{"sha": "6d7aa4763fe7f737d6add4261b9e050b36701089", "node_id": "C_kwDOAAsO6NoAKDZkN2FhNDc2M2ZlN2Y3MzdkNmFkZDQyNjFiOWUwNTBiMzY3MDEwODk", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-02-20T08:38:28Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-02-20T08:38:28Z"}, "message": "Auto merge of #93605 - notriddle:notriddle/rustdoc-html-tags-resolve, r=GuillaumeGomez\n\nrustdoc: resolve intra-doc links when checking HTML\n\nSimilar to #86451\n\nCC #67799\n\nGiven this test case:\n\n```rust\n#![warn(rustdoc::invalid_html_tags)]\n#![warn(rustdoc::broken_intra_doc_links)]\n\npub struct ExistentStruct<T>(T);\n\n/// This [test][ExistentStruct<i32>] thing!\npub struct NoError;\n```\n\nThis pull request silences the following, spurious warning:\n\n```text\nwarning: unclosed HTML tag `i32`\n --> test.rs:6:31\n  |\n6 | /// This [test][ExistentStruct<i32>] thing!\n  |                               ^^^^^\n  |\nnote: the lint level is defined here\n --> test.rs:1:9\n  |\n1 | #![warn(rustdoc::invalid_html_tags)]\n  |         ^^^^^^^^^^^^^^^^^^^^^^^^^^\nhelp: try marking as source code\n  |\n6 | /// This [test][`ExistentStruct<i32>`] thing!\n  |                 +                   +\n\nwarning: 1 warning emitted\n```", "tree": {"sha": "3f48ea10f5e8a10c06d0d4e93bea05ac7fe0a5e9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3f48ea10f5e8a10c06d0d4e93bea05ac7fe0a5e9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6d7aa4763fe7f737d6add4261b9e050b36701089", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6d7aa4763fe7f737d6add4261b9e050b36701089", "html_url": "https://github.com/rust-lang/rust/commit/6d7aa4763fe7f737d6add4261b9e050b36701089", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6d7aa4763fe7f737d6add4261b9e050b36701089/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a6fe969541d14ad8ba286c47416e6d3f58a1c9a4", "url": "https://api.github.com/repos/rust-lang/rust/commits/a6fe969541d14ad8ba286c47416e6d3f58a1c9a4", "html_url": "https://github.com/rust-lang/rust/commit/a6fe969541d14ad8ba286c47416e6d3f58a1c9a4"}, {"sha": "1a6d41cdb5219763eeaf3604e5805a854e5ba931", "url": "https://api.github.com/repos/rust-lang/rust/commits/1a6d41cdb5219763eeaf3604e5805a854e5ba931", "html_url": "https://github.com/rust-lang/rust/commit/1a6d41cdb5219763eeaf3604e5805a854e5ba931"}], "stats": {"total": 122, "additions": 120, "deletions": 2}, "files": [{"sha": "f047f6bb1699bea6001e6e681e176854078b3293", "filename": "src/librustdoc/passes/html_tags.rs", "status": "modified", "additions": 26, "deletions": 2, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/6d7aa4763fe7f737d6add4261b9e050b36701089/src%2Flibrustdoc%2Fpasses%2Fhtml_tags.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6d7aa4763fe7f737d6add4261b9e050b36701089/src%2Flibrustdoc%2Fpasses%2Fhtml_tags.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fhtml_tags.rs?ref=6d7aa4763fe7f737d6add4261b9e050b36701089", "patch": "@@ -5,7 +5,7 @@ use crate::core::DocContext;\n use crate::html::markdown::main_body_opts;\n use crate::visit::DocVisitor;\n \n-use pulldown_cmark::{Event, Parser, Tag};\n+use pulldown_cmark::{BrokenLink, Event, LinkType, Parser, Tag};\n \n use std::iter::Peekable;\n use std::ops::Range;\n@@ -249,7 +249,31 @@ impl<'a, 'tcx> DocVisitor for InvalidHtmlTagsLinter<'a, 'tcx> {\n             let mut is_in_comment = None;\n             let mut in_code_block = false;\n \n-            let p = Parser::new_ext(&dox, main_body_opts()).into_offset_iter();\n+            let link_names = item.link_names(&self.cx.cache);\n+\n+            let mut replacer = |broken_link: BrokenLink<'_>| {\n+                if let Some(link) =\n+                    link_names.iter().find(|link| *link.original_text == *broken_link.reference)\n+                {\n+                    Some((link.href.as_str().into(), link.new_text.as_str().into()))\n+                } else if matches!(\n+                    &broken_link.link_type,\n+                    LinkType::Reference | LinkType::ReferenceUnknown\n+                ) {\n+                    // If the link is shaped [like][this], suppress any broken HTML in the [this] part.\n+                    // The `broken_intra_doc_links` will report typos in there anyway.\n+                    Some((\n+                        broken_link.reference.to_string().into(),\n+                        broken_link.reference.to_string().into(),\n+                    ))\n+                } else {\n+                    None\n+                }\n+            };\n+\n+            let p =\n+                Parser::new_with_broken_link_callback(&dox, main_body_opts(), Some(&mut replacer))\n+                    .into_offset_iter();\n \n             for (event, range) in p {\n                 match event {"}, {"sha": "b5470c859fdf4bb8bf00763ae6c4fc6a369cc741", "filename": "src/test/rustdoc-ui/intra-doc/html-as-generics-intra-doc.rs", "status": "added", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/6d7aa4763fe7f737d6add4261b9e050b36701089/src%2Ftest%2Frustdoc-ui%2Fintra-doc%2Fhtml-as-generics-intra-doc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6d7aa4763fe7f737d6add4261b9e050b36701089/src%2Ftest%2Frustdoc-ui%2Fintra-doc%2Fhtml-as-generics-intra-doc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fintra-doc%2Fhtml-as-generics-intra-doc.rs?ref=6d7aa4763fe7f737d6add4261b9e050b36701089", "patch": "@@ -0,0 +1,25 @@\n+#![deny(rustdoc::invalid_html_tags)]\n+#![deny(rustdoc::broken_intra_doc_links)]\n+\n+pub struct ExistentStruct<T>(T);\n+\n+/// This [test][ExistentStruct<i32>] thing!\n+pub struct NoError;\n+\n+/// This [ExistentStruct<i32>] thing!\n+//~^ ERROR unclosed HTML tag `i32`\n+pub struct PartialErrorOnlyHtml;\n+\n+/// This [test][NonExistentStruct<i32>] thing!\n+//~^ ERROR unresolved link\n+pub struct PartialErrorOnlyResolve;\n+\n+/// This [NonExistentStruct2<i32>] thing!\n+//~^ ERROR unclosed HTML tag `i32`\n+//~| ERROR unresolved link\n+pub struct YesError;\n+\n+/// This [NonExistentStruct3<i32>][] thing!\n+//~^ ERROR unclosed HTML tag `i32`\n+//~| ERROR unresolved link\n+pub struct YesErrorCollapsed;"}, {"sha": "00fe229da40ce648a8a98773bd04bab7e65eb11f", "filename": "src/test/rustdoc-ui/intra-doc/html-as-generics-intra-doc.stderr", "status": "added", "additions": 69, "deletions": 0, "changes": 69, "blob_url": "https://github.com/rust-lang/rust/blob/6d7aa4763fe7f737d6add4261b9e050b36701089/src%2Ftest%2Frustdoc-ui%2Fintra-doc%2Fhtml-as-generics-intra-doc.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/6d7aa4763fe7f737d6add4261b9e050b36701089/src%2Ftest%2Frustdoc-ui%2Fintra-doc%2Fhtml-as-generics-intra-doc.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fintra-doc%2Fhtml-as-generics-intra-doc.stderr?ref=6d7aa4763fe7f737d6add4261b9e050b36701089", "patch": "@@ -0,0 +1,69 @@\n+error: unresolved link to `NonExistentStruct`\n+  --> $DIR/html-as-generics-intra-doc.rs:13:17\n+   |\n+LL | /// This [test][NonExistentStruct<i32>] thing!\n+   |                 ^^^^^^^^^^^^^^^^^^^^^^ no item named `NonExistentStruct` in scope\n+   |\n+note: the lint level is defined here\n+  --> $DIR/html-as-generics-intra-doc.rs:2:9\n+   |\n+LL | #![deny(rustdoc::broken_intra_doc_links)]\n+   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   = help: to escape `[` and `]` characters, add '\\' before them like `\\[` or `\\]`\n+\n+error: unresolved link to `NonExistentStruct2`\n+  --> $DIR/html-as-generics-intra-doc.rs:17:11\n+   |\n+LL | /// This [NonExistentStruct2<i32>] thing!\n+   |           ^^^^^^^^^^^^^^^^^^^^^^^ no item named `NonExistentStruct2` in scope\n+   |\n+   = help: to escape `[` and `]` characters, add '\\' before them like `\\[` or `\\]`\n+\n+error: unresolved link to `NonExistentStruct3`\n+  --> $DIR/html-as-generics-intra-doc.rs:22:11\n+   |\n+LL | /// This [NonExistentStruct3<i32>][] thing!\n+   |           ^^^^^^^^^^^^^^^^^^^^^^^ no item named `NonExistentStruct3` in scope\n+   |\n+   = help: to escape `[` and `]` characters, add '\\' before them like `\\[` or `\\]`\n+\n+error: unclosed HTML tag `i32`\n+  --> $DIR/html-as-generics-intra-doc.rs:9:25\n+   |\n+LL | /// This [ExistentStruct<i32>] thing!\n+   |                         ^^^^^\n+   |\n+note: the lint level is defined here\n+  --> $DIR/html-as-generics-intra-doc.rs:1:9\n+   |\n+LL | #![deny(rustdoc::invalid_html_tags)]\n+   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^\n+help: try marking as source code\n+   |\n+LL | /// This [`ExistentStruct<i32>`] thing!\n+   |           +                   +\n+\n+error: unclosed HTML tag `i32`\n+  --> $DIR/html-as-generics-intra-doc.rs:17:29\n+   |\n+LL | /// This [NonExistentStruct2<i32>] thing!\n+   |                             ^^^^^\n+   |\n+help: try marking as source code\n+   |\n+LL | /// This [`NonExistentStruct2<i32>`] thing!\n+   |           +                       +\n+\n+error: unclosed HTML tag `i32`\n+  --> $DIR/html-as-generics-intra-doc.rs:22:29\n+   |\n+LL | /// This [NonExistentStruct3<i32>][] thing!\n+   |                             ^^^^^\n+   |\n+help: try marking as source code\n+   |\n+LL | /// This [`NonExistentStruct3<i32>`][] thing!\n+   |           +                       +\n+\n+error: aborting due to 6 previous errors\n+"}]}