{"sha": "5b84d5ff13cad8842c2244a141159d3383d66784", "node_id": "MDY6Q29tbWl0NzI0NzEyOjViODRkNWZmMTNjYWQ4ODQyYzIyNDRhMTQxMTU5ZDMzODNkNjY3ODQ=", "commit": {"author": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2020-05-03T14:35:14Z"}, "committer": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2020-05-03T14:39:03Z"}, "message": "resolve: Relax fresh binding disambiguation slightly to fix regression", "tree": {"sha": "9d14411c2b0eaff5e348bf99751a25244cecc328", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9d14411c2b0eaff5e348bf99751a25244cecc328"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5b84d5ff13cad8842c2244a141159d3383d66784", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5b84d5ff13cad8842c2244a141159d3383d66784", "html_url": "https://github.com/rust-lang/rust/commit/5b84d5ff13cad8842c2244a141159d3383d66784", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5b84d5ff13cad8842c2244a141159d3383d66784/comments", "author": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "committer": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d626e4dadc37d7027d65f087da0ad1ddb460959f", "url": "https://api.github.com/repos/rust-lang/rust/commits/d626e4dadc37d7027d65f087da0ad1ddb460959f", "html_url": "https://github.com/rust-lang/rust/commit/d626e4dadc37d7027d65f087da0ad1ddb460959f"}], "stats": {"total": 17, "additions": 11, "deletions": 6}, "files": [{"sha": "6214186a901a1e073dad1a1e38ed0b9239798b34", "filename": "src/librustc_resolve/late.rs", "status": "modified", "additions": 10, "deletions": 6, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/5b84d5ff13cad8842c2244a141159d3383d66784/src%2Flibrustc_resolve%2Flate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5b84d5ff13cad8842c2244a141159d3383d66784/src%2Flibrustc_resolve%2Flate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_resolve%2Flate.rs?ref=5b84d5ff13cad8842c2244a141159d3383d66784", "patch": "@@ -1522,23 +1522,27 @@ impl<'a, 'b, 'ast> LateResolutionVisitor<'a, 'b, 'ast> {\n         ident: Ident,\n         has_sub: bool,\n     ) -> Option<Res> {\n+        // An immutable (no `mut`) by-value (no `ref`) binding pattern without\n+        // a sub pattern (no `@ $pat`) is syntactically ambiguous as it could\n+        // also be interpreted as a path to e.g. a constant, variant, etc.\n+        let is_syntactic_ambiguity = !has_sub && bm == BindingMode::ByValue(Mutability::Not);\n+\n         let ls_binding = self.resolve_ident_in_lexical_scope(ident, ValueNS, None, pat.span)?;\n         let (res, binding) = match ls_binding {\n-            LexicalScopeBinding::Item(binding) if binding.is_ambiguity() => {\n+            LexicalScopeBinding::Item(binding)\n+                if is_syntactic_ambiguity && binding.is_ambiguity() =>\n+            {\n                 // For ambiguous bindings we don't know all their definitions and cannot check\n                 // whether they can be shadowed by fresh bindings or not, so force an error.\n+                // issues/33118#issuecomment-233962221 (see below) still applies here,\n+                // but we have to ignore it for backward compatibility.\n                 self.r.record_use(ident, ValueNS, binding, false);\n                 return None;\n             }\n             LexicalScopeBinding::Item(binding) => (binding.res(), Some(binding)),\n             LexicalScopeBinding::Res(res) => (res, None),\n         };\n \n-        // An immutable (no `mut`) by-value (no `ref`) binding pattern without\n-        // a sub pattern (no `@ $pat`) is syntactically ambiguous as it could\n-        // also be interpreted as a path to e.g. a constant, variant, etc.\n-        let is_syntactic_ambiguity = !has_sub && bm == BindingMode::ByValue(Mutability::Not);\n-\n         match res {\n             Res::SelfCtor(_) // See #70549.\n             | Res::Def("}, {"sha": "0f48340c2cd33b09edd56143be4f8e27908b6b9b", "filename": "src/test/ui/binding/ambiguity-item.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/5b84d5ff13cad8842c2244a141159d3383d66784/src%2Ftest%2Fui%2Fbinding%2Fambiguity-item.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5b84d5ff13cad8842c2244a141159d3383d66784/src%2Ftest%2Fui%2Fbinding%2Fambiguity-item.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fbinding%2Fambiguity-item.rs?ref=5b84d5ff13cad8842c2244a141159d3383d66784", "patch": "@@ -14,5 +14,6 @@ fn main() {\n     let v = f; //~ ERROR `f` is ambiguous\n     match v {\n         f => {} //~ ERROR `f` is ambiguous\n+        mut f => {} // OK, unambiguously a fresh binding due to `mut`\n     }\n }"}]}