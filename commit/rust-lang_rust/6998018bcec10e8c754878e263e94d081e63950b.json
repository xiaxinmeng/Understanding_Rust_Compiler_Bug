{"sha": "6998018bcec10e8c754878e263e94d081e63950b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjY5OTgwMThiY2VjMTBlOGM3NTQ4NzhlMjYzZTk0ZDA4MWU2Mzk1MGI=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-07-14T09:45:29Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2016-07-14T09:45:29Z"}, "message": "Auto merge of #33907 - strake:decode_utf8, r=alexcrichton\n\nadd core::char::DecodeUtf8\n\nSee [issue](https://github.com/rust-lang/rust/issues/33906)", "tree": {"sha": "4f3bc5b90dada8ec84cb3ba61e22ba28f6feda4b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4f3bc5b90dada8ec84cb3ba61e22ba28f6feda4b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6998018bcec10e8c754878e263e94d081e63950b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6998018bcec10e8c754878e263e94d081e63950b", "html_url": "https://github.com/rust-lang/rust/commit/6998018bcec10e8c754878e263e94d081e63950b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6998018bcec10e8c754878e263e94d081e63950b/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3c85f414e922b7bf427493211601c0c7bde3a286", "url": "https://api.github.com/repos/rust-lang/rust/commits/3c85f414e922b7bf427493211601c0c7bde3a286", "html_url": "https://github.com/rust-lang/rust/commit/3c85f414e922b7bf427493211601c0c7bde3a286"}, {"sha": "837029fec146b4eb7af4dae3f002b00306af00db", "url": "https://api.github.com/repos/rust-lang/rust/commits/837029fec146b4eb7af4dae3f002b00306af00db", "html_url": "https://github.com/rust-lang/rust/commit/837029fec146b4eb7af4dae3f002b00306af00db"}], "stats": {"total": 80, "additions": 80, "deletions": 0}, "files": [{"sha": "0e7f04c775825224cb8defe7af3b02b7681cbb3a", "filename": "src/libcore/char.rs", "status": "modified", "additions": 47, "deletions": 0, "changes": 47, "blob_url": "https://github.com/rust-lang/rust/blob/6998018bcec10e8c754878e263e94d081e63950b/src%2Flibcore%2Fchar.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6998018bcec10e8c754878e263e94d081e63950b/src%2Flibcore%2Fchar.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fchar.rs?ref=6998018bcec10e8c754878e263e94d081e63950b", "patch": "@@ -676,3 +676,50 @@ impl Iterator for EncodeUtf16 {\n         self.as_slice().iter().size_hint()\n     }\n }\n+\n+\n+/// An iterator over an iterator of bytes of the characters the bytes represent\n+/// as UTF-8\n+#[unstable(feature = \"decode_utf8\", issue = \"33906\")]\n+#[derive(Clone, Debug)]\n+pub struct DecodeUtf8<I: Iterator<Item = u8>>(::iter::Peekable<I>);\n+\n+/// Decodes an `Iterator` of bytes as UTF-8.\n+#[unstable(feature = \"decode_utf8\", issue = \"33906\")]\n+#[inline]\n+pub fn decode_utf8<I: IntoIterator<Item = u8>>(i: I) -> DecodeUtf8<I::IntoIter> {\n+    DecodeUtf8(i.into_iter().peekable())\n+}\n+\n+/// `<DecodeUtf8 as Iterator>::next` returns this for an invalid input sequence.\n+#[unstable(feature = \"decode_utf8\", issue = \"33906\")]\n+#[derive(PartialEq, Debug)]\n+pub struct InvalidSequence(());\n+\n+#[unstable(feature = \"decode_utf8\", issue = \"33906\")]\n+impl<I: Iterator<Item = u8>> Iterator for DecodeUtf8<I> {\n+    type Item = Result<char, InvalidSequence>;\n+    #[inline]\n+    fn next(&mut self) -> Option<Result<char, InvalidSequence>> {\n+        self.0.next().map(|b| {\n+            if b & 0x80 == 0 { Ok(b as char) } else {\n+                let l = (!b).leading_zeros() as usize; // number of bytes in UTF-8 representation\n+                if l < 2 || l > 6 { return Err(InvalidSequence(())) };\n+                let mut x = (b as u32) & (0x7F >> l);\n+                for _ in 0..l-1 {\n+                    match self.0.peek() {\n+                        Some(&b) if b & 0xC0 == 0x80 => {\n+                            self.0.next();\n+                            x = (x << 6) | (b as u32) & 0x3F;\n+                        },\n+                        _ => return Err(InvalidSequence(())),\n+                    }\n+                }\n+                match from_u32(x) {\n+                    Some(x) if l == x.len_utf8() => Ok(x),\n+                    _ => Err(InvalidSequence(())),\n+                }\n+            }\n+        })\n+    }\n+}"}, {"sha": "c8906fed3d2fa28bca17d60c8819c0f9c72c54ee", "filename": "src/libcoretest/char.rs", "status": "modified", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/6998018bcec10e8c754878e263e94d081e63950b/src%2Flibcoretest%2Fchar.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6998018bcec10e8c754878e263e94d081e63950b/src%2Flibcoretest%2Fchar.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcoretest%2Fchar.rs?ref=6998018bcec10e8c754878e263e94d081e63950b", "patch": "@@ -302,3 +302,32 @@ fn eu_iterator_specializations() {\n     check('\\u{12340}');\n     check('\\u{10FFFF}');\n }\n+\n+#[test]\n+fn test_decode_utf8() {\n+    use core::char::*;\n+    use core::iter::FromIterator;\n+\n+    for &(str, bs) in [(\"\", &[] as &[u8]),\n+                       (\"A\", &[0x41u8] as &[u8]),\n+                       (\"\ufffd\", &[0xC1u8, 0x81u8] as &[u8]),\n+                       (\"\u2665\", &[0xE2u8, 0x99u8, 0xA5u8]),\n+                       (\"\u2665A\", &[0xE2u8, 0x99u8, 0xA5u8, 0x41u8] as &[u8]),\n+                       (\"\ufffd\", &[0xE2u8, 0x99u8] as &[u8]),\n+                       (\"\ufffdA\", &[0xE2u8, 0x99u8, 0x41u8] as &[u8]),\n+                       (\"\ufffd\", &[0xC0u8] as &[u8]),\n+                       (\"\ufffdA\", &[0xC0u8, 0x41u8] as &[u8]),\n+                       (\"\ufffd\", &[0x80u8] as &[u8]),\n+                       (\"\ufffdA\", &[0x80u8, 0x41u8] as &[u8]),\n+                       (\"\ufffd\", &[0xFEu8] as &[u8]),\n+                       (\"\ufffdA\", &[0xFEu8, 0x41u8] as &[u8]),\n+                       (\"\ufffd\", &[0xFFu8] as &[u8]),\n+                       (\"\ufffdA\", &[0xFFu8, 0x41u8] as &[u8])].into_iter() {\n+        assert!(Iterator::eq(str.chars(),\n+                             decode_utf8(bs.into_iter().map(|&b|b))\n+                                 .map(|r_b| r_b.unwrap_or('\\u{FFFD}'))),\n+                \"chars = {}, bytes = {:?}, decoded = {:?}\", str, bs,\n+                Vec::from_iter(decode_utf8(bs.into_iter().map(|&b|b))\n+                                   .map(|r_b| r_b.unwrap_or('\\u{FFFD}'))));\n+    }\n+}"}, {"sha": "1ef2b58351fe5d7820d44c37ff1822bae7cccfbd", "filename": "src/libcoretest/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/6998018bcec10e8c754878e263e94d081e63950b/src%2Flibcoretest%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6998018bcec10e8c754878e263e94d081e63950b/src%2Flibcoretest%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcoretest%2Flib.rs?ref=6998018bcec10e8c754878e263e94d081e63950b", "patch": "@@ -18,6 +18,7 @@\n #![feature(core_private_bignum)]\n #![feature(core_private_diy_float)]\n #![feature(dec2flt)]\n+#![feature(decode_utf8)]\n #![feature(fixed_size_array)]\n #![feature(flt2dec)]\n #![feature(libc)]"}, {"sha": "7445ff94eb50277ca217c8f3627f7e4f8aa2ae98", "filename": "src/librustc_unicode/char.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/6998018bcec10e8c754878e263e94d081e63950b/src%2Flibrustc_unicode%2Fchar.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6998018bcec10e8c754878e263e94d081e63950b/src%2Flibrustc_unicode%2Fchar.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_unicode%2Fchar.rs?ref=6998018bcec10e8c754878e263e94d081e63950b", "patch": "@@ -39,6 +39,8 @@ pub use core::char::{MAX, from_digit, from_u32, from_u32_unchecked};\n pub use core::char::{EncodeUtf16, EncodeUtf8, EscapeDefault, EscapeUnicode};\n \n // unstable reexports\n+#[unstable(feature = \"decode_utf8\", issue = \"33906\")]\n+pub use core::char::{DecodeUtf8, decode_utf8};\n #[unstable(feature = \"unicode\", issue = \"27783\")]\n pub use tables::UNICODE_VERSION;\n "}, {"sha": "f91a754ab57db3a71359a6b279fe0afc66a82cea", "filename": "src/librustc_unicode/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/6998018bcec10e8c754878e263e94d081e63950b/src%2Flibrustc_unicode%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6998018bcec10e8c754878e263e94d081e63950b/src%2Flibrustc_unicode%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_unicode%2Flib.rs?ref=6998018bcec10e8c754878e263e94d081e63950b", "patch": "@@ -33,6 +33,7 @@\n #![no_std]\n \n #![feature(core_char_ext)]\n+#![feature(decode_utf8)]\n #![feature(lang_items)]\n #![feature(staged_api)]\n #![feature(unicode)]"}]}