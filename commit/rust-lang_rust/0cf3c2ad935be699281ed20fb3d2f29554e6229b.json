{"sha": "0cf3c2ad935be699281ed20fb3d2f29554e6229b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBjZjNjMmFkOTM1YmU2OTkyODFlZDIwZmIzZDJmMjk1NTRlNjIyOWI=", "commit": {"author": {"name": "Graydon Hoare", "email": "graydon@mozilla.com", "date": "2010-06-26T04:20:32Z"}, "committer": {"name": "Graydon Hoare", "email": "graydon@mozilla.com", "date": "2010-06-26T04:20:32Z"}, "message": "Pass type parameters to free function called from sweep loop.", "tree": {"sha": "a7f11b7c13b5d55a3332a3d4842e4b507504ad7e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a7f11b7c13b5d55a3332a3d4842e4b507504ad7e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0cf3c2ad935be699281ed20fb3d2f29554e6229b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0cf3c2ad935be699281ed20fb3d2f29554e6229b", "html_url": "https://github.com/rust-lang/rust/commit/0cf3c2ad935be699281ed20fb3d2f29554e6229b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0cf3c2ad935be699281ed20fb3d2f29554e6229b/comments", "author": {"login": "graydon", "id": 14097, "node_id": "MDQ6VXNlcjE0MDk3", "avatar_url": "https://avatars.githubusercontent.com/u/14097?v=4", "gravatar_id": "", "url": "https://api.github.com/users/graydon", "html_url": "https://github.com/graydon", "followers_url": "https://api.github.com/users/graydon/followers", "following_url": "https://api.github.com/users/graydon/following{/other_user}", "gists_url": "https://api.github.com/users/graydon/gists{/gist_id}", "starred_url": "https://api.github.com/users/graydon/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/graydon/subscriptions", "organizations_url": "https://api.github.com/users/graydon/orgs", "repos_url": "https://api.github.com/users/graydon/repos", "events_url": "https://api.github.com/users/graydon/events{/privacy}", "received_events_url": "https://api.github.com/users/graydon/received_events", "type": "User", "site_admin": false}, "committer": {"login": "graydon", "id": 14097, "node_id": "MDQ6VXNlcjE0MDk3", "avatar_url": "https://avatars.githubusercontent.com/u/14097?v=4", "gravatar_id": "", "url": "https://api.github.com/users/graydon", "html_url": "https://github.com/graydon", "followers_url": "https://api.github.com/users/graydon/followers", "following_url": "https://api.github.com/users/graydon/following{/other_user}", "gists_url": "https://api.github.com/users/graydon/gists{/gist_id}", "starred_url": "https://api.github.com/users/graydon/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/graydon/subscriptions", "organizations_url": "https://api.github.com/users/graydon/orgs", "repos_url": "https://api.github.com/users/graydon/repos", "events_url": "https://api.github.com/users/graydon/events{/privacy}", "received_events_url": "https://api.github.com/users/graydon/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "37180552769b316e7239d047008f187127e630e6", "url": "https://api.github.com/repos/rust-lang/rust/commits/37180552769b316e7239d047008f187127e630e6", "html_url": "https://github.com/rust-lang/rust/commit/37180552769b316e7239d047008f187127e630e6"}], "stats": {"total": 25, "additions": 16, "deletions": 9}, "files": [{"sha": "9d671c1b457777c3cdca82c81ba4da12a7cf4fc8", "filename": "src/boot/be/x86.ml", "status": "modified", "additions": 16, "deletions": 9, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/0cf3c2ad935be699281ed20fb3d2f29554e6229b/src%2Fboot%2Fbe%2Fx86.ml", "raw_url": "https://github.com/rust-lang/rust/raw/0cf3c2ad935be699281ed20fb3d2f29554e6229b/src%2Fboot%2Fbe%2Fx86.ml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fboot%2Fbe%2Fx86.ml?ref=0cf3c2ad935be699281ed20fb3d2f29554e6229b", "patch": "@@ -853,11 +853,6 @@ let gc_glue\n       (Il.jmp Il.JNE\n          (codefix skip_jmp_fix));               (* if unmarked (garbage)  *)\n \n-    (* NB: ecx is a type descriptor now. *)\n-    mov (rc eax)                                (* Load glue tydesc-off.  *)\n-      (c (ecx_n Abi.tydesc_field_free_glue));\n-    add eax ecx;                                (* Add to tydesc*         *)\n-\n     (* FIXME: this path is all wrong\n      *\n      * It actually needs to walk in two full passes over the chain:\n@@ -878,11 +873,23 @@ let gc_glue\n      *\n      *)\n \n-    push (ro edx);                      (* gc_val to drop                 *)\n-    push (c task_ptr);                  (* form usual call to glue        *)\n-    push (immi 0L);                     (* outptr                         *)\n+    push (ro edx);                              (* Push gc_val to drop.   *)\n+\n+    (* NB: ecx is a type descriptor now. *)\n+\n+    mov (rc eax)                                (* Load typarams ptr.     *)\n+      (c (ecx_n Abi.tydesc_field_first_param));\n+    push (ro eax);                              (* Push typarams ptr.     *)\n+\n+    push (c task_ptr);                          (* Push task ptr.         *)\n+    push (immi 0L);                             (* Push null outptr.      *)\n+\n+    mov (rc eax)                                (* Load glue tydesc-off.  *)\n+      (c (ecx_n Abi.tydesc_field_free_glue));\n+    add eax ecx;                                (* Add to tydesc*         *)\n     emit (Il.call (rc eax)\n-            (reg_codeptr (h eax)));     (* call glue_fn, trashing eax.    *)\n+            (reg_codeptr (h eax)));             (* Call free glue.        *)\n+    pop (rc eax);\n     pop (rc eax);\n     pop (rc eax);\n     pop (rc eax);"}]}