{"sha": "2a71e45411881dda12a704d7491428d8a23347c0", "node_id": "MDY6Q29tbWl0NzI0NzEyOjJhNzFlNDU0MTE4ODFkZGExMmE3MDRkNzQ5MTQyOGQ4YTIzMzQ3YzA=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-10-27T13:57:54Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-10-27T13:57:54Z"}, "message": "Auto merge of #78434 - jonas-schievink:disable-miropt, r=wesleywiser\n\nDisable \"optimization to avoid load of address\" in InstCombine\n\nSame as #78195, fixes https://github.com/rust-lang/rust/issues/78192 (again).", "tree": {"sha": "9a0fd52b5c9b1c7bbf141ce0b62b6e544775a833", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9a0fd52b5c9b1c7bbf141ce0b62b6e544775a833"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2a71e45411881dda12a704d7491428d8a23347c0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2a71e45411881dda12a704d7491428d8a23347c0", "html_url": "https://github.com/rust-lang/rust/commit/2a71e45411881dda12a704d7491428d8a23347c0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2a71e45411881dda12a704d7491428d8a23347c0/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "56d288fa46e04cd5faf53d369a1a640a97e2bb08", "url": "https://api.github.com/repos/rust-lang/rust/commits/56d288fa46e04cd5faf53d369a1a640a97e2bb08", "html_url": "https://github.com/rust-lang/rust/commit/56d288fa46e04cd5faf53d369a1a640a97e2bb08"}, {"sha": "0be35cf9c72ac57402b7a7bef2f4cc6974607cb9", "url": "https://api.github.com/repos/rust-lang/rust/commits/0be35cf9c72ac57402b7a7bef2f4cc6974607cb9", "html_url": "https://github.com/rust-lang/rust/commit/0be35cf9c72ac57402b7a7bef2f4cc6974607cb9"}], "stats": {"total": 28, "additions": 25, "deletions": 3}, "files": [{"sha": "59b7db243190081361b77f2e458e4422d412d46e", "filename": "compiler/rustc_mir/src/transform/instcombine.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/2a71e45411881dda12a704d7491428d8a23347c0/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Finstcombine.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2a71e45411881dda12a704d7491428d8a23347c0/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Finstcombine.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Finstcombine.rs?ref=2a71e45411881dda12a704d7491428d8a23347c0", "patch": "@@ -119,6 +119,11 @@ impl OptimizationFinder<'b, 'tcx> {\n     }\n \n     fn find_deref_of_address(&mut self, rvalue: &Rvalue<'tcx>, location: Location) -> Option<()> {\n+        // FIXME(#78192): This optimization can result in unsoundness.\n+        if !self.tcx.sess.opts.debugging_opts.unsound_mir_opts {\n+            return None;\n+        }\n+\n         // Look for the sequence\n         //\n         // _2 = &_1;"}, {"sha": "4fd1b8b2276496da04fbbff47073b6ba27f79122", "filename": "src/test/mir-opt/const_prop/ref_deref.main.ConstProp.diff", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/2a71e45411881dda12a704d7491428d8a23347c0/src%2Ftest%2Fmir-opt%2Fconst_prop%2Fref_deref.main.ConstProp.diff", "raw_url": "https://github.com/rust-lang/rust/raw/2a71e45411881dda12a704d7491428d8a23347c0/src%2Ftest%2Fmir-opt%2Fconst_prop%2Fref_deref.main.ConstProp.diff", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fconst_prop%2Fref_deref.main.ConstProp.diff?ref=2a71e45411881dda12a704d7491428d8a23347c0", "patch": "@@ -19,7 +19,7 @@\n                                            // + span: $DIR/ref_deref.rs:5:6: 5:10\n                                            // + literal: Const { ty: &i32, val: Unevaluated(WithOptConstParam { did: DefId(0:3 ~ ref_deref[317d]::main), const_param_did: None }, [], Some(promoted[0])) }\n           _2 = _4;                         // scope 0 at $DIR/ref_deref.rs:5:6: 5:10\n--         _1 = (*_4);                      // scope 0 at $DIR/ref_deref.rs:5:5: 5:10\n+-         _1 = (*_2);                      // scope 0 at $DIR/ref_deref.rs:5:5: 5:10\n +         _1 = const 4_i32;                // scope 0 at $DIR/ref_deref.rs:5:5: 5:10\n           StorageDead(_2);                 // scope 0 at $DIR/ref_deref.rs:5:10: 5:11\n           StorageDead(_1);                 // scope 0 at $DIR/ref_deref.rs:5:10: 5:11"}, {"sha": "812c7c9771801d5809b7c9a89eff69fc76f922cc", "filename": "src/test/mir-opt/const_prop/ref_deref_project.main.ConstProp.diff", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/2a71e45411881dda12a704d7491428d8a23347c0/src%2Ftest%2Fmir-opt%2Fconst_prop%2Fref_deref_project.main.ConstProp.diff", "raw_url": "https://github.com/rust-lang/rust/raw/2a71e45411881dda12a704d7491428d8a23347c0/src%2Ftest%2Fmir-opt%2Fconst_prop%2Fref_deref_project.main.ConstProp.diff", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fconst_prop%2Fref_deref_project.main.ConstProp.diff?ref=2a71e45411881dda12a704d7491428d8a23347c0", "patch": "@@ -19,7 +19,7 @@\n                                            // + span: $DIR/ref_deref_project.rs:5:6: 5:17\n                                            // + literal: Const { ty: &(i32, i32), val: Unevaluated(WithOptConstParam { did: DefId(0:3 ~ ref_deref_project[317d]::main), const_param_did: None }, [], Some(promoted[0])) }\n           _2 = &((*_4).1: i32);            // scope 0 at $DIR/ref_deref_project.rs:5:6: 5:17\n-          _1 = ((*_4).1: i32);             // scope 0 at $DIR/ref_deref_project.rs:5:5: 5:17\n+          _1 = (*_2);                      // scope 0 at $DIR/ref_deref_project.rs:5:5: 5:17\n           StorageDead(_2);                 // scope 0 at $DIR/ref_deref_project.rs:5:17: 5:18\n           StorageDead(_1);                 // scope 0 at $DIR/ref_deref_project.rs:5:17: 5:18\n           _0 = const ();                   // scope 0 at $DIR/ref_deref_project.rs:4:11: 6:2"}, {"sha": "78361c336607c671b5f9635101d6edc54ef9468b", "filename": "src/test/mir-opt/inst_combine_deref.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/2a71e45411881dda12a704d7491428d8a23347c0/src%2Ftest%2Fmir-opt%2Finst_combine_deref.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2a71e45411881dda12a704d7491428d8a23347c0/src%2Ftest%2Fmir-opt%2Finst_combine_deref.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Finst_combine_deref.rs?ref=2a71e45411881dda12a704d7491428d8a23347c0", "patch": "@@ -1,4 +1,4 @@\n-// compile-flags: -O\n+// compile-flags: -O -Zunsound-mir-opts\n // EMIT_MIR inst_combine_deref.simple_opt.InstCombine.diff\n fn simple_opt() -> u64 {\n     let x = 5;"}, {"sha": "b5c3001599ad71de33f32f8011ab8787013be915", "filename": "src/test/ui/issues/issue-78192.rs", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/2a71e45411881dda12a704d7491428d8a23347c0/src%2Ftest%2Fui%2Fissues%2Fissue-78192.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2a71e45411881dda12a704d7491428d8a23347c0/src%2Ftest%2Fui%2Fissues%2Fissue-78192.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-78192.rs?ref=2a71e45411881dda12a704d7491428d8a23347c0", "patch": "@@ -0,0 +1,17 @@\n+// run-pass\n+\n+#![allow(unused_assignments)]\n+\n+fn main() {\n+    let a = 1u32;\n+    let b = 2u32;\n+\n+    let mut c: *const u32 = &a;\n+    let d: &u32 = &b;\n+\n+    let x = unsafe { &*c };\n+    c = d;\n+    let z = *x;\n+\n+    assert_eq!(1, z);\n+}"}]}