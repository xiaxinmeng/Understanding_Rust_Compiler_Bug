{"sha": "4658210565a81e0da5fbb172b817ec257abfc542", "node_id": "C_kwDOAAsO6NoAKDQ2NTgyMTA1NjVhODFlMGRhNWZiYjE3MmI4MTdlYzI1N2FiZmM1NDI", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2023-02-22T09:35:09Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-02-22T09:35:09Z"}, "message": "Rollup merge of #108246 - saethlin:instcombine-redundant-casts, r=compiler-errors\n\nAdd an InstCombine for redundant casts\n\n`@rustbot` label +A-mir-opt", "tree": {"sha": "bfecbcd3d8cc1bd89211e8d0cce6544a62a655c3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bfecbcd3d8cc1bd89211e8d0cce6544a62a655c3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4658210565a81e0da5fbb172b817ec257abfc542", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJj9eHNCRBK7hj4Ov3rIwAAMY8IAEOy5Qn+O6T10+dWWMqXRT3q\ncQjtnepIUhF/y+GeX1sfi1OAfskeU06Z1tBtE5YcF/UXUV5UQfLc6RWnCgdMD+B3\ndYs5JL0aFHdtb/Hvdf8YQck3UmAbTSB+ITDeUtu/d9+PviSYfPHjgnNI7Ma1irAM\niObeGd0r3Dlv1duhkNuPb1w6PsiZryMhEzyoPG8z2085vB9PXJf88iGK9mSbJED/\nkriuecJDonan46euwIrYWu9SrmoDo034lJC/1+rst/cEfzzn/YtpobHnXuwlLUt3\nJmWU0pXc5c9x0+C+Zr2DJrXVeonVg2/uPZzcZ2cWvaER8Pnb7DI6wYOvYIhpAKw=\n=liNx\n-----END PGP SIGNATURE-----\n", "payload": "tree bfecbcd3d8cc1bd89211e8d0cce6544a62a655c3\nparent 437f210af54b35bb6c53aaa806ea0f68f184fb51\nparent 0e05280d75e43da007efd50ce49f4e1e8456bcbd\nauthor Guillaume Gomez <guillaume1.gomez@gmail.com> 1677058509 +0100\ncommitter GitHub <noreply@github.com> 1677058509 +0100\n\nRollup merge of #108246 - saethlin:instcombine-redundant-casts, r=compiler-errors\n\nAdd an InstCombine for redundant casts\n\n`@rustbot` label +A-mir-opt\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4658210565a81e0da5fbb172b817ec257abfc542", "html_url": "https://github.com/rust-lang/rust/commit/4658210565a81e0da5fbb172b817ec257abfc542", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4658210565a81e0da5fbb172b817ec257abfc542/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "437f210af54b35bb6c53aaa806ea0f68f184fb51", "url": "https://api.github.com/repos/rust-lang/rust/commits/437f210af54b35bb6c53aaa806ea0f68f184fb51", "html_url": "https://github.com/rust-lang/rust/commit/437f210af54b35bb6c53aaa806ea0f68f184fb51"}, {"sha": "0e05280d75e43da007efd50ce49f4e1e8456bcbd", "url": "https://api.github.com/repos/rust-lang/rust/commits/0e05280d75e43da007efd50ce49f4e1e8456bcbd", "html_url": "https://github.com/rust-lang/rust/commit/0e05280d75e43da007efd50ce49f4e1e8456bcbd"}], "stats": {"total": 80, "additions": 80, "deletions": 0}, "files": [{"sha": "3896f0e57ead92e141c64ee46b3b9fbe7584fb0f", "filename": "compiler/rustc_mir_transform/src/instcombine.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/4658210565a81e0da5fbb172b817ec257abfc542/compiler%2Frustc_mir_transform%2Fsrc%2Finstcombine.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4658210565a81e0da5fbb172b817ec257abfc542/compiler%2Frustc_mir_transform%2Fsrc%2Finstcombine.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_transform%2Fsrc%2Finstcombine.rs?ref=4658210565a81e0da5fbb172b817ec257abfc542", "patch": "@@ -30,6 +30,7 @@ impl<'tcx> MirPass<'tcx> for InstCombine {\n                         ctx.combine_bool_cmp(&statement.source_info, rvalue);\n                         ctx.combine_ref_deref(&statement.source_info, rvalue);\n                         ctx.combine_len(&statement.source_info, rvalue);\n+                        ctx.combine_cast(&statement.source_info, rvalue);\n                     }\n                     _ => {}\n                 }\n@@ -142,6 +143,14 @@ impl<'tcx> InstCombineContext<'tcx, '_> {\n         }\n     }\n \n+    fn combine_cast(&self, _source_info: &SourceInfo, rvalue: &mut Rvalue<'tcx>) {\n+        if let Rvalue::Cast(_kind, operand, ty) = rvalue {\n+            if operand.ty(self.local_decls, self.tcx) == *ty {\n+                *rvalue = Rvalue::Use(operand.clone());\n+            }\n+        }\n+    }\n+\n     fn combine_primitive_clone(\n         &self,\n         terminator: &mut Terminator<'tcx>,"}, {"sha": "528a8e5a90f268a828fae097e5767896b50ed7f8", "filename": "tests/mir-opt/casts.redundant.InstCombine.diff", "status": "added", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/4658210565a81e0da5fbb172b817ec257abfc542/tests%2Fmir-opt%2Fcasts.redundant.InstCombine.diff", "raw_url": "https://github.com/rust-lang/rust/raw/4658210565a81e0da5fbb172b817ec257abfc542/tests%2Fmir-opt%2Fcasts.redundant.InstCombine.diff", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Fcasts.redundant.InstCombine.diff?ref=4658210565a81e0da5fbb172b817ec257abfc542", "patch": "@@ -0,0 +1,25 @@\n+- // MIR for `redundant` before InstCombine\n++ // MIR for `redundant` after InstCombine\n+  \n+  fn redundant(_1: *const &u8) -> *const &u8 {\n+      debug x => _1;                       // in scope 0 at $DIR/casts.rs:+0:30: +0:31\n+      let mut _0: *const &u8;              // return place in scope 0 at $DIR/casts.rs:+0:51: +0:64\n+      let mut _2: *const &u8;              // in scope 0 at $DIR/casts.rs:+1:5: +1:55\n+      let mut _3: *const &u8;              // in scope 0 at $DIR/casts.rs:+1:36: +1:37\n+      scope 1 (inlined generic_cast::<&u8, &u8>) { // at $DIR/casts.rs:6:5: 6:38\n+          debug x => _3;                   // in scope 1 at $DIR/casts.rs:10:23: 10:24\n+      }\n+  \n+      bb0: {\n+          StorageLive(_2);                 // scope 0 at $DIR/casts.rs:+1:5: +1:55\n+          StorageLive(_3);                 // scope 0 at $DIR/casts.rs:+1:36: +1:37\n+          _3 = _1;                         // scope 0 at $DIR/casts.rs:+1:36: +1:37\n+-         _2 = _3 as *const &u8 (PtrToPtr); // scope 1 at $DIR/casts.rs:11:5: 11:18\n++         _2 = _3;                         // scope 1 at $DIR/casts.rs:11:5: 11:18\n+          StorageDead(_3);                 // scope 0 at $DIR/casts.rs:+1:37: +1:38\n+          _0 = _2;                         // scope 0 at $DIR/casts.rs:+1:5: +1:55\n+          StorageDead(_2);                 // scope 0 at $DIR/casts.rs:+2:1: +2:2\n+          return;                          // scope 0 at $DIR/casts.rs:+2:2: +2:2\n+      }\n+  }\n+  "}, {"sha": "21a470ea30075fb4a95b710f34cb2d9a777a47b2", "filename": "tests/mir-opt/casts.redundant.PreCodegen.after.mir", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/4658210565a81e0da5fbb172b817ec257abfc542/tests%2Fmir-opt%2Fcasts.redundant.PreCodegen.after.mir", "raw_url": "https://github.com/rust-lang/rust/raw/4658210565a81e0da5fbb172b817ec257abfc542/tests%2Fmir-opt%2Fcasts.redundant.PreCodegen.after.mir", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Fcasts.redundant.PreCodegen.after.mir?ref=4658210565a81e0da5fbb172b817ec257abfc542", "patch": "@@ -0,0 +1,14 @@\n+// MIR for `redundant` after PreCodegen\n+\n+fn redundant(_1: *const &u8) -> *const &u8 {\n+    debug x => _1;                       // in scope 0 at $DIR/casts.rs:+0:30: +0:31\n+    let mut _0: *const &u8;              // return place in scope 0 at $DIR/casts.rs:+0:51: +0:64\n+    scope 1 (inlined generic_cast::<&u8, &u8>) { // at $DIR/casts.rs:6:5: 6:38\n+        debug x => _1;                   // in scope 1 at $DIR/casts.rs:10:23: 10:24\n+    }\n+\n+    bb0: {\n+        _0 = _1;                         // scope 0 at $DIR/casts.rs:+1:5: +1:55\n+        return;                          // scope 0 at $DIR/casts.rs:+2:2: +2:2\n+    }\n+}"}, {"sha": "0c793984ceb6ce347cee838b90de1108c7db1d45", "filename": "tests/mir-opt/casts.roundtrip.PreCodegen.after.mir", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/4658210565a81e0da5fbb172b817ec257abfc542/tests%2Fmir-opt%2Fcasts.roundtrip.PreCodegen.after.mir", "raw_url": "https://github.com/rust-lang/rust/raw/4658210565a81e0da5fbb172b817ec257abfc542/tests%2Fmir-opt%2Fcasts.roundtrip.PreCodegen.after.mir", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Fcasts.roundtrip.PreCodegen.after.mir?ref=4658210565a81e0da5fbb172b817ec257abfc542", "patch": "@@ -0,0 +1,15 @@\n+// MIR for `roundtrip` after PreCodegen\n+\n+fn roundtrip(_1: *const u8) -> *const u8 {\n+    debug x => _1;                       // in scope 0 at $DIR/casts.rs:+0:18: +0:19\n+    let mut _0: *const u8;               // return place in scope 0 at $DIR/casts.rs:+0:35: +0:44\n+    let mut _2: *mut u8;                 // in scope 0 at $DIR/casts.rs:+1:5: +1:17\n+\n+    bb0: {\n+        StorageLive(_2);                 // scope 0 at $DIR/casts.rs:+1:5: +1:17\n+        _2 = _1 as *mut u8 (PtrToPtr);   // scope 0 at $DIR/casts.rs:+1:5: +1:17\n+        _0 = move _2 as *const u8 (Pointer(MutToConstPointer)); // scope 0 at $DIR/casts.rs:+1:5: +1:17\n+        StorageDead(_2);                 // scope 0 at $DIR/casts.rs:+1:16: +1:17\n+        return;                          // scope 0 at $DIR/casts.rs:+2:2: +2:2\n+    }\n+}"}, {"sha": "259c462da3d42810db41de52e535d00b9f3ba112", "filename": "tests/mir-opt/casts.rs", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/4658210565a81e0da5fbb172b817ec257abfc542/tests%2Fmir-opt%2Fcasts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4658210565a81e0da5fbb172b817ec257abfc542/tests%2Fmir-opt%2Fcasts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Fcasts.rs?ref=4658210565a81e0da5fbb172b817ec257abfc542", "patch": "@@ -0,0 +1,17 @@\n+#![crate_type = \"lib\"]\n+\n+// EMIT_MIR casts.redundant.InstCombine.diff\n+// EMIT_MIR casts.redundant.PreCodegen.after.mir\n+pub fn redundant<'a, 'b: 'a>(x: *const &'a u8) -> *const &'a u8 {\n+    generic_cast::<&'a u8, &'b u8>(x) as *const &'a u8\n+}\n+\n+#[inline]\n+fn generic_cast<T, U>(x: *const T) -> *const U {\n+    x as *const U\n+}\n+\n+// EMIT_MIR casts.roundtrip.PreCodegen.after.mir\n+pub fn roundtrip(x: *const u8) -> *const u8 {\n+    x as *mut u8 as *const u8\n+}"}]}