{"sha": "98190b716829fd4edbf1b364a1a662de9a9ca7bb", "node_id": "C_kwDOAAsO6NoAKDk4MTkwYjcxNjgyOWZkNGVkYmYxYjM2NGExYTY2MmRlOWE5Y2E3YmI", "commit": {"author": {"name": "Cliff L. Biffle", "email": "cliff@oxide.computer", "date": "2022-04-04T18:03:03Z"}, "committer": {"name": "Cliff L. Biffle", "email": "cliff@oxide.computer", "date": "2022-04-05T17:38:13Z"}, "message": "Revert \"Work around invalid DWARF bugs for fat LTO\"\n\nSince September, the toolchain has not been generating reliable DWARF\ninformation for static variables when LTO is on. This has affected\nprojects in the embedded space where the use of LTO is typical. In our\ncase, it has kept us from bumping past the 2021-09-22 nightly toolchain\nlest our debugger break. This has been a pretty dramatic regression for\npeople using debuggers and static variables. See #90357 for more info\nand a repro case.\n\nThis commit is a mechanical revert of\nd5de680e20def848751cb3c11e1182408112b1d3 from PR #89041, which caused\nthe issue. (Note on that PR that the commit's author has requested it be\nreverted.)\n\nI have locally verified that this fixes #90357 by restoring the\nfunctionality of both the repro case I posted on that bug, and debugger\nbehavior on real programs. There do not appear to be test cases for this\nin the toolchain; if I've missed them, point me at 'em and I'll update\nthem.", "tree": {"sha": "e4bddc74adde3387028bd1bdd9b1b977f39e9974", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e4bddc74adde3387028bd1bdd9b1b977f39e9974"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/98190b716829fd4edbf1b364a1a662de9a9ca7bb", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/98190b716829fd4edbf1b364a1a662de9a9ca7bb", "html_url": "https://github.com/rust-lang/rust/commit/98190b716829fd4edbf1b364a1a662de9a9ca7bb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/98190b716829fd4edbf1b364a1a662de9a9ca7bb/comments", "author": {"login": "cbiffle", "id": 45247, "node_id": "MDQ6VXNlcjQ1MjQ3", "avatar_url": "https://avatars.githubusercontent.com/u/45247?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cbiffle", "html_url": "https://github.com/cbiffle", "followers_url": "https://api.github.com/users/cbiffle/followers", "following_url": "https://api.github.com/users/cbiffle/following{/other_user}", "gists_url": "https://api.github.com/users/cbiffle/gists{/gist_id}", "starred_url": "https://api.github.com/users/cbiffle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cbiffle/subscriptions", "organizations_url": "https://api.github.com/users/cbiffle/orgs", "repos_url": "https://api.github.com/users/cbiffle/repos", "events_url": "https://api.github.com/users/cbiffle/events{/privacy}", "received_events_url": "https://api.github.com/users/cbiffle/received_events", "type": "User", "site_admin": false}, "committer": {"login": "cbiffle", "id": 45247, "node_id": "MDQ6VXNlcjQ1MjQ3", "avatar_url": "https://avatars.githubusercontent.com/u/45247?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cbiffle", "html_url": "https://github.com/cbiffle", "followers_url": "https://api.github.com/users/cbiffle/followers", "following_url": "https://api.github.com/users/cbiffle/following{/other_user}", "gists_url": "https://api.github.com/users/cbiffle/gists{/gist_id}", "starred_url": "https://api.github.com/users/cbiffle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cbiffle/subscriptions", "organizations_url": "https://api.github.com/users/cbiffle/orgs", "repos_url": "https://api.github.com/users/cbiffle/repos", "events_url": "https://api.github.com/users/cbiffle/events{/privacy}", "received_events_url": "https://api.github.com/users/cbiffle/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d4c7839f73e4a84c75e8708adaafb9fafcb668f0", "url": "https://api.github.com/repos/rust-lang/rust/commits/d4c7839f73e4a84c75e8708adaafb9fafcb668f0", "html_url": "https://github.com/rust-lang/rust/commit/d4c7839f73e4a84c75e8708adaafb9fafcb668f0"}], "stats": {"total": 30, "additions": 10, "deletions": 20}, "files": [{"sha": "266ed6d8b6f300f8145dc7340de06dafb1011059", "filename": "compiler/rustc_codegen_llvm/src/back/lto.rs", "status": "modified", "additions": 2, "deletions": 16, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/98190b716829fd4edbf1b364a1a662de9a9ca7bb/compiler%2Frustc_codegen_llvm%2Fsrc%2Fback%2Flto.rs", "raw_url": "https://github.com/rust-lang/rust/raw/98190b716829fd4edbf1b364a1a662de9a9ca7bb/compiler%2Frustc_codegen_llvm%2Fsrc%2Fback%2Flto.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fback%2Flto.rs?ref=98190b716829fd4edbf1b364a1a662de9a9ca7bb", "patch": "@@ -325,20 +325,6 @@ fn fat_lto(\n         drop(linker);\n         save_temp_bitcode(cgcx, &module, \"lto.input\");\n \n-        // Fat LTO also suffers from the invalid DWARF issue similar to Thin LTO.\n-        // Here we rewrite all `DICompileUnit` pointers if there is only one `DICompileUnit`.\n-        // This only works around the problem when codegen-units = 1.\n-        // Refer to the comments in the `optimize_thin_module` function for more details.\n-        let mut cu1 = ptr::null_mut();\n-        let mut cu2 = ptr::null_mut();\n-        unsafe { llvm::LLVMRustLTOGetDICompileUnit(llmod, &mut cu1, &mut cu2) };\n-        if !cu2.is_null() {\n-            let _timer =\n-                cgcx.prof.generic_activity_with_arg(\"LLVM_fat_lto_patch_debuginfo\", &*module.name);\n-            unsafe { llvm::LLVMRustLTOPatchDICompileUnit(llmod, cu1) };\n-            save_temp_bitcode(cgcx, &module, \"fat-lto-after-patch\");\n-        }\n-\n         // Internalize everything below threshold to help strip out more modules and such.\n         unsafe {\n             let ptr = symbols_below_threshold.as_ptr();\n@@ -757,7 +743,7 @@ pub unsafe fn optimize_thin_module(\n         // an error.\n         let mut cu1 = ptr::null_mut();\n         let mut cu2 = ptr::null_mut();\n-        llvm::LLVMRustLTOGetDICompileUnit(llmod, &mut cu1, &mut cu2);\n+        llvm::LLVMRustThinLTOGetDICompileUnit(llmod, &mut cu1, &mut cu2);\n         if !cu2.is_null() {\n             let msg = \"multiple source DICompileUnits found\";\n             return Err(write::llvm_err(&diag_handler, msg));\n@@ -846,7 +832,7 @@ pub unsafe fn optimize_thin_module(\n             let _timer = cgcx\n                 .prof\n                 .generic_activity_with_arg(\"LLVM_thin_lto_patch_debuginfo\", thin_module.name());\n-            llvm::LLVMRustLTOPatchDICompileUnit(llmod, cu1);\n+            llvm::LLVMRustThinLTOPatchDICompileUnit(llmod, cu1);\n             save_temp_bitcode(cgcx, &module, \"thin-lto-after-patch\");\n         }\n "}, {"sha": "db018aeac13859dfb813284297e49b5a1f3a146c", "filename": "compiler/rustc_codegen_llvm/src/llvm/ffi.rs", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/98190b716829fd4edbf1b364a1a662de9a9ca7bb/compiler%2Frustc_codegen_llvm%2Fsrc%2Fllvm%2Fffi.rs", "raw_url": "https://github.com/rust-lang/rust/raw/98190b716829fd4edbf1b364a1a662de9a9ca7bb/compiler%2Frustc_codegen_llvm%2Fsrc%2Fllvm%2Fffi.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fllvm%2Fffi.rs?ref=98190b716829fd4edbf1b364a1a662de9a9ca7bb", "patch": "@@ -2506,8 +2506,12 @@ extern \"C\" {\n         len: usize,\n         out_len: &mut usize,\n     ) -> *const u8;\n-    pub fn LLVMRustLTOGetDICompileUnit(M: &Module, CU1: &mut *mut c_void, CU2: &mut *mut c_void);\n-    pub fn LLVMRustLTOPatchDICompileUnit(M: &Module, CU: *mut c_void);\n+    pub fn LLVMRustThinLTOGetDICompileUnit(\n+        M: &Module,\n+        CU1: &mut *mut c_void,\n+        CU2: &mut *mut c_void,\n+    );\n+    pub fn LLVMRustThinLTOPatchDICompileUnit(M: &Module, CU: *mut c_void);\n \n     pub fn LLVMRustLinkerNew(M: &Module) -> &mut Linker<'_>;\n     pub fn LLVMRustLinkerAdd("}, {"sha": "e3ee21c80859e9c3b6b005f3edcf444498e98028", "filename": "compiler/rustc_llvm/llvm-wrapper/PassWrapper.cpp", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/98190b716829fd4edbf1b364a1a662de9a9ca7bb/compiler%2Frustc_llvm%2Fllvm-wrapper%2FPassWrapper.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/98190b716829fd4edbf1b364a1a662de9a9ca7bb/compiler%2Frustc_llvm%2Fllvm-wrapper%2FPassWrapper.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_llvm%2Fllvm-wrapper%2FPassWrapper.cpp?ref=98190b716829fd4edbf1b364a1a662de9a9ca7bb", "patch": "@@ -1611,7 +1611,7 @@ LLVMRustGetBitcodeSliceFromObjectData(const char *data,\n // Rewrite all `DICompileUnit` pointers to the `DICompileUnit` specified. See\n // the comment in `back/lto.rs` for why this exists.\n extern \"C\" void\n-LLVMRustLTOGetDICompileUnit(LLVMModuleRef Mod,\n+LLVMRustThinLTOGetDICompileUnit(LLVMModuleRef Mod,\n                                 DICompileUnit **A,\n                                 DICompileUnit **B) {\n   Module *M = unwrap(Mod);\n@@ -1629,7 +1629,7 @@ LLVMRustLTOGetDICompileUnit(LLVMModuleRef Mod,\n // Rewrite all `DICompileUnit` pointers to the `DICompileUnit` specified. See\n // the comment in `back/lto.rs` for why this exists.\n extern \"C\" void\n-LLVMRustLTOPatchDICompileUnit(LLVMModuleRef Mod, DICompileUnit *Unit) {\n+LLVMRustThinLTOPatchDICompileUnit(LLVMModuleRef Mod, DICompileUnit *Unit) {\n   Module *M = unwrap(Mod);\n \n   // If the original source module didn't have a `DICompileUnit` then try to"}]}