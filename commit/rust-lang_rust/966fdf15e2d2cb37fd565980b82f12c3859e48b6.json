{"sha": "966fdf15e2d2cb37fd565980b82f12c3859e48b6", "node_id": "MDY6Q29tbWl0NzI0NzEyOjk2NmZkZjE1ZTJkMmNiMzdmZDU2NTk4MGI4MmYxMmMzODU5ZTQ4YjY=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-12-29T03:23:37Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-12-29T03:23:37Z"}, "message": "Auto merge of #46883 - QuietMisdreavus:faildown, r=GuillaumeGomez\n\nrustdoc: add option to abort the process on markdown differences\n\nIn the efforts of keeping the std docs free of markdown warnings, this PR adds a stopgap measure to make sure the CI fails if it detects a markdown difference. It does this by adding a new unstable flag to rustdoc, `--deny-render-differences`, which bootstrap then passes to rustdoc when documenting std and friends.\n\nThe implementation is... probably not the cleanest option. It currently adds an extra branch after it prints the markdown warnings, which just prints a final line and calls `::std::process::abort(1)`. I did it like this because if it just panics regularly, it looks like an ICE, an even though `html::render::run` returns a Result, that Result is also just `expect`ed immediately, generating the same problem. This way bypasses the panic handler at the top of the thread and looks like a proper failure. Since i don't have a real error Handler there, this is the best i can do without pulling in a real error system for rustdoc.\n\nThis PR is blocked on https://github.com/rust-lang/rust/pull/46853, which will fix the rendering differences that were present on master when i started this branch.", "tree": {"sha": "3b187107654b35ae5d330511537feec8ca11ef18", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3b187107654b35ae5d330511537feec8ca11ef18"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/966fdf15e2d2cb37fd565980b82f12c3859e48b6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/966fdf15e2d2cb37fd565980b82f12c3859e48b6", "html_url": "https://github.com/rust-lang/rust/commit/966fdf15e2d2cb37fd565980b82f12c3859e48b6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/966fdf15e2d2cb37fd565980b82f12c3859e48b6/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ec9be91e4366f57dcb88169c78daaee049857af0", "url": "https://api.github.com/repos/rust-lang/rust/commits/ec9be91e4366f57dcb88169c78daaee049857af0", "html_url": "https://github.com/rust-lang/rust/commit/ec9be91e4366f57dcb88169c78daaee049857af0"}, {"sha": "dfbb94664915354eb512c66833ece422bd2b9214", "url": "https://api.github.com/repos/rust-lang/rust/commits/dfbb94664915354eb512c66833ece422bd2b9214", "html_url": "https://github.com/rust-lang/rust/commit/dfbb94664915354eb512c66833ece422bd2b9214"}], "stats": {"total": 20, "additions": 18, "deletions": 2}, "files": [{"sha": "62037590853c7dd72a09fa317a283b234c568413", "filename": "src/bootstrap/bin/rustdoc.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/966fdf15e2d2cb37fd565980b82f12c3859e48b6/src%2Fbootstrap%2Fbin%2Frustdoc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/966fdf15e2d2cb37fd565980b82f12c3859e48b6/src%2Fbootstrap%2Fbin%2Frustdoc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbin%2Frustdoc.rs?ref=966fdf15e2d2cb37fd565980b82f12c3859e48b6", "patch": "@@ -57,6 +57,10 @@ fn main() {\n         // This \"unstable-options\" can be removed when `--crate-version` is stabilized\n         cmd.arg(\"-Z\").arg(\"unstable-options\")\n            .arg(\"--crate-version\").arg(version);\n+\n+        // While we can assume that `-Z unstable-options` is set, let's also force rustdoc to panic\n+        // if pulldown rendering differences are found\n+        cmd.arg(\"--deny-render-differences\");\n     }\n \n     std::process::exit(match cmd.status() {"}, {"sha": "afbaf037c7defcd70a211db2f84bc94715332fb4", "filename": "src/librustdoc/html/render.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/966fdf15e2d2cb37fd565980b82f12c3859e48b6/src%2Flibrustdoc%2Fhtml%2Frender.rs", "raw_url": "https://github.com/rust-lang/rust/raw/966fdf15e2d2cb37fd565980b82f12c3859e48b6/src%2Flibrustdoc%2Fhtml%2Frender.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender.rs?ref=966fdf15e2d2cb37fd565980b82f12c3859e48b6", "patch": "@@ -495,7 +495,8 @@ pub fn run(mut krate: clean::Crate,\n            css_file_extension: Option<PathBuf>,\n            renderinfo: RenderInfo,\n            render_type: RenderType,\n-           sort_modules_alphabetically: bool) -> Result<(), Error> {\n+           sort_modules_alphabetically: bool,\n+           deny_render_differences: bool) -> Result<(), Error> {\n     let src_root = match krate.src {\n         FileName::Real(ref p) => match p.parent() {\n             Some(p) => p.to_path_buf(),\n@@ -659,6 +660,11 @@ pub fn run(mut krate: clean::Crate,\n                 render_difference(d, &mut intro_msg, span, text);\n             }\n         }\n+\n+        if deny_render_differences {\n+            println!(\"Aborting with {} rendering differences\", markdown_warnings.len());\n+            ::std::process::exit(1);\n+        }\n     }\n \n     result"}, {"sha": "1740816ef6b16eeb4ffdb6b07b0d80b2045ff914", "filename": "src/librustdoc/lib.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/966fdf15e2d2cb37fd565980b82f12c3859e48b6/src%2Flibrustdoc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/966fdf15e2d2cb37fd565980b82f12c3859e48b6/src%2Flibrustdoc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Flib.rs?ref=966fdf15e2d2cb37fd565980b82f12c3859e48b6", "patch": "@@ -257,6 +257,10 @@ pub fn opts() -> Vec<RustcOptGroup> {\n             o.optflag(\"\", \"sort-modules-by-appearance\", \"sort modules by where they appear in the \\\n                                                          program, rather than alphabetically\")\n         }),\n+        unstable(\"deny-render-differences\", |o| {\n+            o.optflag(\"\", \"deny-render-differences\", \"abort doc runs when markdown rendering \\\n+                                                      differences are found\")\n+        }),\n     ]\n }\n \n@@ -393,6 +397,7 @@ pub fn main_args(args: &[String]) -> isize {\n     }\n \n     let output_format = matches.opt_str(\"w\");\n+    let deny_render_differences = matches.opt_present(\"deny-render-differences\");\n     let res = acquire_input(PathBuf::from(input), externs, &matches, move |out| {\n         let Output { krate, passes, renderinfo } = out;\n         info!(\"going to format\");\n@@ -404,7 +409,8 @@ pub fn main_args(args: &[String]) -> isize {\n                                   css_file_extension,\n                                   renderinfo,\n                                   render_type,\n-                                  sort_modules_alphabetically)\n+                                  sort_modules_alphabetically,\n+                                  deny_render_differences)\n                     .expect(\"failed to generate documentation\");\n                 0\n             }"}]}