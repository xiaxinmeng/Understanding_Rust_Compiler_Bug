{"sha": "084794ed164199619d9bd6e5422b4feaee4a0a9a", "node_id": "MDY6Q29tbWl0NzI0NzEyOjA4NDc5NGVkMTY0MTk5NjE5ZDliZDZlNTQyMmI0ZmVhZWU0YTBhOWE=", "commit": {"author": {"name": "Arpad Borsos", "email": "swatinem@swatinem.de", "date": "2021-05-14T09:04:48Z"}, "committer": {"name": "Arpad Borsos", "email": "swatinem@swatinem.de", "date": "2021-06-14T18:29:21Z"}, "message": "Avoid possible filename collision in coverage tests\n\nPreviously, coverage tests were writing profiler data to files based on\ntheir pid. As rustdoc spawns each doctest as its own process, it might\nbe possible in rare cases that a pid is being reused which would cause\na file to be overwritten, leading to incorrect coverage results.", "tree": {"sha": "ef76b4c7c17639357e4da9faaaf5dbd060211f8c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ef76b4c7c17639357e4da9faaaf5dbd060211f8c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/084794ed164199619d9bd6e5422b4feaee4a0a9a", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEZNNjbpmzULCa7LeL/HvKd4JLMpgFAmDHoBkACgkQ/HvKd4JL\nMpiYGQ//bHb85Td4U+7QpUOSQ4xFt0+ylH3yL51DnOAZPIPV3CsNu/WjMYyouUKy\n/yuV5PF7F68fuFFtolCT6MjLzlX71jgDAIal7+tK0+lcs1s9hhTFDLCc8wUuaDPz\n5GKQrGzN+BQp/XxK9h6CFB/3gykOB8IFz9WKQE4Ue6ak+A4j99+1nJCWo87kv/bW\nEgig5eSded7sPzTZG+DrwQrk2RRdjgiTzB1qQNEZ8KANA+/ZoV63bUdq73tLxYIv\nX16Nat6OYQ4p5eFw13wE1KAz18JiCtfBdDwAVTnWK61106lCLd2WJOupT/MUkChs\nQ/N/oCJZFcNBs+QyFh5h52HKNxzB22A8fenUuny8NVIisc5qQqjLKO7HwhSQ/vnM\nAGQVoE1NZKxtGqLP3fSo8Pwee57RwGVREBf4rSRn9w8mWePlq15qkCXEW1TFtjbS\ncghmCPgeQwxM6CgPT7iJW54oloUmNj4/3Zlueh+TuiH3RGvVvKshWxuCqOxad56C\nTMYb+Nye32J/jmRRBvNhQGmfv1S0zJiiwAQvqL6tgtYc7I5rEgmZ4Hr4aqabCbjM\nRzfisOmiKPfwwPopkNRLqz/4UZk2fG0bjVSv0BdSE+6OxNgScDiuZ34TYJIotiQ6\ngaEktDycgFtRfdh/hriAEYo918fd6rVmjkq3Bv5YatiqPbvStf8=\n=nFv9\n-----END PGP SIGNATURE-----", "payload": "tree ef76b4c7c17639357e4da9faaaf5dbd060211f8c\nparent a216131c3566858b78f45ccc0c36b5578f5c5155\nauthor Arpad Borsos <swatinem@swatinem.de> 1620983088 +0200\ncommitter Arpad Borsos <swatinem@swatinem.de> 1623695361 +0200\n\nAvoid possible filename collision in coverage tests\n\nPreviously, coverage tests were writing profiler data to files based on\ntheir pid. As rustdoc spawns each doctest as its own process, it might\nbe possible in rare cases that a pid is being reused which would cause\na file to be overwritten, leading to incorrect coverage results.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/084794ed164199619d9bd6e5422b4feaee4a0a9a", "html_url": "https://github.com/rust-lang/rust/commit/084794ed164199619d9bd6e5422b4feaee4a0a9a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/084794ed164199619d9bd6e5422b4feaee4a0a9a/comments", "author": {"login": "Swatinem", "id": 580492, "node_id": "MDQ6VXNlcjU4MDQ5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/580492?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Swatinem", "html_url": "https://github.com/Swatinem", "followers_url": "https://api.github.com/users/Swatinem/followers", "following_url": "https://api.github.com/users/Swatinem/following{/other_user}", "gists_url": "https://api.github.com/users/Swatinem/gists{/gist_id}", "starred_url": "https://api.github.com/users/Swatinem/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Swatinem/subscriptions", "organizations_url": "https://api.github.com/users/Swatinem/orgs", "repos_url": "https://api.github.com/users/Swatinem/repos", "events_url": "https://api.github.com/users/Swatinem/events{/privacy}", "received_events_url": "https://api.github.com/users/Swatinem/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Swatinem", "id": 580492, "node_id": "MDQ6VXNlcjU4MDQ5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/580492?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Swatinem", "html_url": "https://github.com/Swatinem", "followers_url": "https://api.github.com/users/Swatinem/followers", "following_url": "https://api.github.com/users/Swatinem/following{/other_user}", "gists_url": "https://api.github.com/users/Swatinem/gists{/gist_id}", "starred_url": "https://api.github.com/users/Swatinem/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Swatinem/subscriptions", "organizations_url": "https://api.github.com/users/Swatinem/orgs", "repos_url": "https://api.github.com/users/Swatinem/repos", "events_url": "https://api.github.com/users/Swatinem/events{/privacy}", "received_events_url": "https://api.github.com/users/Swatinem/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a216131c3566858b78f45ccc0c36b5578f5c5155", "url": "https://api.github.com/repos/rust-lang/rust/commits/a216131c3566858b78f45ccc0c36b5578f5c5155", "html_url": "https://github.com/rust-lang/rust/commit/a216131c3566858b78f45ccc0c36b5578f5c5155"}], "stats": {"total": 14, "additions": 8, "deletions": 6}, "files": [{"sha": "78fbf811f12bf5b70aa2ad0842db9bbb5a5ad748", "filename": "src/test/run-make-fulldeps/coverage-reports/Makefile", "status": "modified", "additions": 8, "deletions": 6, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/084794ed164199619d9bd6e5422b4feaee4a0a9a/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/084794ed164199619d9bd6e5422b4feaee4a0a9a/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2FMakefile?ref=084794ed164199619d9bd6e5422b4feaee4a0a9a", "patch": "@@ -87,7 +87,7 @@ endif\n \t# Run it in order to generate some profiling data,\n \t# with `LLVM_PROFILE_FILE=<profdata_file>` environment variable set to\n \t# output the coverage stats for this run.\n-\tLLVM_PROFILE_FILE=\"$(TMPDIR)\"/$@-%p.profraw \\\n+\tLLVM_PROFILE_FILE=\"$(TMPDIR)\"/$@.profraw \\\n \t\t\t$(call RUN,$@) || \\\n \t\t\t( \\\n \t\t\t\tstatus=$$?; \\\n@@ -97,16 +97,19 @@ endif\n \t\t\t\t) \\\n \t\t\t)\n \n-\t# Run it through rustdoc as well to cover doctests\n-\tLLVM_PROFILE_FILE=\"$(TMPDIR)\"/$@-%p.profraw \\\n+\t# Run it through rustdoc as well to cover doctests.\n+\t# `%p` is the pid, and `%m` the binary signature. We suspect that the pid alone\n+\t# might result in overwritten files and failed tests, as rustdoc spawns each\n+\t# doctest as its own process, so make sure the filename is as unique as possible.\n+\tLLVM_PROFILE_FILE=\"$(TMPDIR)\"/$@-%p-%m.profraw \\\n \t\t\t$(RUSTDOC) --crate-name workaround_for_79771 --test $(SOURCEDIR)/$@.rs \\\n \t\t\t$$( sed -n 's/^\\/\\/ compile-flags: \\([^#]*\\).*/\\1/p' $(SOURCEDIR)/$@.rs ) \\\n \t\t\t-L \"$(TMPDIR)\" -Zinstrument-coverage \\\n \t\t\t-Z unstable-options --persist-doctests=$(TMPDIR)/rustdoc-$@\n \n \t# Postprocess the profiling data so it can be used by the llvm-cov tool\n \t\"$(LLVM_BIN_DIR)\"/llvm-profdata merge --sparse \\\n-\t\t\t\"$(TMPDIR)\"/$@-*.profraw \\\n+\t\t\t\"$(TMPDIR)\"/$@*.profraw \\\n \t\t\t-o \"$(TMPDIR)\"/$@.profdata\n \n \t# Generate a coverage report using `llvm-cov show`.\n@@ -118,8 +121,7 @@ endif\n \t\t\t--instr-profile=\"$(TMPDIR)\"/$@.profdata \\\n \t\t\t$(call BIN,\"$(TMPDIR)\"/$@) \\\n \t\t\t$$( \\\n-\t\t\t\tfor file in $(TMPDIR)/rustdoc-$@/*/rust_out; \\\n-\t\t\t\tdo \\\n+\t\t\t\tfor file in $(TMPDIR)/rustdoc-$@/*/rust_out; do \\\n \t\t\t\t[ -x \"$$file\" ] && printf \"%s %s \" -object $$file; \\\n \t\t\t\tdone \\\n \t\t\t) \\"}]}