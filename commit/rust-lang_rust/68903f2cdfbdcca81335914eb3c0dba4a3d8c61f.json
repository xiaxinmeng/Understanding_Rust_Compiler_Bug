{"sha": "68903f2cdfbdcca81335914eb3c0dba4a3d8c61f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjY4OTAzZjJjZGZiZGNjYTgxMzM1OTE0ZWIzYzBkYmE0YTNkOGM2MWY=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-03-06T11:11:39Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-03-06T11:11:39Z"}, "message": "auto merge of #12719 : alexcrichton/rust/fix-llvm-33, r=brson\n\nThe llvm.copysign and llvm.round intrinsics weren't added until LLVM 3.4, so if\r\nwe're on LLVM 3.3 we lower these to calls in libm instead of LLVM intrinsics.\r\n\r\nThis should fix our travis failures.", "tree": {"sha": "53e96713a350bf5ae9cb4dcf440ed65d58662aa3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/53e96713a350bf5ae9cb4dcf440ed65d58662aa3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/68903f2cdfbdcca81335914eb3c0dba4a3d8c61f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/68903f2cdfbdcca81335914eb3c0dba4a3d8c61f", "html_url": "https://github.com/rust-lang/rust/commit/68903f2cdfbdcca81335914eb3c0dba4a3d8c61f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/68903f2cdfbdcca81335914eb3c0dba4a3d8c61f/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "14c620719c06fcb3222b95d0d1505306506efb86", "url": "https://api.github.com/repos/rust-lang/rust/commits/14c620719c06fcb3222b95d0d1505306506efb86", "html_url": "https://github.com/rust-lang/rust/commit/14c620719c06fcb3222b95d0d1505306506efb86"}, {"sha": "93964525922f5b13cbc3b0a28175082acf50f587", "url": "https://api.github.com/repos/rust-lang/rust/commits/93964525922f5b13cbc3b0a28175082acf50f587", "html_url": "https://github.com/rust-lang/rust/commit/93964525922f5b13cbc3b0a28175082acf50f587"}], "stats": {"total": 36, "additions": 32, "deletions": 4}, "files": [{"sha": "448b9e30dcd3df551460808b70d44dc48f0eba3d", "filename": "src/librustc/lib/llvm.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/68903f2cdfbdcca81335914eb3c0dba4a3d8c61f/src%2Flibrustc%2Flib%2Fllvm.rs", "raw_url": "https://github.com/rust-lang/rust/raw/68903f2cdfbdcca81335914eb3c0dba4a3d8c61f/src%2Flibrustc%2Flib%2Fllvm.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Flib%2Fllvm.rs?ref=68903f2cdfbdcca81335914eb3c0dba4a3d8c61f", "patch": "@@ -1771,6 +1771,7 @@ pub mod llvm {\n         pub fn LLVMRustDestroyArchive(AR: ArchiveRef);\n \n         pub fn LLVMRustSetDLLExportStorageClass(V: ValueRef);\n+        pub fn LLVMVersionMinor() -> c_int;\n     }\n }\n "}, {"sha": "6a1fe8611e52185877d59770758c7c570d226360", "filename": "src/librustc/middle/trans/base.rs", "status": "modified", "additions": 26, "deletions": 4, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/68903f2cdfbdcca81335914eb3c0dba4a3d8c61f/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/68903f2cdfbdcca81335914eb3c0dba4a3d8c61f/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs?ref=68903f2cdfbdcca81335914eb3c0dba4a3d8c61f", "patch": "@@ -2286,8 +2286,6 @@ pub fn declare_intrinsics(llmod: ModuleRef) -> HashMap<&'static str, ValueRef> {\n \n     ifn!(intrinsics, \"llvm.fabs.f32\", [Type::f32()], Type::f32());\n     ifn!(intrinsics, \"llvm.fabs.f64\", [Type::f64()], Type::f64());\n-    ifn!(intrinsics, \"llvm.copysign.f32\", [Type::f32(), Type::f32()], Type::f32());\n-    ifn!(intrinsics, \"llvm.copysign.f64\", [Type::f64(), Type::f64()], Type::f64());\n \n     ifn!(intrinsics, \"llvm.floor.f32\",[Type::f32()], Type::f32());\n     ifn!(intrinsics, \"llvm.floor.f64\",[Type::f64()], Type::f64());\n@@ -2300,8 +2298,6 @@ pub fn declare_intrinsics(llmod: ModuleRef) -> HashMap<&'static str, ValueRef> {\n     ifn!(intrinsics, \"llvm.rint.f64\", [Type::f64()], Type::f64());\n     ifn!(intrinsics, \"llvm.nearbyint.f32\", [Type::f32()], Type::f32());\n     ifn!(intrinsics, \"llvm.nearbyint.f64\", [Type::f64()], Type::f64());\n-    ifn!(intrinsics, \"llvm.round.f32\", [Type::f32()], Type::f32());\n-    ifn!(intrinsics, \"llvm.round.f64\", [Type::f64()], Type::f64());\n \n     ifn!(intrinsics, \"llvm.ctpop.i8\", [Type::i8()], Type::i8());\n     ifn!(intrinsics, \"llvm.ctpop.i16\",[Type::i16()], Type::i16());\n@@ -2378,6 +2374,32 @@ pub fn declare_intrinsics(llmod: ModuleRef) -> HashMap<&'static str, ValueRef> {\n \n     ifn!(intrinsics, \"llvm.expect.i1\", [Type::i1(), Type::i1()], Type::i1());\n \n+    // Some intrinsics were introduced in later versions of LLVM, but they have\n+    // fallbacks in libc or libm and such. Currently, all of these intrinsics\n+    // were introduced in LLVM 3.4, so we case on that.\n+    macro_rules! compatible_ifn (\n+        ($intrinsics:ident, $name:expr, $cname:expr, $args:expr, $ret:expr) => ({\n+            let name = $name;\n+            if unsafe { llvm::LLVMVersionMinor() >= 4 } {\n+                ifn!($intrinsics, $name, $args, $ret);\n+            } else {\n+                let f = decl_cdecl_fn(llmod, $cname,\n+                                      Type::func($args, &$ret),\n+                                      ty::mk_nil());\n+                $intrinsics.insert(name, f);\n+            }\n+        })\n+    )\n+\n+    compatible_ifn!(intrinsics, \"llvm.copysign.f32\", \"copysignf\",\n+                    [Type::f32(), Type::f32()], Type::f32());\n+    compatible_ifn!(intrinsics, \"llvm.copysign.f64\", \"copysign\",\n+                    [Type::f64(), Type::f64()], Type::f64());\n+    compatible_ifn!(intrinsics, \"llvm.round.f32\", \"roundf\",\n+                    [Type::f32()], Type::f32());\n+    compatible_ifn!(intrinsics, \"llvm.round.f64\", \"round\",\n+                    [Type::f64()], Type::f64());\n+\n     return intrinsics;\n }\n "}, {"sha": "aaaf512bcf3fe2cc5ae471523669498f5251b3d7", "filename": "src/rustllvm/RustWrapper.cpp", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/68903f2cdfbdcca81335914eb3c0dba4a3d8c61f/src%2Frustllvm%2FRustWrapper.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/68903f2cdfbdcca81335914eb3c0dba4a3d8c61f/src%2Frustllvm%2FRustWrapper.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustllvm%2FRustWrapper.cpp?ref=68903f2cdfbdcca81335914eb3c0dba4a3d8c61f", "patch": "@@ -652,3 +652,8 @@ LLVMRustSetDLLExportStorageClass(LLVMValueRef Value) {\n     LLVMSetLinkage(Value, LLVMDLLExportLinkage);\n }\n #endif\n+\n+extern \"C\" int\n+LLVMVersionMinor() {\n+    return LLVM_VERSION_MINOR;\n+}"}]}