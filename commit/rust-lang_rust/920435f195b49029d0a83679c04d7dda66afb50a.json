{"sha": "920435f195b49029d0a83679c04d7dda66afb50a", "node_id": "C_kwDOAAsO6NoAKDkyMDQzNWYxOTViNDkwMjlkMGE4MzY3OWMwNGQ3ZGRhNjZhZmI1MGE", "commit": {"author": {"name": "Chris Denton", "email": "christophersdenton@gmail.com", "date": "2022-12-02T14:07:58Z"}, "committer": {"name": "Chris Denton", "email": "christophersdenton@gmail.com", "date": "2022-12-02T14:32:06Z"}, "message": "Windows: make Command prefer non-verbatim paths\n\nWhen spawning Commands, the path we use can end up being queried using `env::current_exe` (or the equivalent in other languages). Not all applications handle these paths properly therefore we should have a stronger preference for non-verbatim paths when spawning processes.", "tree": {"sha": "221c57cd17f1ffa2dd6bd1cabe790de7dbb6c69a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/221c57cd17f1ffa2dd6bd1cabe790de7dbb6c69a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/920435f195b49029d0a83679c04d7dda66afb50a", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE+p/jD6jrzmnSIWJLcTRy8vRWJ94FAmOKDGYACgkQcTRy8vRW\nJ96axQ//cNI/GJir0QYtxo4ibkn6BSoXTRzRU28AKShGJNuJ+mog8y8RGW7Syx74\nyxhqasuYY4c6HBR13m41EgXiJFk5pVRQ1fRudCe1Gwb8lqMcLBp0QQ1IQVkKiAne\nNNTVp2sWeqvFKGZ8EXXtQAW9xXOVEYcxI/sHjyQyWhF+JHUTM21xK+Jf4wY/d65o\ngOV7AcfAqvSC1PrSKlkCb2S/mNugSaqXVPBSxE9zWqq8ILka0FaB/pEpx9DL/NBm\nzv/drSgvhVHAKoc0bKEbAQjluU/XzX+cWx+XGuu2u4GPpzDlEy6Z0AAAWgW5mJCZ\ny401E1Mkw3OdcPE7MkXuyBV4VjiMVv3VQMwafrOPvn/Tpvj9hWM79rH1HmxOWuPd\n0FQCrnMjPCbCD1QEkE66jqjPbzKEPieYjs5nmDVLJL2ndRcDu2EPTKhkbnlyO6bc\nlc8D6IKjLKfb+IEG5LxEGy8/mixvJbAdRfklU1jwjkXzHHDEqwq7cIKU4kCcPk3E\ne0cC/qMr7kWedFrM0+2Vo6KMqrbtzNjRodXcGw0gFmShohYxPh30vLNyIUiDe53H\nPlvRwN1yHGozKlC0pRm/dpu6HDk3ysYXbHiEpmVipkHCg3AvHrq8E9krZSAWuwik\nWp9XueuHrbgwXUsxOf3/81FBXlAzON5GKFL/hBH13agZUZrv/ZA=\n=DnK0\n-----END PGP SIGNATURE-----", "payload": "tree 221c57cd17f1ffa2dd6bd1cabe790de7dbb6c69a\nparent 11663b1b4857ffeafbd85a9a36c234d117373b76\nauthor Chris Denton <christophersdenton@gmail.com> 1669990078 +0000\ncommitter Chris Denton <christophersdenton@gmail.com> 1669991526 +0000\n\nWindows: make Command prefer non-verbatim paths\n\nWhen spawning Commands, the path we use can end up being queried using `env::current_exe` (or the equivalent in other languages). Not all applications handle these paths properly therefore we should have a stronger preference for non-verbatim paths when spawning processes.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/920435f195b49029d0a83679c04d7dda66afb50a", "html_url": "https://github.com/rust-lang/rust/commit/920435f195b49029d0a83679c04d7dda66afb50a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/920435f195b49029d0a83679c04d7dda66afb50a/comments", "author": {"login": "ChrisDenton", "id": 4459874, "node_id": "MDQ6VXNlcjQ0NTk4NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/4459874?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ChrisDenton", "html_url": "https://github.com/ChrisDenton", "followers_url": "https://api.github.com/users/ChrisDenton/followers", "following_url": "https://api.github.com/users/ChrisDenton/following{/other_user}", "gists_url": "https://api.github.com/users/ChrisDenton/gists{/gist_id}", "starred_url": "https://api.github.com/users/ChrisDenton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ChrisDenton/subscriptions", "organizations_url": "https://api.github.com/users/ChrisDenton/orgs", "repos_url": "https://api.github.com/users/ChrisDenton/repos", "events_url": "https://api.github.com/users/ChrisDenton/events{/privacy}", "received_events_url": "https://api.github.com/users/ChrisDenton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ChrisDenton", "id": 4459874, "node_id": "MDQ6VXNlcjQ0NTk4NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/4459874?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ChrisDenton", "html_url": "https://github.com/ChrisDenton", "followers_url": "https://api.github.com/users/ChrisDenton/followers", "following_url": "https://api.github.com/users/ChrisDenton/following{/other_user}", "gists_url": "https://api.github.com/users/ChrisDenton/gists{/gist_id}", "starred_url": "https://api.github.com/users/ChrisDenton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ChrisDenton/subscriptions", "organizations_url": "https://api.github.com/users/ChrisDenton/orgs", "repos_url": "https://api.github.com/users/ChrisDenton/repos", "events_url": "https://api.github.com/users/ChrisDenton/events{/privacy}", "received_events_url": "https://api.github.com/users/ChrisDenton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "11663b1b4857ffeafbd85a9a36c234d117373b76", "url": "https://api.github.com/repos/rust-lang/rust/commits/11663b1b4857ffeafbd85a9a36c234d117373b76", "html_url": "https://github.com/rust-lang/rust/commit/11663b1b4857ffeafbd85a9a36c234d117373b76"}], "stats": {"total": 100, "additions": 62, "deletions": 38}, "files": [{"sha": "49724161549188817ddd4e0a002eceb0c46967f9", "filename": "library/std/src/sys/windows/args.rs", "status": "modified", "additions": 17, "deletions": 6, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/920435f195b49029d0a83679c04d7dda66afb50a/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fargs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/920435f195b49029d0a83679c04d7dda66afb50a/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fargs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fargs.rs?ref=920435f195b49029d0a83679c04d7dda66afb50a", "patch": "@@ -11,10 +11,11 @@ use crate::fmt;\n use crate::io;\n use crate::num::NonZeroU16;\n use crate::os::windows::prelude::*;\n-use crate::path::PathBuf;\n-use crate::sys::c;\n+use crate::path::{Path, PathBuf};\n+use crate::sys::path::get_long_path;\n use crate::sys::process::ensure_no_nuls;\n use crate::sys::windows::os::current_exe;\n+use crate::sys::{c, to_u16s};\n use crate::sys_common::wstr::WStrUnits;\n use crate::vec;\n \n@@ -302,7 +303,7 @@ pub(crate) fn make_bat_command_line(\n /// Takes a path and tries to return a non-verbatim path.\n ///\n /// This is necessary because cmd.exe does not support verbatim paths.\n-pub(crate) fn to_user_path(mut path: Vec<u16>) -> io::Result<Vec<u16>> {\n+pub(crate) fn to_user_path(path: &Path) -> io::Result<Vec<u16>> {\n     use crate::ptr;\n     use crate::sys::windows::fill_utf16_buf;\n \n@@ -315,6 +316,8 @@ pub(crate) fn to_user_path(mut path: Vec<u16>) -> io::Result<Vec<u16>> {\n     const N: u16 = b'N' as _;\n     const C: u16 = b'C' as _;\n \n+    let mut path = to_u16s(path)?;\n+\n     // Early return if the path is too long to remove the verbatim prefix.\n     const LEGACY_MAX_PATH: usize = 260;\n     if path.len() > LEGACY_MAX_PATH {\n@@ -328,7 +331,13 @@ pub(crate) fn to_user_path(mut path: Vec<u16>) -> io::Result<Vec<u16>> {\n             fill_utf16_buf(\n                 |buffer, size| c::GetFullPathNameW(lpfilename, size, buffer, ptr::null_mut()),\n                 |full_path: &[u16]| {\n-                    if full_path == &path[4..path.len() - 1] { full_path.into() } else { path }\n+                    if full_path == &path[4..path.len() - 1] {\n+                        let mut path: Vec<u16> = full_path.into();\n+                        path.push(0);\n+                        path\n+                    } else {\n+                        path\n+                    }\n                 },\n             )\n         },\n@@ -341,7 +350,9 @@ pub(crate) fn to_user_path(mut path: Vec<u16>) -> io::Result<Vec<u16>> {\n                 |buffer, size| c::GetFullPathNameW(lpfilename, size, buffer, ptr::null_mut()),\n                 |full_path: &[u16]| {\n                     if full_path == &path[6..path.len() - 1] {\n-                        full_path.into()\n+                        let mut path: Vec<u16> = full_path.into();\n+                        path.push(0);\n+                        path\n                     } else {\n                         // Restore the 'C' in \"UNC\".\n                         path[6] = b'C' as u16;\n@@ -351,6 +362,6 @@ pub(crate) fn to_user_path(mut path: Vec<u16>) -> io::Result<Vec<u16>> {\n             )\n         },\n         // For everything else, leave the path unchanged.\n-        _ => Ok(path),\n+        _ => get_long_path(path, false),\n     }\n }"}, {"sha": "c3573d14c7f929cb87cc13faf81e1a8a40d615f3", "filename": "library/std/src/sys/windows/path.rs", "status": "modified", "additions": 41, "deletions": 24, "changes": 65, "blob_url": "https://github.com/rust-lang/rust/blob/920435f195b49029d0a83679c04d7dda66afb50a/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fpath.rs", "raw_url": "https://github.com/rust-lang/rust/raw/920435f195b49029d0a83679c04d7dda66afb50a/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fpath.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fpath.rs?ref=920435f195b49029d0a83679c04d7dda66afb50a", "patch": "@@ -220,6 +220,19 @@ fn parse_next_component(path: &OsStr, verbatim: bool) -> (&OsStr, &OsStr) {\n ///\n /// This path may or may not have a verbatim prefix.\n pub(crate) fn maybe_verbatim(path: &Path) -> io::Result<Vec<u16>> {\n+    let path = to_u16s(path)?;\n+    get_long_path(path, true)\n+}\n+\n+/// Get a normalized absolute path that can bypass path length limits.\n+///\n+/// Setting prefer_verbatim to true suggests a stronger preference for verbatim\n+/// paths even when not strictly necessary. This allows the Windows API to avoid\n+/// repeating our work. However, if the path may be given back to users or\n+/// passed to other application then it's preferable to use non-verbatim paths\n+/// when possible. Non-verbatim paths are better understood by users and handled\n+/// by more software.\n+pub(crate) fn get_long_path(mut path: Vec<u16>, prefer_verbatim: bool) -> io::Result<Vec<u16>> {\n     // Normally the MAX_PATH is 260 UTF-16 code units (including the NULL).\n     // However, for APIs such as CreateDirectory[1], the limit is 248.\n     //\n@@ -243,7 +256,6 @@ pub(crate) fn maybe_verbatim(path: &Path) -> io::Result<Vec<u16>> {\n     // \\\\?\\UNC\\\n     const UNC_PREFIX: &[u16] = &[SEP, SEP, QUERY, SEP, U, N, C, SEP];\n \n-    let mut path = to_u16s(path)?;\n     if path.starts_with(VERBATIM_PREFIX) || path.starts_with(NT_PREFIX) || path == &[0] {\n         // Early return for paths that are already verbatim or empty.\n         return Ok(path);\n@@ -275,29 +287,34 @@ pub(crate) fn maybe_verbatim(path: &Path) -> io::Result<Vec<u16>> {\n         |mut absolute| {\n             path.clear();\n \n-            // Secondly, add the verbatim prefix. This is easier here because we know the\n-            // path is now absolute and fully normalized (e.g. `/` has been changed to `\\`).\n-            let prefix = match absolute {\n-                // C:\\ => \\\\?\\C:\\\n-                [_, COLON, SEP, ..] => VERBATIM_PREFIX,\n-                // \\\\.\\ => \\\\?\\\n-                [SEP, SEP, DOT, SEP, ..] => {\n-                    absolute = &absolute[4..];\n-                    VERBATIM_PREFIX\n-                }\n-                // Leave \\\\?\\ and \\??\\ as-is.\n-                [SEP, SEP, QUERY, SEP, ..] | [SEP, QUERY, QUERY, SEP, ..] => &[],\n-                // \\\\ => \\\\?\\UNC\\\n-                [SEP, SEP, ..] => {\n-                    absolute = &absolute[2..];\n-                    UNC_PREFIX\n-                }\n-                // Anything else we leave alone.\n-                _ => &[],\n-            };\n-\n-            path.reserve_exact(prefix.len() + absolute.len() + 1);\n-            path.extend_from_slice(prefix);\n+            // Only prepend the prefix if needed.\n+            if prefer_verbatim || absolute.len() + 1 >= LEGACY_MAX_PATH {\n+                // Secondly, add the verbatim prefix. This is easier here because we know the\n+                // path is now absolute and fully normalized (e.g. `/` has been changed to `\\`).\n+                let prefix = match absolute {\n+                    // C:\\ => \\\\?\\C:\\\n+                    [_, COLON, SEP, ..] => VERBATIM_PREFIX,\n+                    // \\\\.\\ => \\\\?\\\n+                    [SEP, SEP, DOT, SEP, ..] => {\n+                        absolute = &absolute[4..];\n+                        VERBATIM_PREFIX\n+                    }\n+                    // Leave \\\\?\\ and \\??\\ as-is.\n+                    [SEP, SEP, QUERY, SEP, ..] | [SEP, QUERY, QUERY, SEP, ..] => &[],\n+                    // \\\\ => \\\\?\\UNC\\\n+                    [SEP, SEP, ..] => {\n+                        absolute = &absolute[2..];\n+                        UNC_PREFIX\n+                    }\n+                    // Anything else we leave alone.\n+                    _ => &[],\n+                };\n+\n+                path.reserve_exact(prefix.len() + absolute.len() + 1);\n+                path.extend_from_slice(prefix);\n+            } else {\n+                path.reserve_exact(absolute.len() + 1);\n+            }\n             path.extend_from_slice(absolute);\n             path.push(0);\n         },"}, {"sha": "82b3f6acde87bb77e960078fb7cc6bce3870523e", "filename": "library/std/src/sys/windows/process.rs", "status": "modified", "additions": 4, "deletions": 8, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/920435f195b49029d0a83679c04d7dda66afb50a/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fprocess.rs", "raw_url": "https://github.com/rust-lang/rust/raw/920435f195b49029d0a83679c04d7dda66afb50a/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fprocess.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fprocess.rs?ref=920435f195b49029d0a83679c04d7dda66afb50a", "patch": "@@ -270,11 +270,7 @@ impl Command {\n         let (program, mut cmd_str) = if is_batch_file {\n             (\n                 command_prompt()?,\n-                args::make_bat_command_line(\n-                    &args::to_user_path(program)?,\n-                    &self.args,\n-                    self.force_quotes_enabled,\n-                )?,\n+                args::make_bat_command_line(&program, &self.args, self.force_quotes_enabled)?,\n             )\n         } else {\n             let cmd_str = make_command_line(&self.program, &self.args, self.force_quotes_enabled)?;\n@@ -397,7 +393,7 @@ fn resolve_exe<'a>(\n         if has_exe_suffix {\n             // The application name is a path to a `.exe` file.\n             // Let `CreateProcessW` figure out if it exists or not.\n-            return path::maybe_verbatim(Path::new(exe_path));\n+            return args::to_user_path(Path::new(exe_path));\n         }\n         let mut path = PathBuf::from(exe_path);\n \n@@ -409,7 +405,7 @@ fn resolve_exe<'a>(\n             // It's ok to use `set_extension` here because the intent is to\n             // remove the extension that was just added.\n             path.set_extension(\"\");\n-            return path::maybe_verbatim(&path);\n+            return args::to_user_path(&path);\n         }\n     } else {\n         ensure_no_nuls(exe_path)?;\n@@ -497,7 +493,7 @@ where\n /// Check if a file exists without following symlinks.\n fn program_exists(path: &Path) -> Option<Vec<u16>> {\n     unsafe {\n-        let path = path::maybe_verbatim(path).ok()?;\n+        let path = args::to_user_path(path).ok()?;\n         // Getting attributes using `GetFileAttributesW` does not follow symlinks\n         // and it will almost always be successful if the link exists.\n         // There are some exceptions for special system files (e.g. the pagefile)"}]}