{"sha": "35ff2cf29570b2e0a94dbe014258284f6f000749", "node_id": "C_kwDOAAsO6NoAKDM1ZmYyY2YyOTU3MGIyZTBhOTRkYmUwMTQyNTgyODRmNmYwMDA3NDk", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-12-14T16:17:56Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-12-14T16:17:56Z"}, "message": "Rollup merge of #105399 - mikebenfield:lfs, r=thomcc\n\nUse more LFS functions.\n\nOn Linux, use mmap64, open64, openat64, and sendfile64 in place of their non-LFS counterparts.\n\nThis is relevant to #94173.\n\nWith these changes (together with rust-lang/backtrace-rs#501), the simple binaries I produce with rustc seem to have no non-LFS functions, so maybe #94173 is fixed. But I can't be sure if I've missed something and maybe some non-LFS functions could sneak in somehow.", "tree": {"sha": "ef344a3c2779cc9401354873aa51055522bdc783", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ef344a3c2779cc9401354873aa51055522bdc783"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/35ff2cf29570b2e0a94dbe014258284f6f000749", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjmfc0CRBK7hj4Ov3rIwAAIocIAGH63s8d60dzoW4Rlr4GOSGK\nB2YgrOFa6B5nNvo7hPMRC6Pyeh+HwRxrZLqGgyEtqreTfFUsAMyULP0oM9+2VeyR\ndN2uPCW+1/wVRyjDcsAvI8uSsUwc0kTXqU5F31uxAMSVenDDYNUpC+VNrU5s4nEu\nRBYFSe99vh0fyzhVMJvOIVMltnc6ZQ56xkEuTcXZ7kCHMhQS6sZJxiyzgZ52WDNF\nKlR28XNh9GBNL2bC1evJX0B8s1Qn54uPXCexnP5ssy+yuf/obfSsHzofT173htHC\njKBQteoL/d3pTh5E2yrtL/QcYDoIZONF0Ap6jR1AnDgKs/dHwn/TC202F+vRf2c=\n=+/F6\n-----END PGP SIGNATURE-----\n", "payload": "tree ef344a3c2779cc9401354873aa51055522bdc783\nparent ba64ba8b0dfd57f7d6d7399d0df7ded37d2af18d\nparent 27011b4185f5341e579d2a02cabd3dc7d7aa7149\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1671034676 +0100\ncommitter GitHub <noreply@github.com> 1671034676 +0100\n\nRollup merge of #105399 - mikebenfield:lfs, r=thomcc\n\nUse more LFS functions.\n\nOn Linux, use mmap64, open64, openat64, and sendfile64 in place of their non-LFS counterparts.\n\nThis is relevant to #94173.\n\nWith these changes (together with rust-lang/backtrace-rs#501), the simple binaries I produce with rustc seem to have no non-LFS functions, so maybe #94173 is fixed. But I can't be sure if I've missed something and maybe some non-LFS functions could sneak in somehow.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/35ff2cf29570b2e0a94dbe014258284f6f000749", "html_url": "https://github.com/rust-lang/rust/commit/35ff2cf29570b2e0a94dbe014258284f6f000749", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/35ff2cf29570b2e0a94dbe014258284f6f000749/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ba64ba8b0dfd57f7d6d7399d0df7ded37d2af18d", "url": "https://api.github.com/repos/rust-lang/rust/commits/ba64ba8b0dfd57f7d6d7399d0df7ded37d2af18d", "html_url": "https://github.com/rust-lang/rust/commit/ba64ba8b0dfd57f7d6d7399d0df7ded37d2af18d"}, {"sha": "27011b4185f5341e579d2a02cabd3dc7d7aa7149", "url": "https://api.github.com/repos/rust-lang/rust/commits/27011b4185f5341e579d2a02cabd3dc7d7aa7149", "html_url": "https://github.com/rust-lang/rust/commit/27011b4185f5341e579d2a02cabd3dc7d7aa7149"}], "stats": {"total": 39, "additions": 31, "deletions": 8}, "files": [{"sha": "818914a2df074d3f3d0ba46a57ef805f42dc6347", "filename": "library/std/src/sys/unix/fs.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/35ff2cf29570b2e0a94dbe014258284f6f000749/library%2Fstd%2Fsrc%2Fsys%2Funix%2Ffs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/35ff2cf29570b2e0a94dbe014258284f6f000749/library%2Fstd%2Fsrc%2Fsys%2Funix%2Ffs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Funix%2Ffs.rs?ref=35ff2cf29570b2e0a94dbe014258284f6f000749", "patch": "@@ -1759,8 +1759,13 @@ mod remove_dir_impl {\n     use crate::sys::common::small_c_string::run_path_with_cstr;\n     use crate::sys::{cvt, cvt_r};\n \n-    #[cfg(not(all(target_os = \"macos\", not(target_arch = \"aarch64\")),))]\n+    #[cfg(not(any(\n+        target_os = \"linux\",\n+        all(target_os = \"macos\", not(target_arch = \"aarch64\"))\n+    )))]\n     use libc::{fdopendir, openat, unlinkat};\n+    #[cfg(target_os = \"linux\")]\n+    use libc::{fdopendir, openat64 as openat, unlinkat};\n     #[cfg(all(target_os = \"macos\", not(target_arch = \"aarch64\")))]\n     use macos_weak::{fdopendir, openat, unlinkat};\n "}, {"sha": "6fa85e859c05b303495ac8e2d808832a13fd0e5b", "filename": "library/std/src/sys/unix/kernel_copy.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/35ff2cf29570b2e0a94dbe014258284f6f000749/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fkernel_copy.rs", "raw_url": "https://github.com/rust-lang/rust/raw/35ff2cf29570b2e0a94dbe014258284f6f000749/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fkernel_copy.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fkernel_copy.rs?ref=35ff2cf29570b2e0a94dbe014258284f6f000749", "patch": "@@ -61,6 +61,10 @@ use crate::ptr;\n use crate::sync::atomic::{AtomicBool, AtomicU8, Ordering};\n use crate::sys::cvt;\n use crate::sys::weak::syscall;\n+#[cfg(not(target_os = \"linux\"))]\n+use libc::sendfile as sendfile64;\n+#[cfg(target_os = \"linux\")]\n+use libc::sendfile64;\n use libc::{EBADF, EINVAL, ENOSYS, EOPNOTSUPP, EOVERFLOW, EPERM, EXDEV};\n \n #[cfg(test)]\n@@ -647,7 +651,7 @@ fn sendfile_splice(mode: SpliceMode, reader: RawFd, writer: RawFd, len: u64) ->\n \n         let result = match mode {\n             SpliceMode::Sendfile => {\n-                cvt(unsafe { libc::sendfile(writer, reader, ptr::null_mut(), chunk_size) })\n+                cvt(unsafe { sendfile64(writer, reader, ptr::null_mut(), chunk_size) })\n             }\n             SpliceMode::Splice => cvt(unsafe {\n                 splice(reader, ptr::null_mut(), writer, ptr::null_mut(), chunk_size, 0)"}, {"sha": "3d60941e84e393c0a7fac39d1fb70f736ed448db", "filename": "library/std/src/sys/unix/mod.rs", "status": "modified", "additions": 10, "deletions": 2, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/35ff2cf29570b2e0a94dbe014258284f6f000749/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/35ff2cf29570b2e0a94dbe014258284f6f000749/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fmod.rs?ref=35ff2cf29570b2e0a94dbe014258284f6f000749", "patch": "@@ -95,6 +95,10 @@ pub unsafe fn init(argc: isize, argv: *const *const u8, sigpipe: u8) {\n         )))]\n         'poll: {\n             use crate::sys::os::errno;\n+            #[cfg(not(target_os = \"linux\"))]\n+            use libc::open as open64;\n+            #[cfg(target_os = \"linux\")]\n+            use libc::open64;\n             let pfds: &mut [_] = &mut [\n                 libc::pollfd { fd: 0, events: 0, revents: 0 },\n                 libc::pollfd { fd: 1, events: 0, revents: 0 },\n@@ -116,7 +120,7 @@ pub unsafe fn init(argc: isize, argv: *const *const u8, sigpipe: u8) {\n                 if pfd.revents & libc::POLLNVAL == 0 {\n                     continue;\n                 }\n-                if libc::open(\"/dev/null\\0\".as_ptr().cast(), libc::O_RDWR, 0) == -1 {\n+                if open64(\"/dev/null\\0\".as_ptr().cast(), libc::O_RDWR, 0) == -1 {\n                     // If the stream is closed but we failed to reopen it, abort the\n                     // process. Otherwise we wouldn't preserve the safety of\n                     // operations on the corresponding Rust object Stdin, Stdout, or\n@@ -139,9 +143,13 @@ pub unsafe fn init(argc: isize, argv: *const *const u8, sigpipe: u8) {\n         )))]\n         {\n             use crate::sys::os::errno;\n+            #[cfg(not(target_os = \"linux\"))]\n+            use libc::open as open64;\n+            #[cfg(target_os = \"linux\")]\n+            use libc::open64;\n             for fd in 0..3 {\n                 if libc::fcntl(fd, libc::F_GETFD) == -1 && errno() == libc::EBADF {\n-                    if libc::open(\"/dev/null\\0\".as_ptr().cast(), libc::O_RDWR, 0) == -1 {\n+                    if open64(\"/dev/null\\0\".as_ptr().cast(), libc::O_RDWR, 0) == -1 {\n                         // If the stream is closed but we failed to reopen it, abort the\n                         // process. Otherwise we wouldn't preserve the safety of\n                         // operations on the corresponding Rust object Stdin, Stdout, or"}, {"sha": "957e086798fd3cd786acd7f01970f42b813f2231", "filename": "library/std/src/sys/unix/stack_overflow.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/35ff2cf29570b2e0a94dbe014258284f6f000749/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fstack_overflow.rs", "raw_url": "https://github.com/rust-lang/rust/raw/35ff2cf29570b2e0a94dbe014258284f6f000749/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fstack_overflow.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fstack_overflow.rs?ref=35ff2cf29570b2e0a94dbe014258284f6f000749", "patch": "@@ -45,7 +45,10 @@ mod imp {\n     use crate::thread;\n \n     use libc::MAP_FAILED;\n-    use libc::{mmap, munmap};\n+    #[cfg(not(target_os = \"linux\"))]\n+    use libc::{mmap as mmap64, munmap};\n+    #[cfg(target_os = \"linux\")]\n+    use libc::{mmap64, munmap};\n     use libc::{sigaction, sighandler_t, SA_ONSTACK, SA_SIGINFO, SIGBUS, SIG_DFL};\n     use libc::{sigaltstack, SIGSTKSZ, SS_DISABLE};\n     use libc::{MAP_ANON, MAP_PRIVATE, PROT_NONE, PROT_READ, PROT_WRITE, SIGSEGV};\n@@ -135,7 +138,7 @@ mod imp {\n         #[cfg(not(any(target_os = \"openbsd\", target_os = \"netbsd\", target_os = \"linux\",)))]\n         let flags = MAP_PRIVATE | MAP_ANON;\n         let stackp =\n-            mmap(ptr::null_mut(), SIGSTKSZ + page_size(), PROT_READ | PROT_WRITE, flags, -1, 0);\n+            mmap64(ptr::null_mut(), SIGSTKSZ + page_size(), PROT_READ | PROT_WRITE, flags, -1, 0);\n         if stackp == MAP_FAILED {\n             panic!(\"failed to allocate an alternative stack: {}\", io::Error::last_os_error());\n         }"}, {"sha": "d454a2a717c0639a326555d3dc8b21a60450b1dd", "filename": "library/std/src/sys/unix/thread.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/35ff2cf29570b2e0a94dbe014258284f6f000749/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fthread.rs", "raw_url": "https://github.com/rust-lang/rust/raw/35ff2cf29570b2e0a94dbe014258284f6f000749/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fthread.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fthread.rs?ref=35ff2cf29570b2e0a94dbe014258284f6f000749", "patch": "@@ -653,7 +653,10 @@ pub mod guard {\n ))]\n #[cfg_attr(test, allow(dead_code))]\n pub mod guard {\n-    use libc::{mmap, mprotect};\n+    #[cfg(not(target_os = \"linux\"))]\n+    use libc::{mmap as mmap64, mprotect};\n+    #[cfg(target_os = \"linux\")]\n+    use libc::{mmap64, mprotect};\n     use libc::{MAP_ANON, MAP_FAILED, MAP_FIXED, MAP_PRIVATE, PROT_NONE, PROT_READ, PROT_WRITE};\n \n     use crate::io;\n@@ -803,7 +806,7 @@ pub mod guard {\n             // read/write permissions and only then mprotect() it to\n             // no permissions at all. See issue #50313.\n             let stackptr = get_stack_start_aligned()?;\n-            let result = mmap(\n+            let result = mmap64(\n                 stackptr,\n                 page_size,\n                 PROT_READ | PROT_WRITE,"}]}