{"sha": "fed52706def9a9f5d33edc7dd9848a02ae475ba5", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZlZDUyNzA2ZGVmOWE5ZjVkMzNlZGM3ZGQ5ODQ4YTAyYWU0NzViYTU=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-06-07T17:49:29Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-06-12T10:36:24Z"}, "message": "make LRU cache configurable", "tree": {"sha": "be508002355e87b97bd98a64f1678f431ed4b3ae", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/be508002355e87b97bd98a64f1678f431ed4b3ae"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fed52706def9a9f5d33edc7dd9848a02ae475ba5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fed52706def9a9f5d33edc7dd9848a02ae475ba5", "html_url": "https://github.com/rust-lang/rust/commit/fed52706def9a9f5d33edc7dd9848a02ae475ba5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fed52706def9a9f5d33edc7dd9848a02ae475ba5/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "15668119de40b97011a1f2e2d065d11f25a5833a", "url": "https://api.github.com/repos/rust-lang/rust/commits/15668119de40b97011a1f2e2d065d11f25a5833a", "html_url": "https://github.com/rust-lang/rust/commit/15668119de40b97011a1f2e2d065d11f25a5833a"}], "stats": {"total": 59, "additions": 48, "deletions": 11}, "files": [{"sha": "b3f395502eede7e293778ccfe18c98f1999545f4", "filename": "crates/ra_ide_api/src/db.rs", "status": "modified", "additions": 9, "deletions": 3, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/fed52706def9a9f5d33edc7dd9848a02ae475ba5/crates%2Fra_ide_api%2Fsrc%2Fdb.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fed52706def9a9f5d33edc7dd9848a02ae475ba5/crates%2Fra_ide_api%2Fsrc%2Fdb.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2Fsrc%2Fdb.rs?ref=fed52706def9a9f5d33edc7dd9848a02ae475ba5", "patch": "@@ -41,6 +41,12 @@ impl salsa::Database for RootDatabase {\n \n impl Default for RootDatabase {\n     fn default() -> RootDatabase {\n+        RootDatabase::new(None)\n+    }\n+}\n+\n+impl RootDatabase {\n+    pub fn new(lru_capacity: Option<usize>) -> RootDatabase {\n         let mut db = RootDatabase {\n             runtime: salsa::Runtime::default(),\n             last_gc: time::Instant::now(),\n@@ -49,9 +55,9 @@ impl Default for RootDatabase {\n         db.set_crate_graph(Default::default());\n         db.set_local_roots(Default::default());\n         db.set_library_roots(Default::default());\n-        let lru_cap = ra_db::DEFAULT_LRU_CAP;\n-        db.query_mut(ra_db::ParseQuery).set_lru_capacity(lru_cap);\n-        db.query_mut(hir::db::ParseMacroQuery).set_lru_capacity(lru_cap);\n+        let lru_capacity = lru_capacity.unwrap_or(ra_db::DEFAULT_LRU_CAP);\n+        db.query_mut(ra_db::ParseQuery).set_lru_capacity(lru_capacity);\n+        db.query_mut(hir::db::ParseMacroQuery).set_lru_capacity(lru_capacity);\n         db\n     }\n }"}, {"sha": "8741e736f517b2ef9698e6f6a454fe72e84337f1", "filename": "crates/ra_ide_api/src/lib.rs", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/fed52706def9a9f5d33edc7dd9848a02ae475ba5/crates%2Fra_ide_api%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fed52706def9a9f5d33edc7dd9848a02ae475ba5/crates%2Fra_ide_api%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2Fsrc%2Flib.rs?ref=fed52706def9a9f5d33edc7dd9848a02ae475ba5", "patch": "@@ -242,12 +242,21 @@ pub struct CallInfo {\n }\n \n /// `AnalysisHost` stores the current state of the world.\n-#[derive(Debug, Default)]\n+#[derive(Debug)]\n pub struct AnalysisHost {\n     db: db::RootDatabase,\n }\n \n+impl Default for AnalysisHost {\n+    fn default() -> AnalysisHost {\n+        AnalysisHost::new(None)\n+    }\n+}\n+\n impl AnalysisHost {\n+    pub fn new(lru_capcity: Option<usize>) -> AnalysisHost {\n+        AnalysisHost { db: db::RootDatabase::new(lru_capcity) }\n+    }\n     /// Returns a snapshot of the current state, which you can query for\n     /// semantic information.\n     pub fn analysis(&self) -> Analysis {"}, {"sha": "b894b449d78c28c3c608540cfe37611821af1243", "filename": "crates/ra_lsp_server/src/init.rs", "status": "modified", "additions": 11, "deletions": 3, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/fed52706def9a9f5d33edc7dd9848a02ae475ba5/crates%2Fra_lsp_server%2Fsrc%2Finit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fed52706def9a9f5d33edc7dd9848a02ae475ba5/crates%2Fra_lsp_server%2Fsrc%2Finit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2Fsrc%2Finit.rs?ref=fed52706def9a9f5d33edc7dd9848a02ae475ba5", "patch": "@@ -17,11 +17,17 @@ pub struct InitializationOptions {\n     /// Defaults to `true`\n     #[serde(deserialize_with = \"nullable_bool_true\")]\n     pub show_workspace_loaded: bool,\n+\n+    pub lru_capacity: Option<usize>,\n }\n \n impl Default for InitializationOptions {\n     fn default() -> InitializationOptions {\n-        InitializationOptions { publish_decorations: false, show_workspace_loaded: true }\n+        InitializationOptions {\n+            publish_decorations: false,\n+            show_workspace_loaded: true,\n+            lru_capacity: None,\n+        }\n     }\n }\n \n@@ -54,8 +60,10 @@ mod test {\n         assert_eq!(default, serde_json::from_str(r#\"{}\"#).unwrap());\n         assert_eq!(\n             default,\n-            serde_json::from_str(r#\"{\"publishDecorations\":null, \"showWorkspaceLoaded\":null}\"#)\n-                .unwrap()\n+            serde_json::from_str(\n+                r#\"{\"publishDecorations\":null, \"showWorkspaceLoaded\":null, \"lruCapacity\":null}\"#\n+            )\n+            .unwrap()\n         );\n     }\n }"}, {"sha": "0790ea472ec64be82f1d33bca4edf58af47b70ca", "filename": "crates/ra_lsp_server/src/main_loop.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/fed52706def9a9f5d33edc7dd9848a02ae475ba5/crates%2Fra_lsp_server%2Fsrc%2Fmain_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fed52706def9a9f5d33edc7dd9848a02ae475ba5/crates%2Fra_lsp_server%2Fsrc%2Fmain_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2Fsrc%2Fmain_loop.rs?ref=fed52706def9a9f5d33edc7dd9848a02ae475ba5", "patch": "@@ -73,7 +73,7 @@ pub fn main_loop(\n         loaded_workspaces\n     };\n \n-    let mut state = WorldState::new(ws_roots, workspaces);\n+    let mut state = WorldState::new(ws_roots, workspaces, options.lru_capacity);\n \n     let pool = ThreadPool::new(THREADPOOL_SIZE);\n     let (task_sender, task_receiver) = unbounded::<Task>();"}, {"sha": "f9ce570ca34320c7eade7a181ef16358a71f1396", "filename": "crates/ra_lsp_server/src/world.rs", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/fed52706def9a9f5d33edc7dd9848a02ae475ba5/crates%2Fra_lsp_server%2Fsrc%2Fworld.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fed52706def9a9f5d33edc7dd9848a02ae475ba5/crates%2Fra_lsp_server%2Fsrc%2Fworld.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2Fsrc%2Fworld.rs?ref=fed52706def9a9f5d33edc7dd9848a02ae475ba5", "patch": "@@ -46,7 +46,11 @@ pub struct WorldSnapshot {\n }\n \n impl WorldState {\n-    pub fn new(folder_roots: Vec<PathBuf>, workspaces: Vec<ProjectWorkspace>) -> WorldState {\n+    pub fn new(\n+        folder_roots: Vec<PathBuf>,\n+        workspaces: Vec<ProjectWorkspace>,\n+        lru_capacity: Option<usize>,\n+    ) -> WorldState {\n         let mut change = AnalysisChange::new();\n \n         let mut roots = Vec::new();\n@@ -74,7 +78,7 @@ impl WorldState {\n         }\n         change.set_crate_graph(crate_graph);\n \n-        let mut analysis_host = AnalysisHost::default();\n+        let mut analysis_host = AnalysisHost::new(lru_capacity);\n         analysis_host.apply_change(change);\n         WorldState {\n             roots_to_scan,"}, {"sha": "c2ed8d1268fe45b001d6a97e053f1ba15eca5cb4", "filename": "editors/code/package.json", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/fed52706def9a9f5d33edc7dd9848a02ae475ba5/editors%2Fcode%2Fpackage.json", "raw_url": "https://github.com/rust-lang/rust/raw/fed52706def9a9f5d33edc7dd9848a02ae475ba5/editors%2Fcode%2Fpackage.json", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fpackage.json?ref=fed52706def9a9f5d33edc7dd9848a02ae475ba5", "patch": "@@ -232,6 +232,11 @@\n                     ],\n                     \"default\": \"off\",\n                     \"description\": \"Trace output of cargo-watch\"\n+                },\n+                \"rust-analyzer.lruCapacity\": {\n+                    \"type\": \"number\",\n+                    \"default\": null,\n+                    \"description\": \"Number of syntax trees rust-analyzer keeps in memory\"\n                 }\n             }\n         },"}, {"sha": "3024546d25e0e6ba93c5f853173f3c75df968481", "filename": "editors/code/src/config.ts", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/fed52706def9a9f5d33edc7dd9848a02ae475ba5/editors%2Fcode%2Fsrc%2Fconfig.ts", "raw_url": "https://github.com/rust-lang/rust/raw/fed52706def9a9f5d33edc7dd9848a02ae475ba5/editors%2Fcode%2Fsrc%2Fconfig.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fconfig.ts?ref=fed52706def9a9f5d33edc7dd9848a02ae475ba5", "patch": "@@ -19,6 +19,7 @@ export class Config {\n     public enableEnhancedTyping = true;\n     public raLspServerPath = RA_LSP_DEBUG || 'ra_lsp_server';\n     public showWorkspaceLoadedNotification = true;\n+    public lruCapacity: null | number = null;\n     public cargoWatchOptions: CargoWatchOptions = {\n         enableOnStartup: 'ask',\n         trace: 'off',\n@@ -109,5 +110,8 @@ export class Config {\n                 ''\n             );\n         }\n+        if (config.has('lruCapacity')) {\n+            this.lruCapacity = config.get('lruCapacity') as number;\n+        }\n     }\n }"}, {"sha": "7029142fdcd5ecc9ee1ac5511597c1062de3a6a3", "filename": "editors/code/src/server.ts", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/fed52706def9a9f5d33edc7dd9848a02ae475ba5/editors%2Fcode%2Fsrc%2Fserver.ts", "raw_url": "https://github.com/rust-lang/rust/raw/fed52706def9a9f5d33edc7dd9848a02ae475ba5/editors%2Fcode%2Fsrc%2Fserver.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fserver.ts?ref=fed52706def9a9f5d33edc7dd9848a02ae475ba5", "patch": "@@ -35,7 +35,8 @@ export class Server {\n             initializationOptions: {\n                 publishDecorations: true,\n                 showWorkspaceLoaded:\n-                    Server.config.showWorkspaceLoadedNotification\n+                    Server.config.showWorkspaceLoadedNotification,\n+                lruCapacity: Server.config.lruCapacity\n             },\n             traceOutputChannel\n         };"}]}