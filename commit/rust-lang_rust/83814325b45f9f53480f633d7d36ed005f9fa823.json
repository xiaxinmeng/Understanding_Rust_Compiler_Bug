{"sha": "83814325b45f9f53480f633d7d36ed005f9fa823", "node_id": "MDY6Q29tbWl0NzI0NzEyOjgzODE0MzI1YjQ1ZjlmNTM0ODBmNjMzZDdkMzZlZDAwNWY5ZmE4MjM=", "commit": {"author": {"name": "Nicholas Mazzuca", "email": "npmazzuca@gmail.com", "date": "2015-04-29T01:20:30Z"}, "committer": {"name": "Nicholas Mazzuca", "email": "npmazzuca@gmail.com", "date": "2015-04-29T01:20:30Z"}, "message": "Add intrinsics for unchecked division and modulo\n\nThe \"unchecked_\" div and rem functions will give UB in case of rhs == 0, or,\nin the signed versions, lhs == INT::min and rhs == -1", "tree": {"sha": "af86c9a013758c74a2d58364124ffd8d3a4b904a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/af86c9a013758c74a2d58364124ffd8d3a4b904a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/83814325b45f9f53480f633d7d36ed005f9fa823", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/83814325b45f9f53480f633d7d36ed005f9fa823", "html_url": "https://github.com/rust-lang/rust/commit/83814325b45f9f53480f633d7d36ed005f9fa823", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/83814325b45f9f53480f633d7d36ed005f9fa823/comments", "author": {"login": "ubsan", "id": 60298436, "node_id": "MDQ6VXNlcjYwMjk4NDM2", "avatar_url": "https://avatars.githubusercontent.com/u/60298436?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ubsan", "html_url": "https://github.com/ubsan", "followers_url": "https://api.github.com/users/ubsan/followers", "following_url": "https://api.github.com/users/ubsan/following{/other_user}", "gists_url": "https://api.github.com/users/ubsan/gists{/gist_id}", "starred_url": "https://api.github.com/users/ubsan/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ubsan/subscriptions", "organizations_url": "https://api.github.com/users/ubsan/orgs", "repos_url": "https://api.github.com/users/ubsan/repos", "events_url": "https://api.github.com/users/ubsan/events{/privacy}", "received_events_url": "https://api.github.com/users/ubsan/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ubsan", "id": 60298436, "node_id": "MDQ6VXNlcjYwMjk4NDM2", "avatar_url": "https://avatars.githubusercontent.com/u/60298436?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ubsan", "html_url": "https://github.com/ubsan", "followers_url": "https://api.github.com/users/ubsan/followers", "following_url": "https://api.github.com/users/ubsan/following{/other_user}", "gists_url": "https://api.github.com/users/ubsan/gists{/gist_id}", "starred_url": "https://api.github.com/users/ubsan/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ubsan/subscriptions", "organizations_url": "https://api.github.com/users/ubsan/orgs", "repos_url": "https://api.github.com/users/ubsan/repos", "events_url": "https://api.github.com/users/ubsan/events{/privacy}", "received_events_url": "https://api.github.com/users/ubsan/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8871c17b76a1e0ab36ce2bb51008b53f596e5b3c", "url": "https://api.github.com/repos/rust-lang/rust/commits/8871c17b76a1e0ab36ce2bb51008b53f596e5b3c", "html_url": "https://github.com/rust-lang/rust/commit/8871c17b76a1e0ab36ce2bb51008b53f596e5b3c"}], "stats": {"total": 31, "additions": 31, "deletions": 0}, "files": [{"sha": "c6bb1fb1cb164c545cd7896bdb27781119661c53", "filename": "src/libcore/intrinsics.rs", "status": "modified", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/83814325b45f9f53480f633d7d36ed005f9fa823/src%2Flibcore%2Fintrinsics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/83814325b45f9f53480f633d7d36ed005f9fa823/src%2Flibcore%2Fintrinsics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fintrinsics.rs?ref=83814325b45f9f53480f633d7d36ed005f9fa823", "patch": "@@ -576,3 +576,20 @@ extern \"rust-intrinsic\" {\n     #[cfg(not(stage0))]\n     pub fn discriminant_value<T>(v: &T) -> u64;\n }\n+\n+#[cfg(not(stage0))]\n+extern \"rust-intrinsic\" {\n+    /// Performs an unchecked signed division, which results in undefined behavior,\n+    /// in cases where y == 0, or x == int::MIN and y == -1\n+    pub fn unchecked_sdiv<T>(x: T, y: T) -> T;\n+    /// Performs an unchecked unsigned division, which results in undefined behavior,\n+    /// in cases where y == 0\n+    pub fn unchecked_udiv<T>(x: T, y: T) -> T;\n+\n+    /// Returns the remainder of an unchecked signed division, which results in\n+    /// undefined behavior, in cases where y == 0, or x == int::MIN and y == -1\n+    pub fn unchecked_urem<T>(x: T, y: T) -> T;\n+    /// Returns the remainder of an unchecked signed division, which results in\n+    /// undefined behavior, in cases where y == 0\n+    pub fn unchecked_srem<T>(x: T, y: T) -> T;\n+}"}, {"sha": "41ef566f2fd7f8e916c7af0039a62e28d91dc9c4", "filename": "src/librustc_trans/trans/context.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/83814325b45f9f53480f633d7d36ed005f9fa823/src%2Flibrustc_trans%2Ftrans%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/83814325b45f9f53480f633d7d36ed005f9fa823/src%2Flibrustc_trans%2Ftrans%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Ftrans%2Fcontext.rs?ref=83814325b45f9f53480f633d7d36ed005f9fa823", "patch": "@@ -735,6 +735,7 @@ impl<'b, 'tcx> CrateContext<'b, 'tcx> {\n     }\n }\n \n+/// Declare any llvm intrinsics that you might need\n fn declare_intrinsic(ccx: &CrateContext, key: & &'static str) -> Option<ValueRef> {\n     macro_rules! ifn {\n         ($name:expr, fn() -> $ret:expr) => ("}, {"sha": "ed0beee20b04009cd3ed2932133ee44e0ec4b9e4", "filename": "src/librustc_trans/trans/intrinsic.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/83814325b45f9f53480f633d7d36ed005f9fa823/src%2Flibrustc_trans%2Ftrans%2Fintrinsic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/83814325b45f9f53480f633d7d36ed005f9fa823/src%2Flibrustc_trans%2Ftrans%2Fintrinsic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Ftrans%2Fintrinsic.rs?ref=83814325b45f9f53480f633d7d36ed005f9fa823", "patch": "@@ -144,6 +144,9 @@ pub fn check_intrinsics(ccx: &CrateContext) {\n     ccx.sess().abort_if_errors();\n }\n \n+/// Remember to add all intrinsics here, in librustc_typeck/check/mod.rs,\n+/// and in libcore/intrinsics.rs; if you need access to any llvm intrinsics,\n+/// add them to librustc_trans/trans/context.rs\n pub fn trans_intrinsic_call<'a, 'blk, 'tcx>(mut bcx: Block<'blk, 'tcx>,\n                                             node: ast::NodeId,\n                                             callee_ty: Ty<'tcx>,\n@@ -676,6 +679,11 @@ pub fn trans_intrinsic_call<'a, 'blk, 'tcx>(mut bcx: Block<'blk, 'tcx>,\n                                     llargs[1],\n                                     call_debug_location),\n \n+        (_, \"unchecked_udiv\") => UDiv(bcx, llargs[0], llargs[1], call_debug_location),\n+        (_, \"unchecked_sdiv\") => SDiv(bcx, llargs[0], llargs[1], call_debug_location),\n+        (_, \"unchecked_urem\") => URem(bcx, llargs[0], llargs[1], call_debug_location),\n+        (_, \"unchecked_srem\") => SRem(bcx, llargs[0], llargs[1], call_debug_location),\n+\n         (_, \"overflowing_add\") => Add(bcx, llargs[0], llargs[1], call_debug_location),\n         (_, \"overflowing_sub\") => Sub(bcx, llargs[0], llargs[1], call_debug_location),\n         (_, \"overflowing_mul\") => Mul(bcx, llargs[0], llargs[1], call_debug_location),"}, {"sha": "c285483214026b1135184f2bcf25dd2d26ef1967", "filename": "src/librustc_typeck/check/mod.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/83814325b45f9f53480f633d7d36ed005f9fa823/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/83814325b45f9f53480f633d7d36ed005f9fa823/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs?ref=83814325b45f9f53480f633d7d36ed005f9fa823", "patch": "@@ -4882,6 +4882,8 @@ pub fn check_bounds_are_used<'a, 'tcx>(ccx: &CrateCtxt<'a, 'tcx>,\n     }\n }\n \n+/// Remember to add all intrinsics here, in librustc_trans/trans/intrinsic.rs,\n+/// and in libcore/intrinsics.rs\n pub fn check_intrinsic_type(ccx: &CrateCtxt, it: &ast::ForeignItem) {\n     fn param<'a, 'tcx>(ccx: &CrateCtxt<'a, 'tcx>, n: u32) -> Ty<'tcx> {\n         let name = token::intern(&format!(\"P{}\", n));\n@@ -5119,6 +5121,9 @@ pub fn check_intrinsic_type(ccx: &CrateCtxt, it: &ast::ForeignItem) {\n                 (0, vec!(tcx.types.u64, tcx.types.u64),\n                 ty::mk_tup(tcx, vec!(tcx.types.u64, tcx.types.bool))),\n \n+            \"unchecked_udiv\" | \"unchecked_sdiv\" | \"unchecked_urem\" | \"unchecked_srem\" =>\n+                (1, vec![param(ccx, 0), param(ccx, 0)], param(ccx, 0)),\n+\n             \"overflowing_add\" | \"overflowing_sub\" | \"overflowing_mul\" =>\n                 (1, vec![param(ccx, 0), param(ccx, 0)], param(ccx, 0)),\n "}]}