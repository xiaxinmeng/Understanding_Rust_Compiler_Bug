{"sha": "bd9d843ae488e4571186f676d63798f762544c1e", "node_id": "MDY6Q29tbWl0NzI0NzEyOmJkOWQ4NDNhZTQ4OGU0NTcxMTg2ZjY3NmQ2Mzc5OGY3NjI1NDRjMWU=", "commit": {"author": {"name": "Tyler Mandry", "email": "tmandry@gmail.com", "date": "2019-10-02T06:06:12Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-10-02T06:06:12Z"}, "message": "Rollup merge of #64801 - nnethercote:improve-find_constraint_paths_between_regions, r=estebank\n\nAvoid `chain()` in `find_constraint_paths_between_regions()`.\n\nThis iterator can be hot, and chained iterators are slow. The second\nhalf of the chain is almost always empty, so this commit specializes the\ncode to avoid the chained iteration.\n\nThis change reduces instruction counts for the `wg-grammar` benchmark by\nup to 1.5%.", "tree": {"sha": "489bcf4fb0bac4155aabbf70931e9550e982cc3f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/489bcf4fb0bac4155aabbf70931e9550e982cc3f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bd9d843ae488e4571186f676d63798f762544c1e", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJdlD5VCRBK7hj4Ov3rIwAAdHIIAGrtpt9oan7CWFyIluxps7Mb\nvoum7GVf3UhMFyPW33x2Ct9DOARsj/j/TpxkhEH/jUeMm2a3EWvGn3Yh1IEBWscE\n2m5QMdVcltHXlER8zOflwNWYcfui9sls2G5tByQFyxgsuhSe3IiH/OL0Qq4E1FDu\nNe5f2H4pdMmGuKVxvx/pcNvSosUGj2qGIEEkreNn8OOlg5MCe6VA8IruxKTuJeAG\ni1qMkyC9aoKrBQMx+yhFMpeTJtMn/9LmssQS1OzyslDCZHPlyMK60a1OeGBW9aCQ\nexJ7TFs+BmL4634NZ74pFGcYqpZ5ckeH7jq6c+ynawKR8PdC2b15sDePg9saM6M=\n=x/dL\n-----END PGP SIGNATURE-----\n", "payload": "tree 489bcf4fb0bac4155aabbf70931e9550e982cc3f\nparent 65a050fddc7071611f0b3ae26efa64c5a23292b3\nparent 5ca99b750e455e9b5e13e83d0d7886486231e48a\nauthor Tyler Mandry <tmandry@gmail.com> 1569996372 -0700\ncommitter GitHub <noreply@github.com> 1569996372 -0700\n\nRollup merge of #64801 - nnethercote:improve-find_constraint_paths_between_regions, r=estebank\n\nAvoid `chain()` in `find_constraint_paths_between_regions()`.\n\nThis iterator can be hot, and chained iterators are slow. The second\nhalf of the chain is almost always empty, so this commit specializes the\ncode to avoid the chained iteration.\n\nThis change reduces instruction counts for the `wg-grammar` benchmark by\nup to 1.5%.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bd9d843ae488e4571186f676d63798f762544c1e", "html_url": "https://github.com/rust-lang/rust/commit/bd9d843ae488e4571186f676d63798f762544c1e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bd9d843ae488e4571186f676d63798f762544c1e/comments", "author": {"login": "tmandry", "id": 2280544, "node_id": "MDQ6VXNlcjIyODA1NDQ=", "avatar_url": "https://avatars.githubusercontent.com/u/2280544?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmandry", "html_url": "https://github.com/tmandry", "followers_url": "https://api.github.com/users/tmandry/followers", "following_url": "https://api.github.com/users/tmandry/following{/other_user}", "gists_url": "https://api.github.com/users/tmandry/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmandry/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmandry/subscriptions", "organizations_url": "https://api.github.com/users/tmandry/orgs", "repos_url": "https://api.github.com/users/tmandry/repos", "events_url": "https://api.github.com/users/tmandry/events{/privacy}", "received_events_url": "https://api.github.com/users/tmandry/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "65a050fddc7071611f0b3ae26efa64c5a23292b3", "url": "https://api.github.com/repos/rust-lang/rust/commits/65a050fddc7071611f0b3ae26efa64c5a23292b3", "html_url": "https://github.com/rust-lang/rust/commit/65a050fddc7071611f0b3ae26efa64c5a23292b3"}, {"sha": "5ca99b750e455e9b5e13e83d0d7886486231e48a", "url": "https://api.github.com/repos/rust-lang/rust/commits/5ca99b750e455e9b5e13e83d0d7886486231e48a", "html_url": "https://github.com/rust-lang/rust/commit/5ca99b750e455e9b5e13e83d0d7886486231e48a"}], "stats": {"total": 40, "additions": 22, "deletions": 18}, "files": [{"sha": "502da588d19a261f1479709848759b771877aeb7", "filename": "src/librustc_mir/borrow_check/nll/region_infer/error_reporting/mod.rs", "status": "modified", "additions": 21, "deletions": 18, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/bd9d843ae488e4571186f676d63798f762544c1e/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Fregion_infer%2Ferror_reporting%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bd9d843ae488e4571186f676d63798f762544c1e/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Fregion_infer%2Ferror_reporting%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Fregion_infer%2Ferror_reporting%2Fmod.rs?ref=bd9d843ae488e4571186f676d63798f762544c1e", "patch": "@@ -1,5 +1,4 @@\n use crate::borrow_check::nll::constraints::OutlivesConstraint;\n-use crate::borrow_check::nll::region_infer::AppliedMemberConstraint;\n use crate::borrow_check::nll::region_infer::RegionInferenceContext;\n use crate::borrow_check::nll::type_check::Locations;\n use crate::borrow_check::nll::universal_regions::DefiningTy;\n@@ -253,29 +252,33 @@ impl<'tcx> RegionInferenceContext<'tcx> {\n             let outgoing_edges_from_graph = self.constraint_graph\n                 .outgoing_edges(r, &self.constraints, fr_static);\n \n-\n-            // But member constraints can also give rise to `'r: 'x`\n-            // edges that were not part of the graph initially, so\n-            // watch out for those.\n-            let outgoing_edges_from_picks = self.applied_member_constraints(r)\n-                .iter()\n-                .map(|&AppliedMemberConstraint { min_choice, member_constraint_index, .. }| {\n-                    let p_c = &self.member_constraints[member_constraint_index];\n-                    OutlivesConstraint {\n-                        sup: r,\n-                        sub: min_choice,\n-                        locations: Locations::All(p_c.definition_span),\n-                        category: ConstraintCategory::OpaqueType,\n-                    }\n-                });\n-\n-            for constraint in outgoing_edges_from_graph.chain(outgoing_edges_from_picks) {\n+            // Always inline this closure because it can be hot.\n+            let mut handle_constraint = #[inline(always)] |constraint: OutlivesConstraint| {\n                 debug_assert_eq!(constraint.sup, r);\n                 let sub_region = constraint.sub;\n                 if let Trace::NotVisited = context[sub_region] {\n                     context[sub_region] = Trace::FromOutlivesConstraint(constraint);\n                     deque.push_back(sub_region);\n                 }\n+            };\n+\n+            // This loop can be hot.\n+            for constraint in outgoing_edges_from_graph {\n+                handle_constraint(constraint);\n+            }\n+\n+            // Member constraints can also give rise to `'r: 'x` edges that\n+            // were not part of the graph initially, so watch out for those.\n+            // (But they are extremely rare; this loop is very cold.)\n+            for constraint in self.applied_member_constraints(r) {\n+                let p_c = &self.member_constraints[constraint.member_constraint_index];\n+                let constraint = OutlivesConstraint {\n+                    sup: r,\n+                    sub: constraint.min_choice,\n+                    locations: Locations::All(p_c.definition_span),\n+                    category: ConstraintCategory::OpaqueType,\n+                };\n+                handle_constraint(constraint);\n             }\n         }\n "}, {"sha": "81c08ee87e985ecab89b9f4b78ac868ef94d1282", "filename": "src/librustc_mir/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/bd9d843ae488e4571186f676d63798f762544c1e/src%2Flibrustc_mir%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bd9d843ae488e4571186f676d63798f762544c1e/src%2Flibrustc_mir%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Flib.rs?ref=bd9d843ae488e4571186f676d63798f762544c1e", "patch": "@@ -25,6 +25,7 @@ Rust MIR: a lowered representation of Rust. Also: an experiment!\n #![feature(mem_take)]\n #![feature(associated_type_bounds)]\n #![feature(range_is_empty)]\n+#![feature(stmt_expr_attributes)]\n \n #![recursion_limit=\"256\"]\n "}]}