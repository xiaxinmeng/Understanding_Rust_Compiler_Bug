{"sha": "e78e9d4a06192cfbb9e1417fdd7a0753d51684a3", "node_id": "MDY6Q29tbWl0NzI0NzEyOmU3OGU5ZDRhMDYxOTJjZmJiOWUxNDE3ZmRkN2EwNzUzZDUxNjg0YTM=", "commit": {"author": {"name": "Aaron Hill", "email": "aa1ronham@gmail.com", "date": "2020-10-25T21:14:19Z"}, "committer": {"name": "Aaron Hill", "email": "aa1ronham@gmail.com", "date": "2020-11-02T18:03:13Z"}, "message": "Treat trailing semicolon as a statement in macro call\n\nSee https://github.com/rust-lang/rust/issues/61733#issuecomment-716188981\n\nWe now preserve the trailing semicolon in a macro invocation, even if\nthe macro expands to nothing. As a result, the following code no longer\ncompiles:\n\n```rust\nmacro_rules! empty {\n    () => { }\n}\n\nfn foo() -> bool { //~ ERROR mismatched\n    { true } //~ ERROR mismatched\n    empty!();\n}\n```\n\nPreviously, `{ true }` would be considered the trailing expression, even\nthough there's a semicolon in `empty!();`\n\nThis makes macro expansion more token-based.", "tree": {"sha": "50ad813cd0c21a4d99288be51fe7b837126a7748", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/50ad813cd0c21a4d99288be51fe7b837126a7748"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e78e9d4a06192cfbb9e1417fdd7a0753d51684a3", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE7J9Gc3TfBwj2K399tAh+UQ6YsWQFAl+gSjQACgkQtAh+UQ6Y\nsWRMRQ//XNICTwv/xmeO+vPEZAWKsklru73uC769W1bptZ+OetvAdP5NF/iXZZpo\nwvIxqGqghiuUIyW67uHfgCO4QjDId7qQRbuUE8j/H4SerbgwUAAjhSCl14Ge1KJr\n+/xvrEDA/+M0A1vzAd8bCTAdNFWJ+Jbu2/hJKWNrgLPcGhz0M9eLhEl5zFj241uC\nhSrm22+ZYzUf6rNzxEu14ZL/jxEgrOZXeyjR6yAOoHNN1Chig1Ytb54jyeIf0W9r\nkk6OSL7eY61g9jo4pTjHq5n2g+W/lqclv2lbnbtTTUZE0RSvRt0prbrwjZ0fXS9Z\n3aCdv1bIXbf/DGdxvBpJkNgonMkKlFFEIakKxWbOERih1Zhtpaa1FqWdJUygYM1k\n3rDENhzrLgNf4RQMnYEQY0plm+YQKtH8e+yOhRGckWPHTbK6Vnrm08zSqmMXUGvr\nHujEMFQydNNV8ziM/cszxUq53A6FqDdKspYctbWuIvezf2RYOr/LKUcLsw3S2ebW\nzoc2YICqZfKmFFyilcqPtsqCsz5S9B9MwBG7EpmEIrAsLj6trEPI116jBxyZddwi\nKhlHqyNa4jGWmBhvK15XdFMh2es6F7rgpTuWM4GYj3s4tAOnGpRiFLuLM6CqYLiF\nngd0rTJtpVZ0I6lUIiMAGJeNuKbPMA234/etQZ/6miIgx+YDzeA=\n=APBx\n-----END PGP SIGNATURE-----", "payload": "tree 50ad813cd0c21a4d99288be51fe7b837126a7748\nparent 499ebcfdf3b09a646154f321b7c28f5105e4dbf7\nauthor Aaron Hill <aa1ronham@gmail.com> 1603660459 -0400\ncommitter Aaron Hill <aa1ronham@gmail.com> 1604340193 -0500\n\nTreat trailing semicolon as a statement in macro call\n\nSee https://github.com/rust-lang/rust/issues/61733#issuecomment-716188981\n\nWe now preserve the trailing semicolon in a macro invocation, even if\nthe macro expands to nothing. As a result, the following code no longer\ncompiles:\n\n```rust\nmacro_rules! empty {\n    () => { }\n}\n\nfn foo() -> bool { //~ ERROR mismatched\n    { true } //~ ERROR mismatched\n    empty!();\n}\n```\n\nPreviously, `{ true }` would be considered the trailing expression, even\nthough there's a semicolon in `empty!();`\n\nThis makes macro expansion more token-based.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e78e9d4a06192cfbb9e1417fdd7a0753d51684a3", "html_url": "https://github.com/rust-lang/rust/commit/e78e9d4a06192cfbb9e1417fdd7a0753d51684a3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e78e9d4a06192cfbb9e1417fdd7a0753d51684a3/comments", "author": {"login": "Aaron1011", "id": 1408859, "node_id": "MDQ6VXNlcjE0MDg4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1408859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Aaron1011", "html_url": "https://github.com/Aaron1011", "followers_url": "https://api.github.com/users/Aaron1011/followers", "following_url": "https://api.github.com/users/Aaron1011/following{/other_user}", "gists_url": "https://api.github.com/users/Aaron1011/gists{/gist_id}", "starred_url": "https://api.github.com/users/Aaron1011/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Aaron1011/subscriptions", "organizations_url": "https://api.github.com/users/Aaron1011/orgs", "repos_url": "https://api.github.com/users/Aaron1011/repos", "events_url": "https://api.github.com/users/Aaron1011/events{/privacy}", "received_events_url": "https://api.github.com/users/Aaron1011/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Aaron1011", "id": 1408859, "node_id": "MDQ6VXNlcjE0MDg4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1408859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Aaron1011", "html_url": "https://github.com/Aaron1011", "followers_url": "https://api.github.com/users/Aaron1011/followers", "following_url": "https://api.github.com/users/Aaron1011/following{/other_user}", "gists_url": "https://api.github.com/users/Aaron1011/gists{/gist_id}", "starred_url": "https://api.github.com/users/Aaron1011/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Aaron1011/subscriptions", "organizations_url": "https://api.github.com/users/Aaron1011/orgs", "repos_url": "https://api.github.com/users/Aaron1011/repos", "events_url": "https://api.github.com/users/Aaron1011/events{/privacy}", "received_events_url": "https://api.github.com/users/Aaron1011/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "499ebcfdf3b09a646154f321b7c28f5105e4dbf7", "url": "https://api.github.com/repos/rust-lang/rust/commits/499ebcfdf3b09a646154f321b7c28f5105e4dbf7", "html_url": "https://github.com/rust-lang/rust/commit/499ebcfdf3b09a646154f321b7c28f5105e4dbf7"}], "stats": {"total": 79, "additions": 77, "deletions": 2}, "files": [{"sha": "f13d67b9c15840178eb35adf6e9fd90fd87c47e1", "filename": "compiler/rustc_ast/src/ast.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/e78e9d4a06192cfbb9e1417fdd7a0753d51684a3/compiler%2Frustc_ast%2Fsrc%2Fast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e78e9d4a06192cfbb9e1417fdd7a0753d51684a3/compiler%2Frustc_ast%2Fsrc%2Fast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast%2Fsrc%2Fast.rs?ref=e78e9d4a06192cfbb9e1417fdd7a0753d51684a3", "patch": "@@ -905,6 +905,13 @@ pub struct Stmt {\n }\n \n impl Stmt {\n+    pub fn has_trailing_semicolon(&self) -> bool {\n+        match &self.kind {\n+            StmtKind::Semi(_) => true,\n+            StmtKind::MacCall(mac) => matches!(mac.style, MacStmtStyle::Semicolon),\n+            _ => false,\n+        }\n+    }\n     pub fn add_trailing_semicolon(mut self) -> Self {\n         self.kind = match self.kind {\n             StmtKind::Expr(expr) => StmtKind::Semi(expr),"}, {"sha": "0cffca17271247d3d1f5e622c04b5fb586608623", "filename": "compiler/rustc_expand/src/placeholders.rs", "status": "modified", "additions": 37, "deletions": 1, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/e78e9d4a06192cfbb9e1417fdd7a0753d51684a3/compiler%2Frustc_expand%2Fsrc%2Fplaceholders.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e78e9d4a06192cfbb9e1417fdd7a0753d51684a3/compiler%2Frustc_expand%2Fsrc%2Fplaceholders.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_expand%2Fsrc%2Fplaceholders.rs?ref=e78e9d4a06192cfbb9e1417fdd7a0753d51684a3", "patch": "@@ -310,8 +310,44 @@ impl<'a, 'b> MutVisitor for PlaceholderExpander<'a, 'b> {\n         };\n \n         if style == ast::MacStmtStyle::Semicolon {\n+            // Implement the proposal described in\n+            // https://github.com/rust-lang/rust/issues/61733#issuecomment-509626449\n+            //\n+            // The macro invocation expands to the list of statements.\n+            // If the list of statements is empty, then 'parse'\n+            // the trailing semicolon on the original invocation\n+            // as an empty statement. That is:\n+            //\n+            // `empty();` is parsed as a single `StmtKind::Empty`\n+            //\n+            // If the list of statements is non-empty, see if the\n+            // final statement alreayd has a trailing semicolon.\n+            //\n+            // If it doesn't have a semicolon, then 'parse' the trailing semicolon\n+            // from the invocation as part of the final statement,\n+            // using `stmt.add_trailing_semicolon()`\n+            //\n+            // If it does have a semicolon, then 'parse' the trailing semicolon\n+            // from the invocation as a new StmtKind::Empty\n+\n+            // FIXME: We will need to preserve the original\n+            // semicolon token and span as part of #15701\n+            let empty_stmt = ast::Stmt {\n+                id: ast::DUMMY_NODE_ID,\n+                kind: ast::StmtKind::Empty,\n+                span: DUMMY_SP,\n+                tokens: None,\n+            };\n+\n             if let Some(stmt) = stmts.pop() {\n-                stmts.push(stmt.add_trailing_semicolon());\n+                if stmt.has_trailing_semicolon() {\n+                    stmts.push(stmt);\n+                    stmts.push(empty_stmt);\n+                } else {\n+                    stmts.push(stmt.add_trailing_semicolon());\n+                }\n+            } else {\n+                stmts.push(empty_stmt);\n             }\n         }\n "}, {"sha": "84cc7b68d4ca9ef45bc9f14b8395b54347638fab", "filename": "compiler/rustc_lint/src/redundant_semicolon.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/e78e9d4a06192cfbb9e1417fdd7a0753d51684a3/compiler%2Frustc_lint%2Fsrc%2Fredundant_semicolon.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e78e9d4a06192cfbb9e1417fdd7a0753d51684a3/compiler%2Frustc_lint%2Fsrc%2Fredundant_semicolon.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_lint%2Fsrc%2Fredundant_semicolon.rs?ref=e78e9d4a06192cfbb9e1417fdd7a0753d51684a3", "patch": "@@ -42,6 +42,11 @@ impl EarlyLintPass for RedundantSemicolons {\n \n fn maybe_lint_redundant_semis(cx: &EarlyContext<'_>, seq: &mut Option<(Span, bool)>) {\n     if let Some((span, multiple)) = seq.take() {\n+        // FIXME: Find a better way of ignoring the trailing\n+        // semicolon from macro expansion\n+        if span == rustc_span::DUMMY_SP {\n+            return;\n+        }\n         cx.struct_span_lint(REDUNDANT_SEMICOLONS, span, |lint| {\n             let (msg, rem) = if multiple {\n                 (\"unnecessary trailing semicolons\", \"remove these semicolons\")"}, {"sha": "3d78ed4a4759a2515bf201d54cb6b6a4012adf46", "filename": "src/test/ui/macros/empty-trailing-stmt.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/e78e9d4a06192cfbb9e1417fdd7a0753d51684a3/src%2Ftest%2Fui%2Fmacros%2Fempty-trailing-stmt.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e78e9d4a06192cfbb9e1417fdd7a0753d51684a3/src%2Ftest%2Fui%2Fmacros%2Fempty-trailing-stmt.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmacros%2Fempty-trailing-stmt.rs?ref=e78e9d4a06192cfbb9e1417fdd7a0753d51684a3", "patch": "@@ -0,0 +1,10 @@\n+macro_rules! empty {\n+    () => { }\n+}\n+\n+fn foo() -> bool { //~ ERROR mismatched\n+    { true } //~ ERROR mismatched\n+    empty!();\n+}\n+\n+fn main() {}"}, {"sha": "e88b12712fb8c8ef7c1769d14c8b68c0d82459b4", "filename": "src/test/ui/macros/empty-trailing-stmt.stderr", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/e78e9d4a06192cfbb9e1417fdd7a0753d51684a3/src%2Ftest%2Fui%2Fmacros%2Fempty-trailing-stmt.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/e78e9d4a06192cfbb9e1417fdd7a0753d51684a3/src%2Ftest%2Fui%2Fmacros%2Fempty-trailing-stmt.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmacros%2Fempty-trailing-stmt.stderr?ref=e78e9d4a06192cfbb9e1417fdd7a0753d51684a3", "patch": "@@ -0,0 +1,17 @@\n+error[E0308]: mismatched types\n+  --> $DIR/empty-trailing-stmt.rs:6:7\n+   |\n+LL |     { true }\n+   |       ^^^^ expected `()`, found `bool`\n+\n+error[E0308]: mismatched types\n+  --> $DIR/empty-trailing-stmt.rs:5:13\n+   |\n+LL | fn foo() -> bool {\n+   |    ---      ^^^^ expected `bool`, found `()`\n+   |    |\n+   |    implicitly returns `()` as its body has no tail or `return` expression\n+\n+error: aborting due to 2 previous errors\n+\n+For more information about this error, try `rustc --explain E0308`."}, {"sha": "a067b7b5411dd87e05f1b5c0df6f7b506e78f7f7", "filename": "src/test/ui/proc-macro/meta-macro-hygiene.stdout", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e78e9d4a06192cfbb9e1417fdd7a0753d51684a3/src%2Ftest%2Fui%2Fproc-macro%2Fmeta-macro-hygiene.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/e78e9d4a06192cfbb9e1417fdd7a0753d51684a3/src%2Ftest%2Fui%2Fproc-macro%2Fmeta-macro-hygiene.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fproc-macro%2Fmeta-macro-hygiene.stdout?ref=e78e9d4a06192cfbb9e1417fdd7a0753d51684a3", "patch": "@@ -40,7 +40,7 @@ macro_rules! produce_it\n     }\n }\n \n-fn main /* 0#0 */() { }\n+fn main /* 0#0 */() { ; }\n \n /*\n Expansions:"}]}