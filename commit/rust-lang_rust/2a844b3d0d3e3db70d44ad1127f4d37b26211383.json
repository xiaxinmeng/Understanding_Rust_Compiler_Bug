{"sha": "2a844b3d0d3e3db70d44ad1127f4d37b26211383", "node_id": "MDY6Q29tbWl0NzI0NzEyOjJhODQ0YjNkMGQzZTNkYjcwZDQ0YWQxMTI3ZjRkMzdiMjYyMTEzODM=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2017-09-16T14:16:46Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2017-09-17T00:09:36Z"}, "message": "Rollup merge of #44273 - bluss:rc-downcast, r=alexcrichton\n\nImplement <Rc<Any>>::downcast\n\n* Implement `<Rc<Any>>::downcast::<T>`\n  * New unstable method. Works just like Box\\<Any\\>, but for Rc.\n  * Any has two cases for its methods: Any and Any + Send; Rc is never Send, so that case is skipped for Rc.\n  * Motivation for being a method with self is to match Box and there is no user-supplied type; the inner type is Any and downcast does not conflict with any method of Any.\n* Arc was skipped because Any itself has no downcast for the case that makes most sense: Any + Send + Sync", "tree": {"sha": "516583f05131d30307cfd8ce436722f64aff38ae", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/516583f05131d30307cfd8ce436722f64aff38ae"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2a844b3d0d3e3db70d44ad1127f4d37b26211383", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2a844b3d0d3e3db70d44ad1127f4d37b26211383", "html_url": "https://github.com/rust-lang/rust/commit/2a844b3d0d3e3db70d44ad1127f4d37b26211383", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2a844b3d0d3e3db70d44ad1127f4d37b26211383/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "277476c4fb9e967ca28a7b529dbcf6b348cb787d", "url": "https://api.github.com/repos/rust-lang/rust/commits/277476c4fb9e967ca28a7b529dbcf6b348cb787d", "html_url": "https://github.com/rust-lang/rust/commit/277476c4fb9e967ca28a7b529dbcf6b348cb787d"}, {"sha": "3a39d95330623d47bcfcd5cac2d6b3c30e12ae5a", "url": "https://api.github.com/repos/rust-lang/rust/commits/3a39d95330623d47bcfcd5cac2d6b3c30e12ae5a", "html_url": "https://github.com/rust-lang/rust/commit/3a39d95330623d47bcfcd5cac2d6b3c30e12ae5a"}], "stats": {"total": 61, "additions": 61, "deletions": 0}, "files": [{"sha": "58c589697f41c75127334a8e79d6604733ff0981", "filename": "src/liballoc/rc.rs", "status": "modified", "additions": 61, "deletions": 0, "changes": 61, "blob_url": "https://github.com/rust-lang/rust/blob/2a844b3d0d3e3db70d44ad1127f4d37b26211383/src%2Fliballoc%2Frc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2a844b3d0d3e3db70d44ad1127f4d37b26211383/src%2Fliballoc%2Frc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fliballoc%2Frc.rs?ref=2a844b3d0d3e3db70d44ad1127f4d37b26211383", "patch": "@@ -244,6 +244,7 @@ use boxed::Box;\n #[cfg(test)]\n use std::boxed::Box;\n \n+use core::any::Any;\n use core::borrow;\n use core::cell::Cell;\n use core::cmp::Ordering;\n@@ -608,6 +609,46 @@ impl<T: Clone> Rc<T> {\n     }\n }\n \n+impl Rc<Any> {\n+    #[inline]\n+    #[unstable(feature = \"rc_downcast\", issue = \"44608\")]\n+    /// Attempt to downcast the `Rc<Any>` to a concrete type.\n+    ///\n+    /// # Examples\n+    ///\n+    /// ```\n+    /// #![feature(rc_downcast)]\n+    /// use std::any::Any;\n+    /// use std::rc::Rc;\n+    ///\n+    /// fn print_if_string(value: Rc<Any>) {\n+    ///     if let Ok(string) = value.downcast::<String>() {\n+    ///         println!(\"String ({}): {}\", string.len(), string);\n+    ///     }\n+    /// }\n+    ///\n+    /// fn main() {\n+    ///     let my_string = \"Hello World\".to_string();\n+    ///     print_if_string(Rc::new(my_string));\n+    ///     print_if_string(Rc::new(0i8));\n+    /// }\n+    /// ```\n+    pub fn downcast<T: Any>(self) -> Result<Rc<T>, Rc<Any>> {\n+        if (*self).is::<T>() {\n+            // avoid the pointer arithmetic in from_raw\n+            unsafe {\n+                let raw: *const RcBox<Any> = self.ptr.as_ptr();\n+                forget(self);\n+                Ok(Rc {\n+                    ptr: Shared::new_unchecked(raw as *const RcBox<T> as *mut _),\n+                })\n+            }\n+        } else {\n+            Err(self)\n+        }\n+    }\n+}\n+\n impl<T: ?Sized> Rc<T> {\n     // Allocates an `RcBox<T>` with sufficient space for an unsized value\n     unsafe fn allocate_for_ptr(ptr: *const T) -> *mut RcBox<T> {\n@@ -1696,6 +1737,26 @@ mod tests {\n \n         assert_eq!(&r[..], [1, 2, 3]);\n     }\n+\n+    #[test]\n+    fn test_downcast() {\n+        use std::any::Any;\n+\n+        let r1: Rc<Any> = Rc::new(i32::max_value());\n+        let r2: Rc<Any> = Rc::new(\"abc\");\n+\n+        assert!(r1.clone().downcast::<u32>().is_err());\n+\n+        let r1i32 = r1.downcast::<i32>();\n+        assert!(r1i32.is_ok());\n+        assert_eq!(r1i32.unwrap(), Rc::new(i32::max_value()));\n+\n+        assert!(r2.clone().downcast::<i32>().is_err());\n+\n+        let r2str = r2.downcast::<&'static str>();\n+        assert!(r2str.is_ok());\n+        assert_eq!(r2str.unwrap(), Rc::new(\"abc\"));\n+    }\n }\n \n #[stable(feature = \"rust1\", since = \"1.0.0\")]"}]}