{"sha": "a0152da5ae5acc68706bc842204a8869ffac0f6d", "node_id": "MDY6Q29tbWl0NzI0NzEyOmEwMTUyZGE1YWU1YWNjNjg3MDZiYzg0MjIwNGE4ODY5ZmZhYzBmNmQ=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-09-03T00:23:10Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-09-03T00:23:10Z"}, "message": "Auto merge of #88363 - michaelwoerister:remapped-diagnostics, r=estebank\n\nPath remapping: Make behavior of diagnostics output dependent on presence of --remap-path-prefix.\n\nThis PR fixes a regression (#87745) with `--remap-path-prefix` where the flag stopped causing diagnostic messages to be remapped as well. The regression was introduced in https://github.com/rust-lang/rust/pull/83813 where we erroneously assumed that remapping of diagnostic messages was not desired anymore (because #70642 partially undid that functionality with nobody objecting).\n\nThe issue is fixed by making `--remap-path-prefix` remap diagnostic messages again, including for paths that have been remapped in upstream crates (e.g. the standard library). This means that \"sysroot-localization\" (implemented in #70642) is also disabled if `rustc` is invoked with `--remap-path-prefix`. The assumption is that once someone starts explicitly remapping paths they also don't want paths to their local Rust installation in their build output.\n\nIn the future we might want to give more fine-grained control over this behavior via compiler flags (see https://github.com/rust-lang/rfcs/pull/3127 for a related RFC). For now this PR is intended as a regression fix.\n\nThis PR is an alternative to https://github.com/rust-lang/rust/pull/88191, which makes diagnostic messages be remapped unconditionally. That approach, however, would effectively revert #70642.\n\nFixes https://github.com/rust-lang/rust/issues/87745.\n\ncc `@cbeuw`\nr? `@ghost`", "tree": {"sha": "f69a748880f08f6096bfca69e1593d57de6b159c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f69a748880f08f6096bfca69e1593d57de6b159c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a0152da5ae5acc68706bc842204a8869ffac0f6d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a0152da5ae5acc68706bc842204a8869ffac0f6d", "html_url": "https://github.com/rust-lang/rust/commit/a0152da5ae5acc68706bc842204a8869ffac0f6d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a0152da5ae5acc68706bc842204a8869ffac0f6d/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "78bf4acc3a18848e21896bae97859c5811b320d4", "url": "https://api.github.com/repos/rust-lang/rust/commits/78bf4acc3a18848e21896bae97859c5811b320d4", "html_url": "https://github.com/rust-lang/rust/commit/78bf4acc3a18848e21896bae97859c5811b320d4"}, {"sha": "c6c1f328ebedabbe1779a9a0543b9f6ba2696e8a", "url": "https://api.github.com/repos/rust-lang/rust/commits/c6c1f328ebedabbe1779a9a0543b9f6ba2696e8a", "html_url": "https://github.com/rust-lang/rust/commit/c6c1f328ebedabbe1779a9a0543b9f6ba2696e8a"}], "stats": {"total": 7, "additions": 2, "deletions": 5}, "files": [{"sha": "39f7ade3f81f6cbbf8c824e9c58f9820b1d40d64", "filename": "clippy_lints/src/macro_use.rs", "status": "modified", "additions": 2, "deletions": 5, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/a0152da5ae5acc68706bc842204a8869ffac0f6d/clippy_lints%2Fsrc%2Fmacro_use.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a0152da5ae5acc68706bc842204a8869ffac0f6d/clippy_lints%2Fsrc%2Fmacro_use.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmacro_use.rs?ref=a0152da5ae5acc68706bc842204a8869ffac0f6d", "patch": "@@ -47,11 +47,8 @@ pub struct MacroRefData {\n \n impl MacroRefData {\n     pub fn new(name: String, callee: Span, cx: &LateContext<'_>) -> Self {\n-        let mut path = cx\n-            .sess()\n-            .source_map()\n-            .span_to_filename(callee)\n-            .prefer_local()\n+        let sm = cx.sess().source_map();\n+        let mut path = sm.filename_for_diagnostics(&sm.span_to_filename(callee))\n             .to_string();\n \n         // std lib paths are <::std::module::file type>"}]}