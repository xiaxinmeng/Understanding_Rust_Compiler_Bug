{"sha": "518ece227223cd6fc6d808c893b4404f450261f2", "node_id": "MDY6Q29tbWl0NzI0NzEyOjUxOGVjZTIyNzIyM2NkNmZjNmQ4MDhjODkzYjQ0MDRmNDUwMjYxZjI=", "commit": {"author": {"name": "Nick Cameron", "email": "nrc@ncameron.org", "date": "2018-04-10T03:07:57Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2018-04-10T03:07:57Z"}, "message": "Merge pull request #2612 from peterhuene/suppress-unstable-config-options\n\nSuppress unstable config options by default.", "tree": {"sha": "611e73b649d5493c330936df58b5c2a62c1c6053", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/611e73b649d5493c330936df58b5c2a62c1c6053"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/518ece227223cd6fc6d808c893b4404f450261f2", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJazCqNCRBK7hj4Ov3rIwAAdHIIAId7sDl9Tyxsxo8701fN4uGE\nJaM1adi43e8IJvTeCoISVOJNqrR4LjFVDqcVf4jW0UGZh68LWbnmwXN9kbLu26zG\nbol31UEjWtYKeh1ZeVn+HpR1f5re4dcqMudfOto9nbvZoWt/XtiayoRYKxmjq7bB\n0B31ZPYl5F+/PGPR+tGjMoRbr2i79xghMAu9M+tSIhJTQYgjlIQDfRL2/6Qmw5ti\nSgfDQMOY2kKDjiz4V+xSvlRw0iP2TfhdqKcVanxtooN3KEo6AfyAzIcqZHBT8Kuz\nMAxySn9PpvKyjoknVMmY/dU7p4s/BITlQK8xZuVr5UfsNhs93tD9bcAdmj1WL8c=\n=9EWq\n-----END PGP SIGNATURE-----\n", "payload": "tree 611e73b649d5493c330936df58b5c2a62c1c6053\nparent 2840229d6f319d7184b28303a3ecb58c1f80a411\nparent 8208f8aa01a53ae681a6ff2b63cbb4547f3704f7\nauthor Nick Cameron <nrc@ncameron.org> 1523329677 +1200\ncommitter GitHub <noreply@github.com> 1523329677 +1200\n\nMerge pull request #2612 from peterhuene/suppress-unstable-config-options\n\nSuppress unstable config options by default."}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/518ece227223cd6fc6d808c893b4404f450261f2", "html_url": "https://github.com/rust-lang/rust/commit/518ece227223cd6fc6d808c893b4404f450261f2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/518ece227223cd6fc6d808c893b4404f450261f2/comments", "author": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2840229d6f319d7184b28303a3ecb58c1f80a411", "url": "https://api.github.com/repos/rust-lang/rust/commits/2840229d6f319d7184b28303a3ecb58c1f80a411", "html_url": "https://github.com/rust-lang/rust/commit/2840229d6f319d7184b28303a3ecb58c1f80a411"}, {"sha": "8208f8aa01a53ae681a6ff2b63cbb4547f3704f7", "url": "https://api.github.com/repos/rust-lang/rust/commits/8208f8aa01a53ae681a6ff2b63cbb4547f3704f7", "html_url": "https://github.com/rust-lang/rust/commit/8208f8aa01a53ae681a6ff2b63cbb4547f3704f7"}], "stats": {"total": 97, "additions": 77, "deletions": 20}, "files": [{"sha": "34c1bc597455bcb607f73fd0c88471ddfdc92000", "filename": "src/bin/main.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/518ece227223cd6fc6d808c893b4404f450261f2/src%2Fbin%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/518ece227223cd6fc6d808c893b4404f450261f2/src%2Fbin%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbin%2Fmain.rs?ref=518ece227223cd6fc6d808c893b4404f450261f2", "patch": "@@ -15,7 +15,7 @@ extern crate getopts;\n extern crate rustfmt_nightly as rustfmt;\n \n use std::fs::File;\n-use std::io::{self, Read, Write};\n+use std::io::{self, stdout, Read, Write};\n use std::path::{Path, PathBuf};\n use std::str::FromStr;\n use std::{env, error};\n@@ -226,7 +226,7 @@ fn execute(opts: &Options) -> FmtResult<Summary> {\n             Ok(Summary::default())\n         }\n         Operation::ConfigHelp => {\n-            Config::print_docs();\n+            Config::print_docs(&mut stdout(), matches.opt_present(\"unstable-features\"));\n             Ok(Summary::default())\n         }\n         Operation::ConfigOutputDefault { path } => {"}, {"sha": "0c38b6d28ad1f9b59724f5730116bd9e5b68898c", "filename": "src/config/config_type.rs", "status": "modified", "additions": 23, "deletions": 18, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/518ece227223cd6fc6d808c893b4404f450261f2/src%2Fconfig%2Fconfig_type.rs", "raw_url": "https://github.com/rust-lang/rust/raw/518ece227223cd6fc6d808c893b4404f450261f2/src%2Fconfig%2Fconfig_type.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fconfig%2Fconfig_type.rs?ref=518ece227223cd6fc6d808c893b4404f450261f2", "patch": "@@ -81,6 +81,7 @@ macro_rules! is_nightly_channel {\n macro_rules! create_config {\n     ($($i:ident: $ty:ty, $def:expr, $stb:expr, $( $dstring:expr ),+ );+ $(;)*) => (\n         use std::collections::HashSet;\n+        use std::io::Write;\n \n         #[derive(Clone)]\n         pub struct Config {\n@@ -359,33 +360,37 @@ macro_rules! create_config {\n                 HIDE_OPTIONS.contains(&name)\n             }\n \n-            pub fn print_docs() {\n+            pub fn print_docs(out: &mut Write, include_unstable: bool) {\n                 use std::cmp;\n                 let max = 0;\n                 $( let max = cmp::max(max, stringify!($i).len()+1); )+\n                 let mut space_str = String::with_capacity(max);\n                 for _ in 0..max {\n                     space_str.push(' ');\n                 }\n-                println!(\"Configuration Options:\");\n+                writeln!(out, \"Configuration Options:\").unwrap();\n                 $(\n-                    let name_raw = stringify!($i);\n-\n-                    if !Config::is_hidden_option(name_raw) {\n-                        let mut name_out = String::with_capacity(max);\n-                        for _ in name_raw.len()..max-1 {\n-                            name_out.push(' ')\n+                    if $stb || include_unstable {\n+                        let name_raw = stringify!($i);\n+\n+                        if !Config::is_hidden_option(name_raw) {\n+                            let mut name_out = String::with_capacity(max);\n+                            for _ in name_raw.len()..max-1 {\n+                                name_out.push(' ')\n+                            }\n+                            name_out.push_str(name_raw);\n+                            name_out.push(' ');\n+                            writeln!(out,\n+                                    \"{}{} Default: {:?}{}\",\n+                                    name_out,\n+                                    <$ty>::doc_hint(),\n+                                    $def,\n+                                    if !$stb { \" (unstable)\" } else { \"\" }).unwrap();\n+                            $(\n+                                writeln!(out, \"{}{}\", space_str, $dstring).unwrap();\n+                            )+\n+                            writeln!(out).unwrap();\n                         }\n-                        name_out.push_str(name_raw);\n-                        name_out.push(' ');\n-                        println!(\"{}{} Default: {:?}\",\n-                                name_out,\n-                                <$ty>::doc_hint(),\n-                                $def);\n-                        $(\n-                            println!(\"{}{}\", space_str, $dstring);\n-                        )+\n-                        println!();\n                     }\n                 )+\n             }"}, {"sha": "3676aed4ba97902b976b5dbe8309f8cb2396499b", "filename": "src/config/mod.rs", "status": "modified", "additions": 52, "deletions": 0, "changes": 52, "blob_url": "https://github.com/rust-lang/rust/blob/518ece227223cd6fc6d808c893b4404f450261f2/src%2Fconfig%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/518ece227223cd6fc6d808c893b4404f450261f2/src%2Fconfig%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fconfig%2Fmod.rs?ref=518ece227223cd6fc6d808c893b4404f450261f2", "patch": "@@ -181,6 +181,31 @@ pub fn get_toml_path(dir: &Path) -> Result<Option<PathBuf>, Error> {\n #[cfg(test)]\n mod test {\n     use super::Config;\n+    use std::str;\n+\n+    #[allow(dead_code)]\n+    mod mock {\n+        use super::super::*;\n+\n+        create_config! {\n+            // Options that are used by the generated functions\n+            max_width: usize, 100, true, \"Maximum width of each line\";\n+            use_small_heuristics: bool, true, false, \"Whether to use different formatting for items and \\\n+                expressions if they satisfy a heuristic notion of 'small'.\";\n+            license_template_path: String, String::default(), false, \"Beginning of file must match license template\";\n+            required_version: String, env!(\"CARGO_PKG_VERSION\").to_owned(), false, \"Require a specific version of rustfmt.\";\n+            ignore: IgnoreList, IgnoreList::default(), false, \"Skip formatting the specified files and directories.\";\n+            verbose: bool, false, false, \"Use verbose output\";\n+            file_lines: FileLines, FileLines::all(), false,\n+                \"Lines to format; this is not supported in rustfmt.toml, and can only be specified \\\n+                    via the --file-lines option\";\n+            width_heuristics: WidthHeuristics, WidthHeuristics::scaled(100), false, \"'small' heuristic values\";\n+\n+            // Options that are used by the tests\n+            stable_option: bool, false, true, \"A stable option\";\n+            unstable_option: bool, false, false, \"An unstable option\";\n+        }\n+    }\n \n     #[test]\n     fn test_config_set() {\n@@ -218,6 +243,33 @@ mod test {\n         assert_eq!(config.was_set().verbose(), false);\n     }\n \n+    #[test]\n+    fn test_print_docs_exclude_unstable() {\n+        use self::mock::Config;\n+\n+        let mut output = Vec::new();\n+        Config::print_docs(&mut output, false);\n+\n+        let s = str::from_utf8(&output).unwrap();\n+\n+        assert_eq!(s.contains(\"stable_option\"), true);\n+        assert_eq!(s.contains(\"unstable_option\"), false);\n+        assert_eq!(s.contains(\"(unstable)\"), false);\n+    }\n+\n+    #[test]\n+    fn test_print_docs_include_unstable() {\n+        use self::mock::Config;\n+\n+        let mut output = Vec::new();\n+        Config::print_docs(&mut output, true);\n+\n+        let s = str::from_utf8(&output).unwrap();\n+        assert_eq!(s.contains(\"stable_option\"), true);\n+        assert_eq!(s.contains(\"unstable_option\"), true);\n+        assert_eq!(s.contains(\"(unstable)\"), true);\n+    }\n+\n     // FIXME(#2183) these tests cannot be run in parallel because they use env vars\n     // #[test]\n     // fn test_as_not_nightly_channel() {"}]}