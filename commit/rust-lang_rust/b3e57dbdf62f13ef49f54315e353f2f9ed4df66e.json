{"sha": "b3e57dbdf62f13ef49f54315e353f2f9ed4df66e", "node_id": "MDY6Q29tbWl0NzI0NzEyOmIzZTU3ZGJkZjYyZjEzZWY0OWY1NDMxNWUzNTNmMmY5ZWQ0ZGY2NmU=", "commit": {"author": {"name": "Pietro Albini", "email": "pietro@pietroalbini.org", "date": "2018-10-25T12:31:20Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2018-10-25T12:31:20Z"}, "message": "Rollup merge of #55306 - pnkfelix:issue-54478-regression-test-jemalloc-ctl, r=nikomatsakis\n\nRegression test for #54478.\n\nThis is a regression test for #54478.\n\nI confirmed that it fails on:\nrustdoc 1.30.0-beta.12 (96a229824 2018-10-04)\nand passes on:\nrustdoc 1.31.0-nightly (f99911a4a 2018-10-23)\n\nFix #54478", "tree": {"sha": "3bd212ad10dbd4530e574aff8242acbf0cb1aa05", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3bd212ad10dbd4530e574aff8242acbf0cb1aa05"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b3e57dbdf62f13ef49f54315e353f2f9ed4df66e", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJb0beYCRBK7hj4Ov3rIwAAdHIIAKeQUKiA7zbr3T3C5923hHj5\nl1w/gxXMWSmS3zcOQ031TR7ppsxZpS5kTdYRSvA6LXFcrfOGvssDOForXm9LewtO\nwul2jb69BXVLfSW74PAT0T5pm+9zmf3axvmQtZhx0Cbu380+As2fV88a2Gjplzrc\nas+4qgHEUPBfJHxX509jeDDmNqaIun+FVbhV8ewu5VDOhW0cgaX1+9uQZOidngLP\nUN0uh+uEHC7g4cyhRv2fX9qmccbImrkBY1R0f/oMGUFnILFUZyxEcU9p8Mfr9Lyw\nepJ4M7rKWLX4rO5HDRh1jWD1Rq7w7OeUg4a2PZ26gPOylYx0TmJLE1TkTCPjW+k=\n=Qec2\n-----END PGP SIGNATURE-----\n", "payload": "tree 3bd212ad10dbd4530e574aff8242acbf0cb1aa05\nparent 1220e1354ae100fded1e2c76ccf158e4b6a9d7ee\nparent be2075c6614532b6b58bef455c3ff89ecf2ef625\nauthor Pietro Albini <pietro@pietroalbini.org> 1540470680 +0200\ncommitter GitHub <noreply@github.com> 1540470680 +0200\n\nRollup merge of #55306 - pnkfelix:issue-54478-regression-test-jemalloc-ctl, r=nikomatsakis\n\nRegression test for #54478.\n\nThis is a regression test for #54478.\n\nI confirmed that it fails on:\nrustdoc 1.30.0-beta.12 (96a229824 2018-10-04)\nand passes on:\nrustdoc 1.31.0-nightly (f99911a4a 2018-10-23)\n\nFix #54478\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b3e57dbdf62f13ef49f54315e353f2f9ed4df66e", "html_url": "https://github.com/rust-lang/rust/commit/b3e57dbdf62f13ef49f54315e353f2f9ed4df66e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b3e57dbdf62f13ef49f54315e353f2f9ed4df66e/comments", "author": {"login": "pietroalbini", "id": 2299951, "node_id": "MDQ6VXNlcjIyOTk5NTE=", "avatar_url": "https://avatars.githubusercontent.com/u/2299951?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pietroalbini", "html_url": "https://github.com/pietroalbini", "followers_url": "https://api.github.com/users/pietroalbini/followers", "following_url": "https://api.github.com/users/pietroalbini/following{/other_user}", "gists_url": "https://api.github.com/users/pietroalbini/gists{/gist_id}", "starred_url": "https://api.github.com/users/pietroalbini/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pietroalbini/subscriptions", "organizations_url": "https://api.github.com/users/pietroalbini/orgs", "repos_url": "https://api.github.com/users/pietroalbini/repos", "events_url": "https://api.github.com/users/pietroalbini/events{/privacy}", "received_events_url": "https://api.github.com/users/pietroalbini/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1220e1354ae100fded1e2c76ccf158e4b6a9d7ee", "url": "https://api.github.com/repos/rust-lang/rust/commits/1220e1354ae100fded1e2c76ccf158e4b6a9d7ee", "html_url": "https://github.com/rust-lang/rust/commit/1220e1354ae100fded1e2c76ccf158e4b6a9d7ee"}, {"sha": "be2075c6614532b6b58bef455c3ff89ecf2ef625", "url": "https://api.github.com/repos/rust-lang/rust/commits/be2075c6614532b6b58bef455c3ff89ecf2ef625", "html_url": "https://github.com/rust-lang/rust/commit/be2075c6614532b6b58bef455c3ff89ecf2ef625"}], "stats": {"total": 42, "additions": 42, "deletions": 0}, "files": [{"sha": "4811f363bc97a388a395941cae7248ce9a5a12f3", "filename": "src/test/rustdoc/issue-54478-demo-allocator.rs", "status": "added", "additions": 42, "deletions": 0, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/b3e57dbdf62f13ef49f54315e353f2f9ed4df66e/src%2Ftest%2Frustdoc%2Fissue-54478-demo-allocator.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b3e57dbdf62f13ef49f54315e353f2f9ed4df66e/src%2Ftest%2Frustdoc%2Fissue-54478-demo-allocator.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fissue-54478-demo-allocator.rs?ref=b3e57dbdf62f13ef49f54315e353f2f9ed4df66e", "patch": "@@ -0,0 +1,42 @@\n+// Issue #54478: regression test showing that we can demonstrate\n+// `#[global_allocator]` in code blocks built by `rustdoc`.\n+//\n+// ## Background\n+//\n+// Changes in lang-item visibility injected failures that were only\n+// exposed when compiling with `-C prefer-dynamic`. But `rustdoc` used\n+// `-C prefer-dynamic` (and had done so for years, for reasons we did\n+// not document at that time).\n+//\n+// Rather than try to revise the visbility semanics, we instead\n+// decided to change `rustdoc` to behave more like the compiler's\n+// default setting, by leaving off `-C prefer-dynamic`.\n+\n+// compile-flags:--test\n+\n+//! This is a doc comment\n+//!\n+//! ```rust\n+//! use std::alloc::*;\n+//!\n+//! #[global_allocator]\n+//! static ALLOC: A = A;\n+//!\n+//! static mut HIT: bool = false;\n+//!\n+//! struct A;\n+//!\n+//! unsafe impl GlobalAlloc for A {\n+//!     unsafe fn alloc(&self, layout: Layout) -> *mut u8 {\n+//!         HIT = true;\n+//!         System.alloc(layout)\n+//!     }\n+//!     unsafe fn dealloc(&self, ptr: *mut u8, layout: Layout) {\n+//!         System.dealloc(ptr, layout);\n+//!     }\n+//! }\n+//!\n+//! fn main() {\n+//!     assert!(unsafe { HIT });\n+//! }\n+//! ```"}]}