{"sha": "9f572dbc6454cc2eb627322c3209d4cfd30f2870", "node_id": "MDY6Q29tbWl0NzI0NzEyOjlmNTcyZGJjNjQ1NGNjMmViNjI3MzIyYzMyMDlkNGNmZDMwZjI4NzA=", "commit": {"author": {"name": "Nick Cameron", "email": "nrc@ncameron.org", "date": "2017-07-24T23:38:59Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2017-07-24T23:38:59Z"}, "message": "Merge pull request #1805 from topecongiro/inner-attr\n\nFormat inner attributes", "tree": {"sha": "085b04b5d0cb3028c32a51a72b7998bd16c90da4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/085b04b5d0cb3028c32a51a72b7998bd16c90da4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9f572dbc6454cc2eb627322c3209d4cfd30f2870", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9f572dbc6454cc2eb627322c3209d4cfd30f2870", "html_url": "https://github.com/rust-lang/rust/commit/9f572dbc6454cc2eb627322c3209d4cfd30f2870", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9f572dbc6454cc2eb627322c3209d4cfd30f2870/comments", "author": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b559a0f2f2177b381c6c3c670745b2cd4dbdea67", "url": "https://api.github.com/repos/rust-lang/rust/commits/b559a0f2f2177b381c6c3c670745b2cd4dbdea67", "html_url": "https://github.com/rust-lang/rust/commit/b559a0f2f2177b381c6c3c670745b2cd4dbdea67"}, {"sha": "5c99d6c6bc79b87863e02bc130d5b00f3daf6ad5", "url": "https://api.github.com/repos/rust-lang/rust/commits/5c99d6c6bc79b87863e02bc130d5b00f3daf6ad5", "html_url": "https://github.com/rust-lang/rust/commit/5c99d6c6bc79b87863e02bc130d5b00f3daf6ad5"}], "stats": {"total": 133, "additions": 99, "deletions": 34}, "files": [{"sha": "35e1e432733f7ece084b54e0911fede34c7bc62b", "filename": "src/expr.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/9f572dbc6454cc2eb627322c3209d4cfd30f2870/src%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9f572dbc6454cc2eb627322c3209d4cfd30f2870/src%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fexpr.rs?ref=9f572dbc6454cc2eb627322c3209d4cfd30f2870", "patch": "@@ -914,7 +914,7 @@ fn rewrite_block_with_visitor(\n         ast::BlockCheckMode::Default => visitor.last_pos = block.span.lo,\n     }\n \n-    visitor.visit_block(block);\n+    visitor.visit_block(block, None);\n     Some(format!(\"{}{}\", prefix, visitor.buffer))\n }\n "}, {"sha": "9c3fb86f73e607e2584fb2480228903dc3b14fe6", "filename": "src/items.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/9f572dbc6454cc2eb627322c3209d4cfd30f2870/src%2Fitems.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9f572dbc6454cc2eb627322c3209d4cfd30f2870/src%2Fitems.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fitems.rs?ref=9f572dbc6454cc2eb627322c3209d4cfd30f2870", "patch": "@@ -640,6 +640,7 @@ pub fn format_impl(\n             visitor.block_indent = offset.block_only().block_indent(context.config);\n             visitor.last_pos = item.span.lo + BytePos(open_pos as u32);\n \n+            visitor.visit_attrs(&item.attrs, ast::AttrStyle::Inner);\n             for item in items {\n                 visitor.visit_impl_item(item);\n             }"}, {"sha": "5647e6df5e23672a1ca78544afb8c42711d0056c", "filename": "src/lib.rs", "status": "modified", "additions": 12, "deletions": 5, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/9f572dbc6454cc2eb627322c3209d4cfd30f2870/src%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9f572dbc6454cc2eb627322c3209d4cfd30f2870/src%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flib.rs?ref=9f572dbc6454cc2eb627322c3209d4cfd30f2870", "patch": "@@ -554,17 +554,24 @@ where\n         if skip_children && path.as_path() != main_file {\n             continue;\n         }\n-        let path = path.to_str().unwrap();\n+        let path_str = path.to_str().unwrap();\n         if config.verbose() {\n-            println!(\"Formatting {}\", path);\n+            println!(\"Formatting {}\", path_str);\n         }\n         {\n             let mut visitor = FmtVisitor::from_codemap(parse_session, config);\n-            visitor.format_separate_mod(module);\n+            let filemap = visitor.codemap.lookup_char_pos(module.inner.lo).file;\n+            // Format inner attributes if available.\n+            if !krate.attrs.is_empty() && path == main_file {\n+                visitor.visit_attrs(&krate.attrs, ast::AttrStyle::Inner);\n+            } else {\n+                visitor.last_pos = filemap.start_pos;\n+            }\n+            visitor.format_separate_mod(module, &*filemap);\n \n-            has_diff |= after_file(path, &mut visitor.buffer)?;\n+            has_diff |= after_file(path_str, &mut visitor.buffer)?;\n \n-            result.push((path.to_owned(), visitor.buffer));\n+            result.push((path_str.to_owned(), visitor.buffer));\n         }\n         // Reset the error count.\n         if parse_session.span_diagnostic.has_errors() {"}, {"sha": "0f7005e2856844132604b0490022432b06bd5f31", "filename": "src/visitor.rs", "status": "modified", "additions": 43, "deletions": 26, "changes": 69, "blob_url": "https://github.com/rust-lang/rust/blob/9f572dbc6454cc2eb627322c3209d4cfd30f2870/src%2Fvisitor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9f572dbc6454cc2eb627322c3209d4cfd30f2870/src%2Fvisitor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fvisitor.rs?ref=9f572dbc6454cc2eb627322c3209d4cfd30f2870", "patch": "@@ -12,7 +12,7 @@ use std::cmp;\n \n use strings::string_buffer::StringBuffer;\n use syntax::{ast, ptr, visit};\n-use syntax::codemap::{BytePos, CodeMap, Span};\n+use syntax::codemap::{self, BytePos, CodeMap, Span};\n use syntax::parse::ParseSess;\n \n use {Indent, Shape};\n@@ -128,7 +128,7 @@ impl<'a> FmtVisitor<'a> {\n         }\n     }\n \n-    pub fn visit_block(&mut self, b: &ast::Block) {\n+    pub fn visit_block(&mut self, b: &ast::Block, inner_attrs: Option<&[ast::Attribute]>) {\n         debug!(\n             \"visit_block: {:?} {:?}\",\n             self.codemap.lookup_char_pos(b.span.lo),\n@@ -144,6 +144,11 @@ impl<'a> FmtVisitor<'a> {\n         self.block_indent = self.block_indent.block_indent(self.config);\n         self.buffer.push_str(\"{\");\n \n+        // Format inner attributes if available.\n+        if let Some(attrs) = inner_attrs {\n+            self.visit_attrs(attrs, ast::AttrStyle::Inner);\n+        }\n+\n         for stmt in &b.stmts {\n             self.visit_stmt(stmt)\n         }\n@@ -201,6 +206,7 @@ impl<'a> FmtVisitor<'a> {\n         s: Span,\n         _: ast::NodeId,\n         defaultness: ast::Defaultness,\n+        inner_attrs: Option<&[ast::Attribute]>,\n     ) {\n         let indent = self.block_indent;\n         let block;\n@@ -254,22 +260,23 @@ impl<'a> FmtVisitor<'a> {\n         }\n \n         self.last_pos = source!(self, block.span).lo;\n-        self.visit_block(block)\n+        self.visit_block(block, inner_attrs)\n     }\n \n     pub fn visit_item(&mut self, item: &ast::Item) {\n         // This is where we bail out if there is a skip attribute. This is only\n         // complex in the module case. It is complex because the module could be\n         // in a separate file and there might be attributes in both files, but\n         // the AST lumps them all together.\n+        let mut attrs = item.attrs.clone();\n         match item.node {\n             ast::ItemKind::Mod(ref m) => {\n                 let outer_file = self.codemap.lookup_char_pos(item.span.lo).file;\n                 let inner_file = self.codemap.lookup_char_pos(m.inner.lo).file;\n                 if outer_file.name == inner_file.name {\n                     // Module is inline, in this case we treat modules like any\n                     // other item.\n-                    if self.visit_attrs(&item.attrs) {\n+                    if self.visit_attrs(&item.attrs, ast::AttrStyle::Outer) {\n                         self.push_rewrite(item.span, None);\n                         return;\n                     }\n@@ -279,7 +286,7 @@ impl<'a> FmtVisitor<'a> {\n                 } else {\n                     // Module is not inline and should not be skipped. We want\n                     // to process only the attributes in the current file.\n-                    let attrs = item.attrs\n+                    let filterd_attrs = item.attrs\n                         .iter()\n                         .filter_map(|a| {\n                             let attr_file = self.codemap.lookup_char_pos(a.span.lo).file;\n@@ -292,10 +299,11 @@ impl<'a> FmtVisitor<'a> {\n                         .collect::<Vec<_>>();\n                     // Assert because if we should skip it should be caught by\n                     // the above case.\n-                    assert!(!self.visit_attrs(&attrs));\n+                    assert!(!self.visit_attrs(&filterd_attrs, ast::AttrStyle::Outer));\n+                    attrs = filterd_attrs;\n                 }\n             }\n-            _ => if self.visit_attrs(&item.attrs) {\n+            _ => if self.visit_attrs(&item.attrs, ast::AttrStyle::Outer) {\n                 self.push_rewrite(item.span, None);\n                 return;\n             },\n@@ -361,7 +369,7 @@ impl<'a> FmtVisitor<'a> {\n             }\n             ast::ItemKind::Mod(ref module) => {\n                 self.format_missing_with_indent(source!(self, item.span).lo);\n-                self.format_mod(module, &item.vis, item.span, item.ident);\n+                self.format_mod(module, &item.vis, item.span, item.ident, &attrs);\n             }\n             ast::ItemKind::Mac(ref mac) => {\n                 self.visit_mac(mac, Some(item.ident), MacroPosition::Item);\n@@ -416,6 +424,7 @@ impl<'a> FmtVisitor<'a> {\n                     item.span,\n                     item.id,\n                     ast::Defaultness::Final,\n+                    Some(&item.attrs),\n                 )\n             }\n             ast::ItemKind::Ty(ref ty, ref generics) => {\n@@ -457,7 +466,7 @@ impl<'a> FmtVisitor<'a> {\n     }\n \n     pub fn visit_trait_item(&mut self, ti: &ast::TraitItem) {\n-        if self.visit_attrs(&ti.attrs) {\n+        if self.visit_attrs(&ti.attrs, ast::AttrStyle::Outer) {\n             self.push_rewrite(ti.span, None);\n             return;\n         }\n@@ -489,6 +498,7 @@ impl<'a> FmtVisitor<'a> {\n                     ti.span,\n                     ti.id,\n                     ast::Defaultness::Final,\n+                    Some(&ti.attrs),\n                 );\n             }\n             ast::TraitItemKind::Type(ref type_param_bounds, ref type_default) => {\n@@ -508,7 +518,7 @@ impl<'a> FmtVisitor<'a> {\n     }\n \n     pub fn visit_impl_item(&mut self, ii: &ast::ImplItem) {\n-        if self.visit_attrs(&ii.attrs) {\n+        if self.visit_attrs(&ii.attrs, ast::AttrStyle::Outer) {\n             self.push_rewrite(ii.span, None);\n             return;\n         }\n@@ -521,6 +531,7 @@ impl<'a> FmtVisitor<'a> {\n                     ii.span,\n                     ii.id,\n                     ii.defaultness,\n+                    Some(&ii.attrs),\n                 );\n             }\n             ast::ImplItemKind::Const(ref ty, ref expr) => {\n@@ -597,31 +608,27 @@ impl<'a> FmtVisitor<'a> {\n     }\n \n     // Returns true if we should skip the following item.\n-    pub fn visit_attrs(&mut self, attrs: &[ast::Attribute]) -> bool {\n+    pub fn visit_attrs(&mut self, attrs: &[ast::Attribute], style: ast::AttrStyle) -> bool {\n         if utils::contains_skip(attrs) {\n             return true;\n         }\n \n-        let outers: Vec<_> = attrs\n-            .iter()\n-            .filter(|a| a.style == ast::AttrStyle::Outer)\n-            .cloned()\n-            .collect();\n-        if outers.is_empty() {\n+        let attrs: Vec<_> = attrs.iter().filter(|a| a.style == style).cloned().collect();\n+        if attrs.is_empty() {\n             return false;\n         }\n \n-        let first = &outers[0];\n+        let first = &attrs[0];\n         self.format_missing_with_indent(source!(self, first.span).lo);\n \n-        let rewrite = outers\n+        let rewrite = attrs\n             .rewrite(\n                 &self.get_context(),\n                 Shape::indented(self.block_indent, self.config),\n             )\n             .unwrap();\n         self.buffer.push_str(&rewrite);\n-        let last = outers.last().unwrap();\n+        let last = attrs.last().unwrap();\n         self.last_pos = source!(self, last.span).hi;\n         false\n     }\n@@ -659,7 +666,14 @@ impl<'a> FmtVisitor<'a> {\n         }\n     }\n \n-    fn format_mod(&mut self, m: &ast::Mod, vis: &ast::Visibility, s: Span, ident: ast::Ident) {\n+    fn format_mod(\n+        &mut self,\n+        m: &ast::Mod,\n+        vis: &ast::Visibility,\n+        s: Span,\n+        ident: ast::Ident,\n+        attrs: &[ast::Attribute],\n+    ) {\n         // Decide whether this is an inline mod or an external mod.\n         let local_file_name = self.codemap.span_to_filename(s);\n         let inner_span = source!(self, m.inner);\n@@ -685,6 +699,7 @@ impl<'a> FmtVisitor<'a> {\n             } else {\n                 self.last_pos = mod_lo;\n                 self.block_indent = self.block_indent.block_indent(self.config);\n+                self.visit_attrs(attrs, ast::AttrStyle::Inner);\n                 self.walk_mod_items(m);\n                 self.format_missing_with_indent(source!(self, m.inner).hi - BytePos(1));\n                 self.close_block(false);\n@@ -696,9 +711,7 @@ impl<'a> FmtVisitor<'a> {\n         }\n     }\n \n-    pub fn format_separate_mod(&mut self, m: &ast::Mod) {\n-        let filemap = self.codemap.lookup_char_pos(m.inner.lo).file;\n-        self.last_pos = filemap.start_pos;\n+    pub fn format_separate_mod(&mut self, m: &ast::Mod, filemap: &codemap::FileMap) {\n         self.block_indent = Indent::empty();\n         self.walk_mod_items(m);\n         self.format_missing_with_indent(filemap.end_pos);\n@@ -836,14 +849,18 @@ impl Rewrite for ast::MetaItem {\n impl Rewrite for ast::Attribute {\n     fn rewrite(&self, context: &RewriteContext, shape: Shape) -> Option<String> {\n         try_opt!(self.meta()).rewrite(context, shape).map(\n-            |rw| if rw.starts_with(\"///\") {\n+            |rw| if self.is_sugared_doc {\n                 rw\n             } else {\n                 let original = context.snippet(self.span);\n+                let prefix = match self.style {\n+                    ast::AttrStyle::Inner => \"#!\",\n+                    ast::AttrStyle::Outer => \"#\",\n+                };\n                 if contains_comment(&original) {\n                     original\n                 } else {\n-                    format!(\"#[{}]\", rw)\n+                    format!(\"{}[{}]\", prefix, rw)\n                 }\n             },\n         )"}, {"sha": "beabed88510d39c0a2b9115b8b8950de1fc1d1b4", "filename": "tests/source/attrib.rs", "status": "modified", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/9f572dbc6454cc2eb627322c3209d4cfd30f2870/tests%2Fsource%2Fattrib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9f572dbc6454cc2eb627322c3209d4cfd30f2870/tests%2Fsource%2Fattrib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fattrib.rs?ref=9f572dbc6454cc2eb627322c3209d4cfd30f2870", "patch": "@@ -91,3 +91,20 @@ fn issue_1799() {\n     // https://github.com/rust-lang/rust/issues/43336\n     Some( Err(error) ) ;\n }\n+\n+// Formatting inner attributes\n+fn inner_attributes() {\n+    #![ this_is_an_inner_attribute ( foo ) ]\n+\n+    foo();\n+}\n+\n+impl InnerAttributes() {\n+    #![ this_is_an_inner_attribute ( foo ) ]\n+\n+    fn foo() {}\n+}\n+\n+mod InnerAttributes {\n+    #![ this_is_an_inner_attribute ( foo ) ]\n+}"}, {"sha": "eae226532589dc7c4bd17993777f610050f20d96", "filename": "tests/source/issue-1800.rs", "status": "added", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/9f572dbc6454cc2eb627322c3209d4cfd30f2870/tests%2Fsource%2Fissue-1800.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9f572dbc6454cc2eb627322c3209d4cfd30f2870/tests%2Fsource%2Fissue-1800.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fissue-1800.rs?ref=9f572dbc6454cc2eb627322c3209d4cfd30f2870", "patch": "@@ -0,0 +1,3 @@\n+#![doc(html_root_url    =    \"http://example.com\")]\n+#[cfg(feature    =    \"foo\")]\n+fn a() {}"}, {"sha": "43283d2db057a9d20cbbd0c1a4e3ed9073df739d", "filename": "tests/target/attrib.rs", "status": "modified", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/9f572dbc6454cc2eb627322c3209d4cfd30f2870/tests%2Ftarget%2Fattrib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9f572dbc6454cc2eb627322c3209d4cfd30f2870/tests%2Ftarget%2Fattrib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fattrib.rs?ref=9f572dbc6454cc2eb627322c3209d4cfd30f2870", "patch": "@@ -91,3 +91,20 @@ fn issue_1799() {\n     // https://github.com/rust-lang/rust/issues/43336\n     Some(Err(error));\n }\n+\n+// Formatting inner attributes\n+fn inner_attributes() {\n+    #![this_is_an_inner_attribute(foo)]\n+\n+    foo();\n+}\n+\n+impl InnerAttributes() {\n+    #![this_is_an_inner_attribute(foo)]\n+\n+    fn foo() {}\n+}\n+\n+mod InnerAttributes {\n+    #![this_is_an_inner_attribute(foo)]\n+}"}, {"sha": "516b78c4ec4214892715fc16283cd0826060f4a6", "filename": "tests/target/comment4.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/9f572dbc6454cc2eb627322c3209d4cfd30f2870/tests%2Ftarget%2Fcomment4.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9f572dbc6454cc2eb627322c3209d4cfd30f2870/tests%2Ftarget%2Fcomment4.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fcomment4.rs?ref=9f572dbc6454cc2eb627322c3209d4cfd30f2870", "patch": "@@ -1,5 +1,5 @@\n-#![allow(dead_code)] // bar\n-\n+#![allow(dead_code)]\n+// bar\n //! Doc comment\n fn test() {\n     // comment"}, {"sha": "06c5cfd056726d71c86ac05c66e929db665d2fa6", "filename": "tests/target/issue-1800.rs", "status": "added", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/9f572dbc6454cc2eb627322c3209d4cfd30f2870/tests%2Ftarget%2Fissue-1800.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9f572dbc6454cc2eb627322c3209d4cfd30f2870/tests%2Ftarget%2Fissue-1800.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fissue-1800.rs?ref=9f572dbc6454cc2eb627322c3209d4cfd30f2870", "patch": "@@ -0,0 +1,3 @@\n+#![doc(html_root_url = \"http://example.com\")]\n+#[cfg(feature = \"foo\")]\n+fn a() {}"}]}