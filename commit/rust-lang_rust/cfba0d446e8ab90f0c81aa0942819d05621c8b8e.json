{"sha": "cfba0d446e8ab90f0c81aa0942819d05621c8b8e", "node_id": "MDY6Q29tbWl0NzI0NzEyOmNmYmEwZDQ0NmU4YWI5MGYwYzgxYWEwOTQyODE5ZDA1NjIxYzhiOGU=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-12-05T20:08:10Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-12-05T20:08:10Z"}, "message": "Auto merge of #46514 - zackmdavis:sticking_it_to_the_man, r=alexcrichton\n\ntemplate month/year, version into man pages while building dist tarball\n\n![the_man](https://user-images.githubusercontent.com/1076988/33596149-963956f4-d94f-11e7-926f-e683217765e5.png)\n\nThis is meant to resolve #25689.\n\nr? @alexcrichton", "tree": {"sha": "9acc17d201d4459601e3ec8f996d4b0d2e7f2ac5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9acc17d201d4459601e3ec8f996d4b0d2e7f2ac5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cfba0d446e8ab90f0c81aa0942819d05621c8b8e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cfba0d446e8ab90f0c81aa0942819d05621c8b8e", "html_url": "https://github.com/rust-lang/rust/commit/cfba0d446e8ab90f0c81aa0942819d05621c8b8e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cfba0d446e8ab90f0c81aa0942819d05621c8b8e/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "abe85ab0b232e744b602d20a65fbe92aa71c6045", "url": "https://api.github.com/repos/rust-lang/rust/commits/abe85ab0b232e744b602d20a65fbe92aa71c6045", "html_url": "https://github.com/rust-lang/rust/commit/abe85ab0b232e744b602d20a65fbe92aa71c6045"}, {"sha": "207fc0bb459d9420cdb9e3050592c6eaada94709", "url": "https://api.github.com/repos/rust-lang/rust/commits/207fc0bb459d9420cdb9e3050592c6eaada94709", "html_url": "https://github.com/rust-lang/rust/commit/207fc0bb459d9420cdb9e3050592c6eaada94709"}], "stats": {"total": 41, "additions": 35, "deletions": 6}, "files": [{"sha": "f04ce47c83fb5d0423146a89d680bafce03d3aa7", "filename": "src/bootstrap/dist.rs", "status": "modified", "additions": 17, "deletions": 2, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/cfba0d446e8ab90f0c81aa0942819d05621c8b8e/src%2Fbootstrap%2Fdist.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cfba0d446e8ab90f0c81aa0942819d05621c8b8e/src%2Fbootstrap%2Fdist.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fdist.rs?ref=cfba0d446e8ab90f0c81aa0942819d05621c8b8e", "patch": "@@ -28,7 +28,7 @@ use build_helper::output;\n \n use {Build, Compiler, Mode};\n use channel;\n-use util::{cp_r, libdir, is_dylib, cp_filtered, copy};\n+use util::{cp_r, libdir, is_dylib, cp_filtered, copy, replace_in_file};\n use builder::{Builder, RunConfig, ShouldRun, Step};\n use compile;\n use tool::{self, Tool};\n@@ -434,7 +434,22 @@ impl Step for Rustc {\n \n             // Man pages\n             t!(fs::create_dir_all(image.join(\"share/man/man1\")));\n-            cp_r(&build.src.join(\"src/doc/man\"), &image.join(\"share/man/man1\"));\n+            let man_src = build.src.join(\"src/doc/man\");\n+            let man_dst = image.join(\"share/man/man1\");\n+            let date_output = output(Command::new(\"date\").arg(\"+%B %Y\"));\n+            let month_year = date_output.trim();\n+            // don't use our `bootstrap::util::{copy, cp_r}`, because those try\n+            // to hardlink, and we don't want to edit the source templates\n+            for entry_result in t!(fs::read_dir(man_src)) {\n+                let file_entry = t!(entry_result);\n+                let page_src = file_entry.path();\n+                let page_dst = man_dst.join(file_entry.file_name());\n+                t!(fs::copy(&page_src, &page_dst));\n+                // template in month/year and version number\n+                replace_in_file(&page_dst,\n+                                &[(\"<INSERT DATE HERE>\", month_year),\n+                                  (\"<INSERT VERSION HERE>\", channel::CFG_RELEASE_NUM)]);\n+            }\n \n             // Debugger scripts\n             builder.ensure(DebuggerScripts {"}, {"sha": "874065f21d0809adbb4af7af4514bbfb2a4873d6", "filename": "src/bootstrap/util.rs", "status": "modified", "additions": 16, "deletions": 2, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/cfba0d446e8ab90f0c81aa0942819d05621c8b8e/src%2Fbootstrap%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cfba0d446e8ab90f0c81aa0942819d05621c8b8e/src%2Fbootstrap%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Futil.rs?ref=cfba0d446e8ab90f0c81aa0942819d05621c8b8e", "patch": "@@ -15,8 +15,8 @@\n \n use std::env;\n use std::str;\n-use std::fs::{self, File};\n-use std::io::{self, Read, Write};\n+use std::fs::{self, File, OpenOptions};\n+use std::io::{self, Read, Write, Seek, SeekFrom};\n use std::path::{Path, PathBuf};\n use std::process::Command;\n use std::time::{SystemTime, Instant};\n@@ -51,6 +51,20 @@ pub fn copy(src: &Path, dst: &Path) {\n     t!(filetime::set_file_times(dst, atime, mtime));\n }\n \n+/// Search-and-replaces within a file. (Not maximally efficiently: allocates a\n+/// new string for each replacement.)\n+pub fn replace_in_file(path: &Path, replacements: &[(&str, &str)]) {\n+    let mut contents = String::new();\n+    let mut file = t!(OpenOptions::new().read(true).write(true).open(path));\n+    t!(file.read_to_string(&mut contents));\n+    for &(target, replacement) in replacements {\n+        contents = contents.replace(target, replacement);\n+    }\n+    t!(file.seek(SeekFrom::Start(0)));\n+    t!(file.set_len(0));\n+    t!(file.write_all(contents.as_bytes()));\n+}\n+\n pub fn read_stamp_file(stamp: &Path) -> Vec<PathBuf> {\n     let mut paths = Vec::new();\n     let mut contents = Vec::new();"}, {"sha": "19f6cc9ac619d0d677392ce548efead407789349", "filename": "src/doc/man/rustc.1", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/cfba0d446e8ab90f0c81aa0942819d05621c8b8e/src%2Fdoc%2Fman%2Frustc.1", "raw_url": "https://github.com/rust-lang/rust/raw/cfba0d446e8ab90f0c81aa0942819d05621c8b8e/src%2Fdoc%2Fman%2Frustc.1", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Fman%2Frustc.1?ref=cfba0d446e8ab90f0c81aa0942819d05621c8b8e", "patch": "@@ -1,4 +1,4 @@\n-.TH RUSTC \"1\" \"September 2016\" \"rustc 1.13.0\" \"User Commands\"\n+.TH RUSTC \"1\" \"<INSERT DATE HERE>\" \"rustc <INSERT VERSION HERE>\" \"User Commands\"\n .SH NAME\n rustc \\- The Rust compiler\n .SH SYNOPSIS"}, {"sha": "a878380f556b3f069f7512c29e54de33110a40da", "filename": "src/doc/man/rustdoc.1", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/cfba0d446e8ab90f0c81aa0942819d05621c8b8e/src%2Fdoc%2Fman%2Frustdoc.1", "raw_url": "https://github.com/rust-lang/rust/raw/cfba0d446e8ab90f0c81aa0942819d05621c8b8e/src%2Fdoc%2Fman%2Frustdoc.1", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Fman%2Frustdoc.1?ref=cfba0d446e8ab90f0c81aa0942819d05621c8b8e", "patch": "@@ -1,4 +1,4 @@\n-.TH RUSTDOC \"1\" \"May 2017\" \"rustdoc 1.19.0\" \"User Commands\"\n+.TH RUSTDOC \"1\" \"<INSERT DATE HERE>\" \"rustdoc <INSERT VERSION HERE>\" \"User Commands\"\n .SH NAME\n rustdoc \\- generate documentation from Rust source code\n .SH SYNOPSIS"}]}