{"sha": "0f9f241aac21bc77fb9e757da18207abefdc841d", "node_id": "C_kwDOAAsO6NoAKDBmOWYyNDFhYWMyMWJjNzdmYjllNzU3ZGExODIwN2FiZWZkYzg0MWQ", "commit": {"author": {"name": "Sebastian Pop", "email": "spop@amazon.com", "date": "2021-04-05T17:17:23Z"}, "committer": {"name": "Sebastian Pop", "email": "spop@amazon.com", "date": "2021-09-30T23:34:33Z"}, "message": "[aarch64] add target feature outline-atomics\n\nEnable outline-atomics by default as enabled in clang by the following commit\nhttps://reviews.llvm.org/rGc5e7e649d537067dec7111f3de1430d0fc8a4d11\n\nPerformance improves by several orders of magnitude when using the LSE instructions\ninstead of the ARMv8.0 compatible load/store exclusive instructions.\n\nTested on Graviton2 aarch64-linux with\nx.py build && x.py install && x.py test", "tree": {"sha": "2962afb37fc14dbda6cbe54e54453b6d31893aad", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2962afb37fc14dbda6cbe54e54453b6d31893aad"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0f9f241aac21bc77fb9e757da18207abefdc841d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0f9f241aac21bc77fb9e757da18207abefdc841d", "html_url": "https://github.com/rust-lang/rust/commit/0f9f241aac21bc77fb9e757da18207abefdc841d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0f9f241aac21bc77fb9e757da18207abefdc841d/comments", "author": {"login": "sebpop", "id": 568397, "node_id": "MDQ6VXNlcjU2ODM5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/568397?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sebpop", "html_url": "https://github.com/sebpop", "followers_url": "https://api.github.com/users/sebpop/followers", "following_url": "https://api.github.com/users/sebpop/following{/other_user}", "gists_url": "https://api.github.com/users/sebpop/gists{/gist_id}", "starred_url": "https://api.github.com/users/sebpop/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sebpop/subscriptions", "organizations_url": "https://api.github.com/users/sebpop/orgs", "repos_url": "https://api.github.com/users/sebpop/repos", "events_url": "https://api.github.com/users/sebpop/events{/privacy}", "received_events_url": "https://api.github.com/users/sebpop/received_events", "type": "User", "site_admin": false}, "committer": {"login": "sebpop", "id": 568397, "node_id": "MDQ6VXNlcjU2ODM5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/568397?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sebpop", "html_url": "https://github.com/sebpop", "followers_url": "https://api.github.com/users/sebpop/followers", "following_url": "https://api.github.com/users/sebpop/following{/other_user}", "gists_url": "https://api.github.com/users/sebpop/gists{/gist_id}", "starred_url": "https://api.github.com/users/sebpop/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sebpop/subscriptions", "organizations_url": "https://api.github.com/users/sebpop/orgs", "repos_url": "https://api.github.com/users/sebpop/repos", "events_url": "https://api.github.com/users/sebpop/events{/privacy}", "received_events_url": "https://api.github.com/users/sebpop/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3e8f32e1c52ca493c862facb7a69e7c3f1f97a18", "url": "https://api.github.com/repos/rust-lang/rust/commits/3e8f32e1c52ca493c862facb7a69e7c3f1f97a18", "html_url": "https://github.com/rust-lang/rust/commit/3e8f32e1c52ca493c862facb7a69e7c3f1f97a18"}], "stats": {"total": 21, "additions": 21, "deletions": 0}, "files": [{"sha": "2d053abd44efe7d15ff402f8c07f29ac2fb6486b", "filename": "compiler/rustc_codegen_llvm/src/llvm_util.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/0f9f241aac21bc77fb9e757da18207abefdc841d/compiler%2Frustc_codegen_llvm%2Fsrc%2Fllvm_util.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0f9f241aac21bc77fb9e757da18207abefdc841d/compiler%2Frustc_codegen_llvm%2Fsrc%2Fllvm_util.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fllvm_util.rs?ref=0f9f241aac21bc77fb9e757da18207abefdc841d", "patch": "@@ -416,6 +416,11 @@ pub fn llvm_global_features(sess: &Session) -> Vec<String> {\n     // -Ctarget-features\n     features.extend(sess.opts.cg.target_feature.split(',').flat_map(&filter));\n \n+    // FIXME: Move outline-atomics to target definition when earliest supported LLVM is 12.\n+    if get_version() >= (12, 0, 0) && sess.target.llvm_target.contains(\"aarch64-unknown-linux\") {\n+        features.push(\"+outline-atomics\".to_string());\n+    }\n+\n     features\n }\n "}, {"sha": "93dda712e1b9b3695f5fa6589ba7749fa1b45dc1", "filename": "src/test/assembly/asm/aarch64-outline-atomics.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/0f9f241aac21bc77fb9e757da18207abefdc841d/src%2Ftest%2Fassembly%2Fasm%2Faarch64-outline-atomics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0f9f241aac21bc77fb9e757da18207abefdc841d/src%2Ftest%2Fassembly%2Fasm%2Faarch64-outline-atomics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fassembly%2Fasm%2Faarch64-outline-atomics.rs?ref=0f9f241aac21bc77fb9e757da18207abefdc841d", "patch": "@@ -0,0 +1,16 @@\n+// min-llvm-version: 12.0\n+// assembly-output: emit-asm\n+// compile-flags: -O\n+// compile-flags: --target aarch64-unknown-linux-gnu\n+// needs-llvm-components: aarch64\n+// only-aarch64\n+\n+#![crate_type = \"rlib\"]\n+\n+use std::sync::atomic::{AtomicI32, Ordering::*};\n+\n+pub fn compare_exchange(a: &AtomicI32) {\n+    // On AArch64 LLVM should outline atomic operations.\n+    // CHECK: __aarch64_cas4_relax\n+    let _ = a.compare_exchange(0, 10, Relaxed, Relaxed);\n+}"}]}