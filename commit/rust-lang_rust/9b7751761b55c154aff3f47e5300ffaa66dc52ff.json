{"sha": "9b7751761b55c154aff3f47e5300ffaa66dc52ff", "node_id": "MDY6Q29tbWl0NzI0NzEyOjliNzc1MTc2MWI1NWMxNTRhZmYzZjQ3ZTUzMDBmZmFhNjZkYzUyZmY=", "commit": {"author": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2014-03-20T05:47:37Z"}, "committer": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2014-03-20T05:51:12Z"}, "message": "mk: Simplify how prepare.mk, install.mk, and dist.mk deal with stages\n\nThe only stage that can be installed from is 2 everywhere but windows,\n3 on windows.\n\nCloses #12799", "tree": {"sha": "1df784f84bdb89d256a5d89e4fa49f4b7cacec1d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1df784f84bdb89d256a5d89e4fa49f4b7cacec1d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9b7751761b55c154aff3f47e5300ffaa66dc52ff", "comment_count": 17, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9b7751761b55c154aff3f47e5300ffaa66dc52ff", "html_url": "https://github.com/rust-lang/rust/commit/9b7751761b55c154aff3f47e5300ffaa66dc52ff", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9b7751761b55c154aff3f47e5300ffaa66dc52ff/comments", "author": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "committer": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4ca51aeea7187a63b987129d67cf7d348b6c60a9", "url": "https://api.github.com/repos/rust-lang/rust/commits/4ca51aeea7187a63b987129d67cf7d348b6c60a9", "html_url": "https://github.com/rust-lang/rust/commit/4ca51aeea7187a63b987129d67cf7d348b6c60a9"}], "stats": {"total": 46, "additions": 17, "deletions": 29}, "files": [{"sha": "7ac3582f821cfb5341e4de13cb8cef6d0c8fee27", "filename": "mk/dist.mk", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/9b7751761b55c154aff3f47e5300ffaa66dc52ff/mk%2Fdist.mk", "raw_url": "https://github.com/rust-lang/rust/raw/9b7751761b55c154aff3f47e5300ffaa66dc52ff/mk%2Fdist.mk", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/mk%2Fdist.mk?ref=9b7751761b55c154aff3f47e5300ffaa66dc52ff", "patch": "@@ -65,8 +65,6 @@ $(PKG_EXE): rust.iss modpath.iss LICENSE.txt rust-logo.ico \\\n dist-prepare-win: PREPARE_HOST=$(CFG_BUILD)\n dist-prepare-win: PREPARE_TARGETS=$(CFG_BUILD)\n dist-prepare-win: PREPARE_DEST_DIR=tmp/dist/win\n-# On windows we're using stage3, unlike Unix...\n-dist-prepare-win: PREPARE_STAGE=3\n dist-prepare-win: PREPARE_DIR_CMD=$(DEFAULT_PREPARE_DIR_CMD)\n dist-prepare-win: PREPARE_BIN_CMD=$(DEFAULT_PREPARE_BIN_CMD)\n dist-prepare-win: PREPARE_LIB_CMD=$(DEFAULT_PREPARE_LIB_CMD)\n@@ -135,7 +133,6 @@ ifeq ($(CFG_OSTYPE), apple-darwin)\n dist-prepare-osx: PREPARE_HOST=$(CFG_BUILD)\n dist-prepare-osx: PREPARE_TARGETS=$(CFG_BUILD)\n dist-prepare-osx: PREPARE_DEST_DIR=tmp/dist/pkgroot\n-dist-prepare-osx: PREPARE_STAGE=2\n dist-prepare-osx: PREPARE_DIR_CMD=$(DEFAULT_PREPARE_DIR_CMD)\n dist-prepare-osx: PREPARE_BIN_CMD=$(DEFAULT_PREPARE_BIN_CMD)\n dist-prepare-osx: PREPARE_LIB_CMD=$(DEFAULT_PREPARE_LIB_CMD)\n@@ -165,7 +162,6 @@ dist-tar-bins: $(foreach host,$(CFG_HOST),dist/$(PKG_DIR)-$(host).tar.gz)\n define DEF_INSTALLER\n dist-install-dir-$(1): PREPARE_HOST=$(1)\n dist-install-dir-$(1): PREPARE_TARGETS=$(1)\n-dist-install-dir-$(1): PREPARE_STAGE=2\n dist-install-dir-$(1): PREPARE_DEST_DIR=tmp/dist/$$(PKG_DIR)-$(1)\n dist-install-dir-$(1): PREPARE_DIR_CMD=$(DEFAULT_PREPARE_DIR_CMD)\n dist-install-dir-$(1): PREPARE_BIN_CMD=$(DEFAULT_PREPARE_BIN_CMD)"}, {"sha": "6e56767a9d7e346b8707b2f6620b9910dfa4b7d8", "filename": "mk/install.mk", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/9b7751761b55c154aff3f47e5300ffaa66dc52ff/mk%2Finstall.mk", "raw_url": "https://github.com/rust-lang/rust/raw/9b7751761b55c154aff3f47e5300ffaa66dc52ff/mk%2Finstall.mk", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/mk%2Finstall.mk?ref=9b7751761b55c154aff3f47e5300ffaa66dc52ff", "patch": "@@ -13,11 +13,10 @@\n # mirror of the installation directory structure.\n \n # The stage we install from\n-ISTAGE = 2\n+ISTAGE = $(PREPARE_STAGE)\n \n install: PREPARE_HOST=$(CFG_BUILD)\n install: PREPARE_TARGETS=$(CFG_TARGET)\n-install: PREPARE_STAGE=$(ISTAGE)\n install: PREPARE_DIR_CMD=$(DEFAULT_PREPARE_DIR_CMD)\n install: PREPARE_BIN_CMD=$(DEFAULT_PREPARE_BIN_CMD)\n install: PREPARE_LIB_CMD=$(DEFAULT_PREPARE_LIB_CMD)"}, {"sha": "bfc5c8785d00b78528a6604de8d7d932aeff7a31", "filename": "mk/prepare.mk", "status": "modified", "additions": 16, "deletions": 23, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/9b7751761b55c154aff3f47e5300ffaa66dc52ff/mk%2Fprepare.mk", "raw_url": "https://github.com/rust-lang/rust/raw/9b7751761b55c154aff3f47e5300ffaa66dc52ff/mk%2Fprepare.mk", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/mk%2Fprepare.mk?ref=9b7751761b55c154aff3f47e5300ffaa66dc52ff", "patch": "@@ -20,7 +20,14 @@\n #   PREPARE_TARGETS - the target triples, space separated\n #   PREPARE_DEST_DIR - the directory to put the image\n \n-prepare: PREPARE_STAGE=2\n+\n+# On windows we install from stage3, but on unix only stage2\n+ifdef CFG_WINDOWSY_$(CFG_BUILD)\n+PREPARE_STAGE=3\n+else\n+PREPARE_STAGE=2\n+endif\n+\n prepare: PREPARE_DIR_CMD=$(DEFAULT_PREPARE_DIR_CMD)\n prepare: PREPARE_BIN_CMD=$(DEFAULT_PREPARE_BIN_CMD)\n prepare: PREPARE_LIB_CMD=$(DEFAULT_PREPARE_LIB_CMD)\n@@ -43,15 +50,6 @@ DEFAULT_PREPARE_BIN_CMD = install -m755\n DEFAULT_PREPARE_LIB_CMD = install -m644\n DEFAULT_PREPARE_MAN_CMD = install -m644\n \n-# On windows we install from stage3, but on unix only stage2\n-# Because of the way these rules are organized, preparing from any\n-# stage requires all these stages to be built\n-ifdef CFG_WINDOWSY_$(CFG_BUILD)\n-PREPARE_STAGES=3\n-else\n-PREPARE_STAGES=2\n-endif\n-\n # Create a directory\n # $(1) is the directory\n define PREPARE_DIR\n@@ -102,9 +100,8 @@ prepare-host: prepare-host-tools\n \n prepare-host-tools: \\\n         $(foreach tool, $(PREPARE_TOOLS),\\\n-          $(foreach stage,$(PREPARE_STAGES),\\\n-            $(foreach host,$(CFG_HOST),\\\n-              prepare-host-tool-$(tool)-$(stage)-$(host))))\n+          $(foreach host,$(CFG_HOST),\\\n+            prepare-host-tool-$(tool)-$(PREPARE_STAGE)-$(host)))\n \n prepare-host-dirs: prepare-maybe-clean\n \t$(call PREPARE_DIR,$(PREPARE_DEST_BIN_DIR))\n@@ -128,9 +125,8 @@ prepare-host-tool-$(1)-$(2)-$(3): prepare-maybe-clean \\\n endef\n \n $(foreach tool,$(PREPARE_TOOLS),\\\n-  $(foreach stage,$(PREPARE_STAGES),\\\n-    $(foreach host,$(CFG_HOST),\\\n-        $(eval $(call DEF_PREPARE_HOST_TOOL,$(tool),$(stage),$(host))))))\n+  $(foreach host,$(CFG_HOST),\\\n+      $(eval $(call DEF_PREPARE_HOST_TOOL,$(tool),$(PREPARE_STAGE),$(host)))))\n \n # For host libraries only install dylibs, not rlibs since the host libs are only\n # used to support rustc and rustc uses dynamic linking\n@@ -151,15 +147,13 @@ prepare-host-lib-$(1)-$(2)-$(3): prepare-maybe-clean \\\n endef\n \n $(foreach lib,$(CRATES),\\\n-  $(foreach stage,$(PREPARE_STAGES),\\\n-    $(foreach host,$(CFG_HOST),\\\n-      $(eval $(call DEF_PREPARE_HOST_LIB,$(lib),$(stage),$(host))))))\n+  $(foreach host,$(CFG_HOST),\\\n+    $(eval $(call DEF_PREPARE_HOST_LIB,$(lib),$(PREPARE_STAGE),$(host)))))\n \n prepare-targets:\\\n         $(foreach host,$(CFG_HOST),\\\n            $(foreach target,$(CFG_TARGET),\\\n-             $(foreach stage,$(PREPARE_STAGES),\\\n-               prepare-target-$(target)-host-$(host)-$(stage))))\n+             prepare-target-$(target)-host-$(host)-$(PREPARE_STAGE)))\n \n # $(1) is stage\n # $(2) is target\n@@ -194,8 +188,7 @@ endef\n \n $(foreach host,$(CFG_HOST),\\\n   $(foreach target,$(CFG_TARGET), \\\n-    $(foreach stage,$(PREPARE_STAGES),\\\n-      $(eval $(call DEF_PREPARE_TARGET_N,$(stage),$(target),$(host))))))\n+    $(eval $(call DEF_PREPARE_TARGET_N,$(PREPARE_STAGE),$(target),$(host)))))\n \n prepare-maybe-clean:\n \t$(if $(findstring true,$(PREPARE_CLEAN)),\\"}]}