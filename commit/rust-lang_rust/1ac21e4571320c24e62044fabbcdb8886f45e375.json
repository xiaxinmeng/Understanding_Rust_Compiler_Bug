{"sha": "1ac21e4571320c24e62044fabbcdb8886f45e375", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFhYzIxZTQ1NzEzMjBjMjRlNjIwNDRmYWJiY2RiODg4NmY0NWUzNzU=", "commit": {"author": {"name": "Camille GILLOT", "email": "gillot.camille@gmail.com", "date": "2021-01-19T17:24:08Z"}, "committer": {"name": "Camille GILLOT", "email": "gillot.camille@gmail.com", "date": "2021-02-19T16:51:56Z"}, "message": "Use QueryCtxt in DepKindStruct.", "tree": {"sha": "b211fec03f3962fa62f26435320ea69fd6658ff1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b211fec03f3962fa62f26435320ea69fd6658ff1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1ac21e4571320c24e62044fabbcdb8886f45e375", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1ac21e4571320c24e62044fabbcdb8886f45e375", "html_url": "https://github.com/rust-lang/rust/commit/1ac21e4571320c24e62044fabbcdb8886f45e375", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1ac21e4571320c24e62044fabbcdb8886f45e375/comments", "author": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "committer": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b27266fdb20dd6f6d58428bcf15771dbaeb18d01", "url": "https://api.github.com/repos/rust-lang/rust/commits/b27266fdb20dd6f6d58428bcf15771dbaeb18d01", "html_url": "https://github.com/rust-lang/rust/commit/b27266fdb20dd6f6d58428bcf15771dbaeb18d01"}], "stats": {"total": 17, "additions": 6, "deletions": 11}, "files": [{"sha": "063a57e484f32596bbd46c668cb773850fd55f66", "filename": "compiler/rustc_middle/src/dep_graph/dep_node.rs", "status": "modified", "additions": 4, "deletions": 9, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/1ac21e4571320c24e62044fabbcdb8886f45e375/compiler%2Frustc_middle%2Fsrc%2Fdep_graph%2Fdep_node.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1ac21e4571320c24e62044fabbcdb8886f45e375/compiler%2Frustc_middle%2Fsrc%2Fdep_graph%2Fdep_node.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fdep_graph%2Fdep_node.rs?ref=1ac21e4571320c24e62044fabbcdb8886f45e375", "patch": "@@ -135,7 +135,7 @@ pub struct DepKindStruct {\n     /// then `force_from_dep_node()` should not fail for it. Otherwise, you can just\n     /// add it to the \"We don't have enough information to reconstruct...\" group in\n     /// the match below.\n-    pub(crate) force_from_dep_node: fn(tcx: TyCtxt<'_>, dep_node: &DepNode) -> bool,\n+    pub(crate) force_from_dep_node: fn(tcx: QueryCtxt<'_>, dep_node: &DepNode) -> bool,\n \n     /// Invoke a query to put the on-disk cached value in memory.\n     pub(crate) try_load_from_on_disk_cache: fn(QueryCtxt<'_>, &DepNode),\n@@ -251,7 +251,7 @@ pub mod dep_kind {\n                     <query_keys::$variant<'_> as DepNodeParams<TyCtxt<'_>>>::recover(tcx, dep_node)\n                 }\n \n-                fn force_from_dep_node(tcx: TyCtxt<'_>, dep_node: &DepNode) -> bool {\n+                fn force_from_dep_node(tcx: QueryCtxt<'_>, dep_node: &DepNode) -> bool {\n                     if is_anon {\n                         return false;\n                     }\n@@ -260,13 +260,8 @@ pub mod dep_kind {\n                         return false;\n                     }\n \n-                    if let Some(key) = recover(tcx, dep_node) {\n-                        force_query::<queries::$variant<'_>, _>(\n-                            QueryCtxt { tcx, queries: tcx.queries },\n-                            key,\n-                            DUMMY_SP,\n-                            *dep_node\n-                        );\n+                    if let Some(key) = recover(*tcx, dep_node) {\n+                        force_query::<queries::$variant<'_>, _>(tcx, key, DUMMY_SP, *dep_node);\n                         return true;\n                     }\n "}, {"sha": "66ed3adb65ac041e098795e6743587535ff6934e", "filename": "compiler/rustc_middle/src/ty/query/plumbing.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/1ac21e4571320c24e62044fabbcdb8886f45e375/compiler%2Frustc_middle%2Fsrc%2Fty%2Fquery%2Fplumbing.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1ac21e4571320c24e62044fabbcdb8886f45e375/compiler%2Frustc_middle%2Fsrc%2Fty%2Fquery%2Fplumbing.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fquery%2Fplumbing.rs?ref=1ac21e4571320c24e62044fabbcdb8886f45e375", "patch": "@@ -68,7 +68,7 @@ impl QueryContext for QueryCtxt<'tcx> {\n         self.queries.try_collect_active_jobs()\n     }\n \n-    fn try_load_from_on_disk_cache(&self, dep_node: &dep_graph::DepNode) {\n+    fn try_load_from_on_disk_cache(&self, dep_node: &DepNode) {\n         (dep_node.kind.try_load_from_on_disk_cache)(*self, dep_node)\n     }\n \n@@ -126,7 +126,7 @@ impl QueryContext for QueryCtxt<'tcx> {\n             \"calling force_from_dep_node() on DepKind::codegen_unit\"\n         );\n \n-        (dep_node.kind.force_from_dep_node)(**self, dep_node)\n+        (dep_node.kind.force_from_dep_node)(*self, dep_node)\n     }\n \n     fn has_errors_or_delayed_span_bugs(&self) -> bool {"}]}