{"sha": "dc1c39b10ed4650de784e860e2778c3e246f585e", "node_id": "C_kwDOAAsO6NoAKGRjMWMzOWIxMGVkNDY1MGRlNzg0ZTg2MGUyNzc4YzNlMjQ2ZjU4NWU", "commit": {"author": {"name": "Andy Russell", "email": "arussell123@gmail.com", "date": "2021-12-09T05:21:36Z"}, "committer": {"name": "Andy Russell", "email": "arussell123@gmail.com", "date": "2022-01-13T16:41:48Z"}, "message": "rustdoc: decouple stability and const-stability", "tree": {"sha": "339732543a3eb8b792fa13882f7376d64e6cdd22", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/339732543a3eb8b792fa13882f7376d64e6cdd22"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/dc1c39b10ed4650de784e860e2778c3e246f585e", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQFKBAABCAA0FiEELriChyEaiMu0yCg7viIhAz7bw3QFAmHgVk8WHGFydXNzZWxs\nMTIzQGdtYWlsLmNvbQAKCRC+IiEDPtvDdMbzCACnXw+h4EClc/zhN3by48dTjL57\nV8UG9FQrqBNzyJ1DA8ZCrD6+09XqfzgY/h4X/TGcBfunOF5TZE4nVm+vjnKA9Kdg\nagfPY7pYDlRmeQUZPuEkJMIS99dgs61nugwKlixQkzKbeYgJi6GF57BJPEcxBffF\nu1mQPppE6AnpGLOjxCL/k6pU6BXa4YKt5nH2tp5Re2fCStr7TKUf0M1AEZ4f/eQa\n/vW9UmRe3PlULFE3BQhfOL/fowEEgOnKkX5UnfLK3ZerD7GqDzRld6yQqGmAnUBu\n6Fv7nxvwXhoovgA8v43iYqQBL4DYtjudDK7sdd1v5d7UEewKAVuu3UUNNGjY\n=wolk\n-----END PGP SIGNATURE-----", "payload": "tree 339732543a3eb8b792fa13882f7376d64e6cdd22\nparent 256721ee519f6ff15dc5c1cfaf3ebf9af75efa4a\nauthor Andy Russell <arussell123@gmail.com> 1639027296 -0500\ncommitter Andy Russell <arussell123@gmail.com> 1642092108 -0500\n\nrustdoc: decouple stability and const-stability\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/dc1c39b10ed4650de784e860e2778c3e246f585e", "html_url": "https://github.com/rust-lang/rust/commit/dc1c39b10ed4650de784e860e2778c3e246f585e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/dc1c39b10ed4650de784e860e2778c3e246f585e/comments", "author": {"login": "euclio", "id": 1372438, "node_id": "MDQ6VXNlcjEzNzI0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1372438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/euclio", "html_url": "https://github.com/euclio", "followers_url": "https://api.github.com/users/euclio/followers", "following_url": "https://api.github.com/users/euclio/following{/other_user}", "gists_url": "https://api.github.com/users/euclio/gists{/gist_id}", "starred_url": "https://api.github.com/users/euclio/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/euclio/subscriptions", "organizations_url": "https://api.github.com/users/euclio/orgs", "repos_url": "https://api.github.com/users/euclio/repos", "events_url": "https://api.github.com/users/euclio/events{/privacy}", "received_events_url": "https://api.github.com/users/euclio/received_events", "type": "User", "site_admin": false}, "committer": {"login": "euclio", "id": 1372438, "node_id": "MDQ6VXNlcjEzNzI0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1372438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/euclio", "html_url": "https://github.com/euclio", "followers_url": "https://api.github.com/users/euclio/followers", "following_url": "https://api.github.com/users/euclio/following{/other_user}", "gists_url": "https://api.github.com/users/euclio/gists{/gist_id}", "starred_url": "https://api.github.com/users/euclio/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/euclio/subscriptions", "organizations_url": "https://api.github.com/users/euclio/orgs", "repos_url": "https://api.github.com/users/euclio/repos", "events_url": "https://api.github.com/users/euclio/events{/privacy}", "received_events_url": "https://api.github.com/users/euclio/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "256721ee519f6ff15dc5c1cfaf3ebf9af75efa4a", "url": "https://api.github.com/repos/rust-lang/rust/commits/256721ee519f6ff15dc5c1cfaf3ebf9af75efa4a", "html_url": "https://github.com/rust-lang/rust/commit/256721ee519f6ff15dc5c1cfaf3ebf9af75efa4a"}], "stats": {"total": 110, "additions": 73, "deletions": 37}, "files": [{"sha": "3dfe03b54e9f28620c2243b4af1928b402b225eb", "filename": "src/librustdoc/html/render/mod.rs", "status": "modified", "additions": 55, "deletions": 36, "changes": 91, "blob_url": "https://github.com/rust-lang/rust/blob/dc1c39b10ed4650de784e860e2778c3e246f585e/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dc1c39b10ed4650de784e860e2778c3e246f585e/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs?ref=dc1c39b10ed4650de784e860e2778c3e246f585e", "patch": "@@ -792,58 +792,77 @@ fn assoc_type(\n     }\n }\n \n+/// Writes a span containing the versions at which an item became stable and/or const-stable. For\n+/// example, if the item became stable at 1.0.0, and const-stable at 1.45.0, this function would\n+/// write a span containing \"1.0.0 (const: 1.45.0)\".\n+///\n+/// Returns `true` if a stability annotation was rendered.\n+///\n+/// Stability and const-stability are considered separately. If the item is unstable, no version\n+/// will be written. If the item is const-unstable, \"const: unstable\" will be appended to the\n+/// span, with a link to the tracking issue if present. If an item's stability or const-stability\n+/// version matches the version of its enclosing item, that version will be omitted.\n+///\n+/// Note that it is possible for an unstable function to be const-stable. In that case, the span\n+/// will include the const-stable version, but no stable version will be emitted, as a natural\n+/// consequence of the above rules.\n fn render_stability_since_raw(\n     w: &mut Buffer,\n     ver: Option<Symbol>,\n     const_stability: Option<ConstStability>,\n     containing_ver: Option<Symbol>,\n     containing_const_ver: Option<Symbol>,\n ) -> bool {\n-    let ver = ver.filter(|inner| !inner.is_empty());\n+    let stable_version = ver.filter(|inner| !inner.is_empty() && Some(*inner) != containing_ver);\n \n-    match (ver, const_stability) {\n-        // stable and const stable\n-        (Some(v), Some(ConstStability { level: StabilityLevel::Stable { since }, .. }))\n+    let mut title = String::new();\n+    let mut stability = String::new();\n+\n+    if let Some(ver) = stable_version {\n+        stability.push_str(&ver.as_str());\n+        title.push_str(&format!(\"Stable since Rust version {}\", ver));\n+    }\n+\n+    let const_title_and_stability = match const_stability {\n+        Some(ConstStability { level: StabilityLevel::Stable { since }, .. })\n             if Some(since) != containing_const_ver =>\n         {\n-            write!(\n-                w,\n-                \"<span class=\\\"since\\\" title=\\\"Stable since Rust version {0}, const since {1}\\\">{0} (const: {1})</span>\",\n-                v, since\n-            );\n+            Some((format!(\"const since {}\", since), format!(\"const: {}\", since)))\n         }\n-        // stable and const unstable\n-        (\n-            Some(v),\n-            Some(ConstStability { level: StabilityLevel::Unstable { issue, .. }, feature, .. }),\n-        ) => {\n-            write!(\n-                w,\n-                \"<span class=\\\"since\\\" title=\\\"Stable since Rust version {0}, const unstable\\\">{0} (const: \",\n-                v\n-            );\n-            if let Some(n) = issue {\n-                write!(\n-                    w,\n-                    \"<a href=\\\"https://github.com/rust-lang/rust/issues/{}\\\" title=\\\"Tracking issue for {}\\\">unstable</a>\",\n+        Some(ConstStability { level: StabilityLevel::Unstable { issue, .. }, feature, .. }) => {\n+            let unstable = if let Some(n) = issue {\n+                format!(\n+                    r#\"<a href=\"https://github.com/rust-lang/rust/issues/{}\" title=\"Tracking issue for {}\">unstable</a>\"#,\n                     n, feature\n-                );\n+                )\n             } else {\n-                write!(w, \"unstable\");\n-            }\n-            write!(w, \")</span>\");\n+                String::from(\"unstable\")\n+            };\n+\n+            Some((String::from(\"const unstable\"), format!(\"const: {}\", unstable)))\n         }\n-        // stable\n-        (Some(v), _) if ver != containing_ver => {\n-            write!(\n-                w,\n-                \"<span class=\\\"since\\\" title=\\\"Stable since Rust version {0}\\\">{0}</span>\",\n-                v\n-            );\n+        _ => None,\n+    };\n+\n+    if let Some((const_title, const_stability)) = const_title_and_stability {\n+        if !title.is_empty() {\n+            title.push_str(&format!(\", {}\", const_title));\n+        } else {\n+            title.push_str(&const_title);\n+        }\n+\n+        if !stability.is_empty() {\n+            stability.push_str(&format!(\" ({})\", const_stability));\n+        } else {\n+            stability.push_str(&const_stability);\n         }\n-        _ => return false,\n     }\n-    true\n+\n+    if !stability.is_empty() {\n+        write!(w, r#\"<span class=\"since\" title=\"{}\">{}</span>\"#, title, stability);\n+    }\n+\n+    !stability.is_empty()\n }\n \n fn render_assoc_item("}, {"sha": "b8e101038f8f11b4ba74c1f8f97c7aabd148807d", "filename": "src/test/rustdoc/const-display.rs", "status": "modified", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/dc1c39b10ed4650de784e860e2778c3e246f585e/src%2Ftest%2Frustdoc%2Fconst-display.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dc1c39b10ed4650de784e860e2778c3e246f585e/src%2Ftest%2Frustdoc%2Fconst-display.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fconst-display.rs?ref=dc1c39b10ed4650de784e860e2778c3e246f585e", "patch": "@@ -67,3 +67,20 @@ impl Foo {\n     #[rustc_const_stable(feature = \"rust1\", since = \"1.2.0\")]\n     pub const fn stable_impl() -> u32 { 42 }\n }\n+\n+#[stable(feature = \"rust1\", since = \"1.0.0\")]\n+pub struct Bar;\n+\n+impl Bar {\n+    // Do not show non-const stabilities that are the same as the enclosing item.\n+    // @matches 'foo/struct.Bar.html' '//span[@class=\"since\"]' '^const: 1.2.0$'\n+    #[stable(feature = \"rust1\", since = \"1.0.0\")]\n+    #[rustc_const_stable(feature = \"rust1\", since = \"1.2.0\")]\n+    pub const fn stable_impl() -> u32 { 42 }\n+\n+    // Show const-stability even for unstable functions.\n+    // @matches 'foo/struct.Bar.html' '//span[@class=\"since\"]' '^const: 1.3.0$'\n+    #[unstable(feature = \"foo2\", issue = \"none\")]\n+    #[rustc_const_stable(feature = \"rust1\", since = \"1.3.0\")]\n+    pub const fn const_stable_unstable() -> u32 { 42 }\n+}"}, {"sha": "8ecca6d12d24af01bd4c61fe58a422a97bd9e607", "filename": "src/test/rustdoc/deref-const-fn.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/dc1c39b10ed4650de784e860e2778c3e246f585e/src%2Ftest%2Frustdoc%2Fderef-const-fn.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dc1c39b10ed4650de784e860e2778c3e246f585e/src%2Ftest%2Frustdoc%2Fderef-const-fn.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fderef-const-fn.rs?ref=dc1c39b10ed4650de784e860e2778c3e246f585e", "patch": "@@ -13,7 +13,7 @@ pub struct Bar;\n \n impl Bar {\n     // @has - '//*[@id=\"method.len\"]' 'pub const fn len(&self) -> usize'\n-    // @has - '//*[@id=\"method.len\"]//span[@class=\"since\"]' '1.0.0 (const: 1.0.0)'\n+    // @has - '//*[@id=\"method.len\"]//span[@class=\"since\"]' 'const: 1.0.0'\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n     #[rustc_const_stable(feature = \"rust1\", since = \"1.0.0\")]\n     pub const fn len(&self) -> usize { 0 }"}]}