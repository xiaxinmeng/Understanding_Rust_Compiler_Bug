{"sha": "81135c9dbc92dc78df747d5096ff07d867ef3b02", "node_id": "MDY6Q29tbWl0NzI0NzEyOjgxMTM1YzlkYmM5MmRjNzhkZjc0N2Q1MDk2ZmYwN2Q4NjdlZjNiMDI=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-04-25T11:40:18Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-04-25T11:40:18Z"}, "message": "Auto merge of #50134 - andjo403:jobserver, r=michaelwoerister\n\nmake rustdoc test follow the jobserver limit of threads\n\nfix that to many threads is executing at the same time\nwhen rustdoc test is executed.", "tree": {"sha": "cb66eab88bc717058a27afbfc1cf33420c0d457a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/cb66eab88bc717058a27afbfc1cf33420c0d457a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/81135c9dbc92dc78df747d5096ff07d867ef3b02", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/81135c9dbc92dc78df747d5096ff07d867ef3b02", "html_url": "https://github.com/rust-lang/rust/commit/81135c9dbc92dc78df747d5096ff07d867ef3b02", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/81135c9dbc92dc78df747d5096ff07d867ef3b02/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5ec6637c15c5a19b45990f931e0e748d4a02d97e", "url": "https://api.github.com/repos/rust-lang/rust/commits/5ec6637c15c5a19b45990f931e0e748d4a02d97e", "html_url": "https://github.com/rust-lang/rust/commit/5ec6637c15c5a19b45990f931e0e748d4a02d97e"}, {"sha": "ed318dd991cb5356fe299aa8fc8c3078dcc614d3", "url": "https://api.github.com/repos/rust-lang/rust/commits/ed318dd991cb5356fe299aa8fc8c3078dcc614d3", "html_url": "https://github.com/rust-lang/rust/commit/ed318dd991cb5356fe299aa8fc8c3078dcc614d3"}], "stats": {"total": 26, "additions": 14, "deletions": 12}, "files": [{"sha": "3bd2bb3c8beb0d10bfdde8b60fd2246e0acba3c9", "filename": "src/librustc/session/mod.rs", "status": "modified", "additions": 13, "deletions": 4, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/81135c9dbc92dc78df747d5096ff07d867ef3b02/src%2Flibrustc%2Fsession%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/81135c9dbc92dc78df747d5096ff07d867ef3b02/src%2Flibrustc%2Fsession%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fsession%2Fmod.rs?ref=81135c9dbc92dc78df747d5096ff07d867ef3b02", "patch": "@@ -156,7 +156,7 @@ pub struct Session {\n \n     /// Loaded up early on in the initialization of this `Session` to avoid\n     /// false positives about a job server in our environment.\n-    pub jobserver_from_env: Option<Client>,\n+    pub jobserver: Client,\n \n     /// Metadata about the allocators for the current crate being compiled\n     pub has_global_allocator: Once<bool>,\n@@ -1128,14 +1128,23 @@ pub fn build_session_(\n         // positives, or in other words we try to execute this before we open\n         // any file descriptors ourselves.\n         //\n+        // Pick a \"reasonable maximum\" if we don't otherwise have\n+        // a jobserver in our environment, capping out at 32 so we\n+        // don't take everything down by hogging the process run queue.\n+        // The fixed number is used to have deterministic compilation\n+        // across machines.\n+        //\n         // Also note that we stick this in a global because there could be\n         // multiple `Session` instances in this process, and the jobserver is\n         // per-process.\n-        jobserver_from_env: unsafe {\n-            static mut GLOBAL_JOBSERVER: *mut Option<Client> = 0 as *mut _;\n+        jobserver: unsafe {\n+            static mut GLOBAL_JOBSERVER: *mut Client = 0 as *mut _;\n             static INIT: std::sync::Once = std::sync::ONCE_INIT;\n             INIT.call_once(|| {\n-                GLOBAL_JOBSERVER = Box::into_raw(Box::new(Client::from_env()));\n+                let client = Client::from_env().unwrap_or_else(|| {\n+                    Client::new(32).expect(\"failed to create jobserver\")\n+                });\n+                GLOBAL_JOBSERVER = Box::into_raw(Box::new(client));\n             });\n             (*GLOBAL_JOBSERVER).clone()\n         },"}, {"sha": "613a07cd2695dadf2489ad8472ba6d321167ee9e", "filename": "src/librustc_trans/back/write.rs", "status": "modified", "additions": 1, "deletions": 8, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/81135c9dbc92dc78df747d5096ff07d867ef3b02/src%2Flibrustc_trans%2Fback%2Fwrite.rs", "raw_url": "https://github.com/rust-lang/rust/raw/81135c9dbc92dc78df747d5096ff07d867ef3b02/src%2Flibrustc_trans%2Fback%2Fwrite.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Fback%2Fwrite.rs?ref=81135c9dbc92dc78df747d5096ff07d867ef3b02", "patch": "@@ -1007,13 +1007,6 @@ pub fn start_async_translation(tcx: TyCtxt,\n     metadata_config.time_passes = false;\n     allocator_config.time_passes = false;\n \n-    let client = sess.jobserver_from_env.clone().unwrap_or_else(|| {\n-        // Pick a \"reasonable maximum\" if we don't otherwise have a jobserver in\n-        // our environment, capping out at 32 so we don't take everything down\n-        // by hogging the process run queue.\n-        Client::new(32).expect(\"failed to create jobserver\")\n-    });\n-\n     let (shared_emitter, shared_emitter_main) = SharedEmitter::new();\n     let (trans_worker_send, trans_worker_receive) = channel();\n \n@@ -1023,7 +1016,7 @@ pub fn start_async_translation(tcx: TyCtxt,\n                                                   trans_worker_send,\n                                                   coordinator_receive,\n                                                   total_cgus,\n-                                                  client,\n+                                                  sess.jobserver.clone(),\n                                                   time_graph.clone(),\n                                                   Arc::new(modules_config),\n                                                   Arc::new(metadata_config),"}]}