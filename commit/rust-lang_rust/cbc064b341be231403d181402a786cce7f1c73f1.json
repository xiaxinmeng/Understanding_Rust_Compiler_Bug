{"sha": "cbc064b341be231403d181402a786cce7f1c73f1", "node_id": "C_kwDOAAsO6NoAKGNiYzA2NGIzNDFiZTIzMTQwM2QxODE0MDJhNzg2Y2NlN2YxYzczZjE", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-03-28T04:24:24Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-03-28T04:24:24Z"}, "message": "Auto merge of #109577 - jonhoo:long-tar-names, r=Mark-Simulacrum\n\n[rust-installer] Allow long link names in tar files\n\nWithout this, users trying to run `x.py dist` under a sufficiently long path run into problems when we build the resulting tarballs due to length limits in the original tar spec. The error looks like:\n\n        Finished release [optimized + debuginfo] target(s) in 0.34s\n    Copying stage0 std from stage0 (x86_64-unknown-linux-gnu -> x86_64-unknown-linux-gnu / x86_64-unknown-linux-musl)\n    Building stage0 tool rust-installer (x86_64-unknown-linux-gnu)\n        Finished release [optimized] target(s) in 0.35s\n    Dist rust-std-1.67.1-x86_64-unknown-linux-musl\n    Error: failed to generate installer\n\n    Caused by:\n        0: failed to tar file '/home/AAAAAAAAAAAAAA/BBBBBB/CCCC/DDD/EEEEE/FFFFFFFFFFFF/GGGGGGGGGGGGGGGG/HHHHHHHHHH/IIIIIIIIIIIIIII/JJJJJ/KKKKKKK/src/build/tmp/tarball/rust-std/x86_64-unknown-linux-musl/rust-std-1.67.1-x86_64-unknown-linux-musl/rust-std-x86_64-unknown-linux-musl/lib/rustlib/x86_64-unknown-linux-musl/lib/self-contained/libc.a'\n        1: provided value is too long when setting link name for\n    Build completed unsuccessfully in 0:00:03\n\nThe fix is to make use of the widely-supported GNU tar extensions which lift this restriction. Switching to [`tar::Builder::append_link`] takes care of that for us. See also alexcrichton/tar-rs#273.\n\n[`tar::Builder::append_link`]: https://docs.rs/tar/0.4.38/tar/struct.Builder.html#method.append_link", "tree": {"sha": "888b1de58c9957056ac914083b89cd4ffa9739ac", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/888b1de58c9957056ac914083b89cd4ffa9739ac"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cbc064b341be231403d181402a786cce7f1c73f1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cbc064b341be231403d181402a786cce7f1c73f1", "html_url": "https://github.com/rust-lang/rust/commit/cbc064b341be231403d181402a786cce7f1c73f1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cbc064b341be231403d181402a786cce7f1c73f1/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5ce70ed8dafeb3029cc7b493570a6f3e1c2f422b", "url": "https://api.github.com/repos/rust-lang/rust/commits/5ce70ed8dafeb3029cc7b493570a6f3e1c2f422b", "html_url": "https://github.com/rust-lang/rust/commit/5ce70ed8dafeb3029cc7b493570a6f3e1c2f422b"}, {"sha": "4d5501037a39a3c58421a02c45aec31a1d57300e", "url": "https://api.github.com/repos/rust-lang/rust/commits/4d5501037a39a3c58421a02c45aec31a1d57300e", "html_url": "https://github.com/rust-lang/rust/commit/4d5501037a39a3c58421a02c45aec31a1d57300e"}], "stats": {"total": 7, "additions": 3, "deletions": 4}, "files": [{"sha": "788e556b0c645c9bf486cd156752f5a589d1380a", "filename": "src/tools/rust-installer/Cargo.toml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/cbc064b341be231403d181402a786cce7f1c73f1/src%2Ftools%2Frust-installer%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/cbc064b341be231403d181402a786cce7f1c73f1/src%2Ftools%2Frust-installer%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Frust-installer%2FCargo.toml?ref=cbc064b341be231403d181402a786cce7f1c73f1", "patch": "@@ -13,7 +13,7 @@ path = \"src/main.rs\"\n anyhow = \"1.0.19\"\n flate2 = \"1.0.1\"\n rayon = \"1.0\"\n-tar = \"0.4.13\"\n+tar = \"0.4.38\"\n walkdir = \"2\"\n xz2 = \"0.1.4\"\n num_cpus = \"1\""}, {"sha": "7353a49fe03548e6d9d034096429a24d831b5142", "filename": "src/tools/rust-installer/src/tarballer.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/cbc064b341be231403d181402a786cce7f1c73f1/src%2Ftools%2Frust-installer%2Fsrc%2Ftarballer.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cbc064b341be231403d181402a786cce7f1c73f1/src%2Ftools%2Frust-installer%2Fsrc%2Ftarballer.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Frust-installer%2Fsrc%2Ftarballer.rs?ref=cbc064b341be231403d181402a786cce7f1c73f1", "patch": "@@ -1,6 +1,6 @@\n use anyhow::{bail, Context, Result};\n use std::fs::{read_link, symlink_metadata};\n-use std::io::{empty, BufWriter, Write};\n+use std::io::{BufWriter, Write};\n use std::path::Path;\n use tar::{Builder, Header};\n use walkdir::WalkDir;\n@@ -93,8 +93,7 @@ fn append_path<W: Write>(builder: &mut Builder<W>, src: &Path, path: &String) ->\n     header.set_metadata(&stat);\n     if stat.file_type().is_symlink() {\n         let link = read_link(src)?;\n-        header.set_link_name(&link)?;\n-        builder.append_data(&mut header, path, &mut empty())?;\n+        builder.append_link(&mut header, path, &link)?;\n     } else {\n         if cfg!(windows) {\n             // Windows doesn't really have a mode, so `tar` never marks files executable."}]}