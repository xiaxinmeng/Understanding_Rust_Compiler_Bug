{"sha": "df725c28d68d049aa29e06548961193531a9b891", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRmNzI1YzI4ZDY4ZDA0OWFhMjllMDY1NDg5NjExOTM1MzFhOWI4OTE=", "commit": {"author": {"name": "Mark Rousskov", "email": "mark.simulacrum@gmail.com", "date": "2019-07-09T22:21:23Z"}, "committer": {"name": "Mark Rousskov", "email": "mark.simulacrum@gmail.com", "date": "2019-07-10T13:56:47Z"}, "message": "Ensure that checkout is with \\n line endings\n\nDuring installation of mingw, at least, the git directories change, so\nwe need to reset the core.autocrlf config to false.\n\nOnce we finish checking out submodules, check that the line endings are\n\\n and not \\r\\n.", "tree": {"sha": "3ee5926f2afc9fe6925f401fa88aa5f57401926e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3ee5926f2afc9fe6925f401fa88aa5f57401926e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/df725c28d68d049aa29e06548961193531a9b891", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/df725c28d68d049aa29e06548961193531a9b891", "html_url": "https://github.com/rust-lang/rust/commit/df725c28d68d049aa29e06548961193531a9b891", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/df725c28d68d049aa29e06548961193531a9b891/comments", "author": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0324a2b309cd66cb7bd4a156bd0b84cb136e254f", "url": "https://api.github.com/repos/rust-lang/rust/commits/0324a2b309cd66cb7bd4a156bd0b84cb136e254f", "html_url": "https://github.com/rust-lang/rust/commit/0324a2b309cd66cb7bd4a156bd0b84cb136e254f"}], "stats": {"total": 34, "additions": 34, "deletions": 0}, "files": [{"sha": "ed06679464c06c6badbb6de2aeebc32a7b5aac9c", "filename": ".azure-pipelines/steps/install-windows-build-deps.yml", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/df725c28d68d049aa29e06548961193531a9b891/.azure-pipelines%2Fsteps%2Finstall-windows-build-deps.yml", "raw_url": "https://github.com/rust-lang/rust/raw/df725c28d68d049aa29e06548961193531a9b891/.azure-pipelines%2Fsteps%2Finstall-windows-build-deps.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.azure-pipelines%2Fsteps%2Finstall-windows-build-deps.yml?ref=df725c28d68d049aa29e06548961193531a9b891", "patch": "@@ -9,6 +9,9 @@ steps:\n   displayName: \"Ensure build happens on C:/ instead of D:/\"\n   condition: and(succeeded(), eq(variables['Agent.OS'], 'Windows_NT'))\n \n+- bash: git config --replace-all --global core.autocrlf false\n+  displayName: \"Disable git automatic line ending conversion (on C:/)\"\n+\n # Download and install MSYS2, needed primarily for the test suite (run-make) but\n # also used by the MinGW toolchain for assembling things.\n #"}, {"sha": "c73753a5857bdfc4c2b1edd7f153c8efff2c2cb5", "filename": ".azure-pipelines/steps/run.yml", "status": "modified", "additions": 31, "deletions": 0, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/df725c28d68d049aa29e06548961193531a9b891/.azure-pipelines%2Fsteps%2Frun.yml", "raw_url": "https://github.com/rust-lang/rust/raw/df725c28d68d049aa29e06548961193531a9b891/.azure-pipelines%2Fsteps%2Frun.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.azure-pipelines%2Fsteps%2Frun.yml?ref=df725c28d68d049aa29e06548961193531a9b891", "patch": "@@ -12,6 +12,9 @@ steps:\n # Azure's Windows image. Having the conversion enabled caused regressions both\n # in our test suite (it broke miri tests) and in the ecosystem, since we\n # started shipping install scripts with CRLF endings instead of the old LF.\n+#\n+# Note that we do this a couple times during the build as the PATH and current\n+# user/directory change, e.g. when mingw is enabled.\n - bash: git config --global core.autocrlf false\n   displayName: \"Disable git automatic line ending conversion\"\n \n@@ -70,6 +73,14 @@ steps:\n   displayName: Enable IPv6\n   condition: and(succeeded(), eq(variables['Agent.OS'], 'Linux'))\n \n+# Disable automatic line ending conversion (again). On Windows, when we're\n+# installing dependencies, something switches the git configuration directory or\n+# re-enables autocrlf. We've not tracked down the exact cause -- and there may\n+# be multiple -- but this should ensure submodules are checked out with the\n+# appropriate line endings.\n+- bash: git config --replace-all --global core.autocrlf false\n+  displayName: \"Disable git automatic line ending conversion\"\n+\n # Check out all our submodules, but more quickly than using git by using one of\n # our custom scripts\n - bash: |\n@@ -84,6 +95,26 @@ steps:\n   condition: and(succeeded(), eq(variables['Agent.OS'], 'Windows_NT'))\n   displayName: Check out submodules (Windows)\n \n+# See also the disable for autocrlf above, this just checks that it worked\n+#\n+# We check both in rust-lang/rust and in a submodule to make sure both are\n+# accurate. Submodules are checked out significantly later than the main\n+# repository in this script, so settings can (and do!) change between then.\n+#\n+# Linux (and maybe macOS) builders don't currently have dos2unix so just only\n+# run this step on Windows.\n+- bash: |\n+    set -x\n+    # print out the git configuration so we can better investigate failures in\n+    # the following\n+    git config --list --show-origin\n+    dos2unix -ih Cargo.lock src/tools/rust-installer/install-template.sh\n+    endings=$(dos2unix -ic Cargo.lock src/tools/rust-installer/install-template.sh)\n+    # if endings has non-zero length, error out\n+    if [ -n \"$endings\" ]; then exit 1 ; fi\n+  condition: and(succeeded(), eq(variables['Agent.OS'], 'Windows_NT'))\n+  displayName: Verify line endings are LF\n+\n # Ensure the `aws` CLI is installed so we can deploy later on, cache docker\n # images, etc.\n - bash: |"}]}