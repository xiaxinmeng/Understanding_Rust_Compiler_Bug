{"sha": "5306eb06cc2de0566ca789ee3863b78059ee2376", "node_id": "C_kwDOAAsO6NoAKDUzMDZlYjA2Y2MyZGUwNTY2Y2E3ODllZTM4NjNiNzgwNTllZTIzNzY", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-01-16T13:11:16Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-01-16T13:11:16Z"}, "message": "Auto merge of #13947 - WaffleLapkin:adjustment_hint_tooltips, r=Veykril\n\nAdd basic tooltips to adjustment hints\n\n![2023-01-16_16-45](https://user-images.githubusercontent.com/38225716/212681383-a60b60bb-a8e7-410d-8b24-f6b72c197311.png)\n\nI'm not sure how to make them look nicer, but it's at least something.", "tree": {"sha": "1a4e58f74d2adf2b965c7febdb726e2282a57abb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1a4e58f74d2adf2b965c7febdb726e2282a57abb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5306eb06cc2de0566ca789ee3863b78059ee2376", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5306eb06cc2de0566ca789ee3863b78059ee2376", "html_url": "https://github.com/rust-lang/rust/commit/5306eb06cc2de0566ca789ee3863b78059ee2376", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5306eb06cc2de0566ca789ee3863b78059ee2376/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "27c9c2fcaf57907862419751e11dbb600bfc77de", "url": "https://api.github.com/repos/rust-lang/rust/commits/27c9c2fcaf57907862419751e11dbb600bfc77de", "html_url": "https://github.com/rust-lang/rust/commit/27c9c2fcaf57907862419751e11dbb600bfc77de"}, {"sha": "81d7e302edcff20ba7ec8f3383f86cb513e0aceb", "url": "https://api.github.com/repos/rust-lang/rust/commits/81d7e302edcff20ba7ec8f3383f86cb513e0aceb", "html_url": "https://github.com/rust-lang/rust/commit/81d7e302edcff20ba7ec8f3383f86cb513e0aceb"}], "stats": {"total": 64, "additions": 43, "deletions": 21}, "files": [{"sha": "45e85a338a452f36298ab441bcb432c4538d5fcc", "filename": "crates/ide/src/inlay_hints/adjustment.rs", "status": "modified", "additions": 43, "deletions": 21, "changes": 64, "blob_url": "https://github.com/rust-lang/rust/blob/5306eb06cc2de0566ca789ee3863b78059ee2376/crates%2Fide%2Fsrc%2Finlay_hints%2Fadjustment.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5306eb06cc2de0566ca789ee3863b78059ee2376/crates%2Fide%2Fsrc%2Finlay_hints%2Fadjustment.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Finlay_hints%2Fadjustment.rs?ref=5306eb06cc2de0566ca789ee3863b78059ee2376", "patch": "@@ -3,15 +3,18 @@\n //! let _: u32  = /* <never-to-any> */ loop {};\n //! let _: &u32 = /* &* */ &mut 0;\n //! ```\n-use hir::{Adjust, AutoBorrow, Mutability, OverloadedDeref, PointerCast, Safety, Semantics};\n+use hir::{Adjust, Adjustment, AutoBorrow, HirDisplay, Mutability, PointerCast, Safety, Semantics};\n use ide_db::RootDatabase;\n \n use syntax::{\n     ast::{self, make, AstNode},\n     ted,\n };\n \n-use crate::{AdjustmentHints, AdjustmentHintsMode, InlayHint, InlayHintsConfig, InlayKind};\n+use crate::{\n+    AdjustmentHints, AdjustmentHintsMode, InlayHint, InlayHintLabel, InlayHintsConfig, InlayKind,\n+    InlayTooltip,\n+};\n \n pub(super) fn hints(\n     acc: &mut Vec<InlayHint>,\n@@ -61,44 +64,63 @@ pub(super) fn hints(\n         &mut tmp1\n     };\n \n-    for adjustment in iter {\n-        if adjustment.source == adjustment.target {\n+    for Adjustment { source, target, kind } in iter {\n+        if source == target {\n             continue;\n         }\n \n         // FIXME: Add some nicer tooltips to each of these\n-        let text = match adjustment.kind {\n+        let (text, coercion) = match kind {\n             Adjust::NeverToAny if config.adjustment_hints == AdjustmentHints::Always => {\n-                \"<never-to-any>\"\n+                (\"<never-to-any>\", \"never to any\")\n+            }\n+            Adjust::Deref(_) => (\"*\", \"dereference\"),\n+            Adjust::Borrow(AutoBorrow::Ref(Mutability::Shared)) => (\"&\", \"borrow\"),\n+            Adjust::Borrow(AutoBorrow::Ref(Mutability::Mut)) => (\"&mut \", \"unique borrow\"),\n+            Adjust::Borrow(AutoBorrow::RawPtr(Mutability::Shared)) => {\n+                (\"&raw const \", \"const pointer borrow\")\n+            }\n+            Adjust::Borrow(AutoBorrow::RawPtr(Mutability::Mut)) => {\n+                (\"&raw mut \", \"mut pointer borrow\")\n             }\n-            Adjust::Deref(None) => \"*\",\n-            Adjust::Deref(Some(OverloadedDeref(Mutability::Mut))) => \"*\",\n-            Adjust::Deref(Some(OverloadedDeref(Mutability::Shared))) => \"*\",\n-            Adjust::Borrow(AutoBorrow::Ref(Mutability::Shared)) => \"&\",\n-            Adjust::Borrow(AutoBorrow::Ref(Mutability::Mut)) => \"&mut \",\n-            Adjust::Borrow(AutoBorrow::RawPtr(Mutability::Shared)) => \"&raw const \",\n-            Adjust::Borrow(AutoBorrow::RawPtr(Mutability::Mut)) => \"&raw mut \",\n             // some of these could be represented via `as` casts, but that's not too nice and\n             // handling everything as a prefix expr makes the `(` and `)` insertion easier\n             Adjust::Pointer(cast) if config.adjustment_hints == AdjustmentHints::Always => {\n                 match cast {\n-                    PointerCast::ReifyFnPointer => \"<fn-item-to-fn-pointer>\",\n-                    PointerCast::UnsafeFnPointer => \"<safe-fn-pointer-to-unsafe-fn-pointer>\",\n+                    PointerCast::ReifyFnPointer => {\n+                        (\"<fn-item-to-fn-pointer>\", \"fn item to fn pointer\")\n+                    }\n+                    PointerCast::UnsafeFnPointer => (\n+                        \"<safe-fn-pointer-to-unsafe-fn-pointer>\",\n+                        \"safe fn pointer to unsafe fn pointer\",\n+                    ),\n                     PointerCast::ClosureFnPointer(Safety::Unsafe) => {\n-                        \"<closure-to-unsafe-fn-pointer>\"\n+                        (\"<closure-to-unsafe-fn-pointer>\", \"closure to unsafe fn pointer\")\n+                    }\n+                    PointerCast::ClosureFnPointer(Safety::Safe) => {\n+                        (\"<closure-to-fn-pointer>\", \"closure to fn pointer\")\n+                    }\n+                    PointerCast::MutToConstPointer => {\n+                        (\"<mut-ptr-to-const-ptr>\", \"mut ptr to const ptr\")\n                     }\n-                    PointerCast::ClosureFnPointer(Safety::Safe) => \"<closure-to-fn-pointer>\",\n-                    PointerCast::MutToConstPointer => \"<mut-ptr-to-const-ptr>\",\n-                    PointerCast::ArrayToPointer => \"<array-ptr-to-element-ptr>\",\n-                    PointerCast::Unsize => \"<unsize>\",\n+                    PointerCast::ArrayToPointer => (\"<array-ptr-to-element-ptr>\", \"\"),\n+                    PointerCast::Unsize => (\"<unsize>\", \"unsize\"),\n                 }\n             }\n             _ => continue,\n         };\n         acc.push(InlayHint {\n             range: expr.syntax().text_range(),\n             kind: if postfix { InlayKind::AdjustmentPostfix } else { InlayKind::Adjustment },\n-            label: if postfix { format!(\".{}\", text.trim_end()).into() } else { text.into() },\n+            label: InlayHintLabel::simple(\n+                if postfix { format!(\".{}\", text.trim_end()) } else { text.to_owned() },\n+                Some(InlayTooltip::Markdown(format!(\n+                    \"`{}` \u2192 `{}` ({coercion} coercion)\",\n+                    source.display(sema.db),\n+                    target.display(sema.db),\n+                ))),\n+                None,\n+            ),\n         });\n     }\n     if !postfix && needs_inner_parens {"}]}