{"sha": "af1aa86ac0df3470b379d21531e67fae0e9c942f", "node_id": "C_kwDOAAsO6NoAKGFmMWFhODZhYzBkZjM0NzBiMzc5ZDIxNTMxZTY3ZmFlMGU5Yzk0MmY", "commit": {"author": {"name": "Kyle Huey", "email": "khuey@kylehuey.com", "date": "2022-03-22T19:38:59Z"}, "committer": {"name": "Kyle Huey", "email": "khuey@kylehuey.com", "date": "2022-03-22T19:38:59Z"}, "message": "Preserve order when grouping references.", "tree": {"sha": "fea9c9a09d0c437b2aaf0ab2254bcee930b171f3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fea9c9a09d0c437b2aaf0ab2254bcee930b171f3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/af1aa86ac0df3470b379d21531e67fae0e9c942f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/af1aa86ac0df3470b379d21531e67fae0e9c942f", "html_url": "https://github.com/rust-lang/rust/commit/af1aa86ac0df3470b379d21531e67fae0e9c942f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/af1aa86ac0df3470b379d21531e67fae0e9c942f/comments", "author": {"login": "khuey", "id": 325892, "node_id": "MDQ6VXNlcjMyNTg5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/325892?v=4", "gravatar_id": "", "url": "https://api.github.com/users/khuey", "html_url": "https://github.com/khuey", "followers_url": "https://api.github.com/users/khuey/followers", "following_url": "https://api.github.com/users/khuey/following{/other_user}", "gists_url": "https://api.github.com/users/khuey/gists{/gist_id}", "starred_url": "https://api.github.com/users/khuey/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/khuey/subscriptions", "organizations_url": "https://api.github.com/users/khuey/orgs", "repos_url": "https://api.github.com/users/khuey/repos", "events_url": "https://api.github.com/users/khuey/events{/privacy}", "received_events_url": "https://api.github.com/users/khuey/received_events", "type": "User", "site_admin": false}, "committer": {"login": "khuey", "id": 325892, "node_id": "MDQ6VXNlcjMyNTg5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/325892?v=4", "gravatar_id": "", "url": "https://api.github.com/users/khuey", "html_url": "https://github.com/khuey", "followers_url": "https://api.github.com/users/khuey/followers", "following_url": "https://api.github.com/users/khuey/following{/other_user}", "gists_url": "https://api.github.com/users/khuey/gists{/gist_id}", "starred_url": "https://api.github.com/users/khuey/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/khuey/subscriptions", "organizations_url": "https://api.github.com/users/khuey/orgs", "repos_url": "https://api.github.com/users/khuey/repos", "events_url": "https://api.github.com/users/khuey/events{/privacy}", "received_events_url": "https://api.github.com/users/khuey/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "05839199190819bf835ba20442ecbc7b06471a8f", "url": "https://api.github.com/repos/rust-lang/rust/commits/05839199190819bf835ba20442ecbc7b06471a8f", "html_url": "https://github.com/rust-lang/rust/commit/05839199190819bf835ba20442ecbc7b06471a8f"}], "stats": {"total": 27, "additions": 16, "deletions": 11}, "files": [{"sha": "5e6d2869877e7f6747dd9a5a38b2e671d77aed22", "filename": "crates/rust-analyzer/src/cli/lsif.rs", "status": "modified", "additions": 16, "deletions": 11, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/af1aa86ac0df3470b379d21531e67fae0e9c942f/crates%2Frust-analyzer%2Fsrc%2Fcli%2Flsif.rs", "raw_url": "https://github.com/rust-lang/rust/raw/af1aa86ac0df3470b379d21531e67fae0e9c942f/crates%2Frust-analyzer%2Fsrc%2Fcli%2Flsif.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fcli%2Flsif.rs?ref=af1aa86ac0df3470b379d21531e67fae0e9c942f", "patch": "@@ -212,7 +212,7 @@ impl LsifManager<'_> {\n                 in_v: result_id.into(),\n                 out_v: result_set_id.into(),\n             }));\n-            let edges = token.references.iter().fold(\n+            let mut edges = token.references.iter().fold(\n                 HashMap::<_, Vec<lsp_types::NumberOrString>>::new(),\n                 |mut edges, x| {\n                     let entry =\n@@ -221,16 +221,21 @@ impl LsifManager<'_> {\n                     edges\n                 },\n             );\n-            for ((file_id, is_definition), vertices) in edges.into_iter() {\n-                self.add_edge(lsif::Edge::Item(lsif::Item {\n-                    document: (*self.file_map.get(&file_id).unwrap()).into(),\n-                    property: Some(if is_definition {\n-                        lsif::ItemKind::Definitions\n-                    } else {\n-                        lsif::ItemKind::References\n-                    }),\n-                    edge_data: lsif::EdgeDataMultiIn { in_vs: vertices, out_v: result_id.into() },\n-                }));\n+            for x in token.references {\n+                if let Some(vertices) = edges.remove(&(x.range.file_id, x.is_definition)) {\n+                    self.add_edge(lsif::Edge::Item(lsif::Item {\n+                        document: (*self.file_map.get(&x.range.file_id).unwrap()).into(),\n+                        property: Some(if x.is_definition {\n+                            lsif::ItemKind::Definitions\n+                        } else {\n+                            lsif::ItemKind::References\n+                        }),\n+                        edge_data: lsif::EdgeDataMultiIn {\n+                            in_vs: vertices,\n+                            out_v: result_id.into(),\n+                        },\n+                    }));\n+                }\n             }\n         }\n     }"}]}