{"sha": "8f736a40426bf0182b92637e9c221da12745a180", "node_id": "C_kwDOAAsO6NoAKDhmNzM2YTQwNDI2YmYwMTgyYjkyNjM3ZTljMjIxZGExMjc0NWExODA", "commit": {"author": {"name": "yukang", "email": "moorekang@gmail.com", "date": "2022-11-27T22:49:18Z"}, "committer": {"name": "yukang", "email": "moorekang@gmail.com", "date": "2023-02-09T02:38:55Z"}, "message": "fix #104961, Add parentheses properly for borrowing suggestion", "tree": {"sha": "fc48f300442f09f89dab3a1031816b986bc24ebb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fc48f300442f09f89dab3a1031816b986bc24ebb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8f736a40426bf0182b92637e9c221da12745a180", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8f736a40426bf0182b92637e9c221da12745a180", "html_url": "https://github.com/rust-lang/rust/commit/8f736a40426bf0182b92637e9c221da12745a180", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8f736a40426bf0182b92637e9c221da12745a180/comments", "author": {"login": "chenyukang", "id": 230646, "node_id": "MDQ6VXNlcjIzMDY0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/230646?v=4", "gravatar_id": "", "url": "https://api.github.com/users/chenyukang", "html_url": "https://github.com/chenyukang", "followers_url": "https://api.github.com/users/chenyukang/followers", "following_url": "https://api.github.com/users/chenyukang/following{/other_user}", "gists_url": "https://api.github.com/users/chenyukang/gists{/gist_id}", "starred_url": "https://api.github.com/users/chenyukang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/chenyukang/subscriptions", "organizations_url": "https://api.github.com/users/chenyukang/orgs", "repos_url": "https://api.github.com/users/chenyukang/repos", "events_url": "https://api.github.com/users/chenyukang/events{/privacy}", "received_events_url": "https://api.github.com/users/chenyukang/received_events", "type": "User", "site_admin": false}, "committer": {"login": "chenyukang", "id": 230646, "node_id": "MDQ6VXNlcjIzMDY0Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/230646?v=4", "gravatar_id": "", "url": "https://api.github.com/users/chenyukang", "html_url": "https://github.com/chenyukang", "followers_url": "https://api.github.com/users/chenyukang/followers", "following_url": "https://api.github.com/users/chenyukang/following{/other_user}", "gists_url": "https://api.github.com/users/chenyukang/gists{/gist_id}", "starred_url": "https://api.github.com/users/chenyukang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/chenyukang/subscriptions", "organizations_url": "https://api.github.com/users/chenyukang/orgs", "repos_url": "https://api.github.com/users/chenyukang/repos", "events_url": "https://api.github.com/users/chenyukang/events{/privacy}", "received_events_url": "https://api.github.com/users/chenyukang/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a00e24d76a9ac03b146d3bf89e2161b2466c6551", "url": "https://api.github.com/repos/rust-lang/rust/commits/a00e24d76a9ac03b146d3bf89e2161b2466c6551", "html_url": "https://github.com/rust-lang/rust/commit/a00e24d76a9ac03b146d3bf89e2161b2466c6551"}], "stats": {"total": 111, "additions": 104, "deletions": 7}, "files": [{"sha": "8ece53dd05cba501d90066a7d1d356aaf15a6a7e", "filename": "compiler/rustc_trait_selection/src/traits/error_reporting/suggestions.rs", "status": "modified", "additions": 35, "deletions": 7, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/8f736a40426bf0182b92637e9c221da12745a180/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8f736a40426bf0182b92637e9c221da12745a180/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs?ref=8f736a40426bf0182b92637e9c221da12745a180", "patch": "@@ -19,6 +19,7 @@ use rustc_hir as hir;\n use rustc_hir::def::DefKind;\n use rustc_hir::def_id::DefId;\n use rustc_hir::intravisit::Visitor;\n+use rustc_hir::is_range_literal;\n use rustc_hir::lang_items::LangItem;\n use rustc_hir::{AsyncGeneratorKind, GeneratorKind, Node};\n use rustc_hir::{Expr, HirId};\n@@ -1350,14 +1351,41 @@ impl<'tcx> TypeErrCtxtExt<'tcx> for TypeErrCtxt<'_, 'tcx> {\n                             Applicability::MaybeIncorrect,\n                         );\n                     } else {\n+                        // Issue #104961, we need to add parentheses properly for compond expressions\n+                        // for example, `x.starts_with(\"hi\".to_string() + \"you\")`\n+                        // should be `x.starts_with(&(\"hi\".to_string() + \"you\"))`\n+                        let Some(body_id) = self.tcx.hir().maybe_body_owned_by(obligation.cause.body_id) else { return false; };\n+                        let body = self.tcx.hir().body(body_id);\n+                        let mut expr_finder = FindExprBySpan::new(span);\n+                        expr_finder.visit_expr(body.value);\n+                        let Some(expr) = expr_finder.result else { return false; };\n+                        let needs_parens = match expr.kind {\n+                            // parenthesize if needed (Issue #46756)\n+                            hir::ExprKind::Cast(_, _) | hir::ExprKind::Binary(_, _, _) => true,\n+                            // parenthesize borrows of range literals (Issue #54505)\n+                            _ if is_range_literal(expr) => true,\n+                            _ => false,\n+                        };\n+\n                         let is_mut = mut_ref_self_ty_satisfies_pred || ref_inner_ty_mut;\n-                        err.span_suggestion_verbose(\n-                            span.shrink_to_lo(),\n-                            &format!(\n-                                \"consider{} borrowing here\",\n-                                if is_mut { \" mutably\" } else { \"\" }\n-                            ),\n-                            format!(\"&{}\", if is_mut { \"mut \" } else { \"\" }),\n+                        let span = if needs_parens { span } else { span.shrink_to_lo() };\n+                        let sugg_prefix = format!(\"&{}\", if is_mut { \"mut \" } else { \"\" });\n+                        let sugg_msg = &format!(\n+                            \"consider{} borrowing here\",\n+                            if is_mut { \" mutably\" } else { \"\" }\n+                        );\n+\n+                        let suggestions = if !needs_parens {\n+                            vec![(span.shrink_to_lo(), format!(\"{}\", sugg_prefix))]\n+                        } else {\n+                            vec![\n+                                (span.shrink_to_lo(), format!(\"{}(\", sugg_prefix)),\n+                                (span.shrink_to_hi(), \")\".to_string()),\n+                            ]\n+                        };\n+                        err.multipart_suggestion_verbose(\n+                            sugg_msg,\n+                            suggestions,\n                             Applicability::MaybeIncorrect,\n                         );\n                     }"}, {"sha": "520d638b1748f1c4b51fb0a0e998e8c31ae9f672", "filename": "tests/ui/suggestions/issue-104961.fixed", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/8f736a40426bf0182b92637e9c221da12745a180/tests%2Fui%2Fsuggestions%2Fissue-104961.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/8f736a40426bf0182b92637e9c221da12745a180/tests%2Fui%2Fsuggestions%2Fissue-104961.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fsuggestions%2Fissue-104961.fixed?ref=8f736a40426bf0182b92637e9c221da12745a180", "patch": "@@ -0,0 +1,16 @@\n+// run-rustfix\n+\n+fn foo(x: &str) -> bool {\n+    x.starts_with(&(\"hi\".to_string() + \" you\"))\n+    //~^ ERROR expected a `FnMut<(char,)>` closure, found `String`\n+}\n+\n+fn foo2(x: &str) -> bool {\n+    x.starts_with(&\"hi\".to_string())\n+    //~^ ERROR expected a `FnMut<(char,)>` closure, found `String`\n+}\n+\n+fn main() {\n+    foo(\"hi you\");\n+    foo2(\"hi\");\n+}"}, {"sha": "aeb787abb6fc8779515121fd297f747198869cc4", "filename": "tests/ui/suggestions/issue-104961.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/8f736a40426bf0182b92637e9c221da12745a180/tests%2Fui%2Fsuggestions%2Fissue-104961.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8f736a40426bf0182b92637e9c221da12745a180/tests%2Fui%2Fsuggestions%2Fissue-104961.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fsuggestions%2Fissue-104961.rs?ref=8f736a40426bf0182b92637e9c221da12745a180", "patch": "@@ -0,0 +1,16 @@\n+// run-rustfix\n+\n+fn foo(x: &str) -> bool {\n+    x.starts_with(\"hi\".to_string() + \" you\")\n+    //~^ ERROR expected a `FnMut<(char,)>` closure, found `String`\n+}\n+\n+fn foo2(x: &str) -> bool {\n+    x.starts_with(\"hi\".to_string())\n+    //~^ ERROR expected a `FnMut<(char,)>` closure, found `String`\n+}\n+\n+fn main() {\n+    foo(\"hi you\");\n+    foo2(\"hi\");\n+}"}, {"sha": "8cec6a3f8270a6f1bd16da3b3c999e2ddf9123bd", "filename": "tests/ui/suggestions/issue-104961.stderr", "status": "added", "additions": 37, "deletions": 0, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/8f736a40426bf0182b92637e9c221da12745a180/tests%2Fui%2Fsuggestions%2Fissue-104961.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/8f736a40426bf0182b92637e9c221da12745a180/tests%2Fui%2Fsuggestions%2Fissue-104961.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fsuggestions%2Fissue-104961.stderr?ref=8f736a40426bf0182b92637e9c221da12745a180", "patch": "@@ -0,0 +1,37 @@\n+error[E0277]: expected a `FnMut<(char,)>` closure, found `String`\n+  --> $DIR/issue-104961.rs:4:19\n+   |\n+LL |     x.starts_with(\"hi\".to_string() + \" you\")\n+   |       ----------- ^^^^^^^^^^^^^^^^^^^^^^^^^ the trait `Pattern<'_>` is not implemented for `String`\n+   |       |\n+   |       required by a bound introduced by this call\n+   |\n+   = note: the trait bound `String: Pattern<'_>` is not satisfied\n+   = note: required for `String` to implement `Pattern<'_>`\n+note: required by a bound in `core::str::<impl str>::starts_with`\n+  --> $SRC_DIR/core/src/str/mod.rs:LL:COL\n+help: consider borrowing here\n+   |\n+LL |     x.starts_with(&(\"hi\".to_string() + \" you\"))\n+   |                   ++                         +\n+\n+error[E0277]: expected a `FnMut<(char,)>` closure, found `String`\n+  --> $DIR/issue-104961.rs:9:19\n+   |\n+LL |     x.starts_with(\"hi\".to_string())\n+   |       ----------- ^^^^^^^^^^^^^^^^ the trait `Pattern<'_>` is not implemented for `String`\n+   |       |\n+   |       required by a bound introduced by this call\n+   |\n+   = note: the trait bound `String: Pattern<'_>` is not satisfied\n+   = note: required for `String` to implement `Pattern<'_>`\n+note: required by a bound in `core::str::<impl str>::starts_with`\n+  --> $SRC_DIR/core/src/str/mod.rs:LL:COL\n+help: consider borrowing here\n+   |\n+LL |     x.starts_with(&\"hi\".to_string())\n+   |                   +\n+\n+error: aborting due to 2 previous errors\n+\n+For more information about this error, try `rustc --explain E0277`."}]}