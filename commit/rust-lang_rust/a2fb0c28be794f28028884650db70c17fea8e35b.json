{"sha": "a2fb0c28be794f28028884650db70c17fea8e35b", "node_id": "MDY6Q29tbWl0NzI0NzEyOmEyZmIwYzI4YmU3OTRmMjgwMjg4ODQ2NTBkYjcwYzE3ZmVhOGUzNWI=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-02-19T01:36:31Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-02-19T01:36:31Z"}, "message": "Auto merge of #69241 - shahn:checked_add_revert, r=Mark-Simulacrum,lqd\n\nRevert \"Remove `checked_add` in `Layout::repeat`\"\n\nThis fixes a a segfault in safe code, a stable regression. Reported in #69225.\n\nThis reverts commit a983e0590a43ed8b0f60417828efd4e79b51f494.", "tree": {"sha": "1b8698110e2a1c02b9f38f8fd213f79dc6cc7561", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1b8698110e2a1c02b9f38f8fd213f79dc6cc7561"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a2fb0c28be794f28028884650db70c17fea8e35b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a2fb0c28be794f28028884650db70c17fea8e35b", "html_url": "https://github.com/rust-lang/rust/commit/a2fb0c28be794f28028884650db70c17fea8e35b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a2fb0c28be794f28028884650db70c17fea8e35b/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e0e5d82e1677c82d209b214bbfc2cc5705c2336a", "url": "https://api.github.com/repos/rust-lang/rust/commits/e0e5d82e1677c82d209b214bbfc2cc5705c2336a", "html_url": "https://github.com/rust-lang/rust/commit/e0e5d82e1677c82d209b214bbfc2cc5705c2336a"}, {"sha": "3e17d191fa47b9ab262d0efa3a39e500e9fb1667", "url": "https://api.github.com/repos/rust-lang/rust/commits/3e17d191fa47b9ab262d0efa3a39e500e9fb1667", "html_url": "https://github.com/rust-lang/rust/commit/3e17d191fa47b9ab262d0efa3a39e500e9fb1667"}], "stats": {"total": 43, "additions": 38, "deletions": 5}, "files": [{"sha": "a04e75bc7ce7c6d32ab0644ffba781203006b11b", "filename": "src/libcore/alloc.rs", "status": "modified", "additions": 7, "deletions": 5, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/a2fb0c28be794f28028884650db70c17fea8e35b/src%2Flibcore%2Falloc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a2fb0c28be794f28028884650db70c17fea8e35b/src%2Flibcore%2Falloc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Falloc.rs?ref=a2fb0c28be794f28028884650db70c17fea8e35b", "patch": "@@ -241,11 +241,13 @@ impl Layout {\n     #[unstable(feature = \"alloc_layout_extra\", issue = \"55724\")]\n     #[inline]\n     pub fn repeat(&self, n: usize) -> Result<(Self, usize), LayoutErr> {\n-        // This cannot overflow. Quoting from the invariant of Layout:\n-        // > `size`, when rounded up to the nearest multiple of `align`,\n-        // > must not overflow (i.e., the rounded value must be less than\n-        // > `usize::MAX`)\n-        let padded_size = self.size() + self.padding_needed_for(self.align());\n+        // Warning, removing the checked_add here led to segfaults in #67174. Further\n+        // analysis in #69225 seems to indicate that this is an LTO-related\n+        // miscompilation, so #67174 might be able to be reapplied in the future.\n+        let padded_size = self\n+            .size()\n+            .checked_add(self.padding_needed_for(self.align()))\n+            .ok_or(LayoutErr { private: () })?;\n         let alloc_size = padded_size.checked_mul(n).ok_or(LayoutErr { private: () })?;\n \n         unsafe {"}, {"sha": "7f43e4d1a51f8ad2320bee28f66a0685ca15d9c4", "filename": "src/test/ui/issues/issue-69225-layout-repeated-checked-add.rs", "status": "added", "additions": 31, "deletions": 0, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/a2fb0c28be794f28028884650db70c17fea8e35b/src%2Ftest%2Fui%2Fissues%2Fissue-69225-layout-repeated-checked-add.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a2fb0c28be794f28028884650db70c17fea8e35b/src%2Ftest%2Fui%2Fissues%2Fissue-69225-layout-repeated-checked-add.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-69225-layout-repeated-checked-add.rs?ref=a2fb0c28be794f28028884650db70c17fea8e35b", "patch": "@@ -0,0 +1,31 @@\n+// Ensure we appropriately error instead of overflowing a calculation when creating a new Alloc\n+// Layout\n+\n+// run-fail\n+// compile-flags: -C opt-level=3\n+// error-pattern: index out of bounds: the len is 0 but the index is 16777216\n+// ignore-wasm no panic or subprocess support\n+// ignore-emscripten no panic or subprocess support\n+\n+fn do_test(x: usize) {\n+    let arr = vec![vec![0u8; 3]];\n+\n+    let mut z = Vec::new();\n+    for arr_ref in arr {\n+        for y in 0..x {\n+            for _ in 0..1 {\n+                z.extend(std::iter::repeat(0).take(x));\n+                let a = y * x;\n+                let b = (y + 1) * x - 1;\n+                let slice = &arr_ref[a..b];\n+                eprintln!(\"{} {} {} {}\", a, b, arr_ref.len(), slice.len());\n+                eprintln!(\"{:?}\", slice[1 << 24]);\n+            }\n+        }\n+    }\n+}\n+\n+fn main() {\n+    do_test(1);\n+    do_test(2);\n+}"}]}