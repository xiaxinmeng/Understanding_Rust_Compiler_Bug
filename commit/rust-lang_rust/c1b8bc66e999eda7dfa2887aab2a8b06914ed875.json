{"sha": "c1b8bc66e999eda7dfa2887aab2a8b06914ed875", "node_id": "C_kwDOAAsO6NoAKGMxYjhiYzY2ZTk5OWVkYTdkZmEyODg3YWFiMmE4YjA2OTE0ZWQ4NzU", "commit": {"author": {"name": "Jason Newcomb", "email": "jsnewcomb@pm.me", "date": "2022-11-30T17:31:38Z"}, "committer": {"name": "Jason Newcomb", "email": "jsnewcomb@pm.me", "date": "2022-11-30T17:46:06Z"}, "message": "Fix ICE in `unused_rounding`", "tree": {"sha": "bd575d99970c2b5689ebe48c308da48fe33c0bd1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bd575d99970c2b5689ebe48c308da48fe33c0bd1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c1b8bc66e999eda7dfa2887aab2a8b06914ed875", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c1b8bc66e999eda7dfa2887aab2a8b06914ed875", "html_url": "https://github.com/rust-lang/rust/commit/c1b8bc66e999eda7dfa2887aab2a8b06914ed875", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c1b8bc66e999eda7dfa2887aab2a8b06914ed875/comments", "author": {"login": "Jarcho", "id": 7761774, "node_id": "MDQ6VXNlcjc3NjE3NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/7761774?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Jarcho", "html_url": "https://github.com/Jarcho", "followers_url": "https://api.github.com/users/Jarcho/followers", "following_url": "https://api.github.com/users/Jarcho/following{/other_user}", "gists_url": "https://api.github.com/users/Jarcho/gists{/gist_id}", "starred_url": "https://api.github.com/users/Jarcho/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Jarcho/subscriptions", "organizations_url": "https://api.github.com/users/Jarcho/orgs", "repos_url": "https://api.github.com/users/Jarcho/repos", "events_url": "https://api.github.com/users/Jarcho/events{/privacy}", "received_events_url": "https://api.github.com/users/Jarcho/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Jarcho", "id": 7761774, "node_id": "MDQ6VXNlcjc3NjE3NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/7761774?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Jarcho", "html_url": "https://github.com/Jarcho", "followers_url": "https://api.github.com/users/Jarcho/followers", "following_url": "https://api.github.com/users/Jarcho/following{/other_user}", "gists_url": "https://api.github.com/users/Jarcho/gists{/gist_id}", "starred_url": "https://api.github.com/users/Jarcho/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Jarcho/subscriptions", "organizations_url": "https://api.github.com/users/Jarcho/orgs", "repos_url": "https://api.github.com/users/Jarcho/repos", "events_url": "https://api.github.com/users/Jarcho/events{/privacy}", "received_events_url": "https://api.github.com/users/Jarcho/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "78589ffad2c973f7863fdabc2df6e8ab2b54110f", "url": "https://api.github.com/repos/rust-lang/rust/commits/78589ffad2c973f7863fdabc2df6e8ab2b54110f", "html_url": "https://github.com/rust-lang/rust/commit/78589ffad2c973f7863fdabc2df6e8ab2b54110f"}], "stats": {"total": 35, "additions": 21, "deletions": 14}, "files": [{"sha": "097568cd1f70037921ee4f5c6b2bc601a8aacee5", "filename": "clippy_lints/src/unused_rounding.rs", "status": "modified", "additions": 8, "deletions": 13, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/c1b8bc66e999eda7dfa2887aab2a8b06914ed875/clippy_lints%2Fsrc%2Funused_rounding.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c1b8bc66e999eda7dfa2887aab2a8b06914ed875/clippy_lints%2Fsrc%2Funused_rounding.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Funused_rounding.rs?ref=c1b8bc66e999eda7dfa2887aab2a8b06914ed875", "patch": "@@ -1,4 +1,5 @@\n use clippy_utils::diagnostics::span_lint_and_sugg;\n+use clippy_utils::source::snippet;\n use rustc_ast::ast::{Expr, ExprKind, MethodCall};\n use rustc_errors::Applicability;\n use rustc_lint::{EarlyContext, EarlyLintPass};\n@@ -29,30 +30,24 @@ declare_clippy_lint! {\n }\n declare_lint_pass!(UnusedRounding => [UNUSED_ROUNDING]);\n \n-fn is_useless_rounding(expr: &Expr) -> Option<(&str, String)> {\n+fn is_useless_rounding<'a>(cx: &EarlyContext<'_>, expr: &'a Expr) -> Option<(&'a str, String)> {\n     if let ExprKind::MethodCall(box MethodCall { seg:name_ident, receiver, .. }) = &expr.kind\n         && let method_name = name_ident.ident.name.as_str()\n         && (method_name == \"ceil\" || method_name == \"round\" || method_name == \"floor\")\n         && let ExprKind::Lit(token_lit) = &receiver.kind\n-        && token_lit.is_semantic_float() {\n-            let mut f_str = token_lit.symbol.to_string();\n-            let f = f_str.trim_end_matches('_').parse::<f64>().unwrap();\n-            if let Some(suffix) = token_lit.suffix {\n-                f_str.push_str(suffix.as_str());\n-            }\n-            if f.fract() == 0.0 {\n-                Some((method_name, f_str))\n-            } else {\n-                None\n-            }\n+        && token_lit.is_semantic_float()\n+        && let Ok(f) = token_lit.symbol.as_str().replace('_', \"\").parse::<f64>() {\n+            (f.fract() == 0.0).then(||\n+                (method_name, snippet(cx, receiver.span, \"..\").to_string())\n+            )\n         } else {\n             None\n         }\n }\n \n impl EarlyLintPass for UnusedRounding {\n     fn check_expr(&mut self, cx: &EarlyContext<'_>, expr: &Expr) {\n-        if let Some((method_name, float)) = is_useless_rounding(expr) {\n+        if let Some((method_name, float)) = is_useless_rounding(cx, expr) {\n             span_lint_and_sugg(\n                 cx,\n                 UNUSED_ROUNDING,"}, {"sha": "f6f734c05ed59e95c06401d13f7faa393c4a9051", "filename": "tests/ui/unused_rounding.fixed", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/c1b8bc66e999eda7dfa2887aab2a8b06914ed875/tests%2Fui%2Funused_rounding.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/c1b8bc66e999eda7dfa2887aab2a8b06914ed875/tests%2Fui%2Funused_rounding.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Funused_rounding.fixed?ref=c1b8bc66e999eda7dfa2887aab2a8b06914ed875", "patch": "@@ -11,4 +11,7 @@ fn main() {\n     let _ = 3.3_f32.round();\n     let _ = 3.3_f64.round();\n     let _ = 3.0_f32;\n+\n+    let _ = 3_3.0_0_f32;\n+    let _ = 3_3.0_1_f64.round();\n }"}, {"sha": "a0267d8144aabb45c462280e45bb29f46ed81d03", "filename": "tests/ui/unused_rounding.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/c1b8bc66e999eda7dfa2887aab2a8b06914ed875/tests%2Fui%2Funused_rounding.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c1b8bc66e999eda7dfa2887aab2a8b06914ed875/tests%2Fui%2Funused_rounding.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Funused_rounding.rs?ref=c1b8bc66e999eda7dfa2887aab2a8b06914ed875", "patch": "@@ -11,4 +11,7 @@ fn main() {\n     let _ = 3.3_f32.round();\n     let _ = 3.3_f64.round();\n     let _ = 3.0_f32.round();\n+\n+    let _ = 3_3.0_0_f32.round();\n+    let _ = 3_3.0_1_f64.round();\n }"}, {"sha": "b867996fe5763c826e375a948796bf45e9bd0b0b", "filename": "tests/ui/unused_rounding.stderr", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/c1b8bc66e999eda7dfa2887aab2a8b06914ed875/tests%2Fui%2Funused_rounding.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c1b8bc66e999eda7dfa2887aab2a8b06914ed875/tests%2Fui%2Funused_rounding.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Funused_rounding.stderr?ref=c1b8bc66e999eda7dfa2887aab2a8b06914ed875", "patch": "@@ -24,5 +24,11 @@ error: used the `round` method with a whole number float\n LL |     let _ = 3.0_f32.round();\n    |             ^^^^^^^^^^^^^^^ help: remove the `round` method call: `3.0_f32`\n \n-error: aborting due to 4 previous errors\n+error: used the `round` method with a whole number float\n+  --> $DIR/unused_rounding.rs:15:13\n+   |\n+LL |     let _ = 3_3.0_0_f32.round();\n+   |             ^^^^^^^^^^^^^^^^^^^ help: remove the `round` method call: `3_3.0_0_f32`\n+\n+error: aborting due to 5 previous errors\n "}]}