{"sha": "e22aa029fb4d923dc03748b435abd6330933b473", "node_id": "MDY6Q29tbWl0NzI0NzEyOmUyMmFhMDI5ZmI0ZDkyM2RjMDM3NDhiNDM1YWJkNjMzMDkzM2I0NzM=", "commit": {"author": {"name": "Tim Chevalier", "email": "chevalier@alum.wellesley.edu", "date": "2013-01-29T23:06:05Z"}, "committer": {"name": "Tim Chevalier", "email": "chevalier@alum.wellesley.edu", "date": "2013-02-04T23:18:53Z"}, "message": "core/syntax: Add transitional code for pipes", "tree": {"sha": "eb1dfcaaadd8ec5439fd0b51c0b755c8fd4009e1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/eb1dfcaaadd8ec5439fd0b51c0b755c8fd4009e1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e22aa029fb4d923dc03748b435abd6330933b473", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e22aa029fb4d923dc03748b435abd6330933b473", "html_url": "https://github.com/rust-lang/rust/commit/e22aa029fb4d923dc03748b435abd6330933b473", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e22aa029fb4d923dc03748b435abd6330933b473/comments", "author": {"login": "catamorphism", "id": 427212, "node_id": "MDQ6VXNlcjQyNzIxMg==", "avatar_url": "https://avatars.githubusercontent.com/u/427212?v=4", "gravatar_id": "", "url": "https://api.github.com/users/catamorphism", "html_url": "https://github.com/catamorphism", "followers_url": "https://api.github.com/users/catamorphism/followers", "following_url": "https://api.github.com/users/catamorphism/following{/other_user}", "gists_url": "https://api.github.com/users/catamorphism/gists{/gist_id}", "starred_url": "https://api.github.com/users/catamorphism/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/catamorphism/subscriptions", "organizations_url": "https://api.github.com/users/catamorphism/orgs", "repos_url": "https://api.github.com/users/catamorphism/repos", "events_url": "https://api.github.com/users/catamorphism/events{/privacy}", "received_events_url": "https://api.github.com/users/catamorphism/received_events", "type": "User", "site_admin": false}, "committer": {"login": "catamorphism", "id": 427212, "node_id": "MDQ6VXNlcjQyNzIxMg==", "avatar_url": "https://avatars.githubusercontent.com/u/427212?v=4", "gravatar_id": "", "url": "https://api.github.com/users/catamorphism", "html_url": "https://github.com/catamorphism", "followers_url": "https://api.github.com/users/catamorphism/followers", "following_url": "https://api.github.com/users/catamorphism/following{/other_user}", "gists_url": "https://api.github.com/users/catamorphism/gists{/gist_id}", "starred_url": "https://api.github.com/users/catamorphism/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/catamorphism/subscriptions", "organizations_url": "https://api.github.com/users/catamorphism/orgs", "repos_url": "https://api.github.com/users/catamorphism/repos", "events_url": "https://api.github.com/users/catamorphism/events{/privacy}", "received_events_url": "https://api.github.com/users/catamorphism/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e08a805b306398b316a489f76960569ac19b25b2", "url": "https://api.github.com/repos/rust-lang/rust/commits/e08a805b306398b316a489f76960569ac19b25b2", "html_url": "https://github.com/rust-lang/rust/commit/e08a805b306398b316a489f76960569ac19b25b2"}], "stats": {"total": 53, "additions": 44, "deletions": 9}, "files": [{"sha": "3e941da12478ae49d8f5f02384afa225ed94df5a", "filename": "src/libcore/pipes.rs", "status": "modified", "additions": 16, "deletions": 9, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/e22aa029fb4d923dc03748b435abd6330933b473/src%2Flibcore%2Fpipes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e22aa029fb4d923dc03748b435abd6330933b473/src%2Flibcore%2Fpipes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fpipes.rs?ref=e22aa029fb4d923dc03748b435abd6330933b473", "patch": "@@ -143,14 +143,9 @@ pub fn BufferHeader() -> BufferHeader {\n // This is for protocols to associate extra data to thread around.\n #[doc(hidden)]\n #[cfg(stage0)]\n-type Buffer<T: Owned> = {\n-    header: BufferHeader,\n-    data: T,\n-};\n-#[doc(hidden)]\n #[cfg(stage1)]\n+type Buffer<T> = { header: BufferHeader, data: T };\n #[cfg(stage2)]\n-#[cfg(stage3)]\n pub struct Buffer<T> {\n     header: BufferHeader,\n     data: T,\n@@ -247,7 +242,6 @@ pub fn mk_packet<T: Owned>() -> Packet<T> {\n         payload: None,\n     }\n }\n-\n #[doc(hidden)]\n #[cfg(stage0)]\n fn unibuffer<T: Owned>() -> ~Buffer<Packet<T>> {\n@@ -264,10 +258,23 @@ fn unibuffer<T: Owned>() -> ~Buffer<Packet<T>> {\n     }\n     move b\n }\n-#[doc(hidden)]\n #[cfg(stage1)]\n+fn unibuffer<T>() -> ~Buffer<Packet<T>> {\n+    let b = ~{\n+        header: BufferHeader(),\n+        data: Packet {\n+            header: PacketHeader(),\n+            payload: None,\n+        }\n+    };\n+\n+    unsafe {\n+        b.data.header.buffer = reinterpret_cast(&b);\n+    }\n+    move b\n+}\n+#[doc(hidden)]\n #[cfg(stage2)]\n-#[cfg(stage3)]\n fn unibuffer<T>() -> ~Buffer<Packet<T>> {\n     let b = ~Buffer {\n         header: BufferHeader(),"}, {"sha": "4bf59d9c627ad32ddd6edfe7f1675faca78e00bf", "filename": "src/libsyntax/ext/pipes/pipec.rs", "status": "modified", "additions": 28, "deletions": 0, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/e22aa029fb4d923dc03748b435abd6330933b473/src%2Flibsyntax%2Fext%2Fpipes%2Fpipec.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e22aa029fb4d923dc03748b435abd6330933b473/src%2Flibsyntax%2Fext%2Fpipes%2Fpipec.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fpipes%2Fpipec.rs?ref=e22aa029fb4d923dc03748b435abd6330933b473", "patch": "@@ -355,6 +355,34 @@ pub impl protocol: gen_init {\n         }))\n     }\n \n+    #[cfg(stage0)]\n+    fn gen_init_bounded(ext_cx: ext_ctxt) -> @ast::expr {\n+        debug!(\"gen_init_bounded\");\n+        let buffer_fields = self.gen_buffer_init(ext_cx);\n+        let buffer = quote_expr!(~{\n+            header: ::pipes::BufferHeader(),\n+            data: $buffer_fields,\n+        });\n+\n+        let entangle_body = ext_cx.block_expr(\n+            ext_cx.block(\n+                self.states.map_to_vec(\n+                    |s| ext_cx.parse_stmt(\n+                        fmt!(\"data.%s.set_buffer_(buffer)\",\n+                             s.name))),\n+                ext_cx.parse_expr(\n+                    fmt!(\"::ptr::addr_of(&(data.%s))\",\n+                         self.states[0].name))));\n+\n+        quote_expr!({\n+            let buffer = $buffer;\n+            do ::pipes::entangle_buffer(move buffer) |buffer, data| {\n+                $entangle_body\n+            }\n+        })\n+    }\n+    #[cfg(stage1)]\n+    #[cfg(stage2)]\n     fn gen_init_bounded(ext_cx: ext_ctxt) -> @ast::expr {\n         debug!(\"gen_init_bounded\");\n         let buffer_fields = self.gen_buffer_init(ext_cx);"}]}