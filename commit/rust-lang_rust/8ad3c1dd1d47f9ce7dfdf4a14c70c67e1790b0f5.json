{"sha": "8ad3c1dd1d47f9ce7dfdf4a14c70c67e1790b0f5", "node_id": "C_kwDOAAsO6NoAKDhhZDNjMWRkMWQ0N2Y5Y2U3ZGZkZjRhMTRjNzBjNjdlMTc5MGIwZjU", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-12-21T12:49:10Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-12-21T12:49:10Z"}, "message": "Auto merge of #92149 - fee1-dead:cache-fix, r=oli-obk\n\nFix bad caching of `~const Drop` bounds\n\nFixes #92111.", "tree": {"sha": "0a6fcdb67f780315e0b94d97ec5ec48d6ac1953a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0a6fcdb67f780315e0b94d97ec5ec48d6ac1953a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8ad3c1dd1d47f9ce7dfdf4a14c70c67e1790b0f5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8ad3c1dd1d47f9ce7dfdf4a14c70c67e1790b0f5", "html_url": "https://github.com/rust-lang/rust/commit/8ad3c1dd1d47f9ce7dfdf4a14c70c67e1790b0f5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8ad3c1dd1d47f9ce7dfdf4a14c70c67e1790b0f5/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3d57c61a9e04dcd3df633f41142009d6dcad4399", "url": "https://api.github.com/repos/rust-lang/rust/commits/3d57c61a9e04dcd3df633f41142009d6dcad4399", "html_url": "https://github.com/rust-lang/rust/commit/3d57c61a9e04dcd3df633f41142009d6dcad4399"}, {"sha": "aaaad5b46bd90047fce43672d7848c6c75ceea35", "url": "https://api.github.com/repos/rust-lang/rust/commits/aaaad5b46bd90047fce43672d7848c6c75ceea35", "html_url": "https://github.com/rust-lang/rust/commit/aaaad5b46bd90047fce43672d7848c6c75ceea35"}], "stats": {"total": 44, "additions": 41, "deletions": 3}, "files": [{"sha": "37d99766da9d244af6345dab9ecd3ea08edab14e", "filename": "compiler/rustc_middle/src/ty/mod.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/8ad3c1dd1d47f9ce7dfdf4a14c70c67e1790b0f5/compiler%2Frustc_middle%2Fsrc%2Fty%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8ad3c1dd1d47f9ce7dfdf4a14c70c67e1790b0f5/compiler%2Frustc_middle%2Fsrc%2Fty%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fmod.rs?ref=8ad3c1dd1d47f9ce7dfdf4a14c70c67e1790b0f5", "patch": "@@ -734,6 +734,15 @@ pub struct TraitPredicate<'tcx> {\n pub type PolyTraitPredicate<'tcx> = ty::Binder<'tcx, TraitPredicate<'tcx>>;\n \n impl<'tcx> TraitPredicate<'tcx> {\n+    pub fn remap_constness(&mut self, tcx: TyCtxt<'tcx>, param_env: &mut ParamEnv<'tcx>) {\n+        if unlikely!(Some(self.trait_ref.def_id) == tcx.lang_items().drop_trait()) {\n+            // remap without changing constness of this predicate.\n+            // this is because `T: ~const Drop` has a different meaning to `T: Drop`\n+            param_env.remap_constness_with(self.constness)\n+        } else {\n+            *param_env = param_env.with_constness(self.constness.and(param_env.constness()))\n+        }\n+    }\n     pub fn def_id(self) -> DefId {\n         self.trait_ref.def_id\n     }"}, {"sha": "fa88c8ee37015f6db0e08f86c37141d16246f0b4", "filename": "compiler/rustc_trait_selection/src/traits/select/mod.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/8ad3c1dd1d47f9ce7dfdf4a14c70c67e1790b0f5/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8ad3c1dd1d47f9ce7dfdf4a14c70c67e1790b0f5/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fmod.rs?ref=8ad3c1dd1d47f9ce7dfdf4a14c70c67e1790b0f5", "patch": "@@ -730,7 +730,7 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n         let mut param_env = obligation.param_env;\n \n         fresh_trait_pred = fresh_trait_pred.map_bound(|mut pred| {\n-            param_env = param_env.with_constness(pred.constness.and(param_env.constness()));\n+            pred.remap_constness(self.tcx(), &mut param_env);\n             pred\n         });\n \n@@ -1269,7 +1269,7 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n         }\n         let tcx = self.tcx();\n         let mut pred = cache_fresh_trait_pred.skip_binder();\n-        param_env = param_env.with_constness(pred.constness.and(param_env.constness()));\n+        pred.remap_constness(tcx, &mut param_env);\n \n         if self.can_use_global_caches(param_env) {\n             if let Some(res) = tcx.selection_cache.get(&param_env.and(pred), tcx) {\n@@ -1322,7 +1322,7 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n         let tcx = self.tcx();\n         let mut pred = cache_fresh_trait_pred.skip_binder();\n \n-        param_env = param_env.with_constness(pred.constness.and(param_env.constness()));\n+        pred.remap_constness(tcx, &mut param_env);\n \n         if !self.can_cache_candidate(&candidate) {\n             debug!(?pred, ?candidate, \"insert_candidate_cache - candidate is not cacheable\");"}, {"sha": "d30f4edd4b25c982062efdaa5b9ba73da894af09", "filename": "src/test/ui/rfc-2632-const-trait-impl/issue-92111.rs", "status": "added", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/8ad3c1dd1d47f9ce7dfdf4a14c70c67e1790b0f5/src%2Ftest%2Fui%2Frfc-2632-const-trait-impl%2Fissue-92111.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8ad3c1dd1d47f9ce7dfdf4a14c70c67e1790b0f5/src%2Ftest%2Fui%2Frfc-2632-const-trait-impl%2Fissue-92111.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frfc-2632-const-trait-impl%2Fissue-92111.rs?ref=8ad3c1dd1d47f9ce7dfdf4a14c70c67e1790b0f5", "patch": "@@ -0,0 +1,29 @@\n+// Regression test for #92111.\n+//\n+// The issue was that we normalize trait bounds before caching\n+// results of selection. Checking that `impl NoDrop for S` requires\n+// checking `S: !Drop` because it cannot overlap with the blanket\n+// impl. Then we save the (unsatisfied) result from checking `S: Drop`.\n+// Then the call to `a` checks whether `S: ~const Drop` but we normalize\n+// it to `S: Drop` which the cache claims to be unsatisfied.\n+//\n+// check-pass\n+\n+#![feature(const_trait_impl)]\n+#![feature(const_fn_trait_bound)]\n+\n+pub trait Tr {}\n+\n+#[allow(drop_bounds)]\n+impl<T: Drop> Tr for T {}\n+\n+#[derive(Debug)]\n+pub struct S(i32);\n+\n+impl Tr for S {}\n+\n+const fn a<T: ~const Drop>(t: T) {}\n+\n+fn main() {\n+    a(S(0));\n+}"}]}