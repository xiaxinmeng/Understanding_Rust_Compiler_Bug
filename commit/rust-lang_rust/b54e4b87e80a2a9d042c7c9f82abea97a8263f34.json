{"sha": "b54e4b87e80a2a9d042c7c9f82abea97a8263f34", "node_id": "MDY6Q29tbWl0NzI0NzEyOmI1NGU0Yjg3ZTgwYTJhOWQwNDJjN2M5ZjgyYWJlYTk3YTgyNjNmMzQ=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-03-19T17:54:30Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-03-19T17:54:30Z"}, "message": "Merge #8109\n\n8109: Make ast editing more ergonomic r=matklad a=matklad\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>", "tree": {"sha": "f05ab4767b47b09e739b364dca2ac32641666f1c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f05ab4767b47b09e739b364dca2ac32641666f1c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b54e4b87e80a2a9d042c7c9f82abea97a8263f34", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgVOVWCRBK7hj4Ov3rIwAAdHIIAJJvQKoLSiC+iAAX0Sq/gIx3\n0SN1wv9PwtIopUK0H0osJWrVFsFBmx8ow862uswj3Mx2UxiN0gx5FmZqLJEBZOt5\n7L9QDC8T7SvlOfjOCJVyd4ZFJWGmXJxR4jWYSSjrVaDrtSThmnYD+a4yM8DW/gHS\n0iATOKGHiKCuNpARkMAUp+r9PwJUY7N/xSh823NhiT7E8fdgElDCCKJWJFC9B2IM\npzUUgotuh0q26B0l/AfxXHBXKaNizjPxHd9lyx1rIYfTy5bovclOt2cylFmArZn1\nMydgjxRFmIpDTiV9051ZUF+DSzz4FJYeTDmPWAC2Wr1Rx5U2yO/mI2TMireNbxM=\n=85qF\n-----END PGP SIGNATURE-----\n", "payload": "tree f05ab4767b47b09e739b364dca2ac32641666f1c\nparent 2813afd0592957b327695e77fe75dd956700fd40\nparent a61691026a169a17f62de9de6ebab197faa7c703\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1616176470 +0000\ncommitter GitHub <noreply@github.com> 1616176470 +0000\n\nMerge #8109\n\n8109: Make ast editing more ergonomic r=matklad a=matklad\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b54e4b87e80a2a9d042c7c9f82abea97a8263f34", "html_url": "https://github.com/rust-lang/rust/commit/b54e4b87e80a2a9d042c7c9f82abea97a8263f34", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b54e4b87e80a2a9d042c7c9f82abea97a8263f34/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2813afd0592957b327695e77fe75dd956700fd40", "url": "https://api.github.com/repos/rust-lang/rust/commits/2813afd0592957b327695e77fe75dd956700fd40", "html_url": "https://github.com/rust-lang/rust/commit/2813afd0592957b327695e77fe75dd956700fd40"}, {"sha": "a61691026a169a17f62de9de6ebab197faa7c703", "url": "https://api.github.com/repos/rust-lang/rust/commits/a61691026a169a17f62de9de6ebab197faa7c703", "html_url": "https://github.com/rust-lang/rust/commit/a61691026a169a17f62de9de6ebab197faa7c703"}], "stats": {"total": 106, "additions": 66, "deletions": 40}, "files": [{"sha": "b1eed0a2ccabc3db8f0b97341f98eea050dc17ea", "filename": "crates/syntax/src/ast/edit_in_place.rs", "status": "modified", "additions": 20, "deletions": 21, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/b54e4b87e80a2a9d042c7c9f82abea97a8263f34/crates%2Fsyntax%2Fsrc%2Fast%2Fedit_in_place.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b54e4b87e80a2a9d042c7c9f82abea97a8263f34/crates%2Fsyntax%2Fsrc%2Fast%2Fedit_in_place.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fsyntax%2Fsrc%2Fast%2Fedit_in_place.rs?ref=b54e4b87e80a2a9d042c7c9f82abea97a8263f34", "patch": "@@ -8,7 +8,7 @@ use parser::T;\n use crate::{\n     ast,\n     ted::{self, Position},\n-    AstNode, Direction, SyntaxElement,\n+    AstNode, Direction,\n };\n \n use super::NameOwner;\n@@ -21,11 +21,11 @@ impl GenericParamsOwnerEdit for ast::Fn {\n     fn get_or_create_where_clause(&self) -> WhereClause {\n         if self.where_clause().is_none() {\n             let position = if let Some(ty) = self.ret_type() {\n-                Position::after(ty.syntax().clone())\n+                Position::after(ty.syntax())\n             } else if let Some(param_list) = self.param_list() {\n-                Position::after(param_list.syntax().clone())\n+                Position::after(param_list.syntax())\n             } else {\n-                Position::last_child_of(self.syntax().clone())\n+                Position::last_child_of(self.syntax())\n             };\n             create_where_clause(position)\n         }\n@@ -37,9 +37,9 @@ impl GenericParamsOwnerEdit for ast::Impl {\n     fn get_or_create_where_clause(&self) -> WhereClause {\n         if self.where_clause().is_none() {\n             let position = if let Some(items) = self.assoc_item_list() {\n-                Position::before(items.syntax().clone())\n+                Position::before(items.syntax())\n             } else {\n-                Position::last_child_of(self.syntax().clone())\n+                Position::last_child_of(self.syntax())\n             };\n             create_where_clause(position)\n         }\n@@ -51,9 +51,9 @@ impl GenericParamsOwnerEdit for ast::Trait {\n     fn get_or_create_where_clause(&self) -> WhereClause {\n         if self.where_clause().is_none() {\n             let position = if let Some(items) = self.assoc_item_list() {\n-                Position::before(items.syntax().clone())\n+                Position::before(items.syntax())\n             } else {\n-                Position::last_child_of(self.syntax().clone())\n+                Position::last_child_of(self.syntax())\n             };\n             create_where_clause(position)\n         }\n@@ -69,13 +69,13 @@ impl GenericParamsOwnerEdit for ast::Struct {\n                 ast::FieldList::TupleFieldList(it) => Some(it),\n             });\n             let position = if let Some(tfl) = tfl {\n-                Position::after(tfl.syntax().clone())\n+                Position::after(tfl.syntax())\n             } else if let Some(gpl) = self.generic_param_list() {\n-                Position::after(gpl.syntax().clone())\n+                Position::after(gpl.syntax())\n             } else if let Some(name) = self.name() {\n-                Position::after(name.syntax().clone())\n+                Position::after(name.syntax())\n             } else {\n-                Position::last_child_of(self.syntax().clone())\n+                Position::last_child_of(self.syntax())\n             };\n             create_where_clause(position)\n         }\n@@ -87,11 +87,11 @@ impl GenericParamsOwnerEdit for ast::Enum {\n     fn get_or_create_where_clause(&self) -> WhereClause {\n         if self.where_clause().is_none() {\n             let position = if let Some(gpl) = self.generic_param_list() {\n-                Position::after(gpl.syntax().clone())\n+                Position::after(gpl.syntax())\n             } else if let Some(name) = self.name() {\n-                Position::after(name.syntax().clone())\n+                Position::after(name.syntax())\n             } else {\n-                Position::last_child_of(self.syntax().clone())\n+                Position::last_child_of(self.syntax())\n             };\n             create_where_clause(position)\n         }\n@@ -100,19 +100,18 @@ impl GenericParamsOwnerEdit for ast::Enum {\n }\n \n fn create_where_clause(position: Position) {\n-    let where_clause: SyntaxElement =\n-        make::where_clause(empty()).clone_for_update().syntax().clone().into();\n-    ted::insert(position, where_clause);\n+    let where_clause = make::where_clause(empty()).clone_for_update();\n+    ted::insert(position, where_clause.syntax());\n }\n \n impl ast::WhereClause {\n     pub fn add_predicate(&self, predicate: ast::WherePred) {\n         if let Some(pred) = self.predicates().last() {\n             if !pred.syntax().siblings_with_tokens(Direction::Next).any(|it| it.kind() == T![,]) {\n-                ted::append_child_raw(self.syntax().clone(), make::token(T![,]));\n+                ted::append_child_raw(self.syntax(), make::token(T![,]));\n             }\n         }\n-        ted::append_child(self.syntax().clone(), predicate.syntax().clone())\n+        ted::append_child(self.syntax(), predicate.syntax())\n     }\n }\n \n@@ -123,7 +122,7 @@ impl ast::TypeBoundList {\n         {\n             ted::remove_all(colon..=self.syntax().clone().into())\n         } else {\n-            ted::remove(self.syntax().clone())\n+            ted::remove(self.syntax())\n         }\n     }\n }"}, {"sha": "be2b846b1513f5eb7dbba212eaed621c60932869", "filename": "crates/syntax/src/ted.rs", "status": "modified", "additions": 46, "deletions": 19, "changes": 65, "blob_url": "https://github.com/rust-lang/rust/blob/b54e4b87e80a2a9d042c7c9f82abea97a8263f34/crates%2Fsyntax%2Fsrc%2Fted.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b54e4b87e80a2a9d042c7c9f82abea97a8263f34/crates%2Fsyntax%2Fsrc%2Fted.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fsyntax%2Fsrc%2Fted.rs?ref=b54e4b87e80a2a9d042c7c9f82abea97a8263f34", "patch": "@@ -8,6 +8,33 @@ use parser::T;\n \n use crate::{ast::make, SyntaxElement, SyntaxKind, SyntaxNode, SyntaxToken};\n \n+/// Utility trait to allow calling `ted` functions with references or owned\n+/// nodes. Do not use outside of this module.\n+pub trait Element {\n+    fn syntax_element(self) -> SyntaxElement;\n+}\n+\n+impl<E: Element + Clone> Element for &'_ E {\n+    fn syntax_element(self) -> SyntaxElement {\n+        self.clone().syntax_element()\n+    }\n+}\n+impl Element for SyntaxElement {\n+    fn syntax_element(self) -> SyntaxElement {\n+        self\n+    }\n+}\n+impl Element for SyntaxNode {\n+    fn syntax_element(self) -> SyntaxElement {\n+        self.into()\n+    }\n+}\n+impl Element for SyntaxToken {\n+    fn syntax_element(self) -> SyntaxElement {\n+        self.into()\n+    }\n+}\n+\n #[derive(Debug)]\n pub struct Position {\n     repr: PositionRepr,\n@@ -20,24 +47,24 @@ enum PositionRepr {\n }\n \n impl Position {\n-    pub fn after(elem: impl Into<SyntaxElement>) -> Position {\n-        let repr = PositionRepr::After(elem.into());\n+    pub fn after(elem: impl Element) -> Position {\n+        let repr = PositionRepr::After(elem.syntax_element());\n         Position { repr }\n     }\n-    pub fn before(elem: impl Into<SyntaxElement>) -> Position {\n-        let elem = elem.into();\n+    pub fn before(elem: impl Element) -> Position {\n+        let elem = elem.syntax_element();\n         let repr = match elem.prev_sibling_or_token() {\n             Some(it) => PositionRepr::After(it),\n             None => PositionRepr::FirstChild(elem.parent().unwrap()),\n         };\n         Position { repr }\n     }\n-    pub fn first_child_of(node: impl Into<SyntaxNode>) -> Position {\n-        let repr = PositionRepr::FirstChild(node.into());\n+    pub fn first_child_of(node: &(impl Into<SyntaxNode> + Clone)) -> Position {\n+        let repr = PositionRepr::FirstChild(node.clone().into());\n         Position { repr }\n     }\n-    pub fn last_child_of(node: impl Into<SyntaxNode>) -> Position {\n-        let node = node.into();\n+    pub fn last_child_of(node: &(impl Into<SyntaxNode> + Clone)) -> Position {\n+        let node = node.clone().into();\n         let repr = match node.last_child_or_token() {\n             Some(it) => PositionRepr::After(it),\n             None => PositionRepr::FirstChild(node),\n@@ -46,11 +73,11 @@ impl Position {\n     }\n }\n \n-pub fn insert(position: Position, elem: impl Into<SyntaxElement>) {\n-    insert_all(position, vec![elem.into()])\n+pub fn insert(position: Position, elem: impl Element) {\n+    insert_all(position, vec![elem.syntax_element()])\n }\n-pub fn insert_raw(position: Position, elem: impl Into<SyntaxElement>) {\n-    insert_all_raw(position, vec![elem.into()])\n+pub fn insert_raw(position: Position, elem: impl Element) {\n+    insert_all_raw(position, vec![elem.syntax_element()])\n }\n pub fn insert_all(position: Position, mut elements: Vec<SyntaxElement>) {\n     if let Some(first) = elements.first() {\n@@ -73,17 +100,17 @@ pub fn insert_all_raw(position: Position, elements: Vec<SyntaxElement>) {\n     parent.splice_children(index..index, elements);\n }\n \n-pub fn remove(elem: impl Into<SyntaxElement>) {\n-    let elem = elem.into();\n+pub fn remove(elem: impl Element) {\n+    let elem = elem.syntax_element();\n     remove_all(elem.clone()..=elem)\n }\n pub fn remove_all(range: RangeInclusive<SyntaxElement>) {\n     replace_all(range, Vec::new())\n }\n \n-pub fn replace(old: impl Into<SyntaxElement>, new: impl Into<SyntaxElement>) {\n-    let old = old.into();\n-    replace_all(old.clone()..=old, vec![new.into()])\n+pub fn replace(old: impl Element, new: impl Element) {\n+    let old = old.syntax_element();\n+    replace_all(old.clone()..=old, vec![new.syntax_element()])\n }\n pub fn replace_all(range: RangeInclusive<SyntaxElement>, new: Vec<SyntaxElement>) {\n     let start = range.start().index();\n@@ -92,11 +119,11 @@ pub fn replace_all(range: RangeInclusive<SyntaxElement>, new: Vec<SyntaxElement>\n     parent.splice_children(start..end + 1, new)\n }\n \n-pub fn append_child(node: impl Into<SyntaxNode>, child: impl Into<SyntaxElement>) {\n+pub fn append_child(node: &(impl Into<SyntaxNode> + Clone), child: impl Element) {\n     let position = Position::last_child_of(node);\n     insert(position, child)\n }\n-pub fn append_child_raw(node: impl Into<SyntaxNode>, child: impl Into<SyntaxElement>) {\n+pub fn append_child_raw(node: &(impl Into<SyntaxNode> + Clone), child: impl Element) {\n     let position = Position::last_child_of(node);\n     insert_raw(position, child)\n }"}]}