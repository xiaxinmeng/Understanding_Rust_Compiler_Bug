{"sha": "ad2a0fc93f4d6fa89001bf482f6abd441e74ae28", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFkMmEwZmM5M2Y0ZDZmYTg5MDAxYmY0ODJmNmFiZDQ0MWU3NGFlMjg=", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2021-07-10T16:15:42Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-07-10T16:15:42Z"}, "message": "Rollup merge of #87020 - RalfJung:const_raw_ptr_to_usize_cast, r=oli-obk\n\nremove const_raw_ptr_to_usize_cast feature\n\nThis feature currently has the strange status of \"const-only `unsafe`\", which was an experiment that we no longer think is a good idea. We need to find better ways to enable things like \"messing with the low bits of a pointer\" during CTFE.\n\nr? `@oli-obk`", "tree": {"sha": "b398622d60dcd26bd39c440d9e33710f17a6e745", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b398622d60dcd26bd39c440d9e33710f17a6e745"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJg6ceuCRBK7hj4Ov3rIwAA88YIAEKJvCtswwwnoxFdy5j/fwFV\n+qjYBD89+I0R5j2ZIT8ZHD+538jQSnrHZwoBEuCjWgvoxsVuOwCQSpvvs8AZDM3A\nX6SAbICmt2VM+QE/FjoN2VFNIj70hApd9PQRyT+fAY7fAlLyeJ9qq9uPw9EZdDrC\niNJkkUUtSwVZja8tESeP9Z44TQ2AK24VWaSgVCq6imoaXzwt+0R1fEx2lndfzKiE\nKaTZiI+6ELMOQ3tC4aw9eDcf5Elh+lA9/AvQMSzSn4fuzUfeERqIXc1GWNh3I/Hr\nrHt5GGjSZcheV2SuL/dR3/6UFtRy8tktY47+oT4BXW/bwhFc1WcGnmdK2f98lhM=\n=W6Gn\n-----END PGP SIGNATURE-----\n", "payload": "tree b398622d60dcd26bd39c440d9e33710f17a6e745\nparent 945458d4722c585775c4ad9ca2a22ae040879658\nparent f5094aa5d6600ef8f47883ee831909cf88c0e955\nauthor Yuki Okushi <jtitor@2k36.org> 1625933742 +0900\ncommitter GitHub <noreply@github.com> 1625933742 +0900\n\nRollup merge of #87020 - RalfJung:const_raw_ptr_to_usize_cast, r=oli-obk\n\nremove const_raw_ptr_to_usize_cast feature\n\nThis feature currently has the strange status of \"const-only `unsafe`\", which was an experiment that we no longer think is a good idea. We need to find better ways to enable things like \"messing with the low bits of a pointer\" during CTFE.\n\nr? `@oli-obk`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28", "html_url": "https://github.com/rust-lang/rust/commit/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "945458d4722c585775c4ad9ca2a22ae040879658", "url": "https://api.github.com/repos/rust-lang/rust/commits/945458d4722c585775c4ad9ca2a22ae040879658", "html_url": "https://github.com/rust-lang/rust/commit/945458d4722c585775c4ad9ca2a22ae040879658"}, {"sha": "f5094aa5d6600ef8f47883ee831909cf88c0e955", "url": "https://api.github.com/repos/rust-lang/rust/commits/f5094aa5d6600ef8f47883ee831909cf88c0e955", "html_url": "https://github.com/rust-lang/rust/commit/f5094aa5d6600ef8f47883ee831909cf88c0e955"}], "stats": {"total": 396, "additions": 65, "deletions": 331}, "files": [{"sha": "9eaf4693811ca100844fe5fd4fc51d614463a468", "filename": "compiler/rustc_feature/src/active.rs", "status": "modified", "additions": 0, "deletions": 3, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28/compiler%2Frustc_feature%2Fsrc%2Factive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28/compiler%2Frustc_feature%2Fsrc%2Factive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_feature%2Fsrc%2Factive.rs?ref=ad2a0fc93f4d6fa89001bf482f6abd441e74ae28", "patch": "@@ -416,9 +416,6 @@ declare_features! (\n     /// Allows accessing fields of unions inside `const` functions.\n     (active, const_fn_union, \"1.27.0\", Some(51909), None),\n \n-    /// Allows casting raw pointers to `usize` during const eval.\n-    (active, const_raw_ptr_to_usize_cast, \"1.27.0\", Some(51910), None),\n-\n     /// Allows dereferencing raw pointers during const eval.\n     (active, const_raw_ptr_deref, \"1.27.0\", Some(51911), None),\n "}, {"sha": "6d3e2b9c5171366219cb1d904d1288e86349285e", "filename": "compiler/rustc_feature/src/removed.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28/compiler%2Frustc_feature%2Fsrc%2Fremoved.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28/compiler%2Frustc_feature%2Fsrc%2Fremoved.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_feature%2Fsrc%2Fremoved.rs?ref=ad2a0fc93f4d6fa89001bf482f6abd441e74ae28", "patch": "@@ -144,6 +144,10 @@ declare_features! (\n     (removed, external_doc, \"1.54.0\", Some(44732), None,\n      Some(\"use #[doc = include_str!(\\\"filename\\\")] instead, which handles macro invocations\")),\n \n+     /// Allows casting raw pointers to `usize` during const eval.\n+    (removed, const_raw_ptr_to_usize_cast, \"1.55.0\", Some(51910), None,\n+     Some(\"at compile-time, pointers do not have an integer value, so these casts cannot be properly supported\")),\n+\n     // -------------------------------------------------------------------------\n     // feature-group-end: removed features\n     // -------------------------------------------------------------------------"}, {"sha": "fd72ec4340f9f2a7f9c462c9039f3888998e70c2", "filename": "compiler/rustc_mir/src/transform/check_consts/ops.rs", "status": "modified", "additions": 15, "deletions": 10, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fcheck_consts%2Fops.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fcheck_consts%2Fops.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fcheck_consts%2Fops.rs?ref=ad2a0fc93f4d6fa89001bf482f6abd441e74ae28", "patch": "@@ -397,6 +397,9 @@ impl NonConstOp for PanicNonStr {\n     }\n }\n \n+/// Comparing raw pointers for equality.\n+/// Not currently intended to ever be allowed, even behind a feature gate: operation depends on\n+/// allocation base addresses that are not known at compile-time.\n #[derive(Debug)]\n pub struct RawPtrComparison;\n impl NonConstOp for RawPtrComparison {\n@@ -430,20 +433,22 @@ impl NonConstOp for RawPtrDeref {\n     }\n }\n \n+/// Casting raw pointer or function pointer to an integer.\n+/// Not currently intended to ever be allowed, even behind a feature gate: operation depends on\n+/// allocation base addresses that are not known at compile-time.\n #[derive(Debug)]\n pub struct RawPtrToIntCast;\n impl NonConstOp for RawPtrToIntCast {\n-    fn status_in_item(&self, _: &ConstCx<'_, '_>) -> Status {\n-        Status::Unstable(sym::const_raw_ptr_to_usize_cast)\n-    }\n-\n     fn build_error(&self, ccx: &ConstCx<'_, 'tcx>, span: Span) -> DiagnosticBuilder<'tcx> {\n-        feature_err(\n-            &ccx.tcx.sess.parse_sess,\n-            sym::const_raw_ptr_to_usize_cast,\n-            span,\n-            &format!(\"casting pointers to integers in {}s is unstable\", ccx.const_kind(),),\n-        )\n+        let mut err = ccx\n+            .tcx\n+            .sess\n+            .struct_span_err(span, \"pointers cannot be cast to integers during const eval.\");\n+        err.note(\"at compile-time, pointers do not have an integer value\");\n+        err.note(\n+            \"avoiding this restriction via `transmute`, `union`, or raw pointers leads to compile-time undefined behavior\",\n+        );\n+        err\n     }\n }\n "}, {"sha": "1ff9bd157210874391deafc577a31eb4dd435c42", "filename": "compiler/rustc_mir/src/transform/check_unsafety.rs", "status": "modified", "additions": 1, "deletions": 30, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fcheck_unsafety.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fcheck_unsafety.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fcheck_unsafety.rs?ref=ad2a0fc93f4d6fa89001bf482f6abd441e74ae28", "patch": "@@ -7,7 +7,6 @@ use rustc_hir::intravisit;\n use rustc_hir::Node;\n use rustc_middle::mir::visit::{MutatingUseContext, PlaceContext, Visitor};\n use rustc_middle::mir::*;\n-use rustc_middle::ty::cast::CastTy;\n use rustc_middle::ty::query::Providers;\n use rustc_middle::ty::{self, TyCtxt};\n use rustc_session::lint::builtin::{UNSAFE_OP_IN_UNSAFE_FN, UNUSED_UNSAFE};\n@@ -18,7 +17,6 @@ use std::ops::Bound;\n pub struct UnsafetyChecker<'a, 'tcx> {\n     body: &'a Body<'tcx>,\n     body_did: LocalDefId,\n-    const_context: bool,\n     violations: Vec<UnsafetyViolation>,\n     source_info: SourceInfo,\n     tcx: TyCtxt<'tcx>,\n@@ -30,7 +28,6 @@ pub struct UnsafetyChecker<'a, 'tcx> {\n \n impl<'a, 'tcx> UnsafetyChecker<'a, 'tcx> {\n     fn new(\n-        const_context: bool,\n         body: &'a Body<'tcx>,\n         body_did: LocalDefId,\n         tcx: TyCtxt<'tcx>,\n@@ -39,7 +36,6 @@ impl<'a, 'tcx> UnsafetyChecker<'a, 'tcx> {\n         Self {\n             body,\n             body_did,\n-            const_context,\n             violations: vec![],\n             source_info: SourceInfo::outermost(body.span),\n             tcx,\n@@ -136,25 +132,6 @@ impl<'a, 'tcx> Visitor<'tcx> for UnsafetyChecker<'a, 'tcx> {\n                     self.register_violations(&violations, &unsafe_blocks);\n                 }\n             },\n-            // casting pointers to ints is unsafe in const fn because the const evaluator cannot\n-            // possibly know what the result of various operations like `address / 2` would be\n-            // pointers during const evaluation have no integral address, only an abstract one\n-            Rvalue::Cast(CastKind::Misc, ref operand, cast_ty)\n-                if self.const_context && self.tcx.features().const_raw_ptr_to_usize_cast =>\n-            {\n-                let operand_ty = operand.ty(self.body, self.tcx);\n-                let cast_in = CastTy::from_ty(operand_ty).expect(\"bad input type for cast\");\n-                let cast_out = CastTy::from_ty(cast_ty).expect(\"bad output type for cast\");\n-                match (cast_in, cast_out) {\n-                    (CastTy::Ptr(_) | CastTy::FnPtr, CastTy::Int(_)) => {\n-                        self.require_unsafe(\n-                            UnsafetyViolationKind::General,\n-                            UnsafetyViolationDetails::CastOfPointerToInt,\n-                        );\n-                    }\n-                    _ => {}\n-                }\n-            }\n             _ => {}\n         }\n         self.super_rvalue(rvalue, location);\n@@ -469,13 +446,7 @@ fn unsafety_check_result<'tcx>(\n \n     let param_env = tcx.param_env(def.did);\n \n-    let id = tcx.hir().local_def_id_to_hir_id(def.did);\n-    let const_context = match tcx.hir().body_owner_kind(id) {\n-        hir::BodyOwnerKind::Closure => false,\n-        hir::BodyOwnerKind::Fn => tcx.is_const_fn_raw(def.did.to_def_id()),\n-        hir::BodyOwnerKind::Const | hir::BodyOwnerKind::Static(_) => true,\n-    };\n-    let mut checker = UnsafetyChecker::new(const_context, body, def.did, tcx, param_env);\n+    let mut checker = UnsafetyChecker::new(body, def.did, tcx, param_env);\n     checker.visit_body(&body);\n \n     check_unused_unsafe(tcx, def.did, &checker.used_unsafe, &mut checker.inherited_blocks);"}, {"sha": "38111527a4ec719e133138452ad4eea2247238a5", "filename": "compiler/rustc_mir_build/src/check_unsafety.rs", "status": "modified", "additions": 0, "deletions": 21, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28/compiler%2Frustc_mir_build%2Fsrc%2Fcheck_unsafety.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28/compiler%2Frustc_mir_build%2Fsrc%2Fcheck_unsafety.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fcheck_unsafety.rs?ref=ad2a0fc93f4d6fa89001bf482f6abd441e74ae28", "patch": "@@ -25,7 +25,6 @@ struct UnsafetyVisitor<'a, 'tcx> {\n     /// The `#[target_feature]` attributes of the body. Used for checking\n     /// calls to functions with `#[target_feature]` (RFC 2396).\n     body_target_features: &'tcx Vec<Symbol>,\n-    is_const: bool,\n     in_possible_lhs_union_assign: bool,\n     in_union_destructure: bool,\n }\n@@ -315,16 +314,6 @@ impl<'a, 'tcx> Visitor<'a, 'tcx> for UnsafetyVisitor<'a, 'tcx> {\n                 (Bound::Unbounded, Bound::Unbounded) => {}\n                 _ => self.requires_unsafe(expr.span, InitializingTypeWith),\n             },\n-            ExprKind::Cast { source } => {\n-                let source = &self.thir[source];\n-                if self.tcx.features().const_raw_ptr_to_usize_cast\n-                    && self.is_const\n-                    && (source.ty.is_unsafe_ptr() || source.ty.is_fn_ptr())\n-                    && expr.ty.is_integral()\n-                {\n-                    self.requires_unsafe(expr.span, CastOfPointerToInt);\n-                }\n-            }\n             ExprKind::Closure {\n                 closure_id,\n                 substs: _,\n@@ -413,7 +402,6 @@ enum UnsafeOpKind {\n     CallToUnsafeFunction,\n     UseOfInlineAssembly,\n     InitializingTypeWith,\n-    CastOfPointerToInt,\n     UseOfMutableStatic,\n     UseOfExternStatic,\n     DerefOfRawPointer,\n@@ -446,9 +434,6 @@ impl UnsafeOpKind {\n                 \"initializing a layout restricted type's field with a value outside the valid \\\n                  range is undefined behavior\",\n             ),\n-            CastOfPointerToInt => {\n-                (\"cast of pointer to int\", \"casting pointers to integers in constants\")\n-            }\n             UseOfMutableStatic => (\n                 \"use of mutable static\",\n                 \"mutable statics can be mutated by multiple threads: aliasing violations or data \\\n@@ -526,19 +511,13 @@ pub fn check_unsafety<'tcx>(tcx: TyCtxt<'tcx>, def: ty::WithOptConstParam<LocalD\n     let body_target_features = &tcx.codegen_fn_attrs(def.did).target_features;\n     let safety_context =\n         if body_unsafety.is_unsafe() { SafetyContext::UnsafeFn } else { SafetyContext::Safe };\n-    let is_const = match tcx.hir().body_owner_kind(hir_id) {\n-        hir::BodyOwnerKind::Closure => false,\n-        hir::BodyOwnerKind::Fn => tcx.is_const_fn_raw(def.did.to_def_id()),\n-        hir::BodyOwnerKind::Const | hir::BodyOwnerKind::Static(_) => true,\n-    };\n     let mut visitor = UnsafetyVisitor {\n         tcx,\n         thir,\n         safety_context,\n         hir_context: hir_id,\n         body_unsafety,\n         body_target_features,\n-        is_const,\n         in_possible_lhs_union_assign: false,\n         in_union_destructure: false,\n     };"}, {"sha": "dcc9a243f0f399a0b73e63fe5820de16224cbcbe", "filename": "src/test/ui/cast/cast-ptr-to-int-const.mir.stderr", "status": "removed", "additions": 0, "deletions": 19, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/945458d4722c585775c4ad9ca2a22ae040879658/src%2Ftest%2Fui%2Fcast%2Fcast-ptr-to-int-const.mir.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/945458d4722c585775c4ad9ca2a22ae040879658/src%2Ftest%2Fui%2Fcast%2Fcast-ptr-to-int-const.mir.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcast%2Fcast-ptr-to-int-const.mir.stderr?ref=945458d4722c585775c4ad9ca2a22ae040879658", "patch": "@@ -1,19 +0,0 @@\n-error[E0133]: cast of pointer to int is unsafe and requires unsafe function or block\n-  --> $DIR/cast-ptr-to-int-const.rs:10:9\n-   |\n-LL |         &Y as *const u32 as usize\n-   |         ^^^^^^^^^^^^^^^^^^^^^^^^^ cast of pointer to int\n-   |\n-   = note: casting pointers to integers in constants\n-\n-error[E0133]: cast of pointer to int is unsafe and requires unsafe function or block\n-  --> $DIR/cast-ptr-to-int-const.rs:17:5\n-   |\n-LL |     &0 as *const i32 as usize\n-   |     ^^^^^^^^^^^^^^^^^^^^^^^^^ cast of pointer to int\n-   |\n-   = note: casting pointers to integers in constants\n-\n-error: aborting due to 2 previous errors\n-\n-For more information about this error, try `rustc --explain E0133`."}, {"sha": "01ea627679d135b0d4201ec25a5437f5065be6cb", "filename": "src/test/ui/cast/cast-ptr-to-int-const.rs", "status": "removed", "additions": 0, "deletions": 19, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/945458d4722c585775c4ad9ca2a22ae040879658/src%2Ftest%2Fui%2Fcast%2Fcast-ptr-to-int-const.rs", "raw_url": "https://github.com/rust-lang/rust/raw/945458d4722c585775c4ad9ca2a22ae040879658/src%2Ftest%2Fui%2Fcast%2Fcast-ptr-to-int-const.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcast%2Fcast-ptr-to-int-const.rs?ref=945458d4722c585775c4ad9ca2a22ae040879658", "patch": "@@ -1,19 +0,0 @@\n-// revisions: mir thir\n-// [thir]compile-flags: -Z thir-unsafeck\n-\n-#![feature(const_raw_ptr_to_usize_cast)]\n-\n-fn main() {\n-    const Y: u32 = 0;\n-    // Cast in `const` without `unsafe` block\n-    const SAFE: usize = {\n-        &Y as *const u32 as usize\n-        //~^ ERROR cast of pointer to int is unsafe and requires unsafe\n-    };\n-}\n-\n-// Cast in `const fn` without `unsafe` block\n-const fn test() -> usize {\n-    &0 as *const i32 as usize\n-    //~^ ERROR cast of pointer to int is unsafe and requires unsafe\n-}"}, {"sha": "dcc9a243f0f399a0b73e63fe5820de16224cbcbe", "filename": "src/test/ui/cast/cast-ptr-to-int-const.thir.stderr", "status": "removed", "additions": 0, "deletions": 19, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/945458d4722c585775c4ad9ca2a22ae040879658/src%2Ftest%2Fui%2Fcast%2Fcast-ptr-to-int-const.thir.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/945458d4722c585775c4ad9ca2a22ae040879658/src%2Ftest%2Fui%2Fcast%2Fcast-ptr-to-int-const.thir.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcast%2Fcast-ptr-to-int-const.thir.stderr?ref=945458d4722c585775c4ad9ca2a22ae040879658", "patch": "@@ -1,19 +0,0 @@\n-error[E0133]: cast of pointer to int is unsafe and requires unsafe function or block\n-  --> $DIR/cast-ptr-to-int-const.rs:10:9\n-   |\n-LL |         &Y as *const u32 as usize\n-   |         ^^^^^^^^^^^^^^^^^^^^^^^^^ cast of pointer to int\n-   |\n-   = note: casting pointers to integers in constants\n-\n-error[E0133]: cast of pointer to int is unsafe and requires unsafe function or block\n-  --> $DIR/cast-ptr-to-int-const.rs:17:5\n-   |\n-LL |     &0 as *const i32 as usize\n-   |     ^^^^^^^^^^^^^^^^^^^^^^^^^ cast of pointer to int\n-   |\n-   = note: casting pointers to integers in constants\n-\n-error: aborting due to 2 previous errors\n-\n-For more information about this error, try `rustc --explain E0133`."}, {"sha": "03e99eb752740c2822b372050269fc9679aacf15", "filename": "src/test/ui/cast/feature-gate-const_raw_ptr_to_usize_cast.rs", "status": "removed", "additions": 0, "deletions": 13, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/945458d4722c585775c4ad9ca2a22ae040879658/src%2Ftest%2Fui%2Fcast%2Ffeature-gate-const_raw_ptr_to_usize_cast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/945458d4722c585775c4ad9ca2a22ae040879658/src%2Ftest%2Fui%2Fcast%2Ffeature-gate-const_raw_ptr_to_usize_cast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcast%2Ffeature-gate-const_raw_ptr_to_usize_cast.rs?ref=945458d4722c585775c4ad9ca2a22ae040879658", "patch": "@@ -1,13 +0,0 @@\n-fn main() {\n-    const X: usize = unsafe {\n-        main as usize //~ ERROR casting pointers to integers in constants is unstable\n-    };\n-    const Y: u32 = 0;\n-    const Z: usize = unsafe {\n-        &Y as *const u32 as usize //~ ERROR is unstable\n-    };\n-}\n-\n-const fn test() -> usize {\n-    &0 as *const i32 as usize //~ ERROR is unstable\n-}"}, {"sha": "4a0b424e1816b3d7df6a0d08821c1ccbb676d3ac", "filename": "src/test/ui/cast/feature-gate-const_raw_ptr_to_usize_cast.stderr", "status": "removed", "additions": 0, "deletions": 30, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/945458d4722c585775c4ad9ca2a22ae040879658/src%2Ftest%2Fui%2Fcast%2Ffeature-gate-const_raw_ptr_to_usize_cast.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/945458d4722c585775c4ad9ca2a22ae040879658/src%2Ftest%2Fui%2Fcast%2Ffeature-gate-const_raw_ptr_to_usize_cast.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcast%2Ffeature-gate-const_raw_ptr_to_usize_cast.stderr?ref=945458d4722c585775c4ad9ca2a22ae040879658", "patch": "@@ -1,30 +0,0 @@\n-error[E0658]: casting pointers to integers in constants is unstable\n-  --> $DIR/feature-gate-const_raw_ptr_to_usize_cast.rs:3:9\n-   |\n-LL |         main as usize\n-   |         ^^^^^^^^^^^^^\n-   |\n-   = note: see issue #51910 <https://github.com/rust-lang/rust/issues/51910> for more information\n-   = help: add `#![feature(const_raw_ptr_to_usize_cast)]` to the crate attributes to enable\n-\n-error[E0658]: casting pointers to integers in constants is unstable\n-  --> $DIR/feature-gate-const_raw_ptr_to_usize_cast.rs:7:9\n-   |\n-LL |         &Y as *const u32 as usize\n-   |         ^^^^^^^^^^^^^^^^^^^^^^^^^\n-   |\n-   = note: see issue #51910 <https://github.com/rust-lang/rust/issues/51910> for more information\n-   = help: add `#![feature(const_raw_ptr_to_usize_cast)]` to the crate attributes to enable\n-\n-error[E0658]: casting pointers to integers in constant functions is unstable\n-  --> $DIR/feature-gate-const_raw_ptr_to_usize_cast.rs:12:5\n-   |\n-LL |     &0 as *const i32 as usize\n-   |     ^^^^^^^^^^^^^^^^^^^^^^^^^\n-   |\n-   = note: see issue #51910 <https://github.com/rust-lang/rust/issues/51910> for more information\n-   = help: add `#![feature(const_raw_ptr_to_usize_cast)]` to the crate attributes to enable\n-\n-error: aborting due to 3 previous errors\n-\n-For more information about this error, try `rustc --explain E0658`."}, {"sha": "bf1e790b5dc29270a92c743ab2b92bc122a2a031", "filename": "src/test/ui/const-ptr/ptr_to_usize_cast.rs", "status": "removed", "additions": 0, "deletions": 13, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/945458d4722c585775c4ad9ca2a22ae040879658/src%2Ftest%2Fui%2Fconst-ptr%2Fptr_to_usize_cast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/945458d4722c585775c4ad9ca2a22ae040879658/src%2Ftest%2Fui%2Fconst-ptr%2Fptr_to_usize_cast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconst-ptr%2Fptr_to_usize_cast.rs?ref=945458d4722c585775c4ad9ca2a22ae040879658", "patch": "@@ -1,13 +0,0 @@\n-#![feature(const_raw_ptr_to_usize_cast)]\n-\n-fn main() {\n-    const OK: usize = unsafe { 0 as *const i32 as usize };\n-\n-    const _ERROR: usize = unsafe { &0 as *const i32 as usize };\n-    //~^ ERROR [const_err]\n-    //~| NOTE cannot cast pointer to integer because it was not created by cast from integer\n-    //~| NOTE\n-    //~| NOTE `#[deny(const_err)]` on by default\n-    //~| WARN this was previously accepted by the compiler but is being phased out\n-    //~| NOTE see issue #71800\n-}"}, {"sha": "48255860bb53fd1f0b5331866dbe70ea6544de4d", "filename": "src/test/ui/const-ptr/ptr_to_usize_cast.stderr", "status": "removed", "additions": 0, "deletions": 14, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/945458d4722c585775c4ad9ca2a22ae040879658/src%2Ftest%2Fui%2Fconst-ptr%2Fptr_to_usize_cast.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/945458d4722c585775c4ad9ca2a22ae040879658/src%2Ftest%2Fui%2Fconst-ptr%2Fptr_to_usize_cast.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconst-ptr%2Fptr_to_usize_cast.stderr?ref=945458d4722c585775c4ad9ca2a22ae040879658", "patch": "@@ -1,14 +0,0 @@\n-error: any use of this value will cause an error\n-  --> $DIR/ptr_to_usize_cast.rs:6:36\n-   |\n-LL |     const _ERROR: usize = unsafe { &0 as *const i32 as usize };\n-   |     -------------------------------^^^^^^^^^^^^^^^^^^^^^^^^^---\n-   |                                    |\n-   |                                    cannot cast pointer to integer because it was not created by cast from integer\n-   |\n-   = note: `#[deny(const_err)]` on by default\n-   = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n-   = note: for more information, see issue #71800 <https://github.com/rust-lang/rust/issues/71800>\n-\n-error: aborting due to previous error\n-"}, {"sha": "a177ed6b3413eb9f7b26e099aa6934d3c931a291", "filename": "src/test/ui/consts/const-eval/const_raw_ptr_ops2.rs", "status": "modified", "additions": 4, "deletions": 8, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fconst_raw_ptr_ops2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fconst_raw_ptr_ops2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fconst_raw_ptr_ops2.rs?ref=ad2a0fc93f4d6fa89001bf482f6abd441e74ae28", "patch": "@@ -1,15 +1,11 @@\n-#![feature(const_raw_ptr_to_usize_cast, const_raw_ptr_deref)]\n+#![feature(const_raw_ptr_deref)]\n \n fn main() {}\n \n-// unconst and fine\n-const Y: usize = unsafe { 42usize as *const i32 as usize + 1 };\n-// unconst and bad, will thus error in miri\n-const Y2: usize = unsafe { &1 as *const i32 as usize + 1 }; //~ ERROR any use of this\n-//~| WARN this was previously accepted by the compiler but is being phased out\n-// unconst and fine\n+// fine\n const Z: i32 = unsafe { *(&1 as *const i32) };\n-// unconst and bad, will thus error in miri\n+\n+// bad, will thus error in miri\n const Z2: i32 = unsafe { *(42 as *const i32) }; //~ ERROR any use of this value will cause\n //~| WARN this was previously accepted by the compiler but is being phased out\n const Z3: i32 = unsafe { *(44 as *const i32) }; //~ ERROR any use of this value will cause"}, {"sha": "de54ea3b9fbd0c7b6754b766a758c500a9dfaf6d", "filename": "src/test/ui/consts/const-eval/const_raw_ptr_ops2.stderr", "status": "modified", "additions": 4, "deletions": 15, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fconst_raw_ptr_ops2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fconst_raw_ptr_ops2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fconst_raw_ptr_ops2.stderr?ref=ad2a0fc93f4d6fa89001bf482f6abd441e74ae28", "patch": "@@ -1,28 +1,17 @@\n error: any use of this value will cause an error\n-  --> $DIR/const_raw_ptr_ops2.rs:8:28\n-   |\n-LL | const Y2: usize = unsafe { &1 as *const i32 as usize + 1 };\n-   | ---------------------------^^^^^^^^^^^^^^^^^^^^^^^^^-------\n-   |                            |\n-   |                            cannot cast pointer to integer because it was not created by cast from integer\n-   |\n-   = note: `#[deny(const_err)]` on by default\n-   = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n-   = note: for more information, see issue #71800 <https://github.com/rust-lang/rust/issues/71800>\n-\n-error: any use of this value will cause an error\n-  --> $DIR/const_raw_ptr_ops2.rs:13:26\n+  --> $DIR/const_raw_ptr_ops2.rs:9:26\n    |\n LL | const Z2: i32 = unsafe { *(42 as *const i32) };\n    | -------------------------^^^^^^^^^^^^^^^^^^^---\n    |                          |\n    |                          unable to turn bytes into a pointer\n    |\n+   = note: `#[deny(const_err)]` on by default\n    = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n    = note: for more information, see issue #71800 <https://github.com/rust-lang/rust/issues/71800>\n \n error: any use of this value will cause an error\n-  --> $DIR/const_raw_ptr_ops2.rs:15:26\n+  --> $DIR/const_raw_ptr_ops2.rs:11:26\n    |\n LL | const Z3: i32 = unsafe { *(44 as *const i32) };\n    | -------------------------^^^^^^^^^^^^^^^^^^^---\n@@ -32,5 +21,5 @@ LL | const Z3: i32 = unsafe { *(44 as *const i32) };\n    = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n    = note: for more information, see issue #71800 <https://github.com/rust-lang/rust/issues/71800>\n \n-error: aborting due to 3 previous errors\n+error: aborting due to 2 previous errors\n "}, {"sha": "159b48d42b6c69e50fc146865244fbb3101ee721", "filename": "src/test/ui/consts/const-eval/issue-52442.rs", "status": "removed", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/945458d4722c585775c4ad9ca2a22ae040879658/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fissue-52442.rs", "raw_url": "https://github.com/rust-lang/rust/raw/945458d4722c585775c4ad9ca2a22ae040879658/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fissue-52442.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fissue-52442.rs?ref=945458d4722c585775c4ad9ca2a22ae040879658", "patch": "@@ -1,4 +0,0 @@\n-fn main() {\n-    [();  { &loop { break } as *const _ as usize } ];\n-    //~^ ERROR casting pointers to integers in constants is unstable\n-}"}, {"sha": "2a8f34279c3db67d9f114333de6a0b50b6b9e079", "filename": "src/test/ui/consts/const-eval/issue-52442.stderr", "status": "removed", "additions": 0, "deletions": 12, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/945458d4722c585775c4ad9ca2a22ae040879658/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fissue-52442.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/945458d4722c585775c4ad9ca2a22ae040879658/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fissue-52442.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fissue-52442.stderr?ref=945458d4722c585775c4ad9ca2a22ae040879658", "patch": "@@ -1,12 +0,0 @@\n-error[E0658]: casting pointers to integers in constants is unstable\n-  --> $DIR/issue-52442.rs:2:13\n-   |\n-LL |     [();  { &loop { break } as *const _ as usize } ];\n-   |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n-   |\n-   = note: see issue #51910 <https://github.com/rust-lang/rust/issues/51910> for more information\n-   = help: add `#![feature(const_raw_ptr_to_usize_cast)]` to the crate attributes to enable\n-\n-error: aborting due to previous error\n-\n-For more information about this error, try `rustc --explain E0658`."}, {"sha": "4af97b5487929ce0184a84d429edaf07a1c20b6f", "filename": "src/test/ui/consts/const-eval/match-test-ptr-null.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fmatch-test-ptr-null.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fmatch-test-ptr-null.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fmatch-test-ptr-null.rs?ref=ad2a0fc93f4d6fa89001bf482f6abd441e74ae28", "patch": "@@ -4,7 +4,7 @@ fn main() {\n     // bytes.\n     let _: [u8; 0] = [4; {\n         match &1 as *const i32 as usize {\n-            //~^ ERROR casting pointers to integers in constants\n+            //~^ ERROR pointers cannot be cast to integers during const eval\n             0 => 42,\n             n => n,\n         }"}, {"sha": "4e55b36da73929237f0f52a147fc5900975dd388", "filename": "src/test/ui/consts/const-eval/match-test-ptr-null.stderr", "status": "modified", "additions": 3, "deletions": 4, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fmatch-test-ptr-null.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fmatch-test-ptr-null.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fmatch-test-ptr-null.stderr?ref=ad2a0fc93f4d6fa89001bf482f6abd441e74ae28", "patch": "@@ -1,12 +1,11 @@\n-error[E0658]: casting pointers to integers in constants is unstable\n+error: pointers cannot be cast to integers during const eval.\n   --> $DIR/match-test-ptr-null.rs:6:15\n    |\n LL |         match &1 as *const i32 as usize {\n    |               ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |\n-   = note: see issue #51910 <https://github.com/rust-lang/rust/issues/51910> for more information\n-   = help: add `#![feature(const_raw_ptr_to_usize_cast)]` to the crate attributes to enable\n+   = note: at compile-time, pointers do not have an integer value\n+   = note: avoiding this restriction via `transmute`, `union`, or raw pointers leads to compile-time undefined behavior\n \n error: aborting due to previous error\n \n-For more information about this error, try `rustc --explain E0658`."}, {"sha": "c7d84303fe54ca6028248b792869357a0605c38e", "filename": "src/test/ui/consts/const-eval/promoted_raw_ptr_ops.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fpromoted_raw_ptr_ops.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fpromoted_raw_ptr_ops.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fpromoted_raw_ptr_ops.rs?ref=ad2a0fc93f4d6fa89001bf482f6abd441e74ae28", "patch": "@@ -1,4 +1,4 @@\n-#![feature(const_raw_ptr_to_usize_cast, const_raw_ptr_deref)]\n+#![feature(const_raw_ptr_deref)]\n \n fn main() {\n     let x: &'static bool = &(42 as *const i32 == 43 as *const i32);"}, {"sha": "46748673067cebb02e795c78449a413186722521", "filename": "src/test/ui/consts/const-extern-fn/const-extern-fn-min-const-fn.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28/src%2Ftest%2Fui%2Fconsts%2Fconst-extern-fn%2Fconst-extern-fn-min-const-fn.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28/src%2Ftest%2Fui%2Fconsts%2Fconst-extern-fn%2Fconst-extern-fn-min-const-fn.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fconst-extern-fn%2Fconst-extern-fn-min-const-fn.rs?ref=ad2a0fc93f4d6fa89001bf482f6abd441e74ae28", "patch": "@@ -7,7 +7,7 @@ const unsafe extern \"C\" fn closure() -> fn() { || {} }\n const unsafe extern \"C\" fn use_float() { 1.0 + 1.0; }\n //~^ ERROR floating point arithmetic\n const extern \"C\" fn ptr_cast(val: *const u8) { val as usize; }\n-//~^ ERROR casting pointers to integers\n+//~^ ERROR pointers cannot be cast to integers\n \n \n fn main() {}"}, {"sha": "2e52bae2b676cf1601d94ded482deb7bcb76489a", "filename": "src/test/ui/consts/const-extern-fn/const-extern-fn-min-const-fn.stderr", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28/src%2Ftest%2Fui%2Fconsts%2Fconst-extern-fn%2Fconst-extern-fn-min-const-fn.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28/src%2Ftest%2Fui%2Fconsts%2Fconst-extern-fn%2Fconst-extern-fn-min-const-fn.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fconst-extern-fn%2Fconst-extern-fn-min-const-fn.stderr?ref=ad2a0fc93f4d6fa89001bf482f6abd441e74ae28", "patch": "@@ -25,14 +25,14 @@ LL | const unsafe extern \"C\" fn use_float() { 1.0 + 1.0; }\n    = note: see issue #57241 <https://github.com/rust-lang/rust/issues/57241> for more information\n    = help: add `#![feature(const_fn_floating_point_arithmetic)]` to the crate attributes to enable\n \n-error[E0658]: casting pointers to integers in constant functions is unstable\n+error: pointers cannot be cast to integers during const eval.\n   --> $DIR/const-extern-fn-min-const-fn.rs:9:48\n    |\n LL | const extern \"C\" fn ptr_cast(val: *const u8) { val as usize; }\n    |                                                ^^^^^^^^^^^^\n    |\n-   = note: see issue #51910 <https://github.com/rust-lang/rust/issues/51910> for more information\n-   = help: add `#![feature(const_raw_ptr_to_usize_cast)]` to the crate attributes to enable\n+   = note: at compile-time, pointers do not have an integer value\n+   = note: avoiding this restriction via `transmute`, `union`, or raw pointers leads to compile-time undefined behavior\n \n error: aborting due to 4 previous errors\n "}, {"sha": "44125a1c3df8d64302f9688a81883083c73873da", "filename": "src/test/ui/consts/issue-17458.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28/src%2Ftest%2Fui%2Fconsts%2Fissue-17458.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28/src%2Ftest%2Fui%2Fconsts%2Fissue-17458.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fissue-17458.rs?ref=ad2a0fc93f4d6fa89001bf482f6abd441e74ae28", "patch": "@@ -1,5 +1,5 @@\n static X: usize = unsafe { core::ptr::null::<usize>() as usize };\n-//~^ ERROR: casting pointers to integers in statics is unstable\n+//~^ ERROR: pointers cannot be cast to integers during const eval\n \n fn main() {\n     assert_eq!(X, 0);"}, {"sha": "aab7d798db2e7f663882befd9bbf10a7b0e4d34e", "filename": "src/test/ui/consts/issue-17458.stderr", "status": "modified", "additions": 3, "deletions": 4, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28/src%2Ftest%2Fui%2Fconsts%2Fissue-17458.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28/src%2Ftest%2Fui%2Fconsts%2Fissue-17458.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fissue-17458.stderr?ref=ad2a0fc93f4d6fa89001bf482f6abd441e74ae28", "patch": "@@ -1,12 +1,11 @@\n-error[E0658]: casting pointers to integers in statics is unstable\n+error: pointers cannot be cast to integers during const eval.\n   --> $DIR/issue-17458.rs:1:28\n    |\n LL | static X: usize = unsafe { core::ptr::null::<usize>() as usize };\n    |                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |\n-   = note: see issue #51910 <https://github.com/rust-lang/rust/issues/51910> for more information\n-   = help: add `#![feature(const_raw_ptr_to_usize_cast)]` to the crate attributes to enable\n+   = note: at compile-time, pointers do not have an integer value\n+   = note: avoiding this restriction via `transmute`, `union`, or raw pointers leads to compile-time undefined behavior\n \n error: aborting due to previous error\n \n-For more information about this error, try `rustc --explain E0658`."}, {"sha": "cc644404f7d7351de70b2c410b56faff0cca4cca", "filename": "src/test/ui/consts/issue-51559.rs", "status": "removed", "additions": 0, "deletions": 8, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/945458d4722c585775c4ad9ca2a22ae040879658/src%2Ftest%2Fui%2Fconsts%2Fissue-51559.rs", "raw_url": "https://github.com/rust-lang/rust/raw/945458d4722c585775c4ad9ca2a22ae040879658/src%2Ftest%2Fui%2Fconsts%2Fissue-51559.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fissue-51559.rs?ref=945458d4722c585775c4ad9ca2a22ae040879658", "patch": "@@ -1,8 +0,0 @@\n-#![feature(const_raw_ptr_to_usize_cast)]\n-\n-const BAR: *mut () = ((|| 3) as fn() -> i32) as *mut ();\n-pub const FOO: usize = unsafe { BAR as usize };\n-//~^ ERROR any use of this value will cause an error\n-//~| WARN this was previously accepted by the compiler but is being phased out\n-\n-fn main() {}"}, {"sha": "d571eb549630f948ffb25569946f6463603bc160", "filename": "src/test/ui/consts/issue-51559.stderr", "status": "removed", "additions": 0, "deletions": 14, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/945458d4722c585775c4ad9ca2a22ae040879658/src%2Ftest%2Fui%2Fconsts%2Fissue-51559.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/945458d4722c585775c4ad9ca2a22ae040879658/src%2Ftest%2Fui%2Fconsts%2Fissue-51559.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fissue-51559.stderr?ref=945458d4722c585775c4ad9ca2a22ae040879658", "patch": "@@ -1,14 +0,0 @@\n-error: any use of this value will cause an error\n-  --> $DIR/issue-51559.rs:4:33\n-   |\n-LL | pub const FOO: usize = unsafe { BAR as usize };\n-   | --------------------------------^^^^^^^^^^^^---\n-   |                                 |\n-   |                                 cannot cast pointer to integer because it was not created by cast from integer\n-   |\n-   = note: `#[deny(const_err)]` on by default\n-   = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n-   = note: for more information, see issue #71800 <https://github.com/rust-lang/rust/issues/71800>\n-\n-error: aborting due to previous error\n-"}, {"sha": "2249d9879f5dc9243991ddcfb0b945ffdb152ee9", "filename": "src/test/ui/consts/issue-52023-array-size-pointer-cast.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28/src%2Ftest%2Fui%2Fconsts%2Fissue-52023-array-size-pointer-cast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28/src%2Ftest%2Fui%2Fconsts%2Fissue-52023-array-size-pointer-cast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fissue-52023-array-size-pointer-cast.rs?ref=ad2a0fc93f4d6fa89001bf482f6abd441e74ae28", "patch": "@@ -1,3 +1,3 @@\n fn main() {\n-    let _ = [0; (&0 as *const i32) as usize]; //~ ERROR casting pointers to integers in constants\n+    let _ = [0; (&0 as *const i32) as usize]; //~ ERROR pointers cannot be cast to integers during const eval\n }"}, {"sha": "363c7b2c8e462d54281956911cebc8709b4c85b0", "filename": "src/test/ui/consts/issue-52023-array-size-pointer-cast.stderr", "status": "modified", "additions": 3, "deletions": 4, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28/src%2Ftest%2Fui%2Fconsts%2Fissue-52023-array-size-pointer-cast.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28/src%2Ftest%2Fui%2Fconsts%2Fissue-52023-array-size-pointer-cast.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fissue-52023-array-size-pointer-cast.stderr?ref=ad2a0fc93f4d6fa89001bf482f6abd441e74ae28", "patch": "@@ -1,12 +1,11 @@\n-error[E0658]: casting pointers to integers in constants is unstable\n+error: pointers cannot be cast to integers during const eval.\n   --> $DIR/issue-52023-array-size-pointer-cast.rs:2:17\n    |\n LL |     let _ = [0; (&0 as *const i32) as usize];\n    |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |\n-   = note: see issue #51910 <https://github.com/rust-lang/rust/issues/51910> for more information\n-   = help: add `#![feature(const_raw_ptr_to_usize_cast)]` to the crate attributes to enable\n+   = note: at compile-time, pointers do not have an integer value\n+   = note: avoiding this restriction via `transmute`, `union`, or raw pointers leads to compile-time undefined behavior\n \n error: aborting due to previous error\n \n-For more information about this error, try `rustc --explain E0658`."}, {"sha": "d719bf1b97161668d5fb305df2f6e81448788f70", "filename": "src/test/ui/consts/issue-52432.rs", "status": "removed", "additions": 0, "deletions": 10, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/945458d4722c585775c4ad9ca2a22ae040879658/src%2Ftest%2Fui%2Fconsts%2Fissue-52432.rs", "raw_url": "https://github.com/rust-lang/rust/raw/945458d4722c585775c4ad9ca2a22ae040879658/src%2Ftest%2Fui%2Fconsts%2Fissue-52432.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fissue-52432.rs?ref=945458d4722c585775c4ad9ca2a22ae040879658", "patch": "@@ -1,10 +0,0 @@\n-#![feature(const_raw_ptr_to_usize_cast)]\n-\n-fn main() {\n-    [(); &(static |x| {}) as *const _ as usize];\n-    //~^ ERROR: closures cannot be static\n-    //~| ERROR: type annotations needed\n-    [(); &(static || {}) as *const _ as usize];\n-    //~^ ERROR: closures cannot be static\n-    //~| ERROR evaluation of constant value failed\n-}"}, {"sha": "29998950552cd502c761a8b287a533c39ff4522a", "filename": "src/test/ui/consts/issue-52432.stderr", "status": "removed", "additions": 0, "deletions": 28, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/945458d4722c585775c4ad9ca2a22ae040879658/src%2Ftest%2Fui%2Fconsts%2Fissue-52432.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/945458d4722c585775c4ad9ca2a22ae040879658/src%2Ftest%2Fui%2Fconsts%2Fissue-52432.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fissue-52432.stderr?ref=945458d4722c585775c4ad9ca2a22ae040879658", "patch": "@@ -1,28 +0,0 @@\n-error[E0697]: closures cannot be static\n-  --> $DIR/issue-52432.rs:4:12\n-   |\n-LL |     [(); &(static |x| {}) as *const _ as usize];\n-   |            ^^^^^^^^^^\n-\n-error[E0697]: closures cannot be static\n-  --> $DIR/issue-52432.rs:7:12\n-   |\n-LL |     [(); &(static || {}) as *const _ as usize];\n-   |            ^^^^^^^^^\n-\n-error[E0282]: type annotations needed\n-  --> $DIR/issue-52432.rs:4:20\n-   |\n-LL |     [(); &(static |x| {}) as *const _ as usize];\n-   |                    ^ consider giving this closure parameter a type\n-\n-error[E0080]: evaluation of constant value failed\n-  --> $DIR/issue-52432.rs:7:10\n-   |\n-LL |     [(); &(static || {}) as *const _ as usize];\n-   |          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ cannot cast pointer to integer because it was not created by cast from integer\n-\n-error: aborting due to 4 previous errors\n-\n-Some errors have detailed explanations: E0080, E0282, E0697.\n-For more information about an error, try `rustc --explain E0080`."}, {"sha": "bb525d57197789ad5b1ebfbd6a370b00e155e848", "filename": "src/test/ui/consts/min_const_fn/min_const_fn.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_fn.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_fn.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_fn.rs?ref=ad2a0fc93f4d6fa89001bf482f6abd441e74ae28", "patch": "@@ -90,13 +90,13 @@ static BAR: u32 = 42;\n const fn foo25() -> u32 { BAR } //~ ERROR cannot refer to statics\n const fn foo26() -> &'static u32 { &BAR } //~ ERROR cannot refer to statics\n const fn foo30(x: *const u32) -> usize { x as usize }\n-//~^ ERROR casting pointers to integers\n+//~^ ERROR pointers cannot be cast to integers\n const fn foo30_with_unsafe(x: *const u32) -> usize { unsafe { x as usize } }\n-//~^ ERROR casting pointers to integers\n+//~^ ERROR pointers cannot be cast to integers\n const fn foo30_2(x: *mut u32) -> usize { x as usize }\n-//~^ ERROR casting pointers to integers\n+//~^ ERROR pointers cannot be cast to integers\n const fn foo30_2_with_unsafe(x: *mut u32) -> usize { unsafe { x as usize } }\n-//~^ ERROR casting pointers to integers\n+//~^ ERROR pointers cannot be cast to integers\n const fn foo30_6() -> bool { let x = true; x }\n const fn inc(x: &mut i32) { *x += 1 }\n //~^ ERROR mutable references"}, {"sha": "fcbf39d38690b5861ddd04d8d04b3eb9a35d7905", "filename": "src/test/ui/consts/min_const_fn/min_const_fn.stderr", "status": "modified", "additions": 12, "deletions": 12, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_fn.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_fn.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_fn.stderr?ref=ad2a0fc93f4d6fa89001bf482f6abd441e74ae28", "patch": "@@ -164,41 +164,41 @@ LL | const fn foo26() -> &'static u32 { &BAR }\n    |\n    = help: consider extracting the value of the `static` to a `const`, and referring to that\n \n-error[E0658]: casting pointers to integers in constant functions is unstable\n+error: pointers cannot be cast to integers during const eval.\n   --> $DIR/min_const_fn.rs:92:42\n    |\n LL | const fn foo30(x: *const u32) -> usize { x as usize }\n    |                                          ^^^^^^^^^^\n    |\n-   = note: see issue #51910 <https://github.com/rust-lang/rust/issues/51910> for more information\n-   = help: add `#![feature(const_raw_ptr_to_usize_cast)]` to the crate attributes to enable\n+   = note: at compile-time, pointers do not have an integer value\n+   = note: avoiding this restriction via `transmute`, `union`, or raw pointers leads to compile-time undefined behavior\n \n-error[E0658]: casting pointers to integers in constant functions is unstable\n+error: pointers cannot be cast to integers during const eval.\n   --> $DIR/min_const_fn.rs:94:63\n    |\n LL | const fn foo30_with_unsafe(x: *const u32) -> usize { unsafe { x as usize } }\n    |                                                               ^^^^^^^^^^\n    |\n-   = note: see issue #51910 <https://github.com/rust-lang/rust/issues/51910> for more information\n-   = help: add `#![feature(const_raw_ptr_to_usize_cast)]` to the crate attributes to enable\n+   = note: at compile-time, pointers do not have an integer value\n+   = note: avoiding this restriction via `transmute`, `union`, or raw pointers leads to compile-time undefined behavior\n \n-error[E0658]: casting pointers to integers in constant functions is unstable\n+error: pointers cannot be cast to integers during const eval.\n   --> $DIR/min_const_fn.rs:96:42\n    |\n LL | const fn foo30_2(x: *mut u32) -> usize { x as usize }\n    |                                          ^^^^^^^^^^\n    |\n-   = note: see issue #51910 <https://github.com/rust-lang/rust/issues/51910> for more information\n-   = help: add `#![feature(const_raw_ptr_to_usize_cast)]` to the crate attributes to enable\n+   = note: at compile-time, pointers do not have an integer value\n+   = note: avoiding this restriction via `transmute`, `union`, or raw pointers leads to compile-time undefined behavior\n \n-error[E0658]: casting pointers to integers in constant functions is unstable\n+error: pointers cannot be cast to integers during const eval.\n   --> $DIR/min_const_fn.rs:98:63\n    |\n LL | const fn foo30_2_with_unsafe(x: *mut u32) -> usize { unsafe { x as usize } }\n    |                                                               ^^^^^^^^^^\n    |\n-   = note: see issue #51910 <https://github.com/rust-lang/rust/issues/51910> for more information\n-   = help: add `#![feature(const_raw_ptr_to_usize_cast)]` to the crate attributes to enable\n+   = note: at compile-time, pointers do not have an integer value\n+   = note: avoiding this restriction via `transmute`, `union`, or raw pointers leads to compile-time undefined behavior\n \n error[E0658]: mutable references are not allowed in constant functions\n   --> $DIR/min_const_fn.rs:101:14"}, {"sha": "77355f0d7c994423a142ceeb4cf87963def7cbcd", "filename": "src/test/ui/issues/issue-18294.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28/src%2Ftest%2Fui%2Fissues%2Fissue-18294.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28/src%2Ftest%2Fui%2Fissues%2Fissue-18294.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-18294.rs?ref=ad2a0fc93f4d6fa89001bf482f6abd441e74ae28", "patch": "@@ -1,5 +1,5 @@\n fn main() {\n     const X: u32 = 1;\n-    const Y: usize = unsafe { &X as *const u32 as usize }; //~ ERROR is unstable\n+    const Y: usize = unsafe { &X as *const u32 as usize }; //~ ERROR pointers cannot be cast to integers\n     println!(\"{}\", Y);\n }"}, {"sha": "432e9a6518765d1e2848f8bc1003405d634a234b", "filename": "src/test/ui/issues/issue-18294.stderr", "status": "modified", "additions": 3, "deletions": 4, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28/src%2Ftest%2Fui%2Fissues%2Fissue-18294.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/ad2a0fc93f4d6fa89001bf482f6abd441e74ae28/src%2Ftest%2Fui%2Fissues%2Fissue-18294.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-18294.stderr?ref=ad2a0fc93f4d6fa89001bf482f6abd441e74ae28", "patch": "@@ -1,12 +1,11 @@\n-error[E0658]: casting pointers to integers in constants is unstable\n+error: pointers cannot be cast to integers during const eval.\n   --> $DIR/issue-18294.rs:3:31\n    |\n LL |     const Y: usize = unsafe { &X as *const u32 as usize };\n    |                               ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |\n-   = note: see issue #51910 <https://github.com/rust-lang/rust/issues/51910> for more information\n-   = help: add `#![feature(const_raw_ptr_to_usize_cast)]` to the crate attributes to enable\n+   = note: at compile-time, pointers do not have an integer value\n+   = note: avoiding this restriction via `transmute`, `union`, or raw pointers leads to compile-time undefined behavior\n \n error: aborting due to previous error\n \n-For more information about this error, try `rustc --explain E0658`."}]}