{"sha": "a995255cf5dfd053584198c10e86d7763e5dbc87", "node_id": "C_kwDOAAsO6NoAKGE5OTUyNTVjZjVkZmQwNTM1ODQxOThjMTBlODZkNzc2M2U1ZGJjODc", "commit": {"author": {"name": "Le\u00f3n Orell Valerian Liehr", "email": "me@fmease.dev", "date": "2023-06-10T12:56:08Z"}, "committer": {"name": "Le\u00f3n Orell Valerian Liehr", "email": "me@fmease.dev", "date": "2023-06-10T22:19:47Z"}, "message": "iat selection: normalize self ty & completely erase bound vars", "tree": {"sha": "26c7e5db29b0e94ff890ee6e18b6629cf56ac033", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/26c7e5db29b0e94ff890ee6e18b6629cf56ac033"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a995255cf5dfd053584198c10e86d7763e5dbc87", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEXSQFaHGAjVoD5I3F0XoHIV9o5xMFAmSE9wQACgkQ0XoHIV9o\n5xMWFxAAksfeUSBG0tnaRHPxS7MYJF3No9Pq4bb7fpnK2DiBnThukudPByLCy0Hk\niktP5eFBMOcgCEathIOQwX2blKPvjqc6A+KycZZk2lETDYzyriSgJ/7MSRZZsKRJ\nDJ72ytoxowzhP4PUbgEQo94u3K6RSrHojnqInlOcmynHtcUU/NvdqlZwlQbdsXQ4\niEb3HPXlz+Lm3R+Ee7NGfZySUwPMFw5HSzCL9c+hCSfrkt4nA5GIt7onzcQZhg3Y\nNWYk63tLQ4edJgQ8SOSTDfjz2w6wsQwA75E7umj1IdKMItVmHgIxTBC0PSEj+5Ip\n3Crdb5fmKpATNe8LaXCvTzdkQxADhDSBwDcVLtmI/SUvGOp5nnu5YJeu5dw8RET5\nkIWKDApxvz6pfUHh5hfBoiBp6EAnXgkEHBm/H8B9jrj8no8NdQv9JW1iMEo/ls/U\n3gSokWjmbxQZekmdcY6HTRtMhHcVIBeoi8g02ex8ybKfkVf9y9/HLPLN2Q27Zxp4\nDS7VQrLr5HGCm39LqMO1FUQCdx8MvhKQ4MCLZT0/sqlkTMpKOunCWhe/xrecvvdt\nnNCfXiwsKtLAsK76GmvZEy+Nk+cqTPAcAij6c+zcTOyj2zI4CNDoqVTrD3+S3hO8\nCIYMf7l/m59gt8JBu/jAMwbK8KDiMHwuw7AYYNEQt1RwYhfyfr0=\n=klMV\n-----END PGP SIGNATURE-----", "payload": "tree 26c7e5db29b0e94ff890ee6e18b6629cf56ac033\nparent 397641f3bd4f4211d0a1e9ada8d477bf495735b2\nauthor Le\u00f3n Orell Valerian Liehr <me@fmease.dev> 1686401768 +0200\ncommitter Le\u00f3n Orell Valerian Liehr <me@fmease.dev> 1686435587 +0200\n\niat selection: normalize self ty & completely erase bound vars\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a995255cf5dfd053584198c10e86d7763e5dbc87", "html_url": "https://github.com/rust-lang/rust/commit/a995255cf5dfd053584198c10e86d7763e5dbc87", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a995255cf5dfd053584198c10e86d7763e5dbc87/comments", "author": {"login": "fmease", "id": 14913065, "node_id": "MDQ6VXNlcjE0OTEzMDY1", "avatar_url": "https://avatars.githubusercontent.com/u/14913065?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fmease", "html_url": "https://github.com/fmease", "followers_url": "https://api.github.com/users/fmease/followers", "following_url": "https://api.github.com/users/fmease/following{/other_user}", "gists_url": "https://api.github.com/users/fmease/gists{/gist_id}", "starred_url": "https://api.github.com/users/fmease/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fmease/subscriptions", "organizations_url": "https://api.github.com/users/fmease/orgs", "repos_url": "https://api.github.com/users/fmease/repos", "events_url": "https://api.github.com/users/fmease/events{/privacy}", "received_events_url": "https://api.github.com/users/fmease/received_events", "type": "User", "site_admin": false}, "committer": {"login": "fmease", "id": 14913065, "node_id": "MDQ6VXNlcjE0OTEzMDY1", "avatar_url": "https://avatars.githubusercontent.com/u/14913065?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fmease", "html_url": "https://github.com/fmease", "followers_url": "https://api.github.com/users/fmease/followers", "following_url": "https://api.github.com/users/fmease/following{/other_user}", "gists_url": "https://api.github.com/users/fmease/gists{/gist_id}", "starred_url": "https://api.github.com/users/fmease/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fmease/subscriptions", "organizations_url": "https://api.github.com/users/fmease/orgs", "repos_url": "https://api.github.com/users/fmease/repos", "events_url": "https://api.github.com/users/fmease/events{/privacy}", "received_events_url": "https://api.github.com/users/fmease/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "397641f3bd4f4211d0a1e9ada8d477bf495735b2", "url": "https://api.github.com/repos/rust-lang/rust/commits/397641f3bd4f4211d0a1e9ada8d477bf495735b2", "html_url": "https://github.com/rust-lang/rust/commit/397641f3bd4f4211d0a1e9ada8d477bf495735b2"}], "stats": {"total": 111, "additions": 92, "deletions": 19}, "files": [{"sha": "1037a49acdf32efd6d72dfc1ef7868828fb32095", "filename": "compiler/rustc_hir_analysis/src/astconv/mod.rs", "status": "modified", "additions": 57, "deletions": 19, "changes": 76, "blob_url": "https://github.com/rust-lang/rust/blob/a995255cf5dfd053584198c10e86d7763e5dbc87/compiler%2Frustc_hir_analysis%2Fsrc%2Fastconv%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a995255cf5dfd053584198c10e86d7763e5dbc87/compiler%2Frustc_hir_analysis%2Fsrc%2Fastconv%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_analysis%2Fsrc%2Fastconv%2Fmod.rs?ref=a995255cf5dfd053584198c10e86d7763e5dbc87", "patch": "@@ -26,10 +26,9 @@ use rustc_hir::def::{CtorOf, DefKind, Namespace, Res};\n use rustc_hir::def_id::{DefId, LocalDefId};\n use rustc_hir::intravisit::{walk_generics, Visitor as _};\n use rustc_hir::{GenericArg, GenericArgs, OpaqueTyOrigin};\n-use rustc_infer::infer::{InferCtxt, TyCtxtInferExt};\n+use rustc_infer::infer::{InferCtxt, InferOk, TyCtxtInferExt};\n use rustc_infer::traits::ObligationCause;\n use rustc_middle::middle::stability::AllowUnstable;\n-use rustc_middle::ty::fold::FnMutDelegate;\n use rustc_middle::ty::subst::{self, GenericArgKind, InternalSubsts, SubstsRef};\n use rustc_middle::ty::GenericParamDefKind;\n use rustc_middle::ty::{self, Const, IsSuggestable, Ty, TyCtxt, TypeVisitableExt};\n@@ -43,7 +42,10 @@ use rustc_trait_selection::traits::error_reporting::{\n     report_object_safety_error, suggestions::NextTypeParamName,\n };\n use rustc_trait_selection::traits::wf::object_region_bounds;\n-use rustc_trait_selection::traits::{self, astconv_object_safety_violations, ObligationCtxt};\n+use rustc_trait_selection::traits::{\n+    self, astconv_object_safety_violations, NormalizeExt, ObligationCtxt,\n+};\n+use rustc_type_ir::fold::{TypeFoldable, TypeFolder, TypeSuperFoldable};\n \n use smallvec::{smallvec, SmallVec};\n use std::collections::BTreeSet;\n@@ -2442,6 +2444,11 @@ impl<'o, 'tcx> dyn AstConv<'tcx> + 'o {\n             return Ok(None);\n         }\n \n+        if !tcx.features().inherent_associated_types {\n+            tcx.sess\n+                .delay_span_bug(span, \"found inherent assoc type without the feature being gated\");\n+        }\n+\n         //\n         // Select applicable inherent associated type candidates modulo regions.\n         //\n@@ -2465,30 +2472,61 @@ impl<'o, 'tcx> dyn AstConv<'tcx> + 'o {\n \n         let mut fulfillment_errors = Vec::new();\n         let mut applicable_candidates: Vec<_> = infcx.probe(|_| {\n-            let universe = infcx.create_next_universe();\n-\n             // Regions are not considered during selection.\n-            // FIXME(non_lifetime_binders): Here we are \"truncating\" or \"flattening\" the universes\n-            // of type and const binders. Is that correct in the selection phase? See also #109505.\n-            let self_ty = tcx.replace_escaping_bound_vars_uncached(\n-                self_ty,\n-                FnMutDelegate {\n-                    regions: &mut |_| tcx.lifetimes.re_erased,\n-                    types: &mut |bv| {\n-                        tcx.mk_placeholder(ty::PlaceholderType { universe, bound: bv })\n-                    },\n-                    consts: &mut |bv, ty| {\n-                        tcx.mk_const(ty::PlaceholderConst { universe, bound: bv }, ty)\n-                    },\n-                },\n-            );\n+            let self_ty = self_ty\n+                .fold_with(&mut BoundVarEraser { tcx, universe: infcx.create_next_universe() });\n+\n+            struct BoundVarEraser<'tcx> {\n+                tcx: TyCtxt<'tcx>,\n+                universe: ty::UniverseIndex,\n+            }\n+\n+            // FIXME(non_lifetime_binders): Don't assign the same universe to each placeholder.\n+            impl<'tcx> TypeFolder<TyCtxt<'tcx>> for BoundVarEraser<'tcx> {\n+                fn interner(&self) -> TyCtxt<'tcx> {\n+                    self.tcx\n+                }\n+\n+                fn fold_region(&mut self, r: ty::Region<'tcx>) -> ty::Region<'tcx> {\n+                    if r.is_late_bound() { self.tcx.lifetimes.re_erased } else { r }\n+                }\n+\n+                fn fold_ty(&mut self, ty: Ty<'tcx>) -> Ty<'tcx> {\n+                    match *ty.kind() {\n+                        ty::Bound(_, bv) => self.tcx.mk_placeholder(ty::PlaceholderType {\n+                            universe: self.universe,\n+                            bound: bv,\n+                        }),\n+                        _ => ty.super_fold_with(self),\n+                    }\n+                }\n+\n+                fn fold_const(\n+                    &mut self,\n+                    ct: ty::Const<'tcx>,\n+                ) -> <TyCtxt<'tcx> as rustc_type_ir::Interner>::Const {\n+                    assert!(!ct.ty().has_escaping_bound_vars());\n+\n+                    match ct.kind() {\n+                        ty::ConstKind::Bound(_, bv) => self.tcx.mk_const(\n+                            ty::PlaceholderConst { universe: self.universe, bound: bv },\n+                            ct.ty(),\n+                        ),\n+                        _ => ct.super_fold_with(self),\n+                    }\n+                }\n+            }\n+\n+            let InferOk { value: self_ty, obligations } =\n+                infcx.at(&cause, param_env).normalize(self_ty);\n \n             candidates\n                 .iter()\n                 .copied()\n                 .filter(|&(impl_, _)| {\n                     infcx.probe(|_| {\n                         let ocx = ObligationCtxt::new_in_snapshot(&infcx);\n+                        ocx.register_obligations(obligations.clone());\n \n                         let impl_substs = infcx.fresh_substs_for_item(span, impl_);\n                         let impl_ty = tcx.type_of(impl_).subst(tcx, impl_substs);"}, {"sha": "1180577bd5421b8b4f5ab480471c25e24ee865c6", "filename": "tests/ui/associated-inherent-types/issue-111404-0.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/a995255cf5dfd053584198c10e86d7763e5dbc87/tests%2Fui%2Fassociated-inherent-types%2Fissue-111404-0.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a995255cf5dfd053584198c10e86d7763e5dbc87/tests%2Fui%2Fassociated-inherent-types%2Fissue-111404-0.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fassociated-inherent-types%2Fissue-111404-0.rs?ref=a995255cf5dfd053584198c10e86d7763e5dbc87", "patch": "@@ -0,0 +1,14 @@\n+// check-pass\n+\n+#![feature(inherent_associated_types)]\n+#![allow(incomplete_features)]\n+\n+struct Foo<T>(T);\n+\n+impl<'a> Foo<fn(&'a ())> {\n+    type Assoc = &'a ();\n+}\n+\n+fn bar(_: for<'a> fn(Foo<fn(Foo<fn(&'a ())>::Assoc)>::Assoc)) {}\n+\n+fn main() {}"}, {"sha": "f4ad5d7ff6c03703884e36ade4d1ae7853d637a2", "filename": "tests/ui/associated-inherent-types/issue-111404-1.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/a995255cf5dfd053584198c10e86d7763e5dbc87/tests%2Fui%2Fassociated-inherent-types%2Fissue-111404-1.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a995255cf5dfd053584198c10e86d7763e5dbc87/tests%2Fui%2Fassociated-inherent-types%2Fissue-111404-1.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fassociated-inherent-types%2Fissue-111404-1.rs?ref=a995255cf5dfd053584198c10e86d7763e5dbc87", "patch": "@@ -0,0 +1,13 @@\n+#![feature(inherent_associated_types)]\n+#![allow(incomplete_features)]\n+\n+struct Foo<T>(T);\n+\n+impl<'a> Foo<fn(&'a ())> {\n+    type Assoc = &'a ();\n+}\n+\n+fn bar(_: fn(Foo<for<'b> fn(Foo<fn(&'b ())>::Assoc)>::Assoc)) {}\n+//~^ ERROR higher-ranked subtype error\n+\n+fn main() {}"}, {"sha": "c55f1432389c786cb0b6c2a07ebcf43b6f38477f", "filename": "tests/ui/associated-inherent-types/issue-111404-1.stderr", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/a995255cf5dfd053584198c10e86d7763e5dbc87/tests%2Fui%2Fassociated-inherent-types%2Fissue-111404-1.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/a995255cf5dfd053584198c10e86d7763e5dbc87/tests%2Fui%2Fassociated-inherent-types%2Fissue-111404-1.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fassociated-inherent-types%2Fissue-111404-1.stderr?ref=a995255cf5dfd053584198c10e86d7763e5dbc87", "patch": "@@ -0,0 +1,8 @@\n+error: higher-ranked subtype error\n+  --> $DIR/issue-111404-1.rs:10:1\n+   |\n+LL | fn bar(_: fn(Foo<for<'b> fn(Foo<fn(&'b ())>::Assoc)>::Assoc)) {}\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: aborting due to previous error\n+"}]}