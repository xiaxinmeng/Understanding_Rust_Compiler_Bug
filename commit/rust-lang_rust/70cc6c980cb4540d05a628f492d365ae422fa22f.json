{"sha": "70cc6c980cb4540d05a628f492d365ae422fa22f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjcwY2M2Yzk4MGNiNDU0MGQwNWE2MjhmNDkyZDM2NWFlNDIyZmEyMmY=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2019-02-22T13:57:58Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-02-22T13:57:58Z"}, "message": "Rollup merge of #58064 - llogiq:vec-deque-try-rfold, r=scottmcm\n\noverride `VecDeque::try_rfold`, also update iterator\n\nThis keeps the slice based iteration and updates the iterator state after each slice. It also uses a loop to reduce the amount of code.\n\nThis uses unsafe code, so some thorough review would be appreciated. Cc @RalfJung", "tree": {"sha": "4156d0969c9f943778c91bca6930356fec70bc72", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4156d0969c9f943778c91bca6930356fec70bc72"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/70cc6c980cb4540d05a628f492d365ae422fa22f", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJcb//mCRBK7hj4Ov3rIwAAdHIIAC9fY7yIKTHMgw9zfa63lhDx\n9DEnp0H6J056a1Yl4zj+2LlyKCLSJRwbLZcQtm99P254GKF5XS+/uap00seZm8qb\nEsFOgY0tsqznjPFsZwxVWxmSDN4m2LW0ftv6LsbebosTagluOTe4m8sOtkeG3alD\nr7xDYVuhAr4LL2GUhNvYlMKCcpTb5PkU8cTFilQwvIfZfRrUXs09EHX4/rTd7SP0\niCc92iIo+uX9sNEb04HVkjiOSJkvDe08B8QTaCUabC7/5KaCJby/+G+bhaxAz396\n1pEwjmJE8i3NIQqoQzwh68mDSFqObOINvXFb/d3FU3hCmAdY5EYR/YlbTsX4n88=\n=3JGW\n-----END PGP SIGNATURE-----\n", "payload": "tree 4156d0969c9f943778c91bca6930356fec70bc72\nparent ec8ef1836af5dbc8df91989de4ae6a9bd6664178\nparent 64c915e3ade66d3335c445eed89509dc41502c13\nauthor Mazdak Farrokhzad <twingoow@gmail.com> 1550843878 +0100\ncommitter GitHub <noreply@github.com> 1550843878 +0100\n\nRollup merge of #58064 - llogiq:vec-deque-try-rfold, r=scottmcm\n\noverride `VecDeque::try_rfold`, also update iterator\n\nThis keeps the slice based iteration and updates the iterator state after each slice. It also uses a loop to reduce the amount of code.\n\nThis uses unsafe code, so some thorough review would be appreciated. Cc @RalfJung\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/70cc6c980cb4540d05a628f492d365ae422fa22f", "html_url": "https://github.com/rust-lang/rust/commit/70cc6c980cb4540d05a628f492d365ae422fa22f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/70cc6c980cb4540d05a628f492d365ae422fa22f/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ec8ef1836af5dbc8df91989de4ae6a9bd6664178", "url": "https://api.github.com/repos/rust-lang/rust/commits/ec8ef1836af5dbc8df91989de4ae6a9bd6664178", "html_url": "https://github.com/rust-lang/rust/commit/ec8ef1836af5dbc8df91989de4ae6a9bd6664178"}, {"sha": "64c915e3ade66d3335c445eed89509dc41502c13", "url": "https://api.github.com/repos/rust-lang/rust/commits/64c915e3ade66d3335c445eed89509dc41502c13", "html_url": "https://github.com/rust-lang/rust/commit/64c915e3ade66d3335c445eed89509dc41502c13"}], "stats": {"total": 122, "additions": 117, "deletions": 5}, "files": [{"sha": "7d2d3cfa61225d64c9544d37e0f65564b7d10942", "filename": "src/liballoc/benches/vec_deque.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/70cc6c980cb4540d05a628f492d365ae422fa22f/src%2Fliballoc%2Fbenches%2Fvec_deque.rs", "raw_url": "https://github.com/rust-lang/rust/raw/70cc6c980cb4540d05a628f492d365ae422fa22f/src%2Fliballoc%2Fbenches%2Fvec_deque.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fliballoc%2Fbenches%2Fvec_deque.rs?ref=70cc6c980cb4540d05a628f492d365ae422fa22f", "patch": "@@ -45,3 +45,10 @@ fn bench_mut_iter_1000(b: &mut Bencher) {\n         black_box(sum);\n     })\n }\n+\n+#[bench]\n+fn bench_try_fold(b: &mut Bencher) {\n+    let ring: VecDeque<_> = (0..1000).collect();\n+\n+    b.iter(|| black_box(ring.iter().try_fold(0, |a, b| Some(a + b))))\n+}"}, {"sha": "4e90f783ec6a596cec9403518d260cb4b44b98cd", "filename": "src/liballoc/collections/vec_deque.rs", "status": "modified", "additions": 46, "deletions": 5, "changes": 51, "blob_url": "https://github.com/rust-lang/rust/blob/70cc6c980cb4540d05a628f492d365ae422fa22f/src%2Fliballoc%2Fcollections%2Fvec_deque.rs", "raw_url": "https://github.com/rust-lang/rust/raw/70cc6c980cb4540d05a628f492d365ae422fa22f/src%2Fliballoc%2Fcollections%2Fvec_deque.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fliballoc%2Fcollections%2Fvec_deque.rs?ref=70cc6c980cb4540d05a628f492d365ae422fa22f", "patch": "@@ -2170,12 +2170,29 @@ impl<'a, T> Iterator for Iter<'a, T> {\n         back.iter().fold(accum, &mut f)\n     }\n \n-    fn try_fold<B, F, R>(&mut self, init: B, mut f: F) -> R where\n-        Self: Sized, F: FnMut(B, Self::Item) -> R, R: Try<Ok=B>\n+    fn try_fold<B, F, R>(&mut self, init: B, mut f: F) -> R\n+    where\n+        Self: Sized,\n+        F: FnMut(B, Self::Item) -> R,\n+        R: Try<Ok = B>,\n     {\n-        let (front, back) = RingSlices::ring_slices(self.ring, self.head, self.tail);\n-        let accum = front.iter().try_fold(init, &mut f)?;\n-        back.iter().try_fold(accum, &mut f)\n+        let (mut iter, final_res);\n+        if self.tail <= self.head {\n+            // single slice self.ring[self.tail..self.head]\n+            iter = self.ring[self.tail..self.head].iter();\n+            final_res = iter.try_fold(init, &mut f);\n+        } else {\n+            // two slices: self.ring[self.tail..], self.ring[..self.head]\n+            let (front, back) = self.ring.split_at(self.tail);\n+            let mut back_iter = back.iter();\n+            let res = back_iter.try_fold(init, &mut f);\n+            let len = self.ring.len();\n+            self.tail = (self.ring.len() - back_iter.len()) & (len - 1);\n+            iter = front[..self.head].iter();\n+            final_res = iter.try_fold(res?, &mut f);\n+        }\n+        self.tail = self.head - iter.len();\n+        final_res\n     }\n }\n \n@@ -2197,6 +2214,30 @@ impl<'a, T> DoubleEndedIterator for Iter<'a, T> {\n         accum = back.iter().rfold(accum, &mut f);\n         front.iter().rfold(accum, &mut f)\n     }\n+\n+    fn try_rfold<B, F, R>(&mut self, init: B, mut f: F) -> R\n+    where\n+        Self: Sized,\n+        F: FnMut(B, Self::Item) -> R,\n+        R: Try<Ok = B>,\n+    {\n+        let (mut iter, final_res);\n+        if self.tail <= self.head {\n+            // single slice self.ring[self.tail..self.head]\n+            iter = self.ring[self.tail..self.head].iter();\n+            final_res = iter.try_rfold(init, &mut f);\n+        } else {\n+            // two slices: self.ring[self.tail..], self.ring[..self.head]\n+            let (front, back) = self.ring.split_at(self.tail);\n+            let mut front_iter = front[..self.head].iter();\n+            let res = front_iter.try_rfold(init, &mut f);\n+            self.head = front_iter.len();\n+            iter = back.iter();\n+            final_res = iter.try_rfold(res?, &mut f);\n+        }\n+        self.head = self.tail + iter.len();\n+        final_res\n+    }\n }\n \n #[stable(feature = \"rust1\", since = \"1.0.0\")]"}, {"sha": "16ddc1444fcf90ae04d6b69b33b34a36989b2c27", "filename": "src/liballoc/tests/vec_deque.rs", "status": "modified", "additions": 64, "deletions": 0, "changes": 64, "blob_url": "https://github.com/rust-lang/rust/blob/70cc6c980cb4540d05a628f492d365ae422fa22f/src%2Fliballoc%2Ftests%2Fvec_deque.rs", "raw_url": "https://github.com/rust-lang/rust/raw/70cc6c980cb4540d05a628f492d365ae422fa22f/src%2Fliballoc%2Ftests%2Fvec_deque.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fliballoc%2Ftests%2Fvec_deque.rs?ref=70cc6c980cb4540d05a628f492d365ae422fa22f", "patch": "@@ -1465,6 +1465,15 @@ fn test_try_fold_unit() {\n     assert_eq!(Some(()), v.into_iter().try_fold((), |(), ()| Some(())));\n }\n \n+\n+#[test]\n+fn test_try_fold_unit_none() {\n+    let v: std::collections::VecDeque<()> = [(); 10].iter().cloned().collect();\n+    let mut iter = v.into_iter();\n+    assert!(iter.try_fold((), |_, _| None).is_none());\n+    assert_eq!(iter.len(), 9);\n+}\n+\n #[test]\n fn test_try_fold_rotated() {\n     let mut v: VecDeque<_> = (0..12).collect();\n@@ -1477,3 +1486,58 @@ fn test_try_fold_rotated() {\n         assert_eq!(Ok::<_, ()>(66), v.iter().try_fold(0, |a, b| Ok(a + b)));\n     }\n }\n+\n+#[test]\n+fn test_try_fold_moves_iter() {\n+    let v: VecDeque<_> = [10, 20, 30, 40, 100, 60, 70, 80, 90].iter().collect();\n+    let mut iter = v.into_iter();\n+    assert_eq!(iter.try_fold(0_i8, |acc, &x| acc.checked_add(x)), None);\n+    assert_eq!(iter.next(), Some(&60));\n+}\n+\n+#[test]\n+fn test_try_fold_exhaust_wrap() {\n+    let mut v = VecDeque::with_capacity(7);\n+    v.push_back(1);\n+    v.push_back(1);\n+    v.push_back(1);\n+    v.pop_front();\n+    v.pop_front();\n+    let mut iter = v.iter();\n+    let _ = iter.try_fold(0, |_, _| Some(1));\n+    assert!(iter.is_empty());\n+}\n+\n+#[test]\n+fn test_try_fold_wraparound() {\n+    let mut v = VecDeque::with_capacity(8);\n+    v.push_back(7);\n+    v.push_back(8);\n+    v.push_back(9);\n+    v.push_front(2);\n+    v.push_front(1);\n+    let mut iter = v.iter();\n+    let _ = iter.find(|&&x| x == 2);\n+    assert_eq!(Some(&7), iter.next());\n+}\n+\n+#[test]\n+fn test_try_rfold_rotated() {\n+    let mut v: VecDeque<_> = (0..12).collect();\n+    for n in 0..10 {\n+        if n & 1 == 0 {\n+            v.rotate_left(n);\n+        } else {\n+            v.rotate_right(n);\n+        }\n+        assert_eq!(Ok::<_, ()>(66), v.iter().try_rfold(0, |a, b| Ok(a + b)));\n+    }\n+}\n+\n+#[test]\n+fn test_try_rfold_moves_iter() {\n+    let v : VecDeque<_> = [10, 20, 30, 40, 100, 60, 70, 80, 90].iter().collect();\n+    let mut iter = v.into_iter();\n+    assert_eq!(iter.try_rfold(0_i8, |acc, &x| acc.checked_add(x)), None);\n+    assert_eq!(iter.next_back(), Some(&70));\n+}"}]}