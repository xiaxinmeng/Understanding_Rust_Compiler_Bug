{"sha": "0da4c44190d657e7c28f077f99b2fa03f06e1649", "node_id": "C_kwDOAAsO6NoAKDBkYTRjNDQxOTBkNjU3ZTdjMjhmMDc3Zjk5YjJmYTAzZjA2ZTE2NDk", "commit": {"author": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2022-11-16T03:43:33Z"}, "committer": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2022-11-23T20:17:48Z"}, "message": "Account for closures", "tree": {"sha": "408a09ca975ef32765528ff9b1df254e3e868b67", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/408a09ca975ef32765528ff9b1df254e3e868b67"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0da4c44190d657e7c28f077f99b2fa03f06e1649", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0da4c44190d657e7c28f077f99b2fa03f06e1649", "html_url": "https://github.com/rust-lang/rust/commit/0da4c44190d657e7c28f077f99b2fa03f06e1649", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0da4c44190d657e7c28f077f99b2fa03f06e1649/comments", "author": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "committer": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3a471b5fd8dcf4444be200b41925396a90a2188a", "url": "https://api.github.com/repos/rust-lang/rust/commits/3a471b5fd8dcf4444be200b41925396a90a2188a", "html_url": "https://github.com/rust-lang/rust/commit/3a471b5fd8dcf4444be200b41925396a90a2188a"}], "stats": {"total": 33, "additions": 9, "deletions": 24}, "files": [{"sha": "04bf4e04736fdda5b9986deab4870eba389ea1e3", "filename": "compiler/rustc_borrowck/src/diagnostics/conflict_errors.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/0da4c44190d657e7c28f077f99b2fa03f06e1649/compiler%2Frustc_borrowck%2Fsrc%2Fdiagnostics%2Fconflict_errors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0da4c44190d657e7c28f077f99b2fa03f06e1649/compiler%2Frustc_borrowck%2Fsrc%2Fdiagnostics%2Fconflict_errors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_borrowck%2Fsrc%2Fdiagnostics%2Fconflict_errors.rs?ref=0da4c44190d657e7c28f077f99b2fa03f06e1649", "patch": "@@ -167,7 +167,7 @@ impl<'cx, 'tcx> MirBorrowckCtxt<'cx, 'tcx> {\n                 );\n             }\n \n-            self.add_moved_or_invoked_closure_note(location, used_place, &mut err);\n+            let closure = self.add_moved_or_invoked_closure_note(location, used_place, &mut err);\n \n             let mut is_loop_move = false;\n             let mut in_pattern = false;\n@@ -193,7 +193,9 @@ impl<'cx, 'tcx> MirBorrowckCtxt<'cx, 'tcx> {\n                 }\n \n                 if !seen_spans.contains(&move_span) {\n-                    self.suggest_ref_or_clone(mpi, move_span, &mut err, &mut in_pattern);\n+                    if !closure {\n+                        self.suggest_ref_or_clone(mpi, move_span, &mut err, &mut in_pattern);\n+                    }\n \n                     self.explain_captures(\n                         &mut err,"}, {"sha": "c500cbc49e4a3700e69b7421976d8708867bfb93", "filename": "compiler/rustc_borrowck/src/diagnostics/mod.rs", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/0da4c44190d657e7c28f077f99b2fa03f06e1649/compiler%2Frustc_borrowck%2Fsrc%2Fdiagnostics%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0da4c44190d657e7c28f077f99b2fa03f06e1649/compiler%2Frustc_borrowck%2Fsrc%2Fdiagnostics%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_borrowck%2Fsrc%2Fdiagnostics%2Fmod.rs?ref=0da4c44190d657e7c28f077f99b2fa03f06e1649", "patch": "@@ -70,7 +70,7 @@ impl<'cx, 'tcx> MirBorrowckCtxt<'cx, 'tcx> {\n         location: Location,\n         place: PlaceRef<'tcx>,\n         diag: &mut Diagnostic,\n-    ) {\n+    ) -> bool {\n         debug!(\"add_moved_or_invoked_closure_note: location={:?} place={:?}\", location, place);\n         let mut target = place.local_or_deref_local();\n         for stmt in &self.body[location.block].statements[location.statement_index..] {\n@@ -106,7 +106,7 @@ impl<'cx, 'tcx> MirBorrowckCtxt<'cx, 'tcx> {\n                         {\n                             place.local_or_deref_local().unwrap()\n                         }\n-                        _ => return,\n+                        _ => return false,\n                     };\n \n                     debug!(\"add_moved_or_invoked_closure_note: closure={:?}\", closure);\n@@ -125,7 +125,7 @@ impl<'cx, 'tcx> MirBorrowckCtxt<'cx, 'tcx> {\n                                     ty::place_to_string_for_capture(self.infcx.tcx, hir_place)\n                                 ),\n                             );\n-                            return;\n+                            return true;\n                         }\n                     }\n                 }\n@@ -149,9 +149,11 @@ impl<'cx, 'tcx> MirBorrowckCtxt<'cx, 'tcx> {\n                             ty::place_to_string_for_capture(self.infcx.tcx, hir_place)\n                         ),\n                     );\n+                    return true;\n                 }\n             }\n         }\n+        false\n     }\n \n     /// End-user visible description of `place` if one can be found."}, {"sha": "896bb6dc6bee8a8cfca5c73ef4d84479b85f5bc6", "filename": "src/test/ui/closure_context/issue-42065.stderr", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/0da4c44190d657e7c28f077f99b2fa03f06e1649/src%2Ftest%2Fui%2Fclosure_context%2Fissue-42065.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/0da4c44190d657e7c28f077f99b2fa03f06e1649/src%2Ftest%2Fui%2Fclosure_context%2Fissue-42065.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fclosure_context%2Fissue-42065.stderr?ref=0da4c44190d657e7c28f077f99b2fa03f06e1649", "patch": "@@ -16,10 +16,6 @@ note: this value implements `FnOnce`, which causes it to be moved when called\n    |\n LL |     debug_dump_dict();\n    |     ^^^^^^^^^^^^^^^\n-help: consider cloning the value if the performance cost is acceptable\n-   |\n-LL |     debug_dump_dict.clone()();\n-   |                    ++++++++\n \n error: aborting due to previous error\n "}, {"sha": "9a84ddef7e64e88be01eda170acc9d6db34ccf9b", "filename": "src/test/ui/moves/borrow-closures-instead-of-move.stderr", "status": "modified", "additions": 0, "deletions": 7, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/0da4c44190d657e7c28f077f99b2fa03f06e1649/src%2Ftest%2Fui%2Fmoves%2Fborrow-closures-instead-of-move.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/0da4c44190d657e7c28f077f99b2fa03f06e1649/src%2Ftest%2Fui%2Fmoves%2Fborrow-closures-instead-of-move.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmoves%2Fborrow-closures-instead-of-move.stderr?ref=0da4c44190d657e7c28f077f99b2fa03f06e1649", "patch": "@@ -58,13 +58,6 @@ note: closure cannot be moved more than once as it is not `Copy` due to moving t\n    |\n LL |         x += 1;\n    |         ^\n-note: consider changing this parameter type in function `takes_fnonce` to borrow instead if owning the value isn't necessary\n-  --> $DIR/borrow-closures-instead-of-move.rs:34:20\n-   |\n-LL | fn takes_fnonce(_: impl FnOnce()) {}\n-   |    ------------    ^^^^^^^^^^^^^ this parameter takes ownership of the value\n-   |    |\n-   |    in this function\n help: consider mutably borrowing `closure`\n    |\n LL |     takes_fnonce(&mut closure);"}, {"sha": "ab6f06518467c9bacaa471e69fb0562f96a987b9", "filename": "src/test/ui/unboxed-closures/unboxed-closures-infer-fnonce-call-twice.stderr", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/0da4c44190d657e7c28f077f99b2fa03f06e1649/src%2Ftest%2Fui%2Funboxed-closures%2Funboxed-closures-infer-fnonce-call-twice.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/0da4c44190d657e7c28f077f99b2fa03f06e1649/src%2Ftest%2Fui%2Funboxed-closures%2Funboxed-closures-infer-fnonce-call-twice.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Funboxed-closures%2Funboxed-closures-infer-fnonce-call-twice.stderr?ref=0da4c44190d657e7c28f077f99b2fa03f06e1649", "patch": "@@ -16,10 +16,6 @@ note: this value implements `FnOnce`, which causes it to be moved when called\n    |\n LL |     tick();\n    |     ^^^^\n-help: consider cloning the value if the performance cost is acceptable\n-   |\n-LL |     tick.clone()();\n-   |         ++++++++\n \n error: aborting due to previous error\n "}, {"sha": "8d70a2b17602b1508e8018239048f850a07bf7a2", "filename": "src/test/ui/unboxed-closures/unboxed-closures-infer-fnonce-move-call-twice.stderr", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/0da4c44190d657e7c28f077f99b2fa03f06e1649/src%2Ftest%2Fui%2Funboxed-closures%2Funboxed-closures-infer-fnonce-move-call-twice.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/0da4c44190d657e7c28f077f99b2fa03f06e1649/src%2Ftest%2Fui%2Funboxed-closures%2Funboxed-closures-infer-fnonce-move-call-twice.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Funboxed-closures%2Funboxed-closures-infer-fnonce-move-call-twice.stderr?ref=0da4c44190d657e7c28f077f99b2fa03f06e1649", "patch": "@@ -16,10 +16,6 @@ note: this value implements `FnOnce`, which causes it to be moved when called\n    |\n LL |     tick();\n    |     ^^^^\n-help: consider cloning the value if the performance cost is acceptable\n-   |\n-LL |     tick.clone()();\n-   |         ++++++++\n \n error: aborting due to previous error\n "}]}