{"sha": "e4e032a0ae82d7db4f99872ff98626af2941c4a5", "node_id": "MDY6Q29tbWl0NzI0NzEyOmU0ZTAzMmEwYWU4MmQ3ZGI0Zjk5ODcyZmY5ODYyNmFmMjk0MWM0YTU=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-04-17T07:05:39Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-04-17T07:05:39Z"}, "message": "Auto merge of #60027 - jethrogb:jb/sgx-reentry-abort, r=cramertj\n\nSGX target: change re-entry abort logic\n\nEven though re-entry after exit is generally not acceptable, there is a race condition where the enclave thinks it's exited but userspace doesn't know that yet. An entry during that time will currently result in an enclave panic (see https://github.com/rust-lang/rust/pull/59997#issuecomment-483846291, https://github.com/rust-lang/rust/pull/60003#issuecomment-483888170). Instead of panicking, just do a regular exit on re-entry.\n\ncc @jseyfried", "tree": {"sha": "876205f9cdce195a39e701740bda7b18b047d44f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/876205f9cdce195a39e701740bda7b18b047d44f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e4e032a0ae82d7db4f99872ff98626af2941c4a5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e4e032a0ae82d7db4f99872ff98626af2941c4a5", "html_url": "https://github.com/rust-lang/rust/commit/e4e032a0ae82d7db4f99872ff98626af2941c4a5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e4e032a0ae82d7db4f99872ff98626af2941c4a5/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "258e3b3a75a0da006cd492307fc46ef605e774ad", "url": "https://api.github.com/repos/rust-lang/rust/commits/258e3b3a75a0da006cd492307fc46ef605e774ad", "html_url": "https://github.com/rust-lang/rust/commit/258e3b3a75a0da006cd492307fc46ef605e774ad"}, {"sha": "d0a1c2d3e0ac91849882693720cb81b5da533439", "url": "https://api.github.com/repos/rust-lang/rust/commits/d0a1c2d3e0ac91849882693720cb81b5da533439", "html_url": "https://github.com/rust-lang/rust/commit/d0a1c2d3e0ac91849882693720cb81b5da533439"}], "stats": {"total": 30, "additions": 11, "deletions": 19}, "files": [{"sha": "c35e49b1dc6ea2453ca1f13fbec730963e76cb7b", "filename": "src/libstd/sys/sgx/abi/entry.S", "status": "modified", "additions": 3, "deletions": 11, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/e4e032a0ae82d7db4f99872ff98626af2941c4a5/src%2Flibstd%2Fsys%2Fsgx%2Fabi%2Fentry.S", "raw_url": "https://github.com/rust-lang/rust/raw/e4e032a0ae82d7db4f99872ff98626af2941c4a5/src%2Flibstd%2Fsys%2Fsgx%2Fabi%2Fentry.S", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Fsgx%2Fabi%2Fentry.S?ref=e4e032a0ae82d7db4f99872ff98626af2941c4a5", "patch": "@@ -65,10 +65,6 @@ IMAGE_BASE:\n     /*  The size in bytes of enclacve EH_FRM_HDR section */\n     globvar EH_FRM_HDR_SIZE 8\n \n-.Lreentry_panic_msg:\n-    .asciz \"Re-entered aborted enclave!\"\n-.Lreentry_panic_msg_end:\n-\n .org .Lxsave_clear+512\n .Lxsave_header:\n     .int 0, 0 /*  XSTATE_BV */\n@@ -210,10 +206,8 @@ sgx_entry:\n /*  end sgx_entry */\n \n .Lreentry_panic:\n-    lea .Lreentry_panic_msg(%rip),%rdi\n-    mov $.Lreentry_panic_msg_end-.Lreentry_panic_msg,%esi\n     orq $8,%rsp\n-    jmp panic_msg\n+    jmp abort_reentry\n \n /*  This *MUST* be called with 6 parameters, otherwise register information */\n /*  might leak! */\n@@ -279,10 +273,8 @@ usercall:\n /*\n The following functions need to be defined externally:\n ```\n-// Called by entry code when it needs to panic\n-extern \"C\" fn panic_msg(msg: &'static str) -> ! {\n-    panic!(msg)\n-}\n+// Called by entry code on re-entry after exit\n+extern \"C\" fn abort_reentry() -> !;\n \n // Called once when a TCS is first entered\n extern \"C\" fn tcs_init(secondary: bool);"}, {"sha": "0f107de83f062c76fbea80edeb6ede41429ee79f", "filename": "src/libstd/sys/sgx/abi/mod.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/e4e032a0ae82d7db4f99872ff98626af2941c4a5/src%2Flibstd%2Fsys%2Fsgx%2Fabi%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e4e032a0ae82d7db4f99872ff98626af2941c4a5/src%2Flibstd%2Fsys%2Fsgx%2Fabi%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Fsgx%2Fabi%2Fmod.rs?ref=e4e032a0ae82d7db4f99872ff98626af2941c4a5", "patch": "@@ -29,7 +29,7 @@ unsafe extern \"C\" fn tcs_init(secondary: bool) {\n     static RELOC_STATE: AtomicUsize = AtomicUsize::new(UNINIT);\n \n     if secondary && RELOC_STATE.load(Ordering::Relaxed) != DONE {\n-        panic::panic_msg(\"Entered secondary TCS before main TCS!\")\n+        rtabort!(\"Entered secondary TCS before main TCS!\")\n     }\n \n     // Try to atomically swap UNINIT with BUSY. The returned state can be:\n@@ -92,3 +92,9 @@ pub(super) fn exit_with_code(code: isize) -> ! {\n     }\n     usercalls::exit(code != 0);\n }\n+\n+#[cfg(not(test))]\n+#[no_mangle]\n+extern \"C\" fn abort_reentry() -> ! {\n+    usercalls::exit(false)\n+}"}, {"sha": "2401476716f4faf3dbef58d1cb0b50828b1f75ca", "filename": "src/libstd/sys/sgx/abi/panic.rs", "status": "modified", "additions": 1, "deletions": 7, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/e4e032a0ae82d7db4f99872ff98626af2941c4a5/src%2Flibstd%2Fsys%2Fsgx%2Fabi%2Fpanic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e4e032a0ae82d7db4f99872ff98626af2941c4a5/src%2Flibstd%2Fsys%2Fsgx%2Fabi%2Fpanic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Fsgx%2Fabi%2Fpanic.rs?ref=e4e032a0ae82d7db4f99872ff98626af2941c4a5", "patch": "@@ -1,4 +1,4 @@\n-use super::usercalls::{alloc::UserRef, self};\n+use super::usercalls::alloc::UserRef;\n use crate::cmp;\n use crate::io::{self, Write};\n use crate::mem;\n@@ -48,9 +48,3 @@ impl Write for SgxPanicOutput {\n         Ok(())\n     }\n }\n-\n-#[cfg_attr(not(test), no_mangle)]\n-pub extern \"C\" fn panic_msg(msg: &str) -> ! {\n-    let _ = SgxPanicOutput::new().map(|mut out| out.write(msg.as_bytes()));\n-    usercalls::exit(true)\n-}"}]}