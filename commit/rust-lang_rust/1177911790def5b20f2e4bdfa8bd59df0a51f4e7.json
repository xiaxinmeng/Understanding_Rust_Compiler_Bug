{"sha": "1177911790def5b20f2e4bdfa8bd59df0a51f4e7", "node_id": "MDY6Q29tbWl0NzI0NzEyOjExNzc5MTE3OTBkZWY1YjIwZjJlNGJkZmE4YmQ1OWRmMGE1MWY0ZTc=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-08-22T11:15:10Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-08-22T11:15:10Z"}, "message": "Auto merge of #44008 - RalfJung:staged1, r=alexcrichton\n\nMake sure crates not opting in to staged_api don't use staged_api\n\nThis also fixes the problem that with `-Zforce-unstable-if-unmarked` set, crates could not use `#[deprecated]`.\n\nIf you prefer, I can instead submit another version which just fixes this problem, but still allows the staged API attributes for all crates when  `-Zforce-unstable-if-unmarked` is set. I have prepared that at <https://github.com/RalfJung/rust/tree/staged2>. As yet another alternative, @alexcrichton suggested to turn this error into a lint, but that seems to be much more work, so is it worth it?\n\nCc @alexcrichton #43975", "tree": {"sha": "98d605deb5c901a8fd27f8ffbba93b8b497ff0b3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/98d605deb5c901a8fd27f8ffbba93b8b497ff0b3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1177911790def5b20f2e4bdfa8bd59df0a51f4e7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1177911790def5b20f2e4bdfa8bd59df0a51f4e7", "html_url": "https://github.com/rust-lang/rust/commit/1177911790def5b20f2e4bdfa8bd59df0a51f4e7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1177911790def5b20f2e4bdfa8bd59df0a51f4e7/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7e5578da8c76fafcb1d7ca9f0643127da76f0879", "url": "https://api.github.com/repos/rust-lang/rust/commits/7e5578da8c76fafcb1d7ca9f0643127da76f0879", "html_url": "https://github.com/rust-lang/rust/commit/7e5578da8c76fafcb1d7ca9f0643127da76f0879"}, {"sha": "472e7e3ee22993d7dd64bdba21304334e0e977c9", "url": "https://api.github.com/repos/rust-lang/rust/commits/472e7e3ee22993d7dd64bdba21304334e0e977c9", "html_url": "https://github.com/rust-lang/rust/commit/472e7e3ee22993d7dd64bdba21304334e0e977c9"}], "stats": {"total": 44, "additions": 43, "deletions": 1}, "files": [{"sha": "d2ed29a3a0ff636c3d778b9ed9c26e81e62c85f6", "filename": "src/librustc/middle/stability.rs", "status": "modified", "additions": 11, "deletions": 1, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/1177911790def5b20f2e4bdfa8bd59df0a51f4e7/src%2Flibrustc%2Fmiddle%2Fstability.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1177911790def5b20f2e4bdfa8bd59df0a51f4e7/src%2Flibrustc%2Fmiddle%2Fstability.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fstability.rs?ref=1177911790def5b20f2e4bdfa8bd59df0a51f4e7", "patch": "@@ -123,7 +123,8 @@ impl<'a, 'tcx: 'a> Annotator<'a, 'tcx> {\n                    item_sp: Span, kind: AnnotationKind, visit_children: F)\n         where F: FnOnce(&mut Self)\n     {\n-        if self.index.staged_api[&LOCAL_CRATE] {\n+        if self.tcx.sess.features.borrow().staged_api {\n+            // This crate explicitly wants staged API.\n             debug!(\"annotate(id = {:?}, attrs = {:?})\", id, attrs);\n             if let Some(..) = attr::find_deprecation(self.tcx.sess.diagnostic(), attrs, item_sp) {\n                 self.tcx.sess.span_err(item_sp, \"`#[deprecated]` cannot be used in staged api, \\\n@@ -204,6 +205,15 @@ impl<'a, 'tcx: 'a> Annotator<'a, 'tcx> {\n                 }\n             }\n \n+            // Propagate unstability.  This can happen even for non-staged-api crates in case\n+            // -Zforce-unstable-if-unmarked is set.\n+            if let Some(stab) = self.parent_stab {\n+                if stab.level.is_unstable() {\n+                    let def_id = self.tcx.hir.local_def_id(id);\n+                    self.index.stab_map.insert(def_id, Some(stab));\n+                }\n+            }\n+\n             if let Some(depr) = attr::find_deprecation(self.tcx.sess.diagnostic(), attrs, item_sp) {\n                 if kind == AnnotationKind::Prohibited {\n                     self.tcx.sess.span_err(item_sp, \"This deprecation annotation is useless\");"}, {"sha": "602b71dca05aba92af522e92c4a7fd160531b79b", "filename": "src/librustc_plugin/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/1177911790def5b20f2e4bdfa8bd59df0a51f4e7/src%2Flibrustc_plugin%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1177911790def5b20f2e4bdfa8bd59df0a51f4e7/src%2Flibrustc_plugin%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_plugin%2Flib.rs?ref=1177911790def5b20f2e4bdfa8bd59df0a51f4e7", "patch": "@@ -69,6 +69,7 @@\n #![deny(warnings)]\n \n #![feature(rustc_diagnostic_macros)]\n+#![feature(staged_api)]\n \n #[macro_use] extern crate syntax;\n "}, {"sha": "5e34688f8cb8f0e7ffc6997cee5aa353bf728843", "filename": "src/libtest/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/1177911790def5b20f2e4bdfa8bd59df0a51f4e7/src%2Flibtest%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1177911790def5b20f2e4bdfa8bd59df0a51f4e7/src%2Flibtest%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibtest%2Flib.rs?ref=1177911790def5b20f2e4bdfa8bd59df0a51f4e7", "patch": "@@ -37,6 +37,7 @@\n #![feature(libc)]\n #![feature(set_stdio)]\n #![feature(panic_unwind)]\n+#![feature(staged_api)]\n \n extern crate getopts;\n extern crate term;"}, {"sha": "512fb24a0c2262df58d33095abf4698799f343f1", "filename": "src/test/compile-fail/stability-attribute-non-staged-force-unstable.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/1177911790def5b20f2e4bdfa8bd59df0a51f4e7/src%2Ftest%2Fcompile-fail%2Fstability-attribute-non-staged-force-unstable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1177911790def5b20f2e4bdfa8bd59df0a51f4e7/src%2Ftest%2Fcompile-fail%2Fstability-attribute-non-staged-force-unstable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fstability-attribute-non-staged-force-unstable.rs?ref=1177911790def5b20f2e4bdfa8bd59df0a51f4e7", "patch": "@@ -0,0 +1,16 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// compile-flags:-Zforce-unstable-if-unmarked\n+\n+#[unstable] //~ ERROR: stability attributes may not be used\n+#[stable] //~ ERROR: stability attributes may not be used\n+#[rustc_deprecated] //~ ERROR: stability attributes may not be used\n+fn main() { }"}, {"sha": "542117eca1209bfd3991819f7c8b61502046e7c2", "filename": "src/test/run-pass/deprecation-in-force-unstable.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/1177911790def5b20f2e4bdfa8bd59df0a51f4e7/src%2Ftest%2Frun-pass%2Fdeprecation-in-force-unstable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1177911790def5b20f2e4bdfa8bd59df0a51f4e7/src%2Ftest%2Frun-pass%2Fdeprecation-in-force-unstable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fdeprecation-in-force-unstable.rs?ref=1177911790def5b20f2e4bdfa8bd59df0a51f4e7", "patch": "@@ -0,0 +1,14 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// compile-flags:-Zforce-unstable-if-unmarked\n+\n+#[deprecated] // should work even with -Zforce-unstable-if-unmarked\n+fn main() { }"}]}