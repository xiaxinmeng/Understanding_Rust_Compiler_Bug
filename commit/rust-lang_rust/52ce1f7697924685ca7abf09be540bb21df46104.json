{"sha": "52ce1f7697924685ca7abf09be540bb21df46104", "node_id": "C_kwDOAAsO6NoAKDUyY2UxZjc2OTc5MjQ2ODVjYTdhYmYwOWJlNTQwYmIyMWRmNDYxMDQ", "commit": {"author": {"name": "Jakob Degen", "email": "jakob.e.degen@gmail.com", "date": "2022-11-28T03:25:55Z"}, "committer": {"name": "Jakob Degen", "email": "jakob.e.degen@gmail.com", "date": "2022-11-30T03:27:26Z"}, "message": "Support statics in custom mir", "tree": {"sha": "ddee0e08e32220a6094115a7f1ec97de99582a93", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ddee0e08e32220a6094115a7f1ec97de99582a93"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/52ce1f7697924685ca7abf09be540bb21df46104", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/52ce1f7697924685ca7abf09be540bb21df46104", "html_url": "https://github.com/rust-lang/rust/commit/52ce1f7697924685ca7abf09be540bb21df46104", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/52ce1f7697924685ca7abf09be540bb21df46104/comments", "author": {"login": "JakobDegen", "id": 51179609, "node_id": "MDQ6VXNlcjUxMTc5NjA5", "avatar_url": "https://avatars.githubusercontent.com/u/51179609?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JakobDegen", "html_url": "https://github.com/JakobDegen", "followers_url": "https://api.github.com/users/JakobDegen/followers", "following_url": "https://api.github.com/users/JakobDegen/following{/other_user}", "gists_url": "https://api.github.com/users/JakobDegen/gists{/gist_id}", "starred_url": "https://api.github.com/users/JakobDegen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JakobDegen/subscriptions", "organizations_url": "https://api.github.com/users/JakobDegen/orgs", "repos_url": "https://api.github.com/users/JakobDegen/repos", "events_url": "https://api.github.com/users/JakobDegen/events{/privacy}", "received_events_url": "https://api.github.com/users/JakobDegen/received_events", "type": "User", "site_admin": false}, "committer": {"login": "JakobDegen", "id": 51179609, "node_id": "MDQ6VXNlcjUxMTc5NjA5", "avatar_url": "https://avatars.githubusercontent.com/u/51179609?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JakobDegen", "html_url": "https://github.com/JakobDegen", "followers_url": "https://api.github.com/users/JakobDegen/followers", "following_url": "https://api.github.com/users/JakobDegen/following{/other_user}", "gists_url": "https://api.github.com/users/JakobDegen/gists{/gist_id}", "starred_url": "https://api.github.com/users/JakobDegen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JakobDegen/subscriptions", "organizations_url": "https://api.github.com/users/JakobDegen/orgs", "repos_url": "https://api.github.com/users/JakobDegen/repos", "events_url": "https://api.github.com/users/JakobDegen/events{/privacy}", "received_events_url": "https://api.github.com/users/JakobDegen/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "757810031764e4a0fce2a21eb5c8ba208ff7f6c1", "url": "https://api.github.com/repos/rust-lang/rust/commits/757810031764e4a0fce2a21eb5c8ba208ff7f6c1", "html_url": "https://github.com/rust-lang/rust/commit/757810031764e4a0fce2a21eb5c8ba208ff7f6c1"}], "stats": {"total": 65, "additions": 65, "deletions": 0}, "files": [{"sha": "03206af33bfb5dc927da6348f64b84f7d4074a08", "filename": "compiler/rustc_mir_build/src/build/custom/parse/instruction.rs", "status": "modified", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/52ce1f7697924685ca7abf09be540bb21df46104/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fcustom%2Fparse%2Finstruction.rs", "raw_url": "https://github.com/rust-lang/rust/raw/52ce1f7697924685ca7abf09be540bb21df46104/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fcustom%2Fparse%2Finstruction.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fcustom%2Fparse%2Finstruction.rs?ref=52ce1f7697924685ca7abf09be540bb21df46104", "patch": "@@ -1,3 +1,4 @@\n+use rustc_middle::mir::interpret::{ConstValue, Scalar};\n use rustc_middle::{mir::*, thir::*, ty};\n \n use super::{parse_by_kind, PResult, ParseCtxt};\n@@ -45,6 +46,8 @@ impl<'tcx, 'body> ParseCtxt<'tcx, 'body> {\n     fn parse_operand(&self, expr_id: ExprId) -> PResult<Operand<'tcx>> {\n         parse_by_kind!(self, expr_id, expr, \"operand\",\n             @call(\"mir_move\", args) => self.parse_place(args[0]).map(Operand::Move),\n+            @call(\"mir_static\", args) => self.parse_static(args[0]),\n+            @call(\"mir_static_mut\", args) => self.parse_static(args[0]),\n             ExprKind::Literal { .. }\n             | ExprKind::NamedConst { .. }\n             | ExprKind::NonHirLiteral { .. }\n@@ -79,4 +82,24 @@ impl<'tcx, 'body> ParseCtxt<'tcx, 'body> {\n             ExprKind::VarRef { id } => Ok(self.block_map[id]),\n         )\n     }\n+\n+    fn parse_static(&self, expr_id: ExprId) -> PResult<Operand<'tcx>> {\n+        let expr_id = parse_by_kind!(self, expr_id, _, \"static\",\n+            ExprKind::Deref { arg } => *arg,\n+        );\n+\n+        parse_by_kind!(self, expr_id, expr, \"static\",\n+            ExprKind::StaticRef { alloc_id, ty, .. } => {\n+                let const_val =\n+                    ConstValue::Scalar(Scalar::from_pointer((*alloc_id).into(), &self.tcx));\n+                let literal = ConstantKind::Val(const_val, *ty);\n+\n+                Ok(Operand::Constant(Box::new(Constant {\n+                    span: expr.span,\n+                    user_ty: None,\n+                    literal\n+                })))\n+            },\n+        )\n+    }\n }"}, {"sha": "8ba1c122884ca431173cc28a77d33b6282e7169d", "filename": "library/core/src/intrinsics/mir.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/52ce1f7697924685ca7abf09be540bb21df46104/library%2Fcore%2Fsrc%2Fintrinsics%2Fmir.rs", "raw_url": "https://github.com/rust-lang/rust/raw/52ce1f7697924685ca7abf09be540bb21df46104/library%2Fcore%2Fsrc%2Fintrinsics%2Fmir.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fintrinsics%2Fmir.rs?ref=52ce1f7697924685ca7abf09be540bb21df46104", "patch": "@@ -80,6 +80,8 @@ define!(\"mir_goto\", fn Goto(destination: BasicBlock) -> BasicBlock);\n define!(\"mir_retag\", fn Retag<T>(place: T));\n define!(\"mir_retag_raw\", fn RetagRaw<T>(place: T));\n define!(\"mir_move\", fn Move<T>(place: T) -> T);\n+define!(\"mir_static\", fn Static<T>(s: T) -> &'static T);\n+define!(\"mir_static_mut\", fn StaticMut<T>(s: T) -> *mut T);\n \n /// Convenience macro for generating custom MIR.\n ///"}, {"sha": "ff4fe1a93246ec0406679043402502f1e7d6a9f2", "filename": "src/test/mir-opt/building/custom/consts.rs", "status": "modified", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/52ce1f7697924685ca7abf09be540bb21df46104/src%2Ftest%2Fmir-opt%2Fbuilding%2Fcustom%2Fconsts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/52ce1f7697924685ca7abf09be540bb21df46104/src%2Ftest%2Fmir-opt%2Fbuilding%2Fcustom%2Fconsts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fbuilding%2Fcustom%2Fconsts.rs?ref=52ce1f7697924685ca7abf09be540bb21df46104", "patch": "@@ -18,6 +18,19 @@ fn consts<const C: u32>() {\n     })\n }\n \n+static S: i32 = 5;\n+static mut T: i32 = 10;\n+// EMIT_MIR consts.statics.built.after.mir\n+#[custom_mir(dialect = \"built\")]\n+fn statics() {\n+    mir!({\n+        let _a: &i32 = Static(S);\n+        let _b: *mut i32 = StaticMut(T);\n+        Return()\n+    })\n+}\n+\n fn main() {\n     consts::<5>();\n+    statics();\n }"}, {"sha": "a193af729d565f39e489edddd9b09a3f9475499a", "filename": "src/test/mir-opt/building/custom/consts.statics.built.after.mir", "status": "added", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/52ce1f7697924685ca7abf09be540bb21df46104/src%2Ftest%2Fmir-opt%2Fbuilding%2Fcustom%2Fconsts.statics.built.after.mir", "raw_url": "https://github.com/rust-lang/rust/raw/52ce1f7697924685ca7abf09be540bb21df46104/src%2Ftest%2Fmir-opt%2Fbuilding%2Fcustom%2Fconsts.statics.built.after.mir", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fbuilding%2Fcustom%2Fconsts.statics.built.after.mir?ref=52ce1f7697924685ca7abf09be540bb21df46104", "patch": "@@ -0,0 +1,27 @@\n+// MIR for `statics` after built\n+\n+fn statics() -> () {\n+    let mut _0: ();                      // return place in scope 0 at $DIR/consts.rs:25:14: 25:14\n+    let mut _1: &i32;                    // in scope 0 at $SRC_DIR/core/src/intrinsics/mir.rs:LL:COL\n+    let mut _2: *mut i32;                // in scope 0 at $SRC_DIR/core/src/intrinsics/mir.rs:LL:COL\n+\n+    bb0: {\n+        _1 = const {alloc1: &i32};       // scope 0 at $DIR/consts.rs:+0:1: +0:13\n+                                         // mir::Constant\n+                                         // + span: $DIR/consts.rs:27:31: 27:32\n+                                         // + literal: Const { ty: &i32, val: Value(Scalar(alloc1)) }\n+        _2 = const {alloc2: *mut i32};   // scope 0 at $DIR/consts.rs:+0:1: +0:13\n+                                         // mir::Constant\n+                                         // + span: $DIR/consts.rs:28:38: 28:39\n+                                         // + literal: Const { ty: *mut i32, val: Value(Scalar(alloc2)) }\n+        return;                          // scope 0 at $DIR/consts.rs:+0:1: +0:13\n+    }\n+}\n+\n+alloc2 (static: T, size: 4, align: 4) {\n+    0a 00 00 00                                     \u2502 ....\n+}\n+\n+alloc1 (static: S, size: 4, align: 4) {\n+    05 00 00 00                                     \u2502 ....\n+}"}]}