{"sha": "1573d10325f286ffcbba290d27984ded9538a5c3", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE1NzNkMTAzMjVmMjg2ZmZjYmJhMjkwZDI3OTg0ZGVkOTUzOGE1YzM=", "commit": {"author": {"name": "Philipp Hansch", "email": "dev@phansch.net", "date": "2021-04-06T04:59:10Z"}, "committer": {"name": "Philipp Hansch", "email": "dev@phansch.net", "date": "2021-04-06T05:20:55Z"}, "message": "tabs_in_doc_comments: Fix ICE due to char indexing\n\nThis is a quick-fix for an ICE in `tabs_in_doc_comments`. The problem\nwas that we we're indexing into possibly multi-byte characters, such as '\u4f4d'.\n\nMore specifically `get_chunks_of_tabs` was returning indices into\nmulti-byte characters. Those were passed on to a `Span` creation that\nthen caused the ICE.\n\nThis fix makes sure that we don't return indices that point inside a\nmulti-byte character. *However*, we are still iterating over unicode\ncodepoints, not grapheme clusters. So a seemingly single character like y\u0306 ,\nwhich actually consists of two codepoints, will probably still cause\nincorrect spans in the output.", "tree": {"sha": "ccf42fb5e45c2a8d49084d655783ef40696ce08d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ccf42fb5e45c2a8d49084d655783ef40696ce08d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1573d10325f286ffcbba290d27984ded9538a5c3", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEE6VFioMHrom999LRAK0OZxL9Ny94FAmBr77kACgkQK0OZxL9N\ny94vmxAAo0st8kpVomJnOtMEUEacpbADsYY+9p0sFy7qRmSrUMv4w4MBObUOBsG5\nHew+fbCo0ULNzbrAladARk9cvqWIeCLAQbuba+TO4HTxsPcQUnjWU/zDkSu2zJAR\naGmFqRpXZtUpO75kgzyG6DlZ0LB8Dl1dSDAHdzE0os33eu3B2a70VPPl00IMXLYA\nBHYWr4z9YVYbV1bcJiaDAQ8Mgi2pJA6nuAmz9YTr1jhRsuTZ88CQdSaP0tO/8keh\nLIoXgMQ0H9g0F/O1iJ0aQE8Hl6pzFgZ+WTLcmA1FKhgvfwIpcvG+JeMYGPO4F8WR\nIGUU5n+XgTUAyCYMFkYZpyrhu3qYhIgjKqwYAYcl6GyhIjY3dYLjwmZXO1CUxLDd\nl6VwdZhDPsvGdf1IgNEBjGwnuHZBnCmlRm750cN+bjRX7Vj+PSDYYXidm6xXsYax\n9Aqdn2+uWndSGCPZtiSLl9V0k/l2uX1H7cmQ9nPxuJp6akj/xxNeagTcxNvO0C3c\nkdFy9vGFiHO8hl5DPP35ttdk+zVbsVwOGhaKZody+TWNs7Hha8/oRMDdPbx5c0aO\n3I+d5/qqbON9l6cYo6rvcoqxZuHPiIYjkXE+OeZGEGIMT+4W/Sj5uyhinKRyu0If\n91Ff9opFy198eJnB25wkGLfIQQZwEpIEr3TjHzqC4zEqcf9uF/Y=\n=Jzvd\n-----END PGP SIGNATURE-----", "payload": "tree ccf42fb5e45c2a8d49084d655783ef40696ce08d\nparent e315437bd69d97c7e11efe6e74dbad1ddb9ca172\nauthor Philipp Hansch <dev@phansch.net> 1617685150 +0200\ncommitter Philipp Hansch <dev@phansch.net> 1617686455 +0200\n\ntabs_in_doc_comments: Fix ICE due to char indexing\n\nThis is a quick-fix for an ICE in `tabs_in_doc_comments`. The problem\nwas that we we're indexing into possibly multi-byte characters, such as '\u4f4d'.\n\nMore specifically `get_chunks_of_tabs` was returning indices into\nmulti-byte characters. Those were passed on to a `Span` creation that\nthen caused the ICE.\n\nThis fix makes sure that we don't return indices that point inside a\nmulti-byte character. *However*, we are still iterating over unicode\ncodepoints, not grapheme clusters. So a seemingly single character like y\u0306 ,\nwhich actually consists of two codepoints, will probably still cause\nincorrect spans in the output.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1573d10325f286ffcbba290d27984ded9538a5c3", "html_url": "https://github.com/rust-lang/rust/commit/1573d10325f286ffcbba290d27984ded9538a5c3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1573d10325f286ffcbba290d27984ded9538a5c3/comments", "author": {"login": "phansch", "id": 2042399, "node_id": "MDQ6VXNlcjIwNDIzOTk=", "avatar_url": "https://avatars.githubusercontent.com/u/2042399?v=4", "gravatar_id": "", "url": "https://api.github.com/users/phansch", "html_url": "https://github.com/phansch", "followers_url": "https://api.github.com/users/phansch/followers", "following_url": "https://api.github.com/users/phansch/following{/other_user}", "gists_url": "https://api.github.com/users/phansch/gists{/gist_id}", "starred_url": "https://api.github.com/users/phansch/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/phansch/subscriptions", "organizations_url": "https://api.github.com/users/phansch/orgs", "repos_url": "https://api.github.com/users/phansch/repos", "events_url": "https://api.github.com/users/phansch/events{/privacy}", "received_events_url": "https://api.github.com/users/phansch/received_events", "type": "User", "site_admin": false}, "committer": {"login": "phansch", "id": 2042399, "node_id": "MDQ6VXNlcjIwNDIzOTk=", "avatar_url": "https://avatars.githubusercontent.com/u/2042399?v=4", "gravatar_id": "", "url": "https://api.github.com/users/phansch", "html_url": "https://github.com/phansch", "followers_url": "https://api.github.com/users/phansch/followers", "following_url": "https://api.github.com/users/phansch/following{/other_user}", "gists_url": "https://api.github.com/users/phansch/gists{/gist_id}", "starred_url": "https://api.github.com/users/phansch/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/phansch/subscriptions", "organizations_url": "https://api.github.com/users/phansch/orgs", "repos_url": "https://api.github.com/users/phansch/repos", "events_url": "https://api.github.com/users/phansch/events{/privacy}", "received_events_url": "https://api.github.com/users/phansch/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e315437bd69d97c7e11efe6e74dbad1ddb9ca172", "url": "https://api.github.com/repos/rust-lang/rust/commits/e315437bd69d97c7e11efe6e74dbad1ddb9ca172", "html_url": "https://github.com/rust-lang/rust/commit/e315437bd69d97c7e11efe6e74dbad1ddb9ca172"}], "stats": {"total": 56, "additions": 45, "deletions": 11}, "files": [{"sha": "3f9692540f70c95a6cce3dbd9c92204ddea7884d", "filename": "clippy_lints/src/tabs_in_doc_comments.rs", "status": "modified", "additions": 17, "deletions": 11, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/1573d10325f286ffcbba290d27984ded9538a5c3/clippy_lints%2Fsrc%2Ftabs_in_doc_comments.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1573d10325f286ffcbba290d27984ded9538a5c3/clippy_lints%2Fsrc%2Ftabs_in_doc_comments.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Ftabs_in_doc_comments.rs?ref=1573d10325f286ffcbba290d27984ded9538a5c3", "patch": "@@ -104,30 +104,29 @@ fn get_chunks_of_tabs(the_str: &str) -> Vec<(u32, u32)> {\n     // tracker to decide if the last group of tabs is not closed by a non-tab character\n     let mut is_active = false;\n \n-    let chars_array: Vec<_> = the_str.chars().collect();\n+    let char_indices: Vec<_> = the_str.char_indices().collect();\n \n-    if chars_array == vec!['\\t'] {\n+    if char_indices.len() == 1 && char_indices.first().unwrap().1 == '\\t' {\n         return vec![(0, 1)];\n     }\n \n-    for (index, arr) in chars_array.windows(2).enumerate() {\n-        let index = u32::try_from(index).expect(line_length_way_to_long);\n-        match arr {\n-            ['\\t', '\\t'] => {\n+    for entry in char_indices.windows(2) {\n+        match entry {\n+            [(_, '\\t'), (_, '\\t')] => {\n                 // either string starts with double tab, then we have to set it active,\n                 // otherwise is_active is true anyway\n                 is_active = true;\n             },\n-            [_, '\\t'] => {\n+            [(_, _), (index_b, '\\t')] => {\n                 // as ['\\t', '\\t'] is excluded, this has to be a start of a tab group,\n                 // set indices accordingly\n                 is_active = true;\n-                current_start = index + 1;\n+                current_start = *index_b as u32;\n             },\n-            ['\\t', _] => {\n+            [(_, '\\t'), (index_b, _)] => {\n                 // this now has to be an end of the group, hence we have to push a new tuple\n                 is_active = false;\n-                spans.push((current_start, index + 1));\n+                spans.push((current_start, *index_b as u32));\n             },\n             _ => {},\n         }\n@@ -137,7 +136,7 @@ fn get_chunks_of_tabs(the_str: &str) -> Vec<(u32, u32)> {\n     if is_active {\n         spans.push((\n             current_start,\n-            u32::try_from(the_str.chars().count()).expect(line_length_way_to_long),\n+            u32::try_from(char_indices.last().unwrap().0 + 1).expect(line_length_way_to_long),\n         ));\n     }\n \n@@ -148,6 +147,13 @@ fn get_chunks_of_tabs(the_str: &str) -> Vec<(u32, u32)> {\n mod tests_for_get_chunks_of_tabs {\n     use super::get_chunks_of_tabs;\n \n+    #[test]\n+    fn test_unicode_han_string() {\n+        let res = get_chunks_of_tabs(\" \u4f4d\\t\");\n+\n+        assert_eq!(res, vec![(4, 5)]);\n+    }\n+\n     #[test]\n     fn test_empty_string() {\n         let res = get_chunks_of_tabs(\"\");"}, {"sha": "209a5b1eb095661071d60c1ab721afc549bc81a8", "filename": "tests/ui/crashes/ice-5835.rs", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/1573d10325f286ffcbba290d27984ded9538a5c3/tests%2Fui%2Fcrashes%2Fice-5835.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1573d10325f286ffcbba290d27984ded9538a5c3/tests%2Fui%2Fcrashes%2Fice-5835.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcrashes%2Fice-5835.rs?ref=1573d10325f286ffcbba290d27984ded9538a5c3", "patch": "@@ -0,0 +1,8 @@\n+#![rustfmt::skip]\n+\n+pub struct Foo {\n+    /// \u4f4d\t\n+    pub bar: u8,\n+}\n+\n+fn main() {}"}, {"sha": "e286bc580adb459bc59207924c908e1b34b44643", "filename": "tests/ui/crashes/ice-5835.stderr", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/1573d10325f286ffcbba290d27984ded9538a5c3/tests%2Fui%2Fcrashes%2Fice-5835.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/1573d10325f286ffcbba290d27984ded9538a5c3/tests%2Fui%2Fcrashes%2Fice-5835.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcrashes%2Fice-5835.stderr?ref=1573d10325f286ffcbba290d27984ded9538a5c3", "patch": "@@ -0,0 +1,20 @@\n+error[E0658]: custom inner attributes are unstable\n+  --> $DIR/ice-5835.rs:1:4\n+   |\n+LL | #![rustfmt::skip]\n+   |    ^^^^^^^^^^^^^\n+   |\n+   = note: see issue #54726 <https://github.com/rust-lang/rust/issues/54726> for more information\n+   = help: add `#![feature(custom_inner_attributes)]` to the crate attributes to enable\n+\n+error: using tabs in doc comments is not recommended\n+  --> $DIR/ice-5835.rs:4:10\n+   |\n+LL |     /// \u4f4d    \n+   |           ^^^^ help: consider using four spaces per tab\n+   |\n+   = note: `-D clippy::tabs-in-doc-comments` implied by `-D warnings`\n+\n+error: aborting due to 2 previous errors\n+\n+For more information about this error, try `rustc --explain E0658`."}]}