{"sha": "a8988519d508cf89b96d18aaa9ace4e0bcd67621", "node_id": "C_kwDOAAsO6NoAKGE4OTg4NTE5ZDUwOGNmODliOTZkMThhYWE5YWNlNGUwYmNkNjc2MjE", "commit": {"author": {"name": "Camille GILLOT", "email": "gillot.camille@gmail.com", "date": "2023-04-25T19:25:28Z"}, "committer": {"name": "Camille GILLOT", "email": "gillot.camille@gmail.com", "date": "2023-05-07T11:10:52Z"}, "message": "Propagate PlaceElem::Index.", "tree": {"sha": "ff854719143e8c62e93848e9de4c004bb910b661", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ff854719143e8c62e93848e9de4c004bb910b661"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a8988519d508cf89b96d18aaa9ace4e0bcd67621", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a8988519d508cf89b96d18aaa9ace4e0bcd67621", "html_url": "https://github.com/rust-lang/rust/commit/a8988519d508cf89b96d18aaa9ace4e0bcd67621", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a8988519d508cf89b96d18aaa9ace4e0bcd67621/comments", "author": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "committer": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8cc75b56a67ab33407b43faa0efc0f6483ff5664", "url": "https://api.github.com/repos/rust-lang/rust/commits/8cc75b56a67ab33407b43faa0efc0f6483ff5664", "html_url": "https://github.com/rust-lang/rust/commit/8cc75b56a67ab33407b43faa0efc0f6483ff5664"}], "stats": {"total": 30, "additions": 26, "deletions": 4}, "files": [{"sha": "a5d18fff89bd79c63a47ef71d75b4d83678ed9bb", "filename": "compiler/rustc_mir_transform/src/const_prop.rs", "status": "modified", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/a8988519d508cf89b96d18aaa9ace4e0bcd67621/compiler%2Frustc_mir_transform%2Fsrc%2Fconst_prop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a8988519d508cf89b96d18aaa9ace4e0bcd67621/compiler%2Frustc_mir_transform%2Fsrc%2Fconst_prop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_transform%2Fsrc%2Fconst_prop.rs?ref=a8988519d508cf89b96d18aaa9ace4e0bcd67621", "patch": "@@ -806,6 +806,24 @@ impl<'tcx> MutVisitor<'tcx> for ConstPropagator<'_, 'tcx> {\n         }\n     }\n \n+    fn process_projection_elem(\n+        &mut self,\n+        elem: PlaceElem<'tcx>,\n+        _: Location,\n+    ) -> Option<PlaceElem<'tcx>> {\n+        if let PlaceElem::Index(local) = elem\n+            && let Some(value) = self.get_const(local.into())\n+            && self.should_const_prop(&value)\n+            && let interpret::Operand::Immediate(interpret::Immediate::Scalar(scalar)) = *value\n+            && let Ok(offset) = scalar.to_target_usize(&self.tcx)\n+            && let Some(min_length) = offset.checked_add(1)\n+        {\n+            Some(PlaceElem::ConstantIndex { offset, min_length, from_end: false })\n+        } else {\n+            None\n+        }\n+    }\n+\n     fn visit_assign(\n         &mut self,\n         place: &mut Place<'tcx>,"}, {"sha": "d72675c2d1157b228810e8ab487e6112554236f8", "filename": "tests/mir-opt/const_prop/bad_op_unsafe_oob_for_slices.main.ConstProp.32bit.diff", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/a8988519d508cf89b96d18aaa9ace4e0bcd67621/tests%2Fmir-opt%2Fconst_prop%2Fbad_op_unsafe_oob_for_slices.main.ConstProp.32bit.diff", "raw_url": "https://github.com/rust-lang/rust/raw/a8988519d508cf89b96d18aaa9ace4e0bcd67621/tests%2Fmir-opt%2Fconst_prop%2Fbad_op_unsafe_oob_for_slices.main.ConstProp.32bit.diff", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Fconst_prop%2Fbad_op_unsafe_oob_for_slices.main.ConstProp.32bit.diff?ref=a8988519d508cf89b96d18aaa9ace4e0bcd67621", "patch": "@@ -45,7 +45,8 @@\n       }\n   \n       bb1: {\n-          _5 = (*_1)[_6];                  // scope 2 at $DIR/bad_op_unsafe_oob_for_slices.rs:+3:18: +3:25\n+-         _5 = (*_1)[_6];                  // scope 2 at $DIR/bad_op_unsafe_oob_for_slices.rs:+3:18: +3:25\n++         _5 = (*_1)[3 of 4];              // scope 2 at $DIR/bad_op_unsafe_oob_for_slices.rs:+3:18: +3:25\n           StorageDead(_6);                 // scope 2 at $DIR/bad_op_unsafe_oob_for_slices.rs:+3:25: +3:26\n           _0 = const ();                   // scope 2 at $DIR/bad_op_unsafe_oob_for_slices.rs:+2:5: +4:6\n           StorageDead(_5);                 // scope 2 at $DIR/bad_op_unsafe_oob_for_slices.rs:+4:5: +4:6"}, {"sha": "d72675c2d1157b228810e8ab487e6112554236f8", "filename": "tests/mir-opt/const_prop/bad_op_unsafe_oob_for_slices.main.ConstProp.64bit.diff", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/a8988519d508cf89b96d18aaa9ace4e0bcd67621/tests%2Fmir-opt%2Fconst_prop%2Fbad_op_unsafe_oob_for_slices.main.ConstProp.64bit.diff", "raw_url": "https://github.com/rust-lang/rust/raw/a8988519d508cf89b96d18aaa9ace4e0bcd67621/tests%2Fmir-opt%2Fconst_prop%2Fbad_op_unsafe_oob_for_slices.main.ConstProp.64bit.diff", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Fconst_prop%2Fbad_op_unsafe_oob_for_slices.main.ConstProp.64bit.diff?ref=a8988519d508cf89b96d18aaa9ace4e0bcd67621", "patch": "@@ -45,7 +45,8 @@\n       }\n   \n       bb1: {\n-          _5 = (*_1)[_6];                  // scope 2 at $DIR/bad_op_unsafe_oob_for_slices.rs:+3:18: +3:25\n+-         _5 = (*_1)[_6];                  // scope 2 at $DIR/bad_op_unsafe_oob_for_slices.rs:+3:18: +3:25\n++         _5 = (*_1)[3 of 4];              // scope 2 at $DIR/bad_op_unsafe_oob_for_slices.rs:+3:18: +3:25\n           StorageDead(_6);                 // scope 2 at $DIR/bad_op_unsafe_oob_for_slices.rs:+3:25: +3:26\n           _0 = const ();                   // scope 2 at $DIR/bad_op_unsafe_oob_for_slices.rs:+2:5: +4:6\n           StorageDead(_5);                 // scope 2 at $DIR/bad_op_unsafe_oob_for_slices.rs:+4:5: +4:6"}, {"sha": "33bbad2f422ba0ebddd14dbe28e6c97f7575c303", "filename": "tests/mir-opt/const_prop/large_array_index.main.ConstProp.32bit.diff", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/a8988519d508cf89b96d18aaa9ace4e0bcd67621/tests%2Fmir-opt%2Fconst_prop%2Flarge_array_index.main.ConstProp.32bit.diff", "raw_url": "https://github.com/rust-lang/rust/raw/a8988519d508cf89b96d18aaa9ace4e0bcd67621/tests%2Fmir-opt%2Fconst_prop%2Flarge_array_index.main.ConstProp.32bit.diff", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Fconst_prop%2Flarge_array_index.main.ConstProp.32bit.diff?ref=a8988519d508cf89b96d18aaa9ace4e0bcd67621", "patch": "@@ -27,7 +27,8 @@\n       }\n   \n       bb1: {\n-          _1 = _2[_3];                     // scope 0 at $DIR/large_array_index.rs:+2:17: +2:32\n+-         _1 = _2[_3];                     // scope 0 at $DIR/large_array_index.rs:+2:17: +2:32\n++         _1 = _2[2 of 3];                 // scope 0 at $DIR/large_array_index.rs:+2:17: +2:32\n           StorageDead(_3);                 // scope 0 at $DIR/large_array_index.rs:+2:32: +2:33\n           StorageDead(_2);                 // scope 0 at $DIR/large_array_index.rs:+2:32: +2:33\n           _0 = const ();                   // scope 0 at $DIR/large_array_index.rs:+0:11: +3:2"}, {"sha": "33bbad2f422ba0ebddd14dbe28e6c97f7575c303", "filename": "tests/mir-opt/const_prop/large_array_index.main.ConstProp.64bit.diff", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/a8988519d508cf89b96d18aaa9ace4e0bcd67621/tests%2Fmir-opt%2Fconst_prop%2Flarge_array_index.main.ConstProp.64bit.diff", "raw_url": "https://github.com/rust-lang/rust/raw/a8988519d508cf89b96d18aaa9ace4e0bcd67621/tests%2Fmir-opt%2Fconst_prop%2Flarge_array_index.main.ConstProp.64bit.diff", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Fconst_prop%2Flarge_array_index.main.ConstProp.64bit.diff?ref=a8988519d508cf89b96d18aaa9ace4e0bcd67621", "patch": "@@ -27,7 +27,8 @@\n       }\n   \n       bb1: {\n-          _1 = _2[_3];                     // scope 0 at $DIR/large_array_index.rs:+2:17: +2:32\n+-         _1 = _2[_3];                     // scope 0 at $DIR/large_array_index.rs:+2:17: +2:32\n++         _1 = _2[2 of 3];                 // scope 0 at $DIR/large_array_index.rs:+2:17: +2:32\n           StorageDead(_3);                 // scope 0 at $DIR/large_array_index.rs:+2:32: +2:33\n           StorageDead(_2);                 // scope 0 at $DIR/large_array_index.rs:+2:32: +2:33\n           _0 = const ();                   // scope 0 at $DIR/large_array_index.rs:+0:11: +3:2"}]}