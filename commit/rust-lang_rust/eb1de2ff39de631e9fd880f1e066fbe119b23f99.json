{"sha": "eb1de2ff39de631e9fd880f1e066fbe119b23f99", "node_id": "MDY6Q29tbWl0NzI0NzEyOmViMWRlMmZmMzlkZTYzMWU5ZmQ4ODBmMWUwNjZmYmUxMTliMjNmOTk=", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2020-04-23T18:05:01Z"}, "committer": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2020-04-23T18:05:01Z"}, "message": "liballoc: more compact way to adjust test sizes for Miri", "tree": {"sha": "795bed67f4036a8482fb9a448fc85e9d37553dc0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/795bed67f4036a8482fb9a448fc85e9d37553dc0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/eb1de2ff39de631e9fd880f1e066fbe119b23f99", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/eb1de2ff39de631e9fd880f1e066fbe119b23f99", "html_url": "https://github.com/rust-lang/rust/commit/eb1de2ff39de631e9fd880f1e066fbe119b23f99", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/eb1de2ff39de631e9fd880f1e066fbe119b23f99/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f1c30519f30e4c245e2b319fbb257ba2c59e8092", "url": "https://api.github.com/repos/rust-lang/rust/commits/f1c30519f30e4c245e2b319fbb257ba2c59e8092", "html_url": "https://github.com/rust-lang/rust/commit/f1c30519f30e4c245e2b319fbb257ba2c59e8092"}], "stats": {"total": 106, "additions": 35, "deletions": 71}, "files": [{"sha": "0a3f33003233f2dc5c1a7928afa5562bf05e03eb", "filename": "src/liballoc/collections/vec_deque/tests.rs", "status": "modified", "additions": 2, "deletions": 4, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/eb1de2ff39de631e9fd880f1e066fbe119b23f99/src%2Fliballoc%2Fcollections%2Fvec_deque%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eb1de2ff39de631e9fd880f1e066fbe119b23f99/src%2Fliballoc%2Fcollections%2Fvec_deque%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fliballoc%2Fcollections%2Fvec_deque%2Ftests.rs?ref=eb1de2ff39de631e9fd880f1e066fbe119b23f99", "patch": "@@ -386,10 +386,8 @@ fn test_vec_from_vecdeque() {\n         assert!(vec.into_iter().eq(vd));\n     }\n \n-    #[cfg(not(miri))] // Miri is too slow\n-    let max_pwr = 7;\n-    #[cfg(miri)]\n-    let max_pwr = 5;\n+    // Miri is too slow\n+    let max_pwr = if cfg!(miri) { 5 } else { 7 };\n \n     for cap_pwr in 0..max_pwr {\n         // Make capacity as a (2^x)-1, so that the ring size is 2^x"}, {"sha": "057afd41824e745b062e22cd5139ed7c5a3df422", "filename": "src/liballoc/tests/binary_heap.rs", "status": "modified", "additions": 3, "deletions": 5, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/eb1de2ff39de631e9fd880f1e066fbe119b23f99/src%2Fliballoc%2Ftests%2Fbinary_heap.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eb1de2ff39de631e9fd880f1e066fbe119b23f99/src%2Fliballoc%2Ftests%2Fbinary_heap.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fliballoc%2Ftests%2Fbinary_heap.rs?ref=eb1de2ff39de631e9fd880f1e066fbe119b23f99", "patch": "@@ -409,16 +409,14 @@ fn panic_safe() {\n     }\n     let mut rng = thread_rng();\n     const DATASZ: usize = 32;\n-    #[cfg(not(miri))] // Miri is too slow\n-    const NTEST: usize = 10;\n-    #[cfg(miri)]\n-    const NTEST: usize = 1;\n+    // Miri is too slow\n+    let ntest = if cfg!(miri) { 1 } else { 10 };\n \n     // don't use 0 in the data -- we want to catch the zeroed-out case.\n     let data = (1..=DATASZ).collect::<Vec<_>>();\n \n     // since it's a fuzzy test, run several tries.\n-    for _ in 0..NTEST {\n+    for _ in 0..ntest {\n         for i in 1..=DATASZ {\n             DROP_COUNTER.store(0, Ordering::SeqCst);\n "}, {"sha": "731a1b5f875b7c32bcf1f046684287df1b5c599d", "filename": "src/liballoc/tests/btree/map.rs", "status": "modified", "additions": 16, "deletions": 32, "changes": 48, "blob_url": "https://github.com/rust-lang/rust/blob/eb1de2ff39de631e9fd880f1e066fbe119b23f99/src%2Fliballoc%2Ftests%2Fbtree%2Fmap.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eb1de2ff39de631e9fd880f1e066fbe119b23f99/src%2Fliballoc%2Ftests%2Fbtree%2Fmap.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fliballoc%2Ftests%2Fbtree%2Fmap.rs?ref=eb1de2ff39de631e9fd880f1e066fbe119b23f99", "patch": "@@ -28,10 +28,8 @@ const MIN_INSERTS_HEIGHT_2: usize = NODE_CAPACITY + (NODE_CAPACITY + 1) * NODE_C\n #[test]\n fn test_basic_large() {\n     let mut map = BTreeMap::new();\n-    #[cfg(not(miri))] // Miri is too slow\n-    let size = 10000;\n-    #[cfg(miri)]\n-    let size = MIN_INSERTS_HEIGHT_2;\n+    // Miri is too slow\n+    let size = if cfg!(miri) { MIN_INSERTS_HEIGHT_2 } else { 10000 };\n     assert_eq!(map.len(), 0);\n \n     for i in 0..size {\n@@ -155,10 +153,8 @@ fn test_basic_small() {\n \n #[test]\n fn test_iter() {\n-    #[cfg(not(miri))] // Miri is too slow\n-    let size = 10000;\n-    #[cfg(miri)]\n-    let size = 200;\n+    // Miri is too slow\n+    let size = if cfg!(miri) { 200 } else { 10000 };\n \n     let mut map: BTreeMap<_, _> = (0..size).map(|i| (i, i)).collect();\n \n@@ -180,10 +176,8 @@ fn test_iter() {\n \n #[test]\n fn test_iter_rev() {\n-    #[cfg(not(miri))] // Miri is too slow\n-    let size = 10000;\n-    #[cfg(miri)]\n-    let size = 200;\n+    // Miri is too slow\n+    let size = if cfg!(miri) { 200 } else { 10000 };\n \n     let mut map: BTreeMap<_, _> = (0..size).map(|i| (i, i)).collect();\n \n@@ -289,10 +283,8 @@ fn test_values_mut() {\n \n #[test]\n fn test_iter_mixed() {\n-    #[cfg(not(miri))] // Miri is too slow\n-    let size = 10000;\n-    #[cfg(miri)]\n-    let size = 200;\n+    // Miri is too slow\n+    let size = if cfg!(miri) { 200 } else { 10000 };\n \n     let mut map: BTreeMap<_, _> = (0..size).map(|i| (i, i)).collect();\n \n@@ -525,10 +517,8 @@ fn test_range_backwards_4() {\n \n #[test]\n fn test_range_1000() {\n-    #[cfg(not(miri))] // Miri is too slow\n-    let size = 1000;\n-    #[cfg(miri)]\n-    let size = MIN_INSERTS_HEIGHT_2 as u32;\n+    // Miri is too slow\n+    let size = if cfg!(miri) { MIN_INSERTS_HEIGHT_2 as u32 } else { 1000 };\n     let map: BTreeMap<_, _> = (0..size).map(|i| (i, i)).collect();\n \n     fn test(map: &BTreeMap<u32, u32>, size: u32, min: Bound<&u32>, max: Bound<&u32>) {\n@@ -566,10 +556,8 @@ fn test_range_borrowed_key() {\n #[test]\n fn test_range() {\n     let size = 200;\n-    #[cfg(not(miri))] // Miri is too slow\n-    let step = 1;\n-    #[cfg(miri)]\n-    let step = 66;\n+    // Miri is too slow\n+    let step = if cfg!(miri) { 66 } else { 1 };\n     let map: BTreeMap<_, _> = (0..size).map(|i| (i, i)).collect();\n \n     for i in (0..size).step_by(step) {\n@@ -589,10 +577,8 @@ fn test_range() {\n #[test]\n fn test_range_mut() {\n     let size = 200;\n-    #[cfg(not(miri))] // Miri is too slow\n-    let step = 1;\n-    #[cfg(miri)]\n-    let step = 66;\n+    // Miri is too slow\n+    let step = if cfg!(miri) { 66 } else { 1 };\n     let mut map: BTreeMap<_, _> = (0..size).map(|i| (i, i)).collect();\n \n     for i in (0..size).step_by(step) {\n@@ -1263,10 +1249,8 @@ fn test_split_off_empty_left() {\n \n #[test]\n fn test_split_off_large_random_sorted() {\n-    #[cfg(not(miri))] // Miri is too slow\n-    let mut data = rand_data(1529);\n-    #[cfg(miri)]\n-    let mut data = rand_data(529);\n+    // Miri is too slow\n+    let mut data = if cfg!(miri) { rand_data(529) } else { rand_data(1529) };\n     // special case with maximum height.\n     data.sort();\n "}, {"sha": "75251ca0d51e9b8b4c49f4f057d03da80f886e54", "filename": "src/liballoc/tests/btree/set.rs", "status": "modified", "additions": 2, "deletions": 4, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/eb1de2ff39de631e9fd880f1e066fbe119b23f99/src%2Fliballoc%2Ftests%2Fbtree%2Fset.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eb1de2ff39de631e9fd880f1e066fbe119b23f99/src%2Fliballoc%2Ftests%2Fbtree%2Fset.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fliballoc%2Ftests%2Fbtree%2Fset.rs?ref=eb1de2ff39de631e9fd880f1e066fbe119b23f99", "patch": "@@ -621,10 +621,8 @@ fn test_split_off_empty_left() {\n \n #[test]\n fn test_split_off_large_random_sorted() {\n-    #[cfg(not(miri))] // Miri is too slow\n-    let mut data = rand_data(1529);\n-    #[cfg(miri)]\n-    let mut data = rand_data(529);\n+    // Miri is too slow\n+    let mut data = if cfg!(miri) { rand_data(529) } else { rand_data(1529) };\n     // special case with maximum height.\n     data.sort();\n "}, {"sha": "75b76bb73ed9e83c327f949c833fb5f9f4022ca9", "filename": "src/liballoc/tests/slice.rs", "status": "modified", "additions": 6, "deletions": 18, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/eb1de2ff39de631e9fd880f1e066fbe119b23f99/src%2Fliballoc%2Ftests%2Fslice.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eb1de2ff39de631e9fd880f1e066fbe119b23f99/src%2Fliballoc%2Ftests%2Fslice.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fliballoc%2Ftests%2Fslice.rs?ref=eb1de2ff39de631e9fd880f1e066fbe119b23f99", "patch": "@@ -463,15 +463,9 @@ fn test_sort() {\n \n #[test]\n fn test_sort_stability() {\n-    #[cfg(not(miri))] // Miri is too slow\n-    let large_range = 500..510;\n-    #[cfg(not(miri))] // Miri is too slow\n-    let rounds = 10;\n-\n-    #[cfg(miri)]\n-    let large_range = 0..0; // empty range\n-    #[cfg(miri)]\n-    let rounds = 1;\n+    // Miri is too slow\n+    let large_range = if cfg!(miri) { 0..0 } else { 500..510 };\n+    let rounds = if cfg!(miri) { 1 } else { 10 };\n \n     for len in (2..25).chain(large_range) {\n         for _ in 0..rounds {\n@@ -1727,15 +1721,9 @@ fn panic_safe() {\n \n     let mut rng = thread_rng();\n \n-    #[cfg(not(miri))] // Miri is too slow\n-    let lens = (1..20).chain(70..MAX_LEN);\n-    #[cfg(not(miri))] // Miri is too slow\n-    let moduli = &[5, 20, 50];\n-\n-    #[cfg(miri)]\n-    let lens = 1..10;\n-    #[cfg(miri)]\n-    let moduli = &[5];\n+    // Miri is too slow\n+    let lens = if cfg!(miri) { (1..10).chain(20..21) } else { (1..20).chain(70..MAX_LEN) };\n+    let moduli: &[u32] = if cfg!(miri) { &[5] } else { &[5, 20, 50] };\n \n     for len in lens {\n         for &modulus in moduli {"}, {"sha": "762dc4be44d6208950d4bd03e2fba8de66c45fcc", "filename": "src/liballoc/tests/vec_deque.rs", "status": "modified", "additions": 6, "deletions": 8, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/eb1de2ff39de631e9fd880f1e066fbe119b23f99/src%2Fliballoc%2Ftests%2Fvec_deque.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eb1de2ff39de631e9fd880f1e066fbe119b23f99/src%2Fliballoc%2Ftests%2Fvec_deque.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fliballoc%2Ftests%2Fvec_deque.rs?ref=eb1de2ff39de631e9fd880f1e066fbe119b23f99", "patch": "@@ -954,16 +954,14 @@ fn test_append_permutations() {\n         out\n     }\n \n-    #[cfg(not(miri))] // Miri is too slow\n-    const MAX: usize = 5;\n-    #[cfg(miri)]\n-    const MAX: usize = 3;\n+    // Miri is too slow\n+    let max = if cfg!(miri) { 3 } else { 5 };\n \n     // Many different permutations of both the `VecDeque` getting appended to\n     // and the one getting appended are generated to check `append`.\n     // This ensures all 6 code paths of `append` are tested.\n-    for src_push_back in 0..MAX {\n-        for src_push_front in 0..MAX {\n+    for src_push_back in 0..max {\n+        for src_push_front in 0..max {\n             // doesn't pop more values than are pushed\n             for src_pop_back in 0..(src_push_back + src_push_front) {\n                 for src_pop_front in 0..(src_push_back + src_push_front - src_pop_back) {\n@@ -974,8 +972,8 @@ fn test_append_permutations() {\n                         src_pop_front,\n                     );\n \n-                    for dst_push_back in 0..MAX {\n-                        for dst_push_front in 0..MAX {\n+                    for dst_push_back in 0..max {\n+                        for dst_push_front in 0..max {\n                             for dst_pop_back in 0..(dst_push_back + dst_push_front) {\n                                 for dst_pop_front in\n                                     0..(dst_push_back + dst_push_front - dst_pop_back)"}]}