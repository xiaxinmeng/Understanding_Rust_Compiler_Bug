{"sha": "c1aa9bf84945642c0beec4838322502b88dccf03", "node_id": "C_kwDOAAsO6NoAKGMxYWE5YmY4NDk0NTY0MmMwYmVlYzQ4MzgzMjI1MDJiODhkY2NmMDM", "commit": {"author": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-09-26T23:13:12Z"}, "committer": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-10-15T17:46:03Z"}, "message": "Fix subst issues with RPITIT", "tree": {"sha": "fdf2470486dc07c4673144593b2b0acef6d5b765", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fdf2470486dc07c4673144593b2b0acef6d5b765"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c1aa9bf84945642c0beec4838322502b88dccf03", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c1aa9bf84945642c0beec4838322502b88dccf03", "html_url": "https://github.com/rust-lang/rust/commit/c1aa9bf84945642c0beec4838322502b88dccf03", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c1aa9bf84945642c0beec4838322502b88dccf03/comments", "author": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b8c35ca26b191bb9a9ac669a4b3f4d3d52d97fb1", "url": "https://api.github.com/repos/rust-lang/rust/commits/b8c35ca26b191bb9a9ac669a4b3f4d3d52d97fb1", "html_url": "https://github.com/rust-lang/rust/commit/b8c35ca26b191bb9a9ac669a4b3f4d3d52d97fb1"}], "stats": {"total": 79, "additions": 69, "deletions": 10}, "files": [{"sha": "986d5bed39ef74f8b1ff606daae97fce788859fc", "filename": "compiler/rustc_hir_analysis/src/check/compare_method.rs", "status": "modified", "additions": 31, "deletions": 6, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/c1aa9bf84945642c0beec4838322502b88dccf03/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fcompare_method.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c1aa9bf84945642c0beec4838322502b88dccf03/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fcompare_method.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fcompare_method.rs?ref=c1aa9bf84945642c0beec4838322502b88dccf03", "patch": "@@ -551,15 +551,40 @@ pub fn collect_trait_impl_trait_tys<'tcx>(\n                 let id_substs = InternalSubsts::identity_for_item(tcx, def_id);\n                 debug!(?id_substs, ?substs);\n                 let map: FxHashMap<ty::GenericArg<'tcx>, ty::GenericArg<'tcx>> =\n-                    substs.iter().enumerate().map(|(index, arg)| (arg, id_substs[index])).collect();\n+                    std::iter::zip(substs, id_substs).collect();\n                 debug!(?map);\n \n+                // NOTE(compiler-errors): RPITITs, like all other RPITs, have early-bound\n+                // region substs that are synthesized during AST lowering. These are substs\n+                // that are appended to the parent substs (trait and trait method). However,\n+                // we're trying to infer the unsubstituted type value of the RPITIT inside\n+                // the *impl*, so we can later use the impl's method substitutions to normalize\n+                // an RPITIT to a concrete type.\n+                //\n+                // Due to the design of RPITITs, during AST lowering, we have no idea that\n+                // an impl method is satisfying a trait method with RPITITs in it. Therefore,\n+                // we don't have a list ofearly-bound region substs for the RPITIT in the impl.\n+                // Since early region parameters are index-based, we can't just rebase these\n+                // (trait method) early-bound region substs onto the impl, since region\n+                // parameters are index-based, and there's no guarantee that the indices from\n+                // the trait substs and impl substs line up -- so we subtract the number of\n+                // trait substs and add the number of impl substs to *renumber* these early-\n+                // bound regions to their corresponding indices in the impl's substitutions list.\n+                //\n+                // Also, we only need to account for a difference in trait and impl substs,\n+                // since we previously enforce that the trait method and impl method have the\n+                // same generics.\n+                let num_trait_substs = trait_to_impl_substs.len();\n+                let num_impl_substs = tcx.generics_of(impl_m.container_id(tcx)).params.len();\n                 let ty = tcx.fold_regions(ty, |region, _| {\n-                    if let ty::ReFree(_) = region.kind() {\n-                        map[&region.into()].expect_region()\n-                    } else {\n-                        region\n-                    }\n+                    let ty::ReFree(_) = region.kind() else { return region; };\n+                    let ty::ReEarlyBound(e) = map[&region.into()].expect_region().kind()\n+                        else { bug!(\"expected ReFree to map to ReEarlyBound\"); };\n+                    tcx.mk_region(ty::ReEarlyBound(ty::EarlyBoundRegion {\n+                        def_id: e.def_id,\n+                        name: e.name,\n+                        index: (e.index as usize - num_trait_substs + num_impl_substs) as u32,\n+                    }))\n                 });\n                 debug!(%ty);\n                 collected_tys.insert(def_id, ty);"}, {"sha": "e552d3f1cc551d0edcd26bd7fa6298a179d82a76", "filename": "compiler/rustc_middle/src/ty/subst.rs", "status": "modified", "additions": 16, "deletions": 3, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/c1aa9bf84945642c0beec4838322502b88dccf03/compiler%2Frustc_middle%2Fsrc%2Fty%2Fsubst.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c1aa9bf84945642c0beec4838322502b88dccf03/compiler%2Frustc_middle%2Fsrc%2Fty%2Fsubst.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fsubst.rs?ref=c1aa9bf84945642c0beec4838322502b88dccf03", "patch": "@@ -606,9 +606,21 @@ impl<'a, 'tcx> TypeFolder<'tcx> for SubstFolder<'a, 'tcx> {\n     fn fold_region(&mut self, r: ty::Region<'tcx>) -> ty::Region<'tcx> {\n         #[cold]\n         #[inline(never)]\n-        fn region_param_out_of_range(data: ty::EarlyBoundRegion) -> ! {\n+        fn region_param_out_of_range(data: ty::EarlyBoundRegion, substs: &[GenericArg<'_>]) -> ! {\n             bug!(\n-                \"Region parameter out of range when substituting in region {} (index={})\",\n+                \"Region parameter out of range when substituting in region {} (index={}, substs = {:?})\",\n+                data.name,\n+                data.index,\n+                substs,\n+            )\n+        }\n+\n+        #[cold]\n+        #[inline(never)]\n+        fn region_param_invalid(data: ty::EarlyBoundRegion, other: GenericArgKind<'_>) -> ! {\n+            bug!(\n+                \"Unexpected parameter {:?} when substituting in region {} (index={})\",\n+                other,\n                 data.name,\n                 data.index\n             )\n@@ -624,7 +636,8 @@ impl<'a, 'tcx> TypeFolder<'tcx> for SubstFolder<'a, 'tcx> {\n                 let rk = self.substs.get(data.index as usize).map(|k| k.unpack());\n                 match rk {\n                     Some(GenericArgKind::Lifetime(lt)) => self.shift_region_through_binders(lt),\n-                    _ => region_param_out_of_range(data),\n+                    Some(other) => region_param_invalid(data, other),\n+                    None => region_param_out_of_range(data, self.substs),\n                 }\n             }\n             _ => r,"}, {"sha": "693c1728931549d83126278c6693ce511123a83a", "filename": "compiler/rustc_trait_selection/src/traits/project.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/c1aa9bf84945642c0beec4838322502b88dccf03/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fproject.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c1aa9bf84945642c0beec4838322502b88dccf03/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fproject.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fproject.rs?ref=c1aa9bf84945642c0beec4838322502b88dccf03", "patch": "@@ -2254,7 +2254,10 @@ fn confirm_impl_trait_in_trait_candidate<'tcx>(\n     }\n \n     let impl_fn_def_id = leaf_def.item.def_id;\n-    let impl_fn_substs = obligation.predicate.substs.rebase_onto(tcx, trait_fn_def_id, data.substs);\n+    // Rebase from {trait}::{fn}::{opaque} to {impl}::{fn}::{opaque},\n+    // since `data.substs` are the impl substs.\n+    let impl_fn_substs =\n+        obligation.predicate.substs.rebase_onto(tcx, tcx.parent(trait_fn_def_id), data.substs);\n \n     let cause = ObligationCause::new(\n         obligation.cause.span,"}, {"sha": "a93714a658ef0046a6e4d6f3a5f406c7ae6273ab", "filename": "src/test/ui/impl-trait/in-trait/issue-102301.rs", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/c1aa9bf84945642c0beec4838322502b88dccf03/src%2Ftest%2Fui%2Fimpl-trait%2Fin-trait%2Fissue-102301.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c1aa9bf84945642c0beec4838322502b88dccf03/src%2Ftest%2Fui%2Fimpl-trait%2Fin-trait%2Fissue-102301.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fimpl-trait%2Fin-trait%2Fissue-102301.rs?ref=c1aa9bf84945642c0beec4838322502b88dccf03", "patch": "@@ -0,0 +1,18 @@\n+// check-pass\n+\n+#![feature(return_position_impl_trait_in_trait)]\n+#![allow(incomplete_features)]\n+\n+trait Foo<T> {\n+    fn foo<F2: Foo<T>>(self) -> impl Foo<T>;\n+}\n+\n+struct Bar;\n+\n+impl Foo<u8> for Bar {\n+    fn foo<F2: Foo<u8>>(self) -> impl Foo<u8> {\n+        self\n+    }\n+}\n+\n+fn main() {}"}]}