{"sha": "1c8966e5e9dc099b55206f34af81242d03bdb413", "node_id": "C_kwDOAAsO6NoAKDFjODk2NmU1ZTlkYzA5OWI1NTIwNmYzNGFmODEyNDJkMDNiZGI0MTM", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-04-29T17:20:00Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-04-29T17:20:00Z"}, "message": "Auto merge of #96474 - SparrowLii:langcall, r=lcnr\n\nEliminate duplication code of building panic langcall during codegen\n\nFrom the FIXME in the `codegen_panic_intrinsic` func.", "tree": {"sha": "a2be0c09905633aad8c01d350ff47b6dcaa7867f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a2be0c09905633aad8c01d350ff47b6dcaa7867f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1c8966e5e9dc099b55206f34af81242d03bdb413", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1c8966e5e9dc099b55206f34af81242d03bdb413", "html_url": "https://github.com/rust-lang/rust/commit/1c8966e5e9dc099b55206f34af81242d03bdb413", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1c8966e5e9dc099b55206f34af81242d03bdb413/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f1d8a7d66237d72e6e61fc9c77cb2985eed21433", "url": "https://api.github.com/repos/rust-lang/rust/commits/f1d8a7d66237d72e6e61fc9c77cb2985eed21433", "html_url": "https://github.com/rust-lang/rust/commit/f1d8a7d66237d72e6e61fc9c77cb2985eed21433"}, {"sha": "cf00142b4db822735b31392ded7c039844411a74", "url": "https://api.github.com/repos/rust-lang/rust/commits/cf00142b4db822735b31392ded7c039844411a74", "html_url": "https://github.com/rust-lang/rust/commit/cf00142b4db822735b31392ded7c039844411a74"}], "stats": {"total": 43, "additions": 14, "deletions": 29}, "files": [{"sha": "1574b30497b4b38dbe8abce2d12b814d1f67a378", "filename": "compiler/rustc_codegen_ssa/src/common.rs", "status": "modified", "additions": 9, "deletions": 10, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/1c8966e5e9dc099b55206f34af81242d03bdb413/compiler%2Frustc_codegen_ssa%2Fsrc%2Fcommon.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1c8966e5e9dc099b55206f34af81242d03bdb413/compiler%2Frustc_codegen_ssa%2Fsrc%2Fcommon.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fcommon.rs?ref=1c8966e5e9dc099b55206f34af81242d03bdb413", "patch": "@@ -2,15 +2,13 @@\n \n use rustc_errors::struct_span_err;\n use rustc_hir as hir;\n-use rustc_hir::def_id::DefId;\n use rustc_hir::LangItem;\n use rustc_middle::mir::interpret::ConstValue;\n use rustc_middle::ty::{self, layout::TyAndLayout, Ty, TyCtxt};\n use rustc_session::Session;\n use rustc_span::Span;\n \n use crate::base;\n-use crate::traits::BuilderMethods;\n use crate::traits::*;\n \n pub enum IntPredicate {\n@@ -118,14 +116,15 @@ mod temp_stable_hash_impls {\n     }\n }\n \n-pub fn langcall(tcx: TyCtxt<'_>, span: Option<Span>, msg: &str, li: LangItem) -> DefId {\n-    tcx.lang_items().require(li).unwrap_or_else(|s| {\n-        let msg = format!(\"{} {}\", msg, s);\n-        match span {\n-            Some(span) => tcx.sess.span_fatal(span, &msg),\n-            None => tcx.sess.fatal(&msg),\n-        }\n-    })\n+pub fn build_langcall<'a, 'tcx, Bx: BuilderMethods<'a, 'tcx>>(\n+    bx: &Bx,\n+    span: Option<Span>,\n+    li: LangItem,\n+) -> (Bx::FnAbiOfResult, Bx::Value) {\n+    let tcx = bx.tcx();\n+    let def_id = tcx.require_lang_item(li, span);\n+    let instance = ty::Instance::mono(tcx, def_id);\n+    (bx.fn_abi_of_instance(instance, ty::List::empty()), bx.get_fn_addr(instance))\n }\n \n // To avoid UB from LLVM, these two functions mask RHS with an"}, {"sha": "a185eb298e0926b825002ec928295308fd2aa1c7", "filename": "compiler/rustc_codegen_ssa/src/mir/block.rs", "status": "modified", "additions": 5, "deletions": 19, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/1c8966e5e9dc099b55206f34af81242d03bdb413/compiler%2Frustc_codegen_ssa%2Fsrc%2Fmir%2Fblock.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1c8966e5e9dc099b55206f34af81242d03bdb413/compiler%2Frustc_codegen_ssa%2Fsrc%2Fmir%2Fblock.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fmir%2Fblock.rs?ref=1c8966e5e9dc099b55206f34af81242d03bdb413", "patch": "@@ -489,11 +489,7 @@ impl<'a, 'tcx, Bx: BuilderMethods<'a, 'tcx>> FunctionCx<'a, 'tcx, Bx> {\n             }\n         };\n \n-        // Obtain the panic entry point.\n-        let def_id = common::langcall(bx.tcx(), Some(span), \"\", lang_item);\n-        let instance = ty::Instance::mono(bx.tcx(), def_id);\n-        let fn_abi = bx.fn_abi_of_instance(instance, ty::List::empty());\n-        let llfn = bx.get_fn_addr(instance);\n+        let (fn_abi, llfn) = common::build_langcall(&bx, Some(span), lang_item);\n \n         // Codegen the actual panic invoke/call.\n         helper.do_call(self, &mut bx, fn_abi, llfn, &args, None, cleanup);\n@@ -509,10 +505,7 @@ impl<'a, 'tcx, Bx: BuilderMethods<'a, 'tcx>> FunctionCx<'a, 'tcx, Bx> {\n         self.set_debug_loc(&mut bx, terminator.source_info);\n \n         // Obtain the panic entry point.\n-        let def_id = common::langcall(bx.tcx(), Some(span), \"\", LangItem::PanicNoUnwind);\n-        let instance = ty::Instance::mono(bx.tcx(), def_id);\n-        let fn_abi = bx.fn_abi_of_instance(instance, ty::List::empty());\n-        let llfn = bx.get_fn_addr(instance);\n+        let (fn_abi, llfn) = common::build_langcall(&bx, Some(span), LangItem::PanicNoUnwind);\n \n         // Codegen the actual panic invoke/call.\n         helper.do_call(self, &mut bx, fn_abi, llfn, &[], None, None);\n@@ -573,12 +566,8 @@ impl<'a, 'tcx, Bx: BuilderMethods<'a, 'tcx>> FunctionCx<'a, 'tcx, Bx> {\n                 let location = self.get_caller_location(bx, source_info).immediate();\n \n                 // Obtain the panic entry point.\n-                // FIXME: dedup this with `codegen_assert_terminator` above.\n-                let def_id =\n-                    common::langcall(bx.tcx(), Some(source_info.span), \"\", LangItem::Panic);\n-                let instance = ty::Instance::mono(bx.tcx(), def_id);\n-                let fn_abi = bx.fn_abi_of_instance(instance, ty::List::empty());\n-                let llfn = bx.get_fn_addr(instance);\n+                let (fn_abi, llfn) =\n+                    common::build_langcall(bx, Some(source_info.span), LangItem::Panic);\n \n                 // Codegen the actual panic invoke/call.\n                 helper.do_call(\n@@ -1440,10 +1429,7 @@ impl<'a, 'tcx, Bx: BuilderMethods<'a, 'tcx>> FunctionCx<'a, 'tcx, Bx> {\n             let llretty = self.landing_pad_type();\n             bx.cleanup_landing_pad(llretty, llpersonality);\n \n-            let def_id = common::langcall(bx.tcx(), None, \"\", LangItem::PanicNoUnwind);\n-            let instance = ty::Instance::mono(bx.tcx(), def_id);\n-            let fn_abi = bx.fn_abi_of_instance(instance, ty::List::empty());\n-            let fn_ptr = bx.get_fn_addr(instance);\n+            let (fn_abi, fn_ptr) = common::build_langcall(&bx, None, LangItem::PanicNoUnwind);\n             let fn_ty = bx.fn_decl_backend_type(&fn_abi);\n \n             let llret = bx.call(fn_ty, fn_ptr, &[], None);"}]}