{"sha": "db6a62c537852a30f030f866598c358d01fb95cd", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRiNmE2MmM1Mzc4NTJhMzBmMDMwZjg2NjU5OGMzNThkMDFmYjk1Y2Q=", "commit": {"author": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2013-05-03T01:42:07Z"}, "committer": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2013-05-03T01:42:07Z"}, "message": "rustc: Drop the visitor object from the visitor glue\n\nRecent demoding makes the visitor glue leak. It hasn't shown up in tests\nbecause the box annihilator deletes the leaked boxes. This affects the\nnew scheduler though which does not yet have a box annihilator.\n\nI don't think there's any great way to test this besides setting up\na task that doesn't run the box annihilator and I don't know that that's\na capability we want tasks to have.", "tree": {"sha": "f198b030c5d6be7af09dc8dee0f25b6e9fa3759f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f198b030c5d6be7af09dc8dee0f25b6e9fa3759f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/db6a62c537852a30f030f866598c358d01fb95cd", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/db6a62c537852a30f030f866598c358d01fb95cd", "html_url": "https://github.com/rust-lang/rust/commit/db6a62c537852a30f030f866598c358d01fb95cd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/db6a62c537852a30f030f866598c358d01fb95cd/comments", "author": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "committer": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9847428acf91e313c9c742fc38c69546bcfc8b26", "url": "https://api.github.com/repos/rust-lang/rust/commits/9847428acf91e313c9c742fc38c69546bcfc8b26", "html_url": "https://github.com/rust-lang/rust/commit/9847428acf91e313c9c742fc38c69546bcfc8b26"}], "stats": {"total": 13, "additions": 9, "deletions": 4}, "files": [{"sha": "4025835495b58a12723c11d7f9d6e2ea04937a37", "filename": "src/librustc/middle/trans/glue.rs", "status": "modified", "additions": 9, "deletions": 4, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/db6a62c537852a30f030f866598c358d01fb95cd/src%2Flibrustc%2Fmiddle%2Ftrans%2Fglue.rs", "raw_url": "https://github.com/rust-lang/rust/raw/db6a62c537852a30f030f866598c358d01fb95cd/src%2Flibrustc%2Fmiddle%2Ftrans%2Fglue.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fglue.rs?ref=db6a62c537852a30f030f866598c358d01fb95cd", "patch": "@@ -394,10 +394,15 @@ pub fn call_tydesc_glue(cx: block, v: ValueRef, t: ty::t, field: uint)\n \n pub fn make_visit_glue(bcx: block, v: ValueRef, t: ty::t) {\n     let _icx = bcx.insn_ctxt(\"make_visit_glue\");\n-    let mut bcx = bcx;\n-    let (visitor_trait, object_ty) = ty::visitor_object_ty(bcx.tcx());\n-    let v = PointerCast(bcx, v, T_ptr(type_of::type_of(bcx.ccx(), object_ty)));\n-    bcx = reflect::emit_calls_to_trait_visit_ty(bcx, t, v, visitor_trait.def_id);\n+    let bcx = do with_scope(bcx, None, ~\"visitor cleanup\") |bcx| {\n+        let mut bcx = bcx;\n+        let (visitor_trait, object_ty) = ty::visitor_object_ty(bcx.tcx());\n+        let v = PointerCast(bcx, v, T_ptr(type_of::type_of(bcx.ccx(), object_ty)));\n+        bcx = reflect::emit_calls_to_trait_visit_ty(bcx, t, v, visitor_trait.def_id);\n+        // The visitor is a boxed object and needs to be dropped\n+        add_clean(bcx, v, object_ty);\n+        bcx\n+    };\n     build_return(bcx);\n }\n "}]}