{"sha": "a9bd049fc09445a20ab8a9283a24f1074403d061", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE5YmQwNDlmYzA5NDQ1YTIwYWI4YTkyODNhMjRmMTA3NDQwM2QwNjE=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2013-11-26T22:55:06Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2013-11-27T17:54:30Z"}, "message": "Relax restrictions on unknown feature directives\n\nInstead of forcibly always aborting compilation, allow usage of\n #[warn(unknown_features)] and related lint attributes to selectively abort\n compilation. By default, this lint is deny.", "tree": {"sha": "eb356b4d583646f03ff9fb9abf8cf317c2a34fb2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/eb356b4d583646f03ff9fb9abf8cf317c2a34fb2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a9bd049fc09445a20ab8a9283a24f1074403d061", "comment_count": 9, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a9bd049fc09445a20ab8a9283a24f1074403d061", "html_url": "https://github.com/rust-lang/rust/commit/a9bd049fc09445a20ab8a9283a24f1074403d061", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a9bd049fc09445a20ab8a9283a24f1074403d061/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e9a1869a5f4164d5311963b1b25b05f003d43699", "url": "https://api.github.com/repos/rust-lang/rust/commits/e9a1869a5f4164d5311963b1b25b05f003d43699", "html_url": "https://github.com/rust-lang/rust/commit/e9a1869a5f4164d5311963b1b25b05f003d43699"}], "stats": {"total": 39, "additions": 34, "deletions": 5}, "files": [{"sha": "99cd01367493aa7d5a8078706989b1249b0cfcba", "filename": "src/librustc/front/feature_gate.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/a9bd049fc09445a20ab8a9283a24f1074403d061/src%2Flibrustc%2Ffront%2Ffeature_gate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a9bd049fc09445a20ab8a9283a24f1074403d061/src%2Flibrustc%2Ffront%2Ffeature_gate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Ffront%2Ffeature_gate.rs?ref=a9bd049fc09445a20ab8a9283a24f1074403d061", "patch": "@@ -18,6 +18,8 @@\n //! Features are enabled in programs via the crate-level attributes of\n //! #[feature(...)] with a comma-separated list of features.\n \n+use middle::lint;\n+\n use syntax::ast;\n use syntax::attr::AttrMetaMethods;\n use syntax::codemap::Span;\n@@ -197,7 +199,10 @@ pub fn check_crate(sess: Session, crate: &ast::Crate) {\n                                                      directive not necessary\");\n                         }\n                         None => {\n-                            sess.span_err(mi.span, \"unknown feature\");\n+                            sess.add_lint(lint::unknown_features,\n+                                          ast::CRATE_NODE_ID,\n+                                          mi.span,\n+                                          ~\"unknown feature\");\n                         }\n                     }\n                 }"}, {"sha": "15fc34c0798f988a48b0bb99a8d02681b76f3fbe", "filename": "src/librustc/middle/lint.rs", "status": "modified", "additions": 11, "deletions": 1, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/a9bd049fc09445a20ab8a9283a24f1074403d061/src%2Flibrustc%2Fmiddle%2Flint.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a9bd049fc09445a20ab8a9283a24f1074403d061/src%2Flibrustc%2Fmiddle%2Flint.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Flint.rs?ref=a9bd049fc09445a20ab8a9283a24f1074403d061", "patch": "@@ -59,6 +59,7 @@ use syntax::codemap::Span;\n use syntax::codemap;\n use syntax::parse::token;\n use syntax::{ast, ast_util, visit};\n+use syntax::ast_util::IdVisitingOperation;\n use syntax::visit::Visitor;\n \n #[deriving(Clone, Eq)]\n@@ -77,6 +78,7 @@ pub enum lint {\n     unused_unsafe,\n     unsafe_block,\n     attribute_usage,\n+    unknown_features,\n \n     managed_heap_memory,\n     owned_heap_memory,\n@@ -321,6 +323,13 @@ static lint_table: &'static [(&'static str, LintSpec)] = &[\n         desc: \"mass-change the level for lints which produce warnings\",\n         default: warn\n     }),\n+\n+    (\"unknown_features\",\n+     LintSpec {\n+        lint: unknown_features,\n+        desc: \"unknown features found in create-level #[feature] directives\",\n+        default: deny,\n+    }),\n ];\n \n /*\n@@ -1319,7 +1328,7 @@ impl<'self> Visitor<()> for Context<'self> {\n     }\n }\n \n-impl<'self> ast_util::IdVisitingOperation for Context<'self> {\n+impl<'self> IdVisitingOperation for Context<'self> {\n     fn visit_id(&self, id: ast::NodeId) {\n         match self.tcx.sess.lints.pop(&id) {\n             None => {}\n@@ -1355,6 +1364,7 @@ pub fn check_crate(tcx: ty::ctxt,\n         cx.set_level(lint, level, CommandLine);\n     }\n     cx.with_lint_attrs(crate.attrs, |cx| {\n+        cx.visit_id(ast::CRATE_NODE_ID);\n         cx.visit_ids(|v| {\n             v.visited_outermost = true;\n             visit::walk_crate(v, crate, ());"}, {"sha": "ed4d32ada0987b3ffb1d556fb5b359fd4a1f519a", "filename": "src/test/compile-fail/gated-bad-feature.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/a9bd049fc09445a20ab8a9283a24f1074403d061/src%2Ftest%2Fcompile-fail%2Fgated-bad-feature.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a9bd049fc09445a20ab8a9283a24f1074403d061/src%2Ftest%2Fcompile-fail%2Fgated-bad-feature.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fgated-bad-feature.rs?ref=a9bd049fc09445a20ab8a9283a24f1074403d061", "patch": "@@ -13,9 +13,8 @@\n     foo(bar),\n     foo = \"baz\"\n )];\n-//~^^^^ ERROR: unknown feature\n-//~^^^^ ERROR: malformed feature\n-//~^^^^ ERROR: malformed feature\n+//~^^^ ERROR: malformed feature\n+//~^^^ ERROR: malformed feature\n \n #[feature]; //~ ERROR: malformed feature\n #[feature = \"foo\"]; //~ ERROR: malformed feature"}, {"sha": "15f446a671cac269bed490476be7a23321eefdc2", "filename": "src/test/compile-fail/lint-unknown-feature.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/a9bd049fc09445a20ab8a9283a24f1074403d061/src%2Ftest%2Fcompile-fail%2Flint-unknown-feature.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a9bd049fc09445a20ab8a9283a24f1074403d061/src%2Ftest%2Fcompile-fail%2Flint-unknown-feature.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Flint-unknown-feature.rs?ref=a9bd049fc09445a20ab8a9283a24f1074403d061", "patch": "@@ -0,0 +1,15 @@\n+// Copyright 2013 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#[deny(unknown_features)];\n+\n+#[feature(this_is_not_a_feature)]; //~ ERROR: unknown feature\n+\n+fn main() {}"}]}