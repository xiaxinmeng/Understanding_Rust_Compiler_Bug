{"sha": "24907f3507de7ce5d6908e3003e06a7f0b1a2ab6", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI0OTA3ZjM1MDdkZTdjZTVkNjkwOGUzMDAzZTA2YTdmMGIxYTJhYjY=", "commit": {"author": {"name": "Yuki Okushi", "email": "huyuumi.dev@gmail.com", "date": "2020-10-20T03:11:00Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-10-20T03:11:00Z"}, "message": "Rollup merge of #77778 - jyn514:git-hook, r=mark-simulacrum\n\n[x.py setup] Allow setting up git hooks from other worktrees\n\nCloses https://github.com/rust-lang/rust/issues/77684\nr? @caass", "tree": {"sha": "353a3ff9f47df8d90008bd95aa458a6826248d6a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/353a3ff9f47df8d90008bd95aa458a6826248d6a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/24907f3507de7ce5d6908e3003e06a7f0b1a2ab6", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfjlVECRBK7hj4Ov3rIwAAdHIIAD0dORmM1NweQr4RveKJoEfS\nI4LQf4J2vPWVeXK6jdQknHn6csrv+iMgJ4Yvw72lc0ArLfLjknZZYABQr0TF7eGh\nsHDziXlh5xh6j/+QhLlLyRofYKs4RaBv3RXxVQUqehv3phjvtuiqEP+EffVy2Cc+\nRjwap2HzrpHIcBgHGnaPE8jmHyWi+lLGM02qIzIKbd69/m3aiJhelXHGXu/aVYNw\nGYvAxUtrYTSLG6SvY8BN+VB4BUrrmpPFRMo3VDz98kwxTJC4a6HRhdnjjtmzardI\nOPbWNLu8tdaKmMZz9mg+KtnQiEyXIaQJz5dLaP84Hm8P3xcvo3XQ3wQE3AM3KDw=\n=ZGN5\n-----END PGP SIGNATURE-----\n", "payload": "tree 353a3ff9f47df8d90008bd95aa458a6826248d6a\nparent b09ef114bbd5f057803fc99f0b78a01e7c1138fa\nparent bd135674814d74ca6fca3ab79d778ecaaeb02cf5\nauthor Yuki Okushi <huyuumi.dev@gmail.com> 1603163460 +0900\ncommitter GitHub <noreply@github.com> 1603163460 +0900\n\nRollup merge of #77778 - jyn514:git-hook, r=mark-simulacrum\n\n[x.py setup] Allow setting up git hooks from other worktrees\n\nCloses https://github.com/rust-lang/rust/issues/77684\nr? @caass\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/24907f3507de7ce5d6908e3003e06a7f0b1a2ab6", "html_url": "https://github.com/rust-lang/rust/commit/24907f3507de7ce5d6908e3003e06a7f0b1a2ab6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/24907f3507de7ce5d6908e3003e06a7f0b1a2ab6/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b09ef114bbd5f057803fc99f0b78a01e7c1138fa", "url": "https://api.github.com/repos/rust-lang/rust/commits/b09ef114bbd5f057803fc99f0b78a01e7c1138fa", "html_url": "https://github.com/rust-lang/rust/commit/b09ef114bbd5f057803fc99f0b78a01e7c1138fa"}, {"sha": "bd135674814d74ca6fca3ab79d778ecaaeb02cf5", "url": "https://api.github.com/repos/rust-lang/rust/commits/bd135674814d74ca6fca3ab79d778ecaaeb02cf5", "html_url": "https://github.com/rust-lang/rust/commit/bd135674814d74ca6fca3ab79d778ecaaeb02cf5"}], "stats": {"total": 14, "additions": 11, "deletions": 3}, "files": [{"sha": "c6e1c99564c09fbc3fe8626bb418042a37595bbd", "filename": "src/bootstrap/setup.rs", "status": "modified", "additions": 11, "deletions": 3, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/24907f3507de7ce5d6908e3003e06a7f0b1a2ab6/src%2Fbootstrap%2Fsetup.rs", "raw_url": "https://github.com/rust-lang/rust/raw/24907f3507de7ce5d6908e3003e06a7f0b1a2ab6/src%2Fbootstrap%2Fsetup.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fsetup.rs?ref=24907f3507de7ce5d6908e3003e06a7f0b1a2ab6", "patch": "@@ -1,6 +1,7 @@\n use crate::{t, VERSION};\n use std::fmt::Write as _;\n use std::path::{Path, PathBuf};\n+use std::process::Command;\n use std::str::FromStr;\n use std::{\n     env, fmt, fs,\n@@ -196,10 +197,17 @@ simply delete the `pre-commit` file from .git/hooks.\"\n \n     Ok(if should_install {\n         let src = src_path.join(\"src\").join(\"etc\").join(\"pre-commit.sh\");\n-        let dst = src_path.join(\".git\").join(\"hooks\").join(\"pre-commit\");\n-        match fs::hard_link(src, dst) {\n+        let git = t!(Command::new(\"git\").args(&[\"rev-parse\", \"--git-common-dir\"]).output().map(\n+            |output| {\n+                assert!(output.status.success(), \"failed to run `git`\");\n+                PathBuf::from(t!(String::from_utf8(output.stdout)).trim())\n+            }\n+        ));\n+        let dst = git.join(\"hooks\").join(\"pre-commit\");\n+        match fs::hard_link(src, &dst) {\n             Err(e) => println!(\n-                \"x.py encountered an error -- do you already have the git hook installed?\\n{}\",\n+                \"error: could not create hook {}: do you already have the git hook installed?\\n{}\",\n+                dst.display(),\n                 e\n             ),\n             Ok(_) => println!(\"Linked `src/etc/pre-commit.sh` to `.git/hooks/pre-commit`\"),"}]}