{"sha": "98dae86d214226b2d9bf400bae39f040f279821b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjk4ZGFlODZkMjE0MjI2YjJkOWJmNDAwYmFlMzlmMDQwZjI3OTgyMWI=", "commit": {"author": {"name": "bjorn3", "email": "bjorn3@users.noreply.github.com", "date": "2019-05-04T14:15:20Z"}, "committer": {"name": "bjorn3", "email": "bjorn3@users.noreply.github.com", "date": "2019-05-04T14:15:20Z"}, "message": "Update cranelift", "tree": {"sha": "651041260d58793b106e75599c85d9e72bbc4bfd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/651041260d58793b106e75599c85d9e72bbc4bfd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/98dae86d214226b2d9bf400bae39f040f279821b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/98dae86d214226b2d9bf400bae39f040f279821b", "html_url": "https://github.com/rust-lang/rust/commit/98dae86d214226b2d9bf400bae39f040f279821b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/98dae86d214226b2d9bf400bae39f040f279821b/comments", "author": {"login": "bjorn3", "id": 17426603, "node_id": "MDQ6VXNlcjE3NDI2NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/17426603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bjorn3", "html_url": "https://github.com/bjorn3", "followers_url": "https://api.github.com/users/bjorn3/followers", "following_url": "https://api.github.com/users/bjorn3/following{/other_user}", "gists_url": "https://api.github.com/users/bjorn3/gists{/gist_id}", "starred_url": "https://api.github.com/users/bjorn3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bjorn3/subscriptions", "organizations_url": "https://api.github.com/users/bjorn3/orgs", "repos_url": "https://api.github.com/users/bjorn3/repos", "events_url": "https://api.github.com/users/bjorn3/events{/privacy}", "received_events_url": "https://api.github.com/users/bjorn3/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bjorn3", "id": 17426603, "node_id": "MDQ6VXNlcjE3NDI2NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/17426603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bjorn3", "html_url": "https://github.com/bjorn3", "followers_url": "https://api.github.com/users/bjorn3/followers", "following_url": "https://api.github.com/users/bjorn3/following{/other_user}", "gists_url": "https://api.github.com/users/bjorn3/gists{/gist_id}", "starred_url": "https://api.github.com/users/bjorn3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bjorn3/subscriptions", "organizations_url": "https://api.github.com/users/bjorn3/orgs", "repos_url": "https://api.github.com/users/bjorn3/repos", "events_url": "https://api.github.com/users/bjorn3/events{/privacy}", "received_events_url": "https://api.github.com/users/bjorn3/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8598a34e4514e90bf22eba00ec07c6cee5842df7", "url": "https://api.github.com/repos/rust-lang/rust/commits/8598a34e4514e90bf22eba00ec07c6cee5842df7", "html_url": "https://github.com/rust-lang/rust/commit/8598a34e4514e90bf22eba00ec07c6cee5842df7"}], "stats": {"total": 38, "additions": 21, "deletions": 17}, "files": [{"sha": "19ef265e754a318bd2b07cdc536f38f6ff166f8b", "filename": "Cargo.lock", "status": "modified", "additions": 10, "deletions": 10, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/98dae86d214226b2d9bf400bae39f040f279821b/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/98dae86d214226b2d9bf400bae39f040f279821b/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=98dae86d214226b2d9bf400bae39f040f279821b", "patch": "@@ -114,7 +114,7 @@ dependencies = [\n [[package]]\n name = \"cranelift\"\n version = \"0.30.0\"\n-source = \"git+https://github.com/CraneStation/cranelift.git#c0ee30f9a95bd80bd6485c21bad7e8e0b8c5caf0\"\n+source = \"git+https://github.com/CraneStation/cranelift.git#a1d8fbc8dda7984edcf334c8e3d0e4ecd6c04968\"\n dependencies = [\n  \"cranelift-codegen 0.30.0 (git+https://github.com/CraneStation/cranelift.git)\",\n  \"cranelift-frontend 0.30.0 (git+https://github.com/CraneStation/cranelift.git)\",\n@@ -123,15 +123,15 @@ dependencies = [\n [[package]]\n name = \"cranelift-bforest\"\n version = \"0.30.0\"\n-source = \"git+https://github.com/CraneStation/cranelift.git#c0ee30f9a95bd80bd6485c21bad7e8e0b8c5caf0\"\n+source = \"git+https://github.com/CraneStation/cranelift.git#a1d8fbc8dda7984edcf334c8e3d0e4ecd6c04968\"\n dependencies = [\n  \"cranelift-entity 0.30.0 (git+https://github.com/CraneStation/cranelift.git)\",\n ]\n \n [[package]]\n name = \"cranelift-codegen\"\n version = \"0.30.0\"\n-source = \"git+https://github.com/CraneStation/cranelift.git#c0ee30f9a95bd80bd6485c21bad7e8e0b8c5caf0\"\n+source = \"git+https://github.com/CraneStation/cranelift.git#a1d8fbc8dda7984edcf334c8e3d0e4ecd6c04968\"\n dependencies = [\n  \"cranelift-bforest 0.30.0 (git+https://github.com/CraneStation/cranelift.git)\",\n  \"cranelift-codegen-meta 0.30.0 (git+https://github.com/CraneStation/cranelift.git)\",\n@@ -145,20 +145,20 @@ dependencies = [\n [[package]]\n name = \"cranelift-codegen-meta\"\n version = \"0.30.0\"\n-source = \"git+https://github.com/CraneStation/cranelift.git#c0ee30f9a95bd80bd6485c21bad7e8e0b8c5caf0\"\n+source = \"git+https://github.com/CraneStation/cranelift.git#a1d8fbc8dda7984edcf334c8e3d0e4ecd6c04968\"\n dependencies = [\n  \"cranelift-entity 0.30.0 (git+https://github.com/CraneStation/cranelift.git)\",\n ]\n \n [[package]]\n name = \"cranelift-entity\"\n version = \"0.30.0\"\n-source = \"git+https://github.com/CraneStation/cranelift.git#c0ee30f9a95bd80bd6485c21bad7e8e0b8c5caf0\"\n+source = \"git+https://github.com/CraneStation/cranelift.git#a1d8fbc8dda7984edcf334c8e3d0e4ecd6c04968\"\n \n [[package]]\n name = \"cranelift-faerie\"\n version = \"0.30.0\"\n-source = \"git+https://github.com/CraneStation/cranelift.git#c0ee30f9a95bd80bd6485c21bad7e8e0b8c5caf0\"\n+source = \"git+https://github.com/CraneStation/cranelift.git#a1d8fbc8dda7984edcf334c8e3d0e4ecd6c04968\"\n dependencies = [\n  \"cranelift-codegen 0.30.0 (git+https://github.com/CraneStation/cranelift.git)\",\n  \"cranelift-module 0.30.0 (git+https://github.com/CraneStation/cranelift.git)\",\n@@ -171,7 +171,7 @@ dependencies = [\n [[package]]\n name = \"cranelift-frontend\"\n version = \"0.30.0\"\n-source = \"git+https://github.com/CraneStation/cranelift.git#c0ee30f9a95bd80bd6485c21bad7e8e0b8c5caf0\"\n+source = \"git+https://github.com/CraneStation/cranelift.git#a1d8fbc8dda7984edcf334c8e3d0e4ecd6c04968\"\n dependencies = [\n  \"cranelift-codegen 0.30.0 (git+https://github.com/CraneStation/cranelift.git)\",\n  \"log 0.4.6 (registry+https://github.com/rust-lang/crates.io-index)\",\n@@ -181,7 +181,7 @@ dependencies = [\n [[package]]\n name = \"cranelift-module\"\n version = \"0.30.0\"\n-source = \"git+https://github.com/CraneStation/cranelift.git#c0ee30f9a95bd80bd6485c21bad7e8e0b8c5caf0\"\n+source = \"git+https://github.com/CraneStation/cranelift.git#a1d8fbc8dda7984edcf334c8e3d0e4ecd6c04968\"\n dependencies = [\n  \"cranelift-codegen 0.30.0 (git+https://github.com/CraneStation/cranelift.git)\",\n  \"cranelift-entity 0.30.0 (git+https://github.com/CraneStation/cranelift.git)\",\n@@ -192,7 +192,7 @@ dependencies = [\n [[package]]\n name = \"cranelift-native\"\n version = \"0.30.0\"\n-source = \"git+https://github.com/CraneStation/cranelift.git#c0ee30f9a95bd80bd6485c21bad7e8e0b8c5caf0\"\n+source = \"git+https://github.com/CraneStation/cranelift.git#a1d8fbc8dda7984edcf334c8e3d0e4ecd6c04968\"\n dependencies = [\n  \"cranelift-codegen 0.30.0 (git+https://github.com/CraneStation/cranelift.git)\",\n  \"raw-cpuid 6.1.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n@@ -202,7 +202,7 @@ dependencies = [\n [[package]]\n name = \"cranelift-simplejit\"\n version = \"0.30.0\"\n-source = \"git+https://github.com/CraneStation/cranelift.git#c0ee30f9a95bd80bd6485c21bad7e8e0b8c5caf0\"\n+source = \"git+https://github.com/CraneStation/cranelift.git#a1d8fbc8dda7984edcf334c8e3d0e4ecd6c04968\"\n dependencies = [\n  \"cranelift-codegen 0.30.0 (git+https://github.com/CraneStation/cranelift.git)\",\n  \"cranelift-module 0.30.0 (git+https://github.com/CraneStation/cranelift.git)\","}, {"sha": "282f429d74de23fcfffb278c124c7f6e1442412d", "filename": "src/constant.rs", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/98dae86d214226b2d9bf400bae39f040f279821b/src%2Fconstant.rs", "raw_url": "https://github.com/rust-lang/rust/raw/98dae86d214226b2d9bf400bae39f040f279821b/src%2Fconstant.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fconstant.rs?ref=98dae86d214226b2d9bf400bae39f040f279821b", "patch": "@@ -179,7 +179,7 @@ fn trans_const_place<'a, 'tcx: 'a>(\n \n fn data_id_for_alloc_id<B: Backend>(module: &mut Module<B>, alloc_id: AllocId) -> DataId {\n     module\n-        .declare_data(&format!(\"__alloc_{}\", alloc_id.0), Linkage::Local, false)\n+        .declare_data(&format!(\"__alloc_{}\", alloc_id.0), Linkage::Local, false, None)\n         .unwrap()\n }\n \n@@ -190,15 +190,16 @@ fn data_id_for_static<'a, 'tcx: 'a, B: Backend>(\n     linkage: Linkage,\n ) -> DataId {\n     let symbol_name = tcx.symbol_name(Instance::mono(tcx, def_id)).as_str();\n+    let ty = tcx.type_of(def_id);\n     let is_mutable = if tcx.is_mutable_static(def_id) {\n         true\n     } else {\n-        !tcx.type_of(def_id)\n-            .is_freeze(tcx, ParamEnv::reveal_all(), DUMMY_SP)\n+        !ty.is_freeze(tcx, ParamEnv::reveal_all(), DUMMY_SP)\n     };\n+    let align = tcx.layout_of(ParamEnv::reveal_all().and(ty)).unwrap().align.pref.bytes();\n \n     let data_id = module\n-        .declare_data(&*symbol_name, linkage, is_mutable)\n+        .declare_data(&*symbol_name, linkage, is_mutable, Some(align.try_into().unwrap()))\n         .unwrap();\n \n     if linkage == Linkage::Preemptible {"}, {"sha": "95eb75c22c828b7dd4030d3d3cb248353d70f4a5", "filename": "src/lib.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/98dae86d214226b2d9bf400bae39f040f279821b/src%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/98dae86d214226b2d9bf400bae39f040f279821b/src%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flib.rs?ref=98dae86d214226b2d9bf400bae39f040f279821b", "patch": "@@ -57,6 +57,7 @@ mod vtable;\n mod prelude {\n     pub use std::any::Any;\n     pub use std::collections::{HashMap, HashSet};\n+    pub use std::convert::TryInto;\n \n     pub use syntax::ast::{FloatTy, IntTy, UintTy};\n     pub use syntax::source_map::{Pos, Span, DUMMY_SP};\n@@ -213,7 +214,8 @@ impl CodegenBackend for CraneliftCodegenBackend {\n         };\n \n         if std::env::var(\"SHOULD_RUN\").is_ok() {\n-            let mut jit_module: Module<SimpleJITBackend> = Module::new(SimpleJITBuilder::new());\n+            let mut jit_module: Module<SimpleJITBackend> =\n+                Module::new(SimpleJITBuilder::new(cranelift_module::default_libcall_names()));\n             assert_eq!(pointer_ty(tcx), jit_module.target_config().pointer_type());\n \n             let sig = Signature {\n@@ -263,7 +265,7 @@ impl CodegenBackend for CraneliftCodegenBackend {\n                         build_isa(tcx.sess),\n                         name + \".o\",\n                         FaerieTrapCollection::Disabled,\n-                        FaerieBuilder::default_libcall_names(),\n+                        cranelift_module::default_libcall_names(),\n                     )\n                     .unwrap(),\n                 );"}, {"sha": "925d59ac255e00ec3bb7d432ae016afa3e0ec904", "filename": "src/trap.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/98dae86d214226b2d9bf400bae39f040f279821b/src%2Ftrap.rs", "raw_url": "https://github.com/rust-lang/rust/raw/98dae86d214226b2d9bf400bae39f040f279821b/src%2Ftrap.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftrap.rs?ref=98dae86d214226b2d9bf400bae39f040f279821b", "patch": "@@ -12,7 +12,7 @@ fn codegen_print(fx: &mut FunctionCx<'_, '_, impl cranelift_module::Backend>, ms\n     let msg_bytes = format!(\"trap at {:?} ({}): {}\\0\", fx.instance, symbol_name, msg).into_bytes().into_boxed_slice();\n     let mut data_ctx = DataContext::new();\n     data_ctx.define(msg_bytes);\n-    let msg_id = fx.module.declare_data(&(symbol_name.as_str().to_string() + msg), Linkage::Local, false).unwrap();\n+    let msg_id = fx.module.declare_data(&(symbol_name.as_str().to_string() + msg), Linkage::Local, false, None).unwrap();\n \n     // Ignore DuplicateDefinition error, as the data will be the same\n     let _ = fx.module.define_data(msg_id, &data_ctx);"}, {"sha": "a19b6b458c4083d068112214e5a54fd538e7ceb8", "filename": "src/vtable.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/98dae86d214226b2d9bf400bae39f040f279821b/src%2Fvtable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/98dae86d214226b2d9bf400bae39f040f279821b/src%2Fvtable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fvtable.rs?ref=98dae86d214226b2d9bf400bae39f040f279821b", "patch": "@@ -136,6 +136,7 @@ fn build_vtable<'a, 'tcx: 'a>(\n             &format!(\"vtable.{:?}.for.{:?}\", trait_ref, ty),\n             Linkage::Local,\n             false,\n+            Some(fx.tcx.data_layout.pointer_align.pref.bytes().try_into().unwrap())\n         )\n         .unwrap();\n "}]}