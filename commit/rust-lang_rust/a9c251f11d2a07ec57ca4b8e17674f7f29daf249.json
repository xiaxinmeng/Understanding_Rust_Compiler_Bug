{"sha": "a9c251f11d2a07ec57ca4b8e17674f7f29daf249", "node_id": "C_kwDOAAsO6NoAKGE5YzI1MWYxMWQyYTA3ZWM1N2NhNGI4ZTE3Njc0ZjdmMjlkYWYyNDk", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-01-22T14:10:16Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-01-22T14:10:16Z"}, "message": "Auto merge of #10106 - koka831:fix/10084, r=Alexendoo\n\nFix FP in `unnecessary_safety_comment`\n\nFix https://github.com/rust-lang/rust-clippy/issues/10084\n\nchangelog: FP: [`unnecessary_safety_comment`]: No longer lints code inside macros\n[#10106](https://github.com/rust-lang/rust-clippy/pull/10106)\n<!-- changelog_checked -->", "tree": {"sha": "9052c0224d0dc6cf2b2e8d4f8749c08a5b5bc3e7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9052c0224d0dc6cf2b2e8d4f8749c08a5b5bc3e7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a9c251f11d2a07ec57ca4b8e17674f7f29daf249", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a9c251f11d2a07ec57ca4b8e17674f7f29daf249", "html_url": "https://github.com/rust-lang/rust/commit/a9c251f11d2a07ec57ca4b8e17674f7f29daf249", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a9c251f11d2a07ec57ca4b8e17674f7f29daf249/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9d1bb8037157d68d6195770d72de96528351fa29", "url": "https://api.github.com/repos/rust-lang/rust/commits/9d1bb8037157d68d6195770d72de96528351fa29", "html_url": "https://github.com/rust-lang/rust/commit/9d1bb8037157d68d6195770d72de96528351fa29"}, {"sha": "1a7ef02dcb65ee4aa9e7679ad0ce7e8a42bee6bf", "url": "https://api.github.com/repos/rust-lang/rust/commits/1a7ef02dcb65ee4aa9e7679ad0ce7e8a42bee6bf", "html_url": "https://github.com/rust-lang/rust/commit/1a7ef02dcb65ee4aa9e7679ad0ce7e8a42bee6bf"}], "stats": {"total": 29, "additions": 29, "deletions": 0}, "files": [{"sha": "2920684ade33cd89a98e949da70c3fa8a702694b", "filename": "clippy_lints/src/undocumented_unsafe_blocks.rs", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/a9c251f11d2a07ec57ca4b8e17674f7f29daf249/clippy_lints%2Fsrc%2Fundocumented_unsafe_blocks.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a9c251f11d2a07ec57ca4b8e17674f7f29daf249/clippy_lints%2Fsrc%2Fundocumented_unsafe_blocks.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fundocumented_unsafe_blocks.rs?ref=a9c251f11d2a07ec57ca4b8e17674f7f29daf249", "patch": "@@ -263,6 +263,18 @@ fn expr_has_unnecessary_safety_comment<'tcx>(\n     expr: &'tcx hir::Expr<'tcx>,\n     comment_pos: BytePos,\n ) -> Option<Span> {\n+    if cx.tcx.hir().parent_iter(expr.hir_id).any(|(_, ref node)| {\n+        matches!(\n+            node,\n+            Node::Block(&Block {\n+                rules: BlockCheckMode::UnsafeBlock(UnsafeSource::UserProvided),\n+                ..\n+            }),\n+        )\n+    }) {\n+        return None;\n+    }\n+\n     // this should roughly be the reverse of `block_parents_have_safety_comment`\n     if for_each_expr_with_closures(cx, expr, |expr| match expr.kind {\n         hir::ExprKind::Block("}, {"sha": "89fedb145f88bd2c75748559237c58477e0fe6a3", "filename": "tests/ui/unnecessary_safety_comment.rs", "status": "modified", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/a9c251f11d2a07ec57ca4b8e17674f7f29daf249/tests%2Fui%2Funnecessary_safety_comment.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a9c251f11d2a07ec57ca4b8e17674f7f29daf249/tests%2Fui%2Funnecessary_safety_comment.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Funnecessary_safety_comment.rs?ref=a9c251f11d2a07ec57ca4b8e17674f7f29daf249", "patch": "@@ -48,4 +48,21 @@ fn unnecessary_on_stmt_and_expr() -> u32 {\n     24\n }\n \n+mod issue_10084 {\n+    unsafe fn bar() -> i32 {\n+        42\n+    }\n+\n+    macro_rules! foo {\n+        () => {\n+            // SAFETY: This is necessary\n+            unsafe { bar() }\n+        };\n+    }\n+\n+    fn main() {\n+        foo!();\n+    }\n+}\n+\n fn main() {}"}]}