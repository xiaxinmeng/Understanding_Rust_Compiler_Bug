{"sha": "f902200de4a722908919da701c05244fed3dabc5", "node_id": "C_kwDOAAsO6NoAKGY5MDIyMDBkZTRhNzIyOTA4OTE5ZGE3MDFjMDUyNDRmZWQzZGFiYzU", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume.gomez@huawei.com", "date": "2023-01-04T11:27:05Z"}, "committer": {"name": "Guillaume Gomez", "email": "guillaume.gomez@huawei.com", "date": "2023-01-04T15:45:28Z"}, "message": "Add retry mechanism for rustdoc GUI tests to reduce flakyness", "tree": {"sha": "4b39aa07af76b5609da3f8f5089e4e6334f452c8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4b39aa07af76b5609da3f8f5089e4e6334f452c8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f902200de4a722908919da701c05244fed3dabc5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f902200de4a722908919da701c05244fed3dabc5", "html_url": "https://github.com/rust-lang/rust/commit/f902200de4a722908919da701c05244fed3dabc5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f902200de4a722908919da701c05244fed3dabc5/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c1567730c0ea07e41fcabd14332ad701857d9f93", "url": "https://api.github.com/repos/rust-lang/rust/commits/c1567730c0ea07e41fcabd14332ad701857d9f93", "html_url": "https://github.com/rust-lang/rust/commit/c1567730c0ea07e41fcabd14332ad701857d9f93"}], "stats": {"total": 122, "additions": 76, "deletions": 46}, "files": [{"sha": "900ca389436254276107f6dbff349e622b2463d2", "filename": "src/tools/rustdoc-gui/tester.js", "status": "modified", "additions": 76, "deletions": 46, "changes": 122, "blob_url": "https://github.com/rust-lang/rust/blob/f902200de4a722908919da701c05244fed3dabc5/src%2Ftools%2Frustdoc-gui%2Ftester.js", "raw_url": "https://github.com/rust-lang/rust/raw/f902200de4a722908919da701c05244fed3dabc5/src%2Ftools%2Frustdoc-gui%2Ftester.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Frustdoc-gui%2Ftester.js?ref=f902200de4a722908919da701c05244fed3dabc5", "patch": "@@ -9,6 +9,9 @@ const path = require(\"path\");\n const os = require('os');\n const {Options, runTest} = require('browser-ui-test');\n \n+// If a test fails or errors, we will retry it two more times in case it was a flaky failure.\n+const NB_RETRY = 3;\n+\n function showHelp() {\n     console.log(\"rustdoc-js options:\");\n     console.log(\"  --doc-folder [PATH]        : location of the generated doc folder\");\n@@ -129,11 +132,59 @@ function char_printer(n_tests) {\n     };\n }\n \n-/// Sort array by .file_name property\n+// Sort array by .file_name property\n function by_filename(a, b) {\n     return a.file_name - b.file_name;\n }\n \n+async function runTests(opts, framework_options, files, results, status_bar, showTestFailures) {\n+    const tests_queue = [];\n+\n+    for (const testPath of files) {\n+        const callback = runTest(testPath, framework_options)\n+            .then(out => {\n+                const [output, nb_failures] = out;\n+                results[nb_failures === 0 ? \"successful\" : \"failed\"].push({\n+                    file_name: testPath,\n+                    output: output,\n+                });\n+                if (nb_failures === 0) {\n+                    status_bar.successful();\n+                } else if (showTestFailures) {\n+                    status_bar.erroneous();\n+                }\n+            })\n+            .catch(err => {\n+                results.errored.push({\n+                    file_name: testPath,\n+                    output: err,\n+                });\n+                if (showTestFailures) {\n+                    status_bar.erroneous();\n+                }\n+            })\n+            .finally(() => {\n+                // We now remove the promise from the tests_queue.\n+                tests_queue.splice(tests_queue.indexOf(callback), 1);\n+            });\n+        tests_queue.push(callback);\n+        if (opts[\"jobs\"] > 0 && tests_queue.length >= opts[\"jobs\"]) {\n+            await Promise.race(tests_queue);\n+        }\n+    }\n+    if (tests_queue.length > 0) {\n+        await Promise.all(tests_queue);\n+    }\n+}\n+\n+function createEmptyResults() {\n+    return {\n+        successful: [],\n+        failed: [],\n+        errored: [],\n+    };\n+}\n+\n async function main(argv) {\n     let opts = parseOptions(argv.slice(2));\n     if (opts === null) {\n@@ -144,7 +195,7 @@ async function main(argv) {\n     let debug = false;\n     // Run tests in sequentially\n     let headless = true;\n-    const options = new Options();\n+    const framework_options = new Options();\n     try {\n         // This is more convenient that setting fields one by one.\n         let args = [\n@@ -169,13 +220,12 @@ async function main(argv) {\n             args.push(\"--executable-path\");\n             args.push(opts[\"executable_path\"]);\n         }\n-        options.parseArguments(args);\n+        framework_options.parseArguments(args);\n     } catch (error) {\n         console.error(`invalid argument: ${error}`);\n         process.exit(1);\n     }\n \n-    let failed = false;\n     let files;\n     if (opts[\"files\"].length === 0) {\n         files = fs.readdirSync(opts[\"tests_folder\"]);\n@@ -187,6 +237,9 @@ async function main(argv) {\n         console.error(\"rustdoc-gui: No test selected\");\n         process.exit(2);\n     }\n+    files.forEach((file_name, index) => {\n+        files[index] = path.join(opts[\"tests_folder\"], file_name);\n+    });\n     files.sort();\n \n     if (!headless) {\n@@ -215,52 +268,29 @@ async function main(argv) {\n     };\n     process.on('exit', exitHandling);\n \n-    const tests_queue = [];\n-    let results = {\n-        successful: [],\n-        failed: [],\n-        errored: [],\n-    };\n+    const originalFilesLen = files.length;\n+    let results = createEmptyResults();\n     const status_bar = char_printer(files.length);\n-    for (let i = 0; i < files.length; ++i) {\n-        const file_name = files[i];\n-        const testPath = path.join(opts[\"tests_folder\"], file_name);\n-        const callback = runTest(testPath, options)\n-            .then(out => {\n-                const [output, nb_failures] = out;\n-                results[nb_failures === 0 ? \"successful\" : \"failed\"].push({\n-                    file_name: testPath,\n-                    output: output,\n-                });\n-                if (nb_failures > 0) {\n-                    status_bar.erroneous();\n-                    failed = true;\n-                } else {\n-                    status_bar.successful();\n-                }\n-            })\n-            .catch(err => {\n-                results.errored.push({\n-                    file_name: testPath + file_name,\n-                    output: err,\n-                });\n-                status_bar.erroneous();\n-                failed = true;\n-            })\n-            .finally(() => {\n-                // We now remove the promise from the tests_queue.\n-                tests_queue.splice(tests_queue.indexOf(callback), 1);\n-            });\n-        tests_queue.push(callback);\n-        if (opts[\"jobs\"] > 0 && tests_queue.length >= opts[\"jobs\"]) {\n-            await Promise.race(tests_queue);\n+\n+    let new_results;\n+    for (let it = 0; it < NB_RETRY && files.length > 0; ++it) {\n+        new_results = createEmptyResults();\n+        await runTests(opts, framework_options, files, new_results, status_bar, it + 1 >= NB_RETRY);\n+        Array.prototype.push.apply(results.successful, new_results.successful);\n+        // We generate the new list of files with the previously failing tests.\n+        files = Array.prototype.concat(new_results.failed, new_results.errored);\n+        if (files.length > originalFilesLen / 2) {\n+            // If we have too many failing tests, it's very likely not flaky failures anymore so\n+            // no need to retry.\n+            break;\n         }\n     }\n-    if (tests_queue.length > 0) {\n-        await Promise.all(tests_queue);\n-    }\n+\n     status_bar.finish();\n \n+    Array.prototype.push.apply(results.failed, new_results.failed);\n+    Array.prototype.push.apply(results.errored, new_results.errored);\n+\n     // We don't need this listener anymore.\n     process.removeListener(\"exit\", exitHandling);\n \n@@ -287,7 +317,7 @@ async function main(argv) {\n         });\n     }\n \n-    if (failed) {\n+    if (results.failed.length > 0 || results.errored.length > 0) {\n         process.exit(1);\n     }\n }"}]}