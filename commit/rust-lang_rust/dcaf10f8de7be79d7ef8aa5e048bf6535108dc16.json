{"sha": "dcaf10f8de7be79d7ef8aa5e048bf6535108dc16", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRjYWYxMGY4ZGU3YmU3OWQ3ZWY4YWE1ZTA0OGJmNjUzNTEwOGRjMTY=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2014-01-04T08:06:13Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2014-01-04T08:08:03Z"}, "message": "Add a stack_bounds function to the Runtime trait\n\nThis allows inspection of the current task's bounds regardless of what the\nunderlying task is.\n\nCloses #11293", "tree": {"sha": "2a5a09d84e6db2421076fe36f407f736e989266e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2a5a09d84e6db2421076fe36f407f736e989266e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/dcaf10f8de7be79d7ef8aa5e048bf6535108dc16", "comment_count": 5, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/dcaf10f8de7be79d7ef8aa5e048bf6535108dc16", "html_url": "https://github.com/rust-lang/rust/commit/dcaf10f8de7be79d7ef8aa5e048bf6535108dc16", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/dcaf10f8de7be79d7ef8aa5e048bf6535108dc16/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a1cb8dc30c6adc88703763a8703b6a3027598b2d", "url": "https://api.github.com/repos/rust-lang/rust/commits/a1cb8dc30c6adc88703763a8703b6a3027598b2d", "html_url": "https://github.com/rust-lang/rust/commit/a1cb8dc30c6adc88703763a8703b6a3027598b2d"}], "stats": {"total": 43, "additions": 38, "deletions": 5}, "files": [{"sha": "ddacc11fd9eddc64ccdb692b2a2dbe962c76ae5a", "filename": "src/libgreen/simple.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/dcaf10f8de7be79d7ef8aa5e048bf6535108dc16/src%2Flibgreen%2Fsimple.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dcaf10f8de7be79d7ef8aa5e048bf6535108dc16/src%2Flibgreen%2Fsimple.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibgreen%2Fsimple.rs?ref=dcaf10f8de7be79d7ef8aa5e048bf6535108dc16", "patch": "@@ -75,6 +75,7 @@ impl Runtime for SimpleTask {\n         fail!()\n     }\n     fn local_io<'a>(&'a mut self) -> Option<rtio::LocalIo<'a>> { None }\n+    fn stack_bounds(&self) -> Option<(uint, uint)> { None }\n     fn wrap(~self) -> ~Any { fail!() }\n }\n "}, {"sha": "183fe8d055528ab9ee85e04bfde13813a1b853e9", "filename": "src/libgreen/task.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/dcaf10f8de7be79d7ef8aa5e048bf6535108dc16/src%2Flibgreen%2Ftask.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dcaf10f8de7be79d7ef8aa5e048bf6535108dc16/src%2Flibgreen%2Ftask.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibgreen%2Ftask.rs?ref=dcaf10f8de7be79d7ef8aa5e048bf6535108dc16", "patch": "@@ -450,6 +450,13 @@ impl Runtime for GreenTask {\n         }\n     }\n \n+    fn stack_bounds(&self) -> Option<(uint, uint)> {\n+        self.coroutine.as_ref().map(|c| {\n+            (c.current_stack_segment.start() as uint,\n+             c.current_stack_segment.end() as uint)\n+        })\n+    }\n+\n     fn wrap(~self) -> ~Any { self as ~Any }\n }\n "}, {"sha": "661358a64e98b3c0167acf45033493693cf9d3f2", "filename": "src/libnative/task.rs", "status": "modified", "additions": 22, "deletions": 5, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/dcaf10f8de7be79d7ef8aa5e048bf6535108dc16/src%2Flibnative%2Ftask.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dcaf10f8de7be79d7ef8aa5e048bf6535108dc16/src%2Flibnative%2Ftask.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibnative%2Ftask.rs?ref=dcaf10f8de7be79d7ef8aa5e048bf6535108dc16", "patch": "@@ -32,12 +32,17 @@ use bookeeping;\n /// Creates a new Task which is ready to execute as a 1:1 task.\n pub fn new() -> ~Task {\n     let mut task = ~Task::new();\n-    task.put_runtime(~Ops {\n+    task.put_runtime(ops() as ~rt::Runtime);\n+    return task;\n+}\n+\n+fn ops() -> ~Ops {\n+    ~Ops {\n         lock: unsafe { Mutex::new() },\n         awoken: false,\n         io: io::IoFactory::new(),\n-    } as ~rt::Runtime);\n-    return task;\n+        stack_bounds: None,\n+    }\n }\n \n /// Spawns a function with the default configuration\n@@ -53,7 +58,7 @@ pub fn spawn_opts(opts: TaskOpts, f: proc()) {\n         notify_chan, name, stack_size\n     } = opts;\n \n-    let mut task = new();\n+    let mut task = ~Task::new();\n     task.name = name;\n     match notify_chan {\n         Some(chan) => {\n@@ -65,6 +70,7 @@ pub fn spawn_opts(opts: TaskOpts, f: proc()) {\n \n     let stack = stack_size.unwrap_or(env::min_stack());\n     let task = task;\n+    let ops = ops();\n \n     // Spawning a new OS thread guarantees that __morestack will never get\n     // triggered, but we must manually set up the actual stack bounds once this\n@@ -75,13 +81,17 @@ pub fn spawn_opts(opts: TaskOpts, f: proc()) {\n     Thread::spawn_stack(stack, proc() {\n         let something_around_the_top_of_the_stack = 1;\n         let addr = &something_around_the_top_of_the_stack as *int;\n+        let my_stack = addr as uint;\n         unsafe {\n-            let my_stack = addr as uint;\n             stack::record_stack_bounds(my_stack - stack + 1024, my_stack);\n         }\n+        let mut ops = ops;\n+        ops.stack_bounds = Some((my_stack - stack + 1024, my_stack));\n \n         bookeeping::increment();\n         let mut f = Some(f);\n+        let mut task = task;\n+        task.put_runtime(ops as ~rt::Runtime);\n         task.run(|| { f.take_unwrap()() });\n         bookeeping::decrement();\n     })\n@@ -93,6 +103,11 @@ struct Ops {\n     lock: Mutex,       // native synchronization\n     awoken: bool,      // used to prevent spurious wakeups\n     io: io::IoFactory, // local I/O factory\n+\n+    // This field holds the known bounds of the stack in (lo, hi) form. Not all\n+    // native tasks necessarily know their precise bounds, hence this is\n+    // optional.\n+    stack_bounds: Option<(uint, uint)>,\n }\n \n impl rt::Runtime for Ops {\n@@ -114,6 +129,8 @@ impl rt::Runtime for Ops {\n         self as ~Any\n     }\n \n+    fn stack_bounds(&self) -> Option<(uint, uint)> { self.stack_bounds }\n+\n     // This function gets a little interesting. There are a few safety and\n     // ownership violations going on here, but this is all done in the name of\n     // shared state. Additionally, all of the violations are protected with a"}, {"sha": "050caef86ebdbf0930d54ef1c9ca7b3ecc7ec12f", "filename": "src/libstd/rt/mod.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/dcaf10f8de7be79d7ef8aa5e048bf6535108dc16/src%2Flibstd%2Frt%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dcaf10f8de7be79d7ef8aa5e048bf6535108dc16/src%2Flibstd%2Frt%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Frt%2Fmod.rs?ref=dcaf10f8de7be79d7ef8aa5e048bf6535108dc16", "patch": "@@ -159,6 +159,7 @@ pub trait Runtime {\n     // you're in.\n     fn spawn_sibling(~self, cur_task: ~Task, opts: TaskOpts, f: proc());\n     fn local_io<'a>(&'a mut self) -> Option<rtio::LocalIo<'a>>;\n+    fn stack_bounds(&self) -> Option<(uint, uint)>; // (lo, hi)\n \n     // XXX: This is a serious code smell and this should not exist at all.\n     fn wrap(~self) -> ~Any;"}, {"sha": "3fdbc8938ba75c6a4c93781874d2a2a575f57831", "filename": "src/libstd/rt/task.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/dcaf10f8de7be79d7ef8aa5e048bf6535108dc16/src%2Flibstd%2Frt%2Ftask.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dcaf10f8de7be79d7ef8aa5e048bf6535108dc16/src%2Flibstd%2Frt%2Ftask.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Frt%2Ftask.rs?ref=dcaf10f8de7be79d7ef8aa5e048bf6535108dc16", "patch": "@@ -277,6 +277,13 @@ impl Task {\n     pub fn local_io<'a>(&'a mut self) -> Option<LocalIo<'a>> {\n         self.imp.get_mut_ref().local_io()\n     }\n+\n+    /// Returns the stack bounds for this task in (lo, hi) format. The stack\n+    /// bounds may not be known for all tasks, so the return value may be\n+    /// `None`.\n+    pub fn stack_bounds(&self) -> Option<(uint, uint)> {\n+        self.imp.get_ref().stack_bounds()\n+    }\n }\n \n impl Drop for Task {"}]}