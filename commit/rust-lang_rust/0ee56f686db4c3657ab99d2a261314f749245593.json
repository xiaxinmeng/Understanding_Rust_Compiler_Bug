{"sha": "0ee56f686db4c3657ab99d2a261314f749245593", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBlZTU2ZjY4NmRiNGMzNjU3YWI5OWQyYTI2MTMxNGY3NDkyNDU1OTM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-04-26T12:34:45Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-04-26T12:34:45Z"}, "message": "Auto merge of #41352 - kennytm:macos-sanitizers, r=alexcrichton\n\nSupport AddressSanitizer and ThreadSanitizer on x86_64-apple-darwin\n\n[ASan](https://clang.llvm.org/docs/AddressSanitizer.html#supported-platforms) and [TSan](https://clang.llvm.org/docs/ThreadSanitizer.html#supported-platforms) are supported on macOS, and this commit enables their support.\n\nThe sanitizers are always built as `*.dylib` on Apple platforms, so they cannot be statically linked into the corresponding `rustc_?san.rlib`. The dylibs are directly copied to `lib/rustlib/x86_64-apple-darwin/lib/` instead.\n\nNote, although Xcode also ships with their own copies of ASan/TSan dylibs, we cannot use them due to version mismatch.\n\n----\n\n~~There is a caveat: the sanitizer libraries are linked as `@rpath/` (due to https://reviews.llvm.org/D6018), so the user needs to additionally pass `-C rpath`:~~\n\n**Edit:** Passing rpath is now automatic.", "tree": {"sha": "aff354fa377e1c0c8d059f68c9667556cdee56e2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/aff354fa377e1c0c8d059f68c9667556cdee56e2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0ee56f686db4c3657ab99d2a261314f749245593", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0ee56f686db4c3657ab99d2a261314f749245593", "html_url": "https://github.com/rust-lang/rust/commit/0ee56f686db4c3657ab99d2a261314f749245593", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0ee56f686db4c3657ab99d2a261314f749245593/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b0a4074c5e87d24ff630f6aa456a64698bff3ed2", "url": "https://api.github.com/repos/rust-lang/rust/commits/b0a4074c5e87d24ff630f6aa456a64698bff3ed2", "html_url": "https://github.com/rust-lang/rust/commit/b0a4074c5e87d24ff630f6aa456a64698bff3ed2"}, {"sha": "164fd696bf9db696148018f395ad703a5825246e", "url": "https://api.github.com/repos/rust-lang/rust/commits/164fd696bf9db696148018f395ad703a5825246e", "html_url": "https://github.com/rust-lang/rust/commit/164fd696bf9db696148018f395ad703a5825246e"}], "stats": {"total": 154, "additions": 115, "deletions": 39}, "files": [{"sha": "c5372609e9bc622eb8f0385fd0db681d906ba0b0", "filename": ".travis.yml", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/0ee56f686db4c3657ab99d2a261314f749245593/.travis.yml", "raw_url": "https://github.com/rust-lang/rust/raw/0ee56f686db4c3657ab99d2a261314f749245593/.travis.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.travis.yml?ref=0ee56f686db4c3657ab99d2a261314f749245593", "patch": "@@ -54,7 +54,7 @@ matrix:\n     # version that we're using, 8.2, cannot compile LLVM for OSX 10.7.\n     - env: >\n         RUST_CHECK_TARGET=check\n-        RUST_CONFIGURE_ARGS=--build=x86_64-apple-darwin\n+        RUST_CONFIGURE_ARGS=\"--build=x86_64-apple-darwin --enable-sanitizers\"\n         SRC=.\n         RUSTC_RETRY_LINKER_ON_SEGFAULT=1\n         SCCACHE_ERROR_LOG=/tmp/sccache.log\n@@ -98,7 +98,7 @@ matrix:\n       install: *osx_install_sccache\n     - env: >\n         RUST_CHECK_TARGET=dist\n-        RUST_CONFIGURE_ARGS=\"--target=aarch64-apple-ios,armv7-apple-ios,armv7s-apple-ios,i386-apple-ios,x86_64-apple-ios --enable-extended\"\n+        RUST_CONFIGURE_ARGS=\"--target=aarch64-apple-ios,armv7-apple-ios,armv7s-apple-ios,i386-apple-ios,x86_64-apple-ios --enable-extended --enable-sanitizers\"\n         SRC=.\n         DEPLOY=1\n         RUSTC_RETRY_LINKER_ON_SEGFAULT=1"}, {"sha": "6f1de62d07ee3bd9267837281b990205f95050c7", "filename": "src/bootstrap/compile.rs", "status": "modified", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/0ee56f686db4c3657ab99d2a261314f749245593/src%2Fbootstrap%2Fcompile.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ee56f686db4c3657ab99d2a261314f749245593/src%2Fbootstrap%2Fcompile.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcompile.rs?ref=0ee56f686db4c3657ab99d2a261314f749245593", "patch": "@@ -115,6 +115,13 @@ pub fn std_link(build: &Build,\n     if target.contains(\"musl\") && !target.contains(\"mips\") {\n         copy_musl_third_party_objects(build, target, &libdir);\n     }\n+\n+    if build.config.sanitizers && compiler.stage != 0 && target == \"x86_64-apple-darwin\" {\n+        // The sanitizers are only built in stage1 or above, so the dylibs will\n+        // be missing in stage0 and causes panic. See the `std()` function above\n+        // for reason why the sanitizers are not built in stage0.\n+        copy_apple_sanitizer_dylibs(&build.native_dir(target), \"osx\", &libdir);\n+    }\n }\n \n /// Copies the crt(1,i,n).o startup objects\n@@ -126,6 +133,18 @@ fn copy_musl_third_party_objects(build: &Build, target: &str, into: &Path) {\n     }\n }\n \n+fn copy_apple_sanitizer_dylibs(native_dir: &Path, platform: &str, into: &Path) {\n+    for &sanitizer in &[\"asan\", \"tsan\"] {\n+        let filename = format!(\"libclang_rt.{}_{}_dynamic.dylib\", sanitizer, platform);\n+        let mut src_path = native_dir.join(sanitizer);\n+        src_path.push(\"build\");\n+        src_path.push(\"lib\");\n+        src_path.push(\"darwin\");\n+        src_path.push(&filename);\n+        copy(&src_path, &into.join(filename));\n+    }\n+}\n+\n /// Build and prepare startup objects like rsbegin.o and rsend.o\n ///\n /// These are primarily used on Windows right now for linking executables/dlls."}, {"sha": "7b6b01655df585fc3f2a61c175c618177171de64", "filename": "src/bootstrap/metadata.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/0ee56f686db4c3657ab99d2a261314f749245593/src%2Fbootstrap%2Fmetadata.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ee56f686db4c3657ab99d2a261314f749245593/src%2Fbootstrap%2Fmetadata.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fmetadata.rs?ref=0ee56f686db4c3657ab99d2a261314f749245593", "patch": "@@ -58,6 +58,7 @@ fn build_krate(build: &mut Build, krate: &str) {\n     // the dependency graph and what `-p` arguments there are.\n     let mut cargo = Command::new(&build.cargo);\n     cargo.arg(\"metadata\")\n+         .arg(\"--format-version\").arg(\"1\")\n          .arg(\"--manifest-path\").arg(build.src.join(krate).join(\"Cargo.toml\"));\n     let output = output(&mut cargo);\n     let output: Output = json::decode(&output).unwrap();"}, {"sha": "da00b970da977e950bacdf275403c0a57e0e6ad7", "filename": "src/build_helper/lib.rs", "status": "modified", "additions": 20, "deletions": 1, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/0ee56f686db4c3657ab99d2a261314f749245593/src%2Fbuild_helper%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ee56f686db4c3657ab99d2a261314f749245593/src%2Fbuild_helper%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbuild_helper%2Flib.rs?ref=0ee56f686db4c3657ab99d2a261314f749245593", "patch": "@@ -198,7 +198,11 @@ pub fn native_lib_boilerplate(src_name: &str,\n     let out_dir = env::var_os(\"RUSTBUILD_NATIVE_DIR\").unwrap_or(env::var_os(\"OUT_DIR\").unwrap());\n     let out_dir = PathBuf::from(out_dir).join(out_name);\n     t!(create_dir_racy(&out_dir));\n-    println!(\"cargo:rustc-link-lib=static={}\", link_name);\n+    if link_name.contains('=') {\n+        println!(\"cargo:rustc-link-lib={}\", link_name);\n+    } else {\n+        println!(\"cargo:rustc-link-lib=static={}\", link_name);\n+    }\n     println!(\"cargo:rustc-link-search=native={}\", out_dir.join(search_subdir).display());\n \n     let timestamp = out_dir.join(\"rustbuild.timestamp\");\n@@ -209,6 +213,21 @@ pub fn native_lib_boilerplate(src_name: &str,\n     }\n }\n \n+pub fn sanitizer_lib_boilerplate(sanitizer_name: &str) -> Result<NativeLibBoilerplate, ()> {\n+    let (link_name, search_path) = match &*env::var(\"TARGET\").unwrap() {\n+        \"x86_64-unknown-linux-gnu\" => (\n+            format!(\"clang_rt.{}-x86_64\", sanitizer_name),\n+            \"build/lib/linux\",\n+        ),\n+        \"x86_64-apple-darwin\" => (\n+            format!(\"dylib=clang_rt.{}_osx_dynamic\", sanitizer_name),\n+            \"build/lib/darwin\",\n+        ),\n+        _ => return Err(()),\n+    };\n+    native_lib_boilerplate(\"compiler-rt\", sanitizer_name, &link_name, search_path)\n+}\n+\n fn dir_up_to_date(src: &Path, threshold: &FileTime) -> bool {\n     t!(fs::read_dir(src)).map(|e| t!(e)).all(|e| {\n         let meta = t!(e.metadata());"}, {"sha": "462fd57cbf17f4a7de6a0d8cfb066bc983597304", "filename": "src/librustc/session/config.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ee56f686db4c3657ab99d2a261314f749245593/src%2Flibrustc%2Fsession%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ee56f686db4c3657ab99d2a261314f749245593/src%2Flibrustc%2Fsession%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fsession%2Fconfig.rs?ref=0ee56f686db4c3657ab99d2a261314f749245593", "patch": "@@ -51,7 +51,7 @@ pub struct Config {\n     pub uint_type: UintTy,\n }\n \n-#[derive(Clone, Hash)]\n+#[derive(Clone, Hash, Debug)]\n pub enum Sanitizer {\n     Address,\n     Leak,"}, {"sha": "3a80baa0485f56cf15b32243f61d960f340d2996", "filename": "src/librustc_asan/build.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/0ee56f686db4c3657ab99d2a261314f749245593/src%2Flibrustc_asan%2Fbuild.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ee56f686db4c3657ab99d2a261314f749245593/src%2Flibrustc_asan%2Fbuild.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_asan%2Fbuild.rs?ref=0ee56f686db4c3657ab99d2a261314f749245593", "patch": "@@ -12,14 +12,13 @@ extern crate build_helper;\n extern crate cmake;\n \n use std::env;\n-use build_helper::native_lib_boilerplate;\n+use build_helper::sanitizer_lib_boilerplate;\n \n use cmake::Config;\n \n fn main() {\n     if let Some(llvm_config) = env::var_os(\"LLVM_CONFIG\") {\n-        let native = match native_lib_boilerplate(\"compiler-rt\", \"asan\", \"clang_rt.asan-x86_64\",\n-                                                  \"build/lib/linux\") {\n+        let native = match sanitizer_lib_boilerplate(\"asan\") {\n             Ok(native) => native,\n             _ => return,\n         };"}, {"sha": "da53571a243905fe7ac7d7fc6063a001fbffdb55", "filename": "src/librustc_lsan/build.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/0ee56f686db4c3657ab99d2a261314f749245593/src%2Flibrustc_lsan%2Fbuild.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ee56f686db4c3657ab99d2a261314f749245593/src%2Flibrustc_lsan%2Fbuild.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_lsan%2Fbuild.rs?ref=0ee56f686db4c3657ab99d2a261314f749245593", "patch": "@@ -12,14 +12,13 @@ extern crate build_helper;\n extern crate cmake;\n \n use std::env;\n-use build_helper::native_lib_boilerplate;\n+use build_helper::sanitizer_lib_boilerplate;\n \n use cmake::Config;\n \n fn main() {\n     if let Some(llvm_config) = env::var_os(\"LLVM_CONFIG\") {\n-        let native = match native_lib_boilerplate(\"compiler-rt\", \"lsan\", \"clang_rt.lsan-x86_64\",\n-                                                  \"build/lib/linux\") {\n+        let native = match sanitizer_lib_boilerplate(\"lsan\") {\n             Ok(native) => native,\n             _ => return,\n         };"}, {"sha": "966e814e3379075741b2809585814f95e5a5624b", "filename": "src/librustc_metadata/creader.rs", "status": "modified", "additions": 20, "deletions": 5, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/0ee56f686db4c3657ab99d2a261314f749245593/src%2Flibrustc_metadata%2Fcreader.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ee56f686db4c3657ab99d2a261314f749245593/src%2Flibrustc_metadata%2Fcreader.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Fcreader.rs?ref=0ee56f686db4c3657ab99d2a261314f749245593", "patch": "@@ -799,11 +799,26 @@ impl<'a> CrateLoader<'a> {\n \n     fn inject_sanitizer_runtime(&mut self) {\n         if let Some(ref sanitizer) = self.sess.opts.debugging_opts.sanitizer {\n-            // Sanitizers can only be used with x86_64 Linux executables linked\n-            // to `std`\n-            if self.sess.target.target.llvm_target != \"x86_64-unknown-linux-gnu\" {\n-                self.sess.err(&format!(\"Sanitizers only work with the \\\n-                                        `x86_64-unknown-linux-gnu` target.\"));\n+            // Sanitizers can only be used on some tested platforms with\n+            // executables linked to `std`\n+            const ASAN_SUPPORTED_TARGETS: &[&str] = &[\"x86_64-unknown-linux-gnu\",\n+                                                      \"x86_64-apple-darwin\"];\n+            const TSAN_SUPPORTED_TARGETS: &[&str] = &[\"x86_64-unknown-linux-gnu\",\n+                                                      \"x86_64-apple-darwin\"];\n+            const LSAN_SUPPORTED_TARGETS: &[&str] = &[\"x86_64-unknown-linux-gnu\"];\n+            const MSAN_SUPPORTED_TARGETS: &[&str] = &[\"x86_64-unknown-linux-gnu\"];\n+\n+            let supported_targets = match *sanitizer {\n+                Sanitizer::Address => ASAN_SUPPORTED_TARGETS,\n+                Sanitizer::Thread => TSAN_SUPPORTED_TARGETS,\n+                Sanitizer::Leak => LSAN_SUPPORTED_TARGETS,\n+                Sanitizer::Memory => MSAN_SUPPORTED_TARGETS,\n+            };\n+            if !supported_targets.contains(&&*self.sess.target.target.llvm_target) {\n+                self.sess.err(&format!(\"{:?}Sanitizer only works with the `{}` target\",\n+                    sanitizer,\n+                    supported_targets.join(\"` or `\")\n+                ));\n                 return\n             }\n "}, {"sha": "dcadbe86966e71eeab8adf40f4e2ad44d6d045e8", "filename": "src/librustc_msan/build.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/0ee56f686db4c3657ab99d2a261314f749245593/src%2Flibrustc_msan%2Fbuild.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ee56f686db4c3657ab99d2a261314f749245593/src%2Flibrustc_msan%2Fbuild.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_msan%2Fbuild.rs?ref=0ee56f686db4c3657ab99d2a261314f749245593", "patch": "@@ -12,14 +12,13 @@ extern crate build_helper;\n extern crate cmake;\n \n use std::env;\n-use build_helper::native_lib_boilerplate;\n+use build_helper::sanitizer_lib_boilerplate;\n \n use cmake::Config;\n \n fn main() {\n     if let Some(llvm_config) = env::var_os(\"LLVM_CONFIG\") {\n-        let native = match native_lib_boilerplate(\"compiler-rt\", \"msan\", \"clang_rt.msan-x86_64\",\n-                                                  \"build/lib/linux\") {\n+        let native = match sanitizer_lib_boilerplate(\"msan\") {\n             Ok(native) => native,\n             _ => return,\n         };"}, {"sha": "e42e69d2a76e27979718317626a86ee2a51df1de", "filename": "src/librustc_trans/back/link.rs", "status": "modified", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/0ee56f686db4c3657ab99d2a261314f749245593/src%2Flibrustc_trans%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ee56f686db4c3657ab99d2a261314f749245593/src%2Flibrustc_trans%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Fback%2Flink.rs?ref=0ee56f686db4c3657ab99d2a261314f749245593", "patch": "@@ -1122,6 +1122,19 @@ fn add_upstream_rust_crates(cmd: &mut Linker,\n                               cnum: CrateNum) {\n         let src = sess.cstore.used_crate_source(cnum);\n         let cratepath = &src.rlib.unwrap().0;\n+\n+        if sess.target.target.options.is_like_osx {\n+            // On Apple platforms, the sanitizer is always built as a dylib, and\n+            // LLVM will link to `@rpath/*.dylib`, so we need to specify an\n+            // rpath to the library as well (the rpath should be absolute, see\n+            // PR #41352 for details).\n+            //\n+            // FIXME: Remove this logic into librustc_*san once Cargo supports it\n+            let rpath = cratepath.parent().unwrap();\n+            let rpath = rpath.to_str().expect(\"non-utf8 component in path\");\n+            cmd.args(&[\"-Wl,-rpath\".into(), \"-Xlinker\".into(), rpath.into()]);\n+        }\n+\n         let dst = tmpdir.join(cratepath.file_name().unwrap());\n         let cfg = archive_config(sess, &dst, Some(cratepath));\n         let mut archive = ArchiveBuilder::new(cfg);"}, {"sha": "5ea52f17a0fdedd73686ddd140f40fbb12d535a3", "filename": "src/librustc_tsan/build.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/0ee56f686db4c3657ab99d2a261314f749245593/src%2Flibrustc_tsan%2Fbuild.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ee56f686db4c3657ab99d2a261314f749245593/src%2Flibrustc_tsan%2Fbuild.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_tsan%2Fbuild.rs?ref=0ee56f686db4c3657ab99d2a261314f749245593", "patch": "@@ -12,14 +12,13 @@ extern crate build_helper;\n extern crate cmake;\n \n use std::env;\n-use build_helper::native_lib_boilerplate;\n+use build_helper::sanitizer_lib_boilerplate;\n \n use cmake::Config;\n \n fn main() {\n     if let Some(llvm_config) = env::var_os(\"LLVM_CONFIG\") {\n-        let native = match native_lib_boilerplate(\"compiler-rt\", \"tsan\", \"clang_rt.tsan-x86_64\",\n-                                                  \"build/lib/linux\") {\n+        let native = match sanitizer_lib_boilerplate(\"tsan\") {\n             Ok(native) => native,\n             _ => return,\n         };"}, {"sha": "717892be2abad5f4eb4bf9855527453d81a5228e", "filename": "src/libstd/Cargo.toml", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/0ee56f686db4c3657ab99d2a261314f749245593/src%2Flibstd%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/0ee56f686db4c3657ab99d2a261314f749245593/src%2Flibstd%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2FCargo.toml?ref=0ee56f686db4c3657ab99d2a261314f749245593", "patch": "@@ -23,6 +23,10 @@ compiler_builtins = { path = \"../libcompiler_builtins\" }\n std_unicode = { path = \"../libstd_unicode\" }\n unwind = { path = \"../libunwind\" }\n \n+[target.x86_64-apple-darwin.dependencies]\n+rustc_asan = { path = \"../librustc_asan\" }\n+rustc_tsan = { path = \"../librustc_tsan\" }\n+\n [target.x86_64-unknown-linux-gnu.dependencies]\n rustc_asan = { path = \"../librustc_asan\" }\n rustc_lsan = { path = \"../librustc_lsan\" }"}, {"sha": "61b25df1451b336895e189500c5a0fbb5335ae4a", "filename": "src/test/run-make/sanitizer-address/Makefile", "status": "modified", "additions": 14, "deletions": 6, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/0ee56f686db4c3657ab99d2a261314f749245593/src%2Ftest%2Frun-make%2Fsanitizer-address%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/0ee56f686db4c3657ab99d2a261314f749245593/src%2Ftest%2Frun-make%2Fsanitizer-address%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fsanitizer-address%2FMakefile?ref=0ee56f686db4c3657ab99d2a261314f749245593", "patch": "@@ -1,11 +1,19 @@\n -include ../tools.mk\n \n-# NOTE the address sanitizer only supports x86_64 linux\n-ifdef SANITIZER_SUPPORT\n-all:\n-\t$(RUSTC) -g -Z sanitizer=address -Z print-link-args overflow.rs | grep -q librustc_asan\n-\t$(TMPDIR)/overflow 2>&1 | grep -q stack-buffer-overflow\n+# NOTE the address sanitizer only supports x86_64 linux and macOS\n+\n+ifeq ($(TARGET),x86_64-apple-darwin)\n+ASAN_SUPPORT=$(SANITIZER_SUPPORT)\n+EXTRA_RUSTFLAG=-C rpath\n else\n-all:\n+ifeq ($(TARGET),x86_64-unknown-linux-gnu)\n+ASAN_SUPPORT=$(SANITIZER_SUPPORT)\n+EXTRA_RUSTFLAG=\n+endif\n+endif\n \n+all:\n+ifeq ($(ASAN_SUPPORT),1)\n+\t$(RUSTC) -g -Z sanitizer=address -Z print-link-args $(EXTRA_RUSTFLAG) overflow.rs | grep -q librustc_asan\n+\t$(TMPDIR)/overflow 2>&1 | grep -q stack-buffer-overflow\n endif"}, {"sha": "82e32f0995202e02e5990024745326fb20c4abcf", "filename": "src/test/run-make/sanitizer-invalid-target/Makefile", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0ee56f686db4c3657ab99d2a261314f749245593/src%2Ftest%2Frun-make%2Fsanitizer-invalid-target%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/0ee56f686db4c3657ab99d2a261314f749245593/src%2Ftest%2Frun-make%2Fsanitizer-invalid-target%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fsanitizer-invalid-target%2FMakefile?ref=0ee56f686db4c3657ab99d2a261314f749245593", "patch": "@@ -1,4 +1,4 @@\n -include ../tools.mk\n \n all:\n-\t$(RUSTC) -Z sanitizer=leak --target i686-unknown-linux-gnu hello.rs 2>&1 | grep -q 'Sanitizers only work with the `x86_64-unknown-linux-gnu` target'\n+\t$(RUSTC) -Z sanitizer=leak --target i686-unknown-linux-gnu hello.rs 2>&1 | grep -q 'LeakSanitizer only works with the `x86_64-unknown-linux-gnu` target'"}, {"sha": "b18dd1d45eda48fd6cd014d392bf1ec60a39fbed", "filename": "src/test/run-make/sanitizer-leak/Makefile", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/0ee56f686db4c3657ab99d2a261314f749245593/src%2Ftest%2Frun-make%2Fsanitizer-leak%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/0ee56f686db4c3657ab99d2a261314f749245593/src%2Ftest%2Frun-make%2Fsanitizer-leak%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fsanitizer-leak%2FMakefile?ref=0ee56f686db4c3657ab99d2a261314f749245593", "patch": "@@ -1,10 +1,10 @@\n -include ../tools.mk\n \n-ifdef SANITIZER_SUPPORT\n all:\n+ifeq ($(TARGET),x86_64-unknown-linux-gnu)\n+ifdef SANITIZER_SUPPORT\n \t$(RUSTC) -C opt-level=1 -g -Z sanitizer=leak -Z print-link-args leak.rs | grep -q librustc_lsan\n \t$(TMPDIR)/leak 2>&1 | grep -q 'detected memory leaks'\n-else\n-all:\n-\n endif\n+endif\n+"}, {"sha": "7502ef0e7a7b750467ecde8e32e013b21d87557d", "filename": "src/test/run-make/sanitizer-memory/Makefile", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/0ee56f686db4c3657ab99d2a261314f749245593/src%2Ftest%2Frun-make%2Fsanitizer-memory%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/0ee56f686db4c3657ab99d2a261314f749245593/src%2Ftest%2Frun-make%2Fsanitizer-memory%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fsanitizer-memory%2FMakefile?ref=0ee56f686db4c3657ab99d2a261314f749245593", "patch": "@@ -1,10 +1,10 @@\n -include ../tools.mk\n \n-ifdef SANITIZER_SUPPORT\n all:\n+ifeq ($(TARGET),x86_64-unknown-linux-gnu)\n+ifdef SANITIZER_SUPPORT\n \t$(RUSTC) -g -Z sanitizer=memory -Z print-link-args uninit.rs | grep -q librustc_msan\n \t$(TMPDIR)/uninit 2>&1 | grep -q use-of-uninitialized-value\n-else\n-all:\n-\n endif\n+endif\n+"}, {"sha": "4b7052f9b94932b3cb08c437dee41552e841249c", "filename": "src/test/run-make/sysroot-crates-are-unstable/Makefile", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/0ee56f686db4c3657ab99d2a261314f749245593/src%2Ftest%2Frun-make%2Fsysroot-crates-are-unstable%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/0ee56f686db4c3657ab99d2a261314f749245593/src%2Ftest%2Frun-make%2Fsysroot-crates-are-unstable%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fsysroot-crates-are-unstable%2FMakefile?ref=0ee56f686db4c3657ab99d2a261314f749245593", "patch": "@@ -1,15 +1,16 @@\n -include ../tools.mk\n \n-# This is a whitelist of crates which are stable, we don't check for the\n-# instability of these crates as they're all stable!\n+# This is a whitelist of files which are stable crates or simply are not crates,\n+# we don't check for the instability of these crates as they're all stable!\n STABLE_CRATES := \\\n \tstd \\\n \tcore \\\n \tproc_macro \\\n \trsbegin.o \\\n \trsend.o \\\n \tdllcrt2.o \\\n-\tcrt2.o\n+\tcrt2.o \\\n+\tclang_rt.%_dynamic.dylib\n \n # Generate a list of all crates in the sysroot. To do this we list all files in\n # rustc's sysroot, look at the filename, strip everything after the `-`, and"}]}