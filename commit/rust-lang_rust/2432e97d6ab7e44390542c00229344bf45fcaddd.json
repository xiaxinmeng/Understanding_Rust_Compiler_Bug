{"sha": "2432e97d6ab7e44390542c00229344bf45fcaddd", "node_id": "C_kwDOAAsO6NoAKDI0MzJlOTdkNmFiN2U0NDM5MDU0MmMwMDIyOTM0NGJmNDVmY2FkZGQ", "commit": {"author": {"name": "Tyler Weaver", "email": "maybe@tylerjw.dev", "date": "2023-01-29T01:45:57Z"}, "committer": {"name": "Tyler Weaver", "email": "maybe@tylerjw.dev", "date": "2023-01-31T00:29:29Z"}, "message": "wildcard_enum_match_arm lint takes the enum origin into account\n\nSigned-off-by: Tyler Weaver <maybe@tylerjw.dev>", "tree": {"sha": "f6a66b48a4107cb874da4e259ab718e4afa75d79", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f6a66b48a4107cb874da4e259ab718e4afa75d79"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2432e97d6ab7e44390542c00229344bf45fcaddd", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN SSH SIGNATURE-----\nU1NIU0lHAAAAAQAAADMAAAALc3NoLWVkMjU1MTkAAAAg7SOvb1XvVqyndOg/aB6xzqcLku\ncJTkLKCfEUxpSDkY0AAAADZ2l0AAAAAAAAAAZzaGE1MTIAAABTAAAAC3NzaC1lZDI1NTE5\nAAAAQBv/mttKtdoC3qlPM+eahCGkSotjLRkhdFoBWzVoB5brFpEKyz9MKcCBfRyaEDIkgN\nMyjjFjD4K9ArlXTHJ1XQU=\n-----END SSH SIGNATURE-----", "payload": "tree f6a66b48a4107cb874da4e259ab718e4afa75d79\nparent d020fd7fe6d4974dfcab419b184cf2efd4ecd294\nauthor Tyler Weaver <maybe@tylerjw.dev> 1674956757 -0700\ncommitter Tyler Weaver <maybe@tylerjw.dev> 1675124969 -0700\n\nwildcard_enum_match_arm lint takes the enum origin into account\n\nSigned-off-by: Tyler Weaver <maybe@tylerjw.dev>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2432e97d6ab7e44390542c00229344bf45fcaddd", "html_url": "https://github.com/rust-lang/rust/commit/2432e97d6ab7e44390542c00229344bf45fcaddd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2432e97d6ab7e44390542c00229344bf45fcaddd/comments", "author": {"login": "tylerjw", "id": 2490389, "node_id": "MDQ6VXNlcjI0OTAzODk=", "avatar_url": "https://avatars.githubusercontent.com/u/2490389?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tylerjw", "html_url": "https://github.com/tylerjw", "followers_url": "https://api.github.com/users/tylerjw/followers", "following_url": "https://api.github.com/users/tylerjw/following{/other_user}", "gists_url": "https://api.github.com/users/tylerjw/gists{/gist_id}", "starred_url": "https://api.github.com/users/tylerjw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tylerjw/subscriptions", "organizations_url": "https://api.github.com/users/tylerjw/orgs", "repos_url": "https://api.github.com/users/tylerjw/repos", "events_url": "https://api.github.com/users/tylerjw/events{/privacy}", "received_events_url": "https://api.github.com/users/tylerjw/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tylerjw", "id": 2490389, "node_id": "MDQ6VXNlcjI0OTAzODk=", "avatar_url": "https://avatars.githubusercontent.com/u/2490389?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tylerjw", "html_url": "https://github.com/tylerjw", "followers_url": "https://api.github.com/users/tylerjw/followers", "following_url": "https://api.github.com/users/tylerjw/following{/other_user}", "gists_url": "https://api.github.com/users/tylerjw/gists{/gist_id}", "starred_url": "https://api.github.com/users/tylerjw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tylerjw/subscriptions", "organizations_url": "https://api.github.com/users/tylerjw/orgs", "repos_url": "https://api.github.com/users/tylerjw/repos", "events_url": "https://api.github.com/users/tylerjw/events{/privacy}", "received_events_url": "https://api.github.com/users/tylerjw/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d020fd7fe6d4974dfcab419b184cf2efd4ecd294", "url": "https://api.github.com/repos/rust-lang/rust/commits/d020fd7fe6d4974dfcab419b184cf2efd4ecd294", "html_url": "https://github.com/rust-lang/rust/commit/d020fd7fe6d4974dfcab419b184cf2efd4ecd294"}], "stats": {"total": 33, "additions": 22, "deletions": 11}, "files": [{"sha": "05cac0f99797659871424e80b85a2da6243a4bc6", "filename": "clippy_lints/src/matches/match_wild_enum.rs", "status": "modified", "additions": 11, "deletions": 6, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/2432e97d6ab7e44390542c00229344bf45fcaddd/clippy_lints%2Fsrc%2Fmatches%2Fmatch_wild_enum.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2432e97d6ab7e44390542c00229344bf45fcaddd/clippy_lints%2Fsrc%2Fmatches%2Fmatch_wild_enum.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmatches%2Fmatch_wild_enum.rs?ref=2432e97d6ab7e44390542c00229344bf45fcaddd", "patch": "@@ -45,8 +45,12 @@ pub(crate) fn check(cx: &LateContext<'_>, ex: &Expr<'_>, arms: &[Arm<'_>]) {\n \n     // Accumulate the variants which should be put in place of the wildcard because they're not\n     // already covered.\n-    let has_hidden = adt_def.variants().iter().any(|x| is_hidden(cx, x));\n-    let mut missing_variants: Vec<_> = adt_def.variants().iter().filter(|x| !is_hidden(cx, x)).collect();\n+    let has_hidden_external = adt_def.variants().iter().any(|x| is_hidden_and_external(cx, x));\n+    let mut missing_variants: Vec<_> = adt_def\n+        .variants()\n+        .iter()\n+        .filter(|x| !is_hidden_and_external(cx, x))\n+        .collect();\n \n     let mut path_prefix = CommonPrefixSearcher::None;\n     for arm in arms {\n@@ -133,7 +137,7 @@ pub(crate) fn check(cx: &LateContext<'_>, ex: &Expr<'_>, arms: &[Arm<'_>]) {\n \n     match missing_variants.as_slice() {\n         [] => (),\n-        [x] if !adt_def.is_variant_list_non_exhaustive() && !has_hidden => span_lint_and_sugg(\n+        [x] if !adt_def.is_variant_list_non_exhaustive() && !has_hidden_external => span_lint_and_sugg(\n             cx,\n             MATCH_WILDCARD_FOR_SINGLE_VARIANTS,\n             wildcard_span,\n@@ -144,7 +148,7 @@ pub(crate) fn check(cx: &LateContext<'_>, ex: &Expr<'_>, arms: &[Arm<'_>]) {\n         ),\n         variants => {\n             let mut suggestions: Vec<_> = variants.iter().copied().map(format_suggestion).collect();\n-            let message = if adt_def.is_variant_list_non_exhaustive() || has_hidden {\n+            let message = if adt_def.is_variant_list_non_exhaustive() || has_hidden_external {\n                 suggestions.push(\"_\".into());\n                 \"wildcard matches known variants and will also match future added variants\"\n             } else {\n@@ -191,6 +195,7 @@ impl<'a> CommonPrefixSearcher<'a> {\n     }\n }\n \n-fn is_hidden(cx: &LateContext<'_>, variant_def: &VariantDef) -> bool {\n-    cx.tcx.is_doc_hidden(variant_def.def_id) || cx.tcx.has_attr(variant_def.def_id, sym::unstable)\n+fn is_hidden_and_external(cx: &LateContext<'_>, variant_def: &VariantDef) -> bool {\n+    (cx.tcx.is_doc_hidden(variant_def.def_id) || cx.tcx.has_attr(variant_def.def_id, sym::unstable))\n+        && variant_def.def_id.as_local().is_none()\n }"}, {"sha": "9fd3739b69c2cd7720da4cee815a39980e7915b4", "filename": "tests/ui/match_wildcard_for_single_variants.fixed", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/2432e97d6ab7e44390542c00229344bf45fcaddd/tests%2Fui%2Fmatch_wildcard_for_single_variants.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/2432e97d6ab7e44390542c00229344bf45fcaddd/tests%2Fui%2Fmatch_wildcard_for_single_variants.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmatch_wildcard_for_single_variants.fixed?ref=2432e97d6ab7e44390542c00229344bf45fcaddd", "patch": "@@ -123,7 +123,7 @@ fn main() {\n             Enum::A => (),\n             Enum::B => (),\n             Enum::C => (),\n-            _ => (),\n+            Enum::__Private => (),\n         }\n         match Enum::A {\n             Enum::A => (),"}, {"sha": "105b4c4b41d1e9ca107906e2cc3a638c0508e307", "filename": "tests/ui/match_wildcard_for_single_variants.stderr", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/2432e97d6ab7e44390542c00229344bf45fcaddd/tests%2Fui%2Fmatch_wildcard_for_single_variants.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2432e97d6ab7e44390542c00229344bf45fcaddd/tests%2Fui%2Fmatch_wildcard_for_single_variants.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmatch_wildcard_for_single_variants.stderr?ref=2432e97d6ab7e44390542c00229344bf45fcaddd", "patch": "@@ -48,11 +48,17 @@ error: wildcard matches only a single variant and will also match any future add\n LL |         _ => (),\n    |         ^ help: try this: `Color::Blue`\n \n+error: wildcard matches only a single variant and will also match any future added variants\n+  --> $DIR/match_wildcard_for_single_variants.rs:126:13\n+   |\n+LL |             _ => (),\n+   |             ^ help: try this: `Enum::__Private`\n+\n error: wildcard matches only a single variant and will also match any future added variants\n   --> $DIR/match_wildcard_for_single_variants.rs:153:13\n    |\n LL |             _ => 2,\n    |             ^ help: try this: `Foo::B`\n \n-error: aborting due to 9 previous errors\n+error: aborting due to 10 previous errors\n "}, {"sha": "293bf75a717627b9b48b949ba925b38ae51f74c0", "filename": "tests/ui/wildcard_enum_match_arm.fixed", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/2432e97d6ab7e44390542c00229344bf45fcaddd/tests%2Fui%2Fwildcard_enum_match_arm.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/2432e97d6ab7e44390542c00229344bf45fcaddd/tests%2Fui%2Fwildcard_enum_match_arm.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fwildcard_enum_match_arm.fixed?ref=2432e97d6ab7e44390542c00229344bf45fcaddd", "patch": "@@ -96,7 +96,7 @@ fn main() {\n         }\n         match Enum::A {\n             Enum::A => (),\n-            Enum::B | _ => (),\n+            Enum::B | Enum::__Private => (),\n         }\n     }\n }"}, {"sha": "30d29aa4e77a1cccde389f57fa0dac1cad717993", "filename": "tests/ui/wildcard_enum_match_arm.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/2432e97d6ab7e44390542c00229344bf45fcaddd/tests%2Fui%2Fwildcard_enum_match_arm.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2432e97d6ab7e44390542c00229344bf45fcaddd/tests%2Fui%2Fwildcard_enum_match_arm.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fwildcard_enum_match_arm.stderr?ref=2432e97d6ab7e44390542c00229344bf45fcaddd", "patch": "@@ -34,11 +34,11 @@ error: wildcard matches known variants and will also match future added variants\n LL |         _ => {},\n    |         ^ help: try this: `ErrorKind::PermissionDenied | _`\n \n-error: wildcard matches known variants and will also match future added variants\n+error: wildcard match will also match any future added variants\n   --> $DIR/wildcard_enum_match_arm.rs:99:13\n    |\n LL |             _ => (),\n-   |             ^ help: try this: `Enum::B | _`\n+   |             ^ help: try this: `Enum::B | Enum::__Private`\n \n error: aborting due to 6 previous errors\n "}]}