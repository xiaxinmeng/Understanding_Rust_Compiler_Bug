{"sha": "fa23d4fe93020bfde8f45c7cad077117d999c3ed", "node_id": "C_kwDOAAsO6NoAKGZhMjNkNGZlOTMwMjBiZmRlOGY0NWM3Y2FkMDc3MTE3ZDk5OWMzZWQ", "commit": {"author": {"name": "Samuel E. Moelius III", "email": "sam@moeli.us", "date": "2021-09-18T22:10:01Z"}, "committer": {"name": "Samuel E. Moelius III", "email": "sam@moeli.us", "date": "2021-09-30T01:51:46Z"}, "message": "Implement #85440", "tree": {"sha": "92954b6026eca5f0a28ce6ca89662c345e58854c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/92954b6026eca5f0a28ce6ca89662c345e58854c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fa23d4fe93020bfde8f45c7cad077117d999c3ed", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fa23d4fe93020bfde8f45c7cad077117d999c3ed", "html_url": "https://github.com/rust-lang/rust/commit/fa23d4fe93020bfde8f45c7cad077117d999c3ed", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fa23d4fe93020bfde8f45c7cad077117d999c3ed/comments", "author": {"login": "smoelius", "id": 35515885, "node_id": "MDQ6VXNlcjM1NTE1ODg1", "avatar_url": "https://avatars.githubusercontent.com/u/35515885?v=4", "gravatar_id": "", "url": "https://api.github.com/users/smoelius", "html_url": "https://github.com/smoelius", "followers_url": "https://api.github.com/users/smoelius/followers", "following_url": "https://api.github.com/users/smoelius/following{/other_user}", "gists_url": "https://api.github.com/users/smoelius/gists{/gist_id}", "starred_url": "https://api.github.com/users/smoelius/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/smoelius/subscriptions", "organizations_url": "https://api.github.com/users/smoelius/orgs", "repos_url": "https://api.github.com/users/smoelius/repos", "events_url": "https://api.github.com/users/smoelius/events{/privacy}", "received_events_url": "https://api.github.com/users/smoelius/received_events", "type": "User", "site_admin": false}, "committer": {"login": "smoelius", "id": 35515885, "node_id": "MDQ6VXNlcjM1NTE1ODg1", "avatar_url": "https://avatars.githubusercontent.com/u/35515885?v=4", "gravatar_id": "", "url": "https://api.github.com/users/smoelius", "html_url": "https://github.com/smoelius", "followers_url": "https://api.github.com/users/smoelius/followers", "following_url": "https://api.github.com/users/smoelius/following{/other_user}", "gists_url": "https://api.github.com/users/smoelius/gists{/gist_id}", "starred_url": "https://api.github.com/users/smoelius/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/smoelius/subscriptions", "organizations_url": "https://api.github.com/users/smoelius/orgs", "repos_url": "https://api.github.com/users/smoelius/repos", "events_url": "https://api.github.com/users/smoelius/events{/privacy}", "received_events_url": "https://api.github.com/users/smoelius/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e0c38af27cb5f6f961809601b717d6afc3b190ee", "url": "https://api.github.com/repos/rust-lang/rust/commits/e0c38af27cb5f6f961809601b717d6afc3b190ee", "html_url": "https://github.com/rust-lang/rust/commit/e0c38af27cb5f6f961809601b717d6afc3b190ee"}], "stats": {"total": 200, "additions": 186, "deletions": 14}, "files": [{"sha": "e26b9101011014a47f8cd126267a45851f6d7fd9", "filename": "library/test/src/cli.rs", "status": "modified", "additions": 74, "deletions": 0, "changes": 74, "blob_url": "https://github.com/rust-lang/rust/blob/fa23d4fe93020bfde8f45c7cad077117d999c3ed/library%2Ftest%2Fsrc%2Fcli.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fa23d4fe93020bfde8f45c7cad077117d999c3ed/library%2Ftest%2Fsrc%2Fcli.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Ftest%2Fsrc%2Fcli.rs?ref=fa23d4fe93020bfde8f45c7cad077117d999c3ed", "patch": "@@ -21,6 +21,8 @@ pub struct TestOpts {\n     pub nocapture: bool,\n     pub color: ColorConfig,\n     pub format: OutputFormat,\n+    pub shuffle: bool,\n+    pub shuffle_seed: Option<u64>,\n     pub test_threads: Option<usize>,\n     pub skip: Vec<String>,\n     pub time_options: Option<TestTimeOptions>,\n@@ -138,6 +140,13 @@ fn optgroups() -> getopts::Options {\n \n             `CRITICAL_TIME` here means the limit that should not be exceeded by test.\n             \",\n+        )\n+        .optflag(\"\", \"shuffle\", \"Run tests in random order\")\n+        .optopt(\n+            \"\",\n+            \"shuffle-seed\",\n+            \"Run tests in random order; seed the random number generator with SEED\",\n+            \"SEED\",\n         );\n     opts\n }\n@@ -155,6 +164,12 @@ By default, all tests are run in parallel. This can be altered with the\n --test-threads flag or the RUST_TEST_THREADS environment variable when running\n tests (set it to 1).\n \n+By default, the tests are run in alphabetical order. Use --shuffle or set\n+RUST_TEST_SHUFFLE to run the tests in random order. Pass the generated\n+\"shuffle seed\" to --shuffle-seed (or set RUST_TEST_SHUFFLE_SEED) to run the\n+tests in the same order again. Note that --shuffle and --shuffle-seed do not\n+affect whether the tests are run in parallel.\n+\n All tests have their standard output and standard error captured by default.\n This can be overridden with the --nocapture flag or setting RUST_TEST_NOCAPTURE\n environment variable to a value other than \"0\". Logging is not captured by default.\n@@ -218,6 +233,21 @@ macro_rules! unstable_optflag {\n     }};\n }\n \n+// Gets the option value and checks if unstable features are enabled.\n+macro_rules! unstable_optopt {\n+    ($matches:ident, $allow_unstable:ident, $option_name:literal) => {{\n+        let opt = $matches.opt_str($option_name);\n+        if !$allow_unstable && opt.is_some() {\n+            return Err(format!(\n+                \"The \\\"{}\\\" option is only accepted on the nightly compiler with -Z unstable-options\",\n+                $option_name\n+            ));\n+        }\n+\n+        opt\n+    }};\n+}\n+\n // Implementation of `parse_opts` that doesn't care about help message\n // and returns a `Result`.\n fn parse_opts_impl(matches: getopts::Matches) -> OptRes {\n@@ -227,6 +257,8 @@ fn parse_opts_impl(matches: getopts::Matches) -> OptRes {\n     let force_run_in_process = unstable_optflag!(matches, allow_unstable, \"force-run-in-process\");\n     let exclude_should_panic = unstable_optflag!(matches, allow_unstable, \"exclude-should-panic\");\n     let time_options = get_time_options(&matches, allow_unstable)?;\n+    let shuffle = get_shuffle(&matches, allow_unstable)?;\n+    let shuffle_seed = get_shuffle_seed(&matches, allow_unstable)?;\n \n     let include_ignored = matches.opt_present(\"include-ignored\");\n     let quiet = matches.opt_present(\"quiet\");\n@@ -260,6 +292,8 @@ fn parse_opts_impl(matches: getopts::Matches) -> OptRes {\n         nocapture,\n         color,\n         format,\n+        shuffle,\n+        shuffle_seed,\n         test_threads,\n         skip,\n         time_options,\n@@ -303,6 +337,46 @@ fn get_time_options(\n     Ok(options)\n }\n \n+fn get_shuffle(matches: &getopts::Matches, allow_unstable: bool) -> OptPartRes<bool> {\n+    let mut shuffle = unstable_optflag!(matches, allow_unstable, \"shuffle\");\n+    if !shuffle {\n+        shuffle = match env::var(\"RUST_TEST_SHUFFLE\") {\n+            Ok(val) => &val != \"0\",\n+            Err(_) => false,\n+        };\n+    }\n+\n+    Ok(shuffle)\n+}\n+\n+fn get_shuffle_seed(matches: &getopts::Matches, allow_unstable: bool) -> OptPartRes<Option<u64>> {\n+    let mut shuffle_seed = match unstable_optopt!(matches, allow_unstable, \"shuffle-seed\") {\n+        Some(n_str) => match n_str.parse::<u64>() {\n+            Ok(n) => Some(n),\n+            Err(e) => {\n+                return Err(format!(\n+                    \"argument for --shuffle-seed must be a number \\\n+                     (error: {})\",\n+                    e\n+                ));\n+            }\n+        },\n+        None => None,\n+    };\n+\n+    if shuffle_seed.is_none() {\n+        shuffle_seed = match env::var(\"RUST_TEST_SHUFFLE_SEED\") {\n+            Ok(val) => match val.parse::<u64>() {\n+                Ok(n) => Some(n),\n+                Err(_) => panic!(\"RUST_TEST_SHUFFLE_SEED is `{}`, should be a number.\", val),\n+            },\n+            Err(_) => None,\n+        };\n+    }\n+\n+    Ok(shuffle_seed)\n+}\n+\n fn get_test_threads(matches: &getopts::Matches) -> OptPartRes<Option<usize>> {\n     let test_threads = match matches.opt_str(\"test-threads\") {\n         Some(n_str) => match n_str.parse::<usize>() {"}, {"sha": "11c5ab48ed3e8e572faa2b7ade04a105009e197e", "filename": "library/test/src/console.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/fa23d4fe93020bfde8f45c7cad077117d999c3ed/library%2Ftest%2Fsrc%2Fconsole.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fa23d4fe93020bfde8f45c7cad077117d999c3ed/library%2Ftest%2Fsrc%2Fconsole.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Ftest%2Fsrc%2Fconsole.rs?ref=fa23d4fe93020bfde8f45c7cad077117d999c3ed", "patch": "@@ -225,9 +225,9 @@ fn on_test_event(\n     out: &mut dyn OutputFormatter,\n ) -> io::Result<()> {\n     match (*event).clone() {\n-        TestEvent::TeFiltered(ref filtered_tests) => {\n+        TestEvent::TeFiltered(ref filtered_tests, shuffle_seed) => {\n             st.total = filtered_tests.len();\n-            out.write_run_start(filtered_tests.len())?;\n+            out.write_run_start(filtered_tests.len(), shuffle_seed)?;\n         }\n         TestEvent::TeFilteredOut(filtered_out) => {\n             st.filtered_out = filtered_out;"}, {"sha": "6ff1a615eb4d055a7e3f78c5e5271a0101ec8d84", "filename": "library/test/src/event.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/fa23d4fe93020bfde8f45c7cad077117d999c3ed/library%2Ftest%2Fsrc%2Fevent.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fa23d4fe93020bfde8f45c7cad077117d999c3ed/library%2Ftest%2Fsrc%2Fevent.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Ftest%2Fsrc%2Fevent.rs?ref=fa23d4fe93020bfde8f45c7cad077117d999c3ed", "patch": "@@ -28,7 +28,7 @@ impl CompletedTest {\n \n #[derive(Debug, Clone)]\n pub enum TestEvent {\n-    TeFiltered(Vec<TestDesc>),\n+    TeFiltered(Vec<TestDesc>, Option<u64>),\n     TeWait(TestDesc),\n     TeResult(CompletedTest),\n     TeTimeout(TestDesc),"}, {"sha": "424d3ef7b4106fd29139f73563a31e4a4b36cb9f", "filename": "library/test/src/formatters/json.rs", "status": "modified", "additions": 8, "deletions": 3, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/fa23d4fe93020bfde8f45c7cad077117d999c3ed/library%2Ftest%2Fsrc%2Fformatters%2Fjson.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fa23d4fe93020bfde8f45c7cad077117d999c3ed/library%2Ftest%2Fsrc%2Fformatters%2Fjson.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Ftest%2Fsrc%2Fformatters%2Fjson.rs?ref=fa23d4fe93020bfde8f45c7cad077117d999c3ed", "patch": "@@ -60,10 +60,15 @@ impl<T: Write> JsonFormatter<T> {\n }\n \n impl<T: Write> OutputFormatter for JsonFormatter<T> {\n-    fn write_run_start(&mut self, test_count: usize) -> io::Result<()> {\n+    fn write_run_start(&mut self, test_count: usize, shuffle_seed: Option<u64>) -> io::Result<()> {\n+        let shuffle_seed_json = if let Some(shuffle_seed) = shuffle_seed {\n+            format!(r#\", \"shuffle_seed\": {}\"#, shuffle_seed)\n+        } else {\n+            String::new()\n+        };\n         self.writeln_message(&*format!(\n-            r#\"{{ \"type\": \"suite\", \"event\": \"started\", \"test_count\": {} }}\"#,\n-            test_count\n+            r#\"{{ \"type\": \"suite\", \"event\": \"started\", \"test_count\": {}{} }}\"#,\n+            test_count, shuffle_seed_json\n         ))\n     }\n "}, {"sha": "f3ae5494906cc34547a4dd44d248ee01000d2af1", "filename": "library/test/src/formatters/junit.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/fa23d4fe93020bfde8f45c7cad077117d999c3ed/library%2Ftest%2Fsrc%2Fformatters%2Fjunit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fa23d4fe93020bfde8f45c7cad077117d999c3ed/library%2Ftest%2Fsrc%2Fformatters%2Fjunit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Ftest%2Fsrc%2Fformatters%2Fjunit.rs?ref=fa23d4fe93020bfde8f45c7cad077117d999c3ed", "patch": "@@ -27,7 +27,11 @@ impl<T: Write> JunitFormatter<T> {\n }\n \n impl<T: Write> OutputFormatter for JunitFormatter<T> {\n-    fn write_run_start(&mut self, _test_count: usize) -> io::Result<()> {\n+    fn write_run_start(\n+        &mut self,\n+        _test_count: usize,\n+        _shuffle_seed: Option<u64>,\n+    ) -> io::Result<()> {\n         // We write xml header on run start\n         self.write_message(&\"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?>\")\n     }"}, {"sha": "cb80859759fad7c55968eeb6ec6b194e4cede049", "filename": "library/test/src/formatters/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/fa23d4fe93020bfde8f45c7cad077117d999c3ed/library%2Ftest%2Fsrc%2Fformatters%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fa23d4fe93020bfde8f45c7cad077117d999c3ed/library%2Ftest%2Fsrc%2Fformatters%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Ftest%2Fsrc%2Fformatters%2Fmod.rs?ref=fa23d4fe93020bfde8f45c7cad077117d999c3ed", "patch": "@@ -18,7 +18,7 @@ pub(crate) use self::pretty::PrettyFormatter;\n pub(crate) use self::terse::TerseFormatter;\n \n pub(crate) trait OutputFormatter {\n-    fn write_run_start(&mut self, test_count: usize) -> io::Result<()>;\n+    fn write_run_start(&mut self, test_count: usize, shuffle_seed: Option<u64>) -> io::Result<()>;\n     fn write_test_start(&mut self, desc: &TestDesc) -> io::Result<()>;\n     fn write_timeout(&mut self, desc: &TestDesc) -> io::Result<()>;\n     fn write_result("}, {"sha": "4a03b4b9147605c392fe76e4d7fa725fb37f9b49", "filename": "library/test/src/formatters/pretty.rs", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/fa23d4fe93020bfde8f45c7cad077117d999c3ed/library%2Ftest%2Fsrc%2Fformatters%2Fpretty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fa23d4fe93020bfde8f45c7cad077117d999c3ed/library%2Ftest%2Fsrc%2Fformatters%2Fpretty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Ftest%2Fsrc%2Fformatters%2Fpretty.rs?ref=fa23d4fe93020bfde8f45c7cad077117d999c3ed", "patch": "@@ -181,9 +181,14 @@ impl<T: Write> PrettyFormatter<T> {\n }\n \n impl<T: Write> OutputFormatter for PrettyFormatter<T> {\n-    fn write_run_start(&mut self, test_count: usize) -> io::Result<()> {\n+    fn write_run_start(&mut self, test_count: usize, shuffle_seed: Option<u64>) -> io::Result<()> {\n         let noun = if test_count != 1 { \"tests\" } else { \"test\" };\n-        self.write_plain(&format!(\"\\nrunning {} {}\\n\", test_count, noun))\n+        let shuffle_seed_msg = if let Some(shuffle_seed) = shuffle_seed {\n+            format!(\" (shuffle seed: {})\", shuffle_seed)\n+        } else {\n+            String::new()\n+        };\n+        self.write_plain(&format!(\"\\nrunning {} {}{}\\n\", test_count, noun, shuffle_seed_msg))\n     }\n \n     fn write_test_start(&mut self, desc: &TestDesc) -> io::Result<()> {"}, {"sha": "1f2c410cd96f3902493d9a17eab2fc5bc95a466c", "filename": "library/test/src/formatters/terse.rs", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/fa23d4fe93020bfde8f45c7cad077117d999c3ed/library%2Ftest%2Fsrc%2Fformatters%2Fterse.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fa23d4fe93020bfde8f45c7cad077117d999c3ed/library%2Ftest%2Fsrc%2Fformatters%2Fterse.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Ftest%2Fsrc%2Fformatters%2Fterse.rs?ref=fa23d4fe93020bfde8f45c7cad077117d999c3ed", "patch": "@@ -170,10 +170,15 @@ impl<T: Write> TerseFormatter<T> {\n }\n \n impl<T: Write> OutputFormatter for TerseFormatter<T> {\n-    fn write_run_start(&mut self, test_count: usize) -> io::Result<()> {\n+    fn write_run_start(&mut self, test_count: usize, shuffle_seed: Option<u64>) -> io::Result<()> {\n         self.total_test_count = test_count;\n         let noun = if test_count != 1 { \"tests\" } else { \"test\" };\n-        self.write_plain(&format!(\"\\nrunning {} {}\\n\", test_count, noun))\n+        let shuffle_seed_msg = if let Some(shuffle_seed) = shuffle_seed {\n+            format!(\" (shuffle seed: {})\", shuffle_seed)\n+        } else {\n+            String::new()\n+        };\n+        self.write_plain(&format!(\"\\nrunning {} {}{}\\n\", test_count, noun, shuffle_seed_msg))\n     }\n \n     fn write_test_start(&mut self, desc: &TestDesc) -> io::Result<()> {"}, {"sha": "049cadf86a6d029d3668882ad1d53b1a19d79f84", "filename": "library/test/src/helpers/mod.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/fa23d4fe93020bfde8f45c7cad077117d999c3ed/library%2Ftest%2Fsrc%2Fhelpers%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fa23d4fe93020bfde8f45c7cad077117d999c3ed/library%2Ftest%2Fsrc%2Fhelpers%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Ftest%2Fsrc%2Fhelpers%2Fmod.rs?ref=fa23d4fe93020bfde8f45c7cad077117d999c3ed", "patch": "@@ -5,3 +5,4 @@ pub mod concurrency;\n pub mod exit_code;\n pub mod isatty;\n pub mod metrics;\n+pub mod shuffle;"}, {"sha": "ca503106c556c43b5fd92e377a1ee6a4fc8db8e7", "filename": "library/test/src/helpers/shuffle.rs", "status": "added", "additions": 67, "deletions": 0, "changes": 67, "blob_url": "https://github.com/rust-lang/rust/blob/fa23d4fe93020bfde8f45c7cad077117d999c3ed/library%2Ftest%2Fsrc%2Fhelpers%2Fshuffle.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fa23d4fe93020bfde8f45c7cad077117d999c3ed/library%2Ftest%2Fsrc%2Fhelpers%2Fshuffle.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Ftest%2Fsrc%2Fhelpers%2Fshuffle.rs?ref=fa23d4fe93020bfde8f45c7cad077117d999c3ed", "patch": "@@ -0,0 +1,67 @@\n+use crate::cli::TestOpts;\n+use crate::types::{TestDescAndFn, TestId, TestName};\n+use std::collections::hash_map::DefaultHasher;\n+use std::hash::Hasher;\n+use std::time::{SystemTime, UNIX_EPOCH};\n+\n+pub fn get_shuffle_seed(opts: &TestOpts) -> Option<u64> {\n+    opts.shuffle_seed.or_else(|| {\n+        if opts.shuffle {\n+            Some(\n+                SystemTime::now()\n+                    .duration_since(UNIX_EPOCH)\n+                    .expect(\"Failed to get system time\")\n+                    .as_nanos() as u64,\n+            )\n+        } else {\n+            None\n+        }\n+    })\n+}\n+\n+pub fn shuffle_tests(shuffle_seed: u64, tests: &mut [(TestId, TestDescAndFn)]) {\n+    let test_names: Vec<&TestName> = tests.iter().map(|test| &test.1.desc.name).collect();\n+    let test_names_hash = calculate_hash(&test_names);\n+    let mut rng = Rng::new(shuffle_seed, test_names_hash);\n+    shuffle(&mut rng, tests);\n+}\n+\n+// `shuffle` is from `rust-analyzer/src/cli/analysis_stats.rs`.\n+fn shuffle<T>(rng: &mut Rng, slice: &mut [T]) {\n+    for i in 0..slice.len() {\n+        randomize_first(rng, &mut slice[i..]);\n+    }\n+\n+    fn randomize_first<T>(rng: &mut Rng, slice: &mut [T]) {\n+        assert!(!slice.is_empty());\n+        let idx = rng.rand_range(0..slice.len() as u64) as usize;\n+        slice.swap(0, idx);\n+    }\n+}\n+\n+struct Rng {\n+    state: u64,\n+    extra: u64,\n+}\n+\n+impl Rng {\n+    fn new(seed: u64, extra: u64) -> Self {\n+        Self { state: seed, extra }\n+    }\n+\n+    fn rand_range(&mut self, range: core::ops::Range<u64>) -> u64 {\n+        self.rand_u64() % (range.end - range.start) + range.start\n+    }\n+\n+    fn rand_u64(&mut self) -> u64 {\n+        self.state = calculate_hash(&(self.state, self.extra));\n+        self.state\n+    }\n+}\n+\n+// `calculate_hash` is from `core/src/hash/mod.rs`.\n+fn calculate_hash<T: core::hash::Hash>(t: &T) -> u64 {\n+    let mut s = DefaultHasher::new();\n+    t.hash(&mut s);\n+    s.finish()\n+}"}, {"sha": "67548819f654301fcc06bb39a6f529eeb40ce27c", "filename": "library/test/src/lib.rs", "status": "modified", "additions": 9, "deletions": 2, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/fa23d4fe93020bfde8f45c7cad077117d999c3ed/library%2Ftest%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fa23d4fe93020bfde8f45c7cad077117d999c3ed/library%2Ftest%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Ftest%2Fsrc%2Flib.rs?ref=fa23d4fe93020bfde8f45c7cad077117d999c3ed", "patch": "@@ -91,6 +91,7 @@ mod tests;\n use event::{CompletedTest, TestEvent};\n use helpers::concurrency::get_concurrency;\n use helpers::exit_code::get_exit_code;\n+use helpers::shuffle::{get_shuffle_seed, shuffle_tests};\n use options::{Concurrent, RunStrategy};\n use test_result::*;\n use time::TestExecTime;\n@@ -247,7 +248,9 @@ where\n \n     let filtered_descs = filtered_tests.iter().map(|t| t.desc.clone()).collect();\n \n-    let event = TestEvent::TeFiltered(filtered_descs);\n+    let shuffle_seed = get_shuffle_seed(opts);\n+\n+    let event = TestEvent::TeFiltered(filtered_descs, shuffle_seed);\n     notify_about_test_event(event)?;\n \n     let (filtered_tests, filtered_benchs): (Vec<_>, _) = filtered_tests\n@@ -259,7 +262,11 @@ where\n     let concurrency = opts.test_threads.unwrap_or_else(get_concurrency);\n \n     let mut remaining = filtered_tests;\n-    remaining.reverse();\n+    if let Some(shuffle_seed) = shuffle_seed {\n+        shuffle_tests(shuffle_seed, &mut remaining);\n+    } else {\n+        remaining.reverse();\n+    }\n     let mut pending = 0;\n \n     let (tx, rx) = channel::<CompletedTest>();"}, {"sha": "7b68b8fbaf82fba9d8be81ec31247b8d83f93802", "filename": "library/test/src/tests.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/fa23d4fe93020bfde8f45c7cad077117d999c3ed/library%2Ftest%2Fsrc%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fa23d4fe93020bfde8f45c7cad077117d999c3ed/library%2Ftest%2Fsrc%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Ftest%2Fsrc%2Ftests.rs?ref=fa23d4fe93020bfde8f45c7cad077117d999c3ed", "patch": "@@ -45,6 +45,8 @@ impl TestOpts {\n             nocapture: false,\n             color: AutoColor,\n             format: OutputFormat::Pretty,\n+            shuffle: false,\n+            shuffle_seed: None,\n             test_threads: None,\n             skip: vec![],\n             time_options: None,"}, {"sha": "d72ed61d134018f53fc8e0d1924dff5a5dc3fa30", "filename": "src/tools/compiletest/src/main.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/fa23d4fe93020bfde8f45c7cad077117d999c3ed/src%2Ftools%2Fcompiletest%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fa23d4fe93020bfde8f45c7cad077117d999c3ed/src%2Ftools%2Fcompiletest%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fmain.rs?ref=fa23d4fe93020bfde8f45c7cad077117d999c3ed", "patch": "@@ -505,6 +505,8 @@ pub fn test_opts(config: &Config) -> test::TestOpts {\n             Err(_) => false,\n         },\n         color: config.color,\n+        shuffle: false,\n+        shuffle_seed: None,\n         test_threads: None,\n         skip: vec![],\n         list: false,"}]}