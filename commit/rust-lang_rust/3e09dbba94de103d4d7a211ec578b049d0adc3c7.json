{"sha": "3e09dbba94de103d4d7a211ec578b049d0adc3c7", "node_id": "MDY6Q29tbWl0NzI0NzEyOjNlMDlkYmJhOTRkZTEwM2Q0ZDdhMjExZWM1NzhiMDQ5ZDBhZGMzYzc=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-06-23T13:25:43Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-06-23T13:25:43Z"}, "message": "Merge #5002\n\n5002: Fix underflow panic when doctests are at top of file r=Nashenas88 a=Nashenas88\n\nWhile debugging a comment at the top of a test string, I discovered that the offset calculations could underflow and panic. This only seemed to occur in tests, I assume because it's running a debug mode. The wrapping is quickly fixed later on in release mode, which is why this seems to have gone unnoticed. The new checks ensure the value is always positive or zero.\n\nCo-authored-by: Paul Daniel Faria <nashenas88@users.noreply.github.com>", "tree": {"sha": "d52a0a75e2ffcc7d71481f2d452969522c76d91e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d52a0a75e2ffcc7d71481f2d452969522c76d91e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3e09dbba94de103d4d7a211ec578b049d0adc3c7", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJe8gLXCRBK7hj4Ov3rIwAAdHIIABR3f+f/lncDa+pjw6b254OL\ng3H/LzyBhr80SoW4d5m6A8c66/RRldeTDT2/wyulGAVAt7rhi7m4kDRv0ORX5u4j\nzExG0sT8sjeS724LMeV50PbvCkMqM0Hy23pAY72H//8iKsh3ZNbM1Gj6KNrtpT7H\nCdPA1jM/vueYsISL4+RRnVXGWVSiRjFVv/cJqrLHJnswUaQZ4e/1AeTW3Z912fES\n1kB/TQx1qjnNX/6wFq9RIVj8GHyfg1ygjougi5AwVqOwzGjUFuVZrahC4H30+rCs\n7Q0/xQOM6OUD5DwE+A/oeqJfPMwoWZm4OHQ0cHgMVEk1Bwb3f8OO44t3jn/L1zc=\n=Jqi5\n-----END PGP SIGNATURE-----\n", "payload": "tree d52a0a75e2ffcc7d71481f2d452969522c76d91e\nparent 45f3a5f9c151e7728cda47ea20fa72b18927ca2b\nparent 0b971625c389c1638957b010a35c7bb1a6bd69b9\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1592918743 +0000\ncommitter GitHub <noreply@github.com> 1592918743 +0000\n\nMerge #5002\n\n5002: Fix underflow panic when doctests are at top of file r=Nashenas88 a=Nashenas88\n\nWhile debugging a comment at the top of a test string, I discovered that the offset calculations could underflow and panic. This only seemed to occur in tests, I assume because it's running a debug mode. The wrapping is quickly fixed later on in release mode, which is why this seems to have gone unnoticed. The new checks ensure the value is always positive or zero.\n\nCo-authored-by: Paul Daniel Faria <nashenas88@users.noreply.github.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3e09dbba94de103d4d7a211ec578b049d0adc3c7", "html_url": "https://github.com/rust-lang/rust/commit/3e09dbba94de103d4d7a211ec578b049d0adc3c7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3e09dbba94de103d4d7a211ec578b049d0adc3c7/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "45f3a5f9c151e7728cda47ea20fa72b18927ca2b", "url": "https://api.github.com/repos/rust-lang/rust/commits/45f3a5f9c151e7728cda47ea20fa72b18927ca2b", "html_url": "https://github.com/rust-lang/rust/commit/45f3a5f9c151e7728cda47ea20fa72b18927ca2b"}, {"sha": "0b971625c389c1638957b010a35c7bb1a6bd69b9", "url": "https://api.github.com/repos/rust-lang/rust/commits/0b971625c389c1638957b010a35c7bb1a6bd69b9", "html_url": "https://github.com/rust-lang/rust/commit/0b971625c389c1638957b010a35c7bb1a6bd69b9"}], "stats": {"total": 20, "additions": 15, "deletions": 5}, "files": [{"sha": "ac546806eb98476c238d33398613b90209c7c615", "filename": "crates/ra_ide/src/snapshots/highlight_doctest.html", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/3e09dbba94de103d4d7a211ec578b049d0adc3c7/crates%2Fra_ide%2Fsrc%2Fsnapshots%2Fhighlight_doctest.html", "raw_url": "https://github.com/rust-lang/rust/raw/3e09dbba94de103d4d7a211ec578b049d0adc3c7/crates%2Fra_ide%2Fsrc%2Fsnapshots%2Fhighlight_doctest.html", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fsnapshots%2Fhighlight_doctest.html?ref=3e09dbba94de103d4d7a211ec578b049d0adc3c7", "patch": "@@ -32,7 +32,10 @@\n .keyword.unsafe     { color: #BC8383; font-weight: bold; }\n .control            { font-style: italic; }\n </style>\n-<pre><code><span class=\"keyword\">struct</span> <span class=\"struct declaration\">Foo</span> {\n+<pre><code><span class=\"comment documentation\">/// ```</span>\n+<span class=\"comment documentation\">/// </span><span class=\"keyword\">let</span> _ = <span class=\"string_literal\">\"early doctests should not go boom\"</span>;\n+<span class=\"comment documentation\">/// ```</span>\n+<span class=\"keyword\">struct</span> <span class=\"struct declaration\">Foo</span> {\n     <span class=\"field declaration\">bar</span>: <span class=\"builtin_type\">bool</span>,\n }\n "}, {"sha": "9d82b400951ad28fa7cf4f0e2cb77cf1528f725a", "filename": "crates/ra_ide/src/syntax_highlighting/injection.rs", "status": "modified", "additions": 8, "deletions": 4, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/3e09dbba94de103d4d7a211ec578b049d0adc3c7/crates%2Fra_ide%2Fsrc%2Fsyntax_highlighting%2Finjection.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3e09dbba94de103d4d7a211ec578b049d0adc3c7/crates%2Fra_ide%2Fsrc%2Fsyntax_highlighting%2Finjection.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fsyntax_highlighting%2Finjection.rs?ref=3e09dbba94de103d4d7a211ec578b049d0adc3c7", "patch": "@@ -155,17 +155,21 @@ pub(super) fn highlight_doc_comment(\n         let mut start_offset = None;\n         let mut end_offset = None;\n         for (line_start, orig_line_start) in range_mapping.range(..h.range.end()).rev() {\n+            // It's possible for orig_line_start - line_start to be negative. Add h.range.start()\n+            // here and remove it from the end range after the loop below so that the values are\n+            // always non-negative.\n+            let offset = h.range.start() + orig_line_start - line_start;\n             if line_start <= &h.range.start() {\n-                start_offset.get_or_insert(orig_line_start - line_start);\n+                start_offset.get_or_insert(offset);\n                 break;\n             } else {\n-                end_offset.get_or_insert(orig_line_start - line_start);\n+                end_offset.get_or_insert(offset);\n             }\n         }\n         if let Some(start_offset) = start_offset {\n             h.range = TextRange::new(\n-                h.range.start() + start_offset,\n-                h.range.end() + end_offset.unwrap_or(start_offset),\n+                start_offset,\n+                h.range.end() + end_offset.unwrap_or(start_offset) - h.range.start(),\n             );\n \n             stack.add(h);"}, {"sha": "b1f48f03bc14bc598c58f7e627a0bcc3d08634e9", "filename": "crates/ra_ide/src/syntax_highlighting/tests.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/3e09dbba94de103d4d7a211ec578b049d0adc3c7/crates%2Fra_ide%2Fsrc%2Fsyntax_highlighting%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3e09dbba94de103d4d7a211ec578b049d0adc3c7/crates%2Fra_ide%2Fsrc%2Fsyntax_highlighting%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fsyntax_highlighting%2Ftests.rs?ref=3e09dbba94de103d4d7a211ec578b049d0adc3c7", "patch": "@@ -291,6 +291,9 @@ fn main() {\n fn test_highlight_doctest() {\n     check_highlighting(\n         r#\"\n+/// ```\n+/// let _ = \"early doctests should not go boom\";\n+/// ```\n struct Foo {\n     bar: bool,\n }"}]}