{"sha": "6466f89fc5df36b4c841fca9d10e27c50dd744b5", "node_id": "C_kwDOAAsO6NoAKDY0NjZmODlmYzVkZjM2YjRjODQxZmNhOWQxMGUyN2M1MGRkNzQ0YjU", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-01-10T10:03:03Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-01-10T10:03:03Z"}, "message": "Rollup merge of #92248 - compiler-errors:normalize-type-for-pointee, r=jackh726\n\nNormalize struct tail type when checking Pointee trait\n\nLet's go ahead and implement the FIXMEs by properly normalizing the struct-tail type when satisfying a Pointee obligation. This should fix the ICE when we try to calculate a layout depending on `<Ty as Pointee>::Metadata` later.\nFixes #92128\nFixes #92577\n\nAdditionally, mark the obligation as ambiguous if there are any infer types in that struct-tail type. This has the effect of causing `<_ as Pointee>::Metadata` to be properly replaced with an infer variable ([here](https://github.com/rust-lang/rust/blob/master/compiler/rustc_trait_selection/src/traits/project.rs#L813)) and registered as an obligation... this turns out to be very important in unifying function parameters with formals that are assoc types.\n\nFixes #91446", "tree": {"sha": "6fa30bed1d995e5eb4f781a78393eee688e1e5ad", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6fa30bed1d995e5eb4f781a78393eee688e1e5ad"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6466f89fc5df36b4c841fca9d10e27c50dd744b5", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJh3ARYCRBK7hj4Ov3rIwAAEGkIADQrU898FkwHGaaG9ACoHhn4\nZ1f4h6TDVvjIW8Er1JwO5FaOmhSMTJU4jUF79NsT1m4fzNnt1dxaWnJ0PFqt0nVO\ngDb1kMcBdJ69jmqWP0d4XrZed1dRflThvw6onZxoQS7e7joBRDzsa7v6XSJApojz\nSL9JYCkUw8F5QCW6Ghvptr99/s+6kPR2Z3drHEHuw0hIquE8Zg8LBM82hytTkrLO\nWW89XVJFfjVUpYGV5PJ/5MeOcmYmmcj+WbMg4zTcgOnUf6rWZ2lBnDuhwYvJ7kNw\nh7pVSJCIlacV6tf9UVGXwsO816KQjT+PO9gP3eFGtfMn0w1dnsiwKgk7YuRGI0A=\n=Y5dK\n-----END PGP SIGNATURE-----\n", "payload": "tree 6fa30bed1d995e5eb4f781a78393eee688e1e5ad\nparent d63a8d965e76f29a2b65c1f22a32613df1fe5c2c\nparent 5a1c460898e9e0559542f33e5ac4f690e054cd17\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1641808983 +0100\ncommitter GitHub <noreply@github.com> 1641808983 +0100\n\nRollup merge of #92248 - compiler-errors:normalize-type-for-pointee, r=jackh726\n\nNormalize struct tail type when checking Pointee trait\n\nLet's go ahead and implement the FIXMEs by properly normalizing the struct-tail type when satisfying a Pointee obligation. This should fix the ICE when we try to calculate a layout depending on `<Ty as Pointee>::Metadata` later.\nFixes #92128\nFixes #92577\n\nAdditionally, mark the obligation as ambiguous if there are any infer types in that struct-tail type. This has the effect of causing `<_ as Pointee>::Metadata` to be properly replaced with an infer variable ([here](https://github.com/rust-lang/rust/blob/master/compiler/rustc_trait_selection/src/traits/project.rs#L813)) and registered as an obligation... this turns out to be very important in unifying function parameters with formals that are assoc types.\n\nFixes #91446\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6466f89fc5df36b4c841fca9d10e27c50dd744b5", "html_url": "https://github.com/rust-lang/rust/commit/6466f89fc5df36b4c841fca9d10e27c50dd744b5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6466f89fc5df36b4c841fca9d10e27c50dd744b5/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d63a8d965e76f29a2b65c1f22a32613df1fe5c2c", "url": "https://api.github.com/repos/rust-lang/rust/commits/d63a8d965e76f29a2b65c1f22a32613df1fe5c2c", "html_url": "https://github.com/rust-lang/rust/commit/d63a8d965e76f29a2b65c1f22a32613df1fe5c2c"}, {"sha": "5a1c460898e9e0559542f33e5ac4f690e054cd17", "url": "https://api.github.com/repos/rust-lang/rust/commits/5a1c460898e9e0559542f33e5ac4f690e054cd17", "html_url": "https://github.com/rust-lang/rust/commit/5a1c460898e9e0559542f33e5ac4f690e054cd17"}], "stats": {"total": 71, "additions": 61, "deletions": 10}, "files": [{"sha": "0d37711d72e67e60f704a5505fa82abd1ac9a6cc", "filename": "compiler/rustc_middle/src/ty/sty.rs", "status": "modified", "additions": 6, "deletions": 3, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/6466f89fc5df36b4c841fca9d10e27c50dd744b5/compiler%2Frustc_middle%2Fsrc%2Fty%2Fsty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6466f89fc5df36b4c841fca9d10e27c50dd744b5/compiler%2Frustc_middle%2Fsrc%2Fty%2Fsty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fsty.rs?ref=6466f89fc5df36b4c841fca9d10e27c50dd744b5", "patch": "@@ -2143,9 +2143,12 @@ impl<'tcx> TyS<'tcx> {\n     }\n \n     /// Returns the type of metadata for (potentially fat) pointers to this type.\n-    pub fn ptr_metadata_ty(&'tcx self, tcx: TyCtxt<'tcx>) -> Ty<'tcx> {\n-        // FIXME:\u00a0should this normalize?\n-        let tail = tcx.struct_tail_without_normalization(self);\n+    pub fn ptr_metadata_ty(\n+        &'tcx self,\n+        tcx: TyCtxt<'tcx>,\n+        normalize: impl FnMut(Ty<'tcx>) -> Ty<'tcx>,\n+    ) -> Ty<'tcx> {\n+        let tail = tcx.struct_tail_with_normalize(self, normalize);\n         match tail.kind() {\n             // Sized types\n             ty::Infer(ty::IntVar(_) | ty::FloatVar(_))"}, {"sha": "8793264a47fbb3438c0f82e00bca58444de6e594", "filename": "compiler/rustc_middle/src/ty/util.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/6466f89fc5df36b4c841fca9d10e27c50dd744b5/compiler%2Frustc_middle%2Fsrc%2Fty%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6466f89fc5df36b4c841fca9d10e27c50dd744b5/compiler%2Frustc_middle%2Fsrc%2Fty%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Futil.rs?ref=6466f89fc5df36b4c841fca9d10e27c50dd744b5", "patch": "@@ -192,7 +192,7 @@ impl<'tcx> TyCtxt<'tcx> {\n     pub fn struct_tail_with_normalize(\n         self,\n         mut ty: Ty<'tcx>,\n-        normalize: impl Fn(Ty<'tcx>) -> Ty<'tcx>,\n+        mut normalize: impl FnMut(Ty<'tcx>) -> Ty<'tcx>,\n     ) -> Ty<'tcx> {\n         let recursion_limit = self.recursion_limit();\n         for iteration in 0.. {"}, {"sha": "035bc9b00c9305f3545b56b7ae7bfa47edd088eb", "filename": "compiler/rustc_trait_selection/src/traits/project.rs", "status": "modified", "additions": 32, "deletions": 6, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/6466f89fc5df36b4c841fca9d10e27c50dd744b5/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fproject.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6466f89fc5df36b4c841fca9d10e27c50dd744b5/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fproject.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fproject.rs?ref=6466f89fc5df36b4c841fca9d10e27c50dd744b5", "patch": "@@ -1400,8 +1400,17 @@ fn assemble_candidates_from_impls<'cx, 'tcx>(\n                 // Any type with multiple potential metadata types is therefore not eligible.\n                 let self_ty = selcx.infcx().shallow_resolve(obligation.predicate.self_ty());\n \n-                // FIXME:\u00a0should this normalize?\n-                let tail = selcx.tcx().struct_tail_without_normalization(self_ty);\n+                let tail = selcx.tcx().struct_tail_with_normalize(self_ty, |ty| {\n+                    normalize_with_depth(\n+                        selcx,\n+                        obligation.param_env,\n+                        obligation.cause.clone(),\n+                        obligation.recursion_depth + 1,\n+                        ty,\n+                    )\n+                    .value\n+                });\n+\n                 match tail.kind() {\n                     ty::Bool\n                     | ty::Char\n@@ -1435,7 +1444,12 @@ fn assemble_candidates_from_impls<'cx, 'tcx>(\n                     | ty::Bound(..)\n                     | ty::Placeholder(..)\n                     | ty::Infer(..)\n-                    | ty::Error(_) => false,\n+                    | ty::Error(_) => {\n+                        if tail.has_infer_types() {\n+                            candidate_set.mark_ambiguous();\n+                        }\n+                        false\n+                    },\n                 }\n             }\n             super::ImplSource::Param(..) => {\n@@ -1640,18 +1654,30 @@ fn confirm_pointee_candidate<'cx, 'tcx>(\n     _: ImplSourcePointeeData,\n ) -> Progress<'tcx> {\n     let tcx = selcx.tcx();\n-\n     let self_ty = selcx.infcx().shallow_resolve(obligation.predicate.self_ty());\n-    let substs = tcx.mk_substs([self_ty.into()].iter());\n \n+    let mut obligations = vec![];\n+    let metadata_ty = self_ty.ptr_metadata_ty(tcx, |ty| {\n+        normalize_with_depth_to(\n+            selcx,\n+            obligation.param_env,\n+            obligation.cause.clone(),\n+            obligation.recursion_depth + 1,\n+            ty,\n+            &mut obligations,\n+        )\n+    });\n+\n+    let substs = tcx.mk_substs([self_ty.into()].iter());\n     let metadata_def_id = tcx.require_lang_item(LangItem::Metadata, None);\n \n     let predicate = ty::ProjectionPredicate {\n         projection_ty: ty::ProjectionTy { substs, item_def_id: metadata_def_id },\n-        ty: self_ty.ptr_metadata_ty(tcx),\n+        ty: metadata_ty,\n     };\n \n     confirm_param_env_candidate(selcx, obligation, ty::Binder::dummy(predicate), false)\n+        .with_addl_obligations(obligations)\n }\n \n fn confirm_fn_pointer_candidate<'cx, 'tcx>("}, {"sha": "f888246967d3dcdb215c21e0a91a7d52aeeb8b27", "filename": "src/test/ui/traits/pointee-deduction.rs", "status": "added", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/6466f89fc5df36b4c841fca9d10e27c50dd744b5/src%2Ftest%2Fui%2Ftraits%2Fpointee-deduction.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6466f89fc5df36b4c841fca9d10e27c50dd744b5/src%2Ftest%2Fui%2Ftraits%2Fpointee-deduction.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftraits%2Fpointee-deduction.rs?ref=6466f89fc5df36b4c841fca9d10e27c50dd744b5", "patch": "@@ -0,0 +1,22 @@\n+// run-pass\n+\n+#![feature(ptr_metadata)]\n+\n+use std::alloc::Layout;\n+use std::ptr::Pointee;\n+\n+trait Foo {\n+    type Bar;\n+}\n+\n+impl Foo for () {\n+    type Bar = ();\n+}\n+\n+struct Wrapper1<T: Foo>(<T as Foo>::Bar);\n+struct Wrapper2<T: Foo>(<Wrapper1<T> as Pointee>::Metadata);\n+\n+fn main() {\n+    let _: Wrapper2<()> = Wrapper2(());\n+    let _ = Layout::new::<Wrapper2<()>>();\n+}"}]}