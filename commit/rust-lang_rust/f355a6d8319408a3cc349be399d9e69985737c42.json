{"sha": "f355a6d8319408a3cc349be399d9e69985737c42", "node_id": "MDY6Q29tbWl0NzI0NzEyOmYzNTVhNmQ4MzE5NDA4YTNjYzM0OWJlMzk5ZDllNjk5ODU3MzdjNDI=", "commit": {"author": {"name": "Jesse Bakker", "email": "github@jessebakker.com", "date": "2020-12-31T12:05:19Z"}, "committer": {"name": "Jesse Bakker", "email": "github@jessebakker.com", "date": "2020-12-31T14:33:20Z"}, "message": "Split textDocument/formatting TextEdit with diff", "tree": {"sha": "e527a3297191ab0a5d9450ecfb12f71f7a51e5ee", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e527a3297191ab0a5d9450ecfb12f71f7a51e5ee"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f355a6d8319408a3cc349be399d9e69985737c42", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f355a6d8319408a3cc349be399d9e69985737c42", "html_url": "https://github.com/rust-lang/rust/commit/f355a6d8319408a3cc349be399d9e69985737c42", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f355a6d8319408a3cc349be399d9e69985737c42/comments", "author": {"login": "Jesse-Bakker", "id": 22473248, "node_id": "MDQ6VXNlcjIyNDczMjQ4", "avatar_url": "https://avatars.githubusercontent.com/u/22473248?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Jesse-Bakker", "html_url": "https://github.com/Jesse-Bakker", "followers_url": "https://api.github.com/users/Jesse-Bakker/followers", "following_url": "https://api.github.com/users/Jesse-Bakker/following{/other_user}", "gists_url": "https://api.github.com/users/Jesse-Bakker/gists{/gist_id}", "starred_url": "https://api.github.com/users/Jesse-Bakker/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Jesse-Bakker/subscriptions", "organizations_url": "https://api.github.com/users/Jesse-Bakker/orgs", "repos_url": "https://api.github.com/users/Jesse-Bakker/repos", "events_url": "https://api.github.com/users/Jesse-Bakker/events{/privacy}", "received_events_url": "https://api.github.com/users/Jesse-Bakker/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Jesse-Bakker", "id": 22473248, "node_id": "MDQ6VXNlcjIyNDczMjQ4", "avatar_url": "https://avatars.githubusercontent.com/u/22473248?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Jesse-Bakker", "html_url": "https://github.com/Jesse-Bakker", "followers_url": "https://api.github.com/users/Jesse-Bakker/followers", "following_url": "https://api.github.com/users/Jesse-Bakker/following{/other_user}", "gists_url": "https://api.github.com/users/Jesse-Bakker/gists{/gist_id}", "starred_url": "https://api.github.com/users/Jesse-Bakker/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Jesse-Bakker/subscriptions", "organizations_url": "https://api.github.com/users/Jesse-Bakker/orgs", "repos_url": "https://api.github.com/users/Jesse-Bakker/repos", "events_url": "https://api.github.com/users/Jesse-Bakker/events{/privacy}", "received_events_url": "https://api.github.com/users/Jesse-Bakker/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9bb9fbab3ab603150990ef8f2df12bddc7104058", "url": "https://api.github.com/repos/rust-lang/rust/commits/9bb9fbab3ab603150990ef8f2df12bddc7104058", "html_url": "https://github.com/rust-lang/rust/commit/9bb9fbab3ab603150990ef8f2df12bddc7104058"}], "stats": {"total": 105, "additions": 82, "deletions": 23}, "files": [{"sha": "1213e5762246f02767a7607c88cd1f6f8199e255", "filename": "Cargo.lock", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/f355a6d8319408a3cc349be399d9e69985737c42/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/f355a6d8319408a3cc349be399d9e69985737c42/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=f355a6d8319408a3cc349be399d9e69985737c42", "patch": "@@ -347,6 +347,12 @@ version = \"2.0.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"524cbf6897b527295dff137cec09ecf3a05f4fddffd7dfcd1585403449e74198\"\n \n+[[package]]\n+name = \"dissimilar\"\n+version = \"1.0.2\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"fc4b29f4b9bb94bf267d57269fd0706d343a160937108e9619fe380645428abb\"\n+\n [[package]]\n name = \"drop_bomb\"\n version = \"0.1.5\"\n@@ -1333,6 +1339,7 @@ dependencies = [\n  \"anyhow\",\n  \"cfg\",\n  \"crossbeam-channel 0.5.0\",\n+ \"dissimilar\",\n  \"env_logger\",\n  \"expect-test\",\n  \"flycheck\","}, {"sha": "470c1d45898b1cdc99ecca0a528c2de51ccddbdf", "filename": "crates/rust-analyzer/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/f355a6d8319408a3cc349be399d9e69985737c42/crates%2Frust-analyzer%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/f355a6d8319408a3cc349be399d9e69985737c42/crates%2Frust-analyzer%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2FCargo.toml?ref=f355a6d8319408a3cc349be399d9e69985737c42", "patch": "@@ -17,6 +17,7 @@ path = \"src/bin/main.rs\"\n [dependencies]\n anyhow = \"1.0.26\"\n crossbeam-channel = \"0.5.0\"\n+dissimilar = \"1.0.2\"\n env_logger = { version = \"0.8.1\", default-features = false }\n itertools = \"0.9.0\"\n jod-thread = \"0.1.0\""}, {"sha": "231be58077834b53d44f7fcfd87d19f01c26edeb", "filename": "crates/rust-analyzer/src/diff.rs", "status": "added", "additions": 53, "deletions": 0, "changes": 53, "blob_url": "https://github.com/rust-lang/rust/blob/f355a6d8319408a3cc349be399d9e69985737c42/crates%2Frust-analyzer%2Fsrc%2Fdiff.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f355a6d8319408a3cc349be399d9e69985737c42/crates%2Frust-analyzer%2Fsrc%2Fdiff.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fdiff.rs?ref=f355a6d8319408a3cc349be399d9e69985737c42", "patch": "@@ -0,0 +1,53 @@\n+//! Generate minimal `TextEdit`s from different text versions\n+use dissimilar::Chunk;\n+use ide::{TextEdit, TextRange, TextSize};\n+\n+pub(crate) fn diff(left: &str, right: &str) -> TextEdit {\n+    let chunks = dissimilar::diff(left, right);\n+    textedit_from_chunks(chunks)\n+}\n+\n+fn textedit_from_chunks(chunks: Vec<dissimilar::Chunk>) -> TextEdit {\n+    let mut builder = TextEdit::builder();\n+    let mut pos = TextSize::default();\n+\n+    let mut chunks = chunks.into_iter().peekable();\n+    while let Some(chunk) = chunks.next() {\n+        if let (Chunk::Delete(deleted), Some(&Chunk::Insert(inserted))) = (chunk, chunks.peek()) {\n+            chunks.next().unwrap();\n+            let deleted_len = TextSize::of(deleted);\n+            builder.replace(TextRange::at(pos, deleted_len), inserted.into());\n+            pos += deleted_len;\n+            continue;\n+        }\n+\n+        match chunk {\n+            Chunk::Equal(text) => {\n+                pos += TextSize::of(text);\n+            }\n+            Chunk::Delete(deleted) => {\n+                let deleted_len = TextSize::of(deleted);\n+                builder.delete(TextRange::at(pos, deleted_len));\n+                pos += deleted_len;\n+            }\n+            Chunk::Insert(inserted) => {\n+                builder.insert(pos, inserted.into());\n+            }\n+        }\n+    }\n+    builder.finish()\n+}\n+\n+#[cfg(test)]\n+mod tests {\n+    use super::*;\n+\n+    #[test]\n+    fn diff_applies() {\n+        let mut original = String::from(\"fn foo(a:u32){\\n}\");\n+        let result = \"fn foo(a: u32) {}\";\n+        let edit = diff(&original, result);\n+        edit.apply(&mut original);\n+        assert_eq!(original, result);\n+    }\n+}"}, {"sha": "ec37fba04fe1f365dca5d43c49220ebf5acf9a4d", "filename": "crates/rust-analyzer/src/handlers.rs", "status": "modified", "additions": 7, "deletions": 5, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/f355a6d8319408a3cc349be399d9e69985737c42/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f355a6d8319408a3cc349be399d9e69985737c42/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs?ref=f355a6d8319408a3cc349be399d9e69985737c42", "patch": "@@ -29,6 +29,7 @@ use serde_json::to_value;\n use stdx::{format_to, split_once};\n use syntax::{algo, ast, AstNode, TextRange, TextSize};\n \n+use crate::diff::diff;\n use crate::{\n     cargo_target_spec::CargoTargetSpec,\n     config::RustfmtConfig,\n@@ -799,7 +800,7 @@ pub(crate) fn handle_formatting(\n     let crate_ids = snap.analysis.crate_for(file_id)?;\n \n     let file_line_index = snap.analysis.file_line_index(file_id)?;\n-    let end_position = to_proto::position(&file_line_index, TextSize::of(file.as_str()));\n+    let file_line_endings = snap.file_line_endings(file_id);\n \n     let mut rustfmt = match &snap.config.rustfmt {\n         RustfmtConfig::Rustfmt { extra_args } => {\n@@ -858,10 +859,11 @@ pub(crate) fn handle_formatting(\n         // The document is already formatted correctly -- no edits needed.\n         Ok(None)\n     } else {\n-        Ok(Some(vec![lsp_types::TextEdit {\n-            range: Range::new(Position::new(0, 0), end_position),\n-            new_text: captured_stdout,\n-        }]))\n+        Ok(Some(to_proto::text_edit_vec(\n+            &file_line_index,\n+            file_line_endings,\n+            diff(&file, &captured_stdout),\n+        )))\n     }\n }\n "}, {"sha": "682fa5f7f220bf0dbff4a5b530fc1ded73250733", "filename": "crates/rust-analyzer/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/f355a6d8319408a3cc349be399d9e69985737c42/crates%2Frust-analyzer%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f355a6d8319408a3cc349be399d9e69985737c42/crates%2Frust-analyzer%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Flib.rs?ref=f355a6d8319408a3cc349be399d9e69985737c42", "patch": "@@ -34,6 +34,7 @@ mod request_metrics;\n mod lsp_utils;\n mod thread_pool;\n mod document;\n+mod diff;\n pub mod lsp_ext;\n pub mod config;\n "}, {"sha": "84db0856d48ce4218c5bc120801182ed8020f42b", "filename": "crates/rust-analyzer/tests/rust-analyzer/main.rs", "status": "modified", "additions": 13, "deletions": 18, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/f355a6d8319408a3cc349be399d9e69985737c42/crates%2Frust-analyzer%2Ftests%2Frust-analyzer%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f355a6d8319408a3cc349be399d9e69985737c42/crates%2Frust-analyzer%2Ftests%2Frust-analyzer%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Ftests%2Frust-analyzer%2Fmain.rs?ref=f355a6d8319408a3cc349be399d9e69985737c42", "patch": "@@ -190,15 +190,10 @@ pub use std::collections::HashMap;\n         },\n         json!([\n             {\n-                \"newText\": r#\"mod bar;\n-\n-fn main() {}\n-\n-pub use std::collections::HashMap;\n-\"#,\n+                \"newText\": \"\",\n                 \"range\": {\n-                    \"end\": { \"character\": 0, \"line\": 6 },\n-                    \"start\": { \"character\": 0, \"line\": 0 }\n+                    \"end\": { \"character\": 0, \"line\": 3 },\n+                    \"start\": { \"character\": 11, \"line\": 2 }\n                 }\n             }\n         ]),\n@@ -248,17 +243,17 @@ pub use std::collections::HashMap;\n         },\n         json!([\n             {\n-                \"newText\": r#\"mod bar;\n-\n-async fn test() {}\n-\n-fn main() {}\n-\n-pub use std::collections::HashMap;\n-\"#,\n+                \"newText\": \"\",\n+                \"range\": {\n+                    \"end\": { \"character\": 0, \"line\": 3 },\n+                    \"start\": { \"character\": 17, \"line\": 2 }\n+                }\n+            },\n+            {\n+                \"newText\": \"\",\n                 \"range\": {\n-                    \"end\": { \"character\": 0, \"line\": 9 },\n-                    \"start\": { \"character\": 0, \"line\": 0 }\n+                    \"end\": { \"character\": 0, \"line\": 6 },\n+                    \"start\": { \"character\": 11, \"line\": 5 }\n                 }\n             }\n         ]),"}]}