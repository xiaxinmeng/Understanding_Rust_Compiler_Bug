{"sha": "7c7f58d5b7b5b453fde743bb058aa5770a37e57f", "node_id": "C_kwDOAAsO6NoAKDdjN2Y1OGQ1YjdiNWI0NTNmZGU3NDNiYjA1OGFhNTc3MGEzN2U1N2Y", "commit": {"author": {"name": "Nilstrieb", "email": "48135649+Nilstrieb@users.noreply.github.com", "date": "2021-11-16T21:16:47Z"}, "committer": {"name": "Nilstrieb", "email": "48135649+Nilstrieb@users.noreply.github.com", "date": "2021-11-16T21:16:47Z"}, "message": "Fix case where ICE #90878 was still triggered by a leading newline\n\nI cannot provide a test for that thanks to tidy.", "tree": {"sha": "7eb51bd364170d8694e684292dfe64297c28dd7e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7eb51bd364170d8694e684292dfe64297c28dd7e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7c7f58d5b7b5b453fde743bb058aa5770a37e57f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7c7f58d5b7b5b453fde743bb058aa5770a37e57f", "html_url": "https://github.com/rust-lang/rust/commit/7c7f58d5b7b5b453fde743bb058aa5770a37e57f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7c7f58d5b7b5b453fde743bb058aa5770a37e57f/comments", "author": {"login": "Nilstrieb", "id": 48135649, "node_id": "MDQ6VXNlcjQ4MTM1NjQ5", "avatar_url": "https://avatars.githubusercontent.com/u/48135649?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Nilstrieb", "html_url": "https://github.com/Nilstrieb", "followers_url": "https://api.github.com/users/Nilstrieb/followers", "following_url": "https://api.github.com/users/Nilstrieb/following{/other_user}", "gists_url": "https://api.github.com/users/Nilstrieb/gists{/gist_id}", "starred_url": "https://api.github.com/users/Nilstrieb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Nilstrieb/subscriptions", "organizations_url": "https://api.github.com/users/Nilstrieb/orgs", "repos_url": "https://api.github.com/users/Nilstrieb/repos", "events_url": "https://api.github.com/users/Nilstrieb/events{/privacy}", "received_events_url": "https://api.github.com/users/Nilstrieb/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Nilstrieb", "id": 48135649, "node_id": "MDQ6VXNlcjQ4MTM1NjQ5", "avatar_url": "https://avatars.githubusercontent.com/u/48135649?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Nilstrieb", "html_url": "https://github.com/Nilstrieb", "followers_url": "https://api.github.com/users/Nilstrieb/followers", "following_url": "https://api.github.com/users/Nilstrieb/following{/other_user}", "gists_url": "https://api.github.com/users/Nilstrieb/gists{/gist_id}", "starred_url": "https://api.github.com/users/Nilstrieb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Nilstrieb/subscriptions", "organizations_url": "https://api.github.com/users/Nilstrieb/orgs", "repos_url": "https://api.github.com/users/Nilstrieb/repos", "events_url": "https://api.github.com/users/Nilstrieb/events{/privacy}", "received_events_url": "https://api.github.com/users/Nilstrieb/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d64aea65ad3b994ed0e1503f836d82a9896ab468", "url": "https://api.github.com/repos/rust-lang/rust/commits/d64aea65ad3b994ed0e1503f836d82a9896ab468", "html_url": "https://github.com/rust-lang/rust/commit/d64aea65ad3b994ed0e1503f836d82a9896ab468"}], "stats": {"total": 16, "additions": 7, "deletions": 9}, "files": [{"sha": "2e4cb4ff7270d75cd451d9b0f3e3ef301667ec56", "filename": "compiler/rustc_resolve/src/diagnostics.rs", "status": "modified", "additions": 7, "deletions": 9, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/7c7f58d5b7b5b453fde743bb058aa5770a37e57f/compiler%2Frustc_resolve%2Fsrc%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7c7f58d5b7b5b453fde743bb058aa5770a37e57f/compiler%2Frustc_resolve%2Fsrc%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Fdiagnostics.rs?ref=7c7f58d5b7b5b453fde743bb058aa5770a37e57f", "patch": "@@ -454,22 +454,20 @@ impl<'a> Resolver<'a> {\n                 // edit:\n                 // only do this if the const and usage of the non-constant value are on the same line\n                 // the further the two are apart, the higher the chance of the suggestion being wrong\n-                // also make sure that this line isn't the first one (ICE #90878)\n+                // also make sure that the pos for the suggestion is not 0 (ICE #90878)\n \n                 let sp =\n                     self.session.source_map().span_extend_to_prev_str(ident.span, current, true);\n \n-                let is_first_line = self\n-                    .session\n-                    .source_map()\n-                    .lookup_line(sp.lo())\n-                    .map(|file_and_line| file_and_line.line == 0)\n-                    .unwrap_or(true);\n+                let pos_for_suggestion = sp.lo().0.saturating_sub(current.len() as u32);\n \n-                if sp.lo().0 == 0 || self.session.source_map().is_multiline(sp) || is_first_line {\n+                if sp.lo().0 == 0\n+                    || pos_for_suggestion == 0\n+                    || self.session.source_map().is_multiline(sp)\n+                {\n                     err.span_label(ident.span, &format!(\"this would need to be a `{}`\", sugg));\n                 } else {\n-                    let sp = sp.with_lo(BytePos(sp.lo().0 - current.len() as u32));\n+                    let sp = sp.with_lo(BytePos(pos_for_suggestion));\n                     err.span_suggestion(\n                         sp,\n                         &format!(\"consider using `{}` instead of `{}`\", sugg, current),"}]}