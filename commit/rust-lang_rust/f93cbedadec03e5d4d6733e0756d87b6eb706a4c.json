{"sha": "f93cbedadec03e5d4d6733e0756d87b6eb706a4c", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY5M2NiZWRhZGVjMDNlNWQ0ZDY3MzNlMDc1NmQ4N2I2ZWI3MDZhNGM=", "commit": {"author": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2021-08-06T09:36:54Z"}, "committer": {"name": "Esteban Kuber", "email": "esteban@kuber.com.ar", "date": "2021-08-09T07:01:35Z"}, "message": "Do not ICE on HIR based WF check when involving lifetimes\n\nFix #87549.", "tree": {"sha": "1396167096ced9c38fa38e849dfcfd2769fe25c4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1396167096ced9c38fa38e849dfcfd2769fe25c4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f93cbedadec03e5d4d6733e0756d87b6eb706a4c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f93cbedadec03e5d4d6733e0756d87b6eb706a4c", "html_url": "https://github.com/rust-lang/rust/commit/f93cbedadec03e5d4d6733e0756d87b6eb706a4c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f93cbedadec03e5d4d6733e0756d87b6eb706a4c/comments", "author": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "committer": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d4ad1cfc63ba5824196bfb2370451ddb5af2e020", "url": "https://api.github.com/repos/rust-lang/rust/commits/d4ad1cfc63ba5824196bfb2370451ddb5af2e020", "html_url": "https://github.com/rust-lang/rust/commit/d4ad1cfc63ba5824196bfb2370451ddb5af2e020"}], "stats": {"total": 52, "additions": 49, "deletions": 3}, "files": [{"sha": "ac07cc1f03439a360ee0ecff4d13ca356382d0d8", "filename": "compiler/rustc_trait_selection/src/traits/error_reporting/mod.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/f93cbedadec03e5d4d6733e0756d87b6eb706a4c/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f93cbedadec03e5d4d6733e0756d87b6eb706a4c/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fmod.rs?ref=f93cbedadec03e5d4d6733e0756d87b6eb706a4c", "patch": "@@ -245,9 +245,10 @@ impl<'a, 'tcx> InferCtxtExt<'tcx> for InferCtxt<'a, 'tcx> {\n                 if let ObligationCauseCode::WellFormed(Some(wf_loc)) =\n                     root_obligation.cause.code.peel_derives()\n                 {\n-                    if let Some(cause) =\n-                        self.tcx.diagnostic_hir_wf_check((obligation.predicate, wf_loc.clone()))\n-                    {\n+                    if let Some(cause) = self.tcx.diagnostic_hir_wf_check((\n+                        tcx.erase_regions(obligation.predicate),\n+                        wf_loc.clone(),\n+                    )) {\n                         obligation.cause = cause;\n                         span = obligation.cause.span;\n                     }"}, {"sha": "bb398e5698a8018797877601ccd9596c4f9564f5", "filename": "src/test/ui/wf/hir-wf-check-erase-regions.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/f93cbedadec03e5d4d6733e0756d87b6eb706a4c/src%2Ftest%2Fui%2Fwf%2Fhir-wf-check-erase-regions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f93cbedadec03e5d4d6733e0756d87b6eb706a4c/src%2Ftest%2Fui%2Fwf%2Fhir-wf-check-erase-regions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fwf%2Fhir-wf-check-erase-regions.rs?ref=f93cbedadec03e5d4d6733e0756d87b6eb706a4c", "patch": "@@ -0,0 +1,14 @@\n+// Regression test for #87549.\n+// compile-flags: -C incremental=tmp/wf/hir-wf-check-erase-regions\n+\n+pub struct Table<T, const N: usize>([Option<T>; N]);\n+\n+impl<'a, T, const N: usize> IntoIterator for &'a Table<T, N> {\n+    type IntoIter = std::iter::Flatten<std::slice::Iter<'a, T>>; //~ ERROR `&T` is not an iterator\n+    type Item = &'a T;\n+\n+    fn into_iter(self) -> Self::IntoIter { //~ ERROR `&T` is not an iterator\n+        unimplemented!()\n+    }\n+}\n+fn main() {}"}, {"sha": "a704754e82a9210f53a765c2e42cb8f14b2ca34c", "filename": "src/test/ui/wf/hir-wf-check-erase-regions.stderr", "status": "added", "additions": 31, "deletions": 0, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/f93cbedadec03e5d4d6733e0756d87b6eb706a4c/src%2Ftest%2Fui%2Fwf%2Fhir-wf-check-erase-regions.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/f93cbedadec03e5d4d6733e0756d87b6eb706a4c/src%2Ftest%2Fui%2Fwf%2Fhir-wf-check-erase-regions.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fwf%2Fhir-wf-check-erase-regions.stderr?ref=f93cbedadec03e5d4d6733e0756d87b6eb706a4c", "patch": "@@ -0,0 +1,31 @@\n+error[E0277]: `&T` is not an iterator\n+  --> $DIR/hir-wf-check-erase-regions.rs:7:5\n+   |\n+LL |     type IntoIter = std::iter::Flatten<std::slice::Iter<'a, T>>;\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ `&T` is not an iterator\n+   |\n+  ::: $SRC_DIR/core/src/iter/adapters/flatten.rs:LL:COL\n+   |\n+LL | pub struct Flatten<I: Iterator<Item: IntoIterator>> {\n+   |                                      ------------ required by this bound in `Flatten`\n+   |\n+   = help: the trait `Iterator` is not implemented for `&T`\n+   = note: required because of the requirements on the impl of `IntoIterator` for `&T`\n+\n+error[E0277]: `&T` is not an iterator\n+  --> $DIR/hir-wf-check-erase-regions.rs:10:27\n+   |\n+LL |     fn into_iter(self) -> Self::IntoIter {\n+   |                           ^^^^^^^^^^^^^^ `&T` is not an iterator\n+   |\n+  ::: $SRC_DIR/core/src/iter/adapters/flatten.rs:LL:COL\n+   |\n+LL | pub struct Flatten<I: Iterator<Item: IntoIterator>> {\n+   |                                      ------------ required by this bound in `Flatten`\n+   |\n+   = help: the trait `Iterator` is not implemented for `&T`\n+   = note: required because of the requirements on the impl of `IntoIterator` for `&T`\n+\n+error: aborting due to 2 previous errors\n+\n+For more information about this error, try `rustc --explain E0277`."}]}