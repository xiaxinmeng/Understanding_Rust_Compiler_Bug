{"sha": "decbbb3fc03875e7b188d8ed30ded23a87d81696", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRlY2JiYjNmYzAzODc1ZTdiMTg4ZDhlZDMwZGVkMjNhODdkODE2OTY=", "commit": {"author": {"name": "Niko Matsakis", "email": "niko@alum.mit.edu", "date": "2017-12-02T02:11:25Z"}, "committer": {"name": "Niko Matsakis", "email": "niko@alum.mit.edu", "date": "2017-12-13T11:03:28Z"}, "message": "when reifying a safe fn as an unsafe fn ptr, insert two casts\n\nOtherwise, `run-pass/typeck-fn-to-unsafe-fn-ptr.rs` fails the MIR type checker.", "tree": {"sha": "baac2a2e9ae195dac84d819b183de832412d741b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/baac2a2e9ae195dac84d819b183de832412d741b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/decbbb3fc03875e7b188d8ed30ded23a87d81696", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/decbbb3fc03875e7b188d8ed30ded23a87d81696", "html_url": "https://github.com/rust-lang/rust/commit/decbbb3fc03875e7b188d8ed30ded23a87d81696", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/decbbb3fc03875e7b188d8ed30ded23a87d81696/comments", "author": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d5cff0740fa761aea4aa22d0e3b1637730dda460", "url": "https://api.github.com/repos/rust-lang/rust/commits/d5cff0740fa761aea4aa22d0e3b1637730dda460", "html_url": "https://github.com/rust-lang/rust/commit/d5cff0740fa761aea4aa22d0e3b1637730dda460"}], "stats": {"total": 15, "additions": 12, "deletions": 3}, "files": [{"sha": "edda557c98c3784f99bbe1ec57c62c6d6b3fe9e8", "filename": "src/librustc_typeck/check/coercion.rs", "status": "modified", "additions": 12, "deletions": 3, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/decbbb3fc03875e7b188d8ed30ded23a87d81696/src%2Flibrustc_typeck%2Fcheck%2Fcoercion.rs", "raw_url": "https://github.com/rust-lang/rust/raw/decbbb3fc03875e7b188d8ed30ded23a87d81696/src%2Flibrustc_typeck%2Fcheck%2Fcoercion.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fcoercion.rs?ref=decbbb3fc03875e7b188d8ed30ded23a87d81696", "patch": "@@ -638,9 +638,18 @@ impl<'f, 'gcx, 'tcx> Coerce<'f, 'gcx, 'tcx> {\n                     self.normalize_associated_types_in_as_infer_ok(self.cause.span, &a_sig);\n \n                 let a_fn_pointer = self.tcx.mk_fn_ptr(a_sig);\n-                let InferOk { value, obligations: o2 } =\n-                    self.coerce_from_safe_fn(a_fn_pointer, a_sig, b,\n-                        simple(Adjust::ReifyFnPointer), simple(Adjust::ReifyFnPointer))?;\n+                let InferOk { value, obligations: o2 } = self.coerce_from_safe_fn(\n+                    a_fn_pointer,\n+                    a_sig,\n+                    b,\n+                    |unsafe_ty| {\n+                        vec![\n+                            Adjustment { kind: Adjust::ReifyFnPointer, target: a_fn_pointer },\n+                            Adjustment { kind: Adjust::UnsafeFnPointer, target: unsafe_ty },\n+                        ]\n+                    },\n+                    simple(Adjust::ReifyFnPointer)\n+                )?;\n \n                 obligations.extend(o2);\n                 Ok(InferOk { value, obligations })"}]}