{"sha": "7baa7afd0fc8061c5b815a7aab9b40d1cd406ce8", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdiYWE3YWZkMGZjODA2MWM1YjgxNWE3YWFiOWI0MGQxY2Q0MDZjZTg=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-05-31T07:32:50Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-05-31T07:32:50Z"}, "message": "Auto merge of #85395 - 12101111:build-crt, r=petrochenkov\n\nBuild crtbegin.o/crtend.o from source code\n\nBuild crtbengin.o/crtend.o from source code instead of copying from gcc.\n\nThe crtbegin and crtend implementation from llvm don't need `crtbeginS.o` for PIC. `crtbegin{,S,T}.o` is unified into one generic `crtbegin.o`. See the comments in https://reviews.llvm.org/D28791#1419436 and https://reviews.llvm.org/D28791#1420914\n\nfix: https://github.com/rust-lang/rust/issues/85310 , fix: https://github.com/rust-lang/rust/issues/47551 , fix: https://github.com/rust-lang/rust/issues/84033", "tree": {"sha": "22cc21763034d9b2febf8968d395a676be429fbd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/22cc21763034d9b2febf8968d395a676be429fbd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7baa7afd0fc8061c5b815a7aab9b40d1cd406ce8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7baa7afd0fc8061c5b815a7aab9b40d1cd406ce8", "html_url": "https://github.com/rust-lang/rust/commit/7baa7afd0fc8061c5b815a7aab9b40d1cd406ce8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7baa7afd0fc8061c5b815a7aab9b40d1cd406ce8/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "dc08641128737ee0832bb61f24fe9212ca000f32", "url": "https://api.github.com/repos/rust-lang/rust/commits/dc08641128737ee0832bb61f24fe9212ca000f32", "html_url": "https://github.com/rust-lang/rust/commit/dc08641128737ee0832bb61f24fe9212ca000f32"}, {"sha": "61c1155d170292179568dce747afd9b8f91cc265", "url": "https://api.github.com/repos/rust-lang/rust/commits/61c1155d170292179568dce747afd9b8f91cc265", "html_url": "https://github.com/rust-lang/rust/commit/61c1155d170292179568dce747afd9b8f91cc265"}], "stats": {"total": 110, "additions": 107, "deletions": 3}, "files": [{"sha": "f3049a747579a91fd4f65bf5bc435518d1c2cabb", "filename": "src/bootstrap/builder.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/7baa7afd0fc8061c5b815a7aab9b40d1cd406ce8/src%2Fbootstrap%2Fbuilder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7baa7afd0fc8061c5b815a7aab9b40d1cd406ce8/src%2Fbootstrap%2Fbuilder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuilder.rs?ref=7baa7afd0fc8061c5b815a7aab9b40d1cd406ce8", "patch": "@@ -369,7 +369,8 @@ impl<'a> Builder<'a> {\n                 tool::Rustfmt,\n                 tool::Miri,\n                 tool::CargoMiri,\n-                native::Lld\n+                native::Lld,\n+                native::CrtBeginEnd\n             ),\n             Kind::Check | Kind::Clippy { .. } | Kind::Fix | Kind::Format => describe!(\n                 check::Std,"}, {"sha": "e5258d08956f6bbbce497dd0baf68df713bd88f1", "filename": "src/bootstrap/compile.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/7baa7afd0fc8061c5b815a7aab9b40d1cd406ce8/src%2Fbootstrap%2Fcompile.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7baa7afd0fc8061c5b815a7aab9b40d1cd406ce8/src%2Fbootstrap%2Fcompile.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcompile.rs?ref=7baa7afd0fc8061c5b815a7aab9b40d1cd406ce8", "patch": "@@ -199,8 +199,9 @@ fn copy_self_contained_objects(\n                 DependencyType::TargetSelfContained,\n             );\n         }\n+        let crt_path = builder.ensure(native::CrtBeginEnd { target });\n         for &obj in &[\"crtbegin.o\", \"crtbeginS.o\", \"crtend.o\", \"crtendS.o\"] {\n-            let src = compiler_file(builder, builder.cc(target), target, obj);\n+            let src = crt_path.join(obj);\n             let target = libdir_self_contained.join(obj);\n             builder.copy(&src, &target);\n             target_deps.push((target, DependencyType::TargetSelfContained));"}, {"sha": "4f33a13c2536aa503de035ce6611c209ec617a74", "filename": "src/bootstrap/native.rs", "status": "modified", "additions": 66, "deletions": 0, "changes": 66, "blob_url": "https://github.com/rust-lang/rust/blob/7baa7afd0fc8061c5b815a7aab9b40d1cd406ce8/src%2Fbootstrap%2Fnative.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7baa7afd0fc8061c5b815a7aab9b40d1cd406ce8/src%2Fbootstrap%2Fnative.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fnative.rs?ref=7baa7afd0fc8061c5b815a7aab9b40d1cd406ce8", "patch": "@@ -858,3 +858,69 @@ impl HashStamp {\n         fs::write(&self.path, self.hash.as_deref().unwrap_or(b\"\"))\n     }\n }\n+\n+#[derive(Debug, Copy, Clone, PartialEq, Eq, Hash)]\n+pub struct CrtBeginEnd {\n+    pub target: TargetSelection,\n+}\n+\n+impl Step for CrtBeginEnd {\n+    type Output = PathBuf;\n+\n+    fn should_run(run: ShouldRun<'_>) -> ShouldRun<'_> {\n+        run.path(\"src/llvm-project/compiler-rt/lib/crt\")\n+    }\n+\n+    fn make_run(run: RunConfig<'_>) {\n+        run.builder.ensure(CrtBeginEnd { target: run.target });\n+    }\n+\n+    /// Build crtbegin.o/crtend.o for musl target.\n+    fn run(self, builder: &Builder<'_>) -> Self::Output {\n+        let out_dir = builder.native_dir(self.target).join(\"crt\");\n+\n+        if builder.config.dry_run {\n+            return out_dir;\n+        }\n+\n+        let crtbegin_src = builder.src.join(\"src/llvm-project/compiler-rt/lib/crt/crtbegin.c\");\n+        let crtend_src = builder.src.join(\"src/llvm-project/compiler-rt/lib/crt/crtend.c\");\n+        if up_to_date(&crtbegin_src, &out_dir.join(\"crtbegin.o\"))\n+            && up_to_date(&crtend_src, &out_dir.join(\"crtendS.o\"))\n+        {\n+            return out_dir;\n+        }\n+\n+        builder.info(\"Building crtbegin.o and crtend.o\");\n+        t!(fs::create_dir_all(&out_dir));\n+\n+        let mut cfg = cc::Build::new();\n+\n+        if let Some(ar) = builder.ar(self.target) {\n+            cfg.archiver(ar);\n+        }\n+        cfg.compiler(builder.cc(self.target));\n+        cfg.cargo_metadata(false)\n+            .out_dir(&out_dir)\n+            .target(&self.target.triple)\n+            .host(&builder.config.build.triple)\n+            .warnings(false)\n+            .debug(false)\n+            .opt_level(3)\n+            .file(crtbegin_src)\n+            .file(crtend_src);\n+\n+        // Those flags are defined in src/llvm-project/compiler-rt/lib/crt/CMakeLists.txt\n+        // Currently only consumer of those objects is musl, which use .init_array/.fini_array\n+        // instead of .ctors/.dtors\n+        cfg.flag(\"-std=c11\")\n+            .define(\"CRT_HAS_INITFINI_ARRAY\", None)\n+            .define(\"EH_USE_FRAME_REGISTRY\", None);\n+\n+        cfg.compile(\"crt\");\n+\n+        t!(fs::copy(out_dir.join(\"crtbegin.o\"), out_dir.join(\"crtbeginS.o\")));\n+        t!(fs::copy(out_dir.join(\"crtend.o\"), out_dir.join(\"crtendS.o\")));\n+        out_dir\n+    }\n+}"}, {"sha": "cd0f01faa1bfa1870a5545bdff58245f8468b638", "filename": "src/ci/docker/host-x86_64/dist-various-1/Dockerfile", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/7baa7afd0fc8061c5b815a7aab9b40d1cd406ce8/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-various-1%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/7baa7afd0fc8061c5b815a7aab9b40d1cd406ce8/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-various-1%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-various-1%2FDockerfile?ref=7baa7afd0fc8061c5b815a7aab9b40d1cd406ce8", "patch": "@@ -144,7 +144,11 @@ ENV TARGETS=$TARGETS,armv7a-none-eabi\n # riscv targets currently do not need a C compiler, as compiler_builtins\n # doesn't currently have it enabled, and the riscv gcc compiler is not\n # installed.\n-ENV CC_mipsel_unknown_linux_musl=mipsel-openwrt-linux-gcc \\\n+ENV CFLAGS_armv5te_unknown_linux_musleabi=\"-march=armv5te -marm -mfloat-abi=soft\" \\\n+    CFLAGS_arm_unknown_linux_musleabi=\"-march=armv6 -marm\" \\\n+    CFLAGS_arm_unknown_linux_musleabihf=\"-march=armv6 -marm -mfpu=vfp\" \\\n+    CFLAGS_armv7_unknown_linux_musleabihf=\"-march=armv7-a\" \\\n+    CC_mipsel_unknown_linux_musl=mipsel-openwrt-linux-gcc \\\n     CC_mips_unknown_linux_musl=mips-openwrt-linux-gcc \\\n     CC_mips64el_unknown_linux_muslabi64=mips64el-linux-gnuabi64-gcc \\\n     CC_mips64_unknown_linux_muslabi64=mips64-linux-gnuabi64-gcc \\"}, {"sha": "f4495e6b671d7302e6e2dc2a1f73d7a954242927", "filename": "src/test/run-make-fulldeps/issue-47551/Makefile", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/7baa7afd0fc8061c5b815a7aab9b40d1cd406ce8/src%2Ftest%2Frun-make-fulldeps%2Fissue-47551%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/7baa7afd0fc8061c5b815a7aab9b40d1cd406ce8/src%2Ftest%2Frun-make-fulldeps%2Fissue-47551%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fissue-47551%2FMakefile?ref=7baa7afd0fc8061c5b815a7aab9b40d1cd406ce8", "patch": "@@ -0,0 +1,9 @@\n+# only-linux\n+# ignore-32bit\n+\n+-include ../tools.mk\n+\n+all:\n+\t$(RUSTC) eh_frame-terminator.rs\n+\t$(call RUN,eh_frame-terminator) | $(CGREP) '1122334455667788'\n+\tobjdump --dwarf=frames $(TMPDIR)/eh_frame-terminator | $(CGREP) 'ZERO terminator'"}, {"sha": "2f740dc4fac38ae74ad6010782f00bac4fea77c7", "filename": "src/test/run-make-fulldeps/issue-47551/eh_frame-terminator.rs", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/7baa7afd0fc8061c5b815a7aab9b40d1cd406ce8/src%2Ftest%2Frun-make-fulldeps%2Fissue-47551%2Feh_frame-terminator.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7baa7afd0fc8061c5b815a7aab9b40d1cd406ce8/src%2Ftest%2Frun-make-fulldeps%2Fissue-47551%2Feh_frame-terminator.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fissue-47551%2Feh_frame-terminator.rs?ref=7baa7afd0fc8061c5b815a7aab9b40d1cd406ce8", "patch": "@@ -0,0 +1,23 @@\n+// run-pass\n+\n+#![feature(backtrace)]\n+#[derive(Clone, Copy)]\n+struct Foo {\n+    array: [u64; 10240],\n+}\n+\n+impl Foo {\n+    const fn new() -> Self {\n+        Self {\n+            array: [0x1122_3344_5566_7788; 10240]\n+        }\n+    }\n+}\n+\n+static BAR: [Foo; 10240] = [Foo::new(); 10240];\n+\n+fn main() {\n+    let bt = std::backtrace::Backtrace::force_capture();\n+    println!(\"Hello, world! {:?}\", bt);\n+    println!(\"{:x}\", BAR[0].array[0]);\n+}"}]}