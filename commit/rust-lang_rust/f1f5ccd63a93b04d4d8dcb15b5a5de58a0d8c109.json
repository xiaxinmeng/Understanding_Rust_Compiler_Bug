{"sha": "f1f5ccd63a93b04d4d8dcb15b5a5de58a0d8c109", "node_id": "MDY6Q29tbWl0NzI0NzEyOmYxZjVjY2Q2M2E5M2IwNGQ0ZDhkY2IxNWI1YTVkZTU4YTBkOGMxMDk=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-06-11T15:58:58Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-06-11T15:58:58Z"}, "message": "Auto merge of #7160 - flip1995:field_reassign_macros, r=xFrednet,camsteffen\n\nDon't trigger `field_reassign_with_default` in macros\n\nFixes #7155\n\nProducing a good suggestion for this lint is already hard when no macros\nare involved. With macros the lint message and the suggestion are just\nconfusing. Since both, producing a good suggestion and figuring out if\nthis pattern can be re-written inside a macro is nearly impossible, just\nbail out.\n\nchangelog: [`field_reassign_with_default`] No longer triggers in macros\n\n---\n\nNo that our reviewing queue is under control, I want to start hacking on Clippy myself again. Starting with an easy issue to get back in :)", "tree": {"sha": "532253ef293deeba0723c49103d924bff178e6a8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/532253ef293deeba0723c49103d924bff178e6a8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f1f5ccd63a93b04d4d8dcb15b5a5de58a0d8c109", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f1f5ccd63a93b04d4d8dcb15b5a5de58a0d8c109", "html_url": "https://github.com/rust-lang/rust/commit/f1f5ccd63a93b04d4d8dcb15b5a5de58a0d8c109", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f1f5ccd63a93b04d4d8dcb15b5a5de58a0d8c109/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f7d09b45e9dbb32c5524d5f3b0838401c848bbf2", "url": "https://api.github.com/repos/rust-lang/rust/commits/f7d09b45e9dbb32c5524d5f3b0838401c848bbf2", "html_url": "https://github.com/rust-lang/rust/commit/f7d09b45e9dbb32c5524d5f3b0838401c848bbf2"}, {"sha": "0854f0caee1d6d16e57eb1d3f5abf539b3bee3f0", "url": "https://api.github.com/repos/rust-lang/rust/commits/0854f0caee1d6d16e57eb1d3f5abf539b3bee3f0", "html_url": "https://github.com/rust-lang/rust/commit/0854f0caee1d6d16e57eb1d3f5abf539b3bee3f0"}], "stats": {"total": 59, "additions": 39, "deletions": 20}, "files": [{"sha": "947479db8f5d78e77fdc1b6fa60a08357fb609fa", "filename": "clippy_lints/src/default.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/f1f5ccd63a93b04d4d8dcb15b5a5de58a0d8c109/clippy_lints%2Fsrc%2Fdefault.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f1f5ccd63a93b04d4d8dcb15b5a5de58a0d8c109/clippy_lints%2Fsrc%2Fdefault.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fdefault.rs?ref=f1f5ccd63a93b04d4d8dcb15b5a5de58a0d8c109", "patch": "@@ -7,7 +7,6 @@ use rustc_errors::Applicability;\n use rustc_hir::def::Res;\n use rustc_hir::{Block, Expr, ExprKind, PatKind, QPath, Stmt, StmtKind};\n use rustc_lint::{LateContext, LateLintPass};\n-use rustc_middle::lint::in_external_macro;\n use rustc_middle::ty;\n use rustc_session::{declare_tool_lint, impl_lint_pass};\n use rustc_span::symbol::{Ident, Symbol};\n@@ -122,7 +121,7 @@ impl LateLintPass<'_> for Default {\n                 if let StmtKind::Local(local) = stmt.kind;\n                 if let Some(expr) = local.init;\n                 if !any_parent_is_automatically_derived(cx.tcx, expr.hir_id);\n-                if !in_external_macro(cx.tcx.sess, expr.span);\n+                if !in_macro(expr.span);\n                 // only take bindings to identifiers\n                 if let PatKind::Binding(_, binding_id, ident, _) = local.pat.kind;\n                 // only when assigning `... = Default::default()`"}, {"sha": "787053fb00064c861a75c37410ae26767ab2322e", "filename": "tests/ui/field_reassign_with_default.rs", "status": "modified", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/f1f5ccd63a93b04d4d8dcb15b5a5de58a0d8c109/tests%2Fui%2Ffield_reassign_with_default.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f1f5ccd63a93b04d4d8dcb15b5a5de58a0d8c109/tests%2Fui%2Ffield_reassign_with_default.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ffield_reassign_with_default.rs?ref=f1f5ccd63a93b04d4d8dcb15b5a5de58a0d8c109", "patch": "@@ -29,6 +29,21 @@ struct C {\n     i: Vec<i32>,\n     j: i64,\n }\n+\n+#[derive(Default)]\n+struct D {\n+    a: Option<i32>,\n+    b: Option<i32>,\n+}\n+\n+macro_rules! m {\n+    ($key:ident: $value:tt) => {{\n+        let mut data = $crate::D::default();\n+        data.$key = Some($value);\n+        data\n+    }};\n+}\n+\n /// Implements .next() that returns a different number each time.\n struct SideEffect(i32);\n \n@@ -143,6 +158,11 @@ fn main() {\n \n     let mut a: WrapperMulti<i32, i64> = Default::default();\n     a.i = 42;\n+\n+    // Don't lint in macros\n+    m! {\n+        a: 42\n+    };\n }\n \n mod m {"}, {"sha": "b56db08ec8a787f63c3edc31fde93178a0237982", "filename": "tests/ui/field_reassign_with_default.stderr", "status": "modified", "additions": 18, "deletions": 18, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/f1f5ccd63a93b04d4d8dcb15b5a5de58a0d8c109/tests%2Fui%2Ffield_reassign_with_default.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/f1f5ccd63a93b04d4d8dcb15b5a5de58a0d8c109/tests%2Fui%2Ffield_reassign_with_default.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ffield_reassign_with_default.stderr?ref=f1f5ccd63a93b04d4d8dcb15b5a5de58a0d8c109", "patch": "@@ -1,108 +1,108 @@\n error: field assignment outside of initializer for an instance created with Default::default()\n-  --> $DIR/field_reassign_with_default.rs:48:5\n+  --> $DIR/field_reassign_with_default.rs:63:5\n    |\n LL |     a.i = 42;\n    |     ^^^^^^^^^\n    |\n    = note: `-D clippy::field-reassign-with-default` implied by `-D warnings`\n note: consider initializing the variable with `main::A { i: 42, ..Default::default() }` and removing relevant reassignments\n-  --> $DIR/field_reassign_with_default.rs:47:5\n+  --> $DIR/field_reassign_with_default.rs:62:5\n    |\n LL |     let mut a: A = Default::default();\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n error: field assignment outside of initializer for an instance created with Default::default()\n-  --> $DIR/field_reassign_with_default.rs:88:5\n+  --> $DIR/field_reassign_with_default.rs:103:5\n    |\n LL |     a.j = 43;\n    |     ^^^^^^^^^\n    |\n note: consider initializing the variable with `main::A { j: 43, i: 42 }` and removing relevant reassignments\n-  --> $DIR/field_reassign_with_default.rs:87:5\n+  --> $DIR/field_reassign_with_default.rs:102:5\n    |\n LL |     let mut a: A = Default::default();\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n error: field assignment outside of initializer for an instance created with Default::default()\n-  --> $DIR/field_reassign_with_default.rs:93:5\n+  --> $DIR/field_reassign_with_default.rs:108:5\n    |\n LL |     a.i = 42;\n    |     ^^^^^^^^^\n    |\n note: consider initializing the variable with `main::A { i: 42, j: 44 }` and removing relevant reassignments\n-  --> $DIR/field_reassign_with_default.rs:92:5\n+  --> $DIR/field_reassign_with_default.rs:107:5\n    |\n LL |     let mut a: A = Default::default();\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n error: field assignment outside of initializer for an instance created with Default::default()\n-  --> $DIR/field_reassign_with_default.rs:99:5\n+  --> $DIR/field_reassign_with_default.rs:114:5\n    |\n LL |     a.i = 42;\n    |     ^^^^^^^^^\n    |\n note: consider initializing the variable with `main::A { i: 42, ..Default::default() }` and removing relevant reassignments\n-  --> $DIR/field_reassign_with_default.rs:98:5\n+  --> $DIR/field_reassign_with_default.rs:113:5\n    |\n LL |     let mut a = A::default();\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^\n \n error: field assignment outside of initializer for an instance created with Default::default()\n-  --> $DIR/field_reassign_with_default.rs:109:5\n+  --> $DIR/field_reassign_with_default.rs:124:5\n    |\n LL |     a.i = Default::default();\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |\n note: consider initializing the variable with `main::A { i: Default::default(), ..Default::default() }` and removing relevant reassignments\n-  --> $DIR/field_reassign_with_default.rs:108:5\n+  --> $DIR/field_reassign_with_default.rs:123:5\n    |\n LL |     let mut a: A = Default::default();\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n error: field assignment outside of initializer for an instance created with Default::default()\n-  --> $DIR/field_reassign_with_default.rs:113:5\n+  --> $DIR/field_reassign_with_default.rs:128:5\n    |\n LL |     a.i = Default::default();\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^\n    |\n note: consider initializing the variable with `main::A { i: Default::default(), j: 45 }` and removing relevant reassignments\n-  --> $DIR/field_reassign_with_default.rs:112:5\n+  --> $DIR/field_reassign_with_default.rs:127:5\n    |\n LL |     let mut a: A = Default::default();\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n error: field assignment outside of initializer for an instance created with Default::default()\n-  --> $DIR/field_reassign_with_default.rs:135:5\n+  --> $DIR/field_reassign_with_default.rs:150:5\n    |\n LL |     a.i = vec![1];\n    |     ^^^^^^^^^^^^^^\n    |\n note: consider initializing the variable with `C { i: vec![1], ..Default::default() }` and removing relevant reassignments\n-  --> $DIR/field_reassign_with_default.rs:134:5\n+  --> $DIR/field_reassign_with_default.rs:149:5\n    |\n LL |     let mut a: C = C::default();\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n error: field assignment outside of initializer for an instance created with Default::default()\n-  --> $DIR/field_reassign_with_default.rs:142:5\n+  --> $DIR/field_reassign_with_default.rs:157:5\n    |\n LL |     a.i = true;\n    |     ^^^^^^^^^^^\n    |\n note: consider initializing the variable with `Wrapper::<bool> { i: true }` and removing relevant reassignments\n-  --> $DIR/field_reassign_with_default.rs:141:5\n+  --> $DIR/field_reassign_with_default.rs:156:5\n    |\n LL |     let mut a: Wrapper<bool> = Default::default();\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n error: field assignment outside of initializer for an instance created with Default::default()\n-  --> $DIR/field_reassign_with_default.rs:145:5\n+  --> $DIR/field_reassign_with_default.rs:160:5\n    |\n LL |     a.i = 42;\n    |     ^^^^^^^^^\n    |\n note: consider initializing the variable with `WrapperMulti::<i32, i64> { i: 42, ..Default::default() }` and removing relevant reassignments\n-  --> $DIR/field_reassign_with_default.rs:144:5\n+  --> $DIR/field_reassign_with_default.rs:159:5\n    |\n LL |     let mut a: WrapperMulti<i32, i64> = Default::default();\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^"}]}