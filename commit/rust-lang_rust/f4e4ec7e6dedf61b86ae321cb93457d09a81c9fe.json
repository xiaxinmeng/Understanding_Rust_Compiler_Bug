{"sha": "f4e4ec7e6dedf61b86ae321cb93457d09a81c9fe", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY0ZTRlYzdlNmRlZGY2MWI4NmFlMzIxY2I5MzQ1N2QwOWE4MWM5ZmU=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2016-05-13T22:26:41Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2016-05-18T23:36:08Z"}, "message": "rustbuild: Pass -O to tests based on configuration\n\nCurrently rustbuild isn't detecting the `-O` flag for tests via the\n`--disable-optimize-tests` or not command line flag to `./configure`, and this\ncommit patches up the support to pass `-O` by default.", "tree": {"sha": "e5cae64233df7284524a160ecb60f6ca33c1b54a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e5cae64233df7284524a160ecb60f6ca33c1b54a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f4e4ec7e6dedf61b86ae321cb93457d09a81c9fe", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f4e4ec7e6dedf61b86ae321cb93457d09a81c9fe", "html_url": "https://github.com/rust-lang/rust/commit/f4e4ec7e6dedf61b86ae321cb93457d09a81c9fe", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f4e4ec7e6dedf61b86ae321cb93457d09a81c9fe/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "bdadad85b5cb77315893a887a3c8bf31687459f8", "url": "https://api.github.com/repos/rust-lang/rust/commits/bdadad85b5cb77315893a887a3c8bf31687459f8", "html_url": "https://github.com/rust-lang/rust/commit/bdadad85b5cb77315893a887a3c8bf31687459f8"}], "stats": {"total": 27, "additions": 25, "deletions": 2}, "files": [{"sha": "154d9556fd7ba2331e248ab1e9c20c7ca72757f7", "filename": "src/bootstrap/build/check.rs", "status": "modified", "additions": 11, "deletions": 2, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/f4e4ec7e6dedf61b86ae321cb93457d09a81c9fe/src%2Fbootstrap%2Fbuild%2Fcheck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f4e4ec7e6dedf61b86ae321cb93457d09a81c9fe/src%2Fbootstrap%2Fbuild%2Fcheck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuild%2Fcheck.rs?ref=f4e4ec7e6dedf61b86ae321cb93457d09a81c9fe", "patch": "@@ -105,9 +105,18 @@ pub fn compiletest(build: &Build,\n     cmd.arg(\"--host\").arg(compiler.host);\n     cmd.arg(\"--llvm-filecheck\").arg(build.llvm_filecheck(&build.config.build));\n \n+    let mut flags = format!(\"-Crpath\");\n+    if build.config.rust_optimize_tests {\n+        flags.push_str(\" -O\");\n+    }\n+    if build.config.rust_debuginfo_tests {\n+        flags.push_str(\" -g\");\n+    }\n+\n+    cmd.arg(\"--host-rustcflags\").arg(&flags);\n+\n     let linkflag = format!(\"-Lnative={}\", build.test_helpers_out(target).display());\n-    cmd.arg(\"--host-rustcflags\").arg(\"-Crpath\");\n-    cmd.arg(\"--target-rustcflags\").arg(format!(\"-Crpath {}\", linkflag));\n+    cmd.arg(\"--target-rustcflags\").arg(format!(\"{} {}\", flags, linkflag));\n \n     // FIXME: needs android support\n     cmd.arg(\"--android-cross-path\").arg(\"\");"}, {"sha": "3c35b9a95169a908478b0fcf9ce0d7a156f4e775", "filename": "src/bootstrap/build/config.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/f4e4ec7e6dedf61b86ae321cb93457d09a81c9fe/src%2Fbootstrap%2Fbuild%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f4e4ec7e6dedf61b86ae321cb93457d09a81c9fe/src%2Fbootstrap%2Fbuild%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuild%2Fconfig.rs?ref=f4e4ec7e6dedf61b86ae321cb93457d09a81c9fe", "patch": "@@ -59,6 +59,8 @@ pub struct Config {\n     pub rust_rpath: bool,\n     pub rustc_default_linker: Option<String>,\n     pub rustc_default_ar: Option<String>,\n+    pub rust_optimize_tests: bool,\n+    pub rust_debuginfo_tests: bool,\n \n     pub build: String,\n     pub host: Vec<String>,\n@@ -136,6 +138,8 @@ struct Rust {\n     channel: Option<String>,\n     musl_root: Option<String>,\n     rpath: Option<bool>,\n+    optimize_tests: Option<bool>,\n+    debuginfo_tests: Option<bool>,\n }\n \n /// TOML representation of how each build target is configured.\n@@ -154,6 +158,7 @@ impl Config {\n         config.llvm_optimize = true;\n         config.use_jemalloc = true;\n         config.rust_optimize = true;\n+        config.rust_optimize_tests = true;\n         config.submodules = true;\n         config.docs = true;\n         config.rust_rpath = true;\n@@ -219,6 +224,8 @@ impl Config {\n             set(&mut config.rust_debug_assertions, rust.debug_assertions);\n             set(&mut config.rust_debuginfo, rust.debuginfo);\n             set(&mut config.rust_optimize, rust.optimize);\n+            set(&mut config.rust_optimize_tests, rust.optimize_tests);\n+            set(&mut config.rust_debuginfo_tests, rust.debuginfo_tests);\n             set(&mut config.rust_rpath, rust.rpath);\n             set(&mut config.debug_jemalloc, rust.debug_jemalloc);\n             set(&mut config.use_jemalloc, rust.use_jemalloc);\n@@ -306,6 +313,8 @@ impl Config {\n                 (\"JEMALLOC\", self.use_jemalloc),\n                 (\"DEBUG_JEMALLOC\", self.debug_jemalloc),\n                 (\"RPATH\", self.rust_rpath),\n+                (\"OPTIMIZE_TESTS\", self.rust_optimize_tests),\n+                (\"DEBUGINFO_TESTS\", self.rust_debuginfo_tests),\n             }\n \n             match key {"}, {"sha": "6f0658423283be3c61f9377c0f04dcc8f0b24f49", "filename": "src/bootstrap/config.toml.example", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/f4e4ec7e6dedf61b86ae321cb93457d09a81c9fe/src%2Fbootstrap%2Fconfig.toml.example", "raw_url": "https://github.com/rust-lang/rust/raw/f4e4ec7e6dedf61b86ae321cb93457d09a81c9fe/src%2Fbootstrap%2Fconfig.toml.example", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fconfig.toml.example?ref=f4e4ec7e6dedf61b86ae321cb93457d09a81c9fe", "patch": "@@ -122,6 +122,11 @@\n # desired in distributions, for example.\n #rpath = true\n \n+# Flag indicating whether tests are compiled with optimizations (the -O flag) or\n+# with debuginfo (the -g flag)\n+#optimize-tests = true\n+#debuginfo-tests = true\n+\n # =============================================================================\n # Options for specific targets\n #"}]}