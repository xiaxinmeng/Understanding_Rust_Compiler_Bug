{"sha": "b32246279d6059564358c4759af08ded7834468b", "node_id": "MDY6Q29tbWl0NzI0NzEyOmIzMjI0NjI3OWQ2MDU5NTY0MzU4YzQ3NTlhZjA4ZGVkNzgzNDQ2OGI=", "commit": {"author": {"name": "comex", "email": "comexk@gmail.com", "date": "2017-01-03T19:40:29Z"}, "committer": {"name": "comex", "email": "comexk@gmail.com", "date": "2017-01-03T21:30:41Z"}, "message": "Fix lint attributes on non-item nodes.\n\nCurrently, late lint checking uses two HIR visitors: LateContext and\nIdVisitor.  IdVisitor only overrides visit_id, and for each node searches\nfor builtin lints previously added to the session; LateContext overrides\na number of methods, and runs late lints.  When LateContext encounters an\nitem, it first has IdVisitor walk everything in it except nested items\n(OnlyBodies), then recurses into it itself - i.e. there are two separate\nwalks.\n\nAside from apparently being unnecessary, this separation prevents lint\nattributes (allow/deny/warn) on non-item HIR nodes from working\nproperly.  Test case:\n\n// generates warning without this change\nfn main() { #[allow(unreachable_code)] loop { break; break; } }\n\nLateContext contains logic to merge attributes seen into the current lint\nsettings while walking (with_lint_attrs), but IdVisitor does not.  So\nsuch attributes will affect late lints (because they are called from\nLateContext), and if the node contains any items within it, they will\naffect builtin lints within those items (because that IdVisitor is run\nwhile LateContext is within the attributed node), but otherwise the\nattributes will be ignored for builtin lints.\n\nThis change simply removes IdVisitor and moves its visit_id into\nLateContext itself.  Hopefully this doesn't break anything...\n\nAlso added walk calls to visit_lifetime and visit_lifetime_def\nrespectively, so visit_lifetime_def will recurse into the lifetime and\nvisit_lifetime will recurse into the name.  In principle this could\nconfuse lint plugins.  This is \"necessary\" because walk_lifetime calls\nvisit_id on the lifetime; of course, an alternative would be directly\ncalling visit_id (which would require manually iterating over the\nlifetimes in visit_lifetime_def), but that seems less clean.", "tree": {"sha": "d4b09f9ad8413fa6a77be44467118e056112e870", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d4b09f9ad8413fa6a77be44467118e056112e870"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b32246279d6059564358c4759af08ded7834468b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b32246279d6059564358c4759af08ded7834468b", "html_url": "https://github.com/rust-lang/rust/commit/b32246279d6059564358c4759af08ded7834468b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b32246279d6059564358c4759af08ded7834468b/comments", "author": {"login": "comex", "id": 47517, "node_id": "MDQ6VXNlcjQ3NTE3", "avatar_url": "https://avatars.githubusercontent.com/u/47517?v=4", "gravatar_id": "", "url": "https://api.github.com/users/comex", "html_url": "https://github.com/comex", "followers_url": "https://api.github.com/users/comex/followers", "following_url": "https://api.github.com/users/comex/following{/other_user}", "gists_url": "https://api.github.com/users/comex/gists{/gist_id}", "starred_url": "https://api.github.com/users/comex/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/comex/subscriptions", "organizations_url": "https://api.github.com/users/comex/orgs", "repos_url": "https://api.github.com/users/comex/repos", "events_url": "https://api.github.com/users/comex/events{/privacy}", "received_events_url": "https://api.github.com/users/comex/received_events", "type": "User", "site_admin": false}, "committer": {"login": "comex", "id": 47517, "node_id": "MDQ6VXNlcjQ3NTE3", "avatar_url": "https://avatars.githubusercontent.com/u/47517?v=4", "gravatar_id": "", "url": "https://api.github.com/users/comex", "html_url": "https://github.com/comex", "followers_url": "https://api.github.com/users/comex/followers", "following_url": "https://api.github.com/users/comex/following{/other_user}", "gists_url": "https://api.github.com/users/comex/gists{/gist_id}", "starred_url": "https://api.github.com/users/comex/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/comex/subscriptions", "organizations_url": "https://api.github.com/users/comex/orgs", "repos_url": "https://api.github.com/users/comex/repos", "events_url": "https://api.github.com/users/comex/events{/privacy}", "received_events_url": "https://api.github.com/users/comex/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8f62c2920077eb5cb81323142fc5dbe6ae8813c0", "url": "https://api.github.com/repos/rust-lang/rust/commits/8f62c2920077eb5cb81323142fc5dbe6ae8813c0", "html_url": "https://github.com/rust-lang/rust/commit/8f62c2920077eb5cb81323142fc5dbe6ae8813c0"}], "stats": {"total": 59, "additions": 13, "deletions": 46}, "files": [{"sha": "7f908f13dff435ca1dc3ab592bc47b12db9f4ce6", "filename": "src/librustc/lint/context.rs", "status": "modified", "additions": 12, "deletions": 45, "changes": 57, "blob_url": "https://github.com/rust-lang/rust/blob/b32246279d6059564358c4759af08ded7834468b/src%2Flibrustc%2Flint%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b32246279d6059564358c4759af08ded7834468b/src%2Flibrustc%2Flint%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Flint%2Fcontext.rs?ref=b32246279d6059564358c4759af08ded7834468b", "patch": "@@ -718,15 +718,6 @@ impl<'a, 'tcx> LateContext<'a, 'tcx> {\n             level_stack: vec![],\n         }\n     }\n-\n-    fn visit_ids<'b, F: 'b>(&'b mut self, f: F)\n-        where F: FnOnce(&mut IdVisitor<'b, 'a, 'tcx>)\n-    {\n-        let mut v = IdVisitor::<'b, 'a, 'tcx> {\n-            cx: self\n-        };\n-        f(&mut v);\n-    }\n }\n \n impl<'a, 'tcx> LintContext<'tcx> for LateContext<'a, 'tcx> {\n@@ -795,10 +786,19 @@ impl<'a, 'tcx> hir_visit::Visitor<'tcx> for LateContext<'a, 'tcx> {\n         hir_visit::NestedVisitorMap::All(&self.tcx.map)\n     }\n \n+    // Output any lints that were previously added to the session.\n+    fn visit_id(&mut self, id: ast::NodeId) {\n+        if let Some(lints) = self.sess().lints.borrow_mut().remove(&id) {\n+            debug!(\"LateContext::visit_id: id={:?} lints={:?}\", id, lints);\n+            for early_lint in lints {\n+                self.early_lint(early_lint);\n+            }\n+        }\n+    }\n+\n     fn visit_item(&mut self, it: &'tcx hir::Item) {\n         self.with_lint_attrs(&it.attrs, |cx| {\n             run_lints!(cx, check_item, late_passes, it);\n-            cx.visit_ids(|v| v.visit_item(it));\n             hir_visit::walk_item(cx, it);\n             run_lints!(cx, check_item_post, late_passes, it);\n         })\n@@ -918,7 +918,6 @@ impl<'a, 'tcx> hir_visit::Visitor<'tcx> for LateContext<'a, 'tcx> {\n     fn visit_trait_item(&mut self, trait_item: &'tcx hir::TraitItem) {\n         self.with_lint_attrs(&trait_item.attrs, |cx| {\n             run_lints!(cx, check_trait_item, late_passes, trait_item);\n-            cx.visit_ids(|v| hir_visit::walk_trait_item(v, trait_item));\n             hir_visit::walk_trait_item(cx, trait_item);\n             run_lints!(cx, check_trait_item_post, late_passes, trait_item);\n         });\n@@ -927,18 +926,19 @@ impl<'a, 'tcx> hir_visit::Visitor<'tcx> for LateContext<'a, 'tcx> {\n     fn visit_impl_item(&mut self, impl_item: &'tcx hir::ImplItem) {\n         self.with_lint_attrs(&impl_item.attrs, |cx| {\n             run_lints!(cx, check_impl_item, late_passes, impl_item);\n-            cx.visit_ids(|v| hir_visit::walk_impl_item(v, impl_item));\n             hir_visit::walk_impl_item(cx, impl_item);\n             run_lints!(cx, check_impl_item_post, late_passes, impl_item);\n         });\n     }\n \n     fn visit_lifetime(&mut self, lt: &'tcx hir::Lifetime) {\n         run_lints!(self, check_lifetime, late_passes, lt);\n+        hir_visit::walk_lifetime(self, lt);\n     }\n \n     fn visit_lifetime_def(&mut self, lt: &'tcx hir::LifetimeDef) {\n         run_lints!(self, check_lifetime_def, late_passes, lt);\n+        hir_visit::walk_lifetime_def(self, lt);\n     }\n \n     fn visit_path(&mut self, p: &'tcx hir::Path, id: ast::NodeId) {\n@@ -1100,35 +1100,6 @@ impl<'a> ast_visit::Visitor<'a> for EarlyContext<'a> {\n     }\n }\n \n-struct IdVisitor<'a, 'b: 'a, 'tcx: 'a+'b> {\n-    cx: &'a mut LateContext<'b, 'tcx>\n-}\n-\n-// Output any lints that were previously added to the session.\n-impl<'a, 'b, 'tcx> hir_visit::Visitor<'tcx> for IdVisitor<'a, 'b, 'tcx> {\n-    fn nested_visit_map<'this>(&'this mut self) -> hir_visit::NestedVisitorMap<'this, 'tcx> {\n-        hir_visit::NestedVisitorMap::OnlyBodies(&self.cx.tcx.map)\n-    }\n-\n-    fn visit_id(&mut self, id: ast::NodeId) {\n-        if let Some(lints) = self.cx.sess().lints.borrow_mut().remove(&id) {\n-            debug!(\"LateContext::visit_id: id={:?} lints={:?}\", id, lints);\n-            for early_lint in lints {\n-                self.cx.early_lint(early_lint);\n-            }\n-        }\n-    }\n-\n-    fn visit_trait_item(&mut self, _ti: &'tcx hir::TraitItem) {\n-        // Do not recurse into trait or impl items automatically. These are\n-        // processed separately by calling hir_visit::walk_trait_item()\n-    }\n-\n-    fn visit_impl_item(&mut self, _ii: &'tcx hir::ImplItem) {\n-        // See visit_trait_item()\n-    }\n-}\n-\n enum CheckLintNameResult {\n     Ok,\n     // Lint doesn't exist\n@@ -1242,10 +1213,6 @@ pub fn check_crate<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>,\n \n     // Visit the whole crate.\n     cx.with_lint_attrs(&krate.attrs, |cx| {\n-        cx.visit_ids(|v| {\n-            hir_visit::walk_crate(v, krate);\n-        });\n-\n         // since the root module isn't visited as an item (because it isn't an\n         // item), warn for it here.\n         run_lints!(cx, check_crate, late_passes, krate);"}, {"sha": "16b79d01fd6d942cf3c9120b92df56b13ec92665", "filename": "src/llvm", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": null, "raw_url": null, "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fllvm?ref=b32246279d6059564358c4759af08ded7834468b", "patch": "@@ -1 +1 @@\n-Subproject commit ceb177eeefa7d67ca29230d2e7e8584f97d4fdad\n+Subproject commit 16b79d01fd6d942cf3c9120b92df56b13ec92665"}]}