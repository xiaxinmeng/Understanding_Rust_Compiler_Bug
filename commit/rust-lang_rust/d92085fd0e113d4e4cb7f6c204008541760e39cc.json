{"sha": "d92085fd0e113d4e4cb7f6c204008541760e39cc", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQ5MjA4NWZkMGUxMTNkNGU0Y2I3ZjZjMjA0MDA4NTQxNzYwZTM5Y2M=", "commit": {"author": {"name": "Oliver Schneider", "email": "git-no-reply-9879165716479413131@oli-obk.de", "date": "2017-02-09T18:08:08Z"}, "committer": {"name": "Oliver Schneider", "email": "git-no-reply-9879165716479413131@oli-obk.de", "date": "2017-02-09T18:08:08Z"}, "message": "properly extract the inner type in a drop impl", "tree": {"sha": "d7a1acb2b06d256363d6b8bcc7379d8effef3577", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d7a1acb2b06d256363d6b8bcc7379d8effef3577"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d92085fd0e113d4e4cb7f6c204008541760e39cc", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d92085fd0e113d4e4cb7f6c204008541760e39cc", "html_url": "https://github.com/rust-lang/rust/commit/d92085fd0e113d4e4cb7f6c204008541760e39cc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d92085fd0e113d4e4cb7f6c204008541760e39cc/comments", "author": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "committer": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "06a02187babfbe5b6a5abdee9b5625bed7a15493", "url": "https://api.github.com/repos/rust-lang/rust/commits/06a02187babfbe5b6a5abdee9b5625bed7a15493", "html_url": "https://github.com/rust-lang/rust/commit/06a02187babfbe5b6a5abdee9b5625bed7a15493"}], "stats": {"total": 35, "additions": 33, "deletions": 2}, "files": [{"sha": "3b0ca371bba07f13e18be715b29a16cf94403c8e", "filename": "src/terminator/drop.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/d92085fd0e113d4e4cb7f6c204008541760e39cc/src%2Fterminator%2Fdrop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d92085fd0e113d4e4cb7f6c204008541760e39cc/src%2Fterminator%2Fdrop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fterminator%2Fdrop.rs?ref=d92085fd0e113d4e4cb7f6c204008541760e39cc", "patch": "@@ -165,9 +165,11 @@ impl<'a, 'tcx> EvalContext<'a, 'tcx> {\n                 // some values don't need to call a drop impl, so the value is null\n                 if drop_fn != Pointer::from_int(0) {\n                     let FunctionDefinition {def_id, substs, sig, ..} = self.memory.get_fn(drop_fn.alloc_id)?.expect_drop_glue()?;\n-                    let real_ty = sig.inputs()[0];\n+                    let real_ty = match sig.inputs()[0].sty {\n+                        ty::TyRef(_, mt) => self.monomorphize(mt.ty, substs),\n+                        _ => bug!(\"first argument of Drop::drop must be &mut T\"),\n+                    };\n                     self.drop(Lvalue::from_ptr(ptr), real_ty, drop)?;\n-                    drop.push((def_id, Value::ByVal(PrimVal::Ptr(ptr)), substs));\n                 } else {\n                     // just a sanity check\n                     assert_eq!(drop_fn.offset, 0);"}, {"sha": "57eef52d573b9e4c6b3acb3d1a8d910c5af3b6eb", "filename": "tests/run-pass/box_box_trait.rs", "status": "added", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/d92085fd0e113d4e4cb7f6c204008541760e39cc/tests%2Frun-pass%2Fbox_box_trait.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d92085fd0e113d4e4cb7f6c204008541760e39cc/tests%2Frun-pass%2Fbox_box_trait.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-pass%2Fbox_box_trait.rs?ref=d92085fd0e113d4e4cb7f6c204008541760e39cc", "patch": "@@ -0,0 +1,29 @@\n+#![feature(box_syntax)]\n+\n+struct DroppableStruct;\n+\n+static mut DROPPED: bool = false;\n+\n+impl Drop for DroppableStruct {\n+    fn drop(&mut self) {\n+        unsafe { DROPPED = true; }\n+    }\n+}\n+\n+trait MyTrait { fn dummy(&self) { } }\n+impl MyTrait for Box<DroppableStruct> {}\n+\n+struct Whatever { w: Box<MyTrait+'static> }\n+impl  Whatever {\n+    fn new(w: Box<MyTrait+'static>) -> Whatever {\n+        Whatever { w: w }\n+    }\n+}\n+\n+fn main() {\n+    {\n+        let f: Box<_> = box DroppableStruct;\n+        let _a = Whatever::new(box f as Box<MyTrait>);\n+    }\n+    assert!(unsafe { DROPPED });\n+}"}]}