{"sha": "41bc32368e907f939bffb25e73bce08ae912674c", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQxYmMzMjM2OGU5MDdmOTM5YmZmYjI1ZTczYmNlMDhhZTkxMjY3NGM=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2020-12-22T16:13:53Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2020-12-22T16:13:53Z"}, "message": "Improve extract_module_to_file assist\n\n* simplify code\n* correctly handle crate roots and mod.rs files (nested inline modules\n  are still mishandled)\n* make sure that new text contains a trailing newline", "tree": {"sha": "2f3da42b26e98cbfdc34b6eb8651e3ffc832c06e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2f3da42b26e98cbfdc34b6eb8651e3ffc832c06e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/41bc32368e907f939bffb25e73bce08ae912674c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/41bc32368e907f939bffb25e73bce08ae912674c", "html_url": "https://github.com/rust-lang/rust/commit/41bc32368e907f939bffb25e73bce08ae912674c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/41bc32368e907f939bffb25e73bce08ae912674c/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b98ee075ee8baa6dc4284f04df4c7012baccda28", "url": "https://api.github.com/repos/rust-lang/rust/commits/b98ee075ee8baa6dc4284f04df4c7012baccda28", "html_url": "https://github.com/rust-lang/rust/commit/b98ee075ee8baa6dc4284f04df4c7012baccda28"}], "stats": {"total": 169, "additions": 66, "deletions": 103}, "files": [{"sha": "3e67fdca2f1a3dfad90c3937f5b6c86be34cd4d6", "filename": "crates/assists/src/handlers/extract_module_to_file.rs", "status": "modified", "additions": 66, "deletions": 103, "changes": 169, "blob_url": "https://github.com/rust-lang/rust/blob/41bc32368e907f939bffb25e73bce08ae912674c/crates%2Fassists%2Fsrc%2Fhandlers%2Fextract_module_to_file.rs", "raw_url": "https://github.com/rust-lang/rust/raw/41bc32368e907f939bffb25e73bce08ae912674c/crates%2Fassists%2Fsrc%2Fhandlers%2Fextract_module_to_file.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fassists%2Fsrc%2Fhandlers%2Fextract_module_to_file.rs?ref=41bc32368e907f939bffb25e73bce08ae912674c", "patch": "@@ -1,5 +1,5 @@\n use ast::edit::IndentLevel;\n-use ide_db::base_db::{AnchoredPathBuf, SourceDatabaseExt};\n+use ide_db::base_db::AnchoredPathBuf;\n use syntax::{\n     ast::{self, edit::AstNodeEdit, NameOwner},\n     AstNode,\n@@ -21,43 +21,44 @@ use crate::{AssistContext, AssistId, AssistKind, Assists};\n // mod foo;\n // ```\n pub(crate) fn extract_module_to_file(acc: &mut Assists, ctx: &AssistContext) -> Option<()> {\n-    let assist_id = AssistId(\"extract_module_to_file\", AssistKind::RefactorExtract);\n-    let assist_label = \"Extract module to file\";\n-    let db = ctx.db();\n     let module_ast = ctx.find_node_at_offset::<ast::Module>()?;\n-    let module_items = module_ast.item_list()?;\n-    let dedent_module_items_text = module_items.dedent(IndentLevel(1)).to_string();\n     let module_name = module_ast.name()?;\n+\n+    let module_def = ctx.sema.to_def(&module_ast)?;\n+    let parent_module = module_def.parent(ctx.db())?;\n+\n+    let module_items = module_ast.item_list()?;\n     let target = module_ast.syntax().text_range();\n     let anchor_file_id = ctx.frange.file_id;\n-    let sr = db.file_source_root(anchor_file_id);\n-    let sr = db.source_root(sr);\n-    let file_path = sr.path_for_file(&anchor_file_id)?;\n-    let (file_name, file_ext) = file_path.name_and_extension()?;\n-    acc.add(assist_id, assist_label, target, |builder| {\n-        builder.replace(target, format!(\"mod {};\", module_name));\n-        let path = if is_main_or_lib(file_name) {\n-            format!(\"./{}.{}\", module_name, file_ext.unwrap())\n-        } else {\n-            format!(\"./{}/{}.{}\", file_name, module_name, file_ext.unwrap())\n-        };\n-        let dst = AnchoredPathBuf { anchor: anchor_file_id, path };\n-        let contents = update_module_items_string(dedent_module_items_text);\n-        builder.create_file(dst, contents);\n-    })\n-}\n-fn is_main_or_lib(file_name: &str) -> bool {\n-    file_name == \"main\".to_string() || file_name == \"lib\".to_string()\n-}\n-fn update_module_items_string(items_str: String) -> String {\n-    let mut items_string_lines: Vec<&str> = items_str.lines().collect();\n-    items_string_lines.pop(); // Delete last line\n-    items_string_lines.reverse();\n-    items_string_lines.pop(); // Delete first line\n-    items_string_lines.reverse();\n \n-    let string = items_string_lines.join(\"\\n\");\n-    format!(\"{}\", string)\n+    acc.add(\n+        AssistId(\"extract_module_to_file\", AssistKind::RefactorExtract),\n+        \"Extract module to file\",\n+        target,\n+        |builder| {\n+            let path = {\n+                let dir = match parent_module.name(ctx.db()) {\n+                    Some(name) if !parent_module.is_mod_rs(ctx.db()) => format!(\"{}/\", name),\n+                    _ => String::new(),\n+                };\n+                format!(\"./{}{}.rs\", dir, module_name)\n+            };\n+            let contents = {\n+                let items = module_items.dedent(IndentLevel(1)).to_string();\n+                let mut items =\n+                    items.trim_start_matches('{').trim_end_matches('}').trim().to_string();\n+                if !items.is_empty() {\n+                    items.push('\\n');\n+                }\n+                items\n+            };\n+\n+            builder.replace(target, format!(\"mod {};\", module_name));\n+\n+            let dst = AnchoredPathBuf { anchor: anchor_file_id, path };\n+            builder.create_file(dst, contents);\n+        },\n+    )\n }\n \n #[cfg(test)]\n@@ -67,104 +68,66 @@ mod tests {\n     use super::*;\n \n     #[test]\n-    fn extract_module_to_file_with_basic_module() {\n+    fn extract_from_root() {\n         check_assist(\n             extract_module_to_file,\n             r#\"\n-//- /foo.rs crate:foo\n mod tests {<|>\n     #[test] fn t() {}\n }\n \"#,\n             r#\"\n-//- /foo.rs\n+//- /main.rs\n mod tests;\n-//- /foo/tests.rs\n-#[test] fn t() {}\"#,\n-        )\n-    }\n-\n-    #[test]\n-    fn extract_module_to_file_with_file_path() {\n-        check_assist(\n-            extract_module_to_file,\n-            r#\"\n-//- /src/foo.rs crate:foo\n-mod bar {<|>\n-    fn f() {\n-\n-    }\n-}\n-fn main() {\n-    println!(\"Hello, world!\");\n-}\n+//- /tests.rs\n+#[test] fn t() {}\n \"#,\n-            r#\"\n-//- /src/foo.rs\n-mod bar;\n-fn main() {\n-    println!(\"Hello, world!\");\n-}\n-//- /src/foo/bar.rs\n-fn f() {\n-\n-}\"#,\n-        )\n+        );\n     }\n \n     #[test]\n-    fn extract_module_to_file_with_main_filw() {\n+    fn extract_from_submodule() {\n         check_assist(\n             extract_module_to_file,\n             r#\"\n //- /main.rs\n-mod foo {<|>\n-    fn f() {\n-\n-    }\n-}\n-fn main() {\n-    println!(\"Hello, world!\");\n+mod submodule;\n+//- /submodule.rs\n+mod inner<|> {\n+    fn f() {}\n }\n+fn g() {}\n \"#,\n             r#\"\n-//- /main.rs\n-mod foo;\n-fn main() {\n-    println!(\"Hello, world!\");\n-}\n-//- /foo.rs\n-fn f() {\n-\n-}\"#,\n-        )\n+//- /submodule.rs\n+mod inner;\n+fn g() {}\n+//- /submodule/inner.rs\n+fn f() {}\n+\"#,\n+        );\n     }\n \n     #[test]\n-    fn extract_module_to_file_with_lib_file() {\n+    fn extract_from_mod_rs() {\n         check_assist(\n             extract_module_to_file,\n             r#\"\n-//- /lib.rs\n-mod foo {<|>\n-    fn f() {\n-\n-    }\n-}\n-fn main() {\n-    println!(\"Hello, world!\");\n+//- /main.rs\n+mod submodule;\n+//- /submodule/mod.rs\n+mod inner<|> {\n+    fn f() {}\n }\n+fn g() {}\n \"#,\n             r#\"\n-//- /lib.rs\n-mod foo;\n-fn main() {\n-    println!(\"Hello, world!\");\n-}\n-//- /foo.rs\n-fn f() {\n-\n-}\"#,\n-        )\n+//- /submodule/mod.rs\n+mod inner;\n+fn g() {}\n+//- /submodule/inner.rs\n+fn f() {}\n+\"#,\n+        );\n     }\n }"}]}