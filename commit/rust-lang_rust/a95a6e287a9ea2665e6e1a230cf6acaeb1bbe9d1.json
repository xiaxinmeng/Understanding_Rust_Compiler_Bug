{"sha": "a95a6e287a9ea2665e6e1a230cf6acaeb1bbe9d1", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE5NWE2ZTI4N2E5ZWEyNjY1ZTZlMWEyMzBjZjZhY2FlYjFiYmU5ZDE=", "commit": {"author": {"name": "Pietro Albini", "email": "pietro@pietroalbini.org", "date": "2018-10-05T20:33:17Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2018-10-05T20:33:17Z"}, "message": "Rollup merge of #54833 - abonander:issue-54441, r=petrochenkov\n\nmake `Parser::parse_foreign_item()` return a foreign item or error\n\nFixes `Parser::parse_foreign_item()` to follow the convention of `parse_trait_item()` and `parse_impl_item()` in that it *must* parse an item or return an error, and then the caller is responsible for detecting the closing delimiter.\n\nThis prevents it from looping endlessly on an unexpected token in `ext/expand.rs` where it was also leaking memory by continually pushing to `Parser::expected_tokens` via `Parser::check_keyword()`.\n\ncloses #54441\n\nr? @petrochenkov\ncc @dtolnay", "tree": {"sha": "6fc17abed4c52dd300c415ea77154bb16d079755", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6fc17abed4c52dd300c415ea77154bb16d079755"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a95a6e287a9ea2665e6e1a230cf6acaeb1bbe9d1", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJbt8qNCRBK7hj4Ov3rIwAAdHIIAF0GN8CjjBAysVQtRGNiGpQF\nGe8wiVo9uz2mRm6g0muw7Ra8x8sz/Z+P9pbgFtfTYvtWfst2muEQQ2JtiqnLqikb\nfHnurWQ+WiijjXrBHF4oQSpzXhFymCxo4BKqPeGonKPEFDhnD2b6kXAVtLbnXZ1d\n07LFFQzFN49FmtBrBCZjr18QZ67c7hVovww7lSFthFBrzo005rmHk+ZwQRGJyO1u\nZbs/wT6TKZkCS3yntjxW97xBGW4yrr5upTHi5yJZ8BgtIpzQ8dq5zxJX1RIQXUMr\nOmc/WzTBS8RLrQdQi9vm9PQ7nnh+XlMAo0+YyhJC5Lf9r1X4cqcxX6Wmwpmt5OA=\n=X6YQ\n-----END PGP SIGNATURE-----\n", "payload": "tree 6fc17abed4c52dd300c415ea77154bb16d079755\nparent 08af25fb27a521ee924787c10c96e8d9e2b04db9\nparent 9da428dad8eefa8a821214bc0fe0d4159ba4efed\nauthor Pietro Albini <pietro@pietroalbini.org> 1538771597 +0200\ncommitter GitHub <noreply@github.com> 1538771597 +0200\n\nRollup merge of #54833 - abonander:issue-54441, r=petrochenkov\n\nmake `Parser::parse_foreign_item()` return a foreign item or error\n\nFixes `Parser::parse_foreign_item()` to follow the convention of `parse_trait_item()` and `parse_impl_item()` in that it *must* parse an item or return an error, and then the caller is responsible for detecting the closing delimiter.\n\nThis prevents it from looping endlessly on an unexpected token in `ext/expand.rs` where it was also leaking memory by continually pushing to `Parser::expected_tokens` via `Parser::check_keyword()`.\n\ncloses #54441\n\nr? @petrochenkov\ncc @dtolnay\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a95a6e287a9ea2665e6e1a230cf6acaeb1bbe9d1", "html_url": "https://github.com/rust-lang/rust/commit/a95a6e287a9ea2665e6e1a230cf6acaeb1bbe9d1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a95a6e287a9ea2665e6e1a230cf6acaeb1bbe9d1/comments", "author": {"login": "pietroalbini", "id": 2299951, "node_id": "MDQ6VXNlcjIyOTk5NTE=", "avatar_url": "https://avatars.githubusercontent.com/u/2299951?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pietroalbini", "html_url": "https://github.com/pietroalbini", "followers_url": "https://api.github.com/users/pietroalbini/followers", "following_url": "https://api.github.com/users/pietroalbini/following{/other_user}", "gists_url": "https://api.github.com/users/pietroalbini/gists{/gist_id}", "starred_url": "https://api.github.com/users/pietroalbini/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pietroalbini/subscriptions", "organizations_url": "https://api.github.com/users/pietroalbini/orgs", "repos_url": "https://api.github.com/users/pietroalbini/repos", "events_url": "https://api.github.com/users/pietroalbini/events{/privacy}", "received_events_url": "https://api.github.com/users/pietroalbini/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "08af25fb27a521ee924787c10c96e8d9e2b04db9", "url": "https://api.github.com/repos/rust-lang/rust/commits/08af25fb27a521ee924787c10c96e8d9e2b04db9", "html_url": "https://github.com/rust-lang/rust/commit/08af25fb27a521ee924787c10c96e8d9e2b04db9"}, {"sha": "9da428dad8eefa8a821214bc0fe0d4159ba4efed", "url": "https://api.github.com/repos/rust-lang/rust/commits/9da428dad8eefa8a821214bc0fe0d4159ba4efed", "html_url": "https://github.com/rust-lang/rust/commit/9da428dad8eefa8a821214bc0fe0d4159ba4efed"}], "stats": {"total": 56, "additions": 40, "deletions": 16}, "files": [{"sha": "9e06384f5a804e574124136419bba662902f37ac", "filename": "src/libsyntax/ext/expand.rs", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/a95a6e287a9ea2665e6e1a230cf6acaeb1bbe9d1/src%2Flibsyntax%2Fext%2Fexpand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a95a6e287a9ea2665e6e1a230cf6acaeb1bbe9d1/src%2Flibsyntax%2Fext%2Fexpand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fexpand.rs?ref=a95a6e287a9ea2665e6e1a230cf6acaeb1bbe9d1", "patch": "@@ -1001,9 +1001,7 @@ impl<'a> Parser<'a> {\n             AstFragmentKind::ForeignItems => {\n                 let mut items = SmallVec::new();\n                 while self.token != token::Eof {\n-                    if let Some(item) = self.parse_foreign_item()? {\n-                        items.push(item);\n-                    }\n+                    items.push(self.parse_foreign_item()?);\n                 }\n                 AstFragment::ForeignItems(items)\n             }"}, {"sha": "d653ed819fddde9ed1f5549566312940f045f928", "filename": "src/libsyntax/parse/parser.rs", "status": "modified", "additions": 11, "deletions": 12, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/a95a6e287a9ea2665e6e1a230cf6acaeb1bbe9d1/src%2Flibsyntax%2Fparse%2Fparser.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a95a6e287a9ea2665e6e1a230cf6acaeb1bbe9d1/src%2Flibsyntax%2Fparse%2Fparser.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fparse%2Fparser.rs?ref=a95a6e287a9ea2665e6e1a230cf6acaeb1bbe9d1", "patch": "@@ -6737,10 +6737,9 @@ impl<'a> Parser<'a> {\n         attrs.extend(self.parse_inner_attributes()?);\n \n         let mut foreign_items = vec![];\n-        while let Some(item) = self.parse_foreign_item()? {\n-            foreign_items.push(item);\n+        while !self.eat(&token::CloseDelim(token::Brace)) {\n+            foreign_items.push(self.parse_foreign_item()?);\n         }\n-        self.expect(&token::CloseDelim(token::Brace))?;\n \n         let prev_span = self.prev_span;\n         let m = ast::ForeignMod {\n@@ -7324,8 +7323,8 @@ impl<'a> Parser<'a> {\n     }\n \n     /// Parse a foreign item.\n-    crate fn parse_foreign_item(&mut self) -> PResult<'a, Option<ForeignItem>> {\n-        maybe_whole!(self, NtForeignItem, |ni| Some(ni));\n+    crate fn parse_foreign_item(&mut self) -> PResult<'a, ForeignItem> {\n+        maybe_whole!(self, NtForeignItem, |ni| ni);\n \n         let attrs = self.parse_outer_attributes()?;\n         let lo = self.span;\n@@ -7345,20 +7344,20 @@ impl<'a> Parser<'a> {\n                     ).emit();\n             }\n             self.bump(); // `static` or `const`\n-            return Ok(Some(self.parse_item_foreign_static(visibility, lo, attrs)?));\n+            return Ok(self.parse_item_foreign_static(visibility, lo, attrs)?);\n         }\n         // FOREIGN FUNCTION ITEM\n         if self.check_keyword(keywords::Fn) {\n-            return Ok(Some(self.parse_item_foreign_fn(visibility, lo, attrs)?));\n+            return Ok(self.parse_item_foreign_fn(visibility, lo, attrs)?);\n         }\n         // FOREIGN TYPE ITEM\n         if self.check_keyword(keywords::Type) {\n-            return Ok(Some(self.parse_item_foreign_type(visibility, lo, attrs)?));\n+            return Ok(self.parse_item_foreign_type(visibility, lo, attrs)?);\n         }\n \n         match self.parse_assoc_macro_invoc(\"extern\", Some(&visibility), &mut false)? {\n             Some(mac) => {\n-                Ok(Some(\n+                Ok(\n                     ForeignItem {\n                         ident: keywords::Invalid.ident(),\n                         span: lo.to(self.prev_span),\n@@ -7367,14 +7366,14 @@ impl<'a> Parser<'a> {\n                         vis: visibility,\n                         node: ForeignItemKind::Macro(mac),\n                     }\n-                ))\n+                )\n             }\n             None => {\n-                if !attrs.is_empty() {\n+                if !attrs.is_empty()  {\n                     self.expected_item_err(&attrs);\n                 }\n \n-                Ok(None)\n+                self.unexpected()\n             }\n         }\n     }"}, {"sha": "cc3286fe70512881c31a834e2d0446b54a2d4d40", "filename": "src/test/parse-fail/duplicate-visibility.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a95a6e287a9ea2665e6e1a230cf6acaeb1bbe9d1/src%2Ftest%2Fparse-fail%2Fduplicate-visibility.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a95a6e287a9ea2665e6e1a230cf6acaeb1bbe9d1/src%2Ftest%2Fparse-fail%2Fduplicate-visibility.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fparse-fail%2Fduplicate-visibility.rs?ref=a95a6e287a9ea2665e6e1a230cf6acaeb1bbe9d1", "patch": "@@ -10,7 +10,7 @@\n \n // compile-flags: -Z parse-only\n \n-// error-pattern:expected one of `(`, `fn`, `static`, `type`, or `}` here\n+// error-pattern:expected one of `(`, `fn`, `static`, or `type`\n extern {\n     pub pub fn foo();\n }"}, {"sha": "b45aedb549ecd66d6a5e77437d67e2b2f89d86a9", "filename": "src/test/ui/macros/issue-54441.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/a95a6e287a9ea2665e6e1a230cf6acaeb1bbe9d1/src%2Ftest%2Fui%2Fmacros%2Fissue-54441.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a95a6e287a9ea2665e6e1a230cf6acaeb1bbe9d1/src%2Ftest%2Fui%2Fmacros%2Fissue-54441.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmacros%2Fissue-54441.rs?ref=a95a6e287a9ea2665e6e1a230cf6acaeb1bbe9d1", "patch": "@@ -0,0 +1,13 @@\n+#![feature(macros_in_extern)]\n+\n+macro_rules! m {\n+    () => {\n+        let //~ ERROR expected\n+    };\n+}\n+\n+extern \"C\" {\n+    m!();\n+}\n+\n+fn main() {}"}, {"sha": "aa1edb2cf893fdd26ed2b99911ad8a5caf95c594", "filename": "src/test/ui/macros/issue-54441.stderr", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/a95a6e287a9ea2665e6e1a230cf6acaeb1bbe9d1/src%2Ftest%2Fui%2Fmacros%2Fissue-54441.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/a95a6e287a9ea2665e6e1a230cf6acaeb1bbe9d1/src%2Ftest%2Fui%2Fmacros%2Fissue-54441.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmacros%2Fissue-54441.stderr?ref=a95a6e287a9ea2665e6e1a230cf6acaeb1bbe9d1", "patch": "@@ -0,0 +1,14 @@\n+error: expected one of `crate`, `fn`, `pub`, `static`, or `type`, found `let`\n+  --> $DIR/issue-54441.rs:5:9\n+   |\n+LL | #![feature(macros_in_extern)]\n+   | - expected one of `crate`, `fn`, `pub`, `static`, or `type` here\n+...\n+LL |         let //~ ERROR expected\n+   |         ^^^ unexpected token\n+...\n+LL |     m!();\n+   |     ----- in this macro invocation\n+\n+error: aborting due to previous error\n+"}]}