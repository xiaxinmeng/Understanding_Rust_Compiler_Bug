{"sha": "70ad31847d568b291253714f06b562ef1d07eda6", "node_id": "MDY6Q29tbWl0NzI0NzEyOjcwYWQzMTg0N2Q1NjhiMjkxMjUzNzE0ZjA2YjU2MmVmMWQwN2VkYTY=", "commit": {"author": {"name": "kadmin", "email": "julianknodt@gmail.com", "date": "2020-08-13T21:59:47Z"}, "committer": {"name": "kadmin", "email": "julianknodt@gmail.com", "date": "2020-08-13T21:59:47Z"}, "message": "Clean up some mir transform passes\n\nI noticed a few places where there were intermediates being created\nin MIR optimization passes, so I removed them.", "tree": {"sha": "ea5b0f5482233f751400f1d8f837fa27bb86f0f8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ea5b0f5482233f751400f1d8f837fa27bb86f0f8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/70ad31847d568b291253714f06b562ef1d07eda6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/70ad31847d568b291253714f06b562ef1d07eda6", "html_url": "https://github.com/rust-lang/rust/commit/70ad31847d568b291253714f06b562ef1d07eda6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/70ad31847d568b291253714f06b562ef1d07eda6/comments", "author": {"login": "JulianKnodt", "id": 7675847, "node_id": "MDQ6VXNlcjc2NzU4NDc=", "avatar_url": "https://avatars.githubusercontent.com/u/7675847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JulianKnodt", "html_url": "https://github.com/JulianKnodt", "followers_url": "https://api.github.com/users/JulianKnodt/followers", "following_url": "https://api.github.com/users/JulianKnodt/following{/other_user}", "gists_url": "https://api.github.com/users/JulianKnodt/gists{/gist_id}", "starred_url": "https://api.github.com/users/JulianKnodt/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JulianKnodt/subscriptions", "organizations_url": "https://api.github.com/users/JulianKnodt/orgs", "repos_url": "https://api.github.com/users/JulianKnodt/repos", "events_url": "https://api.github.com/users/JulianKnodt/events{/privacy}", "received_events_url": "https://api.github.com/users/JulianKnodt/received_events", "type": "User", "site_admin": false}, "committer": {"login": "JulianKnodt", "id": 7675847, "node_id": "MDQ6VXNlcjc2NzU4NDc=", "avatar_url": "https://avatars.githubusercontent.com/u/7675847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JulianKnodt", "html_url": "https://github.com/JulianKnodt", "followers_url": "https://api.github.com/users/JulianKnodt/followers", "following_url": "https://api.github.com/users/JulianKnodt/following{/other_user}", "gists_url": "https://api.github.com/users/JulianKnodt/gists{/gist_id}", "starred_url": "https://api.github.com/users/JulianKnodt/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JulianKnodt/subscriptions", "organizations_url": "https://api.github.com/users/JulianKnodt/orgs", "repos_url": "https://api.github.com/users/JulianKnodt/repos", "events_url": "https://api.github.com/users/JulianKnodt/events{/privacy}", "received_events_url": "https://api.github.com/users/JulianKnodt/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b6396b75e782954acb085447fb836c4e0ff5281d", "url": "https://api.github.com/repos/rust-lang/rust/commits/b6396b75e782954acb085447fb836c4e0ff5281d", "html_url": "https://github.com/rust-lang/rust/commit/b6396b75e782954acb085447fb836c4e0ff5281d"}], "stats": {"total": 101, "additions": 50, "deletions": 51}, "files": [{"sha": "324289166b9fb0c913929dadcc63863979d8d44c", "filename": "src/librustc_mir/transform/add_retag.rs", "status": "modified", "additions": 16, "deletions": 22, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/70ad31847d568b291253714f06b562ef1d07eda6/src%2Flibrustc_mir%2Ftransform%2Fadd_retag.rs", "raw_url": "https://github.com/rust-lang/rust/raw/70ad31847d568b291253714f06b562ef1d07eda6/src%2Flibrustc_mir%2Ftransform%2Fadd_retag.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fadd_retag.rs?ref=70ad31847d568b291253714f06b562ef1d07eda6", "patch": "@@ -86,12 +86,11 @@ impl<'tcx> MirPass<'tcx> for AddRetag {\n                 .skip(1)\n                 .take(arg_count)\n                 .map(|(local, _)| Place::from(local))\n-                .filter(needs_retag)\n-                .collect::<Vec<_>>();\n+                .filter(needs_retag);\n             // Emit their retags.\n             basic_blocks[START_BLOCK].statements.splice(\n                 0..0,\n-                places.into_iter().map(|place| Statement {\n+                places.map(|place| Statement {\n                     source_info,\n                     kind: StatementKind::Retag(RetagKind::FnEntry, box (place)),\n                 }),\n@@ -101,29 +100,24 @@ impl<'tcx> MirPass<'tcx> for AddRetag {\n         // PART 2\n         // Retag return values of functions.  Also escape-to-raw the argument of `drop`.\n         // We collect the return destinations because we cannot mutate while iterating.\n-        let mut returns: Vec<(SourceInfo, Place<'tcx>, BasicBlock)> = Vec::new();\n-        for block_data in basic_blocks.iter_mut() {\n-            match block_data.terminator().kind {\n-                TerminatorKind::Call { ref destination, .. } => {\n-                    // Remember the return destination for later\n-                    if let Some(ref destination) = destination {\n-                        if needs_retag(&destination.0) {\n-                            returns.push((\n-                                block_data.terminator().source_info,\n-                                destination.0,\n-                                destination.1,\n-                            ));\n-                        }\n+        let returns = basic_blocks\n+            .iter_mut()\n+            .filter_map(|block_data| {\n+                match block_data.terminator().kind {\n+                    TerminatorKind::Call { destination: Some(ref destination), .. }\n+                        if needs_retag(&destination.0) =>\n+                    {\n+                        // Remember the return destination for later\n+                        Some((block_data.terminator().source_info, destination.0, destination.1))\n                     }\n-                }\n-                TerminatorKind::Drop { .. } | TerminatorKind::DropAndReplace { .. } => {\n+\n                     // `Drop` is also a call, but it doesn't return anything so we are good.\n-                }\n-                _ => {\n+                    TerminatorKind::Drop { .. } | TerminatorKind::DropAndReplace { .. } => None,\n                     // Not a block ending in a Call -> ignore.\n+                    _ => None,\n                 }\n-            }\n-        }\n+            })\n+            .collect::<Vec<_>>();\n         // Now we go over the returns we collected to retag the return values.\n         for (source_info, dest_place, dest_block) in returns {\n             basic_blocks[dest_block].statements.insert("}, {"sha": "66989a902447d6076071f0936672459dc276f4e9", "filename": "src/librustc_mir/transform/deaggregator.rs", "status": "modified", "additions": 11, "deletions": 13, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/70ad31847d568b291253714f06b562ef1d07eda6/src%2Flibrustc_mir%2Ftransform%2Fdeaggregator.rs", "raw_url": "https://github.com/rust-lang/rust/raw/70ad31847d568b291253714f06b562ef1d07eda6/src%2Flibrustc_mir%2Ftransform%2Fdeaggregator.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fdeaggregator.rs?ref=70ad31847d568b291253714f06b562ef1d07eda6", "patch": "@@ -12,26 +12,24 @@ impl<'tcx> MirPass<'tcx> for Deaggregator {\n         for bb in basic_blocks {\n             bb.expand_statements(|stmt| {\n                 // FIXME(eddyb) don't match twice on `stmt.kind` (post-NLL).\n-                if let StatementKind::Assign(box (_, ref rhs)) = stmt.kind {\n-                    if let Rvalue::Aggregate(ref kind, _) = *rhs {\n-                        // FIXME(#48193) Deaggregate arrays when it's cheaper to do so.\n-                        if let AggregateKind::Array(_) = **kind {\n-                            return None;\n-                        }\n-                    } else {\n+                match stmt.kind {\n+                    // FIXME(#48193) Deaggregate arrays when it's cheaper to do so.\n+                    StatementKind::Assign(box (\n+                        _,\n+                        Rvalue::Aggregate(box AggregateKind::Array(_), _),\n+                    )) => {\n                         return None;\n                     }\n-                } else {\n-                    return None;\n+                    StatementKind::Assign(box (_, Rvalue::Aggregate(_, _))) => {}\n+                    _ => return None,\n                 }\n \n                 let stmt = stmt.replace_nop();\n                 let source_info = stmt.source_info;\n                 let (lhs, kind, operands) = match stmt.kind {\n-                    StatementKind::Assign(box (lhs, rvalue)) => match rvalue {\n-                        Rvalue::Aggregate(kind, operands) => (lhs, kind, operands),\n-                        _ => bug!(),\n-                    },\n+                    StatementKind::Assign(box (lhs, Rvalue::Aggregate(kind, operands))) => {\n+                        (lhs, kind, operands)\n+                    }\n                     _ => bug!(),\n                 };\n "}, {"sha": "e2f8917156b8d71c941f44478b41a4798bd96973", "filename": "src/librustc_mir/transform/unreachable_prop.rs", "status": "modified", "additions": 23, "deletions": 16, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/70ad31847d568b291253714f06b562ef1d07eda6/src%2Flibrustc_mir%2Ftransform%2Funreachable_prop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/70ad31847d568b291253714f06b562ef1d07eda6/src%2Flibrustc_mir%2Ftransform%2Funreachable_prop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Funreachable_prop.rs?ref=70ad31847d568b291253714f06b562ef1d07eda6", "patch": "@@ -67,18 +67,24 @@ fn remove_successors<F>(\n where\n     F: Fn(BasicBlock) -> bool,\n {\n-    match *terminator_kind {\n-        TerminatorKind::Goto { target } if predicate(target) => Some(TerminatorKind::Unreachable),\n+    let terminator = match *terminator_kind {\n+        TerminatorKind::FalseEdge { real_target, imaginary_target }\n+            if predicate(real_target) && predicate(imaginary_target) =>\n+        {\n+            TerminatorKind::Unreachable\n+        }\n+        TerminatorKind::FalseUnwind { real_target, unwind }\n+            if predicate(real_target) && unwind.map_or(true, &predicate) =>\n+        {\n+            TerminatorKind::Unreachable\n+        }\n+\n+        TerminatorKind::Goto { target } if predicate(target) => TerminatorKind::Unreachable,\n         TerminatorKind::SwitchInt { ref discr, switch_ty, ref values, ref targets } => {\n             let original_targets_len = targets.len();\n             let (otherwise, targets) = targets.split_last().unwrap();\n-            let retained = values\n-                .iter()\n-                .zip(targets.iter())\n-                .filter(|(_, &t)| !predicate(t))\n-                .collect::<Vec<_>>();\n-            let mut values = retained.iter().map(|&(v, _)| *v).collect::<Vec<_>>();\n-            let mut targets = retained.iter().map(|&(_, d)| *d).collect::<Vec<_>>();\n+            let (mut values, mut targets): (Vec<_>, Vec<_>) =\n+                values.iter().zip(targets.iter()).filter(|(_, &t)| !predicate(t)).unzip();\n \n             if !predicate(*otherwise) {\n                 targets.push(*otherwise);\n@@ -89,20 +95,21 @@ where\n             let retained_targets_len = targets.len();\n \n             if targets.is_empty() {\n-                Some(TerminatorKind::Unreachable)\n+                TerminatorKind::Unreachable\n             } else if targets.len() == 1 {\n-                Some(TerminatorKind::Goto { target: targets[0] })\n+                TerminatorKind::Goto { target: targets[0] }\n             } else if original_targets_len != retained_targets_len {\n-                Some(TerminatorKind::SwitchInt {\n+                TerminatorKind::SwitchInt {\n                     discr: discr.clone(),\n                     switch_ty,\n                     values: Cow::from(values),\n                     targets,\n-                })\n+                }\n             } else {\n-                None\n+                return None;\n             }\n         }\n-        _ => None,\n-    }\n+        _ => return None,\n+    };\n+    Some(terminator)\n }"}]}