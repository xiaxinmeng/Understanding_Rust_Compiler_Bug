{"sha": "faf87105db54a399bc598765528dec818b63a54a", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZhZjg3MTA1ZGI1NGEzOTliYzU5ODc2NTUyOGRlYzgxOGI2M2E1NGE=", "commit": {"author": {"name": "Nadrieril", "email": "nadrieril+git@gmail.com", "date": "2020-10-21T19:15:02Z"}, "committer": {"name": "Nadrieril", "email": "nadrieril+git@gmail.com", "date": "2020-10-21T19:15:02Z"}, "message": "Explain the `Opaque` special case in specialization", "tree": {"sha": "983be03128b5282fdd89d4f8609b7522acd06065", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/983be03128b5282fdd89d4f8609b7522acd06065"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/faf87105db54a399bc598765528dec818b63a54a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/faf87105db54a399bc598765528dec818b63a54a", "html_url": "https://github.com/rust-lang/rust/commit/faf87105db54a399bc598765528dec818b63a54a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/faf87105db54a399bc598765528dec818b63a54a/comments", "author": {"login": "Nadrieril", "id": 6783654, "node_id": "MDQ6VXNlcjY3ODM2NTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/6783654?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Nadrieril", "html_url": "https://github.com/Nadrieril", "followers_url": "https://api.github.com/users/Nadrieril/followers", "following_url": "https://api.github.com/users/Nadrieril/following{/other_user}", "gists_url": "https://api.github.com/users/Nadrieril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Nadrieril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Nadrieril/subscriptions", "organizations_url": "https://api.github.com/users/Nadrieril/orgs", "repos_url": "https://api.github.com/users/Nadrieril/repos", "events_url": "https://api.github.com/users/Nadrieril/events{/privacy}", "received_events_url": "https://api.github.com/users/Nadrieril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Nadrieril", "id": 6783654, "node_id": "MDQ6VXNlcjY3ODM2NTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/6783654?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Nadrieril", "html_url": "https://github.com/Nadrieril", "followers_url": "https://api.github.com/users/Nadrieril/followers", "following_url": "https://api.github.com/users/Nadrieril/following{/other_user}", "gists_url": "https://api.github.com/users/Nadrieril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Nadrieril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Nadrieril/subscriptions", "organizations_url": "https://api.github.com/users/Nadrieril/orgs", "repos_url": "https://api.github.com/users/Nadrieril/repos", "events_url": "https://api.github.com/users/Nadrieril/events{/privacy}", "received_events_url": "https://api.github.com/users/Nadrieril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "35194117006d987d59dabb44ee3e4f38281c9e1b", "url": "https://api.github.com/repos/rust-lang/rust/commits/35194117006d987d59dabb44ee3e4f38281c9e1b", "html_url": "https://github.com/rust-lang/rust/commit/35194117006d987d59dabb44ee3e4f38281c9e1b"}], "stats": {"total": 19, "additions": 18, "deletions": 1}, "files": [{"sha": "4c69339795d404591b473cd8f284b8163be92706", "filename": "compiler/rustc_mir_build/src/thir/pattern/_match.rs", "status": "modified", "additions": 18, "deletions": 1, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/faf87105db54a399bc598765528dec818b63a54a/compiler%2Frustc_mir_build%2Fsrc%2Fthir%2Fpattern%2F_match.rs", "raw_url": "https://github.com/rust-lang/rust/raw/faf87105db54a399bc598765528dec818b63a54a/compiler%2Frustc_mir_build%2Fsrc%2Fthir%2Fpattern%2F_match.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fthir%2Fpattern%2F_match.rs?ref=faf87105db54a399bc598765528dec818b63a54a", "patch": "@@ -2477,7 +2477,24 @@ fn specialize_one_pattern<'p, 'tcx>(\n \n     if let Opaque = constructor {\n         // Only a wildcard pattern can match an opaque constant, unless we're specializing the\n-        // value against its own constructor.\n+        // value against its own constructor. That happens when we call\n+        // `v.specialize_constructor(ctor)` with `ctor` obtained from `pat_constructor(v.head())`.\n+        // For example, in the following match, when we are dealing with the third branch, we will\n+        // specialize with an `Opaque` ctor. We want to ignore the second branch because opaque\n+        // constants should not be inspected, but we don't want to ignore the current (third)\n+        // branch, as that would cause us to always conclude that such a branch is unreachable.\n+        // ```rust\n+        // #[derive(PartialEq)]\n+        // struct Foo(i32);\n+        // impl Eq for Foo {}\n+        // const FOO: Foo = Foo(42);\n+        //\n+        // match (Foo(0), true) {\n+        //     (_, true) => {}\n+        //     (FOO, true) => {}\n+        //     (FOO, false) => {}\n+        // }\n+        // ```\n         if is_its_own_ctor || pat.is_wildcard() {\n             return Some(Fields::empty());\n         } else {"}]}