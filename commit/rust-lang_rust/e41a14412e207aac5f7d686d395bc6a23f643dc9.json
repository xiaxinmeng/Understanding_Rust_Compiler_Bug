{"sha": "e41a14412e207aac5f7d686d395bc6a23f643dc9", "node_id": "MDY6Q29tbWl0NzI0NzEyOmU0MWExNDQxMmUyMDdhYWM1ZjdkNjg2ZDM5NWJjNmEyM2Y2NDNkYzk=", "commit": {"author": {"name": "Amanieu d'Antras", "email": "amanieu@gmail.com", "date": "2020-10-03T15:13:06Z"}, "committer": {"name": "Amanieu d'Antras", "email": "amanieu@gmail.com", "date": "2020-10-03T19:35:59Z"}, "message": "Support vectors with fewer than 8 elements for simd_select_bitmask", "tree": {"sha": "e9387b3eaabb9516d8cc676a286a2d2d63bd950d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e9387b3eaabb9516d8cc676a286a2d2d63bd950d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e41a14412e207aac5f7d686d395bc6a23f643dc9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e41a14412e207aac5f7d686d395bc6a23f643dc9", "html_url": "https://github.com/rust-lang/rust/commit/e41a14412e207aac5f7d686d395bc6a23f643dc9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e41a14412e207aac5f7d686d395bc6a23f643dc9/comments", "author": {"login": "Amanieu", "id": 278509, "node_id": "MDQ6VXNlcjI3ODUwOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/278509?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Amanieu", "html_url": "https://github.com/Amanieu", "followers_url": "https://api.github.com/users/Amanieu/followers", "following_url": "https://api.github.com/users/Amanieu/following{/other_user}", "gists_url": "https://api.github.com/users/Amanieu/gists{/gist_id}", "starred_url": "https://api.github.com/users/Amanieu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Amanieu/subscriptions", "organizations_url": "https://api.github.com/users/Amanieu/orgs", "repos_url": "https://api.github.com/users/Amanieu/repos", "events_url": "https://api.github.com/users/Amanieu/events{/privacy}", "received_events_url": "https://api.github.com/users/Amanieu/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Amanieu", "id": 278509, "node_id": "MDQ6VXNlcjI3ODUwOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/278509?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Amanieu", "html_url": "https://github.com/Amanieu", "followers_url": "https://api.github.com/users/Amanieu/followers", "following_url": "https://api.github.com/users/Amanieu/following{/other_user}", "gists_url": "https://api.github.com/users/Amanieu/gists{/gist_id}", "starred_url": "https://api.github.com/users/Amanieu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Amanieu/subscriptions", "organizations_url": "https://api.github.com/users/Amanieu/orgs", "repos_url": "https://api.github.com/users/Amanieu/repos", "events_url": "https://api.github.com/users/Amanieu/events{/privacy}", "received_events_url": "https://api.github.com/users/Amanieu/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6f56fbdc1c58992a9db630f5cd2ba9882d32e84b", "url": "https://api.github.com/repos/rust-lang/rust/commits/6f56fbdc1c58992a9db630f5cd2ba9882d32e84b", "html_url": "https://github.com/rust-lang/rust/commit/6f56fbdc1c58992a9db630f5cd2ba9882d32e84b"}], "stats": {"total": 45, "additions": 37, "deletions": 8}, "files": [{"sha": "e76e86f56510ba02ef77c1fa81990bfafe93c670", "filename": "compiler/rustc_codegen_llvm/src/intrinsic.rs", "status": "modified", "additions": 7, "deletions": 3, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/e41a14412e207aac5f7d686d395bc6a23f643dc9/compiler%2Frustc_codegen_llvm%2Fsrc%2Fintrinsic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e41a14412e207aac5f7d686d395bc6a23f643dc9/compiler%2Frustc_codegen_llvm%2Fsrc%2Fintrinsic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fintrinsic.rs?ref=e41a14412e207aac5f7d686d395bc6a23f643dc9", "patch": "@@ -793,14 +793,18 @@ fn generic_simd_intrinsic(\n         require_simd!(arg_tys[1], \"argument\");\n         let v_len = arg_tys[1].simd_size(tcx);\n         require!(\n-            m_len == v_len,\n+            // Allow masks for vectors with fewer than 8 elements to be\n+            // represented with a u8 or i8.\n+            m_len == v_len || (m_len == 8 && v_len < 8),\n             \"mismatched lengths: mask length `{}` != other vector length `{}`\",\n             m_len,\n             v_len\n         );\n         let i1 = bx.type_i1();\n-        let i1xn = bx.type_vector(i1, m_len);\n-        let m_i1s = bx.bitcast(args[0].immediate(), i1xn);\n+        let im = bx.type_ix(v_len);\n+        let i1xn = bx.type_vector(i1, v_len);\n+        let m_im = bx.trunc(args[0].immediate(), im);\n+        let m_i1s = bx.bitcast(m_im, i1xn);\n         return Ok(bx.select(m_i1s, args[1].immediate(), args[2].immediate()));\n     }\n "}, {"sha": "7d68af49e2868a8d76c38be186921451c784d739", "filename": "src/test/ui/simd-intrinsic/simd-intrinsic-generic-select.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/e41a14412e207aac5f7d686d395bc6a23f643dc9/src%2Ftest%2Fui%2Fsimd-intrinsic%2Fsimd-intrinsic-generic-select.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e41a14412e207aac5f7d686d395bc6a23f643dc9/src%2Ftest%2Fui%2Fsimd-intrinsic%2Fsimd-intrinsic-generic-select.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsimd-intrinsic%2Fsimd-intrinsic-generic-select.rs?ref=e41a14412e207aac5f7d686d395bc6a23f643dc9", "patch": "@@ -49,8 +49,8 @@ fn main() {\n         simd_select(m4, 0u32, 1u32);\n         //~^ ERROR found non-SIMD `u32`\n \n-        simd_select_bitmask(0u8, x, x);\n-        //~^ ERROR mask length `8` != other vector length `4`\n+        simd_select_bitmask(0u16, x, x);\n+        //~^ ERROR mask length `16` != other vector length `4`\n         //\n         simd_select_bitmask(0u8, 1u32, 2u32);\n         //~^ ERROR found non-SIMD `u32`"}, {"sha": "a1ef0bb8ee03bbef2acb06f6db314ec0837b8891", "filename": "src/test/ui/simd-intrinsic/simd-intrinsic-generic-select.stderr", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/e41a14412e207aac5f7d686d395bc6a23f643dc9/src%2Ftest%2Fui%2Fsimd-intrinsic%2Fsimd-intrinsic-generic-select.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/e41a14412e207aac5f7d686d395bc6a23f643dc9/src%2Ftest%2Fui%2Fsimd-intrinsic%2Fsimd-intrinsic-generic-select.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsimd-intrinsic%2Fsimd-intrinsic-generic-select.stderr?ref=e41a14412e207aac5f7d686d395bc6a23f643dc9", "patch": "@@ -22,11 +22,11 @@ error[E0511]: invalid monomorphization of `simd_select` intrinsic: expected SIMD\n LL |         simd_select(m4, 0u32, 1u32);\n    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n-error[E0511]: invalid monomorphization of `simd_select_bitmask` intrinsic: mismatched lengths: mask length `8` != other vector length `4`\n+error[E0511]: invalid monomorphization of `simd_select_bitmask` intrinsic: mismatched lengths: mask length `16` != other vector length `4`\n   --> $DIR/simd-intrinsic-generic-select.rs:52:9\n    |\n-LL |         simd_select_bitmask(0u8, x, x);\n-   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+LL |         simd_select_bitmask(0u16, x, x);\n+   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n error[E0511]: invalid monomorphization of `simd_select_bitmask` intrinsic: expected SIMD argument type, found non-SIMD `u32`\n   --> $DIR/simd-intrinsic-generic-select.rs:55:9"}, {"sha": "b850cf9750a1f665767945c7fcfe53336cd57f8a", "filename": "src/test/ui/simd/simd-intrinsic-generic-select.rs", "status": "modified", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/e41a14412e207aac5f7d686d395bc6a23f643dc9/src%2Ftest%2Fui%2Fsimd%2Fsimd-intrinsic-generic-select.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e41a14412e207aac5f7d686d395bc6a23f643dc9/src%2Ftest%2Fui%2Fsimd%2Fsimd-intrinsic-generic-select.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsimd%2Fsimd-intrinsic-generic-select.rs?ref=e41a14412e207aac5f7d686d395bc6a23f643dc9", "patch": "@@ -167,4 +167,29 @@ fn main() {\n         let e = u32x8(8, 9, 10, 11, 4, 5, 6, 7);\n         assert_eq!(r, e);\n     }\n+\n+    unsafe {\n+        let a = u32x4(0, 1, 2, 3);\n+        let b = u32x4(4, 5, 6, 7);\n+\n+        let r: u32x4 = simd_select_bitmask(0u8, a, b);\n+        let e = b;\n+        assert_eq!(r, e);\n+\n+        let r: u32x4 = simd_select_bitmask(0xfu8, a, b);\n+        let e = a;\n+        assert_eq!(r, e);\n+\n+        let r: u32x4 = simd_select_bitmask(0b0101u8, a, b);\n+        let e = u32x4(0, 5, 2, 7);\n+        assert_eq!(r, e);\n+\n+        let r: u32x4 = simd_select_bitmask(0b1010u8, a, b);\n+        let e = u32x4(4, 1, 6, 3);\n+        assert_eq!(r, e);\n+\n+        let r: u32x4 = simd_select_bitmask(0b1100u8, a, b);\n+        let e = u32x4(4, 5, 2, 3);\n+        assert_eq!(r, e);\n+    }\n }"}]}