{"sha": "34eb2c1d4ff61693ab45863ee0f9ee298148a1ab", "node_id": "MDY6Q29tbWl0NzI0NzEyOjM0ZWIyYzFkNGZmNjE2OTNhYjQ1ODYzZWUwZjllZTI5ODE0OGExYWI=", "commit": {"author": {"name": "Matthew Jasper", "email": "mjjasper1@gmail.com", "date": "2020-04-22T20:40:18Z"}, "committer": {"name": "Matthew Jasper", "email": "mjjasper1@gmail.com", "date": "2020-05-02T10:11:17Z"}, "message": "Report cannot move errors in promoted MIR", "tree": {"sha": "e050c60c205f3ce12bf18531caff8a4c40b7c29b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e050c60c205f3ce12bf18531caff8a4c40b7c29b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/34eb2c1d4ff61693ab45863ee0f9ee298148a1ab", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/34eb2c1d4ff61693ab45863ee0f9ee298148a1ab", "html_url": "https://github.com/rust-lang/rust/commit/34eb2c1d4ff61693ab45863ee0f9ee298148a1ab", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/34eb2c1d4ff61693ab45863ee0f9ee298148a1ab/comments", "author": {"login": "matthewjasper", "id": 20113453, "node_id": "MDQ6VXNlcjIwMTEzNDUz", "avatar_url": "https://avatars.githubusercontent.com/u/20113453?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthewjasper", "html_url": "https://github.com/matthewjasper", "followers_url": "https://api.github.com/users/matthewjasper/followers", "following_url": "https://api.github.com/users/matthewjasper/following{/other_user}", "gists_url": "https://api.github.com/users/matthewjasper/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthewjasper/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthewjasper/subscriptions", "organizations_url": "https://api.github.com/users/matthewjasper/orgs", "repos_url": "https://api.github.com/users/matthewjasper/repos", "events_url": "https://api.github.com/users/matthewjasper/events{/privacy}", "received_events_url": "https://api.github.com/users/matthewjasper/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matthewjasper", "id": 20113453, "node_id": "MDQ6VXNlcjIwMTEzNDUz", "avatar_url": "https://avatars.githubusercontent.com/u/20113453?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthewjasper", "html_url": "https://github.com/matthewjasper", "followers_url": "https://api.github.com/users/matthewjasper/followers", "following_url": "https://api.github.com/users/matthewjasper/following{/other_user}", "gists_url": "https://api.github.com/users/matthewjasper/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthewjasper/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthewjasper/subscriptions", "organizations_url": "https://api.github.com/users/matthewjasper/orgs", "repos_url": "https://api.github.com/users/matthewjasper/repos", "events_url": "https://api.github.com/users/matthewjasper/events{/privacy}", "received_events_url": "https://api.github.com/users/matthewjasper/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ec1f28f9614292c36b371d3758afffdd52cb9786", "url": "https://api.github.com/repos/rust-lang/rust/commits/ec1f28f9614292c36b371d3758afffdd52cb9786", "html_url": "https://github.com/rust-lang/rust/commit/ec1f28f9614292c36b371d3758afffdd52cb9786"}], "stats": {"total": 99, "additions": 93, "deletions": 6}, "files": [{"sha": "a548b6b4c37cd7c6cd80c79282add440eda3a97c", "filename": "src/librustc_mir/borrow_check/mod.rs", "status": "modified", "additions": 42, "deletions": 6, "changes": 48, "blob_url": "https://github.com/rust-lang/rust/blob/34eb2c1d4ff61693ab45863ee0f9ee298148a1ab/src%2Flibrustc_mir%2Fborrow_check%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/34eb2c1d4ff61693ab45863ee0f9ee298148a1ab/src%2Flibrustc_mir%2Fborrow_check%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fborrow_check%2Fmod.rs?ref=34eb2c1d4ff61693ab45863ee0f9ee298148a1ab", "patch": "@@ -180,11 +180,14 @@ fn do_mir_borrowck<'a, 'tcx>(\n     let location_table = &LocationTable::new(&body);\n \n     let mut errors_buffer = Vec::new();\n-    let (move_data, move_errors): (MoveData<'tcx>, Option<Vec<(Place<'tcx>, MoveError<'tcx>)>>) =\n+    let (move_data, move_errors): (MoveData<'tcx>, Vec<(Place<'tcx>, MoveError<'tcx>)>) =\n         match MoveData::gather_moves(&body, tcx, param_env) {\n-            Ok(move_data) => (move_data, None),\n-            Err((move_data, move_errors)) => (move_data, Some(move_errors)),\n+            Ok(move_data) => (move_data, Vec::new()),\n+            Err((move_data, move_errors)) => (move_data, move_errors),\n         };\n+    let promoted_errors = promoted\n+        .iter_enumerated()\n+        .map(|(idx, body)| (idx, MoveData::gather_moves(&body, tcx, param_env)));\n \n     let mdpe = MoveDataParamEnv { move_data, param_env };\n \n@@ -264,6 +267,41 @@ fn do_mir_borrowck<'a, 'tcx>(\n         _ => true,\n     };\n \n+    for (idx, move_data_results) in promoted_errors {\n+        let promoted_body = &promoted[idx];\n+        let dominators = promoted_body.dominators();\n+\n+        if let Err((move_data, move_errors)) = move_data_results {\n+            let mut promoted_mbcx = MirBorrowckCtxt {\n+                infcx,\n+                body: promoted_body,\n+                mir_def_id: def_id.to_def_id(),\n+                move_data: &move_data,\n+                location_table: &LocationTable::new(promoted_body),\n+                movable_generator,\n+                locals_are_invalidated_at_exit,\n+                access_place_error_reported: Default::default(),\n+                reservation_error_reported: Default::default(),\n+                reservation_warnings: Default::default(),\n+                move_error_reported: BTreeMap::new(),\n+                uninitialized_error_reported: Default::default(),\n+                errors_buffer,\n+                regioncx: regioncx.clone(),\n+                used_mut: Default::default(),\n+                used_mut_upvars: SmallVec::new(),\n+                borrow_set: borrow_set.clone(),\n+                dominators,\n+                upvars: Vec::new(),\n+                local_names: IndexVec::from_elem(None, &promoted_body.local_decls),\n+                region_names: RefCell::default(),\n+                next_region_name: RefCell::new(1),\n+                polonius_output: None,\n+            };\n+            promoted_mbcx.report_move_errors(move_errors);\n+            errors_buffer = promoted_mbcx.errors_buffer;\n+        };\n+    }\n+\n     let dominators = body.dominators();\n \n     let mut mbcx = MirBorrowckCtxt {\n@@ -301,9 +339,7 @@ fn do_mir_borrowck<'a, 'tcx>(\n         borrows: flow_borrows,\n     };\n \n-    if let Some(errors) = move_errors {\n-        mbcx.report_move_errors(errors);\n-    }\n+    mbcx.report_move_errors(move_errors);\n \n     dataflow::visit_results(\n         &body,"}, {"sha": "13da34f3922c2516ef0c8baec99da3c85b849c93", "filename": "src/test/ui/borrowck/move-error-in-promoted-2.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/34eb2c1d4ff61693ab45863ee0f9ee298148a1ab/src%2Ftest%2Fui%2Fborrowck%2Fmove-error-in-promoted-2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/34eb2c1d4ff61693ab45863ee0f9ee298148a1ab/src%2Ftest%2Fui%2Fborrowck%2Fmove-error-in-promoted-2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fborrowck%2Fmove-error-in-promoted-2.rs?ref=34eb2c1d4ff61693ab45863ee0f9ee298148a1ab", "patch": "@@ -0,0 +1,10 @@\n+// Regression test for #70934\n+\n+struct S;\n+\n+fn foo() {\n+    &([S][0],);\n+    //~^ ERROR cannot move out of type `[S; 1]`\n+}\n+\n+fn main() {}"}, {"sha": "38dba94bdd41b53a133db1f586fe4833574d7844", "filename": "src/test/ui/borrowck/move-error-in-promoted-2.stderr", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/34eb2c1d4ff61693ab45863ee0f9ee298148a1ab/src%2Ftest%2Fui%2Fborrowck%2Fmove-error-in-promoted-2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/34eb2c1d4ff61693ab45863ee0f9ee298148a1ab/src%2Ftest%2Fui%2Fborrowck%2Fmove-error-in-promoted-2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fborrowck%2Fmove-error-in-promoted-2.stderr?ref=34eb2c1d4ff61693ab45863ee0f9ee298148a1ab", "patch": "@@ -0,0 +1,12 @@\n+error[E0508]: cannot move out of type `[S; 1]`, a non-copy array\n+  --> $DIR/move-error-in-promoted-2.rs:6:7\n+   |\n+LL |     &([S][0],);\n+   |       ^^^^^^\n+   |       |\n+   |       cannot move out of here\n+   |       move occurs because value has type `S`, which does not implement the `Copy` trait\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0508`."}, {"sha": "b94db6451312390ec185701c857c287881b43a60", "filename": "src/test/ui/borrowck/move-error-in-promoted.rs", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/34eb2c1d4ff61693ab45863ee0f9ee298148a1ab/src%2Ftest%2Fui%2Fborrowck%2Fmove-error-in-promoted.rs", "raw_url": "https://github.com/rust-lang/rust/raw/34eb2c1d4ff61693ab45863ee0f9ee298148a1ab/src%2Ftest%2Fui%2Fborrowck%2Fmove-error-in-promoted.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fborrowck%2Fmove-error-in-promoted.rs?ref=34eb2c1d4ff61693ab45863ee0f9ee298148a1ab", "patch": "@@ -0,0 +1,17 @@\n+// Regression test for #70934\n+\n+fn f() {\n+    const C: [S2; 1] = [S2];\n+    let _ = S1(C[0]).clone();\n+    //~^ ERROR cannot move out of type `[S2; 1]`\n+}\n+\n+#[derive(Clone)]\n+struct S1(S2);\n+\n+#[derive(Clone)]\n+struct S2;\n+\n+fn main() {\n+    f();\n+}"}, {"sha": "a4432e38da0e457141c36fc4667c2da82b86e8dd", "filename": "src/test/ui/borrowck/move-error-in-promoted.stderr", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/34eb2c1d4ff61693ab45863ee0f9ee298148a1ab/src%2Ftest%2Fui%2Fborrowck%2Fmove-error-in-promoted.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/34eb2c1d4ff61693ab45863ee0f9ee298148a1ab/src%2Ftest%2Fui%2Fborrowck%2Fmove-error-in-promoted.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fborrowck%2Fmove-error-in-promoted.stderr?ref=34eb2c1d4ff61693ab45863ee0f9ee298148a1ab", "patch": "@@ -0,0 +1,12 @@\n+error[E0508]: cannot move out of type `[S2; 1]`, a non-copy array\n+  --> $DIR/move-error-in-promoted.rs:5:16\n+   |\n+LL |     let _ = S1(C[0]).clone();\n+   |                ^^^^\n+   |                |\n+   |                cannot move out of here\n+   |                move occurs because value has type `S2`, which does not implement the `Copy` trait\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0508`."}]}