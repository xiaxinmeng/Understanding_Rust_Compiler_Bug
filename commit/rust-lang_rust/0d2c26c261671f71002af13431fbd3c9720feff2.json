{"sha": "0d2c26c261671f71002af13431fbd3c9720feff2", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBkMmMyNmMyNjE2NzFmNzEwMDJhZjEzNDMxZmJkM2M5NzIwZmVmZjI=", "commit": {"author": {"name": "Eduard Burtescu", "email": "edy.burt@gmail.com", "date": "2016-05-16T17:05:43Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2016-05-19T22:32:03Z"}, "message": "Mark the metadata symbol as reachable to fix OSX not finding dylibs.", "tree": {"sha": "29da516f1e9fe87e252d8dc47da6ea660f003226", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/29da516f1e9fe87e252d8dc47da6ea660f003226"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0d2c26c261671f71002af13431fbd3c9720feff2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0d2c26c261671f71002af13431fbd3c9720feff2", "html_url": "https://github.com/rust-lang/rust/commit/0d2c26c261671f71002af13431fbd3c9720feff2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0d2c26c261671f71002af13431fbd3c9720feff2/comments", "author": {"login": "eddyb", "id": 77424, "node_id": "MDQ6VXNlcjc3NDI0", "avatar_url": "https://avatars.githubusercontent.com/u/77424?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eddyb", "html_url": "https://github.com/eddyb", "followers_url": "https://api.github.com/users/eddyb/followers", "following_url": "https://api.github.com/users/eddyb/following{/other_user}", "gists_url": "https://api.github.com/users/eddyb/gists{/gist_id}", "starred_url": "https://api.github.com/users/eddyb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eddyb/subscriptions", "organizations_url": "https://api.github.com/users/eddyb/orgs", "repos_url": "https://api.github.com/users/eddyb/repos", "events_url": "https://api.github.com/users/eddyb/events{/privacy}", "received_events_url": "https://api.github.com/users/eddyb/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "07d373f3d6e616058864afd963f6f7bb518249a4", "url": "https://api.github.com/repos/rust-lang/rust/commits/07d373f3d6e616058864afd963f6f7bb518249a4", "html_url": "https://github.com/rust-lang/rust/commit/07d373f3d6e616058864afd963f6f7bb518249a4"}], "stats": {"total": 14, "additions": 11, "deletions": 3}, "files": [{"sha": "942975e971966cfb5b8662349aef8a4815429b89", "filename": "src/librustc_trans/base.rs", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/0d2c26c261671f71002af13431fbd3c9720feff2/src%2Flibrustc_trans%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0d2c26c261671f71002af13431fbd3c9720feff2/src%2Flibrustc_trans%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Fbase.rs?ref=0d2c26c261671f71002af13431fbd3c9720feff2", "patch": "@@ -2508,9 +2508,7 @@ pub fn write_metadata<'a, 'tcx>(cx: &SharedCrateContext<'a, 'tcx>,\n \n     let llmeta = C_bytes_in_context(cx.metadata_llcx(), &compressed[..]);\n     let llconst = C_struct_in_context(cx.metadata_llcx(), &[llmeta], false);\n-    let name = format!(\"rust_metadata_{}_{}\",\n-                       cx.link_meta().crate_name,\n-                       cx.link_meta().crate_hash);\n+    let name = cx.metadata_symbol_name();\n     let buf = CString::new(name).unwrap();\n     let llglobal = unsafe {\n         llvm::LLVMAddGlobal(cx.metadata_llmod(), val_ty(llconst).to_ref(), buf.as_ptr())\n@@ -2812,6 +2810,10 @@ pub fn trans_crate<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>,\n         reachable_symbols.push(\"main\".to_string());\n     }\n \n+    if sess.crate_types.borrow().contains(&config::CrateTypeDylib) {\n+        reachable_symbols.push(shared_ccx.metadata_symbol_name());\n+    }\n+\n     // For the purposes of LTO or when creating a cdylib, we add to the\n     // reachable set all of the upstream reachable extern fns. These functions\n     // are all part of the public ABI of the final product, so we need to"}, {"sha": "4d6c4cdcc6b072f5df36d090664561aa1f82dea8", "filename": "src/librustc_trans/context.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/0d2c26c261671f71002af13431fbd3c9720feff2/src%2Flibrustc_trans%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0d2c26c261671f71002af13431fbd3c9720feff2/src%2Flibrustc_trans%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Fcontext.rs?ref=0d2c26c261671f71002af13431fbd3c9720feff2", "patch": "@@ -503,6 +503,12 @@ impl<'b, 'tcx> SharedCrateContext<'b, 'tcx> {\n             Substs::new(VecPerParamSpace::empty(),\n                         scheme.generics.regions.map(|_| ty::ReStatic)))\n     }\n+\n+    pub fn metadata_symbol_name(&self) -> String {\n+        format!(\"rust_metadata_{}_{}\",\n+                self.link_meta().crate_name,\n+                self.link_meta().crate_hash)\n+    }\n }\n \n impl<'tcx> LocalCrateContext<'tcx> {"}]}