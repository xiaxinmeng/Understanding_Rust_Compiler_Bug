{"sha": "9bbef13702561b955bc1fd71608502d3a10a4acc", "node_id": "MDY6Q29tbWl0NzI0NzEyOjliYmVmMTM3MDI1NjFiOTU1YmMxZmQ3MTYwODUwMmQzYTEwYTRhY2M=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-12-13T08:32:47Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-12-13T08:32:47Z"}, "message": "auto merge of #10698 : metajack/rust/dep-info, r=alexcrichton\n\nThis isn't super useful for libraries yet without #10593.\r\n\r\nFixes #7633.", "tree": {"sha": "1ebb348561548fd71107547a85b4738e2ff35e54", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1ebb348561548fd71107547a85b4738e2ff35e54"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9bbef13702561b955bc1fd71608502d3a10a4acc", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9bbef13702561b955bc1fd71608502d3a10a4acc", "html_url": "https://github.com/rust-lang/rust/commit/9bbef13702561b955bc1fd71608502d3a10a4acc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9bbef13702561b955bc1fd71608502d3a10a4acc/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "09bb3c0c4bb8d174b783d3bfd3c0cdf06b2fa013", "url": "https://api.github.com/repos/rust-lang/rust/commits/09bb3c0c4bb8d174b783d3bfd3c0cdf06b2fa013", "html_url": "https://github.com/rust-lang/rust/commit/09bb3c0c4bb8d174b783d3bfd3c0cdf06b2fa013"}, {"sha": "b2ccd4c3ec099b57fbcdb7dbc36cdb08c9016b4a", "url": "https://api.github.com/repos/rust-lang/rust/commits/b2ccd4c3ec099b57fbcdb7dbc36cdb08c9016b4a", "html_url": "https://github.com/rust-lang/rust/commit/b2ccd4c3ec099b57fbcdb7dbc36cdb08c9016b4a"}], "stats": {"total": 99, "additions": 90, "deletions": 9}, "files": [{"sha": "838a5aa8943d330b20f50f9506945080b719d3b9", "filename": "src/librustc/back/link.rs", "status": "modified", "additions": 9, "deletions": 3, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/9bbef13702561b955bc1fd71608502d3a10a4acc/src%2Flibrustc%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9bbef13702561b955bc1fd71608502d3a10a4acc/src%2Flibrustc%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fback%2Flink.rs?ref=9bbef13702561b955bc1fd71608502d3a10a4acc", "patch": "@@ -721,7 +721,7 @@ pub fn link_binary(sess: Session,\n                    trans: &CrateTranslation,\n                    obj_filename: &Path,\n                    out_filename: &Path,\n-                   lm: &LinkMeta) {\n+                   lm: &LinkMeta) -> ~[Path] {\n     // If we're generating a test executable, then ignore all other output\n     // styles at all other locations\n     let outputs = if sess.opts.test {\n@@ -730,15 +730,19 @@ pub fn link_binary(sess: Session,\n         (*sess.outputs).clone()\n     };\n \n+    let mut out_filenames = ~[];\n     for output in outputs.move_iter() {\n-        link_binary_output(sess, trans, output, obj_filename, out_filename, lm);\n+        let out_file = link_binary_output(sess, trans, output, obj_filename, out_filename, lm);\n+        out_filenames.push(out_file);\n     }\n \n     // Remove the temporary object file and metadata if we aren't saving temps\n     if !sess.opts.save_temps {\n         fs::unlink(obj_filename);\n         fs::unlink(&obj_filename.with_extension(\"metadata.o\"));\n     }\n+\n+    out_filenames\n }\n \n fn is_writeable(p: &Path) -> bool {\n@@ -755,7 +759,7 @@ fn link_binary_output(sess: Session,\n                       output: session::OutputStyle,\n                       obj_filename: &Path,\n                       out_filename: &Path,\n-                      lm: &LinkMeta) {\n+                      lm: &LinkMeta) -> Path {\n     let libname = output_lib_filename(lm);\n     let out_filename = match output {\n         session::OutputRlib => {\n@@ -812,6 +816,8 @@ fn link_binary_output(sess: Session,\n             link_natively(sess, true, obj_filename, &out_filename);\n         }\n     }\n+\n+    out_filename\n }\n \n // Create an 'rlib'"}, {"sha": "6206b4efa321d813af5de85973a938e10195559d", "filename": "src/librustc/driver/driver.rs", "status": "modified", "additions": 28, "deletions": 3, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/9bbef13702561b955bc1fd71608502d3a10a4acc/src%2Flibrustc%2Fdriver%2Fdriver.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9bbef13702561b955bc1fd71608502d3a10a4acc/src%2Flibrustc%2Fdriver%2Fdriver.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fdriver%2Fdriver.rs?ref=9bbef13702561b955bc1fd71608502d3a10a4acc", "patch": "@@ -384,13 +384,34 @@ pub fn phase_5_run_llvm_passes(sess: Session,\n /// This should produce either a finished executable or library.\n pub fn phase_6_link_output(sess: Session,\n                            trans: &CrateTranslation,\n+                           input: &input,\n                            outputs: &OutputFilenames) {\n-    time(sess.time_passes(), \"linking\", (), |_|\n+    let outputs = time(sess.time_passes(), \"linking\", (), |_|\n          link::link_binary(sess,\n                            trans,\n                            &outputs.obj_filename,\n                            &outputs.out_filename,\n                            &trans.link));\n+\n+    // Write out dependency rules to the .d file if requested\n+    if sess.opts.write_dependency_info {\n+        match *input {\n+            file_input(ref input_path) => {\n+                let files: ~[@str] = sess.codemap.files.iter()\n+                    .filter_map(|fmap| if fmap.is_real_file() { Some(fmap.name) } else { None })\n+                    .collect();\n+                let mut output_path = outputs[0].dir_path();\n+                let filestem = input_path.filestem().expect(\"input file must have stem\");\n+                output_path.push(Path::new(filestem).with_extension(\"d\"));\n+                let mut file = io::File::create(&output_path);\n+                for output in outputs.iter() {\n+                    write!(&mut file as &mut Writer,\n+                           \"{}: {}\\n\\n\", output.display(), files.connect(\" \"));\n+                }\n+            }\n+            str_input(_) => {}\n+        }\n+    }\n }\n \n pub fn stop_after_phase_3(sess: Session) -> bool {\n@@ -438,7 +459,7 @@ pub fn compile_input(sess: Session, cfg: ast::CrateConfig, input: &input,\n     };\n     phase_5_run_llvm_passes(sess, &trans, outputs);\n     if stop_after_phase_5(sess) { return; }\n-    phase_6_link_output(sess, &trans, outputs);\n+    phase_6_link_output(sess, &trans, input, outputs);\n }\n \n struct IdentifiedAnnotation {\n@@ -750,6 +771,7 @@ pub fn build_session_options(binary: @str,\n     let cfg = parse_cfgspecs(matches.opt_strs(\"cfg\"), demitter);\n     let test = matches.opt_present(\"test\");\n     let android_cross_path = matches.opt_str(\"android-cross-path\");\n+    let write_dependency_info = matches.opt_present(\"dep-info\");\n \n     let custom_passes = match matches.opt_str(\"passes\") {\n         None => ~[],\n@@ -793,7 +815,8 @@ pub fn build_session_options(binary: @str,\n         parse_only: parse_only,\n         no_trans: no_trans,\n         debugging_opts: debugging_opts,\n-        android_cross_path: android_cross_path\n+        android_cross_path: android_cross_path,\n+        write_dependency_info: write_dependency_info,\n     };\n     return sopts;\n }\n@@ -902,6 +925,8 @@ pub fn optgroups() -> ~[getopts::groups::OptGroup] {\n                           or identified (fully parenthesized,\n                           AST nodes and blocks with IDs)\", \"TYPE\"),\n   optflag(\"S\", \"\",    \"Compile only; do not assemble or link\"),\n+  optflag(\"\", \"dep-info\",\n+                        \"Output dependency info to .d file after compiling\"),\n   optflag(\"\", \"save-temps\",\n                         \"Write intermediate files (.bc, .opt.bc, .o)\n                           in addition to normal output\"),"}, {"sha": "d12e06fab3fc73023bcb5e7f8c55f8b0b37e03c5", "filename": "src/librustc/driver/session.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/9bbef13702561b955bc1fd71608502d3a10a4acc/src%2Flibrustc%2Fdriver%2Fsession.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9bbef13702561b955bc1fd71608502d3a10a4acc/src%2Flibrustc%2Fdriver%2Fsession.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fdriver%2Fsession.rs?ref=9bbef13702561b955bc1fd71608502d3a10a4acc", "patch": "@@ -170,6 +170,8 @@ pub struct options {\n     no_trans: bool,\n     debugging_opts: uint,\n     android_cross_path: Option<~str>,\n+    // Whether to write .d dependency files\n+    write_dependency_info: bool,\n }\n \n pub struct crate_metadata {\n@@ -393,6 +395,7 @@ pub fn basic_options() -> @options {\n         no_trans: false,\n         debugging_opts: 0u,\n         android_cross_path: None,\n+        write_dependency_info: false,\n     }\n }\n "}, {"sha": "4b0de74a90fe1ea8891fd11807195309de117169", "filename": "src/librustpkg/util.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/9bbef13702561b955bc1fd71608502d3a10a4acc/src%2Flibrustpkg%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9bbef13702561b955bc1fd71608502d3a10a4acc/src%2Flibrustpkg%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustpkg%2Futil.rs?ref=9bbef13702561b955bc1fd71608502d3a10a4acc", "patch": "@@ -353,7 +353,8 @@ pub fn compile_crate_from_input(input: &Path,\n \n     // bad copy\n     debug!(\"out_dir = {}\", out_dir.display());\n-    let mut outputs = driver::build_output_filenames(&driver::file_input(input.clone()),\n+    let file_input = driver::file_input(input.clone());\n+    let mut outputs = driver::build_output_filenames(&file_input,\n                                                      &Some(out_dir.clone()), &None,\n                                                      crate.attrs, sess);\n     match what {\n@@ -388,7 +389,7 @@ pub fn compile_crate_from_input(input: &Path,\n     // -c\n     if driver::stop_after_phase_5(sess)\n         || stop_before == Link || stop_before == Assemble { return Some(outputs.out_filename); }\n-    driver::phase_6_link_output(sess, &translation, outputs);\n+    driver::phase_6_link_output(sess, &translation, &file_input, outputs);\n \n     // Register dependency on the source file\n     // FIXME (#9639): This needs to handle non-utf8 paths"}, {"sha": "0509760120a428ba2bcc176fd3b1e087a4d392f4", "filename": "src/libsyntax/codemap.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/9bbef13702561b955bc1fd71608502d3a10a4acc/src%2Flibsyntax%2Fcodemap.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9bbef13702561b955bc1fd71608502d3a10a4acc/src%2Flibsyntax%2Fcodemap.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fcodemap.rs?ref=9bbef13702561b955bc1fd71608502d3a10a4acc", "patch": "@@ -260,6 +260,10 @@ impl FileMap {\n         };\n         self.multibyte_chars.push(mbc);\n     }\n+\n+    pub fn is_real_file(&self) -> bool {\n+        !(self.name.starts_with(\"<\") && self.name.ends_with(\">\"))\n+    }\n }\n \n pub struct CodeMap {"}, {"sha": "2fcf6f1cad02501c281a66c43809fc52fa201d0d", "filename": "src/libsyntax/ext/source_util.rs", "status": "modified", "additions": 15, "deletions": 1, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/9bbef13702561b955bc1fd71608502d3a10a4acc/src%2Flibsyntax%2Fext%2Fsource_util.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9bbef13702561b955bc1fd71608502d3a10a4acc/src%2Flibsyntax%2Fext%2Fsource_util.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fsource_util.rs?ref=9bbef13702561b955bc1fd71608502d3a10a4acc", "patch": "@@ -80,6 +80,7 @@ pub fn expand_mod(cx: @ExtCtxt, sp: Span, tts: &[ast::token_tree])\n pub fn expand_include(cx: @ExtCtxt, sp: Span, tts: &[ast::token_tree])\n     -> base::MacResult {\n     let file = get_single_str_from_tts(cx, sp, tts, \"include!\");\n+    // The file will be added to the code map by the parser\n     let p = parse::new_sub_parser_from_file(\n         cx.parse_sess(), cx.cfg(),\n         &res_rel_file(cx, sp, &Path::new(file)), sp);\n@@ -99,7 +100,20 @@ pub fn expand_include_str(cx: @ExtCtxt, sp: Span, tts: &[ast::token_tree])\n         Ok(bytes) => bytes,\n     };\n     match str::from_utf8_owned_opt(bytes) {\n-        Some(s) => base::MRExpr(cx.expr_str(sp, s.to_managed())),\n+        Some(s) => {\n+            let s = s.to_managed();\n+            // Add this input file to the code map to make it available as\n+            // dependency information\n+            cx.parse_sess.cm.files.push(@codemap::FileMap {\n+                name: file.display().to_str().to_managed(),\n+                substr: codemap::FssNone,\n+                src: s,\n+                start_pos: codemap::BytePos(0),\n+                lines: @mut ~[],\n+                multibyte_chars: @mut ~[],\n+            });\n+            base::MRExpr(cx.expr_str(sp, s))\n+        }\n         None => {\n             cx.span_fatal(sp, format!(\"{} wasn't a utf-8 file\", file.display()));\n         }"}, {"sha": "535cda4d80b9e987d64500e70121a5eae8d20c6c", "filename": "src/test/run-make/dep-info/Makefile", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/9bbef13702561b955bc1fd71608502d3a10a4acc/src%2Ftest%2Frun-make%2Fdep-info%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/9bbef13702561b955bc1fd71608502d3a10a4acc/src%2Ftest%2Frun-make%2Fdep-info%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fdep-info%2FMakefile?ref=9bbef13702561b955bc1fd71608502d3a10a4acc", "patch": "@@ -0,0 +1,11 @@\n+-include ../tools.mk\n+all:\n+\t$(RUSTC) --dep-info --lib lib.rs\n+\tsleep 1\n+\ttouch foo.rs\n+\t-rm -f $(TMPDIR)/done\n+\t$(MAKE) -f Makefile.foo\n+\trm $(TMPDIR)/done\n+\tpwd\n+\t$(MAKE) -df Makefile.foo\n+\trm $(TMPDIR)/done && exit 1 || exit 0"}, {"sha": "3e009828c0c49d8a5c39c190dc9c39c152612f4a", "filename": "src/test/run-make/dep-info/Makefile.foo", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/9bbef13702561b955bc1fd71608502d3a10a4acc/src%2Ftest%2Frun-make%2Fdep-info%2FMakefile.foo", "raw_url": "https://github.com/rust-lang/rust/raw/9bbef13702561b955bc1fd71608502d3a10a4acc/src%2Ftest%2Frun-make%2Fdep-info%2FMakefile.foo", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fdep-info%2FMakefile.foo?ref=9bbef13702561b955bc1fd71608502d3a10a4acc", "patch": "@@ -0,0 +1,11 @@\n+ifeq ($(shell uname),Darwin)\n+LIBEXT=dylib\n+else\n+LIBEXT=so\n+endif\n+\n+$(TMPDIR)/libfoo-b517899a-0.1.$(LIBEXT):\n+\t$(RUSTC) --dep-info --lib lib.rs\n+\ttouch $(TMPDIR)/done\n+\n+-include $(TMPDIR)/lib.d"}, {"sha": "c5c0bc606cd699cda9d339035a1ca95bff4a70f4", "filename": "src/test/run-make/dep-info/bar.rs", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/9bbef13702561b955bc1fd71608502d3a10a4acc/src%2Ftest%2Frun-make%2Fdep-info%2Fbar.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9bbef13702561b955bc1fd71608502d3a10a4acc/src%2Ftest%2Frun-make%2Fdep-info%2Fbar.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fdep-info%2Fbar.rs?ref=9bbef13702561b955bc1fd71608502d3a10a4acc", "patch": "@@ -0,0 +1 @@\n+pub fn bar() {}"}, {"sha": "b76b4321d62aa8e066b24d213c79ccc8230b8d7b", "filename": "src/test/run-make/dep-info/foo.rs", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/9bbef13702561b955bc1fd71608502d3a10a4acc/src%2Ftest%2Frun-make%2Fdep-info%2Ffoo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9bbef13702561b955bc1fd71608502d3a10a4acc/src%2Ftest%2Frun-make%2Fdep-info%2Ffoo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fdep-info%2Ffoo.rs?ref=9bbef13702561b955bc1fd71608502d3a10a4acc", "patch": "@@ -0,0 +1 @@\n+pub fn foo() {}"}, {"sha": "d08a0fbcb6079bc7cb88f887e851a238bed9e0dd", "filename": "src/test/run-make/dep-info/lib.rs", "status": "added", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/9bbef13702561b955bc1fd71608502d3a10a4acc/src%2Ftest%2Frun-make%2Fdep-info%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9bbef13702561b955bc1fd71608502d3a10a4acc/src%2Ftest%2Frun-make%2Fdep-info%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fdep-info%2Flib.rs?ref=9bbef13702561b955bc1fd71608502d3a10a4acc", "patch": "@@ -0,0 +1,4 @@\n+#[pkgid=\"foo#0.1\"];\n+\n+pub mod foo;\n+pub mod bar;"}]}