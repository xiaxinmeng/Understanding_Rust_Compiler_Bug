{"sha": "49fd71bea7bd3d8d11818503ca048227ffa1e758", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQ5ZmQ3MWJlYTdiZDNkOGQxMTgxODUwM2NhMDQ4MjI3ZmZhMWU3NTg=", "commit": {"author": {"name": "Wesley Wiser", "email": "wwiser@gmail.com", "date": "2018-03-23T02:25:57Z"}, "committer": {"name": "Wesley Wiser", "email": "wwiser@gmail.com", "date": "2018-03-28T12:30:09Z"}, "message": "[incremental] Don't panic if decoding the cache fails\n\nIf the cached data can't be loaded from disk, just issue a warning to\nthe user so they know why compilation is taking longer than usual but\ndon't fail the entire compilation since we can recover by ignorning the\non disk cache.\n\nIn the same way, if the disk cache can't be deserialized (because it has\nbeen corrupted for some reason), report the issue as a warning and\ncontinue without failing the compilation. `Decodable::decode()` tends to\npanic with various errors like \"entered unreachable code\" or \"index out\nof range\" if the input data is corrupted. Work around this by catching\npanics from the `decode()` calls when joining the thread and continuing\nwithout the cached data.\n\nFixes #48847", "tree": {"sha": "3d9df20cc1247b5e409ca733f189a3ba083a404c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3d9df20cc1247b5e409ca733f189a3ba083a404c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/49fd71bea7bd3d8d11818503ca048227ffa1e758", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/49fd71bea7bd3d8d11818503ca048227ffa1e758", "html_url": "https://github.com/rust-lang/rust/commit/49fd71bea7bd3d8d11818503ca048227ffa1e758", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/49fd71bea7bd3d8d11818503ca048227ffa1e758/comments", "author": {"login": "wesleywiser", "id": 831192, "node_id": "MDQ6VXNlcjgzMTE5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/831192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wesleywiser", "html_url": "https://github.com/wesleywiser", "followers_url": "https://api.github.com/users/wesleywiser/followers", "following_url": "https://api.github.com/users/wesleywiser/following{/other_user}", "gists_url": "https://api.github.com/users/wesleywiser/gists{/gist_id}", "starred_url": "https://api.github.com/users/wesleywiser/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wesleywiser/subscriptions", "organizations_url": "https://api.github.com/users/wesleywiser/orgs", "repos_url": "https://api.github.com/users/wesleywiser/repos", "events_url": "https://api.github.com/users/wesleywiser/events{/privacy}", "received_events_url": "https://api.github.com/users/wesleywiser/received_events", "type": "User", "site_admin": false}, "committer": {"login": "wesleywiser", "id": 831192, "node_id": "MDQ6VXNlcjgzMTE5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/831192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wesleywiser", "html_url": "https://github.com/wesleywiser", "followers_url": "https://api.github.com/users/wesleywiser/followers", "following_url": "https://api.github.com/users/wesleywiser/following{/other_user}", "gists_url": "https://api.github.com/users/wesleywiser/gists{/gist_id}", "starred_url": "https://api.github.com/users/wesleywiser/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wesleywiser/subscriptions", "organizations_url": "https://api.github.com/users/wesleywiser/orgs", "repos_url": "https://api.github.com/users/wesleywiser/repos", "events_url": "https://api.github.com/users/wesleywiser/events{/privacy}", "received_events_url": "https://api.github.com/users/wesleywiser/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "482a913fb337855072a53c0d602cd19947f45285", "url": "https://api.github.com/repos/rust-lang/rust/commits/482a913fb337855072a53c0d602cd19947f45285", "html_url": "https://github.com/rust-lang/rust/commit/482a913fb337855072a53c0d602cd19947f45285"}], "stats": {"total": 9, "additions": 7, "deletions": 2}, "files": [{"sha": "c6ebc99268057c4bbfd361291e6d35cd486408a9", "filename": "src/librustc_driver/driver.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/49fd71bea7bd3d8d11818503ca048227ffa1e758/src%2Flibrustc_driver%2Fdriver.rs", "raw_url": "https://github.com/rust-lang/rust/raw/49fd71bea7bd3d8d11818503ca048227ffa1e758/src%2Flibrustc_driver%2Fdriver.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_driver%2Fdriver.rs?ref=49fd71bea7bd3d8d11818503ca048227ffa1e758", "patch": "@@ -901,7 +901,9 @@ pub fn phase_2_configure_and_expand_inner<'a, F>(sess: &'a Session,\n         Some(future) => {\n             let prev_graph = time(sess, \"blocked while dep-graph loading finishes\", || {\n                 future.open()\n-                      .expect(\"Could not join with background dep_graph thread\")\n+                      .unwrap_or_else(|e| rustc_incremental::LoadResult::Error {\n+                          message: format!(\"could not decode incremental cache: {:?}\", e)\n+                      })\n                       .open(sess)\n             });\n             DepGraph::new(prev_graph)"}, {"sha": "4b524287ca1c7364f2eba1b4c31ceeaca29b0fc5", "filename": "src/librustc_incremental/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/49fd71bea7bd3d8d11818503ca048227ffa1e758/src%2Flibrustc_incremental%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/49fd71bea7bd3d8d11818503ca048227ffa1e758/src%2Flibrustc_incremental%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_incremental%2Flib.rs?ref=49fd71bea7bd3d8d11818503ca048227ffa1e758", "patch": "@@ -39,6 +39,7 @@ pub use assert_dep_graph::assert_dep_graph;\n pub use persist::dep_graph_tcx_init;\n pub use persist::load_dep_graph;\n pub use persist::load_query_result_cache;\n+pub use persist::LoadResult;\n pub use persist::save_dep_graph;\n pub use persist::save_trans_partition;\n pub use persist::save_work_products;"}, {"sha": "44d6e532f79bb4aa67b52c4446ac18dc665d4aef", "filename": "src/librustc_incremental/persist/load.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/49fd71bea7bd3d8d11818503ca048227ffa1e758/src%2Flibrustc_incremental%2Fpersist%2Fload.rs", "raw_url": "https://github.com/rust-lang/rust/raw/49fd71bea7bd3d8d11818503ca048227ffa1e758/src%2Flibrustc_incremental%2Fpersist%2Fload.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_incremental%2Fpersist%2Fload.rs?ref=49fd71bea7bd3d8d11818503ca048227ffa1e758", "patch": "@@ -89,7 +89,8 @@ impl LoadResult<PreviousDepGraph> {\n     pub fn open(self, sess: &Session) -> PreviousDepGraph {\n         match self {\n             LoadResult::Error { message } => {\n-                sess.fatal(&message) /* never returns */\n+                sess.warn(&message);\n+                PreviousDepGraph::new(SerializedDepGraph::new())\n             },\n             LoadResult::DataOutOfDate => {\n                 if let Err(err) = delete_all_session_dir_contents(sess) {"}, {"sha": "755a550b5bca31e4af3a120cd56d4b6ce22dd204", "filename": "src/librustc_incremental/persist/mod.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/49fd71bea7bd3d8d11818503ca048227ffa1e758/src%2Flibrustc_incremental%2Fpersist%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/49fd71bea7bd3d8d11818503ca048227ffa1e758/src%2Flibrustc_incremental%2Fpersist%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_incremental%2Fpersist%2Fmod.rs?ref=49fd71bea7bd3d8d11818503ca048227ffa1e758", "patch": "@@ -27,6 +27,7 @@ pub use self::fs::prepare_session_directory;\n pub use self::load::dep_graph_tcx_init;\n pub use self::load::load_dep_graph;\n pub use self::load::load_query_result_cache;\n+pub use self::load::LoadResult;\n pub use self::save::save_dep_graph;\n pub use self::save::save_work_products;\n pub use self::work_product::save_trans_partition;"}]}