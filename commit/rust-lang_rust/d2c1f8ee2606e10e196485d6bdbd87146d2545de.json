{"sha": "d2c1f8ee2606e10e196485d6bdbd87146d2545de", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQyYzFmOGVlMjYwNmUxMGUxOTY0ODVkNmJkYmQ4NzE0NmQyNTQ1ZGU=", "commit": {"author": {"name": "Edwin Cheng", "email": "edwin0cheng@gmail.com", "date": "2019-12-17T05:50:00Z"}, "committer": {"name": "Edwin Cheng", "email": "edwin0cheng@gmail.com", "date": "2019-12-18T02:47:45Z"}, "message": "Add macro span handling", "tree": {"sha": "f1470b1df2c364b9bfec83a2198c1b6a06d53833", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f1470b1df2c364b9bfec83a2198c1b6a06d53833"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d2c1f8ee2606e10e196485d6bdbd87146d2545de", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d2c1f8ee2606e10e196485d6bdbd87146d2545de", "html_url": "https://github.com/rust-lang/rust/commit/d2c1f8ee2606e10e196485d6bdbd87146d2545de", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d2c1f8ee2606e10e196485d6bdbd87146d2545de/comments", "author": {"login": "edwin0cheng", "id": 11014119, "node_id": "MDQ6VXNlcjExMDE0MTE5", "avatar_url": "https://avatars.githubusercontent.com/u/11014119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/edwin0cheng", "html_url": "https://github.com/edwin0cheng", "followers_url": "https://api.github.com/users/edwin0cheng/followers", "following_url": "https://api.github.com/users/edwin0cheng/following{/other_user}", "gists_url": "https://api.github.com/users/edwin0cheng/gists{/gist_id}", "starred_url": "https://api.github.com/users/edwin0cheng/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/edwin0cheng/subscriptions", "organizations_url": "https://api.github.com/users/edwin0cheng/orgs", "repos_url": "https://api.github.com/users/edwin0cheng/repos", "events_url": "https://api.github.com/users/edwin0cheng/events{/privacy}", "received_events_url": "https://api.github.com/users/edwin0cheng/received_events", "type": "User", "site_admin": false}, "committer": {"login": "edwin0cheng", "id": 11014119, "node_id": "MDQ6VXNlcjExMDE0MTE5", "avatar_url": "https://avatars.githubusercontent.com/u/11014119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/edwin0cheng", "html_url": "https://github.com/edwin0cheng", "followers_url": "https://api.github.com/users/edwin0cheng/followers", "following_url": "https://api.github.com/users/edwin0cheng/following{/other_user}", "gists_url": "https://api.github.com/users/edwin0cheng/gists{/gist_id}", "starred_url": "https://api.github.com/users/edwin0cheng/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/edwin0cheng/subscriptions", "organizations_url": "https://api.github.com/users/edwin0cheng/orgs", "repos_url": "https://api.github.com/users/edwin0cheng/repos", "events_url": "https://api.github.com/users/edwin0cheng/events{/privacy}", "received_events_url": "https://api.github.com/users/edwin0cheng/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ee93fac7767d36ee91d5a0029bb58023765c72d5", "url": "https://api.github.com/repos/rust-lang/rust/commits/ee93fac7767d36ee91d5a0029bb58023765c72d5", "html_url": "https://github.com/rust-lang/rust/commit/ee93fac7767d36ee91d5a0029bb58023765c72d5"}], "stats": {"total": 38, "additions": 38, "deletions": 0}, "files": [{"sha": "1f0c0d3e4057a85d6dcca373474b421f177c53be", "filename": "editors/code/src/utils/diagnostics/rust.ts", "status": "modified", "additions": 38, "deletions": 0, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/d2c1f8ee2606e10e196485d6bdbd87146d2545de/editors%2Fcode%2Fsrc%2Futils%2Fdiagnostics%2Frust.ts", "raw_url": "https://github.com/rust-lang/rust/raw/d2c1f8ee2606e10e196485d6bdbd87146d2545de/editors%2Fcode%2Fsrc%2Futils%2Fdiagnostics%2Frust.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Futils%2Fdiagnostics%2Frust.ts?ref=d2c1f8ee2606e10e196485d6bdbd87146d2545de", "patch": "@@ -10,6 +10,12 @@ export enum SuggestionApplicability {\n     Unspecified = 'Unspecified',\n }\n \n+export interface RustDiagnosticSpanMacroExpansion {\n+    span: RustDiagnosticSpan;\n+    macro_decl_name: string;\n+    def_site_span?: RustDiagnosticSpan;\n+}\n+\n // Reference:\n // https://github.com/rust-lang/rust/blob/master/src/libsyntax/json.rs\n export interface RustDiagnosticSpan {\n@@ -20,6 +26,7 @@ export interface RustDiagnosticSpan {\n     is_primary: boolean;\n     file_name: string;\n     label?: string;\n+    expansion?: RustDiagnosticSpanMacroExpansion;\n     suggested_replacement?: string;\n     suggestion_applicability?: SuggestionApplicability;\n }\n@@ -60,10 +67,41 @@ function mapLevelToSeverity(s: string): vscode.DiagnosticSeverity {\n     return vscode.DiagnosticSeverity.Information;\n }\n \n+/**\n+ * Check whether a file name is from macro invocation\n+ */\n+function isFromMacro(fileName: string): boolean {\n+    return fileName.startsWith('<') && fileName.endsWith('>');\n+}\n+\n+/**\n+ * Converts a Rust macro span to a VsCode location recursively\n+ */\n+function mapMacroSpanToLocation(\n+    spanMacro: RustDiagnosticSpanMacroExpansion,\n+): vscode.Location | undefined {\n+    if (!isFromMacro(spanMacro.span.file_name)) {\n+        return mapSpanToLocation(spanMacro.span);\n+    }\n+\n+    if (spanMacro.span.expansion) {\n+        return mapMacroSpanToLocation(spanMacro.span.expansion);\n+    }\n+\n+    return;\n+}\n+\n /**\n  * Converts a Rust span to a VsCode location\n  */\n function mapSpanToLocation(span: RustDiagnosticSpan): vscode.Location {\n+    if (isFromMacro(span.file_name) && span.expansion) {\n+        const macroLoc = mapMacroSpanToLocation(span.expansion);\n+        if (macroLoc) {\n+            return macroLoc;\n+        }\n+    }\n+\n     const fileName = path.join(vscode.workspace.rootPath || '', span.file_name);\n     const fileUri = vscode.Uri.file(fileName);\n "}]}