{"sha": "bf4a37d9611239fc89f25e0a9c47d71bd43f1450", "node_id": "MDY6Q29tbWl0NzI0NzEyOmJmNGEzN2Q5NjExMjM5ZmM4OWYyNWUwYTljNDdkNzFiZDQzZjE0NTA=", "commit": {"author": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2020-08-02T20:08:42Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-08-02T20:08:42Z"}, "message": "Rollup merge of #74980 - davidtwco:issue-74745-pprust-regression-test, r=petrochenkov\n\npprust: adjust mixed comment printing and add regression test for #74745\n\nFixes #74745.\n\nThis PR adds a regression test for #74745. While a `ignore-tidy-trailing-lines` header is required, this doesn't stop the test from reproducing, so long as there is no newline at the end of the file.\n\nHowever, adding the header comments made the test fail due to a bug in pprust - so this PR also  adjusts the pretty printing of mixed comments so that the initial zero-break isn't emitted at the beginning of the line. Through this, the `block-comment-wchar` test can have the `pp-exact` file removed, as it no longer converges from pretty printing of the source.", "tree": {"sha": "719cd7331192d4bd1c06a34f70b7cc5e2481903e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/719cd7331192d4bd1c06a34f70b7cc5e2481903e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bf4a37d9611239fc89f25e0a9c47d71bd43f1450", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfJx1KCRBK7hj4Ov3rIwAAdHIIAI+vgen8ZpeMg3UtG9xUy8GJ\nHMbRKFnh2/OYNfygsGmx9Ypj4bZr9g6P7Wue0JNeRbEF+Cu7EqfrAyCVGz1kT90c\nzsUOTUzj8PzR7NDq7REucPl9ekpnhyPF5luhqDcKUnGClpZpKmVUmYt5N63khqsi\nZuDaYvieZ8PKAhpHK8BGPfWETZs8+zNsPNWyW92dX3CsjcCe0NmRodHSYxWm37Yn\nvv+C09xjPCbjnfgPS97jYgWk3TKyrcs3+rWKtenqSHH0qvl90TSABmlUfOFQVBuJ\n8sdWrzS2krgYuiH1zn1gj7zGlpSKlxBIsRpj9tYuHtzbhPuxxhtOnYfQ9AElk0U=\n=hncS\n-----END PGP SIGNATURE-----\n", "payload": "tree 719cd7331192d4bd1c06a34f70b7cc5e2481903e\nparent 19cefa68640843956eedd86227ddc1d35dbc6754\nparent 1530563bd7a3880eec14d78e4a715c1bc4e24074\nauthor Manish Goregaokar <manishsmail@gmail.com> 1596398922 -0700\ncommitter GitHub <noreply@github.com> 1596398922 -0700\n\nRollup merge of #74980 - davidtwco:issue-74745-pprust-regression-test, r=petrochenkov\n\npprust: adjust mixed comment printing and add regression test for #74745\n\nFixes #74745.\n\nThis PR adds a regression test for #74745. While a `ignore-tidy-trailing-lines` header is required, this doesn't stop the test from reproducing, so long as there is no newline at the end of the file.\n\nHowever, adding the header comments made the test fail due to a bug in pprust - so this PR also  adjusts the pretty printing of mixed comments so that the initial zero-break isn't emitted at the beginning of the line. Through this, the `block-comment-wchar` test can have the `pp-exact` file removed, as it no longer converges from pretty printing of the source.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bf4a37d9611239fc89f25e0a9c47d71bd43f1450", "html_url": "https://github.com/rust-lang/rust/commit/bf4a37d9611239fc89f25e0a9c47d71bd43f1450", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bf4a37d9611239fc89f25e0a9c47d71bd43f1450/comments", "author": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "19cefa68640843956eedd86227ddc1d35dbc6754", "url": "https://api.github.com/repos/rust-lang/rust/commits/19cefa68640843956eedd86227ddc1d35dbc6754", "html_url": "https://github.com/rust-lang/rust/commit/19cefa68640843956eedd86227ddc1d35dbc6754"}, {"sha": "1530563bd7a3880eec14d78e4a715c1bc4e24074", "url": "https://api.github.com/repos/rust-lang/rust/commits/1530563bd7a3880eec14d78e4a715c1bc4e24074", "html_url": "https://github.com/rust-lang/rust/commit/1530563bd7a3880eec14d78e4a715c1bc4e24074"}], "stats": {"total": 36, "additions": 24, "deletions": 12}, "files": [{"sha": "4b228629ad719e2e2bac4a58687b2a5a00398326", "filename": "src/librustc_ast_pretty/pprust.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/bf4a37d9611239fc89f25e0a9c47d71bd43f1450/src%2Flibrustc_ast_pretty%2Fpprust.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bf4a37d9611239fc89f25e0a9c47d71bd43f1450/src%2Flibrustc_ast_pretty%2Fpprust.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_ast_pretty%2Fpprust.rs?ref=bf4a37d9611239fc89f25e0a9c47d71bd43f1450", "patch": "@@ -450,7 +450,9 @@ pub trait PrintState<'a>: std::ops::Deref<Target = pp::Printer> + std::ops::Dere\n     fn print_comment(&mut self, cmnt: &comments::Comment) {\n         match cmnt.style {\n             comments::Mixed => {\n-                self.zerobreak();\n+                if !self.is_beginning_of_line() {\n+                    self.zerobreak();\n+                }\n                 if let Some((last, lines)) = cmnt.lines.split_last() {\n                     self.ibox(0);\n "}, {"sha": "2bfcdd75e15cff94d54007075bcacc3d586c6238", "filename": "src/test/pretty/block-comment-wchar.pp", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/bf4a37d9611239fc89f25e0a9c47d71bd43f1450/src%2Ftest%2Fpretty%2Fblock-comment-wchar.pp", "raw_url": "https://github.com/rust-lang/rust/raw/bf4a37d9611239fc89f25e0a9c47d71bd43f1450/src%2Ftest%2Fpretty%2Fblock-comment-wchar.pp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fpretty%2Fblock-comment-wchar.pp?ref=bf4a37d9611239fc89f25e0a9c47d71bd43f1450", "patch": "@@ -73,15 +73,13 @@\n     */\n \n \n-\n     /* */\n \n     /*\n       Hello from offset 6\n       Space 6+2:                     compare A\n       Ogham Space Mark 6+2: compare B\n     */\n-\n     /*\u1680*/\n \n     /*"}, {"sha": "e255cd6caa8654c97021d22dc427cffe23172960", "filename": "src/test/pretty/issue-74745.rs", "status": "added", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/bf4a37d9611239fc89f25e0a9c47d71bd43f1450/src%2Ftest%2Fpretty%2Fissue-74745.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bf4a37d9611239fc89f25e0a9c47d71bd43f1450/src%2Ftest%2Fpretty%2Fissue-74745.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fpretty%2Fissue-74745.rs?ref=bf4a37d9611239fc89f25e0a9c47d71bd43f1450", "patch": "@@ -0,0 +1,5 @@\n+// ignore-tidy-trailing-newlines\n+// pretty-compare-only\n+\n+/*\n+*/\n\\ No newline at end of file"}, {"sha": "940e16720f6a98fef2a4ad503819b7245e2c81ad", "filename": "src/tools/compiletest/src/runtest.rs", "status": "modified", "additions": 16, "deletions": 9, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/bf4a37d9611239fc89f25e0a9c47d71bd43f1450/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bf4a37d9611239fc89f25e0a9c47d71bd43f1450/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs?ref=bf4a37d9611239fc89f25e0a9c47d71bd43f1450", "patch": "@@ -178,27 +178,30 @@ pub fn make_diff(expected: &str, actual: &str, context_size: usize) -> Vec<Misma\n     results\n }\n \n-fn print_diff(expected: &str, actual: &str, context_size: usize) {\n+fn write_diff(expected: &str, actual: &str, context_size: usize) -> String {\n+    use std::fmt::Write;\n+    let mut output = String::new();\n     let diff_results = make_diff(expected, actual, context_size);\n     for result in diff_results {\n         let mut line_number = result.line_number;\n         for line in result.lines {\n             match line {\n                 DiffLine::Expected(e) => {\n-                    println!(\"-\\t{}\", e);\n+                    writeln!(output, \"-\\t{}\", e).unwrap();\n                     line_number += 1;\n                 }\n                 DiffLine::Context(c) => {\n-                    println!(\"{}\\t{}\", line_number, c);\n+                    writeln!(output, \"{}\\t{}\", line_number, c).unwrap();\n                     line_number += 1;\n                 }\n                 DiffLine::Resulting(r) => {\n-                    println!(\"+\\t{}\", r);\n+                    writeln!(output, \"+\\t{}\", r).unwrap();\n                 }\n             }\n         }\n-        println!();\n+        writeln!(output, \"\").unwrap();\n     }\n+    output\n }\n \n pub fn run(config: Config, testpaths: &TestPaths, revision: Option<&str>) {\n@@ -655,8 +658,12 @@ impl<'test> TestCx<'test> {\n                  ------------------------------------------\\n\\\n                  {}\\n\\\n                  ------------------------------------------\\n\\\n-                 \\n\",\n-                expected, actual\n+                 diff:\\n\\\n+                 ------------------------------------------\\n\\\n+                 {}\\n\",\n+                expected,\n+                actual,\n+                write_diff(expected, actual, 3),\n             ));\n         }\n     }\n@@ -3227,7 +3234,7 @@ impl<'test> TestCx<'test> {\n                     }\n                     let expected_string = fs::read_to_string(&expected_file).unwrap();\n                     if dumped_string != expected_string {\n-                        print_diff(&expected_string, &dumped_string, 3);\n+                        print!(\"{}\", write_diff(&expected_string, &dumped_string, 3));\n                         panic!(\n                             \"Actual MIR output differs from expected MIR output {}\",\n                             expected_file.display()\n@@ -3452,7 +3459,7 @@ impl<'test> TestCx<'test> {\n                 println!(\"normalized {}:\\n{}\\n\", kind, actual);\n             } else {\n                 println!(\"diff of {}:\\n\", kind);\n-                print_diff(expected, actual, 3);\n+                print!(\"{}\", write_diff(expected, actual, 3));\n             }\n         }\n "}]}