{"sha": "bd4ea87f7442541123e3bbd7e17bfecdfb3c18c6", "node_id": "MDY6Q29tbWl0NzI0NzEyOmJkNGVhODdmNzQ0MjU0MTEyM2UzYmJkN2UxN2JmZWNkZmIzYzE4YzY=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-02-24T16:18:12Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-02-24T16:18:12Z"}, "message": "Merge #3294\n\n3294: When joining lines, unwrap trivial diverging blocks r=matklad a=matklad\n\n\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>", "tree": {"sha": "ef855bb9a4e77b2a99657e2e9ed3708c44ca104b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ef855bb9a4e77b2a99657e2e9ed3708c44ca104b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bd4ea87f7442541123e3bbd7e17bfecdfb3c18c6", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJeU/dECRBK7hj4Ov3rIwAAdHIIAJ4zhXH/GgrtyGcidPFJC8tv\nJJXbDsybGHRu8n4hcRgVHR6lhaCmUY8hCONWTE1TOw26ZvYIjfWdkE2MYhuBqej6\n6+hAe8TQO4u7ykJOlZf6r16RPYOD3v7ORQfP2r3m9Jka0WPI9+mcqd7YgsV6ez0U\npU++QY0Iiq20RBSyosfBrEsOvhrPeJveMFIThE08tqOHMA+l6FjQBHaX/bnib8bE\n8vl6G67Rj0IVi3g6Ng8ddsh/6zsgKsuKhoTldqPrHNBw7y6jUxUpD8dfVw2p1g3+\n33mjP3jpoSwleLHTV9xvbe7pszEXSKm9Tt6DYe+xaVVtnzFZkMVbqQ8EW5guZfI=\n=Qfqj\n-----END PGP SIGNATURE-----\n", "payload": "tree ef855bb9a4e77b2a99657e2e9ed3708c44ca104b\nparent 49b9c8a0524e53f9bd75b50b6e87d7d88587629f\nparent f551e50c16d189a724885ce5f208595a31af49cc\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1582561092 +0000\ncommitter GitHub <noreply@github.com> 1582561092 +0000\n\nMerge #3294\n\n3294: When joining lines, unwrap trivial diverging blocks r=matklad a=matklad\n\n\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bd4ea87f7442541123e3bbd7e17bfecdfb3c18c6", "html_url": "https://github.com/rust-lang/rust/commit/bd4ea87f7442541123e3bbd7e17bfecdfb3c18c6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bd4ea87f7442541123e3bbd7e17bfecdfb3c18c6/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "49b9c8a0524e53f9bd75b50b6e87d7d88587629f", "url": "https://api.github.com/repos/rust-lang/rust/commits/49b9c8a0524e53f9bd75b50b6e87d7d88587629f", "html_url": "https://github.com/rust-lang/rust/commit/49b9c8a0524e53f9bd75b50b6e87d7d88587629f"}, {"sha": "f551e50c16d189a724885ce5f208595a31af49cc", "url": "https://api.github.com/repos/rust-lang/rust/commits/f551e50c16d189a724885ce5f208595a31af49cc", "html_url": "https://github.com/rust-lang/rust/commit/f551e50c16d189a724885ce5f208595a31af49cc"}], "stats": {"total": 61, "additions": 53, "deletions": 8}, "files": [{"sha": "db27f9b83932739771e4b7d3cab8b40c9a6ad4c3", "filename": "crates/ra_fmt/src/lib.rs", "status": "modified", "additions": 28, "deletions": 8, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/bd4ea87f7442541123e3bbd7e17bfecdfb3c18c6/crates%2Fra_fmt%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bd4ea87f7442541123e3bbd7e17bfecdfb3c18c6/crates%2Fra_fmt%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_fmt%2Fsrc%2Flib.rs?ref=bd4ea87f7442541123e3bbd7e17bfecdfb3c18c6", "patch": "@@ -43,15 +43,35 @@ pub fn unwrap_trivial_block(block: ast::BlockExpr) -> ast::Expr {\n \n pub fn extract_trivial_expression(block: &ast::BlockExpr) -> Option<ast::Expr> {\n     let block = block.block()?;\n-    let expr = block.expr()?;\n-    let non_trivial_children = block.syntax().children().filter(|it| match it.kind() {\n-        WHITESPACE | T!['{'] | T!['}'] => false,\n-        _ => it != expr.syntax(),\n-    });\n-    if non_trivial_children.count() > 0 {\n-        return None;\n+    let has_anything_else = |thing: &SyntaxNode| -> bool {\n+        let mut non_trivial_children =\n+            block.syntax().children_with_tokens().filter(|it| match it.kind() {\n+                WHITESPACE | T!['{'] | T!['}'] => false,\n+                _ => it.as_node() != Some(thing),\n+            });\n+        non_trivial_children.next().is_some()\n+    };\n+\n+    if let Some(expr) = block.expr() {\n+        if has_anything_else(expr.syntax()) {\n+            return None;\n+        }\n+        return Some(expr);\n+    } else {\n+        // Unwrap `{ continue; }`\n+        let (stmt,) = block.statements().next_tuple()?;\n+        if has_anything_else(stmt.syntax()) {\n+            return None;\n+        }\n+        if let ast::Stmt::ExprStmt(expr_stmt) = stmt {\n+            let expr = expr_stmt.expr()?;\n+            match expr.syntax().kind() {\n+                CONTINUE_EXPR | BREAK_EXPR | RETURN_EXPR => return Some(expr),\n+                _ => (),\n+            }\n+        }\n     }\n-    Some(expr)\n+    None\n }\n \n pub fn compute_ws(left: SyntaxKind, right: SyntaxKind) -> &'static str {"}, {"sha": "7d70dab9c69266a67d94b5fcb61d9c123b9a8c41", "filename": "crates/ra_ide/src/join_lines.rs", "status": "modified", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/bd4ea87f7442541123e3bbd7e17bfecdfb3c18c6/crates%2Fra_ide%2Fsrc%2Fjoin_lines.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bd4ea87f7442541123e3bbd7e17bfecdfb3c18c6/crates%2Fra_ide%2Fsrc%2Fjoin_lines.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fjoin_lines.rs?ref=bd4ea87f7442541123e3bbd7e17bfecdfb3c18c6", "patch": "@@ -227,6 +227,31 @@ fn foo() {\n         );\n     }\n \n+    #[test]\n+    fn test_join_lines_diverging_block() {\n+        let before = r\"\n+            fn foo() {\n+                loop {\n+                    match x {\n+                        92 => <|>{\n+                            continue;\n+                        }\n+                    }\n+                }\n+            }\n+        \";\n+        let after = r\"\n+            fn foo() {\n+                loop {\n+                    match x {\n+                        92 => <|>continue,\n+                    }\n+                }\n+            }\n+        \";\n+        check_join_lines(before, after);\n+    }\n+\n     #[test]\n     fn join_lines_adds_comma_for_block_in_match_arm() {\n         check_join_lines("}]}