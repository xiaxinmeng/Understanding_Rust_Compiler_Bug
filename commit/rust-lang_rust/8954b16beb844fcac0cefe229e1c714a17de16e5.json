{"sha": "8954b16beb844fcac0cefe229e1c714a17de16e5", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg5NTRiMTZiZWI4NDRmY2FjMGNlZmUyMjllMWM3MTRhMTdkZTE2ZTU=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-12-14T07:06:02Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-12-14T07:06:02Z"}, "message": "Auto merge of #46605 - estebank:macro-backtrace-spans, r=pnkfelix\n\nUse spans for -Z external-macro-backtrace\n\n```\n% rustc ui/type-check/cannot_infer_local_or_vec.rs -Z external-macro-backtrace\nerror[E0282]: type annotations needed\n  --> <vec macros>:3:1\n   |\n1  | / ( $ elem : expr ; $ n : expr ) => (\n2  | | $ crate :: vec :: from_elem ( $ elem , $ n ) ) ; ( $ ( $ x : expr ) , * ) => (\n3  | | < [ _ ] > :: into_vec ( box [ $ ( $ x ) , * ] ) ) ; ( $ ( $ x : expr , ) * )\n   | | ^^^^^^^^^^^^^^^^^^^^^\n   | | |\n   | | cannot infer type for `T`\n4  | | => ( vec ! [ $ ( $ x ) , * ] )\n   | |______________________________- in this expansion of `vec!`\n   |\n  ::: ui/type-check/cannot_infer_local_or_vec.rs\n   |\n12 |       let x = vec![];\n   |           -   ------ in this macro invocation\n   |           |\n   |           consider giving `x` a type\n\nerror: aborting due to previous error\n```", "tree": {"sha": "07e11d44c2885af6b96cf276f5c62d9d3ad4acaf", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/07e11d44c2885af6b96cf276f5c62d9d3ad4acaf"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8954b16beb844fcac0cefe229e1c714a17de16e5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8954b16beb844fcac0cefe229e1c714a17de16e5", "html_url": "https://github.com/rust-lang/rust/commit/8954b16beb844fcac0cefe229e1c714a17de16e5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8954b16beb844fcac0cefe229e1c714a17de16e5/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f03e06762ea6c4116c360185c0e9b6f209b76959", "url": "https://api.github.com/repos/rust-lang/rust/commits/f03e06762ea6c4116c360185c0e9b6f209b76959", "html_url": "https://github.com/rust-lang/rust/commit/f03e06762ea6c4116c360185c0e9b6f209b76959"}, {"sha": "d4b8e99540ed815f7c0187cf2db8a2e4c0a61d8f", "url": "https://api.github.com/repos/rust-lang/rust/commits/d4b8e99540ed815f7c0187cf2db8a2e4c0a61d8f", "html_url": "https://github.com/rust-lang/rust/commit/d4b8e99540ed815f7c0187cf2db8a2e4c0a61d8f"}], "stats": {"total": 207, "additions": 144, "deletions": 63}, "files": [{"sha": "a9c934e971345c842f9675d465519ab01bc94be1", "filename": "src/librustc_errors/emitter.rs", "status": "modified", "additions": 49, "deletions": 53, "changes": 102, "blob_url": "https://github.com/rust-lang/rust/blob/8954b16beb844fcac0cefe229e1c714a17de16e5/src%2Flibrustc_errors%2Femitter.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8954b16beb844fcac0cefe229e1c714a17de16e5/src%2Flibrustc_errors%2Femitter.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_errors%2Femitter.rs?ref=8954b16beb844fcac0cefe229e1c714a17de16e5", "patch": "@@ -64,11 +64,11 @@ impl Emitter for EmitterWriter {\n             }\n         }\n \n-        if !db.handler.flags.external_macro_backtrace {\n-            self.fix_multispans_in_std_macros(&mut primary_span, &mut children);\n-        }\n+        self.fix_multispans_in_std_macros(&mut primary_span,\n+                                          &mut children,\n+                                          db.handler.flags.external_macro_backtrace);\n+\n         self.emit_messages_default(&db.level,\n-                                   db.handler.flags.external_macro_backtrace,\n                                    &db.styled_message(),\n                                    &db.code,\n                                    &primary_span,\n@@ -726,7 +726,9 @@ impl EmitterWriter {\n     // This \"fixes\" MultiSpans that contain Spans that are pointing to locations inside of\n     // <*macros>. Since these locations are often difficult to read, we move these Spans from\n     // <*macros> to their corresponding use site.\n-    fn fix_multispan_in_std_macros(&mut self, span: &mut MultiSpan) -> bool {\n+    fn fix_multispan_in_std_macros(&mut self,\n+                                   span: &mut MultiSpan,\n+                                   always_backtrace: bool) -> bool {\n         let mut spans_updated = false;\n \n         if let Some(ref cm) = self.cm {\n@@ -739,22 +741,45 @@ impl EmitterWriter {\n                     continue;\n                 }\n                 let call_sp = cm.call_span_if_macro(*sp);\n-                if call_sp != *sp {\n-                    before_after.push((sp.clone(), call_sp));\n+                if call_sp != *sp && !always_backtrace {\n+                    before_after.push((*sp, call_sp));\n                 }\n-                for trace in sp.macro_backtrace().iter().rev() {\n+                let backtrace_len = sp.macro_backtrace().len();\n+                for (i, trace) in sp.macro_backtrace().iter().rev().enumerate() {\n                     // Only show macro locations that are local\n                     // and display them like a span_note\n                     if let Some(def_site) = trace.def_site_span {\n                         if def_site == DUMMY_SP {\n                             continue;\n                         }\n+                        if always_backtrace {\n+                            new_labels.push((def_site,\n+                                             format!(\"in this expansion of `{}`{}\",\n+                                                     trace.macro_decl_name,\n+                                                     if backtrace_len > 2 {\n+                                                         // if backtrace_len == 1 it'll be pointed\n+                                                         // at by \"in this macro invocation\"\n+                                                         format!(\" (#{})\", i + 1)\n+                                                     } else {\n+                                                         \"\".to_string()\n+                                                     })));\n+                        }\n                         // Check to make sure we're not in any <*macros>\n                         if !cm.span_to_filename(def_site).contains(\"macros>\") &&\n-                           !trace.macro_decl_name.starts_with(\"#[\") {\n+                           !trace.macro_decl_name.starts_with(\"#[\") ||\n+                           always_backtrace {\n                             new_labels.push((trace.call_site,\n-                                             \"in this macro invocation\".to_string()));\n-                            break;\n+                                             format!(\"in this macro invocation{}\",\n+                                                     if backtrace_len > 2 && always_backtrace {\n+                                                         // only specify order when the macro\n+                                                         // backtrace is multiple levels deep\n+                                                         format!(\" (#{})\", i + 1)\n+                                                     } else {\n+                                                         \"\".to_string()\n+                                                     })));\n+                            if !always_backtrace {\n+                                break;\n+                            }\n                         }\n                     }\n                 }\n@@ -766,7 +791,9 @@ impl EmitterWriter {\n                 if sp_label.span == DUMMY_SP {\n                     continue;\n                 }\n-                if cm.span_to_filename(sp_label.span.clone()).contains(\"macros>\") {\n+                if cm.span_to_filename(sp_label.span.clone()).contains(\"macros>\") &&\n+                    !always_backtrace\n+                {\n                     let v = sp_label.span.macro_backtrace();\n                     if let Some(use_site) = v.last() {\n                         before_after.push((sp_label.span.clone(), use_site.call_site.clone()));\n@@ -788,18 +815,19 @@ impl EmitterWriter {\n     // will change the span to point at the use site.\n     fn fix_multispans_in_std_macros(&mut self,\n                                     span: &mut MultiSpan,\n-                                    children: &mut Vec<SubDiagnostic>) {\n-        let mut spans_updated = self.fix_multispan_in_std_macros(span);\n+                                    children: &mut Vec<SubDiagnostic>,\n+                                    backtrace: bool) {\n+        let mut spans_updated = self.fix_multispan_in_std_macros(span, backtrace);\n         for child in children.iter_mut() {\n-            spans_updated |= self.fix_multispan_in_std_macros(&mut child.span);\n+            spans_updated |= self.fix_multispan_in_std_macros(&mut child.span, backtrace);\n         }\n         if spans_updated {\n             children.push(SubDiagnostic {\n                 level: Level::Note,\n                 message: vec![\n-                    ([\"this error originates in a macro outside of the current crate\",\n-                      \"(in Nightly builds, run with -Z external-macro-backtrace for more info)\"]\n-                      .join(\" \"),\n+                    (\"this error originates in a macro outside of the current crate \\\n+                      (in Nightly builds, run with -Z external-macro-backtrace \\\n+                       for more info)\".to_string(),\n                      Style::NoStyle),\n                 ],\n                 span: MultiSpan::new(),\n@@ -861,7 +889,7 @@ impl EmitterWriter {\n         //       (\"see?\", Style::Highlight),\n         //     ];\n         //\n-        // the expected output on a note is (* surround the  highlighted text)\n+        // the expected output on a note is (* surround the highlighted text)\n         //\n         //        = note: highlighted multiline\n         //                string to\n@@ -889,7 +917,6 @@ impl EmitterWriter {\n                             msg: &Vec<(String, Style)>,\n                             code: &Option<DiagnosticId>,\n                             level: &Level,\n-                            external_macro_backtrace: bool,\n                             max_line_num_len: usize,\n                             is_secondary: bool)\n                             -> io::Result<()> {\n@@ -1087,18 +1114,13 @@ impl EmitterWriter {\n             }\n         }\n \n-        if external_macro_backtrace {\n-            if let Some(ref primary_span) = msp.primary_span().as_ref() {\n-                self.render_macro_backtrace_old_school(primary_span, &mut buffer)?;\n-            }\n-        }\n-\n         // final step: take our styled buffer, render it, then output it\n         emit_to_destination(&buffer.render(), level, &mut self.dst, self.short_message)?;\n \n         Ok(())\n \n     }\n+\n     fn emit_suggestion_default(&mut self,\n                                suggestion: &CodeSuggestion,\n                                level: &Level,\n@@ -1182,9 +1204,9 @@ impl EmitterWriter {\n         }\n         Ok(())\n     }\n+\n     fn emit_messages_default(&mut self,\n                              level: &Level,\n-                             external_macro_backtrace: bool,\n                              message: &Vec<(String, Style)>,\n                              code: &Option<DiagnosticId>,\n                              span: &MultiSpan,\n@@ -1197,7 +1219,6 @@ impl EmitterWriter {\n                                         message,\n                                         code,\n                                         level,\n-                                        external_macro_backtrace,\n                                         max_line_num_len,\n                                         false) {\n             Ok(()) => {\n@@ -1219,7 +1240,6 @@ impl EmitterWriter {\n                                                         &child.styled_message(),\n                                                         &None,\n                                                         &child.level,\n-                                                        external_macro_backtrace,\n                                                         max_line_num_len,\n                                                         true) {\n                             Err(e) => panic!(\"failed to emit error: {}\", e),\n@@ -1248,30 +1268,6 @@ impl EmitterWriter {\n             }\n         }\n     }\n-\n-    fn render_macro_backtrace_old_school(&self,\n-                                         sp: &Span,\n-                                         buffer: &mut StyledBuffer) -> io::Result<()> {\n-        if let Some(ref cm) = self.cm {\n-            for trace in sp.macro_backtrace().iter().rev() {\n-                let line_offset = buffer.num_lines();\n-\n-                let mut diag_string =\n-                    format!(\"in this expansion of {}\", trace.macro_decl_name);\n-                if let Some(def_site_span) = trace.def_site_span {\n-                    diag_string.push_str(\n-                        &format!(\" (defined in {})\",\n-                            cm.span_to_filename(def_site_span)));\n-                }\n-                let snippet = cm.span_to_string(trace.call_site);\n-                buffer.append(line_offset, &format!(\"{} \", snippet), Style::NoStyle);\n-                buffer.append(line_offset, \"note\", Style::Level(Level::Note));\n-                buffer.append(line_offset, \": \", Style::NoStyle);\n-                buffer.append(line_offset, &diag_string, Style::OldSchoolNoteText);\n-            }\n-        }\n-        Ok(())\n-    }\n }\n \n fn draw_col_separator(buffer: &mut StyledBuffer, line: usize, col: usize) {"}, {"sha": "e4131dde8f7208500fc06b522e8d99789df0b90f", "filename": "src/test/ui/macro_backtrace/auxiliary/ping.rs", "status": "modified", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/8954b16beb844fcac0cefe229e1c714a17de16e5/src%2Ftest%2Fui%2Fmacro_backtrace%2Fauxiliary%2Fping.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8954b16beb844fcac0cefe229e1c714a17de16e5/src%2Ftest%2Fui%2Fmacro_backtrace%2Fauxiliary%2Fping.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmacro_backtrace%2Fauxiliary%2Fping.rs?ref=8954b16beb844fcac0cefe229e1c714a17de16e5", "patch": "@@ -18,3 +18,24 @@ macro_rules! ping {\n     }\n }\n \n+#[macro_export]\n+macro_rules! deep {\n+    () => {\n+        foo!();\n+    }\n+}\n+\n+#[macro_export]\n+macro_rules! foo {\n+    () => {\n+        bar!();\n+    }\n+}\n+\n+#[macro_export]\n+macro_rules! bar {\n+    () => {\n+        ping!();\n+    }\n+}\n+"}, {"sha": "72a5c0d5e3728bd696b3c1a94c6bbf61ce2a7a51", "filename": "src/test/ui/macro_backtrace/main.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/8954b16beb844fcac0cefe229e1c714a17de16e5/src%2Ftest%2Fui%2Fmacro_backtrace%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8954b16beb844fcac0cefe229e1c714a17de16e5/src%2Ftest%2Fui%2Fmacro_backtrace%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmacro_backtrace%2Fmain.rs?ref=8954b16beb844fcac0cefe229e1c714a17de16e5", "patch": "@@ -16,11 +16,14 @@\n \n // a local macro\n macro_rules! pong {\n-    () => { syntax error }; //~ ERROR expected one of\n-    //~^ ERROR expected one of\n+    () => { syntax error };\n }\n+//~^^ ERROR expected one of\n+//~| ERROR expected one of\n+//~| ERROR expected one of\n \n fn main() {\n     pong!();\n     ping!();\n+    deep!();\n }"}, {"sha": "5990f71b3ca0ad1f7b74d980855f0d201f254187", "filename": "src/test/ui/macro_backtrace/main.stderr", "status": "modified", "additions": 69, "deletions": 8, "changes": 77, "blob_url": "https://github.com/rust-lang/rust/blob/8954b16beb844fcac0cefe229e1c714a17de16e5/src%2Ftest%2Fui%2Fmacro_backtrace%2Fmain.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/8954b16beb844fcac0cefe229e1c714a17de16e5/src%2Ftest%2Fui%2Fmacro_backtrace%2Fmain.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmacro_backtrace%2Fmain.stderr?ref=8954b16beb844fcac0cefe229e1c714a17de16e5", "patch": "@@ -1,17 +1,78 @@\n error: expected one of `!`, `.`, `::`, `;`, `?`, `{`, `}`, or an operator, found `error`\n   --> $DIR/main.rs:19:20\n    |\n-19 |     () => { syntax error }; //~ ERROR expected one of\n-   |                    ^^^^^ expected one of 8 possible tokens here\n-$DIR/main.rs:24:5: 24:13 note: in this expansion of pong! (defined in $DIR/main.rs)\n+18 | / macro_rules! pong {\n+19 | |     () => { syntax error };\n+   | |                    ^^^^^ expected one of 8 possible tokens here\n+20 | | }\n+   | |_- in this expansion of `pong!`\n+...\n+26 |       pong!();\n+   |       -------- in this macro invocation\n \n error: expected one of `!`, `.`, `::`, `;`, `?`, `{`, `}`, or an operator, found `error`\n   --> $DIR/main.rs:19:20\n    |\n-19 |     () => { syntax error }; //~ ERROR expected one of\n-   |                    ^^^^^ expected one of 8 possible tokens here\n-$DIR/main.rs:25:5: 25:13 note: in this expansion of ping! (defined in <ping macros>)\n-<ping macros>:1:11: 1:24 note: in this expansion of pong! (defined in $DIR/main.rs)\n+18 | / macro_rules! pong {\n+19 | |     () => { syntax error };\n+   | |                    ^^^^^ expected one of 8 possible tokens here\n+20 | | }\n+   | |_- in this expansion of `pong!`\n+...\n+27 |       ping!();\n+   |       -------- in this macro invocation\n+   | \n+  ::: <ping macros>\n+   |\n+1  |   (  ) => { pong ! (  ) ; }\n+   |   -------------------------\n+   |   |         |\n+   |   |         in this macro invocation\n+   |   in this expansion of `ping!`\n+\n+error: expected one of `!`, `.`, `::`, `;`, `?`, `{`, `}`, or an operator, found `error`\n+  --> $DIR/main.rs:19:20\n+   |\n+18 | / macro_rules! pong {\n+19 | |     () => { syntax error };\n+   | |                    ^^^^^ expected one of 8 possible tokens here\n+20 | | }\n+   | |_- in this expansion of `pong!` (#5)\n+...\n+28 |       deep!();\n+   |       -------- in this macro invocation (#1)\n+   | \n+  ::: <deep macros>\n+   |\n+1  |   (  ) => { foo ! (  ) ; }\n+   |   ------------------------\n+   |   |         |\n+   |   |         in this macro invocation (#2)\n+   |   in this expansion of `deep!` (#1)\n+   | \n+  ::: <foo macros>\n+   |\n+1  |   (  ) => { bar ! (  ) ; }\n+   |   ------------------------\n+   |   |         |\n+   |   |         in this macro invocation (#3)\n+   |   in this expansion of `foo!` (#2)\n+   | \n+  ::: <bar macros>\n+   |\n+1  |   (  ) => { ping ! (  ) ; }\n+   |   -------------------------\n+   |   |         |\n+   |   |         in this macro invocation (#4)\n+   |   in this expansion of `bar!` (#3)\n+   | \n+  ::: <ping macros>\n+   |\n+1  |   (  ) => { pong ! (  ) ; }\n+   |   -------------------------\n+   |   |         |\n+   |   |         in this macro invocation (#5)\n+   |   in this expansion of `ping!` (#4)\n \n-error: aborting due to 2 previous errors\n+error: aborting due to 3 previous errors\n "}]}