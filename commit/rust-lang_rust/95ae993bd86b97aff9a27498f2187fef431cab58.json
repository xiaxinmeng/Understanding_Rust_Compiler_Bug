{"sha": "95ae993bd86b97aff9a27498f2187fef431cab58", "node_id": "C_kwDOAAsO6NoAKDk1YWU5OTNiZDg2Yjk3YWZmOWEyNzQ5OGYyMTg3ZmVmNDMxY2FiNTg", "commit": {"author": {"name": "Ben Kimock", "email": "kimockb@gmail.com", "date": "2022-10-07T00:09:54Z"}, "committer": {"name": "Ben Kimock", "email": "kimockb@gmail.com", "date": "2022-10-07T03:31:57Z"}, "message": "Avoid defensive re-initialization of the BufReader buffer", "tree": {"sha": "17e7425d97da5eb8d9ff232b72031c36cea103ec", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/17e7425d97da5eb8d9ff232b72031c36cea103ec"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/95ae993bd86b97aff9a27498f2187fef431cab58", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/95ae993bd86b97aff9a27498f2187fef431cab58", "html_url": "https://github.com/rust-lang/rust/commit/95ae993bd86b97aff9a27498f2187fef431cab58", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/95ae993bd86b97aff9a27498f2187fef431cab58/comments", "author": {"login": "saethlin", "id": 12105168, "node_id": "MDQ6VXNlcjEyMTA1MTY4", "avatar_url": "https://avatars.githubusercontent.com/u/12105168?v=4", "gravatar_id": "", "url": "https://api.github.com/users/saethlin", "html_url": "https://github.com/saethlin", "followers_url": "https://api.github.com/users/saethlin/followers", "following_url": "https://api.github.com/users/saethlin/following{/other_user}", "gists_url": "https://api.github.com/users/saethlin/gists{/gist_id}", "starred_url": "https://api.github.com/users/saethlin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/saethlin/subscriptions", "organizations_url": "https://api.github.com/users/saethlin/orgs", "repos_url": "https://api.github.com/users/saethlin/repos", "events_url": "https://api.github.com/users/saethlin/events{/privacy}", "received_events_url": "https://api.github.com/users/saethlin/received_events", "type": "User", "site_admin": false}, "committer": {"login": "saethlin", "id": 12105168, "node_id": "MDQ6VXNlcjEyMTA1MTY4", "avatar_url": "https://avatars.githubusercontent.com/u/12105168?v=4", "gravatar_id": "", "url": "https://api.github.com/users/saethlin", "html_url": "https://github.com/saethlin", "followers_url": "https://api.github.com/users/saethlin/followers", "following_url": "https://api.github.com/users/saethlin/following{/other_user}", "gists_url": "https://api.github.com/users/saethlin/gists{/gist_id}", "starred_url": "https://api.github.com/users/saethlin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/saethlin/subscriptions", "organizations_url": "https://api.github.com/users/saethlin/orgs", "repos_url": "https://api.github.com/users/saethlin/repos", "events_url": "https://api.github.com/users/saethlin/events{/privacy}", "received_events_url": "https://api.github.com/users/saethlin/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0ca356586fed56002b10920fd21ddf6fb12de797", "url": "https://api.github.com/repos/rust-lang/rust/commits/0ca356586fed56002b10920fd21ddf6fb12de797", "html_url": "https://github.com/rust-lang/rust/commit/0ca356586fed56002b10920fd21ddf6fb12de797"}], "stats": {"total": 51, "additions": 48, "deletions": 3}, "files": [{"sha": "4f339a18a480ec8ef42187b347b9dc0ce2bfbd1e", "filename": "library/std/src/io/buffered/bufreader.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/95ae993bd86b97aff9a27498f2187fef431cab58/library%2Fstd%2Fsrc%2Fio%2Fbuffered%2Fbufreader.rs", "raw_url": "https://github.com/rust-lang/rust/raw/95ae993bd86b97aff9a27498f2187fef431cab58/library%2Fstd%2Fsrc%2Fio%2Fbuffered%2Fbufreader.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fio%2Fbuffered%2Fbufreader.rs?ref=95ae993bd86b97aff9a27498f2187fef431cab58", "patch": "@@ -224,6 +224,14 @@ impl<R> BufReader<R> {\n     }\n }\n \n+// This is only used by a test which asserts that the initialization-tracking is correct.\n+#[cfg(test)]\n+impl<R> BufReader<R> {\n+    pub fn initialized(&self) -> usize {\n+        self.buf.initialized()\n+    }\n+}\n+\n impl<R: Seek> BufReader<R> {\n     /// Seeks relative to the current position. If the new position lies within the buffer,\n     /// the buffer will not be flushed, allowing for more efficient seeks."}, {"sha": "e9e29d60ca2826a915937688e8fe02488b861a4e", "filename": "library/std/src/io/buffered/bufreader/buffer.rs", "status": "modified", "additions": 16, "deletions": 3, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/95ae993bd86b97aff9a27498f2187fef431cab58/library%2Fstd%2Fsrc%2Fio%2Fbuffered%2Fbufreader%2Fbuffer.rs", "raw_url": "https://github.com/rust-lang/rust/raw/95ae993bd86b97aff9a27498f2187fef431cab58/library%2Fstd%2Fsrc%2Fio%2Fbuffered%2Fbufreader%2Fbuffer.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fio%2Fbuffered%2Fbufreader%2Fbuffer.rs?ref=95ae993bd86b97aff9a27498f2187fef431cab58", "patch": "@@ -20,13 +20,19 @@ pub struct Buffer {\n     // Each call to `fill_buf` sets `filled` to indicate how many bytes at the start of `buf` are\n     // initialized with bytes from a read.\n     filled: usize,\n+    // This is the max number of bytes returned across all `fill_buf` calls. We track this so that we\n+    // can accurately tell `read_buf` how many bytes of buf are initialized, to bypass as much of its\n+    // defensive initialization as possible. Note that while this often the same as `filled`, it\n+    // doesn't need to be. Calls to `fill_buf` are not required to actually fill the buffer, and\n+    // omitting this is a huge perf regression for `Read` impls that do not.\n+    initialized: usize,\n }\n \n impl Buffer {\n     #[inline]\n     pub fn with_capacity(capacity: usize) -> Self {\n         let buf = Box::new_uninit_slice(capacity);\n-        Self { buf, pos: 0, filled: 0 }\n+        Self { buf, pos: 0, filled: 0, initialized: 0 }\n     }\n \n     #[inline]\n@@ -51,6 +57,12 @@ impl Buffer {\n         self.pos\n     }\n \n+    // This is only used by a test which asserts that the initialization-tracking is correct.\n+    #[cfg(test)]\n+    pub fn initialized(&self) -> usize {\n+        self.initialized\n+    }\n+\n     #[inline]\n     pub fn discard_buffer(&mut self) {\n         self.pos = 0;\n@@ -96,13 +108,14 @@ impl Buffer {\n             let mut buf = BorrowedBuf::from(&mut *self.buf);\n             // SAFETY: `self.filled` bytes will always have been initialized.\n             unsafe {\n-                buf.set_init(self.filled);\n+                buf.set_init(self.initialized);\n             }\n \n             reader.read_buf(buf.unfilled())?;\n \n-            self.filled = buf.len();\n             self.pos = 0;\n+            self.filled = buf.len();\n+            self.initialized = buf.init_len();\n         }\n         Ok(self.buffer())\n     }"}, {"sha": "f4e688eb926cc7bff8962f1f79ecca455d7c27bc", "filename": "library/std/src/io/buffered/tests.rs", "status": "modified", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/95ae993bd86b97aff9a27498f2187fef431cab58/library%2Fstd%2Fsrc%2Fio%2Fbuffered%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/95ae993bd86b97aff9a27498f2187fef431cab58/library%2Fstd%2Fsrc%2Fio%2Fbuffered%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fio%2Fbuffered%2Ftests.rs?ref=95ae993bd86b97aff9a27498f2187fef431cab58", "patch": "@@ -1039,3 +1039,27 @@ fn single_formatted_write() {\n     writeln!(&mut writer, \"{}, {}!\", \"hello\", \"world\").unwrap();\n     assert_eq!(writer.get_ref().events, [RecordedEvent::Write(\"hello, world!\\n\".to_string())]);\n }\n+\n+#[test]\n+fn bufreader_full_initialize() {\n+    struct OneByteReader;\n+    impl Read for OneByteReader {\n+        fn read(&mut self, buf: &mut [u8]) -> crate::io::Result<usize> {\n+            if buf.len() > 0 {\n+                buf[0] = 0;\n+                Ok(1)\n+            } else {\n+                Ok(0)\n+            }\n+        }\n+    }\n+    let mut reader = BufReader::new(OneByteReader);\n+    // Nothing is initialized yet.\n+    assert_eq!(reader.initialized(), 0);\n+\n+    let buf = reader.fill_buf().unwrap();\n+    // We read one byte...\n+    assert_eq!(buf.len(), 1);\n+    // But we initialized the whole buffer!\n+    assert_eq!(reader.initialized(), reader.capacity());\n+}"}]}