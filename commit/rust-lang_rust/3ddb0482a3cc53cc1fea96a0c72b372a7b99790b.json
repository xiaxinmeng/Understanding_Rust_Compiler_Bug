{"sha": "3ddb0482a3cc53cc1fea96a0c72b372a7b99790b", "node_id": "C_kwDOAAsO6NoAKDNkZGIwNDgyYTNjYzUzY2MxZmVhOTZhMGM3MmIzNzJhN2I5OTc5MGI", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-09-10T05:09:20Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-09-10T05:09:20Z"}, "message": "Rollup merge of #101595 - ehuss:fix-ice-flag-report, r=tmiasko\n\nFix ICE report flags display.\n\n#92310 made some changes to the ICE report that displays the rustc flags, but it introduced a bug where a flag like `-Z incremental-verify-ich=yes` was being treated as-if it was `-Cincremental`. This corrupted the output and made it confusing. The cause was using `starts_with` instead of properly splitting the option.\n\nFor example, with the command like `rustc foo.rs -Cincremental=/tmp/a -Zincremental-verify-ich=yes --crate-type lib` would previously look like:\n\n```\nnote: compiler flags: -C incremental -Z incremental --crate-type lib\n```\n\nIt now looks like:\n\n```\nnote: compiler flags: -C incremental=[REDACTED] -Z incremental-verify-ich=yes --crate-type lib\n```\n\nI added a `[REDACTED]` marker for `-Cincremental` so it is a little less confusing that a value has been removed.\n\nFixes #101588", "tree": {"sha": "1c299c6f57ba31c408252b0c03f5e088d56f435f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1c299c6f57ba31c408252b0c03f5e088d56f435f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3ddb0482a3cc53cc1fea96a0c72b372a7b99790b", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjHBwACRBK7hj4Ov3rIwAAkqUIAF2DJJuJn+lS8pqIFiqWCCz8\nkHgrGoRnf3f+mM0FlTx0rLJp2hNPvFoSpOOWo6Lb1a2/AzVvE7SU2SSxU99fCN+W\neOCoEvf3w2eT+4J9IdCBzim3+hBOW5Xi8p4UN/SvwaCjieRpaAzy3GLbwYsz0yEi\ni51Si+9rlOXpcpx0GUW6L5jYaVIjw30/FHQ8N8GzIBBhdPGxabqA5OgwhNb2ahKe\nzohJhtTYXbMqS07MiYHK0uHeHFObGo4GfBM9twzOENpPkBVJmeBS3eXw3MoGFTOg\nHlNFhs272BrIGEnCCtKZ73EQYJMHvGhSoyFF3alKg8NhgEolugftzv1gD6ayL+E=\n=tPmJ\n-----END PGP SIGNATURE-----\n", "payload": "tree 1c299c6f57ba31c408252b0c03f5e088d56f435f\nparent 857a43d2c8fedc0bcb7c51d64b1b7b29d754d16a\nparent ed0f0377e2620ed3c70a42890ca420c1472eb788\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1662786560 +0200\ncommitter GitHub <noreply@github.com> 1662786560 +0200\n\nRollup merge of #101595 - ehuss:fix-ice-flag-report, r=tmiasko\n\nFix ICE report flags display.\n\n#92310 made some changes to the ICE report that displays the rustc flags, but it introduced a bug where a flag like `-Z incremental-verify-ich=yes` was being treated as-if it was `-Cincremental`. This corrupted the output and made it confusing. The cause was using `starts_with` instead of properly splitting the option.\n\nFor example, with the command like `rustc foo.rs -Cincremental=/tmp/a -Zincremental-verify-ich=yes --crate-type lib` would previously look like:\n\n```\nnote: compiler flags: -C incremental -Z incremental --crate-type lib\n```\n\nIt now looks like:\n\n```\nnote: compiler flags: -C incremental=[REDACTED] -Z incremental-verify-ich=yes --crate-type lib\n```\n\nI added a `[REDACTED]` marker for `-Cincremental` so it is a little less confusing that a value has been removed.\n\nFixes #101588\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3ddb0482a3cc53cc1fea96a0c72b372a7b99790b", "html_url": "https://github.com/rust-lang/rust/commit/3ddb0482a3cc53cc1fea96a0c72b372a7b99790b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3ddb0482a3cc53cc1fea96a0c72b372a7b99790b/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "857a43d2c8fedc0bcb7c51d64b1b7b29d754d16a", "url": "https://api.github.com/repos/rust-lang/rust/commits/857a43d2c8fedc0bcb7c51d64b1b7b29d754d16a", "html_url": "https://github.com/rust-lang/rust/commit/857a43d2c8fedc0bcb7c51d64b1b7b29d754d16a"}, {"sha": "ed0f0377e2620ed3c70a42890ca420c1472eb788", "url": "https://api.github.com/repos/rust-lang/rust/commits/ed0f0377e2620ed3c70a42890ca420c1472eb788", "html_url": "https://github.com/rust-lang/rust/commit/ed0f0377e2620ed3c70a42890ca420c1472eb788"}], "stats": {"total": 11, "additions": 7, "deletions": 4}, "files": [{"sha": "d6f51d7eee1afca590f30d6fd3205bc51d2953de", "filename": "compiler/rustc_driver/src/lib.rs", "status": "modified", "additions": 7, "deletions": 4, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/3ddb0482a3cc53cc1fea96a0c72b372a7b99790b/compiler%2Frustc_driver%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3ddb0482a3cc53cc1fea96a0c72b372a7b99790b/compiler%2Frustc_driver%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_driver%2Fsrc%2Flib.rs?ref=3ddb0482a3cc53cc1fea96a0c72b372a7b99790b", "patch": "@@ -1119,22 +1119,25 @@ fn extra_compiler_flags() -> Option<(Vec<String>, bool)> {\n     while let Some(arg) = args.next() {\n         if let Some(a) = ICE_REPORT_COMPILER_FLAGS.iter().find(|a| arg.starts_with(*a)) {\n             let content = if arg.len() == a.len() {\n+                // A space-separated option, like `-C incremental=foo` or `--crate-type rlib`\n                 match args.next() {\n                     Some(arg) => arg.to_string(),\n                     None => continue,\n                 }\n             } else if arg.get(a.len()..a.len() + 1) == Some(\"=\") {\n+                // An equals option, like `--crate-type=rlib`\n                 arg[a.len() + 1..].to_string()\n             } else {\n+                // A non-space option, like `-Cincremental=foo`\n                 arg[a.len()..].to_string()\n             };\n-            if ICE_REPORT_COMPILER_FLAGS_EXCLUDE.iter().any(|exc| content.starts_with(exc)) {\n+            let option = content.split_once('=').map(|s| s.0).unwrap_or(&content);\n+            if ICE_REPORT_COMPILER_FLAGS_EXCLUDE.iter().any(|exc| option == *exc) {\n                 excluded_cargo_defaults = true;\n             } else {\n                 result.push(a.to_string());\n-                match ICE_REPORT_COMPILER_FLAGS_STRIP_VALUE.iter().find(|s| content.starts_with(*s))\n-                {\n-                    Some(s) => result.push(s.to_string()),\n+                match ICE_REPORT_COMPILER_FLAGS_STRIP_VALUE.iter().find(|s| option == **s) {\n+                    Some(s) => result.push(format!(\"{}=[REDACTED]\", s)),\n                     None => result.push(content),\n                 }\n             }"}]}