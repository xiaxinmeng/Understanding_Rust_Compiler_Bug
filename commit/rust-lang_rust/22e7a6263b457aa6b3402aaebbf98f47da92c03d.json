{"sha": "22e7a6263b457aa6b3402aaebbf98f47da92c03d", "node_id": "MDY6Q29tbWl0NzI0NzEyOjIyZTdhNjI2M2I0NTdhYTZiMzQwMmFhZWJiZjk4ZjQ3ZGE5MmMwM2Q=", "commit": {"author": {"name": "Justus K", "email": "justus.k@protonmail.com", "date": "2020-07-09T11:16:38Z"}, "committer": {"name": "Justus K", "email": "justus.k@protonmail.com", "date": "2020-07-09T11:16:38Z"}, "message": "Early exit if program doesn't contain a main fn", "tree": {"sha": "8c9fa78c757a3ba21bed257ada0b87443b0e4d44", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8c9fa78c757a3ba21bed257ada0b87443b0e4d44"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/22e7a6263b457aa6b3402aaebbf98f47da92c03d", "comment_count": 0, "verification": {"verified": false, "reason": "unknown_key", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEAnt70qq/3wgMiTrgT9TFg+Q3uKoFAl8G/LcACgkQT9TFg+Q3\nuKoFEQ//Zb1YbBcxPUDWnlit33R56tTKHBxyULG8nARmj53MEdP63DNBERw8oLXQ\nQtIhB6y91m6uXf2mpLRdvMYg6Rlw7Gei6kdLzpGvc/nwLxoG+a8DJrn9mhtZHoZ/\nHK4O7s5ImsBVSS5UIKdYthL1x5CiGLT4IQgEN1ewFh7VWN4ZYufnf7wbE3YZMEHs\nW9xyFdV1wOv0WS0+vp1URGZuxnGDZGqmf5LvoIpEKvplUi3/cvCICUAE8OE/FmQg\n9/uPG+gIU0/vwlPxqbc62ZEWCzxVBSa8YV/d3i3HI370wBYyoFFk/WyEdMYUYd9N\n00/8plGLw5gnNYGJcWeZ56mCp6OjfncnnpzkF3+wVi/Fwv32bvw+aekK4vXu0lV0\nQ4/3jDgf+46uycHvNUOhkV745t4fZKXYcT/b5w560zlSU/SxSldQ8/3OFdhSlMk/\nncrQbNhgC7615kQtY8wT6qcypIm69m2DTO9c64pVJJb3YbEpVqY2xTMUdFMd/Jx7\nsll2y/dxPrIFmc3lBXowdGs+qLICFXNmNT3ugco0UyO1ZC2qzLwtJ30gySqWhZtV\nuVXEz3SvfL6nYCAwkwmeZj4lSpADelkFHl9AnqRslzpeQN9fPuHCNhV23blcfjDn\nPM2MYruVs6QK2fPgzsg9LHe++JfVsLrG4QwiM80k0TlJ3m220pI=\n=l4A3\n-----END PGP SIGNATURE-----", "payload": "tree 8c9fa78c757a3ba21bed257ada0b87443b0e4d44\nparent b245786f9d3466bc9ae66f894cb5288e32eaac07\nauthor Justus K <justus.k@protonmail.com> 1594293398 +0200\ncommitter Justus K <justus.k@protonmail.com> 1594293398 +0200\n\nEarly exit if program doesn't contain a main fn\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/22e7a6263b457aa6b3402aaebbf98f47da92c03d", "html_url": "https://github.com/rust-lang/rust/commit/22e7a6263b457aa6b3402aaebbf98f47da92c03d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/22e7a6263b457aa6b3402aaebbf98f47da92c03d/comments", "author": {"login": "Stupremee", "id": 39732259, "node_id": "MDQ6VXNlcjM5NzMyMjU5", "avatar_url": "https://avatars.githubusercontent.com/u/39732259?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Stupremee", "html_url": "https://github.com/Stupremee", "followers_url": "https://api.github.com/users/Stupremee/followers", "following_url": "https://api.github.com/users/Stupremee/following{/other_user}", "gists_url": "https://api.github.com/users/Stupremee/gists{/gist_id}", "starred_url": "https://api.github.com/users/Stupremee/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Stupremee/subscriptions", "organizations_url": "https://api.github.com/users/Stupremee/orgs", "repos_url": "https://api.github.com/users/Stupremee/repos", "events_url": "https://api.github.com/users/Stupremee/events{/privacy}", "received_events_url": "https://api.github.com/users/Stupremee/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Stupremee", "id": 39732259, "node_id": "MDQ6VXNlcjM5NzMyMjU5", "avatar_url": "https://avatars.githubusercontent.com/u/39732259?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Stupremee", "html_url": "https://github.com/Stupremee", "followers_url": "https://api.github.com/users/Stupremee/followers", "following_url": "https://api.github.com/users/Stupremee/following{/other_user}", "gists_url": "https://api.github.com/users/Stupremee/gists{/gist_id}", "starred_url": "https://api.github.com/users/Stupremee/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Stupremee/subscriptions", "organizations_url": "https://api.github.com/users/Stupremee/orgs", "repos_url": "https://api.github.com/users/Stupremee/repos", "events_url": "https://api.github.com/users/Stupremee/events{/privacy}", "received_events_url": "https://api.github.com/users/Stupremee/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b245786f9d3466bc9ae66f894cb5288e32eaac07", "url": "https://api.github.com/repos/rust-lang/rust/commits/b245786f9d3466bc9ae66f894cb5288e32eaac07", "html_url": "https://github.com/rust-lang/rust/commit/b245786f9d3466bc9ae66f894cb5288e32eaac07"}], "stats": {"total": 11, "additions": 9, "deletions": 2}, "files": [{"sha": "73e52af4ec51d1da9476b10ddb51be47b786d032", "filename": "src/bin/miri.rs", "status": "modified", "additions": 9, "deletions": 2, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/22e7a6263b457aa6b3402aaebbf98f47da92c03d/src%2Fbin%2Fmiri.rs", "raw_url": "https://github.com/rust-lang/rust/raw/22e7a6263b457aa6b3402aaebbf98f47da92c03d/src%2Fbin%2Fmiri.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbin%2Fmiri.rs?ref=22e7a6263b457aa6b3402aaebbf98f47da92c03d", "patch": "@@ -5,6 +5,7 @@ extern crate rustc_driver;\n extern crate rustc_hir;\n extern crate rustc_interface;\n extern crate rustc_session;\n+extern crate rustc_errors;\n \n use std::convert::TryFrom;\n use std::env;\n@@ -13,7 +14,8 @@ use std::str::FromStr;\n use hex::FromHexError;\n use log::debug;\n \n-use rustc_session::CtfeBacktrace;\n+use rustc_session::{CtfeBacktrace, config::ErrorOutputType};\n+use rustc_errors::emitter::{HumanReadableErrorType, ColorConfig};\n use rustc_driver::Compilation;\n use rustc_hir::def_id::LOCAL_CRATE;\n use rustc_middle::ty::TyCtxt;\n@@ -32,7 +34,12 @@ impl rustc_driver::Callbacks for MiriCompilerCalls {\n \n         queries.global_ctxt().unwrap().peek_mut().enter(|tcx| {\n             init_late_loggers(tcx);\n-            let (entry_def_id, _) = tcx.entry_fn(LOCAL_CRATE).expect(\"no main function found!\");\n+            let (entry_def_id, _) = if let Some((entry_def, x)) = tcx.entry_fn(LOCAL_CRATE) {\n+                (entry_def, x)\n+            } else {\n+                let output_ty = ErrorOutputType::HumanReadable(HumanReadableErrorType::Default(ColorConfig::Auto));\n+                rustc_session::early_error(output_ty, \"miri can only run programs that have a main function\");\n+            };\n             let mut config = self.miri_config.clone();\n \n             // Add filename to `miri` arguments."}]}