{"sha": "a37126b90cc9373420e92cebddb4b62d3ded16e1", "node_id": "MDY6Q29tbWl0NzI0NzEyOmEzNzEyNmI5MGNjOTM3MzQyMGU5MmNlYmRkYjRiNjJkM2RlZDE2ZTE=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-01-02T11:22:40Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-01-02T11:22:40Z"}, "message": "Auto merge of #47042 - redox-os:redox, r=estebank\n\nRedox - Implement rename using new system call\n\nThis does the following:\n\n- Update syscall module to match upstream\n- Implement rename using new system call\n- Make readlink and symlink utilize O_CLOEXEC\n- Make readlink and symlink not leave dangling file handles on failure", "tree": {"sha": "2bedcdd9a5b1dfa631ee4a53fb1c8ff794198a95", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2bedcdd9a5b1dfa631ee4a53fb1c8ff794198a95"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a37126b90cc9373420e92cebddb4b62d3ded16e1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a37126b90cc9373420e92cebddb4b62d3ded16e1", "html_url": "https://github.com/rust-lang/rust/commit/a37126b90cc9373420e92cebddb4b62d3ded16e1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a37126b90cc9373420e92cebddb4b62d3ded16e1/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5873a74d8f8bceeb15a689a8fd6bd1f22c42b6ba", "url": "https://api.github.com/repos/rust-lang/rust/commits/5873a74d8f8bceeb15a689a8fd6bd1f22c42b6ba", "html_url": "https://github.com/rust-lang/rust/commit/5873a74d8f8bceeb15a689a8fd6bd1f22c42b6ba"}, {"sha": "5919243924bff22e7a2fb82a49269ebd25191537", "url": "https://api.github.com/repos/rust-lang/rust/commits/5919243924bff22e7a2fb82a49269ebd25191537", "html_url": "https://github.com/rust-lang/rust/commit/5919243924bff22e7a2fb82a49269ebd25191537"}], "stats": {"total": 41, "additions": 34, "deletions": 7}, "files": [{"sha": "2e2216186f1e6b8228e4a425a0c3345f494b534f", "filename": "src/libstd/sys/redox/fs.rs", "status": "modified", "additions": 13, "deletions": 6, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/a37126b90cc9373420e92cebddb4b62d3ded16e1/src%2Flibstd%2Fsys%2Fredox%2Ffs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a37126b90cc9373420e92cebddb4b62d3ded16e1/src%2Flibstd%2Fsys%2Fredox%2Ffs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Fredox%2Ffs.rs?ref=a37126b90cc9373420e92cebddb4b62d3ded16e1", "patch": "@@ -384,8 +384,11 @@ pub fn unlink(p: &Path) -> io::Result<()> {\n }\n \n pub fn rename(old: &Path, new: &Path) -> io::Result<()> {\n-    copy(old, new)?;\n-    unlink(old)?;\n+    let fd = cvt(syscall::open(old.to_str().unwrap(),\n+                               syscall::O_CLOEXEC | syscall::O_STAT | syscall::O_NOFOLLOW))?;\n+    let res = cvt(syscall::frename(fd, new.to_str().unwrap()));\n+    cvt(syscall::close(fd))?;\n+    res?;\n     Ok(())\n }\n \n@@ -421,18 +424,22 @@ fn remove_dir_all_recursive(path: &Path) -> io::Result<()> {\n }\n \n pub fn readlink(p: &Path) -> io::Result<PathBuf> {\n-    let fd = cvt(syscall::open(p.to_str().unwrap(), syscall::O_SYMLINK | syscall::O_RDONLY))?;\n+    let fd = cvt(syscall::open(p.to_str().unwrap(),\n+                               syscall::O_CLOEXEC | syscall::O_SYMLINK | syscall::O_RDONLY))?;\n     let mut buf: [u8; 4096] = [0; 4096];\n-    let count = cvt(syscall::read(fd, &mut buf))?;\n+    let res = cvt(syscall::read(fd, &mut buf));\n     cvt(syscall::close(fd))?;\n+    let count = res?;\n     Ok(PathBuf::from(unsafe { String::from_utf8_unchecked(Vec::from(&buf[..count])) }))\n }\n \n pub fn symlink(src: &Path, dst: &Path) -> io::Result<()> {\n     let fd = cvt(syscall::open(dst.to_str().unwrap(),\n-                               syscall::O_SYMLINK | syscall::O_CREAT | syscall::O_WRONLY | 0o777))?;\n-    cvt(syscall::write(fd, src.to_str().unwrap().as_bytes()))?;\n+                               syscall::O_CLOEXEC | syscall::O_SYMLINK |\n+                               syscall::O_CREAT | syscall::O_WRONLY | 0o777))?;\n+    let res = cvt(syscall::write(fd, src.to_str().unwrap().as_bytes()));\n     cvt(syscall::close(fd))?;\n+    res?;\n     Ok(())\n }\n "}, {"sha": "f9a8bd61ac800636a330d4cbb17cf8918e8a3820", "filename": "src/libstd/sys/redox/syscall/call.rs", "status": "modified", "additions": 18, "deletions": 1, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/a37126b90cc9373420e92cebddb4b62d3ded16e1/src%2Flibstd%2Fsys%2Fredox%2Fsyscall%2Fcall.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a37126b90cc9373420e92cebddb4b62d3ded16e1/src%2Flibstd%2Fsys%2Fredox%2Fsyscall%2Fcall.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Fredox%2Fsyscall%2Fcall.rs?ref=a37126b90cc9373420e92cebddb4b62d3ded16e1", "patch": "@@ -93,7 +93,19 @@ pub fn exit(status: usize) -> Result<usize> {\n     unsafe { syscall1(SYS_EXIT, status) }\n }\n \n-/// Register a file for event-based I/O\n+/// Change file permissions\n+pub fn fchmod(fd: usize, mode: u16) -> Result<usize> {\n+    unsafe { syscall2(SYS_FCHMOD, fd, mode as usize) }\n+\n+}\n+\n+/// Change file ownership\n+pub fn fchown(fd: usize, uid: u32, gid: u32) -> Result<usize> {\n+    unsafe { syscall3(SYS_FCHOWN, fd, uid as usize, gid as usize) }\n+\n+}\n+\n+/// Change file descriptor flags\n pub fn fcntl(fd: usize, cmd: usize, arg: usize) -> Result<usize> {\n     unsafe { syscall3(SYS_FCNTL, fd, cmd, arg) }\n }\n@@ -118,6 +130,11 @@ pub fn fpath(fd: usize, buf: &mut [u8]) -> Result<usize> {\n     unsafe { syscall3(SYS_FPATH, fd, buf.as_mut_ptr() as usize, buf.len()) }\n }\n \n+/// Rename a file\n+pub fn frename<T: AsRef<[u8]>>(fd: usize, path: T) -> Result<usize> {\n+    unsafe { syscall3(SYS_FRENAME, fd, path.as_ref().as_ptr() as usize, path.as_ref().len()) }\n+}\n+\n /// Get metadata about a file\n pub fn fstat(fd: usize, stat: &mut Stat) -> Result<usize> {\n     unsafe { syscall3(SYS_FSTAT, fd, stat as *mut Stat as usize, mem::size_of::<Stat>()) }"}, {"sha": "45cb40e390840a3f46300dbc48b7447784800431", "filename": "src/libstd/sys/redox/syscall/number.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/a37126b90cc9373420e92cebddb4b62d3ded16e1/src%2Flibstd%2Fsys%2Fredox%2Fsyscall%2Fnumber.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a37126b90cc9373420e92cebddb4b62d3ded16e1/src%2Flibstd%2Fsys%2Fredox%2Fsyscall%2Fnumber.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Fredox%2Fsyscall%2Fnumber.rs?ref=a37126b90cc9373420e92cebddb4b62d3ded16e1", "patch": "@@ -32,11 +32,14 @@ pub const SYS_DUP2: usize =     SYS_CLASS_FILE | SYS_RET_FILE | 63;\n pub const SYS_READ: usize =     SYS_CLASS_FILE | SYS_ARG_MSLICE | 3;\n pub const SYS_WRITE: usize =    SYS_CLASS_FILE | SYS_ARG_SLICE | 4;\n pub const SYS_LSEEK: usize =    SYS_CLASS_FILE | 19;\n+pub const SYS_FCHMOD: usize =   SYS_CLASS_FILE | 94;\n+pub const SYS_FCHOWN: usize =   SYS_CLASS_FILE | 207;\n pub const SYS_FCNTL: usize =    SYS_CLASS_FILE | 55;\n pub const SYS_FEVENT: usize =   SYS_CLASS_FILE | 927;\n pub const SYS_FMAP: usize =     SYS_CLASS_FILE | 90;\n pub const SYS_FUNMAP: usize =   SYS_CLASS_FILE | 91;\n pub const SYS_FPATH: usize =    SYS_CLASS_FILE | SYS_ARG_MSLICE | 928;\n+pub const SYS_FRENAME: usize =  SYS_CLASS_FILE | SYS_ARG_PATH | 38;\n pub const SYS_FSTAT: usize =    SYS_CLASS_FILE | SYS_ARG_MSLICE | 28;\n pub const SYS_FSTATVFS: usize = SYS_CLASS_FILE | SYS_ARG_MSLICE | 100;\n pub const SYS_FSYNC: usize =    SYS_CLASS_FILE | 118;"}]}