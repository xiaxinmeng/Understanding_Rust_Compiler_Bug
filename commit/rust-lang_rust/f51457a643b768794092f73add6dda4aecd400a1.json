{"sha": "f51457a643b768794092f73add6dda4aecd400a1", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY1MTQ1N2E2NDNiNzY4Nzk0MDkyZjczYWRkNmRkYTRhZWNkNDAwYTE=", "commit": {"author": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2021-01-14T17:35:22Z"}, "committer": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2021-01-14T17:35:22Z"}, "message": "Group file source edits by FileId", "tree": {"sha": "8deeda89c7709aa69918d24ee4ecd18ea0e179db", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8deeda89c7709aa69918d24ee4ecd18ea0e179db"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f51457a643b768794092f73add6dda4aecd400a1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f51457a643b768794092f73add6dda4aecd400a1", "html_url": "https://github.com/rust-lang/rust/commit/f51457a643b768794092f73add6dda4aecd400a1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f51457a643b768794092f73add6dda4aecd400a1/comments", "author": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f88f3d688507508ae9528101e13e1c62902467a3", "url": "https://api.github.com/repos/rust-lang/rust/commits/f88f3d688507508ae9528101e13e1c62902467a3", "html_url": "https://github.com/rust-lang/rust/commit/f88f3d688507508ae9528101e13e1c62902467a3"}], "stats": {"total": 360, "additions": 184, "deletions": 176}, "files": [{"sha": "de4b32573a57063a16e0afd562a2ac28093d3634", "filename": "crates/assists/src/assist_context.rs", "status": "modified", "additions": 4, "deletions": 12, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/f51457a643b768794092f73add6dda4aecd400a1/crates%2Fassists%2Fsrc%2Fassist_context.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f51457a643b768794092f73add6dda4aecd400a1/crates%2Fassists%2Fsrc%2Fassist_context.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fassists%2Fsrc%2Fassist_context.rs?ref=f51457a643b768794092f73add6dda4aecd400a1", "patch": "@@ -10,7 +10,7 @@ use ide_db::{\n };\n use ide_db::{\n     label::Label,\n-    source_change::{FileSystemEdit, SourceChange, SourceFileEdit},\n+    source_change::{FileSystemEdit, SourceChange, SourceFileEdits},\n     RootDatabase,\n };\n use syntax::{\n@@ -181,7 +181,7 @@ pub(crate) struct AssistBuilder {\n     edit: TextEditBuilder,\n     file_id: FileId,\n     is_snippet: bool,\n-    source_file_edits: Vec<SourceFileEdit>,\n+    source_file_edits: SourceFileEdits,\n     file_system_edits: Vec<FileSystemEdit>,\n }\n \n@@ -191,7 +191,7 @@ impl AssistBuilder {\n             edit: TextEdit::builder(),\n             file_id,\n             is_snippet: false,\n-            source_file_edits: Vec::default(),\n+            source_file_edits: SourceFileEdits::default(),\n             file_system_edits: Vec::default(),\n         }\n     }\n@@ -204,15 +204,7 @@ impl AssistBuilder {\n     fn commit(&mut self) {\n         let edit = mem::take(&mut self.edit).finish();\n         if !edit.is_empty() {\n-            match self.source_file_edits.binary_search_by_key(&self.file_id, |edit| edit.file_id) {\n-                Ok(idx) => self.source_file_edits[idx]\n-                    .edit\n-                    .union(edit)\n-                    .expect(\"overlapping edits for same file\"),\n-                Err(idx) => self\n-                    .source_file_edits\n-                    .insert(idx, SourceFileEdit { file_id: self.file_id, edit }),\n-            }\n+            self.source_file_edits.insert(self.file_id, edit);\n         }\n     }\n "}, {"sha": "d13d6ad31ee5e7ac242a72f64c59f94def414b7f", "filename": "crates/assists/src/tests.rs", "status": "modified", "additions": 8, "deletions": 11, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/f51457a643b768794092f73add6dda4aecd400a1/crates%2Fassists%2Fsrc%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f51457a643b768794092f73add6dda4aecd400a1/crates%2Fassists%2Fsrc%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fassists%2Fsrc%2Ftests.rs?ref=f51457a643b768794092f73add6dda4aecd400a1", "patch": "@@ -80,10 +80,8 @@ fn check_doc_test(assist_id: &str, before: &str, after: &str) {\n     let actual = {\n         let source_change = assist.source_change.unwrap();\n         let mut actual = before;\n-        for source_file_edit in source_change.source_file_edits {\n-            if source_file_edit.file_id == file_id {\n-                source_file_edit.edit.apply(&mut actual)\n-            }\n+        if let Some(source_file_edit) = source_change.source_file_edits.edits.get(&file_id) {\n+            source_file_edit.apply(&mut actual);\n         }\n         actual\n     };\n@@ -116,20 +114,19 @@ fn check(handler: Handler, before: &str, expected: ExpectedResult, assist_label:\n \n     match (assist, expected) {\n         (Some(assist), ExpectedResult::After(after)) => {\n-            let mut source_change = assist.source_change.unwrap();\n+            let source_change = assist.source_change.unwrap();\n             assert!(!source_change.source_file_edits.is_empty());\n             let skip_header = source_change.source_file_edits.len() == 1\n                 && source_change.file_system_edits.len() == 0;\n-            source_change.source_file_edits.sort_by_key(|it| it.file_id);\n \n             let mut buf = String::new();\n-            for source_file_edit in source_change.source_file_edits {\n-                let mut text = db.file_text(source_file_edit.file_id).as_ref().to_owned();\n-                source_file_edit.edit.apply(&mut text);\n+            for (file_id, edit) in source_change.source_file_edits.edits {\n+                let mut text = db.file_text(file_id).as_ref().to_owned();\n+                edit.apply(&mut text);\n                 if !skip_header {\n-                    let sr = db.file_source_root(source_file_edit.file_id);\n+                    let sr = db.file_source_root(file_id);\n                     let sr = db.source_root(sr);\n-                    let path = sr.path_for_file(&source_file_edit.file_id).unwrap();\n+                    let path = sr.path_for_file(&file_id).unwrap();\n                     format_to!(buf, \"//- {}\\n\", path)\n                 }\n                 buf.push_str(&text);"}, {"sha": "a43188fb0a4db469f698164d1a95fc6107ba2cd1", "filename": "crates/ide/src/diagnostics.rs", "status": "modified", "additions": 9, "deletions": 10, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/f51457a643b768794092f73add6dda4aecd400a1/crates%2Fide%2Fsrc%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f51457a643b768794092f73add6dda4aecd400a1/crates%2Fide%2Fsrc%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fdiagnostics.rs?ref=f51457a643b768794092f73add6dda4aecd400a1", "patch": "@@ -13,8 +13,7 @@ use hir::{\n     diagnostics::{Diagnostic as _, DiagnosticCode, DiagnosticSinkBuilder},\n     Semantics,\n };\n-use ide_db::base_db::SourceDatabase;\n-use ide_db::RootDatabase;\n+use ide_db::{base_db::SourceDatabase, source_change::SourceFileEdits, RootDatabase};\n use itertools::Itertools;\n use rustc_hash::FxHashSet;\n use syntax::{\n@@ -23,7 +22,7 @@ use syntax::{\n };\n use text_edit::TextEdit;\n \n-use crate::{FileId, Label, SourceChange, SourceFileEdit};\n+use crate::{FileId, Label, SourceChange};\n \n use self::fixes::DiagnosticWithFix;\n \n@@ -220,7 +219,7 @@ fn check_unnecessary_braces_in_use_statement(\n             Diagnostic::hint(use_range, \"Unnecessary braces in use statement\".to_string())\n                 .with_fix(Some(Fix::new(\n                     \"Remove unnecessary braces\",\n-                    SourceFileEdit { file_id, edit }.into(),\n+                    SourceFileEdits::from_text_edit(file_id, edit).into(),\n                     use_range,\n                 ))),\n         );\n@@ -265,13 +264,11 @@ mod tests {\n             .unwrap();\n         let fix = diagnostic.fix.unwrap();\n         let actual = {\n-            let file_id = fix.source_change.source_file_edits.first().unwrap().file_id;\n+            let file_id = *fix.source_change.source_file_edits.edits.keys().next().unwrap();\n             let mut actual = analysis.file_text(file_id).unwrap().to_string();\n \n-            // Go from the last one to the first one, so that ranges won't be affected by previous edits.\n-            // FIXME: https://github.com/rust-analyzer/rust-analyzer/issues/4901#issuecomment-644675309\n-            for edit in fix.source_change.source_file_edits.iter().rev() {\n-                edit.edit.apply(&mut actual);\n+            for edit in fix.source_change.source_file_edits.edits.values() {\n+                edit.apply(&mut actual);\n             }\n             actual\n         };\n@@ -616,7 +613,9 @@ fn test_fn() {\n                             Fix {\n                                 label: \"Create module\",\n                                 source_change: SourceChange {\n-                                    source_file_edits: [],\n+                                    source_file_edits: SourceFileEdits {\n+                                        edits: {},\n+                                    },\n                                     file_system_edits: [\n                                         CreateFile {\n                                             dst: AnchoredPathBuf {"}, {"sha": "f4ec51b6442520fdea761e1a680b037a8f9b28c4", "filename": "crates/ide/src/diagnostics/field_shorthand.rs", "status": "modified", "additions": 3, "deletions": 4, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/f51457a643b768794092f73add6dda4aecd400a1/crates%2Fide%2Fsrc%2Fdiagnostics%2Ffield_shorthand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f51457a643b768794092f73add6dda4aecd400a1/crates%2Fide%2Fsrc%2Fdiagnostics%2Ffield_shorthand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fdiagnostics%2Ffield_shorthand.rs?ref=f51457a643b768794092f73add6dda4aecd400a1", "patch": "@@ -1,8 +1,7 @@\n //! Suggests shortening `Foo { field: field }` to `Foo { field }` in both\n //! expressions and patterns.\n \n-use ide_db::base_db::FileId;\n-use ide_db::source_change::SourceFileEdit;\n+use ide_db::{base_db::FileId, source_change::SourceFileEdits};\n use syntax::{ast, match_ast, AstNode, SyntaxNode};\n use text_edit::TextEdit;\n \n@@ -50,7 +49,7 @@ fn check_expr_field_shorthand(\n             Diagnostic::hint(field_range, \"Shorthand struct initialization\".to_string()).with_fix(\n                 Some(Fix::new(\n                     \"Use struct shorthand initialization\",\n-                    SourceFileEdit { file_id, edit }.into(),\n+                    SourceFileEdits::from_text_edit(file_id, edit).into(),\n                     field_range,\n                 )),\n             ),\n@@ -89,7 +88,7 @@ fn check_pat_field_shorthand(\n         acc.push(Diagnostic::hint(field_range, \"Shorthand struct pattern\".to_string()).with_fix(\n             Some(Fix::new(\n                 \"Use struct field shorthand\",\n-                SourceFileEdit { file_id, edit }.into(),\n+                SourceFileEdits::from_text_edit(file_id, edit).into(),\n                 field_range,\n             )),\n         ));"}, {"sha": "b04964ccd535f03c3a1ce54a17b5ea50671913c2", "filename": "crates/ide/src/diagnostics/fixes.rs", "status": "modified", "additions": 9, "deletions": 9, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/f51457a643b768794092f73add6dda4aecd400a1/crates%2Fide%2Fsrc%2Fdiagnostics%2Ffixes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f51457a643b768794092f73add6dda4aecd400a1/crates%2Fide%2Fsrc%2Fdiagnostics%2Ffixes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fdiagnostics%2Ffixes.rs?ref=f51457a643b768794092f73add6dda4aecd400a1", "patch": "@@ -8,9 +8,9 @@ use hir::{\n     },\n     HasSource, HirDisplay, InFile, Semantics, VariantDef,\n };\n-use ide_db::base_db::{AnchoredPathBuf, FileId};\n use ide_db::{\n-    source_change::{FileSystemEdit, SourceFileEdit},\n+    base_db::{AnchoredPathBuf, FileId},\n+    source_change::{FileSystemEdit, SourceFileEdits},\n     RootDatabase,\n };\n use syntax::{\n@@ -88,7 +88,7 @@ impl DiagnosticWithFix for MissingFields {\n         };\n         Some(Fix::new(\n             \"Fill struct fields\",\n-            SourceFileEdit { file_id: self.file.original_file(sema.db), edit }.into(),\n+            SourceFileEdits::from_text_edit(self.file.original_file(sema.db), edit).into(),\n             sema.original_range(&field_list_parent.syntax()).range,\n         ))\n     }\n@@ -102,7 +102,7 @@ impl DiagnosticWithFix for MissingOkOrSomeInTailExpr {\n         let replacement = format!(\"{}({})\", self.required, tail_expr.syntax());\n         let edit = TextEdit::replace(tail_expr_range, replacement);\n         let source_change =\n-            SourceFileEdit { file_id: self.file.original_file(sema.db), edit }.into();\n+            SourceFileEdits::from_text_edit(self.file.original_file(sema.db), edit).into();\n         let name = if self.required == \"Ok\" { \"Wrap with Ok\" } else { \"Wrap with Some\" };\n         Some(Fix::new(name, source_change, tail_expr_range))\n     }\n@@ -123,7 +123,7 @@ impl DiagnosticWithFix for RemoveThisSemicolon {\n \n         let edit = TextEdit::delete(semicolon);\n         let source_change =\n-            SourceFileEdit { file_id: self.file.original_file(sema.db), edit }.into();\n+            SourceFileEdits::from_text_edit(self.file.original_file(sema.db), edit).into();\n \n         Some(Fix::new(\"Remove this semicolon\", source_change, semicolon))\n     }\n@@ -204,10 +204,10 @@ fn missing_record_expr_field_fix(\n         new_field = format!(\",{}\", new_field);\n     }\n \n-    let source_change = SourceFileEdit {\n-        file_id: def_file_id,\n-        edit: TextEdit::insert(last_field_syntax.text_range().end(), new_field),\n-    };\n+    let source_change = SourceFileEdits::from_text_edit(\n+        def_file_id,\n+        TextEdit::insert(last_field_syntax.text_range().end(), new_field),\n+    );\n     return Some(Fix::new(\n         \"Create field\",\n         source_change.into(),"}, {"sha": "110920e58df203bdf19f222743a34e5dacb75c7d", "filename": "crates/ide/src/lib.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/f51457a643b768794092f73add6dda4aecd400a1/crates%2Fide%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f51457a643b768794092f73add6dda4aecd400a1/crates%2Fide%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Flib.rs?ref=f51457a643b768794092f73add6dda4aecd400a1", "patch": "@@ -98,7 +98,7 @@ pub use ide_db::{\n     label::Label,\n     line_index::{LineCol, LineIndex},\n     search::SearchScope,\n-    source_change::{FileSystemEdit, SourceChange, SourceFileEdit},\n+    source_change::{FileSystemEdit, SourceChange, SourceFileEdits},\n     symbol_index::Query,\n     RootDatabase,\n };\n@@ -553,7 +553,7 @@ impl Analysis {\n             let rule: ssr::SsrRule = query.parse()?;\n             let mut match_finder = ssr::MatchFinder::in_context(db, resolve_context, selections);\n             match_finder.add_rule(rule)?;\n-            let edits = if parse_only { Vec::new() } else { match_finder.edits() };\n+            let edits = if parse_only { Default::default() } else { match_finder.edits() };\n             Ok(SourceChange::from(edits))\n         })\n     }"}, {"sha": "cd9c7c7e5720498f6797582d12575291635604af", "filename": "crates/ide/src/references/rename.rs", "status": "modified", "additions": 57, "deletions": 81, "changes": 138, "blob_url": "https://github.com/rust-lang/rust/blob/f51457a643b768794092f73add6dda4aecd400a1/crates%2Fide%2Fsrc%2Freferences%2Frename.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f51457a643b768794092f73add6dda4aecd400a1/crates%2Fide%2Fsrc%2Freferences%2Frename.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Freferences%2Frename.rs?ref=f51457a643b768794092f73add6dda4aecd400a1", "patch": "@@ -21,7 +21,7 @@ use text_edit::TextEdit;\n \n use crate::{\n     FilePosition, FileSystemEdit, RangeInfo, ReferenceKind, ReferenceSearchResult, SourceChange,\n-    SourceFileEdit, TextRange, TextSize,\n+    SourceFileEdits, TextRange, TextSize,\n };\n \n type RenameResult<T> = Result<T, RenameError>;\n@@ -58,7 +58,7 @@ pub(crate) fn prepare_rename(\n         rename_self_to_param(&sema, position, self_token, \"dummy\")\n     } else {\n         let RangeInfo { range, .. } = find_all_refs(&sema, position)?;\n-        Ok(RangeInfo::new(range, SourceChange::from(vec![])))\n+        Ok(RangeInfo::new(range, SourceChange::default()))\n     }\n     .map(|info| RangeInfo::new(info.range, ()))\n }\n@@ -176,7 +176,7 @@ fn source_edit_from_references(\n     file_id: FileId,\n     references: &[FileReference],\n     new_name: &str,\n-) -> SourceFileEdit {\n+) -> (FileId, TextEdit) {\n     let mut edit = TextEdit::builder();\n     for reference in references {\n         let mut replacement_text = String::new();\n@@ -209,8 +209,7 @@ fn source_edit_from_references(\n         };\n         edit.replace(range, replacement_text);\n     }\n-\n-    SourceFileEdit { file_id, edit: edit.finish() }\n+    (file_id, edit.finish())\n }\n \n fn edit_text_range_for_record_field_expr_or_pat(\n@@ -250,7 +249,7 @@ fn rename_mod(\n     if IdentifierKind::Ident != check_identifier(new_name)? {\n         bail!(\"Invalid name `{0}`: cannot rename module to {0}\", new_name);\n     }\n-    let mut source_file_edits = Vec::new();\n+    let mut source_file_edits = SourceFileEdits::default();\n     let mut file_system_edits = Vec::new();\n \n     let src = module.definition_source(sema.db);\n@@ -273,11 +272,8 @@ fn rename_mod(\n     if let Some(src) = module.declaration_source(sema.db) {\n         let file_id = src.file_id.original_file(sema.db);\n         let name = src.value.name().unwrap();\n-        let edit = SourceFileEdit {\n-            file_id,\n-            edit: TextEdit::replace(name.syntax().text_range(), new_name.into()),\n-        };\n-        source_file_edits.push(edit);\n+        source_file_edits\n+            .insert(file_id, TextEdit::replace(name.syntax().text_range(), new_name.into()));\n     }\n \n     let RangeInfo { range, info: refs } = find_all_refs(sema, position)?;\n@@ -335,20 +331,13 @@ fn rename_to_self(\n \n     let RangeInfo { range, info: refs } = find_all_refs(sema, position)?;\n \n-    let mut edits = refs\n-        .references()\n-        .iter()\n-        .map(|(&file_id, references)| {\n-            source_edit_from_references(sema, file_id, references, \"self\")\n-        })\n-        .collect::<Vec<_>>();\n+    let mut edits = SourceFileEdits::default();\n+    edits.extend(refs.references().iter().map(|(&file_id, references)| {\n+        source_edit_from_references(sema, file_id, references, \"self\")\n+    }));\n+    edits.insert(position.file_id, TextEdit::replace(param_range, String::from(self_param)));\n \n-    edits.push(SourceFileEdit {\n-        file_id: position.file_id,\n-        edit: TextEdit::replace(param_range, String::from(self_param)),\n-    });\n-\n-    Ok(RangeInfo::new(range, SourceChange::from(edits)))\n+    Ok(RangeInfo::new(range, edits.into()))\n }\n \n fn text_edit_from_self_param(\n@@ -402,7 +391,7 @@ fn rename_self_to_param(\n         .ok_or_else(|| format_err!(\"No surrounding method declaration found\"))?;\n     let search_range = fn_def.syntax().text_range();\n \n-    let mut edits: Vec<SourceFileEdit> = vec![];\n+    let mut edits = SourceFileEdits::default();\n \n     for (idx, _) in text.match_indices(\"self\") {\n         let offset: TextSize = idx.try_into().unwrap();\n@@ -416,7 +405,7 @@ fn rename_self_to_param(\n             } else {\n                 TextEdit::replace(usage.text_range(), String::from(new_name))\n             };\n-            edits.push(SourceFileEdit { file_id: position.file_id, edit });\n+            edits.insert(position.file_id, edit);\n         }\n     }\n \n@@ -427,7 +416,7 @@ fn rename_self_to_param(\n     let range = ast::SelfParam::cast(self_token.parent())\n         .map_or(self_token.text_range(), |p| p.syntax().text_range());\n \n-    Ok(RangeInfo::new(range, SourceChange::from(edits)))\n+    Ok(RangeInfo::new(range, edits.into()))\n }\n \n fn rename_reference(\n@@ -464,14 +453,12 @@ fn rename_reference(\n         (IdentifierKind::Ident, _) | (IdentifierKind::Underscore, _) => mark::hit!(rename_ident),\n     }\n \n-    let edit = refs\n-        .into_iter()\n-        .map(|(file_id, references)| {\n-            source_edit_from_references(sema, file_id, &references, new_name)\n-        })\n-        .collect::<Vec<_>>();\n+    let mut edits = SourceFileEdits::default();\n+    edits.extend(refs.into_iter().map(|(file_id, references)| {\n+        source_edit_from_references(sema, file_id, &references, new_name)\n+    }));\n \n-    Ok(RangeInfo::new(range, SourceChange::from(edit)))\n+    Ok(RangeInfo::new(range, edits.into()))\n }\n \n #[cfg(test)]\n@@ -493,9 +480,9 @@ mod tests {\n             Ok(source_change) => {\n                 let mut text_edit_builder = TextEdit::builder();\n                 let mut file_id: Option<FileId> = None;\n-                for edit in source_change.info.source_file_edits {\n-                    file_id = Some(edit.file_id);\n-                    for indel in edit.edit.into_iter() {\n+                for edit in source_change.info.source_file_edits.edits {\n+                    file_id = Some(edit.0);\n+                    for indel in edit.1.into_iter() {\n                         text_edit_builder.replace(indel.delete, indel.insert);\n                     }\n                 }\n@@ -895,12 +882,11 @@ mod foo$0;\n                 RangeInfo {\n                     range: 4..7,\n                     info: SourceChange {\n-                        source_file_edits: [\n-                            SourceFileEdit {\n-                                file_id: FileId(\n+                        source_file_edits: SourceFileEdits {\n+                            edits: {\n+                                FileId(\n                                     1,\n-                                ),\n-                                edit: TextEdit {\n+                                ): TextEdit {\n                                     indels: [\n                                         Indel {\n                                             insert: \"foo2\",\n@@ -909,7 +895,7 @@ mod foo$0;\n                                     ],\n                                 },\n                             },\n-                        ],\n+                        },\n                         file_system_edits: [\n                             MoveFile {\n                                 src: FileId(\n@@ -950,25 +936,21 @@ use crate::foo$0::FooContent;\n                 RangeInfo {\n                     range: 11..14,\n                     info: SourceChange {\n-                        source_file_edits: [\n-                            SourceFileEdit {\n-                                file_id: FileId(\n+                        source_file_edits: SourceFileEdits {\n+                            edits: {\n+                                FileId(\n                                     0,\n-                                ),\n-                                edit: TextEdit {\n+                                ): TextEdit {\n                                     indels: [\n                                         Indel {\n                                             insert: \"quux\",\n                                             delete: 8..11,\n                                         },\n                                     ],\n                                 },\n-                            },\n-                            SourceFileEdit {\n-                                file_id: FileId(\n+                                FileId(\n                                     2,\n-                                ),\n-                                edit: TextEdit {\n+                                ): TextEdit {\n                                     indels: [\n                                         Indel {\n                                             insert: \"quux\",\n@@ -977,7 +959,7 @@ use crate::foo$0::FooContent;\n                                     ],\n                                 },\n                             },\n-                        ],\n+                        },\n                         file_system_edits: [\n                             MoveFile {\n                                 src: FileId(\n@@ -1012,12 +994,11 @@ mod fo$0o;\n                 RangeInfo {\n                     range: 4..7,\n                     info: SourceChange {\n-                        source_file_edits: [\n-                            SourceFileEdit {\n-                                file_id: FileId(\n+                        source_file_edits: SourceFileEdits {\n+                            edits: {\n+                                FileId(\n                                     0,\n-                                ),\n-                                edit: TextEdit {\n+                                ): TextEdit {\n                                     indels: [\n                                         Indel {\n                                             insert: \"foo2\",\n@@ -1026,7 +1007,7 @@ mod fo$0o;\n                                     ],\n                                 },\n                             },\n-                        ],\n+                        },\n                         file_system_edits: [\n                             MoveFile {\n                                 src: FileId(\n@@ -1062,12 +1043,11 @@ mod outer { mod fo$0o; }\n                 RangeInfo {\n                     range: 16..19,\n                     info: SourceChange {\n-                        source_file_edits: [\n-                            SourceFileEdit {\n-                                file_id: FileId(\n+                        source_file_edits: SourceFileEdits {\n+                            edits: {\n+                                FileId(\n                                     0,\n-                                ),\n-                                edit: TextEdit {\n+                                ): TextEdit {\n                                     indels: [\n                                         Indel {\n                                             insert: \"bar\",\n@@ -1076,7 +1056,7 @@ mod outer { mod fo$0o; }\n                                     ],\n                                 },\n                             },\n-                        ],\n+                        },\n                         file_system_edits: [\n                             MoveFile {\n                                 src: FileId(\n@@ -1135,34 +1115,30 @@ pub mod foo$0;\n                 RangeInfo {\n                     range: 8..11,\n                     info: SourceChange {\n-                        source_file_edits: [\n-                            SourceFileEdit {\n-                                file_id: FileId(\n-                                    1,\n-                                ),\n-                                edit: TextEdit {\n+                        source_file_edits: SourceFileEdits {\n+                            edits: {\n+                                FileId(\n+                                    0,\n+                                ): TextEdit {\n                                     indels: [\n                                         Indel {\n                                             insert: \"foo2\",\n-                                            delete: 8..11,\n+                                            delete: 27..30,\n                                         },\n                                     ],\n                                 },\n-                            },\n-                            SourceFileEdit {\n-                                file_id: FileId(\n-                                    0,\n-                                ),\n-                                edit: TextEdit {\n+                                FileId(\n+                                    1,\n+                                ): TextEdit {\n                                     indels: [\n                                         Indel {\n                                             insert: \"foo2\",\n-                                            delete: 27..30,\n+                                            delete: 8..11,\n                                         },\n                                     ],\n                                 },\n                             },\n-                        ],\n+                        },\n                         file_system_edits: [\n                             MoveFile {\n                                 src: FileId("}, {"sha": "b3fc326458faa84f0559ec38f0a87eeccf67b717", "filename": "crates/ide/src/typing.rs", "status": "modified", "additions": 6, "deletions": 3, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/f51457a643b768794092f73add6dda4aecd400a1/crates%2Fide%2Fsrc%2Ftyping.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f51457a643b768794092f73add6dda4aecd400a1/crates%2Fide%2Fsrc%2Ftyping.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Ftyping.rs?ref=f51457a643b768794092f73add6dda4aecd400a1", "patch": "@@ -15,8 +15,11 @@\n \n mod on_enter;\n \n-use ide_db::base_db::{FilePosition, SourceDatabase};\n-use ide_db::{source_change::SourceFileEdit, RootDatabase};\n+use ide_db::{\n+    base_db::{FilePosition, SourceDatabase},\n+    source_change::SourceFileEdits,\n+    RootDatabase,\n+};\n use syntax::{\n     algo::find_node_at_offset,\n     ast::{self, edit::IndentLevel, AstToken},\n@@ -56,7 +59,7 @@ pub(crate) fn on_char_typed(\n     let file = &db.parse(position.file_id).tree();\n     assert_eq!(file.syntax().text().char_at(position.offset), Some(char_typed));\n     let edit = on_char_typed_inner(file, position.offset, char_typed)?;\n-    Some(SourceFileEdit { file_id: position.file_id, edit }.into())\n+    Some(SourceFileEdits::from_text_edit(position.file_id, edit).into())\n }\n \n fn on_char_typed_inner(file: &SourceFile, offset: TextSize, char_typed: char) -> Option<TextEdit> {"}, {"sha": "516d7859a875763620c5b6f281b477d94a0fd3ae", "filename": "crates/ide_db/src/source_change.rs", "status": "modified", "additions": 42, "deletions": 12, "changes": 54, "blob_url": "https://github.com/rust-lang/rust/blob/f51457a643b768794092f73add6dda4aecd400a1/crates%2Fide_db%2Fsrc%2Fsource_change.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f51457a643b768794092f73add6dda4aecd400a1/crates%2Fide_db%2Fsrc%2Fsource_change.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_db%2Fsrc%2Fsource_change.rs?ref=f51457a643b768794092f73add6dda4aecd400a1", "patch": "@@ -3,12 +3,18 @@\n //!\n //! It can be viewed as a dual for `AnalysisChange`.\n \n+use std::{\n+    collections::hash_map::Entry,\n+    iter::{self, FromIterator},\n+};\n+\n use base_db::{AnchoredPathBuf, FileId};\n+use rustc_hash::FxHashMap;\n use text_edit::TextEdit;\n \n #[derive(Default, Debug, Clone)]\n pub struct SourceChange {\n-    pub source_file_edits: Vec<SourceFileEdit>,\n+    pub source_file_edits: SourceFileEdits,\n     pub file_system_edits: Vec<FileSystemEdit>,\n     pub is_snippet: bool,\n }\n@@ -17,27 +23,51 @@ impl SourceChange {\n     /// Creates a new SourceChange with the given label\n     /// from the edits.\n     pub fn from_edits(\n-        source_file_edits: Vec<SourceFileEdit>,\n+        source_file_edits: SourceFileEdits,\n         file_system_edits: Vec<FileSystemEdit>,\n     ) -> Self {\n         SourceChange { source_file_edits, file_system_edits, is_snippet: false }\n     }\n }\n \n-#[derive(Debug, Clone)]\n-pub struct SourceFileEdit {\n-    pub file_id: FileId,\n-    pub edit: TextEdit,\n+#[derive(Default, Debug, Clone)]\n+pub struct SourceFileEdits {\n+    pub edits: FxHashMap<FileId, TextEdit>,\n+}\n+\n+impl SourceFileEdits {\n+    pub fn from_text_edit(file_id: FileId, edit: TextEdit) -> Self {\n+        SourceFileEdits { edits: FxHashMap::from_iter(iter::once((file_id, edit))) }\n+    }\n+\n+    pub fn len(&self) -> usize {\n+        self.edits.len()\n+    }\n+\n+    pub fn is_empty(&self) -> bool {\n+        self.edits.is_empty()\n+    }\n+\n+    pub fn insert(&mut self, file_id: FileId, edit: TextEdit) {\n+        match self.edits.entry(file_id) {\n+            Entry::Occupied(mut entry) => {\n+                entry.get_mut().union(edit).expect(\"overlapping edits for same file\");\n+            }\n+            Entry::Vacant(entry) => {\n+                entry.insert(edit);\n+            }\n+        }\n+    }\n }\n \n-impl From<SourceFileEdit> for SourceChange {\n-    fn from(edit: SourceFileEdit) -> SourceChange {\n-        vec![edit].into()\n+impl Extend<(FileId, TextEdit)> for SourceFileEdits {\n+    fn extend<T: IntoIterator<Item = (FileId, TextEdit)>>(&mut self, iter: T) {\n+        iter.into_iter().for_each(|(file_id, edit)| self.insert(file_id, edit));\n     }\n }\n \n-impl From<Vec<SourceFileEdit>> for SourceChange {\n-    fn from(source_file_edits: Vec<SourceFileEdit>) -> SourceChange {\n+impl From<SourceFileEdits> for SourceChange {\n+    fn from(source_file_edits: SourceFileEdits) -> SourceChange {\n         SourceChange { source_file_edits, file_system_edits: Vec::new(), is_snippet: false }\n     }\n }\n@@ -51,7 +81,7 @@ pub enum FileSystemEdit {\n impl From<FileSystemEdit> for SourceChange {\n     fn from(edit: FileSystemEdit) -> SourceChange {\n         SourceChange {\n-            source_file_edits: Vec::new(),\n+            source_file_edits: Default::default(),\n             file_system_edits: vec![edit],\n             is_snippet: false,\n         }"}, {"sha": "100331c37388cd5581aefbdb80cbf93b57c6019b", "filename": "crates/rust-analyzer/src/cli/ssr.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/f51457a643b768794092f73add6dda4aecd400a1/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fssr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f51457a643b768794092f73add6dda4aecd400a1/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fssr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fssr.rs?ref=f51457a643b768794092f73add6dda4aecd400a1", "patch": "@@ -12,10 +12,10 @@ pub fn apply_ssr_rules(rules: Vec<SsrRule>) -> Result<()> {\n         match_finder.add_rule(rule)?;\n     }\n     let edits = match_finder.edits();\n-    for edit in edits {\n-        if let Some(path) = vfs.file_path(edit.file_id).as_path() {\n-            let mut contents = db.file_text(edit.file_id).to_string();\n-            edit.edit.apply(&mut contents);\n+    for (file_id, edit) in edits.edits {\n+        if let Some(path) = vfs.file_path(file_id).as_path() {\n+            let mut contents = db.file_text(file_id).to_string();\n+            edit.apply(&mut contents);\n             std::fs::write(path, contents)?;\n         }\n     }"}, {"sha": "839466e4fb2c8ff779dddafbf78d91945650569a", "filename": "crates/rust-analyzer/src/handlers.rs", "status": "modified", "additions": 9, "deletions": 5, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/f51457a643b768794092f73add6dda4aecd400a1/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f51457a643b768794092f73add6dda4aecd400a1/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs?ref=f51457a643b768794092f73add6dda4aecd400a1", "patch": "@@ -260,15 +260,15 @@ pub(crate) fn handle_on_type_formatting(\n     }\n \n     let edit = snap.analysis.on_char_typed(position, char_typed)?;\n-    let mut edit = match edit {\n+    let edit = match edit {\n         Some(it) => it,\n         None => return Ok(None),\n     };\n \n     // This should be a single-file edit\n-    let edit = edit.source_file_edits.pop().unwrap();\n+    let (_, edit) = edit.source_file_edits.edits.into_iter().next().unwrap();\n \n-    let change = to_proto::text_edit_vec(&line_index, line_endings, edit.edit);\n+    let change = to_proto::text_edit_vec(&line_index, line_endings, edit);\n     Ok(Some(change))\n }\n \n@@ -463,8 +463,12 @@ pub(crate) fn handle_will_rename_files(\n         .collect();\n \n     // Drop file system edits since we're just renaming things on the same level\n-    let edits = source_changes.into_iter().map(|it| it.source_file_edits).flatten().collect();\n-    let source_change = SourceChange::from_edits(edits, Vec::new());\n+    let mut source_changes = source_changes.into_iter();\n+    let mut source_file_edits =\n+        source_changes.next().map_or_else(Default::default, |it| it.source_file_edits);\n+    // no collect here because we want to merge text edits on same file ids\n+    source_file_edits.extend(source_changes.map(|it| it.source_file_edits.edits).flatten());\n+    let source_change = SourceChange::from_edits(source_file_edits, Vec::new());\n \n     let workspace_edit = to_proto::workspace_edit(&snap, source_change)?;\n     Ok(Some(workspace_edit))"}, {"sha": "34f510e73d3fe19a6432ae370bbb9f3802d4fe2b", "filename": "crates/rust-analyzer/src/to_proto.rs", "status": "modified", "additions": 9, "deletions": 10, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/f51457a643b768794092f73add6dda4aecd400a1/crates%2Frust-analyzer%2Fsrc%2Fto_proto.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f51457a643b768794092f73add6dda4aecd400a1/crates%2Frust-analyzer%2Fsrc%2Fto_proto.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fto_proto.rs?ref=f51457a643b768794092f73add6dda4aecd400a1", "patch": "@@ -8,8 +8,7 @@ use ide::{\n     Assist, AssistKind, CallInfo, CompletionItem, CompletionItemKind, Documentation, FileId,\n     FileRange, FileSystemEdit, Fold, FoldKind, Highlight, HlMod, HlPunct, HlRange, HlTag, Indel,\n     InlayHint, InlayKind, InsertTextFormat, LineIndex, Markup, NavigationTarget, ReferenceAccess,\n-    RenameError, Runnable, Severity, SourceChange, SourceFileEdit, SymbolKind, TextEdit, TextRange,\n-    TextSize,\n+    RenameError, Runnable, Severity, SourceChange, SymbolKind, TextEdit, TextRange, TextSize,\n };\n use itertools::Itertools;\n \n@@ -634,13 +633,13 @@ pub(crate) fn goto_definition_response(\n pub(crate) fn snippet_text_document_edit(\n     snap: &GlobalStateSnapshot,\n     is_snippet: bool,\n-    source_file_edit: SourceFileEdit,\n+    file_id: FileId,\n+    edit: TextEdit,\n ) -> Result<lsp_ext::SnippetTextDocumentEdit> {\n-    let text_document = optional_versioned_text_document_identifier(snap, source_file_edit.file_id);\n-    let line_index = snap.analysis.file_line_index(source_file_edit.file_id)?;\n-    let line_endings = snap.file_line_endings(source_file_edit.file_id);\n-    let edits = source_file_edit\n-        .edit\n+    let text_document = optional_versioned_text_document_identifier(snap, file_id);\n+    let line_index = snap.analysis.file_line_index(file_id)?;\n+    let line_endings = snap.file_line_endings(file_id);\n+    let edits = edit\n         .into_iter()\n         .map(|it| snippet_text_edit(&line_index, line_endings, is_snippet, it))\n         .collect();\n@@ -699,8 +698,8 @@ pub(crate) fn snippet_workspace_edit(\n         let ops = snippet_text_document_ops(snap, op);\n         document_changes.extend_from_slice(&ops);\n     }\n-    for edit in source_change.source_file_edits {\n-        let edit = snippet_text_document_edit(&snap, source_change.is_snippet, edit)?;\n+    for (file_id, edit) in source_change.source_file_edits.edits {\n+        let edit = snippet_text_document_edit(&snap, source_change.is_snippet, file_id, edit)?;\n         document_changes.push(lsp_ext::SnippetDocumentChangeOperation::Edit(edit));\n     }\n     let workspace_edit ="}, {"sha": "d99ebefb165bac8df9990368338b4d780d73ac68", "filename": "crates/ssr/src/lib.rs", "status": "modified", "additions": 19, "deletions": 9, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/f51457a643b768794092f73add6dda4aecd400a1/crates%2Fssr%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f51457a643b768794092f73add6dda4aecd400a1/crates%2Fssr%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fssr%2Fsrc%2Flib.rs?ref=f51457a643b768794092f73add6dda4aecd400a1", "patch": "@@ -74,8 +74,10 @@ pub use crate::errors::SsrError;\n pub use crate::matching::Match;\n use crate::matching::MatchFailureReason;\n use hir::Semantics;\n-use ide_db::base_db::{FileId, FilePosition, FileRange};\n-use ide_db::source_change::SourceFileEdit;\n+use ide_db::{\n+    base_db::{FileId, FilePosition, FileRange},\n+    source_change::SourceFileEdits,\n+};\n use resolving::ResolvedRule;\n use rustc_hash::FxHashMap;\n use syntax::{ast, AstNode, SyntaxNode, TextRange};\n@@ -159,7 +161,7 @@ impl<'db> MatchFinder<'db> {\n     }\n \n     /// Finds matches for all added rules and returns edits for all found matches.\n-    pub fn edits(&self) -> Vec<SourceFileEdit> {\n+    pub fn edits(&self) -> SourceFileEdits {\n         use ide_db::base_db::SourceDatabaseExt;\n         let mut matches_by_file = FxHashMap::default();\n         for m in self.matches().matches {\n@@ -169,13 +171,21 @@ impl<'db> MatchFinder<'db> {\n                 .matches\n                 .push(m);\n         }\n-        let mut edits = vec![];\n-        for (file_id, matches) in matches_by_file {\n-            let edit =\n-                replacing::matches_to_edit(&matches, &self.sema.db.file_text(file_id), &self.rules);\n-            edits.push(SourceFileEdit { file_id, edit });\n+        SourceFileEdits {\n+            edits: matches_by_file\n+                .into_iter()\n+                .map(|(file_id, matches)| {\n+                    (\n+                        file_id,\n+                        replacing::matches_to_edit(\n+                            &matches,\n+                            &self.sema.db.file_text(file_id),\n+                            &self.rules,\n+                        ),\n+                    )\n+                })\n+                .collect(),\n         }\n-        edits\n     }\n \n     /// Adds a search pattern. For use if you intend to only call `find_matches_in_file`. If you"}, {"sha": "5888bf8f82a4a25d5e832acac7cdb53223facf2a", "filename": "crates/ssr/src/matching.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/f51457a643b768794092f73add6dda4aecd400a1/crates%2Fssr%2Fsrc%2Fmatching.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f51457a643b768794092f73add6dda4aecd400a1/crates%2Fssr%2Fsrc%2Fmatching.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fssr%2Fsrc%2Fmatching.rs?ref=f51457a643b768794092f73add6dda4aecd400a1", "patch": "@@ -810,9 +810,9 @@ mod tests {\n \n         let edits = match_finder.edits();\n         assert_eq!(edits.len(), 1);\n-        let edit = &edits[0];\n+        let edit = &edits.edits[&position.file_id];\n         let mut after = input.to_string();\n-        edit.edit.apply(&mut after);\n+        edit.apply(&mut after);\n         assert_eq!(after, \"fn foo() {} fn bar() {} fn main() { bar(1+2); }\");\n     }\n }"}, {"sha": "8ba783526d7b90892ed7eda5cee42625706744a7", "filename": "crates/ssr/src/tests.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/f51457a643b768794092f73add6dda4aecd400a1/crates%2Fssr%2Fsrc%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f51457a643b768794092f73add6dda4aecd400a1/crates%2Fssr%2Fsrc%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fssr%2Fsrc%2Ftests.rs?ref=f51457a643b768794092f73add6dda4aecd400a1", "patch": "@@ -103,11 +103,10 @@ fn assert_ssr_transforms(rules: &[&str], input: &str, expected: Expect) {\n     if edits.is_empty() {\n         panic!(\"No edits were made\");\n     }\n-    assert_eq!(edits[0].file_id, position.file_id);\n     // Note, db.file_text is not necessarily the same as `input`, since fixture parsing alters\n     // stuff.\n     let mut actual = db.file_text(position.file_id).to_string();\n-    edits[0].edit.apply(&mut actual);\n+    edits.edits[&position.file_id].apply(&mut actual);\n     expected.assert_eq(&actual);\n }\n "}]}