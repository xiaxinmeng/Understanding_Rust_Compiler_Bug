{"sha": "8fe20b19d4702fc6d6933c31abddc8539d2581f0", "node_id": "MDY6Q29tbWl0NzI0NzEyOjhmZTIwYjE5ZDQ3MDJmYzZkNjkzM2MzMWFiZGRjODUzOWQyNTgxZjA=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2021-04-06T11:16:35Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2021-04-06T12:45:31Z"}, "message": "More robust status notifications", "tree": {"sha": "8aca2a3aa2b059bb47cc235b1b557d4b4de93a24", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8aca2a3aa2b059bb47cc235b1b557d4b4de93a24"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8fe20b19d4702fc6d6933c31abddc8539d2581f0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8fe20b19d4702fc6d6933c31abddc8539d2581f0", "html_url": "https://github.com/rust-lang/rust/commit/8fe20b19d4702fc6d6933c31abddc8539d2581f0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8fe20b19d4702fc6d6933c31abddc8539d2581f0/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9143e3925cd95d30af72745f25e185f65a686d32", "url": "https://api.github.com/repos/rust-lang/rust/commits/9143e3925cd95d30af72745f25e185f65a686d32", "html_url": "https://github.com/rust-lang/rust/commit/9143e3925cd95d30af72745f25e185f65a686d32"}], "stats": {"total": 315, "additions": 165, "deletions": 150}, "files": [{"sha": "e012b4452fa4ca157c21f4b1b8d9ce1f62536e7b", "filename": "crates/rust-analyzer/src/config.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/8fe20b19d4702fc6d6933c31abddc8539d2581f0/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8fe20b19d4702fc6d6933c31abddc8539d2581f0/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs?ref=8fe20b19d4702fc6d6933c31abddc8539d2581f0", "patch": "@@ -445,8 +445,8 @@ impl Config {\n     pub fn hover_actions(&self) -> bool {\n         self.experimental(\"hoverActions\")\n     }\n-    pub fn status_notification(&self) -> bool {\n-        self.experimental(\"statusNotification\")\n+    pub fn server_status_notification(&self) -> bool {\n+        self.experimental(\"serverStatusNotification\")\n     }\n \n     pub fn publish_diagnostics(&self) -> bool {"}, {"sha": "adeb7a97e85ab96c985ec9f32f434f59aaad41ac", "filename": "crates/rust-analyzer/src/global_state.rs", "status": "modified", "additions": 6, "deletions": 17, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/8fe20b19d4702fc6d6933c31abddc8539d2581f0/crates%2Frust-analyzer%2Fsrc%2Fglobal_state.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8fe20b19d4702fc6d6933c31abddc8539d2581f0/crates%2Frust-analyzer%2Fsrc%2Fglobal_state.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fglobal_state.rs?ref=8fe20b19d4702fc6d6933c31abddc8539d2581f0", "patch": "@@ -23,6 +23,7 @@ use crate::{\n     document::DocumentData,\n     from_proto,\n     line_index::{LineEndings, LineIndex},\n+    lsp_ext,\n     main_loop::Task,\n     op_queue::OpQueue,\n     reload::SourceRootConfig,\n@@ -32,20 +33,6 @@ use crate::{\n     Result,\n };\n \n-#[derive(Eq, PartialEq, Copy, Clone)]\n-pub(crate) enum Status {\n-    Loading,\n-    Ready { partial: bool },\n-    Invalid,\n-    NeedsReload,\n-}\n-\n-impl Default for Status {\n-    fn default() -> Self {\n-        Status::Loading\n-    }\n-}\n-\n // Enforces drop order\n pub(crate) struct Handle<H, C> {\n     pub(crate) handle: H,\n@@ -73,7 +60,7 @@ pub(crate) struct GlobalState {\n     pub(crate) mem_docs: FxHashMap<VfsPath, DocumentData>,\n     pub(crate) semantic_tokens_cache: Arc<Mutex<FxHashMap<Url, SemanticTokens>>>,\n     pub(crate) shutdown_requested: bool,\n-    pub(crate) status: Status,\n+    pub(crate) last_reported_status: Option<lsp_ext::ServerStatusParams>,\n     pub(crate) source_root_config: SourceRootConfig,\n     pub(crate) proc_macro_client: Option<ProcMacroClient>,\n \n@@ -83,6 +70,7 @@ pub(crate) struct GlobalState {\n \n     pub(crate) vfs: Arc<RwLock<(vfs::Vfs, FxHashMap<FileId, LineEndings>)>>,\n     pub(crate) vfs_config_version: u32,\n+    pub(crate) vfs_progress_config_version: u32,\n     pub(crate) vfs_progress_n_total: usize,\n     pub(crate) vfs_progress_n_done: usize,\n \n@@ -141,7 +129,7 @@ impl GlobalState {\n             mem_docs: FxHashMap::default(),\n             semantic_tokens_cache: Arc::new(Default::default()),\n             shutdown_requested: false,\n-            status: Status::default(),\n+            last_reported_status: None,\n             source_root_config: SourceRootConfig::default(),\n             proc_macro_client: None,\n \n@@ -151,14 +139,15 @@ impl GlobalState {\n \n             vfs: Arc::new(RwLock::new((vfs::Vfs::default(), FxHashMap::default()))),\n             vfs_config_version: 0,\n+            vfs_progress_config_version: 0,\n             vfs_progress_n_total: 0,\n             vfs_progress_n_done: 0,\n \n             workspaces: Arc::new(Vec::new()),\n             fetch_workspaces_queue: OpQueue::default(),\n             workspace_build_data: None,\n-            fetch_build_data_queue: OpQueue::default(),\n \n+            fetch_build_data_queue: OpQueue::default(),\n             latest_requests: Default::default(),\n         }\n     }"}, {"sha": "81a6f22f16c1c79d1f3f5f6f7247fe2dd26b8978", "filename": "crates/rust-analyzer/src/lsp_ext.rs", "status": "modified", "additions": 15, "deletions": 15, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/8fe20b19d4702fc6d6933c31abddc8539d2581f0/crates%2Frust-analyzer%2Fsrc%2Flsp_ext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8fe20b19d4702fc6d6933c31abddc8539d2581f0/crates%2Frust-analyzer%2Fsrc%2Flsp_ext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Flsp_ext.rs?ref=8fe20b19d4702fc6d6933c31abddc8539d2581f0", "patch": "@@ -241,26 +241,26 @@ pub struct SsrParams {\n     pub selections: Vec<lsp_types::Range>,\n }\n \n-pub enum StatusNotification {}\n+pub enum ServerStatusNotification {}\n \n-#[derive(Serialize, Deserialize)]\n-#[serde(rename_all = \"camelCase\")]\n-pub enum Status {\n-    Loading,\n-    ReadyPartial,\n-    Ready,\n-    NeedsReload,\n-    Invalid,\n+impl Notification for ServerStatusNotification {\n+    type Params = ServerStatusParams;\n+    const METHOD: &'static str = \"experimental/serverStatus\";\n }\n \n-#[derive(Deserialize, Serialize)]\n-pub struct StatusParams {\n-    pub status: Status,\n+#[derive(Deserialize, Serialize, PartialEq, Eq, Clone)]\n+pub struct ServerStatusParams {\n+    pub health: Health,\n+    pub quiescent: bool,\n+    pub message: Option<String>,\n }\n \n-impl Notification for StatusNotification {\n-    type Params = StatusParams;\n-    const METHOD: &'static str = \"rust-analyzer/status\";\n+#[derive(Serialize, Deserialize, Clone, Copy, PartialEq, Eq)]\n+#[serde(rename_all = \"camelCase\")]\n+pub enum Health {\n+    Ok,\n+    Warning,\n+    Error,\n }\n \n pub enum CodeActionRequest {}"}, {"sha": "a5655116b49ae18d44cfbc2f9c7512d33a5b0237", "filename": "crates/rust-analyzer/src/main_loop.rs", "status": "modified", "additions": 13, "deletions": 11, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/8fe20b19d4702fc6d6933c31abddc8539d2581f0/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8fe20b19d4702fc6d6933c31abddc8539d2581f0/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs?ref=8fe20b19d4702fc6d6933c31abddc8539d2581f0", "patch": "@@ -21,7 +21,7 @@ use crate::{\n     dispatch::{NotificationDispatcher, RequestDispatcher},\n     document::DocumentData,\n     from_proto,\n-    global_state::{file_id_to_url, url_to_file_id, GlobalState, Status},\n+    global_state::{file_id_to_url, url_to_file_id, GlobalState},\n     handlers, lsp_ext,\n     lsp_utils::{apply_document_changes, is_canceled, notification_is, Progress},\n     reload::{BuildDataProgress, ProjectWorkspaceProgress},\n@@ -189,7 +189,7 @@ impl GlobalState {\n             log::info!(\"task queue len: {}\", task_queue_len);\n         }\n \n-        let mut new_status = self.status;\n+        let was_quiescent = self.is_quiescent();\n         match event {\n             Event::Lsp(msg) => match msg {\n                 lsp_server::Message::Request(req) => self.on_request(loop_start, req)?,\n@@ -314,9 +314,12 @@ impl GlobalState {\n                             }\n                         }\n                         vfs::loader::Message::Progress { n_total, n_done, config_version } => {\n+                            always!(config_version <= self.vfs_config_version);\n+\n+                            self.vfs_progress_config_version = config_version;\n                             self.vfs_progress_n_total = n_total;\n                             self.vfs_progress_n_done = n_done;\n-                            always!(config_version <= self.vfs_config_version);\n+\n                             let state = if n_done == 0 {\n                                 Progress::Begin\n                             } else if n_done < n_total {\n@@ -406,18 +409,14 @@ impl GlobalState {\n         }\n \n         let state_changed = self.process_changes();\n-        let prev_status = self.status;\n-        if prev_status != new_status {\n-            self.transition(new_status);\n-        }\n-        let is_ready = matches!(self.status, Status::Ready { .. });\n-        if prev_status == Status::Loading && is_ready {\n+\n+        if self.is_quiescent() && !was_quiescent {\n             for flycheck in &self.flycheck {\n                 flycheck.update();\n             }\n         }\n \n-        if is_ready && (state_changed || prev_status == Status::Loading) {\n+        if self.is_quiescent() && (!was_quiescent || state_changed) {\n             self.update_file_notifications_on_threadpool();\n \n             // Refresh semantic tokens if the client supports it.\n@@ -451,6 +450,8 @@ impl GlobalState {\n         }\n         self.fetch_build_data_if_needed();\n \n+        self.report_new_status_if_needed();\n+\n         let loop_duration = loop_start.elapsed();\n         if loop_duration > Duration::from_millis(100) {\n             log::warn!(\"overly long loop turn: {:?}\", loop_duration);\n@@ -477,7 +478,8 @@ impl GlobalState {\n             return Ok(());\n         }\n \n-        if self.status == Status::Loading && req.method != \"shutdown\" {\n+        // Avoid flashing a bunch of unresolved references during initial load.\n+        if self.workspaces.is_empty() && !self.is_quiescent() {\n             self.respond(lsp_server::Response::new_err(\n                 req.id,\n                 // FIXME: i32 should impl From<ErrorCode> (from() guarantees lossless conversion)"}, {"sha": "1d612a9337642eef9ec231fbc703e4ae3d08d007", "filename": "crates/rust-analyzer/src/op_queue.rs", "status": "modified", "additions": 11, "deletions": 5, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/8fe20b19d4702fc6d6933c31abddc8539d2581f0/crates%2Frust-analyzer%2Fsrc%2Fop_queue.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8fe20b19d4702fc6d6933c31abddc8539d2581f0/crates%2Frust-analyzer%2Fsrc%2Fop_queue.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fop_queue.rs?ref=8fe20b19d4702fc6d6933c31abddc8539d2581f0", "patch": "@@ -2,27 +2,27 @@\n //! at a time.\n \n pub(crate) struct OpQueue<Args, Output> {\n-    op_scheduled: Option<Args>,\n+    op_requested: Option<Args>,\n     op_in_progress: bool,\n     last_op_result: Output,\n }\n \n impl<Args, Output: Default> Default for OpQueue<Args, Output> {\n     fn default() -> Self {\n-        Self { op_scheduled: None, op_in_progress: false, last_op_result: Default::default() }\n+        Self { op_requested: None, op_in_progress: false, last_op_result: Default::default() }\n     }\n }\n \n impl<Args, Output> OpQueue<Args, Output> {\n     pub(crate) fn request_op(&mut self, data: Args) {\n-        self.op_scheduled = Some(data);\n+        self.op_requested = Some(data);\n     }\n     pub(crate) fn should_start_op(&mut self) -> Option<Args> {\n         if self.op_in_progress {\n             return None;\n         }\n-        self.op_in_progress = self.op_scheduled.is_some();\n-        self.op_scheduled.take()\n+        self.op_in_progress = self.op_requested.is_some();\n+        self.op_requested.take()\n     }\n     pub(crate) fn op_completed(&mut self, result: Output) {\n         assert!(self.op_in_progress);\n@@ -34,4 +34,10 @@ impl<Args, Output> OpQueue<Args, Output> {\n     pub(crate) fn last_op_result(&self) -> &Output {\n         &self.last_op_result\n     }\n+    pub(crate) fn op_in_progress(&self) -> bool {\n+        self.op_in_progress\n+    }\n+    pub(crate) fn op_requested(&self) -> bool {\n+        self.op_requested.is_some()\n+    }\n }"}, {"sha": "301c7003b99dafa325467925aa29c2a49746203d", "filename": "crates/rust-analyzer/src/reload.rs", "status": "modified", "additions": 67, "deletions": 52, "changes": 119, "blob_url": "https://github.com/rust-lang/rust/blob/8fe20b19d4702fc6d6933c31abddc8539d2581f0/crates%2Frust-analyzer%2Fsrc%2Freload.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8fe20b19d4702fc6d6933c31abddc8539d2581f0/crates%2Frust-analyzer%2Fsrc%2Freload.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Freload.rs?ref=8fe20b19d4702fc6d6933c31abddc8539d2581f0", "patch": "@@ -9,11 +9,10 @@ use vfs::{file_set::FileSetConfig, AbsPath, AbsPathBuf, ChangeKind};\n \n use crate::{\n     config::{Config, FilesWatcher, LinkedProject},\n-    global_state::{GlobalState, Status},\n+    global_state::GlobalState,\n     lsp_ext,\n     main_loop::Task,\n };\n-use lsp_ext::StatusParams;\n \n #[derive(Debug)]\n pub(crate) enum ProjectWorkspaceProgress {\n@@ -30,6 +29,13 @@ pub(crate) enum BuildDataProgress {\n }\n \n impl GlobalState {\n+    pub(crate) fn is_quiescent(&self) -> bool {\n+        !(self.fetch_workspaces_queue.op_in_progress()\n+            || self.fetch_build_data_queue.op_in_progress()\n+            || self.vfs_progress_config_version < self.vfs_config_version\n+            || self.vfs_progress_n_done < self.vfs_progress_n_total)\n+    }\n+\n     pub(crate) fn update_configuration(&mut self, config: Config) {\n         let _p = profile::span(\"GlobalState::update_configuration\");\n         let old_config = mem::replace(&mut self.config, Arc::new(config));\n@@ -46,17 +52,13 @@ impl GlobalState {\n         if !changes.iter().any(|(path, kind)| is_interesting(path, *kind)) {\n             return;\n         }\n-        match self.status {\n-            Status::Loading | Status::NeedsReload => return,\n-            Status::Ready { .. } | Status::Invalid => (),\n-        }\n         log::info!(\n-            \"Reloading workspace because of the following changes: {}\",\n+            \"Requesting workspace reload because of the following changes: {}\",\n             itertools::join(\n                 changes\n                     .iter()\n                     .filter(|(path, kind)| is_interesting(path, *kind))\n-                    .map(|(path, kind)| format!(\"{}/{:?}\", path.display(), kind)),\n+                    .map(|(path, kind)| format!(\"{}: {:?}\", path.display(), kind)),\n                 \", \"\n             )\n         );\n@@ -97,19 +99,31 @@ impl GlobalState {\n             false\n         }\n     }\n-    pub(crate) fn transition(&mut self, new_status: Status) {\n-        self.status = new_status;\n-        if self.config.status_notification() {\n-            let lsp_status = match new_status {\n-                Status::Loading => lsp_ext::Status::Loading,\n-                Status::Ready { partial: true } => lsp_ext::Status::ReadyPartial,\n-                Status::Ready { partial: false } => lsp_ext::Status::Ready,\n-                Status::Invalid => lsp_ext::Status::Invalid,\n-                Status::NeedsReload => lsp_ext::Status::NeedsReload,\n-            };\n-            self.send_notification::<lsp_ext::StatusNotification>(StatusParams {\n-                status: lsp_status,\n-            });\n+    pub(crate) fn report_new_status_if_needed(&mut self) {\n+        if !self.config.server_status_notification() {\n+            return;\n+        }\n+\n+        let mut status = lsp_ext::ServerStatusParams {\n+            health: lsp_ext::Health::Ok,\n+            quiescent: self.is_quiescent(),\n+            message: None,\n+        };\n+        if !self.config.cargo_autoreload()\n+            && self.is_quiescent()\n+            && self.fetch_workspaces_queue.op_requested()\n+        {\n+            status.health = lsp_ext::Health::Warning;\n+            status.message = Some(\"Workspace reload required\".to_string())\n+        }\n+        if let Some(error) = self.loading_error() {\n+            status.health = lsp_ext::Health::Error;\n+            status.message = Some(format!(\"Workspace reload failed: {}\", error))\n+        }\n+\n+        if self.last_reported_status.as_ref() != Some(&status) {\n+            self.last_reported_status = Some(status.clone());\n+            self.send_notification::<lsp_ext::ServerStatusNotification>(status);\n         }\n     }\n \n@@ -201,45 +215,28 @@ impl GlobalState {\n \n     pub(crate) fn switch_workspaces(&mut self) {\n         let _p = profile::span(\"GlobalState::switch_workspaces\");\n-        let workspaces = self.fetch_workspaces_queue.last_op_result();\n-        log::info!(\"will switch workspaces: {:?}\", workspaces);\n+        log::info!(\"will switch workspaces\");\n+\n+        if let Some(error_message) = self.loading_error() {\n+            log::error!(\"failed to switch workspaces: {}\", error_message);\n+            self.show_message(lsp_types::MessageType::Error, error_message);\n+            if !self.workspaces.is_empty() {\n+                return;\n+            }\n+        }\n \n-        let mut error_message = None;\n-        let workspaces = workspaces\n+        let workspaces = self\n+            .fetch_workspaces_queue\n+            .last_op_result()\n             .iter()\n-            .filter_map(|res| match res {\n-                Ok(it) => Some(it.clone()),\n-                Err(err) => {\n-                    log::error!(\"failed to load workspace: {:#}\", err);\n-                    let message = error_message.get_or_insert_with(String::new);\n-                    stdx::format_to!(\n-                        message,\n-                        \"rust-analyzer failed to load workspace: {:#}\\n\",\n-                        err\n-                    );\n-                    None\n-                }\n-            })\n+            .filter_map(|res| res.as_ref().ok().cloned())\n             .collect::<Vec<_>>();\n \n         let workspace_build_data = match self.fetch_build_data_queue.last_op_result() {\n             Some(Ok(it)) => Some(it.clone()),\n-            None => None,\n-            Some(Err(err)) => {\n-                log::error!(\"failed to fetch build data: {:#}\", err);\n-                let message = error_message.get_or_insert_with(String::new);\n-                stdx::format_to!(message, \"rust-analyzer failed to fetch build data: {:#}\\n\", err);\n-                None\n-            }\n+            None | Some(Err(_)) => None,\n         };\n \n-        if let Some(error_message) = error_message {\n-            self.show_message(lsp_types::MessageType::Error, error_message);\n-            if !self.workspaces.is_empty() {\n-                return;\n-            }\n-        }\n-\n         if *self.workspaces == workspaces && self.workspace_build_data == workspace_build_data {\n             return;\n         }\n@@ -346,6 +343,24 @@ impl GlobalState {\n         log::info!(\"did switch workspaces\");\n     }\n \n+    fn loading_error(&self) -> Option<String> {\n+        let mut message = None;\n+\n+        for ws in self.fetch_workspaces_queue.last_op_result() {\n+            if let Err(err) = ws {\n+                let message = message.get_or_insert_with(String::new);\n+                stdx::format_to!(message, \"rust-analyzer failed to load workspace: {:#}\\n\", err);\n+            }\n+        }\n+\n+        if let Some(Err(err)) = self.fetch_build_data_queue.last_op_result() {\n+            let message = message.get_or_insert_with(String::new);\n+            stdx::format_to!(message, \"rust-analyzer failed to fetch build data: {:#}\\n\", err);\n+        }\n+\n+        message\n+    }\n+\n     fn reload_flycheck(&mut self) {\n         let _p = profile::span(\"GlobalState::reload_flycheck\");\n         let config = match self.config.flycheck() {"}, {"sha": "8d68f1b7d53af1c8900abce15f862353affd037e", "filename": "crates/rust-analyzer/tests/rust-analyzer/support.rs", "status": "modified", "additions": 5, "deletions": 6, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/8fe20b19d4702fc6d6933c31abddc8539d2581f0/crates%2Frust-analyzer%2Ftests%2Frust-analyzer%2Fsupport.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8fe20b19d4702fc6d6933c31abddc8539d2581f0/crates%2Frust-analyzer%2Ftests%2Frust-analyzer%2Fsupport.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Ftests%2Frust-analyzer%2Fsupport.rs?ref=8fe20b19d4702fc6d6933c31abddc8539d2581f0", "patch": "@@ -103,7 +103,7 @@ impl<'a> Project<'a> {\n                     ..Default::default()\n                 }),\n                 experimental: Some(json!({\n-                    \"statusNotification\": true,\n+                    \"serverStatusNotification\": true,\n                 })),\n                 ..Default::default()\n             },\n@@ -213,13 +213,12 @@ impl Server {\n     }\n     pub(crate) fn wait_until_workspace_is_loaded(self) -> Server {\n         self.wait_for_message_cond(1, &|msg: &Message| match msg {\n-            Message::Notification(n) if n.method == \"rust-analyzer/status\" => {\n+            Message::Notification(n) if n.method == \"experimental/serverStatus\" => {\n                 let status = n\n                     .clone()\n-                    .extract::<lsp_ext::StatusParams>(\"rust-analyzer/status\")\n-                    .unwrap()\n-                    .status;\n-                matches!(status, lsp_ext::Status::Ready)\n+                    .extract::<lsp_ext::ServerStatusParams>(\"experimental/serverStatus\")\n+                    .unwrap();\n+                status.quiescent\n             }\n             _ => false,\n         })"}, {"sha": "989771ac6fff8c5f8a4098e8718780e5b2fe54ad", "filename": "docs/dev/lsp-extensions.md", "status": "modified", "additions": 22, "deletions": 8, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/8fe20b19d4702fc6d6933c31abddc8539d2581f0/docs%2Fdev%2Flsp-extensions.md", "raw_url": "https://github.com/rust-lang/rust/raw/8fe20b19d4702fc6d6933c31abddc8539d2581f0/docs%2Fdev%2Flsp-extensions.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/docs%2Fdev%2Flsp-extensions.md?ref=8fe20b19d4702fc6d6933c31abddc8539d2581f0", "patch": "@@ -1,5 +1,5 @@\n <!---\n-lsp_ext.rs hash: e8a7502bd2b2c2f5\n+lsp_ext.rs hash: faae991334a151d0\n \n If you need to change the above hash to make the test pass, please check if you\n need to adjust this doc as well and ping this  issue:\n@@ -419,23 +419,37 @@ Returns internal status message, mostly for debugging purposes.\n \n Reloads project information (that is, re-executes `cargo metadata`).\n \n-## Status Notification\n+## Server Status\n \n-**Experimental Client Capability:** `{ \"statusNotification\": boolean }`\n+**Experimental Client Capability:** `{ \"serverStatus\": boolean }`\n \n-**Method:** `rust-analyzer/status`\n+**Method:** `experimental/serverStatus`\n \n **Notification:**\n \n ```typescript\n-interface StatusParams {\n-    status: \"loading\" | \"readyPartial\" | \"ready\" | \"invalid\" | \"needsReload\",\n+interface ServerStatusParams {\n+    /// `ok` means that the server is completely functional.\n+    ///\n+    /// `warning` means that the server is partially functional.\n+    /// It can server requests, but some results might be wrong due to,\n+    /// for example, some missing dependencies.\n+    ///\n+    /// `error` means that the server is not functional. For example,\n+    /// there's a fatal build configuration problem.\n+    health: \"ok\" | \"warning\" | \"error\",\n+    /// Is there any pending background work which might change the status?\n+    /// For example, are dependencies being downloaded?\n+    quiescent: bool,\n+    /// Explanatory message to show on hover.\n+    message?: string,\n }\n ```\n \n This notification is sent from server to client.\n-The client can use it to display persistent status to the user (in modline).\n-For `needsReload` state, the client can provide a context-menu action to run `rust-analyzer/reloadWorkspace` request.\n+The client can use it to display *persistent* status to the user (in modline).\n+It is similar to the `showMessage`, but is intended for stares rather than point-in-time events.\n+\n \n ## Syntax Tree\n "}, {"sha": "116f41df6e9c1a8e48c31bd678a6b236a1dcf026", "filename": "editors/code/src/client.ts", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/8fe20b19d4702fc6d6933c31abddc8539d2581f0/editors%2Fcode%2Fsrc%2Fclient.ts", "raw_url": "https://github.com/rust-lang/rust/raw/8fe20b19d4702fc6d6933c31abddc8539d2581f0/editors%2Fcode%2Fsrc%2Fclient.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fclient.ts?ref=8fe20b19d4702fc6d6933c31abddc8539d2581f0", "patch": "@@ -159,7 +159,7 @@ class ExperimentalFeatures implements lc.StaticFeature {\n         caps.snippetTextEdit = true;\n         caps.codeActionGroup = true;\n         caps.hoverActions = true;\n-        caps.statusNotification = true;\n+        caps.serverStatusNotification = true;\n         capabilities.experimental = caps;\n     }\n     initialize(_capabilities: lc.ServerCapabilities<any>, _documentSelector: lc.DocumentSelector | undefined): void {"}, {"sha": "c05e757f864f54e406cde3a1740402fd3dd32f08", "filename": "editors/code/src/ctx.ts", "status": "modified", "additions": 18, "deletions": 29, "changes": 47, "blob_url": "https://github.com/rust-lang/rust/blob/8fe20b19d4702fc6d6933c31abddc8539d2581f0/editors%2Fcode%2Fsrc%2Fctx.ts", "raw_url": "https://github.com/rust-lang/rust/raw/8fe20b19d4702fc6d6933c31abddc8539d2581f0/editors%2Fcode%2Fsrc%2Fctx.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fctx.ts?ref=8fe20b19d4702fc6d6933c31abddc8539d2581f0", "patch": "@@ -5,7 +5,7 @@ import * as ra from './lsp_ext';\n import { Config } from './config';\n import { createClient } from './client';\n import { isRustEditor, RustEditor } from './util';\n-import { Status } from './lsp_ext';\n+import { ServerStatusParams } from './lsp_ext';\n \n export class Ctx {\n     private constructor(\n@@ -36,7 +36,7 @@ export class Ctx {\n \n         res.pushCleanup(client.start());\n         await client.onReady();\n-        client.onNotification(ra.status, (params) => res.setStatus(params.status));\n+        client.onNotification(ra.serverStatus, (params) => res.setServerStatus(params));\n         return res;\n     }\n \n@@ -66,39 +66,28 @@ export class Ctx {\n         return this.extCtx.subscriptions;\n     }\n \n-    setStatus(status: Status) {\n-        switch (status) {\n-            case \"loading\":\n-                this.statusBar.text = \"$(sync~spin) rust-analyzer\";\n-                this.statusBar.tooltip = \"Loading the project\";\n-                this.statusBar.command = undefined;\n+    setServerStatus(status: ServerStatusParams) {\n+        this.statusBar.tooltip = status.message ?? \"Ready\";\n+        let icon = \"\";\n+        switch (status.health) {\n+            case \"ok\":\n                 this.statusBar.color = undefined;\n                 break;\n-            case \"readyPartial\":\n-                this.statusBar.text = \"rust-analyzer\";\n-                this.statusBar.tooltip = \"Ready (Partial)\";\n-                this.statusBar.command = undefined;\n-                this.statusBar.color = undefined;\n-                break;\n-            case \"ready\":\n-                this.statusBar.text = \"rust-analyzer\";\n-                this.statusBar.tooltip = \"Ready\";\n-                this.statusBar.command = undefined;\n-                this.statusBar.color = undefined;\n-                break;\n-            case \"invalid\":\n-                this.statusBar.text = \"$(error) rust-analyzer\";\n-                this.statusBar.tooltip = \"Failed to load the project\";\n-                this.statusBar.command = undefined;\n-                this.statusBar.color = new vscode.ThemeColor(\"notificationsErrorIcon.foreground\");\n-                break;\n-            case \"needsReload\":\n-                this.statusBar.text = \"$(warning) rust-analyzer\";\n-                this.statusBar.tooltip = \"Click to reload\";\n+            case \"warning\":\n+                this.statusBar.tooltip += \"\\nClick to reload.\"\n                 this.statusBar.command = \"rust-analyzer.reloadWorkspace\";\n                 this.statusBar.color = new vscode.ThemeColor(\"notificationsWarningIcon.foreground\");\n+                icon = \"$(warning) \";\n+                break;\n+            case \"error\":\n+                this.statusBar.tooltip += \"\\nClick to reload.\"\n+                this.statusBar.command = \"rust-analyzer.reloadWorkspace\";\n+                this.statusBar.color = new vscode.ThemeColor(\"notificationsErrorIcon.foreground\");\n+                icon = \"$(error) \";\n                 break;\n         }\n+        if (!status.quiescent) icon = \"$(sync~spin) \";\n+        this.statusBar.text = `${icon} rust-analyzer`;\n     }\n \n     pushCleanup(d: Disposable) {"}, {"sha": "2e1744f1bff4785228e518be67402477a0e4438c", "filename": "editors/code/src/lsp_ext.ts", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/8fe20b19d4702fc6d6933c31abddc8539d2581f0/editors%2Fcode%2Fsrc%2Flsp_ext.ts", "raw_url": "https://github.com/rust-lang/rust/raw/8fe20b19d4702fc6d6933c31abddc8539d2581f0/editors%2Fcode%2Fsrc%2Flsp_ext.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Flsp_ext.ts?ref=8fe20b19d4702fc6d6933c31abddc8539d2581f0", "patch": "@@ -10,11 +10,12 @@ export interface AnalyzerStatusParams {\n export const analyzerStatus = new lc.RequestType<AnalyzerStatusParams, string, void>(\"rust-analyzer/analyzerStatus\");\n export const memoryUsage = new lc.RequestType0<string, void>(\"rust-analyzer/memoryUsage\");\n \n-export type Status = \"loading\" | \"ready\" | \"readyPartial\" | \"invalid\" | \"needsReload\";\n-export interface StatusParams {\n-    status: Status;\n+export interface ServerStatusParams {\n+    health: \"ok\" | \"warning\" | \"error\"\n+    quiescent: boolean\n+    message?: string\n }\n-export const status = new lc.NotificationType<StatusParams>(\"rust-analyzer/status\");\n+export const serverStatus = new lc.NotificationType<ServerStatusParams>(\"experimental/serverStatus\");\n \n export const reloadWorkspace = new lc.RequestType0<null, void>(\"rust-analyzer/reloadWorkspace\");\n "}]}