{"sha": "2bd4dcf891d9cfe567c607fa8607f46b212b1aa3", "node_id": "MDY6Q29tbWl0NzI0NzEyOjJiZDRkY2Y4OTFkOWNmZTU2N2M2MDdmYTg2MDdmNDZiMjEyYjFhYTM=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2017-09-16T14:17:04Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2017-09-17T00:09:41Z"}, "message": "Rollup merge of #44631 - kennytm:travis-conditional-jobs, r=alexcrichton\n\nMake use of Travis's conditional jobs.\n\nConditional jobs: https://docs.travis-ci.com/user/conditional-builds-stages-jobs/#Conditional-Jobs.\n\nJobs not matching the condition will not be scheduled at all. This allows us to get rid of `$ALLOW_PR`/`$ALLOW_TRY`/`$SKIP_BUILD` in `.travis.yml`, and perfectly prevent spurious PR failures due to flaky macOS machines.", "tree": {"sha": "67ba491f789ab444ff7d45e21b2fa4eb20983670", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/67ba491f789ab444ff7d45e21b2fa4eb20983670"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2bd4dcf891d9cfe567c607fa8607f46b212b1aa3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2bd4dcf891d9cfe567c607fa8607f46b212b1aa3", "html_url": "https://github.com/rust-lang/rust/commit/2bd4dcf891d9cfe567c607fa8607f46b212b1aa3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2bd4dcf891d9cfe567c607fa8607f46b212b1aa3/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9eae11183117f39af9a53221c281a370dab6f29b", "url": "https://api.github.com/repos/rust-lang/rust/commits/9eae11183117f39af9a53221c281a370dab6f29b", "html_url": "https://github.com/rust-lang/rust/commit/9eae11183117f39af9a53221c281a370dab6f29b"}, {"sha": "9f763549c1b93d0118a9307f1ebe9fccbf95ae05", "url": "https://api.github.com/repos/rust-lang/rust/commits/9f763549c1b93d0118a9307f1ebe9fccbf95ae05", "html_url": "https://github.com/rust-lang/rust/commit/9f763549c1b93d0118a9307f1ebe9fccbf95ae05"}], "stats": {"total": 82, "additions": 52, "deletions": 30}, "files": [{"sha": "dd619c945d4aaa06e46f82d8baa2e01e2eddc787", "filename": ".travis.yml", "status": "modified", "additions": 52, "deletions": 30, "changes": 82, "blob_url": "https://github.com/rust-lang/rust/blob/2bd4dcf891d9cfe567c607fa8607f46b212b1aa3/.travis.yml", "raw_url": "https://github.com/rust-lang/rust/raw/2bd4dcf891d9cfe567c607fa8607f46b212b1aa3/.travis.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.travis.yml?ref=2bd4dcf891d9cfe567c607fa8607f46b212b1aa3", "patch": "@@ -12,14 +12,19 @@ matrix:\n   fast_finish: true\n   include:\n     # Images used in testing PR and try-build should be run first.\n-    - env: IMAGE=x86_64-gnu-llvm-3.7 ALLOW_PR=1 RUST_BACKTRACE=1\n-    - env: IMAGE=dist-x86_64-linux DEPLOY=1 ALLOW_TRY=1\n+    - env: IMAGE=x86_64-gnu-llvm-3.7 RUST_BACKTRACE=1\n+      if: type = pull_request OR branch = auto\n+\n+    - env: IMAGE=dist-x86_64-linux DEPLOY=1\n+      if: branch = try OR branch = auto\n \n     # \"alternate\" deployments, these are \"nightlies\" but don't have assertions\n     # turned on, they're deployed to a different location primarily for projects\n     # which are stuck on nightly and don't want llvm assertions in the artifacts\n     # that they use.\n     - env: IMAGE=dist-x86_64-linux DEPLOY_ALT=1\n+      if: branch = auto\n+\n     - env: >\n         RUST_CHECK_TARGET=dist\n         RUST_CONFIGURE_ARGS=\"--enable-extended --enable-profiler\"\n@@ -31,6 +36,7 @@ matrix:\n         NO_LLVM_ASSERTIONS=1\n       os: osx\n       osx_image: xcode7\n+      if: branch = auto\n \n     # macOS builders. These are placed near the beginning because they are very\n     # slow to run.\n@@ -50,6 +56,8 @@ matrix:\n         NO_LLVM_ASSERTIONS=1\n       os: osx\n       osx_image: xcode8.2\n+      if: branch = auto\n+\n     - env: >\n         RUST_CHECK_TARGET=check\n         RUST_CONFIGURE_ARGS=--build=i686-apple-darwin\n@@ -61,6 +69,7 @@ matrix:\n         NO_LLVM_ASSERTIONS=1\n       os: osx\n       osx_image: xcode8.2\n+      if: branch = auto\n \n     # OSX builders producing releases. These do not run the full test suite and\n     # just produce a bunch of artifacts.\n@@ -79,6 +88,8 @@ matrix:\n         NO_LLVM_ASSERTIONS=1\n       os: osx\n       osx_image: xcode7\n+      if: branch = auto\n+\n     - env: >\n         RUST_CHECK_TARGET=dist\n         RUST_CONFIGURE_ARGS=\"--target=aarch64-apple-ios,armv7-apple-ios,armv7s-apple-ios,i386-apple-ios,x86_64-apple-ios --enable-extended --enable-sanitizers --enable-profiler\"\n@@ -90,42 +101,77 @@ matrix:\n         NO_LLVM_ASSERTIONS=1\n       os: osx\n       osx_image: xcode7\n+      if: branch = auto\n \n     # Linux builders, remaining docker images\n     - env: IMAGE=arm-android\n+      if: branch = auto\n     - env: IMAGE=armhf-gnu\n+      if: branch = auto\n     - env: IMAGE=cross DEPLOY=1\n+      if: branch = auto\n     - env: IMAGE=dist-aarch64-linux DEPLOY=1\n+      if: branch = auto\n     - env: IMAGE=dist-android DEPLOY=1\n+      if: branch = auto\n     - env: IMAGE=dist-arm-linux DEPLOY=1\n+      if: branch = auto\n     - env: IMAGE=dist-armhf-linux DEPLOY=1\n+      if: branch = auto\n     - env: IMAGE=dist-armv7-linux DEPLOY=1\n+      if: branch = auto\n     - env: IMAGE=dist-fuchsia DEPLOY=1\n+      if: branch = auto\n     - env: IMAGE=dist-i586-gnu-i686-musl DEPLOY=1\n+      if: branch = auto\n     - env: IMAGE=dist-i686-freebsd DEPLOY=1\n+      if: branch = auto\n     - env: IMAGE=dist-i686-linux DEPLOY=1\n+      if: branch = auto\n     - env: IMAGE=dist-mips-linux DEPLOY=1\n+      if: branch = auto\n     - env: IMAGE=dist-mips64-linux DEPLOY=1\n+      if: branch = auto\n     - env: IMAGE=dist-mips64el-linux DEPLOY=1\n+      if: branch = auto\n     - env: IMAGE=dist-mipsel-linux DEPLOY=1\n+      if: branch = auto\n     - env: IMAGE=dist-powerpc-linux DEPLOY=1\n+      if: branch = auto\n     - env: IMAGE=dist-powerpc64-linux DEPLOY=1\n+      if: branch = auto\n     - env: IMAGE=dist-powerpc64le-linux DEPLOY=1\n+      if: branch = auto\n     - env: IMAGE=dist-s390x-linux DEPLOY=1\n+      if: branch = auto\n     - env: IMAGE=dist-x86_64-freebsd DEPLOY=1\n+      if: branch = auto\n     - env: IMAGE=dist-x86_64-musl DEPLOY=1\n+      if: branch = auto\n     - env: IMAGE=dist-x86_64-netbsd DEPLOY=1\n+      if: branch = auto\n     - env: IMAGE=asmjs\n+      if: branch = auto\n     - env: IMAGE=i686-gnu\n+      if: branch = auto\n     - env: IMAGE=i686-gnu-nopt\n+      if: branch = auto\n     # - env: IMAGE=wasm32 issue 42646\n+    #   if: branch = auto\n     - env: IMAGE=x86_64-gnu\n+      if: branch = auto\n     - env: IMAGE=x86_64-gnu-full-bootstrap\n+      if: branch = auto\n     - env: IMAGE=x86_64-gnu-aux\n+      if: branch = auto\n     - env: IMAGE=x86_64-gnu-debug\n+      if: branch = auto\n     - env: IMAGE=x86_64-gnu-nopt\n+      if: branch = auto\n     - env: IMAGE=x86_64-gnu-distcheck\n+      if: branch = auto\n     - env: IMAGE=x86_64-gnu-incremental\n+      if: branch = auto\n \n env:\n   global:\n@@ -136,34 +182,11 @@ env:\n     - secure: \"j96XxTVOSUf4s4r4htIxn/fvIa5DWbMgLqWl7r8z2QfgUwscmkMXAwXuFNc7s7bGTpV/+CgDiMFFM6BAFLGKutytIF6oA02s9b+usQYnM0th7YQ2AIgm9GtMTJCJp4AoyfFmh8F2faUICBZlfVLUJ34udHEe35vOklix+0k4WDo=\"\n \n before_install:\n-  # If we are building a pull request, do the build if $ALLOW_PR == 1\n-  # Otherwise, do the build if we are on the auto branch, or the try branch and $ALLOW_TRY == 1\n-  - >\n-    if [[ \"$TRAVIS_PULL_REQUEST\" != \"false\" ]]; then\n-        if [[ \"$ALLOW_PR\" == \"1\" ]]; then\n-            export SKIP_BUILD=false;\n-        else\n-            export SKIP_BUILD=true;\n-        fi;\n-    elif [[ \"$TRAVIS_BRANCH\" == \"auto\" || ( \"$ALLOW_TRY\" == \"1\" && \"$TRAVIS_BRANCH\" == \"try\" ) ]]; then\n-        export SKIP_BUILD=false;\n-    else\n-        export SKIP_BUILD=true;\n-    fi\n-  - >\n-    if [[ \"$SKIP_BUILD\" == false ]]; then\n-      zcat $HOME/docker/rust-ci.tar.gz | docker load || true\n-    fi\n+  - zcat $HOME/docker/rust-ci.tar.gz | docker load || true\n   - mkdir -p $HOME/rustsrc\n \n install:\n-  - >\n-    if [[ \"$SKIP_BUILD\" == true ]]; then\n-      echo echo skipping, not a full build > $HOME/stamp &&\n-        chmod +x $HOME/stamp &&\n-        export PATH=$PATH:$HOME;\n-    else\n-      case \"$TRAVIS_OS_NAME\" in\n+  - case \"$TRAVIS_OS_NAME\" in\n         linux)\n           travis_retry curl -fo $HOME/stamp https://s3.amazonaws.com/rust-lang-ci/rust-ci-mirror/2017-03-17-stamp-x86_64-unknown-linux-musl &&\n             chmod +x $HOME/stamp &&\n@@ -179,8 +202,7 @@ install:\n           travis_retry curl -fo /usr/local/bin/stamp https://s3.amazonaws.com/rust-lang-ci/rust-ci-mirror/2017-03-17-stamp-x86_64-apple-darwin &&\n             chmod +x /usr/local/bin/stamp\n           ;;\n-      esac\n-    fi\n+    esac\n \n before_script:\n   - >\n@@ -285,7 +307,7 @@ deploy:\n       secure: \"kUGd3t7JcVWFESgIlzvsM8viZgCA9Encs3creW0xLJaLSeI1iVjlJK4h/2/nO6y224AFrh/GUfsNr4/4AlxPuYb8OU5oC5Lv+Ff2JiRDYtuNpyQSKAQp+bRYytWMtrmhja91h118Mbm90cUfcLPwkdiINgJNTXhPKg5Cqu3VYn0=\"\n     on:\n       branch: try\n-      condition: $DEPLOY = 1 && $ALLOW_TRY = 1\n+      condition: $DEPLOY = 1\n \n   # this is the same as the above deployment provider except that it uploads to\n   # a slightly different directory and has a different trigger"}]}