{"sha": "e97317c2d39689f1c7d53e8b3af64643ed5574c9", "node_id": "C_kwDOAAsO6NoAKGU5NzMxN2MyZDM5Njg5ZjFjN2Q1M2U4YjNhZjY0NjQzZWQ1NTc0Yzk", "commit": {"author": {"name": "Wesley Wiser", "email": "wesleywiser@microsoft.com", "date": "2021-11-09T17:28:55Z"}, "committer": {"name": "Wesley Wiser", "email": "wesleywiser@microsoft.com", "date": "2021-11-13T01:30:57Z"}, "message": "Build musl dist artifacts with debuginfo enabled\n\nSince our musl targets link to a version of musl we build and bundle\nwith the targets, if users need to debug into musl or generate\nbacktraces which contain parts of the musl library, they will be unable\nto do so unless we enable and ship the debug info.\n\nThis patch changes our dist builds so they enabled debug info when\nbuilding musl. This patch also includes a fix for CFI detection in\nmusl's `configure` script which has been posted upstream[1].\n\nThe net effect of this is that we now ship debug info for musl in those\ntargets. This adds ~90kb to those artifacts but running `strip` on\nbinaries produced removes all of that. For a \"hello world\" Rust binary\non x86_64, the numbers are:\n\n|                        | debug | release | release + strip |\n|           -            |   -   |    -    |        -        |\n| without musl debuginfo | 507kb |  495kb  |      410kb      |\n| with musl debuginfo    | 595kb |  584kb  |      410kb      |\n\nOnce stripped, the final binaries are the same size (down to the byte).\n\n[1]: https://www.openwall.com/lists/musl/2021/10/21/2", "tree": {"sha": "39431ada50333196d863751e6c8abaf9b92d0c8e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/39431ada50333196d863751e6c8abaf9b92d0c8e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e97317c2d39689f1c7d53e8b3af64643ed5574c9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e97317c2d39689f1c7d53e8b3af64643ed5574c9", "html_url": "https://github.com/rust-lang/rust/commit/e97317c2d39689f1c7d53e8b3af64643ed5574c9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e97317c2d39689f1c7d53e8b3af64643ed5574c9/comments", "author": {"login": "wesleywiser", "id": 831192, "node_id": "MDQ6VXNlcjgzMTE5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/831192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wesleywiser", "html_url": "https://github.com/wesleywiser", "followers_url": "https://api.github.com/users/wesleywiser/followers", "following_url": "https://api.github.com/users/wesleywiser/following{/other_user}", "gists_url": "https://api.github.com/users/wesleywiser/gists{/gist_id}", "starred_url": "https://api.github.com/users/wesleywiser/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wesleywiser/subscriptions", "organizations_url": "https://api.github.com/users/wesleywiser/orgs", "repos_url": "https://api.github.com/users/wesleywiser/repos", "events_url": "https://api.github.com/users/wesleywiser/events{/privacy}", "received_events_url": "https://api.github.com/users/wesleywiser/received_events", "type": "User", "site_admin": false}, "committer": {"login": "wesleywiser", "id": 831192, "node_id": "MDQ6VXNlcjgzMTE5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/831192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wesleywiser", "html_url": "https://github.com/wesleywiser", "followers_url": "https://api.github.com/users/wesleywiser/followers", "following_url": "https://api.github.com/users/wesleywiser/following{/other_user}", "gists_url": "https://api.github.com/users/wesleywiser/gists{/gist_id}", "starred_url": "https://api.github.com/users/wesleywiser/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wesleywiser/subscriptions", "organizations_url": "https://api.github.com/users/wesleywiser/orgs", "repos_url": "https://api.github.com/users/wesleywiser/repos", "events_url": "https://api.github.com/users/wesleywiser/events{/privacy}", "received_events_url": "https://api.github.com/users/wesleywiser/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "07acdb48a0e0b22d08a45e3ced0378e0027b40eb", "url": "https://api.github.com/repos/rust-lang/rust/commits/07acdb48a0e0b22d08a45e3ced0378e0027b40eb", "html_url": "https://github.com/rust-lang/rust/commit/07acdb48a0e0b22d08a45e3ced0378e0027b40eb"}], "stats": {"total": 25, "additions": 24, "deletions": 1}, "files": [{"sha": "61cc000dca55529ea82e1c7ded8fd7d0bedf2072", "filename": "src/ci/docker/host-x86_64/dist-arm-linux/Dockerfile", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/e97317c2d39689f1c7d53e8b3af64643ed5574c9/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-arm-linux%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/e97317c2d39689f1c7d53e8b3af64643ed5574c9/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-arm-linux%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-arm-linux%2FDockerfile?ref=e97317c2d39689f1c7d53e8b3af64643ed5574c9", "patch": "@@ -8,6 +8,7 @@ RUN sh /scripts/crosstool-ng-1.24.sh\n \n WORKDIR /build\n \n+COPY scripts/musl-patch-configure.diff /build/\n COPY scripts/musl-toolchain.sh /build/\n # We need to mitigate rust-lang/rust#34978 when compiling musl itself as well\n RUN CFLAGS=\"-Wa,--compress-debug-sections=none -Wl,--compress-debug-sections=none\" \\"}, {"sha": "ef49904b53d6a62e9806fbc8ee2a0ba6514817d9", "filename": "src/ci/docker/host-x86_64/dist-x86_64-musl/Dockerfile", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/e97317c2d39689f1c7d53e8b3af64643ed5574c9/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-x86_64-musl%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/e97317c2d39689f1c7d53e8b3af64643ed5574c9/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-x86_64-musl%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-x86_64-musl%2FDockerfile?ref=e97317c2d39689f1c7d53e8b3af64643ed5574c9", "patch": "@@ -24,6 +24,7 @@ WORKDIR /build/\n COPY scripts/cmake.sh /scripts/\n RUN /scripts/cmake.sh\n \n+COPY scripts/musl-patch-configure.diff /build/\n COPY scripts/musl-toolchain.sh /build/\n # We need to mitigate rust-lang/rust#34978 when compiling musl itself as well\n RUN CFLAGS=\"-Wa,-mrelax-relocations=no -Wa,--compress-debug-sections=none -Wl,--compress-debug-sections=none\" \\"}, {"sha": "4d554a2852a0910c490a623b7afdda4a8cf381b0", "filename": "src/ci/docker/host-x86_64/test-various/Dockerfile", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/e97317c2d39689f1c7d53e8b3af64643ed5574c9/src%2Fci%2Fdocker%2Fhost-x86_64%2Ftest-various%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/e97317c2d39689f1c7d53e8b3af64643ed5574c9/src%2Fci%2Fdocker%2Fhost-x86_64%2Ftest-various%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Ftest-various%2FDockerfile?ref=e97317c2d39689f1c7d53e8b3af64643ed5574c9", "patch": "@@ -22,6 +22,7 @@ RUN curl -sL https://nodejs.org/dist/v15.14.0/node-v15.14.0-linux-x64.tar.xz | \\\n   tar -xJ\n \n WORKDIR /build/\n+COPY scripts/musl-patch-configure.diff /build/\n COPY scripts/musl-toolchain.sh /build/\n RUN bash musl-toolchain.sh x86_64 && rm -rf build\n WORKDIR /"}, {"sha": "6e106b4504b996d49f2b1b880ed975943712f2b5", "filename": "src/ci/docker/scripts/musl-patch-configure.diff", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/e97317c2d39689f1c7d53e8b3af64643ed5574c9/src%2Fci%2Fdocker%2Fscripts%2Fmusl-patch-configure.diff", "raw_url": "https://github.com/rust-lang/rust/raw/e97317c2d39689f1c7d53e8b3af64643ed5574c9/src%2Fci%2Fdocker%2Fscripts%2Fmusl-patch-configure.diff", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fscripts%2Fmusl-patch-configure.diff?ref=e97317c2d39689f1c7d53e8b3af64643ed5574c9", "patch": "@@ -0,0 +1,13 @@\n+diff --git a/configure b/configure\n+index 86801281..ed2f7998 100755\n+--- a/configure\n++++ b/configure\n+@@ -398,7 +398,7 @@ test \"$debug\" = yes && CFLAGS_AUTO=-g\n+ #\n+ printf \"checking whether we should preprocess assembly to add debugging information... \"\n+ if fnmatch '-g*|*\\ -g*' \"$CFLAGS_AUTO $CFLAGS\" &&\n+-   test -f \"tools/add-cfi.$ARCH.awk\" &&\n++   test -f \"$srcdir/tools/add-cfi.$ARCH.awk\" &&\n+    printf \".file 1 \\\"srcfile.s\\\"\\n.line 1\\n.cfi_startproc\\n.cfi_endproc\" | $CC -g -x assembler -c -o /dev/null 2>/dev/null -\n+ then\n+   ADD_CFI=yes"}, {"sha": "3c17f316d1fe870e7ff11a5c565efe20b7a4f031", "filename": "src/ci/docker/scripts/musl-toolchain.sh", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/e97317c2d39689f1c7d53e8b3af64643ed5574c9/src%2Fci%2Fdocker%2Fscripts%2Fmusl-toolchain.sh", "raw_url": "https://github.com/rust-lang/rust/raw/e97317c2d39689f1c7d53e8b3af64643ed5574c9/src%2Fci%2Fdocker%2Fscripts%2Fmusl-toolchain.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fscripts%2Fmusl-toolchain.sh?ref=e97317c2d39689f1c7d53e8b3af64643ed5574c9", "patch": "@@ -38,13 +38,20 @@ shift\n \n # Ancient binutils versions don't understand debug symbols produced by more recent tools.\n # Apparently applying `-fPIC` everywhere allows them to link successfully.\n-export CFLAGS=\"-fPIC $CFLAGS\"\n+# Enable debug info. If we don't do so, users can't debug into musl code,\n+# debuggers can't walk the stack, etc. Fixes #90103.\n+export CFLAGS=\"-fPIC -g1 $CFLAGS\"\n \n git clone https://github.com/richfelker/musl-cross-make # -b v0.9.9\n cd musl-cross-make\n # A few commits ahead of v0.9.9 to include the cowpatch fix:\n git checkout a54eb56f33f255dfca60be045f12a5cfaf5a72a9\n \n+# Fix the cfi detection script in musl's configure so cfi is generated\n+# when debug info is asked for.\n+mkdir patches/musl-1.1.24\n+cp ../musl-patch-configure.diff patches/musl-1.1.24/0001-fix-cfi-detection.diff\n+\n hide_output make -j$(nproc) TARGET=$TARGET MUSL_VER=1.1.24 LINUX_HEADERS_SITE=$LINUX_HEADERS_SITE\n hide_output make install TARGET=$TARGET MUSL_VER=1.1.24 LINUX_HEADERS_SITE=$LINUX_HEADERS_SITE OUTPUT=$OUTPUT\n "}]}