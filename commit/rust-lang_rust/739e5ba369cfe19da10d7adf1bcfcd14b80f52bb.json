{"sha": "739e5ba369cfe19da10d7adf1bcfcd14b80f52bb", "node_id": "MDY6Q29tbWl0NzI0NzEyOjczOWU1YmEzNjljZmUxOWRhMTBkN2FkZjFiY2ZjZDE0YjgwZjUyYmI=", "commit": {"author": {"name": "Tim Chevalier", "email": "chevalier@alum.wellesley.edu", "date": "2013-02-04T23:30:32Z"}, "committer": {"name": "Tim Chevalier", "email": "chevalier@alum.wellesley.edu", "date": "2013-02-06T20:09:11Z"}, "message": "rustc: Less copy", "tree": {"sha": "cd2c76064a6370a57708ba042c3c1231b888e62b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/cd2c76064a6370a57708ba042c3c1231b888e62b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/739e5ba369cfe19da10d7adf1bcfcd14b80f52bb", "comment_count": 8, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/739e5ba369cfe19da10d7adf1bcfcd14b80f52bb", "html_url": "https://github.com/rust-lang/rust/commit/739e5ba369cfe19da10d7adf1bcfcd14b80f52bb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/739e5ba369cfe19da10d7adf1bcfcd14b80f52bb/comments", "author": {"login": "catamorphism", "id": 427212, "node_id": "MDQ6VXNlcjQyNzIxMg==", "avatar_url": "https://avatars.githubusercontent.com/u/427212?v=4", "gravatar_id": "", "url": "https://api.github.com/users/catamorphism", "html_url": "https://github.com/catamorphism", "followers_url": "https://api.github.com/users/catamorphism/followers", "following_url": "https://api.github.com/users/catamorphism/following{/other_user}", "gists_url": "https://api.github.com/users/catamorphism/gists{/gist_id}", "starred_url": "https://api.github.com/users/catamorphism/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/catamorphism/subscriptions", "organizations_url": "https://api.github.com/users/catamorphism/orgs", "repos_url": "https://api.github.com/users/catamorphism/repos", "events_url": "https://api.github.com/users/catamorphism/events{/privacy}", "received_events_url": "https://api.github.com/users/catamorphism/received_events", "type": "User", "site_admin": false}, "committer": {"login": "catamorphism", "id": 427212, "node_id": "MDQ6VXNlcjQyNzIxMg==", "avatar_url": "https://avatars.githubusercontent.com/u/427212?v=4", "gravatar_id": "", "url": "https://api.github.com/users/catamorphism", "html_url": "https://github.com/catamorphism", "followers_url": "https://api.github.com/users/catamorphism/followers", "following_url": "https://api.github.com/users/catamorphism/following{/other_user}", "gists_url": "https://api.github.com/users/catamorphism/gists{/gist_id}", "starred_url": "https://api.github.com/users/catamorphism/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/catamorphism/subscriptions", "organizations_url": "https://api.github.com/users/catamorphism/orgs", "repos_url": "https://api.github.com/users/catamorphism/repos", "events_url": "https://api.github.com/users/catamorphism/events{/privacy}", "received_events_url": "https://api.github.com/users/catamorphism/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "801f3225b24a796402b83f660f80e62ac504befe", "url": "https://api.github.com/repos/rust-lang/rust/commits/801f3225b24a796402b83f660f80e62ac504befe", "html_url": "https://github.com/rust-lang/rust/commit/801f3225b24a796402b83f660f80e62ac504befe"}], "stats": {"total": 30, "additions": 16, "deletions": 14}, "files": [{"sha": "34a68c1468c5d65b07cdd3cacd55b80286bbd7a3", "filename": "src/librustc/middle/trans/base.rs", "status": "modified", "additions": 13, "deletions": 13, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/739e5ba369cfe19da10d7adf1bcfcd14b80f52bb/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/739e5ba369cfe19da10d7adf1bcfcd14b80f52bb/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs?ref=739e5ba369cfe19da10d7adf1bcfcd14b80f52bb", "patch": "@@ -137,7 +137,7 @@ pub fn log_fn_time(ccx: @crate_ctxt, +name: ~str, start: time::Timespec,\n     ccx.stats.fn_times.push({ident: name, time: elapsed});\n }\n \n-pub fn decl_fn(llmod: ModuleRef, name: ~str, cc: lib::llvm::CallConv,\n+pub fn decl_fn(llmod: ModuleRef, name: &str, cc: lib::llvm::CallConv,\n                llty: TypeRef) -> ValueRef {\n     let llfn: ValueRef = str::as_c_str(name, |buf| {\n         unsafe {\n@@ -150,7 +150,7 @@ pub fn decl_fn(llmod: ModuleRef, name: ~str, cc: lib::llvm::CallConv,\n     return llfn;\n }\n \n-pub fn decl_cdecl_fn(llmod: ModuleRef, +name: ~str, llty: TypeRef)\n+pub fn decl_cdecl_fn(llmod: ModuleRef, name: &str, llty: TypeRef)\n                   -> ValueRef {\n     return decl_fn(llmod, name, lib::llvm::CCallConv, llty);\n }\n@@ -164,20 +164,19 @@ pub fn decl_internal_cdecl_fn(llmod: ModuleRef, +name: ~str, llty: TypeRef) ->\n     return llfn;\n }\n \n-pub fn get_extern_fn(externs: HashMap<~str, ValueRef>,\n+pub fn get_extern_fn(externs: ExternMap,\n                      llmod: ModuleRef,\n-                     +name: ~str,\n+                     name: @str,\n                      cc: lib::llvm::CallConv,\n                      ty: TypeRef) -> ValueRef {\n     if externs.contains_key_ref(&name) { return externs.get(&name); }\n-    // XXX: Bad copy.\n-    let f = decl_fn(llmod, copy name, cc, ty);\n+    let f = decl_fn(llmod, name, cc, ty);\n     externs.insert(name, f);\n     return f;\n }\n \n-pub fn get_extern_const(externs: HashMap<~str, ValueRef>, llmod: ModuleRef,\n-                        +name: ~str, ty: TypeRef) -> ValueRef {\n+pub fn get_extern_const(externs: ExternMap, llmod: ModuleRef,\n+                        name: @str, ty: TypeRef) -> ValueRef {\n     unsafe {\n         if externs.contains_key_ref(&name) { return externs.get(&name); }\n         let c = str::as_c_str(name, |buf| {\n@@ -189,9 +188,9 @@ pub fn get_extern_const(externs: HashMap<~str, ValueRef>, llmod: ModuleRef,\n }\n \n     fn get_simple_extern_fn(cx: block,\n-                            externs: HashMap<~str, ValueRef>,\n+                            externs: ExternMap,\n                             llmod: ModuleRef,\n-                            +name: ~str,\n+                            name: @str,\n                             n_args: int) -> ValueRef {\n     let _icx = cx.insn_ctxt(\"get_simple_extern_fn\");\n     let ccx = cx.fcx.ccx;\n@@ -201,8 +200,8 @@ pub fn get_extern_const(externs: HashMap<~str, ValueRef>, llmod: ModuleRef,\n     return get_extern_fn(externs, llmod, name, lib::llvm::CCallConv, t);\n }\n \n-pub fn trans_foreign_call(cx: block, externs: HashMap<~str, ValueRef>,\n-                          llmod: ModuleRef, +name: ~str, args: ~[ValueRef]) ->\n+pub fn trans_foreign_call(cx: block, externs: ExternMap,\n+                          llmod: ModuleRef, name: @str, args: ~[ValueRef]) ->\n    ValueRef {\n     let _icx = cx.insn_ctxt(\"trans_foreign_call\");\n     let n = args.len() as int;\n@@ -474,6 +473,7 @@ pub fn get_res_dtor(ccx: @crate_ctxt, did: ast::def_id,\n         let class_ty = ty::subst_tps(tcx, substs, None,\n                           ty::lookup_item_type(tcx, parent_id).ty);\n         let llty = type_of_dtor(ccx, class_ty);\n+        let name = name.to_managed(); // :-(\n         get_extern_fn(ccx.externs, ccx.llmod, name, lib::llvm::CCallConv,\n                       llty)\n     }\n@@ -766,7 +766,7 @@ pub fn null_env_ptr(bcx: block) -> ValueRef {\n \n pub fn trans_external_path(ccx: @crate_ctxt, did: ast::def_id, t: ty::t)\n     -> ValueRef {\n-    let name = csearch::get_symbol(ccx.sess.cstore, did);\n+    let name = csearch::get_symbol(ccx.sess.cstore, did).to_managed(); // Sad\n     match ty::get(t).sty {\n       ty::ty_fn(_) => {\n         let llty = type_of_fn_from_ty(ccx, t);"}, {"sha": "995d78a02e8ed2c314b30c0252654036ea9ceb21", "filename": "src/librustc/middle/trans/common.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/739e5ba369cfe19da10d7adf1bcfcd14b80f52bb/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcommon.rs", "raw_url": "https://github.com/rust-lang/rust/raw/739e5ba369cfe19da10d7adf1bcfcd14b80f52bb/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcommon.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcommon.rs?ref=739e5ba369cfe19da10d7adf1bcfcd14b80f52bb", "patch": "@@ -152,13 +152,15 @@ pub fn BuilderRef_res(B: BuilderRef) -> BuilderRef_res {\n     }\n }\n \n+type ExternMap = HashMap<@str, ValueRef>;\n+\n // Crate context.  Every crate we compile has one of these.\n pub struct crate_ctxt {\n      sess: session::Session,\n      llmod: ModuleRef,\n      td: target_data,\n      tn: type_names,\n-     externs: HashMap<~str, ValueRef>,\n+     externs: ExternMap,\n      intrinsics: HashMap<~str, ValueRef>,\n      item_vals: HashMap<ast::node_id, ValueRef>,\n      exp_map2: resolve::ExportMap2,"}]}