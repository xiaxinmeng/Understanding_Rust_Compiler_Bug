{"sha": "9b128e40652cbf369388df07e17eec9dd91f56e7", "node_id": "MDY6Q29tbWl0NzI0NzEyOjliMTI4ZTQwNjUyY2JmMzY5Mzg4ZGYwN2UxN2VlYzlkZDkxZjU2ZTc=", "commit": {"author": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2017-10-13T15:38:00Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2017-10-13T15:38:00Z"}, "message": "Rollup merge of #45209 - kennytm:treat-checksum-error-as-download-error, r=Mark-Simulacrum\n\nrustbuild: Make openssl download more reliable.\n\n1. Add `-f` flag to curl, so when the server returns 403 or 500 it will fail immediately.\n2. Moved the checksum part into the retry loop, assuming checksum failure is due to broken download that can be fixed by downloading again.\n\nThis PR is created responding to two recent spurious failures in https://github.com/rust-lang/rust/pull/45075#issuecomment-335202319 and https://github.com/rust-lang/rust/pull/45030#issuecomment-335029356.\n\nr? @Mark-Simulacrum , cc @aidanhs", "tree": {"sha": "f47068c824cce62bea00891518ea78d019f1bf61", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f47068c824cce62bea00891518ea78d019f1bf61"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9b128e40652cbf369388df07e17eec9dd91f56e7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9b128e40652cbf369388df07e17eec9dd91f56e7", "html_url": "https://github.com/rust-lang/rust/commit/9b128e40652cbf369388df07e17eec9dd91f56e7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9b128e40652cbf369388df07e17eec9dd91f56e7/comments", "author": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "64cc5ecc1a012fedcae1e8c4014ac583f5f50edb", "url": "https://api.github.com/repos/rust-lang/rust/commits/64cc5ecc1a012fedcae1e8c4014ac583f5f50edb", "html_url": "https://github.com/rust-lang/rust/commit/64cc5ecc1a012fedcae1e8c4014ac583f5f50edb"}, {"sha": "90d58a362aaa27dab9a820f60c636811deb26de5", "url": "https://api.github.com/repos/rust-lang/rust/commits/90d58a362aaa27dab9a820f60c636811deb26de5", "html_url": "https://github.com/rust-lang/rust/commit/90d58a362aaa27dab9a820f60c636811deb26de5"}], "stats": {"total": 57, "additions": 37, "deletions": 20}, "files": [{"sha": "2c8e5004041da3480cdd8ae0e32bb0e60dda45a7", "filename": "src/bootstrap/native.rs", "status": "modified", "additions": 37, "deletions": 20, "changes": 57, "blob_url": "https://github.com/rust-lang/rust/blob/9b128e40652cbf369388df07e17eec9dd91f56e7/src%2Fbootstrap%2Fnative.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b128e40652cbf369388df07e17eec9dd91f56e7/src%2Fbootstrap%2Fnative.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fnative.rs?ref=9b128e40652cbf369388df07e17eec9dd91f56e7", "patch": "@@ -352,34 +352,51 @@ impl Step for Openssl {\n             // originally from https://www.openssl.org/source/...\n             let url = format!(\"https://s3-us-west-1.amazonaws.com/rust-lang-ci2/rust-ci-mirror/{}\",\n                               name);\n-            let mut ok = false;\n+            let mut last_error = None;\n             for _ in 0..3 {\n                 let status = Command::new(\"curl\")\n                                 .arg(\"-o\").arg(&tmp)\n+                                .arg(\"-f\")  // make curl fail if the URL does not return HTTP 200\n                                 .arg(&url)\n                                 .status()\n                                 .expect(\"failed to spawn curl\");\n-                if status.success() {\n-                    ok = true;\n-                    break\n+\n+                // Retry if download failed.\n+                if !status.success() {\n+                    last_error = Some(status.to_string());\n+                    continue;\n                 }\n+\n+                // Ensure the hash is correct.\n+                let mut shasum = if target.contains(\"apple\") || build.build.contains(\"netbsd\") {\n+                    let mut cmd = Command::new(\"shasum\");\n+                    cmd.arg(\"-a\").arg(\"256\");\n+                    cmd\n+                } else {\n+                    Command::new(\"sha256sum\")\n+                };\n+                let output = output(&mut shasum.arg(&tmp));\n+                let found = output.split_whitespace().next().unwrap();\n+\n+                // If the hash is wrong, probably the download is incomplete or S3 served an error\n+                // page. In any case, retry.\n+                if found != OPENSSL_SHA256 {\n+                    last_error = Some(format!(\n+                        \"downloaded openssl sha256 different\\n\\\n+                         expected: {}\\n\\\n+                         found:    {}\\n\",\n+                        OPENSSL_SHA256,\n+                        found\n+                    ));\n+                    continue;\n+                }\n+\n+                // Everything is fine, so exit the retry loop.\n+                last_error = None;\n+                break;\n             }\n-            if !ok {\n-                panic!(\"failed to download openssl source\")\n-            }\n-            let mut shasum = if target.contains(\"apple\") || build.build.contains(\"netbsd\") {\n-                let mut cmd = Command::new(\"shasum\");\n-                cmd.arg(\"-a\").arg(\"256\");\n-                cmd\n-            } else {\n-                Command::new(\"sha256sum\")\n-            };\n-            let output = output(&mut shasum.arg(&tmp));\n-            let found = output.split_whitespace().next().unwrap();\n-            if found != OPENSSL_SHA256 {\n-                panic!(\"downloaded openssl sha256 different\\n\\\n-                        expected: {}\\n\\\n-                        found:    {}\\n\", OPENSSL_SHA256, found);\n+            if let Some(error) = last_error {\n+                panic!(\"failed to download openssl source: {}\", error);\n             }\n             t!(fs::rename(&tmp, &tarball));\n         }"}]}