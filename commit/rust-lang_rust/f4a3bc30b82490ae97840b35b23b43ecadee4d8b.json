{"sha": "f4a3bc30b82490ae97840b35b23b43ecadee4d8b", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY0YTNiYzMwYjgyNDkwYWU5Nzg0MGIzNWIyM2I0M2VjYWRlZTRkOGI=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2020-07-03T16:45:18Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2020-07-03T16:47:26Z"}, "message": "Fix module renaming", "tree": {"sha": "fd6ded0dfaabc2adb9c7cd51e4aef8597f8524fa", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fd6ded0dfaabc2adb9c7cd51e4aef8597f8524fa"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f4a3bc30b82490ae97840b35b23b43ecadee4d8b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f4a3bc30b82490ae97840b35b23b43ecadee4d8b", "html_url": "https://github.com/rust-lang/rust/commit/f4a3bc30b82490ae97840b35b23b43ecadee4d8b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f4a3bc30b82490ae97840b35b23b43ecadee4d8b/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4c347a9f650f2cdce3890ff95c16a09d7c57e2dc", "url": "https://api.github.com/repos/rust-lang/rust/commits/4c347a9f650f2cdce3890ff95c16a09d7c57e2dc", "html_url": "https://github.com/rust-lang/rust/commit/4c347a9f650f2cdce3890ff95c16a09d7c57e2dc"}], "stats": {"total": 59, "additions": 53, "deletions": 6}, "files": [{"sha": "8735ec53cf2ae379ffed0b2f82c08c2d061025d6", "filename": "crates/ra_ide/src/references/rename.rs", "status": "modified", "additions": 53, "deletions": 6, "changes": 59, "blob_url": "https://github.com/rust-lang/rust/blob/f4a3bc30b82490ae97840b35b23b43ecadee4d8b/crates%2Fra_ide%2Fsrc%2Freferences%2Frename.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f4a3bc30b82490ae97840b35b23b43ecadee4d8b/crates%2Fra_ide%2Fsrc%2Freferences%2Frename.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Freferences%2Frename.rs?ref=f4a3bc30b82490ae97840b35b23b43ecadee4d8b", "patch": "@@ -116,8 +116,7 @@ fn rename_mod(\n             } else {\n                 format!(\"{}.rs\", new_name)\n             };\n-            let move_file =\n-                FileSystemEdit::MoveFile { src: file_id, anchor: position.file_id, dst };\n+            let move_file = FileSystemEdit::MoveFile { src: file_id, anchor: file_id, dst };\n             file_system_edits.push(move_file);\n         }\n         ModuleSource::Module(..) => {}\n@@ -621,7 +620,7 @@ mod foo<|>;\n                                     3,\n                                 ),\n                                 anchor: FileId(\n-                                    2,\n+                                    3,\n                                 ),\n                                 dst: \"foo2.rs\",\n                             },\n@@ -687,7 +686,7 @@ use crate::foo<|>::FooContent;\n                                     2,\n                                 ),\n                                 anchor: FileId(\n-                                    3,\n+                                    2,\n                                 ),\n                                 dst: \"quux.rs\",\n                             },\n@@ -734,7 +733,7 @@ mod fo<|>o;\n                                     2,\n                                 ),\n                                 anchor: FileId(\n-                                    1,\n+                                    2,\n                                 ),\n                                 dst: \"../foo2/mod.rs\",\n                             },\n@@ -746,6 +745,54 @@ mod fo<|>o;\n         );\n     }\n \n+    #[test]\n+    fn test_rename_unusually_nested_mod() {\n+        check_expect(\n+            \"bar\",\n+            r#\"\n+//- /lib.rs\n+mod outer { mod fo<|>o; }\n+\n+//- /outer/foo.rs\n+// emtpy\n+\"#,\n+            expect![[r#\"\n+                RangeInfo {\n+                    range: 16..19,\n+                    info: SourceChange {\n+                        source_file_edits: [\n+                            SourceFileEdit {\n+                                file_id: FileId(\n+                                    1,\n+                                ),\n+                                edit: TextEdit {\n+                                    indels: [\n+                                        Indel {\n+                                            insert: \"bar\",\n+                                            delete: 16..19,\n+                                        },\n+                                    ],\n+                                },\n+                            },\n+                        ],\n+                        file_system_edits: [\n+                            MoveFile {\n+                                src: FileId(\n+                                    2,\n+                                ),\n+                                anchor: FileId(\n+                                    2,\n+                                ),\n+                                dst: \"bar.rs\",\n+                            },\n+                        ],\n+                        is_snippet: false,\n+                    },\n+                }\n+            \"#]],\n+        );\n+    }\n+\n     #[test]\n     fn test_module_rename_in_path() {\n         check(\n@@ -818,7 +865,7 @@ pub mod foo<|>;\n                                     3,\n                                 ),\n                                 anchor: FileId(\n-                                    2,\n+                                    3,\n                                 ),\n                                 dst: \"foo2.rs\",\n                             },"}]}