{"sha": "df148e4efb3bfd973d94217e52a01cde76fec09b", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRmMTQ4ZTRlZmIzYmZkOTczZDk0MjE3ZTUyYTAxY2RlNzZmZWMwOWI=", "commit": {"author": {"name": "Camille GILLOT", "email": "gillot.camille@gmail.com", "date": "2021-08-26T18:27:06Z"}, "committer": {"name": "Camille GILLOT", "email": "gillot.camille@gmail.com", "date": "2021-09-02T17:08:59Z"}, "message": "Drop walk_crate_and_attributes.", "tree": {"sha": "fafad3957b65335487a3f801c566dad176a88bad", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fafad3957b65335487a3f801c566dad176a88bad"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/df148e4efb3bfd973d94217e52a01cde76fec09b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/df148e4efb3bfd973d94217e52a01cde76fec09b", "html_url": "https://github.com/rust-lang/rust/commit/df148e4efb3bfd973d94217e52a01cde76fec09b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/df148e4efb3bfd973d94217e52a01cde76fec09b/comments", "author": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "committer": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "bd2f08c22fa89dbbcccc56a04231cfb63a80132e", "url": "https://api.github.com/repos/rust-lang/rust/commits/bd2f08c22fa89dbbcccc56a04231cfb63a80132e", "html_url": "https://github.com/rust-lang/rust/commit/bd2f08c22fa89dbbcccc56a04231cfb63a80132e"}], "stats": {"total": 30, "additions": 10, "deletions": 20}, "files": [{"sha": "2dd49eba4427a8bd00305c8f7633fe3814c69ab7", "filename": "compiler/rustc_hir/src/intravisit.rs", "status": "modified", "additions": 0, "deletions": 12, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/df148e4efb3bfd973d94217e52a01cde76fec09b/compiler%2Frustc_hir%2Fsrc%2Fintravisit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/df148e4efb3bfd973d94217e52a01cde76fec09b/compiler%2Frustc_hir%2Fsrc%2Fintravisit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir%2Fsrc%2Fintravisit.rs?ref=df148e4efb3bfd973d94217e52a01cde76fec09b", "patch": "@@ -32,7 +32,6 @@\n //! example generator inference, and possibly also HIR borrowck.\n \n use crate::hir::*;\n-use crate::hir_id::CRATE_HIR_ID;\n use crate::itemlikevisit::{ItemLikeVisitor, ParItemLikeVisitor};\n use rustc_ast::walk_list;\n use rustc_ast::{Attribute, Label};\n@@ -477,17 +476,6 @@ pub trait Visitor<'v>: Sized {\n     }\n }\n \n-/// Walks the contents of a crate. See also `Crate::visit_all_items`.\n-pub fn walk_crate_and_attributes<'v, V: Visitor<'v>>(visitor: &mut V, krate: &'v Crate<'v>) {\n-    let top_mod = krate.module();\n-    visitor.visit_mod(top_mod, top_mod.inner, CRATE_HIR_ID);\n-    for (&id, attrs) in krate.attrs.iter() {\n-        for a in *attrs {\n-            visitor.visit_attribute(id, a)\n-        }\n-    }\n-}\n-\n pub fn walk_mod<'v, V: Visitor<'v>>(visitor: &mut V, module: &'v Mod<'v>, mod_hir_id: HirId) {\n     visitor.visit_id(mod_hir_id);\n     for &item_id in module.item_ids {"}, {"sha": "3eb588c7ff06bcba1d57fe9218cd053d08110f96", "filename": "compiler/rustc_interface/src/passes.rs", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/df148e4efb3bfd973d94217e52a01cde76fec09b/compiler%2Frustc_interface%2Fsrc%2Fpasses.rs", "raw_url": "https://github.com/rust-lang/rust/raw/df148e4efb3bfd973d94217e52a01cde76fec09b/compiler%2Frustc_interface%2Fsrc%2Fpasses.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_interface%2Fsrc%2Fpasses.rs?ref=df148e4efb3bfd973d94217e52a01cde76fec09b", "patch": "@@ -464,10 +464,6 @@ pub fn lower_to_hir<'res, 'tcx>(\n         arena,\n     );\n \n-    if sess.opts.debugging_opts.hir_stats {\n-        hir_stats::print_hir_stats(&hir_crate);\n-    }\n-\n     sess.time(\"early_lint_checks\", || {\n         rustc_lint::check_ast_crate(\n             sess,"}, {"sha": "18f61c6e1c1a787df5b6733e881d0db950c4f3f2", "filename": "compiler/rustc_passes/src/hir_id_validator.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/df148e4efb3bfd973d94217e52a01cde76fec09b/compiler%2Frustc_passes%2Fsrc%2Fhir_id_validator.rs", "raw_url": "https://github.com/rust-lang/rust/raw/df148e4efb3bfd973d94217e52a01cde76fec09b/compiler%2Frustc_passes%2Fsrc%2Fhir_id_validator.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fhir_id_validator.rs?ref=df148e4efb3bfd973d94217e52a01cde76fec09b", "patch": "@@ -11,6 +11,10 @@ use rustc_middle::ty::TyCtxt;\n pub fn check_crate(tcx: TyCtxt<'_>) {\n     tcx.dep_graph.assert_ignored();\n \n+    if tcx.sess.opts.debugging_opts.hir_stats {\n+        crate::hir_stats::print_hir_stats(tcx);\n+    }\n+\n     let errors = Lock::new(Vec::new());\n     let hir_map = tcx.hir();\n "}, {"sha": "58693cdda90fa55de843ef3a9e057c23de2f6af3", "filename": "compiler/rustc_passes/src/hir_stats.rs", "status": "modified", "additions": 6, "deletions": 4, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/df148e4efb3bfd973d94217e52a01cde76fec09b/compiler%2Frustc_passes%2Fsrc%2Fhir_stats.rs", "raw_url": "https://github.com/rust-lang/rust/raw/df148e4efb3bfd973d94217e52a01cde76fec09b/compiler%2Frustc_passes%2Fsrc%2Fhir_stats.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fhir_stats.rs?ref=df148e4efb3bfd973d94217e52a01cde76fec09b", "patch": "@@ -9,6 +9,7 @@ use rustc_hir as hir;\n use rustc_hir::intravisit as hir_visit;\n use rustc_hir::HirId;\n use rustc_middle::hir::map::Map;\n+use rustc_middle::ty::TyCtxt;\n use rustc_middle::util::common::to_readable_str;\n use rustc_span::Span;\n \n@@ -25,18 +26,19 @@ struct NodeData {\n }\n \n struct StatCollector<'k> {\n-    krate: Option<&'k hir::Crate<'k>>,\n+    krate: Option<Map<'k>>,\n     data: FxHashMap<&'static str, NodeData>,\n     seen: FxHashSet<Id>,\n }\n \n-pub fn print_hir_stats(krate: &hir::Crate<'_>) {\n+pub fn print_hir_stats(tcx: TyCtxt<'_>) {\n     let mut collector = StatCollector {\n-        krate: Some(krate),\n+        krate: Some(tcx.hir()),\n         data: FxHashMap::default(),\n         seen: FxHashSet::default(),\n     };\n-    hir_visit::walk_crate_and_attributes(&mut collector, krate);\n+    tcx.hir().walk_crate(&mut collector);\n+    tcx.hir().walk_attributes(&mut collector);\n     collector.print(\"HIR STATS\");\n }\n "}]}