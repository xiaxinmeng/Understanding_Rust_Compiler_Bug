{"sha": "d4b135f38c8c0050768c50e62043ddca5f09079a", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQ0YjEzNWYzOGM4YzAwNTA3NjhjNTBlNjIwNDNkZGNhNWYwOTA3OWE=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-12-21T17:45:46Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-12-21T17:46:21Z"}, "message": "Optimize and profile", "tree": {"sha": "5684bfee4f4614d503ed84ad3c540440c232b4bf", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5684bfee4f4614d503ed84ad3c540440c232b4bf"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d4b135f38c8c0050768c50e62043ddca5f09079a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d4b135f38c8c0050768c50e62043ddca5f09079a", "html_url": "https://github.com/rust-lang/rust/commit/d4b135f38c8c0050768c50e62043ddca5f09079a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d4b135f38c8c0050768c50e62043ddca5f09079a/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6d8a2ec3dd350541d7c0e5aa08795a42c4dbd8f8", "url": "https://api.github.com/repos/rust-lang/rust/commits/6d8a2ec3dd350541d7c0e5aa08795a42c4dbd8f8", "html_url": "https://github.com/rust-lang/rust/commit/6d8a2ec3dd350541d7c0e5aa08795a42c4dbd8f8"}], "stats": {"total": 22, "additions": 19, "deletions": 3}, "files": [{"sha": "55afcda7bf5af56bc204c37e82685d9ebf775971", "filename": "Cargo.lock", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d4b135f38c8c0050768c50e62043ddca5f09079a/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/d4b135f38c8c0050768c50e62043ddca5f09079a/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=d4b135f38c8c0050768c50e62043ddca5f09079a", "patch": "@@ -948,6 +948,7 @@ dependencies = [\n  \"ra_hir_def 0.1.0\",\n  \"ra_hir_expand 0.1.0\",\n  \"ra_hir_ty 0.1.0\",\n+ \"ra_prof 0.1.0\",\n  \"ra_syntax 0.1.0\",\n  \"rustc-hash 1.0.1 (registry+https://github.com/rust-lang/crates.io-index)\",\n ]"}, {"sha": "7dc31ad3cbdefe7a67c1ffb2f723523e27796ad8", "filename": "crates/ra_hir/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d4b135f38c8c0050768c50e62043ddca5f09079a/crates%2Fra_hir%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/d4b135f38c8c0050768c50e62043ddca5f09079a/crates%2Fra_hir%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2FCargo.toml?ref=d4b135f38c8c0050768c50e62043ddca5f09079a", "patch": "@@ -14,6 +14,7 @@ either = \"1.5\"\n \n ra_syntax = { path = \"../ra_syntax\" }\n ra_db = { path = \"../ra_db\" }\n+ra_prof = { path = \"../ra_prof\" }\n hir_expand = { path = \"../ra_hir_expand\", package = \"ra_hir_expand\" }\n hir_def = { path = \"../ra_hir_def\", package = \"ra_hir_def\" }\n hir_ty = { path = \"../ra_hir_ty\", package = \"ra_hir_ty\" }"}, {"sha": "ebd9ee2a8e7146fdf97e3004c86db82fe8733361", "filename": "crates/ra_hir/src/from_source.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/d4b135f38c8c0050768c50e62043ddca5f09079a/crates%2Fra_hir%2Fsrc%2Ffrom_source.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4b135f38c8c0050768c50e62043ddca5f09079a/crates%2Fra_hir%2Fsrc%2Ffrom_source.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Ffrom_source.rs?ref=d4b135f38c8c0050768c50e62043ddca5f09079a", "patch": "@@ -7,6 +7,7 @@ use hir_def::{\n     StaticId, StructId, TraitId, TypeAliasId, UnionId, VariantId,\n };\n use hir_expand::{name::AsName, AstId, MacroDefId, MacroDefKind};\n+use ra_prof::profile;\n use ra_syntax::{\n     ast::{self, AstNode, NameOwner},\n     match_ast, SyntaxNode,\n@@ -169,6 +170,7 @@ impl TypeParam {\n \n impl Module {\n     pub fn from_declaration(db: &impl DefDatabase, src: InFile<ast::Module>) -> Option<Self> {\n+        let _p = profile(\"Module::from_declaration\");\n         let parent_declaration = src.value.syntax().ancestors().skip(1).find_map(ast::Module::cast);\n \n         let parent_module = match parent_declaration {\n@@ -191,6 +193,7 @@ impl Module {\n     }\n \n     pub fn from_definition(db: &impl DefDatabase, src: InFile<ModuleSource>) -> Option<Self> {\n+        let _p = profile(\"Module::from_definition\");\n         match src.value {\n             ModuleSource::Module(ref module) => {\n                 assert!(!module.has_semi());\n@@ -214,6 +217,7 @@ impl Module {\n }\n \n fn analyze_container(db: &impl DefDatabase, src: InFile<&SyntaxNode>) -> DynMap {\n+    let _p = profile(\"analyze_container\");\n     return child_by_source(db, src).unwrap_or_default();\n \n     fn child_by_source(db: &impl DefDatabase, src: InFile<&SyntaxNode>) -> Option<DynMap> {"}, {"sha": "85b378483c65540003c3a454c2695871b26c605e", "filename": "crates/ra_hir/src/source_binder.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/d4b135f38c8c0050768c50e62043ddca5f09079a/crates%2Fra_hir%2Fsrc%2Fsource_binder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4b135f38c8c0050768c50e62043ddca5f09079a/crates%2Fra_hir%2Fsrc%2Fsource_binder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fsource_binder.rs?ref=d4b135f38c8c0050768c50e62043ddca5f09079a", "patch": "@@ -26,6 +26,7 @@ use hir_ty::{\n     method_resolution::{self, implements_trait},\n     Canonical, InEnvironment, InferenceResult, TraitEnvironment, Ty,\n };\n+use ra_prof::profile;\n use ra_syntax::{\n     ast::{self, AstNode},\n     match_ast, AstPtr,\n@@ -83,6 +84,7 @@ fn def_with_body_from_child_node(\n     db: &impl HirDatabase,\n     child: InFile<&SyntaxNode>,\n ) -> Option<DefWithBody> {\n+    let _p = profile(\"def_with_body_from_child_node\");\n     child.cloned().ancestors_with_macros(db).find_map(|node| {\n         let n = &node.value;\n         match_ast! {\n@@ -169,6 +171,7 @@ impl SourceAnalyzer {\n         node: InFile<&SyntaxNode>,\n         offset: Option<TextUnit>,\n     ) -> SourceAnalyzer {\n+        let _p = profile(\"SourceAnalyzer::new\");\n         let def_with_body = def_with_body_from_child_node(db, node);\n         if let Some(def) = def_with_body {\n             let (_body, source_map) = db.body_with_source_map(def.into());"}, {"sha": "148ff007edc4d136df150246f362b6e66a9e19d2", "filename": "crates/ra_hir_def/src/body.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d4b135f38c8c0050768c50e62043ddca5f09079a/crates%2Fra_hir_def%2Fsrc%2Fbody.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4b135f38c8c0050768c50e62043ddca5f09079a/crates%2Fra_hir_def%2Fsrc%2Fbody.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_def%2Fsrc%2Fbody.rs?ref=d4b135f38c8c0050768c50e62043ddca5f09079a", "patch": "@@ -11,6 +11,7 @@ use hir_expand::{\n     ast_id_map::AstIdMap, hygiene::Hygiene, AstId, HirFileId, InFile, MacroCallKind, MacroDefId,\n };\n use ra_arena::{map::ArenaMap, Arena};\n+use ra_prof::profile;\n use ra_syntax::{ast, AstNode, AstPtr};\n use rustc_hash::FxHashMap;\n \n@@ -168,6 +169,7 @@ impl Body {\n         db: &impl DefDatabase,\n         def: DefWithBodyId,\n     ) -> (Arc<Body>, Arc<BodySourceMap>) {\n+        let _p = profile(\"body_with_source_map_query\");\n         let mut params = None;\n \n         let (file_id, module, body) = match def {"}, {"sha": "c5e406977395fae9e143c557843c1e131a227d7b", "filename": "crates/ra_ide/src/inlay_hints.rs", "status": "modified", "additions": 8, "deletions": 3, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/d4b135f38c8c0050768c50e62043ddca5f09079a/crates%2Fra_ide%2Fsrc%2Finlay_hints.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4b135f38c8c0050768c50e62043ddca5f09079a/crates%2Fra_ide%2Fsrc%2Finlay_hints.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Finlay_hints.rs?ref=d4b135f38c8c0050768c50e62043ddca5f09079a", "patch": "@@ -1,12 +1,15 @@\n //! FIXME: write short doc here\n \n-use crate::{db::RootDatabase, FileId};\n use hir::{HirDisplay, SourceAnalyzer};\n+use once_cell::unsync::Lazy;\n+use ra_prof::profile;\n use ra_syntax::{\n     ast::{self, AstNode, TypeAscriptionOwner},\n     match_ast, SmolStr, SourceFile, SyntaxKind, SyntaxNode, TextRange,\n };\n \n+use crate::{db::RootDatabase, FileId};\n+\n #[derive(Debug, PartialEq, Eq)]\n pub enum InlayKind {\n     TypeHint,\n@@ -27,7 +30,7 @@ pub(crate) fn inlay_hints(\n ) -> Vec<InlayHint> {\n     file.syntax()\n         .descendants()\n-        .map(|node| get_inlay_hints(db, file_id, &node, max_inlay_hint_length).unwrap_or_default())\n+        .flat_map(|node| get_inlay_hints(db, file_id, &node, max_inlay_hint_length))\n         .flatten()\n         .collect()\n }\n@@ -38,7 +41,9 @@ fn get_inlay_hints(\n     node: &SyntaxNode,\n     max_inlay_hint_length: Option<usize>,\n ) -> Option<Vec<InlayHint>> {\n-    let analyzer = SourceAnalyzer::new(db, hir::InFile::new(file_id.into(), node), None);\n+    let _p = profile(\"get_inlay_hints\");\n+    let analyzer =\n+        Lazy::new(|| SourceAnalyzer::new(db, hir::InFile::new(file_id.into(), node), None));\n     match_ast! {\n         match node {\n             ast::LetStmt(it) => {"}]}