{"sha": "f346309562c1b894a822839bfddf7291993163a5", "node_id": "MDY6Q29tbWl0NzI0NzEyOmYzNDYzMDk1NjJjMWI4OTRhODIyODM5YmZkZGY3MjkxOTkzMTYzYTU=", "commit": {"author": {"name": "David Wood", "email": "david@davidtw.co", "date": "2019-05-03T21:36:35Z"}, "committer": {"name": "David Wood", "email": "david@davidtw.co", "date": "2019-05-03T21:36:35Z"}, "message": "Fix async fn lowering ICE with APIT.\n\nThis commit fixes an ICE where simple bindings (which aren't replaced\nwith replacement arguments during async fn lowering) were not being\nvisited in the def collector and thus caused an ICE during HIR lowering\nfor types that use their `DefId` at that point - such as `impl Trait`.", "tree": {"sha": "ecba49c9c85c079a3a0948cb93364f4c62ef5128", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ecba49c9c85c079a3a0948cb93364f4c62ef5128"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f346309562c1b894a822839bfddf7291993163a5", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEWwgxPGhT5b/6kagXAXYLT59T8VQFAlzMtOcACgkQAXYLT59T\n8VQmxA//VXH6vfzoFu1h8yDeFTwW2z0PDEqicvZPk2Su5xqiO7HkV7qIet7+2sUR\nbwSijQDjPGmUKcN6O99WAOCV587S6K6JOhRQ4aqQVtLO+USs8Sx49iOccPXKH62Z\n+5MiL1ENH5+b6KjktIErVAOrXw38U14Xaa4m3Z69FjV/Hj1tAOnMcvKYyMlsS4rq\nDVCdje3EHdaWESPhKkd6Z5B03dEzkYMCLtKQEU3dZPoLuyzZILt4Gok88VTlqLDW\n3PP9RV3pi4XE2Jbc1TE+FYcGX323QhG9fqnIJ07O0XO9eOpmTZzgBOrXLuJujaYR\nwDlmpqb3rdHuO4wGvpBiOZEsp3cg+YA4DpXRih4BAB5lS4NOI6jSTrLxyy+0XmQE\n9PeQBSz0PrEiGNNyhuNatHALczgTeQY9gZcYUgyl80c3yKkKOAnkCJA6zs2T7z8B\nRKI6E1fbGMqD7fYOCbmYlpc6WJK/9HvZMqk1/aenDxIgDNaf9vEzG8wM30x1A4OJ\nMCNIIoi2fVZW54R9PbmZHccmA1YYitz2vOsjhUHcoiQmTtd52JTwwq8WqPM6+XCI\nx98thsasA6ZqLUi5z5iuLFRtG3XJ0qTphfxN5OTpC7iMJ87DpsIlQMjuYLxf0KCo\na4akNTGJFgz8Ekmx6XbWnN5cm4ley9zn5WzhtHcSihtEVVqvGZE=\n=/KPu\n-----END PGP SIGNATURE-----", "payload": "tree ecba49c9c85c079a3a0948cb93364f4c62ef5128\nparent 08bfe16129b0621bc90184f8704523d4929695ef\nauthor David Wood <david@davidtw.co> 1556919395 +0100\ncommitter David Wood <david@davidtw.co> 1556919395 +0100\n\nFix async fn lowering ICE with APIT.\n\nThis commit fixes an ICE where simple bindings (which aren't replaced\nwith replacement arguments during async fn lowering) were not being\nvisited in the def collector and thus caused an ICE during HIR lowering\nfor types that use their `DefId` at that point - such as `impl Trait`.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f346309562c1b894a822839bfddf7291993163a5", "html_url": "https://github.com/rust-lang/rust/commit/f346309562c1b894a822839bfddf7291993163a5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f346309562c1b894a822839bfddf7291993163a5/comments", "author": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "committer": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "08bfe16129b0621bc90184f8704523d4929695ef", "url": "https://api.github.com/repos/rust-lang/rust/commits/08bfe16129b0621bc90184f8704523d4929695ef", "html_url": "https://github.com/rust-lang/rust/commit/08bfe16129b0621bc90184f8704523d4929695ef"}], "stats": {"total": 16, "additions": 15, "deletions": 1}, "files": [{"sha": "7f1352095d936ab334d6145349e0735aaec76cdb", "filename": "src/librustc/hir/map/def_collector.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/f346309562c1b894a822839bfddf7291993163a5/src%2Flibrustc%2Fhir%2Fmap%2Fdef_collector.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f346309562c1b894a822839bfddf7291993163a5/src%2Flibrustc%2Fhir%2Fmap%2Fdef_collector.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fhir%2Fmap%2Fdef_collector.rs?ref=f346309562c1b894a822839bfddf7291993163a5", "patch": "@@ -92,10 +92,12 @@ impl<'a> DefCollector<'a> {\n             visit::walk_generics(this, generics);\n \n             // Walk the generated arguments for the `async fn`.\n-            for a in arguments {\n+            for (i, a) in arguments.iter().enumerate() {\n                 use visit::Visitor;\n                 if let Some(arg) = &a.arg {\n                     this.visit_ty(&arg.ty);\n+                } else {\n+                    this.visit_ty(&decl.inputs[i].ty);\n                 }\n             }\n "}, {"sha": "f603c5bd3f9462b7e4c9027095eb346628da3e01", "filename": "src/test/ui/async-await/issue-60518.rs", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/f346309562c1b894a822839bfddf7291993163a5/src%2Ftest%2Fui%2Fasync-await%2Fissue-60518.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f346309562c1b894a822839bfddf7291993163a5/src%2Ftest%2Fui%2Fasync-await%2Fissue-60518.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasync-await%2Fissue-60518.rs?ref=f346309562c1b894a822839bfddf7291993163a5", "patch": "@@ -0,0 +1,12 @@\n+// compile-pass\n+// edition:2018\n+\n+#![feature(async_await)]\n+\n+// This is a regression test to ensure that simple bindings (where replacement arguments aren't\n+// created during async fn lowering) that have their DefId used during HIR lowering (such as impl\n+// trait) are visited during def collection and thus have a DefId.\n+\n+async fn foo(ws: impl Iterator<Item = ()>) {}\n+\n+fn main() {}"}]}