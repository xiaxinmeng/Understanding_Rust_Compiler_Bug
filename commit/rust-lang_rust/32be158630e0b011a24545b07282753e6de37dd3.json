{"sha": "32be158630e0b011a24545b07282753e6de37dd3", "node_id": "C_kwDOAAsO6NoAKDMyYmUxNTg2MzBlMGIwMTFhMjQ1NDViMDcyODI3NTNlNmRlMzdkZDM", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-01-14T09:40:40Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-01-14T09:40:40Z"}, "message": "Auto merge of #13941 - matklad:rpj, r=Veykril\n\ninternal: explain the idea behind rust-project.json", "tree": {"sha": "fbc1fbb12a793ad50c6d1885fd416e4ef829bfbb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fbc1fbb12a793ad50c6d1885fd416e4ef829bfbb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/32be158630e0b011a24545b07282753e6de37dd3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/32be158630e0b011a24545b07282753e6de37dd3", "html_url": "https://github.com/rust-lang/rust/commit/32be158630e0b011a24545b07282753e6de37dd3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/32be158630e0b011a24545b07282753e6de37dd3/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a119352adab65d0cab25c13ae0fd7676bed7100f", "url": "https://api.github.com/repos/rust-lang/rust/commits/a119352adab65d0cab25c13ae0fd7676bed7100f", "html_url": "https://github.com/rust-lang/rust/commit/a119352adab65d0cab25c13ae0fd7676bed7100f"}, {"sha": "bd350085f66c5e392a14b11d40ac24b4fd139aca", "url": "https://api.github.com/repos/rust-lang/rust/commits/bd350085f66c5e392a14b11d40ac24b4fd139aca", "html_url": "https://github.com/rust-lang/rust/commit/bd350085f66c5e392a14b11d40ac24b4fd139aca"}], "stats": {"total": 44, "additions": 44, "deletions": 0}, "files": [{"sha": "4b2448e47f1ff09d2d61a52febf6e736b8cf7a31", "filename": "crates/project-model/src/project_json.rs", "status": "modified", "additions": 44, "deletions": 0, "changes": 44, "blob_url": "https://github.com/rust-lang/rust/blob/32be158630e0b011a24545b07282753e6de37dd3/crates%2Fproject-model%2Fsrc%2Fproject_json.rs", "raw_url": "https://github.com/rust-lang/rust/raw/32be158630e0b011a24545b07282753e6de37dd3/crates%2Fproject-model%2Fsrc%2Fproject_json.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproject-model%2Fsrc%2Fproject_json.rs?ref=32be158630e0b011a24545b07282753e6de37dd3", "patch": "@@ -4,6 +4,50 @@\n //! idea here is that people who do not use Cargo, can instead teach their build\n //! system to generate `rust-project.json` which can be ingested by\n //! rust-analyzer.\n+//!\n+//! This short file is a somewhat big conceptual piece of the architecture of\n+//! rust-analyzer, so it's worth elaborating on the underlying ideas and\n+//! motivation.\n+//!\n+//! For rust-analyzer to function, it needs some information about the project.\n+//! Specifically, it maintains an in-memory data structure which lists all the\n+//! crates (compilation units) and dependencies between them. This is necessary\n+//! a global singleton, as we do want, eg, find usages to always search across\n+//! the whole project, rather than just in the \"current\" crate.\n+//!\n+//! Normally, we get this \"crate graph\" by calling `cargo metadata\n+//! --message-format=json` for each cargo workspace and merging results. This\n+//! works for your typical cargo project, but breaks down for large folks who\n+//! have a monorepo with an infinite amount of Rust code which is built with bazel or\n+//! some such.\n+//!\n+//! To support this use case, we need to make _something_ configurable. To avoid\n+//! a [midlayer mistake](https://lwn.net/Articles/336262/), we allow configuring\n+//! the lowest possible layer. `ProjectJson` is essentially a hook to just set\n+//! that global singleton in-memory data structure. It is optimized for power,\n+//! not for convenience (you'd be using cargo anyway if you wanted nice things,\n+//! right? :)\n+//!\n+//! `rust-project.json` also isn't necessary a file. Architecturally, we support\n+//! any convenient way to specify this data, which today is:\n+//!\n+//! * file on disk\n+//! * a field in the config (ie, you can send a JSON request with the contents\n+//!   of rust-project.json to rust-analyzer, no need to write anything to disk)\n+//!\n+//! Another possible thing we don't do today, but which would be totally valid,\n+//! is to add an extension point to VS Code extension to register custom\n+//! project.\n+//!\n+//! In general, it is assumed that if you are going to use `rust-project.json`,\n+//! you'd write a fair bit of custom code gluing your build system to ra through\n+//! this JSON format. This logic can take form of a VS Code extension, or a\n+//! proxy process which injects data into \"configure\" LSP request, or maybe just\n+//! a simple build system rule to generate the file.\n+//!\n+//! In particular, the logic for lazily loading parts of the monorepo as the\n+//! user explores them belongs to that extension (it's totally valid to change\n+//! rust-project.json over time via configuration request!)\n \n use std::path::PathBuf;\n "}]}