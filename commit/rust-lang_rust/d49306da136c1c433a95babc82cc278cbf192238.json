{"sha": "d49306da136c1c433a95babc82cc278cbf192238", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQ0OTMwNmRhMTM2YzFjNDMzYTk1YmFiYzgyY2MyNzhjYmYxOTIyMzg=", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2020-03-11T13:23:13Z"}, "committer": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2020-03-11T13:23:13Z"}, "message": "implement zeroed and uninitialized with MaybeUninit", "tree": {"sha": "5925accc0e24d4ccc0dec2af7c58acd16f9f8dc9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5925accc0e24d4ccc0dec2af7c58acd16f9f8dc9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d49306da136c1c433a95babc82cc278cbf192238", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d49306da136c1c433a95babc82cc278cbf192238", "html_url": "https://github.com/rust-lang/rust/commit/d49306da136c1c433a95babc82cc278cbf192238", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d49306da136c1c433a95babc82cc278cbf192238/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "303d8aff6092709edd4dbd35b1c88e9aa40bf6d8", "url": "https://api.github.com/repos/rust-lang/rust/commits/303d8aff6092709edd4dbd35b1c88e9aa40bf6d8", "html_url": "https://github.com/rust-lang/rust/commit/303d8aff6092709edd4dbd35b1c88e9aa40bf6d8"}], "stats": {"total": 124, "additions": 14, "deletions": 110}, "files": [{"sha": "265ed48809527f76202fe7c0022eff79b61a9447", "filename": "src/libcore/intrinsics.rs", "status": "modified", "additions": 1, "deletions": 39, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/d49306da136c1c433a95babc82cc278cbf192238/src%2Flibcore%2Fintrinsics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d49306da136c1c433a95babc82cc278cbf192238/src%2Flibcore%2Fintrinsics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fintrinsics.rs?ref=d49306da136c1c433a95babc82cc278cbf192238", "patch": "@@ -1021,46 +1021,8 @@ extern \"rust-intrinsic\" {\n     #[rustc_const_unstable(feature = \"const_caller_location\", issue = \"47809\")]\n     pub fn caller_location() -> &'static crate::panic::Location<'static>;\n \n-    /// Creates a value initialized to zero.\n-    ///\n-    /// `init` is unsafe because it returns a zeroed-out datum,\n-    /// which is unsafe unless `T` is `Copy`. Also, even if T is\n-    /// `Copy`, an all-zero value may not correspond to any legitimate\n-    /// state for the type in question.\n-    ///\n-    /// The stabilized version of this intrinsic is\n-    /// [`std::mem::zeroed`](../../std/mem/fn.zeroed.html).\n-    #[unstable(\n-        feature = \"core_intrinsics\",\n-        reason = \"intrinsics are unlikely to ever be stabilized, instead \\\n-                         they should be used through stabilized interfaces \\\n-                         in the rest of the standard library\",\n-        issue = \"none\"\n-    )]\n-    #[rustc_deprecated(reason = \"superseded by MaybeUninit, removal planned\", since = \"1.38.0\")]\n-    pub fn init<T>() -> T;\n-\n-    /// Creates an uninitialized value.\n-    ///\n-    /// `uninit` is unsafe because there is no guarantee of what its\n-    /// contents are. In particular its drop-flag may be set to any\n-    /// state, which means it may claim either dropped or\n-    /// undropped. In the general case one must use `ptr::write` to\n-    /// initialize memory previous set to the result of `uninit`.\n-    ///\n-    /// The stabilized version of this intrinsic is\n-    /// [`std::mem::MaybeUninit`](../../std/mem/union.MaybeUninit.html).\n-    #[unstable(\n-        feature = \"core_intrinsics\",\n-        reason = \"intrinsics are unlikely to ever be stabilized, instead \\\n-                         they should be used through stabilized interfaces \\\n-                         in the rest of the standard library\",\n-        issue = \"none\"\n-    )]\n-    #[rustc_deprecated(reason = \"superseded by MaybeUninit, removal planned\", since = \"1.38.0\")]\n-    pub fn uninit<T>() -> T;\n-\n     /// Moves a value out of scope without running drop glue.\n+    /// This exists solely for `mem::forget_unsized`; normal `forget` uses `ManuallyDrop` instead.\n     pub fn forget<T: ?Sized>(_: T);\n \n     /// Reinterprets the bits of a value of one type as another type."}, {"sha": "9f7868005225eccd160195e1aabc1a65e6c3ac0a", "filename": "src/libcore/mem/mod.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/d49306da136c1c433a95babc82cc278cbf192238/src%2Flibcore%2Fmem%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d49306da136c1c433a95babc82cc278cbf192238/src%2Flibcore%2Fmem%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fmem%2Fmod.rs?ref=d49306da136c1c433a95babc82cc278cbf192238", "patch": "@@ -500,7 +500,7 @@ pub unsafe fn zeroed<T>() -> T {\n     intrinsics::panic_if_zero_invalid::<T>();\n     #[cfg(bootstrap)]\n     intrinsics::panic_if_uninhabited::<T>();\n-    intrinsics::init()\n+    MaybeUninit::zeroed().assume_init()\n }\n \n /// Bypasses Rust's normal memory-initialization checks by pretending to\n@@ -536,7 +536,7 @@ pub unsafe fn uninitialized<T>() -> T {\n     intrinsics::panic_if_any_invalid::<T>();\n     #[cfg(bootstrap)]\n     intrinsics::panic_if_uninhabited::<T>();\n-    intrinsics::uninit()\n+    MaybeUninit::uninit().assume_init()\n }\n \n /// Swaps the values at two mutable locations, without deinitializing either one."}, {"sha": "aa42d557b02617c77aed5b944ab89c306c260ac0", "filename": "src/librustc_codegen_llvm/intrinsic.rs", "status": "modified", "additions": 2, "deletions": 20, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/d49306da136c1c433a95babc82cc278cbf192238/src%2Flibrustc_codegen_llvm%2Fintrinsic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d49306da136c1c433a95babc82cc278cbf192238/src%2Flibrustc_codegen_llvm%2Fintrinsic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fintrinsic.rs?ref=d49306da136c1c433a95babc82cc278cbf192238", "patch": "@@ -195,26 +195,8 @@ impl IntrinsicCallMethods<'tcx> for Builder<'a, 'll, 'tcx> {\n                     .unwrap();\n                 OperandRef::from_const(self, ty_name, ret_ty).immediate_or_packed_pair(self)\n             }\n-            \"init\" => {\n-                let ty = substs.type_at(0);\n-                if !self.layout_of(ty).is_zst() {\n-                    // Just zero out the stack slot.\n-                    // If we store a zero constant, LLVM will drown in vreg allocation for large\n-                    // data structures, and the generated code will be awful. (A telltale sign of\n-                    // this is large quantities of `mov [byte ptr foo],0` in the generated code.)\n-                    memset_intrinsic(\n-                        self,\n-                        false,\n-                        ty,\n-                        llresult,\n-                        self.const_u8(0),\n-                        self.const_usize(1),\n-                    );\n-                }\n-                return;\n-            }\n-            // Effectively no-ops\n-            \"uninit\" | \"forget\" => {\n+            // Effectively no-op\n+            \"forget\" => {\n                 return;\n             }\n             \"offset\" => {"}, {"sha": "36b7ef87b5ef4317563e8899b097df4ca0fb4f36", "filename": "src/librustc_typeck/check/intrinsic.rs", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d49306da136c1c433a95babc82cc278cbf192238/src%2Flibrustc_typeck%2Fcheck%2Fintrinsic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d49306da136c1c433a95babc82cc278cbf192238/src%2Flibrustc_typeck%2Fcheck%2Fintrinsic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fintrinsic.rs?ref=d49306da136c1c433a95babc82cc278cbf192238", "patch": "@@ -150,8 +150,6 @@ pub fn check_intrinsic_type(tcx: TyCtxt<'_>, it: &hir::ForeignItem<'_>) {\n             \"panic_if_uninhabited\" | \"panic_if_zero_invalid\" | \"panic_if_any_invalid\" => {\n                 (1, Vec::new(), tcx.mk_unit())\n             }\n-            \"init\" => (1, Vec::new(), param(0)),\n-            \"uninit\" => (1, Vec::new(), param(0)),\n             \"forget\" => (1, vec![param(0)], tcx.mk_unit()),\n             \"transmute\" => (2, vec![param(0)], param(1)),\n             \"move_val_init\" => (1, vec![tcx.mk_mut_ptr(param(0)), param(0)], tcx.mk_unit()),"}, {"sha": "7a3ffbb6ad7bfe937dc884246d83b9c42e7bf3c8", "filename": "src/test/ui/init-large-type.rs", "status": "modified", "additions": 2, "deletions": 6, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/d49306da136c1c433a95babc82cc278cbf192238/src%2Ftest%2Fui%2Finit-large-type.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d49306da136c1c433a95babc82cc278cbf192238/src%2Ftest%2Fui%2Finit-large-type.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Finit-large-type.rs?ref=d49306da136c1c433a95babc82cc278cbf192238", "patch": "@@ -10,17 +10,13 @@\n \n #![feature(intrinsics)]\n \n-use std::thread;\n-\n-extern \"rust-intrinsic\" {\n-    pub fn init<T>() -> T;\n-}\n+use std::{mem, thread};\n \n const SIZE: usize = 1024 * 1024;\n \n fn main() {\n     // do the test in a new thread to avoid (spurious?) stack overflows\n     thread::spawn(|| {\n-        let _memory: [u8; SIZE] = unsafe { init() };\n+        let _memory: [u8; SIZE] = unsafe { mem::zeroed() };\n     }).join();\n }"}, {"sha": "3d65cfc2340926f6b7e07a08c4d23a6b24b15245", "filename": "src/test/ui/init-unsafe.rs", "status": "removed", "additions": 0, "deletions": 9, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/303d8aff6092709edd4dbd35b1c88e9aa40bf6d8/src%2Ftest%2Fui%2Finit-unsafe.rs", "raw_url": "https://github.com/rust-lang/rust/raw/303d8aff6092709edd4dbd35b1c88e9aa40bf6d8/src%2Ftest%2Fui%2Finit-unsafe.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Finit-unsafe.rs?ref=303d8aff6092709edd4dbd35b1c88e9aa40bf6d8", "patch": "@@ -1,9 +0,0 @@\n-#![allow(deprecated)]\n-#![feature(core_intrinsics)]\n-\n-use std::intrinsics::{init};\n-\n-// Test that the `init` intrinsic is really unsafe\n-pub fn main() {\n-    let stuff = init::<isize>(); //~ ERROR call to unsafe function is unsafe\n-}"}, {"sha": "e1126316af34ee3ab4f0839bc18f80a663d3e47e", "filename": "src/test/ui/init-unsafe.stderr", "status": "removed", "additions": 0, "deletions": 11, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/303d8aff6092709edd4dbd35b1c88e9aa40bf6d8/src%2Ftest%2Fui%2Finit-unsafe.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/303d8aff6092709edd4dbd35b1c88e9aa40bf6d8/src%2Ftest%2Fui%2Finit-unsafe.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Finit-unsafe.stderr?ref=303d8aff6092709edd4dbd35b1c88e9aa40bf6d8", "patch": "@@ -1,11 +0,0 @@\n-error[E0133]: call to unsafe function is unsafe and requires unsafe function or block\n-  --> $DIR/init-unsafe.rs:8:17\n-   |\n-LL |     let stuff = init::<isize>();\n-   |                 ^^^^^^^^^^^^^^^ call to unsafe function\n-   |\n-   = note: consult the function's documentation for information on how to avoid undefined behavior\n-\n-error: aborting due to previous error\n-\n-For more information about this error, try `rustc --explain E0133`."}, {"sha": "b672f1ed26e8d8d1dfdd81f57fa2cf929fa5f42b", "filename": "src/test/ui/intrinsics/intrinsic-move-val.rs", "status": "modified", "additions": 7, "deletions": 8, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/d49306da136c1c433a95babc82cc278cbf192238/src%2Ftest%2Fui%2Fintrinsics%2Fintrinsic-move-val.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d49306da136c1c433a95babc82cc278cbf192238/src%2Ftest%2Fui%2Fintrinsics%2Fintrinsic-move-val.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fintrinsics%2Fintrinsic-move-val.rs?ref=d49306da136c1c433a95babc82cc278cbf192238", "patch": "@@ -5,7 +5,6 @@\n \n mod rusti {\n     extern \"rust-intrinsic\" {\n-        pub fn init<T>() -> T;\n         pub fn move_val_init<T>(dst: *mut T, src: T);\n     }\n }\n@@ -15,17 +14,17 @@ pub fn main() {\n         // sanity check\n         check_drops_state(0, None);\n \n-        let mut x: Box<D> = box D(1);\n-        assert_eq!(x.0, 1);\n+        let mut x: Option<Box<D>> = Some(box D(1));\n+        assert_eq!(x.as_ref().unwrap().0, 1);\n \n         // A normal overwrite, to demonstrate `check_drops_state`.\n-        x = box D(2);\n+        x = Some(box D(2));\n \n         // At this point, one destructor has run, because the\n         // overwrite of `x` drops its initial value.\n         check_drops_state(1, Some(1));\n \n-        let mut y: Box<D> = rusti::init();\n+        let mut y: Option<Box<D>> = std::mem::zeroed();\n \n         // An initial binding does not overwrite anything.\n         check_drops_state(1, Some(1));\n@@ -51,9 +50,9 @@ pub fn main() {\n         // during such a destructor call. We do so after the end of\n         // this scope.\n \n-        assert_eq!(y.0, 2);\n-        y.0 = 3;\n-        assert_eq!(y.0, 3);\n+        assert_eq!(y.as_ref().unwrap().0, 2);\n+        y.as_mut().unwrap().0 = 3;\n+        assert_eq!(y.as_ref().unwrap().0, 3);\n \n         check_drops_state(1, Some(1));\n     }"}, {"sha": "9555efb639b50480e93a11db16d009cd23fa1f64", "filename": "src/test/ui/intrinsics/intrinsic-uninit.rs", "status": "removed", "additions": 0, "deletions": 13, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/303d8aff6092709edd4dbd35b1c88e9aa40bf6d8/src%2Ftest%2Fui%2Fintrinsics%2Fintrinsic-uninit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/303d8aff6092709edd4dbd35b1c88e9aa40bf6d8/src%2Ftest%2Fui%2Fintrinsics%2Fintrinsic-uninit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fintrinsics%2Fintrinsic-uninit.rs?ref=303d8aff6092709edd4dbd35b1c88e9aa40bf6d8", "patch": "@@ -1,13 +0,0 @@\n-// run-pass\n-// pretty-expanded FIXME #23616\n-\n-#![feature(intrinsics)]\n-\n-mod rusti {\n-    extern \"rust-intrinsic\" {\n-        pub fn uninit<T>() -> T;\n-    }\n-}\n-pub fn main() {\n-    let _a : isize = unsafe {rusti::uninit()};\n-}"}]}