{"sha": "fb888117da6cb3bdae352bafbdb2dc8e2b78a271", "node_id": "C_kwDOAAsO6NoAKGZiODg4MTE3ZGE2Y2IzYmRhZTM1MmJhZmJkYjJkYzhlMmI3OGEyNzE", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-09-01T13:21:03Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-09-01T13:21:03Z"}, "message": "Auto merge of #100606 - cuviper:upgrade-linux-ci, r=Mark-Simulacrum\n\nci: Upgrade non-dist Linux testers from ubuntu:16.04 to 22.04\n\nThe main goal of updating to 22.04 is to get away from `llvm.allow-old-toolchain`.\nA side benefit is that they can also use the system `cmake` instead of building one.", "tree": {"sha": "fa526759a731881c0b3a1f5765271b9bc9344299", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fa526759a731881c0b3a1f5765271b9bc9344299"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fb888117da6cb3bdae352bafbdb2dc8e2b78a271", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fb888117da6cb3bdae352bafbdb2dc8e2b78a271", "html_url": "https://github.com/rust-lang/rust/commit/fb888117da6cb3bdae352bafbdb2dc8e2b78a271", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fb888117da6cb3bdae352bafbdb2dc8e2b78a271/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4f9898a7947059433d08357cdaaba84c4705873d", "url": "https://api.github.com/repos/rust-lang/rust/commits/4f9898a7947059433d08357cdaaba84c4705873d", "html_url": "https://github.com/rust-lang/rust/commit/4f9898a7947059433d08357cdaaba84c4705873d"}, {"sha": "b96cde7cba8927ee75de2ad888c4089d99837e41", "url": "https://api.github.com/repos/rust-lang/rust/commits/b96cde7cba8927ee75de2ad888c4089d99837e41", "html_url": "https://github.com/rust-lang/rust/commit/b96cde7cba8927ee75de2ad888c4089d99837e41"}], "stats": {"total": 78, "additions": 26, "deletions": 52}, "files": [{"sha": "f61c95830858fb6f4b869b79701305627c7adc55", "filename": "src/bootstrap/test.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/fb888117da6cb3bdae352bafbdb2dc8e2b78a271/src%2Fbootstrap%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fb888117da6cb3bdae352bafbdb2dc8e2b78a271/src%2Fbootstrap%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Ftest.rs?ref=fb888117da6cb3bdae352bafbdb2dc8e2b78a271", "patch": "@@ -854,7 +854,10 @@ fn get_browser_ui_test_version_inner(npm: &Path, global: bool) -> Option<String>\n         .output()\n         .map(|output| String::from_utf8_lossy(&output.stdout).into_owned())\n         .unwrap_or(String::new());\n-    lines.lines().find_map(|l| l.split(\":browser-ui-test@\").skip(1).next()).map(|v| v.to_owned())\n+    lines\n+        .lines()\n+        .find_map(|l| l.split(':').nth(1)?.strip_prefix(\"browser-ui-test@\"))\n+        .map(|v| v.to_owned())\n }\n \n fn get_browser_ui_test_version(npm: &Path) -> Option<String> {"}, {"sha": "dd74726f856915a73311b92112066fe976d6e34a", "filename": "src/ci/docker/host-x86_64/i686-gnu-nopt/Dockerfile", "status": "modified", "additions": 3, "deletions": 10, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/fb888117da6cb3bdae352bafbdb2dc8e2b78a271/src%2Fci%2Fdocker%2Fhost-x86_64%2Fi686-gnu-nopt%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/fb888117da6cb3bdae352bafbdb2dc8e2b78a271/src%2Fci%2Fdocker%2Fhost-x86_64%2Fi686-gnu-nopt%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fi686-gnu-nopt%2FDockerfile?ref=fb888117da6cb3bdae352bafbdb2dc8e2b78a271", "patch": "@@ -1,5 +1,6 @@\n-FROM ubuntu:16.04\n+FROM ubuntu:22.04\n \n+ARG DEBIAN_FRONTEND=noninteractive\n RUN apt-get update && apt-get install -y --no-install-recommends \\\n   g++-multilib \\\n   make \\\n@@ -20,18 +21,10 @@ RUN apt-get update && apt-get install -y --no-install-recommends \\\n COPY scripts/sccache.sh /scripts/\n RUN sh /scripts/sccache.sh\n \n-COPY scripts/cmake.sh /scripts/\n-RUN /scripts/cmake.sh\n-\n RUN mkdir -p /config\n RUN echo \"[rust]\" > /config/nopt-std-config.toml\n RUN echo \"optimize = false\" >> /config/nopt-std-config.toml\n \n-# We are intentionally allowing an old toolchain on this builder (and that's\n-# incompatible with LLVM downloads today).\n-ENV NO_DOWNLOAD_CI_LLVM 1\n-\n-ENV RUST_CONFIGURE_ARGS --build=i686-unknown-linux-gnu --disable-optimize-tests \\\n-    --set llvm.allow-old-toolchain\n+ENV RUST_CONFIGURE_ARGS --build=i686-unknown-linux-gnu --disable-optimize-tests\n ENV SCRIPT python3 ../x.py test --stage 0 --config /config/nopt-std-config.toml library/std \\\n   && python3 ../x.py --stage 2 test"}, {"sha": "0c36cfd66bdef05ac0842102035c2288fc84b271", "filename": "src/ci/docker/host-x86_64/i686-gnu/Dockerfile", "status": "modified", "additions": 3, "deletions": 9, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/fb888117da6cb3bdae352bafbdb2dc8e2b78a271/src%2Fci%2Fdocker%2Fhost-x86_64%2Fi686-gnu%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/fb888117da6cb3bdae352bafbdb2dc8e2b78a271/src%2Fci%2Fdocker%2Fhost-x86_64%2Fi686-gnu%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fi686-gnu%2FDockerfile?ref=fb888117da6cb3bdae352bafbdb2dc8e2b78a271", "patch": "@@ -1,5 +1,6 @@\n-FROM ubuntu:16.04\n+FROM ubuntu:22.04\n \n+ARG DEBIAN_FRONTEND=noninteractive\n RUN apt-get update && apt-get install -y --no-install-recommends \\\n   g++-multilib \\\n   make \\\n@@ -20,14 +21,7 @@ RUN apt-get update && apt-get install -y --no-install-recommends \\\n COPY scripts/sccache.sh /scripts/\n RUN sh /scripts/sccache.sh\n \n-COPY scripts/cmake.sh /scripts/\n-RUN /scripts/cmake.sh\n-\n-# We are intentionally allowing an old toolchain on this builder (and that's\n-# incompatible with LLVM downloads today).\n-ENV NO_DOWNLOAD_CI_LLVM 1\n-ENV RUST_CONFIGURE_ARGS --build=i686-unknown-linux-gnu \\\n-    --set llvm.allow-old-toolchain\n+ENV RUST_CONFIGURE_ARGS --build=i686-unknown-linux-gnu\n # Exclude some tests that are unlikely to be platform specific, to speed up\n # this slow job.\n ENV SCRIPT python3 ../x.py --stage 2 test \\"}, {"sha": "d55d5b56ad3f5e8cccfced590d0d2c0a81dcbf0f", "filename": "src/ci/docker/host-x86_64/x86_64-gnu-aux/Dockerfile", "status": "modified", "additions": 3, "deletions": 10, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/fb888117da6cb3bdae352bafbdb2dc8e2b78a271/src%2Fci%2Fdocker%2Fhost-x86_64%2Fx86_64-gnu-aux%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/fb888117da6cb3bdae352bafbdb2dc8e2b78a271/src%2Fci%2Fdocker%2Fhost-x86_64%2Fx86_64-gnu-aux%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fx86_64-gnu-aux%2FDockerfile?ref=fb888117da6cb3bdae352bafbdb2dc8e2b78a271", "patch": "@@ -1,5 +1,6 @@\n-FROM ubuntu:16.04\n+FROM ubuntu:22.04\n \n+ARG DEBIAN_FRONTEND=noninteractive\n RUN apt-get update && apt-get install -y --no-install-recommends \\\n   g++ \\\n   make \\\n@@ -23,13 +24,5 @@ RUN apt-get update && apt-get install -y --no-install-recommends \\\n COPY scripts/sccache.sh /scripts/\n RUN sh /scripts/sccache.sh\n \n-COPY scripts/cmake.sh /scripts/\n-RUN /scripts/cmake.sh\n-\n-# We are intentionally allowing an old toolchain on this builder (and that's\n-# incompatible with LLVM downloads today).\n-ENV NO_DOWNLOAD_CI_LLVM 1\n-\n-ENV RUST_CONFIGURE_ARGS --build=x86_64-unknown-linux-gnu \\\n-    --set llvm.allow-old-toolchain\n+ENV RUST_CONFIGURE_ARGS --build=x86_64-unknown-linux-gnu\n ENV RUST_CHECK_TARGET check-aux"}, {"sha": "80a004501a81bb590553c4d77e8861587f331d07", "filename": "src/ci/docker/host-x86_64/x86_64-gnu-distcheck/Dockerfile", "status": "modified", "additions": 4, "deletions": 8, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/fb888117da6cb3bdae352bafbdb2dc8e2b78a271/src%2Fci%2Fdocker%2Fhost-x86_64%2Fx86_64-gnu-distcheck%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/fb888117da6cb3bdae352bafbdb2dc8e2b78a271/src%2Fci%2Fdocker%2Fhost-x86_64%2Fx86_64-gnu-distcheck%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fx86_64-gnu-distcheck%2FDockerfile?ref=fb888117da6cb3bdae352bafbdb2dc8e2b78a271", "patch": "@@ -1,5 +1,6 @@\n-FROM ubuntu:16.04\n+FROM ubuntu:22.04\n \n+ARG DEBIAN_FRONTEND=noninteractive\n RUN apt-get update && apt-get install -y --no-install-recommends \\\n   g++ \\\n   make \\\n@@ -19,14 +20,9 @@ RUN apt-get update && apt-get install -y --no-install-recommends \\\n COPY scripts/sccache.sh /scripts/\n RUN sh /scripts/sccache.sh\n \n-COPY scripts/cmake.sh /scripts/\n-RUN /scripts/cmake.sh\n-\n-# We are intentionally allowing an old toolchain on this builder (and that's\n-# incompatible with LLVM downloads today).\n+# We are disabling CI LLVM since distcheck is an offline build.\n ENV NO_DOWNLOAD_CI_LLVM 1\n \n-ENV RUST_CONFIGURE_ARGS --build=x86_64-unknown-linux-gnu --set rust.ignore-git=false \\\n-    --set llvm.allow-old-toolchain\n+ENV RUST_CONFIGURE_ARGS --build=x86_64-unknown-linux-gnu --set rust.ignore-git=false\n ENV SCRIPT python3 ../x.py --stage 2 test distcheck\n ENV DIST_SRC 1"}, {"sha": "4350ca205862ce742923d79c642b2511ad19f955", "filename": "src/ci/docker/host-x86_64/x86_64-gnu-tools/Dockerfile", "status": "modified", "additions": 7, "deletions": 12, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/fb888117da6cb3bdae352bafbdb2dc8e2b78a271/src%2Fci%2Fdocker%2Fhost-x86_64%2Fx86_64-gnu-tools%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/fb888117da6cb3bdae352bafbdb2dc8e2b78a271/src%2Fci%2Fdocker%2Fhost-x86_64%2Fx86_64-gnu-tools%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fx86_64-gnu-tools%2FDockerfile?ref=fb888117da6cb3bdae352bafbdb2dc8e2b78a271", "patch": "@@ -1,5 +1,6 @@\n-FROM ubuntu:16.04\n+FROM ubuntu:22.04\n \n+ARG DEBIAN_FRONTEND=noninteractive\n RUN apt-get update && apt-get install -y --no-install-recommends \\\n   g++ \\\n   make \\\n@@ -27,6 +28,7 @@ RUN apt-get install -y \\\n   libdbus-1-3 \\\n   libexpat1 \\\n   libfontconfig1 \\\n+  libgbm1 \\\n   libgcc1 \\\n   libgconf-2-4 \\\n   libgdk-pixbuf2.0-0 \\\n@@ -59,13 +61,10 @@ RUN apt-get install -y \\\n COPY scripts/sccache.sh /scripts/\n RUN sh /scripts/sccache.sh\n \n-COPY scripts/cmake.sh /scripts/\n-RUN /scripts/cmake.sh\n-\n COPY host-x86_64/x86_64-gnu-tools/checktools.sh /tmp/\n \n-RUN curl -sL https://nodejs.org/dist/v14.4.0/node-v14.4.0-linux-x64.tar.xz | tar -xJ\n-ENV NODE_FOLDER=/node-v14.4.0-linux-x64/bin\n+RUN curl -sL https://nodejs.org/dist/v14.20.0/node-v14.20.0-linux-x64.tar.xz | tar -xJ\n+ENV NODE_FOLDER=/node-v14.20.0-linux-x64/bin\n ENV PATH=\"$NODE_FOLDER:${PATH}\"\n \n COPY host-x86_64/x86_64-gnu-tools/browser-ui-test.version /tmp/\n@@ -80,14 +79,10 @@ COPY host-x86_64/x86_64-gnu-tools/browser-ui-test.version /tmp/\n # the local version of the package is different than the one used by the CI.\n RUN npm install -g browser-ui-test@$(head -n 1 /tmp/browser-ui-test.version) --unsafe-perm=true\n \n-# We are intentionally allowing an old toolchain on this builder (and that's\n-# incompatible with LLVM downloads today).\n-ENV NO_DOWNLOAD_CI_LLVM 1\n-\n ENV RUST_CONFIGURE_ARGS \\\n-  --set llvm.allow-old-toolchain \\\n   --build=x86_64-unknown-linux-gnu \\\n   --save-toolstates=/tmp/toolstate/toolstates.json\n \n ENV SCRIPT /tmp/checktools.sh ../x.py && \\\n-  NODE_PATH=`npm root -g` python3 ../x.py test src/test/rustdoc-gui --stage 2\n+  NODE_PATH=`npm root -g` python3 ../x.py test src/test/rustdoc-gui --stage 2 \\\n+    --test-args \"'--no-sandbox --jobs 1'\""}, {"sha": "85e03c45e700e985bebd41ecd88898398fc70a30", "filename": "src/test/rustdoc-gui/type-declation-overflow.goml", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/fb888117da6cb3bdae352bafbdb2dc8e2b78a271/src%2Ftest%2Frustdoc-gui%2Ftype-declation-overflow.goml", "raw_url": "https://github.com/rust-lang/rust/raw/fb888117da6cb3bdae352bafbdb2dc8e2b78a271/src%2Ftest%2Frustdoc-gui%2Ftype-declation-overflow.goml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-gui%2Ftype-declation-overflow.goml?ref=fb888117da6cb3bdae352bafbdb2dc8e2b78a271", "patch": "@@ -32,6 +32,6 @@ assert-property: (\".item-decl pre\", {\"scrollWidth\": \"950\"})\n size: (600, 600)\n goto: file://|DOC_PATH|/lib2/too_long/struct.SuperIncrediblyLongLongLongLongLongLongLongGigaGigaGigaMegaLongLongLongStructName.html\n // It shouldn't have an overflow in the topbar either.\n-assert-property: (\".mobile-topbar .location\", {\"scrollWidth\": \"492\"})\n-assert-property: (\".mobile-topbar .location\", {\"clientWidth\": \"492\"})\n+assert-property: (\".mobile-topbar .location\", {\"scrollWidth\": \"502\"})\n+assert-property: (\".mobile-topbar .location\", {\"clientWidth\": \"502\"})\n assert-css: (\".mobile-topbar .location\", {\"overflow-x\": \"hidden\"})"}]}