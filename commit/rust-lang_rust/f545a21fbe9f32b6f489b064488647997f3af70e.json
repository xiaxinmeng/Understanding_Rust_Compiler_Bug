{"sha": "f545a21fbe9f32b6f489b064488647997f3af70e", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY1NDVhMjFmYmU5ZjMyYjZmNDg5YjA2NDQ4ODY0Nzk5N2YzYWY3MGU=", "commit": {"author": {"name": "bjorn3", "email": "bjorn3@users.noreply.github.com", "date": "2021-03-15T13:21:15Z"}, "committer": {"name": "bjorn3", "email": "bjorn3@users.noreply.github.com", "date": "2021-03-15T13:21:15Z"}, "message": "Split rust fork setup out of test_bootstrap.sh", "tree": {"sha": "98034e165cfda4c95b0e0119b75db6ab674bb713", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/98034e165cfda4c95b0e0119b75db6ab674bb713"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f545a21fbe9f32b6f489b064488647997f3af70e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f545a21fbe9f32b6f489b064488647997f3af70e", "html_url": "https://github.com/rust-lang/rust/commit/f545a21fbe9f32b6f489b064488647997f3af70e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f545a21fbe9f32b6f489b064488647997f3af70e/comments", "author": {"login": "bjorn3", "id": 17426603, "node_id": "MDQ6VXNlcjE3NDI2NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/17426603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bjorn3", "html_url": "https://github.com/bjorn3", "followers_url": "https://api.github.com/users/bjorn3/followers", "following_url": "https://api.github.com/users/bjorn3/following{/other_user}", "gists_url": "https://api.github.com/users/bjorn3/gists{/gist_id}", "starred_url": "https://api.github.com/users/bjorn3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bjorn3/subscriptions", "organizations_url": "https://api.github.com/users/bjorn3/orgs", "repos_url": "https://api.github.com/users/bjorn3/repos", "events_url": "https://api.github.com/users/bjorn3/events{/privacy}", "received_events_url": "https://api.github.com/users/bjorn3/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bjorn3", "id": 17426603, "node_id": "MDQ6VXNlcjE3NDI2NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/17426603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bjorn3", "html_url": "https://github.com/bjorn3", "followers_url": "https://api.github.com/users/bjorn3/followers", "following_url": "https://api.github.com/users/bjorn3/following{/other_user}", "gists_url": "https://api.github.com/users/bjorn3/gists{/gist_id}", "starred_url": "https://api.github.com/users/bjorn3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bjorn3/subscriptions", "organizations_url": "https://api.github.com/users/bjorn3/orgs", "repos_url": "https://api.github.com/users/bjorn3/repos", "events_url": "https://api.github.com/users/bjorn3/events{/privacy}", "received_events_url": "https://api.github.com/users/bjorn3/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "78d0b7765107bcad95a5279b6a78fd0753159e1b", "url": "https://api.github.com/repos/rust-lang/rust/commits/78d0b7765107bcad95a5279b6a78fd0753159e1b", "html_url": "https://github.com/rust-lang/rust/commit/78d0b7765107bcad95a5279b6a78fd0753159e1b"}], "stats": {"total": 130, "additions": 69, "deletions": 61}, "files": [{"sha": "e8bedf625f79684574d2f94c7bd1f350a623e479", "filename": "scripts/setup_rust_fork.sh", "status": "added", "additions": 68, "deletions": 0, "changes": 68, "blob_url": "https://github.com/rust-lang/rust/blob/f545a21fbe9f32b6f489b064488647997f3af70e/scripts%2Fsetup_rust_fork.sh", "raw_url": "https://github.com/rust-lang/rust/raw/f545a21fbe9f32b6f489b064488647997f3af70e/scripts%2Fsetup_rust_fork.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/scripts%2Fsetup_rust_fork.sh?ref=f545a21fbe9f32b6f489b064488647997f3af70e", "patch": "@@ -0,0 +1,68 @@\n+#!/bin/bash\n+set -e\n+\n+./build.sh\n+source build/config.sh\n+\n+echo \"[SETUP] Rust fork\"\n+git clone https://github.com/rust-lang/rust.git || true\n+pushd rust\n+git fetch\n+git checkout -- .\n+git checkout \"$(rustc -V | cut -d' ' -f3 | tr -d '(')\"\n+\n+git apply - <<EOF\n+diff --git a/Cargo.toml b/Cargo.toml\n+index 5bd1147cad5..10d68a2ff14 100644\n+--- a/Cargo.toml\n++++ b/Cargo.toml\n+@@ -111,5 +111,7 @@ rustc-std-workspace-std = { path = 'library/rustc-std-workspace-std' }\n+ rustc-std-workspace-alloc = { path = 'library/rustc-std-workspace-alloc' }\n+ rustc-std-workspace-std = { path = 'library/rustc-std-workspace-std' }\n+\n++compiler_builtins = { path = \"../build_sysroot/compiler-builtins\" }\n++\n+ [patch.\"https://github.com/rust-lang/rust-clippy\"]\n+ clippy_lints = { path = \"src/tools/clippy/clippy_lints\" }\n+diff --git a/compiler/rustc_data_structures/Cargo.toml b/compiler/rustc_data_structures/Cargo.toml\n+index 23e689fcae7..5f077b765b6 100644\n+--- a/compiler/rustc_data_structures/Cargo.toml\n++++ b/compiler/rustc_data_structures/Cargo.toml\n+@@ -32,7 +32,6 @@ tempfile = \"3.0.5\"\n+\n+ [dependencies.parking_lot]\n+ version = \"0.11\"\n+-features = [\"nightly\"]\n+\n+ [target.'cfg(windows)'.dependencies]\n+ winapi = { version = \"0.3\", features = [\"fileapi\", \"psapi\"] }\n+diff --git a/library/alloc/Cargo.toml b/library/alloc/Cargo.toml\n+index d95b5b7f17f..00b6f0e3635 100644\n+--- a/library/alloc/Cargo.toml\n++++ b/library/alloc/Cargo.toml\n+@@ -8,7 +8,7 @@ edition = \"2018\"\n+\n+ [dependencies]\n+ core = { path = \"../core\" }\n+-compiler_builtins = { version = \"0.1.39\", features = ['rustc-dep-of-std'] }\n++compiler_builtins = { version = \"0.1.39\", features = ['rustc-dep-of-std', 'no-asm'] }\n+\n+ [dev-dependencies]\n+ rand = \"0.7\"\n+EOF\n+\n+cat > config.toml <<EOF\n+[llvm]\n+ninja = false\n+\n+[build]\n+rustc = \"$(pwd)/../build/bin/cg_clif\"\n+cargo = \"$(rustup which cargo)\"\n+full-bootstrap = true\n+local-rebuild = true\n+\n+[rust]\n+codegen-backends = [\"cranelift\"]\n+deny-warnings = false\n+EOF\n+popd"}, {"sha": "791d457993de3a3d42ad77c2e9a843ea719b4d39", "filename": "scripts/test_bootstrap.sh", "status": "modified", "additions": 1, "deletions": 61, "changes": 62, "blob_url": "https://github.com/rust-lang/rust/blob/f545a21fbe9f32b6f489b064488647997f3af70e/scripts%2Ftest_bootstrap.sh", "raw_url": "https://github.com/rust-lang/rust/raw/f545a21fbe9f32b6f489b064488647997f3af70e/scripts%2Ftest_bootstrap.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/scripts%2Ftest_bootstrap.sh?ref=f545a21fbe9f32b6f489b064488647997f3af70e", "patch": "@@ -3,70 +3,10 @@ set -e\n \n cd \"$(dirname \"$0\")/../\"\n \n-./build.sh\n-source build/config.sh\n+source ./scripts/setup_rust_fork.sh\n \n echo \"[TEST] Bootstrap of rustc\"\n-git clone https://github.com/rust-lang/rust.git || true\n pushd rust\n-git fetch\n-git checkout -- .\n-git checkout \"$(rustc -V | cut -d' ' -f3 | tr -d '(')\"\n-\n-git apply - <<EOF\n-diff --git a/Cargo.toml b/Cargo.toml\n-index 5bd1147cad5..10d68a2ff14 100644\n---- a/Cargo.toml\n-+++ b/Cargo.toml\n-@@ -111,5 +111,7 @@ rustc-std-workspace-std = { path = 'library/rustc-std-workspace-std' }\n- rustc-std-workspace-alloc = { path = 'library/rustc-std-workspace-alloc' }\n- rustc-std-workspace-std = { path = 'library/rustc-std-workspace-std' }\n- \n-+compiler_builtins = { path = \"../build_sysroot/compiler-builtins\" }\n-+\n- [patch.\"https://github.com/rust-lang/rust-clippy\"]\n- clippy_lints = { path = \"src/tools/clippy/clippy_lints\" }\n-diff --git a/compiler/rustc_data_structures/Cargo.toml b/compiler/rustc_data_structures/Cargo.toml\n-index 23e689fcae7..5f077b765b6 100644\n---- a/compiler/rustc_data_structures/Cargo.toml\n-+++ b/compiler/rustc_data_structures/Cargo.toml\n-@@ -32,7 +32,6 @@ tempfile = \"3.0.5\"\n-\n- [dependencies.parking_lot]\n- version = \"0.11\"\n--features = [\"nightly\"]\n-\n- [target.'cfg(windows)'.dependencies]\n- winapi = { version = \"0.3\", features = [\"fileapi\", \"psapi\"] }\n-diff --git a/library/alloc/Cargo.toml b/library/alloc/Cargo.toml\n-index d95b5b7f17f..00b6f0e3635 100644\n---- a/library/alloc/Cargo.toml\n-+++ b/library/alloc/Cargo.toml\n-@@ -8,7 +8,7 @@ edition = \"2018\"\n- \n- [dependencies]\n- core = { path = \"../core\" }\n--compiler_builtins = { version = \"0.1.39\", features = ['rustc-dep-of-std'] }\n-+compiler_builtins = { version = \"0.1.39\", features = ['rustc-dep-of-std', 'no-asm'] }\n- \n- [dev-dependencies]\n- rand = \"0.7\"\n-EOF\n-\n-cat > config.toml <<EOF\n-[llvm]\n-ninja = false\n-\n-[build]\n-rustc = \"$(pwd)/../build/bin/cg_clif\"\n-cargo = \"$(rustup which cargo)\"\n-full-bootstrap = true\n-local-rebuild = true\n-\n-[rust]\n-codegen-backends = [\"cranelift\"]\n-EOF\n-\n rm -r compiler/rustc_codegen_cranelift/{Cargo.*,src}\n cp ../Cargo.* compiler/rustc_codegen_cranelift/\n cp -r ../src compiler/rustc_codegen_cranelift/src"}]}