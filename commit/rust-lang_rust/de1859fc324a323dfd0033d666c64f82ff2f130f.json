{"sha": "de1859fc324a323dfd0033d666c64f82ff2f130f", "node_id": "C_kwDOAAsO6NoAKGRlMTg1OWZjMzI0YTMyM2RmZDAwMzNkNjY2YzY0ZjgyZmYyZjEzMGY", "commit": {"author": {"name": "Camille GILLOT", "email": "gillot.camille@gmail.com", "date": "2023-01-05T17:57:55Z"}, "committer": {"name": "Camille GILLOT", "email": "gillot.camille@gmail.com", "date": "2023-01-05T18:00:45Z"}, "message": "Correct detection of elided lifetimes in impl-trait.", "tree": {"sha": "240a5bfa6837d95d8aae71944d58bc1dd2999c03", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/240a5bfa6837d95d8aae71944d58bc1dd2999c03"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/de1859fc324a323dfd0033d666c64f82ff2f130f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/de1859fc324a323dfd0033d666c64f82ff2f130f", "html_url": "https://github.com/rust-lang/rust/commit/de1859fc324a323dfd0033d666c64f82ff2f130f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/de1859fc324a323dfd0033d666c64f82ff2f130f/comments", "author": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "committer": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1d284af117716473e1a35cc0d91c170e44e3fc6e", "url": "https://api.github.com/repos/rust-lang/rust/commits/1d284af117716473e1a35cc0d91c170e44e3fc6e", "html_url": "https://github.com/rust-lang/rust/commit/1d284af117716473e1a35cc0d91c170e44e3fc6e"}], "stats": {"total": 11, "additions": 9, "deletions": 2}, "files": [{"sha": "35f10dc873745f59d4355f1ebe675890f468f0b7", "filename": "compiler/rustc_hir_analysis/src/collect/lifetimes.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/de1859fc324a323dfd0033d666c64f82ff2f130f/compiler%2Frustc_hir_analysis%2Fsrc%2Fcollect%2Flifetimes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/de1859fc324a323dfd0033d666c64f82ff2f130f/compiler%2Frustc_hir_analysis%2Fsrc%2Fcollect%2Flifetimes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_analysis%2Fsrc%2Fcollect%2Flifetimes.rs?ref=de1859fc324a323dfd0033d666c64f82ff2f130f", "patch": "@@ -1195,8 +1195,10 @@ impl<'a, 'tcx> LifetimeContext<'a, 'tcx> {\n                     // Fresh lifetimes in APIT used to be allowed in async fns and forbidden in\n                     // regular fns.\n                     if let Some(hir::PredicateOrigin::ImplTrait) = where_bound_origin\n-                        && let hir::LifetimeName::Param(_) = lifetime_ref.res\n-                        && lifetime_ref.is_anonymous()\n+                        && let hir::LifetimeName::Param(param_id) = lifetime_ref.res\n+                        && let Some(generics) = self.tcx.hir().get_generics(self.tcx.local_parent(param_id))\n+                        && let Some(param) = generics.params.iter().find(|p| p.def_id == param_id)\n+                        && param.is_elided_lifetime()\n                         && let hir::IsAsync::NotAsync = self.tcx.asyncness(lifetime_ref.hir_id.owner.def_id)\n                         && !self.tcx.features().anonymous_lifetime_in_impl_trait\n                     {"}, {"sha": "a1a51c4814e8fc980918e2c5735859d52f39d0a8", "filename": "src/test/ui/suggestions/impl-trait-missing-lifetime-gated.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/de1859fc324a323dfd0033d666c64f82ff2f130f/src%2Ftest%2Fui%2Fsuggestions%2Fimpl-trait-missing-lifetime-gated.rs", "raw_url": "https://github.com/rust-lang/rust/raw/de1859fc324a323dfd0033d666c64f82ff2f130f/src%2Ftest%2Fui%2Fsuggestions%2Fimpl-trait-missing-lifetime-gated.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsuggestions%2Fimpl-trait-missing-lifetime-gated.rs?ref=de1859fc324a323dfd0033d666c64f82ff2f130f", "patch": "@@ -60,4 +60,9 @@ mod in_path {\n     //~| ERROR missing lifetime specifier\n }\n \n+// This must not err, as the `&` actually resolves to `'a`.\n+fn resolved_anonymous<'a, T>(f: impl Fn(&'a str) -> &T) {\n+    f(\"f\")\n+}\n+\n fn main() {}"}]}