{"sha": "75c2acae6ec6b87db5a27d5235ca92ee8d529e08", "node_id": "C_kwDOAAsO6NoAKDc1YzJhY2FlNmVjNmI4N2RiNWEyN2Q1MjM1Y2E5MmVlOGQ1MjllMDg", "commit": {"author": {"name": "hkalbasi", "email": "hamidrezakalbasi@protonmail.com", "date": "2021-12-23T17:49:18Z"}, "committer": {"name": "hkalbasi", "email": "hamidrezakalbasi@protonmail.com", "date": "2022-01-04T21:47:01Z"}, "message": "Evaluate constants in array repeat expression", "tree": {"sha": "8c90ed1449b43af065fefe4e181524bf400e7397", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8c90ed1449b43af065fefe4e181524bf400e7397"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/75c2acae6ec6b87db5a27d5235ca92ee8d529e08", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/75c2acae6ec6b87db5a27d5235ca92ee8d529e08", "html_url": "https://github.com/rust-lang/rust/commit/75c2acae6ec6b87db5a27d5235ca92ee8d529e08", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/75c2acae6ec6b87db5a27d5235ca92ee8d529e08/comments", "author": {"login": "HKalbasi", "id": 45197576, "node_id": "MDQ6VXNlcjQ1MTk3NTc2", "avatar_url": "https://avatars.githubusercontent.com/u/45197576?v=4", "gravatar_id": "", "url": "https://api.github.com/users/HKalbasi", "html_url": "https://github.com/HKalbasi", "followers_url": "https://api.github.com/users/HKalbasi/followers", "following_url": "https://api.github.com/users/HKalbasi/following{/other_user}", "gists_url": "https://api.github.com/users/HKalbasi/gists{/gist_id}", "starred_url": "https://api.github.com/users/HKalbasi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/HKalbasi/subscriptions", "organizations_url": "https://api.github.com/users/HKalbasi/orgs", "repos_url": "https://api.github.com/users/HKalbasi/repos", "events_url": "https://api.github.com/users/HKalbasi/events{/privacy}", "received_events_url": "https://api.github.com/users/HKalbasi/received_events", "type": "User", "site_admin": false}, "committer": {"login": "HKalbasi", "id": 45197576, "node_id": "MDQ6VXNlcjQ1MTk3NTc2", "avatar_url": "https://avatars.githubusercontent.com/u/45197576?v=4", "gravatar_id": "", "url": "https://api.github.com/users/HKalbasi", "html_url": "https://github.com/HKalbasi", "followers_url": "https://api.github.com/users/HKalbasi/followers", "following_url": "https://api.github.com/users/HKalbasi/following{/other_user}", "gists_url": "https://api.github.com/users/HKalbasi/gists{/gist_id}", "starred_url": "https://api.github.com/users/HKalbasi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/HKalbasi/subscriptions", "organizations_url": "https://api.github.com/users/HKalbasi/orgs", "repos_url": "https://api.github.com/users/HKalbasi/repos", "events_url": "https://api.github.com/users/HKalbasi/events{/privacy}", "received_events_url": "https://api.github.com/users/HKalbasi/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7b7a1ed062edd438caa824b6a71aaaa56b48e7d4", "url": "https://api.github.com/repos/rust-lang/rust/commits/7b7a1ed062edd438caa824b6a71aaaa56b48e7d4", "html_url": "https://github.com/rust-lang/rust/commit/7b7a1ed062edd438caa824b6a71aaaa56b48e7d4"}], "stats": {"total": 121, "additions": 94, "deletions": 27}, "files": [{"sha": "9a1a893650cd64befee3e39009619b38916dae3f", "filename": "crates/hir/src/lib.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/75c2acae6ec6b87db5a27d5235ca92ee8d529e08/crates%2Fhir%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/75c2acae6ec6b87db5a27d5235ca92ee8d529e08/crates%2Fhir%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir%2Fsrc%2Flib.rs?ref=75c2acae6ec6b87db5a27d5235ca92ee8d529e08", "patch": "@@ -1540,11 +1540,11 @@ impl Const {\n         let infer = infer.as_ref();\n         let result = eval_const(\n             root,\n-            ConstEvalCtx {\n+            &mut ConstEvalCtx {\n                 exprs: &body.exprs,\n                 pats: &body.pats,\n                 local_data: HashMap::default(),\n-                infer,\n+                infer: &mut |x| infer[x].clone(),\n             },\n         );\n         result"}, {"sha": "68e6e0582e3700344d2c8f91805aa3584dd60618", "filename": "crates/hir_ty/src/consteval.rs", "status": "modified", "additions": 37, "deletions": 22, "changes": 59, "blob_url": "https://github.com/rust-lang/rust/blob/75c2acae6ec6b87db5a27d5235ca92ee8d529e08/crates%2Fhir_ty%2Fsrc%2Fconsteval.rs", "raw_url": "https://github.com/rust-lang/rust/raw/75c2acae6ec6b87db5a27d5235ca92ee8d529e08/crates%2Fhir_ty%2Fsrc%2Fconsteval.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Fconsteval.rs?ref=75c2acae6ec6b87db5a27d5235ca92ee8d529e08", "patch": "@@ -4,14 +4,13 @@ use std::{collections::HashMap, convert::TryInto, fmt::Display};\n \n use chalk_ir::{IntTy, Scalar};\n use hir_def::{\n-    builtin_type::BuiltinUint,\n     expr::{ArithOp, BinaryOp, Expr, Literal, Pat},\n     type_ref::ConstScalar,\n };\n use hir_expand::name::Name;\n-use la_arena::Arena;\n+use la_arena::{Arena, Idx};\n \n-use crate::{Const, ConstData, ConstValue, InferenceResult, Interner, TyKind};\n+use crate::{Const, ConstData, ConstValue, Interner, Ty, TyKind};\n \n /// Extension trait for [`Const`]\n pub trait ConstExt {\n@@ -41,12 +40,11 @@ impl ConstExt for Const {\n     }\n }\n \n-#[derive(Clone)]\n pub struct ConstEvalCtx<'a> {\n     pub exprs: &'a Arena<Expr>,\n     pub pats: &'a Arena<Pat>,\n     pub local_data: HashMap<Name, ComputedExpr>,\n-    pub infer: &'a InferenceResult,\n+    pub infer: &'a mut dyn FnMut(Idx<Expr>) -> Ty,\n }\n \n #[derive(Debug, Clone)]\n@@ -57,7 +55,7 @@ pub enum ConstEvalError {\n     Panic(String),\n }\n \n-#[derive(Clone)]\n+#[derive(Debug, Clone)]\n pub enum ComputedExpr {\n     Literal(Literal),\n     Tuple(Box<[ComputedExpr]>),\n@@ -130,11 +128,11 @@ fn is_valid(scalar: &Scalar, value: i128) -> bool {\n     }\n }\n \n-pub fn eval_const(expr: &Expr, mut ctx: ConstEvalCtx<'_>) -> Result<ComputedExpr, ConstEvalError> {\n+pub fn eval_const(expr: &Expr, ctx: &mut ConstEvalCtx<'_>) -> Result<ComputedExpr, ConstEvalError> {\n     match expr {\n         Expr::Literal(l) => Ok(ComputedExpr::Literal(l.clone())),\n         &Expr::UnaryOp { expr, op } => {\n-            let ty = &ctx.infer[expr];\n+            let ty = &(ctx.infer)(expr);\n             let ev = eval_const(&ctx.exprs[expr], ctx)?;\n             match op {\n                 hir_def::expr::UnaryOp::Deref => Err(ConstEvalError::NotSupported(\"deref\")),\n@@ -190,9 +188,9 @@ pub fn eval_const(expr: &Expr, mut ctx: ConstEvalCtx<'_>) -> Result<ComputedExpr\n             }\n         }\n         &Expr::BinaryOp { lhs, rhs, op } => {\n-            let ty = &ctx.infer[lhs];\n-            let lhs = eval_const(&ctx.exprs[lhs], ctx.clone())?;\n-            let rhs = eval_const(&ctx.exprs[rhs], ctx.clone())?;\n+            let ty = &(ctx.infer)(lhs);\n+            let lhs = eval_const(&ctx.exprs[lhs], ctx)?;\n+            let rhs = eval_const(&ctx.exprs[rhs], ctx)?;\n             let op = op.ok_or(ConstEvalError::IncompleteExpr)?;\n             let v1 = match lhs {\n                 ComputedExpr::Literal(Literal::Int(v, _)) => v,\n@@ -241,6 +239,7 @@ pub fn eval_const(expr: &Expr, mut ctx: ConstEvalCtx<'_>) -> Result<ComputedExpr\n             }\n         }\n         Expr::Block { statements, tail, .. } => {\n+            let mut prev_values = HashMap::<Name, Option<ComputedExpr>>::default();\n             for statement in &**statements {\n                 match statement {\n                     &hir_def::expr::Statement::Let { pat, initializer, .. } => {\n@@ -252,21 +251,33 @@ pub fn eval_const(expr: &Expr, mut ctx: ConstEvalCtx<'_>) -> Result<ComputedExpr\n                             }\n                         };\n                         let value = match initializer {\n-                            Some(x) => eval_const(&ctx.exprs[x], ctx.clone())?,\n+                            Some(x) => eval_const(&ctx.exprs[x], ctx)?,\n                             None => continue,\n                         };\n-                        ctx.local_data.insert(name, value);\n+                        if !prev_values.contains_key(&name) {\n+                            let prev = ctx.local_data.insert(name.clone(), value);\n+                            prev_values.insert(name, prev);\n+                        } else {\n+                            ctx.local_data.insert(name, value);\n+                        }\n                     }\n                     &hir_def::expr::Statement::Expr { .. } => {\n                         return Err(ConstEvalError::NotSupported(\"this kind of statement\"))\n                     }\n                 }\n             }\n-            let tail_expr = match tail {\n-                &Some(x) => &ctx.exprs[x],\n-                None => return Ok(ComputedExpr::Tuple(Box::new([]))),\n+            let r = match tail {\n+                &Some(x) => eval_const(&ctx.exprs[x], ctx),\n+                None => Ok(ComputedExpr::Tuple(Box::new([]))),\n             };\n-            eval_const(tail_expr, ctx)\n+            // clean up local data, so caller will receive the exact map that passed to us\n+            for (name, val) in prev_values {\n+                match val {\n+                    Some(x) => ctx.local_data.insert(name, x),\n+                    None => ctx.local_data.remove(&name),\n+                };\n+            }\n+            r\n         }\n         Expr::Path(p) => {\n             let name = p.mod_path().as_ident().ok_or(ConstEvalError::NotSupported(\"big paths\"))?;\n@@ -280,12 +291,16 @@ pub fn eval_const(expr: &Expr, mut ctx: ConstEvalCtx<'_>) -> Result<ComputedExpr\n     }\n }\n \n-// FIXME: support more than just evaluating literals\n-pub fn eval_usize(expr: &Expr) -> Option<u64> {\n-    match expr {\n-        Expr::Literal(Literal::Uint(v, None | Some(BuiltinUint::Usize))) => (*v).try_into().ok(),\n-        _ => None,\n+pub fn eval_usize(expr: Idx<Expr>, mut ctx: ConstEvalCtx<'_>) -> Option<u64> {\n+    let expr = &ctx.exprs[expr];\n+    if let Ok(ce) = eval_const(&expr, &mut ctx) {\n+        match ce {\n+            ComputedExpr::Literal(Literal::Int(x, _)) => return x.try_into().ok(),\n+            ComputedExpr::Literal(Literal::Uint(x, _)) => return x.try_into().ok(),\n+            _ => {}\n+        }\n     }\n+    None\n }\n \n /// Interns a possibly-unknown target usize"}, {"sha": "54b1680214e9faeb8fc2ed989c29139d533492e2", "filename": "crates/hir_ty/src/infer/expr.rs", "status": "modified", "additions": 9, "deletions": 2, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/75c2acae6ec6b87db5a27d5235ca92ee8d529e08/crates%2Fhir_ty%2Fsrc%2Finfer%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/75c2acae6ec6b87db5a27d5235ca92ee8d529e08/crates%2Fhir_ty%2Fsrc%2Finfer%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Finfer%2Fexpr.rs?ref=75c2acae6ec6b87db5a27d5235ca92ee8d529e08", "patch": "@@ -799,8 +799,15 @@ impl<'a> InferenceContext<'a> {\n                             ),\n                         );\n \n-                        let repeat_expr = &self.body.exprs[repeat];\n-                        consteval::eval_usize(repeat_expr)\n+                        consteval::eval_usize(\n+                            repeat,\n+                            consteval::ConstEvalCtx {\n+                                exprs: &body.exprs,\n+                                pats: &body.pats,\n+                                local_data: Default::default(),\n+                                infer: &mut |x| self.infer_expr(x, &expected),\n+                            },\n+                        )\n                     }\n                 };\n "}, {"sha": "21ff4f2a60fe1c8425da9a87e35fab010c381706", "filename": "crates/ide/src/hover/tests.rs", "status": "modified", "additions": 43, "deletions": 0, "changes": 43, "blob_url": "https://github.com/rust-lang/rust/blob/75c2acae6ec6b87db5a27d5235ca92ee8d529e08/crates%2Fide%2Fsrc%2Fhover%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/75c2acae6ec6b87db5a27d5235ca92ee8d529e08/crates%2Fide%2Fsrc%2Fhover%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fhover%2Ftests.rs?ref=75c2acae6ec6b87db5a27d5235ca92ee8d529e08", "patch": "@@ -3350,6 +3350,31 @@ const FOO$0: usize = 1 << 10;\n     check(\n         r#\"\n /// This is a doc\n+const FOO$0: usize = {\n+    let b = 4;\n+    let a = { let b = 2; let a = b; a } + { let a = 1; a + b };\n+    a\n+};\n+\"#,\n+        expect![[r#\"\n+            *FOO*\n+\n+            ```rust\n+            test\n+            ```\n+\n+            ```rust\n+            const FOO: usize = 7\n+            ```\n+\n+            ---\n+\n+            This is a doc\n+        \"#]],\n+    );\n+    check(\n+        r#\"\n+/// This is a doc\n const FOO$0: usize = 2 - 3;\n \"#,\n         expect![[r#\"\n@@ -3443,6 +3468,24 @@ fn foo() {\n     );\n }\n \n+#[test]\n+fn array_repeat_exp() {\n+    check(\n+        r#\"\n+fn main() {\n+    let til$0e4 = [0_u32; (4 * 8 * 8) / 32];\n+}\n+        \"#,\n+        expect![[r#\"\n+            *tile4*\n+\n+            ```rust\n+            let tile4: [u32; 8]\n+            ```\n+            \"#]],\n+    );\n+}\n+\n #[test]\n fn hover_mod_def() {\n     check("}, {"sha": "52be0ff958aeb7b406c603bcfe11eda783f8cd17", "filename": "crates/ide_assists/src/handlers/add_explicit_type.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/75c2acae6ec6b87db5a27d5235ca92ee8d529e08/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fadd_explicit_type.rs", "raw_url": "https://github.com/rust-lang/rust/raw/75c2acae6ec6b87db5a27d5235ca92ee8d529e08/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fadd_explicit_type.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fadd_explicit_type.rs?ref=75c2acae6ec6b87db5a27d5235ca92ee8d529e08", "patch": "@@ -185,8 +185,10 @@ fn main() {\n         check_assist_not_applicable(\n             add_explicit_type,\n             r#\"\n+//- minicore: option\n+\n fn main() {\n-    let $0l = [0.0; 2+2];\n+    let $0l = [0.0; Some(2).unwrap()];\n }\n \"#,\n         );"}]}