{"sha": "a3711e08dc4e393957dff136218c47d8b77da14f", "node_id": "MDY6Q29tbWl0NzI0NzEyOmEzNzExZTA4ZGM0ZTM5Mzk1N2RmZjEzNjIxOGM0N2Q4Yjc3ZGExNGY=", "commit": {"author": {"name": "Wilco Kusee", "email": "wilcokusee@gmail.com", "date": "2019-03-23T16:34:49Z"}, "committer": {"name": "Wilco Kusee", "email": "wilcokusee@gmail.com", "date": "2019-03-23T16:34:49Z"}, "message": "Move highlighting and matching_brace", "tree": {"sha": "862ad28652de70aac75cf6e619850ae013500694", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/862ad28652de70aac75cf6e619850ae013500694"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a3711e08dc4e393957dff136218c47d8b77da14f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a3711e08dc4e393957dff136218c47d8b77da14f", "html_url": "https://github.com/rust-lang/rust/commit/a3711e08dc4e393957dff136218c47d8b77da14f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a3711e08dc4e393957dff136218c47d8b77da14f/comments", "author": {"login": "detrumi", "id": 5758008, "node_id": "MDQ6VXNlcjU3NTgwMDg=", "avatar_url": "https://avatars.githubusercontent.com/u/5758008?v=4", "gravatar_id": "", "url": "https://api.github.com/users/detrumi", "html_url": "https://github.com/detrumi", "followers_url": "https://api.github.com/users/detrumi/followers", "following_url": "https://api.github.com/users/detrumi/following{/other_user}", "gists_url": "https://api.github.com/users/detrumi/gists{/gist_id}", "starred_url": "https://api.github.com/users/detrumi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/detrumi/subscriptions", "organizations_url": "https://api.github.com/users/detrumi/orgs", "repos_url": "https://api.github.com/users/detrumi/repos", "events_url": "https://api.github.com/users/detrumi/events{/privacy}", "received_events_url": "https://api.github.com/users/detrumi/received_events", "type": "User", "site_admin": false}, "committer": {"login": "detrumi", "id": 5758008, "node_id": "MDQ6VXNlcjU3NTgwMDg=", "avatar_url": "https://avatars.githubusercontent.com/u/5758008?v=4", "gravatar_id": "", "url": "https://api.github.com/users/detrumi", "html_url": "https://github.com/detrumi", "followers_url": "https://api.github.com/users/detrumi/followers", "following_url": "https://api.github.com/users/detrumi/following{/other_user}", "gists_url": "https://api.github.com/users/detrumi/gists{/gist_id}", "starred_url": "https://api.github.com/users/detrumi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/detrumi/subscriptions", "organizations_url": "https://api.github.com/users/detrumi/orgs", "repos_url": "https://api.github.com/users/detrumi/repos", "events_url": "https://api.github.com/users/detrumi/events{/privacy}", "received_events_url": "https://api.github.com/users/detrumi/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a656b891fba4b89775adbc93114a20c99afe5f36", "url": "https://api.github.com/repos/rust-lang/rust/commits/a656b891fba4b89775adbc93114a20c99afe5f36", "html_url": "https://github.com/rust-lang/rust/commit/a656b891fba4b89775adbc93114a20c99afe5f36"}], "stats": {"total": 330, "additions": 166, "deletions": 164}, "files": [{"sha": "aabb614b9e8a6b684aa88e7fb991e8a8f04ca88c", "filename": "crates/ra_ide_api/src/diagnostics.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/a3711e08dc4e393957dff136218c47d8b77da14f/crates%2Fra_ide_api%2Fsrc%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a3711e08dc4e393957dff136218c47d8b77da14f/crates%2Fra_ide_api%2Fsrc%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2Fsrc%2Fdiagnostics.rs?ref=a3711e08dc4e393957dff136218c47d8b77da14f", "patch": "@@ -1,6 +1,5 @@\n use itertools::Itertools;\n use hir::{Problem, source_binder};\n-use ra_ide_api_light::Severity;\n use ra_db::SourceDatabase;\n use ra_syntax::{\n     Location, SourceFile, SyntaxKind, TextRange, SyntaxNode,\n@@ -11,6 +10,12 @@ use ra_text_edit::{TextEdit, TextEditBuilder};\n \n use crate::{Diagnostic, FileId, FileSystemEdit, SourceChange, SourceFileEdit, db::RootDatabase};\n \n+#[derive(Debug, Copy, Clone)]\n+pub enum Severity {\n+    Error,\n+    WeakWarning,\n+}\n+\n pub(crate) fn diagnostics(db: &RootDatabase, file_id: FileId) -> Vec<Diagnostic> {\n     let source_file = db.parse(file_id);\n     let mut res = Vec::new();"}, {"sha": "99f18b6b8c343e9640554fa9507ef62b9aecb334", "filename": "crates/ra_ide_api/src/lib.rs", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/a3711e08dc4e393957dff136218c47d8b77da14f/crates%2Fra_ide_api%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a3711e08dc4e393957dff136218c47d8b77da14f/crates%2Fra_ide_api%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2Fsrc%2Flib.rs?ref=a3711e08dc4e393957dff136218c47d8b77da14f", "patch": "@@ -38,6 +38,7 @@ mod folding_ranges;\n mod line_index_utils;\n mod join_lines;\n mod typing;\n+mod matching_brace;\n \n #[cfg(test)]\n mod marks;\n@@ -70,10 +71,10 @@ pub use crate::{\n     line_index::{LineIndex, LineCol},\n     line_index_utils::translate_offset_with_edit,\n     folding_ranges::{Fold, FoldKind},\n+    syntax_highlighting::HighlightedRange,\n+    diagnostics::Severity,\n };\n-pub use ra_ide_api_light::{\n-    HighlightedRange, Severity, StructureNode,\n-};\n+pub use ra_ide_api_light::StructureNode;\n pub use ra_db::{\n     Canceled, CrateGraph, CrateId, FileId, FilePosition, FileRange, SourceRootId,\n     Edition\n@@ -267,7 +268,7 @@ impl Analysis {\n     /// supported).\n     pub fn matching_brace(&self, position: FilePosition) -> Option<TextUnit> {\n         let file = self.db.parse(position.file_id);\n-        ra_ide_api_light::matching_brace(&file, position.offset)\n+        matching_brace::matching_brace(&file, position.offset)\n     }\n \n     /// Returns a syntax tree represented as `String`, for debug purposes."}, {"sha": "d1405f14fcd90fcc813777d339ca242779cfb510", "filename": "crates/ra_ide_api/src/matching_brace.rs", "status": "added", "additions": 45, "deletions": 0, "changes": 45, "blob_url": "https://github.com/rust-lang/rust/blob/a3711e08dc4e393957dff136218c47d8b77da14f/crates%2Fra_ide_api%2Fsrc%2Fmatching_brace.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a3711e08dc4e393957dff136218c47d8b77da14f/crates%2Fra_ide_api%2Fsrc%2Fmatching_brace.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2Fsrc%2Fmatching_brace.rs?ref=a3711e08dc4e393957dff136218c47d8b77da14f", "patch": "@@ -0,0 +1,45 @@\n+use ra_syntax::{\n+    SourceFile, TextUnit,\n+    algo::find_leaf_at_offset,\n+    SyntaxKind::{self, *},\n+    ast::AstNode,\n+};\n+\n+pub fn matching_brace(file: &SourceFile, offset: TextUnit) -> Option<TextUnit> {\n+    const BRACES: &[SyntaxKind] =\n+        &[L_CURLY, R_CURLY, L_BRACK, R_BRACK, L_PAREN, R_PAREN, L_ANGLE, R_ANGLE];\n+    let (brace_node, brace_idx) = find_leaf_at_offset(file.syntax(), offset)\n+        .filter_map(|node| {\n+            let idx = BRACES.iter().position(|&brace| brace == node.kind())?;\n+            Some((node, idx))\n+        })\n+        .next()?;\n+    let parent = brace_node.parent()?;\n+    let matching_kind = BRACES[brace_idx ^ 1];\n+    let matching_node = parent.children().find(|node| node.kind() == matching_kind)?;\n+    Some(matching_node.range().start())\n+}\n+\n+#[cfg(test)]\n+mod tests {\n+    use test_utils::{add_cursor, assert_eq_text, extract_offset};\n+\n+    use super::*;\n+\n+    #[test]\n+    fn test_matching_brace() {\n+        fn do_check(before: &str, after: &str) {\n+            let (pos, before) = extract_offset(before);\n+            let file = SourceFile::parse(&before);\n+            let new_pos = match matching_brace(&file, pos) {\n+                None => pos,\n+                Some(pos) => pos,\n+            };\n+            let actual = add_cursor(&before, new_pos);\n+            assert_eq_text!(after, &actual);\n+        }\n+\n+        do_check(\"struct Foo { a: i32, }<|>\", \"struct Foo <|>{ a: i32, }\");\n+    }\n+\n+}"}, {"sha": "72029e0ed27bb526b4ea5736c1a9596b21c26345", "filename": "crates/ra_ide_api/src/snapshots/tests__highlighting.snap", "status": "added", "additions": 34, "deletions": 0, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/a3711e08dc4e393957dff136218c47d8b77da14f/crates%2Fra_ide_api%2Fsrc%2Fsnapshots%2Ftests__highlighting.snap", "raw_url": "https://github.com/rust-lang/rust/raw/a3711e08dc4e393957dff136218c47d8b77da14f/crates%2Fra_ide_api%2Fsrc%2Fsnapshots%2Ftests__highlighting.snap", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2Fsrc%2Fsnapshots%2Ftests__highlighting.snap?ref=a3711e08dc4e393957dff136218c47d8b77da14f", "patch": "@@ -0,0 +1,34 @@\n+---\n+created: \"2019-03-23T16:20:31.394314144Z\"\n+creator: insta@0.7.1\n+source: crates/ra_ide_api/src/syntax_highlighting.rs\n+expression: result\n+---\n+Ok(\n+    [\n+        HighlightedRange {\n+            range: [1; 11),\n+            tag: \"comment\"\n+        },\n+        HighlightedRange {\n+            range: [12; 14),\n+            tag: \"keyword\"\n+        },\n+        HighlightedRange {\n+            range: [15; 19),\n+            tag: \"function\"\n+        },\n+        HighlightedRange {\n+            range: [29; 37),\n+            tag: \"macro\"\n+        },\n+        HighlightedRange {\n+            range: [38; 50),\n+            tag: \"string\"\n+        },\n+        HighlightedRange {\n+            range: [52; 54),\n+            tag: \"literal\"\n+        }\n+    ]\n+)"}, {"sha": "a0c5e78ad79d18515faf8e0b093a5113c80626e2", "filename": "crates/ra_ide_api/src/syntax_highlighting.rs", "status": "modified", "additions": 75, "deletions": 6, "changes": 81, "blob_url": "https://github.com/rust-lang/rust/blob/a3711e08dc4e393957dff136218c47d8b77da14f/crates%2Fra_ide_api%2Fsrc%2Fsyntax_highlighting.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a3711e08dc4e393957dff136218c47d8b77da14f/crates%2Fra_ide_api%2Fsrc%2Fsyntax_highlighting.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2Fsrc%2Fsyntax_highlighting.rs?ref=a3711e08dc4e393957dff136218c47d8b77da14f", "patch": "@@ -1,12 +1,81 @@\n-use ra_syntax::AstNode;\n+use rustc_hash::FxHashSet;\n+\n+use ra_syntax::{ast, AstNode, TextRange, Direction, SyntaxKind::*};\n use ra_db::SourceDatabase;\n \n-use crate::{\n-    FileId, HighlightedRange,\n-    db::RootDatabase,\n-};\n+use crate::{FileId, db::RootDatabase};\n+\n+#[derive(Debug)]\n+pub struct HighlightedRange {\n+    pub range: TextRange,\n+    pub tag: &'static str,\n+}\n \n pub(crate) fn highlight(db: &RootDatabase, file_id: FileId) -> Vec<HighlightedRange> {\n     let source_file = db.parse(file_id);\n-    ra_ide_api_light::highlight(source_file.syntax())\n+\n+    // Visited nodes to handle highlighting priorities\n+    let mut highlighted = FxHashSet::default();\n+    let mut res = Vec::new();\n+    for node in source_file.syntax().descendants() {\n+        if highlighted.contains(&node) {\n+            continue;\n+        }\n+        let tag = match node.kind() {\n+            COMMENT => \"comment\",\n+            STRING | RAW_STRING | RAW_BYTE_STRING | BYTE_STRING => \"string\",\n+            ATTR => \"attribute\",\n+            NAME_REF => \"text\",\n+            NAME => \"function\",\n+            INT_NUMBER | FLOAT_NUMBER | CHAR | BYTE => \"literal\",\n+            LIFETIME => \"parameter\",\n+            k if k.is_keyword() => \"keyword\",\n+            _ => {\n+                if let Some(macro_call) = ast::MacroCall::cast(node) {\n+                    if let Some(path) = macro_call.path() {\n+                        if let Some(segment) = path.segment() {\n+                            if let Some(name_ref) = segment.name_ref() {\n+                                highlighted.insert(name_ref.syntax());\n+                                let range_start = name_ref.syntax().range().start();\n+                                let mut range_end = name_ref.syntax().range().end();\n+                                for sibling in path.syntax().siblings(Direction::Next) {\n+                                    match sibling.kind() {\n+                                        EXCL | IDENT => range_end = sibling.range().end(),\n+                                        _ => (),\n+                                    }\n+                                }\n+                                res.push(HighlightedRange {\n+                                    range: TextRange::from_to(range_start, range_end),\n+                                    tag: \"macro\",\n+                                })\n+                            }\n+                        }\n+                    }\n+                }\n+                continue;\n+            }\n+        };\n+        res.push(HighlightedRange { range: node.range(), tag })\n+    }\n+    res\n+}\n+\n+#[cfg(test)]\n+mod tests {\n+    use insta::assert_debug_snapshot_matches;\n+\n+    use crate::mock_analysis::single_file;\n+\n+    #[test]\n+    fn test_highlighting() {\n+        let (analysis, file_id) = single_file(\n+            r#\"\n+// comment\n+fn main() {}\n+    println!(\"Hello, {}!\", 92);\n+\"#,\n+        );\n+        let result = analysis.highlight(file_id);\n+        assert_debug_snapshot_matches!(\"highlighting\", result);\n+    }\n }"}, {"sha": "df7f144b627c5121bb3cd7a41b881e4bca7f8268", "filename": "crates/ra_ide_api_light/src/lib.rs", "status": "modified", "additions": 1, "deletions": 121, "changes": 122, "blob_url": "https://github.com/rust-lang/rust/blob/a3711e08dc4e393957dff136218c47d8b77da14f/crates%2Fra_ide_api_light%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a3711e08dc4e393957dff136218c47d8b77da14f/crates%2Fra_ide_api_light%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api_light%2Fsrc%2Flib.rs?ref=a3711e08dc4e393957dff136218c47d8b77da14f", "patch": "@@ -5,128 +5,8 @@\n \n mod structure;\n \n-use rustc_hash::FxHashSet;\n-use ra_syntax::{\n-    SourceFile, SyntaxNode, TextRange, TextUnit, Direction,\n-    algo::find_leaf_at_offset,\n-    SyntaxKind::{self, *},\n-    ast::{self, AstNode},\n-};\n+use ra_syntax::TextRange;\n \n pub use crate::{\n     structure::{file_structure, StructureNode},\n };\n-\n-#[derive(Debug)]\n-pub struct HighlightedRange {\n-    pub range: TextRange,\n-    pub tag: &'static str,\n-}\n-\n-#[derive(Debug, Copy, Clone)]\n-pub enum Severity {\n-    Error,\n-    WeakWarning,\n-}\n-\n-pub fn matching_brace(file: &SourceFile, offset: TextUnit) -> Option<TextUnit> {\n-    const BRACES: &[SyntaxKind] =\n-        &[L_CURLY, R_CURLY, L_BRACK, R_BRACK, L_PAREN, R_PAREN, L_ANGLE, R_ANGLE];\n-    let (brace_node, brace_idx) = find_leaf_at_offset(file.syntax(), offset)\n-        .filter_map(|node| {\n-            let idx = BRACES.iter().position(|&brace| brace == node.kind())?;\n-            Some((node, idx))\n-        })\n-        .next()?;\n-    let parent = brace_node.parent()?;\n-    let matching_kind = BRACES[brace_idx ^ 1];\n-    let matching_node = parent.children().find(|node| node.kind() == matching_kind)?;\n-    Some(matching_node.range().start())\n-}\n-\n-pub fn highlight(root: &SyntaxNode) -> Vec<HighlightedRange> {\n-    // Visited nodes to handle highlighting priorities\n-    let mut highlighted = FxHashSet::default();\n-    let mut res = Vec::new();\n-    for node in root.descendants() {\n-        if highlighted.contains(&node) {\n-            continue;\n-        }\n-        let tag = match node.kind() {\n-            COMMENT => \"comment\",\n-            STRING | RAW_STRING | RAW_BYTE_STRING | BYTE_STRING => \"string\",\n-            ATTR => \"attribute\",\n-            NAME_REF => \"text\",\n-            NAME => \"function\",\n-            INT_NUMBER | FLOAT_NUMBER | CHAR | BYTE => \"literal\",\n-            LIFETIME => \"parameter\",\n-            k if k.is_keyword() => \"keyword\",\n-            _ => {\n-                if let Some(macro_call) = ast::MacroCall::cast(node) {\n-                    if let Some(path) = macro_call.path() {\n-                        if let Some(segment) = path.segment() {\n-                            if let Some(name_ref) = segment.name_ref() {\n-                                highlighted.insert(name_ref.syntax());\n-                                let range_start = name_ref.syntax().range().start();\n-                                let mut range_end = name_ref.syntax().range().end();\n-                                for sibling in path.syntax().siblings(Direction::Next) {\n-                                    match sibling.kind() {\n-                                        EXCL | IDENT => range_end = sibling.range().end(),\n-                                        _ => (),\n-                                    }\n-                                }\n-                                res.push(HighlightedRange {\n-                                    range: TextRange::from_to(range_start, range_end),\n-                                    tag: \"macro\",\n-                                })\n-                            }\n-                        }\n-                    }\n-                }\n-                continue;\n-            }\n-        };\n-        res.push(HighlightedRange { range: node.range(), tag })\n-    }\n-    res\n-}\n-\n-#[cfg(test)]\n-mod tests {\n-    use ra_syntax::AstNode;\n-    use insta::assert_debug_snapshot_matches;\n-\n-    use test_utils::{add_cursor, assert_eq_text, extract_offset};\n-\n-    use super::*;\n-\n-    #[test]\n-    fn test_highlighting() {\n-        let file = SourceFile::parse(\n-            r#\"\n-// comment\n-fn main() {}\n-    println!(\"Hello, {}!\", 92);\n-\"#,\n-        );\n-        let hls = highlight(file.syntax());\n-        assert_debug_snapshot_matches!(\"highlighting\", hls);\n-    }\n-\n-    #[test]\n-    fn test_matching_brace() {\n-        fn do_check(before: &str, after: &str) {\n-            let (pos, before) = extract_offset(before);\n-            let file = SourceFile::parse(&before);\n-            let new_pos = match matching_brace(&file, pos) {\n-                None => pos,\n-                Some(pos) => pos,\n-            };\n-            let actual = add_cursor(&before, new_pos);\n-            assert_eq_text!(after, &actual);\n-        }\n-\n-        do_check(\"struct Foo { a: i32, }<|>\", \"struct Foo <|>{ a: i32, }\");\n-    }\n-\n-}"}, {"sha": "ef306a7a02f9c71255b79361ced428024331fdee", "filename": "crates/ra_ide_api_light/src/snapshots/tests__highlighting.snap", "status": "removed", "additions": 0, "deletions": 32, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/a656b891fba4b89775adbc93114a20c99afe5f36/crates%2Fra_ide_api_light%2Fsrc%2Fsnapshots%2Ftests__highlighting.snap", "raw_url": "https://github.com/rust-lang/rust/raw/a656b891fba4b89775adbc93114a20c99afe5f36/crates%2Fra_ide_api_light%2Fsrc%2Fsnapshots%2Ftests__highlighting.snap", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api_light%2Fsrc%2Fsnapshots%2Ftests__highlighting.snap?ref=a656b891fba4b89775adbc93114a20c99afe5f36", "patch": "@@ -1,32 +0,0 @@\n----\n-created: \"2019-01-22T14:45:01.959724300+00:00\"\n-creator: insta@0.4.0\n-expression: hls\n-source: \"crates\\\\ra_ide_api_light\\\\src\\\\lib.rs\"\n----\n-[\n-    HighlightedRange {\n-        range: [1; 11),\n-        tag: \"comment\"\n-    },\n-    HighlightedRange {\n-        range: [12; 14),\n-        tag: \"keyword\"\n-    },\n-    HighlightedRange {\n-        range: [15; 19),\n-        tag: \"function\"\n-    },\n-    HighlightedRange {\n-        range: [29; 37),\n-        tag: \"macro\"\n-    },\n-    HighlightedRange {\n-        range: [38; 50),\n-        tag: \"string\"\n-    },\n-    HighlightedRange {\n-        range: [52; 54),\n-        tag: \"literal\"\n-    }\n-]"}]}