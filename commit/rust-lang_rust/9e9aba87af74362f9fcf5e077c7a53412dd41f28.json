{"sha": "9e9aba87af74362f9fcf5e077c7a53412dd41f28", "node_id": "MDY6Q29tbWl0NzI0NzEyOjllOWFiYTg3YWY3NDM2MmY5ZmNmNWUwNzdjN2E1MzQxMmRkNDFmMjg=", "commit": {"author": {"name": "Mara Bos", "email": "m-ou.se@m-ou.se", "date": "2021-01-14T18:00:09Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-01-14T18:00:09Z"}, "message": "Rollup merge of #80829 - jyn514:dep-constructor, r=michaelwoerister\n\nGet rid of `DepConstructor`\n\nThis removes fully 235 unused functions.\n\nFollow-up to https://github.com/rust-lang/rust/pull/80325#discussion_r548491999.\n\nr? ``@michaelwoerister``\ncc ``@cjgillot``", "tree": {"sha": "f2f0a6204f402073950cf86f9c16a0a828d28707", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f2f0a6204f402073950cf86f9c16a0a828d28707"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9e9aba87af74362f9fcf5e077c7a53412dd41f28", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgAIapCRBK7hj4Ov3rIwAAdHIIACxasIKpfi082VzkZagMp03N\nDAUZyYXFygvKj+i9j1p0XBNGRTdA7Hhh06pPTtN1TE66gX8V0AZht2NJ9ryEQTZ1\neO/vbKG6MwVP0eOj57cfuJEDX0pZhJisKjuY7xfMURWBh0fnNErE0tuVu1r0XHMX\nmR4pe+nvi0z5v5PmjBkWBZCqTx3lJ9JlALWjOBrNaoJTfsHkTaYl5a8ZPy9iVcn4\na736L1XMySKLdGSBOlXexaxqhN3jVXWCmSN59KU9y3RxOOIktWkXAmeUC18yHh83\n/UTPqsp+EA+qD1x5qYrHeayaJAYiqMoHUw0mlXcy/SqBinNKKnwUaNwWZvKRhCc=\n=41Gi\n-----END PGP SIGNATURE-----\n", "payload": "tree f2f0a6204f402073950cf86f9c16a0a828d28707\nparent 446ed771244812f9012ea78a48d6b932e34dad3a\nparent f7d261c3b125c1d54bce9eae0da390f654d656b1\nauthor Mara Bos <m-ou.se@m-ou.se> 1610647209 +0000\ncommitter GitHub <noreply@github.com> 1610647209 +0000\n\nRollup merge of #80829 - jyn514:dep-constructor, r=michaelwoerister\n\nGet rid of `DepConstructor`\n\nThis removes fully 235 unused functions.\n\nFollow-up to https://github.com/rust-lang/rust/pull/80325#discussion_r548491999.\n\nr? ``@michaelwoerister``\ncc ``@cjgillot``\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9e9aba87af74362f9fcf5e077c7a53412dd41f28", "html_url": "https://github.com/rust-lang/rust/commit/9e9aba87af74362f9fcf5e077c7a53412dd41f28", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9e9aba87af74362f9fcf5e077c7a53412dd41f28/comments", "author": {"login": "m-ou-se", "id": 783247, "node_id": "MDQ6VXNlcjc4MzI0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/783247?v=4", "gravatar_id": "", "url": "https://api.github.com/users/m-ou-se", "html_url": "https://github.com/m-ou-se", "followers_url": "https://api.github.com/users/m-ou-se/followers", "following_url": "https://api.github.com/users/m-ou-se/following{/other_user}", "gists_url": "https://api.github.com/users/m-ou-se/gists{/gist_id}", "starred_url": "https://api.github.com/users/m-ou-se/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/m-ou-se/subscriptions", "organizations_url": "https://api.github.com/users/m-ou-se/orgs", "repos_url": "https://api.github.com/users/m-ou-se/repos", "events_url": "https://api.github.com/users/m-ou-se/events{/privacy}", "received_events_url": "https://api.github.com/users/m-ou-se/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "446ed771244812f9012ea78a48d6b932e34dad3a", "url": "https://api.github.com/repos/rust-lang/rust/commits/446ed771244812f9012ea78a48d6b932e34dad3a", "html_url": "https://github.com/rust-lang/rust/commit/446ed771244812f9012ea78a48d6b932e34dad3a"}, {"sha": "f7d261c3b125c1d54bce9eae0da390f654d656b1", "url": "https://api.github.com/repos/rust-lang/rust/commits/f7d261c3b125c1d54bce9eae0da390f654d656b1", "html_url": "https://github.com/rust-lang/rust/commit/f7d261c3b125c1d54bce9eae0da390f654d656b1"}], "stats": {"total": 52, "additions": 17, "deletions": 35}, "files": [{"sha": "65e5301c96e9e64dc2913505c3f247d75a64985a", "filename": "compiler/rustc_middle/src/dep_graph/dep_node.rs", "status": "modified", "additions": 13, "deletions": 32, "changes": 45, "blob_url": "https://github.com/rust-lang/rust/blob/9e9aba87af74362f9fcf5e077c7a53412dd41f28/compiler%2Frustc_middle%2Fsrc%2Fdep_graph%2Fdep_node.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9e9aba87af74362f9fcf5e077c7a53412dd41f28/compiler%2Frustc_middle%2Fsrc%2Fdep_graph%2Fdep_node.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fdep_graph%2Fdep_node.rs?ref=9e9aba87af74362f9fcf5e077c7a53412dd41f28", "patch": "@@ -29,9 +29,10 @@\n //!   contained no `DefId` for thing that had been removed.\n //!\n //! `DepNode` definition happens in the `define_dep_nodes!()` macro. This macro\n-//! defines the `DepKind` enum and a corresponding `dep_constructor` module. The\n-//! `dep_constructor` module links a `DepKind` to the parameters that are needed at\n-//! runtime in order to construct a valid `DepNode` fingerprint.\n+//! defines the `DepKind` enum. Each `DepKind` has its own parameters that are\n+//! needed at runtime in order to construct a valid `DepNode` fingerprint.\n+//! However, only `CompileCodegenUnit` is constructed explicitly (with\n+//! `make_compile_codegen_unit`).\n //!\n //! Because the macro sees what parameters a given `DepKind` requires, it can\n //! \"infer\" some properties for each kind of `DepNode`:\n@@ -44,22 +45,14 @@\n //!   `DefId` it was computed from. In other cases, too much information gets\n //!   lost during fingerprint computation.\n //!\n-//! The `dep_constructor` module, together with `DepNode::new()`, ensures that only\n+//! `make_compile_codegen_unit`, together with `DepNode::new()`, ensures that only\n //! valid `DepNode` instances can be constructed. For example, the API does not\n //! allow for constructing parameterless `DepNode`s with anything other\n //! than a zeroed out fingerprint. More generally speaking, it relieves the\n //! user of the `DepNode` API of having to know how to compute the expected\n //! fingerprint for a given set of node parameters.\n \n-use crate::mir::interpret::{GlobalId, LitToConstInput};\n-use crate::traits;\n-use crate::traits::query::{\n-    CanonicalPredicateGoal, CanonicalProjectionGoal, CanonicalTyGoal,\n-    CanonicalTypeOpAscribeUserTypeGoal, CanonicalTypeOpEqGoal, CanonicalTypeOpNormalizeGoal,\n-    CanonicalTypeOpProvePredicateGoal, CanonicalTypeOpSubtypeGoal,\n-};\n-use crate::ty::subst::{GenericArg, SubstsRef};\n-use crate::ty::{self, ParamEnvAnd, Ty, TyCtxt};\n+use crate::ty::TyCtxt;\n \n use rustc_data_structures::fingerprint::Fingerprint;\n use rustc_hir::def_id::{CrateNum, DefId, LocalDefId, CRATE_DEF_INDEX};\n@@ -338,25 +331,6 @@ macro_rules! define_dep_nodes {\n             $($variant),*\n         }\n \n-        #[allow(non_camel_case_types)]\n-        pub mod dep_constructor {\n-            use super::*;\n-\n-            $(\n-                #[inline(always)]\n-                #[allow(unreachable_code, non_snake_case)]\n-                pub fn $variant(_tcx: TyCtxt<'_>, $(arg: $tuple_arg_ty)*) -> DepNode {\n-                    // tuple args\n-                    $({\n-                        erase!($tuple_arg_ty);\n-                        return DepNode::construct(_tcx, DepKind::$variant, &arg)\n-                    })*\n-\n-                    return DepNode::construct(_tcx, DepKind::$variant, &())\n-                }\n-            )*\n-        }\n-\n         fn dep_kind_from_label_string(label: &str) -> Result<DepKind, ()> {\n             match label {\n                 $(stringify!($variant) => Ok(DepKind::$variant),)*\n@@ -384,9 +358,16 @@ rustc_dep_node_append!([define_dep_nodes!][ <'tcx>\n \n     [anon] TraitSelect,\n \n+    // WARNING: if `Symbol` is changed, make sure you update `make_compile_codegen_unit` below.\n     [] CompileCodegenUnit(Symbol),\n ]);\n \n+// WARNING: `construct` is generic and does not know that `CompileCodegenUnit` takes `Symbol`s as keys.\n+// Be very careful changing this type signature!\n+crate fn make_compile_codegen_unit(tcx: TyCtxt<'_>, name: Symbol) -> DepNode {\n+    DepNode::construct(tcx, DepKind::CompileCodegenUnit, &name)\n+}\n+\n pub type DepNode = rustc_query_system::dep_graph::DepNode<DepKind>;\n \n // We keep a lot of `DepNode`s in memory during compilation. It's not"}, {"sha": "ea4d8c129970929fd780c3aeffacca255a997b87", "filename": "compiler/rustc_middle/src/dep_graph/mod.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/9e9aba87af74362f9fcf5e077c7a53412dd41f28/compiler%2Frustc_middle%2Fsrc%2Fdep_graph%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9e9aba87af74362f9fcf5e077c7a53412dd41f28/compiler%2Frustc_middle%2Fsrc%2Fdep_graph%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fdep_graph%2Fmod.rs?ref=9e9aba87af74362f9fcf5e077c7a53412dd41f28", "patch": "@@ -13,7 +13,8 @@ pub use rustc_query_system::dep_graph::{\n     WorkProduct, WorkProductId,\n };\n \n-pub use dep_node::{dep_constructor, label_strs, DepKind, DepNode, DepNodeExt};\n+crate use dep_node::make_compile_codegen_unit;\n+pub use dep_node::{label_strs, DepKind, DepNode, DepNodeExt};\n \n pub type DepGraph = rustc_query_system::dep_graph::DepGraph<DepKind>;\n pub type TaskDeps = rustc_query_system::dep_graph::TaskDeps<DepKind>;"}, {"sha": "6d5d408f86c15bf38096ff4f8f7cbcfd3d73b89c", "filename": "compiler/rustc_middle/src/mir/mono.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/9e9aba87af74362f9fcf5e077c7a53412dd41f28/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmono.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9e9aba87af74362f9fcf5e077c7a53412dd41f28/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmono.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmono.rs?ref=9e9aba87af74362f9fcf5e077c7a53412dd41f28", "patch": "@@ -1,4 +1,4 @@\n-use crate::dep_graph::{dep_constructor, DepNode, WorkProduct, WorkProductId};\n+use crate::dep_graph::{DepNode, WorkProduct, WorkProductId};\n use crate::ich::{NodeIdHashingMode, StableHashingContext};\n use crate::ty::{subst::InternalSubsts, Instance, InstanceDef, SymbolName, TyCtxt};\n use rustc_attr::InlineAttr;\n@@ -362,7 +362,7 @@ impl<'tcx> CodegenUnit<'tcx> {\n     }\n \n     pub fn codegen_dep_node(&self, tcx: TyCtxt<'tcx>) -> DepNode {\n-        dep_constructor::CompileCodegenUnit(tcx, self.name())\n+        crate::dep_graph::make_compile_codegen_unit(tcx, self.name())\n     }\n }\n "}]}