{"sha": "90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8", "node_id": "C_kwDOAAsO6NoAKDkwYTEwY2FlNGI3ZmFmYmQ4Y2UxMDBmMmFlMGNlNjVkYzZiY2IzZDg", "commit": {"author": {"name": "Joshua Nelson", "email": "github@jyn.dev", "date": "2022-12-31T01:55:24Z"}, "committer": {"name": "Joshua Nelson", "email": "github@jyn.dev", "date": "2022-12-31T01:55:24Z"}, "message": "Revert \"Auto merge of #105058 - Nilstrieb:no-merge-commits-for-you-only-bors-is-allowed-to-do-that, r=jyn514\"\n\nThis reverts commit 4839886f0abe208ab8f2bb73a3076a59fe2ab60c, reversing\nchanges made to ce85c98575e3016cf2007d90a85be321e592aa96.", "tree": {"sha": "833ee6ee2d8a4869ff119d3f066aa899b8365319", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/833ee6ee2d8a4869ff119d3f066aa899b8365319"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8", "html_url": "https://github.com/rust-lang/rust/commit/90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8/comments", "author": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4839886f0abe208ab8f2bb73a3076a59fe2ab60c", "url": "https://api.github.com/repos/rust-lang/rust/commits/4839886f0abe208ab8f2bb73a3076a59fe2ab60c", "html_url": "https://github.com/rust-lang/rust/commit/4839886f0abe208ab8f2bb73a3076a59fe2ab60c"}], "stats": {"total": 255, "additions": 60, "deletions": 195}, "files": [{"sha": "23d3e71424b2b41b8490407f4f5d531de13eba64", "filename": ".github/workflows/ci.yml", "status": "modified", "additions": 0, "deletions": 15, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8/.github%2Fworkflows%2Fci.yml", "raw_url": "https://github.com/rust-lang/rust/raw/90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8/.github%2Fworkflows%2Fci.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.github%2Fworkflows%2Fci.yml?ref=90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8", "patch": "@@ -71,11 +71,6 @@ jobs:\n         uses: actions/checkout@v3\n         with:\n           fetch-depth: 2\n-      - name: \"checkout the `master` branch for tidy\"\n-        uses: actions/checkout@v3\n-        with:\n-          ref: master\n-          fetch-depth: 1\n       - name: configure the PR in which the error message will be posted\n         run: \"echo \\\"[CI_PR_NUMBER=$num]\\\"\"\n         env:\n@@ -490,11 +485,6 @@ jobs:\n         uses: actions/checkout@v3\n         with:\n           fetch-depth: 2\n-      - name: \"checkout the `master` branch for tidy\"\n-        uses: actions/checkout@v3\n-        with:\n-          ref: master\n-          fetch-depth: 1\n       - name: configure the PR in which the error message will be posted\n         run: \"echo \\\"[CI_PR_NUMBER=$num]\\\"\"\n         env:\n@@ -610,11 +600,6 @@ jobs:\n         uses: actions/checkout@v3\n         with:\n           fetch-depth: 2\n-      - name: \"checkout the `master` branch for tidy\"\n-        uses: actions/checkout@v3\n-        with:\n-          ref: master\n-          fetch-depth: 1\n       - name: configure the PR in which the error message will be posted\n         run: \"echo \\\"[CI_PR_NUMBER=$num]\\\"\"\n         env:"}, {"sha": "9581099c210ea2ece000212a3783dcab78c45cdc", "filename": "Cargo.lock", "status": "modified", "additions": 0, "deletions": 5, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8", "patch": "@@ -259,10 +259,6 @@ dependencies = [\n  \"toml\",\n ]\n \n-[[package]]\n-name = \"build_helper\"\n-version = \"0.1.0\"\n-\n [[package]]\n name = \"bump-stage0\"\n version = \"0.1.0\"\n@@ -5308,7 +5304,6 @@ dependencies = [\n name = \"tidy\"\n version = \"0.1.0\"\n dependencies = [\n- \"build_helper\",\n  \"cargo_metadata 0.14.0\",\n  \"ignore\",\n  \"lazy_static\","}, {"sha": "1cec4a84480c43a4215d10ea2fc3f3b3d227f580", "filename": "Cargo.toml", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8/Cargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8/Cargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.toml?ref=90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8", "patch": "@@ -4,7 +4,6 @@ members = [\n   \"library/std\",\n   \"library/test\",\n   \"src/rustdoc-json-types\",\n-  \"src/tools/build_helper\",\n   \"src/tools/cargotest\",\n   \"src/tools/clippy\",\n   \"src/tools/clippy/clippy_dev\","}, {"sha": "efe8ae3169fc2f9e4ca678f809a3d7aaf095bec4", "filename": "src/bootstrap/Cargo.lock", "status": "modified", "additions": 0, "deletions": 5, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8/src%2Fbootstrap%2FCargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8/src%2Fbootstrap%2FCargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2FCargo.lock?ref=90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8", "patch": "@@ -36,7 +36,6 @@ dependencies = [\n name = \"bootstrap\"\n version = \"0.0.0\"\n dependencies = [\n- \"build_helper\",\n  \"cc\",\n  \"cmake\",\n  \"fd-lock\",\n@@ -71,10 +70,6 @@ dependencies = [\n  \"regex-automata\",\n ]\n \n-[[package]]\n-name = \"build_helper\"\n-version = \"0.1.0\"\n-\n [[package]]\n name = \"cc\"\n version = \"1.0.73\""}, {"sha": "fafe82a9c128a44ea9307a635b3819282e42c8f1", "filename": "src/bootstrap/Cargo.toml", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8/src%2Fbootstrap%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8/src%2Fbootstrap%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2FCargo.toml?ref=90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8", "patch": "@@ -30,7 +30,6 @@ path = \"bin/sccache-plus-cl.rs\"\n test = false\n \n [dependencies]\n-build_helper = { path = \"../tools/build_helper\" }\n cmake = \"0.1.38\"\n fd-lock = \"3.0.8\"\n filetime = \"0.2\""}, {"sha": "1d57c6ecbbb8d93167cc195b38b44d6f2f5fd8a2", "filename": "src/bootstrap/format.rs", "status": "modified", "additions": 29, "deletions": 1, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8/src%2Fbootstrap%2Fformat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8/src%2Fbootstrap%2Fformat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fformat.rs?ref=90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8", "patch": "@@ -2,7 +2,6 @@\n \n use crate::builder::Builder;\n use crate::util::{output, program_out_of_date, t};\n-use build_helper::git::get_rust_lang_rust_remote;\n use ignore::WalkBuilder;\n use std::collections::VecDeque;\n use std::path::{Path, PathBuf};\n@@ -101,6 +100,35 @@ fn get_modified_rs_files(build: &Builder<'_>) -> Option<Vec<String>> {\n     )\n }\n \n+/// Finds the remote for rust-lang/rust.\n+/// For example for these remotes it will return `upstream`.\n+/// ```text\n+/// origin  https://github.com/Nilstrieb/rust.git (fetch)\n+/// origin  https://github.com/Nilstrieb/rust.git (push)\n+/// upstream        https://github.com/rust-lang/rust (fetch)\n+/// upstream        https://github.com/rust-lang/rust (push)\n+/// ```\n+fn get_rust_lang_rust_remote() -> Result<String, String> {\n+    let mut git = Command::new(\"git\");\n+    git.args([\"config\", \"--local\", \"--get-regex\", \"remote\\\\..*\\\\.url\"]);\n+\n+    let output = git.output().map_err(|err| format!(\"{err:?}\"))?;\n+    if !output.status.success() {\n+        return Err(\"failed to execute git config command\".to_owned());\n+    }\n+\n+    let stdout = String::from_utf8(output.stdout).map_err(|err| format!(\"{err:?}\"))?;\n+\n+    let rust_lang_remote = stdout\n+        .lines()\n+        .find(|remote| remote.contains(\"rust-lang\"))\n+        .ok_or_else(|| \"rust-lang/rust remote not found\".to_owned())?;\n+\n+    let remote_name =\n+        rust_lang_remote.split('.').nth(1).ok_or_else(|| \"remote name not found\".to_owned())?;\n+    Ok(remote_name.into())\n+}\n+\n #[derive(serde::Deserialize)]\n struct RustfmtConfig {\n     ignore: Vec<String>,"}, {"sha": "5ea41d10bc8170686f78e87f79d905e32b7c7993", "filename": "src/bootstrap/lib.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8/src%2Fbootstrap%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8/src%2Fbootstrap%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Flib.rs?ref=90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8", "patch": "@@ -113,7 +113,6 @@ use std::path::{Path, PathBuf};\n use std::process::Command;\n use std::str;\n \n-use build_helper::ci::CiEnv;\n use channel::GitInfo;\n use config::{DryRun, Target};\n use filetime::FileTime;\n@@ -122,7 +121,7 @@ use once_cell::sync::OnceCell;\n use crate::builder::Kind;\n use crate::config::{LlvmLibunwind, TargetSelection};\n use crate::util::{\n-    exe, libdir, mtime, output, run, run_suppressed, symlink_dir, try_run_suppressed,\n+    exe, libdir, mtime, output, run, run_suppressed, symlink_dir, try_run_suppressed, CiEnv,\n };\n \n mod bolt;"}, {"sha": "4e503dfe864e2937eca0461125effb8147739ff1", "filename": "src/bootstrap/native.rs", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8/src%2Fbootstrap%2Fnative.rs", "raw_url": "https://github.com/rust-lang/rust/raw/90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8/src%2Fbootstrap%2Fnative.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fnative.rs?ref=90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8", "patch": "@@ -24,8 +24,6 @@ use crate::util::get_clang_cl_resource_dir;\n use crate::util::{self, exe, output, t, up_to_date};\n use crate::{CLang, GitRepo};\n \n-use build_helper::ci::CiEnv;\n-\n #[derive(Clone)]\n pub struct LlvmResult {\n     /// Path to llvm-config binary.\n@@ -219,7 +217,7 @@ pub(crate) fn is_ci_llvm_available(config: &Config, asserts: bool) -> bool {\n         return false;\n     }\n \n-    if CiEnv::is_ci() {\n+    if crate::util::CiEnv::is_ci() {\n         // We assume we have access to git, so it's okay to unconditionally pass\n         // `true` here.\n         let llvm_sha = detect_llvm_sha(config, true);"}, {"sha": "58220783228b2883fae9ba5ca03d646048e41964", "filename": "src/bootstrap/util.rs", "status": "modified", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8/src%2Fbootstrap%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8/src%2Fbootstrap%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Futil.rs?ref=90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8", "patch": "@@ -255,6 +255,35 @@ pub enum CiEnv {\n     GitHubActions,\n }\n \n+impl CiEnv {\n+    /// Obtains the current CI environment.\n+    pub fn current() -> CiEnv {\n+        if env::var(\"TF_BUILD\").map_or(false, |e| e == \"True\") {\n+            CiEnv::AzurePipelines\n+        } else if env::var(\"GITHUB_ACTIONS\").map_or(false, |e| e == \"true\") {\n+            CiEnv::GitHubActions\n+        } else {\n+            CiEnv::None\n+        }\n+    }\n+\n+    pub fn is_ci() -> bool {\n+        Self::current() != CiEnv::None\n+    }\n+\n+    /// If in a CI environment, forces the command to run with colors.\n+    pub fn force_coloring_in_ci(self, cmd: &mut Command) {\n+        if self != CiEnv::None {\n+            // Due to use of stamp/docker, the output stream of rustbuild is not\n+            // a TTY in CI, so coloring is by-default turned off.\n+            // The explicit `TERM=xterm` environment is needed for\n+            // `--color always` to actually work. This env var was lost when\n+            // compiling through the Makefile. Very strange.\n+            cmd.env(\"TERM\", \"xterm\").args(&[\"--color\", \"always\"]);\n+        }\n+    }\n+}\n+\n pub fn forcing_clang_based_tests() -> bool {\n     if let Some(var) = env::var_os(\"RUSTBUILD_FORCE_CLANG_BASED_TESTS\") {\n         match &var.to_string_lossy().to_lowercase()[..] {"}, {"sha": "d33396dcc80fe42a03bf369027999a507b5e0db7", "filename": "src/ci/github-actions/ci.yml", "status": "modified", "additions": 0, "deletions": 6, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8/src%2Fci%2Fgithub-actions%2Fci.yml", "raw_url": "https://github.com/rust-lang/rust/raw/90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8/src%2Fci%2Fgithub-actions%2Fci.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fgithub-actions%2Fci.yml?ref=90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8", "patch": "@@ -103,12 +103,6 @@ x--expand-yaml-anchors--remove:\n         with:\n           fetch-depth: 2\n \n-      - name: checkout the `master` branch for tidy\n-        uses: actions/checkout@v3\n-        with:\n-          ref: master\n-          fetch-depth: 1\n-\n       # Rust Log Analyzer can't currently detect the PR number of a GitHub\n       # Actions build on its own, so a hint in the log message is needed to\n       # point it in the right direction."}, {"sha": "99f6fea2ecf997b8a3b47433466f5a7840714ab5", "filename": "src/tools/build_helper/Cargo.toml", "status": "removed", "additions": 0, "deletions": 8, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/4839886f0abe208ab8f2bb73a3076a59fe2ab60c/src%2Ftools%2Fbuild_helper%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/4839886f0abe208ab8f2bb73a3076a59fe2ab60c/src%2Ftools%2Fbuild_helper%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fbuild_helper%2FCargo.toml?ref=4839886f0abe208ab8f2bb73a3076a59fe2ab60c", "patch": "@@ -1,8 +0,0 @@\n-[package]\n-name = \"build_helper\"\n-version = \"0.1.0\"\n-edition = \"2021\"\n-\n-# See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html\n-\n-[dependencies]"}, {"sha": "9f113c72b9338be390922d45d14d7f1ef6cf7dc5", "filename": "src/tools/build_helper/src/ci.rs", "status": "removed", "additions": 0, "deletions": 40, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/4839886f0abe208ab8f2bb73a3076a59fe2ab60c/src%2Ftools%2Fbuild_helper%2Fsrc%2Fci.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4839886f0abe208ab8f2bb73a3076a59fe2ab60c/src%2Ftools%2Fbuild_helper%2Fsrc%2Fci.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fbuild_helper%2Fsrc%2Fci.rs?ref=4839886f0abe208ab8f2bb73a3076a59fe2ab60c", "patch": "@@ -1,40 +0,0 @@\n-use std::process::Command;\n-\n-#[derive(Copy, Clone, PartialEq, Eq, Debug)]\n-pub enum CiEnv {\n-    /// Not a CI environment.\n-    None,\n-    /// The Azure Pipelines environment, for Linux (including Docker), Windows, and macOS builds.\n-    AzurePipelines,\n-    /// The GitHub Actions environment, for Linux (including Docker), Windows and macOS builds.\n-    GitHubActions,\n-}\n-\n-impl CiEnv {\n-    /// Obtains the current CI environment.\n-    pub fn current() -> CiEnv {\n-        if std::env::var(\"TF_BUILD\").map_or(false, |e| e == \"True\") {\n-            CiEnv::AzurePipelines\n-        } else if std::env::var(\"GITHUB_ACTIONS\").map_or(false, |e| e == \"true\") {\n-            CiEnv::GitHubActions\n-        } else {\n-            CiEnv::None\n-        }\n-    }\n-\n-    pub fn is_ci() -> bool {\n-        Self::current() != CiEnv::None\n-    }\n-\n-    /// If in a CI environment, forces the command to run with colors.\n-    pub fn force_coloring_in_ci(self, cmd: &mut Command) {\n-        if self != CiEnv::None {\n-            // Due to use of stamp/docker, the output stream of rustbuild is not\n-            // a TTY in CI, so coloring is by-default turned off.\n-            // The explicit `TERM=xterm` environment is needed for\n-            // `--color always` to actually work. This env var was lost when\n-            // compiling through the Makefile. Very strange.\n-            cmd.env(\"TERM\", \"xterm\").args(&[\"--color\", \"always\"]);\n-        }\n-    }\n-}"}, {"sha": "e9638206e6729f561f4a2ee388bc90f6b2748e5c", "filename": "src/tools/build_helper/src/git.rs", "status": "removed", "additions": 0, "deletions": 30, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/4839886f0abe208ab8f2bb73a3076a59fe2ab60c/src%2Ftools%2Fbuild_helper%2Fsrc%2Fgit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4839886f0abe208ab8f2bb73a3076a59fe2ab60c/src%2Ftools%2Fbuild_helper%2Fsrc%2Fgit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fbuild_helper%2Fsrc%2Fgit.rs?ref=4839886f0abe208ab8f2bb73a3076a59fe2ab60c", "patch": "@@ -1,30 +0,0 @@\n-use std::process::Command;\n-\n-/// Finds the remote for rust-lang/rust.\n-/// For example for these remotes it will return `upstream`.\n-/// ```text\n-/// origin  https://github.com/Nilstrieb/rust.git (fetch)\n-/// origin  https://github.com/Nilstrieb/rust.git (push)\n-/// upstream        https://github.com/rust-lang/rust (fetch)\n-/// upstream        https://github.com/rust-lang/rust (push)\n-/// ```\n-pub fn get_rust_lang_rust_remote() -> Result<String, String> {\n-    let mut git = Command::new(\"git\");\n-    git.args([\"config\", \"--local\", \"--get-regex\", \"remote\\\\..*\\\\.url\"]);\n-\n-    let output = git.output().map_err(|err| format!(\"{err:?}\"))?;\n-    if !output.status.success() {\n-        return Err(\"failed to execute git config command\".to_owned());\n-    }\n-\n-    let stdout = String::from_utf8(output.stdout).map_err(|err| format!(\"{err:?}\"))?;\n-\n-    let rust_lang_remote = stdout\n-        .lines()\n-        .find(|remote| remote.contains(\"rust-lang\"))\n-        .ok_or_else(|| \"rust-lang/rust remote not found\".to_owned())?;\n-\n-    let remote_name =\n-        rust_lang_remote.split('.').nth(1).ok_or_else(|| \"remote name not found\".to_owned())?;\n-    Ok(remote_name.into())\n-}"}, {"sha": "d3d2323db853a0cfe735d80dbfe2b9d19a883f43", "filename": "src/tools/build_helper/src/lib.rs", "status": "removed", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/4839886f0abe208ab8f2bb73a3076a59fe2ab60c/src%2Ftools%2Fbuild_helper%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4839886f0abe208ab8f2bb73a3076a59fe2ab60c/src%2Ftools%2Fbuild_helper%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fbuild_helper%2Fsrc%2Flib.rs?ref=4839886f0abe208ab8f2bb73a3076a59fe2ab60c", "patch": "@@ -1,2 +0,0 @@\n-pub mod ci;\n-pub mod git;"}, {"sha": "97d038da702d5b727497f787702ad559fe87def8", "filename": "src/tools/tidy/Cargo.toml", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8/src%2Ftools%2Ftidy%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8/src%2Ftools%2Ftidy%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2FCargo.toml?ref=90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8", "patch": "@@ -5,7 +5,6 @@ edition = \"2021\"\n autobins = false\n \n [dependencies]\n-build_helper = { path = \"../build_helper\" }\n cargo_metadata = \"0.14\"\n regex = \"1\"\n miropt-test-tools = { path = \"../miropt-test-tools\" }"}, {"sha": "698e4850bea9bdf1e8d94875c2ffde8f8e358696", "filename": "src/tools/tidy/src/lib.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8/src%2Ftools%2Ftidy%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8/src%2Ftools%2Ftidy%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Flib.rs?ref=90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8", "patch": "@@ -48,7 +48,6 @@ pub mod errors;\n pub mod extdeps;\n pub mod features;\n pub mod mir_opt_tests;\n-pub mod no_merge;\n pub mod pal;\n pub mod primitive_docs;\n pub mod style;"}, {"sha": "6714c63ee62a143a923f84088101cc99ec1142d1", "filename": "src/tools/tidy/src/main.rs", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8/src%2Ftools%2Ftidy%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8/src%2Ftools%2Ftidy%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Fmain.rs?ref=90a10cae4b7fafbd8ce100f2ae0ce65dc6bcb3d8", "patch": "@@ -107,8 +107,6 @@ fn main() {\n         check!(alphabetical, &compiler_path);\n         check!(alphabetical, &library_path);\n \n-        check!(no_merge, ());\n-\n         let collected = {\n             drain_handles(&mut handles);\n "}, {"sha": "362d6f6f4d77f858d4845c3e28b395e2900a33f0", "filename": "src/tools/tidy/src/no_merge.rs", "status": "removed", "additions": 0, "deletions": 72, "changes": 72, "blob_url": "https://github.com/rust-lang/rust/blob/4839886f0abe208ab8f2bb73a3076a59fe2ab60c/src%2Ftools%2Ftidy%2Fsrc%2Fno_merge.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4839886f0abe208ab8f2bb73a3076a59fe2ab60c/src%2Ftools%2Ftidy%2Fsrc%2Fno_merge.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Fno_merge.rs?ref=4839886f0abe208ab8f2bb73a3076a59fe2ab60c", "patch": "@@ -1,72 +0,0 @@\n-//! This check makes sure that no accidental merge commits are introduced to the repository.\n-//! It forbids all merge commits that are not caused by rollups/bors or subtree syncs.\n-\n-use std::process::Command;\n-\n-use build_helper::ci::CiEnv;\n-use build_helper::git::get_rust_lang_rust_remote;\n-\n-macro_rules! try_unwrap_in_ci {\n-    ($expr:expr) => {\n-        match $expr {\n-            Ok(value) => value,\n-            Err(err) if CiEnv::is_ci() => {\n-                panic!(\"Encountered error while testing Git status: {:?}\", err)\n-            }\n-            Err(_) => return,\n-        }\n-    };\n-}\n-\n-pub fn check(_: (), bad: &mut bool) {\n-    let remote = try_unwrap_in_ci!(get_rust_lang_rust_remote());\n-    let merge_commits = try_unwrap_in_ci!(find_merge_commits(&remote));\n-\n-    let mut bad_merge_commits = merge_commits.lines().filter(|commit| {\n-        !(\n-            // Bors is the ruler of merge commits.\n-            commit.starts_with(\"Auto merge of\") || commit.starts_with(\"Rollup merge of\")\n-        )\n-    });\n-\n-    if let Some(merge) = bad_merge_commits.next() {\n-        tidy_error!(\n-            bad,\n-            \"found a merge commit in the history: `{merge}`.\n-To resolve the issue, see this: https://rustc-dev-guide.rust-lang.org/git.html#i-made-a-merge-commit-by-accident.\n-If you're doing a subtree sync, add your tool to the list in the code that emitted this error.\"\n-        );\n-    }\n-}\n-\n-/// Runs `git log --merges --format=%s $REMOTE/master..HEAD` and returns all commits\n-fn find_merge_commits(remote: &str) -> Result<String, String> {\n-    let mut git = Command::new(\"git\");\n-    git.args([\n-        \"log\",\n-        \"--merges\",\n-        \"--format=%s\",\n-        &format!(\"{remote}/master..HEAD\"),\n-        // Ignore subtree syncs. Add your new subtrees here.\n-        \":!src/tools/miri\",\n-        \":!src/tools/rust-analyzer\",\n-        \":!compiler/rustc_smir\",\n-        \":!library/portable-simd\",\n-        \":!compiler/rustc_codegen_gcc\",\n-        \":!src/tools/rustfmt\",\n-        \":!compiler/rustc_codegen_cranelift\",\n-        \":!src/tools/clippy\",\n-    ]);\n-\n-    let output = git.output().map_err(|err| format!(\"{err:?}\"))?;\n-    if !output.status.success() {\n-        return Err(format!(\n-            \"failed to execute git log command: {}\",\n-            String::from_utf8_lossy(&output.stderr)\n-        ));\n-    }\n-\n-    let stdout = String::from_utf8(output.stdout).map_err(|err| format!(\"{err:?}\"))?;\n-\n-    Ok(stdout)\n-}"}]}