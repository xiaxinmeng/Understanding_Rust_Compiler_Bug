{"sha": "6051318744f4743d40d91660d41fd8cbe6583d34", "node_id": "C_kwDOAAsO6NoAKDYwNTEzMTg3NDRmNDc0M2Q0MGQ5MTY2MGQ0MWZkOGNiZTY1ODNkMzQ", "commit": {"author": {"name": "vlad20012", "email": "beskvlad@gmail.com", "date": "2022-01-27T12:54:06Z"}, "committer": {"name": "vlad20012", "email": "beskvlad@gmail.com", "date": "2022-01-27T13:18:12Z"}, "message": "Set current working directory for procedural macros", "tree": {"sha": "5e1266afc24607826e911dea5a7a68e6f5d0aaca", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5e1266afc24607826e911dea5a7a68e6f5d0aaca"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6051318744f4743d40d91660d41fd8cbe6583d34", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEERcui/VYSaOw9QCPjWOYu0xqLOZkFAmHym5QACgkQWOYu0xqL\nOZlqaw//SU1pP1HNqdqk4MkmxTeLb29w2rnmiNlGU+P2e+Bfiq0sECiVOD7SvKG+\nCgM8fngIll9PpSutt8vkNx6GbmJG7DQbdobOxT59Yr9PT/4AWuRqDwypdzKkHonr\nwTEV1kcc3Mo1XgKOk1sL2c25naaMY/wLEB8dCbo/mql4Xv40nh4kctFI/DT+4KsN\nZTWKaGmJvXQzqjnFD7b7JaUeCnpltX/xZKglAGdpEoVmHcAhairhEfoD21tOLEBm\n3kcdM9MIlmv7QyxXO3enuXswUdawcJeWmfQNb5QOmh4nuMwlTcxE+1eNJcY4zpkY\nxh4/RpHStWKZtwQ/8/F6tHWC062J8KAplUYvbOSOt2DEUkaxN4MIPgQB8G05zfci\nGRImTGWjPHIFi8bQ9yQtYubzcv7RIyjMIO/naMRiUtHVtb+9jAYejgXcMWblwUWM\nqWXe9a1iL4ysVkKbXTcbERhA7Jn0OmIMn7qDHfj+kRQXA43TDF4DFIrh2TlbkNzI\n6um0/EXWh088h5rIgrNyOjL/qKtxnCZ2ggsTGX+BVZfe2eZ2ibEpM3Nn1tH/7KBr\nTDh3yjBgkBZElLzt4sc3RDy6atkBkaVFJUodRrAtwG/15RT95pKOKZInyNk/OFLL\nEOEw3n5L0lOkWv8J7DxV7bbgHpURr8m6fO1thJJKZ3/wFALBE3A=\n=gMz7\n-----END PGP SIGNATURE-----", "payload": "tree 5e1266afc24607826e911dea5a7a68e6f5d0aaca\nparent e149a15edd354dd0f995532d16a3e8dc21367e06\nauthor vlad20012 <beskvlad@gmail.com> 1643288046 +0300\ncommitter vlad20012 <beskvlad@gmail.com> 1643289492 +0300\n\nSet current working directory for procedural macros\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6051318744f4743d40d91660d41fd8cbe6583d34", "html_url": "https://github.com/rust-lang/rust/commit/6051318744f4743d40d91660d41fd8cbe6583d34", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6051318744f4743d40d91660d41fd8cbe6583d34/comments", "author": {"login": "vlad20012", "id": 3221931, "node_id": "MDQ6VXNlcjMyMjE5MzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3221931?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vlad20012", "html_url": "https://github.com/vlad20012", "followers_url": "https://api.github.com/users/vlad20012/followers", "following_url": "https://api.github.com/users/vlad20012/following{/other_user}", "gists_url": "https://api.github.com/users/vlad20012/gists{/gist_id}", "starred_url": "https://api.github.com/users/vlad20012/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vlad20012/subscriptions", "organizations_url": "https://api.github.com/users/vlad20012/orgs", "repos_url": "https://api.github.com/users/vlad20012/repos", "events_url": "https://api.github.com/users/vlad20012/events{/privacy}", "received_events_url": "https://api.github.com/users/vlad20012/received_events", "type": "User", "site_admin": false}, "committer": {"login": "vlad20012", "id": 3221931, "node_id": "MDQ6VXNlcjMyMjE5MzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3221931?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vlad20012", "html_url": "https://github.com/vlad20012", "followers_url": "https://api.github.com/users/vlad20012/followers", "following_url": "https://api.github.com/users/vlad20012/following{/other_user}", "gists_url": "https://api.github.com/users/vlad20012/gists{/gist_id}", "starred_url": "https://api.github.com/users/vlad20012/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vlad20012/subscriptions", "organizations_url": "https://api.github.com/users/vlad20012/orgs", "repos_url": "https://api.github.com/users/vlad20012/repos", "events_url": "https://api.github.com/users/vlad20012/events{/privacy}", "received_events_url": "https://api.github.com/users/vlad20012/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e149a15edd354dd0f995532d16a3e8dc21367e06", "url": "https://api.github.com/repos/rust-lang/rust/commits/e149a15edd354dd0f995532d16a3e8dc21367e06", "html_url": "https://github.com/rust-lang/rust/commit/e149a15edd354dd0f995532d16a3e8dc21367e06"}], "stats": {"total": 28, "additions": 28, "deletions": 0}, "files": [{"sha": "0b8a2b6f85710846d5af18acd7dc72df3cb14ac4", "filename": "crates/proc_macro_api/src/lib.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/6051318744f4743d40d91660d41fd8cbe6583d34/crates%2Fproc_macro_api%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6051318744f4743d40d91660d41fd8cbe6583d34/crates%2Fproc_macro_api%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproc_macro_api%2Fsrc%2Flib.rs?ref=6051318744f4743d40d91660d41fd8cbe6583d34", "patch": "@@ -156,12 +156,18 @@ impl ProcMacro {\n         attr: Option<&Subtree>,\n         env: Vec<(String, String)>,\n     ) -> Result<Result<Subtree, PanicMessage>, ServerError> {\n+        let current_dir = env\n+            .iter()\n+            .find(|(name, _)| name == \"CARGO_MANIFEST_DIR\")\n+            .map(|(_, value)| value.clone());\n+\n         let task = ExpandMacro {\n             macro_body: FlatTree::new(subtree),\n             macro_name: self.name.to_string(),\n             attributes: attr.map(FlatTree::new),\n             lib: self.dylib_path.to_path_buf().into(),\n             env,\n+            current_dir,\n         };\n \n         let request = msg::Request::ExpandMacro(task);"}, {"sha": "da96c81d49f71d1a74715f6febf6af8085c2e256", "filename": "crates/proc_macro_api/src/msg.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/6051318744f4743d40d91660d41fd8cbe6583d34/crates%2Fproc_macro_api%2Fsrc%2Fmsg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6051318744f4743d40d91660d41fd8cbe6583d34/crates%2Fproc_macro_api%2Fsrc%2Fmsg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproc_macro_api%2Fsrc%2Fmsg.rs?ref=6051318744f4743d40d91660d41fd8cbe6583d34", "patch": "@@ -48,6 +48,8 @@ pub struct ExpandMacro {\n \n     /// Environment variables to set during macro expansion.\n     pub env: Vec<(String, String)>,\n+\n+    pub current_dir: Option<String>,\n }\n \n pub trait Message: Serialize + DeserializeOwned {\n@@ -143,6 +145,7 @@ mod tests {\n             attributes: None,\n             lib: std::env::current_dir().unwrap(),\n             env: Default::default(),\n+            current_dir: Default::default(),\n         };\n \n         let json = serde_json::to_string(&task).unwrap();"}, {"sha": "1698bc967d73fc12a792758e5e25666d0e2798db", "filename": "crates/proc_macro_srv/src/lib.rs", "status": "modified", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/6051318744f4743d40d91660d41fd8cbe6583d34/crates%2Fproc_macro_srv%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6051318744f4743d40d91660d41fd8cbe6583d34/crates%2Fproc_macro_srv%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproc_macro_srv%2Fsrc%2Flib.rs?ref=6051318744f4743d40d91660d41fd8cbe6583d34", "patch": "@@ -43,6 +43,16 @@ impl ProcMacroSrv {\n             prev_env.insert(k.as_str(), env::var_os(k));\n             env::set_var(k, v);\n         }\n+        let prev_working_dir = match task.current_dir {\n+            Some(dir) => {\n+                let prev_working_dir = std::env::current_dir().ok();\n+                if let Err(err) = std::env::set_current_dir(&dir) {\n+                    eprintln!(\"Failed to set the current working dir to {}. Error: {:?}\", dir, err)\n+                }\n+                prev_working_dir\n+            }\n+            None => None,\n+        };\n \n         let macro_body = task.macro_body.to_subtree();\n         let attributes = task.attributes.map(|it| it.to_subtree());\n@@ -56,6 +66,15 @@ impl ProcMacroSrv {\n                 None => env::remove_var(k),\n             }\n         }\n+        if let Some(dir) = prev_working_dir {\n+            if let Err(err) = std::env::set_current_dir(&dir) {\n+                eprintln!(\n+                    \"Failed to set the current working dir to {}. Error: {:?}\",\n+                    dir.display(),\n+                    err\n+                )\n+            }\n+        }\n \n         result.map_err(PanicMessage)\n     }"}]}