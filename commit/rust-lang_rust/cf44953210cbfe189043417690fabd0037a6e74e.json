{"sha": "cf44953210cbfe189043417690fabd0037a6e74e", "node_id": "MDY6Q29tbWl0NzI0NzEyOmNmNDQ5NTMyMTBjYmZlMTg5MDQzNDE3NjkwZmFiZDAwMzdhNmU3NGU=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-02-12T16:45:58Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-02-12T16:45:58Z"}, "message": "Merge #7652\n\n7652: Fix slow tests sometimes failing r=flodiebold a=flodiebold\n\nIn some situations we reloaded the workspace in the tests after having reported\r\nto be ready. There's two fixes here:\r\n1. Add a version to the VFS config and include that version in progress reports,\r\nso that we don't think we're done prematurely;\r\n2. Delay status transitions until after changes are applied. Otherwise the last\r\nchange during loading can potentially trigger a workspace reload, if it contains\r\ninteresting changes.\r\n\n\nCo-authored-by: Florian Diebold <florian.diebold@freiheit.com>", "tree": {"sha": "357232094eb1bc5a98362fb6ec2d6d65160573be", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/357232094eb1bc5a98362fb6ec2d6d65160573be"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cf44953210cbfe189043417690fabd0037a6e74e", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgJrDGCRBK7hj4Ov3rIwAAdHIIADfdkCLabNXHHTEjFPgoDQIF\n/qrYHzPl2naf/c46/SxtbApFBS3JBhdfeRO30dAcVlKbQ3txIb3LiWs+7dFTbohI\nNcZdx4PiWqMi59h9RKQmHgFGUTS5+tBE9+6/7CVIdnfoBin7nSUkP3QGWYjEDBs0\nf4pnJ2yHkOgeXPhwa/NC9vp8kVTC01CV+dqO2CDS3QyUUbYYZ0KN2Go/De1sHc1Y\nTNHGDeQG4XkeMFHIWtyGCkBiiXVY0bi2jz1QsQZ+QdqjrWyN62W25/l2htP2mEnT\n7+zGSOkIbio1yCIZDlCa1xsZzlN3KQ+EJpNWS8d/hF00/937O0eoouIMbKBTbFM=\n=xase\n-----END PGP SIGNATURE-----\n", "payload": "tree 357232094eb1bc5a98362fb6ec2d6d65160573be\nparent 777d936c17631dfc32a37bd919e45597b83349e4\nparent 8c196056d5d51b0c7395eab399f548fc38b9573b\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1613148358 +0000\ncommitter GitHub <noreply@github.com> 1613148358 +0000\n\nMerge #7652\n\n7652: Fix slow tests sometimes failing r=flodiebold a=flodiebold\n\nIn some situations we reloaded the workspace in the tests after having reported\r\nto be ready. There's two fixes here:\r\n1. Add a version to the VFS config and include that version in progress reports,\r\nso that we don't think we're done prematurely;\r\n2. Delay status transitions until after changes are applied. Otherwise the last\r\nchange during loading can potentially trigger a workspace reload, if it contains\r\ninteresting changes.\r\n\n\nCo-authored-by: Florian Diebold <florian.diebold@freiheit.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cf44953210cbfe189043417690fabd0037a6e74e", "html_url": "https://github.com/rust-lang/rust/commit/cf44953210cbfe189043417690fabd0037a6e74e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cf44953210cbfe189043417690fabd0037a6e74e/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "777d936c17631dfc32a37bd919e45597b83349e4", "url": "https://api.github.com/repos/rust-lang/rust/commits/777d936c17631dfc32a37bd919e45597b83349e4", "html_url": "https://github.com/rust-lang/rust/commit/777d936c17631dfc32a37bd919e45597b83349e4"}, {"sha": "8c196056d5d51b0c7395eab399f548fc38b9573b", "url": "https://api.github.com/repos/rust-lang/rust/commits/8c196056d5d51b0c7395eab399f548fc38b9573b", "html_url": "https://github.com/rust-lang/rust/commit/8c196056d5d51b0c7395eab399f548fc38b9573b"}], "stats": {"total": 75, "additions": 52, "deletions": 23}, "files": [{"sha": "1850068a340cdb7492bb4960f5b386e3cabc7505", "filename": ".github/workflows/ci.yaml", "status": "modified", "additions": 1, "deletions": 9, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/cf44953210cbfe189043417690fabd0037a6e74e/.github%2Fworkflows%2Fci.yaml", "raw_url": "https://github.com/rust-lang/rust/raw/cf44953210cbfe189043417690fabd0037a6e74e/.github%2Fworkflows%2Fci.yaml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.github%2Fworkflows%2Fci.yaml?ref=cf44953210cbfe189043417690fabd0037a6e74e", "patch": "@@ -53,19 +53,11 @@ jobs:\n     - name: Install Rust toolchain\n       uses: actions-rs/toolchain@v1\n       with:\n-        toolchain: 1.49.0   # FIXME: CI is failing on 1.50\n+        toolchain: stable\n         profile: minimal\n         override: true\n         components: rustfmt, rust-src\n \n-    - name: Install rustfmt\n-      uses: actions-rs/toolchain@v1\n-      with:\n-        toolchain: stable\n-        profile: minimal\n-        override: false\n-        components: rustfmt\n-\n     - name: Cache cargo directories\n       uses: actions/cache@v2\n       with:"}, {"sha": "cf0cd81deef522a33d45a8b8e665ddb0b5be0465", "filename": "crates/rust-analyzer/src/cli/load_cargo.rs", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/cf44953210cbfe189043417690fabd0037a6e74e/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fload_cargo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf44953210cbfe189043417690fabd0037a6e74e/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fload_cargo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fload_cargo.rs?ref=cf44953210cbfe189043417690fabd0037a6e74e", "patch": "@@ -59,7 +59,11 @@ pub fn load_cargo(root: &Path, config: &LoadCargoConfig) -> Result<(AnalysisHost\n     );\n \n     let project_folders = ProjectFolders::new(&[ws], &[], build_data.as_ref());\n-    loader.set_config(vfs::loader::Config { load: project_folders.load, watch: vec![] });\n+    loader.set_config(vfs::loader::Config {\n+        load: project_folders.load,\n+        watch: vec![],\n+        version: 0,\n+    });\n \n     log::debug!(\"crate graph: {:?}\", crate_graph);\n     let host = load(crate_graph, project_folders.source_root_config, &mut vfs, &receiver);\n@@ -79,7 +83,7 @@ fn load(\n     // wait until Vfs has loaded all roots\n     for task in receiver {\n         match task {\n-            vfs::loader::Message::Progress { n_done, n_total } => {\n+            vfs::loader::Message::Progress { n_done, n_total, config_version: _ } => {\n                 if n_done == n_total {\n                     break;\n                 }"}, {"sha": "c3bc8791d4bb51da2d21b2352936cfb7a5dea4c2", "filename": "crates/rust-analyzer/src/global_state.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/cf44953210cbfe189043417690fabd0037a6e74e/crates%2Frust-analyzer%2Fsrc%2Fglobal_state.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf44953210cbfe189043417690fabd0037a6e74e/crates%2Frust-analyzer%2Fsrc%2Fglobal_state.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fglobal_state.rs?ref=cf44953210cbfe189043417690fabd0037a6e74e", "patch": "@@ -67,6 +67,7 @@ pub(crate) struct GlobalState {\n     req_queue: ReqQueue,\n     pub(crate) task_pool: Handle<TaskPool<Task>, Receiver<Task>>,\n     pub(crate) loader: Handle<Box<dyn vfs::loader::Handle>, Receiver<vfs::loader::Message>>,\n+    pub(crate) vfs_config_version: u32,\n     pub(crate) flycheck: Vec<FlycheckHandle>,\n     pub(crate) flycheck_sender: Sender<flycheck::Message>,\n     pub(crate) flycheck_receiver: Receiver<flycheck::Message>,\n@@ -120,6 +121,7 @@ impl GlobalState {\n         GlobalState {\n             sender,\n             req_queue: ReqQueue::default(),\n+            vfs_config_version: 0,\n             task_pool,\n             loader,\n             flycheck: Vec::new(),"}, {"sha": "2829d5970e6b502d52706891c6f30d8927574ac8", "filename": "crates/rust-analyzer/src/main_loop.rs", "status": "modified", "additions": 13, "deletions": 7, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/cf44953210cbfe189043417690fabd0037a6e74e/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf44953210cbfe189043417690fabd0037a6e74e/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs?ref=cf44953210cbfe189043417690fabd0037a6e74e", "patch": "@@ -5,6 +5,7 @@ use std::{\n     time::{Duration, Instant},\n };\n \n+use always_assert::always;\n use crossbeam_channel::{select, Receiver};\n use ide::PrimeCachesProgress;\n use ide::{Canceled, FileId};\n@@ -186,7 +187,7 @@ impl GlobalState {\n             log::info!(\"task queue len: {}\", task_queue_len);\n         }\n \n-        let prev_status = self.status;\n+        let mut new_status = self.status;\n         match event {\n             Event::Lsp(msg) => match msg {\n                 lsp_server::Message::Request(req) => self.on_request(loop_start, req)?,\n@@ -298,22 +299,23 @@ impl GlobalState {\n                                 }\n                             }\n                         }\n-                        vfs::loader::Message::Progress { n_total, n_done } => {\n+                        vfs::loader::Message::Progress { n_total, n_done, config_version } => {\n+                            always!(config_version <= self.vfs_config_version);\n                             if n_total == 0 {\n-                                self.transition(Status::Invalid);\n+                                new_status = Status::Invalid;\n                             } else {\n                                 let state = if n_done == 0 {\n-                                    self.transition(Status::Loading);\n+                                    new_status = Status::Loading;\n                                     Progress::Begin\n                                 } else if n_done < n_total {\n                                     Progress::Report\n                                 } else {\n                                     assert_eq!(n_done, n_total);\n-                                    let status = Status::Ready {\n+                                    new_status = Status::Ready {\n                                         partial: self.config.load_out_dirs_from_check()\n-                                            && self.workspace_build_data.is_none(),\n+                                            && self.workspace_build_data.is_none()\n+                                            || config_version < self.vfs_config_version,\n                                     };\n-                                    self.transition(status);\n                                     Progress::End\n                                 };\n                                 self.report_progress(\n@@ -398,6 +400,10 @@ impl GlobalState {\n         }\n \n         let state_changed = self.process_changes();\n+        let prev_status = self.status;\n+        if prev_status != new_status {\n+            self.transition(new_status);\n+        }\n         let is_ready = matches!(self.status, Status::Ready { .. });\n         if prev_status == Status::Loading && is_ready {\n             for flycheck in &self.flycheck {"}, {"sha": "c07efa330313d7f6cf0e4d47dd41e365e4b0b9c5", "filename": "crates/rust-analyzer/src/reload.rs", "status": "modified", "additions": 16, "deletions": 1, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/cf44953210cbfe189043417690fabd0037a6e74e/crates%2Frust-analyzer%2Fsrc%2Freload.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf44953210cbfe189043417690fabd0037a6e74e/crates%2Frust-analyzer%2Fsrc%2Freload.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Freload.rs?ref=cf44953210cbfe189043417690fabd0037a6e74e", "patch": "@@ -50,6 +50,16 @@ impl GlobalState {\n             Status::Loading | Status::NeedsReload => return,\n             Status::Ready { .. } | Status::Invalid => (),\n         }\n+        log::info!(\n+            \"Reloading workspace because of the following changes: {}\",\n+            itertools::join(\n+                changes\n+                    .iter()\n+                    .filter(|(path, kind)| is_interesting(path, *kind))\n+                    .map(|(path, kind)| format!(\"{}/{:?}\", path.display(), kind)),\n+                \", \"\n+            )\n+        );\n         if self.config.cargo_autoreload() {\n             self.fetch_workspaces_request();\n         } else {\n@@ -290,7 +300,12 @@ impl GlobalState {\n             FilesWatcher::Client => vec![],\n             FilesWatcher::Notify => project_folders.watch,\n         };\n-        self.loader.handle.set_config(vfs::loader::Config { load: project_folders.load, watch });\n+        self.vfs_config_version += 1;\n+        self.loader.handle.set_config(vfs::loader::Config {\n+            load: project_folders.load,\n+            watch,\n+            version: self.vfs_config_version,\n+        });\n \n         // Create crate graph from all the workspaces\n         let crate_graph = {"}, {"sha": "f7ae0577d2e2c6b0f118b76d32434e640c425047", "filename": "crates/vfs-notify/src/lib.rs", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/cf44953210cbfe189043417690fabd0037a6e74e/crates%2Fvfs-notify%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf44953210cbfe189043417690fabd0037a6e74e/crates%2Fvfs-notify%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fvfs-notify%2Fsrc%2Flib.rs?ref=cf44953210cbfe189043417690fabd0037a6e74e", "patch": "@@ -86,8 +86,10 @@ impl NotifyActor {\n                             self.watcher = watcher.map(|it| (it, watcher_receiver));\n                         }\n \n+                        let config_version = config.version;\n+\n                         let n_total = config.load.len();\n-                        self.send(loader::Message::Progress { n_total, n_done: 0 });\n+                        self.send(loader::Message::Progress { n_total, n_done: 0, config_version });\n \n                         self.watched_entries.clear();\n \n@@ -98,7 +100,11 @@ impl NotifyActor {\n                             }\n                             let files = self.load_entry(entry, watch);\n                             self.send(loader::Message::Loaded { files });\n-                            self.send(loader::Message::Progress { n_total, n_done: i + 1 });\n+                            self.send(loader::Message::Progress {\n+                                n_total,\n+                                n_done: i + 1,\n+                                config_version,\n+                            });\n                         }\n                     }\n                     Message::Invalidate(path) => {"}, {"sha": "473b29fcb32fd2f55bf3450b176d12f78f52a677", "filename": "crates/vfs/src/loader.rs", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/cf44953210cbfe189043417690fabd0037a6e74e/crates%2Fvfs%2Fsrc%2Floader.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf44953210cbfe189043417690fabd0037a6e74e/crates%2Fvfs%2Fsrc%2Floader.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fvfs%2Fsrc%2Floader.rs?ref=cf44953210cbfe189043417690fabd0037a6e74e", "patch": "@@ -32,6 +32,9 @@ pub struct Directories {\n /// [`Handle`]'s configuration.\n #[derive(Debug)]\n pub struct Config {\n+    /// Version number to associate progress updates to the right config\n+    /// version.\n+    pub version: u32,\n     /// Set of initially loaded files.\n     pub load: Vec<Entry>,\n     /// Index of watched entries in `load`.\n@@ -45,7 +48,7 @@ pub enum Message {\n     /// Indicate a gradual progress.\n     ///\n     /// This is supposed to be the number of loaded files.\n-    Progress { n_total: usize, n_done: usize },\n+    Progress { n_total: usize, n_done: usize, config_version: u32 },\n     /// The handle loaded the following files' content.\n     Loaded { files: Vec<(AbsPathBuf, Option<Vec<u8>>)> },\n }\n@@ -196,10 +199,11 @@ impl fmt::Debug for Message {\n             Message::Loaded { files } => {\n                 f.debug_struct(\"Loaded\").field(\"n_files\", &files.len()).finish()\n             }\n-            Message::Progress { n_total, n_done } => f\n+            Message::Progress { n_total, n_done, config_version } => f\n                 .debug_struct(\"Progress\")\n                 .field(\"n_total\", n_total)\n                 .field(\"n_done\", n_done)\n+                .field(\"config_version\", config_version)\n                 .finish(),\n         }\n     }"}]}