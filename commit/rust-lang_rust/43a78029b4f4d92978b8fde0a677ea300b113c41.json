{"sha": "43a78029b4f4d92978b8fde0a677ea300b113c41", "node_id": "C_kwDOAAsO6NoAKDQzYTc4MDI5YjRmNGQ5Mjk3OGI4ZmRlMGE2NzdlYTMwMGIxMTNjNDE", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-04-28T09:26:59Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-04-28T09:26:59Z"}, "message": "Auto merge of #110837 - scottmcm:offset-for-add, r=compiler-errors\n\nUse MIR's `Offset` for pointer `add` too\n\n~~Status: draft while waiting for #110822 to land, since this is built atop that.~~\n~~r? `@ghost~~`\n\nCanonical Rust code has mostly moved to `add`/`sub` on pointers, which take `usize`, instead of `offset` which takes `isize`.  (And, relatedly, when `sub_ptr` was added it turned out it replaced every single in-tree use of `offset_from`, because `usize` is just so much more useful than `isize` in Rust.)\n\nUnfortunately, `intrinsics::offset` could only accept `*const` and `isize`, so there's a *huge* amount of type conversions back and forth being done.  They're identity conversions in the backend, but still end up producing quite a lot of unhelpful MIR.\n\nThis PR changes `intrinsics::offset` to accept `*const` *and* `*mut` along with `isize` *and* `usize`.  Conveniently, the backends and CTFE already handle this, since MIR's `BinOp::Offset` [already supports all four combinations](https://github.com/rust-lang/rust/blob/adaac6b166df57ea5a20d56e4cce503b55aca927/compiler/rustc_const_eval/src/transform/validate.rs#L523-L528).\n\nTo demonstrate the difference, I added some `mir-opt/pre-codegen/` tests around slice indexing.  Here's the difference to `[T]::get_mut`, since it uses `<*mut _>::add` internally:\n```diff\n`@@` -79,30 +70,21 `@@` fn slice_get_mut_usize(_1: &mut [u32], _2: usize) -> Option<&mut u32> {\n         StorageLive(_12);                // scope 3 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n         StorageLive(_9);                 // scope 6 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n         _9 = _8 as *mut u32 (PtrToPtr);  // scope 11 at $SRC_DIR/core/src/ptr/mut_ptr.rs:LL:COL\n-        StorageLive(_13);                // scope 13 at $SRC_DIR/core/src/ptr/mut_ptr.rs:LL:COL\n-        _13 = _2 as isize (IntToInt);    // scope 13 at $SRC_DIR/core/src/ptr/mut_ptr.rs:LL:COL\n-        StorageLive(_14);                // scope 15 at $SRC_DIR/core/src/ptr/mut_ptr.rs:LL:COL\n-        StorageLive(_15);                // scope 15 at $SRC_DIR/core/src/ptr/mut_ptr.rs:LL:COL\n-        _15 = _9 as *const u32 (Pointer(MutToConstPointer)); // scope 15 at $SRC_DIR/core/src/ptr/mut_ptr.rs:LL:COL\n-        _14 = Offset(move _15, _13);     // scope 15 at $SRC_DIR/core/src/ptr/mut_ptr.rs:LL:COL\n-        StorageDead(_15);                // scope 15 at $SRC_DIR/core/src/ptr/mut_ptr.rs:LL:COL\n-        _7 = move _14 as *mut u32 (PtrToPtr); // scope 15 at $SRC_DIR/core/src/ptr/mut_ptr.rs:LL:COL\n-        StorageDead(_14);                // scope 15 at $SRC_DIR/core/src/ptr/mut_ptr.rs:LL:COL\n-        StorageDead(_13);                // scope 13 at $SRC_DIR/core/src/ptr/mut_ptr.rs:LL:COL\n+        _7 = Offset(_9, _2);             // scope 13 at $SRC_DIR/core/src/ptr/mut_ptr.rs:LL:COL\n         StorageDead(_9);                 // scope 6 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n         StorageDead(_12);                // scope 3 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n         StorageDead(_11);                // scope 3 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n```\nhttps://github.com/rust-lang/rust/pull/110837/commits/1c1c8e442add0f46905a57a25a6cba52b8b0c54d#diff-a841b6a4538657add3f39bc895744331453d0625e7aace128b1f604f0b63c8fdR80", "tree": {"sha": "e0aac28106852b0318fbde208ffdfa8bd95e2506", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e0aac28106852b0318fbde208ffdfa8bd95e2506"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/43a78029b4f4d92978b8fde0a677ea300b113c41", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/43a78029b4f4d92978b8fde0a677ea300b113c41", "html_url": "https://github.com/rust-lang/rust/commit/43a78029b4f4d92978b8fde0a677ea300b113c41", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/43a78029b4f4d92978b8fde0a677ea300b113c41/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2fce2290865f012391b8f3e581c3852a248031fa", "url": "https://api.github.com/repos/rust-lang/rust/commits/2fce2290865f012391b8f3e581c3852a248031fa", "html_url": "https://github.com/rust-lang/rust/commit/2fce2290865f012391b8f3e581c3852a248031fa"}, {"sha": "e1da77c76d63f442acadcfbda4e42701887d6324", "url": "https://api.github.com/repos/rust-lang/rust/commits/e1da77c76d63f442acadcfbda4e42701887d6324", "html_url": "https://github.com/rust-lang/rust/commit/e1da77c76d63f442acadcfbda4e42701887d6324"}], "stats": {"total": 414, "additions": 401, "deletions": 13}, "files": [{"sha": "64452472eeca45f82c6c2bf5a6f4b28db2f2577e", "filename": "compiler/rustc_codegen_ssa/src/mir/rvalue.rs", "status": "modified", "additions": 9, "deletions": 2, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/43a78029b4f4d92978b8fde0a677ea300b113c41/compiler%2Frustc_codegen_ssa%2Fsrc%2Fmir%2Frvalue.rs", "raw_url": "https://github.com/rust-lang/rust/raw/43a78029b4f4d92978b8fde0a677ea300b113c41/compiler%2Frustc_codegen_ssa%2Fsrc%2Fmir%2Frvalue.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fmir%2Frvalue.rs?ref=43a78029b4f4d92978b8fde0a677ea300b113c41", "patch": "@@ -819,8 +819,15 @@ impl<'a, 'tcx, Bx: BuilderMethods<'a, 'tcx>> FunctionCx<'a, 'tcx, Bx> {\n                     .builtin_deref(true)\n                     .unwrap_or_else(|| bug!(\"deref of non-pointer {:?}\", input_ty))\n                     .ty;\n-                let llty = bx.cx().backend_type(bx.cx().layout_of(pointee_type));\n-                bx.inbounds_gep(llty, lhs, &[rhs])\n+                let pointee_layout = bx.cx().layout_of(pointee_type);\n+                if pointee_layout.is_zst() {\n+                    // `Offset` works in terms of the size of pointee,\n+                    // so offsetting a pointer to ZST is a noop.\n+                    lhs\n+                } else {\n+                    let llty = bx.cx().backend_type(pointee_layout);\n+                    bx.inbounds_gep(llty, lhs, &[rhs])\n+                }\n             }\n             mir::BinOp::Shl => common::build_unchecked_lshift(bx, lhs, rhs),\n             mir::BinOp::Shr => common::build_unchecked_rshift(bx, input_ty, lhs, rhs),"}, {"sha": "d505d8b8e0b30ba0b7dd92f8faed485878268003", "filename": "compiler/rustc_hir_analysis/src/check/intrinsic.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/43a78029b4f4d92978b8fde0a677ea300b113c41/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fintrinsic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/43a78029b4f4d92978b8fde0a677ea300b113c41/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fintrinsic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fintrinsic.rs?ref=43a78029b4f4d92978b8fde0a677ea300b113c41", "patch": "@@ -215,7 +215,8 @@ pub fn check_intrinsic_type(tcx: TyCtxt<'_>, it: &hir::ForeignItem<'_>) {\n \n             sym::type_name => (1, Vec::new(), tcx.mk_static_str()),\n             sym::type_id => (1, Vec::new(), tcx.types.u64),\n-            sym::offset | sym::arith_offset => (\n+            sym::offset => (2, vec![param(0), param(1)], param(0)),\n+            sym::arith_offset => (\n                 1,\n                 vec![\n                     tcx.mk_ptr(ty::TypeAndMut { ty: param(0), mutbl: hir::Mutability::Not }),"}, {"sha": "b14c801f2fb72aea1c834ed1ae88f7daa5123996", "filename": "library/core/src/intrinsics.rs", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/43a78029b4f4d92978b8fde0a677ea300b113c41/library%2Fcore%2Fsrc%2Fintrinsics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/43a78029b4f4d92978b8fde0a677ea300b113c41/library%2Fcore%2Fsrc%2Fintrinsics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fintrinsics.rs?ref=43a78029b4f4d92978b8fde0a677ea300b113c41", "patch": "@@ -1413,6 +1413,10 @@ extern \"rust-intrinsic\" {\n     /// This is implemented as an intrinsic to avoid converting to and from an\n     /// integer, since the conversion would throw away aliasing information.\n     ///\n+    /// This can only be used with `Ptr` as a raw pointer type (`*mut` or `*const`)\n+    /// to a `Sized` pointee and with `Delta` as `usize` or `isize`.  Any other\n+    /// instantiations may arbitrarily misbehave, and that's *not* a compiler bug.\n+    ///\n     /// # Safety\n     ///\n     /// Both the starting and resulting pointer must be either in bounds or one\n@@ -1421,6 +1425,14 @@ extern \"rust-intrinsic\" {\n     /// returned value will result in undefined behavior.\n     ///\n     /// The stabilized version of this intrinsic is [`pointer::offset`].\n+    #[cfg(not(bootstrap))]\n+    #[must_use = \"returns a new pointer rather than modifying its argument\"]\n+    #[rustc_const_stable(feature = \"const_ptr_offset\", since = \"1.61.0\")]\n+    #[rustc_nounwind]\n+    pub fn offset<Ptr, Delta>(dst: Ptr, offset: Delta) -> Ptr;\n+\n+    /// The bootstrap version of this is more restricted.\n+    #[cfg(bootstrap)]\n     #[must_use = \"returns a new pointer rather than modifying its argument\"]\n     #[rustc_const_stable(feature = \"const_ptr_offset\", since = \"1.61.0\")]\n     #[rustc_nounwind]"}, {"sha": "585b648873a60130dc951fba3c15b809ad23daa2", "filename": "library/core/src/ptr/const_ptr.rs", "status": "modified", "additions": 9, "deletions": 1, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/43a78029b4f4d92978b8fde0a677ea300b113c41/library%2Fcore%2Fsrc%2Fptr%2Fconst_ptr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/43a78029b4f4d92978b8fde0a677ea300b113c41/library%2Fcore%2Fsrc%2Fptr%2Fconst_ptr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fptr%2Fconst_ptr.rs?ref=43a78029b4f4d92978b8fde0a677ea300b113c41", "patch": "@@ -916,8 +916,16 @@ impl<T: ?Sized> *const T {\n     where\n         T: Sized,\n     {\n+        #[cfg(bootstrap)]\n         // SAFETY: the caller must uphold the safety contract for `offset`.\n-        unsafe { self.offset(count as isize) }\n+        unsafe {\n+            self.offset(count as isize)\n+        }\n+        #[cfg(not(bootstrap))]\n+        // SAFETY: the caller must uphold the safety contract for `offset`.\n+        unsafe {\n+            intrinsics::offset(self, count)\n+        }\n     }\n \n     /// Calculates the offset from a pointer in bytes (convenience for `.byte_offset(count as isize)`)."}, {"sha": "c339ccb1b4dd0e2de79bbc00464782bee8cf44a1", "filename": "library/core/src/ptr/mut_ptr.rs", "status": "modified", "additions": 20, "deletions": 2, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/43a78029b4f4d92978b8fde0a677ea300b113c41/library%2Fcore%2Fsrc%2Fptr%2Fmut_ptr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/43a78029b4f4d92978b8fde0a677ea300b113c41/library%2Fcore%2Fsrc%2Fptr%2Fmut_ptr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fptr%2Fmut_ptr.rs?ref=43a78029b4f4d92978b8fde0a677ea300b113c41", "patch": "@@ -473,10 +473,20 @@ impl<T: ?Sized> *mut T {\n     where\n         T: Sized,\n     {\n+        #[cfg(bootstrap)]\n         // SAFETY: the caller must uphold the safety contract for `offset`.\n         // The obtained pointer is valid for writes since the caller must\n         // guarantee that it points to the same allocated object as `self`.\n-        unsafe { intrinsics::offset(self, count) as *mut T }\n+        unsafe {\n+            intrinsics::offset(self, count) as *mut T\n+        }\n+        #[cfg(not(bootstrap))]\n+        // SAFETY: the caller must uphold the safety contract for `offset`.\n+        // The obtained pointer is valid for writes since the caller must\n+        // guarantee that it points to the same allocated object as `self`.\n+        unsafe {\n+            intrinsics::offset(self, count)\n+        }\n     }\n \n     /// Calculates the offset from a pointer in bytes.\n@@ -1016,8 +1026,16 @@ impl<T: ?Sized> *mut T {\n     where\n         T: Sized,\n     {\n+        #[cfg(bootstrap)]\n+        // SAFETY: the caller must uphold the safety contract for `offset`.\n+        unsafe {\n+            self.offset(count as isize)\n+        }\n+        #[cfg(not(bootstrap))]\n         // SAFETY: the caller must uphold the safety contract for `offset`.\n-        unsafe { self.offset(count as isize) }\n+        unsafe {\n+            intrinsics::offset(self, count)\n+        }\n     }\n \n     /// Calculates the offset from a pointer in bytes (convenience for `.byte_offset(count as isize)`)."}, {"sha": "ea9bace6dd47fbafbf1c37b7dc042423e83cfada", "filename": "src/doc/unstable-book/src/language-features/intrinsics.md", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/43a78029b4f4d92978b8fde0a677ea300b113c41/src%2Fdoc%2Funstable-book%2Fsrc%2Flanguage-features%2Fintrinsics.md", "raw_url": "https://github.com/rust-lang/rust/raw/43a78029b4f4d92978b8fde0a677ea300b113c41/src%2Fdoc%2Funstable-book%2Fsrc%2Flanguage-features%2Fintrinsics.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Funstable-book%2Fsrc%2Flanguage-features%2Fintrinsics.md?ref=43a78029b4f4d92978b8fde0a677ea300b113c41", "patch": "@@ -22,7 +22,7 @@ via a declaration like\n extern \"rust-intrinsic\" {\n     fn transmute<T, U>(x: T) -> U;\n \n-    fn offset<T>(dst: *const T, offset: isize) -> *const T;\n+    fn arith_offset<T>(dst: *const T, offset: isize) -> *const T;\n }\n ```\n "}, {"sha": "7fc4f4498d6df1d913e1263de7eea493e89780e3", "filename": "tests/codegen/intrinsics/offset.rs", "status": "added", "additions": 34, "deletions": 0, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/43a78029b4f4d92978b8fde0a677ea300b113c41/tests%2Fcodegen%2Fintrinsics%2Foffset.rs", "raw_url": "https://github.com/rust-lang/rust/raw/43a78029b4f4d92978b8fde0a677ea300b113c41/tests%2Fcodegen%2Fintrinsics%2Foffset.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcodegen%2Fintrinsics%2Foffset.rs?ref=43a78029b4f4d92978b8fde0a677ea300b113c41", "patch": "@@ -0,0 +1,34 @@\n+// compile-flags: -O -C no-prepopulate-passes\n+// min-llvm-version: 15.0 (because we're using opaque pointers)\n+\n+#![crate_type = \"lib\"]\n+#![feature(core_intrinsics)]\n+\n+use std::intrinsics::offset;\n+\n+// CHECK-LABEL: ptr @offset_zst\n+// CHECK-SAME: (ptr noundef %p, [[SIZE:i[0-9]+]] noundef %d)\n+#[no_mangle]\n+pub unsafe fn offset_zst(p: *const (), d: usize) -> *const () {\n+    // CHECK-NOT: getelementptr\n+    // CHECK: ret ptr %p\n+    offset(p, d)\n+}\n+\n+// CHECK-LABEL: ptr @offset_isize\n+// CHECK-SAME: (ptr noundef %p, [[SIZE]] noundef %d)\n+#[no_mangle]\n+pub unsafe fn offset_isize(p: *const u32, d: isize) -> *const u32 {\n+    // CHECK: %[[R:.*]] = getelementptr inbounds i32, ptr %p, [[SIZE]] %d\n+    // CHECK-NEXT: ret ptr %[[R]]\n+    offset(p, d)\n+}\n+\n+// CHECK-LABEL: ptr @offset_usize\n+// CHECK-SAME: (ptr noundef %p, [[SIZE]] noundef %d)\n+#[no_mangle]\n+pub unsafe fn offset_usize(p: *const u64, d: usize) -> *const u64 {\n+    // CHECK: %[[R:.*]] = getelementptr inbounds i64, ptr %p, [[SIZE]] %d\n+    // CHECK-NEXT: ret ptr %[[R]]\n+    offset(p, d)\n+}"}, {"sha": "e4e228371e606ab5189cb490a5fa5cdb15760a8b", "filename": "tests/mir-opt/lower_intrinsics.ptr_offset.LowerIntrinsics.diff", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/43a78029b4f4d92978b8fde0a677ea300b113c41/tests%2Fmir-opt%2Flower_intrinsics.ptr_offset.LowerIntrinsics.diff", "raw_url": "https://github.com/rust-lang/rust/raw/43a78029b4f4d92978b8fde0a677ea300b113c41/tests%2Fmir-opt%2Flower_intrinsics.ptr_offset.LowerIntrinsics.diff", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Flower_intrinsics.ptr_offset.LowerIntrinsics.diff?ref=43a78029b4f4d92978b8fde0a677ea300b113c41", "patch": "@@ -13,10 +13,10 @@\n           _3 = _1;                         // scope 0 at $DIR/lower_intrinsics.rs:+1:30: +1:31\n           StorageLive(_4);                 // scope 0 at $DIR/lower_intrinsics.rs:+1:33: +1:34\n           _4 = _2;                         // scope 0 at $DIR/lower_intrinsics.rs:+1:33: +1:34\n--         _0 = offset::<i32>(move _3, move _4) -> [return: bb1, unwind unreachable]; // scope 0 at $DIR/lower_intrinsics.rs:+1:5: +1:35\n+-         _0 = offset::<*const i32, isize>(move _3, move _4) -> [return: bb1, unwind unreachable]; // scope 0 at $DIR/lower_intrinsics.rs:+1:5: +1:35\n -                                          // mir::Constant\n -                                          // + span: $DIR/lower_intrinsics.rs:140:5: 140:29\n--                                          // + literal: Const { ty: unsafe extern \"rust-intrinsic\" fn(*const i32, isize) -> *const i32 {offset::<i32>}, val: Value(<ZST>) }\n+-                                          // + literal: Const { ty: unsafe extern \"rust-intrinsic\" fn(*const i32, isize) -> *const i32 {offset::<*const i32, isize>}, val: Value(<ZST>) }\n +         _0 = Offset(move _3, move _4);   // scope 0 at $DIR/lower_intrinsics.rs:+1:5: +1:35\n +         goto -> bb1;                     // scope 0 at $DIR/lower_intrinsics.rs:+1:5: +1:35\n       }"}, {"sha": "44b45627607ef1e86b7891566e426b889753f8e4", "filename": "tests/mir-opt/pre-codegen/slice_index.rs", "status": "added", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/43a78029b4f4d92978b8fde0a677ea300b113c41/tests%2Fmir-opt%2Fpre-codegen%2Fslice_index.rs", "raw_url": "https://github.com/rust-lang/rust/raw/43a78029b4f4d92978b8fde0a677ea300b113c41/tests%2Fmir-opt%2Fpre-codegen%2Fslice_index.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Fpre-codegen%2Fslice_index.rs?ref=43a78029b4f4d92978b8fde0a677ea300b113c41", "patch": "@@ -0,0 +1,27 @@\n+// compile-flags: -O -C debuginfo=0 -Zmir-opt-level=2\n+// only-64bit\n+// ignore-debug\n+\n+#![crate_type = \"lib\"]\n+\n+use std::ops::Range;\n+\n+// EMIT_MIR slice_index.slice_index_usize.PreCodegen.after.mir\n+pub fn slice_index_usize(slice: &[u32], index: usize) -> u32 {\n+    slice[index]\n+}\n+\n+// EMIT_MIR slice_index.slice_get_mut_usize.PreCodegen.after.mir\n+pub fn slice_get_mut_usize(slice: &mut [u32], index: usize) -> Option<&mut u32> {\n+    slice.get_mut(index)\n+}\n+\n+// EMIT_MIR slice_index.slice_index_range.PreCodegen.after.mir\n+pub fn slice_index_range(slice: &[u32], index: Range<usize>) -> &[u32] {\n+    &slice[index]\n+}\n+\n+// EMIT_MIR slice_index.slice_get_unchecked_mut_range.PreCodegen.after.mir\n+pub unsafe fn slice_get_unchecked_mut_range(slice: &mut [u32], index: Range<usize>) -> &mut [u32] {\n+    slice.get_unchecked_mut(index)\n+}"}, {"sha": "715a1e3fcd4796b33916037ecce4cd383bff0647", "filename": "tests/mir-opt/pre-codegen/slice_index.slice_get_mut_usize.PreCodegen.after.mir", "status": "added", "additions": 105, "deletions": 0, "changes": 105, "blob_url": "https://github.com/rust-lang/rust/blob/43a78029b4f4d92978b8fde0a677ea300b113c41/tests%2Fmir-opt%2Fpre-codegen%2Fslice_index.slice_get_mut_usize.PreCodegen.after.mir", "raw_url": "https://github.com/rust-lang/rust/raw/43a78029b4f4d92978b8fde0a677ea300b113c41/tests%2Fmir-opt%2Fpre-codegen%2Fslice_index.slice_get_mut_usize.PreCodegen.after.mir", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Fpre-codegen%2Fslice_index.slice_get_mut_usize.PreCodegen.after.mir?ref=43a78029b4f4d92978b8fde0a677ea300b113c41", "patch": "@@ -0,0 +1,105 @@\n+// MIR for `slice_get_mut_usize` after PreCodegen\n+\n+fn slice_get_mut_usize(_1: &mut [u32], _2: usize) -> Option<&mut u32> {\n+    debug slice => _1;                   // in scope 0 at $DIR/slice_index.rs:+0:28: +0:33\n+    debug index => _2;                   // in scope 0 at $DIR/slice_index.rs:+0:47: +0:52\n+    let mut _0: std::option::Option<&mut u32>; // return place in scope 0 at $DIR/slice_index.rs:+0:64: +0:80\n+    scope 1 (inlined core::slice::<impl [u32]>::get_mut::<usize>) { // at $DIR/slice_index.rs:16:11: 16:25\n+        debug self => _1;                // in scope 1 at $SRC_DIR/core/src/slice/mod.rs:LL:COL\n+        debug index => _2;               // in scope 1 at $SRC_DIR/core/src/slice/mod.rs:LL:COL\n+        scope 2 (inlined <usize as SliceIndex<[u32]>>::get_mut) { // at $SRC_DIR/core/src/slice/mod.rs:LL:COL\n+            debug self => _2;            // in scope 2 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+            debug slice => _1;           // in scope 2 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+            let mut _3: bool;            // in scope 2 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+            let mut _4: usize;           // in scope 2 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+            let mut _5: &[u32];          // in scope 2 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+            let mut _6: &mut u32;        // in scope 2 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+            let mut _7: *mut u32;        // in scope 2 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+            let mut _8: *mut [u32];      // in scope 2 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+            scope 3 {\n+                scope 4 (inlined <usize as SliceIndex<[u32]>>::get_unchecked_mut) { // at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+                    debug self => _2;    // in scope 4 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+                    debug slice => _8;   // in scope 4 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+                    let mut _9: *mut u32; // in scope 4 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+                    let mut _10: usize;  // in scope 4 at $SRC_DIR/core/src/intrinsics.rs:LL:COL\n+                    let mut _11: *mut [u32]; // in scope 4 at $SRC_DIR/core/src/intrinsics.rs:LL:COL\n+                    scope 5 {\n+                        debug this => _2; // in scope 5 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+                        scope 6 {\n+                            scope 7 (inlined <usize as SliceIndex<[T]>>::get_unchecked_mut::runtime::<u32>) { // at $SRC_DIR/core/src/intrinsics.rs:LL:COL\n+                                debug this => _10; // in scope 7 at $SRC_DIR/core/src/intrinsics.rs:LL:COL\n+                                debug slice => _11; // in scope 7 at $SRC_DIR/core/src/intrinsics.rs:LL:COL\n+                                scope 8 (inlined ptr::mut_ptr::<impl *mut [u32]>::len) { // at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+                                    debug self => _11; // in scope 8 at $SRC_DIR/core/src/ptr/mut_ptr.rs:LL:COL\n+                                    let mut _12: *const [u32]; // in scope 8 at $SRC_DIR/core/src/ptr/mut_ptr.rs:LL:COL\n+                                    scope 9 (inlined std::ptr::metadata::<[u32]>) { // at $SRC_DIR/core/src/ptr/mut_ptr.rs:LL:COL\n+                                        debug ptr => _12; // in scope 9 at $SRC_DIR/core/src/ptr/metadata.rs:LL:COL\n+                                        scope 10 {\n+                                        }\n+                                    }\n+                                }\n+                            }\n+                            scope 11 (inlined ptr::mut_ptr::<impl *mut [u32]>::as_mut_ptr) { // at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+                                debug self => _8; // in scope 11 at $SRC_DIR/core/src/ptr/mut_ptr.rs:LL:COL\n+                            }\n+                            scope 12 (inlined ptr::mut_ptr::<impl *mut u32>::add) { // at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+                                debug self => _9; // in scope 12 at $SRC_DIR/core/src/ptr/mut_ptr.rs:LL:COL\n+                                debug count => _2; // in scope 12 at $SRC_DIR/core/src/ptr/mut_ptr.rs:LL:COL\n+                                scope 13 {\n+                                }\n+                            }\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+    }\n+\n+    bb0: {\n+        StorageLive(_6);                 // scope 1 at $SRC_DIR/core/src/slice/mod.rs:LL:COL\n+        StorageLive(_3);                 // scope 2 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        StorageLive(_4);                 // scope 2 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        StorageLive(_5);                 // scope 2 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        _5 = &(*_1);                     // scope 2 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        _4 = Len((*_5));                 // scope 2 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        StorageDead(_5);                 // scope 2 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        _3 = Lt(_2, move _4);            // scope 2 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        StorageDead(_4);                 // scope 2 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        switchInt(move _3) -> [0: bb2, otherwise: bb1]; // scope 2 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+    }\n+\n+    bb1: {\n+        StorageLive(_7);                 // scope 3 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        StorageLive(_8);                 // scope 3 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        _8 = &raw mut (*_1);             // scope 3 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        StorageLive(_10);                // scope 3 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        StorageLive(_11);                // scope 3 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        StorageLive(_12);                // scope 3 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        StorageLive(_9);                 // scope 6 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        _9 = _8 as *mut u32 (PtrToPtr);  // scope 11 at $SRC_DIR/core/src/ptr/mut_ptr.rs:LL:COL\n+        _7 = Offset(_9, _2);             // scope 13 at $SRC_DIR/core/src/ptr/mut_ptr.rs:LL:COL\n+        StorageDead(_9);                 // scope 6 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        StorageDead(_12);                // scope 3 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        StorageDead(_11);                // scope 3 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        StorageDead(_10);                // scope 3 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        StorageDead(_8);                 // scope 3 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        _6 = &mut (*_7);                 // scope 3 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        _0 = Option::<&mut u32>::Some(_6); // scope 3 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        StorageDead(_7);                 // scope 2 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        goto -> bb3;                     // scope 2 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+    }\n+\n+    bb2: {\n+        _0 = const Option::<&mut u32>::None; // scope 2 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+                                         // mir::Constant\n+                                         // + span: no-location\n+                                         // + literal: Const { ty: Option<&mut u32>, val: Value(Scalar(0x0000000000000000)) }\n+        goto -> bb3;                     // scope 2 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+    }\n+\n+    bb3: {\n+        StorageDead(_3);                 // scope 2 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        StorageDead(_6);                 // scope 1 at $SRC_DIR/core/src/slice/mod.rs:LL:COL\n+        return;                          // scope 0 at $DIR/slice_index.rs:+2:2: +2:2\n+    }\n+}"}, {"sha": "ea0a44cf3bf79ff60b8961440cb2f8941a1d49a2", "filename": "tests/mir-opt/pre-codegen/slice_index.slice_get_unchecked_mut_range.PreCodegen.after.mir", "status": "added", "additions": 134, "deletions": 0, "changes": 134, "blob_url": "https://github.com/rust-lang/rust/blob/43a78029b4f4d92978b8fde0a677ea300b113c41/tests%2Fmir-opt%2Fpre-codegen%2Fslice_index.slice_get_unchecked_mut_range.PreCodegen.after.mir", "raw_url": "https://github.com/rust-lang/rust/raw/43a78029b4f4d92978b8fde0a677ea300b113c41/tests%2Fmir-opt%2Fpre-codegen%2Fslice_index.slice_get_unchecked_mut_range.PreCodegen.after.mir", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Fpre-codegen%2Fslice_index.slice_get_unchecked_mut_range.PreCodegen.after.mir?ref=43a78029b4f4d92978b8fde0a677ea300b113c41", "patch": "@@ -0,0 +1,134 @@\n+// MIR for `slice_get_unchecked_mut_range` after PreCodegen\n+\n+fn slice_get_unchecked_mut_range(_1: &mut [u32], _2: std::ops::Range<usize>) -> &mut [u32] {\n+    debug slice => _1;                   // in scope 0 at $DIR/slice_index.rs:+0:45: +0:50\n+    debug index => _2;                   // in scope 0 at $DIR/slice_index.rs:+0:64: +0:69\n+    let mut _0: &mut [u32];              // return place in scope 0 at $DIR/slice_index.rs:+1:5: +1:35\n+    scope 1 (inlined core::slice::<impl [u32]>::get_unchecked_mut::<std::ops::Range<usize>>) { // at $DIR/slice_index.rs:26:11: 26:35\n+        debug self => _1;                // in scope 1 at $SRC_DIR/core/src/slice/mod.rs:LL:COL\n+        debug index => _2;               // in scope 1 at $SRC_DIR/core/src/slice/mod.rs:LL:COL\n+        let mut _3: *mut [u32];          // in scope 1 at $SRC_DIR/core/src/slice/mod.rs:LL:COL\n+        let mut _4: *mut [u32];          // in scope 1 at $SRC_DIR/core/src/slice/mod.rs:LL:COL\n+        scope 2 {\n+            scope 3 (inlined <std::ops::Range<usize> as SliceIndex<[u32]>>::get_unchecked_mut) { // at $SRC_DIR/core/src/slice/mod.rs:LL:COL\n+                debug self => _2;        // in scope 3 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+                debug slice => _4;       // in scope 3 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+                let _5: std::ops::Range<usize>; // in scope 3 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+                let mut _7: usize;       // in scope 3 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+                let mut _8: usize;       // in scope 3 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+                let mut _9: *mut u32;    // in scope 3 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+                let mut _10: *mut u32;   // in scope 3 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+                let mut _11: usize;      // in scope 3 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+                let mut _12: usize;      // in scope 3 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+                let mut _13: std::ops::Range<usize>; // in scope 3 at $SRC_DIR/core/src/intrinsics.rs:LL:COL\n+                let mut _14: *mut [u32]; // in scope 3 at $SRC_DIR/core/src/intrinsics.rs:LL:COL\n+                scope 4 {\n+                    debug this => _5;    // in scope 4 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+                    scope 5 {\n+                        let _6: usize;   // in scope 5 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+                        scope 6 {\n+                            debug new_len => _6; // in scope 6 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+                            scope 11 (inlined ptr::mut_ptr::<impl *mut [u32]>::as_mut_ptr) { // at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+                                debug self => _4; // in scope 11 at $SRC_DIR/core/src/ptr/mut_ptr.rs:LL:COL\n+                            }\n+                            scope 12 (inlined ptr::mut_ptr::<impl *mut u32>::add) { // at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+                                debug self => _10; // in scope 12 at $SRC_DIR/core/src/ptr/mut_ptr.rs:LL:COL\n+                                debug count => _11; // in scope 12 at $SRC_DIR/core/src/ptr/mut_ptr.rs:LL:COL\n+                                scope 13 {\n+                                }\n+                            }\n+                            scope 14 (inlined slice_from_raw_parts_mut::<u32>) { // at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+                                debug data => _9; // in scope 14 at $SRC_DIR/core/src/ptr/mod.rs:LL:COL\n+                                debug len => _12; // in scope 14 at $SRC_DIR/core/src/ptr/mod.rs:LL:COL\n+                                let mut _16: *mut (); // in scope 14 at $SRC_DIR/core/src/ptr/mod.rs:LL:COL\n+                                scope 15 (inlined ptr::mut_ptr::<impl *mut u32>::cast::<()>) { // at $SRC_DIR/core/src/ptr/mod.rs:LL:COL\n+                                    debug self => _9; // in scope 15 at $SRC_DIR/core/src/ptr/mut_ptr.rs:LL:COL\n+                                }\n+                                scope 16 (inlined std::ptr::from_raw_parts_mut::<[u32]>) { // at $SRC_DIR/core/src/ptr/mod.rs:LL:COL\n+                                    debug data_address => _16; // in scope 16 at $SRC_DIR/core/src/ptr/metadata.rs:LL:COL\n+                                    debug metadata => _12; // in scope 16 at $SRC_DIR/core/src/ptr/metadata.rs:LL:COL\n+                                    let mut _17: std::ptr::metadata::PtrRepr<[u32]>; // in scope 16 at $SRC_DIR/core/src/ptr/metadata.rs:LL:COL\n+                                    let mut _18: std::ptr::metadata::PtrComponents<[u32]>; // in scope 16 at $SRC_DIR/core/src/ptr/metadata.rs:LL:COL\n+                                    let mut _19: *const (); // in scope 16 at $SRC_DIR/core/src/ptr/metadata.rs:LL:COL\n+                                    scope 17 {\n+                                    }\n+                                }\n+                            }\n+                        }\n+                        scope 7 (inlined <std::ops::Range<usize> as SliceIndex<[T]>>::get_unchecked_mut::runtime::<u32>) { // at $SRC_DIR/core/src/intrinsics.rs:LL:COL\n+                            debug this => _13; // in scope 7 at $SRC_DIR/core/src/intrinsics.rs:LL:COL\n+                            debug slice => _14; // in scope 7 at $SRC_DIR/core/src/intrinsics.rs:LL:COL\n+                            scope 8 (inlined ptr::mut_ptr::<impl *mut [u32]>::len) { // at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+                                debug self => _14; // in scope 8 at $SRC_DIR/core/src/ptr/mut_ptr.rs:LL:COL\n+                                let mut _15: *const [u32]; // in scope 8 at $SRC_DIR/core/src/ptr/mut_ptr.rs:LL:COL\n+                                scope 9 (inlined std::ptr::metadata::<[u32]>) { // at $SRC_DIR/core/src/ptr/mut_ptr.rs:LL:COL\n+                                    debug ptr => _15; // in scope 9 at $SRC_DIR/core/src/ptr/metadata.rs:LL:COL\n+                                    scope 10 {\n+                                    }\n+                                }\n+                            }\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+    }\n+\n+    bb0: {\n+        StorageLive(_3);                 // scope 2 at $SRC_DIR/core/src/slice/mod.rs:LL:COL\n+        StorageLive(_4);                 // scope 2 at $SRC_DIR/core/src/slice/mod.rs:LL:COL\n+        _4 = &raw mut (*_1);             // scope 2 at $SRC_DIR/core/src/slice/mod.rs:LL:COL\n+        StorageLive(_5);                 // scope 2 at $SRC_DIR/core/src/slice/mod.rs:LL:COL\n+        StorageLive(_13);                // scope 2 at $SRC_DIR/core/src/slice/mod.rs:LL:COL\n+        StorageLive(_14);                // scope 2 at $SRC_DIR/core/src/slice/mod.rs:LL:COL\n+        StorageLive(_15);                // scope 2 at $SRC_DIR/core/src/slice/mod.rs:LL:COL\n+        StorageLive(_6);                 // scope 5 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        StorageLive(_7);                 // scope 5 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        _7 = (_2.1: usize);              // scope 5 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        StorageLive(_8);                 // scope 5 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        _8 = (_2.0: usize);              // scope 5 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        _6 = unchecked_sub::<usize>(move _7, move _8) -> [return: bb1, unwind unreachable]; // scope 5 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+                                         // mir::Constant\n+                                         // + span: $SRC_DIR/core/src/slice/index.rs:LL:COL\n+                                         // + literal: Const { ty: unsafe extern \"rust-intrinsic\" fn(usize, usize) -> usize {unchecked_sub::<usize>}, val: Value(<ZST>) }\n+    }\n+\n+    bb1: {\n+        StorageDead(_8);                 // scope 5 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        StorageDead(_7);                 // scope 5 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        StorageLive(_9);                 // scope 6 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        StorageLive(_10);                // scope 6 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        _10 = _4 as *mut u32 (PtrToPtr); // scope 11 at $SRC_DIR/core/src/ptr/mut_ptr.rs:LL:COL\n+        StorageLive(_11);                // scope 6 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        _11 = (_2.0: usize);             // scope 6 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        _9 = Offset(_10, _11);           // scope 13 at $SRC_DIR/core/src/ptr/mut_ptr.rs:LL:COL\n+        StorageDead(_11);                // scope 6 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        StorageDead(_10);                // scope 6 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        StorageLive(_12);                // scope 6 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        _12 = _6;                        // scope 6 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        StorageLive(_16);                // scope 14 at $SRC_DIR/core/src/ptr/mod.rs:LL:COL\n+        _16 = _9 as *mut () (PtrToPtr);  // scope 15 at $SRC_DIR/core/src/ptr/mut_ptr.rs:LL:COL\n+        StorageLive(_17);                // scope 17 at $SRC_DIR/core/src/ptr/metadata.rs:LL:COL\n+        StorageLive(_18);                // scope 17 at $SRC_DIR/core/src/ptr/metadata.rs:LL:COL\n+        StorageLive(_19);                // scope 17 at $SRC_DIR/core/src/ptr/metadata.rs:LL:COL\n+        _19 = _16 as *const () (Pointer(MutToConstPointer)); // scope 17 at $SRC_DIR/core/src/ptr/metadata.rs:LL:COL\n+        _18 = ptr::metadata::PtrComponents::<[u32]> { data_address: move _19, metadata: _12 }; // scope 17 at $SRC_DIR/core/src/ptr/metadata.rs:LL:COL\n+        StorageDead(_19);                // scope 17 at $SRC_DIR/core/src/ptr/metadata.rs:LL:COL\n+        _17 = ptr::metadata::PtrRepr::<[u32]> { const_ptr: move _18 }; // scope 17 at $SRC_DIR/core/src/ptr/metadata.rs:LL:COL\n+        StorageDead(_18);                // scope 17 at $SRC_DIR/core/src/ptr/metadata.rs:LL:COL\n+        _3 = (_17.1: *mut [u32]);        // scope 17 at $SRC_DIR/core/src/ptr/metadata.rs:LL:COL\n+        StorageDead(_17);                // scope 16 at $SRC_DIR/core/src/ptr/metadata.rs:LL:COL\n+        StorageDead(_16);                // scope 14 at $SRC_DIR/core/src/ptr/mod.rs:LL:COL\n+        StorageDead(_12);                // scope 6 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        StorageDead(_9);                 // scope 6 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        StorageDead(_6);                 // scope 5 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        StorageDead(_15);                // scope 2 at $SRC_DIR/core/src/slice/mod.rs:LL:COL\n+        StorageDead(_14);                // scope 2 at $SRC_DIR/core/src/slice/mod.rs:LL:COL\n+        StorageDead(_13);                // scope 2 at $SRC_DIR/core/src/slice/mod.rs:LL:COL\n+        StorageDead(_5);                 // scope 2 at $SRC_DIR/core/src/slice/mod.rs:LL:COL\n+        StorageDead(_4);                 // scope 2 at $SRC_DIR/core/src/slice/mod.rs:LL:COL\n+        _0 = &mut (*_3);                 // scope 2 at $SRC_DIR/core/src/slice/mod.rs:LL:COL\n+        StorageDead(_3);                 // scope 1 at $SRC_DIR/core/src/slice/mod.rs:LL:COL\n+        return;                          // scope 0 at $DIR/slice_index.rs:+2:2: +2:2\n+    }\n+}"}, {"sha": "35dd973b55fa1bacc41919de94c047a8f961c909", "filename": "tests/mir-opt/pre-codegen/slice_index.slice_index_range.PreCodegen.after.mir", "status": "added", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/43a78029b4f4d92978b8fde0a677ea300b113c41/tests%2Fmir-opt%2Fpre-codegen%2Fslice_index.slice_index_range.PreCodegen.after.mir", "raw_url": "https://github.com/rust-lang/rust/raw/43a78029b4f4d92978b8fde0a677ea300b113c41/tests%2Fmir-opt%2Fpre-codegen%2Fslice_index.slice_index_range.PreCodegen.after.mir", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Fpre-codegen%2Fslice_index.slice_index_range.PreCodegen.after.mir?ref=43a78029b4f4d92978b8fde0a677ea300b113c41", "patch": "@@ -0,0 +1,26 @@\n+// MIR for `slice_index_range` after PreCodegen\n+\n+fn slice_index_range(_1: &[u32], _2: std::ops::Range<usize>) -> &[u32] {\n+    debug slice => _1;                   // in scope 0 at $DIR/slice_index.rs:+0:26: +0:31\n+    debug index => _2;                   // in scope 0 at $DIR/slice_index.rs:+0:41: +0:46\n+    let mut _0: &[u32];                  // return place in scope 0 at $DIR/slice_index.rs:+1:5: +1:18\n+    let _3: &[u32];                      // in scope 0 at $DIR/slice_index.rs:+1:6: +1:18\n+    scope 1 (inlined #[track_caller] core::slice::index::<impl Index<std::ops::Range<usize>> for [u32]>::index) { // at $DIR/slice_index.rs:21:6: 21:18\n+        debug self => _1;                // in scope 1 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+        debug index => _2;               // in scope 1 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+    }\n+\n+    bb0: {\n+        StorageLive(_3);                 // scope 0 at $DIR/slice_index.rs:+1:6: +1:18\n+        _3 = <std::ops::Range<usize> as SliceIndex<[u32]>>::index(move _2, _1) -> bb1; // scope 1 at $SRC_DIR/core/src/slice/index.rs:LL:COL\n+                                         // mir::Constant\n+                                         // + span: $SRC_DIR/core/src/slice/index.rs:LL:COL\n+                                         // + literal: Const { ty: for<'a> fn(std::ops::Range<usize>, &'a [u32]) -> &'a <std::ops::Range<usize> as SliceIndex<[u32]>>::Output {<std::ops::Range<usize> as SliceIndex<[u32]>>::index}, val: Value(<ZST>) }\n+    }\n+\n+    bb1: {\n+        _0 = _3;                         // scope 0 at $DIR/slice_index.rs:+1:5: +1:18\n+        StorageDead(_3);                 // scope 0 at $DIR/slice_index.rs:+2:1: +2:2\n+        return;                          // scope 0 at $DIR/slice_index.rs:+2:2: +2:2\n+    }\n+}"}, {"sha": "6cc0ee0570bb595f91a31aa13d0c16b69255edbd", "filename": "tests/mir-opt/pre-codegen/slice_index.slice_index_usize.PreCodegen.after.mir", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/43a78029b4f4d92978b8fde0a677ea300b113c41/tests%2Fmir-opt%2Fpre-codegen%2Fslice_index.slice_index_usize.PreCodegen.after.mir", "raw_url": "https://github.com/rust-lang/rust/raw/43a78029b4f4d92978b8fde0a677ea300b113c41/tests%2Fmir-opt%2Fpre-codegen%2Fslice_index.slice_index_usize.PreCodegen.after.mir", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Fpre-codegen%2Fslice_index.slice_index_usize.PreCodegen.after.mir?ref=43a78029b4f4d92978b8fde0a677ea300b113c41", "patch": "@@ -0,0 +1,20 @@\n+// MIR for `slice_index_usize` after PreCodegen\n+\n+fn slice_index_usize(_1: &[u32], _2: usize) -> u32 {\n+    debug slice => _1;                   // in scope 0 at $DIR/slice_index.rs:+0:26: +0:31\n+    debug index => _2;                   // in scope 0 at $DIR/slice_index.rs:+0:41: +0:46\n+    let mut _0: u32;                     // return place in scope 0 at $DIR/slice_index.rs:+0:58: +0:61\n+    let mut _3: usize;                   // in scope 0 at $DIR/slice_index.rs:+1:5: +1:17\n+    let mut _4: bool;                    // in scope 0 at $DIR/slice_index.rs:+1:5: +1:17\n+\n+    bb0: {\n+        _3 = Len((*_1));                 // scope 0 at $DIR/slice_index.rs:+1:5: +1:17\n+        _4 = Lt(_2, _3);                 // scope 0 at $DIR/slice_index.rs:+1:5: +1:17\n+        assert(move _4, \"index out of bounds: the length is {} but the index is {}\", move _3, _2) -> bb1; // scope 0 at $DIR/slice_index.rs:+1:5: +1:17\n+    }\n+\n+    bb1: {\n+        _0 = (*_1)[_2];                  // scope 0 at $DIR/slice_index.rs:+1:5: +1:17\n+        return;                          // scope 0 at $DIR/slice_index.rs:+2:2: +2:2\n+    }\n+}"}, {"sha": "817cfb0acf90eb69303b23170fed66a8bb11b9fb", "filename": "tests/ui/const-ptr/forbidden_slices.stderr", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/43a78029b4f4d92978b8fde0a677ea300b113c41/tests%2Fui%2Fconst-ptr%2Fforbidden_slices.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/43a78029b4f4d92978b8fde0a677ea300b113c41/tests%2Fui%2Fconst-ptr%2Fforbidden_slices.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fconst-ptr%2Fforbidden_slices.stderr?ref=43a78029b4f4d92978b8fde0a677ea300b113c41", "patch": "@@ -131,8 +131,6 @@ error[E0080]: could not evaluate static initializer\n    |\n    = note: out-of-bounds pointer arithmetic: allocN has size 4, so pointer to 8 bytes starting at offset 0 is out-of-bounds\n    |\n-note: inside `ptr::const_ptr::<impl *const u32>::offset`\n-  --> $SRC_DIR/core/src/ptr/const_ptr.rs:LL:COL\n note: inside `ptr::const_ptr::<impl *const u32>::add`\n   --> $SRC_DIR/core/src/ptr/const_ptr.rs:LL:COL\n note: inside `R2`\n@@ -195,8 +193,6 @@ error[E0080]: could not evaluate static initializer\n    |\n    = note: out-of-bounds pointer arithmetic: allocN has size 8, so pointer to 8 bytes starting at offset 1 is out-of-bounds\n    |\n-note: inside `ptr::const_ptr::<impl *const u64>::offset`\n-  --> $SRC_DIR/core/src/ptr/const_ptr.rs:LL:COL\n note: inside `ptr::const_ptr::<impl *const u64>::add`\n   --> $SRC_DIR/core/src/ptr/const_ptr.rs:LL:COL\n note: inside `R8`"}]}