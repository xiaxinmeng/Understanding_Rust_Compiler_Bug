{"sha": "aaeb7605c9aeb09374563ac7a427dfbd7d1f7892", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFhZWI3NjA1YzlhZWIwOTM3NDU2M2FjN2E0MjdkZmJkN2QxZjc4OTI=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-10-02T17:11:38Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-10-02T17:11:38Z"}, "message": "auto merge of #9670 : luisbg/rust/strftime, r=alexcrichton", "tree": {"sha": "23c9ce44aa48982d5e14a8df0b9b89c6b63ee521", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/23c9ce44aa48982d5e14a8df0b9b89c6b63ee521"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/aaeb7605c9aeb09374563ac7a427dfbd7d1f7892", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/aaeb7605c9aeb09374563ac7a427dfbd7d1f7892", "html_url": "https://github.com/rust-lang/rust/commit/aaeb7605c9aeb09374563ac7a427dfbd7d1f7892", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/aaeb7605c9aeb09374563ac7a427dfbd7d1f7892/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c44826fdcd036982b955407677c5ec4ce1f834ce", "url": "https://api.github.com/repos/rust-lang/rust/commits/c44826fdcd036982b955407677c5ec4ce1f834ce", "html_url": "https://github.com/rust-lang/rust/commit/c44826fdcd036982b955407677c5ec4ce1f834ce"}, {"sha": "1005b7976bde4b8d42ec2e1d924015b754567401", "url": "https://api.github.com/repos/rust-lang/rust/commits/1005b7976bde4b8d42ec2e1d924015b754567401", "html_url": "https://github.com/rust-lang/rust/commit/1005b7976bde4b8d42ec2e1d924015b754567401"}], "stats": {"total": 69, "additions": 61, "deletions": 8}, "files": [{"sha": "798113167d976543aaa753ccb11685333438b9a1", "filename": "src/libextra/time.rs", "status": "modified", "additions": 61, "deletions": 8, "changes": 69, "blob_url": "https://github.com/rust-lang/rust/blob/aaeb7605c9aeb09374563ac7a427dfbd7d1f7892/src%2Flibextra%2Ftime.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aaeb7605c9aeb09374563ac7a427dfbd7d1f7892/src%2Flibextra%2Ftime.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibextra%2Ftime.rs?ref=aaeb7605c9aeb09374563ac7a427dfbd7d1f7892", "patch": "@@ -734,6 +734,59 @@ fn do_strptime(s: &str, format: &str) -> Result<Tm, ~str> {\n }\n \n fn do_strftime(format: &str, tm: &Tm) -> ~str {\n+    fn days_in_year(year: int) -> i32 {\n+        if ((year % 4 == 0) && ((year % 100 != 0) || (year % 400 == 0))) {\n+            366    /* Days in a leap year */\n+        } else {\n+            365    /* Days in a non-leap year */\n+        }\n+    }\n+\n+    fn iso_week_days(yday: i32, wday: i32) -> int {\n+        /* The number of days from the first day of the first ISO week of this\n+        * year to the year day YDAY with week day WDAY.\n+        * ISO weeks start on Monday. The first ISO week has the year's first\n+        * Thursday.\n+        * YDAY may be as small as yday_minimum.\n+        */\n+        let yday: int = yday as int;\n+        let wday: int = wday as int;\n+        let iso_week_start_wday: int = 1;                     /* Monday */\n+        let iso_week1_wday: int = 4;                          /* Thursday */\n+        let yday_minimum: int = 366;\n+        /* Add enough to the first operand of % to make it nonnegative. */\n+        let big_enough_multiple_of_7: int = (yday_minimum / 7 + 2) * 7;\n+\n+        yday - (yday - wday + iso_week1_wday + big_enough_multiple_of_7) % 7\n+            + iso_week1_wday - iso_week_start_wday\n+    }\n+\n+    fn iso_week(ch:char, tm: &Tm) -> ~str {\n+        let mut year: int = tm.tm_year as int + 1900;\n+        let mut days: int = iso_week_days (tm.tm_yday, tm.tm_wday);\n+\n+        if (days < 0) {\n+            /* This ISO week belongs to the previous year. */\n+            year -= 1;\n+            days = iso_week_days (tm.tm_yday + (days_in_year(year)), tm.tm_wday);\n+        } else {\n+            let d: int = iso_week_days (tm.tm_yday - (days_in_year(year)),\n+                                        tm.tm_wday);\n+            if (0 <= d) {\n+                /* This ISO week belongs to the next year. */\n+                year += 1;\n+                days = d;\n+            }\n+        }\n+\n+        match ch {\n+            'G' => format!(\"{}\", year),\n+            'g' => format!(\"{:02d}\", (year % 100 + 100) % 100),\n+            'V' => format!(\"{:02d}\", days / 7 + 1),\n+            _ => ~\"\"\n+        }\n+    }\n+\n     fn parse_type(ch: char, tm: &Tm) -> ~str {\n         //FIXME (#2350): Implement missing types.\n       let die = || format!(\"strftime: can't understand this format {} \", ch);\n@@ -812,8 +865,8 @@ fn do_strftime(format: &str, tm: &Tm) -> ~str {\n                 parse_type('m', tm),\n                 parse_type('d', tm))\n           }\n-          //'G' {}\n-          //'g' {}\n+          'G' => iso_week('G', tm),\n+          'g' => iso_week('g', tm),\n           'H' => format!(\"{:02d}\", tm.tm_hour),\n           'I' => {\n             let mut h = tm.tm_hour;\n@@ -855,12 +908,12 @@ fn do_strftime(format: &str, tm: &Tm) -> ~str {\n                 parse_type('S', tm))\n           }\n           't' => ~\"\\t\",\n-          //'U' {}\n+          'U' => format!(\"{:02d}\", (tm.tm_yday - tm.tm_wday + 7) / 7),\n           'u' => {\n             let i = tm.tm_wday as int;\n             (if i == 0 { 7 } else { i }).to_str()\n           }\n-          //'V' {}\n+          'V' => iso_week('V', tm),\n           'v' => {\n             format!(\"{}-{}-{}\",\n                 parse_type('e', tm),\n@@ -1222,8 +1275,8 @@ mod tests {\n         assert_eq!(local.strftime(\"%e\"), ~\"13\");\n         assert_eq!(local.strftime(\"%f\"), ~\"000054321\");\n         assert_eq!(local.strftime(\"%F\"), ~\"2009-02-13\");\n-        // assert!(local.strftime(\"%G\") == \"2009\");\n-        // assert!(local.strftime(\"%g\") == \"09\");\n+        assert_eq!(local.strftime(\"%G\"), ~\"2009\");\n+        assert_eq!(local.strftime(\"%g\"), ~\"09\");\n         assert_eq!(local.strftime(\"%H\"), ~\"15\");\n         assert_eq!(local.strftime(\"%I\"), ~\"03\");\n         assert_eq!(local.strftime(\"%j\"), ~\"044\");\n@@ -1240,9 +1293,9 @@ mod tests {\n         assert_eq!(local.strftime(\"%s\"), ~\"1234567890\");\n         assert_eq!(local.strftime(\"%T\"), ~\"15:31:30\");\n         assert_eq!(local.strftime(\"%t\"), ~\"\\t\");\n-        // assert!(local.strftime(\"%U\") == \"06\");\n+        assert_eq!(local.strftime(\"%U\"), ~\"06\");\n         assert_eq!(local.strftime(\"%u\"), ~\"5\");\n-        // assert!(local.strftime(\"%V\") == \"07\");\n+        assert_eq!(local.strftime(\"%V\"), ~\"07\");\n         assert_eq!(local.strftime(\"%v\"), ~\"13-Feb-2009\");\n         // assert!(local.strftime(\"%W\") == \"06\");\n         assert_eq!(local.strftime(\"%w\"), ~\"5\");"}]}