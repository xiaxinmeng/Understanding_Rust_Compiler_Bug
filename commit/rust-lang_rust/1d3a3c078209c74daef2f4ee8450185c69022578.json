{"sha": "1d3a3c078209c74daef2f4ee8450185c69022578", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFkM2EzYzA3ODIwOWM3NGRhZWYyZjRlZTg0NTAxODVjNjkwMjI1Nzg=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-07-04T13:44:52Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-07-04T13:44:52Z"}, "message": "Merge #5221\n\n5221: Modernize postfix completion tests r=matklad a=matklad\n\n\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>", "tree": {"sha": "8f6d84be1abe0fdbd3da2da97e5f2491bbef8dbf", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8f6d84be1abe0fdbd3da2da97e5f2491bbef8dbf"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1d3a3c078209c74daef2f4ee8450185c69022578", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfAIfUCRBK7hj4Ov3rIwAAdHIIAHlrRhSY1YwfXKY8humEt5KD\nYGxs8KpsL84AoEJSANRypywUtV2wTjZ0/9sBl0C3LCEaLsJC6xkQlSoYRJ5PLBjO\nPX7rutggGvvPY8nOuW0kl6D6vArMB+F4SVpn79ODmbDM2Rbq7ohWZeu3uqHl2hHe\nsgl2QIVovgVnH+Rs1XlchrAthFCNKcPaq2f+zLKSKORzKi87Ma6501w6WzHACb5J\nN7AEj2Plab2xuBy25nMXPj0bS2oeHk/alTM9nZmsVzFIChK2OveJLvLhuSFZFxsN\n9rib76089hTAP3ElD1ept25JIGmAsuLkYxdewdqOn9lIlcfmoYyCbqSkEljtW8E=\n=fymh\n-----END PGP SIGNATURE-----\n", "payload": "tree 8f6d84be1abe0fdbd3da2da97e5f2491bbef8dbf\nparent 1ee524bb42c6dd2e24e8ee8561427e0a9991e62f\nparent ba9c398144a0d4840fd02b5f3184ab71ef8264da\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1593870292 +0000\ncommitter GitHub <noreply@github.com> 1593870292 +0000\n\nMerge #5221\n\n5221: Modernize postfix completion tests r=matklad a=matklad\n\n\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1d3a3c078209c74daef2f4ee8450185c69022578", "html_url": "https://github.com/rust-lang/rust/commit/1d3a3c078209c74daef2f4ee8450185c69022578", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1d3a3c078209c74daef2f4ee8450185c69022578/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1ee524bb42c6dd2e24e8ee8561427e0a9991e62f", "url": "https://api.github.com/repos/rust-lang/rust/commits/1ee524bb42c6dd2e24e8ee8561427e0a9991e62f", "html_url": "https://github.com/rust-lang/rust/commit/1ee524bb42c6dd2e24e8ee8561427e0a9991e62f"}, {"sha": "ba9c398144a0d4840fd02b5f3184ab71ef8264da", "url": "https://api.github.com/repos/rust-lang/rust/commits/ba9c398144a0d4840fd02b5f3184ab71ef8264da", "html_url": "https://github.com/rust-lang/rust/commit/ba9c398144a0d4840fd02b5f3184ab71ef8264da"}], "stats": {"total": 760, "additions": 160, "deletions": 600}, "files": [{"sha": "41c16df7b1f4e229dd67839b64bdf7808b9a5bbe", "filename": "crates/ra_ide/src/completion/complete_pattern.rs", "status": "modified", "additions": 37, "deletions": 88, "changes": 125, "blob_url": "https://github.com/rust-lang/rust/blob/1d3a3c078209c74daef2f4ee8450185c69022578/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fcomplete_pattern.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d3a3c078209c74daef2f4ee8450185c69022578/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fcomplete_pattern.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fcomplete_pattern.rs?ref=1d3a3c078209c74daef2f4ee8450185c69022578", "patch": "@@ -33,107 +33,56 @@ pub(super) fn complete_pattern(acc: &mut Completions, ctx: &CompletionContext) {\n \n #[cfg(test)]\n mod tests {\n-    use crate::completion::{test_utils::do_completion, CompletionItem, CompletionKind};\n-    use insta::assert_debug_snapshot;\n+    use expect::{expect, Expect};\n \n-    fn complete(code: &str) -> Vec<CompletionItem> {\n-        do_completion(code, CompletionKind::Reference)\n+    use crate::completion::{test_utils::completion_list, CompletionKind};\n+\n+    fn check(ra_fixture: &str, expect: Expect) {\n+        let actual = completion_list(ra_fixture, CompletionKind::Reference);\n+        expect.assert_eq(&actual)\n     }\n \n     #[test]\n     fn completes_enum_variants_and_modules() {\n-        let completions = complete(\n-            r\"\n-            enum E { X }\n-            use self::E::X;\n-            const Z: E = E::X;\n-            mod m {}\n+        check(\n+            r#\"\n+enum E { X }\n+use self::E::X;\n+const Z: E = E::X;\n+mod m {}\n \n-            static FOO: E = E::X;\n-            struct Bar { f: u32 }\n+static FOO: E = E::X;\n+struct Bar { f: u32 }\n \n-            fn foo() {\n-               match E::X {\n-                   <|>\n-               }\n-            }\n-            \",\n+fn foo() {\n+   match E::X { <|> }\n+}\n+\"#,\n+            expect![[r#\"\n+                st Bar\n+                en E\n+                ev X ()\n+                ct Z\n+                md m\n+            \"#]],\n         );\n-        assert_debug_snapshot!(completions, @r###\"\n-        [\n-            CompletionItem {\n-                label: \"Bar\",\n-                source_range: 137..137,\n-                delete: 137..137,\n-                insert: \"Bar\",\n-                kind: Struct,\n-            },\n-            CompletionItem {\n-                label: \"E\",\n-                source_range: 137..137,\n-                delete: 137..137,\n-                insert: \"E\",\n-                kind: Enum,\n-            },\n-            CompletionItem {\n-                label: \"X\",\n-                source_range: 137..137,\n-                delete: 137..137,\n-                insert: \"X\",\n-                kind: EnumVariant,\n-                detail: \"()\",\n-            },\n-            CompletionItem {\n-                label: \"Z\",\n-                source_range: 137..137,\n-                delete: 137..137,\n-                insert: \"Z\",\n-                kind: Const,\n-            },\n-            CompletionItem {\n-                label: \"m\",\n-                source_range: 137..137,\n-                delete: 137..137,\n-                insert: \"m\",\n-                kind: Module,\n-            },\n-        ]\n-        \"###);\n     }\n \n     #[test]\n     fn completes_in_simple_macro_call() {\n-        let completions = complete(\n-            r\"\n-            macro_rules! m { ($e:expr) => { $e } }\n-            enum E { X }\n+        check(\n+            r#\"\n+macro_rules! m { ($e:expr) => { $e } }\n+enum E { X }\n \n-            fn foo() {\n-               m!(match E::X {\n-                   <|>\n-               })\n-            }\n-            \",\n+fn foo() {\n+   m!(match E::X { <|> })\n+}\n+\"#,\n+            expect![[r#\"\n+                en E\n+                ma m!(\u2026) macro_rules! m\n+            \"#]],\n         );\n-        assert_debug_snapshot!(completions, @r###\"\n-        [\n-            CompletionItem {\n-                label: \"E\",\n-                source_range: 90..90,\n-                delete: 90..90,\n-                insert: \"E\",\n-                kind: Enum,\n-            },\n-            CompletionItem {\n-                label: \"m!(\u2026)\",\n-                source_range: 90..90,\n-                delete: 90..90,\n-                insert: \"m!($0)\",\n-                kind: Macro,\n-                lookup: \"m!\",\n-                detail: \"macro_rules! m\",\n-            },\n-        ]\n-        \"###);\n     }\n }"}, {"sha": "14013dc2f97d649f5192b3dd1a110235c68ce71a", "filename": "crates/ra_ide/src/completion/complete_postfix.rs", "status": "modified", "additions": 123, "deletions": 512, "changes": 635, "blob_url": "https://github.com/rust-lang/rust/blob/1d3a3c078209c74daef2f4ee8450185c69022578/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fcomplete_postfix.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d3a3c078209c74daef2f4ee8450185c69022578/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fcomplete_postfix.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fcomplete_postfix.rs?ref=1d3a3c078209c74daef2f4ee8450185c69022578", "patch": "@@ -8,14 +8,13 @@ use ra_text_edit::TextEdit;\n \n use crate::{\n     completion::{\n+        completion_config::SnippetCap,\n         completion_context::CompletionContext,\n         completion_item::{Builder, CompletionKind, Completions},\n     },\n-    CompletionItem,\n+    CompletionItem, CompletionItemKind,\n };\n \n-use super::completion_config::SnippetCap;\n-\n pub(super) fn complete_postfix(acc: &mut Completions, ctx: &CompletionContext) {\n     if !ctx.config.enable_postfix_completions {\n         return;\n@@ -103,10 +102,9 @@ pub(super) fn complete_postfix(acc: &mut Completions, ctx: &CompletionContext) {\n             &format!(\"while {} {{\\n    $0\\n}}\", receiver_text),\n         )\n         .add_to(acc);\n+        postfix_snippet(ctx, cap, &dot_receiver, \"not\", \"!expr\", &format!(\"!{}\", receiver_text))\n+            .add_to(acc);\n     }\n-    // !&&&42 is a compiler error, ergo process it before considering the references\n-    postfix_snippet(ctx, cap, &dot_receiver, \"not\", \"!expr\", &format!(\"!{}\", receiver_text))\n-        .add_to(acc);\n \n     postfix_snippet(ctx, cap, &dot_receiver, \"ref\", \"&expr\", &format!(\"&{}\", receiver_text))\n         .add_to(acc);\n@@ -125,41 +123,43 @@ pub(super) fn complete_postfix(acc: &mut Completions, ctx: &CompletionContext) {\n     let dot_receiver = include_references(dot_receiver);\n     let receiver_text =\n         get_receiver_text(&dot_receiver, ctx.dot_receiver_is_ambiguous_float_literal);\n+\n     match try_enum {\n-        Some(try_enum) => {\n-            match try_enum {\n-                TryEnum::Result => {\n-                    postfix_snippet(\n+        Some(try_enum) => match try_enum {\n+            TryEnum::Result => {\n+                postfix_snippet(\n                     ctx,\n                     cap,\n                     &dot_receiver,\n                     \"match\",\n                     \"match expr {}\",\n-                    &format!(\"match {} {{\\n    Ok(${{1:_}}) => {{$2\\\\}},\\n    Err(${{3:_}}) => {{$0\\\\}},\\n}}\", receiver_text),\n+                    &format!(\"match {} {{\\n    Ok(${{1:_}}) => {{$2}},\\n    Err(${{3:_}}) => {{$0}},\\n}}\", receiver_text),\n                 )\n                 .add_to(acc);\n-                }\n-                TryEnum::Option => {\n-                    postfix_snippet(\n+            }\n+            TryEnum::Option => {\n+                postfix_snippet(\n                     ctx,\n                     cap,\n                     &dot_receiver,\n                     \"match\",\n                     \"match expr {}\",\n-                    &format!(\"match {} {{\\n    Some(${{1:_}}) => {{$2\\\\}},\\n    None => {{$0\\\\}},\\n}}\", receiver_text),\n+                    &format!(\n+                        \"match {} {{\\n    Some(${{1:_}}) => {{$2}},\\n    None => {{$0}},\\n}}\",\n+                        receiver_text\n+                    ),\n                 )\n                 .add_to(acc);\n-                }\n             }\n-        }\n+        },\n         None => {\n             postfix_snippet(\n                 ctx,\n                 cap,\n                 &dot_receiver,\n                 \"match\",\n                 \"match expr {}\",\n-                &format!(\"match {} {{\\n    ${{1:_}} => {{$0\\\\}},\\n}}\", receiver_text),\n+                &format!(\"match {} {{\\n    ${{1:_}} => {{$0}},\\n}}\", receiver_text),\n             )\n             .add_to(acc);\n         }\n@@ -232,536 +232,147 @@ fn postfix_snippet(\n     };\n     CompletionItem::new(CompletionKind::Postfix, ctx.source_range(), label)\n         .detail(detail)\n+        .kind(CompletionItemKind::Snippet)\n         .snippet_edit(cap, edit)\n }\n \n #[cfg(test)]\n mod tests {\n-    use insta::assert_debug_snapshot;\n+    use expect::{expect, Expect};\n \n-    use crate::completion::{test_utils::do_completion, CompletionItem, CompletionKind};\n+    use crate::completion::{\n+        test_utils::{check_edit, completion_list},\n+        CompletionKind,\n+    };\n \n-    fn do_postfix_completion(code: &str) -> Vec<CompletionItem> {\n-        do_completion(code, CompletionKind::Postfix)\n+    fn check(ra_fixture: &str, expect: Expect) {\n+        let actual = completion_list(ra_fixture, CompletionKind::Postfix);\n+        expect.assert_eq(&actual)\n     }\n \n     #[test]\n     fn postfix_completion_works_for_trivial_path_expression() {\n-        assert_debug_snapshot!(\n-            do_postfix_completion(\n-                r#\"\n-                fn main() {\n-                    let bar = true;\n-                    bar.<|>\n-                }\n-                \"#,\n-            ),\n-            @r###\"\n-        [\n-            CompletionItem {\n-                label: \"box\",\n-                source_range: 40..40,\n-                delete: 36..40,\n-                insert: \"Box::new(bar)\",\n-                detail: \"Box::new(expr)\",\n-            },\n-            CompletionItem {\n-                label: \"call\",\n-                source_range: 40..40,\n-                delete: 36..40,\n-                insert: \"${1}(bar)\",\n-                detail: \"function(expr)\",\n-            },\n-            CompletionItem {\n-                label: \"dbg\",\n-                source_range: 40..40,\n-                delete: 36..40,\n-                insert: \"dbg!(bar)\",\n-                detail: \"dbg!(expr)\",\n-            },\n-            CompletionItem {\n-                label: \"if\",\n-                source_range: 40..40,\n-                delete: 36..40,\n-                insert: \"if bar {\\n    $0\\n}\",\n-                detail: \"if expr {}\",\n-            },\n-            CompletionItem {\n-                label: \"match\",\n-                source_range: 40..40,\n-                delete: 36..40,\n-                insert: \"match bar {\\n    ${1:_} => {$0\\\\},\\n}\",\n-                detail: \"match expr {}\",\n-            },\n-            CompletionItem {\n-                label: \"not\",\n-                source_range: 40..40,\n-                delete: 36..40,\n-                insert: \"!bar\",\n-                detail: \"!expr\",\n-            },\n-            CompletionItem {\n-                label: \"ref\",\n-                source_range: 40..40,\n-                delete: 36..40,\n-                insert: \"&bar\",\n-                detail: \"&expr\",\n-            },\n-            CompletionItem {\n-                label: \"refm\",\n-                source_range: 40..40,\n-                delete: 36..40,\n-                insert: \"&mut bar\",\n-                detail: \"&mut expr\",\n-            },\n-            CompletionItem {\n-                label: \"while\",\n-                source_range: 40..40,\n-                delete: 36..40,\n-                insert: \"while bar {\\n    $0\\n}\",\n-                detail: \"while expr {}\",\n-            },\n-        ]\n-        \"###\n+        check(\n+            r#\"\n+fn main() {\n+    let bar = true;\n+    bar.<|>\n+}\n+\"#,\n+            expect![[r#\"\n+                sn box Box::new(expr)\n+                sn call function(expr)\n+                sn dbg dbg!(expr)\n+                sn if if expr {}\n+                sn match match expr {}\n+                sn not !expr\n+                sn ref &expr\n+                sn refm &mut expr\n+                sn while while expr {}\n+            \"#]],\n         );\n     }\n \n     #[test]\n-    fn postfix_completion_works_for_option() {\n-        assert_debug_snapshot!(\n-            do_postfix_completion(\n-                r#\"\n-                enum Option<T> {\n-                    Some(T),\n-                    None,\n-                }\n-\n-                fn main() {\n-                    let bar = Option::Some(true);\n-                    bar.<|>\n-                }\n-                \"#,\n-            ),\n-            @r###\"\n-        [\n-            CompletionItem {\n-                label: \"box\",\n-                source_range: 97..97,\n-                delete: 93..97,\n-                insert: \"Box::new(bar)\",\n-                detail: \"Box::new(expr)\",\n-            },\n-            CompletionItem {\n-                label: \"call\",\n-                source_range: 97..97,\n-                delete: 93..97,\n-                insert: \"${1}(bar)\",\n-                detail: \"function(expr)\",\n-            },\n-            CompletionItem {\n-                label: \"dbg\",\n-                source_range: 97..97,\n-                delete: 93..97,\n-                insert: \"dbg!(bar)\",\n-                detail: \"dbg!(expr)\",\n-            },\n-            CompletionItem {\n-                label: \"ifl\",\n-                source_range: 97..97,\n-                delete: 93..97,\n-                insert: \"if let Some($1) = bar {\\n    $0\\n}\",\n-                detail: \"if let Some {}\",\n-            },\n-            CompletionItem {\n-                label: \"match\",\n-                source_range: 97..97,\n-                delete: 93..97,\n-                insert: \"match bar {\\n    Some(${1:_}) => {$2\\\\},\\n    None => {$0\\\\},\\n}\",\n-                detail: \"match expr {}\",\n-            },\n-            CompletionItem {\n-                label: \"not\",\n-                source_range: 97..97,\n-                delete: 93..97,\n-                insert: \"!bar\",\n-                detail: \"!expr\",\n-            },\n-            CompletionItem {\n-                label: \"ref\",\n-                source_range: 97..97,\n-                delete: 93..97,\n-                insert: \"&bar\",\n-                detail: \"&expr\",\n-            },\n-            CompletionItem {\n-                label: \"refm\",\n-                source_range: 97..97,\n-                delete: 93..97,\n-                insert: \"&mut bar\",\n-                detail: \"&mut expr\",\n-            },\n-            CompletionItem {\n-                label: \"while\",\n-                source_range: 97..97,\n-                delete: 93..97,\n-                insert: \"while let Some($1) = bar {\\n    $0\\n}\",\n-                detail: \"while let Some {}\",\n-            },\n-        ]\n-        \"###\n-        );\n+    fn postfix_type_filtering() {\n+        check(\n+            r#\"\n+fn main() {\n+    let bar: u8 = 12;\n+    bar.<|>\n+}\n+\"#,\n+            expect![[r#\"\n+                sn box Box::new(expr)\n+                sn call function(expr)\n+                sn dbg dbg!(expr)\n+                sn match match expr {}\n+                sn ref &expr\n+                sn refm &mut expr\n+            \"#]],\n+        )\n     }\n \n     #[test]\n-    fn postfix_completion_works_for_result() {\n-        assert_debug_snapshot!(\n-            do_postfix_completion(\n-                r#\"\n-                enum Result<T, E> {\n-                    Ok(T),\n-                    Err(E),\n-                }\n+    fn option_iflet() {\n+        check_edit(\n+            \"ifl\",\n+            r#\"\n+enum Option<T> { Some(T), None }\n+\n+fn main() {\n+    let bar = Option::Some(true);\n+    bar.<|>\n+}\n+\"#,\n+            r#\"\n+enum Option<T> { Some(T), None }\n \n-                fn main() {\n-                    let bar = Result::Ok(true);\n-                    bar.<|>\n-                }\n-                \"#,\n-            ),\n-            @r###\"\n-        [\n-            CompletionItem {\n-                label: \"box\",\n-                source_range: 98..98,\n-                delete: 94..98,\n-                insert: \"Box::new(bar)\",\n-                detail: \"Box::new(expr)\",\n-            },\n-            CompletionItem {\n-                label: \"call\",\n-                source_range: 98..98,\n-                delete: 94..98,\n-                insert: \"${1}(bar)\",\n-                detail: \"function(expr)\",\n-            },\n-            CompletionItem {\n-                label: \"dbg\",\n-                source_range: 98..98,\n-                delete: 94..98,\n-                insert: \"dbg!(bar)\",\n-                detail: \"dbg!(expr)\",\n-            },\n-            CompletionItem {\n-                label: \"ifl\",\n-                source_range: 98..98,\n-                delete: 94..98,\n-                insert: \"if let Ok($1) = bar {\\n    $0\\n}\",\n-                detail: \"if let Ok {}\",\n-            },\n-            CompletionItem {\n-                label: \"match\",\n-                source_range: 98..98,\n-                delete: 94..98,\n-                insert: \"match bar {\\n    Ok(${1:_}) => {$2\\\\},\\n    Err(${3:_}) => {$0\\\\},\\n}\",\n-                detail: \"match expr {}\",\n-            },\n-            CompletionItem {\n-                label: \"not\",\n-                source_range: 98..98,\n-                delete: 94..98,\n-                insert: \"!bar\",\n-                detail: \"!expr\",\n-            },\n-            CompletionItem {\n-                label: \"ref\",\n-                source_range: 98..98,\n-                delete: 94..98,\n-                insert: \"&bar\",\n-                detail: \"&expr\",\n-            },\n-            CompletionItem {\n-                label: \"refm\",\n-                source_range: 98..98,\n-                delete: 94..98,\n-                insert: \"&mut bar\",\n-                detail: \"&mut expr\",\n-            },\n-            CompletionItem {\n-                label: \"while\",\n-                source_range: 98..98,\n-                delete: 94..98,\n-                insert: \"while let Ok($1) = bar {\\n    $0\\n}\",\n-                detail: \"while let Ok {}\",\n-            },\n-        ]\n-        \"###\n+fn main() {\n+    let bar = Option::Some(true);\n+    if let Some($1) = bar {\n+    $0\n+}\n+}\n+\"#,\n         );\n     }\n \n     #[test]\n-    fn some_postfix_completions_ignored() {\n-        assert_debug_snapshot!(\n-            do_postfix_completion(\n-                r#\"\n-                fn main() {\n-                    let bar: u8 = 12;\n-                    bar.<|>\n-                }\n-                \"#,\n-            ),\n-            @r###\"\n-        [\n-            CompletionItem {\n-                label: \"box\",\n-                source_range: 42..42,\n-                delete: 38..42,\n-                insert: \"Box::new(bar)\",\n-                detail: \"Box::new(expr)\",\n-            },\n-            CompletionItem {\n-                label: \"call\",\n-                source_range: 42..42,\n-                delete: 38..42,\n-                insert: \"${1}(bar)\",\n-                detail: \"function(expr)\",\n-            },\n-            CompletionItem {\n-                label: \"dbg\",\n-                source_range: 42..42,\n-                delete: 38..42,\n-                insert: \"dbg!(bar)\",\n-                detail: \"dbg!(expr)\",\n-            },\n-            CompletionItem {\n-                label: \"match\",\n-                source_range: 42..42,\n-                delete: 38..42,\n-                insert: \"match bar {\\n    ${1:_} => {$0\\\\},\\n}\",\n-                detail: \"match expr {}\",\n-            },\n-            CompletionItem {\n-                label: \"not\",\n-                source_range: 42..42,\n-                delete: 38..42,\n-                insert: \"!bar\",\n-                detail: \"!expr\",\n-            },\n-            CompletionItem {\n-                label: \"ref\",\n-                source_range: 42..42,\n-                delete: 38..42,\n-                insert: \"&bar\",\n-                detail: \"&expr\",\n-            },\n-            CompletionItem {\n-                label: \"refm\",\n-                source_range: 42..42,\n-                delete: 38..42,\n-                insert: \"&mut bar\",\n-                detail: \"&mut expr\",\n-            },\n-        ]\n-        \"###\n+    fn result_match() {\n+        check_edit(\n+            \"match\",\n+            r#\"\n+enum Result<T, E> { Ok(T), Err(E) }\n+\n+fn main() {\n+    let bar = Result::Ok(true);\n+    bar.<|>\n+}\n+\"#,\n+            r#\"\n+enum Result<T, E> { Ok(T), Err(E) }\n+\n+fn main() {\n+    let bar = Result::Ok(true);\n+    match bar {\n+    Ok(${1:_}) => {$2},\n+    Err(${3:_}) => {$0},\n+}\n+}\n+\"#,\n         );\n     }\n \n     #[test]\n     fn postfix_completion_works_for_ambiguous_float_literal() {\n-        assert_debug_snapshot!(\n-            do_postfix_completion(\n-                r#\"\n-                fn main() {\n-                    42.<|>\n-                }\n-                \"#,\n-            ),\n-            @r###\"\n-        [\n-            CompletionItem {\n-                label: \"box\",\n-                source_range: 19..19,\n-                delete: 16..19,\n-                insert: \"Box::new(42)\",\n-                detail: \"Box::new(expr)\",\n-            },\n-            CompletionItem {\n-                label: \"call\",\n-                source_range: 19..19,\n-                delete: 16..19,\n-                insert: \"${1}(42)\",\n-                detail: \"function(expr)\",\n-            },\n-            CompletionItem {\n-                label: \"dbg\",\n-                source_range: 19..19,\n-                delete: 16..19,\n-                insert: \"dbg!(42)\",\n-                detail: \"dbg!(expr)\",\n-            },\n-            CompletionItem {\n-                label: \"match\",\n-                source_range: 19..19,\n-                delete: 16..19,\n-                insert: \"match 42 {\\n    ${1:_} => {$0\\\\},\\n}\",\n-                detail: \"match expr {}\",\n-            },\n-            CompletionItem {\n-                label: \"not\",\n-                source_range: 19..19,\n-                delete: 16..19,\n-                insert: \"!42\",\n-                detail: \"!expr\",\n-            },\n-            CompletionItem {\n-                label: \"ref\",\n-                source_range: 19..19,\n-                delete: 16..19,\n-                insert: \"&42\",\n-                detail: \"&expr\",\n-            },\n-            CompletionItem {\n-                label: \"refm\",\n-                source_range: 19..19,\n-                delete: 16..19,\n-                insert: \"&mut 42\",\n-                detail: \"&mut expr\",\n-            },\n-        ]\n-        \"###\n-        );\n+        check_edit(\"refm\", r#\"fn main() { 42.<|> }\"#, r#\"fn main() { &mut 42 }\"#)\n     }\n \n     #[test]\n     fn works_in_simple_macro() {\n-        assert_debug_snapshot!(\n-            do_postfix_completion(\n-                r#\"\n-                macro_rules! m { ($e:expr) => { $e } }\n-                fn main() {\n-                    let bar: u8 = 12;\n-                    m!(bar.b<|>)\n-                }\n-                \"#,\n-            ),\n-            @r###\"\n-        [\n-            CompletionItem {\n-                label: \"box\",\n-                source_range: 84..85,\n-                delete: 80..85,\n-                insert: \"Box::new(bar)\",\n-                detail: \"Box::new(expr)\",\n-            },\n-            CompletionItem {\n-                label: \"call\",\n-                source_range: 84..85,\n-                delete: 80..85,\n-                insert: \"${1}(bar)\",\n-                detail: \"function(expr)\",\n-            },\n-            CompletionItem {\n-                label: \"dbg\",\n-                source_range: 84..85,\n-                delete: 80..85,\n-                insert: \"dbg!(bar)\",\n-                detail: \"dbg!(expr)\",\n-            },\n-            CompletionItem {\n-                label: \"match\",\n-                source_range: 84..85,\n-                delete: 80..85,\n-                insert: \"match bar {\\n    ${1:_} => {$0\\\\},\\n}\",\n-                detail: \"match expr {}\",\n-            },\n-            CompletionItem {\n-                label: \"not\",\n-                source_range: 84..85,\n-                delete: 80..85,\n-                insert: \"!bar\",\n-                detail: \"!expr\",\n-            },\n-            CompletionItem {\n-                label: \"ref\",\n-                source_range: 84..85,\n-                delete: 80..85,\n-                insert: \"&bar\",\n-                detail: \"&expr\",\n-            },\n-            CompletionItem {\n-                label: \"refm\",\n-                source_range: 84..85,\n-                delete: 80..85,\n-                insert: \"&mut bar\",\n-                detail: \"&mut expr\",\n-            },\n-        ]\n-        \"###\n+        check_edit(\n+            \"dbg\",\n+            r#\"\n+macro_rules! m { ($e:expr) => { $e } }\n+fn main() {\n+    let bar: u8 = 12;\n+    m!(bar.d<|>)\n+}\n+\"#,\n+            r#\"\n+macro_rules! m { ($e:expr) => { $e } }\n+fn main() {\n+    let bar: u8 = 12;\n+    m!(dbg!(bar))\n+}\n+\"#,\n         );\n     }\n \n     #[test]\n     fn postfix_completion_for_references() {\n-        assert_debug_snapshot!(\n-            do_postfix_completion(\n-                r#\"\n-                fn main() {\n-                    &&&&42.<|>\n-                }\n-                \"#,\n-            ),\n-            @r###\"\n-        [\n-            CompletionItem {\n-                label: \"box\",\n-                source_range: 23..23,\n-                delete: 16..23,\n-                insert: \"Box::new(&&&&42)\",\n-                detail: \"Box::new(expr)\",\n-            },\n-            CompletionItem {\n-                label: \"call\",\n-                source_range: 23..23,\n-                delete: 16..23,\n-                insert: \"${1}(&&&&42)\",\n-                detail: \"function(expr)\",\n-            },\n-            CompletionItem {\n-                label: \"dbg\",\n-                source_range: 23..23,\n-                delete: 16..23,\n-                insert: \"dbg!(&&&&42)\",\n-                detail: \"dbg!(expr)\",\n-            },\n-            CompletionItem {\n-                label: \"match\",\n-                source_range: 23..23,\n-                delete: 16..23,\n-                insert: \"match &&&&42 {\\n    ${1:_} => {$0\\\\},\\n}\",\n-                detail: \"match expr {}\",\n-            },\n-            CompletionItem {\n-                label: \"not\",\n-                source_range: 23..23,\n-                delete: 20..23,\n-                insert: \"!42\",\n-                detail: \"!expr\",\n-            },\n-            CompletionItem {\n-                label: \"ref\",\n-                source_range: 23..23,\n-                delete: 20..23,\n-                insert: \"&42\",\n-                detail: \"&expr\",\n-            },\n-            CompletionItem {\n-                label: \"refm\",\n-                source_range: 23..23,\n-                delete: 20..23,\n-                insert: \"&mut 42\",\n-                detail: \"&mut expr\",\n-            },\n-        ]\n-        \"###\n-        );\n+        check_edit(\"dbg\", r#\"fn main() { &&42.<|> }\"#, r#\"fn main() { dbg!(&&42) }\"#);\n+        check_edit(\"refm\", r#\"fn main() { &&42.<|> }\"#, r#\"fn main() { &&&mut 42 }\"#);\n     }\n }"}]}