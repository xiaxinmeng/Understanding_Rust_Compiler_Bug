{"sha": "848e5518d66ff2084c10a4c1cfcf5da5e0534033", "node_id": "C_kwDOAAsO6NoAKDg0OGU1NTE4ZDY2ZmYyMDg0YzEwYTRjMWNmY2Y1ZGE1ZTA1MzQwMzM", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-09-21T16:59:48Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-09-21T16:59:48Z"}, "message": "Auto merge of #7694 - Jarcho:lintcheck_retry, r=matthiaskrgr\n\nRetry on some download errors in lintcheck\n\nI'm currently on spotty wifi right now. It is shocking the number of things that break when you lose connection for a few seconds. Some 500 errors should probably also be retried, but this fixes my issue.\n\nchangelog: None", "tree": {"sha": "396f3788d463fd37be4013a1b1f9fe862c8e683d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/396f3788d463fd37be4013a1b1f9fe862c8e683d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/848e5518d66ff2084c10a4c1cfcf5da5e0534033", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/848e5518d66ff2084c10a4c1cfcf5da5e0534033", "html_url": "https://github.com/rust-lang/rust/commit/848e5518d66ff2084c10a4c1cfcf5da5e0534033", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/848e5518d66ff2084c10a4c1cfcf5da5e0534033/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "871ad80bb02af6d8fbf3f5c7291916b817c75168", "url": "https://api.github.com/repos/rust-lang/rust/commits/871ad80bb02af6d8fbf3f5c7291916b817c75168", "html_url": "https://github.com/rust-lang/rust/commit/871ad80bb02af6d8fbf3f5c7291916b817c75168"}, {"sha": "41fe5461f432266afe75c7cd183aae27306c7c08", "url": "https://api.github.com/repos/rust-lang/rust/commits/41fe5461f432266afe75c7cd183aae27306c7c08", "html_url": "https://github.com/rust-lang/rust/commit/41fe5461f432266afe75c7cd183aae27306c7c08"}], "stats": {"total": 20, "additions": 19, "deletions": 1}, "files": [{"sha": "97d3794fb84f0a951de6acd2e8a0e3eced02d357", "filename": "lintcheck/src/main.rs", "status": "modified", "additions": 19, "deletions": 1, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/848e5518d66ff2084c10a4c1cfcf5da5e0534033/lintcheck%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/848e5518d66ff2084c10a4c1cfcf5da5e0534033/lintcheck%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/lintcheck%2Fsrc%2Fmain.rs?ref=848e5518d66ff2084c10a4c1cfcf5da5e0534033", "patch": "@@ -15,6 +15,8 @@ use std::{\n     env, fmt,\n     fs::write,\n     path::{Path, PathBuf},\n+    thread,\n+    time::Duration,\n };\n \n use clap::{App, Arg, ArgMatches};\n@@ -109,6 +111,22 @@ impl std::fmt::Display for ClippyWarning {\n     }\n }\n \n+fn get(path: &str) -> Result<ureq::Response, ureq::Error> {\n+    const MAX_RETRIES: u8 = 4;\n+    let mut retries = 0;\n+    loop {\n+        match ureq::get(path).call() {\n+            Ok(res) => return Ok(res),\n+            Err(e) if retries >= MAX_RETRIES => return Err(e),\n+            Err(ureq::Error::Transport(e)) => eprintln!(\"Error: {}\", e),\n+            Err(e) => return Err(e),\n+        }\n+        eprintln!(\"retrying in {} seconds...\", retries);\n+        thread::sleep(Duration::from_secs(retries as u64));\n+        retries += 1;\n+    }\n+}\n+\n impl CrateSource {\n     /// Makes the sources available on the disk for clippy to check.\n     /// Clones a git repo and checks out the specified commit or downloads a crate from crates.io or\n@@ -129,7 +147,7 @@ impl CrateSource {\n                 if !krate_file_path.is_file() {\n                     // create a file path to download and write the crate data into\n                     let mut krate_dest = std::fs::File::create(&krate_file_path).unwrap();\n-                    let mut krate_req = ureq::get(&url).call().unwrap().into_reader();\n+                    let mut krate_req = get(&url).unwrap().into_reader();\n                     // copy the crate into the file\n                     std::io::copy(&mut krate_req, &mut krate_dest).unwrap();\n "}]}