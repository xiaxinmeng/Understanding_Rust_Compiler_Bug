{"sha": "96859dbaf6229f131fbd427a32aaa95d4f9cb132", "node_id": "MDY6Q29tbWl0NzI0NzEyOjk2ODU5ZGJhZjYyMjlmMTMxZmJkNDI3YTMyYWFhOTVkNGY5Y2IxMzI=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-07-03T16:06:35Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-07-03T16:06:35Z"}, "message": "Auto merge of #86778 - tmiasko:fast-multiline, r=davidtwco\n\nAvoid byte to char position conversions in `is_multiline`\n\nConverting a byte position into a char position is currently linear in\nthe number of multibyte characters in the source code. Avoid it when\nchecking if a range spans across lines.\n\nThis makes it feasible to compile source files with a large number of\nmultibyte characters.", "tree": {"sha": "e4fec5b9f22a98f051e19ead1483603e78f96d61", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e4fec5b9f22a98f051e19ead1483603e78f96d61"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/96859dbaf6229f131fbd427a32aaa95d4f9cb132", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/96859dbaf6229f131fbd427a32aaa95d4f9cb132", "html_url": "https://github.com/rust-lang/rust/commit/96859dbaf6229f131fbd427a32aaa95d4f9cb132", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/96859dbaf6229f131fbd427a32aaa95d4f9cb132/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8649737beefccbef2d6bc0113df4650dd05ad7f2", "url": "https://api.github.com/repos/rust-lang/rust/commits/8649737beefccbef2d6bc0113df4650dd05ad7f2", "html_url": "https://github.com/rust-lang/rust/commit/8649737beefccbef2d6bc0113df4650dd05ad7f2"}, {"sha": "7a410763facea6aab28cdaeb133179b11a979eb6", "url": "https://api.github.com/repos/rust-lang/rust/commits/7a410763facea6aab28cdaeb133179b11a979eb6", "html_url": "https://github.com/rust-lang/rust/commit/7a410763facea6aab28cdaeb133179b11a979eb6"}], "stats": {"total": 10, "additions": 7, "deletions": 3}, "files": [{"sha": "77a3ad931d5717343eef8355a25a6c529ff11793", "filename": "compiler/rustc_span/src/source_map.rs", "status": "modified", "additions": 7, "deletions": 3, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/96859dbaf6229f131fbd427a32aaa95d4f9cb132/compiler%2Frustc_span%2Fsrc%2Fsource_map.rs", "raw_url": "https://github.com/rust-lang/rust/raw/96859dbaf6229f131fbd427a32aaa95d4f9cb132/compiler%2Frustc_span%2Fsrc%2Fsource_map.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_span%2Fsrc%2Fsource_map.rs?ref=96859dbaf6229f131fbd427a32aaa95d4f9cb132", "patch": "@@ -461,9 +461,13 @@ impl SourceMap {\n     }\n \n     pub fn is_multiline(&self, sp: Span) -> bool {\n-        let lo = self.lookup_char_pos(sp.lo());\n-        let hi = self.lookup_char_pos(sp.hi());\n-        lo.line != hi.line\n+        let lo = self.lookup_source_file_idx(sp.lo());\n+        let hi = self.lookup_source_file_idx(sp.hi());\n+        if lo != hi {\n+            return true;\n+        }\n+        let f = (*self.files.borrow().source_files)[lo].clone();\n+        f.lookup_line(sp.lo()) != f.lookup_line(sp.hi())\n     }\n \n     pub fn is_valid_span(&self, sp: Span) -> Result<(Loc, Loc), SpanLinesError> {"}]}