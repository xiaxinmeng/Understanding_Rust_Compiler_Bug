{"sha": "8cacf50563ba0f60855d3465f019290d29495ec1", "node_id": "MDY6Q29tbWl0NzI0NzEyOjhjYWNmNTA1NjNiYTBmNjA4NTVkMzQ2NWYwMTkyOTBkMjk0OTVlYzE=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-01-17T00:20:48Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-01-17T00:20:48Z"}, "message": "Auto merge of #66716 - derekdreery:debug_non_exhaustive, r=dtolnay\n\nImplement `DebugStruct::non_exhaustive`.\n\nThis patch adds a function (finish_non_exhaustive) to add ellipsis before the closing brace when formatting using `DebugStruct`.\n\n ## Example\n\n ```rust\n #![feature(debug_non_exhaustive)]\n use std::fmt;\n\n struct Bar {\n     bar: i32,\n     hidden: f32,\n }\n\n impl fmt::Debug for Bar {\n     fn fmt(&self, fmt: &mut fmt::Formatter<'_>) -> fmt::Result {\n         fmt.debug_struct(\"Bar\")\n            .field(\"bar\", &self.bar)\n            .non_exhaustive(true) // Show that some other field(s) exist.\n            .finish()\n     }\n }\n\n assert_eq!(\n     format!(\"{:?}\", Bar { bar: 10, hidden: 1.0 }),\n     \"Bar { bar: 10, .. }\",\n );\n ```", "tree": {"sha": "9efd2b59f04a6da177d33545676bd1d346a5e83b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9efd2b59f04a6da177d33545676bd1d346a5e83b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8cacf50563ba0f60855d3465f019290d29495ec1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8cacf50563ba0f60855d3465f019290d29495ec1", "html_url": "https://github.com/rust-lang/rust/commit/8cacf50563ba0f60855d3465f019290d29495ec1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8cacf50563ba0f60855d3465f019290d29495ec1/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ecbc222855c890c3aabe4848e8d8b312debcf0ff", "url": "https://api.github.com/repos/rust-lang/rust/commits/ecbc222855c890c3aabe4848e8d8b312debcf0ff", "html_url": "https://github.com/rust-lang/rust/commit/ecbc222855c890c3aabe4848e8d8b312debcf0ff"}, {"sha": "73124df6eba9d81affb3ef597fdaeb4fce82f7af", "url": "https://api.github.com/repos/rust-lang/rust/commits/73124df6eba9d81affb3ef597fdaeb4fce82f7af", "html_url": "https://github.com/rust-lang/rust/commit/73124df6eba9d81affb3ef597fdaeb4fce82f7af"}], "stats": {"total": 142, "additions": 142, "deletions": 0}, "files": [{"sha": "dd0f3ccb15841721ca16c28c1288b3e13baccf21", "filename": "src/libcore/fmt/builders.rs", "status": "modified", "additions": 56, "deletions": 0, "changes": 56, "blob_url": "https://github.com/rust-lang/rust/blob/8cacf50563ba0f60855d3465f019290d29495ec1/src%2Flibcore%2Ffmt%2Fbuilders.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8cacf50563ba0f60855d3465f019290d29495ec1/src%2Flibcore%2Ffmt%2Fbuilders.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Ffmt%2Fbuilders.rs?ref=8cacf50563ba0f60855d3465f019290d29495ec1", "patch": "@@ -159,6 +159,62 @@ impl<'a, 'b: 'a> DebugStruct<'a, 'b> {\n         self\n     }\n \n+    /// Marks the struct as non-exhaustive, indicating to the reader that there are some other\n+    /// fields that are not shown in the debug representation.\n+    ///\n+    /// # Examples\n+    ///\n+    /// ```\n+    /// # #![feature(debug_non_exhaustive)]\n+    /// use std::fmt;\n+    ///\n+    /// struct Bar {\n+    ///     bar: i32,\n+    ///     hidden: f32,\n+    /// }\n+    ///\n+    /// impl fmt::Debug for Bar {\n+    ///     fn fmt(&self, fmt: &mut fmt::Formatter<'_>) -> fmt::Result {\n+    ///         fmt.debug_struct(\"Bar\")\n+    ///            .field(\"bar\", &self.bar)\n+    ///            .finish_non_exhaustive() // Show that some other field(s) exist.\n+    ///     }\n+    /// }\n+    ///\n+    /// assert_eq!(\n+    ///     format!(\"{:?}\", Bar { bar: 10, hidden: 1.0 }),\n+    ///     \"Bar { bar: 10, .. }\",\n+    /// );\n+    /// ```\n+    #[unstable(feature = \"debug_non_exhaustive\", issue = \"67364\")]\n+    pub fn finish_non_exhaustive(&mut self) -> fmt::Result {\n+        self.result = self.result.and_then(|_| {\n+            // Draw non-exhaustive dots (`..`), and open brace if necessary (no fields).\n+            if self.is_pretty() {\n+                if !self.has_fields {\n+                    self.fmt.write_str(\" {\\n\")?;\n+                }\n+                let mut slot = None;\n+                let mut state = Default::default();\n+                let mut writer = PadAdapter::wrap(&mut self.fmt, &mut slot, &mut state);\n+                writer.write_str(\"..\\n\")?;\n+            } else {\n+                if self.has_fields {\n+                    self.fmt.write_str(\", ..\")?;\n+                } else {\n+                    self.fmt.write_str(\" { ..\")?;\n+                }\n+            }\n+            if self.is_pretty() {\n+                self.fmt.write_str(\"}\")?\n+            } else {\n+                self.fmt.write_str(\" }\")?;\n+            }\n+            Ok(())\n+        });\n+        self.result\n+    }\n+\n     /// Finishes output and returns any error encountered.\n     ///\n     /// # Examples"}, {"sha": "129c121e8ceac0f5cd0974a9b15832a14445c5a2", "filename": "src/libcore/tests/fmt/builders.rs", "status": "modified", "additions": 85, "deletions": 0, "changes": 85, "blob_url": "https://github.com/rust-lang/rust/blob/8cacf50563ba0f60855d3465f019290d29495ec1/src%2Flibcore%2Ftests%2Ffmt%2Fbuilders.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8cacf50563ba0f60855d3465f019290d29495ec1/src%2Flibcore%2Ftests%2Ffmt%2Fbuilders.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Ftests%2Ffmt%2Fbuilders.rs?ref=8cacf50563ba0f60855d3465f019290d29495ec1", "patch": "@@ -89,6 +89,91 @@ mod debug_struct {\n         baz: 10/20,\n     },\n     hello: \\\"world\\\",\n+}\",\n+            format!(\"{:#?}\", Bar)\n+        );\n+    }\n+\n+    #[test]\n+    fn test_only_non_exhaustive() {\n+        struct Foo;\n+\n+        impl fmt::Debug for Foo {\n+            fn fmt(&self, fmt: &mut fmt::Formatter<'_>) -> fmt::Result {\n+                fmt.debug_struct(\"Foo\").finish_non_exhaustive()\n+            }\n+        }\n+\n+        assert_eq!(\"Foo { .. }\", format!(\"{:?}\", Foo));\n+        assert_eq!(\n+            \"Foo {\n+    ..\n+}\",\n+            format!(\"{:#?}\", Foo)\n+        );\n+    }\n+\n+    #[test]\n+    fn test_multiple_and_non_exhaustive() {\n+        struct Foo;\n+\n+        impl fmt::Debug for Foo {\n+            fn fmt(&self, fmt: &mut fmt::Formatter<'_>) -> fmt::Result {\n+                fmt.debug_struct(\"Foo\")\n+                    .field(\"bar\", &true)\n+                    .field(\"baz\", &format_args!(\"{}/{}\", 10, 20))\n+                    .finish_non_exhaustive()\n+            }\n+        }\n+\n+        assert_eq!(\"Foo { bar: true, baz: 10/20, .. }\", format!(\"{:?}\", Foo));\n+        assert_eq!(\n+            \"Foo {\n+    bar: true,\n+    baz: 10/20,\n+    ..\n+}\",\n+            format!(\"{:#?}\", Foo)\n+        );\n+    }\n+\n+    #[test]\n+    fn test_nested_non_exhaustive() {\n+        struct Foo;\n+\n+        impl fmt::Debug for Foo {\n+            fn fmt(&self, fmt: &mut fmt::Formatter<'_>) -> fmt::Result {\n+                fmt.debug_struct(\"Foo\")\n+                    .field(\"bar\", &true)\n+                    .field(\"baz\", &format_args!(\"{}/{}\", 10, 20))\n+                    .finish_non_exhaustive()\n+            }\n+        }\n+\n+        struct Bar;\n+\n+        impl fmt::Debug for Bar {\n+            fn fmt(&self, fmt: &mut fmt::Formatter<'_>) -> fmt::Result {\n+                fmt.debug_struct(\"Bar\")\n+                    .field(\"foo\", &Foo)\n+                    .field(\"hello\", &\"world\")\n+                    .finish_non_exhaustive()\n+            }\n+        }\n+\n+        assert_eq!(\n+            \"Bar { foo: Foo { bar: true, baz: 10/20, .. }, hello: \\\"world\\\", .. }\",\n+            format!(\"{:?}\", Bar)\n+        );\n+        assert_eq!(\n+            \"Bar {\n+    foo: Foo {\n+        bar: true,\n+        baz: 10/20,\n+        ..\n+    },\n+    hello: \\\"world\\\",\n+    ..\n }\",\n             format!(\"{:#?}\", Bar)\n         );"}, {"sha": "8c034938c2bb9881a58de26f4cc1e5e6ae5ecafb", "filename": "src/libcore/tests/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/8cacf50563ba0f60855d3465f019290d29495ec1/src%2Flibcore%2Ftests%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8cacf50563ba0f60855d3465f019290d29495ec1/src%2Flibcore%2Ftests%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Ftests%2Flib.rs?ref=8cacf50563ba0f60855d3465f019290d29495ec1", "patch": "@@ -5,6 +5,7 @@\n #![feature(core_private_bignum)]\n #![feature(core_private_diy_float)]\n #![feature(debug_map_key_value)]\n+#![feature(debug_non_exhaustive)]\n #![feature(dec2flt)]\n #![feature(exact_size_is_empty)]\n #![feature(fixed_size_array)]"}]}