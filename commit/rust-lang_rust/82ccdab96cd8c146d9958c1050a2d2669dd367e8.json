{"sha": "82ccdab96cd8c146d9958c1050a2d2669dd367e8", "node_id": "MDY6Q29tbWl0NzI0NzEyOjgyY2NkYWI5NmNkOGMxNDZkOTk1OGMxMDUwYTJkMjY2OWRkMzY3ZTg=", "commit": {"author": {"name": "Alexis Bourget", "email": "alexis.bourget@gmail.com", "date": "2020-07-29T19:58:09Z"}, "committer": {"name": "Alexis Bourget", "email": "alexis.bourget@gmail.com", "date": "2020-07-29T19:58:09Z"}, "message": "Disallow missing unsafe blocks in unsafe fn in panicking.rs\n\nThis adds SAFETY comments where necessary, explaining the preconditions\nand how they are respected.", "tree": {"sha": "df6ce4ac3cd6c354da7b346200dfd6946c8e276d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/df6ce4ac3cd6c354da7b346200dfd6946c8e276d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/82ccdab96cd8c146d9958c1050a2d2669dd367e8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/82ccdab96cd8c146d9958c1050a2d2669dd367e8", "html_url": "https://github.com/rust-lang/rust/commit/82ccdab96cd8c146d9958c1050a2d2669dd367e8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/82ccdab96cd8c146d9958c1050a2d2669dd367e8/comments", "author": {"login": "poliorcetics", "id": 7951708, "node_id": "MDQ6VXNlcjc5NTE3MDg=", "avatar_url": "https://avatars.githubusercontent.com/u/7951708?v=4", "gravatar_id": "", "url": "https://api.github.com/users/poliorcetics", "html_url": "https://github.com/poliorcetics", "followers_url": "https://api.github.com/users/poliorcetics/followers", "following_url": "https://api.github.com/users/poliorcetics/following{/other_user}", "gists_url": "https://api.github.com/users/poliorcetics/gists{/gist_id}", "starred_url": "https://api.github.com/users/poliorcetics/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/poliorcetics/subscriptions", "organizations_url": "https://api.github.com/users/poliorcetics/orgs", "repos_url": "https://api.github.com/users/poliorcetics/repos", "events_url": "https://api.github.com/users/poliorcetics/events{/privacy}", "received_events_url": "https://api.github.com/users/poliorcetics/received_events", "type": "User", "site_admin": false}, "committer": {"login": "poliorcetics", "id": 7951708, "node_id": "MDQ6VXNlcjc5NTE3MDg=", "avatar_url": "https://avatars.githubusercontent.com/u/7951708?v=4", "gravatar_id": "", "url": "https://api.github.com/users/poliorcetics", "html_url": "https://github.com/poliorcetics", "followers_url": "https://api.github.com/users/poliorcetics/followers", "following_url": "https://api.github.com/users/poliorcetics/following{/other_user}", "gists_url": "https://api.github.com/users/poliorcetics/gists{/gist_id}", "starred_url": "https://api.github.com/users/poliorcetics/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/poliorcetics/subscriptions", "organizations_url": "https://api.github.com/users/poliorcetics/orgs", "repos_url": "https://api.github.com/users/poliorcetics/repos", "events_url": "https://api.github.com/users/poliorcetics/events{/privacy}", "received_events_url": "https://api.github.com/users/poliorcetics/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2c28244cf0fc9868f55070e55b8f332d196eaf3f", "url": "https://api.github.com/repos/rust-lang/rust/commits/2c28244cf0fc9868f55070e55b8f332d196eaf3f", "html_url": "https://github.com/rust-lang/rust/commit/2c28244cf0fc9868f55070e55b8f332d196eaf3f"}], "stats": {"total": 56, "additions": 49, "deletions": 7}, "files": [{"sha": "f92c1dd76a17fb8a282cb51af420ac47fe60d1ee", "filename": "library/std/src/panicking.rs", "status": "modified", "additions": 44, "deletions": 6, "changes": 50, "blob_url": "https://github.com/rust-lang/rust/blob/82ccdab96cd8c146d9958c1050a2d2669dd367e8/library%2Fstd%2Fsrc%2Fpanicking.rs", "raw_url": "https://github.com/rust-lang/rust/raw/82ccdab96cd8c146d9958c1050a2d2669dd367e8/library%2Fstd%2Fsrc%2Fpanicking.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fpanicking.rs?ref=82ccdab96cd8c146d9958c1050a2d2669dd367e8", "patch": "@@ -7,6 +7,8 @@\n //! * Executing a panic up to doing the actual implementation\n //! * Shims around \"try\"\n \n+#![deny(unsafe_op_in_unsafe_fn)]\n+\n use core::panic::{BoxMeUp, Location, PanicInfo};\n \n use crate::any::Any;\n@@ -322,25 +324,48 @@ pub unsafe fn r#try<R, F: FnOnce() -> R>(f: F) -> Result<R, Box<dyn Any + Send>>\n     let mut data = Data { f: ManuallyDrop::new(f) };\n \n     let data_ptr = &mut data as *mut _ as *mut u8;\n-    return if intrinsics::r#try(do_call::<F, R>, data_ptr, do_catch::<F, R>) == 0 {\n-        Ok(ManuallyDrop::into_inner(data.r))\n-    } else {\n-        Err(ManuallyDrop::into_inner(data.p))\n-    };\n+    // SAFETY:\n+    //\n+    // Access to the union's fields: this is `std` and we know that the `r#try`\n+    // intrinsic fills in the `r` or `p` union field based on its return value.\n+    //\n+    // The call to `intrinsics::r#try` is made safe by:\n+    // - `do_call`, the first argument, can be called with the initial `data_ptr`.\n+    // - `do_catch`, the second argument, can be called with the `data_ptr` as well.\n+    // See their safety preconditions for more informations\n+    unsafe {\n+        return if intrinsics::r#try(do_call::<F, R>, data_ptr, do_catch::<F, R>) == 0 {\n+            Ok(ManuallyDrop::into_inner(data.r))\n+        } else {\n+            Err(ManuallyDrop::into_inner(data.p))\n+        };\n+    }\n \n     // We consider unwinding to be rare, so mark this function as cold. However,\n     // do not mark it no-inline -- that decision is best to leave to the\n     // optimizer (in most cases this function is not inlined even as a normal,\n     // non-cold function, though, as of the writing of this comment).\n     #[cold]\n     unsafe fn cleanup(payload: *mut u8) -> Box<dyn Any + Send + 'static> {\n-        let obj = Box::from_raw(__rust_panic_cleanup(payload));\n+        // SAFETY: The whole unsafe block hinges on a correct implementation of\n+        // the panic handler `__rust_panic_cleanup`. As such we can only\n+        // assume it returns the correct thing for `Box::from_raw` to work\n+        // without undefined behavior.\n+        let obj = unsafe { Box::from_raw(__rust_panic_cleanup(payload)) };\n         panic_count::decrease();\n         obj\n     }\n \n+    // SAFETY:\n+    // data must be non-NUL, correctly aligned, and a pointer to a `Data<F, R>`\n+    // Its must contains a valid `f` (type: F) value that can be use to fill\n+    // `data.r`.\n+    //\n+    // This function cannot be marked as `unsafe` because `intrinsics::r#try`\n+    // expects normal function pointers.\n     #[inline]\n     fn do_call<F: FnOnce() -> R, R>(data: *mut u8) {\n+        // SAFETY: this is the responsibilty of the caller, see above.\n         unsafe {\n             let data = data as *mut Data<F, R>;\n             let data = &mut (*data);\n@@ -352,8 +377,21 @@ pub unsafe fn r#try<R, F: FnOnce() -> R>(f: F) -> Result<R, Box<dyn Any + Send>>\n     // We *do* want this part of the catch to be inlined: this allows the\n     // compiler to properly track accesses to the Data union and optimize it\n     // away most of the time.\n+    //\n+    // SAFETY:\n+    // data must be non-NUL, correctly aligned, and a pointer to a `Data<F, R>`\n+    // Since this uses `cleanup` it also hinges on a correct implementation of\n+    // `__rustc_panic_cleanup`.\n+    //\n+    // This function cannot be marked as `unsafe` because `intrinsics::r#try`\n+    // expects normal function pointers.\n     #[inline]\n     fn do_catch<F: FnOnce() -> R, R>(data: *mut u8, payload: *mut u8) {\n+        // SAFETY: this is the responsibilty of the caller, see above.\n+        //\n+        // When `__rustc_panic_cleaner` is correctly implemented we can rely\n+        // on `obj` being the correct thing to pass to `data.p` (after wrapping\n+        // in `ManuallyDrop`).\n         unsafe {\n             let data = data as *mut Data<F, R>;\n             let data = &mut (*data);"}, {"sha": "66508f06b2884ccb4de9147d890d3f08fa35e8cb", "filename": "library/std/src/thread/local.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/82ccdab96cd8c146d9958c1050a2d2669dd367e8/library%2Fstd%2Fsrc%2Fthread%2Flocal.rs", "raw_url": "https://github.com/rust-lang/rust/raw/82ccdab96cd8c146d9958c1050a2d2669dd367e8/library%2Fstd%2Fsrc%2Fthread%2Flocal.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fthread%2Flocal.rs?ref=82ccdab96cd8c146d9958c1050a2d2669dd367e8", "patch": "@@ -172,7 +172,11 @@ macro_rules! __thread_local_inner {\n                 static __KEY: $crate::thread::__OsLocalKeyInner<$t> =\n                     $crate::thread::__OsLocalKeyInner::new();\n \n-                __KEY.get(__init)\n+                // FIXME: remove the #[allow(...)] marker when macros don't\n+                // raise warning for missing/extraneous unsafe blocks anymore.\n+                // See https://github.com/rust-lang/rust/issues/74838.\n+                #[allow(unused_unsafe)]\n+                unsafe { __KEY.get(__init) }\n             }\n \n             unsafe {"}]}