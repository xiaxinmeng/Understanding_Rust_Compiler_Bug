{"sha": "21736816478b96b6e4cc4dc594d1e2a91898d73c", "node_id": "MDY6Q29tbWl0NzI0NzEyOjIxNzM2ODE2NDc4Yjk2YjZlNGNjNGRjNTk0ZDFlMmE5MTg5OGQ3M2M=", "commit": {"author": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2018-11-13T07:09:40Z"}, "committer": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2018-11-13T11:21:09Z"}, "message": "Rollup merge of #55136 - GuillaumeGomez:short-doc, r=QuietMisdreavus\n\nRemove short doc where it starts with a codeblock\n\nFixes #54975.", "tree": {"sha": "221e15566919a52d10148fb8353f7085f1e7c2b8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/221e15566919a52d10148fb8353f7085f1e7c2b8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/21736816478b96b6e4cc4dc594d1e2a91898d73c", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEZ1R8CLMp8f2GxWoQ/vbIBR0OATwFAlvqs6YACgkQ/vbIBR0O\nATwrqw/+MBl5KviFwalYjU+0FLxbZOxAdZ1EH9Fnx6Weiiq6lFWOCzLKIngpf0KF\n8ZkC7SobHI5BtAwSEdN7YoytLWns+d0Cl6GiG4BpK4OQAtDwbH3lFZijV4qEZaJU\nyE/1etGoeSu48SnniAsxAcbu+sFSPjaD2hAE/zcYmi/oVU1RPYV1eYkOrhyuGlGS\nB2atFEpOXlc9SDq7OpTEYmFc36925olA/o2euZkknrrYWdzPnQYjUZRW8y7ZryPw\nw/lEUL/Cn13EvTo7yFGWKfw41XoXirORzbtRZB8+vNyVQemS/sAdkMWI4+EsTtlv\nEzYGA4Xqr6Yh2qO4BPSFCMaqO4ZGEh1CBMVpDKo8Lia6EuxLaaVA0QM9TeCgtoGk\nsgVAEVHJ9tZnx2wzKNP/MGojSNKKCSjUcCbG3YMXHrP9Xex+DWTNUzHQyLk5QN8s\nalHD319ObRW9/AKEh1pSqCFXudS2WqkblzF0W5pR6KwhILpSHW3tRXNCZAXgH+er\nUOuj1Vy24h9l//f264GoIoWh4I+cdl80uV+w06H4SXF6qvUSR1omLVIq9+0iuii1\nXJkr9A/1MnjdSqsv2szCYH6yVuQC0e01Rdjw8J3edCb7o+AQWsZGEhomR/r73AT3\neiKWVHQ3i5hDIq5oTLK3mYL97ZTSU5CjyUjkLamf6x4ub1Pl6ws=\n=c01A\n-----END PGP SIGNATURE-----", "payload": "tree 221e15566919a52d10148fb8353f7085f1e7c2b8\nparent 8a13ae5fce294af87c45ae1a3a332b5463eec035\nparent 3030cbea957adbd560bf2eaa34c1b8a56daee16a\nauthor kennytm <kennytm@gmail.com> 1542092980 +0800\ncommitter kennytm <kennytm@gmail.com> 1542108069 +0800\n\nRollup merge of #55136 - GuillaumeGomez:short-doc, r=QuietMisdreavus\n\nRemove short doc where it starts with a codeblock\n\nFixes #54975.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/21736816478b96b6e4cc4dc594d1e2a91898d73c", "html_url": "https://github.com/rust-lang/rust/commit/21736816478b96b6e4cc4dc594d1e2a91898d73c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/21736816478b96b6e4cc4dc594d1e2a91898d73c/comments", "author": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8a13ae5fce294af87c45ae1a3a332b5463eec035", "url": "https://api.github.com/repos/rust-lang/rust/commits/8a13ae5fce294af87c45ae1a3a332b5463eec035", "html_url": "https://github.com/rust-lang/rust/commit/8a13ae5fce294af87c45ae1a3a332b5463eec035"}, {"sha": "3030cbea957adbd560bf2eaa34c1b8a56daee16a", "url": "https://api.github.com/repos/rust-lang/rust/commits/3030cbea957adbd560bf2eaa34c1b8a56daee16a", "html_url": "https://github.com/rust-lang/rust/commit/3030cbea957adbd560bf2eaa34c1b8a56daee16a"}], "stats": {"total": 113, "additions": 78, "deletions": 35}, "files": [{"sha": "00ca4fed2f4a008e73eb1ecf23cf73d446884c30", "filename": "src/librustdoc/html/markdown.rs", "status": "modified", "additions": 28, "deletions": 22, "changes": 50, "blob_url": "https://github.com/rust-lang/rust/blob/21736816478b96b6e4cc4dc594d1e2a91898d73c/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs", "raw_url": "https://github.com/rust-lang/rust/raw/21736816478b96b6e4cc4dc594d1e2a91898d73c/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs?ref=21736816478b96b6e4cc4dc594d1e2a91898d73c", "patch": "@@ -399,7 +399,6 @@ impl<'a, I: Iterator<Item = Event<'a>>> SummaryLine<'a, I> {\n fn check_if_allowed_tag(t: &Tag) -> bool {\n     match *t {\n         Tag::Paragraph\n-        | Tag::CodeBlock(_)\n         | Tag::Item\n         | Tag::Emphasis\n         | Tag::Strong\n@@ -420,29 +419,36 @@ impl<'a, I: Iterator<Item = Event<'a>>> Iterator for SummaryLine<'a, I> {\n         if !self.started {\n             self.started = true;\n         }\n-        let event = self.inner.next();\n-        let mut is_start = true;\n-        let is_allowed_tag = match event {\n-            Some(Event::Start(ref c)) => {\n-                self.depth += 1;\n-                check_if_allowed_tag(c)\n-            }\n-            Some(Event::End(ref c)) => {\n-                self.depth -= 1;\n-                is_start = false;\n-                check_if_allowed_tag(c)\n-            }\n-            _ => true,\n-        };\n-        if is_allowed_tag == false {\n-            if is_start {\n-                Some(Event::Start(Tag::Paragraph))\n+        while let Some(event) = self.inner.next() {\n+            let mut is_start = true;\n+            let is_allowed_tag = match event {\n+                Event::Start(Tag::CodeBlock(_)) | Event::End(Tag::CodeBlock(_)) => {\n+                    return None;\n+                }\n+                Event::Start(ref c) => {\n+                    self.depth += 1;\n+                    check_if_allowed_tag(c)\n+                }\n+                Event::End(ref c) => {\n+                    self.depth -= 1;\n+                    is_start = false;\n+                    check_if_allowed_tag(c)\n+                }\n+                _ => {\n+                    true\n+                }\n+            };\n+            return if is_allowed_tag == false {\n+                if is_start {\n+                    Some(Event::Start(Tag::Paragraph))\n+                } else {\n+                    Some(Event::End(Tag::Paragraph))\n+                }\n             } else {\n-                Some(Event::End(Tag::Paragraph))\n-            }\n-        } else {\n-            event\n+                Some(event)\n+            };\n         }\n+        None\n     }\n }\n "}, {"sha": "b46efb20d8f6b2164c3538dfbcd21420a5a456eb", "filename": "src/librustdoc/html/render.rs", "status": "modified", "additions": 25, "deletions": 10, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/21736816478b96b6e4cc4dc594d1e2a91898d73c/src%2Flibrustdoc%2Fhtml%2Frender.rs", "raw_url": "https://github.com/rust-lang/rust/raw/21736816478b96b6e4cc4dc594d1e2a91898d73c/src%2Flibrustdoc%2Fhtml%2Frender.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender.rs?ref=21736816478b96b6e4cc4dc594d1e2a91898d73c", "patch": "@@ -2584,24 +2584,39 @@ fn item_module(w: &mut fmt::Formatter, cx: &Context,\n                     _ => \"\",\n                 };\n \n+                let stab = myitem.stability_class();\n+                let add = if stab.is_some() {\n+                    \" \"\n+                } else {\n+                    \"\"\n+                };\n+\n                 let doc_value = myitem.doc_value().unwrap_or(\"\");\n-                write!(w, \"\n-                       <tr class='{stab} module-item'>\n-                           <td><a class=\\\"{class}\\\" href=\\\"{href}\\\"\n-                                  title='{title_type} {title}'>{name}</a>{unsafety_flag}</td>\n-                           <td class='docblock-short'>\n-                               {stab_docs} {docs}\n-                           </td>\n+                write!(w, \"\\\n+                       <tr class='{stab}{add}module-item'>\\\n+                           <td><a class=\\\"{class}\\\" href=\\\"{href}\\\" \\\n+                                  title='{title}'>{name}</a>{unsafety_flag}</td>\\\n+                           <td class='docblock-short'>{stab_docs}{docs}\\\n+                           </td>\\\n                        </tr>\",\n                        name = *myitem.name.as_ref().unwrap(),\n                        stab_docs = stab_docs,\n                        docs = MarkdownSummaryLine(doc_value, &myitem.links()),\n                        class = myitem.type_(),\n-                       stab = myitem.stability_class().unwrap_or(String::new()),\n+                       add = add,\n+                       stab = stab.unwrap_or_else(|| String::new()),\n                        unsafety_flag = unsafety_flag,\n                        href = item_path(myitem.type_(), myitem.name.as_ref().unwrap()),\n-                       title_type = myitem.type_(),\n-                       title = full_path(cx, myitem))?;\n+                       title = [full_path(cx, myitem), myitem.type_().to_string()]\n+                                .iter()\n+                                .filter_map(|s| if !s.is_empty() {\n+                                    Some(s.as_str())\n+                                } else {\n+                                    None\n+                                })\n+                                .collect::<Vec<_>>()\n+                                .join(\" \"),\n+                      )?;\n             }\n         }\n     }"}, {"sha": "f82dafa25172090462eb371f810c91ead8f92a6d", "filename": "src/test/rustdoc/doc-cfg.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/21736816478b96b6e4cc4dc594d1e2a91898d73c/src%2Ftest%2Frustdoc%2Fdoc-cfg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/21736816478b96b6e4cc4dc594d1e2a91898d73c/src%2Ftest%2Frustdoc%2Fdoc-cfg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fdoc-cfg.rs?ref=21736816478b96b6e4cc4dc594d1e2a91898d73c", "patch": "@@ -20,8 +20,8 @@ pub struct Portable;\n // @has doc_cfg/unix_only/index.html \\\n //  '//*[@id=\"main\"]/*[@class=\"stability\"]/*[@class=\"stab portability\"]' \\\n //  'This is supported on Unix only.'\n-// @matches - '//*[@class=\" module-item\"]//*[@class=\"stab portability\"]' '\\AUnix\\Z'\n-// @matches - '//*[@class=\" module-item\"]//*[@class=\"stab portability\"]' '\\AUnix and ARM\\Z'\n+// @matches - '//*[@class=\"module-item\"]//*[@class=\"stab portability\"]' '\\AUnix\\Z'\n+// @matches - '//*[@class=\"module-item\"]//*[@class=\"stab portability\"]' '\\AUnix and ARM\\Z'\n // @count - '//*[@class=\"stab portability\"]' 3\n #[doc(cfg(unix))]\n pub mod unix_only {\n@@ -52,7 +52,7 @@ pub mod unix_only {\n \n // the portability header is different on the module view versus the full view\n // @has doc_cfg/index.html\n-// @matches - '//*[@class=\" module-item\"]//*[@class=\"stab portability\"]' '\\Aavx\\Z'\n+// @matches - '//*[@class=\"module-item\"]//*[@class=\"stab portability\"]' '\\Aavx\\Z'\n \n // @has doc_cfg/fn.uses_target_feature.html\n // @has - '//*[@id=\"main\"]/*[@class=\"stability\"]/*[@class=\"stab portability\"]' \\"}, {"sha": "060b349c251774d1d0ed43832ded6e44b96d7c03", "filename": "src/test/rustdoc/short-docblock-codeblock.rs", "status": "added", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/21736816478b96b6e4cc4dc594d1e2a91898d73c/src%2Ftest%2Frustdoc%2Fshort-docblock-codeblock.rs", "raw_url": "https://github.com/rust-lang/rust/raw/21736816478b96b6e4cc4dc594d1e2a91898d73c/src%2Ftest%2Frustdoc%2Fshort-docblock-codeblock.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fshort-docblock-codeblock.rs?ref=21736816478b96b6e4cc4dc594d1e2a91898d73c", "patch": "@@ -0,0 +1,22 @@\n+// Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![crate_name = \"foo\"]\n+\n+// @has foo/index.html '//*[@class=\"module-item\"]//td[@class=\"docblock-short\"]' \"\"\n+// @!has foo/index.html '//*[@id=\"module-item\"]//td[@class=\"docblock-short\"]' \"Some text.\"\n+// @!has foo/index.html '//*[@id=\"module-item\"]//td[@class=\"docblock-short\"]' \"let x = 12;\"\n+\n+/// ```\n+/// let x = 12;\n+/// ```\n+///\n+/// Some text.\n+pub fn foo() {}"}]}