{"sha": "24bb607e7d65ebfc487eba62e053ac049f140efc", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI0YmI2MDdlN2Q2NWViZmM0ODdlYmE2MmUwNTNhYzA0OWYxNDBlZmM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-03-18T16:21:43Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-03-18T16:21:43Z"}, "message": "Auto merge of #32282 - sfackler:panic-hook, r=alexcrichton\n\nAdjustments to the panic hook API\n\nRename `set_handler` and `take_handler` to `set_hook` and `take_hook` since we're not actually \"handling\" (i.e. fixing) anything.\n\nAlso alter `set_hook` to take a `Box<Fn(&PanicInfo) + 'static + Sync + Send>` rather than a parameterized closure since there's otherwise no easy way to re-register a hook that came from `take_hook`.\n\ncc #30449\n\nr? @aturon", "tree": {"sha": "5488e6cdaba0a034870a1b0b459b9685e7352ed6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5488e6cdaba0a034870a1b0b459b9685e7352ed6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/24bb607e7d65ebfc487eba62e053ac049f140efc", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/24bb607e7d65ebfc487eba62e053ac049f140efc", "html_url": "https://github.com/rust-lang/rust/commit/24bb607e7d65ebfc487eba62e053ac049f140efc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/24bb607e7d65ebfc487eba62e053ac049f140efc/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "235d77457d80b549dad3ac36d94f235208a1eafb", "url": "https://api.github.com/repos/rust-lang/rust/commits/235d77457d80b549dad3ac36d94f235208a1eafb", "html_url": "https://github.com/rust-lang/rust/commit/235d77457d80b549dad3ac36d94f235208a1eafb"}, {"sha": "50fda1eead10af900a7b7c9f07983937e66bcc3c", "url": "https://api.github.com/repos/rust-lang/rust/commits/50fda1eead10af900a7b7c9f07983937e66bcc3c", "html_url": "https://github.com/rust-lang/rust/commit/50fda1eead10af900a7b7c9f07983937e66bcc3c"}], "stats": {"total": 122, "additions": 67, "deletions": 55}, "files": [{"sha": "aff11d036f8f91e16006a8c624afb01db229bcfb", "filename": "src/libstd/panic.rs", "status": "modified", "additions": 15, "deletions": 1, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/24bb607e7d65ebfc487eba62e053ac049f140efc/src%2Flibstd%2Fpanic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/24bb607e7d65ebfc487eba62e053ac049f140efc/src%2Flibstd%2Fpanic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fpanic.rs?ref=24bb607e7d65ebfc487eba62e053ac049f140efc", "patch": "@@ -23,7 +23,21 @@ use sync::{Arc, Mutex, RwLock};\n use sys_common::unwind;\n use thread::Result;\n \n-pub use panicking::{take_handler, set_handler, PanicInfo, Location};\n+pub use panicking::{take_hook, set_hook, PanicInfo, Location};\n+\n+///\n+#[rustc_deprecated(since = \"1.9.0\", reason = \"renamed to set_hook\")]\n+#[unstable(feature = \"panic_handler\", reason = \"awaiting feedback\", issue = \"30449\")]\n+pub fn set_handler<F>(handler: F) where F: Fn(&PanicInfo) + 'static + Sync + Send {\n+    set_hook(Box::new(handler))\n+}\n+\n+///\n+#[rustc_deprecated(since = \"1.9.0\", reason = \"renamed to take_hook\")]\n+#[unstable(feature = \"panic_handler\", reason = \"awaiting feedback\", issue = \"30449\")]\n+pub fn take_handler() -> Box<Fn(&PanicInfo) + 'static + Sync + Send> {\n+    take_hook()\n+}\n \n /// A marker trait which represents \"panic safe\" types in Rust.\n ///"}, {"sha": "fd6a15b0f69a3f8bebf751eae3cfeeb643e7fbed", "filename": "src/libstd/panicking.rs", "status": "modified", "additions": 30, "deletions": 32, "changes": 62, "blob_url": "https://github.com/rust-lang/rust/blob/24bb607e7d65ebfc487eba62e053ac049f140efc/src%2Flibstd%2Fpanicking.rs", "raw_url": "https://github.com/rust-lang/rust/raw/24bb607e7d65ebfc487eba62e053ac049f140efc/src%2Flibstd%2Fpanicking.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fpanicking.rs?ref=24bb607e7d65ebfc487eba62e053ac049f140efc", "patch": "@@ -32,73 +32,71 @@ thread_local! {\n }\n \n #[derive(Copy, Clone)]\n-enum Handler {\n+enum Hook {\n     Default,\n     Custom(*mut (Fn(&PanicInfo) + 'static + Sync + Send)),\n }\n \n-static HANDLER_LOCK: StaticRwLock = StaticRwLock::new();\n-static mut HANDLER: Handler = Handler::Default;\n+static HOOK_LOCK: StaticRwLock = StaticRwLock::new();\n+static mut HOOK: Hook = Hook::Default;\n static FIRST_PANIC: AtomicBool = AtomicBool::new(true);\n \n-/// Registers a custom panic handler, replacing any that was previously\n-/// registered.\n+/// Registers a custom panic hook, replacing any that was previously registered.\n ///\n-/// The panic handler is invoked when a thread panics, but before it begins\n-/// unwinding the stack. The default handler prints a message to standard error\n+/// The panic hook is invoked when a thread panics, but before it begins\n+/// unwinding the stack. The default hook prints a message to standard error\n /// and generates a backtrace if requested, but this behavior can be customized\n-/// with the `set_handler` and `take_handler` functions.\n+/// with the `set_hook` and `take_hook` functions.\n ///\n-/// The handler is provided with a `PanicInfo` struct which contains information\n+/// The hook is provided with a `PanicInfo` struct which contains information\n /// about the origin of the panic, including the payload passed to `panic!` and\n /// the source code location from which the panic originated.\n ///\n-/// The panic handler is a global resource.\n+/// The panic hook is a global resource.\n ///\n /// # Panics\n ///\n /// Panics if called from a panicking thread.\n #[unstable(feature = \"panic_handler\", reason = \"awaiting feedback\", issue = \"30449\")]\n-pub fn set_handler<F>(handler: F) where F: Fn(&PanicInfo) + 'static + Sync + Send {\n+pub fn set_hook(hook: Box<Fn(&PanicInfo) + 'static + Sync + Send>) {\n     if thread::panicking() {\n-        panic!(\"cannot modify the panic handler from a panicking thread\");\n+        panic!(\"cannot modify the panic hook from a panicking thread\");\n     }\n \n-    let handler = Box::new(handler);\n     unsafe {\n-        let lock = HANDLER_LOCK.write();\n-        let old_handler = HANDLER;\n-        HANDLER = Handler::Custom(Box::into_raw(handler));\n+        let lock = HOOK_LOCK.write();\n+        let old_hook = HOOK;\n+        HOOK = Hook::Custom(Box::into_raw(hook));\n         drop(lock);\n \n-        if let Handler::Custom(ptr) = old_handler {\n+        if let Hook::Custom(ptr) = old_hook {\n             Box::from_raw(ptr);\n         }\n     }\n }\n \n-/// Unregisters the current panic handler, returning it.\n+/// Unregisters the current panic hook, returning it.\n ///\n-/// If no custom handler is registered, the default handler will be returned.\n+/// If no custom hook is registered, the default hook will be returned.\n ///\n /// # Panics\n ///\n /// Panics if called from a panicking thread.\n #[unstable(feature = \"panic_handler\", reason = \"awaiting feedback\", issue = \"30449\")]\n-pub fn take_handler() -> Box<Fn(&PanicInfo) + 'static + Sync + Send> {\n+pub fn take_hook() -> Box<Fn(&PanicInfo) + 'static + Sync + Send> {\n     if thread::panicking() {\n-        panic!(\"cannot modify the panic handler from a panicking thread\");\n+        panic!(\"cannot modify the panic hook from a panicking thread\");\n     }\n \n     unsafe {\n-        let lock = HANDLER_LOCK.write();\n-        let handler = HANDLER;\n-        HANDLER = Handler::Default;\n+        let lock = HOOK_LOCK.write();\n+        let hook = HOOK;\n+        HOOK = Hook::Default;\n         drop(lock);\n \n-        match handler {\n-            Handler::Default => Box::new(default_handler),\n-            Handler::Custom(ptr) => {Box::from_raw(ptr)} // FIXME #30530\n+        match hook {\n+            Hook::Default => Box::new(default_hook),\n+            Hook::Custom(ptr) => {Box::from_raw(ptr)} // FIXME #30530\n         }\n     }\n }\n@@ -151,7 +149,7 @@ impl<'a> Location<'a> {\n     }\n }\n \n-fn default_handler(info: &PanicInfo) {\n+fn default_hook(info: &PanicInfo) {\n     let panics = PANIC_COUNT.with(|s| s.get());\n \n     // If this is a double panic, make sure that we print a backtrace\n@@ -224,10 +222,10 @@ pub fn on_panic(obj: &(Any+Send), file: &'static str, line: u32) {\n     };\n \n     unsafe {\n-        let _lock = HANDLER_LOCK.read();\n-        match HANDLER {\n-            Handler::Default => default_handler(&info),\n-            Handler::Custom(ptr) => (*ptr)(&info),\n+        let _lock = HOOK_LOCK.read();\n+        match HOOK {\n+            Hook::Default => default_hook(&info),\n+            Hook::Custom(ptr) => (*ptr)(&info),\n         }\n     }\n "}, {"sha": "7c2e3f0c91baff5774974c863736bb22470a1015", "filename": "src/test/run-pass/panic-handler-chain.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/24bb607e7d65ebfc487eba62e053ac049f140efc/src%2Ftest%2Frun-pass%2Fpanic-handler-chain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/24bb607e7d65ebfc487eba62e053ac049f140efc/src%2Ftest%2Frun-pass%2Fpanic-handler-chain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fpanic-handler-chain.rs?ref=24bb607e7d65ebfc487eba62e053ac049f140efc", "patch": "@@ -17,12 +17,12 @@ static A: AtomicUsize = AtomicUsize::new(0);\n static B: AtomicUsize = AtomicUsize::new(0);\n \n fn main() {\n-    panic::set_handler(|_| { A.fetch_add(1, Ordering::SeqCst); });\n-    let handler = panic::take_handler();\n-    panic::set_handler(move |info| {\n+    panic::set_hook(Box::new(|_| { A.fetch_add(1, Ordering::SeqCst); }));\n+    let hook = panic::take_hook();\n+    panic::set_hook(Box::new(move |info| {\n         B.fetch_add(1, Ordering::SeqCst);\n-        handler(info);\n-    });\n+        hook(info);\n+    }));\n \n     let _ = thread::spawn(|| {\n         panic!();"}, {"sha": "311310712df8360096fd7cac349c3dd55cd9d699", "filename": "src/test/run-pass/panic-handler-flail-wildly.rs", "status": "modified", "additions": 15, "deletions": 15, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/24bb607e7d65ebfc487eba62e053ac049f140efc/src%2Ftest%2Frun-pass%2Fpanic-handler-flail-wildly.rs", "raw_url": "https://github.com/rust-lang/rust/raw/24bb607e7d65ebfc487eba62e053ac049f140efc/src%2Ftest%2Frun-pass%2Fpanic-handler-flail-wildly.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fpanic-handler-flail-wildly.rs?ref=24bb607e7d65ebfc487eba62e053ac049f140efc", "patch": "@@ -15,28 +15,28 @@ use std::panic;\n use std::thread;\n \n fn a() {\n-    panic::set_handler(|_| println!(\"hello yes this is a\"));\n-    panic::take_handler();\n-    panic::set_handler(|_| println!(\"hello yes this is a part 2\"));\n-    panic::take_handler();\n+    panic::set_hook(Box::new(|_| println!(\"hello yes this is a\")));\n+    panic::take_hook();\n+    panic::set_hook(Box::new(|_| println!(\"hello yes this is a part 2\")));\n+    panic::take_hook();\n }\n \n fn b() {\n-    panic::take_handler();\n-    panic::take_handler();\n-    panic::take_handler();\n-    panic::take_handler();\n-    panic::take_handler();\n+    panic::take_hook();\n+    panic::take_hook();\n+    panic::take_hook();\n+    panic::take_hook();\n+    panic::take_hook();\n     panic!();\n }\n \n fn c() {\n-    panic::set_handler(|_| ());\n-    panic::set_handler(|_| ());\n-    panic::set_handler(|_| ());\n-    panic::set_handler(|_| ());\n-    panic::set_handler(|_| ());\n-    panic::set_handler(|_| ());\n+    panic::set_hook(Box::new(|_| ()));\n+    panic::set_hook(Box::new(|_| ()));\n+    panic::set_hook(Box::new(|_| ()));\n+    panic::set_hook(Box::new(|_| ()));\n+    panic::set_hook(Box::new(|_| ()));\n+    panic::set_hook(Box::new(|_| ()));\n     panic!();\n }\n "}, {"sha": "196e08a63a7f0fafecb1ac889681a7398e5264a7", "filename": "src/test/run-pass/panic-handler-set-twice.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/24bb607e7d65ebfc487eba62e053ac049f140efc/src%2Ftest%2Frun-pass%2Fpanic-handler-set-twice.rs", "raw_url": "https://github.com/rust-lang/rust/raw/24bb607e7d65ebfc487eba62e053ac049f140efc/src%2Ftest%2Frun-pass%2Fpanic-handler-set-twice.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fpanic-handler-set-twice.rs?ref=24bb607e7d65ebfc487eba62e053ac049f140efc", "patch": "@@ -18,8 +18,8 @@ use std::thread;\n static A: AtomicUsize = AtomicUsize::new(0);\n \n fn main() {\n-    panic::set_handler(|_| ());\n-    panic::set_handler(|info| { A.fetch_add(1, Ordering::SeqCst); });\n+    panic::set_hook(Box::new(|_| ()));\n+    panic::set_hook(Box::new(|info| { A.fetch_add(1, Ordering::SeqCst); }));\n \n     let _ = thread::spawn(|| {\n         panic!();"}]}