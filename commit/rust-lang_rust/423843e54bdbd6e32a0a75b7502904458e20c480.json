{"sha": "423843e54bdbd6e32a0a75b7502904458e20c480", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQyMzg0M2U1NGJkYmQ2ZTMyYTBhNzViNzUwMjkwNDQ1OGUyMGM0ODA=", "commit": {"author": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2013-02-20T00:12:12Z"}, "committer": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2013-02-21T00:18:48Z"}, "message": "Don't perform swap when src == dst. #5041", "tree": {"sha": "a0b41d23bc2bb28c2b23f18d9c8830c77d3cf293", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a0b41d23bc2bb28c2b23f18d9c8830c77d3cf293"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/423843e54bdbd6e32a0a75b7502904458e20c480", "comment_count": 5, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/423843e54bdbd6e32a0a75b7502904458e20c480", "html_url": "https://github.com/rust-lang/rust/commit/423843e54bdbd6e32a0a75b7502904458e20c480", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/423843e54bdbd6e32a0a75b7502904458e20c480/comments", "author": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "committer": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "831840ab242b6359333c490653ea477ae9f553cb", "url": "https://api.github.com/repos/rust-lang/rust/commits/831840ab242b6359333c490653ea477ae9f553cb", "html_url": "https://github.com/rust-lang/rust/commit/831840ab242b6359333c490653ea477ae9f553cb"}], "stats": {"total": 71, "additions": 67, "deletions": 4}, "files": [{"sha": "5b57ccc9ad430f9af984af1756e030f25335d25a", "filename": "src/librustc/middle/trans/expr.rs", "status": "modified", "additions": 22, "deletions": 4, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/423843e54bdbd6e32a0a75b7502904458e20c480/src%2Flibrustc%2Fmiddle%2Ftrans%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/423843e54bdbd6e32a0a75b7502904458e20c480/src%2Flibrustc%2Fmiddle%2Ftrans%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fexpr.rs?ref=423843e54bdbd6e32a0a75b7502904458e20c480", "patch": "@@ -491,11 +491,29 @@ fn trans_rvalue_stmt_unadjusted(bcx: block, expr: @ast::expr) -> block {\n         ast::expr_swap(dst, src) => {\n             let dst_datum = unpack_datum!(bcx, trans_lvalue(bcx, dst));\n             let src_datum = unpack_datum!(bcx, trans_lvalue(bcx, src));\n-            let scratch = scratch_datum(bcx, dst_datum.ty, false);\n \n-            let bcx = dst_datum.move_to_datum(bcx, INIT, scratch);\n-            let bcx = src_datum.move_to_datum(bcx, INIT, dst_datum);\n-            return scratch.move_to_datum(bcx, INIT, src_datum);\n+            // If the source and destination are the same, then don't swap.\n+            // Avoids performing an overlapping memcpy\n+            let dst_datum_ref = dst_datum.to_ref_llval(bcx);\n+            let src_datum_ref = src_datum.to_ref_llval(bcx);\n+            let cmp = ICmp(bcx, lib::llvm::IntEQ,\n+                           src_datum_ref,\n+                           dst_datum_ref);\n+\n+            let swap_cx = base::sub_block(bcx, ~\"swap\");\n+            let next_cx = base::sub_block(bcx, ~\"next\");\n+\n+            CondBr(bcx, cmp, next_cx.llbb, swap_cx.llbb);\n+\n+            let scratch = scratch_datum(swap_cx, dst_datum.ty, false);\n+\n+            let swap_cx = dst_datum.move_to_datum(swap_cx, INIT, scratch);\n+            let swap_cx = src_datum.move_to_datum(swap_cx, INIT, dst_datum);\n+            let swap_cx = scratch.move_to_datum(swap_cx, INIT, src_datum);\n+\n+            Br(swap_cx, next_cx.llbb);\n+\n+            return next_cx;\n         }\n         ast::expr_assign_op(op, dst, src) => {\n             return trans_assign_op(bcx, expr, op, dst, src);"}, {"sha": "90b2ceef71a76eb20253848566e6d0d354c58cd1", "filename": "src/test/run-pass/swap-overlapping.rs", "status": "added", "additions": 45, "deletions": 0, "changes": 45, "blob_url": "https://github.com/rust-lang/rust/blob/423843e54bdbd6e32a0a75b7502904458e20c480/src%2Ftest%2Frun-pass%2Fswap-overlapping.rs", "raw_url": "https://github.com/rust-lang/rust/raw/423843e54bdbd6e32a0a75b7502904458e20c480/src%2Ftest%2Frun-pass%2Fswap-overlapping.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fswap-overlapping.rs?ref=423843e54bdbd6e32a0a75b7502904458e20c480", "patch": "@@ -0,0 +1,45 @@\n+// Copyright 2013 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// Issue #5041 - avoid overlapping memcpy when src and dest of a swap are the same\n+\n+pub fn main() {\n+    let mut test = TestDescAndFn {\n+        desc: TestDesc {\n+            name: DynTestName(~\"test\"),\n+            should_fail: false\n+        },\n+        testfn: DynTestFn(|| ()),\n+    };\n+    do_swap(&mut test);\n+}\n+\n+fn do_swap(test: &mut TestDescAndFn) {\n+    *test <-> *test;\n+}\n+\n+pub enum TestName {\n+    DynTestName(~str)\n+}\n+\n+pub enum TestFn {\n+    DynTestFn(~fn()),\n+    DynBenchFn(~fn(&mut int))\n+}\n+\n+pub struct TestDesc {\n+    name: TestName,\n+    should_fail: bool\n+}\n+\n+pub struct TestDescAndFn {\n+    desc: TestDesc,\n+    testfn: TestFn,\n+}"}]}