{"sha": "9ec772e2230ad0bba99115408822253a24272150", "node_id": "C_kwDOAAsO6NoAKDllYzc3MmUyMjMwYWQwYmJhOTkxMTU0MDg4MjIyNTNhMjQyNzIxNTA", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-09-30T21:38:25Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-09-30T21:38:25Z"}, "message": "Rollup merge of #102373 - Nilstrieb:cannot-get-layout-of-branch-error, r=cjgillot\n\nFlush delayed bugs before codegen\n\nSometimes it can happen that invalid code like a TyKind::Error makes its way through the compiler without triggering any errors (this is always a bug in rustc but bugs do happen sometimes :)). These ICEs will manifest in the backend like as cg_llvm not being able to get the layout of `[type error]`, which makes it hard to debug. By flushing before codegen, we display all the delayed bugs, making it easier to trace it to the root of the problem.\n\nI tried this on #102366 and it showed tons of of delayed bugs and no error in cg_llvm, so it seems to be working.", "tree": {"sha": "1ec53ccc9a292c9a972c57e2731e547e8453fafc", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1ec53ccc9a292c9a972c57e2731e547e8453fafc"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9ec772e2230ad0bba99115408822253a24272150", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjN2HRCRBK7hj4Ov3rIwAAlDMIAC7gMSREiIwiapcR8WT/4b3P\nR+mrRlEu8yXbo4FgZ2eQ9rW69FXZPTYFmadbLrmTmrrIFB6qsb+TsfVysoHh0gBC\nxFfU9ZJbaKUcaq5Si9/2PNUpATtK3C3uUWJuO+hpwzTAxgPZzERZNtBJRNt3s/Pz\nXIQYV8nbwSOAy20u1vivB1hIgQEzgHUKinXRQN1mlh5uTyLYIFpX21WXwaIb/B/6\nwiQZ4j/i/+ift41b8E402hQ3IhkM1nw19OMkZlf6gJSnTxkBJZF6ypCzqepEeFix\nc8EkuWyhrXpEmrIuAMiLrPA3JZBDxVq3hXtnD0eqIudSO/cpnyVOWiF9wuRjzBg=\n=+20a\n-----END PGP SIGNATURE-----\n", "payload": "tree 1ec53ccc9a292c9a972c57e2731e547e8453fafc\nparent c07ebeb74bdcc61a432c873035a0623df5465894\nparent e8f1bfe1937c51c1a408c98cf810d10ead454314\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1664573905 +0200\ncommitter GitHub <noreply@github.com> 1664573905 +0200\n\nRollup merge of #102373 - Nilstrieb:cannot-get-layout-of-branch-error, r=cjgillot\n\nFlush delayed bugs before codegen\n\nSometimes it can happen that invalid code like a TyKind::Error makes its way through the compiler without triggering any errors (this is always a bug in rustc but bugs do happen sometimes :)). These ICEs will manifest in the backend like as cg_llvm not being able to get the layout of `[type error]`, which makes it hard to debug. By flushing before codegen, we display all the delayed bugs, making it easier to trace it to the root of the problem.\n\nI tried this on #102366 and it showed tons of of delayed bugs and no error in cg_llvm, so it seems to be working.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9ec772e2230ad0bba99115408822253a24272150", "html_url": "https://github.com/rust-lang/rust/commit/9ec772e2230ad0bba99115408822253a24272150", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9ec772e2230ad0bba99115408822253a24272150/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c07ebeb74bdcc61a432c873035a0623df5465894", "url": "https://api.github.com/repos/rust-lang/rust/commits/c07ebeb74bdcc61a432c873035a0623df5465894", "html_url": "https://github.com/rust-lang/rust/commit/c07ebeb74bdcc61a432c873035a0623df5465894"}, {"sha": "e8f1bfe1937c51c1a408c98cf810d10ead454314", "url": "https://api.github.com/repos/rust-lang/rust/commits/e8f1bfe1937c51c1a408c98cf810d10ead454314", "html_url": "https://github.com/rust-lang/rust/commit/e8f1bfe1937c51c1a408c98cf810d10ead454314"}], "stats": {"total": 10, "additions": 10, "deletions": 0}, "files": [{"sha": "a27c88a2a41fe7e629350486233f31f1338b5480", "filename": "compiler/rustc_errors/src/lib.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/9ec772e2230ad0bba99115408822253a24272150/compiler%2Frustc_errors%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9ec772e2230ad0bba99115408822253a24272150/compiler%2Frustc_errors%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_errors%2Fsrc%2Flib.rs?ref=9ec772e2230ad0bba99115408822253a24272150", "patch": "@@ -1134,6 +1134,12 @@ impl Handler {\n         );\n         std::mem::take(&mut self.inner.borrow_mut().fulfilled_expectations)\n     }\n+\n+    pub fn flush_delayed(&self) {\n+        let mut inner = self.inner.lock();\n+        let bugs = std::mem::replace(&mut inner.delayed_span_bugs, Vec::new());\n+        inner.flush_delayed(bugs, \"no errors encountered even though `delay_span_bug` issued\");\n+    }\n }\n \n impl HandlerInner {"}, {"sha": "91d180e1eb7e5ab7d315be4ba0ab49fdc14621dc", "filename": "compiler/rustc_interface/src/queries.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/9ec772e2230ad0bba99115408822253a24272150/compiler%2Frustc_interface%2Fsrc%2Fqueries.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9ec772e2230ad0bba99115408822253a24272150/compiler%2Frustc_interface%2Fsrc%2Fqueries.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_interface%2Fsrc%2Fqueries.rs?ref=9ec772e2230ad0bba99115408822253a24272150", "patch": "@@ -246,6 +246,10 @@ impl<'tcx> Queries<'tcx> {\n                 // Don't do code generation if there were any errors\n                 self.session().compile_status()?;\n \n+                // If we have any delayed bugs, for example because we created TyKind::Error earlier,\n+                // it's likely that codegen will only cause more ICEs, obscuring the original problem\n+                self.session().diagnostic().flush_delayed();\n+\n                 // Hook for UI tests.\n                 Self::check_for_rustc_errors_attr(tcx);\n "}]}