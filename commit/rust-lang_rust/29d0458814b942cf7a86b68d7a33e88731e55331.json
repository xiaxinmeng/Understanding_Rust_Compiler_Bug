{"sha": "29d0458814b942cf7a86b68d7a33e88731e55331", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI5ZDA0NTg4MTRiOTQyY2Y3YTg2YjY4ZDdhMzNlODg3MzFlNTUzMzE=", "commit": {"author": {"name": "Jeffrey Yasskin", "email": "jyasskin@gmail.com", "date": "2010-07-10T20:15:08Z"}, "committer": {"name": "Graydon Hoare", "email": "graydon@pobox.com", "date": "2010-07-16T00:13:07Z"}, "message": "Remove the __PAGEZERO segment from shared MachO libraries.  This avoids a\nsegfault in dlclose() and fixes the tests on OSX 10.5.8.", "tree": {"sha": "a9fcaf165fc626a10520c9c713340cea2a124ca4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a9fcaf165fc626a10520c9c713340cea2a124ca4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/29d0458814b942cf7a86b68d7a33e88731e55331", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/29d0458814b942cf7a86b68d7a33e88731e55331", "html_url": "https://github.com/rust-lang/rust/commit/29d0458814b942cf7a86b68d7a33e88731e55331", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/29d0458814b942cf7a86b68d7a33e88731e55331/comments", "author": {"login": "jyasskin", "id": 83420, "node_id": "MDQ6VXNlcjgzNDIw", "avatar_url": "https://avatars.githubusercontent.com/u/83420?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyasskin", "html_url": "https://github.com/jyasskin", "followers_url": "https://api.github.com/users/jyasskin/followers", "following_url": "https://api.github.com/users/jyasskin/following{/other_user}", "gists_url": "https://api.github.com/users/jyasskin/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyasskin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyasskin/subscriptions", "organizations_url": "https://api.github.com/users/jyasskin/orgs", "repos_url": "https://api.github.com/users/jyasskin/repos", "events_url": "https://api.github.com/users/jyasskin/events{/privacy}", "received_events_url": "https://api.github.com/users/jyasskin/received_events", "type": "User", "site_admin": false}, "committer": {"login": "graydon", "id": 14097, "node_id": "MDQ6VXNlcjE0MDk3", "avatar_url": "https://avatars.githubusercontent.com/u/14097?v=4", "gravatar_id": "", "url": "https://api.github.com/users/graydon", "html_url": "https://github.com/graydon", "followers_url": "https://api.github.com/users/graydon/followers", "following_url": "https://api.github.com/users/graydon/following{/other_user}", "gists_url": "https://api.github.com/users/graydon/gists{/gist_id}", "starred_url": "https://api.github.com/users/graydon/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/graydon/subscriptions", "organizations_url": "https://api.github.com/users/graydon/orgs", "repos_url": "https://api.github.com/users/graydon/repos", "events_url": "https://api.github.com/users/graydon/events{/privacy}", "received_events_url": "https://api.github.com/users/graydon/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9c4bc7b872569a7d71622c9f56a11e81edec741d", "url": "https://api.github.com/repos/rust-lang/rust/commits/9c4bc7b872569a7d71622c9f56a11e81edec741d", "html_url": "https://github.com/rust-lang/rust/commit/9c4bc7b872569a7d71622c9f56a11e81edec741d"}], "stats": {"total": 24, "additions": 14, "deletions": 10}, "files": [{"sha": "c2970e781556362b7a6778d87a4b586752a1738f", "filename": "src/boot/be/macho.ml", "status": "modified", "additions": 14, "deletions": 10, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/29d0458814b942cf7a86b68d7a33e88731e55331/src%2Fboot%2Fbe%2Fmacho.ml", "raw_url": "https://github.com/rust-lang/rust/raw/29d0458814b942cf7a86b68d7a33e88731e55331/src%2Fboot%2Fbe%2Fmacho.ml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fboot%2Fbe%2Fmacho.ml?ref=29d0458814b942cf7a86b68d7a33e88731e55331", "patch": "@@ -15,6 +15,14 @@ let iflog (sess:Session.sess) (thunk:(unit -> unit)) : unit =\n   else ()\n ;;\n \n+let filter_marks (orig:frag array) : frag array =\n+  let not_mark (elem:frag) =\n+    match elem with\n+        MARK -> None\n+      | x -> Some x\n+  in arr_map_partial orig not_mark\n+;;\n+\n let (cpu_arch_abi64:int64) = 0x01000000L\n ;;\n \n@@ -591,20 +599,14 @@ let macho_header_32\n     (flags:file_flag list)\n     (loadcmds:frag array) : frag =\n   let load_commands_fixup = new_fixup \"load commands\" in\n-  let count_non_mark so_far elem =\n-    match elem with\n-        MARK -> so_far\n-      | _ -> so_far + 1\n-  in\n   let cmds = DEF (load_commands_fixup, SEQ loadcmds) in\n     SEQ\n     [|\n       WORD (TY_u32, IMM mh_magic);\n       WORD (TY_u32, IMM (cpu_type_code cpu));\n       WORD (TY_u32, IMM (cpu_subtype_code sub));\n       WORD (TY_u32, IMM (file_type_code ftype));\n-      WORD (TY_u32,\n-            IMM (Int64.of_int (Array.fold_left count_non_mark 0 loadcmds)));\n+      WORD (TY_u32, IMM (Int64.of_int (Array.length loadcmds)));\n       WORD (TY_u32, F_SZ load_commands_fixup);\n       WORD (TY_u32, IMM (fold_flags file_flag_code flags));\n       cmds\n@@ -873,8 +875,10 @@ let emit_file\n \n   let load_commands =\n     [|\n-      macho_segment_command \"__PAGEZERO\" zero_segment_fixup\n-        [] [] [||];\n+      if sess.Session.sess_library_mode\n+      then MARK\n+      else (macho_segment_command \"__PAGEZERO\" zero_segment_fixup\n+              [] [] [||]);\n \n       macho_segment_command \"__TEXT\" text_segment_fixup\n         [VM_PROT_READ; VM_PROT_EXECUTE]\n@@ -949,7 +953,7 @@ let emit_file\n       CPU_SUBTYPE_X86_ALL\n       (if sess.Session.sess_library_mode then MH_DYLIB else MH_EXECUTE)\n       [ MH_BINDATLOAD; MH_DYLDLINK; MH_TWOLEVEL ]\n-      load_commands\n+      (filter_marks load_commands)\n   in\n \n   let objfile_start e start_fixup rust_start_fixup main_fn_fixup ="}]}