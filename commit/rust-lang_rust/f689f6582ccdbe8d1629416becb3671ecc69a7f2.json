{"sha": "f689f6582ccdbe8d1629416becb3671ecc69a7f2", "node_id": "C_kwDOAAsO6NoAKGY2ODlmNjU4MmNjZGJlOGQxNjI5NDE2YmVjYjM2NzFlY2M2OWE3ZjI", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2022-05-10T15:09:32Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-05-10T15:09:32Z"}, "message": "Rollup merge of #96725 - nico-abram:win_tid, r=ChrisDenton\n\nExpose process windows_process_extensions_main_thread_handle on Windows\n\n~~I did not find any tests in https://github.com/rust-lang/rust/blob/7d3e03666a93bd2b0f78b3933f9305832af771a5/library/std/src/sys/windows/process/tests.rs that actually launch processes, so I haven't added tests for this.~~ I ran the following locally, to check that it works as expected:\n```rs\n#![feature(windows_process_extensions_main_thread_handle)]\n\nfn main() {\n    use std::os::windows::process::{ChildExt, CommandExt};\n    const CREATE_SUSPENDED: u32 = 0x00000004;\n\n    let proc = std::process::Command::new(\"cmd\")\n        .args([\"/C\", \"echo hello\"])\n        .creation_flags(CREATE_SUSPENDED)\n        .spawn()\n        .unwrap();\n\n    extern \"system\" {\n        fn ResumeThread(_: *mut std::ffi::c_void) -> u32;\n    }\n    unsafe {\n        ResumeThread(proc.main_thread_handle());\n    }\n\n    let output = proc.wait_with_output().unwrap();\n    let str_output = std::str::from_utf8(&output.stdout[..]).unwrap();\n    println!(\"{}\", str_output);\n}\n\n```\n\nWithout the feature attribute it wouldn't compile, and commenting the `ResumeThread` line makes it hang forever, showing that it works.\n\nTrakcing issue https://github.com/rust-lang/rust/issues/96723", "tree": {"sha": "cf5d98f16f8012c4eaa6354e57f9ff7293571f78", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/cf5d98f16f8012c4eaa6354e57f9ff7293571f78"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f689f6582ccdbe8d1629416becb3671ecc69a7f2", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJieoAsCRBK7hj4Ov3rIwAAB60IAJ1e58L+ha1QMF5kVxHqKfD8\n5qMKYfeswufJVlReNhbv+/c8UWbKvKX109GCMPCb2EDyN9v9z/b6Of0n/7E6XloR\nHMUYezOdwh+PGtMYCDEpn1qMyyCMdMT2GyRziiKGmKl76AYT/bDuHJp/deruxeL1\nUV5fgzWAMS1dak1mVr7CnUigL0hGDaL0QcwBcIgxq5yH4rlrA3O+xB2PcfhQ+dJH\n2OtS/OCAiMUvkZNIdIA1R2mf2vcw0md5xSrzpZ78GcTk6BtLaGomevjYPBPCWOnU\nEgVMC5mbMSnsI7AvCHifB4UyE2wJaM7gyI552T18zSwOzq2PAA+UZMFpTJG3pww=\n=jopK\n-----END PGP SIGNATURE-----\n", "payload": "tree cf5d98f16f8012c4eaa6354e57f9ff7293571f78\nparent 77030b7825796461f10ee5dd774caa46ad09c64a\nparent 5368ea7d2eae4e86c1c7a68197506d062bc1689d\nauthor Yuki Okushi <jtitor@2k36.org> 1652195372 +0900\ncommitter GitHub <noreply@github.com> 1652195372 +0900\n\nRollup merge of #96725 - nico-abram:win_tid, r=ChrisDenton\n\nExpose process windows_process_extensions_main_thread_handle on Windows\n\n~~I did not find any tests in https://github.com/rust-lang/rust/blob/7d3e03666a93bd2b0f78b3933f9305832af771a5/library/std/src/sys/windows/process/tests.rs that actually launch processes, so I haven't added tests for this.~~ I ran the following locally, to check that it works as expected:\n```rs\n#![feature(windows_process_extensions_main_thread_handle)]\n\nfn main() {\n    use std::os::windows::process::{ChildExt, CommandExt};\n    const CREATE_SUSPENDED: u32 = 0x00000004;\n\n    let proc = std::process::Command::new(\"cmd\")\n        .args([\"/C\", \"echo hello\"])\n        .creation_flags(CREATE_SUSPENDED)\n        .spawn()\n        .unwrap();\n\n    extern \"system\" {\n        fn ResumeThread(_: *mut std::ffi::c_void) -> u32;\n    }\n    unsafe {\n        ResumeThread(proc.main_thread_handle());\n    }\n\n    let output = proc.wait_with_output().unwrap();\n    let str_output = std::str::from_utf8(&output.stdout[..]).unwrap();\n    println!(\"{}\", str_output);\n}\n\n```\n\nWithout the feature attribute it wouldn't compile, and commenting the `ResumeThread` line makes it hang forever, showing that it works.\n\nTrakcing issue https://github.com/rust-lang/rust/issues/96723\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f689f6582ccdbe8d1629416becb3671ecc69a7f2", "html_url": "https://github.com/rust-lang/rust/commit/f689f6582ccdbe8d1629416becb3671ecc69a7f2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f689f6582ccdbe8d1629416becb3671ecc69a7f2/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "77030b7825796461f10ee5dd774caa46ad09c64a", "url": "https://api.github.com/repos/rust-lang/rust/commits/77030b7825796461f10ee5dd774caa46ad09c64a", "html_url": "https://github.com/rust-lang/rust/commit/77030b7825796461f10ee5dd774caa46ad09c64a"}, {"sha": "5368ea7d2eae4e86c1c7a68197506d062bc1689d", "url": "https://api.github.com/repos/rust-lang/rust/commits/5368ea7d2eae4e86c1c7a68197506d062bc1689d", "html_url": "https://github.com/rust-lang/rust/commit/5368ea7d2eae4e86c1c7a68197506d062bc1689d"}], "stats": {"total": 59, "additions": 52, "deletions": 7}, "files": [{"sha": "1c7e361c2a4a8d3767ea98b9e140ffce68c71c2c", "filename": "library/std/src/os/windows/process.rs", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/f689f6582ccdbe8d1629416becb3671ecc69a7f2/library%2Fstd%2Fsrc%2Fos%2Fwindows%2Fprocess.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f689f6582ccdbe8d1629416becb3671ecc69a7f2/library%2Fstd%2Fsrc%2Fos%2Fwindows%2Fprocess.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fos%2Fwindows%2Fprocess.rs?ref=f689f6582ccdbe8d1629416becb3671ecc69a7f2", "patch": "@@ -180,3 +180,17 @@ impl CommandExt for process::Command {\n         self\n     }\n }\n+\n+#[unstable(feature = \"windows_process_extensions_main_thread_handle\", issue = \"96723\")]\n+pub trait ChildExt: Sealed {\n+    /// Extracts the main thread raw handle, without taking ownership\n+    #[unstable(feature = \"windows_process_extensions_main_thread_handle\", issue = \"96723\")]\n+    fn main_thread_handle(&self) -> BorrowedHandle<'_>;\n+}\n+\n+#[unstable(feature = \"windows_process_extensions_main_thread_handle\", issue = \"96723\")]\n+impl ChildExt for process::Child {\n+    fn main_thread_handle(&self) -> BorrowedHandle<'_> {\n+        self.handle.main_thread_handle()\n+    }\n+}"}, {"sha": "476b4b21cb1c0e7b90888d7ec51e1581b3b702d7", "filename": "library/std/src/sys/windows/process.rs", "status": "modified", "additions": 13, "deletions": 7, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/f689f6582ccdbe8d1629416becb3671ecc69a7f2/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fprocess.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f689f6582ccdbe8d1629416becb3671ecc69a7f2/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fprocess.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fprocess.rs?ref=f689f6582ccdbe8d1629416becb3671ecc69a7f2", "patch": "@@ -14,7 +14,7 @@ use crate::io::{self, Error, ErrorKind};\n use crate::mem;\n use crate::num::NonZeroI32;\n use crate::os::windows::ffi::{OsStrExt, OsStringExt};\n-use crate::os::windows::io::{AsRawHandle, FromRawHandle, IntoRawHandle};\n+use crate::os::windows::io::{AsHandle, AsRawHandle, BorrowedHandle, FromRawHandle, IntoRawHandle};\n use crate::path::{Path, PathBuf};\n use crate::ptr;\n use crate::sys::args::{self, Arg};\n@@ -334,13 +334,14 @@ impl Command {\n             ))\n         }?;\n \n-        // We close the thread handle because we don't care about keeping\n-        // the thread id valid, and we aren't keeping the thread handle\n-        // around to be able to close it later.\n         unsafe {\n-            drop(Handle::from_raw_handle(pi.hThread));\n-\n-            Ok((Process { handle: Handle::from_raw_handle(pi.hProcess) }, pipes))\n+            Ok((\n+                Process {\n+                    handle: Handle::from_raw_handle(pi.hProcess),\n+                    main_thread_handle: Handle::from_raw_handle(pi.hThread),\n+                },\n+                pipes,\n+            ))\n         }\n     }\n }\n@@ -609,6 +610,7 @@ impl From<File> for Stdio {\n /// for the process to terminate.\n pub struct Process {\n     handle: Handle,\n+    main_thread_handle: Handle,\n }\n \n impl Process {\n@@ -621,6 +623,10 @@ impl Process {\n         unsafe { c::GetProcessId(self.handle.as_raw_handle()) as u32 }\n     }\n \n+    pub fn main_thread_handle(&self) -> BorrowedHandle<'_> {\n+        self.main_thread_handle.as_handle()\n+    }\n+\n     pub fn wait(&mut self) -> io::Result<ExitStatus> {\n         unsafe {\n             let res = c::WaitForSingleObject(self.handle.as_raw_handle(), c::INFINITE);"}, {"sha": "3fc0c75240c33c0adede4c91f73c1d77fcde74e2", "filename": "library/std/src/sys/windows/process/tests.rs", "status": "modified", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/f689f6582ccdbe8d1629416becb3671ecc69a7f2/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fprocess%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f689f6582ccdbe8d1629416becb3671ecc69a7f2/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fprocess%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fprocess%2Ftests.rs?ref=f689f6582ccdbe8d1629416becb3671ecc69a7f2", "patch": "@@ -24,6 +24,31 @@ fn test_raw_args() {\n     );\n }\n \n+#[test]\n+fn test_thread_handle() {\n+    use crate::os::windows::io::BorrowedHandle;\n+    use crate::os::windows::process::{ChildExt, CommandExt};\n+    const CREATE_SUSPENDED: u32 = 0x00000004;\n+\n+    let p = Command::new(\"cmd\").args(&[\"/C\", \"exit 0\"]).creation_flags(CREATE_SUSPENDED).spawn();\n+    assert!(p.is_ok());\n+    let mut p = p.unwrap();\n+\n+    extern \"system\" {\n+        fn ResumeThread(_: BorrowedHandle<'_>) -> u32;\n+    }\n+    unsafe {\n+        ResumeThread(p.main_thread_handle());\n+    }\n+\n+    crate::thread::sleep(crate::time::Duration::from_millis(100));\n+\n+    let res = p.try_wait();\n+    assert!(res.is_ok());\n+    assert!(res.unwrap().is_some());\n+    assert!(p.try_wait().unwrap().unwrap().success());\n+}\n+\n #[test]\n fn test_make_command_line() {\n     fn test_wrapper(prog: &str, args: &[&str], force_quotes: bool) -> String {"}]}