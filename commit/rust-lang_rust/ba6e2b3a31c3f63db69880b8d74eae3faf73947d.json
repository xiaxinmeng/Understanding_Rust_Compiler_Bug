{"sha": "ba6e2b3a31c3f63db69880b8d74eae3faf73947d", "node_id": "MDY6Q29tbWl0NzI0NzEyOmJhNmUyYjNhMzFjM2Y2M2RiNjk4ODBiOGQ3NGVhZTNmYWY3Mzk0N2Q=", "commit": {"author": {"name": "Tyler Mandry", "email": "tmandry@gmail.com", "date": "2020-09-10T04:02:35Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-09-10T04:02:35Z"}, "message": "Rollup merge of #76500 - richkadel:mir-graphviz-dark, r=tmandry\n\nAdd -Zgraphviz_dark_mode and monospace font fix\n\nMany developers use a dark theme with editors and IDEs, but this\ntypically doesn't extend to graphviz output.\n\nWhen I bring up a MIR graphviz document, the white background is\nstrikingly bright. This new option changes the colors used for graphviz\noutput to work better in dark-themed UIs.\n\n<img width=\"1305\" alt=\"Screen Shot 2020-09-09 at 3 00 31 PM\" src=\"https://user-images.githubusercontent.com/3827298/92659478-4b9bff00-f2ad-11ea-8894-b40d3a873cb9.png\">\n\nAlso fixed the monospace font for common graphviz renders (e.g., VS Code extensions), as described in https://github.com/rust-lang/rust/pull/76500#issuecomment-689837948\n\n**Before:**\n<img width=\"943\" alt=\"Screen Shot 2020-09-09 at 2 48 44 PM\" src=\"https://user-images.githubusercontent.com/3827298/92658939-47231680-f2ac-11ea-97ac-96727e4dd622.png\">\n\n**Now with fix:**\n<img width=\"943\" alt=\"Screen Shot 2020-09-09 at 2 49 02 PM\" src=\"https://user-images.githubusercontent.com/3827298/92658959-51451500-f2ac-11ea-9aae-de982d466d6a.png\">", "tree": {"sha": "6370e3146b4c3a47804c99969a498eb69a00d504", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6370e3146b4c3a47804c99969a498eb69a00d504"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ba6e2b3a31c3f63db69880b8d74eae3faf73947d", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfWaVbCRBK7hj4Ov3rIwAAdHIIAKpkWTkJcoBqaQbLD4TzHnQO\nBW6QqD2azb2Ey8KDQf36A5GBEPkdkt70R1Sv/Zqlty2F7KF35UOPmJlS+KIdyYll\nHfwVhr9RoRoTFt+LEUOu/oH5EaKteASwslsDGdl7Xv5ztUGQJ+qVGTsOm+8usEOn\nuOscT9CgWf7G9Nip1R83iCcpbneT6Y+4TP13V1aWhvJUHOMfLRZV4GL1QMfXKP72\nLSuzN3zie/r41n308Oj/iPx0TdoutUCITy+nt2o8H1ByJD9gNOVNHNH8dcELeEaW\nIERYfFaboEt6CA6rC0NLUjI64ABI2tSJDF91vlo2oo+e7ojsFx68vLvIsgavKU8=\n=o+yw\n-----END PGP SIGNATURE-----\n", "payload": "tree 6370e3146b4c3a47804c99969a498eb69a00d504\nparent d013e60ad479e086aae044a2e613510976bcb261\nparent f7aee330c70ef787d2224adb49804343978dd145\nauthor Tyler Mandry <tmandry@gmail.com> 1599710555 -0700\ncommitter GitHub <noreply@github.com> 1599710555 -0700\n\nRollup merge of #76500 - richkadel:mir-graphviz-dark, r=tmandry\n\nAdd -Zgraphviz_dark_mode and monospace font fix\n\nMany developers use a dark theme with editors and IDEs, but this\ntypically doesn't extend to graphviz output.\n\nWhen I bring up a MIR graphviz document, the white background is\nstrikingly bright. This new option changes the colors used for graphviz\noutput to work better in dark-themed UIs.\n\n<img width=\"1305\" alt=\"Screen Shot 2020-09-09 at 3 00 31 PM\" src=\"https://user-images.githubusercontent.com/3827298/92659478-4b9bff00-f2ad-11ea-8894-b40d3a873cb9.png\">\n\nAlso fixed the monospace font for common graphviz renders (e.g., VS Code extensions), as described in https://github.com/rust-lang/rust/pull/76500#issuecomment-689837948\n\n**Before:**\n<img width=\"943\" alt=\"Screen Shot 2020-09-09 at 2 48 44 PM\" src=\"https://user-images.githubusercontent.com/3827298/92658939-47231680-f2ac-11ea-97ac-96727e4dd622.png\">\n\n**Now with fix:**\n<img width=\"943\" alt=\"Screen Shot 2020-09-09 at 2 49 02 PM\" src=\"https://user-images.githubusercontent.com/3827298/92658959-51451500-f2ac-11ea-9aae-de982d466d6a.png\">\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ba6e2b3a31c3f63db69880b8d74eae3faf73947d", "html_url": "https://github.com/rust-lang/rust/commit/ba6e2b3a31c3f63db69880b8d74eae3faf73947d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ba6e2b3a31c3f63db69880b8d74eae3faf73947d/comments", "author": {"login": "tmandry", "id": 2280544, "node_id": "MDQ6VXNlcjIyODA1NDQ=", "avatar_url": "https://avatars.githubusercontent.com/u/2280544?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmandry", "html_url": "https://github.com/tmandry", "followers_url": "https://api.github.com/users/tmandry/followers", "following_url": "https://api.github.com/users/tmandry/following{/other_user}", "gists_url": "https://api.github.com/users/tmandry/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmandry/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmandry/subscriptions", "organizations_url": "https://api.github.com/users/tmandry/orgs", "repos_url": "https://api.github.com/users/tmandry/repos", "events_url": "https://api.github.com/users/tmandry/events{/privacy}", "received_events_url": "https://api.github.com/users/tmandry/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d013e60ad479e086aae044a2e613510976bcb261", "url": "https://api.github.com/repos/rust-lang/rust/commits/d013e60ad479e086aae044a2e613510976bcb261", "html_url": "https://github.com/rust-lang/rust/commit/d013e60ad479e086aae044a2e613510976bcb261"}, {"sha": "f7aee330c70ef787d2224adb49804343978dd145", "url": "https://api.github.com/repos/rust-lang/rust/commits/f7aee330c70ef787d2224adb49804343978dd145", "html_url": "https://github.com/rust-lang/rust/commit/f7aee330c70ef787d2224adb49804343978dd145"}], "stats": {"total": 63, "additions": 49, "deletions": 14}, "files": [{"sha": "29ec3572016d759185989c8c6efb1e9f7d941eb0", "filename": "compiler/rustc_graphviz/src/lib.rs", "status": "modified", "additions": 17, "deletions": 3, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/ba6e2b3a31c3f63db69880b8d74eae3faf73947d/compiler%2Frustc_graphviz%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ba6e2b3a31c3f63db69880b8d74eae3faf73947d/compiler%2Frustc_graphviz%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_graphviz%2Fsrc%2Flib.rs?ref=ba6e2b3a31c3f63db69880b8d74eae3faf73947d", "patch": "@@ -599,6 +599,7 @@ pub enum RenderOption {\n     NoNodeStyles,\n \n     Monospace,\n+    DarkTheme,\n }\n \n /// Returns vec holding all the default render options.\n@@ -630,10 +631,23 @@ where\n     writeln!(w, \"digraph {} {{\", g.graph_id().as_slice())?;\n \n     // Global graph properties\n+    let mut graph_attrs = Vec::new();\n+    let mut content_attrs = Vec::new();\n     if options.contains(&RenderOption::Monospace) {\n-        writeln!(w, r#\"    graph[fontname=\"monospace\"];\"#)?;\n-        writeln!(w, r#\"    node[fontname=\"monospace\"];\"#)?;\n-        writeln!(w, r#\"    edge[fontname=\"monospace\"];\"#)?;\n+        let font = r#\"fontname=\"Courier, monospace\"\"#;\n+        graph_attrs.push(font);\n+        content_attrs.push(font);\n+    };\n+    if options.contains(&RenderOption::DarkTheme) {\n+        graph_attrs.push(r#\"bgcolor=\"black\"\"#);\n+        content_attrs.push(r#\"color=\"white\"\"#);\n+        content_attrs.push(r#\"fontcolor=\"white\"\"#);\n+    }\n+    if !(graph_attrs.is_empty() && content_attrs.is_empty()) {\n+        writeln!(w, r#\"    graph[{}];\"#, graph_attrs.join(\" \"))?;\n+        let content_attrs_str = content_attrs.join(\" \");\n+        writeln!(w, r#\"    node[{}];\"#, content_attrs_str)?;\n+        writeln!(w, r#\"    edge[{}];\"#, content_attrs_str)?;\n     }\n \n     for n in g.nodes().iter() {"}, {"sha": "0b5b437d186aade4297534aaa699ff0327276eee", "filename": "compiler/rustc_mir/src/dataflow/framework/engine.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/ba6e2b3a31c3f63db69880b8d74eae3faf73947d/compiler%2Frustc_mir%2Fsrc%2Fdataflow%2Fframework%2Fengine.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ba6e2b3a31c3f63db69880b8d74eae3faf73947d/compiler%2Frustc_mir%2Fsrc%2Fdataflow%2Fframework%2Fengine.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Fdataflow%2Fframework%2Fengine.rs?ref=ba6e2b3a31c3f63db69880b8d74eae3faf73947d", "patch": "@@ -306,7 +306,11 @@ where\n     let mut buf = Vec::new();\n \n     let graphviz = graphviz::Formatter::new(body, def_id, results, style);\n-    dot::render_opts(&graphviz, &mut buf, &[dot::RenderOption::Monospace])?;\n+    let mut render_opts = vec![dot::RenderOption::Monospace];\n+    if tcx.sess.opts.debugging_opts.graphviz_dark_mode {\n+        render_opts.push(dot::RenderOption::DarkTheme);\n+    }\n+    dot::render_opts(&graphviz, &mut buf, &render_opts)?;\n \n     if let Some(parent) = path.parent() {\n         fs::create_dir_all(parent)?;"}, {"sha": "e89c9437706384e3a8ff65ca067135485f72a9dc", "filename": "compiler/rustc_mir/src/util/graphviz.rs", "status": "modified", "additions": 22, "deletions": 7, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/ba6e2b3a31c3f63db69880b8d74eae3faf73947d/compiler%2Frustc_mir%2Fsrc%2Futil%2Fgraphviz.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ba6e2b3a31c3f63db69880b8d74eae3faf73947d/compiler%2Frustc_mir%2Fsrc%2Futil%2Fgraphviz.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Futil%2Fgraphviz.rs?ref=ba6e2b3a31c3f63db69880b8d74eae3faf73947d", "patch": "@@ -55,16 +55,28 @@ where\n     writeln!(w, \"{} {}Mir_{} {{\", kind, cluster, def_name)?;\n \n     // Global graph properties\n-    writeln!(w, r#\"    graph [fontname=\"monospace\"];\"#)?;\n-    writeln!(w, r#\"    node [fontname=\"monospace\"];\"#)?;\n-    writeln!(w, r#\"    edge [fontname=\"monospace\"];\"#)?;\n+    let font = r#\"fontname=\"Courier, monospace\"\"#;\n+    let mut graph_attrs = vec![font];\n+    let mut content_attrs = vec![font];\n+\n+    let dark_mode = tcx.sess.opts.debugging_opts.graphviz_dark_mode;\n+    if dark_mode {\n+        graph_attrs.push(r#\"bgcolor=\"black\"\"#);\n+        content_attrs.push(r#\"color=\"white\"\"#);\n+        content_attrs.push(r#\"fontcolor=\"white\"\"#);\n+    }\n+\n+    writeln!(w, r#\"    graph [{}];\"#, graph_attrs.join(\" \"))?;\n+    let content_attrs_str = content_attrs.join(\" \");\n+    writeln!(w, r#\"    node [{}];\"#, content_attrs_str)?;\n+    writeln!(w, r#\"    edge [{}];\"#, content_attrs_str)?;\n \n     // Graph label\n     write_graph_label(tcx, def_id, body, w)?;\n \n     // Nodes\n     for (block, _) in body.basic_blocks().iter_enumerated() {\n-        write_node(def_id, block, body, w)?;\n+        write_node(def_id, block, body, dark_mode, w)?;\n     }\n \n     // Edges\n@@ -84,6 +96,7 @@ where\n pub fn write_node_label<W: Write, INIT, FINI>(\n     block: BasicBlock,\n     body: &Body<'_>,\n+    dark_mode: bool,\n     w: &mut W,\n     num_cols: u32,\n     init: INIT,\n@@ -100,8 +113,9 @@ where\n     // Basic block number at the top.\n     write!(\n         w,\n-        r#\"<tr><td {attrs} colspan=\"{colspan}\">{blk}</td></tr>\"#,\n-        attrs = r#\"bgcolor=\"gray\" align=\"center\"\"#,\n+        r#\"<tr><td bgcolor=\"{bgcolor}\" {attrs} colspan=\"{colspan}\">{blk}</td></tr>\"#,\n+        bgcolor = if dark_mode { \"dimgray\" } else { \"gray\" },\n+        attrs = r#\"align=\"center\"\"#,\n         colspan = num_cols,\n         blk = block.index()\n     )?;\n@@ -134,11 +148,12 @@ fn write_node<W: Write>(\n     def_id: DefId,\n     block: BasicBlock,\n     body: &Body<'_>,\n+    dark_mode: bool,\n     w: &mut W,\n ) -> io::Result<()> {\n     // Start a new node with the label to follow, in one of DOT's pseudo-HTML tables.\n     write!(w, r#\"    {} [shape=\"none\", label=<\"#, node(def_id, block))?;\n-    write_node_label(block, body, w, 1, |_| Ok(()), |_| Ok(()))?;\n+    write_node_label(block, body, dark_mode, w, 1, |_| Ok(()), |_| Ok(()))?;\n     // Close the node label and the node itself.\n     writeln!(w, \">];\")\n }"}, {"sha": "c5050dbea73394efc094fcede30ee8bc3436adbe", "filename": "compiler/rustc_session/src/options.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ba6e2b3a31c3f63db69880b8d74eae3faf73947d/compiler%2Frustc_session%2Fsrc%2Foptions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ba6e2b3a31c3f63db69880b8d74eae3faf73947d/compiler%2Frustc_session%2Fsrc%2Foptions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Foptions.rs?ref=ba6e2b3a31c3f63db69880b8d74eae3faf73947d", "patch": "@@ -909,6 +909,8 @@ options! {DebuggingOptions, DebuggingSetter, basic_debugging_options,\n         \"force all crates to be `rustc_private` unstable (default: no)\"),\n     fuel: Option<(String, u64)> = (None, parse_optimization_fuel, [TRACKED],\n         \"set the optimization fuel quota for a crate\"),\n+    graphviz_dark_mode: bool = (false, parse_bool, [UNTRACKED],\n+        \"use dark-themed colors in graphviz output (default: no)\"),\n     hir_stats: bool = (false, parse_bool, [UNTRACKED],\n         \"print some statistics about AST and HIR (default: no)\"),\n     human_readable_cgu_names: bool = (false, parse_bool, [TRACKED],"}, {"sha": "df4f11f0f21693ba41f3eea94f223781aa62d80d", "filename": "src/test/mir-opt/graphviz.main.mir_map.0.dot", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/ba6e2b3a31c3f63db69880b8d74eae3faf73947d/src%2Ftest%2Fmir-opt%2Fgraphviz.main.mir_map.0.dot", "raw_url": "https://github.com/rust-lang/rust/raw/ba6e2b3a31c3f63db69880b8d74eae3faf73947d/src%2Ftest%2Fmir-opt%2Fgraphviz.main.mir_map.0.dot", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fgraphviz.main.mir_map.0.dot?ref=ba6e2b3a31c3f63db69880b8d74eae3faf73947d", "patch": "@@ -1,7 +1,7 @@\n digraph Mir_0_3 {\n-    graph [fontname=\"monospace\"];\n-    node [fontname=\"monospace\"];\n-    edge [fontname=\"monospace\"];\n+    graph [fontname=\"Courier, monospace\"];\n+    node [fontname=\"Courier, monospace\"];\n+    edge [fontname=\"Courier, monospace\"];\n     label=<fn main() -&gt; ()<br align=\"left\"/>>;\n     bb0__0_3 [shape=\"none\", label=<<table border=\"0\" cellborder=\"1\" cellspacing=\"0\"><tr><td bgcolor=\"gray\" align=\"center\" colspan=\"1\">0</td></tr><tr><td align=\"left\" balign=\"left\">_0 = const ()<br/></td></tr><tr><td align=\"left\">goto</td></tr></table>>];\n     bb1__0_3 [shape=\"none\", label=<<table border=\"0\" cellborder=\"1\" cellspacing=\"0\"><tr><td bgcolor=\"gray\" align=\"center\" colspan=\"1\">1</td></tr><tr><td align=\"left\">resume</td></tr></table>>];"}]}