{"sha": "f24aa7a45ad6ffbbae56d5bca50afd6aefa1a4c7", "node_id": "MDY6Q29tbWl0NzI0NzEyOmYyNGFhN2E0NWFkNmZmYmJhZTU2ZDViY2E1MGFmZDZhZWZhMWE0Yzc=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2019-11-22T09:27:13Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-11-22T09:27:13Z"}, "message": "Merge #2351\n\n2351: Rename Atts trait r=matklad a=matklad\n\n\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>", "tree": {"sha": "286d7f91a45aa132691729a98302b687f677b643", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/286d7f91a45aa132691729a98302b687f677b643"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f24aa7a45ad6ffbbae56d5bca50afd6aefa1a4c7", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJd16nxCRBK7hj4Ov3rIwAAdHIIAD+aI+adGkk0XboQL9hLQttV\naIhk8Cx7J3z3yN+M8dGLQTsaMH6JigsITDKmgcFoRHHpuu85OiBsqQrLW3dNnwnz\nKXVyBd5ZVFm8+veIxbWYu8DnY1evbOPdlw1hVLxmy/9gUgh9aOEUMSPerEJOwAmS\niq0OTqbcaozXx36RyHf/i9/8JIA4VhWOlW08pod2E38TZK9wCn6QqL7Y9yI1kQme\nCNJfgkeJVpMv8cbk2Vn4NoQMoUPKZppI+Xj6FRh8Dzfy7BJc8V07aE/Hj3TMb046\nQWO7sSnTzXDv323HupE7Ms/IboRBVXeqpuUQsLUHCd7ORPmORa0RVRlj56VePeg=\n=qQJo\n-----END PGP SIGNATURE-----\n", "payload": "tree 286d7f91a45aa132691729a98302b687f677b643\nparent d59bf33b9e1c20d6ef3fd9b72f3cf4730172b5a8\nparent a87e9145a67634a5ea8a893ab8b52b3c07108a13\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1574414833 +0000\ncommitter GitHub <noreply@github.com> 1574414833 +0000\n\nMerge #2351\n\n2351: Rename Atts trait r=matklad a=matklad\n\n\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f24aa7a45ad6ffbbae56d5bca50afd6aefa1a4c7", "html_url": "https://github.com/rust-lang/rust/commit/f24aa7a45ad6ffbbae56d5bca50afd6aefa1a4c7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f24aa7a45ad6ffbbae56d5bca50afd6aefa1a4c7/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d59bf33b9e1c20d6ef3fd9b72f3cf4730172b5a8", "url": "https://api.github.com/repos/rust-lang/rust/commits/d59bf33b9e1c20d6ef3fd9b72f3cf4730172b5a8", "html_url": "https://github.com/rust-lang/rust/commit/d59bf33b9e1c20d6ef3fd9b72f3cf4730172b5a8"}, {"sha": "a87e9145a67634a5ea8a893ab8b52b3c07108a13", "url": "https://api.github.com/repos/rust-lang/rust/commits/a87e9145a67634a5ea8a893ab8b52b3c07108a13", "html_url": "https://github.com/rust-lang/rust/commit/a87e9145a67634a5ea8a893ab8b52b3c07108a13"}], "stats": {"total": 114, "additions": 63, "deletions": 51}, "files": [{"sha": "96da8c88c44048feaa44139d162d1d2eda6b22aa", "filename": "crates/ra_hir/src/code_model/attrs.rs", "status": "modified", "additions": 12, "deletions": 13, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/f24aa7a45ad6ffbbae56d5bca50afd6aefa1a4c7/crates%2Fra_hir%2Fsrc%2Fcode_model%2Fattrs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f24aa7a45ad6ffbbae56d5bca50afd6aefa1a4c7/crates%2Fra_hir%2Fsrc%2Fcode_model%2Fattrs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fcode_model%2Fattrs.rs?ref=f24aa7a45ad6ffbbae56d5bca50afd6aefa1a4c7", "patch": "@@ -5,10 +5,9 @@ use crate::{\n     Adt, Const, Enum, EnumVariant, FieldSource, Function, HasSource, MacroDef, Module, Static,\n     Struct, StructField, Trait, TypeAlias, Union,\n };\n-use hir_def::attr::Attr;\n+use hir_def::attr::{Attr, Attrs};\n use hir_expand::hygiene::Hygiene;\n use ra_syntax::ast;\n-use std::sync::Arc;\n \n #[derive(Clone, Copy, Debug, PartialEq, Eq, Hash)]\n pub enum AttrDef {\n@@ -37,17 +36,17 @@ impl_froms!(\n     MacroDef\n );\n \n-pub trait Attrs {\n-    fn attrs(&self, db: &impl HirDatabase) -> Option<Arc<[Attr]>>;\n+pub trait HasAttrs {\n+    fn attrs(&self, db: &impl HirDatabase) -> Attrs;\n }\n \n-pub(crate) fn attributes_query(\n-    db: &(impl DefDatabase + AstDatabase),\n-    def: AttrDef,\n-) -> Option<Arc<[Attr]>> {\n+pub(crate) fn attributes_query(db: &(impl DefDatabase + AstDatabase), def: AttrDef) -> Attrs {\n     match def {\n         AttrDef::Module(it) => {\n-            let src = it.declaration_source(db)?;\n+            let src = match it.declaration_source(db) {\n+                Some(it) => it,\n+                None => return Attrs::default(),\n+            };\n             let hygiene = Hygiene::new(db, src.file_id);\n             Attr::from_attrs_owner(&src.value, &hygiene)\n         }\n@@ -57,7 +56,7 @@ pub(crate) fn attributes_query(\n                 let hygiene = Hygiene::new(db, src.file_id);\n                 Attr::from_attrs_owner(&named, &hygiene)\n             }\n-            FieldSource::Pos(..) => None,\n+            FieldSource::Pos(..) => Attrs::default(),\n         },\n         AttrDef::Adt(it) => match it {\n             Adt::Struct(it) => attrs_from_ast(it, db),\n@@ -74,7 +73,7 @@ pub(crate) fn attributes_query(\n     }\n }\n \n-fn attrs_from_ast<T, D>(node: T, db: &D) -> Option<Arc<[Attr]>>\n+fn attrs_from_ast<T, D>(node: T, db: &D) -> Attrs\n where\n     T: HasSource,\n     T::Ast: ast::AttrsOwner,\n@@ -85,8 +84,8 @@ where\n     Attr::from_attrs_owner(&src.value, &hygiene)\n }\n \n-impl<T: Into<AttrDef> + Copy> Attrs for T {\n-    fn attrs(&self, db: &impl HirDatabase) -> Option<Arc<[Attr]>> {\n+impl<T: Into<AttrDef> + Copy> HasAttrs for T {\n+    fn attrs(&self, db: &impl HirDatabase) -> Attrs {\n         db.attrs((*self).into())\n     }\n }"}, {"sha": "1f63be3b92794aba840b50b90ec1a6d5ad9d37b2", "filename": "crates/ra_hir/src/db.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/f24aa7a45ad6ffbbae56d5bca50afd6aefa1a4c7/crates%2Fra_hir%2Fsrc%2Fdb.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f24aa7a45ad6ffbbae56d5bca50afd6aefa1a4c7/crates%2Fra_hir%2Fsrc%2Fdb.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fdb.rs?ref=f24aa7a45ad6ffbbae56d5bca50afd6aefa1a4c7", "patch": "@@ -2,7 +2,7 @@\n \n use std::sync::Arc;\n \n-use hir_def::attr::Attr;\n+use hir_def::attr::Attrs;\n use ra_db::salsa;\n use ra_syntax::SmolStr;\n \n@@ -61,7 +61,7 @@ pub trait DefDatabase: HirDebugDatabase + DefDatabase2 {\n     fn documentation(&self, def: crate::DocDef) -> Option<crate::Documentation>;\n \n     #[salsa::invoke(crate::code_model::attrs::attributes_query)]\n-    fn attrs(&self, def: crate::AttrDef) -> Option<Arc<[Attr]>>;\n+    fn attrs(&self, def: crate::AttrDef) -> Attrs;\n }\n \n #[salsa::query_group(HirDatabaseStorage)]"}, {"sha": "915ca46fb77088032610ebc04ccd4a867d81c694", "filename": "crates/ra_hir/src/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f24aa7a45ad6ffbbae56d5bca50afd6aefa1a4c7/crates%2Fra_hir%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f24aa7a45ad6ffbbae56d5bca50afd6aefa1a4c7/crates%2Fra_hir%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Flib.rs?ref=f24aa7a45ad6ffbbae56d5bca50afd6aefa1a4c7", "patch": "@@ -52,7 +52,7 @@ mod marks;\n \n pub use crate::{\n     code_model::{\n-        attrs::{AttrDef, Attrs},\n+        attrs::{AttrDef, HasAttrs},\n         docs::{DocDef, Docs, Documentation},\n         src::{HasBodySource, HasSource},\n         Adt, AssocItem, Const, ConstData, Container, Crate, CrateDependency, DefWithBody, Enum,"}, {"sha": "7a9d0fdf4404ac00c2a45b2c1a9360c39071b2e7", "filename": "crates/ra_hir_def/src/attr.rs", "status": "modified", "additions": 30, "deletions": 6, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/f24aa7a45ad6ffbbae56d5bca50afd6aefa1a4c7/crates%2Fra_hir_def%2Fsrc%2Fattr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f24aa7a45ad6ffbbae56d5bca50afd6aefa1a4c7/crates%2Fra_hir_def%2Fsrc%2Fattr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_def%2Fsrc%2Fattr.rs?ref=f24aa7a45ad6ffbbae56d5bca50afd6aefa1a4c7", "patch": "@@ -1,6 +1,6 @@\n //! A higher level attributes based on TokenTree, with also some shortcuts.\n \n-use std::sync::Arc;\n+use std::{ops, sync::Arc};\n \n use hir_expand::hygiene::Hygiene;\n use mbe::ast_to_token_tree;\n@@ -13,6 +13,28 @@ use tt::Subtree;\n \n use crate::path::Path;\n \n+#[derive(Default, Debug, Clone, PartialEq, Eq)]\n+pub struct Attrs {\n+    entries: Option<Arc<[Attr]>>,\n+}\n+\n+impl ops::Deref for Attrs {\n+    type Target = [Attr];\n+\n+    fn deref(&self) -> &[Attr] {\n+        match &self.entries {\n+            Some(it) => &*it,\n+            None => &[],\n+        }\n+    }\n+}\n+\n+impl Attrs {\n+    pub fn has_atom(&self, atom: &str) -> bool {\n+        self.iter().any(|it| it.is_simple_atom(atom))\n+    }\n+}\n+\n #[derive(Debug, Clone, PartialEq, Eq)]\n pub struct Attr {\n     pub(crate) path: Path,\n@@ -43,13 +65,15 @@ impl Attr {\n         Some(Attr { path, input })\n     }\n \n-    pub fn from_attrs_owner(owner: &dyn AttrsOwner, hygiene: &Hygiene) -> Option<Arc<[Attr]>> {\n+    pub fn from_attrs_owner(owner: &dyn AttrsOwner, hygiene: &Hygiene) -> Attrs {\n         let mut attrs = owner.attrs().peekable();\n-        if attrs.peek().is_none() {\n+        let entries = if attrs.peek().is_none() {\n             // Avoid heap allocation\n-            return None;\n-        }\n-        Some(attrs.flat_map(|ast| Attr::from_src(ast, hygiene)).collect())\n+            None\n+        } else {\n+            Some(attrs.flat_map(|ast| Attr::from_src(ast, hygiene)).collect())\n+        };\n+        Attrs { entries }\n     }\n \n     pub fn is_simple_atom(&self, name: &str) -> bool {"}, {"sha": "7902293e8f9096c282af3e901db5f8bd3ca76371", "filename": "crates/ra_hir_def/src/nameres/collector.rs", "status": "modified", "additions": 8, "deletions": 12, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/f24aa7a45ad6ffbbae56d5bca50afd6aefa1a4c7/crates%2Fra_hir_def%2Fsrc%2Fnameres%2Fcollector.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f24aa7a45ad6ffbbae56d5bca50afd6aefa1a4c7/crates%2Fra_hir_def%2Fsrc%2Fnameres%2Fcollector.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_def%2Fsrc%2Fnameres%2Fcollector.rs?ref=f24aa7a45ad6ffbbae56d5bca50afd6aefa1a4c7", "patch": "@@ -12,7 +12,7 @@ use rustc_hash::FxHashMap;\n use test_utils::tested_by;\n \n use crate::{\n-    attr::Attr,\n+    attr::Attrs,\n     db::DefDatabase2,\n     nameres::{\n         diagnostics::DefDiagnostic, mod_resolution::ModDir, path_resolution::ReachedFixedPoint,\n@@ -549,7 +549,7 @@ where\n         // `#[macro_use] extern crate` is hoisted to imports macros before collecting\n         // any other items.\n         for item in items {\n-            if self.is_cfg_enabled(item.attrs()) {\n+            if self.is_cfg_enabled(&item.attrs) {\n                 if let raw::RawItemKind::Import(import_id) = item.kind {\n                     let import = self.raw_items[import_id].clone();\n                     if import.is_extern_crate && import.is_macro_use {\n@@ -560,10 +560,10 @@ where\n         }\n \n         for item in items {\n-            if self.is_cfg_enabled(item.attrs()) {\n+            if self.is_cfg_enabled(&item.attrs) {\n                 match item.kind {\n                     raw::RawItemKind::Module(m) => {\n-                        self.collect_module(&self.raw_items[m], item.attrs())\n+                        self.collect_module(&self.raw_items[m], &item.attrs)\n                     }\n                     raw::RawItemKind::Import(import_id) => self\n                         .def_collector\n@@ -585,9 +585,9 @@ where\n         }\n     }\n \n-    fn collect_module(&mut self, module: &raw::ModuleData, attrs: &[Attr]) {\n+    fn collect_module(&mut self, module: &raw::ModuleData, attrs: &Attrs) {\n         let path_attr = self.path_attr(attrs);\n-        let is_macro_use = self.is_macro_use(attrs);\n+        let is_macro_use = attrs.has_atom(\"macro_use\");\n         match module {\n             // inline module, just recurse\n             raw::ModuleData::Definition { name, items, ast_id } => {\n@@ -779,17 +779,13 @@ where\n         }\n     }\n \n-    fn is_cfg_enabled(&self, attrs: &[Attr]) -> bool {\n+    fn is_cfg_enabled(&self, attrs: &Attrs) -> bool {\n         attrs.iter().all(|attr| attr.is_cfg_enabled(&self.def_collector.cfg_options) != Some(false))\n     }\n \n-    fn path_attr<'a>(&self, attrs: &'a [Attr]) -> Option<&'a SmolStr> {\n+    fn path_attr<'a>(&self, attrs: &'a Attrs) -> Option<&'a SmolStr> {\n         attrs.iter().find_map(|attr| attr.as_path())\n     }\n-\n-    fn is_macro_use<'a>(&self, attrs: &'a [Attr]) -> bool {\n-        attrs.iter().any(|attr| attr.is_simple_atom(\"macro_use\"))\n-    }\n }\n \n fn is_macro_rules(path: &Path) -> bool {"}, {"sha": "55a9634f8b48c37eba55e2dd6b21f29bb17968fc", "filename": "crates/ra_hir_def/src/nameres/raw.rs", "status": "modified", "additions": 7, "deletions": 11, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/f24aa7a45ad6ffbbae56d5bca50afd6aefa1a4c7/crates%2Fra_hir_def%2Fsrc%2Fnameres%2Fraw.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f24aa7a45ad6ffbbae56d5bca50afd6aefa1a4c7/crates%2Fra_hir_def%2Fsrc%2Fnameres%2Fraw.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_def%2Fsrc%2Fnameres%2Fraw.rs?ref=f24aa7a45ad6ffbbae56d5bca50afd6aefa1a4c7", "patch": "@@ -16,7 +16,12 @@ use ra_syntax::{\n };\n use test_utils::tested_by;\n \n-use crate::{attr::Attr, db::DefDatabase2, path::Path, FileAstId, HirFileId, ModuleSource, Source};\n+use crate::{\n+    attr::{Attr, Attrs},\n+    db::DefDatabase2,\n+    path::Path,\n+    FileAstId, HirFileId, ModuleSource, Source,\n+};\n \n /// `RawItems` is a set of top-level items in a file (except for impls).\n ///\n@@ -129,21 +134,12 @@ impl Index<Impl> for RawItems {\n     }\n }\n \n-// Avoid heap allocation on items without attributes.\n-type Attrs = Option<Arc<[Attr]>>;\n-\n #[derive(Debug, PartialEq, Eq, Clone)]\n pub(super) struct RawItem {\n-    attrs: Attrs,\n+    pub(super) attrs: Attrs,\n     pub(super) kind: RawItemKind,\n }\n \n-impl RawItem {\n-    pub(super) fn attrs(&self) -> &[Attr] {\n-        self.attrs.as_ref().map_or(&[], |it| &*it)\n-    }\n-}\n-\n #[derive(Debug, PartialEq, Eq, Clone, Copy)]\n pub(super) enum RawItemKind {\n     Module(Module),"}, {"sha": "bd464d193eeb0e62d4e23e578f542d63b9503673", "filename": "crates/ra_ide_api/src/completion/presentation.rs", "status": "modified", "additions": 3, "deletions": 6, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/f24aa7a45ad6ffbbae56d5bca50afd6aefa1a4c7/crates%2Fra_ide_api%2Fsrc%2Fcompletion%2Fpresentation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f24aa7a45ad6ffbbae56d5bca50afd6aefa1a4c7/crates%2Fra_ide_api%2Fsrc%2Fcompletion%2Fpresentation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2Fsrc%2Fcompletion%2Fpresentation.rs?ref=f24aa7a45ad6ffbbae56d5bca50afd6aefa1a4c7", "patch": "@@ -1,6 +1,6 @@\n //! This modules takes care of rendering various definitions as completion items.\n \n-use hir::{db::HirDatabase, Attrs, Docs, HasSource, HirDisplay, ScopeDef, Ty, TypeWalk};\n+use hir::{db::HirDatabase, Docs, HasAttrs, HasSource, HirDisplay, ScopeDef, Ty, TypeWalk};\n use join_to_string::join;\n use ra_syntax::ast::NameOwner;\n use test_utils::tested_by;\n@@ -285,11 +285,8 @@ impl Completions {\n     }\n }\n \n-fn is_deprecated(node: impl Attrs, db: &impl HirDatabase) -> bool {\n-    match node.attrs(db) {\n-        None => false,\n-        Some(attrs) => attrs.iter().any(|x| x.is_simple_atom(\"deprecated\")),\n-    }\n+fn is_deprecated(node: impl HasAttrs, db: &impl HirDatabase) -> bool {\n+    node.attrs(db).has_atom(\"deprecated\")\n }\n \n fn has_non_default_type_params(def: hir::GenericDef, db: &db::RootDatabase) -> bool {"}]}