{"sha": "e916815d21e37af5cd85f9eb67cda155d7129fff", "node_id": "C_kwDOAAsO6NoAKGU5MTY4MTVkMjFlMzdhZjVjZDg1ZjllYjY3Y2RhMTU1ZDcxMjlmZmY", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-01-13T00:29:34Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-01-13T00:29:34Z"}, "message": "Auto merge of #92526 - djc:rustdoc-askama, r=jsha\n\nMigrate rustdoc from Tera to Askama\n\nSee #84419.\n\nShould probably get a benchmarking run to verify if it has the intended effect on rustdoc performance.\n\ncc `@jsha` `@jyn514.`", "tree": {"sha": "f3a0e11f2f7b560154d81fc022308ded90370d4f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f3a0e11f2f7b560154d81fc022308ded90370d4f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e916815d21e37af5cd85f9eb67cda155d7129fff", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e916815d21e37af5cd85f9eb67cda155d7129fff", "html_url": "https://github.com/rust-lang/rust/commit/e916815d21e37af5cd85f9eb67cda155d7129fff", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e916815d21e37af5cd85f9eb67cda155d7129fff/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "124555a69e5f65173ec7840000eb8e953d046740", "url": "https://api.github.com/repos/rust-lang/rust/commits/124555a69e5f65173ec7840000eb8e953d046740", "html_url": "https://github.com/rust-lang/rust/commit/124555a69e5f65173ec7840000eb8e953d046740"}, {"sha": "ef96d573bff12330080d22f12cad96b818ea5da7", "url": "https://api.github.com/repos/rust-lang/rust/commits/ef96d573bff12330080d22f12cad96b818ea5da7", "html_url": "https://github.com/rust-lang/rust/commit/ef96d573bff12330080d22f12cad96b818ea5da7"}], "stats": {"total": 275, "additions": 127, "deletions": 148}, "files": [{"sha": "ef9f91fdb434b3417ddfcd755752b217d6d49e8d", "filename": "Cargo.lock", "status": "modified", "additions": 59, "deletions": 27, "changes": 86, "blob_url": "https://github.com/rust-lang/rust/blob/e916815d21e37af5cd85f9eb67cda155d7129fff/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/e916815d21e37af5cd85f9eb67cda155d7129fff/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=e916815d21e37af5cd85f9eb67cda155d7129fff", "patch": "@@ -103,6 +103,47 @@ version = \"0.7.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"5a2f58b0bb10c380af2b26e57212856b8c9a59e0925b4c20f4a174a49734eaf7\"\n \n+[[package]]\n+name = \"askama\"\n+version = \"0.11.0\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"4d8f355701c672c2ba3d718acbd213f740beea577cc4eae66accdffe15be1882\"\n+dependencies = [\n+ \"askama_derive\",\n+ \"askama_escape\",\n+ \"askama_shared\",\n+]\n+\n+[[package]]\n+name = \"askama_derive\"\n+version = \"0.11.0\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"84704cab5b7ae0fd3a9f78ee5eb7b27f3749df445f04623db6633459ae283267\"\n+dependencies = [\n+ \"askama_shared\",\n+ \"proc-macro2\",\n+ \"syn\",\n+]\n+\n+[[package]]\n+name = \"askama_escape\"\n+version = \"0.10.2\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"9a1bb320f97e6edf9f756bf015900038e43c7700e059688e5724a928c8f3b8d5\"\n+\n+[[package]]\n+name = \"askama_shared\"\n+version = \"0.12.0\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"dae03eebba55a2697a376e58b573a29fe36893157173ac8df312ad85f3c0e012\"\n+dependencies = [\n+ \"askama_escape\",\n+ \"nom\",\n+ \"proc-macro2\",\n+ \"quote\",\n+ \"syn\",\n+]\n+\n [[package]]\n name = \"atty\"\n version = \"0.2.14\"\n@@ -1509,17 +1550,6 @@ dependencies = [\n  \"regex\",\n ]\n \n-[[package]]\n-name = \"globwalk\"\n-version = \"0.8.1\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"93e3af942408868f6934a7b85134a3230832b9977cf66125df2f9edcfce4ddcc\"\n-dependencies = [\n- \"bitflags\",\n- \"ignore\",\n- \"walkdir\",\n-]\n-\n [[package]]\n name = \"gsgdt\"\n version = \"0.1.2\"\n@@ -2245,6 +2275,12 @@ dependencies = [\n  \"macro-utils\",\n ]\n \n+[[package]]\n+name = \"minimal-lexical\"\n+version = \"0.2.1\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"68354c5c6bd36d73ff3feceb05efa59b6acb7626617f4962be322a825e61f79a\"\n+\n [[package]]\n name = \"miniz_oxide\"\n version = \"0.4.0\"\n@@ -2304,6 +2340,17 @@ version = \"1.0.4\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"e4a24736216ec316047a1fc4252e27dabb04218aa4a3f37c6e7ddbf1f9782b54\"\n \n+[[package]]\n+name = \"nom\"\n+version = \"7.1.0\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"1b1d11e1ef389c76fe5b81bcaf2ea32cf88b62bc494e19f493d0b30e7a930109\"\n+dependencies = [\n+ \"memchr\",\n+ \"minimal-lexical\",\n+ \"version_check\",\n+]\n+\n [[package]]\n name = \"ntapi\"\n version = \"0.3.6\"\n@@ -4631,6 +4678,7 @@ name = \"rustdoc\"\n version = \"0.0.0\"\n dependencies = [\n  \"arrayvec\",\n+ \"askama\",\n  \"expect-test\",\n  \"itertools 0.9.0\",\n  \"minifier\",\n@@ -4642,7 +4690,6 @@ dependencies = [\n  \"serde_json\",\n  \"smallvec\",\n  \"tempfile\",\n- \"tera\",\n  \"tracing\",\n  \"tracing-subscriber\",\n  \"tracing-tree\",\n@@ -5187,21 +5234,6 @@ dependencies = [\n  \"utf-8\",\n ]\n \n-[[package]]\n-name = \"tera\"\n-version = \"1.10.0\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"81060acb882480c8793782eb96bc86f5c83d2fc7175ad46c375c6956ef7afa62\"\n-dependencies = [\n- \"globwalk\",\n- \"lazy_static\",\n- \"pest\",\n- \"pest_derive\",\n- \"regex\",\n- \"serde\",\n- \"serde_json\",\n-]\n-\n [[package]]\n name = \"term\"\n version = \"0.6.1\""}, {"sha": "5025342c1d68ce845ceeb18dec864d035d1c2038", "filename": "src/librustdoc/Cargo.toml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e916815d21e37af5cd85f9eb67cda155d7129fff/src%2Flibrustdoc%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/e916815d21e37af5cd85f9eb67cda155d7129fff/src%2Flibrustdoc%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2FCargo.toml?ref=e916815d21e37af5cd85f9eb67cda155d7129fff", "patch": "@@ -8,6 +8,7 @@ path = \"lib.rs\"\n \n [dependencies]\n arrayvec = { version = \"0.7\", default-features = false }\n+askama = { version = \"0.11\", default-features = false }\n pulldown-cmark = { version = \"0.9\", default-features = false }\n minifier = \"0.0.41\"\n rayon = \"1.3.1\"\n@@ -20,7 +21,6 @@ regex = \"1\"\n rustdoc-json-types = { path = \"../rustdoc-json-types\" }\n tracing = \"0.1\"\n tracing-tree = \"0.2.0\"\n-tera = { version = \"1.10.0\", default-features = false }\n \n [dependencies.tracing-subscriber]\n version = \"0.3.3\""}, {"sha": "959f83a021139e09877a1364864cb1b40028b449", "filename": "src/librustdoc/config.rs", "status": "modified", "additions": 0, "deletions": 5, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/e916815d21e37af5cd85f9eb67cda155d7129fff/src%2Flibrustdoc%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e916815d21e37af5cd85f9eb67cda155d7129fff/src%2Flibrustdoc%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fconfig.rs?ref=e916815d21e37af5cd85f9eb67cda155d7129fff", "patch": "@@ -257,9 +257,6 @@ crate struct RenderOptions {\n     /// If present, playground URL to use in the \"Run\" button added to code samples generated from\n     /// standalone Markdown files. If not present, `playground_url` is used.\n     crate markdown_playground_url: Option<String>,\n-    /// If false, the `select` element to have search filtering by crates on rendered docs\n-    /// won't be generated.\n-    crate generate_search_filter: bool,\n     /// Document items that have lower than `pub` visibility.\n     crate document_private: bool,\n     /// Document items that have `doc(hidden)`.\n@@ -638,7 +635,6 @@ impl Options {\n         let crate_version = matches.opt_str(\"crate-version\");\n         let enable_index_page = matches.opt_present(\"enable-index-page\") || index_page.is_some();\n         let static_root_path = matches.opt_str(\"static-root-path\");\n-        let generate_search_filter = !matches.opt_present(\"disable-per-crate-search\");\n         let test_run_directory = matches.opt_str(\"test-run-directory\").map(PathBuf::from);\n         let persist_doctests = matches.opt_str(\"persist-doctests\").map(PathBuf::from);\n         let test_builder = matches.opt_str(\"test-builder\").map(PathBuf::from);\n@@ -724,7 +720,6 @@ impl Options {\n                 markdown_no_toc,\n                 markdown_css,\n                 markdown_playground_url,\n-                generate_search_filter,\n                 document_private,\n                 document_hidden,\n                 generate_redirect_map,"}, {"sha": "4ca71ea8684b29e62e16dea28d1985007eb2f126", "filename": "src/librustdoc/html/layout.rs", "status": "modified", "additions": 8, "deletions": 12, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/e916815d21e37af5cd85f9eb67cda155d7129fff/src%2Flibrustdoc%2Fhtml%2Flayout.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e916815d21e37af5cd85f9eb67cda155d7129fff/src%2Flibrustdoc%2Fhtml%2Flayout.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Flayout.rs?ref=e916815d21e37af5cd85f9eb67cda155d7129fff", "patch": "@@ -7,9 +7,9 @@ use crate::externalfiles::ExternalHtml;\n use crate::html::format::{Buffer, Print};\n use crate::html::render::{ensure_trailing_slash, StylePath};\n \n-use serde::Serialize;\n+use askama::Template;\n \n-#[derive(Clone, Serialize)]\n+#[derive(Clone)]\n crate struct Layout {\n     crate logo: String,\n     crate favicon: String,\n@@ -19,14 +19,10 @@ crate struct Layout {\n     /// The given user css file which allow to customize the generated\n     /// documentation theme.\n     crate css_file_extension: Option<PathBuf>,\n-    /// If false, the `select` element to have search filtering by crates on rendered docs\n-    /// won't be generated.\n-    crate generate_search_filter: bool,\n     /// If true, then scrape-examples.js will be included in the output HTML file\n     crate scrape_examples_extension: bool,\n }\n \n-#[derive(Serialize)]\n crate struct Page<'a> {\n     crate title: &'a str,\n     crate css_class: &'a str,\n@@ -45,7 +41,8 @@ impl<'a> Page<'a> {\n     }\n }\n \n-#[derive(Serialize)]\n+#[derive(Template)]\n+#[template(path = \"page.html\")]\n struct PageLayout<'a> {\n     static_root_path: &'a str,\n     page: &'a Page<'a>,\n@@ -58,7 +55,6 @@ struct PageLayout<'a> {\n }\n \n crate fn render<T: Print, S: Print>(\n-    templates: &tera::Tera,\n     layout: &Layout,\n     page: &Page<'_>,\n     sidebar: S,\n@@ -76,7 +72,7 @@ crate fn render<T: Print, S: Print>(\n     let rustdoc_version = rustc_interface::util::version_str().unwrap_or(\"unknown version\");\n     let content = Buffer::html().to_display(t); // Note: This must happen before making the sidebar.\n     let sidebar = Buffer::html().to_display(sidebar);\n-    let teractx = tera::Context::from_serialize(PageLayout {\n+    PageLayout {\n         static_root_path,\n         page,\n         layout,\n@@ -85,9 +81,9 @@ crate fn render<T: Print, S: Print>(\n         content,\n         krate_with_trailing_slash,\n         rustdoc_version,\n-    })\n-    .unwrap();\n-    templates.render(\"page.html\", &teractx).unwrap()\n+    }\n+    .render()\n+    .unwrap()\n }\n \n crate fn redirect(url: &str) -> String {"}, {"sha": "4f3455a92083ab2c9d0e549af4476cca175d7e23", "filename": "src/librustdoc/html/render/context.rs", "status": "modified", "additions": 1, "deletions": 11, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/e916815d21e37af5cd85f9eb67cda155d7129fff/src%2Flibrustdoc%2Fhtml%2Frender%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e916815d21e37af5cd85f9eb67cda155d7129fff/src%2Flibrustdoc%2Fhtml%2Frender%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fcontext.rs?ref=e916815d21e37af5cd85f9eb67cda155d7129fff", "patch": "@@ -15,7 +15,6 @@ use rustc_span::symbol::sym;\n \n use super::print_item::{full_path, item_path, print_item};\n use super::search_index::build_index;\n-use super::templates;\n use super::write_shared::write_shared;\n use super::{\n     collect_spans_and_sources, print_sidebar, settings, AllTypes, LinkFromSrc, NameDoc, StylePath,\n@@ -118,8 +117,6 @@ crate struct SharedContext<'tcx> {\n     /// the crate.\n     redirections: Option<RefCell<FxHashMap<String, String>>>,\n \n-    pub(crate) templates: tera::Tera,\n-\n     /// Correspondance map used to link types used in the source code pages to allow to click on\n     /// links to jump to the type's definition.\n     crate span_correspondance_map: FxHashMap<rustc_span::Span, LinkFromSrc>,\n@@ -218,11 +215,10 @@ impl<'tcx> Context<'tcx> {\n \n         if !self.render_redirect_pages {\n             layout::render(\n-                &self.shared.templates,\n                 &self.shared.layout,\n                 &page,\n                 |buf: &mut _| print_sidebar(self, it, buf),\n-                |buf: &mut _| print_item(self, &self.shared.templates, it, buf, &page),\n+                |buf: &mut _| print_item(self, it, buf, &page),\n                 &self.shared.style_files,\n             )\n         } else {\n@@ -391,7 +387,6 @@ impl<'tcx> FormatRenderer<'tcx> for Context<'tcx> {\n             extension_css,\n             resource_suffix,\n             static_root_path,\n-            generate_search_filter,\n             unstable_features,\n             generate_redirect_map,\n             show_type_layout,\n@@ -421,12 +416,10 @@ impl<'tcx> FormatRenderer<'tcx> for Context<'tcx> {\n             default_settings,\n             krate: krate.name(tcx).to_string(),\n             css_file_extension: extension_css,\n-            generate_search_filter,\n             scrape_examples_extension: !call_locations.is_empty(),\n         };\n         let mut issue_tracker_base_url = None;\n         let mut include_sources = true;\n-        let templates = templates::load()?;\n \n         // Crawl the crate attributes looking for attributes which control how we're\n         // going to emit HTML\n@@ -481,7 +474,6 @@ impl<'tcx> FormatRenderer<'tcx> for Context<'tcx> {\n             errors: receiver,\n             redirections: if generate_redirect_map { Some(Default::default()) } else { None },\n             show_type_layout,\n-            templates,\n             span_correspondance_map: matches,\n             cache,\n             call_locations,\n@@ -577,7 +569,6 @@ impl<'tcx> FormatRenderer<'tcx> for Context<'tcx> {\n         };\n         let all = self.shared.all.replace(AllTypes::new());\n         let v = layout::render(\n-            &self.shared.templates,\n             &self.shared.layout,\n             &page,\n             sidebar,\n@@ -599,7 +590,6 @@ impl<'tcx> FormatRenderer<'tcx> for Context<'tcx> {\n             .map(StylePath::basename)\n             .collect::<Result<_, Error>>()?;\n         let v = layout::render(\n-            &self.shared.templates,\n             &self.shared.layout,\n             &page,\n             sidebar,"}, {"sha": "dda749049319742ec95b8bf7c84651e4d55b9992", "filename": "src/librustdoc/html/render/mod.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/e916815d21e37af5cd85f9eb67cda155d7129fff/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e916815d21e37af5cd85f9eb67cda155d7129fff/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs?ref=e916815d21e37af5cd85f9eb67cda155d7129fff", "patch": "@@ -31,7 +31,6 @@ mod tests;\n mod context;\n mod print_item;\n mod span_map;\n-mod templates;\n mod write_shared;\n \n crate use self::context::*;"}, {"sha": "11426cb65719427c739355249b4333b3fbd3a1a0", "filename": "src/librustdoc/html/render/print_item.rs", "status": "modified", "additions": 5, "deletions": 12, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/e916815d21e37af5cd85f9eb67cda155d7129fff/src%2Flibrustdoc%2Fhtml%2Frender%2Fprint_item.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e916815d21e37af5cd85f9eb67cda155d7129fff/src%2Flibrustdoc%2Fhtml%2Frender%2Fprint_item.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fprint_item.rs?ref=e916815d21e37af5cd85f9eb67cda155d7129fff", "patch": "@@ -32,21 +32,21 @@ use crate::html::highlight;\n use crate::html::layout::Page;\n use crate::html::markdown::{HeadingOffset, MarkdownSummaryLine};\n \n-use serde::Serialize;\n+use askama::Template;\n \n const ITEM_TABLE_OPEN: &str = \"<div class=\\\"item-table\\\">\";\n const ITEM_TABLE_CLOSE: &str = \"</div>\";\n const ITEM_TABLE_ROW_OPEN: &str = \"<div class=\\\"item-row\\\">\";\n const ITEM_TABLE_ROW_CLOSE: &str = \"</div>\";\n \n // A component in a `use` path, like `string` in std::string::ToString\n-#[derive(Serialize)]\n struct PathComponent<'a> {\n     path: String,\n     name: &'a str,\n }\n \n-#[derive(Serialize)]\n+#[derive(Template)]\n+#[template(path = \"print_item.html\")]\n struct ItemVars<'a> {\n     page: &'a Page<'a>,\n     static_root_path: &'a str,\n@@ -58,13 +58,7 @@ struct ItemVars<'a> {\n     src_href: Option<&'a str>,\n }\n \n-pub(super) fn print_item(\n-    cx: &Context<'_>,\n-    templates: &tera::Tera,\n-    item: &clean::Item,\n-    buf: &mut Buffer,\n-    page: &Page<'_>,\n-) {\n+pub(super) fn print_item(cx: &Context<'_>, item: &clean::Item, buf: &mut Buffer, page: &Page<'_>) {\n     debug_assert!(!item.is_stripped());\n     let typ = match *item.kind {\n         clean::ModuleItem(_) => {\n@@ -143,8 +137,7 @@ pub(super) fn print_item(\n         src_href: src_href.as_deref(),\n     };\n \n-    let teractx = tera::Context::from_serialize(item_vars).unwrap();\n-    let heading = templates.render(\"print_item.html\", &teractx).unwrap();\n+    let heading = item_vars.render().unwrap();\n     buf.write_str(&heading);\n \n     match *item.kind {"}, {"sha": "d1f182394479a5ea81952068dd5a50feafbe57de", "filename": "src/librustdoc/html/render/templates.rs", "status": "removed", "additions": 0, "deletions": 20, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/124555a69e5f65173ec7840000eb8e953d046740/src%2Flibrustdoc%2Fhtml%2Frender%2Ftemplates.rs", "raw_url": "https://github.com/rust-lang/rust/raw/124555a69e5f65173ec7840000eb8e953d046740/src%2Flibrustdoc%2Fhtml%2Frender%2Ftemplates.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Ftemplates.rs?ref=124555a69e5f65173ec7840000eb8e953d046740", "patch": "@@ -1,20 +0,0 @@\n-use std::error::Error as StdError;\n-\n-use crate::error::Error;\n-\n-pub(crate) fn load() -> Result<tera::Tera, Error> {\n-    let mut templates = tera::Tera::default();\n-\n-    macro_rules! include_template {\n-        ($file:literal, $fullpath:literal) => {\n-            templates.add_raw_template($file, include_str!($fullpath)).map_err(|e| Error {\n-                file: $file.into(),\n-                error: format!(\"{}: {}\", e, e.source().map(|e| e.to_string()).unwrap_or_default()),\n-            })?\n-        };\n-    }\n-\n-    include_template!(\"page.html\", \"../templates/page.html\");\n-    include_template!(\"print_item.html\", \"../templates/print_item.html\");\n-    Ok(templates)\n-}"}, {"sha": "2e763dbd8fe9eb2ad93a417f4234ec34bec3749a", "filename": "src/librustdoc/html/render/write_shared.rs", "status": "modified", "additions": 1, "deletions": 8, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/e916815d21e37af5cd85f9eb67cda155d7129fff/src%2Flibrustdoc%2Fhtml%2Frender%2Fwrite_shared.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e916815d21e37af5cd85f9eb67cda155d7129fff/src%2Flibrustdoc%2Fhtml%2Frender%2Fwrite_shared.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fwrite_shared.rs?ref=e916815d21e37af5cd85f9eb67cda155d7129fff", "patch": "@@ -494,14 +494,7 @@ pub(super) fn write_shared(\n                     })\n                     .collect::<String>()\n             );\n-            let v = layout::render(\n-                &cx.shared.templates,\n-                &cx.shared.layout,\n-                &page,\n-                \"\",\n-                content,\n-                &cx.shared.style_files,\n-            );\n+            let v = layout::render(&cx.shared.layout, &page, \"\", content, &cx.shared.style_files);\n             cx.shared.fs.write(dst, v)?;\n         }\n     }"}, {"sha": "bae04f2095a3d079d63a6a09636953c3c592292b", "filename": "src/librustdoc/html/sources.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/e916815d21e37af5cd85f9eb67cda155d7129fff/src%2Flibrustdoc%2Fhtml%2Fsources.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e916815d21e37af5cd85f9eb67cda155d7129fff/src%2Flibrustdoc%2Fhtml%2Fsources.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fsources.rs?ref=e916815d21e37af5cd85f9eb67cda155d7129fff", "patch": "@@ -203,7 +203,6 @@ impl SourceCollector<'_, '_> {\n             static_extra_scripts: &[&format!(\"source-script{}\", self.cx.shared.resource_suffix)],\n         };\n         let v = layout::render(\n-            &self.cx.shared.templates,\n             &self.cx.shared.layout,\n             &page,\n             \"\","}, {"sha": "fff65e3b5ff24fb6d46e539bf4cb14f41e906874", "filename": "src/librustdoc/templates/STYLE.md", "status": "renamed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/e916815d21e37af5cd85f9eb67cda155d7129fff/src%2Flibrustdoc%2Ftemplates%2FSTYLE.md", "raw_url": "https://github.com/rust-lang/rust/raw/e916815d21e37af5cd85f9eb67cda155d7129fff/src%2Flibrustdoc%2Ftemplates%2FSTYLE.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Ftemplates%2FSTYLE.md?ref=e916815d21e37af5cd85f9eb67cda155d7129fff", "previous_filename": "src/librustdoc/html/templates/STYLE.md"}, {"sha": "673260ac6d09d1607428c11e1fbe188c782e4eca", "filename": "src/librustdoc/templates/page.html", "status": "renamed", "additions": 43, "deletions": 43, "changes": 86, "blob_url": "https://github.com/rust-lang/rust/blob/e916815d21e37af5cd85f9eb67cda155d7129fff/src%2Flibrustdoc%2Ftemplates%2Fpage.html", "raw_url": "https://github.com/rust-lang/rust/raw/e916815d21e37af5cd85f9eb67cda155d7129fff/src%2Flibrustdoc%2Ftemplates%2Fpage.html", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Ftemplates%2Fpage.html?ref=e916815d21e37af5cd85f9eb67cda155d7129fff", "patch": "@@ -7,20 +7,20 @@\n     <meta name=\"description\" content=\"{{page.description}}\"> {#- -#}\n     <meta name=\"keywords\" content=\"{{page.keywords}}\"> {#- -#}\n     <title>{{page.title}}</title> {#- -#}\n-    <link rel=\"preload\" as=\"font\" type=\"font/woff2\" crossorigin href=\"{{static_root_path | safe}}SourceSerif4-Regular.ttf.woff2\"> {#- -#}\n-    <link rel=\"preload\" as=\"font\" type=\"font/woff2\" crossorigin href=\"{{static_root_path | safe}}FiraSans-Regular.woff2\"> {#- -#}\n-    <link rel=\"preload\" as=\"font\" type=\"font/woff2\" crossorigin href=\"{{static_root_path | safe}}FiraSans-Medium.woff2\"> {#- -#}\n-    <link rel=\"preload\" as=\"font\" type=\"font/woff2\" crossorigin href=\"{{static_root_path | safe}}SourceCodePro-Regular.ttf.woff2\"> {#- -#}\n-    <link rel=\"preload\" as=\"font\" type=\"font/woff2\" crossorigin href=\"{{static_root_path | safe}}SourceSerif4-Bold.ttf.woff2\"> {#- -#}\n-    <link rel=\"preload\" as=\"font\" type=\"font/woff2\" crossorigin href=\"{{static_root_path | safe}}SourceCodePro-Semibold.ttf.woff2\"> {#- -#}\n+    <link rel=\"preload\" as=\"font\" type=\"font/woff2\" crossorigin href=\"{{static_root_path|safe}}SourceSerif4-Regular.ttf.woff2\"> {#- -#}\n+    <link rel=\"preload\" as=\"font\" type=\"font/woff2\" crossorigin href=\"{{static_root_path|safe}}FiraSans-Regular.woff2\"> {#- -#}\n+    <link rel=\"preload\" as=\"font\" type=\"font/woff2\" crossorigin href=\"{{static_root_path|safe}}FiraSans-Medium.woff2\"> {#- -#}\n+    <link rel=\"preload\" as=\"font\" type=\"font/woff2\" crossorigin href=\"{{static_root_path|safe}}SourceCodePro-Regular.ttf.woff2\"> {#- -#}\n+    <link rel=\"preload\" as=\"font\" type=\"font/woff2\" crossorigin href=\"{{static_root_path|safe}}SourceSerif4-Bold.ttf.woff2\"> {#- -#}\n+    <link rel=\"preload\" as=\"font\" type=\"font/woff2\" crossorigin href=\"{{static_root_path|safe}}SourceCodePro-Semibold.ttf.woff2\"> {#- -#}\n     <link rel=\"stylesheet\" type=\"text/css\" {# -#}\n-          href=\"{{static_root_path | safe}}normalize{{page.resource_suffix}}.css\"> {#- -#}\n+          href=\"{{static_root_path|safe}}normalize{{page.resource_suffix}}.css\"> {#- -#}\n     <link rel=\"stylesheet\" type=\"text/css\" {# -#}\n-          href=\"{{static_root_path | safe}}rustdoc{{page.resource_suffix}}.css\" {# -#}\n+          href=\"{{static_root_path|safe}}rustdoc{{page.resource_suffix}}.css\" {# -#}\n           id=\"mainThemeStyle\"> {#- -#}\n     {%- for theme in themes -%}\n         <link rel=\"stylesheet\" type=\"text/css\" {# -#}\n-            href=\"{{static_root_path | safe}}{{theme}}{{page.resource_suffix}}.css\" {# -#}\n+            href=\"{{static_root_path|safe}}{{theme}}{{page.resource_suffix}}.css\" {# -#}\n         {%- if theme == \"light\" -%}\n             id=\"themeStyle\"\n         {%- else -%}\n@@ -29,77 +29,77 @@\n         >\n     {%- endfor -%}\n     <script id=\"default-settings\" {# -#}\n-      {% for k, v in layout.default_settings %}\n+      {% for (k, v) in layout.default_settings %}\n         data-{{k}}=\"{{v}}\"\n       {%- endfor -%}\n     ></script> {#- -#}\n-    <script src=\"{{static_root_path | safe}}storage{{page.resource_suffix}}.js\"></script> {#- -#}\n-    <script src=\"{{page.root_path | safe}}crates{{page.resource_suffix}}.js\"></script> {#- -#}\n-    <script defer src=\"{{static_root_path | safe}}main{{page.resource_suffix}}.js\"></script> {#- -#}\n+    <script src=\"{{static_root_path|safe}}storage{{page.resource_suffix}}.js\"></script> {#- -#}\n+    <script src=\"{{page.root_path|safe}}crates{{page.resource_suffix}}.js\"></script> {#- -#}\n+    <script defer src=\"{{static_root_path|safe}}main{{page.resource_suffix}}.js\"></script> {#- -#}\n     {%- for script in page.static_extra_scripts -%}\n-    <script defer src=\"{{static_root_path | safe}}{{script}}.js\"></script> {#- -#}\n+    <script defer src=\"{{static_root_path|safe}}{{script}}.js\"></script> {#- -#}\n     {% endfor %}\n     {%- if layout.scrape_examples_extension -%}\n-    <script defer src=\"{{page.root_path | safe}}scrape-examples{{page.resource_suffix}}.js\"></script> {#- -#}\n+    <script defer src=\"{{page.root_path|safe}}scrape-examples{{page.resource_suffix}}.js\"></script> {#- -#}\n     {%- endif -%}\n     {%- for script in page.extra_scripts -%}\n-    <script defer src=\"{{page.root_path | safe}}{{script}}.js\"></script> {#- -#}\n+    <script defer src=\"{{page.root_path|safe}}{{script}}.js\"></script> {#- -#}\n     {% endfor %}\n     <noscript> {#- -#}\n         <link rel=\"stylesheet\" {# -#}\n-           href=\"{{static_root_path | safe}}noscript{{page.resource_suffix}}.css\"> {#- -#}\n+           href=\"{{static_root_path|safe}}noscript{{page.resource_suffix}}.css\"> {#- -#}\n     </noscript> {#- -#}\n-    {%- if layout.css_file_extension -%}\n+    {%- if layout.css_file_extension.is_some() -%}\n         <link rel=\"stylesheet\" type=\"text/css\" {# -#}\n-            href=\"{{static_root_path | safe}}theme{{page.resource_suffix}}.css\"> {#- -#}\n+            href=\"{{static_root_path|safe}}theme{{page.resource_suffix}}.css\"> {#- -#}\n     {%- endif -%}\n-    {%- if layout.favicon -%}\n+    {%- if !layout.favicon.is_empty() -%}\n         <link rel=\"shortcut icon\" href=\"{{layout.favicon}}\"> {#- -#}\n     {%- else -%}\n         <link rel=\"alternate icon\" type=\"image/png\" {# -#}\n-            href=\"{{static_root_path | safe}}favicon-16x16{{page.resource_suffix}}.png\"> {#- -#}\n+            href=\"{{static_root_path|safe}}favicon-16x16{{page.resource_suffix}}.png\"> {#- -#}\n         <link rel=\"alternate icon\" type=\"image/png\" {# -#}\n-            href=\"{{static_root_path | safe}}favicon-32x32{{page.resource_suffix}}.png\"> {#- -#}\n+            href=\"{{static_root_path|safe}}favicon-32x32{{page.resource_suffix}}.png\"> {#- -#}\n         <link rel=\"icon\" type=\"image/svg+xml\" {# -#}\n-            href=\"{{static_root_path | safe}}favicon{{page.resource_suffix}}.svg\"> {#- -#}\n+            href=\"{{static_root_path|safe}}favicon{{page.resource_suffix}}.svg\"> {#- -#}\n     {%- endif -%}\n-    {{- layout.external_html.in_header | safe -}}\n+    {{- layout.external_html.in_header|safe -}}\n </head> {#- -#}\n <body class=\"rustdoc {{page.css_class}}\"> {#- -#}\n     <!--[if lte IE 11]> {#- -#}\n     <div class=\"warning\"> {#- -#}\n         This old browser is unsupported and will most likely display funky things. {#- -#}\n     </div> {#- -#}\n     <![endif]--> {#- -#}\n-    {{- layout.external_html.before_content | safe -}}\n+    {{- layout.external_html.before_content|safe -}}\n     <nav class=\"sidebar\"> {#- -#}\n         <div class=\"sidebar-menu\" role=\"button\">&#9776;</div> {#- -#}\n-        <a class=\"sidebar-logo\" href=\"{{page.root_path | safe}}{{krate_with_trailing_slash | safe}}index.html\"> {#- -#}\n+        <a class=\"sidebar-logo\" href=\"{{page.root_path|safe}}{{krate_with_trailing_slash|safe}}index.html\"> {#- -#}\n             <div class=\"logo-container\"> {#- -#}\n-            {%- if layout.logo -%}\n-                <img src=\"{{layout.logo}}\" alt=\"logo\"> {#- -#}\n-            {%- else -%}\n-                <img class=\"rust-logo\" src=\"{{static_root_path | safe}}rust-logo{{page.resource_suffix}}.png\" alt=\"logo\"> {#- -#}\n-            {%- endif -%}\n+                {%- if !layout.logo.is_empty()  %}\n+                    <img src=\"{{layout.logo}}\" alt=\"logo\"> {#- -#}\n+                {%- else -%}\n+                    <img class=\"rust-logo\" src=\"{{static_root_path|safe}}rust-logo{{page.resource_suffix}}.png\" alt=\"logo\"> {#- -#}\n+                {%- endif -%}\n             </div>\n         </a> {#- -#}\n-        {{- sidebar | safe -}}\n+        {{- sidebar|safe -}}\n     </nav> {#- -#}\n     <main> {#- -#}\n         <div class=\"width-limiter\"> {#- -#}\n             <div class=\"sub-container\"> {#- -#}\n-                <a class=\"sub-logo-container\" href=\"{{page.root_path | safe}}{{krate_with_trailing_slash | safe}}index.html\"> {#- -#}\n-                    {%- if layout.logo -%}\n-                    <img src=\"{{layout.logo}}\" alt=\"logo\">\n+                <a class=\"sub-logo-container\" href=\"{{page.root_path|safe}}{{krate_with_trailing_slash|safe}}index.html\"> {#- -#}\n+                    {%- if !layout.logo.is_empty()  %}\n+                        <img src=\"{{layout.logo}}\" alt=\"logo\"> {#- -#}\n                     {%- else -%}\n-                    <img class=\"rust-logo\" src=\"{{static_root_path | safe}}rust-logo{{page.resource_suffix}}.png\" alt=\"logo\">\n+                        <img class=\"rust-logo\" src=\"{{static_root_path|safe}}rust-logo{{page.resource_suffix}}.png\" alt=\"logo\"> {#- -#}\n                     {%- endif -%}\n                 </a> {#- -#}\n                 <nav class=\"sub\"> {#- -#}\n                     <div class=\"theme-picker\"> {#- -#}\n                         <button id=\"theme-picker\" aria-label=\"Pick another theme!\" aria-haspopup=\"menu\" title=\"themes\"> {#- -#}\n                             <img width=\"18\" height=\"18\" alt=\"Pick another theme!\" {# -#}\n-                             src=\"{{static_root_path | safe}}brush{{page.resource_suffix}}.svg\"> {#- -#}\n+                             src=\"{{static_root_path|safe}}brush{{page.resource_suffix}}.svg\"> {#- -#}\n                         </button> {#- -#}\n                         <div id=\"theme-choices\" role=\"menu\"></div> {#- -#}\n                     </div> {#- -#}\n@@ -115,23 +115,23 @@\n                                     type=\"search\"> {#- -#}\n                             </div> {#- -#}\n                             <button type=\"button\" id=\"help-button\" title=\"help\">?</button> {#- -#}\n-                            <a id=\"settings-menu\" href=\"{{page.root_path | safe}}settings.html\" title=\"settings\"> {#- -#}\n+                            <a id=\"settings-menu\" href=\"{{page.root_path|safe}}settings.html\" title=\"settings\"> {#- -#}\n                                 <img width=\"18\" height=\"18\" alt=\"Change settings\" {# -#}\n-                                     src=\"{{static_root_path | safe}}wheel{{page.resource_suffix}}.svg\"> {#- -#}\n+                                     src=\"{{static_root_path|safe}}wheel{{page.resource_suffix}}.svg\"> {#- -#}\n                             </a> {#- -#}\n                         </div> {#- -#}\n                     </form> {#- -#}\n                 </nav> {#- -#}\n             </div> {#- -#}\n-            <section id=\"main-content\" class=\"content\">{{- content | safe -}}</section> {#- -#}\n+            <section id=\"main-content\" class=\"content\">{{- content|safe -}}</section> {#- -#}\n             <section id=\"search\" class=\"content hidden\"></section> {#- -#}\n         </div> {#- -#}\n     </main> {#- -#}\n-    {{- layout.external_html.after_content | safe -}}\n+    {{- layout.external_html.after_content|safe -}}\n     <div id=\"rustdoc-vars\" {# -#}\n-         data-root-path=\"{{page.root_path | safe}}\" {# -#}\n+         data-root-path=\"{{page.root_path|safe}}\" {# -#}\n          data-current-crate=\"{{layout.krate}}\" {# -#}\n-         data-themes=\"{{themes | join(sep=\",\") }}\" {# -#}\n+         data-themes=\"{{themes|join(\",\") }}\" {# -#}\n          data-resource-suffix=\"{{page.resource_suffix}}\" {# -#}\n          data-rustdoc-version=\"{{rustdoc_version}}\" {# -#}\n     > {#- -#}", "previous_filename": "src/librustdoc/html/templates/page.html"}, {"sha": "c98c6db424a198794fef69fc7be0da200192a7f1", "filename": "src/librustdoc/templates/print_item.html", "status": "renamed", "additions": 9, "deletions": 7, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/e916815d21e37af5cd85f9eb67cda155d7129fff/src%2Flibrustdoc%2Ftemplates%2Fprint_item.html", "raw_url": "https://github.com/rust-lang/rust/raw/e916815d21e37af5cd85f9eb67cda155d7129fff/src%2Flibrustdoc%2Ftemplates%2Fprint_item.html", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Ftemplates%2Fprint_item.html?ref=e916815d21e37af5cd85f9eb67cda155d7129fff", "patch": "@@ -4,23 +4,25 @@ <h1 class=\"fqn\"> {#- -#}\n             {{-typ-}}\n             {#- The breadcrumbs of the item path, like std::string -#}\n             {%- for component in path_components -%}\n-            <a href=\"{{component.path | safe}}index.html\">{{component.name}}</a>::<wbr>\n+            <a href=\"{{component.path|safe}}index.html\">{{component.name}}</a>::<wbr>\n             {%- endfor -%}\n             <a class=\"{{item_type}}\" href=\"#\">{{name}}</a> {#- -#}\n             <button id=\"copy-path\" onclick=\"copy_path(this)\" title=\"Copy item path to clipboard\"> {#- -#}\n-                <img src=\"{{static_root_path | safe}}clipboard{{page.resource_suffix}}.svg\" {# -#}\n+                <img src=\"{{static_root_path|safe}}clipboard{{page.resource_suffix}}.svg\" {# -#}\n                     width=\"19\" height=\"18\" {# -#}\n                     alt=\"Copy item path\"> {#- -#}\n             </button> {#- -#}\n         </span> {#- -#}\n     </h1> {#- -#}\n     <span class=\"out-of-band\"> {#- -#}\n-        {% if stability_since_raw %}\n-        {{- stability_since_raw | safe -}} \u00b7 \n+        {% if !stability_since_raw.is_empty() %}\n+        {{- stability_since_raw|safe -}} \u00b7\n         {% endif %}\n-        {%- if src_href %}\n-        <a class=\"srclink\" href=\"{{src_href | safe}}\" title=\"goto source code\">source</a> \u00b7\n-        {% endif -%}\n+        {%- match src_href -%}\n+            {%- when Some with (href) -%}\n+                <a class=\"srclink\" href=\"{{href|safe}}\" title=\"goto source code\">source</a>\n+            {%- else -%} \u00b7\n+        {%- endmatch -%}\n         <a id=\"toggle-all-docs\" href=\"javascript:void(0)\" title=\"collapse all docs\"> {#- -#}\n             [<span class=\"inner\">&#x2212;</span>] {#- -#}\n         </a> {#- -#}", "previous_filename": "src/librustdoc/html/templates/print_item.html"}]}