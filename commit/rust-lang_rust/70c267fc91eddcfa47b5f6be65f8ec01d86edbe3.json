{"sha": "70c267fc91eddcfa47b5f6be65f8ec01d86edbe3", "node_id": "MDY6Q29tbWl0NzI0NzEyOjcwYzI2N2ZjOTFlZGRjZmE0N2I1ZjZiZTY1ZjhlYzAxZDg2ZWRiZTM=", "commit": {"author": {"name": "Jethro Beekman", "email": "jethro@jbeekman.nl", "date": "2017-05-03T17:19:23Z"}, "committer": {"name": "Jethro Beekman", "email": "jethro@jbeekman.nl", "date": "2017-05-03T17:19:23Z"}, "message": "Windows io::Error: also format NTSTATUS error codes", "tree": {"sha": "a5e530ddd4fdd1cecd4f2088db8f7ac1a49f47b4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a5e530ddd4fdd1cecd4f2088db8f7ac1a49f47b4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/70c267fc91eddcfa47b5f6be65f8ec01d86edbe3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/70c267fc91eddcfa47b5f6be65f8ec01d86edbe3", "html_url": "https://github.com/rust-lang/rust/commit/70c267fc91eddcfa47b5f6be65f8ec01d86edbe3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/70c267fc91eddcfa47b5f6be65f8ec01d86edbe3/comments", "author": null, "committer": null, "parents": [{"sha": "526d39948af4004bb60c04dc82d60b7b395966bb", "url": "https://api.github.com/repos/rust-lang/rust/commits/526d39948af4004bb60c04dc82d60b7b395966bb", "html_url": "https://github.com/rust-lang/rust/commit/526d39948af4004bb60c04dc82d60b7b395966bb"}], "stats": {"total": 27, "additions": 24, "deletions": 3}, "files": [{"sha": "5d7a5c94bd3d4c837ba7cc7bf80a24de5982b5d2", "filename": "src/libstd/sys/windows/c.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/70c267fc91eddcfa47b5f6be65f8ec01d86edbe3/src%2Flibstd%2Fsys%2Fwindows%2Fc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/70c267fc91eddcfa47b5f6be65f8ec01d86edbe3/src%2Flibstd%2Fsys%2Fwindows%2Fc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Fwindows%2Fc.rs?ref=70c267fc91eddcfa47b5f6be65f8ec01d86edbe3", "patch": "@@ -198,7 +198,10 @@ pub const ERROR_TIMEOUT: DWORD = 0x5B4;\n \n pub const INVALID_HANDLE_VALUE: HANDLE = !0 as HANDLE;\n \n+pub const FACILITY_NT_BIT: DWORD = 0x1000_0000;\n+\n pub const FORMAT_MESSAGE_FROM_SYSTEM: DWORD = 0x00001000;\n+pub const FORMAT_MESSAGE_FROM_HMODULE: DWORD = 0x00000800;\n pub const FORMAT_MESSAGE_IGNORE_INSERTS: DWORD = 0x00000200;\n \n pub const TLS_OUT_OF_INDEXES: DWORD = 0xFFFFFFFF;"}, {"sha": "402d4f9ee6e56b6dee75e1144fde3191e671a0fb", "filename": "src/libstd/sys/windows/os.rs", "status": "modified", "additions": 21, "deletions": 3, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/70c267fc91eddcfa47b5f6be65f8ec01d86edbe3/src%2Flibstd%2Fsys%2Fwindows%2Fos.rs", "raw_url": "https://github.com/rust-lang/rust/raw/70c267fc91eddcfa47b5f6be65f8ec01d86edbe3/src%2Flibstd%2Fsys%2Fwindows%2Fos.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Fwindows%2Fos.rs?ref=70c267fc91eddcfa47b5f6be65f8ec01d86edbe3", "patch": "@@ -32,17 +32,35 @@ pub fn errno() -> i32 {\n }\n \n /// Gets a detailed string description for the given error number.\n-pub fn error_string(errnum: i32) -> String {\n+pub fn error_string(mut errnum: i32) -> String {\n     // This value is calculated from the macro\n     // MAKELANGID(LANG_SYSTEM_DEFAULT, SUBLANG_SYS_DEFAULT)\n     let langId = 0x0800 as c::DWORD;\n \n     let mut buf = [0 as c::WCHAR; 2048];\n \n     unsafe {\n-        let res = c::FormatMessageW(c::FORMAT_MESSAGE_FROM_SYSTEM |\n+        let mut module = ptr::null_mut();\n+        let mut flags = 0;\n+\n+        // NTSTATUS errors may be encoded as HRESULT, which may returned from\n+        // GetLastError. For more information about Windows error codes, see\n+        // `[MS-ERREF]`: https://msdn.microsoft.com/en-us/library/cc231198.aspx\n+        if (errnum & c::FACILITY_NT_BIT as i32) != 0 {\n+            // format according to https://support.microsoft.com/en-us/help/259693\n+            const NTDLL_DLL: &'static [u16] = &['N' as _, 'T' as _, 'D' as _, 'L' as _, 'L' as _,\n+                                                '.' as _, 'D' as _, 'L' as _, 'L' as _, 0];\n+            module = c::GetModuleHandleW(NTDLL_DLL.as_ptr());\n+\n+            if module != ptr::null_mut() {\n+                errnum ^= c::FACILITY_NT_BIT as i32;\n+                flags = c::FORMAT_MESSAGE_FROM_HMODULE;\n+            }\n+        }\n+\n+        let res = c::FormatMessageW(flags | c::FORMAT_MESSAGE_FROM_SYSTEM |\n                                         c::FORMAT_MESSAGE_IGNORE_INSERTS,\n-                                    ptr::null_mut(),\n+                                    module,\n                                     errnum as c::DWORD,\n                                     langId,\n                                     buf.as_mut_ptr(),"}]}