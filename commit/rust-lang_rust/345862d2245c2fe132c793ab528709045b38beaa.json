{"sha": "345862d2245c2fe132c793ab528709045b38beaa", "node_id": "MDY6Q29tbWl0NzI0NzEyOjM0NTg2MmQyMjQ1YzJmZTEzMmM3OTNhYjUyODcwOTA0NWIzOGJlYWE=", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2021-08-03T10:07:43Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-08-03T10:07:43Z"}, "message": "Rollup merge of #87645 - LeSeulArtichaut:issue-87414, r=oli-obk\n\nProperly find owner of closure in THIR unsafeck\n\nPreviously, when encountering a closure in a constant, the THIR unsafeck gets invoked on the owner of the constant instead of the constant itself, producing cycles.\nSupersedes #87492. ```@FabianWolff``` thanks for your work on that PR, I copied your test file and added you as a co-author.\n\nFixes #87414.\nr? ```@oli-obk```", "tree": {"sha": "ebcc03ab83ff9cd7b38f52a6d3c02489a03d1096", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ebcc03ab83ff9cd7b38f52a6d3c02489a03d1096"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/345862d2245c2fe132c793ab528709045b38beaa", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhCRVvCRBK7hj4Ov3rIwAAWrcIAKJowajpnDRJ+14ZHox2BqwD\nbulm35Kl2QJpySrQrVV9Xv4V3ePJFs1mZlfK1nIz3XuKBno4IDkBejpYPT40xo2W\nGsEP/zw1mmE2G4c+c6a2BFIVgqdrViLilZ9EBClr6Uw2l2NwG6VKi6/QNEO8vmFT\nvvKlF+BQOsFt4m2cmmwHOOhK3tmrYZiwIgiNgsHwivIMVlardXuinK4dlLNk7gBQ\nnDCjfsOD8+riRWXpP5Ua8SJyaIrFxE0LQjhwqT/vALi0ZJHKyJ8aIh0zy+il26I9\nAtdjWJZB8WoOJtbZULJJbQGPJuW8lyk/sDAYFjw1KkQhmbDebgG7cFjWbYoyOp8=\n=vV0S\n-----END PGP SIGNATURE-----\n", "payload": "tree ebcc03ab83ff9cd7b38f52a6d3c02489a03d1096\nparent e91405b9d5c8dabb3e488bafb314147f1050f9b9\nparent 12804230a25d4f996f4738de20c161d95df4933b\nauthor Yuki Okushi <jtitor@2k36.org> 1627985263 +0900\ncommitter GitHub <noreply@github.com> 1627985263 +0900\n\nRollup merge of #87645 - LeSeulArtichaut:issue-87414, r=oli-obk\n\nProperly find owner of closure in THIR unsafeck\n\nPreviously, when encountering a closure in a constant, the THIR unsafeck gets invoked on the owner of the constant instead of the constant itself, producing cycles.\nSupersedes #87492. ```@FabianWolff``` thanks for your work on that PR, I copied your test file and added you as a co-author.\n\nFixes #87414.\nr? ```@oli-obk```\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/345862d2245c2fe132c793ab528709045b38beaa", "html_url": "https://github.com/rust-lang/rust/commit/345862d2245c2fe132c793ab528709045b38beaa", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/345862d2245c2fe132c793ab528709045b38beaa/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e91405b9d5c8dabb3e488bafb314147f1050f9b9", "url": "https://api.github.com/repos/rust-lang/rust/commits/e91405b9d5c8dabb3e488bafb314147f1050f9b9", "html_url": "https://github.com/rust-lang/rust/commit/e91405b9d5c8dabb3e488bafb314147f1050f9b9"}, {"sha": "12804230a25d4f996f4738de20c161d95df4933b", "url": "https://api.github.com/repos/rust-lang/rust/commits/12804230a25d4f996f4738de20c161d95df4933b", "html_url": "https://github.com/rust-lang/rust/commit/12804230a25d4f996f4738de20c161d95df4933b"}], "stats": {"total": 26, "additions": 19, "deletions": 7}, "files": [{"sha": "d27ce6ec81a90214d190167c3a652f8ab434c574", "filename": "compiler/rustc_mir_build/src/check_unsafety.rs", "status": "modified", "additions": 4, "deletions": 7, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/345862d2245c2fe132c793ab528709045b38beaa/compiler%2Frustc_mir_build%2Fsrc%2Fcheck_unsafety.rs", "raw_url": "https://github.com/rust-lang/rust/raw/345862d2245c2fe132c793ab528709045b38beaa/compiler%2Frustc_mir_build%2Fsrc%2Fcheck_unsafety.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fcheck_unsafety.rs?ref=345862d2245c2fe132c793ab528709045b38beaa", "patch": "@@ -599,13 +599,10 @@ pub fn check_unsafety<'tcx>(tcx: TyCtxt<'tcx>, def: ty::WithOptConstParam<LocalD\n \n     // Closures are handled by their owner, if it has a body\n     if tcx.is_closure(def.did.to_def_id()) {\n-        let owner = tcx.hir().local_def_id_to_hir_id(def.did).owner;\n-        let owner_hir_id = tcx.hir().local_def_id_to_hir_id(owner);\n-\n-        if tcx.hir().maybe_body_owned_by(owner_hir_id).is_some() {\n-            tcx.ensure().thir_check_unsafety(owner);\n-            return;\n-        }\n+        let hir = tcx.hir();\n+        let owner = hir.enclosing_body_owner(hir.local_def_id_to_hir_id(def.did));\n+        tcx.ensure().thir_check_unsafety(hir.local_def_id(owner));\n+        return;\n     }\n \n     let (thir, expr) = tcx.thir_body(def);"}, {"sha": "99e40ba4b4c04b0fe0018616f8fbcb8037f55df9", "filename": "src/test/ui/unsafe/issue-87414-query-cycle.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/345862d2245c2fe132c793ab528709045b38beaa/src%2Ftest%2Fui%2Funsafe%2Fissue-87414-query-cycle.rs", "raw_url": "https://github.com/rust-lang/rust/raw/345862d2245c2fe132c793ab528709045b38beaa/src%2Ftest%2Fui%2Funsafe%2Fissue-87414-query-cycle.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Funsafe%2Fissue-87414-query-cycle.rs?ref=345862d2245c2fe132c793ab528709045b38beaa", "patch": "@@ -0,0 +1,15 @@\n+// Regression test for #87414.\n+\n+// check-pass\n+// compile-flags: -Zthir-unsafeck\n+\n+fn bad<T>() -> Box<dyn Iterator<Item = [(); { |x: u32| { x }; 4 }]>> { todo!() }\n+\n+fn foo() -> [(); { |x: u32| { x }; 4 }] { todo!() }\n+fn bar() { let _: [(); { |x: u32| { x }; 4 }]; }\n+\n+// This one should not cause any errors either:\n+unsafe fn unsf() {}\n+fn bad2<T>() -> Box<dyn Iterator<Item = [(); { unsafe { || { unsf() } }; 4 }]>> { todo!() }\n+\n+fn main() {}"}]}