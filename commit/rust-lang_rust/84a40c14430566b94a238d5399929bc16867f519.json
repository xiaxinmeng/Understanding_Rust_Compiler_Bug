{"sha": "84a40c14430566b94a238d5399929bc16867f519", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg0YTQwYzE0NDMwNTY2Yjk0YTIzOGQ1Mzk5OTI5YmMxNjg2N2Y1MTk=", "commit": {"author": {"name": "Michael Woerister", "email": "michaelwoerister@posteo.net", "date": "2017-05-10T09:00:08Z"}, "committer": {"name": "Michael Woerister", "email": "michaelwoerister@posteo.net", "date": "2017-05-10T10:35:36Z"}, "message": "ICH: Handle case of removed FileMaps.", "tree": {"sha": "dd528f09122432bd2351f9976d5e5d20ceb02968", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/dd528f09122432bd2351f9976d5e5d20ceb02968"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/84a40c14430566b94a238d5399929bc16867f519", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/84a40c14430566b94a238d5399929bc16867f519", "html_url": "https://github.com/rust-lang/rust/commit/84a40c14430566b94a238d5399929bc16867f519", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/84a40c14430566b94a238d5399929bc16867f519/comments", "author": {"login": "michaelwoerister", "id": 1825894, "node_id": "MDQ6VXNlcjE4MjU4OTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1825894?v=4", "gravatar_id": "", "url": "https://api.github.com/users/michaelwoerister", "html_url": "https://github.com/michaelwoerister", "followers_url": "https://api.github.com/users/michaelwoerister/followers", "following_url": "https://api.github.com/users/michaelwoerister/following{/other_user}", "gists_url": "https://api.github.com/users/michaelwoerister/gists{/gist_id}", "starred_url": "https://api.github.com/users/michaelwoerister/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/michaelwoerister/subscriptions", "organizations_url": "https://api.github.com/users/michaelwoerister/orgs", "repos_url": "https://api.github.com/users/michaelwoerister/repos", "events_url": "https://api.github.com/users/michaelwoerister/events{/privacy}", "received_events_url": "https://api.github.com/users/michaelwoerister/received_events", "type": "User", "site_admin": false}, "committer": {"login": "michaelwoerister", "id": 1825894, "node_id": "MDQ6VXNlcjE4MjU4OTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1825894?v=4", "gravatar_id": "", "url": "https://api.github.com/users/michaelwoerister", "html_url": "https://github.com/michaelwoerister", "followers_url": "https://api.github.com/users/michaelwoerister/followers", "following_url": "https://api.github.com/users/michaelwoerister/following{/other_user}", "gists_url": "https://api.github.com/users/michaelwoerister/gists{/gist_id}", "starred_url": "https://api.github.com/users/michaelwoerister/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/michaelwoerister/subscriptions", "organizations_url": "https://api.github.com/users/michaelwoerister/orgs", "repos_url": "https://api.github.com/users/michaelwoerister/repos", "events_url": "https://api.github.com/users/michaelwoerister/events{/privacy}", "received_events_url": "https://api.github.com/users/michaelwoerister/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "58b33ad70cdd11f9ce7b5874c6effab9627e51aa", "url": "https://api.github.com/repos/rust-lang/rust/commits/58b33ad70cdd11f9ce7b5874c6effab9627e51aa", "html_url": "https://github.com/rust-lang/rust/commit/58b33ad70cdd11f9ce7b5874c6effab9627e51aa"}], "stats": {"total": 50, "additions": 49, "deletions": 1}, "files": [{"sha": "2f727a80f016e0589ccb8069554338645c3db31d", "filename": "src/librustc_incremental/persist/hash.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/84a40c14430566b94a238d5399929bc16867f519/src%2Flibrustc_incremental%2Fpersist%2Fhash.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84a40c14430566b94a238d5399929bc16867f519/src%2Flibrustc_incremental%2Fpersist%2Fhash.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_incremental%2Fpersist%2Fhash.rs?ref=84a40c14430566b94a238d5399929bc16867f519", "patch": "@@ -79,7 +79,11 @@ impl<'a, 'tcx> HashContext<'a, 'tcx> {\n \n             DepNode::FileMap(def_id, ref name) => {\n                 if def_id.is_local() {\n-                    Some(self.incremental_hashes_map[dep_node])\n+                    // We will have been able to retrace the DefId (which is\n+                    // always the local CRATE_DEF_INDEX), but the file with the\n+                    // given name might have been removed, so we use get() in\n+                    // order to allow for that case.\n+                    self.incremental_hashes_map.get(dep_node).map(|x| *x)\n                 } else {\n                     Some(self.metadata_hash(DepNode::FileMap(def_id, name.clone()),\n                                             def_id.krate,"}, {"sha": "a2cea65a309ce7ae78c176ae01231b409e30b73e", "filename": "src/test/incremental/remove_source_file/auxiliary/mod.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/84a40c14430566b94a238d5399929bc16867f519/src%2Ftest%2Fincremental%2Fremove_source_file%2Fauxiliary%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84a40c14430566b94a238d5399929bc16867f519/src%2Ftest%2Fincremental%2Fremove_source_file%2Fauxiliary%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fincremental%2Fremove_source_file%2Fauxiliary%2Fmod.rs?ref=84a40c14430566b94a238d5399929bc16867f519", "patch": "@@ -0,0 +1,13 @@\n+// Copyright 2017 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+pub fn print_hello() {\n+    println!(\"hello\");\n+}"}, {"sha": "4ba33f3bb3d62e9715fabcdf376df010b5470000", "filename": "src/test/incremental/remove_source_file/main.rs", "status": "added", "additions": 31, "deletions": 0, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/84a40c14430566b94a238d5399929bc16867f519/src%2Ftest%2Fincremental%2Fremove_source_file%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84a40c14430566b94a238d5399929bc16867f519/src%2Ftest%2Fincremental%2Fremove_source_file%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fincremental%2Fremove_source_file%2Fmain.rs?ref=84a40c14430566b94a238d5399929bc16867f519", "patch": "@@ -0,0 +1,31 @@\n+// Copyright 2017 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// This test case makes sure that the compiler doesn't crash due to a failing\n+// table lookup when a source file is removed.\n+\n+// revisions:rpass1 rpass2\n+\n+// Note that we specify -g so that the FileMaps actually get referenced by the\n+// incr. comp. cache:\n+// compile-flags: -Z query-dep-graph -g\n+\n+#[cfg(rpass1)]\n+mod auxiliary;\n+\n+#[cfg(rpass1)]\n+fn main() {\n+    auxiliary::print_hello();\n+}\n+\n+#[cfg(rpass2)]\n+fn main() {\n+    println!(\"hello\");\n+}"}]}