{"sha": "87e56eb94ced9943977a38e7d4c6697587187ce6", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg3ZTU2ZWI5NGNlZDk5NDM5NzdhMzhlN2Q0YzY2OTc1ODcxODdjZTY=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-04-05T17:49:48Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-04-05T17:49:48Z"}, "message": "Merge #8350\n\n8350: internal: prepare to store OpQueue results in the queue itself r=matklad a=matklad\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>", "tree": {"sha": "bdeab141a5919fc0964f6c5a70553beeecb182d6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bdeab141a5919fc0964f6c5a70553beeecb182d6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/87e56eb94ced9943977a38e7d4c6697587187ce6", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJga028CRBK7hj4Ov3rIwAAdHIIAErleV2lTfgrLknevCOujRUv\nhL93RdPnzFcW4vu5ZtnfVl36MqkwtOR2AVBYcMm07wnb4sCB14R/+YzVoXCmqyuk\n1CZOoqtkA/IuVs6tXpP3wpkDqv04BWY5OX26RGlO0StRkjCvlobQlX9kGxMwpq7o\nJ720k5tn57MGtDu3nGKJihOIVfc4VqybJDBEd4XVGDXI84VxYuItcf7QO20QmsX3\n4SVBbYEmmKd3jjm06WT3qP0LY7SjPK3lLpKQcCly1/y6Agn5eCssWclwRdxLxTAH\nqAWM/fEGp9bdlL5aAb4Z90C9sfwYzg2FhqLKjNQa4uM+KgiKFTUE1VqIdW5YlYs=\n=VlSW\n-----END PGP SIGNATURE-----\n", "payload": "tree bdeab141a5919fc0964f6c5a70553beeecb182d6\nparent c91b5376835ab54cd4bca02953625ef1f1fabeba\nparent 7099438e0c2f281629e11b63acfbcdefc22fef76\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1617644988 +0000\ncommitter GitHub <noreply@github.com> 1617644988 +0000\n\nMerge #8350\n\n8350: internal: prepare to store OpQueue results in the queue itself r=matklad a=matklad\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/87e56eb94ced9943977a38e7d4c6697587187ce6", "html_url": "https://github.com/rust-lang/rust/commit/87e56eb94ced9943977a38e7d4c6697587187ce6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/87e56eb94ced9943977a38e7d4c6697587187ce6/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c91b5376835ab54cd4bca02953625ef1f1fabeba", "url": "https://api.github.com/repos/rust-lang/rust/commits/c91b5376835ab54cd4bca02953625ef1f1fabeba", "html_url": "https://github.com/rust-lang/rust/commit/c91b5376835ab54cd4bca02953625ef1f1fabeba"}, {"sha": "7099438e0c2f281629e11b63acfbcdefc22fef76", "url": "https://api.github.com/repos/rust-lang/rust/commits/7099438e0c2f281629e11b63acfbcdefc22fef76", "html_url": "https://github.com/rust-lang/rust/commit/7099438e0c2f281629e11b63acfbcdefc22fef76"}], "stats": {"total": 37, "additions": 24, "deletions": 13}, "files": [{"sha": "8679c8599617f4c99a5c4cb5fdb638f44aae6f30", "filename": "crates/rust-analyzer/src/global_state.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/87e56eb94ced9943977a38e7d4c6697587187ce6/crates%2Frust-analyzer%2Fsrc%2Fglobal_state.rs", "raw_url": "https://github.com/rust-lang/rust/raw/87e56eb94ced9943977a38e7d4c6697587187ce6/crates%2Frust-analyzer%2Fsrc%2Fglobal_state.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fglobal_state.rs?ref=87e56eb94ced9943977a38e7d4c6697587187ce6", "patch": "@@ -81,10 +81,13 @@ pub(crate) struct GlobalState {\n     pub(crate) status: Status,\n     pub(crate) source_root_config: SourceRootConfig,\n     pub(crate) proc_macro_client: Option<ProcMacroClient>,\n+\n     pub(crate) workspaces: Arc<Vec<ProjectWorkspace>>,\n-    pub(crate) fetch_workspaces_queue: OpQueue<()>,\n+    pub(crate) fetch_workspaces_queue: OpQueue<(), ()>,\n+\n     pub(crate) workspace_build_data: Option<BuildDataResult>,\n-    pub(crate) fetch_build_data_queue: OpQueue<BuildDataCollector>,\n+    pub(crate) fetch_build_data_queue: OpQueue<BuildDataCollector, ()>,\n+\n     latest_requests: Arc<RwLock<LatestRequests>>,\n }\n "}, {"sha": "f71b718bc08751324ec60f6f447933cd78ed53ec", "filename": "crates/rust-analyzer/src/op_queue.rs", "status": "modified", "additions": 17, "deletions": 9, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/87e56eb94ced9943977a38e7d4c6697587187ce6/crates%2Frust-analyzer%2Fsrc%2Fop_queue.rs", "raw_url": "https://github.com/rust-lang/rust/raw/87e56eb94ced9943977a38e7d4c6697587187ce6/crates%2Frust-analyzer%2Fsrc%2Fop_queue.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fop_queue.rs?ref=87e56eb94ced9943977a38e7d4c6697587187ce6", "patch": "@@ -1,29 +1,37 @@\n-//! Bookkeeping to make sure only one long-running operation is executed.\n+//! Bookkeeping to make sure only one long-running operation is being executed\n+//! at a time.\n \n-pub(crate) struct OpQueue<D> {\n-    op_scheduled: Option<D>,\n+pub(crate) struct OpQueue<Args, Output> {\n+    op_scheduled: Option<Args>,\n     op_in_progress: bool,\n+    last_op_result: Output,\n }\n \n-impl<D> Default for OpQueue<D> {\n+impl<Args, Output: Default> Default for OpQueue<Args, Output> {\n     fn default() -> Self {\n-        Self { op_scheduled: None, op_in_progress: false }\n+        Self { op_scheduled: None, op_in_progress: false, last_op_result: Default::default() }\n     }\n }\n \n-impl<D> OpQueue<D> {\n-    pub(crate) fn request_op(&mut self, data: D) {\n+impl<Args, Output> OpQueue<Args, Output> {\n+    pub(crate) fn request_op(&mut self, data: Args) {\n         self.op_scheduled = Some(data);\n     }\n-    pub(crate) fn should_start_op(&mut self) -> Option<D> {\n+    pub(crate) fn should_start_op(&mut self) -> Option<Args> {\n         if self.op_in_progress {\n             return None;\n         }\n         self.op_in_progress = self.op_scheduled.is_some();\n         self.op_scheduled.take()\n     }\n-    pub(crate) fn op_completed(&mut self) {\n+    pub(crate) fn op_completed(&mut self, result: Output) {\n         assert!(self.op_in_progress);\n         self.op_in_progress = false;\n+        self.last_op_result = result;\n+    }\n+\n+    #[allow(unused)]\n+    pub(crate) fn last_op_result(&self) -> &Output {\n+        &self.last_op_result\n     }\n }"}, {"sha": "d12f891bbce60b2febcfca63141752f8911e4aca", "filename": "crates/rust-analyzer/src/reload.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/87e56eb94ced9943977a38e7d4c6697587187ce6/crates%2Frust-analyzer%2Fsrc%2Freload.rs", "raw_url": "https://github.com/rust-lang/rust/raw/87e56eb94ced9943977a38e7d4c6697587187ce6/crates%2Frust-analyzer%2Fsrc%2Freload.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Freload.rs?ref=87e56eb94ced9943977a38e7d4c6697587187ce6", "patch": "@@ -140,7 +140,7 @@ impl GlobalState {\n         });\n     }\n     pub(crate) fn fetch_build_data_completed(&mut self) {\n-        self.fetch_build_data_queue.op_completed()\n+        self.fetch_build_data_queue.op_completed(())\n     }\n \n     pub(crate) fn fetch_workspaces_request(&mut self) {\n@@ -195,7 +195,7 @@ impl GlobalState {\n         });\n     }\n     pub(crate) fn fetch_workspaces_completed(&mut self) {\n-        self.fetch_workspaces_queue.op_completed()\n+        self.fetch_workspaces_queue.op_completed(())\n     }\n \n     pub(crate) fn switch_workspaces("}]}