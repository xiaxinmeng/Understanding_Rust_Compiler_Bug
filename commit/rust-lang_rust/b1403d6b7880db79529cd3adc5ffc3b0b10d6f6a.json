{"sha": "b1403d6b7880db79529cd3adc5ffc3b0b10d6f6a", "node_id": "C_kwDOAAsO6NoAKGIxNDAzZDZiNzg4MGRiNzk1MjljZDNhZGM1ZmZjM2IwYjEwZDZmNmE", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-06-30T17:55:52Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-06-30T17:55:52Z"}, "message": "Rollup merge of #98671 - GuillaumeGomez:source-sidebar-fixes, r=notriddle\n\nFix source sidebar bugs\n\nThis PR fixes the following two bugs:\n\n![Screenshot from 2022-06-29 14-39-58](https://user-images.githubusercontent.com/3050060/176449070-3e3762da-2bfe-4acf-8eb0-34f6eb4c94ed.png)\n![Screenshot from 2022-06-29 15-05-09](https://user-images.githubusercontent.com/3050060/176449073-b164820b-bd71-4b1a-990c-bba4e5fce196.png)\n\nI added regression tests to prevent them to happen again.\n\nI think we should backport it to beta as well.\n\nYou can test it [here](https://rustdoc.crud.net/imperio/source-sidebar-fixes/src/std/lib.rs.html).\n\ncc ```@jsha```\nr? ```@notriddle```", "tree": {"sha": "009cf60c09764cdef21328a113f4b649d34ec809", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/009cf60c09764cdef21328a113f4b649d34ec809"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b1403d6b7880db79529cd3adc5ffc3b0b10d6f6a", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJiveOpCRBK7hj4Ov3rIwAAdzIIACVEzTsSUalq1t/nG+n3GaGh\nO9e8G5WQ080GX29u8NhDUJzGGHwmAIHnWfOI5KKj2bkea4Tx04joDXdhGDpU+o03\nglX4FfN6lawlq+DC18atAAEp+QYT9XKTBEhNFH/7I4zY1CXEpSps486DhhFm69Hb\ncxWQrO5D84sdWDLaHA7IZta4NNnXv/p/IHptOQmWRfSE0tg4ghDsUKHAOvB1s559\nvDniXcg6KBa0HBNqyeS1JZ5lPCrSHazRb1LCRbSA65X7InYO47fVKLlPg3KVUabT\ni5+kC+nlR1gvQtD5kGJRAIW+Lu538dNYs5lezIY+jzVkSV3MVEwXQqHqZ+kyFww=\n=8OFi\n-----END PGP SIGNATURE-----\n", "payload": "tree 009cf60c09764cdef21328a113f4b649d34ec809\nparent 5cd41d7be8f1af027d2d3e38f7ac5d278bf5e0be\nparent 9a1f52d7fd78f3dc26b49d4490e4e8004f590fc3\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1656611752 +0200\ncommitter GitHub <noreply@github.com> 1656611752 +0200\n\nRollup merge of #98671 - GuillaumeGomez:source-sidebar-fixes, r=notriddle\n\nFix source sidebar bugs\n\nThis PR fixes the following two bugs:\n\n![Screenshot from 2022-06-29 14-39-58](https://user-images.githubusercontent.com/3050060/176449070-3e3762da-2bfe-4acf-8eb0-34f6eb4c94ed.png)\n![Screenshot from 2022-06-29 15-05-09](https://user-images.githubusercontent.com/3050060/176449073-b164820b-bd71-4b1a-990c-bba4e5fce196.png)\n\nI added regression tests to prevent them to happen again.\n\nI think we should backport it to beta as well.\n\nYou can test it [here](https://rustdoc.crud.net/imperio/source-sidebar-fixes/src/std/lib.rs.html).\n\ncc ```@jsha```\nr? ```@notriddle```\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b1403d6b7880db79529cd3adc5ffc3b0b10d6f6a", "html_url": "https://github.com/rust-lang/rust/commit/b1403d6b7880db79529cd3adc5ffc3b0b10d6f6a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b1403d6b7880db79529cd3adc5ffc3b0b10d6f6a/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5cd41d7be8f1af027d2d3e38f7ac5d278bf5e0be", "url": "https://api.github.com/repos/rust-lang/rust/commits/5cd41d7be8f1af027d2d3e38f7ac5d278bf5e0be", "html_url": "https://github.com/rust-lang/rust/commit/5cd41d7be8f1af027d2d3e38f7ac5d278bf5e0be"}, {"sha": "9a1f52d7fd78f3dc26b49d4490e4e8004f590fc3", "url": "https://api.github.com/repos/rust-lang/rust/commits/9a1f52d7fd78f3dc26b49d4490e4e8004f590fc3", "html_url": "https://github.com/rust-lang/rust/commit/9a1f52d7fd78f3dc26b49d4490e4e8004f590fc3"}], "stats": {"total": 64, "additions": 60, "deletions": 4}, "files": [{"sha": "bae256fd5b38acfa0a6909427beeef27b76fb95e", "filename": "src/ci/docker/host-x86_64/x86_64-gnu-tools/browser-ui-test.version", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b1403d6b7880db79529cd3adc5ffc3b0b10d6f6a/src%2Fci%2Fdocker%2Fhost-x86_64%2Fx86_64-gnu-tools%2Fbrowser-ui-test.version", "raw_url": "https://github.com/rust-lang/rust/raw/b1403d6b7880db79529cd3adc5ffc3b0b10d6f6a/src%2Fci%2Fdocker%2Fhost-x86_64%2Fx86_64-gnu-tools%2Fbrowser-ui-test.version", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fx86_64-gnu-tools%2Fbrowser-ui-test.version?ref=b1403d6b7880db79529cd3adc5ffc3b0b10d6f6a", "patch": "@@ -1 +1 @@\n-0.9.6\n\\ No newline at end of file\n+0.9.7\n\\ No newline at end of file"}, {"sha": "532b98d9bb9f64017664c66c4cfdc9edc93a697e", "filename": "src/librustdoc/html/static/css/rustdoc.css", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/b1403d6b7880db79529cd3adc5ffc3b0b10d6f6a/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Frustdoc.css", "raw_url": "https://github.com/rust-lang/rust/raw/b1403d6b7880db79529cd3adc5ffc3b0b10d6f6a/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Frustdoc.css", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Frustdoc.css?ref=b1403d6b7880db79529cd3adc5ffc3b0b10d6f6a", "patch": "@@ -1772,9 +1772,11 @@ details.rustdoc-toggle[open] > summary.hideme::after {\n \t/* The source view uses a different design for the sidebar toggle, and doesn't have a topbar,\n \t   so don't bump down the main content or the sidebar. */\n \t.source main,\n-\t.source .sidebar {\n+\t.rustdoc.source .sidebar {\n \t\ttop: 0;\n \t\tpadding: 0;\n+\t\theight: 100vh;\n+\t\tborder: 0;\n \t}\n \n \t.sidebar.shown,\n@@ -1924,6 +1926,9 @@ details.rustdoc-toggle[open] > summary.hideme::after {\n \t\twidth: unset;\n \t\tborder-top-right-radius: unset;\n \t\tborder-bottom-right-radius: unset;\n+\t\tposition: sticky;\n+\t\tborder: 0;\n+\t\tborder-bottom: 1px solid;\n \t}\n \n \t#source-sidebar {"}, {"sha": "acb1d8d7b5c8d2ea558de8db6321840e9c0afcbc", "filename": "src/librustdoc/html/static/js/source-script.js", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/b1403d6b7880db79529cd3adc5ffc3b0b10d6f6a/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsource-script.js", "raw_url": "https://github.com/rust-lang/rust/raw/b1403d6b7880db79529cd3adc5ffc3b0b10d6f6a/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsource-script.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsource-script.js?ref=b1403d6b7880db79529cd3adc5ffc3b0b10d6f6a", "patch": "@@ -10,6 +10,7 @@\n (function() {\n \n const rootPath = document.getElementById(\"rustdoc-vars\").attributes[\"data-root-path\"].value;\n+let oldScrollPosition = 0;\n \n function createDirEntry(elem, parent, fullPath, hasFoundFile) {\n     const name = document.createElement(\"div\");\n@@ -65,10 +66,24 @@ function createDirEntry(elem, parent, fullPath, hasFoundFile) {\n function toggleSidebar() {\n     const child = this.children[0];\n     if (child.innerText === \">\") {\n+        if (window.innerWidth < 701) {\n+            // This is to keep the scroll position on mobile.\n+            oldScrollPosition = window.scrollY;\n+            document.body.style.position = \"fixed\";\n+            document.body.style.top = `-${oldScrollPosition}px`;\n+        }\n         addClass(document.documentElement, \"source-sidebar-expanded\");\n         child.innerText = \"<\";\n         updateLocalStorage(\"source-sidebar-show\", \"true\");\n     } else {\n+        if (window.innerWidth < 701) {\n+            // This is to keep the scroll position on mobile.\n+            document.body.style.position = \"\";\n+            document.body.style.top = \"\";\n+            // The scroll position is lost when resetting the style, hence why we store it in\n+            // `oldScroll`.\n+            window.scrollTo(0, oldScrollPosition);\n+        }\n         removeClass(document.documentElement, \"source-sidebar-expanded\");\n         child.innerText = \">\";\n         updateLocalStorage(\"source-sidebar-show\", \"false\");"}, {"sha": "c441f84a82135f2960f9be78412bfccad59fc9c1", "filename": "src/test/rustdoc-gui/sidebar-source-code-display.goml", "status": "modified", "additions": 36, "deletions": 0, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/b1403d6b7880db79529cd3adc5ffc3b0b10d6f6a/src%2Ftest%2Frustdoc-gui%2Fsidebar-source-code-display.goml", "raw_url": "https://github.com/rust-lang/rust/raw/b1403d6b7880db79529cd3adc5ffc3b0b10d6f6a/src%2Ftest%2Frustdoc-gui%2Fsidebar-source-code-display.goml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-gui%2Fsidebar-source-code-display.goml?ref=b1403d6b7880db79529cd3adc5ffc3b0b10d6f6a", "patch": "@@ -116,3 +116,39 @@ assert-css: (\n     \"#source-sidebar .expand + .children .folders .name\",\n     {\"color\": \"rgb(255, 180, 76)\", \"background-color\": \"rgb(20, 25, 31)\"},\n )\n+\n+// Now checking on mobile devices.\n+size: (500, 700)\n+reload:\n+// Waiting for the sidebar to be displayed...\n+wait-for-css: (\"#sidebar-toggle\", {\"visibility\": \"visible\", \"opacity\": 1})\n+\n+// We now check it takes the full size of the display.\n+assert-property: (\"body\", {\"clientWidth\": \"500\", \"clientHeight\": \"700\"})\n+assert-property: (\".sidebar\", {\"clientWidth\": \"500\", \"clientHeight\": \"700\"})\n+\n+// We now check the display of the toggle once the sidebar is expanded.\n+assert-property: (\"#sidebar-toggle\", {\"clientWidth\": \"500\", \"clientHeight\": \"39\"})\n+assert-css: (\n+    \"#sidebar-toggle\",\n+    {\n+        \"border-top-width\": \"0px\",\n+        \"border-right-width\": \"0px\",\n+        \"border-left-width\": \"0px\",\n+        \"border-bottom-width\": \"1px\",\n+    },\n+)\n+\n+// We now check that the scroll position is kept when opening the sidebar.\n+click: \"#sidebar-toggle\"\n+wait-for-css: (\".sidebar\", {\"width\": \"0px\"})\n+// We scroll to line 117 to change the scroll position.\n+scroll-to: '//*[@id=\"117\"]'\n+assert-window-property: {\"pageYOffset\": \"2519\"}\n+// Expanding the sidebar...\n+click: \"#sidebar-toggle\"\n+wait-for-css: (\".sidebar\", {\"width\": \"500px\"})\n+click: \"#sidebar-toggle\"\n+wait-for-css: (\".sidebar\", {\"width\": \"0px\"})\n+// The \"scrollTop\" property should be the same.\n+assert-window-property: {\"pageYOffset\": \"2519\"}"}, {"sha": "86df478fa1dd268cb9cac26164c00a16311364cf", "filename": "src/test/rustdoc-gui/sidebar-source-code.goml", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/b1403d6b7880db79529cd3adc5ffc3b0b10d6f6a/src%2Ftest%2Frustdoc-gui%2Fsidebar-source-code.goml", "raw_url": "https://github.com/rust-lang/rust/raw/b1403d6b7880db79529cd3adc5ffc3b0b10d6f6a/src%2Ftest%2Frustdoc-gui%2Fsidebar-source-code.goml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-gui%2Fsidebar-source-code.goml?ref=b1403d6b7880db79529cd3adc5ffc3b0b10d6f6a", "patch": "@@ -18,8 +18,8 @@ assert: \"nav.sidebar\"\n \n // We now switch to mobile mode.\n size: (600, 600)\n-// We check that the sidebar has the expected width (0 and 1px for the border).\n-assert-css: (\"nav.sidebar\", {\"width\": \"1px\"})\n+// We check that the sidebar has the expected width (0).\n+assert-css: (\"nav.sidebar\", {\"width\": \"0px\"})\n // We expand the sidebar.\n click: \"#sidebar-toggle\"\n assert-css: (\".source-sidebar-expanded nav.sidebar\", {\"width\": \"600px\"})"}]}