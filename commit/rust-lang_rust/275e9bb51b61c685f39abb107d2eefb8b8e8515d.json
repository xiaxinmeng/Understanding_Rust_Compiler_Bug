{"sha": "275e9bb51b61c685f39abb107d2eefb8b8e8515d", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI3NWU5YmI1MWI2MWM2ODVmMzlhYmIxMDdkMmVlZmI4YjhlODUxNWQ=", "commit": {"author": {"name": "Christopher Serr", "email": "christopher.serr@gmail.com", "date": "2017-02-20T22:20:06Z"}, "committer": {"name": "Christopher Serr", "email": "christopher.serr@gmail.com", "date": "2017-02-20T22:29:02Z"}, "message": "Turn off Vectorization for Emscripten\n\nWhen targeting Emscripten, rustc emits Vector Instructions by default.\nHowever Web Assembly doesn't support Vector Instructions yet, which\ncauses Binaryen to fail converting the intermediate asm.js code to Web\nAssembly. While asm.js kind of supports Vector Instructions, they\naren't supported by any browser other than Firefox, often meaning that\nthey need to be emulated very slowly. So it should just be turned off\nfor all Emscripten targets.\n\nFixes #38558", "tree": {"sha": "cda036b7f8a916d9cae9643834b9e63c0662e979", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/cda036b7f8a916d9cae9643834b9e63c0662e979"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/275e9bb51b61c685f39abb107d2eefb8b8e8515d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/275e9bb51b61c685f39abb107d2eefb8b8e8515d", "html_url": "https://github.com/rust-lang/rust/commit/275e9bb51b61c685f39abb107d2eefb8b8e8515d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/275e9bb51b61c685f39abb107d2eefb8b8e8515d/comments", "author": {"login": "CryZe", "id": 1451630, "node_id": "MDQ6VXNlcjE0NTE2MzA=", "avatar_url": "https://avatars.githubusercontent.com/u/1451630?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CryZe", "html_url": "https://github.com/CryZe", "followers_url": "https://api.github.com/users/CryZe/followers", "following_url": "https://api.github.com/users/CryZe/following{/other_user}", "gists_url": "https://api.github.com/users/CryZe/gists{/gist_id}", "starred_url": "https://api.github.com/users/CryZe/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CryZe/subscriptions", "organizations_url": "https://api.github.com/users/CryZe/orgs", "repos_url": "https://api.github.com/users/CryZe/repos", "events_url": "https://api.github.com/users/CryZe/events{/privacy}", "received_events_url": "https://api.github.com/users/CryZe/received_events", "type": "User", "site_admin": false}, "committer": {"login": "CryZe", "id": 1451630, "node_id": "MDQ6VXNlcjE0NTE2MzA=", "avatar_url": "https://avatars.githubusercontent.com/u/1451630?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CryZe", "html_url": "https://github.com/CryZe", "followers_url": "https://api.github.com/users/CryZe/followers", "following_url": "https://api.github.com/users/CryZe/following{/other_user}", "gists_url": "https://api.github.com/users/CryZe/gists{/gist_id}", "starred_url": "https://api.github.com/users/CryZe/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CryZe/subscriptions", "organizations_url": "https://api.github.com/users/CryZe/orgs", "repos_url": "https://api.github.com/users/CryZe/repos", "events_url": "https://api.github.com/users/CryZe/events{/privacy}", "received_events_url": "https://api.github.com/users/CryZe/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5b7c5563855123ab094db99d42ccab5f26dbccdf", "url": "https://api.github.com/repos/rust-lang/rust/commits/5b7c5563855123ab094db99d42ccab5f26dbccdf", "html_url": "https://github.com/rust-lang/rust/commit/5b7c5563855123ab094db99d42ccab5f26dbccdf"}], "stats": {"total": 8, "additions": 6, "deletions": 2}, "files": [{"sha": "40a69721495b8394ec797c0bb09d3f265a6600a9", "filename": "src/librustc_trans/back/write.rs", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/275e9bb51b61c685f39abb107d2eefb8b8e8515d/src%2Flibrustc_trans%2Fback%2Fwrite.rs", "raw_url": "https://github.com/rust-lang/rust/raw/275e9bb51b61c685f39abb107d2eefb8b8e8515d/src%2Flibrustc_trans%2Fback%2Fwrite.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Fback%2Fwrite.rs?ref=275e9bb51b61c685f39abb107d2eefb8b8e8515d", "patch": "@@ -315,11 +315,15 @@ impl ModuleConfig {\n         // Copy what clang does by turning on loop vectorization at O2 and\n         // slp vectorization at O3. Otherwise configure other optimization aspects\n         // of this pass manager builder.\n+        // Turn off vectorization for emscripten, as it's not very well supported.\n         self.vectorize_loop = !sess.opts.cg.no_vectorize_loops &&\n                              (sess.opts.optimize == config::OptLevel::Default ||\n-                              sess.opts.optimize == config::OptLevel::Aggressive);\n+                              sess.opts.optimize == config::OptLevel::Aggressive) &&\n+                             !sess.target.target.options.is_like_emscripten;\n+\n         self.vectorize_slp = !sess.opts.cg.no_vectorize_slp &&\n-                            sess.opts.optimize == config::OptLevel::Aggressive;\n+                            sess.opts.optimize == config::OptLevel::Aggressive &&\n+                            !sess.target.target.options.is_like_emscripten;\n \n         self.merge_functions = sess.opts.optimize == config::OptLevel::Default ||\n                                sess.opts.optimize == config::OptLevel::Aggressive;"}]}