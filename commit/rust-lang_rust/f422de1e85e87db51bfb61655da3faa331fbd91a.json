{"sha": "f422de1e85e87db51bfb61655da3faa331fbd91a", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY0MjJkZTFlODVlODdkYjUxYmZiNjE2NTVkYTNmYWEzMzFmYmQ5MWE=", "commit": {"author": {"name": "Keegan McAllister", "email": "kmcallister@mozilla.com", "date": "2014-09-04T02:03:25Z"}, "committer": {"name": "Keegan McAllister", "email": "kmcallister@mozilla.com", "date": "2014-09-04T02:28:37Z"}, "message": "Use a visitor to look for non-FFI-safe types\n\nFixes #16250.", "tree": {"sha": "328fc0843e05d9f5ee776cc642f586db32e847d4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/328fc0843e05d9f5ee776cc642f586db32e847d4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f422de1e85e87db51bfb61655da3faa331fbd91a", "comment_count": 5, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f422de1e85e87db51bfb61655da3faa331fbd91a", "html_url": "https://github.com/rust-lang/rust/commit/f422de1e85e87db51bfb61655da3faa331fbd91a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f422de1e85e87db51bfb61655da3faa331fbd91a/comments", "author": {"login": "kmcallister", "id": 444997, "node_id": "MDQ6VXNlcjQ0NDk5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/444997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kmcallister", "html_url": "https://github.com/kmcallister", "followers_url": "https://api.github.com/users/kmcallister/followers", "following_url": "https://api.github.com/users/kmcallister/following{/other_user}", "gists_url": "https://api.github.com/users/kmcallister/gists{/gist_id}", "starred_url": "https://api.github.com/users/kmcallister/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kmcallister/subscriptions", "organizations_url": "https://api.github.com/users/kmcallister/orgs", "repos_url": "https://api.github.com/users/kmcallister/repos", "events_url": "https://api.github.com/users/kmcallister/events{/privacy}", "received_events_url": "https://api.github.com/users/kmcallister/received_events", "type": "User", "site_admin": false}, "committer": {"login": "kmcallister", "id": 444997, "node_id": "MDQ6VXNlcjQ0NDk5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/444997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kmcallister", "html_url": "https://github.com/kmcallister", "followers_url": "https://api.github.com/users/kmcallister/followers", "following_url": "https://api.github.com/users/kmcallister/following{/other_user}", "gists_url": "https://api.github.com/users/kmcallister/gists{/gist_id}", "starred_url": "https://api.github.com/users/kmcallister/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kmcallister/subscriptions", "organizations_url": "https://api.github.com/users/kmcallister/orgs", "repos_url": "https://api.github.com/users/kmcallister/repos", "events_url": "https://api.github.com/users/kmcallister/events{/privacy}", "received_events_url": "https://api.github.com/users/kmcallister/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7f676b86994edcd6adf27018a5d18e957c9390ab", "url": "https://api.github.com/repos/rust-lang/rust/commits/7f676b86994edcd6adf27018a5d18e957c9390ab", "html_url": "https://github.com/rust-lang/rust/commit/7f676b86994edcd6adf27018a5d18e957c9390ab"}], "stats": {"total": 114, "additions": 74, "deletions": 40}, "files": [{"sha": "355cd8203c5d6d2a479f471c8ad5bcb94a4dc954", "filename": "src/librustc/lint/builtin.rs", "status": "modified", "additions": 56, "deletions": 40, "changes": 96, "blob_url": "https://github.com/rust-lang/rust/blob/f422de1e85e87db51bfb61655da3faa331fbd91a/src%2Flibrustc%2Flint%2Fbuiltin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f422de1e85e87db51bfb61655da3faa331fbd91a/src%2Flibrustc%2Flint%2Fbuiltin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Flint%2Fbuiltin.rs?ref=f422de1e85e87db51bfb61655da3faa331fbd91a", "patch": "@@ -45,6 +45,7 @@ use syntax::attr;\n use syntax::codemap::Span;\n use syntax::parse::token;\n use syntax::{ast, ast_util, visit};\n+use syntax::visit::Visitor;\n \n declare_lint!(WHILE_TRUE, Warn,\n               \"suggest using `loop { }` instead of `while true { }`\")\n@@ -339,6 +340,51 @@ impl LintPass for TypeLimits {\n declare_lint!(CTYPES, Warn,\n               \"proper use of libc types in foreign modules\")\n \n+struct CTypesVisitor<'a> {\n+    cx: &'a Context<'a>\n+}\n+\n+impl<'a> CTypesVisitor<'a> {\n+    fn check_def(&mut self, sp: Span, ty_id: ast::NodeId, path_id: ast::NodeId) {\n+        match self.cx.tcx.def_map.borrow().get_copy(&path_id) {\n+            def::DefPrimTy(ast::TyInt(ast::TyI)) => {\n+                self.cx.span_lint(CTYPES, sp,\n+                                  \"found rust type `int` in foreign module, while \\\n+                                   libc::c_int or libc::c_long should be used\");\n+            }\n+            def::DefPrimTy(ast::TyUint(ast::TyU)) => {\n+                self.cx.span_lint(CTYPES, sp,\n+                                  \"found rust type `uint` in foreign module, while \\\n+                                   libc::c_uint or libc::c_ulong should be used\");\n+            }\n+            def::DefTy(..) => {\n+                let tty = match self.cx.tcx.ast_ty_to_ty_cache.borrow().find(&ty_id) {\n+                    Some(&ty::atttce_resolved(t)) => t,\n+                    _ => fail!(\"ast_ty_to_ty_cache was incomplete after typeck!\")\n+                };\n+\n+                if !ty::is_ffi_safe(self.cx.tcx, tty) {\n+                    self.cx.span_lint(CTYPES, sp,\n+                                      \"found type without foreign-function-safe\n+                                      representation annotation in foreign module, consider \\\n+                                      adding a #[repr(...)] attribute to the type\");\n+                }\n+            }\n+            _ => ()\n+        }\n+    }\n+}\n+\n+impl<'a> Visitor<()> for CTypesVisitor<'a> {\n+    fn visit_ty(&mut self, ty: &ast::Ty, _: ()) {\n+        match ty.node {\n+            ast::TyPath(_, _, id) => self.check_def(ty.span, ty.id, id),\n+            _ => (),\n+        }\n+        visit::walk_ty(self, ty, ());\n+    }\n+}\n+\n pub struct CTypes;\n \n impl LintPass for CTypes {\n@@ -348,38 +394,8 @@ impl LintPass for CTypes {\n \n     fn check_item(&mut self, cx: &Context, it: &ast::Item) {\n         fn check_ty(cx: &Context, ty: &ast::Ty) {\n-            match ty.node {\n-                ast::TyPath(_, _, id) => {\n-                    match cx.tcx.def_map.borrow().get_copy(&id) {\n-                        def::DefPrimTy(ast::TyInt(ast::TyI)) => {\n-                            cx.span_lint(CTYPES, ty.span,\n-                                         \"found rust type `int` in foreign module, while \\\n-                                          libc::c_int or libc::c_long should be used\");\n-                        }\n-                        def::DefPrimTy(ast::TyUint(ast::TyU)) => {\n-                            cx.span_lint(CTYPES, ty.span,\n-                                         \"found rust type `uint` in foreign module, while \\\n-                                          libc::c_uint or libc::c_ulong should be used\");\n-                        }\n-                        def::DefTy(..) => {\n-                            let tty = match cx.tcx.ast_ty_to_ty_cache.borrow().find(&ty.id) {\n-                                Some(&ty::atttce_resolved(t)) => t,\n-                                _ => fail!(\"ast_ty_to_ty_cache was incomplete after typeck!\")\n-                            };\n-\n-                            if !ty::is_ffi_safe(cx.tcx, tty) {\n-                                cx.span_lint(CTYPES, ty.span,\n-                                             \"found type without foreign-function-safe\n-                                             representation annotation in foreign module, consider \\\n-                                             adding a #[repr(...)] attribute to the type\");\n-                            }\n-                        }\n-                        _ => ()\n-                    }\n-                }\n-                ast::TyPtr(ref mt) => { check_ty(cx, &*mt.ty) }\n-                _ => {}\n-            }\n+            let mut vis = CTypesVisitor { cx: cx };\n+            vis.visit_ty(ty, ());\n         }\n \n         fn check_foreign_fn(cx: &Context, decl: &ast::FnDecl) {\n@@ -390,15 +406,15 @@ impl LintPass for CTypes {\n         }\n \n         match it.node {\n-          ast::ItemForeignMod(ref nmod) if nmod.abi != abi::RustIntrinsic => {\n-            for ni in nmod.items.iter() {\n-                match ni.node {\n-                    ast::ForeignItemFn(decl, _) => check_foreign_fn(cx, &*decl),\n-                    ast::ForeignItemStatic(t, _) => check_ty(cx, &*t)\n+            ast::ItemForeignMod(ref nmod) if nmod.abi != abi::RustIntrinsic => {\n+                for ni in nmod.items.iter() {\n+                    match ni.node {\n+                        ast::ForeignItemFn(decl, _) => check_foreign_fn(cx, &*decl),\n+                        ast::ForeignItemStatic(t, _) => check_ty(cx, &*t)\n+                    }\n                 }\n             }\n-          }\n-          _ => {/* nothing to do */ }\n+            _ => (),\n         }\n     }\n }\n@@ -493,7 +509,7 @@ struct RawPtrDerivingVisitor<'a> {\n     cx: &'a Context<'a>\n }\n \n-impl<'a> visit::Visitor<()> for RawPtrDerivingVisitor<'a> {\n+impl<'a> Visitor<()> for RawPtrDerivingVisitor<'a> {\n     fn visit_ty(&mut self, ty: &ast::Ty, _: ()) {\n         static MSG: &'static str = \"use of `#[deriving]` with a raw pointer\";\n         match ty.node {"}, {"sha": "883e79d75e0968707d0b6c6bf35fad82f966c8a4", "filename": "src/test/compile-fail/issue-16250.rs", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/f422de1e85e87db51bfb61655da3faa331fbd91a/src%2Ftest%2Fcompile-fail%2Fissue-16250.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f422de1e85e87db51bfb61655da3faa331fbd91a/src%2Ftest%2Fcompile-fail%2Fissue-16250.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fissue-16250.rs?ref=f422de1e85e87db51bfb61655da3faa331fbd91a", "patch": "@@ -0,0 +1,18 @@\n+// Copyright 2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![deny(warnings)]\n+\n+extern {\n+    pub fn foo(x: (int)); //~ ERROR found rust type `int` in foreign module\n+}\n+\n+fn main() {\n+}"}]}