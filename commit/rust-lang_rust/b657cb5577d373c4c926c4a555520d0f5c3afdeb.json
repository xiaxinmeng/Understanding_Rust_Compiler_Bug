{"sha": "b657cb5577d373c4c926c4a555520d0f5c3afdeb", "node_id": "C_kwDOAAsO6NoAKGI2NTdjYjU1NzdkMzczYzRjOTI2YzRhNTU1NTIwZDBmNWMzYWZkZWI", "commit": {"author": {"name": "jam1garner", "email": "8260240+jam1garner@users.noreply.github.com", "date": "2022-03-31T22:14:01Z"}, "committer": {"name": "jam1garner", "email": "8260240+jam1garner@users.noreply.github.com", "date": "2022-03-31T22:34:20Z"}, "message": "Add error message suggestion for missing noreturn in naked function", "tree": {"sha": "70c6ab6c69318e7a876a83154f63416fc766f1a4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/70c6ab6c69318e7a876a83154f63416fc766f1a4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b657cb5577d373c4c926c4a555520d0f5c3afdeb", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b657cb5577d373c4c926c4a555520d0f5c3afdeb", "html_url": "https://github.com/rust-lang/rust/commit/b657cb5577d373c4c926c4a555520d0f5c3afdeb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b657cb5577d373c4c926c4a555520d0f5c3afdeb/comments", "author": {"login": "jam1garner", "id": 8260240, "node_id": "MDQ6VXNlcjgyNjAyNDA=", "avatar_url": "https://avatars.githubusercontent.com/u/8260240?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jam1garner", "html_url": "https://github.com/jam1garner", "followers_url": "https://api.github.com/users/jam1garner/followers", "following_url": "https://api.github.com/users/jam1garner/following{/other_user}", "gists_url": "https://api.github.com/users/jam1garner/gists{/gist_id}", "starred_url": "https://api.github.com/users/jam1garner/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jam1garner/subscriptions", "organizations_url": "https://api.github.com/users/jam1garner/orgs", "repos_url": "https://api.github.com/users/jam1garner/repos", "events_url": "https://api.github.com/users/jam1garner/events{/privacy}", "received_events_url": "https://api.github.com/users/jam1garner/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jam1garner", "id": 8260240, "node_id": "MDQ6VXNlcjgyNjAyNDA=", "avatar_url": "https://avatars.githubusercontent.com/u/8260240?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jam1garner", "html_url": "https://github.com/jam1garner", "followers_url": "https://api.github.com/users/jam1garner/followers", "following_url": "https://api.github.com/users/jam1garner/following{/other_user}", "gists_url": "https://api.github.com/users/jam1garner/gists{/gist_id}", "starred_url": "https://api.github.com/users/jam1garner/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jam1garner/subscriptions", "organizations_url": "https://api.github.com/users/jam1garner/orgs", "repos_url": "https://api.github.com/users/jam1garner/repos", "events_url": "https://api.github.com/users/jam1garner/events{/privacy}", "received_events_url": "https://api.github.com/users/jam1garner/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "03314912f1361af6b39383958b5aa1b4aed61c26", "url": "https://api.github.com/repos/rust-lang/rust/commits/03314912f1361af6b39383958b5aa1b4aed61c26", "html_url": "https://github.com/rust-lang/rust/commit/03314912f1361af6b39383958b5aa1b4aed61c26"}], "stats": {"total": 40, "additions": 39, "deletions": 1}, "files": [{"sha": "30db0cec0804a99f80cd726a37dada8b37be98f0", "filename": "compiler/rustc_passes/src/naked_functions.rs", "status": "modified", "additions": 14, "deletions": 1, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/b657cb5577d373c4c926c4a555520d0f5c3afdeb/compiler%2Frustc_passes%2Fsrc%2Fnaked_functions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b657cb5577d373c4c926c4a555520d0f5c3afdeb/compiler%2Frustc_passes%2Fsrc%2Fnaked_functions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fnaked_functions.rs?ref=b657cb5577d373c4c926c4a555520d0f5c3afdeb", "patch": "@@ -1,7 +1,7 @@\n //! Checks validity of naked functions.\n \n use rustc_ast::{Attribute, InlineAsmOptions};\n-use rustc_errors::struct_span_err;\n+use rustc_errors::{struct_span_err, Applicability};\n use rustc_hir as hir;\n use rustc_hir::def_id::LocalDefId;\n use rustc_hir::intravisit::{FnKind, Visitor};\n@@ -274,12 +274,25 @@ impl<'tcx> CheckInlineAssembly<'tcx> {\n         }\n \n         if !asm.options.contains(InlineAsmOptions::NORETURN) {\n+            let last_span = asm\n+                .operands\n+                .last()\n+                .map_or_else(|| asm.template_strs.last().unwrap().2, |op| op.1)\n+                .shrink_to_hi();\n+\n             struct_span_err!(\n                 self.tcx.sess,\n                 span,\n                 E0787,\n                 \"asm in naked functions must use `noreturn` option\"\n             )\n+            .span_suggestion(\n+                last_span,\n+                \"consider specifying that the asm block is responsible \\\n+                for returning, if desired\",\n+                String::from(\", options(noreturn)\"),\n+                Applicability::MachineApplicable,\n+            )\n             .emit();\n         }\n     }"}, {"sha": "edaecb78b2c5665aca9f392fb46882b83facda18", "filename": "src/test/ui/asm/naked-functions.stderr", "status": "modified", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/b657cb5577d373c4c926c4a555520d0f5c3afdeb/src%2Ftest%2Fui%2Fasm%2Fnaked-functions.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/b657cb5577d373c4c926c4a555520d0f5c3afdeb/src%2Ftest%2Fui%2Fasm%2Fnaked-functions.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasm%2Fnaked-functions.stderr?ref=b657cb5577d373c4c926c4a555520d0f5c3afdeb", "patch": "@@ -97,6 +97,11 @@ LL | |\n LL | |          sym G,\n LL | |     );\n    | |_____^\n+   |\n+help: consider specifying that the asm block is responsible for returning, if desired\n+   |\n+LL |          sym G, options(noreturn),\n+   |               +++++++++++++++++++\n \n error[E0787]: naked functions must contain a single asm block\n   --> $DIR/naked-functions.rs:53:1\n@@ -131,18 +136,33 @@ error[E0787]: asm in naked functions must use `noreturn` option\n    |\n LL |     asm!(\"\");\n    |     ^^^^^^^^\n+   |\n+help: consider specifying that the asm block is responsible for returning, if desired\n+   |\n+LL |     asm!(\"\", options(noreturn));\n+   |            +++++++++++++++++++\n \n error[E0787]: asm in naked functions must use `noreturn` option\n   --> $DIR/naked-functions.rs:85:5\n    |\n LL |     asm!(\"\");\n    |     ^^^^^^^^\n+   |\n+help: consider specifying that the asm block is responsible for returning, if desired\n+   |\n+LL |     asm!(\"\", options(noreturn));\n+   |            +++++++++++++++++++\n \n error[E0787]: asm in naked functions must use `noreturn` option\n   --> $DIR/naked-functions.rs:87:5\n    |\n LL |     asm!(\"\");\n    |     ^^^^^^^^\n+   |\n+help: consider specifying that the asm block is responsible for returning, if desired\n+   |\n+LL |     asm!(\"\", options(noreturn));\n+   |            +++++++++++++++++++\n \n error[E0787]: naked functions must contain a single asm block\n   --> $DIR/naked-functions.rs:81:1\n@@ -198,6 +218,11 @@ error[E0787]: asm in naked functions must use `noreturn` option\n    |\n LL |     asm!(\"\", options(readonly, nostack), options(pure));\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+help: consider specifying that the asm block is responsible for returning, if desired\n+   |\n+LL |     asm!(\"\", options(noreturn), options(readonly, nostack), options(pure));\n+   |            +++++++++++++++++++\n \n error[E0787]: asm options unsupported in naked functions: `may_unwind`\n   --> $DIR/naked-functions.rs:118:5"}]}