{"sha": "b2c9872c6c2c60c905e16bce0801934b86d15f95", "node_id": "C_kwDOAAsO6NoAKGIyYzk4NzJjNmMyYzYwYzkwNWUxNmJjZTA4MDE5MzRiODZkMTVmOTU", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-05-26T22:01:19Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-05-26T22:01:19Z"}, "message": "Auto merge of #97386 - nnethercote:optimize-pos-adjustments, r=bjorn3\n\nOptimize position adjustments\n\nA small improvement.\n\nr? `@bjorn3`", "tree": {"sha": "c29272719da002fb98d1e03d5564e09c0286a716", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c29272719da002fb98d1e03d5564e09c0286a716"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b2c9872c6c2c60c905e16bce0801934b86d15f95", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b2c9872c6c2c60c905e16bce0801934b86d15f95", "html_url": "https://github.com/rust-lang/rust/commit/b2c9872c6c2c60c905e16bce0801934b86d15f95", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b2c9872c6c2c60c905e16bce0801934b86d15f95/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "490324f7b29d5f1a1e063a563045d790091ed639", "url": "https://api.github.com/repos/rust-lang/rust/commits/490324f7b29d5f1a1e063a563045d790091ed639", "html_url": "https://github.com/rust-lang/rust/commit/490324f7b29d5f1a1e063a563045d790091ed639"}, {"sha": "2b91c40c19e51b694ec113fd6991cf59959d4046", "url": "https://api.github.com/repos/rust-lang/rust/commits/2b91c40c19e51b694ec113fd6991cf59959d4046", "html_url": "https://github.com/rust-lang/rust/commit/2b91c40c19e51b694ec113fd6991cf59959d4046"}], "stats": {"total": 51, "additions": 21, "deletions": 30}, "files": [{"sha": "621580793ebe88d51633f104a75a7a7e728ebc17", "filename": "compiler/rustc_metadata/src/rmeta/decoder.rs", "status": "modified", "additions": 4, "deletions": 22, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/b2c9872c6c2c60c905e16bce0801934b86d15f95/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fdecoder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b2c9872c6c2c60c905e16bce0801934b86d15f95/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fdecoder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fdecoder.rs?ref=b2c9872c6c2c60c905e16bce0801934b86d15f95", "patch": "@@ -1565,10 +1565,10 @@ impl<'a, 'tcx> CrateMetadataRef<'a> {\n                         src_hash,\n                         start_pos,\n                         end_pos,\n-                        mut lines,\n-                        mut multibyte_chars,\n-                        mut non_narrow_chars,\n-                        mut normalized_pos,\n+                        lines,\n+                        multibyte_chars,\n+                        non_narrow_chars,\n+                        normalized_pos,\n                         name_hash,\n                         ..\n                     } = source_file_to_import;\n@@ -1605,24 +1605,6 @@ impl<'a, 'tcx> CrateMetadataRef<'a> {\n \n                     let source_length = (end_pos - start_pos).to_usize();\n \n-                    // Translate line-start positions and multibyte character\n-                    // position into frame of reference local to file.\n-                    // `SourceMap::new_imported_source_file()` will then translate those\n-                    // coordinates to their new global frame of reference when the\n-                    // offset of the SourceFile is known.\n-                    for pos in &mut lines {\n-                        *pos = *pos - start_pos;\n-                    }\n-                    for mbc in &mut multibyte_chars {\n-                        mbc.pos = mbc.pos - start_pos;\n-                    }\n-                    for swc in &mut non_narrow_chars {\n-                        *swc = *swc - start_pos;\n-                    }\n-                    for np in &mut normalized_pos {\n-                        np.pos = np.pos - start_pos;\n-                    }\n-\n                     let local_version = sess.source_map().new_imported_source_file(\n                         name,\n                         src_hash,"}, {"sha": "f44eac63cef10a2e7460c0a93008adaf8404941c", "filename": "compiler/rustc_span/src/lib.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/b2c9872c6c2c60c905e16bce0801934b86d15f95/compiler%2Frustc_span%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b2c9872c6c2c60c905e16bce0801934b86d15f95/compiler%2Frustc_span%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_span%2Fsrc%2Flib.rs?ref=b2c9872c6c2c60c905e16bce0801934b86d15f95", "patch": "@@ -1270,7 +1270,9 @@ impl<S: Encoder> Encodable<S> for SourceFile {\n                     // the lines list is sorted and individual lines are\n                     // probably not that long. Because of that we can store lines\n                     // as a difference list, using as little space as possible\n-                    // for the differences.\n+                    // for the differences. But note that the first line is\n+                    // always encoded as a `BytePos` because its position is\n+                    // often much larger than any of the differences.\n                     let max_line_length = if lines.len() == 1 {\n                         0\n                     } else {"}, {"sha": "d60b4d3d021e840de82b8d61dbaaace52426511d", "filename": "compiler/rustc_span/src/source_map.rs", "status": "modified", "additions": 14, "deletions": 7, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/b2c9872c6c2c60c905e16bce0801934b86d15f95/compiler%2Frustc_span%2Fsrc%2Fsource_map.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b2c9872c6c2c60c905e16bce0801934b86d15f95/compiler%2Frustc_span%2Fsrc%2Fsource_map.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_span%2Fsrc%2Fsource_map.rs?ref=b2c9872c6c2c60c905e16bce0801934b86d15f95", "patch": "@@ -345,20 +345,27 @@ impl SourceMap {\n         let end_pos = Pos::from_usize(start_pos + source_len);\n         let start_pos = Pos::from_usize(start_pos);\n \n+        // Translate these positions into the new global frame of reference,\n+        // now that the offset of the SourceFile is known.\n+        //\n+        // These are all unsigned values. `original_start_pos` may be larger or\n+        // smaller than `start_pos`, but `pos` is always larger than both.\n+        // Therefore, `(pos - original_start_pos) + start_pos` won't overflow\n+        // but `start_pos - original_start_pos` might. So we use the former\n+        // form rather than pre-computing the offset into a local variable. The\n+        // compiler backend can optimize away the repeated computations in a\n+        // way that won't trigger overflow checks.\n         for pos in &mut file_local_lines {\n-            *pos = *pos + start_pos;\n+            *pos = (*pos - original_start_pos) + start_pos;\n         }\n-\n         for mbc in &mut file_local_multibyte_chars {\n-            mbc.pos = mbc.pos + start_pos;\n+            mbc.pos = (mbc.pos - original_start_pos) + start_pos;\n         }\n-\n         for swc in &mut file_local_non_narrow_chars {\n-            *swc = *swc + start_pos;\n+            *swc = (*swc - original_start_pos) + start_pos;\n         }\n-\n         for nc in &mut file_local_normalized_pos {\n-            nc.pos = nc.pos + start_pos;\n+            nc.pos = (nc.pos - original_start_pos) + start_pos;\n         }\n \n         let source_file = Lrc::new(SourceFile {"}]}