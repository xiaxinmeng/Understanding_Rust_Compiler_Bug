{"sha": "57c98d3392405705e17cc87dee350c16aeb24b4f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU3Yzk4ZDMzOTI0MDU3MDVlMTdjYzg3ZGVlMzUwYzE2YWViMjRiNGY=", "commit": {"author": {"name": "Wesley Wiser", "email": "wwiser@gmail.com", "date": "2019-07-03T00:50:27Z"}, "committer": {"name": "Wesley Wiser", "email": "wwiser@gmail.com", "date": "2019-07-03T00:52:58Z"}, "message": "Add a query to get the `promoted`s for a `mir::Body`\n\nThis is a builidng block toward removing a lot of duplicated code\nbetween miri and the cosnt-propagator pass.\n\nSee this thread for more info:\nhttps://rust-lang.zulipchat.com/#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/Using.20.60InterpCx.60.20more/near/169030661", "tree": {"sha": "23db80061066a53e44a94ba52c48b5095b835ae3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/23db80061066a53e44a94ba52c48b5095b835ae3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/57c98d3392405705e17cc87dee350c16aeb24b4f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/57c98d3392405705e17cc87dee350c16aeb24b4f", "html_url": "https://github.com/rust-lang/rust/commit/57c98d3392405705e17cc87dee350c16aeb24b4f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/57c98d3392405705e17cc87dee350c16aeb24b4f/comments", "author": {"login": "wesleywiser", "id": 831192, "node_id": "MDQ6VXNlcjgzMTE5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/831192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wesleywiser", "html_url": "https://github.com/wesleywiser", "followers_url": "https://api.github.com/users/wesleywiser/followers", "following_url": "https://api.github.com/users/wesleywiser/following{/other_user}", "gists_url": "https://api.github.com/users/wesleywiser/gists{/gist_id}", "starred_url": "https://api.github.com/users/wesleywiser/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wesleywiser/subscriptions", "organizations_url": "https://api.github.com/users/wesleywiser/orgs", "repos_url": "https://api.github.com/users/wesleywiser/repos", "events_url": "https://api.github.com/users/wesleywiser/events{/privacy}", "received_events_url": "https://api.github.com/users/wesleywiser/received_events", "type": "User", "site_admin": false}, "committer": {"login": "wesleywiser", "id": 831192, "node_id": "MDQ6VXNlcjgzMTE5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/831192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wesleywiser", "html_url": "https://github.com/wesleywiser", "followers_url": "https://api.github.com/users/wesleywiser/followers", "following_url": "https://api.github.com/users/wesleywiser/following{/other_user}", "gists_url": "https://api.github.com/users/wesleywiser/gists{/gist_id}", "starred_url": "https://api.github.com/users/wesleywiser/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wesleywiser/subscriptions", "organizations_url": "https://api.github.com/users/wesleywiser/orgs", "repos_url": "https://api.github.com/users/wesleywiser/repos", "events_url": "https://api.github.com/users/wesleywiser/events{/privacy}", "received_events_url": "https://api.github.com/users/wesleywiser/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0beb2ba16a08dfa01569b5f4644da315dc4c806c", "url": "https://api.github.com/repos/rust-lang/rust/commits/0beb2ba16a08dfa01569b5f4644da315dc4c806c", "html_url": "https://github.com/rust-lang/rust/commit/0beb2ba16a08dfa01569b5f4644da315dc4c806c"}], "stats": {"total": 13, "additions": 11, "deletions": 2}, "files": [{"sha": "70b79c5a6cadca9410d7516660c8d0a7a152c322", "filename": "src/librustc/query/mod.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/57c98d3392405705e17cc87dee350c16aeb24b4f/src%2Flibrustc%2Fquery%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/57c98d3392405705e17cc87dee350c16aeb24b4f/src%2Flibrustc%2Fquery%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fquery%2Fmod.rs?ref=57c98d3392405705e17cc87dee350c16aeb24b4f", "patch": "@@ -124,6 +124,8 @@ rustc_queries! {\n                 mir.map(|x| &*tcx.arena.alloc(x))\n             }\n         }\n+\n+        query promoted_mir(key: DefId) -> &'tcx IndexVec<mir::Promoted, mir::Body<'tcx>> { }\n     }\n \n     TypeChecking {"}, {"sha": "b2955c61097cb5d7c2a4f9c18c1ce2bfb9fc4f3d", "filename": "src/librustc_mir/const_eval.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/57c98d3392405705e17cc87dee350c16aeb24b4f/src%2Flibrustc_mir%2Fconst_eval.rs", "raw_url": "https://github.com/rust-lang/rust/raw/57c98d3392405705e17cc87dee350c16aeb24b4f/src%2Flibrustc_mir%2Fconst_eval.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fconst_eval.rs?ref=57c98d3392405705e17cc87dee350c16aeb24b4f", "patch": "@@ -681,7 +681,7 @@ pub fn const_eval_raw_provider<'tcx>(\n                 // promoting runtime code is only allowed to error if it references broken constants\n                 // any other kind of error will be reported to the user as a deny-by-default lint\n                 _ => if let Some(p) = cid.promoted {\n-                    let span = tcx.optimized_mir(def_id).promoted[p].span;\n+                    let span = tcx.promoted_mir(def_id)[p].span;\n                     if let InterpError::ReferencedConstant = err.error {\n                         err.report_as_error(\n                             tcx.at(span),"}, {"sha": "4313c75342f0b63164d2ccaca6a3da551a35f5c0", "filename": "src/librustc_mir/transform/mod.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/57c98d3392405705e17cc87dee350c16aeb24b4f/src%2Flibrustc_mir%2Ftransform%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/57c98d3392405705e17cc87dee350c16aeb24b4f/src%2Flibrustc_mir%2Ftransform%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fmod.rs?ref=57c98d3392405705e17cc87dee350c16aeb24b4f", "patch": "@@ -1,4 +1,5 @@\n use crate::{build, shim};\n+use rustc_data_structures::indexed_vec::IndexVec;\n use rustc::hir::def_id::{CrateNum, DefId, LOCAL_CRATE};\n use rustc::mir::{Body, MirPhase, Promoted};\n use rustc::ty::{TyCtxt, InstanceDef};\n@@ -46,6 +47,7 @@ pub(crate) fn provide(providers: &mut Providers<'_>) {\n         mir_validated,\n         optimized_mir,\n         is_mir_available,\n+        promoted_mir,\n         ..*providers\n     };\n }\n@@ -296,3 +298,8 @@ fn optimized_mir<'tcx>(tcx: TyCtxt<'tcx>, def_id: DefId) -> &'tcx Body<'tcx> {\n     ]);\n     tcx.arena.alloc(body)\n }\n+\n+fn promoted_mir<'tcx>(tcx: TyCtxt<'tcx>, def_id: DefId) -> &'tcx IndexVec<Promoted, Body<'tcx>> {\n+    let body = tcx.optimized_mir(def_id);\n+    &body.promoted\n+}"}, {"sha": "68880fc345ae23e47de7b9b0c709f47be772a6bf", "filename": "src/librustc_mir/util/pretty.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/57c98d3392405705e17cc87dee350c16aeb24b4f/src%2Flibrustc_mir%2Futil%2Fpretty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/57c98d3392405705e17cc87dee350c16aeb24b4f/src%2Flibrustc_mir%2Futil%2Fpretty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Futil%2Fpretty.rs?ref=57c98d3392405705e17cc87dee350c16aeb24b4f", "patch": "@@ -263,7 +263,7 @@ pub fn write_mir_pretty<'tcx>(\n \n         write_mir_fn(tcx, MirSource::item(def_id), body, &mut |_, _| Ok(()), w)?;\n \n-        for (i, body) in body.promoted.iter_enumerated() {\n+        for (i, body) in tcx.promoted_mir(def_id).iter_enumerated() {\n             writeln!(w, \"\")?;\n             let src = MirSource {\n                 instance: ty::InstanceDef::Item(def_id),"}]}