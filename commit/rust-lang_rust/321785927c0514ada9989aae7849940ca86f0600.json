{"sha": "321785927c0514ada9989aae7849940ca86f0600", "node_id": "MDY6Q29tbWl0NzI0NzEyOjMyMTc4NTkyN2MwNTE0YWRhOTk4OWFhZTc4NDk5NDBjYTg2ZjA2MDA=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-09-23T17:05:39Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-09-23T17:05:39Z"}, "message": "auto merge of #17413 : jakub-/rust/issue-17385, r=pcwalton\n\nThis is to make sure it hadn't been moved if there are no bindings\r\nin any of the arms.\r\n\r\nFixes #17385.", "tree": {"sha": "f16be6304cb4b8f1b156c25cb88010599a6c55e9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f16be6304cb4b8f1b156c25cb88010599a6c55e9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/321785927c0514ada9989aae7849940ca86f0600", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/321785927c0514ada9989aae7849940ca86f0600", "html_url": "https://github.com/rust-lang/rust/commit/321785927c0514ada9989aae7849940ca86f0600", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/321785927c0514ada9989aae7849940ca86f0600/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d80cd3d9bc46c326b67fe48497c9ae7b322179ba", "url": "https://api.github.com/repos/rust-lang/rust/commits/d80cd3d9bc46c326b67fe48497c9ae7b322179ba", "html_url": "https://github.com/rust-lang/rust/commit/d80cd3d9bc46c326b67fe48497c9ae7b322179ba"}, {"sha": "7b08827f2ddef8e80c176baa8d9f12561a06f1ee", "url": "https://api.github.com/repos/rust-lang/rust/commits/7b08827f2ddef8e80c176baa8d9f12561a06f1ee", "html_url": "https://github.com/rust-lang/rust/commit/7b08827f2ddef8e80c176baa8d9f12561a06f1ee"}], "stats": {"total": 57, "additions": 50, "deletions": 7}, "files": [{"sha": "e9be87758f95c1ebd88a3064bba09719b4d3b501", "filename": "src/librustc/middle/borrowck/check_loans.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/321785927c0514ada9989aae7849940ca86f0600/src%2Flibrustc%2Fmiddle%2Fborrowck%2Fcheck_loans.rs", "raw_url": "https://github.com/rust-lang/rust/raw/321785927c0514ada9989aae7849940ca86f0600/src%2Flibrustc%2Fmiddle%2Fborrowck%2Fcheck_loans.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fborrowck%2Fcheck_loans.rs?ref=321785927c0514ada9989aae7849940ca86f0600", "patch": "@@ -494,7 +494,8 @@ impl<'a, 'tcx> CheckLoanCtxt<'a, 'tcx> {\n                 euv::AutoRef(..) |\n                 euv::ClosureInvocation(..) |\n                 euv::ForLoop(..) |\n-                euv::RefBinding(..) => {\n+                euv::RefBinding(..) |\n+                euv::MatchDiscriminant(..) => {\n                     format!(\"previous borrow of `{}` occurs here\",\n                             self.bccx.loan_path_to_string(&*old_loan.loan_path))\n                 }"}, {"sha": "7d734323ee829b9ba187a0e9e103f5b704be033c", "filename": "src/librustc/middle/borrowck/mod.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/321785927c0514ada9989aae7849940ca86f0600/src%2Flibrustc%2Fmiddle%2Fborrowck%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/321785927c0514ada9989aae7849940ca86f0600/src%2Flibrustc%2Fmiddle%2Fborrowck%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fborrowck%2Fmod.rs?ref=321785927c0514ada9989aae7849940ca86f0600", "patch": "@@ -648,7 +648,8 @@ impl<'a, 'tcx> BorrowckCtxt<'a, 'tcx> {\n                     euv::AddrOf |\n                     euv::RefBinding |\n                     euv::AutoRef |\n-                    euv::ForLoop => {\n+                    euv::ForLoop |\n+                    euv::MatchDiscriminant => {\n                         format!(\"cannot borrow {} as mutable\", descr)\n                     }\n                     euv::ClosureInvocation => {\n@@ -702,7 +703,8 @@ impl<'a, 'tcx> BorrowckCtxt<'a, 'tcx> {\n             BorrowViolation(euv::OverloadedOperator) |\n             BorrowViolation(euv::AddrOf) |\n             BorrowViolation(euv::AutoRef) |\n-            BorrowViolation(euv::RefBinding) => {\n+            BorrowViolation(euv::RefBinding) |\n+            BorrowViolation(euv::MatchDiscriminant) => {\n                 \"cannot borrow data mutably\"\n             }\n "}, {"sha": "81994ee64a8cf956f19400754533c49c059f5423", "filename": "src/librustc/middle/expr_use_visitor.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/321785927c0514ada9989aae7849940ca86f0600/src%2Flibrustc%2Fmiddle%2Fexpr_use_visitor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/321785927c0514ada9989aae7849940ca86f0600/src%2Flibrustc%2Fmiddle%2Fexpr_use_visitor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fexpr_use_visitor.rs?ref=321785927c0514ada9989aae7849940ca86f0600", "patch": "@@ -82,6 +82,7 @@ pub enum LoanCause {\n     OverloadedOperator,\n     ClosureInvocation,\n     ForLoop,\n+    MatchDiscriminant\n }\n \n #[deriving(PartialEq,Show)]\n@@ -374,10 +375,10 @@ impl<'d,'t,'tcx,TYPER:mc::Typer<'tcx>> ExprUseVisitor<'d,'t,TYPER> {\n             }\n \n             ast::ExprMatch(ref discr, ref arms) => {\n-                // treatment of the discriminant is handled while\n-                // walking the arms:\n-                self.walk_expr(&**discr);\n                 let discr_cmt = return_if_err!(self.mc.cat_expr(&**discr));\n+                self.borrow_expr(&**discr, ty::ReEmpty, ty::ImmBorrow, MatchDiscriminant);\n+\n+                // treatment of the discriminant is handled while walking the arms.\n                 for arm in arms.iter() {\n                     self.walk_arm(discr_cmt.clone(), arm);\n                 }"}, {"sha": "469cdad076da27f99acbe01e59343624c0ceeffd", "filename": "src/librustc/middle/ty.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/321785927c0514ada9989aae7849940ca86f0600/src%2Flibrustc%2Fmiddle%2Fty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/321785927c0514ada9989aae7849940ca86f0600/src%2Flibrustc%2Fmiddle%2Fty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fty.rs?ref=321785927c0514ada9989aae7849940ca86f0600", "patch": "@@ -3308,7 +3308,7 @@ pub fn ty_region(tcx: &ctxt,\n         ref s => {\n             tcx.sess.span_bug(\n                 span,\n-                format!(\"ty_region() invoked on in appropriate ty: {:?}\",\n+                format!(\"ty_region() invoked on an inappropriate ty: {:?}\",\n                         s).as_slice());\n         }\n     }"}, {"sha": "227ed3fb83420d059057916a3ff82d7f0c77be38", "filename": "src/test/compile-fail/issue-13359.rs", "status": "renamed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/321785927c0514ada9989aae7849940ca86f0600/src%2Ftest%2Fcompile-fail%2Fissue-13359.rs", "raw_url": "https://github.com/rust-lang/rust/raw/321785927c0514ada9989aae7849940ca86f0600/src%2Ftest%2Fcompile-fail%2Fissue-13359.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fissue-13359.rs?ref=321785927c0514ada9989aae7849940ca86f0600", "previous_filename": "src/test/compile-fail/issue13359.rs"}, {"sha": "bc1495ac454322d1a0c108ff8977a53d5cefe9e1", "filename": "src/test/compile-fail/issue-17385.rs", "status": "added", "additions": 39, "deletions": 0, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/321785927c0514ada9989aae7849940ca86f0600/src%2Ftest%2Fcompile-fail%2Fissue-17385.rs", "raw_url": "https://github.com/rust-lang/rust/raw/321785927c0514ada9989aae7849940ca86f0600/src%2Ftest%2Fcompile-fail%2Fissue-17385.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fissue-17385.rs?ref=321785927c0514ada9989aae7849940ca86f0600", "patch": "@@ -0,0 +1,39 @@\n+// Copyright 2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+struct X(int);\n+\n+enum Enum {\n+    Variant1,\n+    Variant2\n+}\n+\n+impl Drop for X {\n+    fn drop(&mut self) {}\n+}\n+impl Drop for Enum {\n+    fn drop(&mut self) {}\n+}\n+\n+fn main() {\n+    let foo = X(1i);\n+    drop(foo);\n+    match foo { //~ ERROR use of moved value\n+        X(1i) => (),\n+        _ => unreachable!()\n+    }\n+\n+    let e = Variant2;\n+    drop(e);\n+    match e { //~ ERROR use of moved value\n+        Variant1 => unreachable!(),\n+        Variant2 => ()\n+    }\n+}"}]}