{"sha": "8d296be1090b21b60e509c831864ae85feec2490", "node_id": "MDY6Q29tbWl0NzI0NzEyOjhkMjk2YmUxMDkwYjIxYjYwZTUwOWM4MzE4NjRhZTg1ZmVlYzI0OTA=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-04-16T20:36:19Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-04-16T20:36:19Z"}, "message": "Merge #3995\n\n3995: Separate project discovery from project loading r=matklad a=matklad\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>", "tree": {"sha": "722e65f7ba7f3a010cfc88982c91b3495ccb4a57", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/722e65f7ba7f3a010cfc88982c91b3495ccb4a57"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8d296be1090b21b60e509c831864ae85feec2490", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJemMHDCRBK7hj4Ov3rIwAAdHIIAF1lk4+B/gGDr/lUhiWm/bjj\n9Nk3VF1FJrtZnejLrL+ZHHQK5EJZR6Vt7rVFh+vJp8f0hmOL/7CNdMzU7LUvvTJK\n7vVD198pLwNIIyqTBxEjYkn8zeNovSNDyvvSy5ZG/eyUL8iNEveG6UxPBsIPxJ3s\nte1pG3LQ2YcRnKJSRbeddr9pk1tHOmCj2MreITZAAUum4rs+lTwyFqT7fM7/melE\nnsXGcGZmMkRRzCVT8VX1Qxeu1i/y8gCCrVx46ZzEDCiuenBhVIWzAMpNZnYNr5ia\nF0I+fa5qak0UlLXWO3+KI0vEuoBEQ7lNjLy2aNnZOKK8rS9j1d/FIEQZSHx3KIg=\n=PXew\n-----END PGP SIGNATURE-----\n", "payload": "tree 722e65f7ba7f3a010cfc88982c91b3495ccb4a57\nparent 10d8cb913cb8247ae64b954cf07460f1b6d96ef7\nparent 422ae477ce2a52c8d004ce629318f0b7c1d89638\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1587069379 +0000\ncommitter GitHub <noreply@github.com> 1587069379 +0000\n\nMerge #3995\n\n3995: Separate project discovery from project loading r=matklad a=matklad\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8d296be1090b21b60e509c831864ae85feec2490", "html_url": "https://github.com/rust-lang/rust/commit/8d296be1090b21b60e509c831864ae85feec2490", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8d296be1090b21b60e509c831864ae85feec2490/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "10d8cb913cb8247ae64b954cf07460f1b6d96ef7", "url": "https://api.github.com/repos/rust-lang/rust/commits/10d8cb913cb8247ae64b954cf07460f1b6d96ef7", "html_url": "https://github.com/rust-lang/rust/commit/10d8cb913cb8247ae64b954cf07460f1b6d96ef7"}, {"sha": "422ae477ce2a52c8d004ce629318f0b7c1d89638", "url": "https://api.github.com/repos/rust-lang/rust/commits/422ae477ce2a52c8d004ce629318f0b7c1d89638", "html_url": "https://github.com/rust-lang/rust/commit/422ae477ce2a52c8d004ce629318f0b7c1d89638"}], "stats": {"total": 299, "additions": 150, "deletions": 149}, "files": [{"sha": "03f2629dae0c76f970e503d92b0bd544d28e449e", "filename": "crates/ra_project_model/src/lib.rs", "status": "modified", "additions": 110, "deletions": 121, "changes": 231, "blob_url": "https://github.com/rust-lang/rust/blob/8d296be1090b21b60e509c831864ae85feec2490/crates%2Fra_project_model%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8d296be1090b21b60e509c831864ae85feec2490/crates%2Fra_project_model%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_project_model%2Fsrc%2Flib.rs?ref=8d296be1090b21b60e509c831864ae85feec2490", "patch": "@@ -5,9 +5,8 @@ mod json_project;\n mod sysroot;\n \n use std::{\n-    error::Error,\n     fs::{read_dir, File, ReadDir},\n-    io::BufReader,\n+    io::{self, BufReader},\n     path::{Path, PathBuf},\n     process::Command,\n };\n@@ -25,25 +24,6 @@ pub use crate::{\n };\n pub use ra_proc_macro::ProcMacroClient;\n \n-#[derive(Clone, PartialEq, Eq, Hash, Debug)]\n-pub struct CargoTomlNotFoundError {\n-    pub searched_at: PathBuf,\n-    pub reason: String,\n-}\n-\n-impl std::fmt::Display for CargoTomlNotFoundError {\n-    fn fmt(&self, fmt: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {\n-        write!(\n-            fmt,\n-            \"can't find Cargo.toml at {}, due to {}\",\n-            self.searched_at.display(),\n-            self.reason\n-        )\n-    }\n-}\n-\n-impl Error for CargoTomlNotFoundError {}\n-\n #[derive(Debug, Clone)]\n pub enum ProjectWorkspace {\n     /// Project workspace was discovered by running `cargo metadata` and `rustc --print sysroot`.\n@@ -77,31 +57,119 @@ impl PackageRoot {\n     }\n }\n \n-impl ProjectWorkspace {\n-    pub fn discover(path: &Path, cargo_features: &CargoConfig) -> Result<ProjectWorkspace> {\n-        ProjectWorkspace::discover_with_sysroot(path, true, cargo_features)\n+#[derive(Debug, Clone, PartialEq, Eq, Hash)]\n+pub enum ProjectRoot {\n+    ProjectJson(PathBuf),\n+    CargoToml(PathBuf),\n+}\n+\n+impl ProjectRoot {\n+    pub fn from_manifest_file(path: PathBuf) -> Result<ProjectRoot> {\n+        if path.ends_with(\"rust-project.json\") {\n+            return Ok(ProjectRoot::ProjectJson(path));\n+        }\n+        if path.ends_with(\"Cargo.toml\") {\n+            return Ok(ProjectRoot::CargoToml(path));\n+        }\n+        bail!(\"project root must point to Cargo.toml or rust-project.json: {}\", path.display())\n     }\n \n-    pub fn discover_with_sysroot(\n-        path: &Path,\n-        with_sysroot: bool,\n+    pub fn discover_single(path: &Path) -> Result<ProjectRoot> {\n+        let mut candidates = ProjectRoot::discover(path)?;\n+        let res = match candidates.pop() {\n+            None => bail!(\"no projects\"),\n+            Some(it) => it,\n+        };\n+\n+        if !candidates.is_empty() {\n+            bail!(\"more than one project\")\n+        }\n+        Ok(res)\n+    }\n+\n+    pub fn discover(path: &Path) -> io::Result<Vec<ProjectRoot>> {\n+        if let Some(project_json) = find_rust_project_json(path) {\n+            return Ok(vec![ProjectRoot::ProjectJson(project_json)]);\n+        }\n+        return find_cargo_toml(path)\n+            .map(|paths| paths.into_iter().map(ProjectRoot::CargoToml).collect());\n+\n+        fn find_rust_project_json(path: &Path) -> Option<PathBuf> {\n+            if path.ends_with(\"rust-project.json\") {\n+                return Some(path.to_path_buf());\n+            }\n+\n+            let mut curr = Some(path);\n+            while let Some(path) = curr {\n+                let candidate = path.join(\"rust-project.json\");\n+                if candidate.exists() {\n+                    return Some(candidate);\n+                }\n+                curr = path.parent();\n+            }\n+\n+            None\n+        }\n+\n+        fn find_cargo_toml(path: &Path) -> io::Result<Vec<PathBuf>> {\n+            if path.ends_with(\"Cargo.toml\") {\n+                return Ok(vec![path.to_path_buf()]);\n+            }\n+\n+            if let Some(p) = find_cargo_toml_in_parent_dir(path) {\n+                return Ok(vec![p]);\n+            }\n+\n+            let entities = read_dir(path)?;\n+            Ok(find_cargo_toml_in_child_dir(entities))\n+        }\n+\n+        fn find_cargo_toml_in_parent_dir(path: &Path) -> Option<PathBuf> {\n+            let mut curr = Some(path);\n+            while let Some(path) = curr {\n+                let candidate = path.join(\"Cargo.toml\");\n+                if candidate.exists() {\n+                    return Some(candidate);\n+                }\n+                curr = path.parent();\n+            }\n+\n+            None\n+        }\n+\n+        fn find_cargo_toml_in_child_dir(entities: ReadDir) -> Vec<PathBuf> {\n+            // Only one level down to avoid cycles the easy way and stop a runaway scan with large projects\n+            let mut valid_canditates = vec![];\n+            for entity in entities.filter_map(Result::ok) {\n+                let candidate = entity.path().join(\"Cargo.toml\");\n+                if candidate.exists() {\n+                    valid_canditates.push(candidate)\n+                }\n+            }\n+            valid_canditates\n+        }\n+    }\n+}\n+\n+impl ProjectWorkspace {\n+    pub fn load(\n+        root: ProjectRoot,\n         cargo_features: &CargoConfig,\n+        with_sysroot: bool,\n     ) -> Result<ProjectWorkspace> {\n-        match find_rust_project_json(path) {\n-            Some(json_path) => {\n-                let file = File::open(&json_path)\n-                    .with_context(|| format!(\"Failed to open json file {}\", json_path.display()))?;\n+        let res = match root {\n+            ProjectRoot::ProjectJson(project_json) => {\n+                let file = File::open(&project_json).with_context(|| {\n+                    format!(\"Failed to open json file {}\", project_json.display())\n+                })?;\n                 let reader = BufReader::new(file);\n-                Ok(ProjectWorkspace::Json {\n+                ProjectWorkspace::Json {\n                     project: from_reader(reader).with_context(|| {\n-                        format!(\"Failed to deserialize json file {}\", json_path.display())\n+                        format!(\"Failed to deserialize json file {}\", project_json.display())\n                     })?,\n-                })\n+                }\n             }\n-            None => {\n-                let cargo_toml = find_cargo_toml(path).with_context(|| {\n-                    format!(\"Failed to find Cargo.toml for path {}\", path.display())\n-                })?;\n+            ProjectRoot::CargoToml(cargo_toml) => {\n                 let cargo = CargoWorkspace::from_cargo_metadata(&cargo_toml, cargo_features)\n                     .with_context(|| {\n                         format!(\n@@ -119,9 +187,11 @@ impl ProjectWorkspace {\n                 } else {\n                     Sysroot::default()\n                 };\n-                Ok(ProjectWorkspace::Cargo { cargo, sysroot })\n+                ProjectWorkspace::Cargo { cargo, sysroot }\n             }\n-        }\n+        };\n+\n+        Ok(res)\n     }\n \n     /// Returns the roots for the current `ProjectWorkspace`\n@@ -469,87 +539,6 @@ impl ProjectWorkspace {\n     }\n }\n \n-fn find_rust_project_json(path: &Path) -> Option<PathBuf> {\n-    if path.ends_with(\"rust-project.json\") {\n-        return Some(path.to_path_buf());\n-    }\n-\n-    let mut curr = Some(path);\n-    while let Some(path) = curr {\n-        let candidate = path.join(\"rust-project.json\");\n-        if candidate.exists() {\n-            return Some(candidate);\n-        }\n-        curr = path.parent();\n-    }\n-\n-    None\n-}\n-\n-fn find_cargo_toml_in_parent_dir(path: &Path) -> Option<PathBuf> {\n-    let mut curr = Some(path);\n-    while let Some(path) = curr {\n-        let candidate = path.join(\"Cargo.toml\");\n-        if candidate.exists() {\n-            return Some(candidate);\n-        }\n-        curr = path.parent();\n-    }\n-\n-    None\n-}\n-\n-fn find_cargo_toml_in_child_dir(entities: ReadDir) -> Vec<PathBuf> {\n-    // Only one level down to avoid cycles the easy way and stop a runaway scan with large projects\n-    let mut valid_canditates = vec![];\n-    for entity in entities.filter_map(Result::ok) {\n-        let candidate = entity.path().join(\"Cargo.toml\");\n-        if candidate.exists() {\n-            valid_canditates.push(candidate)\n-        }\n-    }\n-    valid_canditates\n-}\n-\n-fn find_cargo_toml(path: &Path) -> Result<PathBuf> {\n-    if path.ends_with(\"Cargo.toml\") {\n-        return Ok(path.to_path_buf());\n-    }\n-\n-    if let Some(p) = find_cargo_toml_in_parent_dir(path) {\n-        return Ok(p);\n-    }\n-\n-    let entities = match read_dir(path) {\n-        Ok(entities) => entities,\n-        Err(e) => {\n-            return Err(CargoTomlNotFoundError {\n-                searched_at: path.to_path_buf(),\n-                reason: format!(\"file system error: {}\", e),\n-            }\n-            .into());\n-        }\n-    };\n-\n-    let mut valid_canditates = find_cargo_toml_in_child_dir(entities);\n-    match valid_canditates.len() {\n-        1 => Ok(valid_canditates.remove(0)),\n-        0 => Err(CargoTomlNotFoundError {\n-            searched_at: path.to_path_buf(),\n-            reason: \"no Cargo.toml file found\".to_string(),\n-        }\n-        .into()),\n-        _ => Err(CargoTomlNotFoundError {\n-            searched_at: path.to_path_buf(),\n-            reason: format!(\n-                \"multiple equally valid Cargo.toml files found: {:?}\",\n-                valid_canditates\n-            ),\n-        }\n-        .into()),\n-    }\n-}\n-\n pub fn get_rustc_cfg_options() -> CfgOptions {\n     let mut cfg_options = CfgOptions::default();\n "}, {"sha": "eb9ac32c3e8cdcd0c94512a0ce5ae4084e128d11", "filename": "crates/rust-analyzer/src/cli/load_cargo.rs", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/8d296be1090b21b60e509c831864ae85feec2490/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fload_cargo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8d296be1090b21b60e509c831864ae85feec2490/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fload_cargo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fload_cargo.rs?ref=8d296be1090b21b60e509c831864ae85feec2490", "patch": "@@ -8,7 +8,7 @@ use crossbeam_channel::{unbounded, Receiver};\n use ra_db::{ExternSourceId, FileId, SourceRootId};\n use ra_ide::{AnalysisChange, AnalysisHost};\n use ra_project_model::{\n-    get_rustc_cfg_options, CargoConfig, PackageRoot, ProcMacroClient, ProjectWorkspace,\n+    get_rustc_cfg_options, CargoConfig, PackageRoot, ProcMacroClient, ProjectRoot, ProjectWorkspace,\n };\n use ra_vfs::{RootEntry, Vfs, VfsChange, VfsTask, Watch};\n use rustc_hash::{FxHashMap, FxHashSet};\n@@ -28,9 +28,11 @@ pub(crate) fn load_cargo(\n     with_proc_macro: bool,\n ) -> Result<(AnalysisHost, FxHashMap<SourceRootId, PackageRoot>)> {\n     let root = std::env::current_dir()?.join(root);\n-    let ws = ProjectWorkspace::discover(\n-        root.as_ref(),\n+    let root = ProjectRoot::discover_single(&root)?;\n+    let ws = ProjectWorkspace::load(\n+        root,\n         &CargoConfig { load_out_dirs_from_check, ..Default::default() },\n+        true,\n     )?;\n \n     let mut extern_dirs = FxHashSet::default();"}, {"sha": "fc4c77f8aa5cab89b926cff3c0c468cb9574d3f7", "filename": "crates/rust-analyzer/src/main_loop.rs", "status": "modified", "additions": 35, "deletions": 25, "changes": 60, "blob_url": "https://github.com/rust-lang/rust/blob/8d296be1090b21b60e509c831864ae85feec2490/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8d296be1090b21b60e509c831864ae85feec2490/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs?ref=8d296be1090b21b60e509c831864ae85feec2490", "patch": "@@ -15,6 +15,7 @@ use std::{\n };\n \n use crossbeam_channel::{never, select, unbounded, RecvError, Sender};\n+use itertools::Itertools;\n use lsp_server::{Connection, ErrorCode, Message, Notification, Request, RequestId, Response};\n use lsp_types::{\n     NumberOrString, WorkDoneProgress, WorkDoneProgressBegin, WorkDoneProgressCreateParams,\n@@ -88,37 +89,46 @@ pub fn main_loop(ws_roots: Vec<PathBuf>, config: Config, connection: Connection)\n \n     let mut loop_state = LoopState::default();\n     let mut world_state = {\n-        // FIXME: support dynamic workspace loading.\n         let workspaces = {\n-            let mut loaded_workspaces = Vec::new();\n-            for ws_root in &ws_roots {\n-                let workspace = ra_project_model::ProjectWorkspace::discover_with_sysroot(\n-                    ws_root.as_path(),\n-                    config.with_sysroot,\n-                    &config.cargo,\n-                );\n-                match workspace {\n-                    Ok(workspace) => loaded_workspaces.push(workspace),\n-                    Err(e) => {\n-                        log::error!(\"loading workspace failed: {:?}\", e);\n-\n-                        if let Some(ra_project_model::CargoTomlNotFoundError { .. }) =\n-                            e.downcast_ref()\n-                        {\n-                            if !config.notifications.cargo_toml_not_found {\n-                                continue;\n-                            }\n-                        }\n+            // FIXME: support dynamic workspace loading.\n+            let mut visited = FxHashSet::default();\n+            let project_roots = ws_roots\n+                .iter()\n+                .filter_map(|it| ra_project_model::ProjectRoot::discover(it).ok())\n+                .flatten()\n+                .filter(|it| visited.insert(it.clone()))\n+                .collect::<Vec<_>>();\n+\n+            if project_roots.is_empty() && config.notifications.cargo_toml_not_found {\n+                show_message(\n+                        req::MessageType::Error,\n+                        format!(\n+                            \"rust-analyzer failed to discover workspace, no Cargo.toml found, dirs searched: {}\",\n+                            ws_roots.iter().format_with(\", \", |it, f| f(&it.display()))\n+                        ),\n+                        &connection.sender,\n+                    );\n+            };\n \n+            project_roots\n+                .into_iter()\n+                .filter_map(|root| {\n+                    ra_project_model::ProjectWorkspace::load(\n+                        root,\n+                        &config.cargo,\n+                        config.with_sysroot,\n+                    )\n+                    .map_err(|err| {\n+                        log::error!(\"failed to load workspace: {:#}\", err);\n                         show_message(\n                             req::MessageType::Error,\n-                            format!(\"rust-analyzer failed to load workspace: {:?}\", e),\n+                            format!(\"rust-analyzer failed to load workspace: {:#}\", err),\n                             &connection.sender,\n                         );\n-                    }\n-                }\n-            }\n-            loaded_workspaces\n+                    })\n+                    .ok()\n+                })\n+                .collect::<Vec<_>>()\n         };\n \n         let globs = config"}]}