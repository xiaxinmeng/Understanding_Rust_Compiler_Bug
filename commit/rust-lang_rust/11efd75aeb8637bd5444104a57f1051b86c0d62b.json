{"sha": "11efd75aeb8637bd5444104a57f1051b86c0d62b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjExZWZkNzVhZWI4NjM3YmQ1NDQ0MTA0YTU3ZjEwNTFiODZjMGQ2MmI=", "commit": {"author": {"name": "Michael Wright", "email": "mikerite@lavabit.com", "date": "2020-08-21T05:23:04Z"}, "committer": {"name": "Michael Wright", "email": "mikerite@lavabit.com", "date": "2020-08-21T05:23:04Z"}, "message": "Fix false negative in `option_as_ref_deref`", "tree": {"sha": "a5239ebda6142fb842d837a9a7d8363d5401a24f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a5239ebda6142fb842d837a9a7d8363d5401a24f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/11efd75aeb8637bd5444104a57f1051b86c0d62b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/11efd75aeb8637bd5444104a57f1051b86c0d62b", "html_url": "https://github.com/rust-lang/rust/commit/11efd75aeb8637bd5444104a57f1051b86c0d62b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/11efd75aeb8637bd5444104a57f1051b86c0d62b/comments", "author": null, "committer": null, "parents": [{"sha": "410461191393e2339e79b33fa8baf4650b905db0", "url": "https://api.github.com/repos/rust-lang/rust/commits/410461191393e2339e79b33fa8baf4650b905db0", "html_url": "https://github.com/rust-lang/rust/commit/410461191393e2339e79b33fa8baf4650b905db0"}], "stats": {"total": 21, "additions": 19, "deletions": 2}, "files": [{"sha": "22942d9fb0c97bac1bdf5cdd13b6a8653d1628a2", "filename": "clippy_lints/src/methods/mod.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/11efd75aeb8637bd5444104a57f1051b86c0d62b/clippy_lints%2Fsrc%2Fmethods%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/11efd75aeb8637bd5444104a57f1051b86c0d62b/clippy_lints%2Fsrc%2Fmethods%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmethods%2Fmod.rs?ref=11efd75aeb8637bd5444104a57f1051b86c0d62b", "patch": "@@ -3421,7 +3421,12 @@ fn lint_option_as_ref_deref<'tcx>(\n     ];\n \n     let is_deref = match map_args[1].kind {\n-        hir::ExprKind::Path(ref expr_qpath) => deref_aliases.iter().any(|path| match_qpath(expr_qpath, path)),\n+        hir::ExprKind::Path(ref expr_qpath) => cx\n+            .qpath_res(expr_qpath, map_args[1].hir_id)\n+            .opt_def_id()\n+            .map_or(false, |fun_def_id| {\n+                deref_aliases.iter().any(|path| match_def_path(cx, fun_def_id, path))\n+            }),\n         hir::ExprKind::Closure(_, _, body_id, _, _) => {\n             let closure_body = cx.tcx.hir().body(body_id);\n             let closure_expr = remove_blocks(&closure_body.value);"}, {"sha": "07d7f0b45b0c2f2171cd29c29a4360deb7cff1ed", "filename": "tests/ui/option_as_ref_deref.fixed", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/11efd75aeb8637bd5444104a57f1051b86c0d62b/tests%2Fui%2Foption_as_ref_deref.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/11efd75aeb8637bd5444104a57f1051b86c0d62b/tests%2Fui%2Foption_as_ref_deref.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Foption_as_ref_deref.fixed?ref=11efd75aeb8637bd5444104a57f1051b86c0d62b", "patch": "@@ -38,4 +38,7 @@ fn main() {\n \n     let _ = opt.as_deref();\n     let _ = opt.as_deref_mut();\n+\n+    // Issue #5927\n+    let _ = opt.as_deref();\n }"}, {"sha": "6ae059c9425d35480c7afcc00ab7e6b63b0db3cf", "filename": "tests/ui/option_as_ref_deref.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/11efd75aeb8637bd5444104a57f1051b86c0d62b/tests%2Fui%2Foption_as_ref_deref.rs", "raw_url": "https://github.com/rust-lang/rust/raw/11efd75aeb8637bd5444104a57f1051b86c0d62b/tests%2Fui%2Foption_as_ref_deref.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Foption_as_ref_deref.rs?ref=11efd75aeb8637bd5444104a57f1051b86c0d62b", "patch": "@@ -41,4 +41,7 @@ fn main() {\n \n     let _ = opt.as_ref().map(|x| &**x);\n     let _ = opt.as_mut().map(|x| &mut **x);\n+\n+    // Issue #5927\n+    let _ = opt.as_ref().map(std::ops::Deref::deref);\n }"}, {"sha": "62f28232475282a1a51ade866365560ec6031386", "filename": "tests/ui/option_as_ref_deref.stderr", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/11efd75aeb8637bd5444104a57f1051b86c0d62b/tests%2Fui%2Foption_as_ref_deref.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/11efd75aeb8637bd5444104a57f1051b86c0d62b/tests%2Fui%2Foption_as_ref_deref.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Foption_as_ref_deref.stderr?ref=11efd75aeb8637bd5444104a57f1051b86c0d62b", "patch": "@@ -100,5 +100,11 @@ error: called `.as_mut().map(|x| &mut **x)` on an Option value. This can be done\n LL |     let _ = opt.as_mut().map(|x| &mut **x);\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: try using as_deref_mut instead: `opt.as_deref_mut()`\n \n-error: aborting due to 16 previous errors\n+error: called `.as_ref().map(std::ops::Deref::deref)` on an Option value. This can be done more directly by calling `opt.as_deref()` instead\n+  --> $DIR/option_as_ref_deref.rs:46:13\n+   |\n+LL |     let _ = opt.as_ref().map(std::ops::Deref::deref);\n+   |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: try using as_deref instead: `opt.as_deref()`\n+\n+error: aborting due to 17 previous errors\n "}]}