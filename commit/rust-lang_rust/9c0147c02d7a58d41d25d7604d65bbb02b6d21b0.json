{"sha": "9c0147c02d7a58d41d25d7604d65bbb02b6d21b0", "node_id": "MDY6Q29tbWl0NzI0NzEyOjljMDE0N2MwMmQ3YTU4ZDQxZDI1ZDc2MDRkNjViYmIwMmI2ZDIxYjA=", "commit": {"author": {"name": "Nathaniel McCallum", "email": "nathaniel@congru.us", "date": "2021-08-03T20:45:55Z"}, "committer": {"name": "Nathaniel McCallum", "email": "nathaniel@congru.us", "date": "2021-08-04T19:30:10Z"}, "message": "Disable unused variable lint for naked functions\n\nIn most calling conventions, accessing function parameters may require\nstack access. However, naked functions have no assembly prelude to set\nup stack access.  This is why naked functions may only contain a single\n`asm!()` block. All parameter access is done inside the `asm!()` block,\nso we cannot validate the liveness of the input parameters. Therefore,\nwe should disable the lint for naked functions.\n\nrust-lang/rfcs#2774\nrust-lang/rfcs#2972", "tree": {"sha": "117124fdfafd4aef3a582dbc60056df4ebb11803", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/117124fdfafd4aef3a582dbc60056df4ebb11803"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9c0147c02d7a58d41d25d7604d65bbb02b6d21b0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9c0147c02d7a58d41d25d7604d65bbb02b6d21b0", "html_url": "https://github.com/rust-lang/rust/commit/9c0147c02d7a58d41d25d7604d65bbb02b6d21b0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9c0147c02d7a58d41d25d7604d65bbb02b6d21b0/comments", "author": {"login": "npmccallum", "id": 288304, "node_id": "MDQ6VXNlcjI4ODMwNA==", "avatar_url": "https://avatars.githubusercontent.com/u/288304?v=4", "gravatar_id": "", "url": "https://api.github.com/users/npmccallum", "html_url": "https://github.com/npmccallum", "followers_url": "https://api.github.com/users/npmccallum/followers", "following_url": "https://api.github.com/users/npmccallum/following{/other_user}", "gists_url": "https://api.github.com/users/npmccallum/gists{/gist_id}", "starred_url": "https://api.github.com/users/npmccallum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/npmccallum/subscriptions", "organizations_url": "https://api.github.com/users/npmccallum/orgs", "repos_url": "https://api.github.com/users/npmccallum/repos", "events_url": "https://api.github.com/users/npmccallum/events{/privacy}", "received_events_url": "https://api.github.com/users/npmccallum/received_events", "type": "User", "site_admin": false}, "committer": {"login": "npmccallum", "id": 288304, "node_id": "MDQ6VXNlcjI4ODMwNA==", "avatar_url": "https://avatars.githubusercontent.com/u/288304?v=4", "gravatar_id": "", "url": "https://api.github.com/users/npmccallum", "html_url": "https://github.com/npmccallum", "followers_url": "https://api.github.com/users/npmccallum/followers", "following_url": "https://api.github.com/users/npmccallum/following{/other_user}", "gists_url": "https://api.github.com/users/npmccallum/gists{/gist_id}", "starred_url": "https://api.github.com/users/npmccallum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/npmccallum/subscriptions", "organizations_url": "https://api.github.com/users/npmccallum/orgs", "repos_url": "https://api.github.com/users/npmccallum/repos", "events_url": "https://api.github.com/users/npmccallum/events{/privacy}", "received_events_url": "https://api.github.com/users/npmccallum/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7ac0cb0ec1152a9a64da0d444b5f21c801f9ca77", "url": "https://api.github.com/repos/rust-lang/rust/commits/7ac0cb0ec1152a9a64da0d444b5f21c801f9ca77", "html_url": "https://github.com/rust-lang/rust/commit/7ac0cb0ec1152a9a64da0d444b5f21c801f9ca77"}], "stats": {"total": 77, "additions": 6, "deletions": 71}, "files": [{"sha": "f2c2521ab43e4690e4366ed42f7834bb697b4968", "filename": "compiler/rustc_passes/src/liveness.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/9c0147c02d7a58d41d25d7604d65bbb02b6d21b0/compiler%2Frustc_passes%2Fsrc%2Fliveness.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9c0147c02d7a58d41d25d7604d65bbb02b6d21b0/compiler%2Frustc_passes%2Fsrc%2Fliveness.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fliveness.rs?ref=9c0147c02d7a58d41d25d7604d65bbb02b6d21b0", "patch": "@@ -332,6 +332,11 @@ impl<'tcx> Visitor<'tcx> for IrMaps<'tcx> {\n             }\n         }\n \n+        // Don't run unused pass for #[naked]\n+        if self.tcx.has_attr(def_id, sym::naked) {\n+            return;\n+        }\n+\n         if let Some(captures) = maps.tcx.typeck(local_def_id).closure_min_captures.get(&def_id) {\n             for &var_hir_id in captures.keys() {\n                 let var_name = maps.tcx.hir().name(var_hir_id);"}, {"sha": "e1f2362bb6fd075f2d3f8a0fa6c6d496485227be", "filename": "src/test/ui/asm/naked-functions-unused.rs", "status": "modified", "additions": 0, "deletions": 10, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/9c0147c02d7a58d41d25d7604d65bbb02b6d21b0/src%2Ftest%2Fui%2Fasm%2Fnaked-functions-unused.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9c0147c02d7a58d41d25d7604d65bbb02b6d21b0/src%2Ftest%2Fui%2Fasm%2Fnaked-functions-unused.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasm%2Fnaked-functions-unused.rs?ref=9c0147c02d7a58d41d25d7604d65bbb02b6d21b0", "patch": "@@ -50,8 +50,6 @@ pub mod normal {\n pub mod naked {\n     #[naked]\n     pub extern \"sysv64\" fn function(a: usize, b: usize) -> usize {\n-        //~^ ERROR unused variable: `a`\n-        //~| ERROR unused variable: `b`\n         unsafe { asm!(\"\", options(noreturn)); }\n     }\n \n@@ -60,31 +58,23 @@ pub mod naked {\n     impl Naked {\n         #[naked]\n         pub extern \"sysv64\" fn associated(a: usize, b: usize) -> usize {\n-            //~^ ERROR unused variable: `a`\n-            //~| ERROR unused variable: `b`\n             unsafe { asm!(\"\", options(noreturn)); }\n         }\n \n         #[naked]\n         pub extern \"sysv64\" fn method(&self, a: usize, b: usize) -> usize {\n-            //~^ ERROR unused variable: `a`\n-            //~| ERROR unused variable: `b`\n             unsafe { asm!(\"\", options(noreturn)); }\n         }\n     }\n \n     impl super::Trait for Naked {\n         #[naked]\n         extern \"sysv64\" fn trait_associated(a: usize, b: usize) -> usize {\n-            //~^ ERROR unused variable: `a`\n-            //~| ERROR unused variable: `b`\n             unsafe { asm!(\"\", options(noreturn)); }\n         }\n \n         #[naked]\n         extern \"sysv64\" fn trait_method(&self, a: usize, b: usize) -> usize {\n-            //~^ ERROR unused variable: `a`\n-            //~| ERROR unused variable: `b`\n             unsafe { asm!(\"\", options(noreturn)); }\n         }\n     }"}, {"sha": "840353366b6703edf3ae938781c7f0f38007b58c", "filename": "src/test/ui/asm/naked-functions-unused.stderr", "status": "modified", "additions": 1, "deletions": 61, "changes": 62, "blob_url": "https://github.com/rust-lang/rust/blob/9c0147c02d7a58d41d25d7604d65bbb02b6d21b0/src%2Ftest%2Fui%2Fasm%2Fnaked-functions-unused.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/9c0147c02d7a58d41d25d7604d65bbb02b6d21b0/src%2Ftest%2Fui%2Fasm%2Fnaked-functions-unused.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasm%2Fnaked-functions-unused.stderr?ref=9c0147c02d7a58d41d25d7604d65bbb02b6d21b0", "patch": "@@ -65,65 +65,5 @@ error: unused variable: `b`\n LL |         extern \"sysv64\" fn trait_method(&self, a: usize, b: usize) -> usize {\n    |                                                          ^ help: if this is intentional, prefix it with an underscore: `_b`\n \n-error: unused variable: `a`\n-  --> $DIR/naked-functions-unused.rs:52:37\n-   |\n-LL |     pub extern \"sysv64\" fn function(a: usize, b: usize) -> usize {\n-   |                                     ^ help: if this is intentional, prefix it with an underscore: `_a`\n-\n-error: unused variable: `b`\n-  --> $DIR/naked-functions-unused.rs:52:47\n-   |\n-LL |     pub extern \"sysv64\" fn function(a: usize, b: usize) -> usize {\n-   |                                               ^ help: if this is intentional, prefix it with an underscore: `_b`\n-\n-error: unused variable: `a`\n-  --> $DIR/naked-functions-unused.rs:62:43\n-   |\n-LL |         pub extern \"sysv64\" fn associated(a: usize, b: usize) -> usize {\n-   |                                           ^ help: if this is intentional, prefix it with an underscore: `_a`\n-\n-error: unused variable: `b`\n-  --> $DIR/naked-functions-unused.rs:62:53\n-   |\n-LL |         pub extern \"sysv64\" fn associated(a: usize, b: usize) -> usize {\n-   |                                                     ^ help: if this is intentional, prefix it with an underscore: `_b`\n-\n-error: unused variable: `a`\n-  --> $DIR/naked-functions-unused.rs:69:46\n-   |\n-LL |         pub extern \"sysv64\" fn method(&self, a: usize, b: usize) -> usize {\n-   |                                              ^ help: if this is intentional, prefix it with an underscore: `_a`\n-\n-error: unused variable: `b`\n-  --> $DIR/naked-functions-unused.rs:69:56\n-   |\n-LL |         pub extern \"sysv64\" fn method(&self, a: usize, b: usize) -> usize {\n-   |                                                        ^ help: if this is intentional, prefix it with an underscore: `_b`\n-\n-error: unused variable: `a`\n-  --> $DIR/naked-functions-unused.rs:78:45\n-   |\n-LL |         extern \"sysv64\" fn trait_associated(a: usize, b: usize) -> usize {\n-   |                                             ^ help: if this is intentional, prefix it with an underscore: `_a`\n-\n-error: unused variable: `b`\n-  --> $DIR/naked-functions-unused.rs:78:55\n-   |\n-LL |         extern \"sysv64\" fn trait_associated(a: usize, b: usize) -> usize {\n-   |                                                       ^ help: if this is intentional, prefix it with an underscore: `_b`\n-\n-error: unused variable: `a`\n-  --> $DIR/naked-functions-unused.rs:85:48\n-   |\n-LL |         extern \"sysv64\" fn trait_method(&self, a: usize, b: usize) -> usize {\n-   |                                                ^ help: if this is intentional, prefix it with an underscore: `_a`\n-\n-error: unused variable: `b`\n-  --> $DIR/naked-functions-unused.rs:85:58\n-   |\n-LL |         extern \"sysv64\" fn trait_method(&self, a: usize, b: usize) -> usize {\n-   |                                                          ^ help: if this is intentional, prefix it with an underscore: `_b`\n-\n-error: aborting due to 20 previous errors\n+error: aborting due to 10 previous errors\n "}]}