{"sha": "8fc0a738e3fb82bb956c996438c71272ed92e49c", "node_id": "MDY6Q29tbWl0NzI0NzEyOjhmYzBhNzM4ZTNmYjgyYmI5NTZjOTk2NDM4YzcxMjcyZWQ5MmU0OWM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-03-12T12:09:56Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-03-12T12:09:56Z"}, "message": "Auto merge of #3869 - taiki-e:use_self, r=flip1995\n\nFix `use_self` false positive on nested functions\n\nRelated to https://github.com/rust-lang/rust-clippy/pull/3640\n\nThe current `use_self` warns the following code.\n\n```rust\n#![warn(clippy::use_self)]\nstruct Foo {}\nimpl Foo {\n    fn bar() {\n        fn baz() -> Foo { //^ warning: unnecessary structure name repetition\n            Foo {} //^ warning: unnecessary structure name repetition\n         }\n    }\n}\n```", "tree": {"sha": "3b0e21d3ad794a3c913ce7f4d256a4462d00956a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3b0e21d3ad794a3c913ce7f4d256a4462d00956a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8fc0a738e3fb82bb956c996438c71272ed92e49c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8fc0a738e3fb82bb956c996438c71272ed92e49c", "html_url": "https://github.com/rust-lang/rust/commit/8fc0a738e3fb82bb956c996438c71272ed92e49c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8fc0a738e3fb82bb956c996438c71272ed92e49c/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6e2b8fa8ca1eee666122cd99a2168986649b09e0", "url": "https://api.github.com/repos/rust-lang/rust/commits/6e2b8fa8ca1eee666122cd99a2168986649b09e0", "html_url": "https://github.com/rust-lang/rust/commit/6e2b8fa8ca1eee666122cd99a2168986649b09e0"}, {"sha": "187ce4c5ab627706b33b28af22b2cefdd6986048", "url": "https://api.github.com/repos/rust-lang/rust/commits/187ce4c5ab627706b33b28af22b2cefdd6986048", "html_url": "https://github.com/rust-lang/rust/commit/187ce4c5ab627706b33b28af22b2cefdd6986048"}], "stats": {"total": 43, "additions": 38, "deletions": 5}, "files": [{"sha": "903e0a81b993e8d813e85d4b54e5b69292358d18", "filename": "clippy_lints/src/use_self.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/8fc0a738e3fb82bb956c996438c71272ed92e49c/clippy_lints%2Fsrc%2Fuse_self.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8fc0a738e3fb82bb956c996438c71272ed92e49c/clippy_lints%2Fsrc%2Fuse_self.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fuse_self.rs?ref=8fc0a738e3fb82bb956c996438c71272ed92e49c", "patch": "@@ -248,7 +248,8 @@ impl<'a, 'tcx> Visitor<'tcx> for UseSelfVisitor<'a, 'tcx> {\n             | ItemKind::Enum(..)\n             | ItemKind::Struct(..)\n             | ItemKind::Union(..)\n-            | ItemKind::Impl(..) => {\n+            | ItemKind::Impl(..)\n+            | ItemKind::Fn(..) => {\n                 // Don't check statements that shadow `Self` or where `Self` can't be used\n             },\n             _ => walk_item(self, item),"}, {"sha": "730d391848ec1be38c8e39c4dc37c47f1b1dc493", "filename": "tests/ui/use_self.fixed", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/8fc0a738e3fb82bb956c996438c71272ed92e49c/tests%2Fui%2Fuse_self.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/8fc0a738e3fb82bb956c996438c71272ed92e49c/tests%2Fui%2Fuse_self.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fuse_self.fixed?ref=8fc0a738e3fb82bb956c996438c71272ed92e49c", "patch": "@@ -249,6 +249,16 @@ mod nesting {\n                     Self { foo: Foo {} }\n                 }\n             }\n+\n+            // Can't use Self here\n+            fn baz() -> Foo {\n+                Foo {}\n+            }\n+        }\n+\n+        // Should lint here\n+        fn baz() -> Self {\n+            Self {}\n         }\n     }\n "}, {"sha": "00824731512106153b320b488c1839e7bee3fd65", "filename": "tests/ui/use_self.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/8fc0a738e3fb82bb956c996438c71272ed92e49c/tests%2Fui%2Fuse_self.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8fc0a738e3fb82bb956c996438c71272ed92e49c/tests%2Fui%2Fuse_self.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fuse_self.rs?ref=8fc0a738e3fb82bb956c996438c71272ed92e49c", "patch": "@@ -249,6 +249,16 @@ mod nesting {\n                     Bar { foo: Foo {} }\n                 }\n             }\n+\n+            // Can't use Self here\n+            fn baz() -> Foo {\n+                Foo {}\n+            }\n+        }\n+\n+        // Should lint here\n+        fn baz() -> Foo {\n+            Foo {}\n         }\n     }\n "}, {"sha": "6e39a28012a88de7ab4cd456db81d85636f97902", "filename": "tests/ui/use_self.stderr", "status": "modified", "additions": 16, "deletions": 4, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/8fc0a738e3fb82bb956c996438c71272ed92e49c/tests%2Fui%2Fuse_self.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/8fc0a738e3fb82bb956c996438c71272ed92e49c/tests%2Fui%2Fuse_self.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fuse_self.stderr?ref=8fc0a738e3fb82bb956c996438c71272ed92e49c", "patch": "@@ -150,6 +150,18 @@ LL |                 Foo {}\n LL |         use_self_expand!(); // Should lint in local macros\n    |         ------------------- in this macro invocation\n \n+error: unnecessary structure name repetition\n+  --> $DIR/use_self.rs:260:21\n+   |\n+LL |         fn baz() -> Foo {\n+   |                     ^^^ help: use the applicable keyword: `Self`\n+\n+error: unnecessary structure name repetition\n+  --> $DIR/use_self.rs:261:13\n+   |\n+LL |             Foo {}\n+   |             ^^^ help: use the applicable keyword: `Self`\n+\n error: unnecessary structure name repetition\n   --> $DIR/use_self.rs:248:29\n    |\n@@ -163,22 +175,22 @@ LL |                     Bar { foo: Foo {} }\n    |                     ^^^ help: use the applicable keyword: `Self`\n \n error: unnecessary structure name repetition\n-  --> $DIR/use_self.rs:293:13\n+  --> $DIR/use_self.rs:303:13\n    |\n LL |             nested::A::fun_1();\n    |             ^^^^^^^^^ help: use the applicable keyword: `Self`\n \n error: unnecessary structure name repetition\n-  --> $DIR/use_self.rs:294:13\n+  --> $DIR/use_self.rs:304:13\n    |\n LL |             nested::A::A;\n    |             ^^^^^^^^^ help: use the applicable keyword: `Self`\n \n error: unnecessary structure name repetition\n-  --> $DIR/use_self.rs:296:13\n+  --> $DIR/use_self.rs:306:13\n    |\n LL |             nested::A {};\n    |             ^^^^^^^^^ help: use the applicable keyword: `Self`\n \n-error: aborting due to 29 previous errors\n+error: aborting due to 31 previous errors\n "}]}