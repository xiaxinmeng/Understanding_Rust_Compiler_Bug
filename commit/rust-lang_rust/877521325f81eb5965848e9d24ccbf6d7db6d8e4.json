{"sha": "877521325f81eb5965848e9d24ccbf6d7db6d8e4", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg3NzUyMTMyNWY4MWViNTk2NTg0OGU5ZDI0Y2NiZjZkN2RiNmQ4ZTQ=", "commit": {"author": {"name": "Edwin Cheng", "email": "edwin0cheng@gmail.com", "date": "2021-03-02T05:14:05Z"}, "committer": {"name": "Edwin Cheng", "email": "edwin0cheng@gmail.com", "date": "2021-03-02T05:14:05Z"}, "message": "Fix ProcMacroClient dropped too early in cli", "tree": {"sha": "29ab01fce8bc7283b367ef63049cf83e3b6d5e94", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/29ab01fce8bc7283b367ef63049cf83e3b6d5e94"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/877521325f81eb5965848e9d24ccbf6d7db6d8e4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/877521325f81eb5965848e9d24ccbf6d7db6d8e4", "html_url": "https://github.com/rust-lang/rust/commit/877521325f81eb5965848e9d24ccbf6d7db6d8e4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/877521325f81eb5965848e9d24ccbf6d7db6d8e4/comments", "author": {"login": "edwin0cheng", "id": 11014119, "node_id": "MDQ6VXNlcjExMDE0MTE5", "avatar_url": "https://avatars.githubusercontent.com/u/11014119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/edwin0cheng", "html_url": "https://github.com/edwin0cheng", "followers_url": "https://api.github.com/users/edwin0cheng/followers", "following_url": "https://api.github.com/users/edwin0cheng/following{/other_user}", "gists_url": "https://api.github.com/users/edwin0cheng/gists{/gist_id}", "starred_url": "https://api.github.com/users/edwin0cheng/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/edwin0cheng/subscriptions", "organizations_url": "https://api.github.com/users/edwin0cheng/orgs", "repos_url": "https://api.github.com/users/edwin0cheng/repos", "events_url": "https://api.github.com/users/edwin0cheng/events{/privacy}", "received_events_url": "https://api.github.com/users/edwin0cheng/received_events", "type": "User", "site_admin": false}, "committer": {"login": "edwin0cheng", "id": 11014119, "node_id": "MDQ6VXNlcjExMDE0MTE5", "avatar_url": "https://avatars.githubusercontent.com/u/11014119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/edwin0cheng", "html_url": "https://github.com/edwin0cheng", "followers_url": "https://api.github.com/users/edwin0cheng/followers", "following_url": "https://api.github.com/users/edwin0cheng/following{/other_user}", "gists_url": "https://api.github.com/users/edwin0cheng/gists{/gist_id}", "starred_url": "https://api.github.com/users/edwin0cheng/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/edwin0cheng/subscriptions", "organizations_url": "https://api.github.com/users/edwin0cheng/orgs", "repos_url": "https://api.github.com/users/edwin0cheng/repos", "events_url": "https://api.github.com/users/edwin0cheng/events{/privacy}", "received_events_url": "https://api.github.com/users/edwin0cheng/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c17f2bf2a27798858ef2e3012ca28295aed46efa", "url": "https://api.github.com/repos/rust-lang/rust/commits/c17f2bf2a27798858ef2e3012ca28295aed46efa", "html_url": "https://github.com/rust-lang/rust/commit/c17f2bf2a27798858ef2e3012ca28295aed46efa"}], "stats": {"total": 20, "additions": 11, "deletions": 9}, "files": [{"sha": "ebbbf05963a5a6261b7fe5dc72b7c177f08f6ee9", "filename": "crates/rust-analyzer/src/cli/analysis_bench.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/877521325f81eb5965848e9d24ccbf6d7db6d8e4/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fanalysis_bench.rs", "raw_url": "https://github.com/rust-lang/rust/raw/877521325f81eb5965848e9d24ccbf6d7db6d8e4/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fanalysis_bench.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fanalysis_bench.rs?ref=877521325f81eb5965848e9d24ccbf6d7db6d8e4", "patch": "@@ -68,7 +68,7 @@ impl BenchCmd {\n             load_out_dirs_from_check: self.load_output_dirs,\n             with_proc_macro: self.with_proc_macro,\n         };\n-        let (mut host, vfs) =\n+        let (mut host, vfs, _proc_macro) =\n             load_workspace_at(&self.path, &cargo_config, &load_cargo_config, &|_| {})?;\n         eprintln!(\"{:?}\\n\", start.elapsed());\n "}, {"sha": "ad0759bdad8c9a4168a04f7caa7658f0e920873c", "filename": "crates/rust-analyzer/src/cli/analysis_stats.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/877521325f81eb5965848e9d24ccbf6d7db6d8e4/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fanalysis_stats.rs", "raw_url": "https://github.com/rust-lang/rust/raw/877521325f81eb5965848e9d24ccbf6d7db6d8e4/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fanalysis_stats.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fanalysis_stats.rs?ref=877521325f81eb5965848e9d24ccbf6d7db6d8e4", "patch": "@@ -64,7 +64,7 @@ impl AnalysisStatsCmd {\n             load_out_dirs_from_check: self.load_output_dirs,\n             with_proc_macro: self.with_proc_macro,\n         };\n-        let (host, vfs) =\n+        let (host, vfs, _proc_macro) =\n             load_workspace_at(&self.path, &cargo_config, &load_cargo_config, &|_| {})?;\n         let db = host.raw_database();\n         eprintln!(\"{:<20} {}\", \"Database loaded:\", db_load_sw.elapsed());"}, {"sha": "8b985716b031a038285499f6266c9fa638b4b0fe", "filename": "crates/rust-analyzer/src/cli/diagnostics.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/877521325f81eb5965848e9d24ccbf6d7db6d8e4/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/877521325f81eb5965848e9d24ccbf6d7db6d8e4/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fdiagnostics.rs?ref=877521325f81eb5965848e9d24ccbf6d7db6d8e4", "patch": "@@ -35,7 +35,8 @@ pub fn diagnostics(\n ) -> Result<()> {\n     let cargo_config = Default::default();\n     let load_cargo_config = LoadCargoConfig { load_out_dirs_from_check, with_proc_macro };\n-    let (host, _vfs) = load_workspace_at(path, &cargo_config, &load_cargo_config, &|_| {})?;\n+    let (host, _vfs, _proc_macro) =\n+        load_workspace_at(path, &cargo_config, &load_cargo_config, &|_| {})?;\n     let db = host.raw_database();\n     let analysis = host.analysis();\n "}, {"sha": "310c36904e0a0aa4a860daf32063df65f381a381", "filename": "crates/rust-analyzer/src/cli/load_cargo.rs", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/877521325f81eb5965848e9d24ccbf6d7db6d8e4/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fload_cargo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/877521325f81eb5965848e9d24ccbf6d7db6d8e4/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fload_cargo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fload_cargo.rs?ref=877521325f81eb5965848e9d24ccbf6d7db6d8e4", "patch": "@@ -23,7 +23,7 @@ pub fn load_workspace_at(\n     cargo_config: &CargoConfig,\n     load_config: &LoadCargoConfig,\n     progress: &dyn Fn(String),\n-) -> Result<(AnalysisHost, vfs::Vfs)> {\n+) -> Result<(AnalysisHost, vfs::Vfs, Option<ProcMacroClient>)> {\n     let root = AbsPathBuf::assert(std::env::current_dir()?.join(root));\n     let root = ProjectManifest::discover_single(&root)?;\n     let workspace = ProjectWorkspace::load(root, cargo_config, progress)?;\n@@ -35,7 +35,7 @@ pub fn load_workspace(\n     ws: ProjectWorkspace,\n     config: &LoadCargoConfig,\n     progress: &dyn Fn(String),\n-) -> Result<(AnalysisHost, vfs::Vfs)> {\n+) -> Result<(AnalysisHost, vfs::Vfs, Option<ProcMacroClient>)> {\n     let (sender, receiver) = unbounded();\n     let mut vfs = vfs::Vfs::default();\n     let mut loader = {\n@@ -80,7 +80,7 @@ pub fn load_workspace(\n     log::debug!(\"crate graph: {:?}\", crate_graph);\n     let host =\n         load_crate_graph(crate_graph, project_folders.source_root_config, &mut vfs, &receiver);\n-    Ok((host, vfs))\n+    Ok((host, vfs, proc_macro_client))\n }\n \n fn load_crate_graph(\n@@ -138,7 +138,8 @@ mod tests {\n         let cargo_config = Default::default();\n         let load_cargo_config =\n             LoadCargoConfig { load_out_dirs_from_check: false, with_proc_macro: false };\n-        let (host, _vfs) = load_workspace_at(path, &cargo_config, &load_cargo_config, &|_| {})?;\n+        let (host, _vfs, _proc_macro) =\n+            load_workspace_at(path, &cargo_config, &load_cargo_config, &|_| {})?;\n \n         let n_crates = Crate::all(host.raw_database()).len();\n         // RA has quite a few crates, but the exact count doesn't matter"}, {"sha": "79f426fff15a9381218d2e099bd4b8d334add1d7", "filename": "crates/rust-analyzer/src/cli/ssr.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/877521325f81eb5965848e9d24ccbf6d7db6d8e4/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fssr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/877521325f81eb5965848e9d24ccbf6d7db6d8e4/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fssr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fssr.rs?ref=877521325f81eb5965848e9d24ccbf6d7db6d8e4", "patch": "@@ -11,7 +11,7 @@ pub fn apply_ssr_rules(rules: Vec<SsrRule>) -> Result<()> {\n     let cargo_config = Default::default();\n     let load_cargo_config =\n         LoadCargoConfig { load_out_dirs_from_check: true, with_proc_macro: true };\n-    let (host, vfs) =\n+    let (host, vfs, _proc_macro) =\n         load_workspace_at(&std::env::current_dir()?, &cargo_config, &load_cargo_config, &|_| {})?;\n     let db = host.raw_database();\n     let mut match_finder = MatchFinder::at_first_file(db)?;\n@@ -38,7 +38,7 @@ pub fn search_for_patterns(patterns: Vec<SsrPattern>, debug_snippet: Option<Stri\n     let cargo_config = Default::default();\n     let load_cargo_config =\n         LoadCargoConfig { load_out_dirs_from_check: true, with_proc_macro: true };\n-    let (host, _vfs) =\n+    let (host, _vfs, _proc_macro) =\n         load_workspace_at(&std::env::current_dir()?, &cargo_config, &load_cargo_config, &|_| {})?;\n     let db = host.raw_database();\n     let mut match_finder = MatchFinder::at_first_file(db)?;"}]}