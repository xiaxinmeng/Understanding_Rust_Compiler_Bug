{"sha": "0fec5ab2bbebbff9dab927133ed9b2dc972b6ab2", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBmZWM1YWIyYmJlYmJmZjlkYWI5MjcxMzNlZDliMmRjOTcyYjZhYjI=", "commit": {"author": {"name": "Yuki Okushi", "email": "huyuumi.dev@gmail.com", "date": "2019-11-10T00:27:20Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-11-10T00:27:20Z"}, "message": "Rollup merge of #66235 - eddyb:coff-syrup, r=nagisa\n\nrustc_metadata: don't let LLVM confuse rmeta blobs for COFF object files.\n\nThis has likely been a silent issue since 1.10 but only caused trouble recently (see https://github.com/rust-lang/rust/issues/65536#issuecomment-552018224), when recent changes to the `rmeta` schema introduced more opportunities for COFF parse errors.\n\nTo prevent any undesired interactions with old compilers, I've renamed the file inside `rlib`s from `rust.metadata.bin` to `lib.rmeta` (not strongly attached to it, suggestions welcome).\n\nFixes #65536.\n\n<hr/>\n\nBefore:\n```\n$ llvm-objdump -all-headers build/*/stage1-std/*/release/deps/libcore-*.rmeta\n\nbuild/x86_64-unknown-linux-gnu/stage1-std/x86_64-unknown-linux-gnu/release/deps/libcore-6b9e8b5a59b79a1d.rmeta: file format COFF-<unknown arch>\n\narchitecture: unknown\nstart address: 0x00000000\n\nSections:\nIdx Name          Size     VMA          Type\n\nSYMBOL TABLE:\n```\n\nAfter:\n```\n$ llvm-objdump -all-headers build/*/stage1-std/*/release/deps/libcore-*.rmeta\n\nllvm-objdump: error: 'build/x86_64-unknown-linux-gnu/stage1-std/x86_64-unknown-linux-gnu/release/deps/libcore-6b9e8b5a59b79a1d.rmeta':\n    The file was not recognized as a valid object file\n```", "tree": {"sha": "6bc533336b11f5961149278f393404500f08a107", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6bc533336b11f5961149278f393404500f08a107"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0fec5ab2bbebbff9dab927133ed9b2dc972b6ab2", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJdx1lpCRBK7hj4Ov3rIwAAdHIIAAJ11vQDnyTr5j5jdvQt4q5W\nV+Vgm/AAtq7vKutjpLb/LROSMhiQJfmyDf9bIHWJJtefUwo/ZRdjR9GKN7HS/Ty9\nJEmoxksG4o0MSMkbX7osfq4z4FcBWB4wiBFuUcv+CABTuFNJZcHZc4u67bhOQQWh\nS1Z0V32K3hogoy7OQRZlXEdMyNoqHP76s7mQwHQ4+RaivKu3EArj0wXVpve0dGS3\nVYp6+sGs4BzqqR62Zsv55qhc4+4qzq9SOSG5kocoH8gH5XxyGKAjFhoppo/UhDi6\nZc/zGVeHanjUbcxTGcsppCLrkbBcP4cFro9jlGSzLSTlu5nCK9g7JRhE4cVRYTM=\n=s5tE\n-----END PGP SIGNATURE-----\n", "payload": "tree 6bc533336b11f5961149278f393404500f08a107\nparent 9db3fddfe984418343b2d527288337715a40693c\nparent 0da85d62283257516a1dab97f7156a4e0cd96266\nauthor Yuki Okushi <huyuumi.dev@gmail.com> 1573345640 +0900\ncommitter GitHub <noreply@github.com> 1573345640 +0900\n\nRollup merge of #66235 - eddyb:coff-syrup, r=nagisa\n\nrustc_metadata: don't let LLVM confuse rmeta blobs for COFF object files.\n\nThis has likely been a silent issue since 1.10 but only caused trouble recently (see https://github.com/rust-lang/rust/issues/65536#issuecomment-552018224), when recent changes to the `rmeta` schema introduced more opportunities for COFF parse errors.\n\nTo prevent any undesired interactions with old compilers, I've renamed the file inside `rlib`s from `rust.metadata.bin` to `lib.rmeta` (not strongly attached to it, suggestions welcome).\n\nFixes #65536.\n\n<hr/>\n\nBefore:\n```\n$ llvm-objdump -all-headers build/*/stage1-std/*/release/deps/libcore-*.rmeta\n\nbuild/x86_64-unknown-linux-gnu/stage1-std/x86_64-unknown-linux-gnu/release/deps/libcore-6b9e8b5a59b79a1d.rmeta: file format COFF-<unknown arch>\n\narchitecture: unknown\nstart address: 0x00000000\n\nSections:\nIdx Name          Size     VMA          Type\n\nSYMBOL TABLE:\n```\n\nAfter:\n```\n$ llvm-objdump -all-headers build/*/stage1-std/*/release/deps/libcore-*.rmeta\n\nllvm-objdump: error: 'build/x86_64-unknown-linux-gnu/stage1-std/x86_64-unknown-linux-gnu/release/deps/libcore-6b9e8b5a59b79a1d.rmeta':\n    The file was not recognized as a valid object file\n```\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0fec5ab2bbebbff9dab927133ed9b2dc972b6ab2", "html_url": "https://github.com/rust-lang/rust/commit/0fec5ab2bbebbff9dab927133ed9b2dc972b6ab2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0fec5ab2bbebbff9dab927133ed9b2dc972b6ab2/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9db3fddfe984418343b2d527288337715a40693c", "url": "https://api.github.com/repos/rust-lang/rust/commits/9db3fddfe984418343b2d527288337715a40693c", "html_url": "https://github.com/rust-lang/rust/commit/9db3fddfe984418343b2d527288337715a40693c"}, {"sha": "0da85d62283257516a1dab97f7156a4e0cd96266", "url": "https://api.github.com/repos/rust-lang/rust/commits/0da85d62283257516a1dab97f7156a4e0cd96266", "html_url": "https://github.com/rust-lang/rust/commit/0da85d62283257516a1dab97f7156a4e0cd96266"}], "stats": {"total": 16, "additions": 7, "deletions": 9}, "files": [{"sha": "81e7ef64e975a88363ec49e416858a3d0bd5083f", "filename": "src/librustc_codegen_ssa/lib.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/0fec5ab2bbebbff9dab927133ed9b2dc972b6ab2/src%2Flibrustc_codegen_ssa%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0fec5ab2bbebbff9dab927133ed9b2dc972b6ab2/src%2Flibrustc_codegen_ssa%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_ssa%2Flib.rs?ref=0fec5ab2bbebbff9dab927133ed9b2dc972b6ab2", "patch": "@@ -59,7 +59,8 @@ pub struct ModuleCodegen<M> {\n     pub kind: ModuleKind,\n }\n \n-pub const METADATA_FILENAME: &str = \"rust.metadata.bin\";\n+// FIXME(eddyb) maybe include the crate name in this?\n+pub const METADATA_FILENAME: &str = \"lib.rmeta\";\n pub const RLIB_BYTECODE_EXTENSION: &str = \"bc.z\";\n \n "}, {"sha": "990a3d984b225ef8776c23788f89eb682985ce7d", "filename": "src/librustc_metadata/rmeta/mod.rs", "status": "modified", "additions": 3, "deletions": 6, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/0fec5ab2bbebbff9dab927133ed9b2dc972b6ab2/src%2Flibrustc_metadata%2Frmeta%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0fec5ab2bbebbff9dab927133ed9b2dc972b6ab2/src%2Flibrustc_metadata%2Frmeta%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Frmeta%2Fmod.rs?ref=0fec5ab2bbebbff9dab927133ed9b2dc972b6ab2", "patch": "@@ -37,18 +37,15 @@ crate fn rustc_version() -> String {\n /// Metadata encoding version.\n /// N.B., increment this if you change the format of metadata such that\n /// the rustc version can't be found to compare with `rustc_version()`.\n-const METADATA_VERSION: u8 = 4;\n+const METADATA_VERSION: u8 = 5;\n \n /// Metadata header which includes `METADATA_VERSION`.\n-/// To get older versions of rustc to ignore this metadata,\n-/// there are 4 zero bytes at the start, which are treated\n-/// as a length of 0 by old compilers.\n ///\n /// This header is followed by the position of the `CrateRoot`,\n /// which is encoded as a 32-bit big-endian unsigned integer,\n /// and further followed by the rustc version string.\n-crate const METADATA_HEADER: &[u8; 12] =\n-    &[0, 0, 0, 0, b'r', b'u', b's', b't', 0, 0, 0, METADATA_VERSION];\n+crate const METADATA_HEADER: &[u8; 8] =\n+    &[b'r', b'u', b's', b't', 0, 0, 0, METADATA_VERSION];\n \n /// Additional metadata for a `Lazy<T>` where `T` may not be `Sized`,\n /// e.g. for `Lazy<[T]>`, this is the length (count of `T` values)."}, {"sha": "c75713c3ee53d1798915a4abfd36c4144a0669ec", "filename": "src/test/run-make-fulldeps/invalid-library/Makefile", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/0fec5ab2bbebbff9dab927133ed9b2dc972b6ab2/src%2Ftest%2Frun-make-fulldeps%2Finvalid-library%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/0fec5ab2bbebbff9dab927133ed9b2dc972b6ab2/src%2Ftest%2Frun-make-fulldeps%2Finvalid-library%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Finvalid-library%2FMakefile?ref=0fec5ab2bbebbff9dab927133ed9b2dc972b6ab2", "patch": "@@ -1,6 +1,6 @@\n -include ../tools.mk\n \n all:\n-\ttouch $(TMPDIR)/rust.metadata.bin\n-\t$(AR) crus $(TMPDIR)/libfoo-ffffffff-1.0.rlib $(TMPDIR)/rust.metadata.bin\n+\ttouch $(TMPDIR)/lib.rmeta\n+\t$(AR) crus $(TMPDIR)/libfoo-ffffffff-1.0.rlib $(TMPDIR)/lib.rmeta\n \t$(RUSTC) foo.rs 2>&1 | $(CGREP) \"can't find crate for\""}]}