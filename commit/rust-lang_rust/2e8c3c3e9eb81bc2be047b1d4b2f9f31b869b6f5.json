{"sha": "2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5", "node_id": "MDY6Q29tbWl0NzI0NzEyOjJlOGMzYzNlOWViODFiYzJiZTA0N2IxZDRiMmY5ZjMxYjg2OWI2ZjU=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-01-03T08:48:05Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-01-03T08:48:05Z"}, "message": "Auto merge of #4975 - JohnTitor:fix-4968, r=phansch\n\nFix ICE on `unsound_collection_transmute`\n\nFixes #4968\n\nCheck if `Ty`s are normalizable. It might show hidden false negative, I'm not sure.\nAlso, the regression tests are placed on two dirs, so move them to `/crashes`. I think it will be easier to find the right place.\n\nchangelog: Fix ICE on `unsound_collection_transmute`", "tree": {"sha": "920b722eac49b8415c45fed685b42e80584d2de0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/920b722eac49b8415c45fed685b42e80584d2de0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5", "html_url": "https://github.com/rust-lang/rust/commit/2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "304edf39c3ebb6fac9b4db3c8e05fee1bbc1543b", "url": "https://api.github.com/repos/rust-lang/rust/commits/304edf39c3ebb6fac9b4db3c8e05fee1bbc1543b", "html_url": "https://github.com/rust-lang/rust/commit/304edf39c3ebb6fac9b4db3c8e05fee1bbc1543b"}, {"sha": "c6aeda7bd52e490148ae34242f09de66d0af9841", "url": "https://api.github.com/repos/rust-lang/rust/commits/c6aeda7bd52e490148ae34242f09de66d0af9841", "html_url": "https://github.com/rust-lang/rust/commit/c6aeda7bd52e490148ae34242f09de66d0af9841"}], "stats": {"total": 59, "additions": 55, "deletions": 4}, "files": [{"sha": "b6ae611da12bbf6c781a1f479c61ee3e090ea631", "filename": "clippy_lints/src/transmute.rs", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5/clippy_lints%2Fsrc%2Ftransmute.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5/clippy_lints%2Fsrc%2Ftransmute.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Ftransmute.rs?ref=2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5", "patch": "@@ -1,4 +1,6 @@\n-use crate::utils::{last_path_segment, match_def_path, paths, snippet, span_lint, span_lint_and_then, sugg};\n+use crate::utils::{\n+    is_normalizable, last_path_segment, match_def_path, paths, snippet, span_lint, span_lint_and_then, sugg,\n+};\n use if_chain::if_chain;\n use rustc::declare_lint_pass;\n use rustc::hir::*;\n@@ -639,8 +641,13 @@ fn get_type_snippet(cx: &LateContext<'_, '_>, path: &QPath<'_>, to_ref_ty: Ty<'_\n // check if the component types of the transmuted collection and the result have different ABI,\n // size or alignment\n fn is_layout_incompatible<'a, 'tcx>(cx: &LateContext<'a, 'tcx>, from: Ty<'tcx>, to: Ty<'tcx>) -> bool {\n-    let from_ty_layout = cx.tcx.layout_of(ty::ParamEnv::empty().and(from));\n-    let to_ty_layout = cx.tcx.layout_of(ty::ParamEnv::empty().and(to));\n+    let empty_param_env = ty::ParamEnv::empty();\n+    // check if `from` and `to` are normalizable to avoid ICE (#4968)\n+    if !(is_normalizable(cx, empty_param_env, from) && is_normalizable(cx, empty_param_env, to)) {\n+        return false;\n+    }\n+    let from_ty_layout = cx.tcx.layout_of(empty_param_env.and(from));\n+    let to_ty_layout = cx.tcx.layout_of(empty_param_env.and(to));\n     if let (Ok(from_layout), Ok(to_layout)) = (from_ty_layout, to_ty_layout) {\n         from_layout.size != to_layout.size || from_layout.align != to_layout.align || from_layout.abi != to_layout.abi\n     } else {"}, {"sha": "0680f627bbb6b6490fdd379e4e12f3b0991becbd", "filename": "clippy_lints/src/utils/mod.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5/clippy_lints%2Fsrc%2Futils%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5/clippy_lints%2Fsrc%2Futils%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Futils%2Fmod.rs?ref=2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5", "patch": "@@ -1111,6 +1111,15 @@ pub fn match_function_call<'a, 'tcx>(\n     None\n }\n \n+/// Checks if `Ty` is normalizable. This function is useful\n+/// to avoid crashes on `layout_of`.\n+pub fn is_normalizable<'a, 'tcx>(cx: &LateContext<'a, 'tcx>, param_env: ty::ParamEnv<'tcx>, ty: Ty<'tcx>) -> bool {\n+    cx.tcx.infer_ctxt().enter(|infcx| {\n+        let cause = rustc::traits::ObligationCause::dummy();\n+        infcx.at(&cause, param_env).normalize(&ty).is_ok()\n+    })\n+}\n+\n #[cfg(test)]\n mod test {\n     use super::{trim_multiline, without_block_comments};"}, {"sha": "a8a85b4baefb728a4cd663ee47c98bceb02aea53", "filename": "tests/ui/crashes/auxiliary/use_self_macro.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5/tests%2Fui%2Fcrashes%2Fauxiliary%2Fuse_self_macro.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5/tests%2Fui%2Fcrashes%2Fauxiliary%2Fuse_self_macro.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcrashes%2Fauxiliary%2Fuse_self_macro.rs?ref=2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5", "patch": "@@ -0,0 +1,15 @@\n+macro_rules! use_self {\n+    (\n+        impl $ty:ident {\n+            fn func(&$this:ident) {\n+                [fields($($field:ident)*)]\n+            }\n+        }\n+    ) => (\n+        impl  $ty {\n+            fn func(&$this) {\n+                let $ty { $($field),* } = $this;\n+            }\n+        }\n+    )\n+}"}, {"sha": "e0b58157590ab26ec150f156273d5df4e8c77947", "filename": "tests/ui/crashes/ice-2636.rs", "status": "renamed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5/tests%2Fui%2Fcrashes%2Fice-2636.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5/tests%2Fui%2Fcrashes%2Fice-2636.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcrashes%2Fice-2636.rs?ref=2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5", "previous_filename": "tests/ui/ice-2636.rs"}, {"sha": "aba8be4adcc16a7d32d0595857cf634b58846362", "filename": "tests/ui/crashes/ice-2636.stderr", "status": "renamed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5/tests%2Fui%2Fcrashes%2Fice-2636.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5/tests%2Fui%2Fcrashes%2Fice-2636.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcrashes%2Fice-2636.stderr?ref=2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5", "previous_filename": "tests/ui/ice-2636.stderr"}, {"sha": "47324ce18316953dcc4dd383617b2b2edc85b1fe", "filename": "tests/ui/crashes/ice-2862.rs", "status": "renamed", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5/tests%2Fui%2Fcrashes%2Fice-2862.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5/tests%2Fui%2Fcrashes%2Fice-2862.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcrashes%2Fice-2862.rs?ref=2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5", "patch": "@@ -1,6 +1,6 @@\n // run-pass\n \n-/// Test for https://github.com/rust-lang/rust-clippy/issues/2826\n+/// Test for https://github.com/rust-lang/rust-clippy/issues/2862\n \n pub trait FooMap {\n     fn map<B, F: Fn() -> B>(&self, f: F) -> B;", "previous_filename": "tests/ui/crashes/issue-2862.rs"}, {"sha": "6555c19ca6a26b5c79711eb925cd1d6b6a4cf9bb", "filename": "tests/ui/crashes/ice-360.rs", "status": "renamed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5/tests%2Fui%2Fcrashes%2Fice-360.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5/tests%2Fui%2Fcrashes%2Fice-360.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcrashes%2Fice-360.rs?ref=2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5", "previous_filename": "tests/ui/ice-360.rs"}, {"sha": "84e31eaf2e9f8d420fef2ea67486ce7dfc1ce32a", "filename": "tests/ui/crashes/ice-360.stderr", "status": "renamed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5/tests%2Fui%2Fcrashes%2Fice-360.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5/tests%2Fui%2Fcrashes%2Fice-360.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcrashes%2Fice-360.stderr?ref=2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5", "previous_filename": "tests/ui/ice-360.stderr"}, {"sha": "21c48f4749cc6f3d977e24139fac6c63a44f000f", "filename": "tests/ui/crashes/ice-3717.rs", "status": "renamed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5/tests%2Fui%2Fcrashes%2Fice-3717.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5/tests%2Fui%2Fcrashes%2Fice-3717.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcrashes%2Fice-3717.rs?ref=2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5", "previous_filename": "tests/ui/ice-3717.rs"}, {"sha": "08c53c399c26d33ed778574cc978a33b7647e973", "filename": "tests/ui/crashes/ice-3717.stderr", "status": "renamed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5/tests%2Fui%2Fcrashes%2Fice-3717.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5/tests%2Fui%2Fcrashes%2Fice-3717.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcrashes%2Fice-3717.stderr?ref=2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5", "previous_filename": "tests/ui/ice-3717.stderr"}, {"sha": "e1a142fdcb67f00053d5700ec5193bf89fc7c6a6", "filename": "tests/ui/crashes/ice-4121.rs", "status": "renamed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5/tests%2Fui%2Fcrashes%2Fice-4121.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5/tests%2Fui%2Fcrashes%2Fice-4121.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcrashes%2Fice-4121.rs?ref=2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5", "previous_filename": "tests/ui/ice-4121.rs"}, {"sha": "d9c9c2096d97c364f62fb2f686ce7e9b280b3a0c", "filename": "tests/ui/crashes/ice-4545.rs", "status": "renamed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5/tests%2Fui%2Fcrashes%2Fice-4545.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5/tests%2Fui%2Fcrashes%2Fice-4545.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcrashes%2Fice-4545.rs?ref=2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5", "previous_filename": "tests/ui/ice-4545.rs"}, {"sha": "2e7e279f847dd28f11cead520f004d2f09998018", "filename": "tests/ui/crashes/ice-4579.rs", "status": "renamed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5/tests%2Fui%2Fcrashes%2Fice-4579.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5/tests%2Fui%2Fcrashes%2Fice-4579.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcrashes%2Fice-4579.rs?ref=2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5", "previous_filename": "tests/ui/ice-4579.rs"}, {"sha": "64e8e7769412d6b09c9c4eca759250bd744b6b6d", "filename": "tests/ui/crashes/ice-4671.rs", "status": "renamed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5/tests%2Fui%2Fcrashes%2Fice-4671.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5/tests%2Fui%2Fcrashes%2Fice-4671.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcrashes%2Fice-4671.rs?ref=2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5", "previous_filename": "tests/ui/ice-4671.rs"}, {"sha": "31e53e846d54da5bdd0f1c29f92d4b1b6d34460e", "filename": "tests/ui/crashes/ice-4775.rs", "status": "renamed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5/tests%2Fui%2Fcrashes%2Fice-4775.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5/tests%2Fui%2Fcrashes%2Fice-4775.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcrashes%2Fice-4775.rs?ref=2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5", "previous_filename": "tests/ui/ice-4775.rs"}, {"sha": "3822f174598540ea2980e6469795872029d5a9e7", "filename": "tests/ui/crashes/ice-4968.rs", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5/tests%2Fui%2Fcrashes%2Fice-4968.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5/tests%2Fui%2Fcrashes%2Fice-4968.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcrashes%2Fice-4968.rs?ref=2e8c3c3e9eb81bc2be047b1d4b2f9f31b869b6f5", "patch": "@@ -0,0 +1,20 @@\n+// check-pass\n+\n+// Test for https://github.com/rust-lang/rust-clippy/issues/4968\n+\n+#![warn(clippy::unsound_collection_transmute)]\n+\n+trait Trait {\n+    type Assoc;\n+}\n+\n+use std::mem::{self, ManuallyDrop};\n+\n+#[allow(unused)]\n+fn func<T: Trait>(slice: Vec<T::Assoc>) {\n+    unsafe {\n+        let _: Vec<ManuallyDrop<T::Assoc>> = mem::transmute(slice);\n+    }\n+}\n+\n+fn main() {}"}]}