{"sha": "a3c23237674290e380c8046a430d7ea61f86c7b2", "node_id": "MDY6Q29tbWl0NzI0NzEyOmEzYzIzMjM3Njc0MjkwZTM4MGM4MDQ2YTQzMGQ3ZWE2MWY4NmM3YjI=", "commit": {"author": {"name": "Seiichi Uchida", "email": "seuchida@gmail.com", "date": "2018-01-30T01:35:35Z"}, "committer": {"name": "Seiichi Uchida", "email": "seuchida@gmail.com", "date": "2018-01-30T01:35:35Z"}, "message": "Add double comparions lint", "tree": {"sha": "3a94b056f42240143f5718a9f65a47626b7330a9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3a94b056f42240143f5718a9f65a47626b7330a9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a3c23237674290e380c8046a430d7ea61f86c7b2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a3c23237674290e380c8046a430d7ea61f86c7b2", "html_url": "https://github.com/rust-lang/rust/commit/a3c23237674290e380c8046a430d7ea61f86c7b2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a3c23237674290e380c8046a430d7ea61f86c7b2/comments", "author": {"login": "topecongiro", "id": 21980157, "node_id": "MDQ6VXNlcjIxOTgwMTU3", "avatar_url": "https://avatars.githubusercontent.com/u/21980157?v=4", "gravatar_id": "", "url": "https://api.github.com/users/topecongiro", "html_url": "https://github.com/topecongiro", "followers_url": "https://api.github.com/users/topecongiro/followers", "following_url": "https://api.github.com/users/topecongiro/following{/other_user}", "gists_url": "https://api.github.com/users/topecongiro/gists{/gist_id}", "starred_url": "https://api.github.com/users/topecongiro/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/topecongiro/subscriptions", "organizations_url": "https://api.github.com/users/topecongiro/orgs", "repos_url": "https://api.github.com/users/topecongiro/repos", "events_url": "https://api.github.com/users/topecongiro/events{/privacy}", "received_events_url": "https://api.github.com/users/topecongiro/received_events", "type": "User", "site_admin": false}, "committer": {"login": "topecongiro", "id": 21980157, "node_id": "MDQ6VXNlcjIxOTgwMTU3", "avatar_url": "https://avatars.githubusercontent.com/u/21980157?v=4", "gravatar_id": "", "url": "https://api.github.com/users/topecongiro", "html_url": "https://github.com/topecongiro", "followers_url": "https://api.github.com/users/topecongiro/followers", "following_url": "https://api.github.com/users/topecongiro/following{/other_user}", "gists_url": "https://api.github.com/users/topecongiro/gists{/gist_id}", "starred_url": "https://api.github.com/users/topecongiro/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/topecongiro/subscriptions", "organizations_url": "https://api.github.com/users/topecongiro/orgs", "repos_url": "https://api.github.com/users/topecongiro/repos", "events_url": "https://api.github.com/users/topecongiro/events{/privacy}", "received_events_url": "https://api.github.com/users/topecongiro/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c3e9ec65a1be17aa3bfb139659be34f969be3ce6", "url": "https://api.github.com/repos/rust-lang/rust/commits/c3e9ec65a1be17aa3bfb139659be34f969be3ce6", "html_url": "https://github.com/rust-lang/rust/commit/c3e9ec65a1be17aa3bfb139659be34f969be3ce6"}], "stats": {"total": 167, "additions": 167, "deletions": 0}, "files": [{"sha": "a4124883fcb65947e3477004ca3257e5ff61cdb1", "filename": "clippy_lints/src/double_comparison.rs", "status": "added", "additions": 85, "deletions": 0, "changes": 85, "blob_url": "https://github.com/rust-lang/rust/blob/a3c23237674290e380c8046a430d7ea61f86c7b2/clippy_lints%2Fsrc%2Fdouble_comparison.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a3c23237674290e380c8046a430d7ea61f86c7b2/clippy_lints%2Fsrc%2Fdouble_comparison.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fdouble_comparison.rs?ref=a3c23237674290e380c8046a430d7ea61f86c7b2", "patch": "@@ -0,0 +1,85 @@\n+//! Lint on unnecessary double comparisons. Some examples:\n+\n+use rustc::hir::*;\n+use rustc::lint::*;\n+use syntax::codemap::Span;\n+\n+use utils::{snippet, span_lint_and_sugg, SpanlessEq};\n+\n+/// **What it does:** Checks for double comparions that could be simpified to a single expression.\n+///\n+///\n+/// **Why is this bad?** Readability.\n+///\n+/// **Known problems:** None.\n+///\n+/// **Example:**\n+/// ```rust\n+/// x == y || x < y\n+/// ```\n+///\n+/// Could be written as:\n+///\n+/// ```rust\n+/// x <= y\n+/// ```\n+declare_lint! {\n+    pub DOUBLE_COMPARISONS,\n+    Deny,\n+    \"unnecessary double comparisons that can be simplified\"\n+}\n+\n+pub struct DoubleComparisonPass;\n+\n+impl LintPass for DoubleComparisonPass {\n+    fn get_lints(&self) -> LintArray {\n+        lint_array!(DOUBLE_COMPARISONS)\n+    }\n+}\n+\n+impl<'a, 'tcx> DoubleComparisonPass {\n+    fn check_binop(\n+        &self,\n+        cx: &LateContext<'a, 'tcx>,\n+        op: BinOp_,\n+        lhs: &'tcx Expr,\n+        rhs: &'tcx Expr,\n+        span: Span,\n+    ) {\n+        let (lkind, llhs, lrhs, rkind, rlhs, rrhs) = match (lhs.node.clone(), rhs.node.clone()) {\n+            (ExprBinary(lb, llhs, lrhs), ExprBinary(rb, rlhs, rrhs)) => {\n+                (lb.node, llhs, lrhs, rb.node, rlhs, rrhs)\n+            }\n+            _ => return,\n+        };\n+        let spanless_eq = SpanlessEq::new(cx).ignore_fn();\n+        if !(spanless_eq.eq_expr(&llhs, &rlhs) && spanless_eq.eq_expr(&lrhs, &rrhs)) {\n+            return;\n+        }\n+        macro_rules! lint_double_comparison {\n+            ($op:tt) => {{\n+                let lhs_str = snippet(cx, llhs.span, \"\");\n+                let rhs_str = snippet(cx, lrhs.span, \"\");\n+                let sugg = format!(\"{} {} {}\", lhs_str, stringify!($op), rhs_str);\n+                span_lint_and_sugg(cx, DOUBLE_COMPARISONS, span,\n+                                   \"This binary expression can be simplified\",\n+                                   \"try\", sugg);\n+            }}\n+        }\n+        match (op, lkind, rkind) {\n+            (BiOr, BiEq, BiLt) | (BiOr, BiLt, BiEq) => lint_double_comparison!(<=),\n+            (BiOr, BiEq, BiGt) | (BiOr, BiGt, BiEq) => lint_double_comparison!(>=),\n+            (BiOr, BiLt, BiGt) | (BiOr, BiGt, BiLt) => lint_double_comparison!(!=),\n+            (BiAnd, BiLe, BiGe) | (BiAnd, BiGe, BiLe) => lint_double_comparison!(==),\n+            _ => (),\n+        };\n+    }\n+}\n+\n+impl<'a, 'tcx> LateLintPass<'a, 'tcx> for DoubleComparisonPass {\n+    fn check_expr(&mut self, cx: &LateContext<'a, 'tcx>, expr: &'tcx Expr) {\n+        if let ExprBinary(ref kind, ref lhs, ref rhs) = expr.node {\n+            self.check_binop(cx, kind.node, lhs, rhs, expr.span);\n+        }\n+    }\n+}"}, {"sha": "5f2d34d9eaad8541db6be61390cfec39f753b0b4", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a3c23237674290e380c8046a430d7ea61f86c7b2/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a3c23237674290e380c8046a430d7ea61f86c7b2/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=a3c23237674290e380c8046a430d7ea61f86c7b2", "patch": "@@ -86,6 +86,7 @@ pub mod copies;\n pub mod cyclomatic_complexity;\n pub mod derive;\n pub mod doc;\n+pub mod double_comparison;\n pub mod double_parens;\n pub mod drop_forget_ref;\n pub mod else_if_without_else;\n@@ -369,6 +370,7 @@ pub fn register_plugins(reg: &mut rustc_plugin::Registry) {\n     reg.register_late_lint_pass(box fallible_impl_from::FallibleImplFrom);\n     reg.register_late_lint_pass(box replace_consts::ReplaceConsts);\n     reg.register_late_lint_pass(box types::UnitArg);\n+    reg.register_late_lint_pass(box double_comparison::DoubleComparisonPass);\n \n     reg.register_lint_group(\"clippy_restrictions\", vec![\n         arithmetic::FLOAT_ARITHMETIC,"}, {"sha": "2c8f116281bdd2e28a1ab01e65bbc84c2c277fe3", "filename": "tests/ui/double_comparison.rs", "status": "added", "additions": 28, "deletions": 0, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/a3c23237674290e380c8046a430d7ea61f86c7b2/tests%2Fui%2Fdouble_comparison.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a3c23237674290e380c8046a430d7ea61f86c7b2/tests%2Fui%2Fdouble_comparison.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fdouble_comparison.rs?ref=a3c23237674290e380c8046a430d7ea61f86c7b2", "patch": "@@ -0,0 +1,28 @@\n+fn main() {\n+    let x = 1;\n+    let y = 2;\n+    if x == y || x < y {\n+        // do something\n+    }\n+    if x < y || x == y {\n+        // do something\n+    }\n+    if x == y || x > y {\n+        // do something\n+    }\n+    if x > y || x == y {\n+        // do something\n+    }\n+    if x < y || x > y {\n+        // do something\n+    }\n+    if x > y || x < y {\n+        // do something\n+    }\n+    if x <= y && x >= y {\n+        // do something\n+    }\n+    if x >= y && x <= y {\n+        // do something\n+    }\n+}"}, {"sha": "a97b0a246af355d15f08ae546633841757aa64cc", "filename": "tests/ui/double_comparison.stderr", "status": "added", "additions": 52, "deletions": 0, "changes": 52, "blob_url": "https://github.com/rust-lang/rust/blob/a3c23237674290e380c8046a430d7ea61f86c7b2/tests%2Fui%2Fdouble_comparison.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/a3c23237674290e380c8046a430d7ea61f86c7b2/tests%2Fui%2Fdouble_comparison.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fdouble_comparison.stderr?ref=a3c23237674290e380c8046a430d7ea61f86c7b2", "patch": "@@ -0,0 +1,52 @@\n+error: This binary expression can be simplified\n+ --> $DIR/double_comparison.rs:4:8\n+  |\n+4 |     if x == y || x < y {\n+  |        ^^^^^^^^^^^^^^^ help: try: `x <= y`\n+  |\n+  = note: #[deny(double_comparisons)] on by default\n+\n+error: This binary expression can be simplified\n+ --> $DIR/double_comparison.rs:7:8\n+  |\n+7 |     if x < y || x == y {\n+  |        ^^^^^^^^^^^^^^^ help: try: `x <= y`\n+\n+error: This binary expression can be simplified\n+  --> $DIR/double_comparison.rs:10:8\n+   |\n+10 |     if x == y || x > y {\n+   |        ^^^^^^^^^^^^^^^ help: try: `x >= y`\n+\n+error: This binary expression can be simplified\n+  --> $DIR/double_comparison.rs:13:8\n+   |\n+13 |     if x > y || x == y {\n+   |        ^^^^^^^^^^^^^^^ help: try: `x >= y`\n+\n+error: This binary expression can be simplified\n+  --> $DIR/double_comparison.rs:16:8\n+   |\n+16 |     if x < y || x > y {\n+   |        ^^^^^^^^^^^^^^ help: try: `x != y`\n+\n+error: This binary expression can be simplified\n+  --> $DIR/double_comparison.rs:19:8\n+   |\n+19 |     if x > y || x < y {\n+   |        ^^^^^^^^^^^^^^ help: try: `x != y`\n+\n+error: This binary expression can be simplified\n+  --> $DIR/double_comparison.rs:22:8\n+   |\n+22 |     if x <= y && x >= y {\n+   |        ^^^^^^^^^^^^^^^^ help: try: `x == y`\n+\n+error: This binary expression can be simplified\n+  --> $DIR/double_comparison.rs:25:8\n+   |\n+25 |     if x >= y && x <= y {\n+   |        ^^^^^^^^^^^^^^^^ help: try: `x == y`\n+\n+error: aborting due to 8 previous errors\n+"}]}