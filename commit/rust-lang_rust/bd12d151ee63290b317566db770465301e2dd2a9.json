{"sha": "bd12d151ee63290b317566db770465301e2dd2a9", "node_id": "C_kwDOAAsO6NoAKGJkMTJkMTUxZWU2MzI5MGIzMTc1NjZkYjc3MDQ2NTMwMWUyZGQyYTk", "commit": {"author": {"name": "Yiming Lei", "email": "yiming.lei@futurewei.com", "date": "2022-12-16T06:25:11Z"}, "committer": {"name": "Yiming Lei", "email": "yiming.lei@futurewei.com", "date": "2022-12-19T16:38:05Z"}, "message": "add function to tell if the current ambiguity error matches a previous one in ambiguity_errors\nif 2 errors of the kind and ident and span of the ident, b1, b2 and misc1 misc2 are the same\nthen these 2 ambiguity errors matched\nprevent identical ambiguity error from pushing into vector of ambiguity_errors\nthis will fix #105177", "tree": {"sha": "c831c993781eaceeace9a04cf35c9023db0253d9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c831c993781eaceeace9a04cf35c9023db0253d9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bd12d151ee63290b317566db770465301e2dd2a9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bd12d151ee63290b317566db770465301e2dd2a9", "html_url": "https://github.com/rust-lang/rust/commit/bd12d151ee63290b317566db770465301e2dd2a9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bd12d151ee63290b317566db770465301e2dd2a9/comments", "author": null, "committer": null, "parents": [{"sha": "ba64ba8b0dfd57f7d6d7399d0df7ded37d2af18d", "url": "https://api.github.com/repos/rust-lang/rust/commits/ba64ba8b0dfd57f7d6d7399d0df7ded37d2af18d", "html_url": "https://github.com/rust-lang/rust/commit/ba64ba8b0dfd57f7d6d7399d0df7ded37d2af18d"}], "stats": {"total": 88, "additions": 32, "deletions": 56}, "files": [{"sha": "5d0b4c0419f0a9c6d2ca54d90419b77c76e8d94e", "filename": "compiler/rustc_resolve/src/lib.rs", "status": "modified", "additions": 24, "deletions": 2, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/bd12d151ee63290b317566db770465301e2dd2a9/compiler%2Frustc_resolve%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bd12d151ee63290b317566db770465301e2dd2a9/compiler%2Frustc_resolve%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Flib.rs?ref=bd12d151ee63290b317566db770465301e2dd2a9", "patch": "@@ -1686,21 +1686,43 @@ impl<'a> Resolver<'a> {\n             .or_insert_with(|| self.arenas.alloc_name_resolution())\n     }\n \n+    // Test if AmbiguityError ambi is any identical to any one inside ambiguity_errors\n+    fn matches_previous_ambiguity_error(&mut self, ambi: &AmbiguityError<'_>) -> bool {\n+        for ambiguity_error in &self.ambiguity_errors {\n+            // if the span location and ident as well as its span are the same\n+            if ambiguity_error.kind == ambi.kind\n+                && ambiguity_error.ident == ambi.ident\n+                && ambiguity_error.ident.span == ambi.ident.span\n+                && ambiguity_error.b1.span == ambi.b1.span\n+                && ambiguity_error.b2.span == ambi.b2.span\n+                && ambiguity_error.misc1 == ambi.misc1\n+                && ambiguity_error.misc2 == ambi.misc2\n+            {\n+                return true;\n+            }\n+        }\n+        false\n+    }\n+\n     fn record_use(\n         &mut self,\n         ident: Ident,\n         used_binding: &'a NameBinding<'a>,\n         is_lexical_scope: bool,\n     ) {\n         if let Some((b2, kind)) = used_binding.ambiguity {\n-            self.ambiguity_errors.push(AmbiguityError {\n+            let ambiguity_error = AmbiguityError {\n                 kind,\n                 ident,\n                 b1: used_binding,\n                 b2,\n                 misc1: AmbiguityErrorMisc::None,\n                 misc2: AmbiguityErrorMisc::None,\n-            });\n+            };\n+            if !self.matches_previous_ambiguity_error(&ambiguity_error) {\n+                // avoid dumplicated span information to be emitt out\n+                self.ambiguity_errors.push(ambiguity_error);\n+            }\n         }\n         if let NameBindingKind::Import { import, binding, ref used } = used_binding.kind {\n             // Avoid marking `extern crate` items that refer to a name from extern prelude,"}, {"sha": "29e9b8ec841f54661233112fcbb236606490a9df", "filename": "src/test/ui/imports/local-modularized-tricky-fail-1.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/bd12d151ee63290b317566db770465301e2dd2a9/src%2Ftest%2Fui%2Fimports%2Flocal-modularized-tricky-fail-1.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bd12d151ee63290b317566db770465301e2dd2a9/src%2Ftest%2Fui%2Fimports%2Flocal-modularized-tricky-fail-1.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fimports%2Flocal-modularized-tricky-fail-1.rs?ref=bd12d151ee63290b317566db770465301e2dd2a9", "patch": "@@ -26,7 +26,6 @@ mod inner1 {\n }\n \n exported!(); //~ ERROR `exported` is ambiguous\n-             //~| ERROR `exported` is ambiguous\n \n mod inner2 {\n     define_exported!();"}, {"sha": "20eadaaaa56b8732012505ffba5928e771275fd2", "filename": "src/test/ui/imports/local-modularized-tricky-fail-1.stderr", "status": "modified", "additions": 3, "deletions": 28, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/bd12d151ee63290b317566db770465301e2dd2a9/src%2Ftest%2Fui%2Fimports%2Flocal-modularized-tricky-fail-1.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/bd12d151ee63290b317566db770465301e2dd2a9/src%2Ftest%2Fui%2Fimports%2Flocal-modularized-tricky-fail-1.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fimports%2Flocal-modularized-tricky-fail-1.stderr?ref=bd12d151ee63290b317566db770465301e2dd2a9", "patch": "@@ -23,33 +23,8 @@ LL | use inner1::*;\n    = help: consider adding an explicit import of `exported` to disambiguate\n    = note: this error originates in the macro `define_exported` (in Nightly builds, run with -Z macro-backtrace for more info)\n \n-error[E0659]: `exported` is ambiguous\n-  --> $DIR/local-modularized-tricky-fail-1.rs:28:1\n-   |\n-LL | exported!();\n-   | ^^^^^^^^ ambiguous name\n-   |\n-   = note: ambiguous because of a conflict between a name from a glob import and a macro-expanded name in the same module during import or macro resolution\n-note: `exported` could refer to the macro defined here\n-  --> $DIR/local-modularized-tricky-fail-1.rs:5:5\n-   |\n-LL | /     macro_rules! exported {\n-LL | |         () => ()\n-LL | |     }\n-   | |_____^\n-...\n-LL |       define_exported!();\n-   |       ------------------ in this macro invocation\n-note: `exported` could also refer to the macro imported here\n-  --> $DIR/local-modularized-tricky-fail-1.rs:22:5\n-   |\n-LL | use inner1::*;\n-   |     ^^^^^^^^^\n-   = help: consider adding an explicit import of `exported` to disambiguate\n-   = note: this error originates in the macro `define_exported` (in Nightly builds, run with -Z macro-backtrace for more info)\n-\n error[E0659]: `panic` is ambiguous\n-  --> $DIR/local-modularized-tricky-fail-1.rs:36:5\n+  --> $DIR/local-modularized-tricky-fail-1.rs:35:5\n    |\n LL |     panic!();\n    |     ^^^^^ ambiguous name\n@@ -70,7 +45,7 @@ LL |       define_panic!();\n    = note: this error originates in the macro `define_panic` (in Nightly builds, run with -Z macro-backtrace for more info)\n \n error[E0659]: `include` is ambiguous\n-  --> $DIR/local-modularized-tricky-fail-1.rs:47:1\n+  --> $DIR/local-modularized-tricky-fail-1.rs:46:1\n    |\n LL | include!();\n    | ^^^^^^^ ambiguous name\n@@ -90,6 +65,6 @@ LL |       define_include!();\n    = help: use `crate::include` to refer to this macro unambiguously\n    = note: this error originates in the macro `define_include` (in Nightly builds, run with -Z macro-backtrace for more info)\n \n-error: aborting due to 4 previous errors\n+error: aborting due to 3 previous errors\n \n For more information about this error, try `rustc --explain E0659`."}, {"sha": "f2a22ad620b1111004fe4893436494d2b13fe7a8", "filename": "src/test/ui/imports/macros.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/bd12d151ee63290b317566db770465301e2dd2a9/src%2Ftest%2Fui%2Fimports%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bd12d151ee63290b317566db770465301e2dd2a9/src%2Ftest%2Fui%2Fimports%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fimports%2Fmacros.rs?ref=bd12d151ee63290b317566db770465301e2dd2a9", "patch": "@@ -14,7 +14,6 @@ mod m1 {\n mod m2 {\n     use two_macros::*;\n     m! { //~ ERROR ambiguous\n-         //~| ERROR ambiguous\n         use foo::m;\n     }\n }"}, {"sha": "e34e5359b48faac1832a308ff7d61e036de5a1bb", "filename": "src/test/ui/imports/macros.stderr", "status": "modified", "additions": 5, "deletions": 24, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/bd12d151ee63290b317566db770465301e2dd2a9/src%2Ftest%2Fui%2Fimports%2Fmacros.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/bd12d151ee63290b317566db770465301e2dd2a9/src%2Ftest%2Fui%2Fimports%2Fmacros.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fimports%2Fmacros.stderr?ref=bd12d151ee63290b317566db770465301e2dd2a9", "patch": "@@ -6,7 +6,7 @@ LL |     m! {\n    |\n    = note: ambiguous because of a conflict between a name from a glob import and a macro-expanded name in the same module during import or macro resolution\n note: `m` could refer to the macro imported here\n-  --> $DIR/macros.rs:18:13\n+  --> $DIR/macros.rs:17:13\n    |\n LL |         use foo::m;\n    |             ^^^^^^\n@@ -18,43 +18,24 @@ LL |     use two_macros::*;\n    = help: consider adding an explicit import of `m` to disambiguate\n \n error[E0659]: `m` is ambiguous\n-  --> $DIR/macros.rs:16:5\n-   |\n-LL |     m! {\n-   |     ^ ambiguous name\n-   |\n-   = note: ambiguous because of a conflict between a name from a glob import and a macro-expanded name in the same module during import or macro resolution\n-note: `m` could refer to the macro imported here\n-  --> $DIR/macros.rs:18:13\n-   |\n-LL |         use foo::m;\n-   |             ^^^^^^\n-note: `m` could also refer to the macro imported here\n-  --> $DIR/macros.rs:15:9\n-   |\n-LL |     use two_macros::*;\n-   |         ^^^^^^^^^^^^^\n-   = help: consider adding an explicit import of `m` to disambiguate\n-\n-error[E0659]: `m` is ambiguous\n-  --> $DIR/macros.rs:30:9\n+  --> $DIR/macros.rs:29:9\n    |\n LL |         m! {\n    |         ^ ambiguous name\n    |\n    = note: ambiguous because of a conflict between a macro-expanded name and a less macro-expanded name from outer scope during import or macro resolution\n note: `m` could refer to the macro imported here\n-  --> $DIR/macros.rs:31:17\n+  --> $DIR/macros.rs:30:17\n    |\n LL |             use two_macros::n as m;\n    |                 ^^^^^^^^^^^^^^^^^^\n note: `m` could also refer to the macro imported here\n-  --> $DIR/macros.rs:23:9\n+  --> $DIR/macros.rs:22:9\n    |\n LL |     use two_macros::m;\n    |         ^^^^^^^^^^^^^\n    = help: use `self::m` to refer to this macro unambiguously\n \n-error: aborting due to 3 previous errors\n+error: aborting due to 2 previous errors\n \n For more information about this error, try `rustc --explain E0659`."}]}