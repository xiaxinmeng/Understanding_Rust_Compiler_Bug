{"sha": "e585b71d9e3a9b95b5e8c3f01e0b3354b2be3ca6", "node_id": "C_kwDOAAsO6NoAKGU1ODViNzFkOWUzYTliOTViNWU4YzNmMDFlMGIzMzU0YjJiZTNjYTY", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-09-14T20:09:49Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-09-14T20:09:49Z"}, "message": "Auto merge of #9475 - Nemo157:mod-files-remap, r=xFrednet\n\nMake module-style lints resilient to --remap-path-prefix\n\nchangelog: [`self_named_module_files`], [`mod_module_files`]: Make module-style lints resilient to `--remap-path-prefix`\n\nWithout this if a user has configured `--remap-path-prefix` to be used for a prefix containing the current source directory the lints would silently fail to generate a warning.", "tree": {"sha": "36aaf40fd616fd52f4336cd59e05597949dd692b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/36aaf40fd616fd52f4336cd59e05597949dd692b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e585b71d9e3a9b95b5e8c3f01e0b3354b2be3ca6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e585b71d9e3a9b95b5e8c3f01e0b3354b2be3ca6", "html_url": "https://github.com/rust-lang/rust/commit/e585b71d9e3a9b95b5e8c3f01e0b3354b2be3ca6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e585b71d9e3a9b95b5e8c3f01e0b3354b2be3ca6/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "bae4699a9f6afc1c3c2e295e2ffa7d309f96f84d", "url": "https://api.github.com/repos/rust-lang/rust/commits/bae4699a9f6afc1c3c2e295e2ffa7d309f96f84d", "html_url": "https://github.com/rust-lang/rust/commit/bae4699a9f6afc1c3c2e295e2ffa7d309f96f84d"}, {"sha": "e9722feef35587a83a359dbc22bf515fae4ccf66", "url": "https://api.github.com/repos/rust-lang/rust/commits/e9722feef35587a83a359dbc22bf515fae4ccf66", "html_url": "https://github.com/rust-lang/rust/commit/e9722feef35587a83a359dbc22bf515fae4ccf66"}], "stats": {"total": 35, "additions": 32, "deletions": 3}, "files": [{"sha": "22071ab3044f4f7a8271f3df4954e4914c46d4d0", "filename": "clippy_lints/src/module_style.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/e585b71d9e3a9b95b5e8c3f01e0b3354b2be3ca6/clippy_lints%2Fsrc%2Fmodule_style.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e585b71d9e3a9b95b5e8c3f01e0b3354b2be3ca6/clippy_lints%2Fsrc%2Fmodule_style.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmodule_style.rs?ref=e585b71d9e3a9b95b5e8c3f01e0b3354b2be3ca6", "patch": "@@ -2,7 +2,7 @@ use rustc_ast::ast;\n use rustc_data_structures::fx::{FxHashMap, FxHashSet};\n use rustc_lint::{EarlyContext, EarlyLintPass, Level, LintContext};\n use rustc_session::{declare_tool_lint, impl_lint_pass};\n-use rustc_span::{FileName, RealFileName, SourceFile, Span, SyntaxContext};\n+use rustc_span::{FileName, SourceFile, Span, SyntaxContext};\n use std::ffi::OsStr;\n use std::path::{Component, Path};\n \n@@ -79,7 +79,7 @@ impl EarlyLintPass for ModStyle {\n \n         let files = cx.sess().source_map().files();\n \n-        let RealFileName::LocalPath(trim_to_src) = &cx.sess().opts.working_dir else { return };\n+        let Some(trim_to_src) = cx.sess().opts.working_dir.local_path() else { return };\n \n         // `folder_segments` is all unique folder path segments `path/to/foo.rs` gives\n         // `[path, to]` but not foo\n@@ -90,7 +90,7 @@ impl EarlyLintPass for ModStyle {\n         // `{ foo => path/to/foo.rs, .. }\n         let mut file_map = FxHashMap::default();\n         for file in files.iter() {\n-            if let FileName::Real(RealFileName::LocalPath(lp)) = &file.name {\n+            if let FileName::Real(name) = &file.name && let Some(lp) = name.local_path() {\n                 let path = if lp.is_relative() {\n                     lp\n                 } else if let Ok(relative) = lp.strip_prefix(trim_to_src) {"}, {"sha": "a822fad388f56fa635624219490149a1bf00c363", "filename": "tests/ui-cargo/module_style/fail_mod_remap/Cargo.toml", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/e585b71d9e3a9b95b5e8c3f01e0b3354b2be3ca6/tests%2Fui-cargo%2Fmodule_style%2Ffail_mod_remap%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/e585b71d9e3a9b95b5e8c3f01e0b3354b2be3ca6/tests%2Fui-cargo%2Fmodule_style%2Ffail_mod_remap%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui-cargo%2Fmodule_style%2Ffail_mod_remap%2FCargo.toml?ref=e585b71d9e3a9b95b5e8c3f01e0b3354b2be3ca6", "patch": "@@ -0,0 +1,9 @@\n+[package]\n+name = \"fail-mod-remap\"\n+version = \"0.1.0\"\n+edition = \"2018\"\n+publish = false\n+\n+# See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html\n+\n+[dependencies]"}, {"sha": "509aad18622b5d990ce0a49780696d6e7147c15b", "filename": "tests/ui-cargo/module_style/fail_mod_remap/src/bad.rs", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/e585b71d9e3a9b95b5e8c3f01e0b3354b2be3ca6/tests%2Fui-cargo%2Fmodule_style%2Ffail_mod_remap%2Fsrc%2Fbad.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e585b71d9e3a9b95b5e8c3f01e0b3354b2be3ca6/tests%2Fui-cargo%2Fmodule_style%2Ffail_mod_remap%2Fsrc%2Fbad.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui-cargo%2Fmodule_style%2Ffail_mod_remap%2Fsrc%2Fbad.rs?ref=e585b71d9e3a9b95b5e8c3f01e0b3354b2be3ca6", "patch": "@@ -0,0 +1 @@\n+pub mod inner;"}, {"sha": "8b137891791fe96927ad78e64b0aad7bded08bdc", "filename": "tests/ui-cargo/module_style/fail_mod_remap/src/bad/inner.rs", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/e585b71d9e3a9b95b5e8c3f01e0b3354b2be3ca6/tests%2Fui-cargo%2Fmodule_style%2Ffail_mod_remap%2Fsrc%2Fbad%2Finner.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e585b71d9e3a9b95b5e8c3f01e0b3354b2be3ca6/tests%2Fui-cargo%2Fmodule_style%2Ffail_mod_remap%2Fsrc%2Fbad%2Finner.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui-cargo%2Fmodule_style%2Ffail_mod_remap%2Fsrc%2Fbad%2Finner.rs?ref=e585b71d9e3a9b95b5e8c3f01e0b3354b2be3ca6", "patch": "@@ -0,0 +1 @@\n+"}, {"sha": "ba4c8c873dd55e5d90a246690e98c1696ef8d6a8", "filename": "tests/ui-cargo/module_style/fail_mod_remap/src/main.rs", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/e585b71d9e3a9b95b5e8c3f01e0b3354b2be3ca6/tests%2Fui-cargo%2Fmodule_style%2Ffail_mod_remap%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e585b71d9e3a9b95b5e8c3f01e0b3354b2be3ca6/tests%2Fui-cargo%2Fmodule_style%2Ffail_mod_remap%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui-cargo%2Fmodule_style%2Ffail_mod_remap%2Fsrc%2Fmain.rs?ref=e585b71d9e3a9b95b5e8c3f01e0b3354b2be3ca6", "patch": "@@ -0,0 +1,7 @@\n+// compile-flags: --remap-path-prefix {{src-base}}=/remapped\n+\n+#![warn(clippy::self_named_module_files)]\n+\n+mod bad;\n+\n+fn main() {}"}, {"sha": "46991ff662e530780f9c7b4c8530aa11ab4669b1", "filename": "tests/ui-cargo/module_style/fail_mod_remap/src/main.stderr", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/e585b71d9e3a9b95b5e8c3f01e0b3354b2be3ca6/tests%2Fui-cargo%2Fmodule_style%2Ffail_mod_remap%2Fsrc%2Fmain.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/e585b71d9e3a9b95b5e8c3f01e0b3354b2be3ca6/tests%2Fui-cargo%2Fmodule_style%2Ffail_mod_remap%2Fsrc%2Fmain.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui-cargo%2Fmodule_style%2Ffail_mod_remap%2Fsrc%2Fmain.stderr?ref=e585b71d9e3a9b95b5e8c3f01e0b3354b2be3ca6", "patch": "@@ -0,0 +1,11 @@\n+error: `mod.rs` files are required, found `bad.rs`\n+  --> /remapped/module_style/fail_mod_remap/src/bad.rs:1:1\n+   |\n+LL | pub mod inner;\n+   | ^\n+   |\n+   = note: `-D clippy::self-named-module-files` implied by `-D warnings`\n+   = help: move `bad.rs` to `bad/mod.rs`\n+\n+error: aborting due to previous error\n+"}]}