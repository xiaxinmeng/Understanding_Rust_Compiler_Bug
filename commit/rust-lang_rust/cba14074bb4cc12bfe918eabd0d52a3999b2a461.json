{"sha": "cba14074bb4cc12bfe918eabd0d52a3999b2a461", "node_id": "C_kwDOAAsO6NoAKGNiYTE0MDc0YmI0Y2MxMmJmZTkxOGVhYmQwZDUyYTM5OTliMmE0NjE", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-05-10T10:28:38Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-05-10T10:28:38Z"}, "message": "Auto merge of #111401 - ChrisDenton:no-windows-allowed, r=workingjubilee\n\nDon't force include Windows goop when documenting\n\nWhy do we need to include all the windows bits on non-windows platforms? Let's try not doing that.\n\nPossible alternative to #111394, if it works.", "tree": {"sha": "c1a3da8e06691338f647e5b5bdda279e1800942e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c1a3da8e06691338f647e5b5bdda279e1800942e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cba14074bb4cc12bfe918eabd0d52a3999b2a461", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cba14074bb4cc12bfe918eabd0d52a3999b2a461", "html_url": "https://github.com/rust-lang/rust/commit/cba14074bb4cc12bfe918eabd0d52a3999b2a461", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cba14074bb4cc12bfe918eabd0d52a3999b2a461/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "25444e5a2e7293dbb4932df1301b9be4222244fe", "url": "https://api.github.com/repos/rust-lang/rust/commits/25444e5a2e7293dbb4932df1301b9be4222244fe", "html_url": "https://github.com/rust-lang/rust/commit/25444e5a2e7293dbb4932df1301b9be4222244fe"}, {"sha": "d0766079833e70b25f081db59105888b9e986f18", "url": "https://api.github.com/repos/rust-lang/rust/commits/d0766079833e70b25f081db59105888b9e986f18", "html_url": "https://github.com/rust-lang/rust/commit/d0766079833e70b25f081db59105888b9e986f18"}], "stats": {"total": 99, "additions": 40, "deletions": 59}, "files": [{"sha": "280757a41a2ba635b7f3c3de3274f155d189a71f", "filename": "library/std/src/os/windows/io/handle.rs", "status": "modified", "additions": 9, "deletions": 9, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/cba14074bb4cc12bfe918eabd0d52a3999b2a461/library%2Fstd%2Fsrc%2Fos%2Fwindows%2Fio%2Fhandle.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cba14074bb4cc12bfe918eabd0d52a3999b2a461/library%2Fstd%2Fsrc%2Fos%2Fwindows%2Fio%2Fhandle.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fos%2Fwindows%2Fio%2Fhandle.rs?ref=cba14074bb4cc12bfe918eabd0d52a3999b2a461", "patch": "@@ -9,7 +9,7 @@ use crate::io;\n use crate::marker::PhantomData;\n use crate::mem::forget;\n use crate::ptr;\n-use crate::sys::c;\n+use crate::sys;\n use crate::sys::cvt;\n use crate::sys_common::{AsInner, FromInner, IntoInner};\n \n@@ -190,14 +190,14 @@ impl BorrowedHandle<'_> {\n     /// object as the existing `BorrowedHandle` instance.\n     #[stable(feature = \"io_safety\", since = \"1.63.0\")]\n     pub fn try_clone_to_owned(&self) -> crate::io::Result<OwnedHandle> {\n-        self.duplicate(0, false, c::DUPLICATE_SAME_ACCESS)\n+        self.duplicate(0, false, sys::c::DUPLICATE_SAME_ACCESS)\n     }\n \n     pub(crate) fn duplicate(\n         &self,\n-        access: c::DWORD,\n+        access: u32,\n         inherit: bool,\n-        options: c::DWORD,\n+        options: u32,\n     ) -> io::Result<OwnedHandle> {\n         let handle = self.as_raw_handle();\n \n@@ -211,14 +211,14 @@ impl BorrowedHandle<'_> {\n \n         let mut ret = ptr::null_mut();\n         cvt(unsafe {\n-            let cur_proc = c::GetCurrentProcess();\n-            c::DuplicateHandle(\n+            let cur_proc = sys::c::GetCurrentProcess();\n+            sys::c::DuplicateHandle(\n                 cur_proc,\n                 handle,\n                 cur_proc,\n                 &mut ret,\n                 access,\n-                inherit as c::BOOL,\n+                inherit as sys::c::BOOL,\n                 options,\n             )\n         })?;\n@@ -233,7 +233,7 @@ impl TryFrom<HandleOrInvalid> for OwnedHandle {\n     #[inline]\n     fn try_from(handle_or_invalid: HandleOrInvalid) -> Result<Self, InvalidHandleError> {\n         let owned_handle = handle_or_invalid.0;\n-        if owned_handle.handle == c::INVALID_HANDLE_VALUE {\n+        if owned_handle.handle == sys::c::INVALID_HANDLE_VALUE {\n             // Don't call `CloseHandle`; it'd be harmless, except that it could\n             // overwrite the `GetLastError` error.\n             forget(owned_handle);\n@@ -365,7 +365,7 @@ impl Drop for OwnedHandle {\n     #[inline]\n     fn drop(&mut self) {\n         unsafe {\n-            let _ = c::CloseHandle(self.handle);\n+            let _ = sys::c::CloseHandle(self.handle);\n         }\n     }\n }"}, {"sha": "1759e2e7f3f91e31b1b6784770e70927154c0391", "filename": "library/std/src/os/windows/io/raw.rs", "status": "modified", "additions": 8, "deletions": 9, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/cba14074bb4cc12bfe918eabd0d52a3999b2a461/library%2Fstd%2Fsrc%2Fos%2Fwindows%2Fio%2Fraw.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cba14074bb4cc12bfe918eabd0d52a3999b2a461/library%2Fstd%2Fsrc%2Fos%2Fwindows%2Fio%2Fraw.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fos%2Fwindows%2Fio%2Fraw.rs?ref=cba14074bb4cc12bfe918eabd0d52a3999b2a461", "patch": "@@ -11,7 +11,6 @@ use crate::os::windows::io::{OwnedHandle, OwnedSocket};\n use crate::os::windows::raw;\n use crate::ptr;\n use crate::sys;\n-use crate::sys::c;\n use crate::sys_common::{self, AsInner, FromInner, IntoInner};\n \n /// Raw HANDLEs.\n@@ -104,42 +103,42 @@ impl AsRawHandle for fs::File {\n #[stable(feature = \"asraw_stdio\", since = \"1.21.0\")]\n impl AsRawHandle for io::Stdin {\n     fn as_raw_handle(&self) -> RawHandle {\n-        stdio_handle(unsafe { c::GetStdHandle(c::STD_INPUT_HANDLE) as RawHandle })\n+        stdio_handle(unsafe { sys::c::GetStdHandle(sys::c::STD_INPUT_HANDLE) as RawHandle })\n     }\n }\n \n #[stable(feature = \"asraw_stdio\", since = \"1.21.0\")]\n impl AsRawHandle for io::Stdout {\n     fn as_raw_handle(&self) -> RawHandle {\n-        stdio_handle(unsafe { c::GetStdHandle(c::STD_OUTPUT_HANDLE) as RawHandle })\n+        stdio_handle(unsafe { sys::c::GetStdHandle(sys::c::STD_OUTPUT_HANDLE) as RawHandle })\n     }\n }\n \n #[stable(feature = \"asraw_stdio\", since = \"1.21.0\")]\n impl AsRawHandle for io::Stderr {\n     fn as_raw_handle(&self) -> RawHandle {\n-        stdio_handle(unsafe { c::GetStdHandle(c::STD_ERROR_HANDLE) as RawHandle })\n+        stdio_handle(unsafe { sys::c::GetStdHandle(sys::c::STD_ERROR_HANDLE) as RawHandle })\n     }\n }\n \n #[stable(feature = \"asraw_stdio_locks\", since = \"1.35.0\")]\n impl<'a> AsRawHandle for io::StdinLock<'a> {\n     fn as_raw_handle(&self) -> RawHandle {\n-        stdio_handle(unsafe { c::GetStdHandle(c::STD_INPUT_HANDLE) as RawHandle })\n+        stdio_handle(unsafe { sys::c::GetStdHandle(sys::c::STD_INPUT_HANDLE) as RawHandle })\n     }\n }\n \n #[stable(feature = \"asraw_stdio_locks\", since = \"1.35.0\")]\n impl<'a> AsRawHandle for io::StdoutLock<'a> {\n     fn as_raw_handle(&self) -> RawHandle {\n-        stdio_handle(unsafe { c::GetStdHandle(c::STD_OUTPUT_HANDLE) as RawHandle })\n+        stdio_handle(unsafe { sys::c::GetStdHandle(sys::c::STD_OUTPUT_HANDLE) as RawHandle })\n     }\n }\n \n #[stable(feature = \"asraw_stdio_locks\", since = \"1.35.0\")]\n impl<'a> AsRawHandle for io::StderrLock<'a> {\n     fn as_raw_handle(&self) -> RawHandle {\n-        stdio_handle(unsafe { c::GetStdHandle(c::STD_ERROR_HANDLE) as RawHandle })\n+        stdio_handle(unsafe { sys::c::GetStdHandle(sys::c::STD_ERROR_HANDLE) as RawHandle })\n     }\n }\n \n@@ -152,14 +151,14 @@ fn stdio_handle(raw: RawHandle) -> RawHandle {\n     // console. In that case, return null to the user, which is consistent\n     // with what they'd get in the parent, and which avoids the problem that\n     // `INVALID_HANDLE_VALUE` aliases the current process handle.\n-    if raw == c::INVALID_HANDLE_VALUE { ptr::null_mut() } else { raw }\n+    if raw == sys::c::INVALID_HANDLE_VALUE { ptr::null_mut() } else { raw }\n }\n \n #[stable(feature = \"from_raw_os\", since = \"1.1.0\")]\n impl FromRawHandle for fs::File {\n     #[inline]\n     unsafe fn from_raw_handle(handle: RawHandle) -> fs::File {\n-        let handle = handle as c::HANDLE;\n+        let handle = handle as sys::c::HANDLE;\n         fs::File::from_inner(sys::fs::File::from_inner(FromInner::from_inner(\n             OwnedHandle::from_raw_handle(handle),\n         )))"}, {"sha": "eb6097a89a61e745e2a149c97a8ea2fac1d65a41", "filename": "library/std/src/os/windows/io/socket.rs", "status": "modified", "additions": 23, "deletions": 16, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/cba14074bb4cc12bfe918eabd0d52a3999b2a461/library%2Fstd%2Fsrc%2Fos%2Fwindows%2Fio%2Fsocket.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cba14074bb4cc12bfe918eabd0d52a3999b2a461/library%2Fstd%2Fsrc%2Fos%2Fwindows%2Fio%2Fsocket.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fos%2Fwindows%2Fio%2Fsocket.rs?ref=cba14074bb4cc12bfe918eabd0d52a3999b2a461", "patch": "@@ -9,7 +9,6 @@ use crate::marker::PhantomData;\n use crate::mem;\n use crate::mem::forget;\n use crate::sys;\n-use crate::sys::c;\n #[cfg(not(target_vendor = \"uwp\"))]\n use crate::sys::cvt;\n \n@@ -76,7 +75,7 @@ impl BorrowedSocket<'_> {\n     #[rustc_const_stable(feature = \"io_safety\", since = \"1.63.0\")]\n     #[stable(feature = \"io_safety\", since = \"1.63.0\")]\n     pub const unsafe fn borrow_raw(socket: RawSocket) -> Self {\n-        assert!(socket != c::INVALID_SOCKET as RawSocket);\n+        assert!(socket != sys::c::INVALID_SOCKET as RawSocket);\n         Self { socket, _phantom: PhantomData }\n     }\n }\n@@ -94,7 +93,11 @@ impl OwnedSocket {\n     #[cfg(not(target_vendor = \"uwp\"))]\n     pub(crate) fn set_no_inherit(&self) -> io::Result<()> {\n         cvt(unsafe {\n-            c::SetHandleInformation(self.as_raw_socket() as c::HANDLE, c::HANDLE_FLAG_INHERIT, 0)\n+            sys::c::SetHandleInformation(\n+                self.as_raw_socket() as sys::c::HANDLE,\n+                sys::c::HANDLE_FLAG_INHERIT,\n+                0,\n+            )\n         })\n         .map(drop)\n     }\n@@ -110,43 +113,47 @@ impl BorrowedSocket<'_> {\n     /// object as the existing `BorrowedSocket` instance.\n     #[stable(feature = \"io_safety\", since = \"1.63.0\")]\n     pub fn try_clone_to_owned(&self) -> io::Result<OwnedSocket> {\n-        let mut info = unsafe { mem::zeroed::<c::WSAPROTOCOL_INFOW>() };\n+        let mut info = unsafe { mem::zeroed::<sys::c::WSAPROTOCOL_INFOW>() };\n         let result = unsafe {\n-            c::WSADuplicateSocketW(self.as_raw_socket(), c::GetCurrentProcessId(), &mut info)\n+            sys::c::WSADuplicateSocketW(\n+                self.as_raw_socket(),\n+                sys::c::GetCurrentProcessId(),\n+                &mut info,\n+            )\n         };\n         sys::net::cvt(result)?;\n         let socket = unsafe {\n-            c::WSASocketW(\n+            sys::c::WSASocketW(\n                 info.iAddressFamily,\n                 info.iSocketType,\n                 info.iProtocol,\n                 &mut info,\n                 0,\n-                c::WSA_FLAG_OVERLAPPED | c::WSA_FLAG_NO_HANDLE_INHERIT,\n+                sys::c::WSA_FLAG_OVERLAPPED | sys::c::WSA_FLAG_NO_HANDLE_INHERIT,\n             )\n         };\n \n-        if socket != c::INVALID_SOCKET {\n+        if socket != sys::c::INVALID_SOCKET {\n             unsafe { Ok(OwnedSocket::from_raw_socket(socket)) }\n         } else {\n-            let error = unsafe { c::WSAGetLastError() };\n+            let error = unsafe { sys::c::WSAGetLastError() };\n \n-            if error != c::WSAEPROTOTYPE && error != c::WSAEINVAL {\n+            if error != sys::c::WSAEPROTOTYPE && error != sys::c::WSAEINVAL {\n                 return Err(io::Error::from_raw_os_error(error));\n             }\n \n             let socket = unsafe {\n-                c::WSASocketW(\n+                sys::c::WSASocketW(\n                     info.iAddressFamily,\n                     info.iSocketType,\n                     info.iProtocol,\n                     &mut info,\n                     0,\n-                    c::WSA_FLAG_OVERLAPPED,\n+                    sys::c::WSA_FLAG_OVERLAPPED,\n                 )\n             };\n \n-            if socket == c::INVALID_SOCKET {\n+            if socket == sys::c::INVALID_SOCKET {\n                 return Err(last_error());\n             }\n \n@@ -161,7 +168,7 @@ impl BorrowedSocket<'_> {\n \n /// Returns the last error from the Windows socket interface.\n fn last_error() -> io::Error {\n-    io::Error::from_raw_os_error(unsafe { c::WSAGetLastError() })\n+    io::Error::from_raw_os_error(unsafe { sys::c::WSAGetLastError() })\n }\n \n #[stable(feature = \"io_safety\", since = \"1.63.0\")]\n@@ -194,7 +201,7 @@ impl IntoRawSocket for OwnedSocket {\n impl FromRawSocket for OwnedSocket {\n     #[inline]\n     unsafe fn from_raw_socket(socket: RawSocket) -> Self {\n-        debug_assert_ne!(socket, c::INVALID_SOCKET as RawSocket);\n+        debug_assert_ne!(socket, sys::c::INVALID_SOCKET as RawSocket);\n         Self { socket }\n     }\n }\n@@ -204,7 +211,7 @@ impl Drop for OwnedSocket {\n     #[inline]\n     fn drop(&mut self) {\n         unsafe {\n-            let _ = c::closesocket(self.socket);\n+            let _ = sys::c::closesocket(self.socket);\n         }\n     }\n }"}, {"sha": "c72be13804d20f4185f5e1d0fe8b9a392a0c17d4", "filename": "library/std/src/sys/mod.rs", "status": "modified", "additions": 0, "deletions": 25, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/cba14074bb4cc12bfe918eabd0d52a3999b2a461/library%2Fstd%2Fsrc%2Fsys%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cba14074bb4cc12bfe918eabd0d52a3999b2a461/library%2Fstd%2Fsrc%2Fsys%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Fmod.rs?ref=cba14074bb4cc12bfe918eabd0d52a3999b2a461", "patch": "@@ -52,31 +52,6 @@ cfg_if::cfg_if! {\n     }\n }\n \n-// Import essential modules from platforms used in `std::os` when documenting.\n-//\n-// Note that on some platforms those modules don't compile\n-// (missing things in `libc` which is empty), so they are not included in `std::os` and can be\n-// omitted here as well.\n-\n-#[cfg(doc)]\n-#[cfg(not(any(\n-    all(target_arch = \"wasm32\", not(target_os = \"wasi\")),\n-    all(target_vendor = \"fortanix\", target_env = \"sgx\")\n-)))]\n-cfg_if::cfg_if! {\n-    if #[cfg(not(windows))] {\n-        // On non-Windows platforms (aka linux/osx/etc) pull in a \"minimal\"\n-        // amount of windows goop which ends up compiling\n-\n-        #[macro_use]\n-        #[path = \"windows/compat.rs\"]\n-        pub mod compat;\n-\n-        #[path = \"windows/c.rs\"]\n-        pub mod c;\n-    }\n-}\n-\n cfg_if::cfg_if! {\n     // Fuchsia components default to full backtrace.\n     if #[cfg(target_os = \"fuchsia\")] {"}]}