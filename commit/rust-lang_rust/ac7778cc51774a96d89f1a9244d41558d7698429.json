{"sha": "ac7778cc51774a96d89f1a9244d41558d7698429", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFjNzc3OGNjNTE3NzRhOTZkODlmMWE5MjQ0ZDQxNTU4ZDc2OTg0Mjk=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2016-03-25T13:11:33Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2016-03-28T23:11:43Z"}, "message": "cargo-fmt: don't return zero on failure", "tree": {"sha": "2af3e32ff44031eaef3b0408120a05f009cd7fba", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2af3e32ff44031eaef3b0408120a05f009cd7fba"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ac7778cc51774a96d89f1a9244d41558d7698429", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ac7778cc51774a96d89f1a9244d41558d7698429", "html_url": "https://github.com/rust-lang/rust/commit/ac7778cc51774a96d89f1a9244d41558d7698429", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ac7778cc51774a96d89f1a9244d41558d7698429/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8fd95df54ab5de3dddfd47d8ae9fc52fea803844", "url": "https://api.github.com/repos/rust-lang/rust/commits/8fd95df54ab5de3dddfd47d8ae9fc52fea803844", "html_url": "https://github.com/rust-lang/rust/commit/8fd95df54ab5de3dddfd47d8ae9fc52fea803844"}], "stats": {"total": 53, "additions": 34, "deletions": 19}, "files": [{"sha": "d267dc5e35d18ea144d1fdbc1aebc7e7fb09f35e", "filename": "src/bin/cargo-fmt.rs", "status": "modified", "additions": 34, "deletions": 19, "changes": 53, "blob_url": "https://github.com/rust-lang/rust/blob/ac7778cc51774a96d89f1a9244d41558d7698429/src%2Fbin%2Fcargo-fmt.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ac7778cc51774a96d89f1a9244d41558d7698429/src%2Fbin%2Fcargo-fmt.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbin%2Fcargo-fmt.rs?ref=ac7778cc51774a96d89f1a9244d41558d7698429", "patch": "@@ -12,19 +12,30 @@\n \n #![cfg(not(test))]\n #![cfg(feature=\"cargo-fmt\")]\n+#![deny(warnings)]\n \n extern crate getopts;\n extern crate rustc_serialize;\n \n-use std::path::PathBuf;\n-use std::process::Command;\n use std::env;\n+use std::io::Write;\n+use std::path::PathBuf;\n+use std::process::{Command, ExitStatus};\n use std::str;\n \n use getopts::Options;\n use rustc_serialize::json::Json;\n \n fn main() {\n+    let exit_status = execute();\n+    std::io::stdout().flush().unwrap();\n+    std::process::exit(exit_status);\n+}\n+\n+fn execute() -> i32 {\n+    let success = 0;\n+    let failure = 1;\n+\n     let mut opts = getopts::Options::new();\n     opts.optflag(\"h\", \"help\", \"show this message\");\n     opts.optflag(\"q\", \"quiet\", \"no output printed to stdout\");\n@@ -34,21 +45,34 @@ fn main() {\n         Ok(m) => m,\n         Err(e) => {\n             print_usage(&opts, &e.to_string());\n-            return;\n+            return failure;\n         }\n     };\n \n     let (verbose, quiet) = (matches.opt_present(\"v\"), matches.opt_present(\"q\"));\n \n     if verbose && quiet {\n         print_usage(&opts, \"quiet mode and verbose mode are not compatible\");\n-        return;\n+        return failure;\n     }\n \n     if matches.opt_present(\"h\") {\n         print_usage(&opts, \"\");\n-    } else {\n-        format_crate(&opts, verbose, quiet);\n+        return success;\n+    }\n+\n+    match format_crate(verbose, quiet) {\n+        Err(e) => {\n+            print_usage(&opts, &e.to_string());\n+            failure\n+        }\n+        Ok(status) => {\n+            if status.success() {\n+                success\n+            } else {\n+                status.code().unwrap_or(failure)\n+            }\n+        }\n     }\n }\n \n@@ -59,14 +83,8 @@ fn print_usage(opts: &Options, reason: &str) {\n              opts.usage(&msg));\n }\n \n-fn format_crate(opts: &Options, verbose: bool, quiet: bool) {\n-    let targets = match get_targets() {\n-        Ok(t) => t,\n-        Err(e) => {\n-            print_usage(opts, &e.to_string());\n-            return;\n-        }\n-    };\n+fn format_crate(verbose: bool, quiet: bool) -> Result<ExitStatus, std::io::Error> {\n+    let targets = try!(get_targets());\n \n     // Currently only bin and lib files get formatted\n     let files: Vec<_> = targets.into_iter()\n@@ -80,7 +98,6 @@ fn format_crate(opts: &Options, verbose: bool, quiet: bool) {\n                                .collect();\n \n     format_files(&files, &get_fmt_args(), verbose, quiet)\n-        .unwrap_or_else(|e| print_usage(opts, &e.to_string()));\n }\n \n fn get_fmt_args() -> Vec<String> {\n@@ -158,7 +175,7 @@ fn format_files(files: &Vec<PathBuf>,\n                 fmt_args: &Vec<String>,\n                 verbose: bool,\n                 quiet: bool)\n-                -> Result<(), std::io::Error> {\n+                -> Result<ExitStatus, std::io::Error> {\n     let stdout = if quiet {\n         std::process::Stdio::null()\n     } else {\n@@ -179,7 +196,5 @@ fn format_files(files: &Vec<PathBuf>,\n                                .args(files)\n                                .args(fmt_args)\n                                .spawn());\n-    try!(command.wait());\n-\n-    Ok(())\n+    command.wait()\n }"}]}