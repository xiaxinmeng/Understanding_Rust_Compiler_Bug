{"sha": "30db261023d6b399ce3b16ce6345b5245a8800d2", "node_id": "MDY6Q29tbWl0NzI0NzEyOjMwZGIyNjEwMjNkNmIzOTljZTNiMTZjZTYzNDViNTI0NWE4ODAwZDI=", "commit": {"author": {"name": "Dylan DPC", "email": "dylan.dpc@gmail.com", "date": "2021-03-24T00:52:30Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-03-24T00:52:30Z"}, "message": "Rollup merge of #83391 - hyd-dev:uwtable, r=alexcrichton\n\nAllow not emitting `uwtable` on Android\n\n`uwtable` is marked as required on Android, so it can't be disabled via `-C force-unwind-tables=no`. However, I found that the reason it's marked as required was to resolve a [backtrace issue in Gecko](https://github.com/rust-lang/rust/issues/49867), and I haven't find any other reasons that make it required ([yet](https://rust-lang.zulipchat.com/#narrow/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android)). Therefore, I assume it's safe to turn it off if a (nice) backtrace is not needed, and submit this PR to allow `-C force-unwind-tables=no` when targeting Android.\n\nNote that I haven't tested this change on Android as I don't have an Android environment for testing.", "tree": {"sha": "9385e9436d6439463e8a76f8e3b4d97bb3017f86", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9385e9436d6439463e8a76f8e3b4d97bb3017f86"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/30db261023d6b399ce3b16ce6345b5245a8800d2", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgWo1OCRBK7hj4Ov3rIwAAdHIIAD76zerNMcg9OTqg0eSnJmhN\nqxEoXRN2+n8nyRMwxPGz2ngGM2QPcPv/mYi3VYfDO/P5SrpaXt+Vu/l98iUMryJg\nWBNAQA8JurFw+pzUNkB025XsKSFRss7DTcOIub2a+ZK8W8TrSgSgMb5/8rEhug9Q\n7KZg14SmHhsMF763UlkgrEg/bYaEqCi4lf+BaNULNyx7Ei6P/NNlDRld5/xrfHWp\ntjZYublmJb3SEt7+HViBDE8JTxh0HGuBz3S0Fg0kOUsuBvCCuuVnTFJdvUjR03z+\nimPoolzB7nisrr6troAU3gBZWf1AQEoEppowtG6NSkRHSW0oOqt8c2usHYnnIDY=\n=Klqx\n-----END PGP SIGNATURE-----\n", "payload": "tree 9385e9436d6439463e8a76f8e3b4d97bb3017f86\nparent a42e62fa0a59d0ba620889f97513929a113a6fbd\nparent f900ee331dfe95493390e1beecb82a277158b60b\nauthor Dylan DPC <dylan.dpc@gmail.com> 1616547150 +0100\ncommitter GitHub <noreply@github.com> 1616547150 +0100\n\nRollup merge of #83391 - hyd-dev:uwtable, r=alexcrichton\n\nAllow not emitting `uwtable` on Android\n\n`uwtable` is marked as required on Android, so it can't be disabled via `-C force-unwind-tables=no`. However, I found that the reason it's marked as required was to resolve a [backtrace issue in Gecko](https://github.com/rust-lang/rust/issues/49867), and I haven't find any other reasons that make it required ([yet](https://rust-lang.zulipchat.com/#narrow/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android)). Therefore, I assume it's safe to turn it off if a (nice) backtrace is not needed, and submit this PR to allow `-C force-unwind-tables=no` when targeting Android.\n\nNote that I haven't tested this change on Android as I don't have an Android environment for testing.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/30db261023d6b399ce3b16ce6345b5245a8800d2", "html_url": "https://github.com/rust-lang/rust/commit/30db261023d6b399ce3b16ce6345b5245a8800d2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/30db261023d6b399ce3b16ce6345b5245a8800d2/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a42e62fa0a59d0ba620889f97513929a113a6fbd", "url": "https://api.github.com/repos/rust-lang/rust/commits/a42e62fa0a59d0ba620889f97513929a113a6fbd", "html_url": "https://github.com/rust-lang/rust/commit/a42e62fa0a59d0ba620889f97513929a113a6fbd"}, {"sha": "f900ee331dfe95493390e1beecb82a277158b60b", "url": "https://api.github.com/repos/rust-lang/rust/commits/f900ee331dfe95493390e1beecb82a277158b60b", "html_url": "https://github.com/rust-lang/rust/commit/f900ee331dfe95493390e1beecb82a277158b60b"}], "stats": {"total": 36, "additions": 34, "deletions": 2}, "files": [{"sha": "203af36b05313fd709a517f17dfcbe73b74e12f3", "filename": "compiler/rustc_session/src/session.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/30db261023d6b399ce3b16ce6345b5245a8800d2/compiler%2Frustc_session%2Fsrc%2Fsession.rs", "raw_url": "https://github.com/rust-lang/rust/raw/30db261023d6b399ce3b16ce6345b5245a8800d2/compiler%2Frustc_session%2Fsrc%2Fsession.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Fsession.rs?ref=30db261023d6b399ce3b16ce6345b5245a8800d2", "patch": "@@ -863,7 +863,7 @@ impl Session {\n         } else if self.target.requires_uwtable {\n             true\n         } else {\n-            self.opts.cg.force_unwind_tables.unwrap_or(false)\n+            self.opts.cg.force_unwind_tables.unwrap_or(self.target.default_uwtable)\n         }\n     }\n "}, {"sha": "c7d2f2329ee86f5cf372e28368b6b25017997d98", "filename": "compiler/rustc_target/src/spec/android_base.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/30db261023d6b399ce3b16ce6345b5245a8800d2/compiler%2Frustc_target%2Fsrc%2Fspec%2Fandroid_base.rs", "raw_url": "https://github.com/rust-lang/rust/raw/30db261023d6b399ce3b16ce6345b5245a8800d2/compiler%2Frustc_target%2Fsrc%2Fspec%2Fandroid_base.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Fandroid_base.rs?ref=30db261023d6b399ce3b16ce6345b5245a8800d2", "patch": "@@ -12,7 +12,10 @@ pub fn opts() -> TargetOptions {\n     base.dwarf_version = Some(2);\n     base.position_independent_executables = true;\n     base.has_elf_tls = false;\n-    base.requires_uwtable = true;\n+    // This is for backward compatibility, see https://github.com/rust-lang/rust/issues/49867\n+    // for context. (At that time, there was no `-C force-unwind-tables`, so the only solution\n+    // was to always emit `uwtable`).\n+    base.default_uwtable = true;\n     base.crt_static_respected = false;\n     base\n }"}, {"sha": "ddfd82625221fa2ca41a1857dd18efc14be9c65b", "filename": "compiler/rustc_target/src/spec/mod.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/30db261023d6b399ce3b16ce6345b5245a8800d2/compiler%2Frustc_target%2Fsrc%2Fspec%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/30db261023d6b399ce3b16ce6345b5245a8800d2/compiler%2Frustc_target%2Fsrc%2Fspec%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Fmod.rs?ref=30db261023d6b399ce3b16ce6345b5245a8800d2", "patch": "@@ -1111,6 +1111,10 @@ pub struct TargetOptions {\n     /// unwinders.\n     pub requires_uwtable: bool,\n \n+    /// Whether or not to emit `uwtable` attributes on functions if `-C force-unwind-tables`\n+    /// is not specified and `uwtable` is not required on this target.\n+    pub default_uwtable: bool,\n+\n     /// Whether or not SIMD types are passed by reference in the Rust ABI,\n     /// typically required if a target can be compiled with a mixed set of\n     /// target features. This is `true` by default, and `false` for targets like\n@@ -1248,6 +1252,7 @@ impl Default for TargetOptions {\n             default_hidden_visibility: false,\n             emit_debug_gdb_scripts: true,\n             requires_uwtable: false,\n+            default_uwtable: false,\n             simd_types_indirect: true,\n             limit_rdylib_exports: true,\n             override_export_symbols: None,\n@@ -1711,6 +1716,7 @@ impl Target {\n         key!(default_hidden_visibility, bool);\n         key!(emit_debug_gdb_scripts, bool);\n         key!(requires_uwtable, bool);\n+        key!(default_uwtable, bool);\n         key!(simd_types_indirect, bool);\n         key!(limit_rdylib_exports, bool);\n         key!(override_export_symbols, opt_list);\n@@ -1947,6 +1953,7 @@ impl ToJson for Target {\n         target_option_val!(default_hidden_visibility);\n         target_option_val!(emit_debug_gdb_scripts);\n         target_option_val!(requires_uwtable);\n+        target_option_val!(default_uwtable);\n         target_option_val!(simd_types_indirect);\n         target_option_val!(limit_rdylib_exports);\n         target_option_val!(override_export_symbols);"}, {"sha": "d4c4200c5d23002e590586ab5553e8bcc6abc1aa", "filename": "src/test/codegen/default-requires-uwtable.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/30db261023d6b399ce3b16ce6345b5245a8800d2/src%2Ftest%2Fcodegen%2Fdefault-requires-uwtable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/30db261023d6b399ce3b16ce6345b5245a8800d2/src%2Ftest%2Fcodegen%2Fdefault-requires-uwtable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fdefault-requires-uwtable.rs?ref=30db261023d6b399ce3b16ce6345b5245a8800d2", "patch": "@@ -0,0 +1,15 @@\n+// revisions: WINDOWS ANDROID\n+// needs-llvm-components: x86 arm\n+// compile-flags: -C panic=abort\n+// [WINDOWS] compile-flags: --target=x86_64-pc-windows-msvc\n+// [ANDROID] compile-flags: --target=armv7-linux-androideabi\n+\n+#![feature(no_core, lang_items)]\n+#![crate_type = \"lib\"]\n+#![no_core]\n+\n+#[lang = \"sized\"]\n+trait Sized {}\n+\n+// CHECK: attributes #{{.*}} uwtable\n+pub fn foo() {}"}, {"sha": "dc77e6cb70917525b368fa46706f7f8ad683d8b4", "filename": "src/test/codegen/force-no-unwind-tables.rs", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/30db261023d6b399ce3b16ce6345b5245a8800d2/src%2Ftest%2Fcodegen%2Fforce-no-unwind-tables.rs", "raw_url": "https://github.com/rust-lang/rust/raw/30db261023d6b399ce3b16ce6345b5245a8800d2/src%2Ftest%2Fcodegen%2Fforce-no-unwind-tables.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fforce-no-unwind-tables.rs?ref=30db261023d6b399ce3b16ce6345b5245a8800d2", "patch": "@@ -0,0 +1,7 @@\n+// compile-flags: -C no-prepopulate-passes -C panic=abort -C force-unwind-tables=n\n+// ignore-windows\n+\n+#![crate_type=\"lib\"]\n+\n+// CHECK-NOT: attributes #{{.*}} uwtable\n+pub fn foo() {}"}]}