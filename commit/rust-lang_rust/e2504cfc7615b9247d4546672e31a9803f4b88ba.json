{"sha": "e2504cfc7615b9247d4546672e31a9803f4b88ba", "node_id": "MDY6Q29tbWl0NzI0NzEyOmUyNTA0Y2ZjNzYxNWI5MjQ3ZDQ1NDY2NzJlMzFhOTgwM2Y0Yjg4YmE=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-09-21T00:35:33Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-09-21T00:35:33Z"}, "message": "Auto merge of #44551 - scalexm:copy-clone-closures, r=arielb1\n\nImplement `Copy`/`Clone` for closures\n\nImplement RFC [#2132](https://github.com/rust-lang/rfcs/pull/2132) (tracking issue: #44490).\n\nNB: I'm not totally sure about the whole feature gates thing, that's my first PR of this kind...", "tree": {"sha": "b6700e23d1a39a841a02491e8f7e2dee0a2e12c7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b6700e23d1a39a841a02491e8f7e2dee0a2e12c7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e2504cfc7615b9247d4546672e31a9803f4b88ba", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e2504cfc7615b9247d4546672e31a9803f4b88ba", "html_url": "https://github.com/rust-lang/rust/commit/e2504cfc7615b9247d4546672e31a9803f4b88ba", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e2504cfc7615b9247d4546672e31a9803f4b88ba/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "870483a57f9e3e1daee6543a4ace2cf875b74541", "url": "https://api.github.com/repos/rust-lang/rust/commits/870483a57f9e3e1daee6543a4ace2cf875b74541", "html_url": "https://github.com/rust-lang/rust/commit/870483a57f9e3e1daee6543a4ace2cf875b74541"}, {"sha": "3fa3fe01b65ec4dde20c66c6bedcd28e2f83f8b6", "url": "https://api.github.com/repos/rust-lang/rust/commits/3fa3fe01b65ec4dde20c66c6bedcd28e2f83f8b6", "html_url": "https://github.com/rust-lang/rust/commit/3fa3fe01b65ec4dde20c66c6bedcd28e2f83f8b6"}], "stats": {"total": 282, "additions": 264, "deletions": 18}, "files": [{"sha": "b4cb39a034b4fd9cec750009ac3b871a8372b42d", "filename": "src/librustc/dep_graph/dep_node.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e2504cfc7615b9247d4546672e31a9803f4b88ba/src%2Flibrustc%2Fdep_graph%2Fdep_node.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e2504cfc7615b9247d4546672e31a9803f4b88ba/src%2Flibrustc%2Fdep_graph%2Fdep_node.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fdep_graph%2Fdep_node.rs?ref=e2504cfc7615b9247d4546672e31a9803f4b88ba", "patch": "@@ -570,6 +570,8 @@ define_dep_nodes!( <'tcx>\n     [] MissingExternCrateItem(CrateNum),\n     [] UsedCrateSource(CrateNum),\n     [] PostorderCnums,\n+    [] HasCloneClosures(CrateNum),\n+    [] HasCopyClosures(CrateNum),\n \n     [] Freevars(DefId),\n     [] MaybeUnusedTraitImport(DefId),"}, {"sha": "00f0672822fc119a5feea7945fff7bb6d908044b", "filename": "src/librustc/traits/select.rs", "status": "modified", "additions": 22, "deletions": 7, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/e2504cfc7615b9247d4546672e31a9803f4b88ba/src%2Flibrustc%2Ftraits%2Fselect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e2504cfc7615b9247d4546672e31a9803f4b88ba/src%2Flibrustc%2Ftraits%2Fselect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Ftraits%2Fselect.rs?ref=e2504cfc7615b9247d4546672e31a9803f4b88ba", "patch": "@@ -1340,7 +1340,7 @@ impl<'cx, 'gcx, 'tcx> SelectionContext<'cx, 'gcx, 'tcx> {\n             self.assemble_candidates_from_impls(obligation, &mut candidates)?;\n \n             // For other types, we'll use the builtin rules.\n-            let copy_conditions = self.copy_conditions(obligation);\n+            let copy_conditions = self.copy_clone_conditions(obligation);\n             self.assemble_builtin_bound_candidates(copy_conditions, &mut candidates)?;\n         } else if lang_items.sized_trait() == Some(def_id) {\n             // Sized is never implementable by end-users, it is\n@@ -1355,7 +1355,7 @@ impl<'cx, 'gcx, 'tcx> SelectionContext<'cx, 'gcx, 'tcx> {\n                  // Same builtin conditions as `Copy`, i.e. every type which has builtin support\n                  // for `Copy` also has builtin support for `Clone`, + tuples and arrays of `Clone`\n                  // types have builtin support for `Clone`.\n-                 let clone_conditions = self.copy_conditions(obligation);\n+                 let clone_conditions = self.copy_clone_conditions(obligation);\n                  self.assemble_builtin_bound_candidates(clone_conditions, &mut candidates)?;\n              }\n \n@@ -2050,7 +2050,7 @@ impl<'cx, 'gcx, 'tcx> SelectionContext<'cx, 'gcx, 'tcx> {\n         }\n     }\n \n-    fn copy_conditions(&mut self, obligation: &TraitObligation<'tcx>)\n+    fn copy_clone_conditions(&mut self, obligation: &TraitObligation<'tcx>)\n                      -> BuiltinImplConditions<'tcx>\n     {\n         // NOTE: binder moved to (*)\n@@ -2068,8 +2068,7 @@ impl<'cx, 'gcx, 'tcx> SelectionContext<'cx, 'gcx, 'tcx> {\n                 Where(ty::Binder(Vec::new()))\n             }\n \n-            ty::TyDynamic(..) | ty::TyStr | ty::TySlice(..) |\n-            ty::TyClosure(..) | ty::TyGenerator(..) |\n+            ty::TyDynamic(..) | ty::TyStr | ty::TySlice(..) | ty::TyGenerator(..) |\n             ty::TyRef(_, ty::TypeAndMut { ty: _, mutbl: hir::MutMutable }) => {\n                 Never\n             }\n@@ -2084,6 +2083,22 @@ impl<'cx, 'gcx, 'tcx> SelectionContext<'cx, 'gcx, 'tcx> {\n                 Where(ty::Binder(tys.to_vec()))\n             }\n \n+            ty::TyClosure(def_id, substs) => {\n+                let trait_id = obligation.predicate.def_id();\n+                let copy_closures =\n+                    Some(trait_id) == self.tcx().lang_items().copy_trait() &&\n+                    self.tcx().has_copy_closures(def_id.krate);\n+                let clone_closures =\n+                    Some(trait_id) == self.tcx().lang_items().clone_trait() &&\n+                    self.tcx().has_clone_closures(def_id.krate);\n+\n+                if copy_closures || clone_closures {\n+                    Where(ty::Binder(substs.upvar_tys(def_id, self.tcx()).collect()))\n+                } else {\n+                    Never\n+                }\n+            }\n+\n             ty::TyAdt(..) | ty::TyProjection(..) | ty::TyParam(..) | ty::TyAnon(..) => {\n                 // Fallback to whatever user-defined impls exist in this case.\n                 None\n@@ -2370,10 +2385,10 @@ impl<'cx, 'gcx, 'tcx> SelectionContext<'cx, 'gcx, 'tcx> {\n                     self.sized_conditions(obligation)\n                 }\n                 _ if Some(trait_def) == lang_items.copy_trait() => {\n-                    self.copy_conditions(obligation)\n+                    self.copy_clone_conditions(obligation)\n                 }\n                 _ if Some(trait_def) == lang_items.clone_trait() => {\n-                    self.copy_conditions(obligation)\n+                    self.copy_clone_conditions(obligation)\n                 }\n                 _ => bug!(\"unexpected builtin trait {:?}\", trait_def)\n             };"}, {"sha": "4a309ee0eb02b7c4bab7ed5c054d1cc1ee616d85", "filename": "src/librustc/ty/context.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/e2504cfc7615b9247d4546672e31a9803f4b88ba/src%2Flibrustc%2Fty%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e2504cfc7615b9247d4546672e31a9803f4b88ba/src%2Flibrustc%2Fty%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fcontext.rs?ref=e2504cfc7615b9247d4546672e31a9803f4b88ba", "patch": "@@ -2247,4 +2247,12 @@ pub fn provide(providers: &mut ty::maps::Providers) {\n         assert_eq!(cnum, LOCAL_CRATE);\n         tcx.output_filenames.clone()\n     };\n+    providers.has_copy_closures = |tcx, cnum| {\n+        assert_eq!(cnum, LOCAL_CRATE);\n+        tcx.sess.features.borrow().copy_closures\n+    };\n+    providers.has_clone_closures = |tcx, cnum| {\n+        assert_eq!(cnum, LOCAL_CRATE);\n+        tcx.sess.features.borrow().clone_closures\n+    };\n }"}, {"sha": "871a23863ac21be3b578d4ead3a51b3fe5f066fa", "filename": "src/librustc/ty/instance.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e2504cfc7615b9247d4546672e31a9803f4b88ba/src%2Flibrustc%2Fty%2Finstance.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e2504cfc7615b9247d4546672e31a9803f4b88ba/src%2Flibrustc%2Fty%2Finstance.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Finstance.rs?ref=e2504cfc7615b9247d4546672e31a9803f4b88ba", "patch": "@@ -38,7 +38,7 @@ pub enum InstanceDef<'tcx> {\n     /// drop_in_place::<T>; None for empty drop glue.\n     DropGlue(DefId, Option<Ty<'tcx>>),\n \n-    /// Builtin method implementation, e.g. `Clone::clone`.\n+    ///`<T as Clone>::clone` shim.\n     CloneShim(DefId, Ty<'tcx>),\n }\n "}, {"sha": "c8520c5be2df5eef5a7e50387b705cb02db3b677", "filename": "src/librustc/ty/maps/config.rs", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/e2504cfc7615b9247d4546672e31a9803f4b88ba/src%2Flibrustc%2Fty%2Fmaps%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e2504cfc7615b9247d4546672e31a9803f4b88ba/src%2Flibrustc%2Fty%2Fmaps%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fmaps%2Fconfig.rs?ref=e2504cfc7615b9247d4546672e31a9803f4b88ba", "patch": "@@ -490,3 +490,15 @@ impl<'tcx> QueryDescription for queries::output_filenames<'tcx> {\n         format!(\"output_filenames\")\n     }\n }\n+\n+impl<'tcx> QueryDescription for queries::has_clone_closures<'tcx> {\n+    fn describe(_tcx: TyCtxt, _: CrateNum) -> String {\n+        format!(\"seeing if the crate has enabled `Clone` closures\")\n+    }\n+}\n+\n+impl<'tcx> QueryDescription for queries::has_copy_closures<'tcx> {\n+    fn describe(_tcx: TyCtxt, _: CrateNum) -> String {\n+        format!(\"seeing if the crate has enabled `Copy` closures\")\n+    }\n+}"}, {"sha": "313a831f6b0eb8632736a50df29a4a327f827f0e", "filename": "src/librustc/ty/maps/mod.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/e2504cfc7615b9247d4546672e31a9803f4b88ba/src%2Flibrustc%2Fty%2Fmaps%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e2504cfc7615b9247d4546672e31a9803f4b88ba/src%2Flibrustc%2Fty%2Fmaps%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fmaps%2Fmod.rs?ref=e2504cfc7615b9247d4546672e31a9803f4b88ba", "patch": "@@ -326,6 +326,9 @@ define_maps! { <'tcx>\n     [] fn compile_codegen_unit: CompileCodegenUnit(InternedString) -> Stats,\n     [] fn output_filenames: output_filenames_node(CrateNum)\n         -> Arc<OutputFilenames>,\n+\n+    [] fn has_copy_closures: HasCopyClosures(CrateNum) -> bool,\n+    [] fn has_clone_closures: HasCloneClosures(CrateNum) -> bool,\n }\n \n //////////////////////////////////////////////////////////////////////"}, {"sha": "9e47e96aee4ef4a1ff995a22474e193737bdf013", "filename": "src/librustc_metadata/cstore.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/e2504cfc7615b9247d4546672e31a9803f4b88ba/src%2Flibrustc_metadata%2Fcstore.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e2504cfc7615b9247d4546672e31a9803f4b88ba/src%2Flibrustc_metadata%2Fcstore.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Fcstore.rs?ref=e2504cfc7615b9247d4546672e31a9803f4b88ba", "patch": "@@ -218,6 +218,16 @@ impl CrateMetadata {\n         attr::contains_name(&attrs, \"no_builtins\")\n     }\n \n+     pub fn has_copy_closures(&self) -> bool {\n+        let attrs = self.get_item_attrs(CRATE_DEF_INDEX);\n+        attr::contains_feature_attr(&attrs, \"copy_closures\")\n+    }\n+\n+    pub fn has_clone_closures(&self) -> bool {\n+        let attrs = self.get_item_attrs(CRATE_DEF_INDEX);\n+        attr::contains_feature_attr(&attrs, \"clone_closures\")\n+    }\n+\n     pub fn panic_strategy(&self) -> PanicStrategy {\n         self.root.panic_strategy.clone()\n     }"}, {"sha": "f785d7bd40763452708384a28bb1ec74415d01ae", "filename": "src/librustc_metadata/cstore_impl.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/e2504cfc7615b9247d4546672e31a9803f4b88ba/src%2Flibrustc_metadata%2Fcstore_impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e2504cfc7615b9247d4546672e31a9803f4b88ba/src%2Flibrustc_metadata%2Fcstore_impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Fcstore_impl.rs?ref=e2504cfc7615b9247d4546672e31a9803f4b88ba", "patch": "@@ -231,6 +231,9 @@ provide! { <'tcx> tcx, def_id, other, cdata,\n     }\n \n     used_crate_source => { Rc::new(cdata.source.clone()) }\n+\n+    has_copy_closures => { cdata.has_copy_closures() }\n+    has_clone_closures => { cdata.has_clone_closures() }\n }\n \n pub fn provide_local<'tcx>(providers: &mut Providers<'tcx>) {"}, {"sha": "31480457723fdef0fc1b187a27cd99a963717a01", "filename": "src/librustc_mir/shim.rs", "status": "modified", "additions": 17, "deletions": 6, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/e2504cfc7615b9247d4546672e31a9803f4b88ba/src%2Flibrustc_mir%2Fshim.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e2504cfc7615b9247d4546672e31a9803f4b88ba/src%2Flibrustc_mir%2Fshim.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fshim.rs?ref=e2504cfc7615b9247d4546672e31a9803f4b88ba", "patch": "@@ -296,9 +296,15 @@ fn build_clone_shim<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>,\n             let len = len.val.to_const_int().unwrap().to_u64().unwrap();\n             builder.array_shim(ty, len)\n         }\n-        ty::TyTuple(tys, _) => builder.tuple_shim(tys),\n+        ty::TyClosure(def_id, substs) => {\n+            builder.tuple_like_shim(\n+                &substs.upvar_tys(def_id, tcx).collect::<Vec<_>>(),\n+                AggregateKind::Closure(def_id, substs)\n+            )\n+        }\n+        ty::TyTuple(tys, _) => builder.tuple_like_shim(&**tys, AggregateKind::Tuple),\n         _ => {\n-            bug!(\"clone shim for `{:?}` which is not `Copy` and is not an aggregate\", self_ty);\n+            bug!(\"clone shim for `{:?}` which is not `Copy` and is not an aggregate\", self_ty)\n         }\n     };\n \n@@ -613,7 +619,12 @@ impl<'a, 'tcx> CloneShimBuilder<'a, 'tcx> {\n         self.block(vec![], TerminatorKind::Resume, true);\n     }\n \n-    fn tuple_shim(&mut self, tys: &ty::Slice<Ty<'tcx>>) {\n+    fn tuple_like_shim(&mut self, tys: &[ty::Ty<'tcx>], kind: AggregateKind<'tcx>) {\n+        match kind {\n+            AggregateKind::Tuple | AggregateKind::Closure(..) => (),\n+            _ => bug!(\"only tuples and closures are accepted\"),\n+        };\n+\n         let rcvr = Lvalue::Local(Local::new(1+0)).deref();\n \n         let mut returns = Vec::new();\n@@ -646,17 +657,17 @@ impl<'a, 'tcx> CloneShimBuilder<'a, 'tcx> {\n             }\n         }\n \n-        // `return (returns[0], returns[1], ..., returns[tys.len() - 1]);`\n+        // `return kind(returns[0], returns[1], ..., returns[tys.len() - 1]);`\n         let ret_statement = self.make_statement(\n             StatementKind::Assign(\n                 Lvalue::Local(RETURN_POINTER),\n                 Rvalue::Aggregate(\n-                    box AggregateKind::Tuple,\n+                    box kind,\n                     returns.into_iter().map(Operand::Consume).collect()\n                 )\n             )\n         );\n-       self.block(vec![ret_statement], TerminatorKind::Return, false);\n+        self.block(vec![ret_statement], TerminatorKind::Return, false);\n     }\n }\n "}, {"sha": "b1f796084df826e6881f4667c968e5dcc1b5e9f5", "filename": "src/libsyntax/attr.rs", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/e2504cfc7615b9247d4546672e31a9803f4b88ba/src%2Flibsyntax%2Fattr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e2504cfc7615b9247d4546672e31a9803f4b88ba/src%2Flibsyntax%2Fattr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fattr.rs?ref=e2504cfc7615b9247d4546672e31a9803f4b88ba", "patch": "@@ -500,6 +500,20 @@ pub fn first_attr_value_str_by_name(attrs: &[Attribute], name: &str) -> Option<S\n         .and_then(|at| at.value_str())\n }\n \n+/// Check if `attrs` contains an attribute like `#![feature(feature_name)]`.\n+/// This will not perform any \"sanity checks\" on the form of the attributes.\n+pub fn contains_feature_attr(attrs: &[Attribute], feature_name: &str) -> bool {\n+    attrs.iter().any(|item| {\n+        item.check_name(\"feature\") &&\n+        item.meta_item_list().map(|list| {\n+            list.iter().any(|mi| {\n+                mi.word().map(|w| w.name() == feature_name)\n+                         .unwrap_or(false)\n+            })\n+        }).unwrap_or(false)\n+    })\n+}\n+\n /* Higher-level applications */\n \n pub fn find_crate_name(attrs: &[Attribute]) -> Option<Symbol> {"}, {"sha": "6560943a9328be968d5ac31b8a5cee3647868255", "filename": "src/libsyntax/feature_gate.rs", "status": "modified", "additions": 27, "deletions": 4, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/e2504cfc7615b9247d4546672e31a9803f4b88ba/src%2Flibsyntax%2Ffeature_gate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e2504cfc7615b9247d4546672e31a9803f4b88ba/src%2Flibsyntax%2Ffeature_gate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Ffeature_gate.rs?ref=e2504cfc7615b9247d4546672e31a9803f4b88ba", "patch": "@@ -385,6 +385,10 @@ declare_features! (\n \n     // allow '|' at beginning of match arms (RFC 1925)\n     (active, match_beginning_vert, \"1.21.0\", Some(44101)),\n+\n+    // Copy/Clone closures (RFC 2132)\n+    (active, clone_closures, \"1.22.0\", Some(44490)),\n+    (active, copy_closures, \"1.22.0\", Some(44490)),\n );\n \n declare_features! (\n@@ -1573,7 +1577,7 @@ impl<'a> Visitor<'a> for PostExpansionVisitor<'a> {\n pub fn get_features(span_handler: &Handler, krate_attrs: &[ast::Attribute]) -> Features {\n     let mut features = Features::new();\n \n-    let mut feature_checker = MutexFeatureChecker::default();\n+    let mut feature_checker = FeatureChecker::default();\n \n     for attr in krate_attrs {\n         if !attr.check_name(\"feature\") {\n@@ -1622,14 +1626,16 @@ pub fn get_features(span_handler: &Handler, krate_attrs: &[ast::Attribute]) -> F\n     features\n }\n \n-// A collector for mutually-exclusive features and their flag spans\n+/// A collector for mutually exclusive and interdependent features and their flag spans.\n #[derive(Default)]\n-struct MutexFeatureChecker {\n+struct FeatureChecker {\n     proc_macro: Option<Span>,\n     custom_attribute: Option<Span>,\n+    copy_closures: Option<Span>,\n+    clone_closures: Option<Span>,\n }\n \n-impl MutexFeatureChecker {\n+impl FeatureChecker {\n     // If this method turns out to be a hotspot due to branching,\n     // the branching can be eliminated by modifying `set!()` to set these spans\n     // only for the features that need to be checked for mutual exclusion.\n@@ -1642,6 +1648,14 @@ impl MutexFeatureChecker {\n         if features.custom_attribute {\n             self.custom_attribute = self.custom_attribute.or(Some(span));\n         }\n+\n+        if features.copy_closures {\n+            self.copy_closures = self.copy_closures.or(Some(span));\n+        }\n+\n+        if features.clone_closures {\n+            self.clone_closures = self.clone_closures.or(Some(span));\n+        }\n     }\n \n     fn check(self, handler: &Handler) {\n@@ -1653,6 +1667,15 @@ impl MutexFeatureChecker {\n \n             panic!(FatalError);\n         }\n+\n+        if let (Some(span), None) = (self.copy_closures, self.clone_closures) {\n+            handler.struct_span_err(span, \"`#![feature(copy_closures)]` can only be used with \\\n+                                           `#![feature(clone_closures)]`\")\n+                  .span_note(span, \"`#![feature(copy_closures)]` declared here\")\n+                  .emit();\n+\n+            panic!(FatalError);\n+        }\n     }\n }\n "}, {"sha": "a15153ea7bf0ab947bbd0b04b0288bfc4899ef1d", "filename": "src/test/compile-fail/feature-gate-clone-closures.rs", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/e2504cfc7615b9247d4546672e31a9803f4b88ba/src%2Ftest%2Fcompile-fail%2Ffeature-gate-clone-closures.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e2504cfc7615b9247d4546672e31a9803f4b88ba/src%2Ftest%2Fcompile-fail%2Ffeature-gate-clone-closures.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Ffeature-gate-clone-closures.rs?ref=e2504cfc7615b9247d4546672e31a9803f4b88ba", "patch": "@@ -0,0 +1,21 @@\n+// Copyright 2017 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#[derive(Clone)]\n+struct S(i32);\n+\n+fn main() {\n+    let a = S(5);\n+    let hello = move || {\n+        println!(\"Hello {}\", a.0);\n+    };\n+\n+    let hello = hello.clone(); //~ ERROR no method named `clone` found for type\n+}"}, {"sha": "b11b09eb9fd9bfab6787d6dc53f5332d98ae1288", "filename": "src/test/compile-fail/feature-gate-copy-closures.rs", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/e2504cfc7615b9247d4546672e31a9803f4b88ba/src%2Ftest%2Fcompile-fail%2Ffeature-gate-copy-closures.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e2504cfc7615b9247d4546672e31a9803f4b88ba/src%2Ftest%2Fcompile-fail%2Ffeature-gate-copy-closures.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Ffeature-gate-copy-closures.rs?ref=e2504cfc7615b9247d4546672e31a9803f4b88ba", "patch": "@@ -0,0 +1,19 @@\n+// Copyright 2017 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+fn main() {\n+    let a = 5;\n+    let hello = || {\n+        println!(\"Hello {}\", a);\n+    };\n+\n+    let b = hello;\n+    let c = hello; //~ ERROR use of moved value: `hello` [E0382]\n+}"}, {"sha": "2a30dc4fdd49c8ae8939c1d0489d7a3cb11da59f", "filename": "src/test/compile-fail/not-clone-closure.rs", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/e2504cfc7615b9247d4546672e31a9803f4b88ba/src%2Ftest%2Fcompile-fail%2Fnot-clone-closure.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e2504cfc7615b9247d4546672e31a9803f4b88ba/src%2Ftest%2Fcompile-fail%2Fnot-clone-closure.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fnot-clone-closure.rs?ref=e2504cfc7615b9247d4546672e31a9803f4b88ba", "patch": "@@ -0,0 +1,24 @@\n+// Copyright 2017 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// Check that closures do not implement `Clone` if their environment is not `Clone`.\n+\n+#![feature(clone_closures)]\n+\n+struct S(i32);\n+\n+fn main() {\n+    let a = S(5);\n+    let hello = move || {\n+        println!(\"Hello {}\", a.0);\n+    };\n+\n+    let hello = hello.clone(); //~ ERROR the trait bound `S: std::clone::Clone` is not satisfied\n+}"}, {"sha": "271e6d5fc90fc36f1d7052f8739fe459d8ec6725", "filename": "src/test/compile-fail/not-copy-closure.rs", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/e2504cfc7615b9247d4546672e31a9803f4b88ba/src%2Ftest%2Fcompile-fail%2Fnot-copy-closure.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e2504cfc7615b9247d4546672e31a9803f4b88ba/src%2Ftest%2Fcompile-fail%2Fnot-copy-closure.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fnot-copy-closure.rs?ref=e2504cfc7615b9247d4546672e31a9803f4b88ba", "patch": "@@ -0,0 +1,24 @@\n+// Copyright 2017 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// Check that closures do not implement `Copy` if their environment is not `Copy`.\n+\n+#![feature(copy_closures)]\n+#![feature(clone_closures)]\n+\n+fn main() {\n+    let mut a = 5;\n+    let hello = || {\n+        a += 1;\n+    };\n+\n+    let b = hello;\n+    let c = hello; //~ ERROR use of moved value: `hello` [E0382]\n+}"}, {"sha": "7f554c77fc4f8013fedbb5939fa68a155a363371", "filename": "src/test/run-pass/clone-closure.rs", "status": "added", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/e2504cfc7615b9247d4546672e31a9803f4b88ba/src%2Ftest%2Frun-pass%2Fclone-closure.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e2504cfc7615b9247d4546672e31a9803f4b88ba/src%2Ftest%2Frun-pass%2Fclone-closure.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fclone-closure.rs?ref=e2504cfc7615b9247d4546672e31a9803f4b88ba", "patch": "@@ -0,0 +1,29 @@\n+// Copyright 2017 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// Check that closures implement `Clone`.\n+\n+#![feature(clone_closures)]\n+\n+#[derive(Clone)]\n+struct S(i32);\n+\n+fn main() {\n+    let mut a = S(5);\n+    let mut hello = move || {\n+        a.0 += 1;\n+        println!(\"Hello {}\", a.0);\n+        a.0\n+    };\n+\n+    let mut hello2 = hello.clone();\n+    assert_eq!(6, hello2());\n+    assert_eq!(6, hello());\n+}"}, {"sha": "309c83ebd99ac9e319c846f4a0ed4255e31d561f", "filename": "src/test/run-pass/copy-closure.rs", "status": "added", "additions": 28, "deletions": 0, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/e2504cfc7615b9247d4546672e31a9803f4b88ba/src%2Ftest%2Frun-pass%2Fcopy-closure.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e2504cfc7615b9247d4546672e31a9803f4b88ba/src%2Ftest%2Frun-pass%2Fcopy-closure.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fcopy-closure.rs?ref=e2504cfc7615b9247d4546672e31a9803f4b88ba", "patch": "@@ -0,0 +1,28 @@\n+// Copyright 2017 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// Check that closures implement `Copy`.\n+\n+#![feature(copy_closures)]\n+#![feature(clone_closures)]\n+\n+fn call<T, F: FnOnce() -> T>(f: F) -> T { f() }\n+\n+fn main() {\n+    let a = 5;\n+    let hello = || {\n+        println!(\"Hello {}\", a);\n+        a\n+    };\n+\n+    assert_eq!(5, call(hello.clone()));\n+    assert_eq!(5, call(hello));\n+    assert_eq!(5, call(hello));\n+}"}]}