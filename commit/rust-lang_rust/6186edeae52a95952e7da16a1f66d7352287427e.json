{"sha": "6186edeae52a95952e7da16a1f66d7352287427e", "node_id": "MDY6Q29tbWl0NzI0NzEyOjYxODZlZGVhZTUyYTk1OTUyZTdkYTE2YTFmNjZkNzM1MjI4NzQyN2U=", "commit": {"author": {"name": "Pi Lanningham", "email": "pi.lanningham@gmail.com", "date": "2019-11-05T23:49:46Z"}, "committer": {"name": "Pi Lanningham", "email": "pi.lanningham@gmail.com", "date": "2019-11-05T23:49:46Z"}, "message": "Use source_callee().is_some() to detect macros\n\nmacro_backtrace() allocates a vector, whereas source_callee() doesn't\nbut indicates the same thing.  Suggested by @estebank", "tree": {"sha": "c653e0c238e769beb2388f76f65bcae76e9bc368", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c653e0c238e769beb2388f76f65bcae76e9bc368"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6186edeae52a95952e7da16a1f66d7352287427e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6186edeae52a95952e7da16a1f66d7352287427e", "html_url": "https://github.com/rust-lang/rust/commit/6186edeae52a95952e7da16a1f66d7352287427e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6186edeae52a95952e7da16a1f66d7352287427e/comments", "author": {"login": "Quantumplation", "id": 49870, "node_id": "MDQ6VXNlcjQ5ODcw", "avatar_url": "https://avatars.githubusercontent.com/u/49870?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Quantumplation", "html_url": "https://github.com/Quantumplation", "followers_url": "https://api.github.com/users/Quantumplation/followers", "following_url": "https://api.github.com/users/Quantumplation/following{/other_user}", "gists_url": "https://api.github.com/users/Quantumplation/gists{/gist_id}", "starred_url": "https://api.github.com/users/Quantumplation/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Quantumplation/subscriptions", "organizations_url": "https://api.github.com/users/Quantumplation/orgs", "repos_url": "https://api.github.com/users/Quantumplation/repos", "events_url": "https://api.github.com/users/Quantumplation/events{/privacy}", "received_events_url": "https://api.github.com/users/Quantumplation/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Quantumplation", "id": 49870, "node_id": "MDQ6VXNlcjQ5ODcw", "avatar_url": "https://avatars.githubusercontent.com/u/49870?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Quantumplation", "html_url": "https://github.com/Quantumplation", "followers_url": "https://api.github.com/users/Quantumplation/followers", "following_url": "https://api.github.com/users/Quantumplation/following{/other_user}", "gists_url": "https://api.github.com/users/Quantumplation/gists{/gist_id}", "starred_url": "https://api.github.com/users/Quantumplation/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Quantumplation/subscriptions", "organizations_url": "https://api.github.com/users/Quantumplation/orgs", "repos_url": "https://api.github.com/users/Quantumplation/repos", "events_url": "https://api.github.com/users/Quantumplation/events{/privacy}", "received_events_url": "https://api.github.com/users/Quantumplation/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "15ccad399f5b157ccf4039d71dcb9b5aeec928da", "url": "https://api.github.com/repos/rust-lang/rust/commits/15ccad399f5b157ccf4039d71dcb9b5aeec928da", "html_url": "https://github.com/rust-lang/rust/commit/15ccad399f5b157ccf4039d71dcb9b5aeec928da"}], "stats": {"total": 9, "additions": 5, "deletions": 4}, "files": [{"sha": "2aeec029cc334dee7f57da7b60409eb3bf46af95", "filename": "src/librustc_passes/dead.rs", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/6186edeae52a95952e7da16a1f66d7352287427e/src%2Flibrustc_passes%2Fdead.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6186edeae52a95952e7da16a1f66d7352287427e/src%2Flibrustc_passes%2Fdead.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_passes%2Fdead.rs?ref=6186edeae52a95952e7da16a1f66d7352287427e", "patch": "@@ -579,14 +579,15 @@ impl Visitor<'tcx> for DeadVisitor<'tcx> {\n                 hir::ItemKind::Trait(..) |\n                 hir::ItemKind::Impl(..) => {\n                     // FIXME(66095): Because item.span is annotated with things\n-                    // like a macro_backtrace, and ident.span isn't, we use the\n+                    // like expansion data, and ident.span isn't, we use the\n                     // def_span method if it's part of a macro invocation\n+                    // (and thus has asource_callee set).\n                     // We should probably annotate ident.span with the macro\n                     // context, but that's a larger change.\n-                    if item.span.macro_backtrace().len() == 0 {\n-                        item.ident.span\n-                    } else {\n+                    if item.span.source_callee().is_some() {\n                         self.tcx.sess.source_map().def_span(item.span)\n+                    } else {\n+                        item.ident.span\n                     }\n                 },\n                 _ => item.span,"}]}