{"sha": "84b058ac47e2ea5f29887a4ed5ae286e37b22194", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg0YjA1OGFjNDdlMmVhNWYyOTg4N2E0ZWQ1YWUyODZlMzdiMjIxOTQ=", "commit": {"author": {"name": "DrMeepster", "email": "19316085+DrMeepster@users.noreply.github.com", "date": "2021-09-02T22:41:10Z"}, "committer": {"name": "DrMeepster", "email": "19316085+DrMeepster@users.noreply.github.com", "date": "2021-09-02T22:41:10Z"}, "message": "add support for #[start]", "tree": {"sha": "64f64ed64b058f8c174847456f08f348b690e720", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/64f64ed64b058f8c174847456f08f348b690e720"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/84b058ac47e2ea5f29887a4ed5ae286e37b22194", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/84b058ac47e2ea5f29887a4ed5ae286e37b22194", "html_url": "https://github.com/rust-lang/rust/commit/84b058ac47e2ea5f29887a4ed5ae286e37b22194", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/84b058ac47e2ea5f29887a4ed5ae286e37b22194/comments", "author": {"login": "DrMeepster", "id": 19316085, "node_id": "MDQ6VXNlcjE5MzE2MDg1", "avatar_url": "https://avatars.githubusercontent.com/u/19316085?v=4", "gravatar_id": "", "url": "https://api.github.com/users/DrMeepster", "html_url": "https://github.com/DrMeepster", "followers_url": "https://api.github.com/users/DrMeepster/followers", "following_url": "https://api.github.com/users/DrMeepster/following{/other_user}", "gists_url": "https://api.github.com/users/DrMeepster/gists{/gist_id}", "starred_url": "https://api.github.com/users/DrMeepster/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/DrMeepster/subscriptions", "organizations_url": "https://api.github.com/users/DrMeepster/orgs", "repos_url": "https://api.github.com/users/DrMeepster/repos", "events_url": "https://api.github.com/users/DrMeepster/events{/privacy}", "received_events_url": "https://api.github.com/users/DrMeepster/received_events", "type": "User", "site_admin": false}, "committer": {"login": "DrMeepster", "id": 19316085, "node_id": "MDQ6VXNlcjE5MzE2MDg1", "avatar_url": "https://avatars.githubusercontent.com/u/19316085?v=4", "gravatar_id": "", "url": "https://api.github.com/users/DrMeepster", "html_url": "https://github.com/DrMeepster", "followers_url": "https://api.github.com/users/DrMeepster/followers", "following_url": "https://api.github.com/users/DrMeepster/following{/other_user}", "gists_url": "https://api.github.com/users/DrMeepster/gists{/gist_id}", "starred_url": "https://api.github.com/users/DrMeepster/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/DrMeepster/subscriptions", "organizations_url": "https://api.github.com/users/DrMeepster/orgs", "repos_url": "https://api.github.com/users/DrMeepster/repos", "events_url": "https://api.github.com/users/DrMeepster/events{/privacy}", "received_events_url": "https://api.github.com/users/DrMeepster/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4f1fca7512dc0cb79279de810687be64ca2b38e6", "url": "https://api.github.com/repos/rust-lang/rust/commits/4f1fca7512dc0cb79279de810687be64ca2b38e6", "html_url": "https://github.com/rust-lang/rust/commit/4f1fca7512dc0cb79279de810687be64ca2b38e6"}], "stats": {"total": 114, "additions": 79, "deletions": 35}, "files": [{"sha": "be542c2bc0a6a28ffa2e8c935356410e01fc28c6", "filename": "benches/helpers/miri_helper.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/84b058ac47e2ea5f29887a4ed5ae286e37b22194/benches%2Fhelpers%2Fmiri_helper.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b058ac47e2ea5f29887a4ed5ae286e37b22194/benches%2Fhelpers%2Fmiri_helper.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/benches%2Fhelpers%2Fmiri_helper.rs?ref=84b058ac47e2ea5f29887a4ed5ae286e37b22194", "patch": "@@ -20,11 +20,12 @@ impl rustc_driver::Callbacks for MiriCompilerCalls<'_> {\n         compiler.session().abort_if_errors();\n \n         queries.global_ctxt().unwrap().peek_mut().enter(|tcx| {\n-            let (entry_def_id, _) = tcx.entry_fn(()).expect(\"no main or start function found\");\n+            let (entry_def_id, entry_type) =\n+                tcx.entry_fn(()).expect(\"no main or start function found\");\n \n             self.bencher.iter(|| {\n                 let config = miri::MiriConfig::default();\n-                miri::eval_main(tcx, entry_def_id, config);\n+                miri::eval_entry(tcx, entry_def_id, entry_type, config);\n             });\n         });\n "}, {"sha": "fbc87148ec7b71a5d3571848e3ac1968ef81afa2", "filename": "src/bin/miri.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/84b058ac47e2ea5f29887a4ed5ae286e37b22194/src%2Fbin%2Fmiri.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b058ac47e2ea5f29887a4ed5ae286e37b22194/src%2Fbin%2Fmiri.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbin%2Fmiri.rs?ref=84b058ac47e2ea5f29887a4ed5ae286e37b22194", "patch": "@@ -58,8 +58,8 @@ impl rustc_driver::Callbacks for MiriCompilerCalls {\n \n         queries.global_ctxt().unwrap().peek_mut().enter(|tcx| {\n             init_late_loggers(tcx);\n-            let (entry_def_id, _) = if let Some((entry_def, x)) = tcx.entry_fn(()) {\n-                (entry_def, x)\n+            let (entry_def_id, entry_type) = if let Some(entry_def) = tcx.entry_fn(()) {\n+                entry_def\n             } else {\n                 let output_ty = ErrorOutputType::HumanReadable(HumanReadableErrorType::Default(\n                     ColorConfig::Auto,\n@@ -79,7 +79,7 @@ impl rustc_driver::Callbacks for MiriCompilerCalls {\n                 env::set_current_dir(cwd).unwrap();\n             }\n \n-            if let Some(return_code) = miri::eval_main(tcx, entry_def_id, config) {\n+            if let Some(return_code) = miri::eval_entry(tcx, entry_def_id, entry_type, config) {\n                 std::process::exit(\n                     i32::try_from(return_code).expect(\"Return value was too large!\"),\n                 );"}, {"sha": "f90a77fafd5a1f642586f22bc2712dca609e6d64", "filename": "src/eval.rs", "status": "modified", "additions": 63, "deletions": 29, "changes": 92, "blob_url": "https://github.com/rust-lang/rust/blob/84b058ac47e2ea5f29887a4ed5ae286e37b22194/src%2Feval.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b058ac47e2ea5f29887a4ed5ae286e37b22194/src%2Feval.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Feval.rs?ref=84b058ac47e2ea5f29887a4ed5ae286e37b22194", "patch": "@@ -10,6 +10,8 @@ use rustc_middle::ty::{self, layout::LayoutCx, TyCtxt};\n use rustc_target::abi::LayoutOf;\n use rustc_target::spec::abi::Abi;\n \n+use rustc_session::config::EntryFnType;\n+\n use crate::*;\n \n #[derive(Copy, Clone, Debug, PartialEq)]\n@@ -117,12 +119,13 @@ impl Default for MiriConfig {\n }\n \n /// Returns a freshly created `InterpCx`, along with an `MPlaceTy` representing\n-/// the location where the return value of the `start` lang item will be\n+/// the location where the return value of the `start` function will be\n /// written to.\n /// Public because this is also used by `priroda`.\n pub fn create_ecx<'mir, 'tcx: 'mir>(\n     tcx: TyCtxt<'tcx>,\n-    main_id: DefId,\n+    entry_id: DefId,\n+    entry_type: EntryFnType,\n     config: MiriConfig,\n ) -> InterpResult<'tcx, (InterpCx<'mir, 'tcx, Evaluator<'mir, 'tcx>>, MPlaceTy<'tcx, Tag>)> {\n     let param_env = ty::ParamEnv::reveal_all();\n@@ -145,26 +148,14 @@ pub fn create_ecx<'mir, 'tcx: 'mir>(\n     }\n \n     // Setup first stack-frame\n-    let main_instance = ty::Instance::mono(tcx, main_id);\n-    let main_mir = ecx.load_mir(main_instance.def, None)?;\n+    let entry_instance = ty::Instance::mono(tcx, entry_id);\n+    /*let entry_mir = ecx.load_mir(entry_instance.def, None)?;\n     if main_mir.arg_count != 0 {\n         bug!(\"main function must not take any arguments\");\n-    }\n+    }*/\n+\n+    // First argument is constructed later, because its skipped if the entry function uses #[start]\n \n-    let start_id = tcx.lang_items().start_fn().unwrap();\n-    let main_ret_ty = tcx.fn_sig(main_id).output();\n-    let main_ret_ty = main_ret_ty.no_bound_vars().unwrap();\n-    let start_instance = ty::Instance::resolve(\n-        tcx,\n-        ty::ParamEnv::reveal_all(),\n-        start_id,\n-        tcx.mk_substs(::std::iter::once(ty::subst::GenericArg::from(main_ret_ty))),\n-    )\n-    .unwrap()\n-    .unwrap();\n-\n-    // First argument: pointer to `main()`.\n-    let main_ptr = ecx.memory.create_fn_alloc(FnVal::Instance(main_instance));\n     // Second argument (argc): length of `config.args`.\n     let argc = Scalar::from_machine_usize(u64::try_from(config.args.len()).unwrap(), &ecx);\n     // Third argument (`argv`): created from `config.args`.\n@@ -237,28 +228,71 @@ pub fn create_ecx<'mir, 'tcx: 'mir>(\n         argv\n     };\n \n+    /*let args: &[_] = match entry_type {\n+        EntryFnType::Main => {\n+            // First argument: pointer to `main()`.\n+            let main_ptr = ecx.memory.create_fn_alloc(FnVal::Instance(main_instance));\n+\n+            &[Scalar::from_pointer(main_ptr, &ecx).into(), argc.into(), argv]\n+        }\n+        EntryFnType::Start => &[argc.into(), argv],\n+    };*/\n+\n     // Return place (in static memory so that it does not count as leak).\n     let ret_place = ecx.allocate(ecx.machine.layouts.isize, MiriMemoryKind::Machine.into())?;\n     // Call start function.\n-    ecx.call_function(\n-        start_instance,\n-        Abi::Rust,\n-        &[Scalar::from_pointer(main_ptr, &ecx).into(), argc.into(), argv],\n-        Some(&ret_place.into()),\n-        StackPopCleanup::None { cleanup: true },\n-    )?;\n+\n+    match entry_type {\n+        EntryFnType::Main => {\n+            let start_id = tcx.lang_items().start_fn().unwrap();\n+            let main_ret_ty = tcx.fn_sig(entry_id).output();\n+            let main_ret_ty = main_ret_ty.no_bound_vars().unwrap();\n+            let start_instance = ty::Instance::resolve(\n+                tcx,\n+                ty::ParamEnv::reveal_all(),\n+                start_id,\n+                tcx.mk_substs(::std::iter::once(ty::subst::GenericArg::from(main_ret_ty))),\n+            )\n+            .unwrap()\n+            .unwrap();\n+\n+            let main_ptr = ecx.memory.create_fn_alloc(FnVal::Instance(entry_instance));\n+\n+            ecx.call_function(\n+                start_instance,\n+                Abi::Rust,\n+                &[Scalar::from_pointer(main_ptr, &ecx).into(), argc.into(), argv],\n+                Some(&ret_place.into()),\n+                StackPopCleanup::None { cleanup: true },\n+            )?;\n+        }\n+        EntryFnType::Start => {\n+            ecx.call_function(\n+                entry_instance,\n+                Abi::Rust,\n+                &[argc.into(), argv],\n+                Some(&ret_place.into()),\n+                StackPopCleanup::None { cleanup: true },\n+            )?;\n+        }\n+    }\n \n     Ok((ecx, ret_place))\n }\n \n-/// Evaluates the main function specified by `main_id`.\n+/// Evaluates the entry function specified by `entry_id`.\n /// Returns `Some(return_code)` if program executed completed.\n /// Returns `None` if an evaluation error occured.\n-pub fn eval_main<'tcx>(tcx: TyCtxt<'tcx>, main_id: DefId, config: MiriConfig) -> Option<i64> {\n+pub fn eval_entry<'tcx>(\n+    tcx: TyCtxt<'tcx>,\n+    entry_id: DefId,\n+    entry_type: EntryFnType,\n+    config: MiriConfig,\n+) -> Option<i64> {\n     // Copy setting before we move `config`.\n     let ignore_leaks = config.ignore_leaks;\n \n-    let (mut ecx, ret_place) = match create_ecx(tcx, main_id, config) {\n+    let (mut ecx, ret_place) = match create_ecx(tcx, entry_id, entry_type, config) {\n         Ok(v) => v,\n         Err(err) => {\n             err.print_backtrace();"}, {"sha": "7ed915b6d1d4bbda509e632371e7b5bf60c14ac8", "filename": "src/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/84b058ac47e2ea5f29887a4ed5ae286e37b22194/src%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b058ac47e2ea5f29887a4ed5ae286e37b22194/src%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flib.rs?ref=84b058ac47e2ea5f29887a4ed5ae286e37b22194", "patch": "@@ -60,7 +60,7 @@ pub use crate::diagnostics::{\n     NonHaltingDiagnostic, TerminationInfo,\n };\n pub use crate::eval::{\n-    create_ecx, eval_main, AlignmentCheck, IsolatedOp, MiriConfig, RejectOpWith,\n+    create_ecx, eval_entry, AlignmentCheck, IsolatedOp, MiriConfig, RejectOpWith,\n };\n pub use crate::helpers::EvalContextExt as HelpersEvalContextExt;\n pub use crate::machine::{"}, {"sha": "f25d62fa8c33532989ee7f44c14ab69a61c620b8", "filename": "tests/run-pass/start.rs", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/84b058ac47e2ea5f29887a4ed5ae286e37b22194/tests%2Frun-pass%2Fstart.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84b058ac47e2ea5f29887a4ed5ae286e37b22194/tests%2Frun-pass%2Fstart.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-pass%2Fstart.rs?ref=84b058ac47e2ea5f29887a4ed5ae286e37b22194", "patch": "@@ -0,0 +1,8 @@\n+#![feature(start)]\n+\n+#[start]\n+fn start(_: isize, _: *const *const u8) -> isize {\n+    println!(\"Hello from start!\");\n+\n+    0\n+}"}, {"sha": "d7f627d237c3e90eacc545922975ae35168f333b", "filename": "tests/run-pass/start.stdout", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/84b058ac47e2ea5f29887a4ed5ae286e37b22194/tests%2Frun-pass%2Fstart.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/84b058ac47e2ea5f29887a4ed5ae286e37b22194/tests%2Frun-pass%2Fstart.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-pass%2Fstart.stdout?ref=84b058ac47e2ea5f29887a4ed5ae286e37b22194", "patch": "@@ -0,0 +1 @@\n+Hello from start!"}]}