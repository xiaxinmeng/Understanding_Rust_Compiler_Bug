{"sha": "aa9bfdee322889eb6f419d3817d3d87060e91581", "node_id": "C_kwDOAAsO6NoAKGFhOWJmZGVlMzIyODg5ZWI2ZjQxOWQzODE3ZDNkODcwNjBlOTE1ODE", "commit": {"author": {"name": "Dylan DPC", "email": "99973273+Dylan-DPC@users.noreply.github.com", "date": "2022-08-30T05:56:49Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-08-30T05:56:49Z"}, "message": "Rollup merge of #101019 - compiler-errors:return-closure-suggestion, r=cjgillot\n\nSuggest returning closure as `impl Fn`\n\nFixes #100936", "tree": {"sha": "f90a6c7086b84cd02e6108c8d522a41c39f24eb5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f90a6c7086b84cd02e6108c8d522a41c39f24eb5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/aa9bfdee322889eb6f419d3817d3d87060e91581", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjDaahCRBK7hj4Ov3rIwAAqmsIABEYBeQi6v6m1VkRJYkP2Ucr\nwviBQl8aBuahqfIPmwrel2KEGYuNUm87mmRmGghs/BGjX/BjmYEJA///IDNKy4qB\nU73+TtXLdvlBZ9yUgAH1KtzlaJwcEmum6c7QhrUfZSWeMhEtKHB23aMhUI+nZ7ru\nN0t5eeFDEEczaWDLslQweeOz9erzRyYRVPsIdTBy1kyPXufKDTF7Nna3bceoKPvt\nOyHomdzl+xON0IZ0IQD9FdMdOyHqQHMkv0YD/cZ1rXZFdadfBNMnxMKHJ9kl4dVP\nAGObhZMi6QWK1cy4mcEbbWNxOR4iWqRh7/XRnxMY5VdiYtVnfu/S4FBPxhxPCTA=\n=WX6f\n-----END PGP SIGNATURE-----\n", "payload": "tree f90a6c7086b84cd02e6108c8d522a41c39f24eb5\nparent e63424db1961215f145befa6d362347fefcef9a1\nparent 93b7d8d2c5c9deeda285568d141c779bb8f83272\nauthor Dylan DPC <99973273+Dylan-DPC@users.noreply.github.com> 1661839009 +0530\ncommitter GitHub <noreply@github.com> 1661839009 +0530\n\nRollup merge of #101019 - compiler-errors:return-closure-suggestion, r=cjgillot\n\nSuggest returning closure as `impl Fn`\n\nFixes #100936\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/aa9bfdee322889eb6f419d3817d3d87060e91581", "html_url": "https://github.com/rust-lang/rust/commit/aa9bfdee322889eb6f419d3817d3d87060e91581", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/aa9bfdee322889eb6f419d3817d3d87060e91581/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e63424db1961215f145befa6d362347fefcef9a1", "url": "https://api.github.com/repos/rust-lang/rust/commits/e63424db1961215f145befa6d362347fefcef9a1", "html_url": "https://github.com/rust-lang/rust/commit/e63424db1961215f145befa6d362347fefcef9a1"}, {"sha": "93b7d8d2c5c9deeda285568d141c779bb8f83272", "url": "https://api.github.com/repos/rust-lang/rust/commits/93b7d8d2c5c9deeda285568d141c779bb8f83272", "html_url": "https://github.com/rust-lang/rust/commit/93b7d8d2c5c9deeda285568d141c779bb8f83272"}], "stats": {"total": 130, "additions": 106, "deletions": 24}, "files": [{"sha": "4e1bba6f1fa9f9ba588263f04103a9f4cc4f6b83", "filename": "compiler/rustc_middle/src/ty/print/pretty.rs", "status": "modified", "additions": 37, "deletions": 0, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/aa9bfdee322889eb6f419d3817d3d87060e91581/compiler%2Frustc_middle%2Fsrc%2Fty%2Fprint%2Fpretty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa9bfdee322889eb6f419d3817d3d87060e91581/compiler%2Frustc_middle%2Fsrc%2Fty%2Fprint%2Fpretty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fprint%2Fpretty.rs?ref=aa9bfdee322889eb6f419d3817d3d87060e91581", "patch": "@@ -1536,6 +1536,34 @@ pub trait PrettyPrinter<'tcx>:\n         }\n         Ok(self)\n     }\n+\n+    fn pretty_closure_as_impl(\n+        mut self,\n+        closure: ty::ClosureSubsts<'tcx>,\n+    ) -> Result<Self::Const, Self::Error> {\n+        let sig = closure.sig();\n+        let kind = closure.kind_ty().to_opt_closure_kind().unwrap_or(ty::ClosureKind::Fn);\n+\n+        write!(self, \"impl \")?;\n+        self.wrap_binder(&sig, |sig, mut cx| {\n+            define_scoped_cx!(cx);\n+\n+            p!(print(kind), \"(\");\n+            for (i, arg) in sig.inputs()[0].tuple_fields().iter().enumerate() {\n+                if i > 0 {\n+                    p!(\", \");\n+                }\n+                p!(print(arg));\n+            }\n+            p!(\")\");\n+\n+            if !sig.output().is_unit() {\n+                p!(\" -> \", print(sig.output()));\n+            }\n+\n+            Ok(cx)\n+        })\n+    }\n }\n \n // HACK(eddyb) boxed to avoid moving around a large struct by-value.\n@@ -2450,6 +2478,11 @@ impl<'tcx> ty::PolyTraitPredicate<'tcx> {\n     }\n }\n \n+#[derive(Debug, Copy, Clone, TypeFoldable, TypeVisitable, Lift)]\n+pub struct PrintClosureAsImpl<'tcx> {\n+    pub closure: ty::ClosureSubsts<'tcx>,\n+}\n+\n forward_display_to_print! {\n     ty::Region<'tcx>,\n     Ty<'tcx>,\n@@ -2542,6 +2575,10 @@ define_print_and_forward_display! {\n         p!(print(self.0.trait_ref.print_only_trait_path()));\n     }\n \n+    PrintClosureAsImpl<'tcx> {\n+        p!(pretty_closure_as_impl(self.closure))\n+    }\n+\n     ty::ParamTy {\n         p!(write(\"{}\", self.name))\n     }"}, {"sha": "80354a3f8a2260e8f61b39e37a89251470c10a75", "filename": "compiler/rustc_middle/src/ty/sty.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/aa9bfdee322889eb6f419d3817d3d87060e91581/compiler%2Frustc_middle%2Fsrc%2Fty%2Fsty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa9bfdee322889eb6f419d3817d3d87060e91581/compiler%2Frustc_middle%2Fsrc%2Fty%2Fsty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fsty.rs?ref=aa9bfdee322889eb6f419d3817d3d87060e91581", "patch": "@@ -325,6 +325,10 @@ impl<'tcx> ClosureSubsts<'tcx> {\n             _ => bug!(\"closure_sig_as_fn_ptr_ty is not a fn-ptr: {:?}\", ty.kind()),\n         }\n     }\n+\n+    pub fn print_as_impl_trait(self) -> ty::print::PrintClosureAsImpl<'tcx> {\n+        ty::print::PrintClosureAsImpl { closure: self }\n+    }\n }\n \n /// Similar to `ClosureSubsts`; see the above documentation for more."}, {"sha": "64d261285c511f146a2a193fe5e752062611e77c", "filename": "compiler/rustc_typeck/src/check/fn_ctxt/suggestions.rs", "status": "modified", "additions": 23, "deletions": 22, "changes": 45, "blob_url": "https://github.com/rust-lang/rust/blob/aa9bfdee322889eb6f419d3817d3d87060e91581/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Ffn_ctxt%2Fsuggestions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa9bfdee322889eb6f419d3817d3d87060e91581/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Ffn_ctxt%2Fsuggestions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Ffn_ctxt%2Fsuggestions.rs?ref=aa9bfdee322889eb6f419d3817d3d87060e91581", "patch": "@@ -506,30 +506,30 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n             self.resolve_numeric_literals_with_default(self.resolve_vars_if_possible(found));\n         // Only suggest changing the return type for methods that\n         // haven't set a return type at all (and aren't `fn main()` or an impl).\n-        match (\n-            &fn_decl.output,\n-            found.is_suggestable(self.tcx, false),\n-            can_suggest,\n-            expected.is_unit(),\n-        ) {\n-            (&hir::FnRetTy::DefaultReturn(span), true, true, true) => {\n-                err.subdiagnostic(AddReturnTypeSuggestion::Add { span, found });\n-                true\n-            }\n-            (&hir::FnRetTy::DefaultReturn(span), false, true, true) => {\n-                // FIXME: if `found` could be `impl Iterator` or `impl Fn*`, we should suggest\n-                // that.\n-                err.subdiagnostic(AddReturnTypeSuggestion::MissingHere { span });\n-                true\n-            }\n-            (&hir::FnRetTy::DefaultReturn(span), _, false, true) => {\n+        match &fn_decl.output {\n+            &hir::FnRetTy::DefaultReturn(span) if expected.is_unit() && !can_suggest => {\n                 // `fn main()` must return `()`, do not suggest changing return type\n                 err.subdiagnostic(ExpectedReturnTypeLabel::Unit { span });\n-                true\n+                return true;\n             }\n-            // expectation was caused by something else, not the default return\n-            (&hir::FnRetTy::DefaultReturn(_), _, _, false) => false,\n-            (&hir::FnRetTy::Return(ref ty), _, _, _) => {\n+            &hir::FnRetTy::DefaultReturn(span) if expected.is_unit() => {\n+                if found.is_suggestable(self.tcx, false) {\n+                    err.subdiagnostic(AddReturnTypeSuggestion::Add { span, found: found.to_string() });\n+                    return true;\n+                } else if let ty::Closure(_, substs) = found.kind()\n+                    // FIXME(compiler-errors): Get better at printing binders...\n+                    && let closure = substs.as_closure()\n+                    && closure.sig().is_suggestable(self.tcx, false)\n+                {\n+                    err.subdiagnostic(AddReturnTypeSuggestion::Add { span, found: closure.print_as_impl_trait().to_string() });\n+                    return true;\n+                } else {\n+                    // FIXME: if `found` could be `impl Iterator` we should suggest that.\n+                    err.subdiagnostic(AddReturnTypeSuggestion::MissingHere { span });\n+                    return true\n+                }\n+            }\n+            &hir::FnRetTy::Return(ref ty) => {\n                 // Only point to return type if the expected type is the return type, as if they\n                 // are not, the expectation must have been caused by something else.\n                 debug!(\"suggest_missing_return_type: return type {:?} node {:?}\", ty, ty.kind);\n@@ -546,9 +546,10 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                     self.try_suggest_return_impl_trait(err, expected, ty, fn_id);\n                     return true;\n                 }\n-                false\n             }\n+            _ => {}\n         }\n+        false\n     }\n \n     /// check whether the return type is a generic type with a trait bound"}, {"sha": "14c0558cdde9362fb52dea2cb6ea0054ad9d977a", "filename": "compiler/rustc_typeck/src/errors.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/aa9bfdee322889eb6f419d3817d3d87060e91581/compiler%2Frustc_typeck%2Fsrc%2Ferrors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa9bfdee322889eb6f419d3817d3d87060e91581/compiler%2Frustc_typeck%2Fsrc%2Ferrors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Ferrors.rs?ref=aa9bfdee322889eb6f419d3817d3d87060e91581", "patch": "@@ -195,7 +195,7 @@ pub struct AddressOfTemporaryTaken {\n }\n \n #[derive(SessionSubdiagnostic)]\n-pub enum AddReturnTypeSuggestion<'tcx> {\n+pub enum AddReturnTypeSuggestion {\n     #[suggestion(\n         typeck::add_return_type_add,\n         code = \"-> {found} \",\n@@ -204,7 +204,7 @@ pub enum AddReturnTypeSuggestion<'tcx> {\n     Add {\n         #[primary_span]\n         span: Span,\n-        found: Ty<'tcx>,\n+        found: String,\n     },\n     #[suggestion(\n         typeck::add_return_type_missing_here,"}, {"sha": "86c7c1537421ea7ab6e2ae3396ed7a8e82e1c0cf", "filename": "src/test/ui/suggestions/return-closures.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/aa9bfdee322889eb6f419d3817d3d87060e91581/src%2Ftest%2Fui%2Fsuggestions%2Freturn-closures.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa9bfdee322889eb6f419d3817d3d87060e91581/src%2Ftest%2Fui%2Fsuggestions%2Freturn-closures.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsuggestions%2Freturn-closures.rs?ref=aa9bfdee322889eb6f419d3817d3d87060e91581", "patch": "@@ -0,0 +1,13 @@\n+fn foo() {\n+    //~^ HELP try adding a return type\n+    |x: &i32| 1i32\n+    //~^ ERROR mismatched types\n+}\n+\n+fn bar(i: impl Sized) {\n+    //~^ HELP a return type might be missing here\n+    || i\n+    //~^ ERROR mismatched types\n+}\n+\n+fn main() {}"}, {"sha": "e273793ea2c293fbdfebd1e8790e160e4adafe4e", "filename": "src/test/ui/suggestions/return-closures.stderr", "status": "added", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/aa9bfdee322889eb6f419d3817d3d87060e91581/src%2Ftest%2Fui%2Fsuggestions%2Freturn-closures.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/aa9bfdee322889eb6f419d3817d3d87060e91581/src%2Ftest%2Fui%2Fsuggestions%2Freturn-closures.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsuggestions%2Freturn-closures.stderr?ref=aa9bfdee322889eb6f419d3817d3d87060e91581", "patch": "@@ -0,0 +1,27 @@\n+error[E0308]: mismatched types\n+  --> $DIR/return-closures.rs:3:5\n+   |\n+LL | fn foo() {\n+   |          - help: try adding a return type: `-> impl for<'r> Fn(&'r i32) -> i32`\n+LL |\n+LL |     |x: &i32| 1i32\n+   |     ^^^^^^^^^^^^^^ expected `()`, found closure\n+   |\n+   = note: expected unit type `()`\n+                found closure `[closure@$DIR/return-closures.rs:3:5: 3:14]`\n+\n+error[E0308]: mismatched types\n+  --> $DIR/return-closures.rs:9:5\n+   |\n+LL | fn bar(i: impl Sized) {\n+   |                       - help: a return type might be missing here: `-> _`\n+LL |\n+LL |     || i\n+   |     ^^^^ expected `()`, found closure\n+   |\n+   = note: expected unit type `()`\n+                found closure `[closure@$DIR/return-closures.rs:9:5: 9:7]`\n+\n+error: aborting due to 2 previous errors\n+\n+For more information about this error, try `rustc --explain E0308`."}]}