{"sha": "1b73abd1c3c9185f4a1f62c5e657e07daf3d4774", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFiNzNhYmQxYzNjOTE4NWY0YTFmNjJjNWU2NTdlMDdkYWYzZDQ3NzQ=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-02-17T19:14:32Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-02-17T19:14:32Z"}, "message": "Merge #3200\n\n3200: Merge ra_vfs_glob and ra_lsp_server r=matklad a=matklad\n\n\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>", "tree": {"sha": "33542cd2b44bd5290f18baebee460b487008035a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/33542cd2b44bd5290f18baebee460b487008035a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1b73abd1c3c9185f4a1f62c5e657e07daf3d4774", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJeSuYYCRBK7hj4Ov3rIwAAdHIIAKoCfZthymF95Hcgxp8MA3sa\nxv888uPhPVdhhlMf/i7eS6p632JyZxHThrw1P5SF2X3sdaIR/9/nAKa8w6Tr6KyQ\nC3PS/KT/eWH6Csrv0GKQC2fDbnUMmxBNaoBivSX/iuCwL4u3QOeHWI9zdiDqYDpO\nwb28v7kvXevKHNi9nGPnXJ8A1GknTiBwLlt5p5LW7Hq6cMgFs71p70Jwr4yWBSnF\nkJF0yW4Qoxb+C0/L8hGSs5Ro8YrFUD0SK8B3RQkgDvsYf9y6YN+h/5XZh0uNTLnA\nmvSBd+/c2O+b+CnmGFIb8AIMNwHYeJduTFhAMLmEdgPQy5YQ9k3pX5rt53hYS7M=\n=zpLA\n-----END PGP SIGNATURE-----\n", "payload": "tree 33542cd2b44bd5290f18baebee460b487008035a\nparent 64755b5e1f68290a2518b0bbc2f0007f95cd2632\nparent 2c9b91ad326c387190bedab9dae9d08d3eb0705a\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1581966872 +0000\ncommitter GitHub <noreply@github.com> 1581966872 +0000\n\nMerge #3200\n\n3200: Merge ra_vfs_glob and ra_lsp_server r=matklad a=matklad\n\n\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1b73abd1c3c9185f4a1f62c5e657e07daf3d4774", "html_url": "https://github.com/rust-lang/rust/commit/1b73abd1c3c9185f4a1f62c5e657e07daf3d4774", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1b73abd1c3c9185f4a1f62c5e657e07daf3d4774/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "64755b5e1f68290a2518b0bbc2f0007f95cd2632", "url": "https://api.github.com/repos/rust-lang/rust/commits/64755b5e1f68290a2518b0bbc2f0007f95cd2632", "html_url": "https://github.com/rust-lang/rust/commit/64755b5e1f68290a2518b0bbc2f0007f95cd2632"}, {"sha": "2c9b91ad326c387190bedab9dae9d08d3eb0705a", "url": "https://api.github.com/repos/rust-lang/rust/commits/2c9b91ad326c387190bedab9dae9d08d3eb0705a", "html_url": "https://github.com/rust-lang/rust/commit/2c9b91ad326c387190bedab9dae9d08d3eb0705a"}], "stats": {"total": 431, "additions": 201, "deletions": 230}, "files": [{"sha": "c22cbca3a36360faa68860d5f007c9cd6fa1e9b5", "filename": "Cargo.lock", "status": "modified", "additions": 9, "deletions": 33, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/1b73abd1c3c9185f4a1f62c5e657e07daf3d4774/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/1b73abd1c3c9185f4a1f62c5e657e07daf3d4774/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=1b73abd1c3c9185f4a1f62c5e657e07daf3d4774", "patch": "@@ -941,30 +941,6 @@ dependencies = [\n  \"rustc-hash\",\n ]\n \n-[[package]]\n-name = \"ra_cli\"\n-version = \"0.1.0\"\n-dependencies = [\n- \"anyhow\",\n- \"crossbeam-channel\",\n- \"env_logger\",\n- \"itertools\",\n- \"log\",\n- \"pico-args\",\n- \"ra_db\",\n- \"ra_hir\",\n- \"ra_hir_def\",\n- \"ra_hir_ty\",\n- \"ra_ide\",\n- \"ra_prof\",\n- \"ra_project_model\",\n- \"ra_syntax\",\n- \"ra_vfs\",\n- \"ra_vfs_glob\",\n- \"rand\",\n- \"rustc-hash\",\n-]\n-\n [[package]]\n name = \"ra_db\"\n version = \"0.1.0\"\n@@ -1122,22 +1098,30 @@ dependencies = [\n name = \"ra_lsp_server\"\n version = \"0.1.0\"\n dependencies = [\n+ \"anyhow\",\n  \"crossbeam-channel\",\n  \"either\",\n  \"env_logger\",\n+ \"globset\",\n+ \"itertools\",\n  \"jod-thread\",\n  \"log\",\n  \"lsp-server\",\n  \"lsp-types\",\n  \"parking_lot\",\n+ \"pico-args\",\n  \"ra_cargo_watch\",\n+ \"ra_db\",\n+ \"ra_hir\",\n+ \"ra_hir_def\",\n+ \"ra_hir_ty\",\n  \"ra_ide\",\n  \"ra_prof\",\n  \"ra_project_model\",\n  \"ra_syntax\",\n  \"ra_text_edit\",\n  \"ra_vfs\",\n- \"ra_vfs_glob\",\n+ \"rand\",\n  \"relative-path\",\n  \"rustc-hash\",\n  \"serde\",\n@@ -1243,14 +1227,6 @@ dependencies = [\n  \"walkdir\",\n ]\n \n-[[package]]\n-name = \"ra_vfs_glob\"\n-version = \"0.1.0\"\n-dependencies = [\n- \"globset\",\n- \"ra_vfs\",\n-]\n-\n [[package]]\n name = \"rand\"\n version = \"0.7.3\""}, {"sha": "ce88a76b1d7fe49325099e4b4175742ae184df71", "filename": "crates/ra_cli/Cargo.toml", "status": "removed", "additions": 0, "deletions": 31, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/64755b5e1f68290a2518b0bbc2f0007f95cd2632/crates%2Fra_cli%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/64755b5e1f68290a2518b0bbc2f0007f95cd2632/crates%2Fra_cli%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_cli%2FCargo.toml?ref=64755b5e1f68290a2518b0bbc2f0007f95cd2632", "patch": "@@ -1,31 +0,0 @@\n-[package]\n-edition = \"2018\"\n-name = \"ra_cli\"\n-version = \"0.1.0\"\n-authors = [\"rust-analyzer developers\"]\n-publish = false\n-\n-[dependencies]\n-crossbeam-channel = \"0.4.0\"\n-env_logger = { version = \"0.7.1\", default-features = false }\n-itertools = \"0.8.0\"\n-log = \"0.4.5\"\n-pico-args = \"0.3.0\"\n-rand = { version = \"0.7.0\", features = [\"small_rng\"] }\n-rustc-hash = \"1.0\"\n-anyhow = \"1.0\"\n-\n-hir = { path = \"../ra_hir\", package = \"ra_hir\" }\n-hir_def = { path = \"../ra_hir_def\", package = \"ra_hir_def\" }\n-hir_ty = { path = \"../ra_hir_ty\", package = \"ra_hir_ty\" }\n-ra_db = { path = \"../ra_db\" }\n-ra_ide = { path = \"../ra_ide\" }\n-ra_project_model = { path = \"../ra_project_model\" }\n-ra_syntax = { path = \"../ra_syntax\" }\n-ra_vfs = \"0.5.0\"\n-ra_vfs_glob = { path = \"../ra_vfs_glob\" }\n-\n-[dependencies.ra_prof]\n-path = \"../ra_prof\"\n-# features = [ \"cpu_profiler\" ]\n-# features = [ \"jemalloc\" ]"}, {"sha": "da523ba8a2336612d731de0ccbda9592b71952bd", "filename": "crates/ra_lsp_server/Cargo.toml", "status": "modified", "additions": 12, "deletions": 1, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/1b73abd1c3c9185f4a1f62c5e657e07daf3d4774/crates%2Fra_lsp_server%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/1b73abd1c3c9185f4a1f62c5e657e07daf3d4774/crates%2Fra_lsp_server%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2FCargo.toml?ref=1b73abd1c3c9185f4a1f62c5e657e07daf3d4774", "patch": "@@ -8,13 +8,18 @@ authors = [\"rust-analyzer developers\"]\n doctest = false\n \n [dependencies]\n+anyhow = \"1.0\"\n crossbeam-channel = \"0.4\"\n either = \"1.5\"\n env_logger = { version = \"0.7.1\", default-features = false }\n+globset = \"0.4.4\"\n+itertools = \"0.8.0\"\n jod-thread = \"0.1.0\"\n log = \"0.4.3\"\n lsp-types = { version = \"0.70.0\", features = [\"proposed\"] }\n parking_lot = \"0.10.0\"\n+pico-args = \"0.3.0\"\n+rand = { version = \"0.7.0\", features = [\"small_rng\"] }\n relative-path = \"1.0.0\"\n rustc-hash = \"1.0\"\n serde = { version = \"1.0.83\", features = [\"derive\"] }\n@@ -29,7 +34,13 @@ ra_project_model = { path = \"../ra_project_model\" }\n ra_syntax = { path = \"../ra_syntax\" }\n ra_text_edit = { path = \"../ra_text_edit\" }\n ra_vfs = \"0.5.0\"\n-ra_vfs_glob = { path = \"../ra_vfs_glob\" }\n+\n+# This should only be used in CLI\n+ra_db = { path = \"../ra_db\" }\n+hir = { path = \"../ra_hir\", package = \"ra_hir\" }\n+hir_def = { path = \"../ra_hir_def\", package = \"ra_hir_def\" }\n+hir_ty = { path = \"../ra_hir_ty\", package = \"ra_hir_ty\" }\n+\n \n [target.'cfg(windows)'.dependencies]\n winapi = \"0.3\""}, {"sha": "89e2139cec2dbdfdf85d49f3444f4e2922179234", "filename": "crates/ra_lsp_server/src/args.rs", "status": "renamed", "additions": 32, "deletions": 126, "changes": 158, "blob_url": "https://github.com/rust-lang/rust/blob/1b73abd1c3c9185f4a1f62c5e657e07daf3d4774/crates%2Fra_lsp_server%2Fsrc%2Fargs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1b73abd1c3c9185f4a1f62c5e657e07daf3d4774/crates%2Fra_lsp_server%2Fsrc%2Fargs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2Fsrc%2Fargs.rs?ref=1b73abd1c3c9185f4a1f62c5e657e07daf3d4774", "patch": "@@ -1,65 +1,20 @@\n-//! FIXME: write short doc here\n-\n-mod load_cargo;\n-mod analysis_stats;\n-mod analysis_bench;\n-mod progress_report;\n-\n-use std::{fmt::Write, io::Read, path::PathBuf, str::FromStr};\n+//! Command like parsing for rust-analyzer.\n+//!\n+//! If run started args, we run the LSP server loop. With a subcommand, we do a\n+//! one-time batch processing.\n \n+use anyhow::{bail, Result};\n use pico_args::Arguments;\n-use ra_ide::{file_structure, Analysis};\n-use ra_prof::profile;\n-use ra_syntax::{AstNode, SourceFile};\n-\n-use anyhow::{bail, format_err, Result};\n-\n-fn main() -> Result<()> {\n-    env_logger::try_init()?;\n-\n-    let command = match Command::from_env_args()? {\n-        Ok(it) => it,\n-        Err(HelpPrinted) => return Ok(()),\n-    };\n-    match command {\n-        Command::Parse { no_dump } => {\n-            let _p = profile(\"parsing\");\n-            let file = file()?;\n-            if !no_dump {\n-                println!(\"{:#?}\", file.syntax());\n-            }\n-            std::mem::forget(file);\n-        }\n-        Command::Symbols => {\n-            let file = file()?;\n-            for s in file_structure(&file) {\n-                println!(\"{:?}\", s);\n-            }\n-        }\n-        Command::Highlight { rainbow } => {\n-            let (analysis, file_id) = Analysis::from_single_file(read_stdin()?);\n-            let html = analysis.highlight_as_html(file_id, rainbow).unwrap();\n-            println!(\"{}\", html);\n-        }\n-        Command::Stats { verbosity, randomize, memory_usage, only, with_deps, path } => {\n-            analysis_stats::run(\n-                verbosity,\n-                memory_usage,\n-                path.as_ref(),\n-                only.as_ref().map(String::as_ref),\n-                with_deps,\n-                randomize,\n-            )?;\n-        }\n-        Command::Bench { verbosity, path, what } => {\n-            analysis_bench::run(verbosity, path.as_ref(), what)?;\n-        }\n-    }\n+use ra_lsp_server::cli::{BenchWhat, Position, Verbosity};\n \n-    Ok(())\n+use std::{fmt::Write, path::PathBuf};\n+\n+pub(crate) struct Args {\n+    pub(crate) verbosity: Verbosity,\n+    pub(crate) command: Command,\n }\n \n-enum Command {\n+pub(crate) enum Command {\n     Parse {\n         no_dump: bool,\n     },\n@@ -68,75 +23,28 @@ enum Command {\n         rainbow: bool,\n     },\n     Stats {\n-        verbosity: Verbosity,\n         randomize: bool,\n         memory_usage: bool,\n         only: Option<String>,\n         with_deps: bool,\n         path: PathBuf,\n     },\n     Bench {\n-        verbosity: Verbosity,\n         path: PathBuf,\n         what: BenchWhat,\n     },\n+    RunServer,\n+    Version,\n }\n \n-#[derive(Clone, Copy)]\n-pub enum Verbosity {\n-    Spammy,\n-    Verbose,\n-    Normal,\n-    Quiet,\n-}\n+impl Args {\n+    pub(crate) fn parse() -> Result<Result<Args, HelpPrinted>> {\n+        let mut matches = Arguments::from_env();\n \n-impl Verbosity {\n-    fn is_verbose(self) -> bool {\n-        match self {\n-            Verbosity::Verbose | Verbosity::Spammy => true,\n-            _ => false,\n-        }\n-    }\n-    fn is_spammy(self) -> bool {\n-        match self {\n-            Verbosity::Spammy => true,\n-            _ => false,\n+        if matches.contains(\"--version\") {\n+            matches.finish().or_else(handle_extra_flags)?;\n+            return Ok(Ok(Args { verbosity: Verbosity::Normal, command: Command::Version }));\n         }\n-    }\n-}\n-\n-enum BenchWhat {\n-    Highlight { path: PathBuf },\n-    Complete(Position),\n-    GotoDef(Position),\n-}\n-\n-pub(crate) struct Position {\n-    path: PathBuf,\n-    line: u32,\n-    column: u32,\n-}\n-\n-impl FromStr for Position {\n-    type Err = anyhow::Error;\n-    fn from_str(s: &str) -> Result<Self> {\n-        let (path_line, column) = rsplit_at_char(s, ':')?;\n-        let (path, line) = rsplit_at_char(path_line, ':')?;\n-        Ok(Position { path: path.into(), line: line.parse()?, column: column.parse()? })\n-    }\n-}\n-\n-fn rsplit_at_char(s: &str, c: char) -> Result<(&str, &str)> {\n-    let idx = s.rfind(c).ok_or_else(|| format_err!(\"no `{}` in {}\", c, s))?;\n-    Ok((&s[..idx], &s[idx + 1..]))\n-}\n-\n-struct HelpPrinted;\n-\n-impl Command {\n-    fn from_env_args() -> Result<Result<Command, HelpPrinted>> {\n-        let mut matches = Arguments::from_env();\n-        let subcommand = matches.subcommand()?.unwrap_or_default();\n \n         let verbosity = match (\n             matches.contains([\"-vv\", \"--spammy\"]),\n@@ -151,6 +59,13 @@ impl Command {\n             (false, true, true) => bail!(\"Invalid flags: -q conflicts with -v\"),\n         };\n \n+        let subcommand = match matches.subcommand()? {\n+            Some(it) => it,\n+            None => {\n+                matches.finish().or_else(handle_extra_flags)?;\n+                return Ok(Ok(Args { verbosity, command: Command::RunServer }));\n+            }\n+        };\n         let command = match subcommand.as_str() {\n             \"parse\" => {\n                 if matches.contains([\"-h\", \"--help\"]) {\n@@ -247,7 +162,7 @@ ARGS:\n                     trailing.pop().unwrap().into()\n                 };\n \n-                Command::Stats { verbosity, randomize, memory_usage, only, with_deps, path }\n+                Command::Stats { randomize, memory_usage, only, with_deps, path }\n             }\n             \"analysis-bench\" => {\n                 if matches.contains([\"-h\", \"--help\"]) {\n@@ -284,7 +199,7 @@ ARGS:\n                         \"exactly one of  `--highlight`, `--complete` or `--goto-def` must be set\"\n                     ),\n                 };\n-                Command::Bench { verbosity, path, what }\n+                Command::Bench { path, what }\n             }\n             _ => {\n                 eprintln!(\n@@ -307,10 +222,12 @@ SUBCOMMANDS:\n                 return Ok(Err(HelpPrinted));\n             }\n         };\n-        Ok(Ok(command))\n+        Ok(Ok(Args { verbosity, command }))\n     }\n }\n \n+pub(crate) struct HelpPrinted;\n+\n fn handle_extra_flags(e: pico_args::Error) -> Result<()> {\n     if let pico_args::Error::UnusedArgsLeft(flags) = e {\n         let mut invalid_flags = String::new();\n@@ -323,14 +240,3 @@ fn handle_extra_flags(e: pico_args::Error) -> Result<()> {\n         bail!(e);\n     }\n }\n-\n-fn file() -> Result<SourceFile> {\n-    let text = read_stdin()?;\n-    Ok(SourceFile::parse(&text).tree())\n-}\n-\n-fn read_stdin() -> Result<String> {\n-    let mut buff = String::new();\n-    std::io::stdin().read_to_string(&mut buff)?;\n-    Ok(buff)\n-}", "previous_filename": "crates/ra_cli/src/main.rs"}, {"sha": "3c7b8e2509a686e7123878ecde24de1b182c3cce", "filename": "crates/ra_lsp_server/src/cli.rs", "status": "added", "additions": 75, "deletions": 0, "changes": 75, "blob_url": "https://github.com/rust-lang/rust/blob/1b73abd1c3c9185f4a1f62c5e657e07daf3d4774/crates%2Fra_lsp_server%2Fsrc%2Fcli.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1b73abd1c3c9185f4a1f62c5e657e07daf3d4774/crates%2Fra_lsp_server%2Fsrc%2Fcli.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2Fsrc%2Fcli.rs?ref=1b73abd1c3c9185f4a1f62c5e657e07daf3d4774", "patch": "@@ -0,0 +1,75 @@\n+//! FIXME: write short doc here\n+\n+mod load_cargo;\n+mod analysis_stats;\n+mod analysis_bench;\n+mod progress_report;\n+\n+use std::io::Read;\n+\n+use anyhow::Result;\n+use ra_ide::{file_structure, Analysis};\n+use ra_prof::profile;\n+use ra_syntax::{AstNode, SourceFile};\n+\n+#[derive(Clone, Copy)]\n+pub enum Verbosity {\n+    Spammy,\n+    Verbose,\n+    Normal,\n+    Quiet,\n+}\n+\n+impl Verbosity {\n+    pub fn is_verbose(self) -> bool {\n+        match self {\n+            Verbosity::Verbose | Verbosity::Spammy => true,\n+            _ => false,\n+        }\n+    }\n+    pub fn is_spammy(self) -> bool {\n+        match self {\n+            Verbosity::Spammy => true,\n+            _ => false,\n+        }\n+    }\n+}\n+\n+pub fn parse(no_dump: bool) -> Result<()> {\n+    let _p = profile(\"parsing\");\n+    let file = file()?;\n+    if !no_dump {\n+        println!(\"{:#?}\", file.syntax());\n+    }\n+    std::mem::forget(file);\n+    Ok(())\n+}\n+\n+pub fn symbols() -> Result<()> {\n+    let file = file()?;\n+    for s in file_structure(&file) {\n+        println!(\"{:?}\", s);\n+    }\n+    Ok(())\n+}\n+\n+pub fn highlight(rainbow: bool) -> Result<()> {\n+    let (analysis, file_id) = Analysis::from_single_file(read_stdin()?);\n+    let html = analysis.highlight_as_html(file_id, rainbow).unwrap();\n+    println!(\"{}\", html);\n+    Ok(())\n+}\n+\n+pub use analysis_bench::{analysis_bench, BenchWhat, Position};\n+pub use analysis_stats::analysis_stats;\n+\n+fn file() -> Result<SourceFile> {\n+    let text = read_stdin()?;\n+    Ok(SourceFile::parse(&text).tree())\n+}\n+\n+fn read_stdin() -> Result<String> {\n+    let mut buff = String::new();\n+    std::io::stdin().read_to_string(&mut buff)?;\n+    Ok(buff)\n+}"}, {"sha": "e00f8107348e0ddba76119e836d412b612585e7c", "filename": "crates/ra_lsp_server/src/cli/analysis_bench.rs", "status": "renamed", "additions": 35, "deletions": 4, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/1b73abd1c3c9185f4a1f62c5e657e07daf3d4774/crates%2Fra_lsp_server%2Fsrc%2Fcli%2Fanalysis_bench.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1b73abd1c3c9185f4a1f62c5e657e07daf3d4774/crates%2Fra_lsp_server%2Fsrc%2Fcli%2Fanalysis_bench.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2Fsrc%2Fcli%2Fanalysis_bench.rs?ref=1b73abd1c3c9185f4a1f62c5e657e07daf3d4774", "patch": "@@ -1,17 +1,48 @@\n //! FIXME: write short doc here\n \n-use std::{path::Path, sync::Arc, time::Instant};\n+use std::{\n+    path::{Path, PathBuf},\n+    str::FromStr,\n+    sync::Arc,\n+    time::Instant,\n+};\n \n-use anyhow::format_err;\n+use anyhow::{format_err, Result};\n use ra_db::{\n     salsa::{Database, Durability},\n     FileId, SourceDatabaseExt,\n };\n use ra_ide::{Analysis, AnalysisChange, AnalysisHost, FilePosition, LineCol};\n \n-use crate::{load_cargo::load_cargo, BenchWhat, Result, Verbosity};\n+use crate::cli::{load_cargo::load_cargo, Verbosity};\n+\n+pub enum BenchWhat {\n+    Highlight { path: PathBuf },\n+    Complete(Position),\n+    GotoDef(Position),\n+}\n+\n+pub struct Position {\n+    pub path: PathBuf,\n+    pub line: u32,\n+    pub column: u32,\n+}\n+\n+impl FromStr for Position {\n+    type Err = anyhow::Error;\n+    fn from_str(s: &str) -> Result<Self> {\n+        let (path_line, column) = rsplit_at_char(s, ':')?;\n+        let (path, line) = rsplit_at_char(path_line, ':')?;\n+        Ok(Position { path: path.into(), line: line.parse()?, column: column.parse()? })\n+    }\n+}\n+\n+fn rsplit_at_char(s: &str, c: char) -> Result<(&str, &str)> {\n+    let idx = s.rfind(c).ok_or_else(|| format_err!(\"no `{}` in {}\", c, s))?;\n+    Ok((&s[..idx], &s[idx + 1..]))\n+}\n \n-pub(crate) fn run(verbosity: Verbosity, path: &Path, what: BenchWhat) -> Result<()> {\n+pub fn analysis_bench(verbosity: Verbosity, path: &Path, what: BenchWhat) -> Result<()> {\n     ra_prof::init();\n \n     let start = Instant::now();", "previous_filename": "crates/ra_cli/src/analysis_bench.rs"}, {"sha": "c27fabe3c4bc7d7c698cd064f3d7cb0cce3dd243", "filename": "crates/ra_lsp_server/src/cli/analysis_stats.rs", "status": "renamed", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/1b73abd1c3c9185f4a1f62c5e657e07daf3d4774/crates%2Fra_lsp_server%2Fsrc%2Fcli%2Fanalysis_stats.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1b73abd1c3c9185f4a1f62c5e657e07daf3d4774/crates%2Fra_lsp_server%2Fsrc%2Fcli%2Fanalysis_stats.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2Fsrc%2Fcli%2Fanalysis_stats.rs?ref=1b73abd1c3c9185f4a1f62c5e657e07daf3d4774", "patch": "@@ -13,9 +13,9 @@ use ra_db::SourceDatabaseExt;\n use ra_syntax::AstNode;\n use rand::{seq::SliceRandom, thread_rng};\n \n-use crate::{load_cargo::load_cargo, progress_report::ProgressReport, Result, Verbosity};\n+use crate::cli::{load_cargo::load_cargo, progress_report::ProgressReport, Result, Verbosity};\n \n-pub fn run(\n+pub fn analysis_stats(\n     verbosity: Verbosity,\n     memory_usage: bool,\n     path: &Path,", "previous_filename": "crates/ra_cli/src/analysis_stats.rs"}, {"sha": "bb3e1513b87f5b884e832db0b5514392dbe810e8", "filename": "crates/ra_lsp_server/src/cli/load_cargo.rs", "status": "renamed", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/1b73abd1c3c9185f4a1f62c5e657e07daf3d4774/crates%2Fra_lsp_server%2Fsrc%2Fcli%2Fload_cargo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1b73abd1c3c9185f4a1f62c5e657e07daf3d4774/crates%2Fra_lsp_server%2Fsrc%2Fcli%2Fload_cargo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2Fsrc%2Fcli%2Fload_cargo.rs?ref=1b73abd1c3c9185f4a1f62c5e657e07daf3d4774", "patch": "@@ -7,9 +7,10 @@ use ra_db::{CrateGraph, FileId, SourceRootId};\n use ra_ide::{AnalysisChange, AnalysisHost, FeatureFlags};\n use ra_project_model::{get_rustc_cfg_options, PackageRoot, ProjectWorkspace};\n use ra_vfs::{RootEntry, Vfs, VfsChange, VfsTask, Watch};\n-use ra_vfs_glob::RustPackageFilterBuilder;\n use rustc_hash::FxHashMap;\n \n+use crate::vfs_glob::RustPackageFilterBuilder;\n+\n use anyhow::Result;\n \n fn vfs_file_to_id(f: ra_vfs::VfsFile) -> FileId {", "previous_filename": "crates/ra_cli/src/load_cargo.rs"}, {"sha": "31867a1e973e3f29fa00f120619fba8bf1366900", "filename": "crates/ra_lsp_server/src/cli/progress_report.rs", "status": "renamed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/1b73abd1c3c9185f4a1f62c5e657e07daf3d4774/crates%2Fra_lsp_server%2Fsrc%2Fcli%2Fprogress_report.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1b73abd1c3c9185f4a1f62c5e657e07daf3d4774/crates%2Fra_lsp_server%2Fsrc%2Fcli%2Fprogress_report.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2Fsrc%2Fcli%2Fprogress_report.rs?ref=1b73abd1c3c9185f4a1f62c5e657e07daf3d4774", "previous_filename": "crates/ra_cli/src/progress_report.rs"}, {"sha": "958c70fe5fac47f989a98cd29688999c7986cdb1", "filename": "crates/ra_lsp_server/src/lib.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/1b73abd1c3c9185f4a1f62c5e657e07daf3d4774/crates%2Fra_lsp_server%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1b73abd1c3c9185f4a1f62c5e657e07daf3d4774/crates%2Fra_lsp_server%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2Fsrc%2Flib.rs?ref=1b73abd1c3c9185f4a1f62c5e657e07daf3d4774", "patch": "@@ -7,6 +7,8 @@\n //! state, and `main_loop` module defines the rules for modifying it.\n #![recursion_limit = \"512\"]\n \n+pub mod cli;\n+\n #[allow(unused)]\n macro_rules! println {\n     ($($tt:tt)*) => {\n@@ -21,6 +23,7 @@ macro_rules! print {\n     };\n }\n \n+mod vfs_glob;\n mod caps;\n mod cargo_target_spec;\n mod conv;"}, {"sha": "a549e5ff1249a85a08d6b6447aaa863ccb5085c4", "filename": "crates/ra_lsp_server/src/main.rs", "status": "modified", "additions": 29, "deletions": 17, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/1b73abd1c3c9185f4a1f62c5e657e07daf3d4774/crates%2Fra_lsp_server%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1b73abd1c3c9185f4a1f62c5e657e07daf3d4774/crates%2Fra_lsp_server%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2Fsrc%2Fmain.rs?ref=1b73abd1c3c9185f4a1f62c5e657e07daf3d4774", "patch": "@@ -1,14 +1,39 @@\n //! `ra_lsp_server` binary\n+mod args;\n \n use lsp_server::Connection;\n-use ra_lsp_server::{from_json, show_message, Result, ServerConfig};\n+use ra_lsp_server::{cli, from_json, show_message, Result, ServerConfig};\n use ra_prof;\n \n+use crate::args::HelpPrinted;\n+\n fn main() -> Result<()> {\n     setup_logging()?;\n-    match Args::parse()? {\n-        Args::Version => println!(\"rust-analyzer {}\", env!(\"REV\")),\n-        Args::Run => run_server()?,\n+    let args = match args::Args::parse()? {\n+        Ok(it) => it,\n+        Err(HelpPrinted) => return Ok(()),\n+    };\n+    match args.command {\n+        args::Command::Parse { no_dump } => cli::parse(no_dump)?,\n+        args::Command::Symbols => cli::symbols()?,\n+        args::Command::Highlight { rainbow } => cli::highlight(rainbow)?,\n+        args::Command::Stats { randomize, memory_usage, only, with_deps, path } => {\n+            cli::analysis_stats(\n+                args.verbosity,\n+                memory_usage,\n+                path.as_ref(),\n+                only.as_ref().map(String::as_ref),\n+                with_deps,\n+                randomize,\n+            )?\n+        }\n+\n+        args::Command::Bench { path, what } => {\n+            cli::analysis_bench(args.verbosity, path.as_ref(), what)?\n+        }\n+\n+        args::Command::RunServer => run_server()?,\n+        args::Command::Version => println!(\"rust-analyzer {}\", env!(\"REV\")),\n     }\n     Ok(())\n }\n@@ -20,19 +45,6 @@ fn setup_logging() -> Result<()> {\n     Ok(())\n }\n \n-enum Args {\n-    Version,\n-    Run,\n-}\n-\n-impl Args {\n-    fn parse() -> Result<Args> {\n-        let res =\n-            if std::env::args().any(|it| it == \"--version\") { Args::Version } else { Args::Run };\n-        Ok(res)\n-    }\n-}\n-\n fn run_server() -> Result<()> {\n     log::info!(\"lifecycle: server started\");\n "}, {"sha": "944074118df494c6e905d49e293b2d86937aa31a", "filename": "crates/ra_lsp_server/src/main_loop.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1b73abd1c3c9185f4a1f62c5e657e07daf3d4774/crates%2Fra_lsp_server%2Fsrc%2Fmain_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1b73abd1c3c9185f4a1f62c5e657e07daf3d4774/crates%2Fra_lsp_server%2Fsrc%2Fmain_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2Fsrc%2Fmain_loop.rs?ref=1b73abd1c3c9185f4a1f62c5e657e07daf3d4774", "patch": "@@ -135,7 +135,7 @@ pub fn main_loop(\n         let globs = config\n             .exclude_globs\n             .iter()\n-            .map(|glob| ra_vfs_glob::Glob::new(glob))\n+            .map(|glob| crate::vfs_glob::Glob::new(glob))\n             .collect::<std::result::Result<Vec<_>, _>>()?;\n \n         if config.use_client_watching {"}, {"sha": "12401d75a82d2feed80b0dc438e1ba4c36921636", "filename": "crates/ra_lsp_server/src/vfs_glob.rs", "status": "renamed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/1b73abd1c3c9185f4a1f62c5e657e07daf3d4774/crates%2Fra_lsp_server%2Fsrc%2Fvfs_glob.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1b73abd1c3c9185f4a1f62c5e657e07daf3d4774/crates%2Fra_lsp_server%2Fsrc%2Fvfs_glob.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2Fsrc%2Fvfs_glob.rs?ref=1b73abd1c3c9185f4a1f62c5e657e07daf3d4774", "previous_filename": "crates/ra_vfs_glob/src/lib.rs"}, {"sha": "71c95d4af0037faf30354c45e86bb480243e011c", "filename": "crates/ra_lsp_server/src/world.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1b73abd1c3c9185f4a1f62c5e657e07daf3d4774/crates%2Fra_lsp_server%2Fsrc%2Fworld.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1b73abd1c3c9185f4a1f62c5e657e07daf3d4774/crates%2Fra_lsp_server%2Fsrc%2Fworld.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2Fsrc%2Fworld.rs?ref=1b73abd1c3c9185f4a1f62c5e657e07daf3d4774", "patch": "@@ -19,12 +19,12 @@ use ra_ide::{\n };\n use ra_project_model::{get_rustc_cfg_options, ProjectWorkspace};\n use ra_vfs::{LineEndings, RootEntry, Vfs, VfsChange, VfsFile, VfsRoot, VfsTask, Watch};\n-use ra_vfs_glob::{Glob, RustPackageFilterBuilder};\n use relative_path::RelativePathBuf;\n \n use crate::{\n     diagnostics::{CheckFixes, DiagnosticCollection},\n     main_loop::pending_requests::{CompletedRequest, LatestRequests},\n+    vfs_glob::{Glob, RustPackageFilterBuilder},\n     LspError, Result,\n };\n "}, {"sha": "094d6d6f440bbb615c922f8abdc97cf0bfb64242", "filename": "crates/ra_vfs_glob/Cargo.toml", "status": "removed", "additions": 0, "deletions": 12, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/64755b5e1f68290a2518b0bbc2f0007f95cd2632/crates%2Fra_vfs_glob%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/64755b5e1f68290a2518b0bbc2f0007f95cd2632/crates%2Fra_vfs_glob%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_vfs_glob%2FCargo.toml?ref=64755b5e1f68290a2518b0bbc2f0007f95cd2632", "patch": "@@ -1,12 +0,0 @@\n-[package]\n-edition = \"2018\"\n-name = \"ra_vfs_glob\"\n-version = \"0.1.0\"\n-authors = [\"rust-analyzer developers\"]\n-\n-[lib]\n-doctest = false\n-\n-[dependencies]\n-ra_vfs = \"0.5.0\"\n-globset = \"0.4.4\""}, {"sha": "b2571df25825a21a7ee4ceacebf6b2b036736613", "filename": "xtask/tests/tidy-tests/docs.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/1b73abd1c3c9185f4a1f62c5e657e07daf3d4774/xtask%2Ftests%2Ftidy-tests%2Fdocs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1b73abd1c3c9185f4a1f62c5e657e07daf3d4774/xtask%2Ftests%2Ftidy-tests%2Fdocs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/xtask%2Ftests%2Ftidy-tests%2Fdocs.rs?ref=1b73abd1c3c9185f4a1f62c5e657e07daf3d4774", "patch": "@@ -73,7 +73,6 @@ fn no_docs_comments() {\n     }\n \n     let whitelist = [\n-        \"ra_cli\",\n         \"ra_db\",\n         \"ra_hir\",\n         \"ra_hir_expand\","}]}