{"sha": "125c729e05e563b1e20b52c1b7203e3ac4feab7c", "node_id": "C_kwDOAAsO6NoAKDEyNWM3MjllMDVlNTYzYjFlMjBiNTJjMWI3MjAzZTNhYzRmZWFiN2M", "commit": {"author": {"name": "David Tolnay", "email": "dtolnay@gmail.com", "date": "2022-01-21T09:26:00Z"}, "committer": {"name": "David Tolnay", "email": "dtolnay@gmail.com", "date": "2022-01-31T03:50:54Z"}, "message": "Restore a visual alignment mode for block comments", "tree": {"sha": "6f1b059ae6d86777f1c32bafd230b54da97df096", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6f1b059ae6d86777f1c32bafd230b54da97df096"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/125c729e05e563b1e20b52c1b7203e3ac4feab7c", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEERijF2Cz/ZdaBZKeK+boUO5X/bYIFAmH3XJ4ACgkQ+boUO5X/\nbYIGZhAAlSWTPxg5ILM/kRwGqkvN55fUmlfguygUYmDjO5OZZnmKZWKic4AuzY/j\nn76+VfznjJH/FYw75bpwoO6BoX9JnUohwoKsw/5sBsn0fWbHoR4bnjKf1b2dDEPR\ncoEC9xelNHp0GYn7BUl/3CrASwmD8t7vqlwiLN0vLRmqnoshO1WMmyAuQPrEjymK\n+AlfeMf1/f2JYbB1TLGm5ZE5/cUhkb93GLivWQ2pn/HtejdKKQFd3TX51DlRZ/2X\n16oSIVshZ9pHMCkcRB7IK+ng0EJSwJ66klFkJbiGDcMI/7qzviIajcfBafoi2Blx\nSeKR6UJPK7OqUTU8NhT93s5F0pYSkh8jaxF3dTLLLjfcDDTRxy2yozf9GNG9kMfo\nS0ZNLgzZDjEA+DnwVXlb0Fs/H5GgXlUB4Hk85N557yVsF5sbZ2hHYxdapIpCjQ52\nUbo5U6dDxMKUdZyFh0VjaGEchdMBjuCDtUHoxxMNFTxO9H8Cx3/D6YFbFuCgV/6X\nloB6+OBLA8OY659CVN3kkfG6HrGCaI9HmMI8ydFshAkYg7GTMGDQy5DhDZAl23nd\nEYRQwRGsurXh4G4WSlf5JiBBW4+3v35rxY28xNYr/qQ3TuWr9Ixp6RUm4ZlJKD8N\nTwTaondC6+B4OTe/eNflZ9gqyB4jEtgVvf1cNH/dq4/iWjBKd1U=\n=txRp\n-----END PGP SIGNATURE-----", "payload": "tree 6f1b059ae6d86777f1c32bafd230b54da97df096\nparent 402f322940caddcf80ee5fb8a5006be50d26ad15\nauthor David Tolnay <dtolnay@gmail.com> 1642757160 -0800\ncommitter David Tolnay <dtolnay@gmail.com> 1643601054 -0800\n\nRestore a visual alignment mode for block comments\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/125c729e05e563b1e20b52c1b7203e3ac4feab7c", "html_url": "https://github.com/rust-lang/rust/commit/125c729e05e563b1e20b52c1b7203e3ac4feab7c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/125c729e05e563b1e20b52c1b7203e3ac4feab7c/comments", "author": {"login": "dtolnay", "id": 1940490, "node_id": "MDQ6VXNlcjE5NDA0OTA=", "avatar_url": "https://avatars.githubusercontent.com/u/1940490?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dtolnay", "html_url": "https://github.com/dtolnay", "followers_url": "https://api.github.com/users/dtolnay/followers", "following_url": "https://api.github.com/users/dtolnay/following{/other_user}", "gists_url": "https://api.github.com/users/dtolnay/gists{/gist_id}", "starred_url": "https://api.github.com/users/dtolnay/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dtolnay/subscriptions", "organizations_url": "https://api.github.com/users/dtolnay/orgs", "repos_url": "https://api.github.com/users/dtolnay/repos", "events_url": "https://api.github.com/users/dtolnay/events{/privacy}", "received_events_url": "https://api.github.com/users/dtolnay/received_events", "type": "User", "site_admin": false}, "committer": {"login": "dtolnay", "id": 1940490, "node_id": "MDQ6VXNlcjE5NDA0OTA=", "avatar_url": "https://avatars.githubusercontent.com/u/1940490?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dtolnay", "html_url": "https://github.com/dtolnay", "followers_url": "https://api.github.com/users/dtolnay/followers", "following_url": "https://api.github.com/users/dtolnay/following{/other_user}", "gists_url": "https://api.github.com/users/dtolnay/gists{/gist_id}", "starred_url": "https://api.github.com/users/dtolnay/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dtolnay/subscriptions", "organizations_url": "https://api.github.com/users/dtolnay/orgs", "repos_url": "https://api.github.com/users/dtolnay/repos", "events_url": "https://api.github.com/users/dtolnay/events{/privacy}", "received_events_url": "https://api.github.com/users/dtolnay/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "402f322940caddcf80ee5fb8a5006be50d26ad15", "url": "https://api.github.com/repos/rust-lang/rust/commits/402f322940caddcf80ee5fb8a5006be50d26ad15", "html_url": "https://github.com/rust-lang/rust/commit/402f322940caddcf80ee5fb8a5006be50d26ad15"}], "stats": {"total": 40, "additions": 33, "deletions": 7}, "files": [{"sha": "e1f43cb20dc383672f9cb923cc3739f6e93f7628", "filename": "compiler/rustc_ast_pretty/src/pp.rs", "status": "modified", "additions": 29, "deletions": 3, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/125c729e05e563b1e20b52c1b7203e3ac4feab7c/compiler%2Frustc_ast_pretty%2Fsrc%2Fpp.rs", "raw_url": "https://github.com/rust-lang/rust/raw/125c729e05e563b1e20b52c1b7203e3ac4feab7c/compiler%2Frustc_ast_pretty%2Fsrc%2Fpp.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast_pretty%2Fsrc%2Fpp.rs?ref=125c729e05e563b1e20b52c1b7203e3ac4feab7c", "patch": "@@ -146,6 +146,22 @@ pub enum Breaks {\n     Inconsistent,\n }\n \n+#[derive(Clone, Copy)]\n+enum IndentStyle {\n+    /// Vertically aligned under whatever column this block begins at.\n+    ///\n+    ///     fn demo(arg1: usize,\n+    ///             arg2: usize);\n+    Visual,\n+    /// Indented relative to the indentation level of the previous line.\n+    ///\n+    ///     fn demo(\n+    ///         arg1: usize,\n+    ///         arg2: usize,\n+    ///     );\n+    Block { offset: isize },\n+}\n+\n #[derive(Clone, Copy)]\n pub struct BreakToken {\n     offset: isize,\n@@ -154,7 +170,7 @@ pub struct BreakToken {\n \n #[derive(Clone, Copy)]\n pub struct BeginToken {\n-    offset: isize,\n+    indent: IndentStyle,\n     breaks: Breaks,\n }\n \n@@ -377,7 +393,10 @@ impl Printer {\n     fn print_begin(&mut self, token: BeginToken, size: isize) {\n         if size > self.space {\n             self.print_stack.push(PrintFrame::Broken { indent: self.indent, breaks: token.breaks });\n-            self.indent = (self.indent as isize + token.offset) as usize;\n+            self.indent = match token.indent {\n+                IndentStyle::Block { offset } => (self.indent as isize + offset) as usize,\n+                IndentStyle::Visual => (self.margin - self.space) as usize,\n+            };\n         } else {\n             self.print_stack.push(PrintFrame::Fits);\n         }\n@@ -425,7 +444,10 @@ impl Printer {\n \n     /// \"raw box\"\n     pub fn rbox(&mut self, indent: usize, breaks: Breaks) {\n-        self.scan_begin(BeginToken { offset: indent as isize, breaks })\n+        self.scan_begin(BeginToken {\n+            indent: IndentStyle::Block { offset: indent as isize },\n+            breaks,\n+        })\n     }\n \n     /// Inconsistent breaking box\n@@ -438,6 +460,10 @@ impl Printer {\n         self.rbox(indent, Breaks::Consistent)\n     }\n \n+    pub fn visual_align(&mut self) {\n+        self.scan_begin(BeginToken { indent: IndentStyle::Visual, breaks: Breaks::Consistent });\n+    }\n+\n     pub fn break_offset(&mut self, n: usize, off: isize) {\n         self.scan_break(BreakToken { offset: off, blank_space: n as isize })\n     }"}, {"sha": "b575dc21961337b0976f5ae4c0d06deabc33988b", "filename": "compiler/rustc_ast_pretty/src/pprust/state.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/125c729e05e563b1e20b52c1b7203e3ac4feab7c/compiler%2Frustc_ast_pretty%2Fsrc%2Fpprust%2Fstate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/125c729e05e563b1e20b52c1b7203e3ac4feab7c/compiler%2Frustc_ast_pretty%2Fsrc%2Fpprust%2Fstate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast_pretty%2Fsrc%2Fpprust%2Fstate.rs?ref=125c729e05e563b1e20b52c1b7203e3ac4feab7c", "patch": "@@ -315,7 +315,7 @@ pub trait PrintState<'a>: std::ops::Deref<Target = pp::Printer> + std::ops::Dere\n                     self.word(cmnt.lines[0].clone());\n                     self.hardbreak()\n                 } else {\n-                    self.ibox(0);\n+                    self.visual_align();\n                     for line in &cmnt.lines {\n                         if !line.is_empty() {\n                             self.word(line.clone());"}, {"sha": "e53d51e34cefa8d3942eb09f8c52c7d0d1319f3b", "filename": "src/test/pretty/block-comment-trailing-whitespace2.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/125c729e05e563b1e20b52c1b7203e3ac4feab7c/src%2Ftest%2Fpretty%2Fblock-comment-trailing-whitespace2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/125c729e05e563b1e20b52c1b7203e3ac4feab7c/src%2Ftest%2Fpretty%2Fblock-comment-trailing-whitespace2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fpretty%2Fblock-comment-trailing-whitespace2.rs?ref=125c729e05e563b1e20b52c1b7203e3ac4feab7c", "patch": "@@ -2,7 +2,7 @@\n \n // pp-exact\n fn f() {} /*\n-The next line should not be indented.\n+          The next line should not be indented.\n \n-That one. It shouldn't have been indented.\n-*/\n+          That one. It shouldn't have been indented.\n+          */"}]}