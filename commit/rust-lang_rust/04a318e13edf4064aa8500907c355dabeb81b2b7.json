{"sha": "04a318e13edf4064aa8500907c355dabeb81b2b7", "node_id": "C_kwDOAAsO6NoAKDA0YTMxOGUxM2VkZjQwNjRhYTg1MDA5MDdjMzU1ZGFiZWI4MWIyYjc", "commit": {"author": {"name": "Josh Stone", "email": "jistone@redhat.com", "date": "2022-09-18T19:17:53Z"}, "committer": {"name": "Josh Stone", "email": "jistone@redhat.com", "date": "2022-09-18T20:26:03Z"}, "message": "Use the helper for internalizing with new PM", "tree": {"sha": "3a4d4b3b1dfa105a42fbcd28f834fa369b8f8261", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3a4d4b3b1dfa105a42fbcd28f834fa369b8f8261"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/04a318e13edf4064aa8500907c355dabeb81b2b7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/04a318e13edf4064aa8500907c355dabeb81b2b7", "html_url": "https://github.com/rust-lang/rust/commit/04a318e13edf4064aa8500907c355dabeb81b2b7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/04a318e13edf4064aa8500907c355dabeb81b2b7/comments", "author": {"login": "cuviper", "id": 36186, "node_id": "MDQ6VXNlcjM2MTg2", "avatar_url": "https://avatars.githubusercontent.com/u/36186?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cuviper", "html_url": "https://github.com/cuviper", "followers_url": "https://api.github.com/users/cuviper/followers", "following_url": "https://api.github.com/users/cuviper/following{/other_user}", "gists_url": "https://api.github.com/users/cuviper/gists{/gist_id}", "starred_url": "https://api.github.com/users/cuviper/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cuviper/subscriptions", "organizations_url": "https://api.github.com/users/cuviper/orgs", "repos_url": "https://api.github.com/users/cuviper/repos", "events_url": "https://api.github.com/users/cuviper/events{/privacy}", "received_events_url": "https://api.github.com/users/cuviper/received_events", "type": "User", "site_admin": false}, "committer": {"login": "cuviper", "id": 36186, "node_id": "MDQ6VXNlcjM2MTg2", "avatar_url": "https://avatars.githubusercontent.com/u/36186?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cuviper", "html_url": "https://github.com/cuviper", "followers_url": "https://api.github.com/users/cuviper/followers", "following_url": "https://api.github.com/users/cuviper/following{/other_user}", "gists_url": "https://api.github.com/users/cuviper/gists{/gist_id}", "starred_url": "https://api.github.com/users/cuviper/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cuviper/subscriptions", "organizations_url": "https://api.github.com/users/cuviper/orgs", "repos_url": "https://api.github.com/users/cuviper/repos", "events_url": "https://api.github.com/users/cuviper/events{/privacy}", "received_events_url": "https://api.github.com/users/cuviper/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d6318de13a470cab542c572e4450866b5307dd8b", "url": "https://api.github.com/repos/rust-lang/rust/commits/d6318de13a470cab542c572e4450866b5307dd8b", "html_url": "https://github.com/rust-lang/rust/commit/d6318de13a470cab542c572e4450866b5307dd8b"}], "stats": {"total": 7, "additions": 2, "deletions": 5}, "files": [{"sha": "09f377d349f45b2a78a7e58c923ec4c22374439f", "filename": "compiler/rustc_llvm/llvm-wrapper/PassWrapper.cpp", "status": "modified", "additions": 2, "deletions": 5, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/04a318e13edf4064aa8500907c355dabeb81b2b7/compiler%2Frustc_llvm%2Fllvm-wrapper%2FPassWrapper.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/04a318e13edf4064aa8500907c355dabeb81b2b7/compiler%2Frustc_llvm%2Fllvm-wrapper%2FPassWrapper.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_llvm%2Fllvm-wrapper%2FPassWrapper.cpp?ref=04a318e13edf4064aa8500907c355dabeb81b2b7", "patch": "@@ -31,6 +31,7 @@\n #include \"llvm/Transforms/IPO/PassManagerBuilder.h\"\n #include \"llvm/Transforms/IPO/AlwaysInliner.h\"\n #include \"llvm/Transforms/IPO/FunctionImport.h\"\n+#include \"llvm/Transforms/IPO/Internalize.h\"\n #include \"llvm/Transforms/IPO/ThinLTOBitcodeWriter.h\"\n #include \"llvm/Transforms/Utils/AddDiscriminators.h\"\n #include \"llvm/Transforms/Utils/FunctionImportUtils.h\"\n@@ -1013,8 +1014,6 @@ extern \"C\" void LLVMRustPrintPasses() {\n \n extern \"C\" void LLVMRustRunRestrictionPass(LLVMModuleRef M, char **Symbols,\n                                            size_t Len) {\n-  llvm::legacy::PassManager passes;\n-\n   auto PreserveFunctions = [=](const GlobalValue &GV) {\n     for (size_t I = 0; I < Len; I++) {\n       if (GV.getName() == Symbols[I]) {\n@@ -1024,9 +1023,7 @@ extern \"C\" void LLVMRustRunRestrictionPass(LLVMModuleRef M, char **Symbols,\n     return false;\n   };\n \n-  passes.add(llvm::createInternalizePass(PreserveFunctions));\n-\n-  passes.run(*unwrap(M));\n+  internalizeModule(*unwrap(M), PreserveFunctions);\n }\n \n extern \"C\" void"}]}