{"sha": "9493d4b95c55a4ed502751170a0d86f9b5e305d8", "node_id": "MDY6Q29tbWl0NzI0NzEyOjk0OTNkNGI5NWM1NWE0ZWQ1MDI3NTExNzBhMGQ4NmY5YjVlMzA1ZDg=", "commit": {"author": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2017-12-01T17:38:54Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2017-12-01T17:38:54Z"}, "message": "Rollup merge of #46373 - jakllsch:netbsd-kern_proc_pathname, r=kennytm\n\nNetBSD: add sysctl backend for std::env::current_exe\n\nUse the CTL_KERN.KERN_PROC_ARGS.-1.KERN_PROC_PATHNAME sysctl in\npreference over the /proc/curproc/exe symlink.\n\nAdditionally, perform more validation of aformentioned symlink.\nParticularly on pre-8.x NetBSD this symlink will point to '/' when\naccurate information is unavailable.", "tree": {"sha": "a497deded4ebcae8e3697af1f6d076df96b9976f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a497deded4ebcae8e3697af1f6d076df96b9976f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9493d4b95c55a4ed502751170a0d86f9b5e305d8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9493d4b95c55a4ed502751170a0d86f9b5e305d8", "html_url": "https://github.com/rust-lang/rust/commit/9493d4b95c55a4ed502751170a0d86f9b5e305d8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9493d4b95c55a4ed502751170a0d86f9b5e305d8/comments", "author": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "263eb4d7ef221e075102c76d85bd7b0d874457b2", "url": "https://api.github.com/repos/rust-lang/rust/commits/263eb4d7ef221e075102c76d85bd7b0d874457b2", "html_url": "https://github.com/rust-lang/rust/commit/263eb4d7ef221e075102c76d85bd7b0d874457b2"}, {"sha": "ccef9696f13b39b619f7b12d770a2908cc2ecdd3", "url": "https://api.github.com/repos/rust-lang/rust/commits/ccef9696f13b39b619f7b12d770a2908cc2ecdd3", "html_url": "https://github.com/rust-lang/rust/commit/ccef9696f13b39b619f7b12d770a2908cc2ecdd3"}], "stats": {"total": 29, "additions": 28, "deletions": 1}, "files": [{"sha": "4f33a2b12fe5d1447fa20fcbbf1c84c8cb583dd4", "filename": "src/libstd/sys/unix/os.rs", "status": "modified", "additions": 28, "deletions": 1, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/9493d4b95c55a4ed502751170a0d86f9b5e305d8/src%2Flibstd%2Fsys%2Funix%2Fos.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9493d4b95c55a4ed502751170a0d86f9b5e305d8/src%2Flibstd%2Fsys%2Funix%2Fos.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Funix%2Fos.rs?ref=9493d4b95c55a4ed502751170a0d86f9b5e305d8", "patch": "@@ -223,7 +223,34 @@ pub fn current_exe() -> io::Result<PathBuf> {\n \n #[cfg(target_os = \"netbsd\")]\n pub fn current_exe() -> io::Result<PathBuf> {\n-    ::fs::read_link(\"/proc/curproc/exe\")\n+    fn sysctl() -> io::Result<PathBuf> {\n+        unsafe {\n+            let mib = [libc::CTL_KERN, libc::KERN_PROC_ARGS, -1, libc::KERN_PROC_PATHNAME];\n+            let mut path_len: usize = 0;\n+            cvt(libc::sysctl(mib.as_ptr(), mib.len() as ::libc::c_uint,\n+                             ptr::null_mut(), &mut path_len,\n+                             ptr::null(), 0))?;\n+            if path_len <= 1 {\n+                return Err(io::Error::new(io::ErrorKind::Other,\n+                           \"KERN_PROC_PATHNAME sysctl returned zero-length string\"))\n+            }\n+            let mut path: Vec<u8> = Vec::with_capacity(path_len);\n+            cvt(libc::sysctl(mib.as_ptr(), mib.len() as ::libc::c_uint,\n+                             path.as_ptr() as *mut libc::c_void, &mut path_len,\n+                             ptr::null(), 0))?;\n+            path.set_len(path_len - 1); // chop off NUL\n+            Ok(PathBuf::from(OsString::from_vec(path)))\n+        }\n+    }\n+    fn procfs() -> io::Result<PathBuf> {\n+        let curproc_exe = path::Path::new(\"/proc/curproc/exe\");\n+        if curproc_exe.is_file() {\n+            return ::fs::read_link(curproc_exe);\n+        }\n+        Err(io::Error::new(io::ErrorKind::Other,\n+                           \"/proc/curproc/exe doesn't point to regular file.\"))\n+    }\n+    sysctl().or_else(|_| procfs())\n }\n \n #[cfg(any(target_os = \"bitrig\", target_os = \"openbsd\"))]"}]}