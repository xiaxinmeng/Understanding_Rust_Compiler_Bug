{"sha": "392d2728683f140f6125732240e462c43c5caff4", "node_id": "C_kwDOAAsO6NoAKDM5MmQyNzI4NjgzZjE0MGY2MTI1NzMyMjQwZTQ2MmM0M2M1Y2FmZjQ", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-06-16T05:02:10Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-06-16T05:02:10Z"}, "message": "Auto merge of #98108 - SpriteOvO:doc_auto_cfg-feature-rmv-fix, r=notriddle,GuillaumeGomez\n\nRustdoc: Fix stab disappearing and exclude cfg \"doc\" and \"doctest\"\n\nFixes #98065 Context: https://github.com/rust-lang/rust/issues/43781#issuecomment-1154226733\n\nr? `@GuillaumeGomez`", "tree": {"sha": "ea61999d8da3f7c3716db2eb21c39ed1d98682bb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ea61999d8da3f7c3716db2eb21c39ed1d98682bb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/392d2728683f140f6125732240e462c43c5caff4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/392d2728683f140f6125732240e462c43c5caff4", "html_url": "https://github.com/rust-lang/rust/commit/392d2728683f140f6125732240e462c43c5caff4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/392d2728683f140f6125732240e462c43c5caff4/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1b9daa69640970e7858b7c8e1c9f72c604985e11", "url": "https://api.github.com/repos/rust-lang/rust/commits/1b9daa69640970e7858b7c8e1c9f72c604985e11", "html_url": "https://github.com/rust-lang/rust/commit/1b9daa69640970e7858b7c8e1c9f72c604985e11"}, {"sha": "713578b82791523afa62803f02a9fc7eef2c3368", "url": "https://api.github.com/repos/rust-lang/rust/commits/713578b82791523afa62803f02a9fc7eef2c3368", "html_url": "https://github.com/rust-lang/rust/commit/713578b82791523afa62803f02a9fc7eef2c3368"}], "stats": {"total": 52, "additions": 40, "deletions": 12}, "files": [{"sha": "f33f5d27d1a9fa74c7bbbe4602adb3f3d2bfd9dc", "filename": "src/librustdoc/clean/cfg.rs", "status": "modified", "additions": 9, "deletions": 5, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/392d2728683f140f6125732240e462c43c5caff4/src%2Flibrustdoc%2Fclean%2Fcfg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/392d2728683f140f6125732240e462c43c5caff4/src%2Flibrustdoc%2Fclean%2Fcfg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Fcfg.rs?ref=392d2728683f140f6125732240e462c43c5caff4", "patch": "@@ -87,15 +87,20 @@ impl Cfg {\n                 }),\n             },\n             MetaItemKind::List(ref items) => {\n+                let orig_len = items.len();\n                 let sub_cfgs =\n                     items.iter().filter_map(|i| Cfg::parse_nested(i, exclude).transpose());\n                 let ret = match name {\n                     sym::all => sub_cfgs.fold(Ok(Cfg::True), |x, y| Ok(x? & y?)),\n                     sym::any => sub_cfgs.fold(Ok(Cfg::False), |x, y| Ok(x? | y?)),\n                     sym::not => {\n-                        let mut sub_cfgs = sub_cfgs.collect::<Vec<_>>();\n-                        if sub_cfgs.len() == 1 {\n-                            Ok(!sub_cfgs.pop().unwrap()?)\n+                        if orig_len == 1 {\n+                            let mut sub_cfgs = sub_cfgs.collect::<Vec<_>>();\n+                            if sub_cfgs.len() == 1 {\n+                                Ok(!sub_cfgs.pop().unwrap()?)\n+                            } else {\n+                                return Ok(None);\n+                            }\n                         } else {\n                             Err(InvalidCfgError { msg: \"expected 1 cfg-pattern\", span: cfg.span })\n                         }\n@@ -304,8 +309,7 @@ impl ops::BitAnd for Cfg {\n impl ops::BitOrAssign for Cfg {\n     fn bitor_assign(&mut self, other: Cfg) {\n         match (self, other) {\n-            (&mut Cfg::True, _) | (_, Cfg::False) => {}\n-            (s, Cfg::True) => *s = Cfg::True,\n+            (Cfg::True, _) | (_, Cfg::False) | (_, Cfg::True) => {}\n             (s @ &mut Cfg::False, b) => *s = b,\n             (&mut Cfg::Any(ref mut a), Cfg::Any(ref mut b)) => {\n                 for c in b.drain(..) {"}, {"sha": "7f72d5d39a75283bc061e15796bca6f723a09a24", "filename": "src/librustdoc/clean/cfg/tests.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/392d2728683f140f6125732240e462c43c5caff4/src%2Flibrustdoc%2Fclean%2Fcfg%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/392d2728683f140f6125732240e462c43c5caff4/src%2Flibrustdoc%2Fclean%2Fcfg%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Fcfg%2Ftests.rs?ref=392d2728683f140f6125732240e462c43c5caff4", "patch": "@@ -161,7 +161,7 @@ fn test_cfg_or() {\n \n         x = word_cfg(\"test\");\n         x |= Cfg::True;\n-        assert_eq!(x, Cfg::True);\n+        assert_eq!(x, word_cfg(\"test\"));\n \n         x = word_cfg(\"test2\");\n         x |= Cfg::False;"}, {"sha": "ac934f6925d0bd24082fb1cd688ee6d15d43ad2c", "filename": "src/librustdoc/visit_ast.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/392d2728683f140f6125732240e462c43c5caff4/src%2Flibrustdoc%2Fvisit_ast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/392d2728683f140f6125732240e462c43c5caff4/src%2Flibrustdoc%2Fvisit_ast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fvisit_ast.rs?ref=392d2728683f140f6125732240e462c43c5caff4", "patch": "@@ -141,7 +141,10 @@ impl<'a, 'tcx> RustdocVisitor<'a, 'tcx> {\n                     })\n                     .collect::<Vec<_>>()\n             })\n-            .chain([Cfg::Cfg(sym::test, None)].into_iter())\n+            .chain(\n+                [Cfg::Cfg(sym::test, None), Cfg::Cfg(sym::doc, None), Cfg::Cfg(sym::doctest, None)]\n+                    .into_iter(),\n+            )\n             .collect();\n \n         self.cx.cache.exact_paths = self.exact_paths;"}, {"sha": "7842ee69c9f67241a99623cf7bbd752b6c40fa60", "filename": "src/test/rustdoc/doc-auto-cfg.rs", "status": "modified", "additions": 26, "deletions": 5, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/392d2728683f140f6125732240e462c43c5caff4/src%2Ftest%2Frustdoc%2Fdoc-auto-cfg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/392d2728683f140f6125732240e462c43c5caff4/src%2Ftest%2Frustdoc%2Fdoc-auto-cfg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fdoc-auto-cfg.rs?ref=392d2728683f140f6125732240e462c43c5caff4", "patch": "@@ -1,14 +1,35 @@\n #![feature(doc_auto_cfg)]\n-\n #![crate_name = \"foo\"]\n \n // @has foo/fn.foo.html\n-// @has - '//*[@class=\"item-info\"]/*[@class=\"stab portability\"]' 'non-doctest'\n-#[cfg(not(doctest))]\n+// @has - '//*[@class=\"item-info\"]/*[@class=\"stab portability\"]' 'non-meowmeow'\n+#[cfg(not(meowmeow))]\n pub fn foo() {}\n \n // @has foo/fn.bar.html\n-// @has - '//*[@class=\"item-info\"]/*[@class=\"stab portability\"]' 'doc'\n+// @has - '//*[@class=\"item-info\"]/*[@class=\"stab portability\"]' 'meowmeow'\n // @!has - '//*[@class=\"item-info\"]/*[@class=\"stab portability\"]' 'test'\n-#[cfg(any(test, doc))]\n+// @!has - '//*[@class=\"item-info\"]/*[@class=\"stab portability\"]' 'doc'\n+// @!has - '//*[@class=\"item-info\"]/*[@class=\"stab portability\"]' 'doctest'\n+#[cfg(any(meowmeow, test, doc, doctest))]\n pub fn bar() {}\n+\n+// @has foo/fn.appear_1.html\n+// @has - '//*[@class=\"item-info\"]/*[@class=\"stab portability\"]' 'meowmeow'\n+// @!has - '//*[@class=\"item-info\"]/*[@class=\"stab portability\"]' 'doc'\n+// @!has - '//*[@class=\"item-info\"]/*[@class=\"stab portability\"]' 'non-test'\n+#[cfg(any(meowmeow, doc, not(test)))]\n+pub fn appear_1() {} // issue #98065\n+\n+// @has foo/fn.appear_2.html\n+// @has - '//*[@class=\"item-info\"]/*[@class=\"stab portability\"]' 'meowmeow'\n+// @!has - '//*[@class=\"item-info\"]/*[@class=\"stab portability\"]' 'doc'\n+// @!has - '//*[@class=\"item-info\"]/*[@class=\"stab portability\"]' 'test'\n+#[cfg(any(meowmeow, doc, all(test)))]\n+pub fn appear_2() {} // issue #98065\n+\n+// @has foo/fn.appear_3.html\n+// @has - '//*[@class=\"item-info\"]/*[@class=\"stab portability\"]' 'meowmeow'\n+// @!has - '//*[@class=\"item-info\"]/*[@class=\"stab portability\"]' 'doc'\n+#[cfg(any(meowmeow, doc, all()))]\n+pub fn appear_3() {} // issue #98065"}]}