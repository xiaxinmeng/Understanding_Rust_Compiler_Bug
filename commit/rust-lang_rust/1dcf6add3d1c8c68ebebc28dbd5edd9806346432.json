{"sha": "1dcf6add3d1c8c68ebebc28dbd5edd9806346432", "node_id": "C_kwDOAAsO6NoAKDFkY2Y2YWRkM2QxYzhjNjhlYmViYzI4ZGJkNWVkZDk4MDYzNDY0MzI", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-12-01T01:22:32Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-12-01T01:22:32Z"}, "message": "Auto merge of #104160 - Ayush1325:windows-args, r=m-ou-se\n\n  Extract WStrUnits to sys_common::wstr\n\nThis commit extracts WStrUnits from sys::windows::args to sys_common::wstr. This allows using the same structure for other targets which use wtf8 (example UEFI).\n\nThis was originally a part of https://github.com/rust-lang/rust/pull/100316\n\nSigned-off-by: Ayush Singh <ayushsingh1325@gmail.com>", "tree": {"sha": "76f05fb9eb9de5e30212cdf895eb8184d6f32c67", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/76f05fb9eb9de5e30212cdf895eb8184d6f32c67"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1dcf6add3d1c8c68ebebc28dbd5edd9806346432", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1dcf6add3d1c8c68ebebc28dbd5edd9806346432", "html_url": "https://github.com/rust-lang/rust/commit/1dcf6add3d1c8c68ebebc28dbd5edd9806346432", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1dcf6add3d1c8c68ebebc28dbd5edd9806346432/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c97b539e408ea353f4fde2f9251d598291fec421", "url": "https://api.github.com/repos/rust-lang/rust/commits/c97b539e408ea353f4fde2f9251d598291fec421", "html_url": "https://github.com/rust-lang/rust/commit/c97b539e408ea353f4fde2f9251d598291fec421"}, {"sha": "348a0585054d633b50f515d95e3c42ea8721e106", "url": "https://api.github.com/repos/rust-lang/rust/commits/348a0585054d633b50f515d95e3c42ea8721e106", "html_url": "https://github.com/rust-lang/rust/commit/348a0585054d633b50f515d95e3c42ea8721e106"}], "stats": {"total": 114, "additions": 62, "deletions": 52}, "files": [{"sha": "6741ae46d32ddfa79c265e46053ce71680e652b6", "filename": "library/std/src/sys/windows/args.rs", "status": "modified", "additions": 2, "deletions": 52, "changes": 54, "blob_url": "https://github.com/rust-lang/rust/blob/1dcf6add3d1c8c68ebebc28dbd5edd9806346432/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fargs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1dcf6add3d1c8c68ebebc28dbd5edd9806346432/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fargs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fargs.rs?ref=1dcf6add3d1c8c68ebebc28dbd5edd9806346432", "patch": "@@ -9,17 +9,16 @@ mod tests;\n use crate::ffi::OsString;\n use crate::fmt;\n use crate::io;\n-use crate::marker::PhantomData;\n use crate::num::NonZeroU16;\n use crate::os::windows::prelude::*;\n use crate::path::PathBuf;\n-use crate::ptr::NonNull;\n use crate::sys::c;\n use crate::sys::process::ensure_no_nuls;\n use crate::sys::windows::os::current_exe;\n+use crate::sys_common::wstr::WStrUnits;\n use crate::vec;\n \n-use core::iter;\n+use crate::iter;\n \n /// This is the const equivalent to `NonZeroU16::new(n).unwrap()`\n ///\n@@ -199,55 +198,6 @@ impl ExactSizeIterator for Args {\n     }\n }\n \n-/// A safe iterator over a LPWSTR\n-/// (aka a pointer to a series of UTF-16 code units terminated by a NULL).\n-struct WStrUnits<'a> {\n-    // The pointer must never be null...\n-    lpwstr: NonNull<u16>,\n-    // ...and the memory it points to must be valid for this lifetime.\n-    lifetime: PhantomData<&'a [u16]>,\n-}\n-impl WStrUnits<'_> {\n-    /// Create the iterator. Returns `None` if `lpwstr` is null.\n-    ///\n-    /// SAFETY: `lpwstr` must point to a null-terminated wide string that lives\n-    /// at least as long as the lifetime of this struct.\n-    unsafe fn new(lpwstr: *const u16) -> Option<Self> {\n-        Some(Self { lpwstr: NonNull::new(lpwstr as _)?, lifetime: PhantomData })\n-    }\n-    fn peek(&self) -> Option<NonZeroU16> {\n-        // SAFETY: It's always safe to read the current item because we don't\n-        // ever move out of the array's bounds.\n-        unsafe { NonZeroU16::new(*self.lpwstr.as_ptr()) }\n-    }\n-    /// Advance the iterator while `predicate` returns true.\n-    /// Returns the number of items it advanced by.\n-    fn advance_while<P: FnMut(NonZeroU16) -> bool>(&mut self, mut predicate: P) -> usize {\n-        let mut counter = 0;\n-        while let Some(w) = self.peek() {\n-            if !predicate(w) {\n-                break;\n-            }\n-            counter += 1;\n-            self.next();\n-        }\n-        counter\n-    }\n-}\n-impl Iterator for WStrUnits<'_> {\n-    // This can never return zero as that marks the end of the string.\n-    type Item = NonZeroU16;\n-    fn next(&mut self) -> Option<NonZeroU16> {\n-        // SAFETY: If NULL is reached we immediately return.\n-        // Therefore it's safe to advance the pointer after that.\n-        unsafe {\n-            let next = self.peek()?;\n-            self.lpwstr = NonNull::new_unchecked(self.lpwstr.as_ptr().add(1));\n-            Some(next)\n-        }\n-    }\n-}\n-\n #[derive(Debug)]\n pub(crate) enum Arg {\n     /// Add quotes (if needed)"}, {"sha": "b1987aa0f6286b2333e36a45aadf576e1f7a395f", "filename": "library/std/src/sys_common/mod.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/1dcf6add3d1c8c68ebebc28dbd5edd9806346432/library%2Fstd%2Fsrc%2Fsys_common%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1dcf6add3d1c8c68ebebc28dbd5edd9806346432/library%2Fstd%2Fsrc%2Fsys_common%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys_common%2Fmod.rs?ref=1dcf6add3d1c8c68ebebc28dbd5edd9806346432", "patch": "@@ -32,6 +32,7 @@ pub mod thread;\n pub mod thread_info;\n pub mod thread_local_dtor;\n pub mod thread_parker;\n+pub mod wstr;\n pub mod wtf8;\n \n cfg_if::cfg_if! {"}, {"sha": "b230fd1a829f72864139c173e310b6dbcde70b58", "filename": "library/std/src/sys_common/wstr.rs", "status": "added", "additions": 59, "deletions": 0, "changes": 59, "blob_url": "https://github.com/rust-lang/rust/blob/1dcf6add3d1c8c68ebebc28dbd5edd9806346432/library%2Fstd%2Fsrc%2Fsys_common%2Fwstr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1dcf6add3d1c8c68ebebc28dbd5edd9806346432/library%2Fstd%2Fsrc%2Fsys_common%2Fwstr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys_common%2Fwstr.rs?ref=1dcf6add3d1c8c68ebebc28dbd5edd9806346432", "patch": "@@ -0,0 +1,59 @@\n+//! This module contains constructs to work with 16-bit characters (UCS-2 or UTF-16)\n+#![allow(dead_code)]\n+\n+use crate::marker::PhantomData;\n+use crate::num::NonZeroU16;\n+use crate::ptr::NonNull;\n+\n+/// A safe iterator over a LPWSTR\n+/// (aka a pointer to a series of UTF-16 code units terminated by a NULL).\n+pub struct WStrUnits<'a> {\n+    // The pointer must never be null...\n+    lpwstr: NonNull<u16>,\n+    // ...and the memory it points to must be valid for this lifetime.\n+    lifetime: PhantomData<&'a [u16]>,\n+}\n+\n+impl WStrUnits<'_> {\n+    /// Create the iterator. Returns `None` if `lpwstr` is null.\n+    ///\n+    /// SAFETY: `lpwstr` must point to a null-terminated wide string that lives\n+    /// at least as long as the lifetime of this struct.\n+    pub unsafe fn new(lpwstr: *const u16) -> Option<Self> {\n+        Some(Self { lpwstr: NonNull::new(lpwstr as _)?, lifetime: PhantomData })\n+    }\n+\n+    pub fn peek(&self) -> Option<NonZeroU16> {\n+        // SAFETY: It's always safe to read the current item because we don't\n+        // ever move out of the array's bounds.\n+        unsafe { NonZeroU16::new(*self.lpwstr.as_ptr()) }\n+    }\n+\n+    /// Advance the iterator while `predicate` returns true.\n+    /// Returns the number of items it advanced by.\n+    pub fn advance_while<P: FnMut(NonZeroU16) -> bool>(&mut self, mut predicate: P) -> usize {\n+        let mut counter = 0;\n+        while let Some(w) = self.peek() {\n+            if !predicate(w) {\n+                break;\n+            }\n+            counter += 1;\n+            self.next();\n+        }\n+        counter\n+    }\n+}\n+\n+impl Iterator for WStrUnits<'_> {\n+    // This can never return zero as that marks the end of the string.\n+    type Item = NonZeroU16;\n+    fn next(&mut self) -> Option<NonZeroU16> {\n+        // SAFETY: If NULL is reached we immediately return.\n+        // Therefore it's safe to advance the pointer after that.\n+        unsafe {\n+            let next = self.peek()?;\n+            self.lpwstr = NonNull::new_unchecked(self.lpwstr.as_ptr().add(1));\n+            Some(next)\n+        }\n+    }\n+}"}]}