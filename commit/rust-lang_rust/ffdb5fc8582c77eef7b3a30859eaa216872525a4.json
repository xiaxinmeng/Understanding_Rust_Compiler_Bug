{"sha": "ffdb5fc8582c77eef7b3a30859eaa216872525a4", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZmZGI1ZmM4NTgyYzc3ZWVmN2IzYTMwODU5ZWFhMjE2ODcyNTI1YTQ=", "commit": {"author": {"name": "Patrick Walton", "email": "pcwalton@mimiga.net", "date": "2010-09-07T23:35:00Z"}, "committer": {"name": "Patrick Walton", "email": "pcwalton@mimiga.net", "date": "2010-09-07T23:35:21Z"}, "message": "Initial support for a global crate metadata cache", "tree": {"sha": "f43afee8d7fcbad87aac197bc774b11e440edfad", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f43afee8d7fcbad87aac197bc774b11e440edfad"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ffdb5fc8582c77eef7b3a30859eaa216872525a4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ffdb5fc8582c77eef7b3a30859eaa216872525a4", "html_url": "https://github.com/rust-lang/rust/commit/ffdb5fc8582c77eef7b3a30859eaa216872525a4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ffdb5fc8582c77eef7b3a30859eaa216872525a4/comments", "author": {"login": "pcwalton", "id": 157897, "node_id": "MDQ6VXNlcjE1Nzg5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/157897?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pcwalton", "html_url": "https://github.com/pcwalton", "followers_url": "https://api.github.com/users/pcwalton/followers", "following_url": "https://api.github.com/users/pcwalton/following{/other_user}", "gists_url": "https://api.github.com/users/pcwalton/gists{/gist_id}", "starred_url": "https://api.github.com/users/pcwalton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pcwalton/subscriptions", "organizations_url": "https://api.github.com/users/pcwalton/orgs", "repos_url": "https://api.github.com/users/pcwalton/repos", "events_url": "https://api.github.com/users/pcwalton/events{/privacy}", "received_events_url": "https://api.github.com/users/pcwalton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pcwalton", "id": 157897, "node_id": "MDQ6VXNlcjE1Nzg5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/157897?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pcwalton", "html_url": "https://github.com/pcwalton", "followers_url": "https://api.github.com/users/pcwalton/followers", "following_url": "https://api.github.com/users/pcwalton/following{/other_user}", "gists_url": "https://api.github.com/users/pcwalton/gists{/gist_id}", "starred_url": "https://api.github.com/users/pcwalton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pcwalton/subscriptions", "organizations_url": "https://api.github.com/users/pcwalton/orgs", "repos_url": "https://api.github.com/users/pcwalton/repos", "events_url": "https://api.github.com/users/pcwalton/events{/privacy}", "received_events_url": "https://api.github.com/users/pcwalton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ca1475382e592176884187877a80900578bcf72b", "url": "https://api.github.com/repos/rust-lang/rust/commits/ca1475382e592176884187877a80900578bcf72b", "html_url": "https://github.com/rust-lang/rust/commit/ca1475382e592176884187877a80900578bcf72b"}], "stats": {"total": 28, "additions": 22, "deletions": 6}, "files": [{"sha": "40d792567549e8469a395040fd6ac5ba9d6e2ac2", "filename": "src/boot/driver/lib.ml", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/ffdb5fc8582c77eef7b3a30859eaa216872525a4/src%2Fboot%2Fdriver%2Flib.ml", "raw_url": "https://github.com/rust-lang/rust/raw/ffdb5fc8582c77eef7b3a30859eaa216872525a4/src%2Fboot%2Fdriver%2Flib.ml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fboot%2Fdriver%2Flib.ml?ref=ffdb5fc8582c77eef7b3a30859eaa216872525a4", "patch": "@@ -59,7 +59,7 @@ let get_sects\n let get_meta\n     (sess:Session.sess)\n     (filename:filename)\n-    : Ast.meta option =\n+    : Session.meta option =\n   htab_search_or_add meta_cache filename\n     begin\n       fun _ ->\n@@ -190,6 +190,10 @@ let get_mod\n                           match get_meta sess file with\n                               None -> ()\n                             | Some meta ->\n+                                if not (Hashtbl.mem\n+                                    sess.Session.sess_crate_meta meta) then\n+                                  Hashtbl.add sess.Session.sess_crate_meta\n+                                    meta (Session.make_crate_id sess);\n                                 Array.iter\n                                   (fun (k,v) -> log sess \"%s = %S\" k v)\n                                   meta;"}, {"sha": "199a372954d2ef172e42d5dec52a7a14381cbee7", "filename": "src/boot/driver/main.ml", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ffdb5fc8582c77eef7b3a30859eaa216872525a4/src%2Fboot%2Fdriver%2Fmain.ml", "raw_url": "https://github.com/rust-lang/rust/raw/ffdb5fc8582c77eef7b3a30859eaa216872525a4/src%2Fboot%2Fdriver%2Fmain.ml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fboot%2Fdriver%2Fmain.ml?ref=ffdb5fc8582c77eef7b3a30859eaa216872525a4", "patch": "@@ -58,8 +58,10 @@ let (sess:Session.sess) =\n     Session.sess_report_timing = false;\n     Session.sess_report_gc = false;\n     Session.sess_report_deps = false;\n+    Session.sess_next_crate_id = 0;\n     Session.sess_timings = Hashtbl.create 0;\n     Session.sess_lib_dirs = Queue.create ();\n+    Session.sess_crate_meta = Hashtbl.create 0;\n   }\n ;;\n "}, {"sha": "ce5a18fb9f0d7f04c7c77ba5b9ad8b4fabbb19ec", "filename": "src/boot/driver/session.ml", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/ffdb5fc8582c77eef7b3a30859eaa216872525a4/src%2Fboot%2Fdriver%2Fsession.ml", "raw_url": "https://github.com/rust-lang/rust/raw/ffdb5fc8582c77eef7b3a30859eaa216872525a4/src%2Fboot%2Fdriver%2Fsession.ml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fboot%2Fdriver%2Fsession.ml?ref=ffdb5fc8582c77eef7b3a30859eaa216872525a4", "patch": "@@ -5,6 +5,8 @@\n \n open Common;;\n \n+type meta = (string * string) array;;\n+\n type sess =\n {\n   mutable sess_in: filename option;\n@@ -41,9 +43,11 @@ type sess =\n   mutable sess_report_timing: bool;\n   mutable sess_report_gc: bool;\n   mutable sess_report_deps: bool;\n+  mutable sess_next_crate_id: int;\n   sess_timings: (string, float) Hashtbl.t;\n   sess_spans: (node_id,span) Hashtbl.t;\n   sess_lib_dirs: filename Queue.t;\n+  sess_crate_meta: (meta, crate_id) Hashtbl.t;\n }\n ;;\n \n@@ -115,6 +119,12 @@ let report_err sess ido str =\n             (string_of_span span) str\n ;;\n \n+let make_crate_id (sess:sess) : crate_id =\n+  let crate_id = Crate sess.sess_next_crate_id in\n+  sess.sess_next_crate_id <- sess.sess_next_crate_id + 1;\n+  crate_id\n+;;\n+\n (*\n  * Local Variables:\n  * fill-column: 78;"}, {"sha": "3ea8917196dbdda9b3d7ed0d4c924a1c868efd99", "filename": "src/boot/fe/ast.ml", "status": "modified", "additions": 2, "deletions": 4, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/ffdb5fc8582c77eef7b3a30859eaa216872525a4/src%2Fboot%2Ffe%2Fast.ml", "raw_url": "https://github.com/rust-lang/rust/raw/ffdb5fc8582c77eef7b3a30859eaa216872525a4/src%2Fboot%2Ffe%2Fast.ml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fboot%2Ffe%2Fast.ml?ref=ffdb5fc8582c77eef7b3a30859eaa216872525a4", "patch": "@@ -452,14 +452,12 @@ and mod_view =\n       view_exports: (export, unit) Hashtbl.t;\n     }\n \n-and meta = (ident * string) array\n-\n-and meta_pat = (ident * string option) array\n+and meta_pat = (string * string option) array\n \n and crate' =\n     {\n       crate_items: (mod_view * mod_items);\n-      crate_meta: meta;\n+      crate_meta: Session.meta;\n       crate_auth: (name, effect) Hashtbl.t;\n       crate_required: (node_id, (required_lib * nabi_conv)) Hashtbl.t;\n       crate_required_syms: (node_id, string) Hashtbl.t;"}, {"sha": "287fbb414755196bc0c49cd149d4e89cad32f0dc", "filename": "src/boot/fe/item.ml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ffdb5fc8582c77eef7b3a30859eaa216872525a4/src%2Fboot%2Ffe%2Fitem.ml", "raw_url": "https://github.com/rust-lang/rust/raw/ffdb5fc8582c77eef7b3a30859eaa216872525a4/src%2Fboot%2Ffe%2Fitem.ml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fboot%2Ffe%2Fitem.ml?ref=ffdb5fc8582c77eef7b3a30859eaa216872525a4", "patch": "@@ -758,7 +758,7 @@ and parse_meta_pat (ps:pstate) : Ast.meta_pat =\n   bracketed_zero_or_more LPAREN RPAREN\n     (Some COMMA) parse_meta_input ps\n \n-and parse_meta (ps:pstate) : Ast.meta =\n+and parse_meta (ps:pstate) : Session.meta =\n   Array.map\n     begin\n       fun (id,v) ->"}, {"sha": "f51d818ec44f22c02257e1638074645b8dd6e097", "filename": "src/boot/util/common.ml", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ffdb5fc8582c77eef7b3a30859eaa216872525a4/src%2Fboot%2Futil%2Fcommon.ml", "raw_url": "https://github.com/rust-lang/rust/raw/ffdb5fc8582c77eef7b3a30859eaa216872525a4/src%2Fboot%2Futil%2Fcommon.ml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fboot%2Futil%2Fcommon.ml?ref=ffdb5fc8582c77eef7b3a30859eaa216872525a4", "patch": "@@ -13,11 +13,13 @@ type node_id = Node of int\n type temp_id = Temp of int\n type opaque_id = Opaque of int\n type constr_id = Constr of int\n+type crate_id = Crate of int\n \n let int_of_node (Node i) = i\n let int_of_temp (Temp i) = i\n let int_of_opaque (Opaque i) = i\n let int_of_constr (Constr i) = i\n+let int_of_common (Crate i) = i\n \n type 'a identified = { node: 'a; id: node_id }\n ;;"}]}