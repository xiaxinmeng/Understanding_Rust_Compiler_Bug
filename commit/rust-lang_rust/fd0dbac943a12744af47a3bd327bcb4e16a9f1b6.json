{"sha": "fd0dbac943a12744af47a3bd327bcb4e16a9f1b6", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZkMGRiYWM5NDNhMTI3NDRhZjQ3YTNiZDMyN2JjYjRlMTZhOWYxYjY=", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2021-01-03T16:09:09Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-01-03T16:09:09Z"}, "message": "Rollup merge of #80617 - GuillaumeGomez:detect-invalid-rustdoc-test-commands, r=jyn514\n\nDetect invalid rustdoc test commands\n\nFixes #80570.\n\nThere are now errors displayed in case of bad command syntax:\n\n```\n---- [rustdoc] rustdoc/remove-url-from-headings.rs stdout ----\n\nerror: htmldocck failed!\nstatus: exit code: 1\ncommand: \"/usr/bin/python\" \"/home/imperio/rust/rust/src/etc/htmldocck.py\" \"/home/imperio/rust/rust/build/x86_64-unknown-linux-gnu/test/rustdoc/remove-url-from-headings\" \"/home/imperio/rust/rust/src/test/rustdoc/remove-url-from-headings.rs\"\nstdout:\n------------------------------------------\n\n------------------------------------------\nstderr:\n------------------------------------------\n3: Invalid command: `!`@has`,` (try with ``@!has`)`\n\t// !`@has` - '//a[`@href=\"http://a.a\"]'`\n\nEncountered 1 errors\n```\n\nr? `@camelid`", "tree": {"sha": "e9c3c7e625f1d0a97e9d3868df4dd596f38ee368", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e9c3c7e625f1d0a97e9d3868df4dd596f38ee368"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fd0dbac943a12744af47a3bd327bcb4e16a9f1b6", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJf8ewmCRBK7hj4Ov3rIwAAdHIIAGsQX7t6YnaTCozjpwVnkAW8\n6vHNRI6ViTdPJCQY/PgH2H6soeL1rFcCcD9A0WuIvzOmeFWzUrXE6Z0Gt78uV4Oq\ndJ8XjKBUflfvNncqaIIIKWnPBHXz5EGADHMjOVupotG4Q2YGKo3CF9Z8GcFewTPb\nCafOQJn3ClUCxCon1sd3JRK8ksz/76NZAM439ti/hUTMhRWrcu7DlDXTpF1BFSLW\n2UdIgUYgp4+QU0djB22Z9JqMtQHiV/k7Q6AnGTCPDONyNT+1L90NrwyM5OKNnDOy\nVt6rgo5XOifWFGTmeWd9hi9sCDHwTW3sCaNHw6iHTRS1B7tjpE+Mj2193PLlBKg=\n=PFz8\n-----END PGP SIGNATURE-----\n", "payload": "tree e9c3c7e625f1d0a97e9d3868df4dd596f38ee368\nparent 2072e117304da97ea1c7df052519f6dc3777b7ff\nparent da3eef61f521f442d02235da0ebc6abaec614e22\nauthor Guillaume Gomez <guillaume1.gomez@gmail.com> 1609690149 +0100\ncommitter GitHub <noreply@github.com> 1609690149 +0100\n\nRollup merge of #80617 - GuillaumeGomez:detect-invalid-rustdoc-test-commands, r=jyn514\n\nDetect invalid rustdoc test commands\n\nFixes #80570.\n\nThere are now errors displayed in case of bad command syntax:\n\n```\n---- [rustdoc] rustdoc/remove-url-from-headings.rs stdout ----\n\nerror: htmldocck failed!\nstatus: exit code: 1\ncommand: \"/usr/bin/python\" \"/home/imperio/rust/rust/src/etc/htmldocck.py\" \"/home/imperio/rust/rust/build/x86_64-unknown-linux-gnu/test/rustdoc/remove-url-from-headings\" \"/home/imperio/rust/rust/src/test/rustdoc/remove-url-from-headings.rs\"\nstdout:\n------------------------------------------\n\n------------------------------------------\nstderr:\n------------------------------------------\n3: Invalid command: `!`@has`,` (try with ``@!has`)`\n\t// !`@has` - '//a[`@href=\"http://a.a\"]'`\n\nEncountered 1 errors\n```\n\nr? `@camelid`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fd0dbac943a12744af47a3bd327bcb4e16a9f1b6", "html_url": "https://github.com/rust-lang/rust/commit/fd0dbac943a12744af47a3bd327bcb4e16a9f1b6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fd0dbac943a12744af47a3bd327bcb4e16a9f1b6/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2072e117304da97ea1c7df052519f6dc3777b7ff", "url": "https://api.github.com/repos/rust-lang/rust/commits/2072e117304da97ea1c7df052519f6dc3777b7ff", "html_url": "https://github.com/rust-lang/rust/commit/2072e117304da97ea1c7df052519f6dc3777b7ff"}, {"sha": "da3eef61f521f442d02235da0ebc6abaec614e22", "url": "https://api.github.com/repos/rust-lang/rust/commits/da3eef61f521f442d02235da0ebc6abaec614e22", "html_url": "https://github.com/rust-lang/rust/commit/da3eef61f521f442d02235da0ebc6abaec614e22"}], "stats": {"total": 12, "additions": 11, "deletions": 1}, "files": [{"sha": "2f7233685db52b05c4dc9ba10a064cac719b8cdf", "filename": "src/etc/htmldocck.py", "status": "modified", "additions": 11, "deletions": 1, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/fd0dbac943a12744af47a3bd327bcb4e16a9f1b6/src%2Fetc%2Fhtmldocck.py", "raw_url": "https://github.com/rust-lang/rust/raw/fd0dbac943a12744af47a3bd327bcb4e16a9f1b6/src%2Fetc%2Fhtmldocck.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fetc%2Fhtmldocck.py?ref=fd0dbac943a12744af47a3bd327bcb4e16a9f1b6", "patch": "@@ -218,7 +218,7 @@ def concat_multi_lines(f):\n \n \n LINE_PATTERN = re.compile(r'''\n-    (?<=(?<!\\S)@)(?P<negated>!?)\n+    (?<=(?<!\\S))(?P<invalid>!?)@(?P<negated>!?)\n     (?P<cmd>[A-Za-z]+(?:-[A-Za-z]+)*)\n     (?P<args>.*)$\n ''', re.X | re.UNICODE)\n@@ -233,6 +233,16 @@ def get_commands(template):\n \n             negated = (m.group('negated') == '!')\n             cmd = m.group('cmd')\n+            if m.group('invalid') == '!':\n+                print_err(\n+                    lineno,\n+                    line,\n+                    'Invalid command: `!@{0}{1}`, (help: try with `@!{1}`)'.format(\n+                        '!' if negated else '',\n+                        cmd,\n+                    ),\n+                )\n+                continue\n             args = m.group('args')\n             if args and not args[:1].isspace():\n                 print_err(lineno, line, 'Invalid template syntax')"}]}