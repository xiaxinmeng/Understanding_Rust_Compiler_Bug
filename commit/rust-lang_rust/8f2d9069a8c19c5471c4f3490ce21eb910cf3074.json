{"sha": "8f2d9069a8c19c5471c4f3490ce21eb910cf3074", "node_id": "MDY6Q29tbWl0NzI0NzEyOjhmMmQ5MDY5YThjMTljNTQ3MWM0ZjM0OTBjZTIxZWI5MTBjZjMwNzQ=", "commit": {"author": {"name": "Amjad Alsharafi", "email": "amjadsharafi10@gmail.com", "date": "2020-09-03T17:47:35Z"}, "committer": {"name": "Amjad Alsharafi", "email": "amjadsharafi10@gmail.com", "date": "2020-09-04T14:17:28Z"}, "message": "Implementation of incompatible features error\n\nIf two features are defined as incompatible, using them together would\nresult in an error", "tree": {"sha": "e41f1a8ac62f0bc5f0556b08f8c07b58ae251e11", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e41f1a8ac62f0bc5f0556b08f8c07b58ae251e11"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8f2d9069a8c19c5471c4f3490ce21eb910cf3074", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8f2d9069a8c19c5471c4f3490ce21eb910cf3074", "html_url": "https://github.com/rust-lang/rust/commit/8f2d9069a8c19c5471c4f3490ce21eb910cf3074", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8f2d9069a8c19c5471c4f3490ce21eb910cf3074/comments", "author": {"login": "Amjad50", "id": 26300843, "node_id": "MDQ6VXNlcjI2MzAwODQz", "avatar_url": "https://avatars.githubusercontent.com/u/26300843?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Amjad50", "html_url": "https://github.com/Amjad50", "followers_url": "https://api.github.com/users/Amjad50/followers", "following_url": "https://api.github.com/users/Amjad50/following{/other_user}", "gists_url": "https://api.github.com/users/Amjad50/gists{/gist_id}", "starred_url": "https://api.github.com/users/Amjad50/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Amjad50/subscriptions", "organizations_url": "https://api.github.com/users/Amjad50/orgs", "repos_url": "https://api.github.com/users/Amjad50/repos", "events_url": "https://api.github.com/users/Amjad50/events{/privacy}", "received_events_url": "https://api.github.com/users/Amjad50/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Amjad50", "id": 26300843, "node_id": "MDQ6VXNlcjI2MzAwODQz", "avatar_url": "https://avatars.githubusercontent.com/u/26300843?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Amjad50", "html_url": "https://github.com/Amjad50", "followers_url": "https://api.github.com/users/Amjad50/followers", "following_url": "https://api.github.com/users/Amjad50/following{/other_user}", "gists_url": "https://api.github.com/users/Amjad50/gists{/gist_id}", "starred_url": "https://api.github.com/users/Amjad50/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Amjad50/subscriptions", "organizations_url": "https://api.github.com/users/Amjad50/orgs", "repos_url": "https://api.github.com/users/Amjad50/repos", "events_url": "https://api.github.com/users/Amjad50/events{/privacy}", "received_events_url": "https://api.github.com/users/Amjad50/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "08deb863bdebfcbbb71c18acf903eca84f1df4e7", "url": "https://api.github.com/repos/rust-lang/rust/commits/08deb863bdebfcbbb71c18acf903eca84f1df4e7", "html_url": "https://github.com/rust-lang/rust/commit/08deb863bdebfcbbb71c18acf903eca84f1df4e7"}], "stats": {"total": 61, "additions": 60, "deletions": 1}, "files": [{"sha": "97e6b363eff60b05fda6856f2178c89dfd7fdd94", "filename": "compiler/rustc_ast_passes/src/feature_gate.rs", "status": "modified", "additions": 34, "deletions": 0, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/8f2d9069a8c19c5471c4f3490ce21eb910cf3074/compiler%2Frustc_ast_passes%2Fsrc%2Ffeature_gate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8f2d9069a8c19c5471c4f3490ce21eb910cf3074/compiler%2Frustc_ast_passes%2Fsrc%2Ffeature_gate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast_passes%2Fsrc%2Ffeature_gate.rs?ref=8f2d9069a8c19c5471c4f3490ce21eb910cf3074", "patch": "@@ -608,6 +608,7 @@ impl<'a> Visitor<'a> for PostExpansionVisitor<'a> {\n \n pub fn check_crate(krate: &ast::Crate, sess: &Session) {\n     maybe_stage_features(sess, krate);\n+    check_incompatible_features(sess);\n     let mut visitor = PostExpansionVisitor { sess, features: &sess.features_untracked() };\n \n     let spans = sess.parse_sess.gated_spans.spans.borrow();\n@@ -677,3 +678,36 @@ fn maybe_stage_features(sess: &Session, krate: &ast::Crate) {\n         }\n     }\n }\n+\n+fn check_incompatible_features(sess: &Session) {\n+    let features = sess.features_untracked();\n+\n+    let declared_features = features\n+        .declared_lang_features\n+        .iter()\n+        .copied()\n+        .map(|(name, span, _)| (name, span))\n+        .chain(features.declared_lib_features.iter().copied());\n+\n+    for (f1, f2) in rustc_feature::INCOMPATIBLE_FEATURES\n+        .iter()\n+        .filter(|&&(f1, f2)| features.enabled(f1) && features.enabled(f2))\n+    {\n+        if let Some((f1_name, f1_span)) = declared_features.clone().find(|(name, _)| name == f1) {\n+            if let Some((f2_name, f2_span)) = declared_features.clone().find(|(name, _)| name == f2)\n+            {\n+                let spans = vec![f1_span, f2_span];\n+                sess.struct_span_err(\n+                    spans.clone(),\n+                    &format!(\n+                        \"features `{}` and `{}` are incompatible, using them at the same time \\\n+                        is not allowed\",\n+                        f1_name, f2_name\n+                    ),\n+                )\n+                .help(\"remove one of these features\")\n+                .emit();\n+            }\n+        }\n+    }\n+}"}, {"sha": "3d7b3da45ccb948bf718feb2f49d287559dc7d99", "filename": "compiler/rustc_feature/src/active.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/8f2d9069a8c19c5471c4f3490ce21eb910cf3074/compiler%2Frustc_feature%2Fsrc%2Factive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8f2d9069a8c19c5471c4f3490ce21eb910cf3074/compiler%2Frustc_feature%2Fsrc%2Factive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_feature%2Fsrc%2Factive.rs?ref=8f2d9069a8c19c5471c4f3490ce21eb910cf3074", "patch": "@@ -605,3 +605,8 @@ pub const INCOMPLETE_FEATURES: &[Symbol] = &[\n     sym::lazy_normalization_consts,\n     sym::specialization,\n ];\n+\n+/// Some features are not allowed to be used together at the same time, if\n+/// the two are present, produce an error\n+pub const INCOMPATIBLE_FEATURES: &[(Symbol, Symbol)] =\n+    &[(sym::const_generics, sym::min_const_generics)];"}, {"sha": "15564a59658cb24c46f3ba8794b6a198229d40b2", "filename": "compiler/rustc_feature/src/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/8f2d9069a8c19c5471c4f3490ce21eb910cf3074/compiler%2Frustc_feature%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8f2d9069a8c19c5471c4f3490ce21eb910cf3074/compiler%2Frustc_feature%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_feature%2Fsrc%2Flib.rs?ref=8f2d9069a8c19c5471c4f3490ce21eb910cf3074", "patch": "@@ -131,7 +131,7 @@ pub fn find_feature_issue(feature: Symbol, issue: GateIssue) -> Option<NonZeroU3\n }\n \n pub use accepted::ACCEPTED_FEATURES;\n-pub use active::{Features, ACTIVE_FEATURES, INCOMPLETE_FEATURES};\n+pub use active::{Features, ACTIVE_FEATURES, INCOMPATIBLE_FEATURES, INCOMPLETE_FEATURES};\n pub use builtin_attrs::{\n     deprecated_attributes, find_gated_cfg, is_builtin_attr_name, AttributeGate, AttributeTemplate,\n     AttributeType, BuiltinAttribute, GatedCfg, BUILTIN_ATTRIBUTES, BUILTIN_ATTRIBUTE_MAP,"}, {"sha": "2365adc3a861f3103e453d220ee6b777638e348b", "filename": "src/test/ui/const-generics/min-and-full-same-time.rs", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/8f2d9069a8c19c5471c4f3490ce21eb910cf3074/src%2Ftest%2Fui%2Fconst-generics%2Fmin-and-full-same-time.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8f2d9069a8c19c5471c4f3490ce21eb910cf3074/src%2Ftest%2Fui%2Fconst-generics%2Fmin-and-full-same-time.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconst-generics%2Fmin-and-full-same-time.rs?ref=8f2d9069a8c19c5471c4f3490ce21eb910cf3074", "patch": "@@ -0,0 +1,7 @@\n+#![feature(const_generics)]\n+//~^ ERROR features `const_generics` and `min_const_generics` are incompatible\n+#![allow(incomplete_features)]\n+#![feature(min_const_generics)]\n+\n+\n+fn main() {}"}, {"sha": "907fec9bbe17a870aa5591e14ac7d7b01f594975", "filename": "src/test/ui/const-generics/min-and-full-same-time.stderr", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/8f2d9069a8c19c5471c4f3490ce21eb910cf3074/src%2Ftest%2Fui%2Fconst-generics%2Fmin-and-full-same-time.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/8f2d9069a8c19c5471c4f3490ce21eb910cf3074/src%2Ftest%2Fui%2Fconst-generics%2Fmin-and-full-same-time.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconst-generics%2Fmin-and-full-same-time.stderr?ref=8f2d9069a8c19c5471c4f3490ce21eb910cf3074", "patch": "@@ -0,0 +1,13 @@\n+error: features `const_generics` and `min_const_generics` are incompatible, using them at the same time is not allowed\n+  --> $DIR/min-and-full-same-time.rs:1:12\n+   |\n+LL | #![feature(const_generics)]\n+   |            ^^^^^^^^^^^^^^\n+...\n+LL | #![feature(min_const_generics)]\n+   |            ^^^^^^^^^^^^^^^^^^\n+   |\n+   = help: remove one of these features\n+\n+error: aborting due to previous error\n+"}]}