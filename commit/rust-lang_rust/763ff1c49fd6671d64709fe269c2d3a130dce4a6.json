{"sha": "763ff1c49fd6671d64709fe269c2d3a130dce4a6", "node_id": "C_kwDOAAsO6NoAKDc2M2ZmMWM0OWZkNjY3MWQ2NDcwOWZlMjY5YzJkM2ExMzBkY2U0YTY", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2022-04-19T18:56:07Z"}, "committer": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2022-04-19T18:56:07Z"}, "message": "do not consider thread-local allocations read-only", "tree": {"sha": "77318f6b6205262fc713f3834e36fba4374dbf95", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/77318f6b6205262fc713f3834e36fba4374dbf95"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/763ff1c49fd6671d64709fe269c2d3a130dce4a6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/763ff1c49fd6671d64709fe269c2d3a130dce4a6", "html_url": "https://github.com/rust-lang/rust/commit/763ff1c49fd6671d64709fe269c2d3a130dce4a6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/763ff1c49fd6671d64709fe269c2d3a130dce4a6/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9d47a5633a60308dd8f736ebd4e99131b078df0e", "url": "https://api.github.com/repos/rust-lang/rust/commits/9d47a5633a60308dd8f736ebd4e99131b078df0e", "html_url": "https://github.com/rust-lang/rust/commit/9d47a5633a60308dd8f736ebd4e99131b078df0e"}], "stats": {"total": 13, "additions": 11, "deletions": 2}, "files": [{"sha": "27bc9566d8fdc0d0f7c3594e5113a00f552dd8ce", "filename": "src/thread.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/763ff1c49fd6671d64709fe269c2d3a130dce4a6/src%2Fthread.rs", "raw_url": "https://github.com/rust-lang/rust/raw/763ff1c49fd6671d64709fe269c2d3a130dce4a6/src%2Fthread.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fthread.rs?ref=763ff1c49fd6671d64709fe269c2d3a130dce4a6", "patch": "@@ -10,6 +10,7 @@ use log::trace;\n use rustc_data_structures::fx::FxHashMap;\n use rustc_hir::def_id::DefId;\n use rustc_index::vec::{Idx, IndexVec};\n+use rustc_middle::mir::Mutability;\n \n use crate::sync::SynchronizationState;\n use crate::*;\n@@ -571,9 +572,11 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n                 throw_unsup_format!(\"foreign thread-local statics are not supported\");\n             }\n             let allocation = tcx.eval_static_initializer(def_id)?;\n+            let mut allocation = allocation.inner().clone();\n+            // This allocation will be deallocated when the thread dies, so it is not in read-only memory.\n+            allocation.mutability = Mutability::Mut;\n             // Create a fresh allocation with this content.\n-            let new_alloc =\n-                this.allocate_raw_ptr(allocation.inner().clone(), MiriMemoryKind::Tls.into());\n+            let new_alloc = this.allocate_raw_ptr(allocation, MiriMemoryKind::Tls.into());\n             this.machine.threads.set_thread_local_alloc(def_id, new_alloc);\n             Ok(new_alloc)\n         }"}, {"sha": "5b11539f7f1191b4eab854ec40a6b38d18b9756c", "filename": "tests/run-pass/concurrency/thread_locals.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/763ff1c49fd6671d64709fe269c2d3a130dce4a6/tests%2Frun-pass%2Fconcurrency%2Fthread_locals.rs", "raw_url": "https://github.com/rust-lang/rust/raw/763ff1c49fd6671d64709fe269c2d3a130dce4a6/tests%2Frun-pass%2Fconcurrency%2Fthread_locals.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-pass%2Fconcurrency%2Fthread_locals.rs?ref=763ff1c49fd6671d64709fe269c2d3a130dce4a6", "patch": "@@ -16,6 +16,10 @@ static mut A: u8 = 0;\n static mut B: u8 = 0;\n static mut C: u8 = 0;\n \n+// Regression test for https://github.com/rust-lang/rust/issues/96191.\n+#[thread_local]\n+static READ_ONLY: u8 = 42;\n+\n unsafe fn get_a_ref() -> *mut u8 {\n     &mut A\n }\n@@ -25,6 +29,8 @@ struct Sender(*mut u8);\n unsafe impl Send for Sender {}\n \n fn main() {\n+    let _val = READ_ONLY;\n+\n     let ptr = unsafe {\n         let x = get_a_ref();\n         *x = 5;"}]}