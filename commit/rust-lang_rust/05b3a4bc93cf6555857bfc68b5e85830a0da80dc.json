{"sha": "05b3a4bc93cf6555857bfc68b5e85830a0da80dc", "node_id": "MDY6Q29tbWl0NzI0NzEyOjA1YjNhNGJjOTNjZjY1NTU4NTdiZmM2OGI1ZTg1ODMwYTBkYTgwZGM=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-06-09T15:16:52Z"}, "committer": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-06-09T15:16:52Z"}, "message": "Build test-macros in a build script", "tree": {"sha": "4bd5ad6b0b9a6a4a653ad8511122fa542021f588", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4bd5ad6b0b9a6a4a653ad8511122fa542021f588"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/05b3a4bc93cf6555857bfc68b5e85830a0da80dc", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/05b3a4bc93cf6555857bfc68b5e85830a0da80dc", "html_url": "https://github.com/rust-lang/rust/commit/05b3a4bc93cf6555857bfc68b5e85830a0da80dc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/05b3a4bc93cf6555857bfc68b5e85830a0da80dc/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5f592f4f58a6e1e1db0f920af34a2f569b65017c", "url": "https://api.github.com/repos/rust-lang/rust/commits/5f592f4f58a6e1e1db0f920af34a2f569b65017c", "html_url": "https://github.com/rust-lang/rust/commit/5f592f4f58a6e1e1db0f920af34a2f569b65017c"}], "stats": {"total": 208, "additions": 133, "deletions": 75}, "files": [{"sha": "215dd627cca797b6b11fe89fd1c4c74d97a9edd5", "filename": "Cargo.lock", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/05b3a4bc93cf6555857bfc68b5e85830a0da80dc/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/05b3a4bc93cf6555857bfc68b5e85830a0da80dc/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=05b3a4bc93cf6555857bfc68b5e85830a0da80dc", "patch": "@@ -1158,6 +1158,15 @@ dependencies = [\n [[package]]\n name = \"proc_macro_test\"\n version = \"0.0.0\"\n+dependencies = [\n+ \"cargo_metadata\",\n+ \"proc_macro_test_impl\",\n+ \"toolchain\",\n+]\n+\n+[[package]]\n+name = \"proc_macro_test_impl\"\n+version = \"0.0.0\"\n \n [[package]]\n name = \"profile\""}, {"sha": "4d6908fa93e9973da7aee0eaa0b9d03d1207a5ec", "filename": "Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/05b3a4bc93cf6555857bfc68b5e85830a0da80dc/Cargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/05b3a4bc93cf6555857bfc68b5e85830a0da80dc/Cargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.toml?ref=05b3a4bc93cf6555857bfc68b5e85830a0da80dc", "patch": "@@ -1,6 +1,7 @@\n [workspace]\n resolver = \"2\"\n members = [\"xtask/\", \"lib/*\", \"crates/*\"]\n+exclude = [\"crates/proc_macro_test/imp\"]\n \n [profile.dev]\n # Disabling debug info speeds up builds a bunch,"}, {"sha": "2c093aa0ad8ec741aad9c2263700b188a115adef", "filename": "crates/proc_macro_srv/src/tests/utils.rs", "status": "modified", "additions": 1, "deletions": 28, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/05b3a4bc93cf6555857bfc68b5e85830a0da80dc/crates%2Fproc_macro_srv%2Fsrc%2Ftests%2Futils.rs", "raw_url": "https://github.com/rust-lang/rust/raw/05b3a4bc93cf6555857bfc68b5e85830a0da80dc/crates%2Fproc_macro_srv%2Fsrc%2Ftests%2Futils.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproc_macro_srv%2Fsrc%2Ftests%2Futils.rs?ref=05b3a4bc93cf6555857bfc68b5e85830a0da80dc", "patch": "@@ -7,35 +7,8 @@ use proc_macro_api::ListMacrosTask;\n use std::str::FromStr;\n \n pub mod fixtures {\n-    use cargo_metadata::Message;\n-    use std::path::PathBuf;\n-    use std::process::Command;\n-\n-    // Use current project metadata to get the proc-macro dylib path\n     pub fn proc_macro_test_dylib_path() -> std::path::PathBuf {\n-        let name = \"proc_macro_test\";\n-        let version = \"0.0.0\";\n-        let command = Command::new(toolchain::cargo())\n-            .args(&[\"check\", \"--tests\", \"--message-format\", \"json\"])\n-            .output()\n-            .unwrap()\n-            .stdout;\n-\n-        for message in Message::parse_stream(command.as_slice()) {\n-            match message.unwrap() {\n-                Message::CompilerArtifact(artifact) => {\n-                    if artifact.target.kind.contains(&\"proc-macro\".to_string()) {\n-                        let repr = format!(\"{} {}\", name, version);\n-                        if artifact.package_id.repr.starts_with(&repr) {\n-                            return PathBuf::from(&artifact.filenames[0]);\n-                        }\n-                    }\n-                }\n-                _ => (), // Unknown message\n-            }\n-        }\n-\n-        panic!(\"No proc-macro dylib for {} found!\", name);\n+        proc_macro_test::PROC_MACRO_TEST_LOCATION.into()\n     }\n }\n "}, {"sha": "1a88e361e83d47113118d205040277353b4e857b", "filename": "crates/proc_macro_test/Cargo.toml", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/05b3a4bc93cf6555857bfc68b5e85830a0da80dc/crates%2Fproc_macro_test%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/05b3a4bc93cf6555857bfc68b5e85830a0da80dc/crates%2Fproc_macro_test%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproc_macro_test%2FCargo.toml?ref=05b3a4bc93cf6555857bfc68b5e85830a0da80dc", "patch": "@@ -8,4 +8,8 @@ publish = false\n \n [lib]\n doctest = false\n-proc-macro = true\n+\n+[build-dependencies]\n+proc_macro_test_impl = { path = \"imp\", version = \"0.0.0\" }\n+toolchain = { path = \"../toolchain\", version = \"0.0.0\" }\n+cargo_metadata = \"0.13\""}, {"sha": "4653a93dde1c0835075b302b429264a4765a9119", "filename": "crates/proc_macro_test/build.rs", "status": "added", "additions": 48, "deletions": 0, "changes": 48, "blob_url": "https://github.com/rust-lang/rust/blob/05b3a4bc93cf6555857bfc68b5e85830a0da80dc/crates%2Fproc_macro_test%2Fbuild.rs", "raw_url": "https://github.com/rust-lang/rust/raw/05b3a4bc93cf6555857bfc68b5e85830a0da80dc/crates%2Fproc_macro_test%2Fbuild.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproc_macro_test%2Fbuild.rs?ref=05b3a4bc93cf6555857bfc68b5e85830a0da80dc", "patch": "@@ -0,0 +1,48 @@\n+//! This will build the proc macro in `imp`, and copy the resulting dylib artifact into the\n+//! `OUT_DIR`.\n+//!\n+//! `proc_macro_test` itself contains only a path to that artifact.\n+\n+use std::{\n+    env, fs,\n+    path::{Path, PathBuf},\n+    process::Command,\n+};\n+\n+use cargo_metadata::Message;\n+\n+fn main() {\n+    let out_dir = env::var_os(\"OUT_DIR\").unwrap();\n+    let out_dir = Path::new(&out_dir);\n+\n+    let name = \"proc_macro_test_impl\";\n+    let version = \"0.0.0\";\n+    let output = Command::new(toolchain::cargo())\n+        .current_dir(\"imp\")\n+        .args(&[\"build\", \"-p\", \"proc_macro_test_impl\", \"--message-format\", \"json\"])\n+        .output()\n+        .unwrap();\n+    assert!(output.status.success());\n+\n+    let mut artifact_path = None;\n+    for message in Message::parse_stream(output.stdout.as_slice()) {\n+        match message.unwrap() {\n+            Message::CompilerArtifact(artifact) => {\n+                if artifact.target.kind.contains(&\"proc-macro\".to_string()) {\n+                    let repr = format!(\"{} {}\", name, version);\n+                    if artifact.package_id.repr.starts_with(&repr) {\n+                        artifact_path = Some(PathBuf::from(&artifact.filenames[0]));\n+                    }\n+                }\n+            }\n+            _ => (), // Unknown message\n+        }\n+    }\n+\n+    let src_path = artifact_path.expect(\"no dylib for proc_macro_test_impl found\");\n+    let dest_path = out_dir.join(src_path.file_name().unwrap());\n+    fs::copy(src_path, &dest_path).unwrap();\n+\n+    let info_path = out_dir.join(\"proc_macro_test_location.txt\");\n+    fs::write(info_path, dest_path.to_str().unwrap()).unwrap();\n+}"}, {"sha": "2c96eb1b6517f2617f9ddeae9f07f5fd7bd7ddef", "filename": "crates/proc_macro_test/imp/.gitignore", "status": "added", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/05b3a4bc93cf6555857bfc68b5e85830a0da80dc/crates%2Fproc_macro_test%2Fimp%2F.gitignore", "raw_url": "https://github.com/rust-lang/rust/raw/05b3a4bc93cf6555857bfc68b5e85830a0da80dc/crates%2Fproc_macro_test%2Fimp%2F.gitignore", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproc_macro_test%2Fimp%2F.gitignore?ref=05b3a4bc93cf6555857bfc68b5e85830a0da80dc", "patch": "@@ -0,0 +1,2 @@\n+target/\n+Cargo.lock"}, {"sha": "1c2e754017534975466d1a5035ea3195be284212", "filename": "crates/proc_macro_test/imp/Cargo.toml", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/05b3a4bc93cf6555857bfc68b5e85830a0da80dc/crates%2Fproc_macro_test%2Fimp%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/05b3a4bc93cf6555857bfc68b5e85830a0da80dc/crates%2Fproc_macro_test%2Fimp%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproc_macro_test%2Fimp%2FCargo.toml?ref=05b3a4bc93cf6555857bfc68b5e85830a0da80dc", "patch": "@@ -0,0 +1,17 @@\n+[package]\n+name = \"proc_macro_test_impl\"\n+version = \"0.0.0\"\n+license = \"MIT OR Apache-2.0\"\n+authors = [\"rust-analyzer developers\"]\n+edition = \"2018\"\n+publish = false\n+\n+[lib]\n+doctest = false\n+proc-macro = true\n+\n+[workspace]\n+\n+[dependencies]\n+# this crate should not have any dependencies, since it uses its own workspace,\n+# and its own `Cargo.lock`"}, {"sha": "4b26d2472116cc2bbdb2d93d790fc90796113f8f", "filename": "crates/proc_macro_test/imp/src/lib.rs", "status": "added", "additions": 48, "deletions": 0, "changes": 48, "blob_url": "https://github.com/rust-lang/rust/blob/05b3a4bc93cf6555857bfc68b5e85830a0da80dc/crates%2Fproc_macro_test%2Fimp%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/05b3a4bc93cf6555857bfc68b5e85830a0da80dc/crates%2Fproc_macro_test%2Fimp%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproc_macro_test%2Fimp%2Fsrc%2Flib.rs?ref=05b3a4bc93cf6555857bfc68b5e85830a0da80dc", "patch": "@@ -0,0 +1,48 @@\n+//! Exports a few trivial procedural macros for testing.\n+\n+use proc_macro::TokenStream;\n+\n+#[proc_macro]\n+pub fn fn_like_noop(args: TokenStream) -> TokenStream {\n+    args\n+}\n+\n+#[proc_macro]\n+pub fn fn_like_panic(args: TokenStream) -> TokenStream {\n+    panic!(\"fn_like_panic!({})\", args);\n+}\n+\n+#[proc_macro]\n+pub fn fn_like_error(args: TokenStream) -> TokenStream {\n+    format!(\"compile_error!(\\\"fn_like_error!({})\\\");\", args).parse().unwrap()\n+}\n+\n+#[proc_macro_attribute]\n+pub fn attr_noop(_args: TokenStream, item: TokenStream) -> TokenStream {\n+    item\n+}\n+\n+#[proc_macro_attribute]\n+pub fn attr_panic(args: TokenStream, item: TokenStream) -> TokenStream {\n+    panic!(\"#[attr_panic {}] {}\", args, item);\n+}\n+\n+#[proc_macro_attribute]\n+pub fn attr_error(args: TokenStream, item: TokenStream) -> TokenStream {\n+    format!(\"compile_error!(\\\"#[attr_error({})] {}\\\");\", args, item).parse().unwrap()\n+}\n+\n+#[proc_macro_derive(DeriveEmpty)]\n+pub fn derive_empty(_item: TokenStream) -> TokenStream {\n+    TokenStream::new()\n+}\n+\n+#[proc_macro_derive(DerivePanic)]\n+pub fn derive_panic(item: TokenStream) -> TokenStream {\n+    panic!(\"#[derive(DerivePanic)] {}\", item);\n+}\n+\n+#[proc_macro_derive(DeriveError)]\n+pub fn derive_error(item: TokenStream) -> TokenStream {\n+    format!(\"compile_error!(\\\"#[derive(DeriveError)] {}\\\");\", item).parse().unwrap()\n+}"}, {"sha": "2edf23a63440377ee978c2868ffa2eddd8b7c842", "filename": "crates/proc_macro_test/src/lib.rs", "status": "modified", "additions": 2, "deletions": 46, "changes": 48, "blob_url": "https://github.com/rust-lang/rust/blob/05b3a4bc93cf6555857bfc68b5e85830a0da80dc/crates%2Fproc_macro_test%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/05b3a4bc93cf6555857bfc68b5e85830a0da80dc/crates%2Fproc_macro_test%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproc_macro_test%2Fsrc%2Flib.rs?ref=05b3a4bc93cf6555857bfc68b5e85830a0da80dc", "patch": "@@ -1,48 +1,4 @@\n //! Exports a few trivial procedural macros for testing.\n \n-use proc_macro::TokenStream;\n-\n-#[proc_macro]\n-pub fn fn_like_noop(args: TokenStream) -> TokenStream {\n-    args\n-}\n-\n-#[proc_macro]\n-pub fn fn_like_panic(args: TokenStream) -> TokenStream {\n-    panic!(\"fn_like_panic!({})\", args);\n-}\n-\n-#[proc_macro]\n-pub fn fn_like_error(args: TokenStream) -> TokenStream {\n-    format!(\"compile_error!(\\\"fn_like_error!({})\\\");\", args).parse().unwrap()\n-}\n-\n-#[proc_macro_attribute]\n-pub fn attr_noop(_args: TokenStream, item: TokenStream) -> TokenStream {\n-    item\n-}\n-\n-#[proc_macro_attribute]\n-pub fn attr_panic(args: TokenStream, item: TokenStream) -> TokenStream {\n-    panic!(\"#[attr_panic {}] {}\", args, item);\n-}\n-\n-#[proc_macro_attribute]\n-pub fn attr_error(args: TokenStream, item: TokenStream) -> TokenStream {\n-    format!(\"compile_error!(\\\"#[attr_error({})] {}\\\");\", args, item).parse().unwrap()\n-}\n-\n-#[proc_macro_derive(DeriveEmpty)]\n-pub fn derive_empty(_item: TokenStream) -> TokenStream {\n-    TokenStream::new()\n-}\n-\n-#[proc_macro_derive(DerivePanic)]\n-pub fn derive_panic(item: TokenStream) -> TokenStream {\n-    panic!(\"#[derive(DerivePanic)] {}\", item);\n-}\n-\n-#[proc_macro_derive(DeriveError)]\n-pub fn derive_error(item: TokenStream) -> TokenStream {\n-    format!(\"compile_error!(\\\"#[derive(DeriveError)] {}\\\");\", item).parse().unwrap()\n-}\n+pub static PROC_MACRO_TEST_LOCATION: &str =\n+    include_str!(concat!(env!(\"OUT_DIR\"), \"/proc_macro_test_location.txt\"));"}]}