{"sha": "4d5bcbe957fa2f9b47aba81484d47206de742f3d", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRkNWJjYmU5NTdmYTJmOWI0N2FiYTgxNDg0ZDQ3MjA2ZGU3NDJmM2Q=", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2021-09-17T05:09:51Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-09-17T05:09:51Z"}, "message": "Rollup merge of #89033 - cuviper:sysroot-lib-path, r=Mark-Simulacrum\n\nSet the library path in sysroot-crates-are-unstable\n\nMost of the `run-make-fulldeps` tests use a make-driven rustc command\nthat includes `HOST_RPATH_DIR` in the library path, but this particular\ntest runs from python instead. When the toolchain is built without\n`rpath` enabled, we need that library path in the environment so it can\nfind its own libraries.", "tree": {"sha": "bdf47d683a7b5bdf12486a1d5986f1d5a7d09da9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bdf47d683a7b5bdf12486a1d5986f1d5a7d09da9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4d5bcbe957fa2f9b47aba81484d47206de742f3d", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhRCMfCRBK7hj4Ov3rIwAA2ikIAJ0vh/z1DYKQwkQWGT1wh3nE\npYp08YzmNC0SNLJeH6hT2BM0JRpdGfkpH4QUgJ5//aUFk83zwIZaH49Qv4EtBUz2\nS9JFdfsqCUNZ5kueDTQ4IfRvoo/2IofHbku7wMI/lWubyJhRw9bBZvGaxjWoPbnT\n858m1o6KnbbsNTPBcUCyLX/XRmLXlWBarpXmLjT+jSJNKjRko/upn1I6ldn7OREB\nUB4Dt234svpj56bUsQqAXFz2SocHnNCDs69OVAeB6zAc0HwbogXbMCZqu4uTq232\n481yNa9/KIHNWorg8Uw4pnzsi0Gyxrn3wXNyJVu2ZAtgPbQS8zgt17SwRxkjp0U=\n=bgDX\n-----END PGP SIGNATURE-----\n", "payload": "tree bdf47d683a7b5bdf12486a1d5986f1d5a7d09da9\nparent 3cff47b608d68db3b59fd0cb8e8d34052f04dbff\nparent 67edf94416cdb8cef46360cd284efc358736d689\nauthor Yuki Okushi <jtitor@2k36.org> 1631855391 +0900\ncommitter GitHub <noreply@github.com> 1631855391 +0900\n\nRollup merge of #89033 - cuviper:sysroot-lib-path, r=Mark-Simulacrum\n\nSet the library path in sysroot-crates-are-unstable\n\nMost of the `run-make-fulldeps` tests use a make-driven rustc command\nthat includes `HOST_RPATH_DIR` in the library path, but this particular\ntest runs from python instead. When the toolchain is built without\n`rpath` enabled, we need that library path in the environment so it can\nfind its own libraries.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4d5bcbe957fa2f9b47aba81484d47206de742f3d", "html_url": "https://github.com/rust-lang/rust/commit/4d5bcbe957fa2f9b47aba81484d47206de742f3d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4d5bcbe957fa2f9b47aba81484d47206de742f3d/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3cff47b608d68db3b59fd0cb8e8d34052f04dbff", "url": "https://api.github.com/repos/rust-lang/rust/commits/3cff47b608d68db3b59fd0cb8e8d34052f04dbff", "html_url": "https://github.com/rust-lang/rust/commit/3cff47b608d68db3b59fd0cb8e8d34052f04dbff"}, {"sha": "67edf94416cdb8cef46360cd284efc358736d689", "url": "https://api.github.com/repos/rust-lang/rust/commits/67edf94416cdb8cef46360cd284efc358736d689", "html_url": "https://github.com/rust-lang/rust/commit/67edf94416cdb8cef46360cd284efc358736d689"}], "stats": {"total": 13, "additions": 13, "deletions": 0}, "files": [{"sha": "cb77eb34fef08d77246fe41bdf4eec42d9be6b78", "filename": "src/test/run-make-fulldeps/sysroot-crates-are-unstable/test.py", "status": "modified", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/4d5bcbe957fa2f9b47aba81484d47206de742f3d/src%2Ftest%2Frun-make-fulldeps%2Fsysroot-crates-are-unstable%2Ftest.py", "raw_url": "https://github.com/rust-lang/rust/raw/4d5bcbe957fa2f9b47aba81484d47206de742f3d/src%2Ftest%2Frun-make-fulldeps%2Fsysroot-crates-are-unstable%2Ftest.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fsysroot-crates-are-unstable%2Ftest.py?ref=4d5bcbe957fa2f9b47aba81484d47206de742f3d", "patch": "@@ -17,6 +17,17 @@ def convert_to_string(s):\n     return s\n \n \n+def set_ld_lib_path():\n+    var = os.environ.get(\"LD_LIB_PATH_ENVVAR\")\n+    rpath = os.environ.get(\"HOST_RPATH_DIR\")\n+    if var and rpath:\n+        path = os.environ.get(var)\n+        if path:\n+            os.environ[var] = rpath + os.pathsep + path\n+        else:\n+            os.environ[var] = rpath\n+\n+\n def exec_command(command, to_input=None):\n     child = None\n     if to_input is None:\n@@ -50,7 +61,9 @@ def get_all_libs(dir_path):\n             if isfile(join(dir_path, f)) and f.endswith('.rlib') and f not in STABLE_CRATES]\n \n \n+set_ld_lib_path()\n sysroot = exec_command([os.environ['RUSTC'], '--print', 'sysroot'])[0].replace('\\n', '')\n+assert sysroot, \"Could not read the rustc sysroot!\"\n libs = get_all_libs(join(sysroot, 'lib/rustlib/{}/lib'.format(os.environ['TARGET'])))\n \n ret = 0"}]}