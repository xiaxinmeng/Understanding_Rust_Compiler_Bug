{"sha": "c8b83babf358cd3094fb05a65889a6d017a81d96", "node_id": "MDY6Q29tbWl0NzI0NzEyOmM4YjgzYmFiZjM1OGNkMzA5NGZiMDVhNjU4ODlhNmQwMTdhODFkOTY=", "commit": {"author": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2020-04-06T00:00:00Z"}, "committer": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2020-04-06T00:00:00Z"}, "message": "Keep codegen units unmerged when building compiler builtins", "tree": {"sha": "e7750129f4aba532d04bf6d3af825b79e8be6d54", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e7750129f4aba532d04bf6d3af825b79e8be6d54"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c8b83babf358cd3094fb05a65889a6d017a81d96", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c8b83babf358cd3094fb05a65889a6d017a81d96", "html_url": "https://github.com/rust-lang/rust/commit/c8b83babf358cd3094fb05a65889a6d017a81d96", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c8b83babf358cd3094fb05a65889a6d017a81d96/comments", "author": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "733f104f138477ef20f59eadcbcf8800b21a7732", "url": "https://api.github.com/repos/rust-lang/rust/commits/733f104f138477ef20f59eadcbcf8800b21a7732", "html_url": "https://github.com/rust-lang/rust/commit/733f104f138477ef20f59eadcbcf8800b21a7732"}], "stats": {"total": 49, "additions": 48, "deletions": 1}, "files": [{"sha": "44aa9a710b65343629f21bc4def713aef493a2f2", "filename": "src/librustc_mir/monomorphize/partitioning.rs", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/c8b83babf358cd3094fb05a65889a6d017a81d96/src%2Flibrustc_mir%2Fmonomorphize%2Fpartitioning.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c8b83babf358cd3094fb05a65889a6d017a81d96/src%2Flibrustc_mir%2Fmonomorphize%2Fpartitioning.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fmonomorphize%2Fpartitioning.rs?ref=c8b83babf358cd3094fb05a65889a6d017a81d96", "patch": "@@ -455,11 +455,18 @@ fn default_visibility(tcx: TyCtxt<'_>, id: DefId, is_generic: bool) -> Visibilit\n fn merge_codegen_units<'tcx>(\n     tcx: TyCtxt<'tcx>,\n     initial_partitioning: &mut PreInliningPartitioning<'tcx>,\n-    target_cgu_count: usize,\n+    mut target_cgu_count: usize,\n ) {\n     assert!(target_cgu_count >= 1);\n     let codegen_units = &mut initial_partitioning.codegen_units;\n \n+    if tcx.is_compiler_builtins(LOCAL_CRATE) {\n+        // Compiler builtins require some degree of control over how mono items\n+        // are partitioned into compilation units. Provide it by keeping the\n+        // original partitioning when compiling the compiler builtins crate.\n+        target_cgu_count = codegen_units.len();\n+    }\n+\n     // Note that at this point in time the `codegen_units` here may not be in a\n     // deterministic order (but we know they're deterministically the same set).\n     // We want this merging to produce a deterministic ordering of codegen units"}, {"sha": "25195743b04007360ab92f5e8cf6d337ee021333", "filename": "src/test/codegen-units/partitioning/compiler-builtins.rs", "status": "added", "additions": 40, "deletions": 0, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/c8b83babf358cd3094fb05a65889a6d017a81d96/src%2Ftest%2Fcodegen-units%2Fpartitioning%2Fcompiler-builtins.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c8b83babf358cd3094fb05a65889a6d017a81d96/src%2Ftest%2Fcodegen-units%2Fpartitioning%2Fcompiler-builtins.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen-units%2Fpartitioning%2Fcompiler-builtins.rs?ref=c8b83babf358cd3094fb05a65889a6d017a81d96", "patch": "@@ -0,0 +1,40 @@\n+// Verifies that during compiler_builtins compilation the codegen units are kept\n+// unmerged. Even when only a single codegen unit is requested with -Ccodegen-units=1.\n+//\n+// compile-flags: -Zprint-mono-items=eager -Ccodegen-units=1\n+\n+#![compiler_builtins]\n+#![crate_type=\"lib\"]\n+#![feature(compiler_builtins)]\n+\n+mod atomics {\n+    //~ MONO_ITEM fn compiler_builtins::atomics[0]::sync_1[0] @@ compiler_builtins-cgu.0[External]\n+    #[no_mangle]\n+    pub extern \"C\" fn sync_1() {}\n+\n+    //~ MONO_ITEM fn compiler_builtins::atomics[0]::sync_2[0] @@ compiler_builtins-cgu.0[External]\n+    #[no_mangle]\n+    pub extern \"C\" fn sync_2() {}\n+\n+    //~ MONO_ITEM fn compiler_builtins::atomics[0]::sync_3[0] @@ compiler_builtins-cgu.0[External]\n+    #[no_mangle]\n+    pub extern \"C\" fn sync_3() {}\n+}\n+\n+mod x {\n+    //~ MONO_ITEM fn compiler_builtins::x[0]::x[0] @@ compiler_builtins-cgu.1[External]\n+    #[no_mangle]\n+    pub extern \"C\" fn x() {}\n+}\n+\n+mod y {\n+    //~ MONO_ITEM fn compiler_builtins::y[0]::y[0] @@ compiler_builtins-cgu.2[External]\n+    #[no_mangle]\n+    pub extern \"C\" fn y() {}\n+}\n+\n+mod z {\n+    //~ MONO_ITEM fn compiler_builtins::z[0]::z[0] @@ compiler_builtins-cgu.3[External]\n+    #[no_mangle]\n+    pub extern \"C\" fn z() {}\n+}"}]}