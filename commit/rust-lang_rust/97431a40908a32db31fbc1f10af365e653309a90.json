{"sha": "97431a40908a32db31fbc1f10af365e653309a90", "node_id": "MDY6Q29tbWl0NzI0NzEyOjk3NDMxYTQwOTA4YTMyZGIzMWZiYzFmMTBhZjM2NWU2NTMzMDlhOTA=", "commit": {"author": {"name": "John K\u00e5re Alsaker", "email": "john.kare.alsaker@gmail.com", "date": "2018-12-03T00:14:35Z"}, "committer": {"name": "John K\u00e5re Alsaker", "email": "john.kare.alsaker@gmail.com", "date": "2019-03-04T23:36:20Z"}, "message": "Create a derive macro for HashStable", "tree": {"sha": "db65eba6bff00e254ad2836a412dd7af5d7293cc", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/db65eba6bff00e254ad2836a412dd7af5d7293cc"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/97431a40908a32db31fbc1f10af365e653309a90", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/97431a40908a32db31fbc1f10af365e653309a90", "html_url": "https://github.com/rust-lang/rust/commit/97431a40908a32db31fbc1f10af365e653309a90", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/97431a40908a32db31fbc1f10af365e653309a90/comments", "author": {"login": "Zoxc", "id": 25784, "node_id": "MDQ6VXNlcjI1Nzg0", "avatar_url": "https://avatars.githubusercontent.com/u/25784?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Zoxc", "html_url": "https://github.com/Zoxc", "followers_url": "https://api.github.com/users/Zoxc/followers", "following_url": "https://api.github.com/users/Zoxc/following{/other_user}", "gists_url": "https://api.github.com/users/Zoxc/gists{/gist_id}", "starred_url": "https://api.github.com/users/Zoxc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Zoxc/subscriptions", "organizations_url": "https://api.github.com/users/Zoxc/orgs", "repos_url": "https://api.github.com/users/Zoxc/repos", "events_url": "https://api.github.com/users/Zoxc/events{/privacy}", "received_events_url": "https://api.github.com/users/Zoxc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Zoxc", "id": 25784, "node_id": "MDQ6VXNlcjI1Nzg0", "avatar_url": "https://avatars.githubusercontent.com/u/25784?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Zoxc", "html_url": "https://github.com/Zoxc", "followers_url": "https://api.github.com/users/Zoxc/followers", "following_url": "https://api.github.com/users/Zoxc/following{/other_user}", "gists_url": "https://api.github.com/users/Zoxc/gists{/gist_id}", "starred_url": "https://api.github.com/users/Zoxc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Zoxc/subscriptions", "organizations_url": "https://api.github.com/users/Zoxc/orgs", "repos_url": "https://api.github.com/users/Zoxc/repos", "events_url": "https://api.github.com/users/Zoxc/events{/privacy}", "received_events_url": "https://api.github.com/users/Zoxc/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a9da8fc9c267c08cfdb8cf5b39da14f154d12939", "url": "https://api.github.com/repos/rust-lang/rust/commits/a9da8fc9c267c08cfdb8cf5b39da14f154d12939", "html_url": "https://github.com/rust-lang/rust/commit/a9da8fc9c267c08cfdb8cf5b39da14f154d12939"}], "stats": {"total": 70, "additions": 63, "deletions": 7}, "files": [{"sha": "31e10c19c7a60599351cd664673d9cb8f0fa60dd", "filename": "src/librustc/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/97431a40908a32db31fbc1f10af365e653309a90/src%2Flibrustc%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/97431a40908a32db31fbc1f10af365e653309a90/src%2Flibrustc%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2FCargo.toml?ref=97431a40908a32db31fbc1f10af365e653309a90", "patch": "@@ -24,6 +24,7 @@ rustc-rayon = \"0.1.2\"\n rustc-rayon-core = \"0.1.2\"\n rustc_apfloat = { path = \"../librustc_apfloat\" }\n rustc_target = { path = \"../librustc_target\" }\n+rustc_macros = { path = \"../librustc_macros\" }\n rustc_data_structures = { path = \"../librustc_data_structures\" }\n errors = { path = \"../librustc_errors\", package = \"rustc_errors\" }\n serialize = { path = \"../libserialize\" }"}, {"sha": "4b5670af138581ded1684e067c82e3f8ea5ffb86", "filename": "src/librustc/hir/mod.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/97431a40908a32db31fbc1f10af365e653309a90/src%2Flibrustc%2Fhir%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/97431a40908a32db31fbc1f10af365e653309a90/src%2Flibrustc%2Fhir%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fhir%2Fmod.rs?ref=97431a40908a32db31fbc1f10af365e653309a90", "patch": "@@ -32,6 +32,7 @@ use crate::ty::query::Providers;\n \n use rustc_data_structures::sync::{ParallelIterator, par_iter, Send, Sync};\n use rustc_data_structures::thin_vec::ThinVec;\n+use rustc_macros::HashStable;\n \n use serialize::{self, Encoder, Encodable, Decoder, Decodable};\n use std::collections::{BTreeSet, BTreeMap};\n@@ -149,7 +150,7 @@ pub const DUMMY_HIR_ID: HirId = HirId {\n \n pub const DUMMY_ITEM_LOCAL_ID: ItemLocalId = ItemLocalId::MAX;\n \n-#[derive(Clone, RustcEncodable, RustcDecodable, Copy)]\n+#[derive(Clone, RustcEncodable, RustcDecodable, Copy, HashStable)]\n pub struct Lifetime {\n     pub hir_id: HirId,\n     pub span: Span,"}, {"sha": "d8d4157e20ec93e300a86af1d2c162869ab55553", "filename": "src/librustc/ich/impls_hir.rs", "status": "modified", "additions": 0, "deletions": 6, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/97431a40908a32db31fbc1f10af365e653309a90/src%2Flibrustc%2Fich%2Fimpls_hir.rs", "raw_url": "https://github.com/rust-lang/rust/raw/97431a40908a32db31fbc1f10af365e653309a90/src%2Flibrustc%2Fich%2Fimpls_hir.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fich%2Fimpls_hir.rs?ref=97431a40908a32db31fbc1f10af365e653309a90", "patch": "@@ -157,12 +157,6 @@ impl_stable_hash_for!(struct ast::Label {\n     ident\n });\n \n-impl_stable_hash_for!(struct hir::Lifetime {\n-    hir_id,\n-    span,\n-    name\n-});\n-\n impl_stable_hash_for!(struct hir::Path {\n     span,\n     def,"}, {"sha": "e1f6e1caeae9b0d1fa5970d90ace7257bca03a9a", "filename": "src/librustc/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/97431a40908a32db31fbc1f10af365e653309a90/src%2Flibrustc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/97431a40908a32db31fbc1f10af365e653309a90/src%2Flibrustc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Flib.rs?ref=97431a40908a32db31fbc1f10af365e653309a90", "patch": "@@ -148,6 +148,7 @@ pub mod util {\n #[doc(hidden)]\n mod rustc {\n     pub use crate::lint;\n+    pub use crate::ich;\n }\n \n // FIXME(#27438): right now the unit tests of librustc don't refer to any actual"}, {"sha": "c5e01e9e0a76a5c8d8734a7baa528fca1455213b", "filename": "src/librustc_macros/Cargo.toml", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/97431a40908a32db31fbc1f10af365e653309a90/src%2Flibrustc_macros%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/97431a40908a32db31fbc1f10af365e653309a90/src%2Flibrustc_macros%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_macros%2FCargo.toml?ref=97431a40908a32db31fbc1f10af365e653309a90", "patch": "@@ -0,0 +1,13 @@\n+[package]\n+name = \"rustc_macros\"\n+version = \"0.1.0\"\n+authors = [\"The Rust Project Developers\"]\n+\n+[lib]\n+proc-macro = true\n+\n+[dependencies]\n+synstructure = \"0.10.1\"\n+syn = { version = \"0.15.22\", features = [\"full\"] }\n+proc-macro2 = \"0.4.24\"\n+quote = \"0.6.10\"\n\\ No newline at end of file"}, {"sha": "86ac0b353e5f41db54ef23ce10835edfd910db2d", "filename": "src/librustc_macros/src/hash_stable.rs", "status": "added", "additions": 31, "deletions": 0, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/97431a40908a32db31fbc1f10af365e653309a90/src%2Flibrustc_macros%2Fsrc%2Fhash_stable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/97431a40908a32db31fbc1f10af365e653309a90/src%2Flibrustc_macros%2Fsrc%2Fhash_stable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_macros%2Fsrc%2Fhash_stable.rs?ref=97431a40908a32db31fbc1f10af365e653309a90", "patch": "@@ -0,0 +1,31 @@\n+use synstructure;\n+use syn;\n+use proc_macro2;\n+\n+pub fn hash_stable_derive(mut s: synstructure::Structure) -> proc_macro2::TokenStream {\n+    let generic: syn::GenericParam = parse_quote!('__ctx);\n+    s.add_bounds(synstructure::AddBounds::Generics);\n+    s.add_impl_generic(generic);\n+    let body = s.each(|bi| quote!{\n+        ::rustc_data_structures::stable_hasher::HashStable::hash_stable(#bi, __hcx, __hasher);\n+    });\n+\n+    let discriminant = match s.ast().data {\n+        syn::Data::Enum(_) => quote! {\n+            ::std::mem::discriminant(self).hash_stable(__hcx, __hasher);\n+        },\n+        syn::Data::Struct(_) => quote! {},\n+        syn::Data::Union(_) => panic!(\"cannot derive on union\"),\n+    };\n+\n+    s.bound_impl(quote!(::rustc_data_structures::stable_hasher::HashStable\n+                        <::rustc::ich::StableHashingContext<'__ctx>>), quote!{\n+        fn hash_stable<__W: ::rustc_data_structures::stable_hasher::StableHasherResult>(\n+            &self,\n+            __hcx: &mut ::rustc::ich::StableHashingContext<'__ctx>,\n+            __hasher: &mut ::rustc_data_structures::stable_hasher::StableHasher<__W>) {\n+            #discriminant\n+            match *self { #body }\n+        }\n+    })\n+}"}, {"sha": "8dcf2b76fad249bfb6a75427fcedaa179f39d1d5", "filename": "src/librustc_macros/src/lib.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/97431a40908a32db31fbc1f10af365e653309a90/src%2Flibrustc_macros%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/97431a40908a32db31fbc1f10af365e653309a90/src%2Flibrustc_macros%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_macros%2Fsrc%2Flib.rs?ref=97431a40908a32db31fbc1f10af365e653309a90", "patch": "@@ -0,0 +1,14 @@\n+#![feature(proc_macro_hygiene)]\n+\n+#[macro_use]\n+extern crate syn;\n+#[macro_use]\n+extern crate synstructure;\n+#[macro_use]\n+extern crate quote;\n+extern crate proc_macro;\n+extern crate proc_macro2;\n+\n+mod hash_stable;\n+\n+decl_derive!([HashStable] => hash_stable::hash_stable_derive);"}, {"sha": "d7683aae841cdd923b157b8f1e4dfaa43eb890db", "filename": "src/tools/tidy/src/deps.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/97431a40908a32db31fbc1f10af365e653309a90/src%2Ftools%2Ftidy%2Fsrc%2Fdeps.rs", "raw_url": "https://github.com/rust-lang/rust/raw/97431a40908a32db31fbc1f10af365e653309a90/src%2Ftools%2Ftidy%2Fsrc%2Fdeps.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Fdeps.rs?ref=97431a40908a32db31fbc1f10af365e653309a90", "patch": "@@ -137,6 +137,7 @@ const WHITELIST: &[Crate<'_>] = &[\n     Crate(\"smallvec\"),\n     Crate(\"stable_deref_trait\"),\n     Crate(\"syn\"),\n+    Crate(\"synstructure\"),\n     Crate(\"tempfile\"),\n     Crate(\"termcolor\"),\n     Crate(\"terminon\"),"}]}