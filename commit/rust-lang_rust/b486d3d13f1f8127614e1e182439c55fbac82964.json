{"sha": "b486d3d13f1f8127614e1e182439c55fbac82964", "node_id": "MDY6Q29tbWl0NzI0NzEyOmI0ODZkM2QxM2YxZjgxMjc2MTRlMWUxODI0MzljNTVmYmFjODI5NjQ=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-07-14T20:27:56Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-07-14T20:27:56Z"}, "message": "Auto merge of #52326 - alexcrichton:tweak-proc-macro-expand, r=petrochenkov\n\nrustc: Tweak expansion of #[proc_macro] for 2018\n\nThe syntactical expansion of `#[proc_macro]` and related attributes currently\ncontains absolute paths which conflicts with a lint for the 2018 edition,\ncausing issues like #52214. This commit puts a band-aid on the issue by ensuring\nthat procedural macros can also migrate to the 2018 edition for now by tweaking\nthe expansion based on what features are activated. A more long-term solution\nwould probably tweak the edition hygiene of spans, but this should do the trick\nfor now.\n\nCloses #52214", "tree": {"sha": "95c53051893b9f5663c7d2da7fcbef444e90fab2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/95c53051893b9f5663c7d2da7fcbef444e90fab2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b486d3d13f1f8127614e1e182439c55fbac82964", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b486d3d13f1f8127614e1e182439c55fbac82964", "html_url": "https://github.com/rust-lang/rust/commit/b486d3d13f1f8127614e1e182439c55fbac82964", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b486d3d13f1f8127614e1e182439c55fbac82964/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cbcd81a4a9312146942f8781376cabc109bfbcf0", "url": "https://api.github.com/repos/rust-lang/rust/commits/cbcd81a4a9312146942f8781376cabc109bfbcf0", "html_url": "https://github.com/rust-lang/rust/commit/cbcd81a4a9312146942f8781376cabc109bfbcf0"}, {"sha": "94c9ea4baee98c1d6579865d0e0d78a45927aa83", "url": "https://api.github.com/repos/rust-lang/rust/commits/94c9ea4baee98c1d6579865d0e0d78a45927aa83", "html_url": "https://github.com/rust-lang/rust/commit/94c9ea4baee98c1d6579865d0e0d78a45927aa83"}], "stats": {"total": 35, "additions": 32, "deletions": 3}, "files": [{"sha": "3cfa50b3e7d5e338f93dfcd24692636aeb65b50b", "filename": "src/libsyntax_ext/proc_macro_registrar.rs", "status": "modified", "additions": 8, "deletions": 3, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/b486d3d13f1f8127614e1e182439c55fbac82964/src%2Flibsyntax_ext%2Fproc_macro_registrar.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b486d3d13f1f8127614e1e182439c55fbac82964/src%2Flibsyntax_ext%2Fproc_macro_registrar.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax_ext%2Fproc_macro_registrar.rs?ref=b486d3d13f1f8127614e1e182439c55fbac82964", "patch": "@@ -23,6 +23,7 @@ use syntax::fold::Folder;\n use syntax::parse::ParseSess;\n use syntax::ptr::P;\n use syntax::symbol::Symbol;\n+use syntax::symbol::keywords;\n use syntax::visit::{self, Visitor};\n \n use syntax_pos::{Span, DUMMY_SP};\n@@ -380,9 +381,13 @@ fn mk_registrar(cx: &mut ExtCtxt,\n     let register_custom_derive = Ident::from_str(\"register_custom_derive\");\n     let register_attr_proc_macro = Ident::from_str(\"register_attr_proc_macro\");\n     let register_bang_proc_macro = Ident::from_str(\"register_bang_proc_macro\");\n+    let crate_kw = Ident::with_empty_ctxt(keywords::Crate.name());\n+    let local_path = |cx: &mut ExtCtxt, sp: Span, name: Ident| {\n+        cx.path(sp.with_ctxt(span.ctxt()), vec![crate_kw, name])\n+    };\n \n     let mut stmts = custom_derives.iter().map(|cd| {\n-        let path = cx.path_global(cd.span, vec![cd.function_name]);\n+        let path = local_path(cx, cd.span, cd.function_name);\n         let trait_name = cx.expr_str(cd.span, cd.trait_name);\n         let attrs = cx.expr_vec_slice(\n             span,\n@@ -399,7 +404,7 @@ fn mk_registrar(cx: &mut ExtCtxt,\n \n     stmts.extend(custom_attrs.iter().map(|ca| {\n         let name = cx.expr_str(ca.span, ca.function_name.name);\n-        let path = cx.path_global(ca.span, vec![ca.function_name]);\n+        let path = local_path(cx, ca.span, ca.function_name);\n         let registrar = cx.expr_ident(ca.span, registrar);\n \n         let ufcs_path = cx.path(span,\n@@ -411,7 +416,7 @@ fn mk_registrar(cx: &mut ExtCtxt,\n \n     stmts.extend(custom_macros.iter().map(|cm| {\n         let name = cx.expr_str(cm.span, cm.function_name.name);\n-        let path = cx.path_global(cm.span, vec![cm.function_name]);\n+        let path = local_path(cx, cm.span, cm.function_name);\n         let registrar = cx.expr_ident(cm.span, registrar);\n \n         let ufcs_path = cx.path(span,"}, {"sha": "1068c05874589d09460fef8864db250e58afde90", "filename": "src/test/ui-fulldeps/rust-2018/proc-macro-crate-in-paths.rs", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/b486d3d13f1f8127614e1e182439c55fbac82964/src%2Ftest%2Fui-fulldeps%2Frust-2018%2Fproc-macro-crate-in-paths.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b486d3d13f1f8127614e1e182439c55fbac82964/src%2Ftest%2Fui-fulldeps%2Frust-2018%2Fproc-macro-crate-in-paths.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui-fulldeps%2Frust-2018%2Fproc-macro-crate-in-paths.rs?ref=b486d3d13f1f8127614e1e182439c55fbac82964", "patch": "@@ -0,0 +1,24 @@\n+// Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// compile-pass\n+\n+#![crate_type = \"proc-macro\"]\n+#![deny(rust_2018_compatibility)]\n+#![feature(rust_2018_preview)]\n+\n+extern crate proc_macro;\n+\n+use proc_macro::TokenStream;\n+\n+#[proc_macro_derive(Template, attributes(template))]\n+pub fn derive_template(input: TokenStream) -> TokenStream {\n+    input\n+}"}]}