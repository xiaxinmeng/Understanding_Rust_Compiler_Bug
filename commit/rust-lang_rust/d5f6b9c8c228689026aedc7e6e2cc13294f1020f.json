{"sha": "d5f6b9c8c228689026aedc7e6e2cc13294f1020f", "node_id": "C_kwDOAAsO6NoAKGQ1ZjZiOWM4YzIyODY4OTAyNmFlZGM3ZTZlMmNjMTMyOTRmMTAyMGY", "commit": {"author": {"name": "Wesley Wiser", "email": "wesleywiser@microsoft.com", "date": "2021-12-02T21:16:34Z"}, "committer": {"name": "Wesley Wiser", "email": "wesleywiser@microsoft.com", "date": "2021-12-03T17:00:12Z"}, "message": "code-cov: generate dead functions with private/default linkage\n\nAs discovered in #85461, the MSVC linker treats weak symbols slightly\ndifferently than unix-y linkers do. This causes link.exe to fail with\nLNK1227 \"conflicting weak extern definition\" where as other targets are\nable to link successfully.\n\nThis changes the dead functions from being generated as weak/hidden to\nprivate/default which, as the LLVM reference says:\n\n> Global values with \u201cprivate\u201d linkage are only directly accessible by\nobjects in the current module. In particular, linking code into a module\nwith a private global value may cause the private to be renamed as\nnecessary to avoid collisions. Because the symbol is private to the\nmodule, all references can be updated. This doesn\u2019t show up in any\nsymbol table in the object file.\n\nThis fixes the conflicting weak symbols but doesn't address the reason\n*why* we have conflicting symbols for these dead functions. The test\ncases added in this commit contain a minimal repro of the fundamental\nissue which is that the logic used to decide what dead code functions\nshould be codegen'd in the current CGU doesn't take into account that\nfunctions can be duplicated across multiple CGUs (for instance, in the\ncase of `#[inline(always)]` functions).\n\nFixing that is likely to be a more complex change (see\nhttps://github.com/rust-lang/rust/issues/85461#issuecomment-985005805).\n\nFixes #85461", "tree": {"sha": "e4e0fdf7a4d87201836d248f52a72036eb125b74", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e4e0fdf7a4d87201836d248f52a72036eb125b74"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d5f6b9c8c228689026aedc7e6e2cc13294f1020f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d5f6b9c8c228689026aedc7e6e2cc13294f1020f", "html_url": "https://github.com/rust-lang/rust/commit/d5f6b9c8c228689026aedc7e6e2cc13294f1020f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d5f6b9c8c228689026aedc7e6e2cc13294f1020f/comments", "author": {"login": "wesleywiser", "id": 831192, "node_id": "MDQ6VXNlcjgzMTE5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/831192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wesleywiser", "html_url": "https://github.com/wesleywiser", "followers_url": "https://api.github.com/users/wesleywiser/followers", "following_url": "https://api.github.com/users/wesleywiser/following{/other_user}", "gists_url": "https://api.github.com/users/wesleywiser/gists{/gist_id}", "starred_url": "https://api.github.com/users/wesleywiser/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wesleywiser/subscriptions", "organizations_url": "https://api.github.com/users/wesleywiser/orgs", "repos_url": "https://api.github.com/users/wesleywiser/repos", "events_url": "https://api.github.com/users/wesleywiser/events{/privacy}", "received_events_url": "https://api.github.com/users/wesleywiser/received_events", "type": "User", "site_admin": false}, "committer": {"login": "wesleywiser", "id": 831192, "node_id": "MDQ6VXNlcjgzMTE5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/831192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wesleywiser", "html_url": "https://github.com/wesleywiser", "followers_url": "https://api.github.com/users/wesleywiser/followers", "following_url": "https://api.github.com/users/wesleywiser/following{/other_user}", "gists_url": "https://api.github.com/users/wesleywiser/gists{/gist_id}", "starred_url": "https://api.github.com/users/wesleywiser/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wesleywiser/subscriptions", "organizations_url": "https://api.github.com/users/wesleywiser/orgs", "repos_url": "https://api.github.com/users/wesleywiser/repos", "events_url": "https://api.github.com/users/wesleywiser/events{/privacy}", "received_events_url": "https://api.github.com/users/wesleywiser/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d47a6cc3f2dab0ef046c2bb7b76a9ee8d1a0be92", "url": "https://api.github.com/repos/rust-lang/rust/commits/d47a6cc3f2dab0ef046c2bb7b76a9ee8d1a0be92", "html_url": "https://github.com/rust-lang/rust/commit/d47a6cc3f2dab0ef046c2bb7b76a9ee8d1a0be92"}], "stats": {"total": 99, "additions": 97, "deletions": 2}, "files": [{"sha": "96b278dbe326aff09bc3f6db0bceb4e161d5dd61", "filename": "compiler/rustc_codegen_llvm/src/coverageinfo/mod.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/d5f6b9c8c228689026aedc7e6e2cc13294f1020f/compiler%2Frustc_codegen_llvm%2Fsrc%2Fcoverageinfo%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d5f6b9c8c228689026aedc7e6e2cc13294f1020f/compiler%2Frustc_codegen_llvm%2Fsrc%2Fcoverageinfo%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fcoverageinfo%2Fmod.rs?ref=d5f6b9c8c228689026aedc7e6e2cc13294f1020f", "patch": "@@ -212,8 +212,8 @@ fn declare_unused_fn(cx: &CodegenCx<'ll, 'tcx>, def_id: &DefId) -> Instance<'tcx\n         ),\n     );\n \n-    llvm::set_linkage(llfn, llvm::Linkage::WeakAnyLinkage);\n-    llvm::set_visibility(llfn, llvm::Visibility::Hidden);\n+    llvm::set_linkage(llfn, llvm::Linkage::PrivateLinkage);\n+    llvm::set_visibility(llfn, llvm::Visibility::Default);\n \n     assert!(cx.instances.borrow_mut().insert(instance, llfn).is_none());\n "}, {"sha": "2831e9b532aba6ac0d8f06ac9f204b9b0c163d98", "filename": "src/test/run-make-fulldeps/coverage-reports/expected_show_coverage.issue-85461.txt", "status": "added", "additions": 36, "deletions": 0, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/d5f6b9c8c228689026aedc7e6e2cc13294f1020f/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2Fexpected_show_coverage.issue-85461.txt", "raw_url": "https://github.com/rust-lang/rust/raw/d5f6b9c8c228689026aedc7e6e2cc13294f1020f/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2Fexpected_show_coverage.issue-85461.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2Fexpected_show_coverage.issue-85461.txt?ref=d5f6b9c8c228689026aedc7e6e2cc13294f1020f", "patch": "@@ -0,0 +1,36 @@\n+../coverage/issue-85461.rs:\n+    1|       |// Regression test for #85461: MSVC sometimes fail to link with dead code and #[inline(always)]\n+    2|       |\n+    3|       |extern crate inline_always_with_dead_code;\n+    4|       |\n+    5|       |use inline_always_with_dead_code::{bar, baz};\n+    6|       |\n+    7|      1|fn main() {\n+    8|      1|    bar::call_me();\n+    9|      1|    baz::call_me();\n+   10|      1|}\n+\n+../coverage/lib/inline_always_with_dead_code.rs:\n+    1|       |// compile-flags: -Zinstrument-coverage -Ccodegen-units=4 -Copt-level=0\n+    2|       |\n+    3|       |#![allow(dead_code)]\n+    4|       |\n+    5|       |mod foo {\n+    6|       |    #[inline(always)]\n+    7|      2|    pub fn called() { }\n+    8|       |\n+    9|      0|    fn uncalled() { }\n+   10|       |}\n+   11|       |\n+   12|       |pub mod bar {\n+   13|      1|    pub fn call_me() {\n+   14|      1|        super::foo::called();\n+   15|      1|    }\n+   16|       |}\n+   17|       |\n+   18|       |pub mod baz {\n+   19|      1|    pub fn call_me() {\n+   20|      1|        super::foo::called();\n+   21|      1|    }\n+   22|       |}\n+"}, {"sha": "a1b9ebb1ed34876c72ca926b36eac46595244c81", "filename": "src/test/run-make-fulldeps/coverage/issue-85461.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/d5f6b9c8c228689026aedc7e6e2cc13294f1020f/src%2Ftest%2Frun-make-fulldeps%2Fcoverage%2Fissue-85461.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d5f6b9c8c228689026aedc7e6e2cc13294f1020f/src%2Ftest%2Frun-make-fulldeps%2Fcoverage%2Fissue-85461.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fcoverage%2Fissue-85461.rs?ref=d5f6b9c8c228689026aedc7e6e2cc13294f1020f", "patch": "@@ -0,0 +1,10 @@\n+// Regression test for #85461: MSVC sometimes fail to link with dead code and #[inline(always)]\n+\n+extern crate inline_always_with_dead_code;\n+\n+use inline_always_with_dead_code::{bar, baz};\n+\n+fn main() {\n+    bar::call_me();\n+    baz::call_me();\n+}"}, {"sha": "b567916aea060a829470b1fea6fa8e9b39450eaf", "filename": "src/test/run-make-fulldeps/coverage/lib/inline_always_with_dead_code.rs", "status": "added", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/d5f6b9c8c228689026aedc7e6e2cc13294f1020f/src%2Ftest%2Frun-make-fulldeps%2Fcoverage%2Flib%2Finline_always_with_dead_code.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d5f6b9c8c228689026aedc7e6e2cc13294f1020f/src%2Ftest%2Frun-make-fulldeps%2Fcoverage%2Flib%2Finline_always_with_dead_code.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fcoverage%2Flib%2Finline_always_with_dead_code.rs?ref=d5f6b9c8c228689026aedc7e6e2cc13294f1020f", "patch": "@@ -0,0 +1,22 @@\n+// compile-flags: -Zinstrument-coverage -Ccodegen-units=4 -Copt-level=0\n+\n+#![allow(dead_code)]\n+\n+mod foo {\n+    #[inline(always)]\n+    pub fn called() { }\n+\n+    fn uncalled() { }\n+}\n+\n+pub mod bar {\n+    pub fn call_me() {\n+        super::foo::called();\n+    }\n+}\n+\n+pub mod baz {\n+    pub fn call_me() {\n+        super::foo::called();\n+    }\n+}"}, {"sha": "4c6c83f2612f6bc5603d6eeead4d75b983af3729", "filename": "src/test/ui/issues/issue-85461.rs", "status": "added", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/d5f6b9c8c228689026aedc7e6e2cc13294f1020f/src%2Ftest%2Fui%2Fissues%2Fissue-85461.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d5f6b9c8c228689026aedc7e6e2cc13294f1020f/src%2Ftest%2Fui%2Fissues%2Fissue-85461.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-85461.rs?ref=d5f6b9c8c228689026aedc7e6e2cc13294f1020f", "patch": "@@ -0,0 +1,27 @@\n+// compile-flags: -Zinstrument-coverage -Ccodegen-units=4 --crate-type dylib -Copt-level=0\n+// build-pass\n+// needs-profiler-support\n+\n+// Regression test for #85461 where MSVC sometimes fails to link instrument-coverage binaries\n+// with dead code and #[inline(always)].\n+\n+#![allow(dead_code)]\n+\n+mod foo {\n+    #[inline(always)]\n+    pub fn called() { }\n+\n+    fn uncalled() { }\n+}\n+\n+pub mod bar {\n+    pub fn call_me() {\n+        super::foo::called();\n+    }\n+}\n+\n+pub mod baz {\n+    pub fn call_me() {\n+        super::foo::called();\n+    }\n+}"}]}