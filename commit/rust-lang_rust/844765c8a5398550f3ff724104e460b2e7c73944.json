{"sha": "844765c8a5398550f3ff724104e460b2e7c73944", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg0NDc2NWM4YTUzOTg1NTBmM2ZmNzI0MTA0ZTQ2MGIyZTdjNzM5NDQ=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-10-02T15:51:58Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-10-02T15:51:58Z"}, "message": "Auto merge of #4603 - rust-lang:needless-doc-main, r=flip1995\n\nNew lint: needless_doc_main\n\nchangelog: Add `needless_doc_main` lint", "tree": {"sha": "6d6a0a39103c26ced5ef75a12414132722cde4b8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6d6a0a39103c26ced5ef75a12414132722cde4b8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/844765c8a5398550f3ff724104e460b2e7c73944", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/844765c8a5398550f3ff724104e460b2e7c73944", "html_url": "https://github.com/rust-lang/rust/commit/844765c8a5398550f3ff724104e460b2e7c73944", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/844765c8a5398550f3ff724104e460b2e7c73944/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "83f90aaedf7e756c22e4a8712233fd0425f1ee85", "url": "https://api.github.com/repos/rust-lang/rust/commits/83f90aaedf7e756c22e4a8712233fd0425f1ee85", "html_url": "https://github.com/rust-lang/rust/commit/83f90aaedf7e756c22e4a8712233fd0425f1ee85"}, {"sha": "23a9c021201df810f40d0ad1fe3815dda5da8462", "url": "https://api.github.com/repos/rust-lang/rust/commits/23a9c021201df810f40d0ad1fe3815dda5da8462", "html_url": "https://github.com/rust-lang/rust/commit/23a9c021201df810f40d0ad1fe3815dda5da8462"}], "stats": {"total": 67, "additions": 55, "deletions": 12}, "files": [{"sha": "c4e045865301d86dda859c2bba90e9ebb9d2af97", "filename": "CHANGELOG.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/844765c8a5398550f3ff724104e460b2e7c73944/CHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/844765c8a5398550f3ff724104e460b2e7c73944/CHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/CHANGELOG.md?ref=844765c8a5398550f3ff724104e460b2e7c73944", "patch": "@@ -1105,6 +1105,7 @@ Released 2018-09-13\n [`needless_borrowed_reference`]: https://rust-lang.github.io/rust-clippy/master/index.html#needless_borrowed_reference\n [`needless_collect`]: https://rust-lang.github.io/rust-clippy/master/index.html#needless_collect\n [`needless_continue`]: https://rust-lang.github.io/rust-clippy/master/index.html#needless_continue\n+[`needless_doctest_main`]: https://rust-lang.github.io/rust-clippy/master/index.html#needless_doctest_main\n [`needless_lifetimes`]: https://rust-lang.github.io/rust-clippy/master/index.html#needless_lifetimes\n [`needless_pass_by_value`]: https://rust-lang.github.io/rust-clippy/master/index.html#needless_pass_by_value\n [`needless_range_loop`]: https://rust-lang.github.io/rust-clippy/master/index.html#needless_range_loop"}, {"sha": "2f7032af87d0799ca8585b828151a079c4c08544", "filename": "README.md", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/844765c8a5398550f3ff724104e460b2e7c73944/README.md", "raw_url": "https://github.com/rust-lang/rust/raw/844765c8a5398550f3ff724104e460b2e7c73944/README.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/README.md?ref=844765c8a5398550f3ff724104e460b2e7c73944", "patch": "@@ -6,7 +6,7 @@\n \n A collection of lints to catch common mistakes and improve your [Rust](https://github.com/rust-lang/rust) code.\n \n-[There are 317 lints included in this crate!](https://rust-lang.github.io/rust-clippy/master/index.html)\n+[There are 318 lints included in this crate!](https://rust-lang.github.io/rust-clippy/master/index.html)\n \n We have a bunch of lint categories to allow you to choose how much Clippy is supposed to ~~annoy~~ help you:\n "}, {"sha": "bd959427403b712235f0db80387592d6ef9b3dfd", "filename": "clippy_lints/src/doc.rs", "status": "modified", "additions": 43, "deletions": 10, "changes": 53, "blob_url": "https://github.com/rust-lang/rust/blob/844765c8a5398550f3ff724104e460b2e7c73944/clippy_lints%2Fsrc%2Fdoc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/844765c8a5398550f3ff724104e460b2e7c73944/clippy_lints%2Fsrc%2Fdoc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fdoc.rs?ref=844765c8a5398550f3ff724104e460b2e7c73944", "patch": "@@ -68,6 +68,34 @@ declare_clippy_lint! {\n     \"`pub unsafe fn` without `# Safety` docs\"\n }\n \n+declare_clippy_lint! {\n+    /// **What it does:** Checks for `fn main() { .. }` in doctests\n+    ///\n+    /// **Why is this bad?** The test can be shorter (and likely more readable)\n+    /// if the `fn main()` is left implicit.\n+    ///\n+    /// **Known problems:** None.\n+    ///\n+    /// **Examples:**\n+    /// ``````rust\n+    /// /// An example of a doctest with a `main()` function\n+    /// ///\n+    /// /// # Examples\n+    /// ///\n+    /// /// ```\n+    /// /// fn main() {\n+    /// ///     // this needs not be in an `fn`\n+    /// /// }\n+    /// /// ```\n+    /// fn needless_main() {\n+    ///     unimplemented!();\n+    /// }\n+    /// ``````\n+    pub NEEDLESS_DOCTEST_MAIN,\n+    style,\n+    \"presence of `fn main() {` in code examples\"\n+}\n+\n #[allow(clippy::module_name_repetitions)]\n #[derive(Clone)]\n pub struct DocMarkdown {\n@@ -80,7 +108,7 @@ impl DocMarkdown {\n     }\n }\n \n-impl_lint_pass!(DocMarkdown => [DOC_MARKDOWN, MISSING_SAFETY_DOC]);\n+impl_lint_pass!(DocMarkdown => [DOC_MARKDOWN, MISSING_SAFETY_DOC, NEEDLESS_DOCTEST_MAIN]);\n \n impl EarlyLintPass for DocMarkdown {\n     fn check_crate(&mut self, cx: &EarlyContext<'_>, krate: &ast::Crate) {\n@@ -245,17 +273,16 @@ fn check_doc<'a, Events: Iterator<Item = (pulldown_cmark::Event<'a>, Range<usize\n                     continue;\n                 }\n                 safety_header |= in_heading && text.trim() == \"Safety\";\n-                if !in_code {\n-                    let index = match spans.binary_search_by(|c| c.0.cmp(&range.start)) {\n-                        Ok(o) => o,\n-                        Err(e) => e - 1,\n-                    };\n-\n-                    let (begin, span) = spans[index];\n-\n+                let index = match spans.binary_search_by(|c| c.0.cmp(&range.start)) {\n+                    Ok(o) => o,\n+                    Err(e) => e - 1,\n+                };\n+                let (begin, span) = spans[index];\n+                if in_code {\n+                    check_code(cx, &text, span);\n+                } else {\n                     // Adjust for the beginning of the current `Event`\n                     let span = span.with_lo(span.lo() + BytePos::from_usize(range.start - begin));\n-\n                     check_text(cx, valid_idents, &text, span);\n                 }\n             },\n@@ -264,6 +291,12 @@ fn check_doc<'a, Events: Iterator<Item = (pulldown_cmark::Event<'a>, Range<usize\n     safety_header\n }\n \n+fn check_code(cx: &EarlyContext<'_>, text: &str, span: Span) {\n+    if text.contains(\"fn main() {\") {\n+        span_lint(cx, NEEDLESS_DOCTEST_MAIN, span, \"needless `fn main` in doctest\");\n+    }\n+}\n+\n fn check_text(cx: &EarlyContext<'_>, valid_idents: &FxHashSet<String>, text: &str, span: Span) {\n     for word in text.split(|c: char| c.is_whitespace() || c == '\\'') {\n         // Trim punctuation as in `some comment (see foo::bar).`"}, {"sha": "10a14f3b906d732393c5174c5ef576607369f9f6", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/844765c8a5398550f3ff724104e460b2e7c73944/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/844765c8a5398550f3ff724104e460b2e7c73944/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=844765c8a5398550f3ff724104e460b2e7c73944", "patch": "@@ -713,6 +713,7 @@ pub fn register_plugins(reg: &mut rustc_driver::plugin::Registry<'_>, conf: &Con\n         copies::IF_SAME_THEN_ELSE,\n         derive::DERIVE_HASH_XOR_EQ,\n         doc::MISSING_SAFETY_DOC,\n+        doc::NEEDLESS_DOCTEST_MAIN,\n         double_comparison::DOUBLE_COMPARISONS,\n         double_parens::DOUBLE_PARENS,\n         drop_bounds::DROP_BOUNDS,\n@@ -937,6 +938,7 @@ pub fn register_plugins(reg: &mut rustc_driver::plugin::Registry<'_>, conf: &Con\n         collapsible_if::COLLAPSIBLE_IF,\n         comparison_chain::COMPARISON_CHAIN,\n         doc::MISSING_SAFETY_DOC,\n+        doc::NEEDLESS_DOCTEST_MAIN,\n         enum_variants::ENUM_VARIANT_NAMES,\n         enum_variants::MODULE_INCEPTION,\n         eq_op::OP_REF,"}, {"sha": "383be8b1da4ae0455e69ce1dacf4697e30cd1a99", "filename": "src/lintlist/mod.rs", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/844765c8a5398550f3ff724104e460b2e7c73944/src%2Flintlist%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/844765c8a5398550f3ff724104e460b2e7c73944/src%2Flintlist%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flintlist%2Fmod.rs?ref=844765c8a5398550f3ff724104e460b2e7c73944", "patch": "@@ -6,7 +6,7 @@ pub use lint::Lint;\n pub use lint::LINT_LEVELS;\n \n // begin lint list, do not remove this comment, it\u2019s used in `update_lints`\n-pub const ALL_LINTS: [Lint; 317] = [\n+pub const ALL_LINTS: [Lint; 318] = [\n     Lint {\n         name: \"absurd_extreme_comparisons\",\n         group: \"correctness\",\n@@ -1225,6 +1225,13 @@ pub const ALL_LINTS: [Lint; 317] = [\n         deprecation: None,\n         module: \"needless_continue\",\n     },\n+    Lint {\n+        name: \"needless_doctest_main\",\n+        group: \"style\",\n+        desc: \"presence of `fn main() {` in code examples\",\n+        deprecation: None,\n+        module: \"doc\",\n+    },\n     Lint {\n         name: \"needless_lifetimes\",\n         group: \"complexity\","}]}