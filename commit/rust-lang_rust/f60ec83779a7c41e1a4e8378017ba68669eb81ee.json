{"sha": "f60ec83779a7c41e1a4e8378017ba68669eb81ee", "node_id": "C_kwDOAAsO6NoAKGY2MGVjODM3NzlhN2M0MWUxYTRlODM3ODAxN2JhNjg2NjllYjgxZWU", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2022-06-29T21:07:24Z"}, "committer": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2022-06-29T21:13:13Z"}, "message": "interpret: add From<&MplaceTy> for PlaceTy", "tree": {"sha": "d54d6f4458708ee9277f6c9d2ad432e6344dc378", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d54d6f4458708ee9277f6c9d2ad432e6344dc378"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f60ec83779a7c41e1a4e8378017ba68669eb81ee", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f60ec83779a7c41e1a4e8378017ba68669eb81ee", "html_url": "https://github.com/rust-lang/rust/commit/f60ec83779a7c41e1a4e8378017ba68669eb81ee", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f60ec83779a7c41e1a4e8378017ba68669eb81ee/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "66c83ffca1512ed76f9445ec7f7280f768ef71c4", "url": "https://api.github.com/repos/rust-lang/rust/commits/66c83ffca1512ed76f9445ec7f7280f768ef71c4", "html_url": "https://github.com/rust-lang/rust/commit/66c83ffca1512ed76f9445ec7f7280f768ef71c4"}], "stats": {"total": 37, "additions": 29, "deletions": 8}, "files": [{"sha": "f8b390aaf50e140e6f55a30574426f0f83d9b7a1", "filename": "compiler/rustc_const_eval/src/const_eval/valtrees.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/f60ec83779a7c41e1a4e8378017ba68669eb81ee/compiler%2Frustc_const_eval%2Fsrc%2Fconst_eval%2Fvaltrees.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f60ec83779a7c41e1a4e8378017ba68669eb81ee/compiler%2Frustc_const_eval%2Fsrc%2Fconst_eval%2Fvaltrees.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Fconst_eval%2Fvaltrees.rs?ref=f60ec83779a7c41e1a4e8378017ba68669eb81ee", "patch": "@@ -346,7 +346,7 @@ fn valtree_into_mplace<'tcx>(\n         ty::FnDef(_, _) => {\n             ecx.write_immediate(\n                 Immediate::Scalar(ScalarMaybeUninit::Scalar(Scalar::ZST)),\n-                &(*place).into(),\n+                &place.into(),\n             )\n             .unwrap();\n         }\n@@ -355,7 +355,7 @@ fn valtree_into_mplace<'tcx>(\n             debug!(\"writing trivial valtree {:?} to place {:?}\", scalar_int, place);\n             ecx.write_immediate(\n                 Immediate::Scalar(ScalarMaybeUninit::Scalar(scalar_int.into())),\n-                &(*place).into(),\n+                &place.into(),\n             )\n             .unwrap();\n         }\n@@ -382,7 +382,7 @@ fn valtree_into_mplace<'tcx>(\n             };\n             debug!(?imm);\n \n-            ecx.write_immediate(imm, &(*place).into()).unwrap();\n+            ecx.write_immediate(imm, &place.into()).unwrap();\n         }\n         ty::Adt(_, _) | ty::Tuple(_) | ty::Array(_, _) | ty::Str | ty::Slice(_) => {\n             let branches = valtree.unwrap_branch();\n@@ -464,11 +464,11 @@ fn valtree_into_mplace<'tcx>(\n \n             if let Some(variant_idx) = variant_idx {\n                 // don't forget filling the place with the discriminant of the enum\n-                ecx.write_discriminant(variant_idx, &(*place).into()).unwrap();\n+                ecx.write_discriminant(variant_idx, &place.into()).unwrap();\n             }\n \n             debug!(\"dump of place after writing discriminant:\");\n-            dump_place(ecx, (*place).into());\n+            dump_place(ecx, place.into());\n         }\n         _ => bug!(\"shouldn't have created a ValTree for {:?}\", ty),\n     }"}, {"sha": "c1d42c9ae7cc346f5dc91c4a4aeef31460a49fcf", "filename": "compiler/rustc_const_eval/src/interpret/intern.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f60ec83779a7c41e1a4e8378017ba68669eb81ee/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Fintern.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f60ec83779a7c41e1a4e8378017ba68669eb81ee/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Fintern.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Fintern.rs?ref=f60ec83779a7c41e1a4e8378017ba68669eb81ee", "patch": "@@ -195,7 +195,7 @@ impl<'rt, 'mir, 'tcx: 'mir, M: CompileTimeMachine<'mir, 'tcx, const_eval::Memory\n         let tcx = self.ecx.tcx;\n         let ty = mplace.layout.ty;\n         if let ty::Ref(_, referenced_ty, ref_mutability) = *ty.kind() {\n-            let value = self.ecx.read_immediate(&(*mplace).into())?;\n+            let value = self.ecx.read_immediate(&mplace.into())?;\n             let mplace = self.ecx.ref_to_mplace(&value)?;\n             assert_eq!(mplace.layout.ty, referenced_ty);\n             // Handle trait object vtables."}, {"sha": "e7a08e052758c561b9cad610309570dde0eadaa3", "filename": "compiler/rustc_const_eval/src/interpret/operand.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/f60ec83779a7c41e1a4e8378017ba68669eb81ee/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Foperand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f60ec83779a7c41e1a4e8378017ba68669eb81ee/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Foperand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Foperand.rs?ref=f60ec83779a7c41e1a4e8378017ba68669eb81ee", "patch": "@@ -204,6 +204,13 @@ impl<'tcx, Tag: Provenance> From<&'_ MPlaceTy<'tcx, Tag>> for OpTy<'tcx, Tag> {\n     }\n }\n \n+impl<'tcx, Tag: Provenance> From<&'_ mut MPlaceTy<'tcx, Tag>> for OpTy<'tcx, Tag> {\n+    #[inline(always)]\n+    fn from(mplace: &mut MPlaceTy<'tcx, Tag>) -> Self {\n+        OpTy { op: Operand::Indirect(**mplace), layout: mplace.layout }\n+    }\n+}\n+\n impl<'tcx, Tag: Provenance> From<ImmTy<'tcx, Tag>> for OpTy<'tcx, Tag> {\n     #[inline(always)]\n     fn from(val: ImmTy<'tcx, Tag>) -> Self {"}, {"sha": "337fcd28c663d7e12d3f03093be7119966e57673", "filename": "compiler/rustc_const_eval/src/interpret/place.rs", "status": "modified", "additions": 15, "deletions": 1, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/f60ec83779a7c41e1a4e8378017ba68669eb81ee/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Fplace.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f60ec83779a7c41e1a4e8378017ba68669eb81ee/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Fplace.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Fplace.rs?ref=f60ec83779a7c41e1a4e8378017ba68669eb81ee", "patch": "@@ -118,7 +118,21 @@ impl<'tcx, Tag: Provenance> std::ops::Deref for MPlaceTy<'tcx, Tag> {\n impl<'tcx, Tag: Provenance> From<MPlaceTy<'tcx, Tag>> for PlaceTy<'tcx, Tag> {\n     #[inline(always)]\n     fn from(mplace: MPlaceTy<'tcx, Tag>) -> Self {\n-        PlaceTy { place: Place::Ptr(mplace.mplace), layout: mplace.layout }\n+        PlaceTy { place: Place::Ptr(*mplace), layout: mplace.layout }\n+    }\n+}\n+\n+impl<'tcx, Tag: Provenance> From<&'_ MPlaceTy<'tcx, Tag>> for PlaceTy<'tcx, Tag> {\n+    #[inline(always)]\n+    fn from(mplace: &MPlaceTy<'tcx, Tag>) -> Self {\n+        PlaceTy { place: Place::Ptr(**mplace), layout: mplace.layout }\n+    }\n+}\n+\n+impl<'tcx, Tag: Provenance> From<&'_ mut MPlaceTy<'tcx, Tag>> for PlaceTy<'tcx, Tag> {\n+    #[inline(always)]\n+    fn from(mplace: &mut MPlaceTy<'tcx, Tag>) -> Self {\n+        PlaceTy { place: Place::Ptr(**mplace), layout: mplace.layout }\n     }\n }\n "}, {"sha": "2b77ed898934544ef573d80526e1969fd51a6dab", "filename": "compiler/rustc_const_eval/src/interpret/visitor.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f60ec83779a7c41e1a4e8378017ba68669eb81ee/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Fvisitor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f60ec83779a7c41e1a4e8378017ba68669eb81ee/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Fvisitor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Fvisitor.rs?ref=f60ec83779a7c41e1a4e8378017ba68669eb81ee", "patch": "@@ -92,7 +92,7 @@ impl<'mir, 'tcx: 'mir, M: Machine<'mir, 'tcx>> Value<'mir, 'tcx, M>\n         &self,\n         _ecx: &InterpCx<'mir, 'tcx, M>,\n     ) -> InterpResult<'tcx, OpTy<'tcx, M::PointerTag>> {\n-        Ok((*self).into())\n+        Ok(self.into())\n     }\n \n     #[inline(always)]"}]}