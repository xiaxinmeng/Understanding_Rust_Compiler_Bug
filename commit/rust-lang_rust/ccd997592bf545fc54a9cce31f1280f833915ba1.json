{"sha": "ccd997592bf545fc54a9cce31f1280f833915ba1", "node_id": "MDY6Q29tbWl0NzI0NzEyOmNjZDk5NzU5MmJmNTQ1ZmM1NGE5Y2NlMzFmMTI4MGY4MzM5MTViYTE=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-04-03T08:46:03Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-04-03T08:46:03Z"}, "message": "Auto merge of #83549 - sjakobi:no-tidy-line-length-1, r=Mark-Simulacrum\n\ntidy: Add ignore-rules for the line length check\n\nThis is step 1 towards fixing https://github.com/rust-lang/rust/issues/77548.\n\nThis PR contains the `tidy` change from https://github.com/rust-lang/rust/pull/77675. The \"ignoring file length unnecessarily\" check is temporarily disabled to simplify landing the ignore-rules. This check will be re-enabled in a follow-up PR.", "tree": {"sha": "57d819935547f126002968fb60226f5e52dc12c5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/57d819935547f126002968fb60226f5e52dc12c5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ccd997592bf545fc54a9cce31f1280f833915ba1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ccd997592bf545fc54a9cce31f1280f833915ba1", "html_url": "https://github.com/rust-lang/rust/commit/ccd997592bf545fc54a9cce31f1280f833915ba1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ccd997592bf545fc54a9cce31f1280f833915ba1/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "836c31742687ba4e2f857b5b698e1e9e6b67619c", "url": "https://api.github.com/repos/rust-lang/rust/commits/836c31742687ba4e2f857b5b698e1e9e6b67619c", "html_url": "https://github.com/rust-lang/rust/commit/836c31742687ba4e2f857b5b698e1e9e6b67619c"}, {"sha": "c35a36f9b339af147bc24016543bfec50085ba05", "url": "https://api.github.com/repos/rust-lang/rust/commits/c35a36f9b339af147bc24016543bfec50085ba05", "html_url": "https://github.com/rust-lang/rust/commit/c35a36f9b339af147bc24016543bfec50085ba05"}], "stats": {"total": 38, "additions": 32, "deletions": 6}, "files": [{"sha": "a2a53c16b78760ad82ec8109317e96b11c8ab3d3", "filename": "src/tools/compiletest/src/runtest.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ccd997592bf545fc54a9cce31f1280f833915ba1/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ccd997592bf545fc54a9cce31f1280f833915ba1/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs?ref=ccd997592bf545fc54a9cce31f1280f833915ba1", "patch": "@@ -3650,6 +3650,8 @@ impl<'test> TestCx<'test> {\n \n         // Remove test annotations like `//~ ERROR text` from the output,\n         // since they duplicate actual errors and make the output hard to read.\n+        // This mirrors the regex in src/tools/tidy/src/style.rs, please update\n+        // both if either are changed.\n         normalized =\n             Regex::new(\"\\\\s*//(\\\\[.*\\\\])?~.*\").unwrap().replace_all(&normalized, \"\").into_owned();\n "}, {"sha": "e99dd45328040890d3ad42b2545c966c80aac267", "filename": "src/tools/tidy/src/style.rs", "status": "modified", "additions": 30, "deletions": 6, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/ccd997592bf545fc54a9cce31f1280f833915ba1/src%2Ftools%2Ftidy%2Fsrc%2Fstyle.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ccd997592bf545fc54a9cce31f1280f833915ba1/src%2Ftools%2Ftidy%2Fsrc%2Fstyle.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Fstyle.rs?ref=ccd997592bf545fc54a9cce31f1280f833915ba1", "patch": "@@ -16,6 +16,7 @@\n //! A number of these checks can be opted-out of with various directives of the form:\n //! `// ignore-tidy-CHECK-NAME`.\n \n+use regex::Regex;\n use std::path::Path;\n \n /// Error code markdown is restricted to 80 columns because they can be\n@@ -41,6 +42,19 @@ C++ code used llvm_unreachable, which triggers undefined behavior\n when executed when assertions are disabled.\n Use llvm::report_fatal_error for increased robustness.\";\n \n+const ANNOTATIONS_TO_IGNORE: &[&str] = &[\n+    \"// @!has\",\n+    \"// @has\",\n+    \"// @matches\",\n+    \"// CHECK\",\n+    \"// EMIT_MIR\",\n+    \"// compile-flags\",\n+    \"// error-pattern\",\n+    \"// gdb\",\n+    \"// lldb\",\n+    \"// normalize-stderr-test\",\n+];\n+\n /// Parser states for `line_is_url`.\n #[derive(Clone, Copy, PartialEq)]\n #[allow(non_camel_case_types)]\n@@ -92,12 +106,20 @@ fn line_is_url(is_error_code: bool, columns: usize, line: &str) -> bool {\n     state == EXP_END\n }\n \n+/// Returns `true` if `line` can be ignored. This is the case when it contains\n+/// an annotation that is explicitly ignored.\n+fn should_ignore(line: &str) -> bool {\n+    // Matches test annotations like `//~ ERROR text`.\n+    // This mirrors the regex in src/tools/compiletest/src/runtest.rs, please\n+    // update both if either are changed.\n+    let re = Regex::new(\"\\\\s*//(\\\\[.*\\\\])?~.*\").unwrap();\n+    re.is_match(line) || ANNOTATIONS_TO_IGNORE.iter().any(|a| line.contains(a))\n+}\n+\n /// Returns `true` if `line` is allowed to be longer than the normal limit.\n-/// Currently there is only one exception, for long URLs, but more\n-/// may be added in the future.\n fn long_line_is_ok(extension: &str, is_error_code: bool, max_columns: usize, line: &str) -> bool {\n     if extension != \"md\" || is_error_code {\n-        if line_is_url(is_error_code, max_columns, line) {\n+        if line_is_url(is_error_code, max_columns, line) || should_ignore(line) {\n             return true;\n         }\n     } else if extension == \"md\" {\n@@ -357,9 +379,11 @@ pub fn check(path: &Path, bad: &mut bool) {\n         if let Directive::Ignore(false) = skip_tab {\n             tidy_error!(bad, \"{}: ignoring tab characters unnecessarily\", file.display());\n         }\n-        if let Directive::Ignore(false) = skip_line_length {\n-            tidy_error!(bad, \"{}: ignoring line length unnecessarily\", file.display());\n-        }\n+        // FIXME: Temporarily disabled to simplify landing the ignore-rules for the line\n+        // length check (https://github.com/rust-lang/rust/issues/77548):\n+        //if let Directive::Ignore(false) = skip_line_length {\n+        //    tidy_error!(bad, \"{}: ignoring line length unnecessarily\", file.display());\n+        //}\n         if let Directive::Ignore(false) = skip_file_length {\n             tidy_error!(bad, \"{}: ignoring file length unnecessarily\", file.display());\n         }"}]}