{"sha": "b35559a2460e7f0b2b79a7029db0c5d4e0acdb44", "node_id": "MDY6Q29tbWl0NzI0NzEyOmIzNTU1OWEyNDYwZTdmMGIyYjc5YTcwMjlkYjBjNWQ0ZTBhY2RiNDQ=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-03-10T15:35:10Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-03-10T15:35:10Z"}, "message": "Merge #7959\n\n7959: Prefer names from outer DefMap over extern prelude r=jonas-schievink a=jonas-schievink\n\nFixes https://github.com/rust-analyzer/rust-analyzer/issues/7919\r\n\r\nJust one more special case, how bad could it be.\r\n\r\nbors r+\n\nCo-authored-by: Jonas Schievink <jonasschievink@gmail.com>", "tree": {"sha": "b0aab1d4c84036dfdc27da40e15c96828cd9e9fd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b0aab1d4c84036dfdc27da40e15c96828cd9e9fd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b35559a2460e7f0b2b79a7029db0c5d4e0acdb44", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgSOcuCRBK7hj4Ov3rIwAAdHIIAGzNCV31uxrXfTsuwdqhebsm\nRRJdwrcJm7ig6RbGf8kdvZHpNpNavbAti4EpxpBgPzd7Olo2ruThsOjIwIr6X7FK\ntxf0eETeJhKd/qFvA5tMGCr9/zG6yY05LvyYf51WSpH/UvP8ZIfzWF84BtiGBDtc\nZl5aVKm35a1ivUWljtJolB6k6aw4/12mKC+0I0fEvpeYjrBCRiyMHKC5IWT6QUL4\nTte67KAOGJlUrXo7DtPl9eDxEhiuP6oYMdLPsJNRagk6NCfTiwZwWsFTFheBjT94\nvAbLgQ7XkASnifWgJaFlbxxp6cSc8EZH2pPedPox03AB2NjXw+EznhYvmLBtGGc=\n=FD1m\n-----END PGP SIGNATURE-----\n", "payload": "tree b0aab1d4c84036dfdc27da40e15c96828cd9e9fd\nparent 83280ea5746451f4580e6c32ba8a82be972cb786\nparent c2622c922887368788674d1735a7705fc345a5b9\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1615390510 +0000\ncommitter GitHub <noreply@github.com> 1615390510 +0000\n\nMerge #7959\n\n7959: Prefer names from outer DefMap over extern prelude r=jonas-schievink a=jonas-schievink\n\nFixes https://github.com/rust-analyzer/rust-analyzer/issues/7919\r\n\r\nJust one more special case, how bad could it be.\r\n\r\nbors r+\n\nCo-authored-by: Jonas Schievink <jonasschievink@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b35559a2460e7f0b2b79a7029db0c5d4e0acdb44", "html_url": "https://github.com/rust-lang/rust/commit/b35559a2460e7f0b2b79a7029db0c5d4e0acdb44", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b35559a2460e7f0b2b79a7029db0c5d4e0acdb44/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "83280ea5746451f4580e6c32ba8a82be972cb786", "url": "https://api.github.com/repos/rust-lang/rust/commits/83280ea5746451f4580e6c32ba8a82be972cb786", "html_url": "https://github.com/rust-lang/rust/commit/83280ea5746451f4580e6c32ba8a82be972cb786"}, {"sha": "c2622c922887368788674d1735a7705fc345a5b9", "url": "https://api.github.com/repos/rust-lang/rust/commits/c2622c922887368788674d1735a7705fc345a5b9", "html_url": "https://github.com/rust-lang/rust/commit/c2622c922887368788674d1735a7705fc345a5b9"}], "stats": {"total": 45, "additions": 40, "deletions": 5}, "files": [{"sha": "db459b1ed8414d30c9ede5efc0dd1c4ce8639968", "filename": "crates/hir_def/src/nameres/path_resolution.rs", "status": "modified", "additions": 11, "deletions": 5, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/b35559a2460e7f0b2b79a7029db0c5d4e0acdb44/crates%2Fhir_def%2Fsrc%2Fnameres%2Fpath_resolution.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b35559a2460e7f0b2b79a7029db0c5d4e0acdb44/crates%2Fhir_def%2Fsrc%2Fnameres%2Fpath_resolution.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fnameres%2Fpath_resolution.rs?ref=b35559a2460e7f0b2b79a7029db0c5d4e0acdb44", "patch": "@@ -156,7 +156,7 @@ impl DefMap {\n         }\n     }\n \n-    pub(super) fn resolve_path_fp_with_macro_single(\n+    fn resolve_path_fp_with_macro_single(\n         &self,\n         db: &dyn DefDatabase,\n         mode: ResolveMode,\n@@ -384,10 +384,16 @@ impl DefMap {\n                 }\n             }\n         };\n-        let from_extern_prelude = self\n-            .extern_prelude\n-            .get(name)\n-            .map_or(PerNs::none(), |&it| PerNs::types(it, Visibility::Public));\n+        // Give precedence to names in outer `DefMap`s over the extern prelude; only check prelude\n+        // from the crate DefMap.\n+        let from_extern_prelude = match self.block {\n+            Some(_) => PerNs::none(),\n+            None => self\n+                .extern_prelude\n+                .get(name)\n+                .map_or(PerNs::none(), |&it| PerNs::types(it, Visibility::Public)),\n+        };\n+\n         let from_prelude = self.resolve_in_prelude(db, name);\n \n         from_legacy_macro.or(from_scope_or_builtin).or(from_extern_prelude).or(from_prelude)"}, {"sha": "86f937e1d3afd01d6909fead56883d561f9dbdc7", "filename": "crates/hir_ty/src/diagnostics.rs", "status": "modified", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/b35559a2460e7f0b2b79a7029db0c5d4e0acdb44/crates%2Fhir_ty%2Fsrc%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b35559a2460e7f0b2b79a7029db0c5d4e0acdb44/crates%2Fhir_ty%2Fsrc%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Fdiagnostics.rs?ref=b35559a2460e7f0b2b79a7029db0c5d4e0acdb44", "patch": "@@ -705,6 +705,35 @@ fn x(a: S) {\n         )\n     }\n \n+    #[test]\n+    fn import_extern_crate_clash_with_inner_item() {\n+        // This is more of a resolver test, but doesn't really work with the hir_def testsuite.\n+\n+        check_diagnostics(\n+            r#\"\n+//- /lib.rs crate:lib deps:jwt\n+mod permissions;\n+\n+use permissions::jwt;\n+\n+fn f() {\n+    fn inner() {}\n+    jwt::Claims {}; // should resolve to the local one with 0 fields, and not get a diagnostic\n+}\n+\n+//- /permissions.rs\n+pub mod jwt  {\n+    pub struct Claims {}\n+}\n+\n+//- /jwt/lib.rs crate:jwt\n+pub struct Claims {\n+    field: u8,\n+}\n+        \"#,\n+        );\n+    }\n+\n     #[test]\n     fn break_outside_of_loop() {\n         check_diagnostics("}]}