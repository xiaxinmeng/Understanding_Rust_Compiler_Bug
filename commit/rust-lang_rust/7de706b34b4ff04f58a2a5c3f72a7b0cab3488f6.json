{"sha": "7de706b34b4ff04f58a2a5c3f72a7b0cab3488f6", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdkZTcwNmIzNGI0ZmYwNGY1OGEyYTVjM2Y3MmE3YjBjYWIzNDg4ZjY=", "commit": {"author": {"name": "Yusuf Simonson", "email": "simonson@gmail.com", "date": "2018-04-29T23:20:39Z"}, "committer": {"name": "Yusuf Simonson", "email": "simonson@gmail.com", "date": "2018-04-29T23:20:39Z"}, "message": "Lint for multiple versions of dependencies", "tree": {"sha": "d15b3d3fc1fb29eca99293aa36a7d597a0b8b117", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d15b3d3fc1fb29eca99293aa36a7d597a0b8b117"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7de706b34b4ff04f58a2a5c3f72a7b0cab3488f6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7de706b34b4ff04f58a2a5c3f72a7b0cab3488f6", "html_url": "https://github.com/rust-lang/rust/commit/7de706b34b4ff04f58a2a5c3f72a7b0cab3488f6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7de706b34b4ff04f58a2a5c3f72a7b0cab3488f6/comments", "author": {"login": "ysimonson", "id": 127386, "node_id": "MDQ6VXNlcjEyNzM4Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/127386?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ysimonson", "html_url": "https://github.com/ysimonson", "followers_url": "https://api.github.com/users/ysimonson/followers", "following_url": "https://api.github.com/users/ysimonson/following{/other_user}", "gists_url": "https://api.github.com/users/ysimonson/gists{/gist_id}", "starred_url": "https://api.github.com/users/ysimonson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ysimonson/subscriptions", "organizations_url": "https://api.github.com/users/ysimonson/orgs", "repos_url": "https://api.github.com/users/ysimonson/repos", "events_url": "https://api.github.com/users/ysimonson/events{/privacy}", "received_events_url": "https://api.github.com/users/ysimonson/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ysimonson", "id": 127386, "node_id": "MDQ6VXNlcjEyNzM4Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/127386?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ysimonson", "html_url": "https://github.com/ysimonson", "followers_url": "https://api.github.com/users/ysimonson/followers", "following_url": "https://api.github.com/users/ysimonson/following{/other_user}", "gists_url": "https://api.github.com/users/ysimonson/gists{/gist_id}", "starred_url": "https://api.github.com/users/ysimonson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ysimonson/subscriptions", "organizations_url": "https://api.github.com/users/ysimonson/orgs", "repos_url": "https://api.github.com/users/ysimonson/repos", "events_url": "https://api.github.com/users/ysimonson/events{/privacy}", "received_events_url": "https://api.github.com/users/ysimonson/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1742229ebb7843a65c05ee495d8de5366fcc5567", "url": "https://api.github.com/repos/rust-lang/rust/commits/1742229ebb7843a65c05ee495d8de5366fcc5567", "html_url": "https://github.com/rust-lang/rust/commit/1742229ebb7843a65c05ee495d8de5366fcc5567"}], "stats": {"total": 86, "additions": 86, "deletions": 0}, "files": [{"sha": "50c2bd95b7f28bcc083d205bcbf1525c276af213", "filename": "README.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7de706b34b4ff04f58a2a5c3f72a7b0cab3488f6/README.md", "raw_url": "https://github.com/rust-lang/rust/raw/7de706b34b4ff04f58a2a5c3f72a7b0cab3488f6/README.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/README.md?ref=7de706b34b4ff04f58a2a5c3f72a7b0cab3488f6", "patch": "@@ -17,6 +17,7 @@ We have a bunch of lint categories to allow you to choose how much clippy is sup\n * `clippy_style` (code that should be written in a more idiomatic way)\n * `clippy_complexity` (code that does something simple but in a complex way)\n * `clippy_perf` (code that can be written in a faster way)\n+* `clippy_cargo` (checks against the cargo manifest)\n * **`clippy_correctness`** (code that is just outright wrong or very very useless)\n \n More to come, please [file an issue](https://github.com/rust-lang-nursery/rust-clippy/issues) if you have ideas!"}, {"sha": "e17aa75cdf560b33d4e2bb6dca8c7ef2a2914e38", "filename": "clippy_lints/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7de706b34b4ff04f58a2a5c3f72a7b0cab3488f6/clippy_lints%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/7de706b34b4ff04f58a2a5c3f72a7b0cab3488f6/clippy_lints%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2FCargo.toml?ref=7de706b34b4ff04f58a2a5c3f72a7b0cab3488f6", "patch": "@@ -16,6 +16,7 @@ license = \"MPL-2.0\"\n keywords = [\"clippy\", \"lint\", \"plugin\"]\n \n [dependencies]\n+cargo_metadata = \"0.5\"\n itertools = \"0.7\"\n lazy_static = \"1.0\"\n matches = \"0.1.2\""}, {"sha": "0a500f9ad6e5c70c4297a5b92d485fb939508f7f", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/7de706b34b4ff04f58a2a5c3f72a7b0cab3488f6/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7de706b34b4ff04f58a2a5c3f72a7b0cab3488f6/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=7de706b34b4ff04f58a2a5c3f72a7b0cab3488f6", "patch": "@@ -16,6 +16,7 @@\n #![feature(iterator_find_map)]\n \n \n+extern crate cargo_metadata;\n #[macro_use]\n extern crate rustc;\n extern crate rustc_typeck;\n@@ -81,6 +82,9 @@ macro_rules! declare_clippy_lint {\n     { pub $name:tt, restriction, $description:tt } => {\n         declare_lint! { pub $name, Allow, $description }\n     };\n+    { pub $name:tt, cargo, $description:tt } => {\n+        declare_lint! { pub $name, Allow, $description }\n+    };\n     { pub $name:tt, nursery, $description:tt } => {\n         declare_lint! { pub $name, Allow, $description }\n     };\n@@ -158,6 +162,7 @@ pub mod minmax;\n pub mod misc;\n pub mod misc_early;\n pub mod missing_doc;\n+pub mod multiple_crate_versions;\n pub mod mut_mut;\n pub mod mut_reference;\n pub mod mutex_atomic;\n@@ -412,6 +417,7 @@ pub fn register_plugins(reg: &mut rustc_plugin::Registry) {\n     reg.register_late_lint_pass(box question_mark::QuestionMarkPass);\n     reg.register_late_lint_pass(box suspicious_trait_impl::SuspiciousImpl);\n     reg.register_late_lint_pass(box redundant_field_names::RedundantFieldNames);\n+    reg.register_early_lint_pass(box multiple_crate_versions::Pass);\n     reg.register_late_lint_pass(box map_unit_fn::Pass);\n     reg.register_late_lint_pass(box infallible_destructuring_match::Pass);\n \n@@ -895,6 +901,10 @@ pub fn register_plugins(reg: &mut rustc_plugin::Registry) {\n         vec::USELESS_VEC,\n     ]);\n \n+    reg.register_lint_group(\"clippy_cargo\", vec![\n+        multiple_crate_versions::MULTIPLE_CRATE_VERSIONS,\n+    ]);\n+\n     reg.register_lint_group(\"clippy_nursery\", vec![\n         attrs::EMPTY_LINE_AFTER_OUTER_ATTR,\n         fallible_impl_from::FALLIBLE_IMPL_FROM,"}, {"sha": "d347270236dd2df77b52fc460925e63fa2914a12", "filename": "clippy_lints/src/multiple_crate_versions.rs", "status": "added", "additions": 72, "deletions": 0, "changes": 72, "blob_url": "https://github.com/rust-lang/rust/blob/7de706b34b4ff04f58a2a5c3f72a7b0cab3488f6/clippy_lints%2Fsrc%2Fmultiple_crate_versions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7de706b34b4ff04f58a2a5c3f72a7b0cab3488f6/clippy_lints%2Fsrc%2Fmultiple_crate_versions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmultiple_crate_versions.rs?ref=7de706b34b4ff04f58a2a5c3f72a7b0cab3488f6", "patch": "@@ -0,0 +1,72 @@\n+//! lint on multiple versions of a crate being used\n+\n+use rustc::lint::*;\n+use syntax::ast::*;\n+\n+use cargo_metadata;\n+use itertools::Itertools;\n+\n+/// **What it does:** Checks to see if multiple versions of a crate are being\n+/// used.\n+///\n+/// **Why is this bad?** This bloats the size of targets, and can lead to\n+/// confusing error messages when structs or traits are used interchangeably\n+/// between different versions of a crate.\n+///\n+/// **Known problems:** Because this can be caused purely by the dependencies\n+/// themselves, it's not always possible to fix this issue.\n+///\n+/// **Example:**\n+/// ```toml\n+/// # This will pull in both winapi v0.3.4 and v0.2.8, triggering a warning.\n+/// [dependencies]\n+/// ctrlc = \"3.1.0\"\n+/// ansi_term = \"0.11.0\"\n+/// ```\n+declare_clippy_lint! {\n+    pub MULTIPLE_CRATE_VERSIONS,\n+    cargo,\n+    \"multiple versions of the same crate being used\"\n+}\n+\n+pub struct Pass;\n+\n+impl LintPass for Pass {\n+    fn get_lints(&self) -> LintArray {\n+        lint_array!(MULTIPLE_CRATE_VERSIONS)\n+    }\n+}\n+\n+impl EarlyLintPass for Pass {\n+    fn check_crate(&mut self, cx: &EarlyContext, krate: &Crate) {\n+        let metadata = match cargo_metadata::metadata_deps(None, true) {\n+            Ok(metadata) => metadata,\n+            Err(_) => {\n+                cx.span_lint(\n+                    MULTIPLE_CRATE_VERSIONS,\n+                    krate.span,\n+                    \"could not read cargo metadata\"\n+                );\n+\n+                return;\n+            }\n+        };\n+\n+        let mut packages = metadata.packages;\n+        packages.sort_by(|a, b| a.name.cmp(&b.name));\n+\n+        for (name, group) in &packages.into_iter().group_by(|p| p.name.clone()) {\n+            let group: Vec<cargo_metadata::Package> = group.collect();\n+\n+            if group.len() > 1 {\n+                let versions = group.into_iter().map(|p| p.version).join(\", \");\n+\n+                cx.span_lint(\n+                    MULTIPLE_CRATE_VERSIONS,\n+                    krate.span,\n+                    &format!(\"multiple versions for dependency `{}`: {}\", name, versions),\n+                );\n+            }\n+        }\n+    }\n+}"}, {"sha": "4323ef5c3e76b7e0a246f575c4b02abadd1a0d1f", "filename": "util/lintlib.py", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7de706b34b4ff04f58a2a5c3f72a7b0cab3488f6/util%2Flintlib.py", "raw_url": "https://github.com/rust-lang/rust/raw/7de706b34b4ff04f58a2a5c3f72a7b0cab3488f6/util%2Flintlib.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/util%2Flintlib.py?ref=7de706b34b4ff04f58a2a5c3f72a7b0cab3488f6", "patch": "@@ -24,6 +24,7 @@\n     \"restriction\": 'Allow',\n     \"pedantic\": 'Allow',\n     \"nursery\": 'Allow',\n+    \"cargo\": 'Allow',\n }\n \n "}, {"sha": "692599886a926ecbee05fc72a6f76605fb3b5a71", "filename": "util/update_lints.py", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7de706b34b4ff04f58a2a5c3f72a7b0cab3488f6/util%2Fupdate_lints.py", "raw_url": "https://github.com/rust-lang/rust/raw/7de706b34b4ff04f58a2a5c3f72a7b0cab3488f6/util%2Fupdate_lints.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/util%2Fupdate_lints.py?ref=7de706b34b4ff04f58a2a5c3f72a7b0cab3488f6", "patch": "@@ -129,6 +129,7 @@ def main(print_only=False, check=False):\n         \"perf\": [],\n         \"restriction\": [],\n         \"pedantic\": [],\n+        \"cargo\": [],\n         \"nursery\": [],\n     }\n "}]}