{"sha": "9fa46fe15367a8154f38371d0d913fa2f97f6416", "node_id": "MDY6Q29tbWl0NzI0NzEyOjlmYTQ2ZmUxNTM2N2E4MTU0ZjM4MzcxZDBkOTEzZmEyZjk3ZjY0MTY=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2020-01-27T22:26:37Z"}, "committer": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2020-02-02T12:20:58Z"}, "message": "Teach dropck about resume arguments", "tree": {"sha": "9d56ef3eb12ba3c4ce549a0e37b9b294417755e9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9d56ef3eb12ba3c4ce549a0e37b9b294417755e9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9fa46fe15367a8154f38371d0d913fa2f97f6416", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9fa46fe15367a8154f38371d0d913fa2f97f6416", "html_url": "https://github.com/rust-lang/rust/commit/9fa46fe15367a8154f38371d0d913fa2f97f6416", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9fa46fe15367a8154f38371d0d913fa2f97f6416/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "aae0f543cff16afe27384171e83de91887bc9f4d", "url": "https://api.github.com/repos/rust-lang/rust/commits/aae0f543cff16afe27384171e83de91887bc9f4d", "html_url": "https://github.com/rust-lang/rust/commit/aae0f543cff16afe27384171e83de91887bc9f4d"}], "stats": {"total": 60, "additions": 55, "deletions": 5}, "files": [{"sha": "346d2a931d10b4b6ed068639339a19298ae99a10", "filename": "src/librustc_traits/dropck_outlives.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/9fa46fe15367a8154f38371d0d913fa2f97f6416/src%2Flibrustc_traits%2Fdropck_outlives.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9fa46fe15367a8154f38371d0d913fa2f97f6416/src%2Flibrustc_traits%2Fdropck_outlives.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_traits%2Fdropck_outlives.rs?ref=9fa46fe15367a8154f38371d0d913fa2f97f6416", "patch": "@@ -227,15 +227,16 @@ fn dtorck_constraint_for_ty<'tcx>(\n             // In particular, skipping over `_interior` is safe\n             // because any side-effects from dropping `_interior` can\n             // only take place through references with lifetimes\n-            // derived from lifetimes attached to the upvars, and we\n-            // *do* incorporate the upvars here.\n+            // derived from lifetimes attached to the upvars and resume\n+            // argument, and we *do* incorporate those here.\n \n             constraints.outlives.extend(\n                 substs\n                     .as_generator()\n                     .upvar_tys(def_id, tcx)\n                     .map(|t| -> ty::subst::GenericArg<'tcx> { t.into() }),\n             );\n+            constraints.outlives.push(substs.as_generator().resume_ty(def_id, tcx).into());\n         }\n \n         ty::Adt(def, substs) => {"}, {"sha": "4c18077f33573e79aeb48647ddd7bb55f6db4580", "filename": "src/test/ui/generator/dropck-resume.rs", "status": "added", "additions": 33, "deletions": 0, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/9fa46fe15367a8154f38371d0d913fa2f97f6416/src%2Ftest%2Fui%2Fgenerator%2Fdropck-resume.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9fa46fe15367a8154f38371d0d913fa2f97f6416/src%2Ftest%2Fui%2Fgenerator%2Fdropck-resume.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fgenerator%2Fdropck-resume.rs?ref=9fa46fe15367a8154f38371d0d913fa2f97f6416", "patch": "@@ -0,0 +1,33 @@\n+#![feature(generators, generator_trait)]\n+\n+use std::ops::{Generator, GeneratorState};\n+use std::pin::Pin;\n+\n+struct SetToNone<'a: 'b, 'b>(&'b mut Option<&'a i32>);\n+\n+impl<'a, 'b> Drop for SetToNone<'a, 'b> {\n+    fn drop(&mut self) {\n+        *self.0 = None;\n+    }\n+}\n+\n+fn drop_using_generator() -> i32 {\n+    let mut y = Some(&0);\n+    let z = &mut y;\n+    let r;\n+    {\n+        let mut g = move |r| {\n+            let _s = SetToNone(r);\n+            yield;\n+        };\n+        let mut g = Pin::new(&mut g);\n+        g.as_mut().resume(z);\n+        r = y.as_ref().unwrap();\n+        //~^ ERROR cannot borrow `y` as immutable because it is also borrowed as mutable\n+    }\n+    **r\n+}\n+\n+fn main() {\n+    println!(\"{}\", drop_using_generator());\n+}"}, {"sha": "ecf92e7e3ae79c179026abd44406f8d90e66706f", "filename": "src/test/ui/generator/dropck-resume.stderr", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/9fa46fe15367a8154f38371d0d913fa2f97f6416/src%2Ftest%2Fui%2Fgenerator%2Fdropck-resume.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/9fa46fe15367a8154f38371d0d913fa2f97f6416/src%2Ftest%2Fui%2Fgenerator%2Fdropck-resume.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fgenerator%2Fdropck-resume.stderr?ref=9fa46fe15367a8154f38371d0d913fa2f97f6416", "patch": "@@ -0,0 +1,15 @@\n+error[E0502]: cannot borrow `y` as immutable because it is also borrowed as mutable\n+  --> $DIR/dropck-resume.rs:25:13\n+   |\n+LL |     let z = &mut y;\n+   |             ------ mutable borrow occurs here\n+...\n+LL |         r = y.as_ref().unwrap();\n+   |             ^ immutable borrow occurs here\n+LL |\n+LL |     }\n+   |     - mutable borrow might be used here, when `g` is dropped and runs the destructor for generator\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0502`."}, {"sha": "bc715c7030eb397e617376c4bb455e74f945d54f", "filename": "src/test/ui/generator/retain-resume-ref.stderr", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/9fa46fe15367a8154f38371d0d913fa2f97f6416/src%2Ftest%2Fui%2Fgenerator%2Fretain-resume-ref.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/9fa46fe15367a8154f38371d0d913fa2f97f6416/src%2Ftest%2Fui%2Fgenerator%2Fretain-resume-ref.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fgenerator%2Fretain-resume-ref.stderr?ref=9fa46fe15367a8154f38371d0d913fa2f97f6416", "patch": "@@ -4,9 +4,10 @@ error[E0499]: cannot borrow `thing` as mutable more than once at a time\n LL |     gen.as_mut().resume(&mut thing);\n    |                         ---------- first mutable borrow occurs here\n LL |     gen.as_mut().resume(&mut thing);\n-   |                  ------ ^^^^^^^^^^ second mutable borrow occurs here\n-   |                  |\n-   |                  first borrow later used by call\n+   |                         ^^^^^^^^^^ second mutable borrow occurs here\n+LL |\n+LL | }\n+   | - first borrow might be used here, when `gen` is dropped and runs the destructor for generator\n \n error: aborting due to previous error\n "}]}