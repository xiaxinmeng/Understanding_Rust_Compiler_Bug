{"sha": "a701ff981d8768e2b81a053bf9189ff67a2bb7ea", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE3MDFmZjk4MWQ4NzY4ZTJiODFhMDUzYmY5MTg5ZmY2N2EyYmI3ZWE=", "commit": {"author": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2021-01-20T01:51:48Z"}, "committer": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2021-01-22T05:41:46Z"}, "message": "Suggest `'a` when given `a` only when appropriate\n\nWhen encountering a name `a` that isn't resolved, but a label `'a` is\nfound in the current ribs, only suggest `'a` if this name is the value\nexpression of a `break` statement.\n\nSolve FIXME.", "tree": {"sha": "def4272e3fea867fd2caa9981ba19c6aa6ce485c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/def4272e3fea867fd2caa9981ba19c6aa6ce485c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a701ff981d8768e2b81a053bf9189ff67a2bb7ea", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a701ff981d8768e2b81a053bf9189ff67a2bb7ea", "html_url": "https://github.com/rust-lang/rust/commit/a701ff981d8768e2b81a053bf9189ff67a2bb7ea", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a701ff981d8768e2b81a053bf9189ff67a2bb7ea/comments", "author": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "committer": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "707ce2b798ad7bb6c1e0fce0da542d9caef07b56", "url": "https://api.github.com/repos/rust-lang/rust/commits/707ce2b798ad7bb6c1e0fce0da542d9caef07b56", "html_url": "https://github.com/rust-lang/rust/commit/707ce2b798ad7bb6c1e0fce0da542d9caef07b56"}], "stats": {"total": 76, "additions": 46, "deletions": 30}, "files": [{"sha": "a3a630e14906f7e29c5f9b4bc2402eaa00389883", "filename": "compiler/rustc_resolve/src/late.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/a701ff981d8768e2b81a053bf9189ff67a2bb7ea/compiler%2Frustc_resolve%2Fsrc%2Flate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a701ff981d8768e2b81a053bf9189ff67a2bb7ea/compiler%2Frustc_resolve%2Fsrc%2Flate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Flate.rs?ref=a701ff981d8768e2b81a053bf9189ff67a2bb7ea", "patch": "@@ -2266,6 +2266,12 @@ impl<'a: 'ast, 'b, 'ast> LateResolutionVisitor<'a, 'b, 'ast> {\n                 visit::walk_expr(self, expr);\n             }\n \n+            ExprKind::Break(None, Some(ref e)) => {\n+                // We use this instead of `visit::walk_expr` to keep the parent expr around for\n+                // better\n+                self.resolve_expr(e, Some(&expr));\n+            }\n+\n             ExprKind::Let(ref pat, ref scrutinee) => {\n                 self.visit_expr(scrutinee);\n                 self.resolve_pattern_top(pat, PatternSource::Let);"}, {"sha": "f8f81c9128772bb912d12b39d8d6b73e229b9ded", "filename": "compiler/rustc_resolve/src/late/diagnostics.rs", "status": "modified", "additions": 13, "deletions": 9, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/a701ff981d8768e2b81a053bf9189ff67a2bb7ea/compiler%2Frustc_resolve%2Fsrc%2Flate%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a701ff981d8768e2b81a053bf9189ff67a2bb7ea/compiler%2Frustc_resolve%2Fsrc%2Flate%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Flate%2Fdiagnostics.rs?ref=a701ff981d8768e2b81a053bf9189ff67a2bb7ea", "patch": "@@ -547,15 +547,19 @@ impl<'a: 'ast, 'ast> LateResolutionVisitor<'a, '_, 'ast> {\n                 for label_rib in &self.label_ribs {\n                     for (label_ident, _) in &label_rib.bindings {\n                         if format!(\"'{}\", ident) == label_ident.to_string() {\n-                            let msg = \"a label with a similar name exists\";\n-                            // FIXME: consider only emitting this suggestion if a label would be valid here\n-                            // which is pretty much only the case for `break` expressions.\n-                            err.span_suggestion(\n-                                span,\n-                                &msg,\n-                                label_ident.name.to_string(),\n-                                Applicability::MaybeIncorrect,\n-                            );\n+                            err.span_label(label_ident.span, \"a label with a similar name exists\");\n+                            if let PathSource::Expr(Some(Expr {\n+                                kind: ExprKind::Break(None, Some(_)),\n+                                ..\n+                            })) = source\n+                            {\n+                                err.span_suggestion(\n+                                    span,\n+                                    \"use the similarly named label\",\n+                                    label_ident.name.to_string(),\n+                                    Applicability::MaybeIncorrect,\n+                                );\n+                            }\n                         }\n                     }\n                 }"}, {"sha": "7cfb6e8147dd9d9c7d8f4c203c8e6f64ec9affe9", "filename": "src/test/ui/label/label_misspelled.stderr", "status": "modified", "additions": 24, "deletions": 20, "changes": 44, "blob_url": "https://github.com/rust-lang/rust/blob/a701ff981d8768e2b81a053bf9189ff67a2bb7ea/src%2Ftest%2Fui%2Flabel%2Flabel_misspelled.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/a701ff981d8768e2b81a053bf9189ff67a2bb7ea/src%2Ftest%2Fui%2Flabel%2Flabel_misspelled.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flabel%2Flabel_misspelled.stderr?ref=a701ff981d8768e2b81a053bf9189ff67a2bb7ea", "patch": "@@ -1,74 +1,78 @@\n error[E0425]: cannot find value `LOOP` in this scope\n   --> $DIR/label_misspelled.rs:3:9\n    |\n+LL |     'LOOP: loop {\n+   |     ----- a label with a similar name exists\n LL |         LOOP;\n-   |         ^^^^\n-   |         |\n-   |         not found in this scope\n-   |         help: a label with a similar name exists: `'LOOP`\n+   |         ^^^^ not found in this scope\n \n error[E0425]: cannot find value `while_loop` in this scope\n   --> $DIR/label_misspelled.rs:7:9\n    |\n+LL |     'while_loop: while true {\n+   |     ----------- a label with a similar name exists\n LL |         while_loop;\n-   |         ^^^^^^^^^^\n-   |         |\n-   |         not found in this scope\n-   |         help: a label with a similar name exists: `'while_loop`\n+   |         ^^^^^^^^^^ not found in this scope\n \n error[E0425]: cannot find value `while_let` in this scope\n   --> $DIR/label_misspelled.rs:11:9\n    |\n+LL |     'while_let: while let Some(_) = Some(()) {\n+   |     ---------- a label with a similar name exists\n LL |         while_let;\n-   |         ^^^^^^^^^\n-   |         |\n-   |         not found in this scope\n-   |         help: a label with a similar name exists: `'while_let`\n+   |         ^^^^^^^^^ not found in this scope\n \n error[E0425]: cannot find value `for_loop` in this scope\n   --> $DIR/label_misspelled.rs:15:9\n    |\n+LL |     'for_loop: for _ in 0..3 {\n+   |     --------- a label with a similar name exists\n LL |         for_loop;\n-   |         ^^^^^^^^\n-   |         |\n-   |         not found in this scope\n-   |         help: a label with a similar name exists: `'for_loop`\n+   |         ^^^^^^^^ not found in this scope\n \n error[E0425]: cannot find value `LOOP` in this scope\n   --> $DIR/label_misspelled.rs:22:15\n    |\n+LL |     'LOOP: loop {\n+   |     ----- a label with a similar name exists\n LL |         break LOOP;\n    |               ^^^^\n    |               |\n    |               not found in this scope\n-   |               help: a label with a similar name exists: `'LOOP`\n+   |               help: use the similarly named label: `'LOOP`\n \n error[E0425]: cannot find value `while_loop` in this scope\n   --> $DIR/label_misspelled.rs:26:15\n    |\n+LL |     'while_loop: while true {\n+   |     ----------- a label with a similar name exists\n LL |         break while_loop;\n    |               ^^^^^^^^^^\n    |               |\n    |               not found in this scope\n-   |               help: a label with a similar name exists: `'while_loop`\n+   |               help: use the similarly named label: `'while_loop`\n \n error[E0425]: cannot find value `while_let` in this scope\n   --> $DIR/label_misspelled.rs:31:15\n    |\n+LL |     'while_let: while let Some(_) = Some(()) {\n+   |     ---------- a label with a similar name exists\n LL |         break while_let;\n    |               ^^^^^^^^^\n    |               |\n    |               not found in this scope\n-   |               help: a label with a similar name exists: `'while_let`\n+   |               help: use the similarly named label: `'while_let`\n \n error[E0425]: cannot find value `for_loop` in this scope\n   --> $DIR/label_misspelled.rs:36:15\n    |\n+LL |     'for_loop: for _ in 0..3 {\n+   |     --------- a label with a similar name exists\n LL |         break for_loop;\n    |               ^^^^^^^^\n    |               |\n    |               not found in this scope\n-   |               help: a label with a similar name exists: `'for_loop`\n+   |               help: use the similarly named label: `'for_loop`\n \n warning: denote infinite loops with `loop { ... }`\n   --> $DIR/label_misspelled.rs:6:5"}, {"sha": "27104118a63a4a2eddad44e0b35a1be3da5fe212", "filename": "src/test/ui/loops/loop-break-value.stderr", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/a701ff981d8768e2b81a053bf9189ff67a2bb7ea/src%2Ftest%2Fui%2Floops%2Floop-break-value.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/a701ff981d8768e2b81a053bf9189ff67a2bb7ea/src%2Ftest%2Fui%2Floops%2Floop-break-value.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Floops%2Floop-break-value.stderr?ref=a701ff981d8768e2b81a053bf9189ff67a2bb7ea", "patch": "@@ -1,11 +1,13 @@\n error[E0425]: cannot find value `LOOP` in this scope\n   --> $DIR/loop-break-value.rs:95:15\n    |\n+LL |     'LOOP: for _ in 0 .. 9 {\n+   |     ----- a label with a similar name exists\n LL |         break LOOP;\n    |               ^^^^\n    |               |\n    |               not found in this scope\n-   |               help: a label with a similar name exists: `'LOOP`\n+   |               help: use the similarly named label: `'LOOP`\n \n warning: denote infinite loops with `loop { ... }`\n   --> $DIR/loop-break-value.rs:26:5"}]}