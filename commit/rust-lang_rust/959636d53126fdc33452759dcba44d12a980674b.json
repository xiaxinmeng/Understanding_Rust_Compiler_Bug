{"sha": "959636d53126fdc33452759dcba44d12a980674b", "node_id": "C_kwDOAAsO6NoAKDk1OTYzNmQ1MzEyNmZkYzMzNDUyNzU5ZGNiYTQ0ZDEyYTk4MDY3NGI", "commit": {"author": {"name": "Miguel Guarniz", "email": "mi9uel9@gmail.com", "date": "2022-05-12T15:34:37Z"}, "committer": {"name": "Miguel Guarniz", "email": "mi9uel9@gmail.com", "date": "2022-05-14T15:01:33Z"}, "message": "avoid fetching HIR when handling Impl assoc items\n\nSigned-off-by: Miguel Guarniz <mi9uel9@gmail.com>", "tree": {"sha": "518e158a31dc32464fcfa2deb38ab0aed6b954fa", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/518e158a31dc32464fcfa2deb38ab0aed6b954fa"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/959636d53126fdc33452759dcba44d12a980674b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/959636d53126fdc33452759dcba44d12a980674b", "html_url": "https://github.com/rust-lang/rust/commit/959636d53126fdc33452759dcba44d12a980674b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/959636d53126fdc33452759dcba44d12a980674b/comments", "author": {"login": "kckeiks", "id": 24687641, "node_id": "MDQ6VXNlcjI0Njg3NjQx", "avatar_url": "https://avatars.githubusercontent.com/u/24687641?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kckeiks", "html_url": "https://github.com/kckeiks", "followers_url": "https://api.github.com/users/kckeiks/followers", "following_url": "https://api.github.com/users/kckeiks/following{/other_user}", "gists_url": "https://api.github.com/users/kckeiks/gists{/gist_id}", "starred_url": "https://api.github.com/users/kckeiks/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kckeiks/subscriptions", "organizations_url": "https://api.github.com/users/kckeiks/orgs", "repos_url": "https://api.github.com/users/kckeiks/repos", "events_url": "https://api.github.com/users/kckeiks/events{/privacy}", "received_events_url": "https://api.github.com/users/kckeiks/received_events", "type": "User", "site_admin": false}, "committer": {"login": "kckeiks", "id": 24687641, "node_id": "MDQ6VXNlcjI0Njg3NjQx", "avatar_url": "https://avatars.githubusercontent.com/u/24687641?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kckeiks", "html_url": "https://github.com/kckeiks", "followers_url": "https://api.github.com/users/kckeiks/followers", "following_url": "https://api.github.com/users/kckeiks/following{/other_user}", "gists_url": "https://api.github.com/users/kckeiks/gists{/gist_id}", "starred_url": "https://api.github.com/users/kckeiks/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kckeiks/subscriptions", "organizations_url": "https://api.github.com/users/kckeiks/orgs", "repos_url": "https://api.github.com/users/kckeiks/repos", "events_url": "https://api.github.com/users/kckeiks/events{/privacy}", "received_events_url": "https://api.github.com/users/kckeiks/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f1c256d1687662a8ca305976ba46e39d12199ae6", "url": "https://api.github.com/repos/rust-lang/rust/commits/f1c256d1687662a8ca305976ba46e39d12199ae6", "html_url": "https://github.com/rust-lang/rust/commit/f1c256d1687662a8ca305976ba46e39d12199ae6"}], "stats": {"total": 30, "additions": 18, "deletions": 12}, "files": [{"sha": "e78d9a59982842b92879b36d5bc9928dd901970c", "filename": "compiler/rustc_passes/src/dead.rs", "status": "modified", "additions": 18, "deletions": 12, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/959636d53126fdc33452759dcba44d12a980674b/compiler%2Frustc_passes%2Fsrc%2Fdead.rs", "raw_url": "https://github.com/rust-lang/rust/raw/959636d53126fdc33452759dcba44d12a980674b/compiler%2Frustc_passes%2Fsrc%2Fdead.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fdead.rs?ref=959636d53126fdc33452759dcba44d12a980674b", "patch": "@@ -511,18 +511,24 @@ fn check_item<'tcx>(\n             }\n         }\n         DefKind::Impl => {\n-            let item = tcx.hir().item(id);\n-            if let hir::ItemKind::Impl(hir::Impl { ref of_trait, items, .. }) = item.kind {\n-                if of_trait.is_some() {\n-                    worklist.push(item.def_id);\n-                }\n-                for impl_item_ref in *items {\n-                    let impl_item = tcx.hir().impl_item(impl_item_ref.id);\n-                    if of_trait.is_some()\n-                        || has_allow_dead_code_or_lang_attr(tcx, impl_item.hir_id())\n-                    {\n-                        worklist.push(impl_item_ref.id.def_id);\n-                    }\n+            let of_trait = tcx.impl_trait_ref(id.def_id);\n+\n+            if of_trait.is_some() {\n+                worklist.push(id.def_id);\n+            }\n+\n+            // get DefIds from another query\n+            let local_def_ids = tcx\n+                .associated_item_def_ids(id.def_id)\n+                .iter()\n+                .filter_map(|def_id| def_id.as_local());\n+\n+            // And we access the Map here to get HirId from LocalDefId\n+            for id in local_def_ids {\n+                if of_trait.is_some()\n+                    || has_allow_dead_code_or_lang_attr(tcx, tcx.hir().local_def_id_to_hir_id(id))\n+                {\n+                    worklist.push(id);\n                 }\n             }\n         }"}]}