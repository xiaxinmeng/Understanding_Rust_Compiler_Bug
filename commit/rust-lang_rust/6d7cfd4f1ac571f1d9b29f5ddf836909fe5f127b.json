{"sha": "6d7cfd4f1ac571f1d9b29f5ddf836909fe5f127b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZkN2NmZDRmMWFjNTcxZjFkOWIyOWY1ZGRmODM2OTA5ZmU1ZjEyN2I=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2018-04-10T19:52:47Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2018-04-10T20:05:13Z"}, "message": "proc_macro: Avoid cached TokenStream more often\n\nThis commit adds even more pessimization to use the cached `TokenStream` inside\nof an AST node. As a reminder the `proc_macro` API requires taking an arbitrary\nAST node and transforming it back into a `TokenStream` to hand off to a\nprocedural macro. Such functionality isn't actually implemented in rustc today,\nso the way `proc_macro` works today is that it stringifies an AST node and then\nreparses for a list of tokens.\n\nThis strategy unfortunately loses all span information, so we try to avoid it\nwhenever possible. Implemented in #43230 some AST nodes have a `TokenStream`\ncache representing the tokens they were originally parsed from. This\n`TokenStream` cache, however, has turned out to not always reflect the current\nstate of the item when it's being tokenized. For example `#[cfg]` processing or\nmacro expansion could modify the state of an item. Consequently we've seen a\nnumber of bugs (#48644 and #49846) related to using this stale cache.\n\nThis commit tweaks the usage of the cached `TokenStream` to compare it to our\nlossy stringification of the token stream. If the tokens that make up the cache\nand the stringified token stream are the same then we return the cached version\n(which has correct span information). If they differ, however, then we will\nreturn the stringified version as the cache has been invalidated and we just\nhaven't figured that out.\n\nCloses #48644\nCloses #49846", "tree": {"sha": "0b3c8f6c7ec31e29b4cd074187f0b893951cc48f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0b3c8f6c7ec31e29b4cd074187f0b893951cc48f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6d7cfd4f1ac571f1d9b29f5ddf836909fe5f127b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6d7cfd4f1ac571f1d9b29f5ddf836909fe5f127b", "html_url": "https://github.com/rust-lang/rust/commit/6d7cfd4f1ac571f1d9b29f5ddf836909fe5f127b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6d7cfd4f1ac571f1d9b29f5ddf836909fe5f127b/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4b9b70c394e7f341b4016fce4cbf763d404b26f9", "url": "https://api.github.com/repos/rust-lang/rust/commits/4b9b70c394e7f341b4016fce4cbf763d404b26f9", "html_url": "https://github.com/rust-lang/rust/commit/4b9b70c394e7f341b4016fce4cbf763d404b26f9"}], "stats": {"total": 133, "additions": 121, "deletions": 12}, "files": [{"sha": "09cc700de5f2908e4951bf371db3cafaa9d78693", "filename": "src/libsyntax/parse/token.rs", "status": "modified", "additions": 22, "deletions": 9, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/6d7cfd4f1ac571f1d9b29f5ddf836909fe5f127b/src%2Flibsyntax%2Fparse%2Ftoken.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6d7cfd4f1ac571f1d9b29f5ddf836909fe5f127b/src%2Flibsyntax%2Fparse%2Ftoken.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fparse%2Ftoken.rs?ref=6d7cfd4f1ac571f1d9b29f5ddf836909fe5f127b", "patch": "@@ -519,8 +519,17 @@ impl Token {\n         // all span information.\n         //\n         // As a result, some AST nodes are annotated with the token\n-        // stream they came from. Attempt to extract these lossless\n-        // token streams before we fall back to the stringification.\n+        // stream they came from. Here we attempt to extract these\n+        // lossless token streams before we fall back to the\n+        // stringification.\n+        //\n+        // During early phases of the compiler, though, the AST could\n+        // get modified directly (e.g. attributes added or removed) and\n+        // the internal cache of tokens my not be invalidated or\n+        // updated. Consequently if the \"lossless\" token stream\n+        // disagrees with our actuall stringification (which has\n+        // historically been much more battle-tested) then we go with\n+        // the lossy stream anyway (losing span information).\n         let mut tokens = None;\n \n         match nt.0 {\n@@ -547,13 +556,17 @@ impl Token {\n             _ => {}\n         }\n \n-        tokens.unwrap_or_else(|| {\n-            nt.1.force(|| {\n-                // FIXME(jseyfried): Avoid this pretty-print + reparse hack\n-                let source = pprust::token_to_string(self);\n-                parse_stream_from_source_str(FileName::MacroExpansion, source, sess, Some(span))\n-            })\n-        })\n+        let tokens_for_real = nt.1.force(|| {\n+            // FIXME(#43081): Avoid this pretty-print + reparse hack\n+            let source = pprust::token_to_string(self);\n+            parse_stream_from_source_str(FileName::MacroExpansion, source, sess, Some(span))\n+        });\n+        if let Some(tokens) = tokens {\n+            if tokens.eq_unspanned(&tokens_for_real) {\n+                return tokens\n+            }\n+        }\n+        return tokens_for_real\n     }\n }\n "}, {"sha": "6ac04b3cdf6c437bd4dcd67b914ef7b91e7298c8", "filename": "src/libsyntax/tokenstream.rs", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/6d7cfd4f1ac571f1d9b29f5ddf836909fe5f127b/src%2Flibsyntax%2Ftokenstream.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6d7cfd4f1ac571f1d9b29f5ddf836909fe5f127b/src%2Flibsyntax%2Ftokenstream.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Ftokenstream.rs?ref=6d7cfd4f1ac571f1d9b29f5ddf836909fe5f127b", "patch": "@@ -118,7 +118,7 @@ impl TokenTree {\n             (&TokenTree::Token(_, ref tk), &TokenTree::Token(_, ref tk2)) => tk == tk2,\n             (&TokenTree::Delimited(_, ref dl), &TokenTree::Delimited(_, ref dl2)) => {\n                 dl.delim == dl2.delim &&\n-                dl.stream().trees().zip(dl2.stream().trees()).all(|(tt, tt2)| tt.eq_unspanned(&tt2))\n+                dl.stream().eq_unspanned(&dl2.stream())\n             }\n             (_, _) => false,\n         }\n@@ -240,12 +240,14 @@ impl TokenStream {\n \n     /// Compares two TokenStreams, checking equality without regarding span information.\n     pub fn eq_unspanned(&self, other: &TokenStream) -> bool {\n-        for (t1, t2) in self.trees().zip(other.trees()) {\n+        let mut t1 = self.trees();\n+        let mut t2 = other.trees();\n+        for (t1, t2) in t1.by_ref().zip(t2.by_ref()) {\n             if !t1.eq_unspanned(&t2) {\n                 return false;\n             }\n         }\n-        true\n+        t1.next().is_none() && t2.next().is_none()\n     }\n \n     /// Precondition: `self` consists of a single token tree."}, {"sha": "6f8c649c6b56cfe22a56ea6baef5434953b4c95b", "filename": "src/test/run-pass-fulldeps/proc-macro/auxiliary/modify-ast.rs", "status": "added", "additions": 57, "deletions": 0, "changes": 57, "blob_url": "https://github.com/rust-lang/rust/blob/6d7cfd4f1ac571f1d9b29f5ddf836909fe5f127b/src%2Ftest%2Frun-pass-fulldeps%2Fproc-macro%2Fauxiliary%2Fmodify-ast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6d7cfd4f1ac571f1d9b29f5ddf836909fe5f127b/src%2Ftest%2Frun-pass-fulldeps%2Fproc-macro%2Fauxiliary%2Fmodify-ast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass-fulldeps%2Fproc-macro%2Fauxiliary%2Fmodify-ast.rs?ref=6d7cfd4f1ac571f1d9b29f5ddf836909fe5f127b", "patch": "@@ -0,0 +1,57 @@\n+// Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// no-prefer-dynamic\n+\n+#![crate_type = \"proc-macro\"]\n+#![feature(proc_macro)]\n+\n+extern crate proc_macro;\n+\n+use proc_macro::*;\n+\n+#[proc_macro_attribute]\n+pub fn assert1(_a: TokenStream, b: TokenStream) -> TokenStream {\n+    assert_eq(b.clone(), \"pub fn foo() {}\".parse().unwrap());\n+    b\n+}\n+\n+#[proc_macro_derive(Foo, attributes(foo))]\n+pub fn assert2(a: TokenStream) -> TokenStream {\n+    assert_eq(a, \"pub struct MyStructc { _a: i32, }\".parse().unwrap());\n+    TokenStream::empty()\n+}\n+\n+fn assert_eq(a: TokenStream, b: TokenStream) {\n+    let mut a = a.into_iter();\n+    let mut b = b.into_iter();\n+    for (a, b) in a.by_ref().zip(&mut b) {\n+        match (a, b) {\n+            (TokenTree::Group(a), TokenTree::Group(b)) => {\n+                assert_eq!(a.delimiter(), b.delimiter());\n+                assert_eq(a.stream(), b.stream());\n+            }\n+            (TokenTree::Op(a), TokenTree::Op(b)) => {\n+                assert_eq!(a.op(), b.op());\n+                assert_eq!(a.spacing(), b.spacing());\n+            }\n+            (TokenTree::Literal(a), TokenTree::Literal(b)) => {\n+                assert_eq!(a.to_string(), b.to_string());\n+            }\n+            (TokenTree::Term(a), TokenTree::Term(b)) => {\n+                assert_eq!(a.to_string(), b.to_string());\n+            }\n+            (a, b) => panic!(\"{:?} != {:?}\", a, b),\n+        }\n+    }\n+\n+    assert!(a.next().is_none());\n+    assert!(b.next().is_none());\n+}"}, {"sha": "13a6dbd2ae576613863e0d0a32f30f8173ab0094", "filename": "src/test/run-pass-fulldeps/proc-macro/modify-ast.rs", "status": "added", "additions": 37, "deletions": 0, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/6d7cfd4f1ac571f1d9b29f5ddf836909fe5f127b/src%2Ftest%2Frun-pass-fulldeps%2Fproc-macro%2Fmodify-ast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6d7cfd4f1ac571f1d9b29f5ddf836909fe5f127b/src%2Ftest%2Frun-pass-fulldeps%2Fproc-macro%2Fmodify-ast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass-fulldeps%2Fproc-macro%2Fmodify-ast.rs?ref=6d7cfd4f1ac571f1d9b29f5ddf836909fe5f127b", "patch": "@@ -0,0 +1,37 @@\n+// Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// aux-build:modify-ast.rs\n+\n+#![feature(proc_macro)]\n+\n+extern crate modify_ast;\n+\n+use modify_ast::*;\n+\n+#[derive(Foo)]\n+pub struct MyStructc {\n+    #[cfg_attr(my_cfg, foo)]\n+    _a: i32,\n+}\n+\n+macro_rules! a {\n+    ($i:item) => ($i)\n+}\n+\n+a! {\n+    #[assert1]\n+    pub fn foo() {}\n+}\n+\n+fn main() {\n+    let _a = MyStructc { _a: 0 };\n+    foo();\n+}"}]}