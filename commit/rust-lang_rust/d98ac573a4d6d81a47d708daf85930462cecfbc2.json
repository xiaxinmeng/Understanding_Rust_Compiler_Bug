{"sha": "d98ac573a4d6d81a47d708daf85930462cecfbc2", "node_id": "C_kwDOAAsO6NoAKGQ5OGFjNTczYTRkNmQ4MWE0N2Q3MDhkYWY4NTkzMDQ2MmNlY2ZiYzI", "commit": {"author": {"name": "Alik Aslanyan", "email": "inline0@protonmail.com", "date": "2021-09-30T11:15:10Z"}, "committer": {"name": "Alik Aslanyan", "email": "inline0@protonmail.com", "date": "2021-09-30T11:15:10Z"}, "message": "Remove visible path calculation from allowed deprecation lint", "tree": {"sha": "ce432cfa455ff4e20720d3b78a77733ebabe761a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ce432cfa455ff4e20720d3b78a77733ebabe761a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d98ac573a4d6d81a47d708daf85930462cecfbc2", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQJLBAABCAA1FiEEeY134/OQL6hN3y4Jf+b9XVvEzPYFAmFVnD4XHGlubGluZTBA\ncHJvdG9ubWFpbC5jb20ACgkQf+b9XVvEzPacJg/8DlOR8Q7nZ+9rNgXRol6HIkH5\n3m4mAxfKLll5draP0muUDf1IDQGkuXH9ABqHqTm/YAXc/UBecv0k0+8e6hmZRM7Z\nhPlegRlnm4+7Z3xVgKyy0lZ+fm9aG08EfG4fRCUfaWpWUdrsaOlT7j85cHjO/rNR\nyPmz1yk8eZ7kj5QZjpqy0TX+wl+EmFUi5TICvj9nDj1BfCGgV+6QKHbJO7drmVfb\nXCQ93PsFYKMub1gIa9nFrV9IgSRYNItntVHE0lpvSmsGyRBFsGAn9SfTAiEA8u9R\n98bR2r/13cmcCWOpC2b/x/rUoR8rf7Lxg2tMP7JsWm2D+/Socl107vQ1Hii7Yn2Y\nNZmYnoQDaC/vje9efyHsrQUuqqG7DxPYRao2XquMYQUYG8EZI0a2VoC9UM28mHSU\nKARlgWES5mt1kWalx52gL56GjGVmPPGBg0BvwVDiPK3bWjJvoGqAXRMEQnhwUUxi\n0rAJQFYVkVqGqXJAN+Z+N/nipv6dfOMNK+BuzLTOZZsXBOTsjIJxYGBTgZsZUi1W\n4W2kaZr89o1G2fIwH2ZnMpYDv+KwfF3TAJZGUbjtv3o/u2FKZZ071AZAtAUIalBu\ndIY8ynf+XiACnJqM+DCcz7lkSxxo5iu/QG8RHPhCH/1kgLIR5MhCdP8QSV5d/+bc\nXSu01qvF2TwRzaEanUs=\n=FCxX\n-----END PGP SIGNATURE-----", "payload": "tree ce432cfa455ff4e20720d3b78a77733ebabe761a\nparent 11491938f80988c7261a1179cf71a25c379c8783\nauthor Alik Aslanyan <inline0@protonmail.com> 1633000510 +0400\ncommitter Alik Aslanyan <inline0@protonmail.com> 1633000510 +0400\n\nRemove visible path calculation from allowed deprecation lint\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d98ac573a4d6d81a47d708daf85930462cecfbc2", "html_url": "https://github.com/rust-lang/rust/commit/d98ac573a4d6d81a47d708daf85930462cecfbc2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d98ac573a4d6d81a47d708daf85930462cecfbc2/comments", "author": {"login": "In-line", "id": 19331496, "node_id": "MDQ6VXNlcjE5MzMxNDk2", "avatar_url": "https://avatars.githubusercontent.com/u/19331496?v=4", "gravatar_id": "", "url": "https://api.github.com/users/In-line", "html_url": "https://github.com/In-line", "followers_url": "https://api.github.com/users/In-line/followers", "following_url": "https://api.github.com/users/In-line/following{/other_user}", "gists_url": "https://api.github.com/users/In-line/gists{/gist_id}", "starred_url": "https://api.github.com/users/In-line/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/In-line/subscriptions", "organizations_url": "https://api.github.com/users/In-line/orgs", "repos_url": "https://api.github.com/users/In-line/repos", "events_url": "https://api.github.com/users/In-line/events{/privacy}", "received_events_url": "https://api.github.com/users/In-line/received_events", "type": "User", "site_admin": false}, "committer": {"login": "In-line", "id": 19331496, "node_id": "MDQ6VXNlcjE5MzMxNDk2", "avatar_url": "https://avatars.githubusercontent.com/u/19331496?v=4", "gravatar_id": "", "url": "https://api.github.com/users/In-line", "html_url": "https://github.com/In-line", "followers_url": "https://api.github.com/users/In-line/followers", "following_url": "https://api.github.com/users/In-line/following{/other_user}", "gists_url": "https://api.github.com/users/In-line/gists{/gist_id}", "starred_url": "https://api.github.com/users/In-line/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/In-line/subscriptions", "organizations_url": "https://api.github.com/users/In-line/orgs", "repos_url": "https://api.github.com/users/In-line/repos", "events_url": "https://api.github.com/users/In-line/events{/privacy}", "received_events_url": "https://api.github.com/users/In-line/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "11491938f80988c7261a1179cf71a25c379c8783", "url": "https://api.github.com/repos/rust-lang/rust/commits/11491938f80988c7261a1179cf71a25c379c8783", "html_url": "https://github.com/rust-lang/rust/commit/11491938f80988c7261a1179cf71a25c379c8783"}], "stats": {"total": 125, "additions": 78, "deletions": 47}, "files": [{"sha": "597622b2ebf907dd000a1412c1a5ed4103a9721d", "filename": "compiler/rustc_middle/src/middle/stability.rs", "status": "modified", "additions": 74, "deletions": 40, "changes": 114, "blob_url": "https://github.com/rust-lang/rust/blob/d98ac573a4d6d81a47d708daf85930462cecfbc2/compiler%2Frustc_middle%2Fsrc%2Fmiddle%2Fstability.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d98ac573a4d6d81a47d708daf85930462cecfbc2/compiler%2Frustc_middle%2Fsrc%2Fmiddle%2Fstability.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fmiddle%2Fstability.rs?ref=d98ac573a4d6d81a47d708daf85930462cecfbc2", "patch": "@@ -15,12 +15,11 @@ use rustc_hir::def_id::{CrateNum, DefId, LocalDefId, CRATE_DEF_INDEX};\n use rustc_hir::{self, HirId};\n use rustc_middle::ty::print::with_no_trimmed_paths;\n use rustc_session::lint::builtin::{DEPRECATED, DEPRECATED_IN_FUTURE, SOFT_UNSTABLE};\n-use rustc_session::lint::{BuiltinLintDiagnostics, Lint, LintBuffer};\n+use rustc_session::lint::{BuiltinLintDiagnostics, Level, Lint, LintBuffer};\n use rustc_session::parse::feature_err_issue;\n use rustc_session::{DiagnosticMessageId, Session};\n use rustc_span::symbol::{sym, Symbol};\n use rustc_span::{MultiSpan, Span};\n-\n use std::num::NonZeroU32;\n \n #[derive(PartialEq, Clone, Copy, Debug)]\n@@ -125,7 +124,11 @@ pub fn report_unstable(\n \n /// Checks whether an item marked with `deprecated(since=\"X\")` is currently\n /// deprecated (i.e., whether X is not greater than the current rustc version).\n-pub fn deprecation_in_effect(is_since_rustc_version: bool, since: Option<&str>) -> bool {\n+pub fn deprecation_in_effect(depr: &Deprecation) -> bool {\n+    let is_since_rustc_version = depr.is_since_rustc_version;\n+    let since = depr.since.map(Symbol::as_str);\n+    let since = since.as_deref();\n+\n     fn parse_version(ver: &str) -> Vec<u32> {\n         // We ignore non-integer components of the version (e.g., \"nightly\").\n         ver.split(|c| c == '.' || c == '-').flat_map(|s| s.parse()).collect()\n@@ -175,33 +178,50 @@ pub fn deprecation_suggestion(\n     }\n }\n \n-pub fn deprecation_message(depr: &Deprecation, kind: &str, path: &str) -> (String, &'static Lint) {\n-    let since = depr.since.map(Symbol::as_str);\n-    let (message, lint) = if deprecation_in_effect(depr.is_since_rustc_version, since.as_deref()) {\n-        (format!(\"use of deprecated {} `{}`\", kind, path), DEPRECATED)\n+fn deprecation_lint(is_in_effect: bool) -> &'static Lint {\n+    if is_in_effect { DEPRECATED } else { DEPRECATED_IN_FUTURE }\n+}\n+\n+fn deprecation_message(\n+    is_in_effect: bool,\n+    since: Option<Symbol>,\n+    note: Option<Symbol>,\n+    kind: &str,\n+    path: &str,\n+) -> String {\n+    let message = if is_in_effect {\n+        format!(\"use of deprecated {} `{}`\", kind, path)\n     } else {\n-        (\n-            if since.as_deref() == Some(\"TBD\") {\n-                format!(\n-                    \"use of {} `{}` that will be deprecated in a future Rust version\",\n-                    kind, path\n-                )\n-            } else {\n-                format!(\n-                    \"use of {} `{}` that will be deprecated in future version {}\",\n-                    kind,\n-                    path,\n-                    since.unwrap()\n-                )\n-            },\n-            DEPRECATED_IN_FUTURE,\n-        )\n+        let since = since.map(Symbol::as_str);\n+\n+        if since.as_deref() == Some(\"TBD\") {\n+            format!(\"use of {} `{}` that will be deprecated in a future Rust version\", kind, path)\n+        } else {\n+            format!(\n+                \"use of {} `{}` that will be deprecated in future version {}\",\n+                kind,\n+                path,\n+                since.unwrap()\n+            )\n+        }\n     };\n-    let message = match depr.note {\n+\n+    match note {\n         Some(reason) => format!(\"{}: {}\", message, reason),\n         None => message,\n-    };\n-    (message, lint)\n+    }\n+}\n+\n+pub fn deprecation_message_and_lint(\n+    depr: &Deprecation,\n+    kind: &str,\n+    path: &str,\n+) -> (String, &'static Lint) {\n+    let is_in_effect = deprecation_in_effect(depr);\n+    (\n+        deprecation_message(is_in_effect, depr.since, depr.note, kind, path),\n+        deprecation_lint(is_in_effect),\n+    )\n }\n \n pub fn early_report_deprecation(\n@@ -303,20 +323,34 @@ impl<'tcx> TyCtxt<'tcx> {\n                 //\n                 // #[rustc_deprecated] however wants to emit down the whole\n                 // hierarchy.\n-                if !skip || depr_entry.attr.is_since_rustc_version {\n-                    let path = &with_no_trimmed_paths(|| self.def_path_str(def_id));\n-                    let kind = self.def_kind(def_id).descr(def_id);\n-                    let (message, lint) = deprecation_message(&depr_entry.attr, kind, path);\n-                    late_report_deprecation(\n-                        self,\n-                        &message,\n-                        depr_entry.attr.suggestion,\n-                        lint,\n-                        span,\n-                        method_span,\n-                        id,\n-                        def_id,\n-                    );\n+                let depr_attr = &depr_entry.attr;\n+                if !skip || depr_attr.is_since_rustc_version {\n+                    // Calculating message for lint involves calling `self.def_path_str`.\n+                    // Which by default to calculate visible path will invoke expensive `visible_parent_map` query.\n+                    // So we skip message calculation altogether, if lint is allowed.\n+                    let is_in_effect = deprecation_in_effect(depr_attr);\n+                    let lint = deprecation_lint(is_in_effect);\n+                    if self.lint_level_at_node(lint, id).0 != Level::Allow {\n+                        let def_path = &with_no_trimmed_paths(|| self.def_path_str(def_id));\n+                        let def_kind = self.def_kind(def_id).descr(def_id);\n+\n+                        late_report_deprecation(\n+                            self,\n+                            &deprecation_message(\n+                                is_in_effect,\n+                                depr_attr.since,\n+                                depr_attr.note,\n+                                def_kind,\n+                                def_path,\n+                            ),\n+                            depr_attr.suggestion,\n+                            lint,\n+                            span,\n+                            method_span,\n+                            id,\n+                            def_id,\n+                        );\n+                    }\n                 }\n             };\n         }"}, {"sha": "4f6e23d8f84f0e3fe40573d54c119e9f57ffa98e", "filename": "compiler/rustc_resolve/src/macros.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d98ac573a4d6d81a47d708daf85930462cecfbc2/compiler%2Frustc_resolve%2Fsrc%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d98ac573a4d6d81a47d708daf85930462cecfbc2/compiler%2Frustc_resolve%2Fsrc%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Fmacros.rs?ref=d98ac573a4d6d81a47d708daf85930462cecfbc2", "patch": "@@ -1137,7 +1137,7 @@ impl<'a> Resolver<'a> {\n         }\n         if let Some(depr) = &ext.deprecation {\n             let path = pprust::path_to_string(&path);\n-            let (message, lint) = stability::deprecation_message(depr, \"macro\", &path);\n+            let (message, lint) = stability::deprecation_message_and_lint(depr, \"macro\", &path);\n             stability::early_report_deprecation(\n                 &mut self.lint_buffer,\n                 &message,"}, {"sha": "5045a99800ab1b783ce4c501d3c41834fc4fafbe", "filename": "src/librustdoc/html/render/mod.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/d98ac573a4d6d81a47d708daf85930462cecfbc2/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d98ac573a4d6d81a47d708daf85930462cecfbc2/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs?ref=d98ac573a4d6d81a47d708daf85930462cecfbc2", "patch": "@@ -599,14 +599,14 @@ fn short_item_info(\n     let mut extra_info = vec![];\n     let error_codes = cx.shared.codes;\n \n-    if let Some(Deprecation { note, since, is_since_rustc_version, suggestion: _ }) =\n+    if let Some(depr @ Deprecation { note, since, is_since_rustc_version: _, suggestion: _ }) =\n         item.deprecation(cx.tcx())\n     {\n         // We display deprecation messages for #[deprecated] and #[rustc_deprecated]\n         // but only display the future-deprecation messages for #[rustc_deprecated].\n         let mut message = if let Some(since) = since {\n             let since = &since.as_str();\n-            if !stability::deprecation_in_effect(is_since_rustc_version, Some(since)) {\n+            if !stability::deprecation_in_effect(&depr) {\n                 if *since == \"TBD\" {\n                     String::from(\"Deprecating in a future Rust version\")\n                 } else {"}, {"sha": "fa0d211efe6308bbaf1614ed93d6d161868ba901", "filename": "src/librustdoc/html/render/print_item.rs", "status": "modified", "additions": 1, "deletions": 4, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/d98ac573a4d6d81a47d708daf85930462cecfbc2/src%2Flibrustdoc%2Fhtml%2Frender%2Fprint_item.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d98ac573a4d6d81a47d708daf85930462cecfbc2/src%2Flibrustdoc%2Fhtml%2Frender%2Fprint_item.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fprint_item.rs?ref=d98ac573a4d6d81a47d708daf85930462cecfbc2", "patch": "@@ -418,10 +418,7 @@ fn extra_info_tags(item: &clean::Item, parent: &clean::Item, tcx: TyCtxt<'_>) ->\n     // The trailing space after each tag is to space it properly against the rest of the docs.\n     if let Some(depr) = &item.deprecation(tcx) {\n         let mut message = \"Deprecated\";\n-        if !stability::deprecation_in_effect(\n-            depr.is_since_rustc_version,\n-            depr.since.map(|s| s.as_str()).as_deref(),\n-        ) {\n+        if !stability::deprecation_in_effect(depr) {\n             message = \"Deprecation planned\";\n         }\n         tags += &tag_html(\"deprecated\", \"\", message);"}]}