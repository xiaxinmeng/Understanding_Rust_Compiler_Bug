{"sha": "4deb5959a3a2cbc189e26cb4b0c59a6707a10b45", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRkZWI1OTU5YTNhMmNiYzE4OWUyNmNiNGIwYzU5YTY3MDdhMTBiNDU=", "commit": {"author": {"name": "Andy Russell", "email": "arussell123@gmail.com", "date": "2019-02-05T15:12:43Z"}, "committer": {"name": "Andy Russell", "email": "arussell123@gmail.com", "date": "2019-02-06T14:24:03Z"}, "message": "display sugared return types for async functions", "tree": {"sha": "6e1eec18108e8381b0524e9e6b002e18a34a6066", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6e1eec18108e8381b0524e9e6b002e18a34a6066"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4deb5959a3a2cbc189e26cb4b0c59a6707a10b45", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQFKBAABCAA0FiEELriChyEaiMu0yCg7viIhAz7bw3QFAlxa7ggWHGFydXNzZWxs\nMTIzQGdtYWlsLmNvbQAKCRC+IiEDPtvDdInTB/4x4OepCjjFJNJqdFOZ1kLoix6o\naPJQdpVfiMd/DohHAkZlMdz7joN4iAWj/YWDmCMHFzpC9AUqf2znKKgOXpNskj4T\nV+WJeGbKmarJ5heNcNBXyouIa6EPMEeiNaYqPF+R/+H7gOOeCALvgLVy/oiyB+F9\nDYj6MRWD76eAbwXX/XvNpobXjF/Z90nslDCpRDvwYYE0PrD3c/z2sHSNzB1QqluM\nH5inyWcvhzTsgH1UTyzYqNqMaOFBXgy7iWIU3PaW3CNhCeDY2pKaPLWM+4DHBxzH\nlk21Ax40qeYkvdcxW7cFzW/FkJ5YCbi0JKmPURD5la+CGlOAByLwMbeWNHAC\n=t704\n-----END PGP SIGNATURE-----", "payload": "tree 6e1eec18108e8381b0524e9e6b002e18a34a6066\nparent d30b99f9c23f8e1d6ef993cc94da96510ad709b3\nauthor Andy Russell <arussell123@gmail.com> 1549379563 -0500\ncommitter Andy Russell <arussell123@gmail.com> 1549463043 -0500\n\ndisplay sugared return types for async functions\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4deb5959a3a2cbc189e26cb4b0c59a6707a10b45", "html_url": "https://github.com/rust-lang/rust/commit/4deb5959a3a2cbc189e26cb4b0c59a6707a10b45", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4deb5959a3a2cbc189e26cb4b0c59a6707a10b45/comments", "author": {"login": "euclio", "id": 1372438, "node_id": "MDQ6VXNlcjEzNzI0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1372438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/euclio", "html_url": "https://github.com/euclio", "followers_url": "https://api.github.com/users/euclio/followers", "following_url": "https://api.github.com/users/euclio/following{/other_user}", "gists_url": "https://api.github.com/users/euclio/gists{/gist_id}", "starred_url": "https://api.github.com/users/euclio/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/euclio/subscriptions", "organizations_url": "https://api.github.com/users/euclio/orgs", "repos_url": "https://api.github.com/users/euclio/repos", "events_url": "https://api.github.com/users/euclio/events{/privacy}", "received_events_url": "https://api.github.com/users/euclio/received_events", "type": "User", "site_admin": false}, "committer": {"login": "euclio", "id": 1372438, "node_id": "MDQ6VXNlcjEzNzI0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1372438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/euclio", "html_url": "https://github.com/euclio", "followers_url": "https://api.github.com/users/euclio/followers", "following_url": "https://api.github.com/users/euclio/following{/other_user}", "gists_url": "https://api.github.com/users/euclio/gists{/gist_id}", "starred_url": "https://api.github.com/users/euclio/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/euclio/subscriptions", "organizations_url": "https://api.github.com/users/euclio/orgs", "repos_url": "https://api.github.com/users/euclio/repos", "events_url": "https://api.github.com/users/euclio/events{/privacy}", "received_events_url": "https://api.github.com/users/euclio/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d30b99f9c23f8e1d6ef993cc94da96510ad709b3", "url": "https://api.github.com/repos/rust-lang/rust/commits/d30b99f9c23f8e1d6ef993cc94da96510ad709b3", "html_url": "https://github.com/rust-lang/rust/commit/d30b99f9c23f8e1d6ef993cc94da96510ad709b3"}], "stats": {"total": 105, "additions": 88, "deletions": 17}, "files": [{"sha": "9ef723db40833bb15a4cb4a3b9597a8a63e66374", "filename": "src/librustdoc/clean/mod.rs", "status": "modified", "additions": 39, "deletions": 0, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/4deb5959a3a2cbc189e26cb4b0c59a6707a10b45/src%2Flibrustdoc%2Fclean%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4deb5959a3a2cbc189e26cb4b0c59a6707a10b45/src%2Flibrustdoc%2Fclean%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Fmod.rs?ref=4deb5959a3a2cbc189e26cb4b0c59a6707a10b45", "patch": "@@ -1707,6 +1707,30 @@ impl FnDecl {\n     pub fn self_type(&self) -> Option<SelfTy> {\n         self.inputs.values.get(0).and_then(|v| v.to_self())\n     }\n+\n+    /// Returns the sugared return type for an async function.\n+    ///\n+    /// For example, if the return type is `impl std::future::Future<Output = i32>`, this function\n+    /// will return `i32`.\n+    ///\n+    /// # Panics\n+    ///\n+    /// This function will panic if the return type does not match the expected sugaring for async\n+    /// functions.\n+    pub fn sugared_async_return_type(&self) -> FunctionRetTy {\n+        match &self.output {\n+            FunctionRetTy::Return(Type::ImplTrait(bounds)) => {\n+                match &bounds[0] {\n+                    GenericBound::TraitBound(PolyTrait { trait_, .. }, ..) => {\n+                        let bindings = trait_.bindings().unwrap();\n+                        FunctionRetTy::Return(bindings[0].ty.clone())\n+                    }\n+                    _ => panic!(\"unexpected desugaring of async function\"),\n+                }\n+            }\n+            _ => panic!(\"unexpected desugaring of async function\"),\n+        }\n+    }\n }\n \n #[derive(Clone, RustcEncodable, RustcDecodable, PartialEq, Eq, Debug, Hash)]\n@@ -2265,6 +2289,21 @@ impl Type {\n             _ => None,\n         }\n     }\n+\n+    pub fn bindings(&self) -> Option<&[TypeBinding]> {\n+        match *self {\n+            ResolvedPath { ref path, .. } => {\n+                path.segments.last().and_then(|seg| {\n+                    if let GenericArgs::AngleBracketed { ref bindings, .. } = seg.args {\n+                        Some(&**bindings)\n+                    } else {\n+                        None\n+                    }\n+                })\n+            }\n+            _ => None\n+        }\n+    }\n }\n \n impl GetDefId for Type {"}, {"sha": "c03e679bc519480283a73ed4270253cebd6b2003", "filename": "src/librustdoc/html/format.rs", "status": "modified", "additions": 16, "deletions": 7, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/4deb5959a3a2cbc189e26cb4b0c59a6707a10b45/src%2Flibrustdoc%2Fhtml%2Fformat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4deb5959a3a2cbc189e26cb4b0c59a6707a10b45/src%2Flibrustdoc%2Fhtml%2Fformat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fformat.rs?ref=4deb5959a3a2cbc189e26cb4b0c59a6707a10b45", "patch": "@@ -5,6 +5,7 @@\n //! assume that HTML output is desired, although it may be possible to redesign\n //! them in the future to instead emit any format desired.\n \n+use std::borrow::Cow;\n use std::fmt;\n \n use rustc::hir::def_id::DefId;\n@@ -44,14 +45,16 @@ pub struct GenericBounds<'a>(pub &'a [clean::GenericBound]);\n pub struct CommaSep<'a, T: 'a>(pub &'a [T]);\n pub struct AbiSpace(pub Abi);\n \n-/// Wrapper struct for properly emitting a method declaration.\n-pub struct Method<'a> {\n+/// Wrapper struct for properly emitting a function or method declaration.\n+pub struct Function<'a> {\n     /// The declaration to emit.\n     pub decl: &'a clean::FnDecl,\n     /// The length of the function's \"name\", used to determine line-wrapping.\n     pub name_len: usize,\n     /// The number of spaces to indent each successive line with, if line-wrapping is necessary.\n     pub indent: usize,\n+    /// Whether the function is async or not.\n+    pub asyncness: hir::IsAsync,\n }\n \n /// Wrapper struct for emitting a where clause from Generics.\n@@ -829,9 +832,9 @@ impl fmt::Display for clean::FnDecl {\n     }\n }\n \n-impl<'a> fmt::Display for Method<'a> {\n+impl<'a> fmt::Display for Function<'a> {\n     fn fmt(&self, f: &mut fmt::Formatter) -> fmt::Result {\n-        let &Method { decl, name_len, indent } = self;\n+        let &Function { decl, name_len, indent, asyncness } = self;\n         let amp = if f.alternate() { \"&\" } else { \"&amp;\" };\n         let mut args = String::new();\n         let mut args_plain = String::new();\n@@ -891,11 +894,17 @@ impl<'a> fmt::Display for Method<'a> {\n             args_plain.push_str(\", ...\");\n         }\n \n-        let arrow_plain = format!(\"{:#}\", decl.output);\n+        let output = if let hir::IsAsync::Async = asyncness {\n+            Cow::Owned(decl.sugared_async_return_type())\n+        } else {\n+            Cow::Borrowed(&decl.output)\n+        };\n+\n+        let arrow_plain = format!(\"{:#}\", &output);\n         let arrow = if f.alternate() {\n-            format!(\"{:#}\", decl.output)\n+            format!(\"{:#}\", &output)\n         } else {\n-            decl.output.to_string()\n+            output.to_string()\n         };\n \n         let pad = \" \".repeat(name_len);"}, {"sha": "c8bda66d84170518554468d1f292af1a968c098f", "filename": "src/librustdoc/html/render.rs", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/4deb5959a3a2cbc189e26cb4b0c59a6707a10b45/src%2Flibrustdoc%2Fhtml%2Frender.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4deb5959a3a2cbc189e26cb4b0c59a6707a10b45/src%2Flibrustdoc%2Fhtml%2Frender.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender.rs?ref=4deb5959a3a2cbc189e26cb4b0c59a6707a10b45", "patch": "@@ -62,7 +62,7 @@ use fold::DocFolder;\n use html::escape::Escape;\n use html::format::{AsyncSpace, ConstnessSpace};\n use html::format::{GenericBounds, WhereClause, href, AbiSpace};\n-use html::format::{VisSpace, Method, UnsafetySpace, MutableSpace};\n+use html::format::{VisSpace, Function, UnsafetySpace, MutableSpace};\n use html::format::fmt_impl_for_trait_page;\n use html::item_type::ItemType;\n use html::markdown::{self, Markdown, MarkdownHtml, MarkdownSummaryLine, ErrorCodes, IdMap};\n@@ -2963,10 +2963,11 @@ fn item_function(w: &mut fmt::Formatter, cx: &Context, it: &clean::Item,\n            name = it.name.as_ref().unwrap(),\n            generics = f.generics,\n            where_clause = WhereClause { gens: &f.generics, indent: 0, end_newline: true },\n-           decl = Method {\n+           decl = Function {\n               decl: &f.decl,\n               name_len,\n               indent: 0,\n+              asyncness: f.header.asyncness,\n            })?;\n     document(w, cx, it)\n }\n@@ -3410,10 +3411,11 @@ fn render_assoc_item(w: &mut fmt::Formatter,\n                href = href,\n                name = name,\n                generics = *g,\n-               decl = Method {\n+               decl = Function {\n                    decl: d,\n                    name_len: head_len,\n                    indent,\n+                   asyncness: header.asyncness,\n                },\n                where_clause = WhereClause {\n                    gens: g,"}, {"sha": "ba4997a7f9b5ba7788eaee63f173d8fd62972265", "filename": "src/test/rustdoc/async-fn.rs", "status": "modified", "additions": 28, "deletions": 7, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/4deb5959a3a2cbc189e26cb4b0c59a6707a10b45/src%2Ftest%2Frustdoc%2Fasync-fn.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4deb5959a3a2cbc189e26cb4b0c59a6707a10b45/src%2Ftest%2Frustdoc%2Fasync-fn.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fasync-fn.rs?ref=4deb5959a3a2cbc189e26cb4b0c59a6707a10b45", "patch": "@@ -1,14 +1,35 @@\n // edition:2018\n-// compile-flags:-Z unstable-options\n-\n-// FIXME: once `--edition` is stable in rustdoc, remove that `compile-flags` directive\n \n #![feature(async_await, futures_api)]\n \n-// @has async_fn/struct.S.html\n-// @has - '//code' 'pub async fn f()'\n-pub struct S;\n+// @has async_fn/fn.foo.html '//pre[@class=\"rust fn\"]' 'pub async fn foo() -> Option<Foo>'\n+pub async fn foo() -> Option<Foo> {\n+    None\n+}\n+\n+// @has async_fn/fn.bar.html '//pre[@class=\"rust fn\"]' 'pub async fn bar(a: i32, b: i32) -> i32'\n+pub async fn bar(a: i32, b: i32) -> i32 {\n+    0\n+}\n+\n+// @has async_fn/fn.baz.html '//pre[@class=\"rust fn\"]' 'pub async fn baz<T>(a: T) -> T'\n+pub async fn baz<T>(a: T) -> T {\n+    a\n+}\n+\n+trait Bar {}\n+\n+impl Bar for () {}\n+\n+// @has async_fn/fn.quux.html '//pre[@class=\"rust fn\"]' 'pub async fn quux() -> impl Bar'\n+pub async fn quux() -> impl Bar {\n+    ()\n+}\n+\n+// @has async_fn/struct.Foo.html\n+// @matches - '//code' 'pub async fn f\\(\\)$'\n+pub struct Foo;\n \n-impl S {\n+impl Foo {\n     pub async fn f() {}\n }"}]}