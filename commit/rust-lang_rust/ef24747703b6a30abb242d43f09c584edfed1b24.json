{"sha": "ef24747703b6a30abb242d43f09c584edfed1b24", "node_id": "C_kwDOAAsO6NoAKGVmMjQ3NDc3MDNiNmEzMGFiYjI0MmQ0M2YwOWM1ODRlZGZlZDFiMjQ", "commit": {"author": {"name": "Michael Howell", "email": "michael@notriddle.com", "date": "2022-09-15T20:03:04Z"}, "committer": {"name": "Michael Howell", "email": "michael@notriddle.com", "date": "2022-09-15T20:03:04Z"}, "message": "rustdoc: use more precise URLs for jump-to-definition links\n\nAs an example, this cuts down\n<https://doc.rust-lang.org/nightly/nightly-rustc/src/rustc_middle/ty/mod.rs.html>\nby about 11%.\n\n    $ du -h new_mod.rs.html old_mod.rs.html\n    296K\tnew_mod.rs.html\n    332K\told_mod.rs.html", "tree": {"sha": "615c9dd0d169e48b25b205f5eb7b16d0c12a2fdf", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/615c9dd0d169e48b25b205f5eb7b16d0c12a2fdf"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ef24747703b6a30abb242d43f09c584edfed1b24", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ef24747703b6a30abb242d43f09c584edfed1b24", "html_url": "https://github.com/rust-lang/rust/commit/ef24747703b6a30abb242d43f09c584edfed1b24", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ef24747703b6a30abb242d43f09c584edfed1b24/comments", "author": {"login": "notriddle", "id": 1593513, "node_id": "MDQ6VXNlcjE1OTM1MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/1593513?v=4", "gravatar_id": "", "url": "https://api.github.com/users/notriddle", "html_url": "https://github.com/notriddle", "followers_url": "https://api.github.com/users/notriddle/followers", "following_url": "https://api.github.com/users/notriddle/following{/other_user}", "gists_url": "https://api.github.com/users/notriddle/gists{/gist_id}", "starred_url": "https://api.github.com/users/notriddle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/notriddle/subscriptions", "organizations_url": "https://api.github.com/users/notriddle/orgs", "repos_url": "https://api.github.com/users/notriddle/repos", "events_url": "https://api.github.com/users/notriddle/events{/privacy}", "received_events_url": "https://api.github.com/users/notriddle/received_events", "type": "User", "site_admin": false}, "committer": {"login": "notriddle", "id": 1593513, "node_id": "MDQ6VXNlcjE1OTM1MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/1593513?v=4", "gravatar_id": "", "url": "https://api.github.com/users/notriddle", "html_url": "https://github.com/notriddle", "followers_url": "https://api.github.com/users/notriddle/followers", "following_url": "https://api.github.com/users/notriddle/following{/other_user}", "gists_url": "https://api.github.com/users/notriddle/gists{/gist_id}", "starred_url": "https://api.github.com/users/notriddle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/notriddle/subscriptions", "organizations_url": "https://api.github.com/users/notriddle/orgs", "repos_url": "https://api.github.com/users/notriddle/repos", "events_url": "https://api.github.com/users/notriddle/events{/privacy}", "received_events_url": "https://api.github.com/users/notriddle/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "35a0407814a6b5a04f0929105631e9c69e293e9d", "url": "https://api.github.com/repos/rust-lang/rust/commits/35a0407814a6b5a04f0929105631e9c69e293e9d", "html_url": "https://github.com/rust-lang/rust/commit/35a0407814a6b5a04f0929105631e9c69e293e9d"}], "stats": {"total": 43, "additions": 39, "deletions": 4}, "files": [{"sha": "8922bf377858e21981838171b29250bf66acfb5e", "filename": "src/librustdoc/html/highlight.rs", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ef24747703b6a30abb242d43f09c584edfed1b24/src%2Flibrustdoc%2Fhtml%2Fhighlight.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ef24747703b6a30abb242d43f09c584edfed1b24/src%2Flibrustdoc%2Fhtml%2Fhighlight.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fhighlight.rs?ref=ef24747703b6a30abb242d43f09c584edfed1b24", "patch": "@@ -29,6 +29,8 @@ pub(crate) struct HrefContext<'a, 'b, 'c> {\n     /// This field is used to know \"how far\" from the top of the directory we are to link to either\n     /// documentation pages or other source pages.\n     pub(crate) root_path: &'c str,\n+    /// This field is used to calculate precise local URLs.\n+    pub(crate) current_href: &'c str,\n }\n \n /// Decorations are represented as a map from CSS class to vector of character ranges.\n@@ -977,9 +979,9 @@ fn string_without_closing_tag<T: Display>(\n                 // a link to their definition can be generated using this:\n                 // https://github.com/rust-lang/rust/blob/60f1a2fc4b535ead9c85ce085fdce49b1b097531/src/librustdoc/html/render/context.rs#L315-L338\n                 match href {\n-                    LinkFromSrc::Local(span) => context\n-                        .href_from_span(*span, true)\n-                        .map(|s| format!(\"{}{}\", href_context.root_path, s)),\n+                    LinkFromSrc::Local(span) => {\n+                        context.href_from_span_relative(*span, href_context.current_href)\n+                    }\n                     LinkFromSrc::External(def_id) => {\n                         format::href_with_root_path(*def_id, context, Some(href_context.root_path))\n                             .ok()"}, {"sha": "62def4a94e8dccd6026ef4eb95c8c43896609a4a", "filename": "src/librustdoc/html/render/context.rs", "status": "modified", "additions": 30, "deletions": 0, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/ef24747703b6a30abb242d43f09c584edfed1b24/src%2Flibrustdoc%2Fhtml%2Frender%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ef24747703b6a30abb242d43f09c584edfed1b24/src%2Flibrustdoc%2Fhtml%2Frender%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fcontext.rs?ref=ef24747703b6a30abb242d43f09c584edfed1b24", "patch": "@@ -31,6 +31,7 @@ use crate::formats::FormatRenderer;\n use crate::html::escape::Escape;\n use crate::html::format::{join_with_double_colon, Buffer};\n use crate::html::markdown::{self, plain_text_summary, ErrorCodes, IdMap};\n+use crate::html::url_parts_builder::UrlPartsBuilder;\n use crate::html::{layout, sources};\n use crate::scrape_examples::AllCallLocations;\n use crate::try_err;\n@@ -370,6 +371,35 @@ impl<'tcx> Context<'tcx> {\n             anchor = anchor\n         ))\n     }\n+\n+    pub(crate) fn href_from_span_relative(\n+        &self,\n+        span: clean::Span,\n+        relative_to: &str,\n+    ) -> Option<String> {\n+        self.href_from_span(span, false).map(|s| {\n+            let mut url = UrlPartsBuilder::new();\n+            let mut dest_href_parts = s.split('/');\n+            let mut cur_href_parts = relative_to.split('/');\n+            for (cur_href_part, dest_href_part) in (&mut cur_href_parts).zip(&mut dest_href_parts) {\n+                if cur_href_part != dest_href_part {\n+                    url.push(dest_href_part);\n+                    break;\n+                }\n+            }\n+            for dest_href_part in dest_href_parts {\n+                url.push(dest_href_part);\n+            }\n+            let loline = span.lo(self.sess()).line;\n+            let hiline = span.hi(self.sess()).line;\n+            format!(\n+                \"{}{}#{}\",\n+                \"../\".repeat(cur_href_parts.count()),\n+                url.finish(),\n+                if loline == hiline { loline.to_string() } else { format!(\"{loline}-{hiline}\") }\n+            )\n+        })\n+    }\n }\n \n /// Generates the documentation for `crate` into the directory `dst`"}, {"sha": "2e2bee78b95f9b441b6f3d6a8f2113d1c98ab8a5", "filename": "src/librustdoc/html/sources.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/ef24747703b6a30abb242d43f09c584edfed1b24/src%2Flibrustdoc%2Fhtml%2Fsources.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ef24747703b6a30abb242d43f09c584edfed1b24/src%2Flibrustdoc%2Fhtml%2Fsources.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fsources.rs?ref=ef24747703b6a30abb242d43f09c584edfed1b24", "patch": "@@ -288,11 +288,14 @@ pub(crate) fn print_src(\n         }\n     }\n     line_numbers.write_str(\"</pre>\");\n+    let current_href = &context\n+        .href_from_span(clean::Span::new(file_span), false)\n+        .expect(\"only local crates should have sources emitted\");\n     highlight::render_source_with_highlighting(\n         s,\n         buf,\n         line_numbers,\n-        highlight::HrefContext { context, file_span, root_path },\n+        highlight::HrefContext { context, file_span, root_path, current_href },\n         decoration_info,\n     );\n }"}]}