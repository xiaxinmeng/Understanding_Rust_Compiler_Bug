{"sha": "ed246fcc953831b50ec0fb5b26a48d0704a15ed7", "node_id": "MDY6Q29tbWl0NzI0NzEyOmVkMjQ2ZmNjOTUzODMxYjUwZWMwZmI1YjI2YTQ4ZDA3MDRhMTVlZDc=", "commit": {"author": {"name": "Mark Rousskov", "email": "mark.simulacrum@gmail.com", "date": "2018-08-04T00:39:28Z"}, "committer": {"name": "Mark Rousskov", "email": "mark.simulacrum@gmail.com", "date": "2018-08-09T16:00:25Z"}, "message": "Cache ignored attributes inside ICH entirely", "tree": {"sha": "4d180fa589d44ed0fad664af47afc85cbf0539a5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4d180fa589d44ed0fad664af47afc85cbf0539a5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ed246fcc953831b50ec0fb5b26a48d0704a15ed7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ed246fcc953831b50ec0fb5b26a48d0704a15ed7", "html_url": "https://github.com/rust-lang/rust/commit/ed246fcc953831b50ec0fb5b26a48d0704a15ed7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ed246fcc953831b50ec0fb5b26a48d0704a15ed7/comments", "author": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "bd6fe1e7007c110d3afa46a2c0df14eb07df372e", "url": "https://api.github.com/repos/rust-lang/rust/commits/bd6fe1e7007c110d3afa46a2c0df14eb07df372e", "html_url": "https://github.com/rust-lang/rust/commit/bd6fe1e7007c110d3afa46a2c0df14eb07df372e"}], "stats": {"total": 15, "additions": 6, "deletions": 9}, "files": [{"sha": "329cc2216a498105a7d8bc20f04499b34070281f", "filename": "src/librustc/ich/hcx.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/ed246fcc953831b50ec0fb5b26a48d0704a15ed7/src%2Flibrustc%2Fich%2Fhcx.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ed246fcc953831b50ec0fb5b26a48d0704a15ed7/src%2Flibrustc%2Fich%2Fhcx.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fich%2Fhcx.rs?ref=ed246fcc953831b50ec0fb5b26a48d0704a15ed7", "patch": "@@ -37,7 +37,7 @@ use rustc_data_structures::stable_hasher::{HashStable,\n use rustc_data_structures::accumulate_vec::AccumulateVec;\n use rustc_data_structures::fx::{FxHashSet, FxHashMap};\n \n-pub fn compute_ignored_attr_names() -> FxHashSet<Symbol> {\n+fn compute_ignored_attr_names() -> FxHashSet<Symbol> {\n     debug_assert!(ich::IGNORED_ATTRIBUTES.len() > 0);\n     ich::IGNORED_ATTRIBUTES.iter().map(|&s| Symbol::intern(s)).collect()\n }\n@@ -183,7 +183,10 @@ impl<'a> StableHashingContext<'a> {\n \n     #[inline]\n     pub fn is_ignored_attr(&self, name: Symbol) -> bool {\n-        self.sess.ignored_attr_names.contains(&name)\n+        thread_local! {\n+            static IGNORED_ATTRIBUTES: FxHashSet<Symbol> = compute_ignored_attr_names();\n+        }\n+        IGNORED_ATTRIBUTES.with(|attrs| attrs.contains(&name))\n     }\n \n     pub fn hash_hir_item_like<F: FnOnce(&mut Self)>(&mut self, f: F) {"}, {"sha": "b00d8c565694a374091eff71a397ac9f14ecaaba", "filename": "src/librustc/ich/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ed246fcc953831b50ec0fb5b26a48d0704a15ed7/src%2Flibrustc%2Fich%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ed246fcc953831b50ec0fb5b26a48d0704a15ed7/src%2Flibrustc%2Fich%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fich%2Fmod.rs?ref=ed246fcc953831b50ec0fb5b26a48d0704a15ed7", "patch": "@@ -13,7 +13,7 @@\n crate use rustc_data_structures::fingerprint::Fingerprint;\n pub use self::caching_codemap_view::CachingCodemapView;\n pub use self::hcx::{StableHashingContextProvider, StableHashingContext, NodeIdHashingMode,\n-                    hash_stable_trait_impls, compute_ignored_attr_names};\n+                    hash_stable_trait_impls};\n mod caching_codemap_view;\n mod hcx;\n "}, {"sha": "c3d4d3abf9a4c4f3a2182b2502d592696df8c633", "filename": "src/librustc/session/mod.rs", "status": "modified", "additions": 0, "deletions": 6, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/ed246fcc953831b50ec0fb5b26a48d0704a15ed7/src%2Flibrustc%2Fsession%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ed246fcc953831b50ec0fb5b26a48d0704a15ed7/src%2Flibrustc%2Fsession%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fsession%2Fmod.rs?ref=ed246fcc953831b50ec0fb5b26a48d0704a15ed7", "patch": "@@ -14,7 +14,6 @@ use self::code_stats::CodeStats;\n use hir::def_id::CrateNum;\n use rustc_data_structures::fingerprint::Fingerprint;\n \n-use ich;\n use lint;\n use lint::builtin::BuiltinLintDiagnostics;\n use middle::allocator::AllocatorKind;\n@@ -34,7 +33,6 @@ use errors::emitter::{Emitter, EmitterWriter};\n use syntax::edition::Edition;\n use syntax::json::JsonEmitter;\n use syntax::feature_gate;\n-use syntax::symbol::Symbol;\n use syntax::parse;\n use syntax::parse::ParseSess;\n use syntax::{ast, codemap};\n@@ -128,9 +126,6 @@ pub struct Session {\n \n     incr_comp_session: OneThread<RefCell<IncrCompSession>>,\n \n-    /// A cache of attributes ignored by StableHashingContext\n-    pub ignored_attr_names: FxHashSet<Symbol>,\n-\n     /// Used by -Z profile-queries in util::common\n     pub profile_channel: Lock<Option<mpsc::Sender<ProfileQueriesMsg>>>,\n \n@@ -1143,7 +1138,6 @@ pub fn build_session_(\n         injected_panic_runtime: Once::new(),\n         imported_macro_spans: OneThread::new(RefCell::new(HashMap::new())),\n         incr_comp_session: OneThread::new(RefCell::new(IncrCompSession::NotInitialized)),\n-        ignored_attr_names: ich::compute_ignored_attr_names(),\n         self_profiling: Lock::new(SelfProfiler::new()),\n         profile_channel: Lock::new(None),\n         perf_stats: PerfStats {"}]}