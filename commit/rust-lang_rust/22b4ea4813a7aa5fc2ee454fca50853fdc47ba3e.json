{"sha": "22b4ea4813a7aa5fc2ee454fca50853fdc47ba3e", "node_id": "C_kwDOAAsO6NoAKDIyYjRlYTQ4MTNhN2FhNWZjMmVlNDU0ZmNhNTA4NTNmZGM0N2JhM2U", "commit": {"author": {"name": "topjohnwu", "email": "topjohnwu@google.com", "date": "2022-07-04T06:53:36Z"}, "committer": {"name": "topjohnwu", "email": "topjohnwu@google.com", "date": "2022-07-04T08:38:05Z"}, "message": "Proper macOS libLLVM symlink when cross compiling\n\nWhen cross compiling on macOS with `llvm.link-shared` enabled,\nthe symlink creation will fail after compiling LLVM for the target\narchitecture, because it will attempt to create the symlink in the\nhost LLVM directory, which was already created when being built.\n\nThis commit changes the symlink path to the actual LLVM output.", "tree": {"sha": "8d255b2b56bc68be9dd29c52416b219048f07d00", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8d255b2b56bc68be9dd29c52416b219048f07d00"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/22b4ea4813a7aa5fc2ee454fca50853fdc47ba3e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/22b4ea4813a7aa5fc2ee454fca50853fdc47ba3e", "html_url": "https://github.com/rust-lang/rust/commit/22b4ea4813a7aa5fc2ee454fca50853fdc47ba3e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/22b4ea4813a7aa5fc2ee454fca50853fdc47ba3e/comments", "author": {"login": "topjohnwu", "id": 7337301, "node_id": "MDQ6VXNlcjczMzczMDE=", "avatar_url": "https://avatars.githubusercontent.com/u/7337301?v=4", "gravatar_id": "", "url": "https://api.github.com/users/topjohnwu", "html_url": "https://github.com/topjohnwu", "followers_url": "https://api.github.com/users/topjohnwu/followers", "following_url": "https://api.github.com/users/topjohnwu/following{/other_user}", "gists_url": "https://api.github.com/users/topjohnwu/gists{/gist_id}", "starred_url": "https://api.github.com/users/topjohnwu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/topjohnwu/subscriptions", "organizations_url": "https://api.github.com/users/topjohnwu/orgs", "repos_url": "https://api.github.com/users/topjohnwu/repos", "events_url": "https://api.github.com/users/topjohnwu/events{/privacy}", "received_events_url": "https://api.github.com/users/topjohnwu/received_events", "type": "User", "site_admin": false}, "committer": {"login": "topjohnwu", "id": 7337301, "node_id": "MDQ6VXNlcjczMzczMDE=", "avatar_url": "https://avatars.githubusercontent.com/u/7337301?v=4", "gravatar_id": "", "url": "https://api.github.com/users/topjohnwu", "html_url": "https://github.com/topjohnwu", "followers_url": "https://api.github.com/users/topjohnwu/followers", "following_url": "https://api.github.com/users/topjohnwu/following{/other_user}", "gists_url": "https://api.github.com/users/topjohnwu/gists{/gist_id}", "starred_url": "https://api.github.com/users/topjohnwu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/topjohnwu/subscriptions", "organizations_url": "https://api.github.com/users/topjohnwu/orgs", "repos_url": "https://api.github.com/users/topjohnwu/repos", "events_url": "https://api.github.com/users/topjohnwu/events{/privacy}", "received_events_url": "https://api.github.com/users/topjohnwu/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a5c6a48aee84215a9200dfa1c4c6ad88f5721f56", "url": "https://api.github.com/repos/rust-lang/rust/commits/a5c6a48aee84215a9200dfa1c4c6ad88f5721f56", "html_url": "https://github.com/rust-lang/rust/commit/a5c6a48aee84215a9200dfa1c4c6ad88f5721f56"}], "stats": {"total": 14, "additions": 6, "deletions": 8}, "files": [{"sha": "503a2fc469e5d53fc35663fa4bb714fd66b4b4d4", "filename": "src/bootstrap/native.rs", "status": "modified", "additions": 6, "deletions": 8, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/22b4ea4813a7aa5fc2ee454fca50853fdc47ba3e/src%2Fbootstrap%2Fnative.rs", "raw_url": "https://github.com/rust-lang/rust/raw/22b4ea4813a7aa5fc2ee454fca50853fdc47ba3e/src%2Fbootstrap%2Fnative.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fnative.rs?ref=22b4ea4813a7aa5fc2ee454fca50853fdc47ba3e", "patch": "@@ -487,16 +487,14 @@ impl Step for Llvm {\n             let version = output(cmd.arg(\"--version\"));\n             let major = version.split('.').next().unwrap();\n             let lib_name = match llvm_version_suffix {\n-                Some(s) => format!(\"lib/libLLVM-{}{}.dylib\", major, s),\n-                None => format!(\"lib/libLLVM-{}.dylib\", major),\n+                Some(s) => format!(\"libLLVM-{}{}.dylib\", major, s),\n+                None => format!(\"libLLVM-{}.dylib\", major),\n             };\n \n-            // The reason why we build the library path from llvm-config is because\n-            // the output of llvm-config depends on its location in the file system.\n-            // Make sure we create the symlink exactly where it's needed.\n-            let llvm_base = build_llvm_config.parent().unwrap().parent().unwrap();\n-            let lib_llvm = llvm_base.join(lib_name);\n-            t!(builder.symlink_file(\"libLLVM.dylib\", &lib_llvm));\n+            let lib_llvm = out_dir.join(\"build\").join(\"lib\").join(lib_name);\n+            if !lib_llvm.exists() {\n+                t!(builder.symlink_file(\"libLLVM.dylib\", &lib_llvm));\n+            }\n         }\n \n         t!(stamp.write());"}]}