{"sha": "5e60497fb8625331afd01769141566f15a6a34aa", "node_id": "MDY6Q29tbWl0NzI0NzEyOjVlNjA0OTdmYjg2MjUzMzFhZmQwMTc2OTE0MTU2NmYxNWE2YTM0YWE=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-09-16T18:13:36Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-09-16T18:13:36Z"}, "message": "Auto merge of #6038 - mikerite:lint-5734, r=matthiaskrgr\n\nAdd `manual-strip` lint\n\nAdd `manual-strip` lint.\n\nchangelog: Add `manual-strip` lint", "tree": {"sha": "cb87e02edb3f46900d1e4a864d54bc3f823b0672", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/cb87e02edb3f46900d1e4a864d54bc3f823b0672"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5e60497fb8625331afd01769141566f15a6a34aa", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5e60497fb8625331afd01769141566f15a6a34aa", "html_url": "https://github.com/rust-lang/rust/commit/5e60497fb8625331afd01769141566f15a6a34aa", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5e60497fb8625331afd01769141566f15a6a34aa/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b08bbe50eac80607bd7e8a3d87d15cbf583ce989", "url": "https://api.github.com/repos/rust-lang/rust/commits/b08bbe50eac80607bd7e8a3d87d15cbf583ce989", "html_url": "https://github.com/rust-lang/rust/commit/b08bbe50eac80607bd7e8a3d87d15cbf583ce989"}, {"sha": "79a0e5110a0168945d43e334e6dc0d12e0bc1487", "url": "https://api.github.com/repos/rust-lang/rust/commits/79a0e5110a0168945d43e334e6dc0d12e0bc1487", "html_url": "https://github.com/rust-lang/rust/commit/79a0e5110a0168945d43e334e6dc0d12e0bc1487"}], "stats": {"total": 489, "additions": 473, "deletions": 16}, "files": [{"sha": "5a84333d6db5915940b8e038d43bf278769a5ad6", "filename": "CHANGELOG.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/5e60497fb8625331afd01769141566f15a6a34aa/CHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/5e60497fb8625331afd01769141566f15a6a34aa/CHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/CHANGELOG.md?ref=5e60497fb8625331afd01769141566f15a6a34aa", "patch": "@@ -1672,6 +1672,7 @@ Released 2018-09-13\n [`manual_memcpy`]: https://rust-lang.github.io/rust-clippy/master/index.html#manual_memcpy\n [`manual_non_exhaustive`]: https://rust-lang.github.io/rust-clippy/master/index.html#manual_non_exhaustive\n [`manual_saturating_arithmetic`]: https://rust-lang.github.io/rust-clippy/master/index.html#manual_saturating_arithmetic\n+[`manual_strip`]: https://rust-lang.github.io/rust-clippy/master/index.html#manual_strip\n [`manual_swap`]: https://rust-lang.github.io/rust-clippy/master/index.html#manual_swap\n [`many_single_char_names`]: https://rust-lang.github.io/rust-clippy/master/index.html#many_single_char_names\n [`map_clone`]: https://rust-lang.github.io/rust-clippy/master/index.html#map_clone"}, {"sha": "62bb70af06e937e2e4522b6886d5d411706c670e", "filename": "clippy_lints/src/doc.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/5e60497fb8625331afd01769141566f15a6a34aa/clippy_lints%2Fsrc%2Fdoc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5e60497fb8625331afd01769141566f15a6a34aa/clippy_lints%2Fsrc%2Fdoc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fdoc.rs?ref=5e60497fb8625331afd01769141566f15a6a34aa", "patch": "@@ -534,7 +534,7 @@ fn check_word(cx: &LateContext<'_>, word: &str, span: Span) {\n             return false;\n         }\n \n-        let s = if s.ends_with('s') { &s[..s.len() - 1] } else { s };\n+        let s = s.strip_suffix('s').unwrap_or(s);\n \n         s.chars().all(char::is_alphanumeric)\n             && s.chars().filter(|&c| c.is_uppercase()).take(2).count() > 1"}, {"sha": "a6313127f6911171cf7950e8caa0fe5685efc4fb", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/5e60497fb8625331afd01769141566f15a6a34aa/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5e60497fb8625331afd01769141566f15a6a34aa/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=5e60497fb8625331afd01769141566f15a6a34aa", "patch": "@@ -230,6 +230,7 @@ mod macro_use;\n mod main_recursion;\n mod manual_async_fn;\n mod manual_non_exhaustive;\n+mod manual_strip;\n mod map_clone;\n mod map_err_ignore;\n mod map_identity;\n@@ -627,6 +628,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n         &main_recursion::MAIN_RECURSION,\n         &manual_async_fn::MANUAL_ASYNC_FN,\n         &manual_non_exhaustive::MANUAL_NON_EXHAUSTIVE,\n+        &manual_strip::MANUAL_STRIP,\n         &map_clone::MAP_CLONE,\n         &map_err_ignore::MAP_ERR_IGNORE,\n         &map_identity::MAP_IDENTITY,\n@@ -1113,6 +1115,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n     store.register_late_pass(|| box self_assignment::SelfAssignment);\n     store.register_late_pass(|| box float_equality_without_abs::FloatEqualityWithoutAbs);\n     store.register_late_pass(|| box async_yields_async::AsyncYieldsAsync);\n+    store.register_late_pass(|| box manual_strip::ManualStrip);\n     store.register_late_pass(|| box utils::internal_lints::MatchTypeOnDiagItem);\n \n     store.register_group(true, \"clippy::restriction\", Some(\"clippy_restriction\"), vec![\n@@ -1342,6 +1345,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n         LintId::of(&main_recursion::MAIN_RECURSION),\n         LintId::of(&manual_async_fn::MANUAL_ASYNC_FN),\n         LintId::of(&manual_non_exhaustive::MANUAL_NON_EXHAUSTIVE),\n+        LintId::of(&manual_strip::MANUAL_STRIP),\n         LintId::of(&map_clone::MAP_CLONE),\n         LintId::of(&map_identity::MAP_IDENTITY),\n         LintId::of(&map_unit_fn::OPTION_MAP_UNIT_FN),\n@@ -1633,6 +1637,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n         LintId::of(&loops::EXPLICIT_COUNTER_LOOP),\n         LintId::of(&loops::MUT_RANGE_BOUND),\n         LintId::of(&loops::WHILE_LET_LOOP),\n+        LintId::of(&manual_strip::MANUAL_STRIP),\n         LintId::of(&map_identity::MAP_IDENTITY),\n         LintId::of(&map_unit_fn::OPTION_MAP_UNIT_FN),\n         LintId::of(&map_unit_fn::RESULT_MAP_UNIT_FN),"}, {"sha": "3410341a1e3c5056aacfc16bffd2344bcf98e23b", "filename": "clippy_lints/src/loops.rs", "status": "modified", "additions": 3, "deletions": 5, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/5e60497fb8625331afd01769141566f15a6a34aa/clippy_lints%2Fsrc%2Floops.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5e60497fb8625331afd01769141566f15a6a34aa/clippy_lints%2Fsrc%2Floops.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Floops.rs?ref=5e60497fb8625331afd01769141566f15a6a34aa", "patch": "@@ -2601,11 +2601,9 @@ fn check_needless_collect_direct_usage<'tcx>(expr: &'tcx Expr<'_>, cx: &LateCont\n                         span,\n                         NEEDLESS_COLLECT_MSG,\n                         |diag| {\n-                            let (arg, pred) = if contains_arg.starts_with('&') {\n-                                (\"x\", &contains_arg[1..])\n-                            } else {\n-                                (\"&x\", &*contains_arg)\n-                            };\n+                            let (arg, pred) = contains_arg\n+                                    .strip_prefix('&')\n+                                    .map_or((\"&x\", &*contains_arg), |s| (\"x\", s));\n                             diag.span_suggestion(\n                                 span,\n                                 \"replace with\","}, {"sha": "4afb0ab3badb06a1a20e4d6678153192a17855d1", "filename": "clippy_lints/src/manual_strip.rs", "status": "added", "additions": 245, "deletions": 0, "changes": 245, "blob_url": "https://github.com/rust-lang/rust/blob/5e60497fb8625331afd01769141566f15a6a34aa/clippy_lints%2Fsrc%2Fmanual_strip.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5e60497fb8625331afd01769141566f15a6a34aa/clippy_lints%2Fsrc%2Fmanual_strip.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmanual_strip.rs?ref=5e60497fb8625331afd01769141566f15a6a34aa", "patch": "@@ -0,0 +1,245 @@\n+use crate::consts::{constant, Constant};\n+use crate::utils::usage::mutated_variables;\n+use crate::utils::{\n+    eq_expr_value, higher, match_def_path, multispan_sugg, paths, qpath_res, snippet, span_lint_and_then,\n+};\n+\n+use if_chain::if_chain;\n+use rustc_ast::ast::LitKind;\n+use rustc_hir::def::Res;\n+use rustc_hir::intravisit::{walk_expr, NestedVisitorMap, Visitor};\n+use rustc_hir::BinOpKind;\n+use rustc_hir::{BorrowKind, Expr, ExprKind};\n+use rustc_lint::{LateContext, LateLintPass};\n+use rustc_middle::hir::map::Map;\n+use rustc_middle::ty;\n+use rustc_session::{declare_lint_pass, declare_tool_lint};\n+use rustc_span::source_map::Spanned;\n+use rustc_span::Span;\n+\n+declare_clippy_lint! {\n+    /// **What it does:**\n+    /// Suggests using `strip_{prefix,suffix}` over `str::{starts,ends}_with` and slicing using\n+    /// the pattern's length.\n+    ///\n+    /// **Why is this bad?**\n+    /// Using `str:strip_{prefix,suffix}` is safer and may have better performance as there is no\n+    /// slicing which may panic and the compiler does not need to insert this panic code. It is\n+    /// also sometimes more readable as it removes the need for duplicating or storing the pattern\n+    /// used by `str::{starts,ends}_with` and in the slicing.\n+    ///\n+    /// **Known problems:**\n+    /// None.\n+    ///\n+    /// **Example:**\n+    ///\n+    /// ```rust\n+    /// let s = \"hello, world!\";\n+    /// if s.starts_with(\"hello, \") {\n+    ///     assert_eq!(s[\"hello, \".len()..].to_uppercase(), \"WORLD!\");\n+    /// }\n+    /// ```\n+    /// Use instead:\n+    /// ```rust\n+    /// let s = \"hello, world!\";\n+    /// if let Some(end) = s.strip_prefix(\"hello, \") {\n+    ///     assert_eq!(end.to_uppercase(), \"WORLD!\");\n+    /// }\n+    /// ```\n+    pub MANUAL_STRIP,\n+    complexity,\n+    \"suggests using `strip_{prefix,suffix}` over `str::{starts,ends}_with` and slicing\"\n+}\n+\n+declare_lint_pass!(ManualStrip => [MANUAL_STRIP]);\n+\n+#[derive(Clone, Copy, Debug, Eq, PartialEq)]\n+enum StripKind {\n+    Prefix,\n+    Suffix,\n+}\n+\n+impl<'tcx> LateLintPass<'tcx> for ManualStrip {\n+    fn check_expr(&mut self, cx: &LateContext<'tcx>, expr: &'tcx Expr<'_>) {\n+        if_chain! {\n+            if let Some((cond, then, _)) = higher::if_block(&expr);\n+            if let ExprKind::MethodCall(_, _, [target_arg, pattern], _) = cond.kind;\n+            if let Some(method_def_id) = cx.typeck_results().type_dependent_def_id(cond.hir_id);\n+            if let ExprKind::Path(target_path) = &target_arg.kind;\n+            then {\n+                let strip_kind = if match_def_path(cx, method_def_id, &paths::STR_STARTS_WITH) {\n+                    StripKind::Prefix\n+                } else if match_def_path(cx, method_def_id, &paths::STR_ENDS_WITH) {\n+                    StripKind::Suffix\n+                } else {\n+                    return;\n+                };\n+                let target_res = qpath_res(cx, &target_path, target_arg.hir_id);\n+                if target_res == Res::Err {\n+                    return;\n+                };\n+\n+                if_chain! {\n+                    if let Res::Local(hir_id) = target_res;\n+                    if let Some(used_mutably) = mutated_variables(then, cx);\n+                    if used_mutably.contains(&hir_id);\n+                    then {\n+                        return;\n+                    }\n+                }\n+\n+                let strippings = find_stripping(cx, strip_kind, target_res, pattern, then);\n+                if !strippings.is_empty() {\n+\n+                    let kind_word = match strip_kind {\n+                        StripKind::Prefix => \"prefix\",\n+                        StripKind::Suffix => \"suffix\",\n+                    };\n+\n+                    let test_span = expr.span.until(then.span);\n+                    span_lint_and_then(cx, MANUAL_STRIP, strippings[0], &format!(\"stripping a {} manually\", kind_word), |diag| {\n+                        diag.span_note(test_span, &format!(\"the {} was tested here\", kind_word));\n+                        multispan_sugg(\n+                            diag,\n+                            &format!(\"try using the `strip_{}` method\", kind_word),\n+                            vec![(test_span,\n+                                  format!(\"if let Some(<stripped>) = {}.strip_{}({}) \",\n+                                          snippet(cx, target_arg.span, \"..\"),\n+                                          kind_word,\n+                                          snippet(cx, pattern.span, \"..\")))]\n+                            .into_iter().chain(strippings.into_iter().map(|span| (span, \"<stripped>\".into()))),\n+                        )\n+                    });\n+                }\n+            }\n+        }\n+    }\n+}\n+\n+// Returns `Some(arg)` if `expr` matches `arg.len()` and `None` otherwise.\n+fn len_arg<'tcx>(cx: &LateContext<'tcx>, expr: &'tcx Expr<'_>) -> Option<&'tcx Expr<'tcx>> {\n+    if_chain! {\n+        if let ExprKind::MethodCall(_, _, [arg], _) = expr.kind;\n+        if let Some(method_def_id) = cx.typeck_results().type_dependent_def_id(expr.hir_id);\n+        if match_def_path(cx, method_def_id, &paths::STR_LEN);\n+        then {\n+            Some(arg)\n+        } else {\n+            None\n+        }\n+    }\n+}\n+\n+// Returns the length of the `expr` if it's a constant string or char.\n+fn constant_length(cx: &LateContext<'_>, expr: &Expr<'_>) -> Option<u128> {\n+    let (value, _) = constant(cx, cx.typeck_results(), expr)?;\n+    match value {\n+        Constant::Str(value) => Some(value.len() as u128),\n+        Constant::Char(value) => Some(value.len_utf8() as u128),\n+        _ => None,\n+    }\n+}\n+\n+// Tests if `expr` equals the length of the pattern.\n+fn eq_pattern_length<'tcx>(cx: &LateContext<'tcx>, pattern: &Expr<'_>, expr: &'tcx Expr<'_>) -> bool {\n+    if let ExprKind::Lit(Spanned {\n+        node: LitKind::Int(n, _),\n+        ..\n+    }) = expr.kind\n+    {\n+        constant_length(cx, pattern).map_or(false, |length| length == n)\n+    } else {\n+        len_arg(cx, expr).map_or(false, |arg| eq_expr_value(cx, pattern, arg))\n+    }\n+}\n+\n+// Tests if `expr` is a `&str`.\n+fn is_ref_str(cx: &LateContext<'_>, expr: &Expr<'_>) -> bool {\n+    match cx.typeck_results().expr_ty_adjusted(&expr).kind() {\n+        ty::Ref(_, ty, _) => ty.is_str(),\n+        _ => false,\n+    }\n+}\n+\n+// Removes the outer `AddrOf` expression if needed.\n+fn peel_ref<'a>(expr: &'a Expr<'_>) -> &'a Expr<'a> {\n+    if let ExprKind::AddrOf(BorrowKind::Ref, _, unref) = &expr.kind {\n+        unref\n+    } else {\n+        expr\n+    }\n+}\n+\n+// Find expressions where `target` is stripped using the length of `pattern`.\n+// We'll suggest replacing these expressions with the result of the `strip_{prefix,suffix}`\n+// method.\n+fn find_stripping<'tcx>(\n+    cx: &LateContext<'tcx>,\n+    strip_kind: StripKind,\n+    target: Res,\n+    pattern: &'tcx Expr<'_>,\n+    expr: &'tcx Expr<'_>,\n+) -> Vec<Span> {\n+    struct StrippingFinder<'a, 'tcx> {\n+        cx: &'a LateContext<'tcx>,\n+        strip_kind: StripKind,\n+        target: Res,\n+        pattern: &'tcx Expr<'tcx>,\n+        results: Vec<Span>,\n+    }\n+\n+    impl<'a, 'tcx> Visitor<'tcx> for StrippingFinder<'a, 'tcx> {\n+        type Map = Map<'tcx>;\n+        fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n+            NestedVisitorMap::None\n+        }\n+\n+        fn visit_expr(&mut self, ex: &'tcx Expr<'_>) {\n+            if_chain! {\n+                if is_ref_str(self.cx, ex);\n+                let unref = peel_ref(ex);\n+                if let ExprKind::Index(indexed, index) = &unref.kind;\n+                if let Some(range) = higher::range(index);\n+                if let higher::Range { start, end, .. } = range;\n+                if let ExprKind::Path(path) = &indexed.kind;\n+                if qpath_res(self.cx, path, ex.hir_id) == self.target;\n+                then {\n+                    match (self.strip_kind, start, end) {\n+                        (StripKind::Prefix, Some(start), None) => {\n+                            if eq_pattern_length(self.cx, self.pattern, start) {\n+                                self.results.push(ex.span);\n+                                return;\n+                            }\n+                        },\n+                        (StripKind::Suffix, None, Some(end)) => {\n+                            if_chain! {\n+                                if let ExprKind::Binary(Spanned { node: BinOpKind::Sub, .. }, left, right) = end.kind;\n+                                if let Some(left_arg) = len_arg(self.cx, left);\n+                                if let ExprKind::Path(left_path) = &left_arg.kind;\n+                                if qpath_res(self.cx, left_path, left_arg.hir_id) == self.target;\n+                                if eq_pattern_length(self.cx, self.pattern, right);\n+                                then {\n+                                    self.results.push(ex.span);\n+                                    return;\n+                                }\n+                            }\n+                        },\n+                        _ => {}\n+                    }\n+                }\n+            }\n+\n+            walk_expr(self, ex);\n+        }\n+    }\n+\n+    let mut finder = StrippingFinder {\n+        cx,\n+        strip_kind,\n+        target,\n+        pattern,\n+        results: vec![],\n+    };\n+    walk_expr(&mut finder, expr);\n+    finder.results\n+}"}, {"sha": "9cb1cfb915d5796734b2f94b6167709a53a93ea3", "filename": "clippy_lints/src/misc_early.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/5e60497fb8625331afd01769141566f15a6a34aa/clippy_lints%2Fsrc%2Fmisc_early.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5e60497fb8625331afd01769141566f15a6a34aa/clippy_lints%2Fsrc%2Fmisc_early.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmisc_early.rs?ref=5e60497fb8625331afd01769141566f15a6a34aa", "patch": "@@ -377,16 +377,16 @@ impl EarlyLintPass for MiscEarlyLints {\n             if let PatKind::Ident(_, ident, None) = arg.pat.kind {\n                 let arg_name = ident.to_string();\n \n-                if arg_name.starts_with('_') {\n-                    if let Some(correspondence) = registered_names.get(&arg_name[1..]) {\n+                if let Some(arg_name) = arg_name.strip_prefix('_') {\n+                    if let Some(correspondence) = registered_names.get(arg_name) {\n                         span_lint(\n                             cx,\n                             DUPLICATE_UNDERSCORE_ARGUMENT,\n                             *correspondence,\n                             &format!(\n                                 \"`{}` already exists, having another argument having almost the same \\\n                                  name makes code comprehension and documentation more difficult\",\n-                                arg_name[1..].to_owned()\n+                                arg_name\n                             ),\n                         );\n                     }"}, {"sha": "1a7f36fbdadbb65cb43fb2042e3c6e024901ed87", "filename": "clippy_lints/src/redundant_clone.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/5e60497fb8625331afd01769141566f15a6a34aa/clippy_lints%2Fsrc%2Fredundant_clone.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5e60497fb8625331afd01769141566f15a6a34aa/clippy_lints%2Fsrc%2Fredundant_clone.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fredundant_clone.rs?ref=5e60497fb8625331afd01769141566f15a6a34aa", "patch": "@@ -239,10 +239,9 @@ impl<'tcx> LateLintPass<'tcx> for RedundantClone {\n                         );\n                         let mut app = Applicability::MaybeIncorrect;\n \n-                        let mut call_snip = &snip[dot + 1..];\n+                        let call_snip = &snip[dot + 1..];\n                         // Machine applicable when `call_snip` looks like `foobar()`\n-                        if call_snip.ends_with(\"()\") {\n-                            call_snip = call_snip[..call_snip.len()-2].trim();\n+                        if let Some(call_snip) = call_snip.strip_suffix(\"()\").map(str::trim) {\n                             if call_snip.as_bytes().iter().all(|b| b.is_ascii_alphabetic() || *b == b'_') {\n                                 app = Applicability::MachineApplicable;\n                             }"}, {"sha": "8736121c3b439f03708b07a171bd767c2b762954", "filename": "clippy_lints/src/utils/paths.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/5e60497fb8625331afd01769141566f15a6a34aa/clippy_lints%2Fsrc%2Futils%2Fpaths.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5e60497fb8625331afd01769141566f15a6a34aa/clippy_lints%2Fsrc%2Futils%2Fpaths.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Futils%2Fpaths.rs?ref=5e60497fb8625331afd01769141566f15a6a34aa", "patch": "@@ -115,6 +115,9 @@ pub const STD_MEM_TRANSMUTE: [&str; 3] = [\"std\", \"mem\", \"transmute\"];\n pub const STD_PTR_NULL: [&str; 3] = [\"std\", \"ptr\", \"null\"];\n pub const STRING_AS_MUT_STR: [&str; 4] = [\"alloc\", \"string\", \"String\", \"as_mut_str\"];\n pub const STRING_AS_STR: [&str; 4] = [\"alloc\", \"string\", \"String\", \"as_str\"];\n+pub const STR_ENDS_WITH: [&str; 4] = [\"core\", \"str\", \"<impl str>\", \"ends_with\"];\n+pub const STR_LEN: [&str; 4] = [\"core\", \"str\", \"<impl str>\", \"len\"];\n+pub const STR_STARTS_WITH: [&str; 4] = [\"core\", \"str\", \"<impl str>\", \"starts_with\"];\n pub const SYNTAX_CONTEXT: [&str; 3] = [\"rustc_span\", \"hygiene\", \"SyntaxContext\"];\n pub const TO_OWNED: [&str; 3] = [\"alloc\", \"borrow\", \"ToOwned\"];\n pub const TO_OWNED_METHOD: [&str; 4] = [\"alloc\", \"borrow\", \"ToOwned\", \"to_owned\"];"}, {"sha": "1468bef02b8a5a5ca50354c81093f82847b7baa1", "filename": "src/lintlist/mod.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/5e60497fb8625331afd01769141566f15a6a34aa/src%2Flintlist%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5e60497fb8625331afd01769141566f15a6a34aa/src%2Flintlist%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flintlist%2Fmod.rs?ref=5e60497fb8625331afd01769141566f15a6a34aa", "patch": "@@ -1144,6 +1144,13 @@ pub static ref ALL_LINTS: Vec<Lint> = vec![\n         deprecation: None,\n         module: \"methods\",\n     },\n+    Lint {\n+        name: \"manual_strip\",\n+        group: \"complexity\",\n+        desc: \"suggests using `strip_{prefix,suffix}` over `str::{starts,ends}_with` and slicing\",\n+        deprecation: None,\n+        module: \"manual_strip\",\n+    },\n     Lint {\n         name: \"manual_swap\",\n         group: \"complexity\","}, {"sha": "32a67f181df435ed1157c5d00f6196495509668a", "filename": "tests/ui/let_if_seq.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/5e60497fb8625331afd01769141566f15a6a34aa/tests%2Fui%2Flet_if_seq.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5e60497fb8625331afd01769141566f15a6a34aa/tests%2Fui%2Flet_if_seq.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Flet_if_seq.rs?ref=5e60497fb8625331afd01769141566f15a6a34aa", "patch": "@@ -33,6 +33,7 @@ fn issue985_alt() -> i32 {\n     x\n }\n \n+#[allow(clippy::manual_strip)]\n fn issue975() -> String {\n     let mut udn = \"dummy\".to_string();\n     if udn.starts_with(\"uuid:\") {"}, {"sha": "7de560c73486bf7e622523d4af6036b8ac4b5163", "filename": "tests/ui/let_if_seq.stderr", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/5e60497fb8625331afd01769141566f15a6a34aa/tests%2Fui%2Flet_if_seq.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/5e60497fb8625331afd01769141566f15a6a34aa/tests%2Fui%2Flet_if_seq.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Flet_if_seq.stderr?ref=5e60497fb8625331afd01769141566f15a6a34aa", "patch": "@@ -1,5 +1,5 @@\n error: `if _ { .. } else { .. }` is an expression\n-  --> $DIR/let_if_seq.rs:63:5\n+  --> $DIR/let_if_seq.rs:64:5\n    |\n LL | /     let mut foo = 0;\n LL | |     if f() {\n@@ -11,7 +11,7 @@ LL | |     }\n    = note: you might not need `mut` at all\n \n error: `if _ { .. } else { .. }` is an expression\n-  --> $DIR/let_if_seq.rs:68:5\n+  --> $DIR/let_if_seq.rs:69:5\n    |\n LL | /     let mut bar = 0;\n LL | |     if f() {\n@@ -25,7 +25,7 @@ LL | |     }\n    = note: you might not need `mut` at all\n \n error: `if _ { .. } else { .. }` is an expression\n-  --> $DIR/let_if_seq.rs:76:5\n+  --> $DIR/let_if_seq.rs:77:5\n    |\n LL | /     let quz;\n LL | |     if f() {\n@@ -36,7 +36,7 @@ LL | |     }\n    | |_____^ help: it is more idiomatic to write: `let quz = if f() { 42 } else { 0 };`\n \n error: `if _ { .. } else { .. }` is an expression\n-  --> $DIR/let_if_seq.rs:105:5\n+  --> $DIR/let_if_seq.rs:106:5\n    |\n LL | /     let mut baz = 0;\n LL | |     if f() {"}, {"sha": "cbb84eb5c7e3709411156d5c5483cdf1020fe567", "filename": "tests/ui/manual_strip.rs", "status": "added", "additions": 66, "deletions": 0, "changes": 66, "blob_url": "https://github.com/rust-lang/rust/blob/5e60497fb8625331afd01769141566f15a6a34aa/tests%2Fui%2Fmanual_strip.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5e60497fb8625331afd01769141566f15a6a34aa/tests%2Fui%2Fmanual_strip.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmanual_strip.rs?ref=5e60497fb8625331afd01769141566f15a6a34aa", "patch": "@@ -0,0 +1,66 @@\n+#![warn(clippy::manual_strip)]\n+\n+fn main() {\n+    let s = \"abc\";\n+\n+    if s.starts_with(\"ab\") {\n+        str::to_string(&s[\"ab\".len()..]);\n+        s[\"ab\".len()..].to_string();\n+\n+        str::to_string(&s[2..]);\n+        s[2..].to_string();\n+    }\n+\n+    if s.ends_with(\"bc\") {\n+        str::to_string(&s[..s.len() - \"bc\".len()]);\n+        s[..s.len() - \"bc\".len()].to_string();\n+\n+        str::to_string(&s[..s.len() - 2]);\n+        s[..s.len() - 2].to_string();\n+    }\n+\n+    // Character patterns\n+    if s.starts_with('a') {\n+        str::to_string(&s[1..]);\n+        s[1..].to_string();\n+    }\n+\n+    // Variable prefix\n+    let prefix = \"ab\";\n+    if s.starts_with(prefix) {\n+        str::to_string(&s[prefix.len()..]);\n+    }\n+\n+    // Constant prefix\n+    const PREFIX: &str = \"ab\";\n+    if s.starts_with(PREFIX) {\n+        str::to_string(&s[PREFIX.len()..]);\n+        str::to_string(&s[2..]);\n+    }\n+\n+    // Constant target\n+    const TARGET: &str = \"abc\";\n+    if TARGET.starts_with(prefix) {\n+        str::to_string(&TARGET[prefix.len()..]);\n+    }\n+\n+    // String target - not mutated.\n+    let s1: String = \"abc\".into();\n+    if s1.starts_with(\"ab\") {\n+        s1[2..].to_uppercase();\n+    }\n+\n+    // String target - mutated. (Don't lint.)\n+    let mut s2: String = \"abc\".into();\n+    if s2.starts_with(\"ab\") {\n+        s2.push('d');\n+        s2[2..].to_uppercase();\n+    }\n+\n+    // Target not stripped. (Don't lint.)\n+    let s3 = String::from(\"abcd\");\n+    let s4 = String::from(\"efgh\");\n+    if s3.starts_with(\"ab\") {\n+        s4[2..].to_string();\n+    }\n+}"}, {"sha": "1352a8713d4f8d31ef98b3ec74b9b8ebbf88667b", "filename": "tests/ui/manual_strip.stderr", "status": "added", "additions": 132, "deletions": 0, "changes": 132, "blob_url": "https://github.com/rust-lang/rust/blob/5e60497fb8625331afd01769141566f15a6a34aa/tests%2Fui%2Fmanual_strip.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/5e60497fb8625331afd01769141566f15a6a34aa/tests%2Fui%2Fmanual_strip.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmanual_strip.stderr?ref=5e60497fb8625331afd01769141566f15a6a34aa", "patch": "@@ -0,0 +1,132 @@\n+error: stripping a prefix manually\n+  --> $DIR/manual_strip.rs:7:24\n+   |\n+LL |         str::to_string(&s[\"ab\".len()..]);\n+   |                        ^^^^^^^^^^^^^^^^\n+   |\n+   = note: `-D clippy::manual-strip` implied by `-D warnings`\n+note: the prefix was tested here\n+  --> $DIR/manual_strip.rs:6:5\n+   |\n+LL |     if s.starts_with(\"ab\") {\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^\n+help: try using the `strip_prefix` method\n+   |\n+LL |     if let Some(<stripped>) = s.strip_prefix(\"ab\") {\n+LL |         str::to_string(<stripped>);\n+LL |         <stripped>.to_string();\n+LL | \n+LL |         str::to_string(<stripped>);\n+LL |         <stripped>.to_string();\n+   |\n+\n+error: stripping a suffix manually\n+  --> $DIR/manual_strip.rs:15:24\n+   |\n+LL |         str::to_string(&s[..s.len() - \"bc\".len()]);\n+   |                        ^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+note: the suffix was tested here\n+  --> $DIR/manual_strip.rs:14:5\n+   |\n+LL |     if s.ends_with(\"bc\") {\n+   |     ^^^^^^^^^^^^^^^^^^^^^\n+help: try using the `strip_suffix` method\n+   |\n+LL |     if let Some(<stripped>) = s.strip_suffix(\"bc\") {\n+LL |         str::to_string(<stripped>);\n+LL |         <stripped>.to_string();\n+LL | \n+LL |         str::to_string(<stripped>);\n+LL |         <stripped>.to_string();\n+   |\n+\n+error: stripping a prefix manually\n+  --> $DIR/manual_strip.rs:24:24\n+   |\n+LL |         str::to_string(&s[1..]);\n+   |                        ^^^^^^^\n+   |\n+note: the prefix was tested here\n+  --> $DIR/manual_strip.rs:23:5\n+   |\n+LL |     if s.starts_with('a') {\n+   |     ^^^^^^^^^^^^^^^^^^^^^^\n+help: try using the `strip_prefix` method\n+   |\n+LL |     if let Some(<stripped>) = s.strip_prefix('a') {\n+LL |         str::to_string(<stripped>);\n+LL |         <stripped>.to_string();\n+   |\n+\n+error: stripping a prefix manually\n+  --> $DIR/manual_strip.rs:31:24\n+   |\n+LL |         str::to_string(&s[prefix.len()..]);\n+   |                        ^^^^^^^^^^^^^^^^^^\n+   |\n+note: the prefix was tested here\n+  --> $DIR/manual_strip.rs:30:5\n+   |\n+LL |     if s.starts_with(prefix) {\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^\n+help: try using the `strip_prefix` method\n+   |\n+LL |     if let Some(<stripped>) = s.strip_prefix(prefix) {\n+LL |         str::to_string(<stripped>);\n+   |\n+\n+error: stripping a prefix manually\n+  --> $DIR/manual_strip.rs:37:24\n+   |\n+LL |         str::to_string(&s[PREFIX.len()..]);\n+   |                        ^^^^^^^^^^^^^^^^^^\n+   |\n+note: the prefix was tested here\n+  --> $DIR/manual_strip.rs:36:5\n+   |\n+LL |     if s.starts_with(PREFIX) {\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^\n+help: try using the `strip_prefix` method\n+   |\n+LL |     if let Some(<stripped>) = s.strip_prefix(PREFIX) {\n+LL |         str::to_string(<stripped>);\n+LL |         str::to_string(<stripped>);\n+   |\n+\n+error: stripping a prefix manually\n+  --> $DIR/manual_strip.rs:44:24\n+   |\n+LL |         str::to_string(&TARGET[prefix.len()..]);\n+   |                        ^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+note: the prefix was tested here\n+  --> $DIR/manual_strip.rs:43:5\n+   |\n+LL |     if TARGET.starts_with(prefix) {\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+help: try using the `strip_prefix` method\n+   |\n+LL |     if let Some(<stripped>) = TARGET.strip_prefix(prefix) {\n+LL |         str::to_string(<stripped>);\n+   |\n+\n+error: stripping a prefix manually\n+  --> $DIR/manual_strip.rs:50:9\n+   |\n+LL |         s1[2..].to_uppercase();\n+   |         ^^^^^^^\n+   |\n+note: the prefix was tested here\n+  --> $DIR/manual_strip.rs:49:5\n+   |\n+LL |     if s1.starts_with(\"ab\") {\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^\n+help: try using the `strip_prefix` method\n+   |\n+LL |     if let Some(<stripped>) = s1.strip_prefix(\"ab\") {\n+LL |         <stripped>.to_uppercase();\n+   |\n+\n+error: aborting due to 7 previous errors\n+"}]}