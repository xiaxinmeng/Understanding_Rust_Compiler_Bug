{"sha": "5f6cb2c552a723c41ae31794c7f2f3a61704df69", "node_id": "C_kwDOAAsO6NoAKDVmNmNiMmM1NTJhNzIzYzQxYWUzMTc5NGM3ZjJmM2E2MTcwNGRmNjk", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2021-11-25T14:05:38Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-11-25T14:05:38Z"}, "message": "Rollup merge of #91111 - cjgillot:hir-no-lower-attrs, r=michaelwoerister\n\nDo not visit attributes in `ItemLowerer`.\n\nBy default, AST visitors visit expressions that appear in key-value attributes.\nThose expressions should not be lowered to HIR, as they do not correspond to actually compiled code.\n\nSince an attribute cannot produce meaningful HIR, just skip them altogether.\n\nFixes https://github.com/rust-lang/rust/issues/81886\nFixes https://github.com/rust-lang/rust/issues/90873\nr? `@michaelwoerister`", "tree": {"sha": "84cc5ed12c4bc1d03f75758c48b1e9d05aba19bd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/84cc5ed12c4bc1d03f75758c48b1e9d05aba19bd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5f6cb2c552a723c41ae31794c7f2f3a61704df69", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhn5gzCRBK7hj4Ov3rIwAAJBoIAAujxXegH27AB6WOozVFyK/u\nis0NcceXB364XZF2jHFlT+iXlL9I308h3YbsoZEkbCWJQ+pO78joOvkYv5zO+cl+\nRRH9TrZjptrjv5KxC7JF0fwgkA08v53+AreYCKP5/CJDI1+10V1JPdgwjpvvjiVS\ntKd5qXOP6C9At5jzPlZ5t9evMCT3md0zUF/kTIyRzoeRI9oOCrNgmKoHzUWio4T2\nFYXfAF3mxGjvYmJtblayWqfJVY8e8cJolikZtkR9BdnGCOUgdGjntwc4Wv1UoLcm\nYIgP+bYQlbL268cp9XM1ByUvuFOU2s0g2fuBX1bNPi2coDDwek1G2xb01RCyqi0=\n=VKD+\n-----END PGP SIGNATURE-----\n", "payload": "tree 84cc5ed12c4bc1d03f75758c48b1e9d05aba19bd\nparent 6970cf5a23b4b9a3fbe474684e6bec9f0e13ddd4\nparent 7f5d3fff4f138cd5aaeea2a3ec4be44da6e8c308\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1637849138 +0100\ncommitter GitHub <noreply@github.com> 1637849138 +0100\n\nRollup merge of #91111 - cjgillot:hir-no-lower-attrs, r=michaelwoerister\n\nDo not visit attributes in `ItemLowerer`.\n\nBy default, AST visitors visit expressions that appear in key-value attributes.\nThose expressions should not be lowered to HIR, as they do not correspond to actually compiled code.\n\nSince an attribute cannot produce meaningful HIR, just skip them altogether.\n\nFixes https://github.com/rust-lang/rust/issues/81886\nFixes https://github.com/rust-lang/rust/issues/90873\nr? `@michaelwoerister`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5f6cb2c552a723c41ae31794c7f2f3a61704df69", "html_url": "https://github.com/rust-lang/rust/commit/5f6cb2c552a723c41ae31794c7f2f3a61704df69", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5f6cb2c552a723c41ae31794c7f2f3a61704df69/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6970cf5a23b4b9a3fbe474684e6bec9f0e13ddd4", "url": "https://api.github.com/repos/rust-lang/rust/commits/6970cf5a23b4b9a3fbe474684e6bec9f0e13ddd4", "html_url": "https://github.com/rust-lang/rust/commit/6970cf5a23b4b9a3fbe474684e6bec9f0e13ddd4"}, {"sha": "7f5d3fff4f138cd5aaeea2a3ec4be44da6e8c308", "url": "https://api.github.com/repos/rust-lang/rust/commits/7f5d3fff4f138cd5aaeea2a3ec4be44da6e8c308", "html_url": "https://github.com/rust-lang/rust/commit/7f5d3fff4f138cd5aaeea2a3ec4be44da6e8c308"}], "stats": {"total": 88, "additions": 69, "deletions": 19}, "files": [{"sha": "692f39368243aaa0c52ce0242504c2f81611536d", "filename": "compiler/rustc_ast_lowering/src/item.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/5f6cb2c552a723c41ae31794c7f2f3a61704df69/compiler%2Frustc_ast_lowering%2Fsrc%2Fitem.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5f6cb2c552a723c41ae31794c7f2f3a61704df69/compiler%2Frustc_ast_lowering%2Fsrc%2Fitem.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast_lowering%2Fsrc%2Fitem.rs?ref=5f6cb2c552a723c41ae31794c7f2f3a61704df69", "patch": "@@ -40,6 +40,11 @@ impl ItemLowerer<'_, '_, '_> {\n }\n \n impl<'a> Visitor<'a> for ItemLowerer<'a, '_, '_> {\n+    fn visit_attribute(&mut self, _: &'a Attribute) {\n+        // We do not want to lower expressions that appear in attributes,\n+        // as they are not accessible to the rest of the HIR.\n+    }\n+\n     fn visit_item(&mut self, item: &'a Item) {\n         let hir_id = self.lctx.with_hir_id_owner(item.id, |lctx| {\n             let node = lctx.without_in_scope_lifetime_defs(|lctx| lctx.lower_item(item));"}, {"sha": "12123c946cc08efac1d0def6f0c87af535f9f174", "filename": "compiler/rustc_resolve/src/late.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/5f6cb2c552a723c41ae31794c7f2f3a61704df69/compiler%2Frustc_resolve%2Fsrc%2Flate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5f6cb2c552a723c41ae31794c7f2f3a61704df69/compiler%2Frustc_resolve%2Fsrc%2Flate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Flate.rs?ref=5f6cb2c552a723c41ae31794c7f2f3a61704df69", "patch": "@@ -431,6 +431,10 @@ struct LateResolutionVisitor<'a, 'b, 'ast> {\n \n /// Walks the whole crate in DFS order, visiting each item, resolving names as it goes.\n impl<'a: 'ast, 'ast> Visitor<'ast> for LateResolutionVisitor<'a, '_, 'ast> {\n+    fn visit_attribute(&mut self, _: &'ast Attribute) {\n+        // We do not want to resolve expressions that appear in attributes,\n+        // as they do not correspond to actual code.\n+    }\n     fn visit_item(&mut self, item: &'ast Item) {\n         let prev = replace(&mut self.diagnostic_metadata.current_item, Some(item));\n         // Always report errors in items we just entered."}, {"sha": "76708ea98305f2ee9637ecb7bfcefca78dbfe11a", "filename": "src/test/ui/attributes/issue-90873.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/5f6cb2c552a723c41ae31794c7f2f3a61704df69/src%2Ftest%2Fui%2Fattributes%2Fissue-90873.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5f6cb2c552a723c41ae31794c7f2f3a61704df69/src%2Ftest%2Fui%2Fattributes%2Fissue-90873.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fattributes%2Fissue-90873.rs?ref=5f6cb2c552a723c41ae31794c7f2f3a61704df69", "patch": "@@ -0,0 +1,9 @@\n+#![u=||{static d=||1;}]\n+//~^ unexpected token\n+//~| cannot find attribute `u` in this scope\n+//~| `main` function not found in crate `issue_90873`\n+//~| missing type for `static` item\n+\n+#![a={impl std::ops::Neg for i8 {}}]\n+//~^ ERROR unexpected token\n+//~| ERROR cannot find attribute `a` in this scope"}, {"sha": "d466157f04e0cd3c1f955fb69e7e2b02ed0ed5db", "filename": "src/test/ui/attributes/issue-90873.stderr", "status": "added", "additions": 50, "deletions": 0, "changes": 50, "blob_url": "https://github.com/rust-lang/rust/blob/5f6cb2c552a723c41ae31794c7f2f3a61704df69/src%2Ftest%2Fui%2Fattributes%2Fissue-90873.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/5f6cb2c552a723c41ae31794c7f2f3a61704df69/src%2Ftest%2Fui%2Fattributes%2Fissue-90873.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fattributes%2Fissue-90873.stderr?ref=5f6cb2c552a723c41ae31794c7f2f3a61704df69", "patch": "@@ -0,0 +1,50 @@\n+error: unexpected token: `||\n+           {\n+               static d: _ = || 1;\n+           }`\n+  --> $DIR/issue-90873.rs:1:6\n+   |\n+LL | #![u=||{static d=||1;}]\n+   |      ^^^^^^^^^^^^^^^^^\n+\n+error: unexpected token: `{\n+           impl std::ops::Neg for i8 { }\n+       }`\n+  --> $DIR/issue-90873.rs:7:6\n+   |\n+LL | #![a={impl std::ops::Neg for i8 {}}]\n+   |      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: cannot find attribute `u` in this scope\n+  --> $DIR/issue-90873.rs:1:4\n+   |\n+LL | #![u=||{static d=||1;}]\n+   |    ^\n+\n+error: cannot find attribute `a` in this scope\n+  --> $DIR/issue-90873.rs:7:4\n+   |\n+LL | #![a={impl std::ops::Neg for i8 {}}]\n+   |    ^\n+\n+error[E0601]: `main` function not found in crate `issue_90873`\n+  --> $DIR/issue-90873.rs:1:1\n+   |\n+LL | / #![u=||{static d=||1;}]\n+LL | |\n+LL | |\n+LL | |\n+LL | |\n+LL | |\n+LL | | #![a={impl std::ops::Neg for i8 {}}]\n+   | |____________________________________^ consider adding a `main` function to `$DIR/issue-90873.rs`\n+\n+error: missing type for `static` item\n+  --> $DIR/issue-90873.rs:1:16\n+   |\n+LL | #![u=||{static d=||1;}]\n+   |                ^ help: provide a type for the item: `d: <type>`\n+\n+error: aborting due to 6 previous errors\n+\n+For more information about this error, try `rustc --explain E0601`."}, {"sha": "ac5640646a814bb84e208db725e106e91cdfd3ed", "filename": "src/test/ui/consts/issue-90878-2.rs", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/5f6cb2c552a723c41ae31794c7f2f3a61704df69/src%2Ftest%2Fui%2Fconsts%2Fissue-90878-2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5f6cb2c552a723c41ae31794c7f2f3a61704df69/src%2Ftest%2Fui%2Fconsts%2Fissue-90878-2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fissue-90878-2.rs?ref=5f6cb2c552a723c41ae31794c7f2f3a61704df69", "patch": "@@ -1,7 +1,5 @@\n  #![l=|x|[b;x ]] //~ ERROR unexpected token: `|x| [b; x]`\n //~^ ERROR cannot find attribute `l` in this scope\n-//~^^ ERROR attempt to use a non-constant value in a constant [E0435]\n-//~^^^ ERROR cannot find value `b` in this scope [E0425]\n \n // notice the space at the start,\n // we can't attach any attributes to this file because it needs to be at the start"}, {"sha": "4ccce36eedf70435d08b3986fbbd2c9105015b8c", "filename": "src/test/ui/consts/issue-90878-2.stderr", "status": "modified", "additions": 1, "deletions": 17, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/5f6cb2c552a723c41ae31794c7f2f3a61704df69/src%2Ftest%2Fui%2Fconsts%2Fissue-90878-2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/5f6cb2c552a723c41ae31794c7f2f3a61704df69/src%2Ftest%2Fui%2Fconsts%2Fissue-90878-2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fissue-90878-2.stderr?ref=5f6cb2c552a723c41ae31794c7f2f3a61704df69", "patch": "@@ -10,21 +10,5 @@ error: cannot find attribute `l` in this scope\n LL |  #![l=|x|[b;x ]]\n    |     ^\n \n-error[E0435]: attempt to use a non-constant value in a constant\n-  --> $DIR/issue-90878-2.rs:1:13\n-   |\n-LL |  #![l=|x|[b;x ]]\n-   |        -    ^\n-   |        |\n-   |        this would need to be a `const`\n-\n-error[E0425]: cannot find value `b` in this scope\n-  --> $DIR/issue-90878-2.rs:1:11\n-   |\n-LL |  #![l=|x|[b;x ]]\n-   |           ^ help: a local variable with a similar name exists: `x`\n-\n-error: aborting due to 4 previous errors\n+error: aborting due to 2 previous errors\n \n-Some errors have detailed explanations: E0425, E0435.\n-For more information about an error, try `rustc --explain E0425`."}]}