{"sha": "c460d38363e315a3e993649215aa6846ac2b70e3", "node_id": "MDY6Q29tbWl0NzI0NzEyOmM0NjBkMzgzNjNlMzE1YTNlOTkzNjQ5MjE1YWE2ODQ2YWMyYjcwZTM=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2014-07-09T14:44:49Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2014-07-09T14:44:49Z"}, "message": "etc: Fix install script for rpath removal\n\nThis adds detection of the relevant LD_LIBRARY_PATH-like environment variable\nand appropriately sets it when testing whether binaries can run or not.\nAdditionally, the installation prints a recommended value if one is necessary.", "tree": {"sha": "14f489253fc7f8d85f6c1473d646928db6510507", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/14f489253fc7f8d85f6c1473d646928db6510507"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c460d38363e315a3e993649215aa6846ac2b70e3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c460d38363e315a3e993649215aa6846ac2b70e3", "html_url": "https://github.com/rust-lang/rust/commit/c460d38363e315a3e993649215aa6846ac2b70e3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c460d38363e315a3e993649215aa6846ac2b70e3/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8ddd286ea4ba4384a0dc9eae393ed515460a986e", "url": "https://api.github.com/repos/rust-lang/rust/commits/8ddd286ea4ba4384a0dc9eae393ed515460a986e", "html_url": "https://github.com/rust-lang/rust/commit/8ddd286ea4ba4384a0dc9eae393ed515460a986e"}], "stats": {"total": 41, "additions": 35, "deletions": 6}, "files": [{"sha": "a89b616edf031f076e1c01ad1da6dfa4540e6319", "filename": "src/etc/install.sh", "status": "modified", "additions": 35, "deletions": 6, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/c460d38363e315a3e993649215aa6846ac2b70e3/src%2Fetc%2Finstall.sh", "raw_url": "https://github.com/rust-lang/rust/raw/c460d38363e315a3e993649215aa6846ac2b70e3/src%2Fetc%2Finstall.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fetc%2Finstall.sh?ref=c460d38363e315a3e993649215aa6846ac2b70e3", "patch": "@@ -285,6 +285,19 @@ then\n     CFG_LIBDIR_RELATIVE=bin\n fi\n \n+if [ \"$CFG_OSTYPE\" = \"pc-mingw32\" ] || [ \"$CFG_OSTYPE\" = \"w64-mingw32\" ]\n+then\n+    CFG_LD_PATH_VAR=PATH\n+    CFG_OLD_LD_PATH_VAR=$PATH\n+elif [ \"$CFG_OSTYPE\" = \"Darwin\" ]\n+then\n+    CFG_LD_PATH_VAR=DYLD_LIBRARY_PATH\n+    CFG_OLD_LD_PATH_VAR=$DYLD_LIBRARY_PATH\n+else\n+    CFG_LD_PATH_VAR=LD_LIBRARY_PATH\n+    CFG_OLD_LD_PATH_VAR=$LD_LIBRARY_PATH\n+fi\n+\n flag uninstall \"only uninstall from the installation prefix\"\n opt verify 1 \"verify that the installed binaries run correctly\"\n valopt prefix \"/usr/local\" \"set installation prefix\"\n@@ -312,11 +325,13 @@ then\n     if [ -z \"${CFG_UNINSTALL}\" ]\n     then\n         msg \"verifying platform can run binaries\"\n+        export $CFG_LD_PATH_VAR=\"${CFG_SRC_DIR}/lib\":$CFG_OLD_LD_PATH_VAR\n         \"${CFG_SRC_DIR}/bin/rustc\" --version > /dev/null\n         if [ $? -ne 0 ]\n         then\n             err \"can't execute rustc binary on this platform\"\n         fi\n+        export $CFG_LD_PATH_VAR=$CFG_OLD_LD_PATH_VAR\n     fi\n fi\n \n@@ -452,17 +467,31 @@ while read p; do\n done < \"${CFG_SRC_DIR}/${CFG_LIBDIR_RELATIVE}/rustlib/manifest.in\"\n \n # Sanity check: can we run the installed binaries?\n+#\n+# As with the verification above, make sure the right LD_LIBRARY_PATH-equivalent\n+# is in place. Try first without this variable, and if that fails try again with\n+# the variable. If the second time tries, print a hopefully helpful message to\n+# add something to the appropriate environment variable.\n if [ -z \"${CFG_DISABLE_VERIFY}\" ]\n then\n     msg \"verifying installed binaries are executable\"\n-    \"${CFG_PREFIX}/bin/rustc\" --version > /dev/null\n+    \"${CFG_PREFIX}/bin/rustc\" --version 2> /dev/null 1> /dev/null\n     if [ $? -ne 0 ]\n     then\n-        ERR=\"can't execute installed rustc binary. \"\n-        ERR=\"${ERR}installation may be broken. \"\n-        ERR=\"${ERR}if this is expected then rerun install.sh with \\`--disable-verify\\` \"\n-        ERR=\"${ERR}or \\`make install\\` with \\`--disable-verify-install\\`\"\n-        err \"${ERR}\"\n+        export $CFG_LD_PATH_VAR=\"${CFG_PREFIX}/lib\":$CFG_OLD_LD_PATH_VAR\n+        \"${CFG_PREFIX}/bin/rustc\" --version > /dev/null\n+        if [ $? -ne 0 ]\n+        then\n+            ERR=\"can't execute installed rustc binary. \"\n+            ERR=\"${ERR}installation may be broken. \"\n+            ERR=\"${ERR}if this is expected then rerun install.sh with \\`--disable-verify\\` \"\n+            ERR=\"${ERR}or \\`make install\\` with \\`--disable-verify-install\\`\"\n+            err \"${ERR}\"\n+        else\n+            echo\n+            echo \"    please ensure '${CFG_PREFIX}/lib' is added to ${CFG_LD_PATH_VAR}\"\n+            echo\n+        fi\n     fi\n fi\n "}]}