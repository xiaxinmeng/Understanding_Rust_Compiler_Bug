{"sha": "86a0a181793aa348f544fdb4136db7ce190fbc25", "node_id": "C_kwDOAAsO6NoAKDg2YTBhMTgxNzkzYWEzNDhmNTQ0ZmRiNDEzNmRiN2NlMTkwZmJjMjU", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-08-15T05:50:54Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-08-15T05:50:54Z"}, "message": "Auto merge of #96745 - ehuss:even-more-attribute-validation, r=cjgillot\n\nVisit attributes in more places.\n\nThis adds 3 loosely related changes (I can split PRs if desired):\n\n- Attribute checking on pattern struct fields.\n- Attribute checking on struct expression fields.\n- Lint level visiting on pattern struct fields, struct expression fields, and generic parameters.\n\nThere are still some lints which ignore lint levels in various positions. This is a consequence of how the lints themselves are implemented. For example, lint levels on associated consts don't work with `unused_braces`.", "tree": {"sha": "8714d0ceea9894bbe2422b21f76d4982a604c82a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8714d0ceea9894bbe2422b21f76d4982a604c82a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/86a0a181793aa348f544fdb4136db7ce190fbc25", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/86a0a181793aa348f544fdb4136db7ce190fbc25", "html_url": "https://github.com/rust-lang/rust/commit/86a0a181793aa348f544fdb4136db7ce190fbc25", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/86a0a181793aa348f544fdb4136db7ce190fbc25/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1a3192a331395e31973bb6d4e384a842172a9bda", "url": "https://api.github.com/repos/rust-lang/rust/commits/1a3192a331395e31973bb6d4e384a842172a9bda", "html_url": "https://github.com/rust-lang/rust/commit/1a3192a331395e31973bb6d4e384a842172a9bda"}, {"sha": "3c4aec500f4d47e99f35837a3da82115d3af3a89", "url": "https://api.github.com/repos/rust-lang/rust/commits/3c4aec500f4d47e99f35837a3da82115d3af3a89", "html_url": "https://github.com/rust-lang/rust/commit/3c4aec500f4d47e99f35837a3da82115d3af3a89"}], "stats": {"total": 26, "additions": 14, "deletions": 12}, "files": [{"sha": "59f10247a11d4c98ea4821a3746ee2479c37aff9", "filename": "clippy_lints/src/dereference.rs", "status": "modified", "additions": 14, "deletions": 12, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/86a0a181793aa348f544fdb4136db7ce190fbc25/clippy_lints%2Fsrc%2Fdereference.rs", "raw_url": "https://github.com/rust-lang/rust/raw/86a0a181793aa348f544fdb4136db7ce190fbc25/clippy_lints%2Fsrc%2Fdereference.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fdereference.rs?ref=86a0a181793aa348f544fdb4136db7ce190fbc25", "patch": "@@ -2,7 +2,7 @@ use clippy_utils::diagnostics::{span_lint_and_sugg, span_lint_hir_and_then};\n use clippy_utils::source::{snippet_with_applicability, snippet_with_context};\n use clippy_utils::sugg::has_enclosing_paren;\n use clippy_utils::ty::{expr_sig, peel_mid_ty_refs, ty_sig, variant_of_res};\n-use clippy_utils::{get_parent_expr, is_lint_allowed, path_to_local, walk_to_expr_usage};\n+use clippy_utils::{get_parent_expr, get_parent_expr_for_hir, is_lint_allowed, path_to_local, walk_to_expr_usage};\n use rustc_ast::util::parser::{PREC_POSTFIX, PREC_PREFIX};\n use rustc_data_structures::fx::FxIndexMap;\n use rustc_errors::Applicability;\n@@ -699,6 +699,19 @@ fn walk_parents<'tcx>(cx: &LateContext<'tcx>, e: &'tcx Expr<'_>) -> (Position, &\n                 Some(ty_auto_deref_stability(cx, output, precedence).position_for_result(cx))\n             },\n \n+            Node::ExprField(field) if field.span.ctxt() == ctxt => match get_parent_expr_for_hir(cx, field.hir_id) {\n+                Some(Expr {\n+                    hir_id,\n+                    kind: ExprKind::Struct(path, ..),\n+                    ..\n+                }) => variant_of_res(cx, cx.qpath_res(path, *hir_id))\n+                    .and_then(|variant| variant.fields.iter().find(|f| f.name == field.ident.name))\n+                    .map(|field_def| {\n+                        ty_auto_deref_stability(cx, cx.tcx.type_of(field_def.did), precedence).position_for_arg()\n+                    }),\n+                _ => None,\n+            },\n+\n             Node::Expr(parent) if parent.span.ctxt() == ctxt => match parent.kind {\n                 ExprKind::Ret(_) => {\n                     let owner_id = cx.tcx.hir().body_owner(cx.enclosing_body.unwrap());\n@@ -788,17 +801,6 @@ fn walk_parents<'tcx>(cx: &LateContext<'tcx>, e: &'tcx Expr<'_>) -> (Position, &\n                         }\n                     })\n                 },\n-                ExprKind::Struct(path, fields, _) => {\n-                    let variant = variant_of_res(cx, cx.qpath_res(path, parent.hir_id));\n-                    fields\n-                        .iter()\n-                        .find(|f| f.expr.hir_id == child_id)\n-                        .zip(variant)\n-                        .and_then(|(field, variant)| variant.fields.iter().find(|f| f.name == field.ident.name))\n-                        .map(|field| {\n-                            ty_auto_deref_stability(cx, cx.tcx.type_of(field.did), precedence).position_for_arg()\n-                        })\n-                },\n                 ExprKind::Field(child, name) if child.hir_id == e.hir_id => Some(Position::FieldAccess(name.name)),\n                 ExprKind::Unary(UnOp::Deref, child) if child.hir_id == e.hir_id => Some(Position::Deref),\n                 ExprKind::Match(child, _, MatchSource::TryDesugar | MatchSource::AwaitDesugar)"}]}