{"sha": "ee4e41cbea8ef3758ccebd9ffb35c5290aebfceb", "node_id": "MDY6Q29tbWl0NzI0NzEyOmVlNGU0MWNiZWE4ZWYzNzU4Y2NlYmQ5ZmZiMzVjNTI5MGFlYmZjZWI=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2020-02-17T13:03:33Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2020-02-17T13:03:33Z"}, "message": "Push IO and error handling up", "tree": {"sha": "7b377257a1f0e64611a31270b3dfd25d12acd96f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7b377257a1f0e64611a31270b3dfd25d12acd96f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ee4e41cbea8ef3758ccebd9ffb35c5290aebfceb", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ee4e41cbea8ef3758ccebd9ffb35c5290aebfceb", "html_url": "https://github.com/rust-lang/rust/commit/ee4e41cbea8ef3758ccebd9ffb35c5290aebfceb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ee4e41cbea8ef3758ccebd9ffb35c5290aebfceb/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6167101302bcc2d7f1a345e0ee44e1411056b4b3", "url": "https://api.github.com/repos/rust-lang/rust/commits/6167101302bcc2d7f1a345e0ee44e1411056b4b3", "html_url": "https://github.com/rust-lang/rust/commit/6167101302bcc2d7f1a345e0ee44e1411056b4b3"}], "stats": {"total": 27, "additions": 13, "deletions": 14}, "files": [{"sha": "aaf2ef40e3e3f1ead29f524f2c8de33f729aa027", "filename": "editors/code/src/client.ts", "status": "modified", "additions": 1, "deletions": 5, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/ee4e41cbea8ef3758ccebd9ffb35c5290aebfceb/editors%2Fcode%2Fsrc%2Fclient.ts", "raw_url": "https://github.com/rust-lang/rust/raw/ee4e41cbea8ef3758ccebd9ffb35c5290aebfceb/editors%2Fcode%2Fsrc%2Fclient.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fclient.ts?ref=ee4e41cbea8ef3758ccebd9ffb35c5290aebfceb", "patch": "@@ -2,18 +2,14 @@ import * as lc from 'vscode-languageclient';\n import * as vscode from 'vscode';\n \n import { Config } from './config';\n-import { ensureServerBinary } from './installation/server';\n import { CallHierarchyFeature } from 'vscode-languageclient/lib/callHierarchy.proposed';\n \n-export async function createClient(config: Config): Promise<null | lc.LanguageClient> {\n+export async function createClient(config: Config, serverPath: string): Promise<lc.LanguageClient> {\n     // '.' Is the fallback if no folder is open\n     // TODO?: Workspace folders support Uri's (eg: file://test.txt).\n     // It might be a good idea to test if the uri points to a file.\n     const workspaceFolderPath = vscode.workspace.workspaceFolders?.[0]?.uri.fsPath ?? '.';\n \n-    const serverPath = await ensureServerBinary(config.serverSource);\n-    if (!serverPath) return null;\n-\n     const run: lc.Executable = {\n         command: serverPath,\n         options: { cwd: workspaceFolderPath },"}, {"sha": "935a6f2b5a3297d72ccd3c3780650a774d892c7e", "filename": "editors/code/src/ctx.ts", "status": "modified", "additions": 2, "deletions": 8, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/ee4e41cbea8ef3758ccebd9ffb35c5290aebfceb/editors%2Fcode%2Fsrc%2Fctx.ts", "raw_url": "https://github.com/rust-lang/rust/raw/ee4e41cbea8ef3758ccebd9ffb35c5290aebfceb/editors%2Fcode%2Fsrc%2Fctx.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fctx.ts?ref=ee4e41cbea8ef3758ccebd9ffb35c5290aebfceb", "patch": "@@ -23,16 +23,10 @@ export class Ctx {\n         this.extCtx = extCtx;\n     }\n \n-    async startServer() {\n+    async startServer(serverPath: string) {\n         assert(this.client == null);\n \n-        const client = await createClient(this.config);\n-        if (!client) {\n-            throw new Error(\n-                \"Rust Analyzer Language Server is not available. \" +\n-                \"Please, ensure its [proper installation](https://github.com/rust-analyzer/rust-analyzer/tree/master/docs/user#vs-code).\"\n-            );\n-        }\n+        const client = await createClient(this.config, serverPath);\n \n         this.pushCleanup(client.start());\n         await client.onReady();"}, {"sha": "ece4883bd6991d808378ed63c4d18953b2bc5961", "filename": "editors/code/src/main.ts", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/ee4e41cbea8ef3758ccebd9ffb35c5290aebfceb/editors%2Fcode%2Fsrc%2Fmain.ts", "raw_url": "https://github.com/rust-lang/rust/raw/ee4e41cbea8ef3758ccebd9ffb35c5290aebfceb/editors%2Fcode%2Fsrc%2Fmain.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fmain.ts?ref=ee4e41cbea8ef3758ccebd9ffb35c5290aebfceb", "patch": "@@ -5,18 +5,27 @@ import { activateInlayHints } from './inlay_hints';\n import { activateStatusDisplay } from './status_display';\n import { Ctx } from './ctx';\n import { activateHighlighting } from './highlighting';\n+import { ensureServerBinary } from './installation/server';\n \n let ctx: Ctx | undefined;\n \n export async function activate(context: vscode.ExtensionContext) {\n     ctx = new Ctx(context);\n \n+    const serverPath = await ensureServerBinary(ctx.config.serverSource);\n+    if (serverPath == null) {\n+        throw new Error(\n+            \"Rust Analyzer Language Server is not available. \" +\n+            \"Please, ensure its [proper installation](https://github.com/rust-analyzer/rust-analyzer/tree/master/docs/user#vs-code).\"\n+        );\n+    }\n+\n     // Note: we try to start the server before we activate type hints so that it\n     // registers its `onDidChangeDocument` handler before us.\n     //\n     // This a horribly, horribly wrong way to deal with this problem.\n     try {\n-        await ctx.startServer();\n+        await ctx.startServer(serverPath);\n     } catch (e) {\n         vscode.window.showErrorMessage(e.message);\n     }"}]}