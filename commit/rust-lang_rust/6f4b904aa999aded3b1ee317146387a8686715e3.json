{"sha": "6f4b904aa999aded3b1ee317146387a8686715e3", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZmNGI5MDRhYTk5OWFkZWQzYjFlZTMxNzE0NjM4N2E4Njg2NzE1ZTM=", "commit": {"author": {"name": "Felix S. Klock II", "email": "pnkfelix@pnkfx.org", "date": "2020-01-16T19:33:18Z"}, "committer": {"name": "Felix S. Klock II", "email": "pnkfelix@pnkfx.org", "date": "2020-01-27T16:06:06Z"}, "message": "Collisions in the dep-graph due to path-reuse are rare but can occur.\n\nSo, instead of ICE'ing, just fail to mark green in such cases\n(for `DepKind::{Hir, HirBody, CrateMetadata}`).\n\nFix #62649.", "tree": {"sha": "51d361c070d85f9603885b9cedd7eaf1c68464d4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/51d361c070d85f9603885b9cedd7eaf1c68464d4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6f4b904aa999aded3b1ee317146387a8686715e3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6f4b904aa999aded3b1ee317146387a8686715e3", "html_url": "https://github.com/rust-lang/rust/commit/6f4b904aa999aded3b1ee317146387a8686715e3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6f4b904aa999aded3b1ee317146387a8686715e3/comments", "author": {"login": "pnkfelix", "id": 173127, "node_id": "MDQ6VXNlcjE3MzEyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pnkfelix", "html_url": "https://github.com/pnkfelix", "followers_url": "https://api.github.com/users/pnkfelix/followers", "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}", "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}", "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions", "organizations_url": "https://api.github.com/users/pnkfelix/orgs", "repos_url": "https://api.github.com/users/pnkfelix/repos", "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}", "received_events_url": "https://api.github.com/users/pnkfelix/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pnkfelix", "id": 173127, "node_id": "MDQ6VXNlcjE3MzEyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pnkfelix", "html_url": "https://github.com/pnkfelix", "followers_url": "https://api.github.com/users/pnkfelix/followers", "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}", "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}", "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions", "organizations_url": "https://api.github.com/users/pnkfelix/orgs", "repos_url": "https://api.github.com/users/pnkfelix/repos", "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}", "received_events_url": "https://api.github.com/users/pnkfelix/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1d5f6d41e140a3d6a9c6584d555bc09f10222d24", "url": "https://api.github.com/repos/rust-lang/rust/commits/1d5f6d41e140a3d6a9c6584d555bc09f10222d24", "html_url": "https://github.com/rust-lang/rust/commit/1d5f6d41e140a3d6a9c6584d555bc09f10222d24"}], "stats": {"total": 52, "additions": 43, "deletions": 9}, "files": [{"sha": "258723bb39d837308413b5c1c21a97d4b0ef3639", "filename": "src/librustc/dep_graph/graph.rs", "status": "modified", "additions": 30, "deletions": 9, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/6f4b904aa999aded3b1ee317146387a8686715e3/src%2Flibrustc%2Fdep_graph%2Fgraph.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6f4b904aa999aded3b1ee317146387a8686715e3/src%2Flibrustc%2Fdep_graph%2Fgraph.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fdep_graph%2Fgraph.rs?ref=6f4b904aa999aded3b1ee317146387a8686715e3", "patch": "@@ -6,6 +6,7 @@ use rustc_data_structures::sharded::{self, Sharded};\n use rustc_data_structures::stable_hasher::{HashStable, StableHasher};\n use rustc_data_structures::sync::{AtomicU32, AtomicU64, Lock, Lrc, Ordering};\n use rustc_errors::Diagnostic;\n+use rustc_hir::def_id::DefId;\n use rustc_index::vec::{Idx, IndexVec};\n use smallvec::SmallVec;\n use std::collections::hash_map::Entry;\n@@ -677,18 +678,33 @@ impl DepGraph {\n                     } else {\n                         match dep_dep_node.kind {\n                             DepKind::Hir | DepKind::HirBody | DepKind::CrateMetadata => {\n-                                if dep_dep_node.extract_def_id(tcx).is_none() {\n+                                if let Some(def_id) = dep_dep_node.extract_def_id(tcx) {\n+                                    if def_id_corresponds_to_hir_dep_node(tcx, def_id) {\n+                                        // The `DefPath` has corresponding node,\n+                                        // and that node should have been marked\n+                                        // either red or green in `data.colors`.\n+                                        bug!(\n+                                            \"DepNode {:?} should have been \\\n+                                             pre-marked as red or green but wasn't.\",\n+                                            dep_dep_node\n+                                        );\n+                                    } else {\n+                                        // This `DefPath` does not have a\n+                                        // corresponding `DepNode` (e.g. a\n+                                        // struct field), and the ` DefPath`\n+                                        // collided with the `DefPath` of a\n+                                        // proper item that existed in the\n+                                        // previous compilation session.\n+                                        //\n+                                        // Since the given `DefPath` does not\n+                                        // denote the item that previously\n+                                        // existed, we just fail to mark green.\n+                                        return None;\n+                                    }\n+                                } else {\n                                     // If the node does not exist anymore, we\n                                     // just fail to mark green.\n                                     return None;\n-                                } else {\n-                                    // If the node does exist, it should have\n-                                    // been pre-allocated.\n-                                    bug!(\n-                                        \"DepNode {:?} should have been \\\n-                                          pre-allocated but wasn't.\",\n-                                        dep_dep_node\n-                                    )\n                                 }\n                             }\n                             _ => {\n@@ -899,6 +915,11 @@ impl DepGraph {\n     }\n }\n \n+fn def_id_corresponds_to_hir_dep_node(tcx: TyCtxt<'_>, def_id: DefId) -> bool {\n+    let hir_id = tcx.hir().as_local_hir_id(def_id).unwrap();\n+    def_id.index == hir_id.owner\n+}\n+\n /// A \"work product\" is an intermediate result that we save into the\n /// incremental directory for later re-use. The primary example are\n /// the object files that we save for each partition at code"}, {"sha": "ee81be76bafe340b041b2fb545b57cf5067a7127", "filename": "src/test/incremental/issue-62649-path-collisions-happen.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/6f4b904aa999aded3b1ee317146387a8686715e3/src%2Ftest%2Fincremental%2Fissue-62649-path-collisions-happen.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6f4b904aa999aded3b1ee317146387a8686715e3/src%2Ftest%2Fincremental%2Fissue-62649-path-collisions-happen.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fincremental%2Fissue-62649-path-collisions-happen.rs?ref=6f4b904aa999aded3b1ee317146387a8686715e3", "patch": "@@ -0,0 +1,13 @@\n+// revisions: rpass1 rpass2\n+\n+#[cfg(rpass1)]\n+pub trait Something {\n+    fn foo();\n+}\n+\n+#[cfg(rpass2)]\n+pub struct Something {\n+    pub foo: u8,\n+}\n+\n+fn main() {}"}]}