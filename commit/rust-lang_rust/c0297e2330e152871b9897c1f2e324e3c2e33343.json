{"sha": "c0297e2330e152871b9897c1f2e324e3c2e33343", "node_id": "C_kwDOAAsO6NoAKGMwMjk3ZTIzMzBlMTUyODcxYjk4OTdjMWYyZTMyNGUzYzJlMzMzNDM", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-08-17T10:32:56Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-08-17T10:32:56Z"}, "message": "Rollup merge of #100646 - finalchild:emoji-diag, r=compiler-errors\n\nMigrate emoji identifier diagnostics to `SessionDiagnostic` in rustc_interface\n\n* Migrate emoji identifier diagnostics to `interface_ferris_identifier` and `interface_emoji_identifier`.\n\nThis is my first PR! I'm learning how to migrate these diagnostics. Thanks in advance.\n\nr? rust-lang/diagnostics", "tree": {"sha": "cbca5cc7097d5e7e78116a7d28996d3c27e53efa", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/cbca5cc7097d5e7e78116a7d28996d3c27e53efa"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c0297e2330e152871b9897c1f2e324e3c2e33343", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJi/MPYCRBK7hj4Ov3rIwAA3I8IAItFzA/GsNHjp5Tlu/tMFtan\n7b77ZokSm/6/LCpk1KmMdx2dRd3pJ6hP1HyMv+9C/ciPiCpeZ+mEACoI1+SWHtVl\nyO7J8cuv9KXpZdNu/Gr9OTqSXkGYf7SjgrHc5nO5vgjKlyJN56h/+HRNBDsoK3Y4\nMQWdDgDOVY0C6PCourljmeNUNKTXVxC6V0YZOrAQrP3GtnTMbdkvmuzz5opabf/R\nz0QY7QZ4Lsh445VP1WvPY1vQojrYvuYMvEGPRwRbENAGKYc51WzftlkCa10OICeu\ntHG/u5rwzztsvLCVFncYPGxGfH7lqDQnwexr3i6cHEyXUaej4K2u9TJdo0zXDag=\n=07R4\n-----END PGP SIGNATURE-----\n", "payload": "tree cbca5cc7097d5e7e78116a7d28996d3c27e53efa\nparent 64cd65758cefc02e4fa7518b20582465fbce5a6c\nparent c1a98416e3e615e2d195a05eec4bad4705c9fc95\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1660732376 +0200\ncommitter GitHub <noreply@github.com> 1660732376 +0200\n\nRollup merge of #100646 - finalchild:emoji-diag, r=compiler-errors\n\nMigrate emoji identifier diagnostics to `SessionDiagnostic` in rustc_interface\n\n* Migrate emoji identifier diagnostics to `interface_ferris_identifier` and `interface_emoji_identifier`.\n\nThis is my first PR! I'm learning how to migrate these diagnostics. Thanks in advance.\n\nr? rust-lang/diagnostics\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c0297e2330e152871b9897c1f2e324e3c2e33343", "html_url": "https://github.com/rust-lang/rust/commit/c0297e2330e152871b9897c1f2e324e3c2e33343", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c0297e2330e152871b9897c1f2e324e3c2e33343/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "64cd65758cefc02e4fa7518b20582465fbce5a6c", "url": "https://api.github.com/repos/rust-lang/rust/commits/64cd65758cefc02e4fa7518b20582465fbce5a6c", "html_url": "https://github.com/rust-lang/rust/commit/64cd65758cefc02e4fa7518b20582465fbce5a6c"}, {"sha": "c1a98416e3e615e2d195a05eec4bad4705c9fc95", "url": "https://api.github.com/repos/rust-lang/rust/commits/c1a98416e3e615e2d195a05eec4bad4705c9fc95", "html_url": "https://github.com/rust-lang/rust/commit/c1a98416e3e615e2d195a05eec4bad4705c9fc95"}], "stats": {"total": 49, "additions": 31, "deletions": 18}, "files": [{"sha": "3e2eb0df70d0a099ab354931b41ce624c031582c", "filename": "Cargo.lock", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/c0297e2330e152871b9897c1f2e324e3c2e33343/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/c0297e2330e152871b9897c1f2e324e3c2e33343/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=c0297e2330e152871b9897c1f2e324e3c2e33343", "patch": "@@ -4011,6 +4011,7 @@ dependencies = [\n  \"rustc_hir\",\n  \"rustc_incremental\",\n  \"rustc_lint\",\n+ \"rustc_macros\",\n  \"rustc_metadata\",\n  \"rustc_middle\",\n  \"rustc_mir_build\","}, {"sha": "2c05abd8c0996300b7e24dfaeb1922e013d1c6bd", "filename": "compiler/rustc_error_messages/locales/en-US/interface.ftl", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/c0297e2330e152871b9897c1f2e324e3c2e33343/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Finterface.ftl", "raw_url": "https://github.com/rust-lang/rust/raw/c0297e2330e152871b9897c1f2e324e3c2e33343/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Finterface.ftl", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Finterface.ftl?ref=c0297e2330e152871b9897c1f2e324e3c2e33343", "patch": "@@ -0,0 +1,6 @@\n+interface_ferris_identifier =\n+    Ferris cannot be used as an identifier\n+    .suggestion = try using their name instead\n+\n+interface_emoji_identifier =\n+    identifiers cannot contain emoji: `{$ident}`"}, {"sha": "6ae4dab3a35eb18898559beaa9dad4fe1e36eb0c", "filename": "compiler/rustc_error_messages/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/c0297e2330e152871b9897c1f2e324e3c2e33343/compiler%2Frustc_error_messages%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c0297e2330e152871b9897c1f2e324e3c2e33343/compiler%2Frustc_error_messages%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_error_messages%2Fsrc%2Flib.rs?ref=c0297e2330e152871b9897c1f2e324e3c2e33343", "patch": "@@ -34,6 +34,7 @@ fluent_messages! {\n     builtin_macros => \"../locales/en-US/builtin_macros.ftl\",\n     const_eval => \"../locales/en-US/const_eval.ftl\",\n     expand => \"../locales/en-US/expand.ftl\",\n+    interface => \"../locales/en-US/interface.ftl\",\n     lint => \"../locales/en-US/lint.ftl\",\n     parser => \"../locales/en-US/parser.ftl\",\n     passes => \"../locales/en-US/passes.ftl\","}, {"sha": "da4002d09ad029db6f397df74f946a333b4a6a26", "filename": "compiler/rustc_interface/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/c0297e2330e152871b9897c1f2e324e3c2e33343/compiler%2Frustc_interface%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/c0297e2330e152871b9897c1f2e324e3c2e33343/compiler%2Frustc_interface%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_interface%2FCargo.toml?ref=c0297e2330e152871b9897c1f2e324e3c2e33343", "patch": "@@ -17,6 +17,7 @@ rustc_attr = { path = \"../rustc_attr\" }\n rustc_borrowck = { path = \"../rustc_borrowck\" }\n rustc_builtin_macros = { path = \"../rustc_builtin_macros\" }\n rustc_expand = { path = \"../rustc_expand\" }\n+rustc_macros = { path = \"../rustc_macros\" }\n rustc_parse = { path = \"../rustc_parse\" }\n rustc_session = { path = \"../rustc_session\" }\n rustc_span = { path = \"../rustc_span\" }"}, {"sha": "e00d0b7d0d82fc51653becf3be09135a50de9f27", "filename": "compiler/rustc_interface/src/passes.rs", "status": "modified", "additions": 22, "deletions": 18, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/c0297e2330e152871b9897c1f2e324e3c2e33343/compiler%2Frustc_interface%2Fsrc%2Fpasses.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c0297e2330e152871b9897c1f2e324e3c2e33343/compiler%2Frustc_interface%2Fsrc%2Fpasses.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_interface%2Fsrc%2Fpasses.rs?ref=c0297e2330e152871b9897c1f2e324e3c2e33343", "patch": "@@ -8,11 +8,12 @@ use rustc_borrowck as mir_borrowck;\n use rustc_codegen_ssa::traits::CodegenBackend;\n use rustc_data_structures::parallel;\n use rustc_data_structures::sync::{Lrc, OnceCell, WorkerLocal};\n-use rustc_errors::{Applicability, ErrorGuaranteed, MultiSpan, PResult};\n+use rustc_errors::{ErrorGuaranteed, PResult};\n use rustc_expand::base::{ExtCtxt, LintStoreExpand, ResolverExpand};\n use rustc_hir::def_id::StableCrateId;\n use rustc_hir::definitions::Definitions;\n use rustc_lint::{BufferedEarlyLint, EarlyCheckNode, LintStore};\n+use rustc_macros::SessionDiagnostic;\n use rustc_metadata::creader::CStore;\n use rustc_middle::arena::Arena;\n use rustc_middle::dep_graph::DepGraph;\n@@ -30,7 +31,7 @@ use rustc_session::output::filename_for_input;\n use rustc_session::search_paths::PathKind;\n use rustc_session::{Limit, Session};\n use rustc_span::symbol::{sym, Symbol};\n-use rustc_span::FileName;\n+use rustc_span::{FileName, Span};\n use rustc_trait_selection::traits;\n use rustc_typeck as typeck;\n use tracing::{info, warn};\n@@ -263,6 +264,23 @@ impl LintStoreExpand for LintStoreExpandImpl<'_> {\n     }\n }\n \n+#[derive(SessionDiagnostic)]\n+#[error(interface::ferris_identifier)]\n+struct FerrisIdentifier {\n+    #[primary_span]\n+    spans: Vec<Span>,\n+    #[suggestion(code = \"ferris\", applicability = \"maybe-incorrect\")]\n+    first_span: Span,\n+}\n+\n+#[derive(SessionDiagnostic)]\n+#[error(interface::emoji_identifier)]\n+struct EmojiIdentifier {\n+    #[primary_span]\n+    spans: Vec<Span>,\n+    ident: Symbol,\n+}\n+\n /// Runs the \"early phases\" of the compiler: initial `cfg` processing, loading compiler plugins,\n /// syntax expansion, secondary `cfg` expansion, synthesis of a test\n /// harness if one is to be provided, injection of a dependency on the\n@@ -443,23 +461,9 @@ pub fn configure_and_expand(\n             spans.sort();\n             if ident == sym::ferris {\n                 let first_span = spans[0];\n-                sess.diagnostic()\n-                    .struct_span_err(\n-                        MultiSpan::from(spans),\n-                        \"Ferris cannot be used as an identifier\",\n-                    )\n-                    .span_suggestion(\n-                        first_span,\n-                        \"try using their name instead\",\n-                        \"ferris\",\n-                        Applicability::MaybeIncorrect,\n-                    )\n-                    .emit();\n+                sess.emit_err(FerrisIdentifier { spans, first_span });\n             } else {\n-                sess.diagnostic().span_err(\n-                    MultiSpan::from(spans),\n-                    &format!(\"identifiers cannot contain emoji: `{}`\", ident),\n-                );\n+                sess.emit_err(EmojiIdentifier { spans, ident });\n             }\n         }\n     });"}]}