{"sha": "9feb4988f2e9a0424030dc2a8dd762738c9fbf49", "node_id": "MDY6Q29tbWl0NzI0NzEyOjlmZWI0OTg4ZjJlOWEwNDI0MDMwZGMyYThkZDc2MjczOGM5ZmJmNDk=", "commit": {"author": {"name": "Nick Cameron", "email": "nrc@ncameron.org", "date": "2017-12-27T01:12:45Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2017-12-27T01:12:45Z"}, "message": "Merge pull request #2310 from topecongiro/issue-2309\n\nDo not give up rewriting struct field when attribute is long", "tree": {"sha": "56a34096ccf0d415f85a0258c81207269802e1ab", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/56a34096ccf0d415f85a0258c81207269802e1ab"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9feb4988f2e9a0424030dc2a8dd762738c9fbf49", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJaQvONCRBK7hj4Ov3rIwAAdHIIAAskJHOdnAS4jaOg4LqzYSCN\nQ75EDbwK5X8pl9GlFBN3E76t2UjeYJ9l2naByLdZSXOwGXzmQNGeZq4QHrz1P6Cf\ndlIevewgBYpcHIcISVjcJt0LascR2kX+aadFYeNiLTtnCgj3no+X/3KD5nGNyuW+\nGp+kVYbaWdYmQBbyUEMYD8MQBF0FtGiYZEOAK02RQdf479ONIW1Iv6S7/+PIlmD+\nQQBnWZ+bpQrPPZn8GEkQwn6M4bDC5eN3/gOFGE+9CUmiIg+6stsV0qKp0vlooc11\np6R95MsVpAKXidG8K0518R5J7luEEBah4W4bzcVLQVPd3pfRo5kVmU19Yv+/Hpg=\n=MzGC\n-----END PGP SIGNATURE-----\n", "payload": "tree 56a34096ccf0d415f85a0258c81207269802e1ab\nparent a6244c2f58a98d570fc391cecf9024cf38cb3e3c\nparent f523ec58ab25596ae9f7139dae322376a94c5b1a\nauthor Nick Cameron <nrc@ncameron.org> 1514337165 +1300\ncommitter GitHub <noreply@github.com> 1514337165 +1300\n\nMerge pull request #2310 from topecongiro/issue-2309\n\nDo not give up rewriting struct field when attribute is long"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9feb4988f2e9a0424030dc2a8dd762738c9fbf49", "html_url": "https://github.com/rust-lang/rust/commit/9feb4988f2e9a0424030dc2a8dd762738c9fbf49", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9feb4988f2e9a0424030dc2a8dd762738c9fbf49/comments", "author": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a6244c2f58a98d570fc391cecf9024cf38cb3e3c", "url": "https://api.github.com/repos/rust-lang/rust/commits/a6244c2f58a98d570fc391cecf9024cf38cb3e3c", "html_url": "https://github.com/rust-lang/rust/commit/a6244c2f58a98d570fc391cecf9024cf38cb3e3c"}, {"sha": "f523ec58ab25596ae9f7139dae322376a94c5b1a", "url": "https://api.github.com/repos/rust-lang/rust/commits/f523ec58ab25596ae9f7139dae322376a94c5b1a", "html_url": "https://github.com/rust-lang/rust/commit/f523ec58ab25596ae9f7139dae322376a94c5b1a"}], "stats": {"total": 36, "additions": 24, "deletions": 12}, "files": [{"sha": "e313179fae904ad2b6da4e98b4a204177f08b27b", "filename": "src/items.rs", "status": "modified", "additions": 12, "deletions": 12, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/9feb4988f2e9a0424030dc2a8dd762738c9fbf49/src%2Fitems.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9feb4988f2e9a0424030dc2a8dd762738c9fbf49/src%2Fitems.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fitems.rs?ref=9feb4988f2e9a0424030dc2a8dd762738c9fbf49", "patch": "@@ -22,7 +22,7 @@ use codemap::{LineRangeUtils, SpanUtils};\n use comment::{combine_strs_with_missing_comments, contains_comment, recover_comment_removed,\n               recover_missing_comment_in_span, rewrite_missing_comment, FindUncommented};\n use config::{BraceStyle, Config, Density, IndentStyle};\n-use expr::{choose_rhs, format_expr, is_empty_block, is_simple_block_stmt, rewrite_assign_rhs,\n+use expr::{format_expr, is_empty_block, is_simple_block_stmt, rewrite_assign_rhs,\n            rewrite_call_inner, ExprType};\n use lists::{definitive_tactic, itemize_list, write_list, DefinitiveListTactic, ListFormatting,\n             ListItem, ListTactic, Separator, SeparatorPlace, SeparatorTactic};\n@@ -1430,8 +1430,7 @@ pub fn rewrite_struct_field(\n     lhs_max_width: usize,\n ) -> Option<String> {\n     if contains_skip(&field.attrs) {\n-        let snippet = context.snippet(mk_sp(field.attrs[0].span.lo(), field.span.hi()));\n-        return Some(snippet.to_owned());\n+        return Some(context.snippet(field.span()).to_owned());\n     }\n \n     let type_annotation_spacing = type_annotation_spacing(context.config);\n@@ -1468,24 +1467,25 @@ pub fn rewrite_struct_field(\n     if prefix.is_empty() && !attrs_str.is_empty() && attrs_extendable && spacing.is_empty() {\n         spacing.push(' ');\n     }\n-    let ty_shape = shape.offset_left(overhead + spacing.len())?;\n-    let mut orig_ty = field.ty.rewrite(context, ty_shape);\n+    let orig_ty = shape\n+        .offset_left(overhead + spacing.len())\n+        .and_then(|ty_shape| field.ty.rewrite(context, ty_shape));\n     if let Some(ref ty) = orig_ty {\n         if !ty.contains('\\n') {\n             return Some(attr_prefix + &spacing + ty);\n         }\n     }\n \n+    let is_prefix_empty = prefix.is_empty();\n     // We must use multiline. We are going to put attributes and a field on different lines.\n-    // 1 = \" \"\n-    let rhs_shape = shape.offset_left(last_line_width(&prefix) + 1)?;\n-    orig_ty = field.ty.rewrite(context, rhs_shape);\n-    let field_str = if prefix.is_empty() {\n-        orig_ty?\n+    let field_str = rewrite_assign_rhs(context, prefix, &*field.ty, shape)?;\n+    // Remove a leading white-space from `rewrite_assign_rhs()` when rewriting a tuple struct.\n+    let field_str = if is_prefix_empty {\n+        field_str.trim_left()\n     } else {\n-        prefix + &choose_rhs(context, &*field.ty, rhs_shape, orig_ty)?\n+        &field_str\n     };\n-    combine_strs_with_missing_comments(context, &attrs_str, &field_str, missing_span, shape, false)\n+    combine_strs_with_missing_comments(context, &attrs_str, field_str, missing_span, shape, false)\n }\n \n pub struct StaticParts<'a> {"}, {"sha": "76d6eda88538ea9cf01d10670477d43f9c20b008", "filename": "tests/source/struct-field-attributes.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/9feb4988f2e9a0424030dc2a8dd762738c9fbf49/tests%2Fsource%2Fstruct-field-attributes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9feb4988f2e9a0424030dc2a8dd762738c9fbf49/tests%2Fsource%2Fstruct-field-attributes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fstruct-field-attributes.rs?ref=9feb4988f2e9a0424030dc2a8dd762738c9fbf49", "patch": "@@ -44,3 +44,9 @@ pub enum State {\n struct Fields(\n     #[cfg_attr(feature = \"serde_derive\", serde(state_with = \"::base::serialization::shared\"))] Arc<Vec<InternedStr>>,\n );\n+\n+// #2309\n+pub struct A {\n+#[doc=\"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX\"]\n+pub foos:Vec<bool>\n+}"}, {"sha": "8bf10fae3e1286c03643f33663be7e3238304813", "filename": "tests/target/struct-field-attributes.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/9feb4988f2e9a0424030dc2a8dd762738c9fbf49/tests%2Ftarget%2Fstruct-field-attributes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9feb4988f2e9a0424030dc2a8dd762738c9fbf49/tests%2Ftarget%2Fstruct-field-attributes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fstruct-field-attributes.rs?ref=9feb4988f2e9a0424030dc2a8dd762738c9fbf49", "patch": "@@ -46,3 +46,9 @@ struct Fields(\n     #[cfg_attr(feature = \"serde_derive\", serde(state_with = \"::base::serialization::shared\"))]\n     Arc<Vec<InternedStr>>,\n );\n+\n+// #2309\n+pub struct A {\n+    #[doc = \"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX\"]\n+    pub foos: Vec<bool>,\n+}"}]}