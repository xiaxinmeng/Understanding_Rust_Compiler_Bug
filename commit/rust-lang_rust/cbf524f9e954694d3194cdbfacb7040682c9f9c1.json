{"sha": "cbf524f9e954694d3194cdbfacb7040682c9f9c1", "node_id": "MDY6Q29tbWl0NzI0NzEyOmNiZjUyNGY5ZTk1NDY5NGQzMTk0Y2RiZmFjYjcwNDA2ODJjOWY5YzE=", "commit": {"author": {"name": "Nick Cameron", "email": "nrc@ncameron.org", "date": "2018-02-18T19:45:21Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2018-02-18T19:45:21Z"}, "message": "Merge pull request #2464 from topecongiro/beginning-vert\n\nFormat a match arm with the beginning vertical bar", "tree": {"sha": "74d81f018e9388e3fda7d28456593f5e08f0842b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/74d81f018e9388e3fda7d28456593f5e08f0842b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cbf524f9e954694d3194cdbfacb7040682c9f9c1", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJaidfRCRBK7hj4Ov3rIwAAdHIIADVzlKND+9i4XVJgMtHmij9W\nIHuwHp7b5NyJZ15ChZHfQIZOYU5R0DS6AKld3dQFeXmmjiSVi/DIFP8MmApyuaTI\nxugmAB+53zEqb5R1XgruhqdAuVoprk1veB+/adDf2OL1XRCkZZbFo3Vm7yQyKvNd\nD865gs9Hh/1Imw31zOdvUHMBVAkG+WFneU+GxeWcYvfakDRuUpn8zBrYXnEkaWF1\n0xUcp03HlEWhkBTqZeEzxavxJoUFCHZYoGpQXTBurwsBz8J/tKCYsO0qE9pGgTSh\nwfgtMnbqKtX81moroz7SR+2oEaK6gX5jPLitCeu5KUURJrL6gMx2ap0fGR4jmSY=\n=NetL\n-----END PGP SIGNATURE-----\n", "payload": "tree 74d81f018e9388e3fda7d28456593f5e08f0842b\nparent 263104a365797151246d28e7d0d05673390a358d\nparent ea3c01e3374143912f048b22fda106ee8d5a1cd8\nauthor Nick Cameron <nrc@ncameron.org> 1518983121 +1300\ncommitter GitHub <noreply@github.com> 1518983121 +1300\n\nMerge pull request #2464 from topecongiro/beginning-vert\n\nFormat a match arm with the beginning vertical bar"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cbf524f9e954694d3194cdbfacb7040682c9f9c1", "html_url": "https://github.com/rust-lang/rust/commit/cbf524f9e954694d3194cdbfacb7040682c9f9c1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cbf524f9e954694d3194cdbfacb7040682c9f9c1/comments", "author": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "263104a365797151246d28e7d0d05673390a358d", "url": "https://api.github.com/repos/rust-lang/rust/commits/263104a365797151246d28e7d0d05673390a358d", "html_url": "https://github.com/rust-lang/rust/commit/263104a365797151246d28e7d0d05673390a358d"}, {"sha": "ea3c01e3374143912f048b22fda106ee8d5a1cd8", "url": "https://api.github.com/repos/rust-lang/rust/commits/ea3c01e3374143912f048b22fda106ee8d5a1cd8", "html_url": "https://github.com/rust-lang/rust/commit/ea3c01e3374143912f048b22fda106ee8d5a1cd8"}], "stats": {"total": 64, "additions": 50, "deletions": 14}, "files": [{"sha": "d21c272631039568f99150b21da1df611ff8cf31", "filename": "rustfmt-core/src/expr.rs", "status": "modified", "additions": 23, "deletions": 13, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/cbf524f9e954694d3194cdbfacb7040682c9f9c1/rustfmt-core%2Fsrc%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cbf524f9e954694d3194cdbfacb7040682c9f9c1/rustfmt-core%2Fsrc%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/rustfmt-core%2Fsrc%2Fexpr.rs?ref=cbf524f9e954694d3194cdbfacb7040682c9f9c1", "patch": "@@ -1406,17 +1406,22 @@ fn rewrite_match_arm(\n     } else {\n         (mk_sp(arm.span().lo(), arm.span().lo()), String::new())\n     };\n-    let pats_str =\n-        rewrite_match_pattern(context, &arm.pats, &arm.guard, shape).and_then(|pats_str| {\n-            combine_strs_with_missing_comments(\n-                context,\n-                &attrs_str,\n-                &pats_str,\n-                missing_span,\n-                shape,\n-                false,\n-            )\n-        })?;\n+    let pats_str = rewrite_match_pattern(\n+        context,\n+        &arm.pats,\n+        &arm.guard,\n+        arm.beginning_vert.is_some(),\n+        shape,\n+    ).and_then(|pats_str| {\n+        combine_strs_with_missing_comments(\n+            context,\n+            &attrs_str,\n+            &pats_str,\n+            missing_span,\n+            shape,\n+            false,\n+        )\n+    })?;\n     rewrite_match_body(\n         context,\n         &arm.body,\n@@ -1463,11 +1468,15 @@ fn rewrite_match_pattern(\n     context: &RewriteContext,\n     pats: &[ptr::P<ast::Pat>],\n     guard: &Option<ptr::P<ast::Expr>>,\n+    has_beginning_vert: bool,\n     shape: Shape,\n ) -> Option<String> {\n     // Patterns\n     // 5 = ` => {`\n-    let pat_shape = shape.sub_width(5)?;\n+    // 2 = `| `\n+    let pat_shape = shape\n+        .sub_width(5)?\n+        .offset_left(if has_beginning_vert { 2 } else { 0 })?;\n \n     let pat_strs = pats.iter()\n         .map(|p| p.rewrite(context, pat_shape))\n@@ -1498,11 +1507,12 @@ fn rewrite_match_pattern(\n         config: context.config,\n     };\n     let pats_str = write_list(&items, &fmt)?;\n+    let beginning_vert = if has_beginning_vert { \"| \" } else { \"\" };\n \n     // Guard\n     let guard_str = rewrite_guard(context, guard, shape, trimmed_last_line_width(&pats_str))?;\n \n-    Some(format!(\"{}{}\", pats_str, guard_str))\n+    Some(format!(\"{}{}{}\", beginning_vert, pats_str, guard_str))\n }\n \n // (extend, body)"}, {"sha": "20dd843879860a2331e2bb9e8b1ef8ac8680ead0", "filename": "rustfmt-core/src/spanned.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/cbf524f9e954694d3194cdbfacb7040682c9f9c1/rustfmt-core%2Fsrc%2Fspanned.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cbf524f9e954694d3194cdbfacb7040682c9f9c1/rustfmt-core%2Fsrc%2Fspanned.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/rustfmt-core%2Fsrc%2Fspanned.rs?ref=cbf524f9e954694d3194cdbfacb7040682c9f9c1", "patch": "@@ -89,7 +89,12 @@ impl Spanned for ast::Ty {\n \n impl Spanned for ast::Arm {\n     fn span(&self) -> Span {\n-        span_with_attrs_lo_hi!(self, self.pats[0].span.lo(), self.body.span.hi())\n+        let lo = if let Some(sp) = self.beginning_vert {\n+            sp.lo()\n+        } else {\n+            self.pats[0].span.lo()\n+        };\n+        span_with_attrs_lo_hi!(self, lo, self.body.span.hi())\n     }\n }\n "}, {"sha": "f38bf7cca977ced74331d40e721ebea011b95e55", "filename": "rustfmt-core/tests/source/match.rs", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/cbf524f9e954694d3194cdbfacb7040682c9f9c1/rustfmt-core%2Ftests%2Fsource%2Fmatch.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cbf524f9e954694d3194cdbfacb7040682c9f9c1/rustfmt-core%2Ftests%2Fsource%2Fmatch.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/rustfmt-core%2Ftests%2Fsource%2Fmatch.rs?ref=cbf524f9e954694d3194cdbfacb7040682c9f9c1", "patch": "@@ -451,3 +451,14 @@ fn issue_2152() {\n         \"bind\" | \"writev\" | \"readv\" | \"sendmsg\" | \"recvmsg\" if android && (aarch64 || x86_64) => true,\n     }\n }\n+\n+// #2462\n+// Preserve a `|` at the beginning of a match arm.\n+fn match_with_beginning_vert() {\n+    let x = Foo::A;\n+    match x {\n+        | Foo::A\n+        | Foo::B => println!(\"AB\"),\n+        | Foo::C => println!(\"C\"),\n+    }\n+}"}, {"sha": "72ffa966c01d2dfdc65a7aba3167042aeda81aa8", "filename": "rustfmt-core/tests/target/match.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/cbf524f9e954694d3194cdbfacb7040682c9f9c1/rustfmt-core%2Ftests%2Ftarget%2Fmatch.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cbf524f9e954694d3194cdbfacb7040682c9f9c1/rustfmt-core%2Ftests%2Ftarget%2Fmatch.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/rustfmt-core%2Ftests%2Ftarget%2Fmatch.rs?ref=cbf524f9e954694d3194cdbfacb7040682c9f9c1", "patch": "@@ -483,3 +483,13 @@ fn issue_2152() {\n         }\n     }\n }\n+\n+// #2462\n+// Preserve a `|` at the beginning of a match arm.\n+fn match_with_beginning_vert() {\n+    let x = Foo::A;\n+    match x {\n+        | Foo::A | Foo::B => println!(\"AB\"),\n+        | Foo::C => println!(\"C\"),\n+    }\n+}"}]}