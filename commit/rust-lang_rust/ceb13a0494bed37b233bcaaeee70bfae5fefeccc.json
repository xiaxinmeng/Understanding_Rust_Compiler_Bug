{"sha": "ceb13a0494bed37b233bcaaeee70bfae5fefeccc", "node_id": "MDY6Q29tbWl0NzI0NzEyOmNlYjEzYTA0OTRiZWQzN2IyMzNiY2FhZWVlNzBiZmFlNWZlZmVjY2M=", "commit": {"author": {"name": "Marco Groppo", "email": "marco.groppo@gmail.com", "date": "2019-11-24T18:02:04Z"}, "committer": {"name": "Marco Groppo", "email": "marco.groppo@gmail.com", "date": "2019-11-24T22:49:58Z"}, "message": "Fix panic during the expansion of `column!`", "tree": {"sha": "d93fdd5f21c9cb04e0458e3f1921a9d3600016d9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d93fdd5f21c9cb04e0458e3f1921a9d3600016d9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ceb13a0494bed37b233bcaaeee70bfae5fefeccc", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ceb13a0494bed37b233bcaaeee70bfae5fefeccc", "html_url": "https://github.com/rust-lang/rust/commit/ceb13a0494bed37b233bcaaeee70bfae5fefeccc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ceb13a0494bed37b233bcaaeee70bfae5fefeccc/comments", "author": {"login": "marcogroppo", "id": 2735511, "node_id": "MDQ6VXNlcjI3MzU1MTE=", "avatar_url": "https://avatars.githubusercontent.com/u/2735511?v=4", "gravatar_id": "", "url": "https://api.github.com/users/marcogroppo", "html_url": "https://github.com/marcogroppo", "followers_url": "https://api.github.com/users/marcogroppo/followers", "following_url": "https://api.github.com/users/marcogroppo/following{/other_user}", "gists_url": "https://api.github.com/users/marcogroppo/gists{/gist_id}", "starred_url": "https://api.github.com/users/marcogroppo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/marcogroppo/subscriptions", "organizations_url": "https://api.github.com/users/marcogroppo/orgs", "repos_url": "https://api.github.com/users/marcogroppo/repos", "events_url": "https://api.github.com/users/marcogroppo/events{/privacy}", "received_events_url": "https://api.github.com/users/marcogroppo/received_events", "type": "User", "site_admin": false}, "committer": {"login": "marcogroppo", "id": 2735511, "node_id": "MDQ6VXNlcjI3MzU1MTE=", "avatar_url": "https://avatars.githubusercontent.com/u/2735511?v=4", "gravatar_id": "", "url": "https://api.github.com/users/marcogroppo", "html_url": "https://github.com/marcogroppo", "followers_url": "https://api.github.com/users/marcogroppo/followers", "following_url": "https://api.github.com/users/marcogroppo/following{/other_user}", "gists_url": "https://api.github.com/users/marcogroppo/gists{/gist_id}", "starred_url": "https://api.github.com/users/marcogroppo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/marcogroppo/subscriptions", "organizations_url": "https://api.github.com/users/marcogroppo/orgs", "repos_url": "https://api.github.com/users/marcogroppo/repos", "events_url": "https://api.github.com/users/marcogroppo/events{/privacy}", "received_events_url": "https://api.github.com/users/marcogroppo/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "775bd98e5cf7918acf0dd72009ac14cf758ed0ca", "url": "https://api.github.com/repos/rust-lang/rust/commits/775bd98e5cf7918acf0dd72009ac14cf758ed0ca", "html_url": "https://github.com/rust-lang/rust/commit/775bd98e5cf7918acf0dd72009ac14cf758ed0ca"}], "stats": {"total": 21, "additions": 16, "deletions": 5}, "files": [{"sha": "9b5305a80d2e4f2f1637b1bb4633c7397a5d4b1a", "filename": "crates/ra_hir_expand/src/builtin_macro.rs", "status": "modified", "additions": 16, "deletions": 5, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/ceb13a0494bed37b233bcaaeee70bfae5fefeccc/crates%2Fra_hir_expand%2Fsrc%2Fbuiltin_macro.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ceb13a0494bed37b233bcaaeee70bfae5fefeccc/crates%2Fra_hir_expand%2Fsrc%2Fbuiltin_macro.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_expand%2Fsrc%2Fbuiltin_macro.rs?ref=ceb13a0494bed37b233bcaaeee70bfae5fefeccc", "patch": "@@ -57,16 +57,21 @@ fn to_line_number(db: &dyn AstDatabase, file: HirFileId, pos: TextUnit) -> usize\n     let text = db.file_text(file_id);\n     let mut line_num = 1;\n \n+    let pos = pos.to_usize();\n+    if pos > text.len() {\n+        // FIXME: `pos` at the moment could be an offset inside the \"wrong\" file\n+        // in this case, when we know it's wrong, we return a dummy value\n+        return 0;\n+    }\n     // Count line end\n     for (i, c) in text.chars().enumerate() {\n-        if i == pos.to_usize() {\n+        if i == pos {\n             break;\n         }\n         if c == '\\n' {\n             line_num += 1;\n         }\n     }\n-\n     line_num\n }\n \n@@ -118,15 +123,21 @@ fn to_col_number(db: &dyn AstDatabase, file: HirFileId, pos: TextUnit) -> usize\n     // FIXME: Use expansion info\n     let file_id = file.original_file(db);\n     let text = db.file_text(file_id);\n-    let mut col_num = 1;\n \n-    for c in text[..pos.to_usize()].chars().rev() {\n+    let pos = pos.to_usize();\n+    if pos > text.len() {\n+        // FIXME: `pos` at the moment could be an offset inside the \"wrong\" file\n+        // in this case we return a dummy value so that we don't `panic!`\n+        return 0;\n+    }\n+\n+    let mut col_num = 1;\n+    for c in text[..pos].chars().rev() {\n         if c == '\\n' {\n             break;\n         }\n         col_num = col_num + 1;\n     }\n-\n     col_num\n }\n "}]}