{"sha": "262b35ea2c4dd9a16c28bf40cb5c124f664ce96c", "node_id": "C_kwDOAAsO6NoAKDI2MmIzNWVhMmM0ZGQ5YTE2YzI4YmY0MGNiNWMxMjRmNjY0Y2U5NmM", "commit": {"author": {"name": "infrandomness", "email": "infrandomness@gmail.com", "date": "2022-04-08T18:07:19Z"}, "committer": {"name": "infrandomness", "email": "infrandomness@gmail.com", "date": "2022-04-14T10:41:47Z"}, "message": "Introduce option_take_on_temporary lints\n\nThis lint checks if Option::take() is used on a temporary value (a value\nthat is not of type &mut Option and that is not a Place expression) to\nsuggest omitting take()", "tree": {"sha": "79bce483611d424de9a03b55855a97bc3ff7bde2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/79bce483611d424de9a03b55855a97bc3ff7bde2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/262b35ea2c4dd9a16c28bf40cb5c124f664ce96c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/262b35ea2c4dd9a16c28bf40cb5c124f664ce96c", "html_url": "https://github.com/rust-lang/rust/commit/262b35ea2c4dd9a16c28bf40cb5c124f664ce96c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/262b35ea2c4dd9a16c28bf40cb5c124f664ce96c/comments", "author": {"login": "InfRandomness", "id": 43730933, "node_id": "MDQ6VXNlcjQzNzMwOTMz", "avatar_url": "https://avatars.githubusercontent.com/u/43730933?v=4", "gravatar_id": "", "url": "https://api.github.com/users/InfRandomness", "html_url": "https://github.com/InfRandomness", "followers_url": "https://api.github.com/users/InfRandomness/followers", "following_url": "https://api.github.com/users/InfRandomness/following{/other_user}", "gists_url": "https://api.github.com/users/InfRandomness/gists{/gist_id}", "starred_url": "https://api.github.com/users/InfRandomness/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/InfRandomness/subscriptions", "organizations_url": "https://api.github.com/users/InfRandomness/orgs", "repos_url": "https://api.github.com/users/InfRandomness/repos", "events_url": "https://api.github.com/users/InfRandomness/events{/privacy}", "received_events_url": "https://api.github.com/users/InfRandomness/received_events", "type": "User", "site_admin": false}, "committer": {"login": "InfRandomness", "id": 43730933, "node_id": "MDQ6VXNlcjQzNzMwOTMz", "avatar_url": "https://avatars.githubusercontent.com/u/43730933?v=4", "gravatar_id": "", "url": "https://api.github.com/users/InfRandomness", "html_url": "https://github.com/InfRandomness", "followers_url": "https://api.github.com/users/InfRandomness/followers", "following_url": "https://api.github.com/users/InfRandomness/following{/other_user}", "gists_url": "https://api.github.com/users/InfRandomness/gists{/gist_id}", "starred_url": "https://api.github.com/users/InfRandomness/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/InfRandomness/subscriptions", "organizations_url": "https://api.github.com/users/InfRandomness/orgs", "repos_url": "https://api.github.com/users/InfRandomness/repos", "events_url": "https://api.github.com/users/InfRandomness/events{/privacy}", "received_events_url": "https://api.github.com/users/InfRandomness/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "849668ad718ad90ed8a61147968fde2eef772479", "url": "https://api.github.com/repos/rust-lang/rust/commits/849668ad718ad90ed8a61147968fde2eef772479", "html_url": "https://github.com/rust-lang/rust/commit/849668ad718ad90ed8a61147968fde2eef772479"}], "stats": {"total": 79, "additions": 79, "deletions": 0}, "files": [{"sha": "d4096ca89df83527efd30a2ad21ef103767c7a1d", "filename": "CHANGELOG.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/262b35ea2c4dd9a16c28bf40cb5c124f664ce96c/CHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/262b35ea2c4dd9a16c28bf40cb5c124f664ce96c/CHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/CHANGELOG.md?ref=262b35ea2c4dd9a16c28bf40cb5c124f664ce96c", "patch": "@@ -3473,6 +3473,7 @@ Released 2018-09-13\n [`needless_lifetimes`]: https://rust-lang.github.io/rust-clippy/master/index.html#needless_lifetimes\n [`needless_match`]: https://rust-lang.github.io/rust-clippy/master/index.html#needless_match\n [`needless_option_as_deref`]: https://rust-lang.github.io/rust-clippy/master/index.html#needless_option_as_deref\n+[`needless_option_take`]: https://rust-lang.github.io/rust-clippy/master/index.html#needless_option_take\n [`needless_pass_by_value`]: https://rust-lang.github.io/rust-clippy/master/index.html#needless_pass_by_value\n [`needless_question_mark`]: https://rust-lang.github.io/rust-clippy/master/index.html#needless_question_mark\n [`needless_range_loop`]: https://rust-lang.github.io/rust-clippy/master/index.html#needless_range_loop"}, {"sha": "84e3176c003037cba34fbac21961782c03286418", "filename": "clippy_lints/src/lib.register_all.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/262b35ea2c4dd9a16c28bf40cb5c124f664ce96c/clippy_lints%2Fsrc%2Flib.register_all.rs", "raw_url": "https://github.com/rust-lang/rust/raw/262b35ea2c4dd9a16c28bf40cb5c124f664ce96c/clippy_lints%2Fsrc%2Flib.register_all.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.register_all.rs?ref=262b35ea2c4dd9a16c28bf40cb5c124f664ce96c", "patch": "@@ -183,6 +183,7 @@ store.register_group(true, \"clippy::all\", Some(\"clippy_all\"), vec![\n     LintId::of(methods::MAP_FLATTEN),\n     LintId::of(methods::MAP_IDENTITY),\n     LintId::of(methods::NEEDLESS_OPTION_AS_DEREF),\n+    LintId::of(methods::NEEDLESS_OPTION_TAKE),\n     LintId::of(methods::NEEDLESS_SPLITN),\n     LintId::of(methods::NEW_RET_NO_SELF),\n     LintId::of(methods::OK_EXPECT),"}, {"sha": "2f6ebd445ebd80ad50816b9d2e9ec9293962e0a0", "filename": "clippy_lints/src/lib.register_complexity.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/262b35ea2c4dd9a16c28bf40cb5c124f664ce96c/clippy_lints%2Fsrc%2Flib.register_complexity.rs", "raw_url": "https://github.com/rust-lang/rust/raw/262b35ea2c4dd9a16c28bf40cb5c124f664ce96c/clippy_lints%2Fsrc%2Flib.register_complexity.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.register_complexity.rs?ref=262b35ea2c4dd9a16c28bf40cb5c124f664ce96c", "patch": "@@ -45,6 +45,7 @@ store.register_group(true, \"clippy::complexity\", Some(\"clippy_complexity\"), vec!\n     LintId::of(methods::MAP_FLATTEN),\n     LintId::of(methods::MAP_IDENTITY),\n     LintId::of(methods::NEEDLESS_OPTION_AS_DEREF),\n+    LintId::of(methods::NEEDLESS_OPTION_TAKE),\n     LintId::of(methods::NEEDLESS_SPLITN),\n     LintId::of(methods::OPTION_AS_REF_DEREF),\n     LintId::of(methods::OPTION_FILTER_MAP),"}, {"sha": "aa9435f3b59a0b1f69f53ab1b70bb5150ecd2082", "filename": "clippy_lints/src/lib.register_lints.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/262b35ea2c4dd9a16c28bf40cb5c124f664ce96c/clippy_lints%2Fsrc%2Flib.register_lints.rs", "raw_url": "https://github.com/rust-lang/rust/raw/262b35ea2c4dd9a16c28bf40cb5c124f664ce96c/clippy_lints%2Fsrc%2Flib.register_lints.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.register_lints.rs?ref=262b35ea2c4dd9a16c28bf40cb5c124f664ce96c", "patch": "@@ -322,6 +322,7 @@ store.register_lints(&[\n     methods::MAP_IDENTITY,\n     methods::MAP_UNWRAP_OR,\n     methods::NEEDLESS_OPTION_AS_DEREF,\n+    methods::NEEDLESS_OPTION_TAKE,\n     methods::NEEDLESS_SPLITN,\n     methods::NEW_RET_NO_SELF,\n     methods::OK_EXPECT,"}, {"sha": "6588ca4a4a7199aeb46308a17d091870ce156297", "filename": "clippy_lints/src/lib.register_suspicious.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/262b35ea2c4dd9a16c28bf40cb5c124f664ce96c/clippy_lints%2Fsrc%2Flib.register_suspicious.rs", "raw_url": "https://github.com/rust-lang/rust/raw/262b35ea2c4dd9a16c28bf40cb5c124f664ce96c/clippy_lints%2Fsrc%2Flib.register_suspicious.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.register_suspicious.rs?ref=262b35ea2c4dd9a16c28bf40cb5c124f664ce96c", "patch": "@@ -22,6 +22,7 @@ store.register_group(true, \"clippy::suspicious\", Some(\"clippy_suspicious\"), vec!\n     LintId::of(loops::EMPTY_LOOP),\n     LintId::of(loops::FOR_LOOPS_OVER_FALLIBLES),\n     LintId::of(loops::MUT_RANGE_BOUND),\n+    LintId::of(methods::OPTION_TAKE_ON_TEMPORARY),\n     LintId::of(methods::SUSPICIOUS_MAP),\n     LintId::of(mut_key::MUTABLE_KEY_TYPE),\n     LintId::of(octal_escapes::OCTAL_ESCAPES),"}, {"sha": "3d4c193691af42b335cbe95b4fc60290bf6e8eb0", "filename": "clippy_lints/src/methods/mod.rs", "status": "modified", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/262b35ea2c4dd9a16c28bf40cb5c124f664ce96c/clippy_lints%2Fsrc%2Fmethods%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/262b35ea2c4dd9a16c28bf40cb5c124f664ce96c/clippy_lints%2Fsrc%2Fmethods%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmethods%2Fmod.rs?ref=262b35ea2c4dd9a16c28bf40cb5c124f664ce96c", "patch": "@@ -43,6 +43,7 @@ mod map_flatten;\n mod map_identity;\n mod map_unwrap_or;\n mod needless_option_as_deref;\n+mod needless_option_take;\n mod ok_expect;\n mod option_as_ref_deref;\n mod option_map_or_none;\n@@ -2162,6 +2163,24 @@ declare_clippy_lint! {\n     \"use of `char::is_digit(..)` with literal radix of 10 or 16\"\n }\n \n+declare_clippy_lint! {\n+    ///\n+    /// ### Why is this bad?\n+    ///\n+    /// ### Example\n+    /// ```rust\n+    /// // example code where clippy issues a warning\n+    /// ```\n+    /// Use instead:\n+    /// ```rust\n+    /// // example code which does not raise clippy warning\n+    /// ```\n+    #[clippy::version = \"1.61.0\"]\n+    pub NEEDLESS_OPTION_TAKE,\n+    suspicious,\n+    \"using `.as_ref().take()` on a temporary value\"\n+}\n+\n pub struct Methods {\n     avoid_breaking_exported_api: bool,\n     msrv: Option<RustcVersion>,\n@@ -2251,6 +2270,7 @@ impl_lint_pass!(Methods => [\n     ERR_EXPECT,\n     NEEDLESS_OPTION_AS_DEREF,\n     IS_DIGIT_ASCII_RADIX,\n+    NEEDLESS_OPTION_TAKE,\n ]);\n \n /// Extracts a method call name, args, and `Span` of the method name.\n@@ -2623,6 +2643,7 @@ fn check_methods<'tcx>(cx: &LateContext<'tcx>, expr: &'tcx Expr<'_>, msrv: Optio\n                     }\n                 }\n             },\n+            (\"take\", []) => needless_option_take::check(cx, expr, recv),\n             (\"to_os_string\" | \"to_owned\" | \"to_path_buf\" | \"to_vec\", []) => {\n                 implicit_clone::check(cx, name, expr, recv);\n             },"}, {"sha": "b3696273e1d05cb5b29ab98536dc7ebe8c9d7dee", "filename": "clippy_lints/src/methods/needless_option_take.rs", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/262b35ea2c4dd9a16c28bf40cb5c124f664ce96c/clippy_lints%2Fsrc%2Fmethods%2Fneedless_option_take.rs", "raw_url": "https://github.com/rust-lang/rust/raw/262b35ea2c4dd9a16c28bf40cb5c124f664ce96c/clippy_lints%2Fsrc%2Fmethods%2Fneedless_option_take.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmethods%2Fneedless_option_take.rs?ref=262b35ea2c4dd9a16c28bf40cb5c124f664ce96c", "patch": "@@ -0,0 +1,23 @@\n+use clippy_utils::diagnostics::span_lint;\n+use clippy_utils::ty::is_type_diagnostic_item;\n+use rustc_hir::Expr;\n+use rustc_lint::LateContext;\n+use rustc_span::sym::Result as sym_result;\n+\n+use super::NEEDLESS_OPTION_TAKE;\n+\n+pub(super) fn check<'tcx>(cx: &LateContext<'tcx>, expr: &'tcx Expr<'_>, recv: &'tcx Expr<'_>) {\n+    if_chain! {\n+        if is_type_diagnostic_item(cx, cx.typeck_results().expr_ty(recv), sym_result);\n+        let result_type = cx.typeck_results().expr_ty(recv);\n+\n+        then {\n+            span_lint(\n+                cx,\n+                NEEDLESS_OPTION_TAKE,\n+                expr.span,\n+                \"Format test\"\n+            );\n+        }\n+    };\n+}"}, {"sha": "29691e81666f7797bc99428b961545f9249331d7", "filename": "tests/ui/needless_option_take.fixed", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/262b35ea2c4dd9a16c28bf40cb5c124f664ce96c/tests%2Fui%2Fneedless_option_take.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/262b35ea2c4dd9a16c28bf40cb5c124f664ce96c/tests%2Fui%2Fneedless_option_take.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fneedless_option_take.fixed?ref=262b35ea2c4dd9a16c28bf40cb5c124f664ce96c", "patch": "@@ -0,0 +1,15 @@\n+// run-rustfix\n+\n+fn main() {\n+    println!(\"Testing non erroneous option_take_on_temporary\");\n+    let mut option = Some(1);\n+    let _ = Box::new(move || option.take().unwrap());\n+\n+    println!(\"Testing non erroneous option_take_on_temporary\");\n+    let x = Some(3);\n+    x.as_ref();\n+\n+    println!(\"Testing erroneous option_take_on_temporary\");\n+    let x = Some(3);\n+    x.as_ref();\n+}"}, {"sha": "2b32b9467f50672b3868116c3a35ae793e23f4d3", "filename": "tests/ui/needless_option_take.rs", "status": "added", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/262b35ea2c4dd9a16c28bf40cb5c124f664ce96c/tests%2Fui%2Fneedless_option_take.rs", "raw_url": "https://github.com/rust-lang/rust/raw/262b35ea2c4dd9a16c28bf40cb5c124f664ce96c/tests%2Fui%2Fneedless_option_take.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fneedless_option_take.rs?ref=262b35ea2c4dd9a16c28bf40cb5c124f664ce96c", "patch": "@@ -0,0 +1,5 @@\n+fn main() {\n+    println!(\"Testing option_take_on_temporary\");\n+    let x = Some(3);\n+    let y = x.as_ref().take();\n+}"}, {"sha": "cb3bf015b369d811634894efd63cb298eb171fd6", "filename": "tests/ui/needless_option_take.stderr", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/262b35ea2c4dd9a16c28bf40cb5c124f664ce96c/tests%2Fui%2Fneedless_option_take.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/262b35ea2c4dd9a16c28bf40cb5c124f664ce96c/tests%2Fui%2Fneedless_option_take.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fneedless_option_take.stderr?ref=262b35ea2c4dd9a16c28bf40cb5c124f664ce96c", "patch": "@@ -0,0 +1,10 @@\n+error: called `Option::take()` on a temporary value\n+  --> $DIR/needless_option_take.rs:14:5\n+   |\n+LL |     x.as_ref().take();\n+   |     ^^^^^^^^^^^^^^^^^ help: try: `x.as_ref()`\n+   |\n+   = note: `-D clippy::needless-option-take` implied by `-D warnings`\n+\n+error: aborting due to previous error\n+"}]}