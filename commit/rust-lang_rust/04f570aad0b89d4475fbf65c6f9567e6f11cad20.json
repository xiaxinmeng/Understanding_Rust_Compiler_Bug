{"sha": "04f570aad0b89d4475fbf65c6f9567e6f11cad20", "node_id": "C_kwDOAAsO6NoAKDA0ZjU3MGFhZDBiODlkNDQ3NWZiZjY1YzZmOTU2N2U2ZjExY2FkMjA", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume.gomez@huawei.com", "date": "2022-07-31T23:59:33Z"}, "committer": {"name": "Guillaume Gomez", "email": "guillaume.gomez@huawei.com", "date": "2022-08-02T11:03:13Z"}, "message": "Remove Clean trait implementation for ast::Attribute and cleanup Attributes::from_ast function by splitting it in two", "tree": {"sha": "95d80b14e10309700c1ad6dfe1de05e4fae644e8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/95d80b14e10309700c1ad6dfe1de05e4fae644e8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/04f570aad0b89d4475fbf65c6f9567e6f11cad20", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/04f570aad0b89d4475fbf65c6f9567e6f11cad20", "html_url": "https://github.com/rust-lang/rust/commit/04f570aad0b89d4475fbf65c6f9567e6f11cad20", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/04f570aad0b89d4475fbf65c6f9567e6f11cad20/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "482153bc208df5fc236cc0e1cddb24e93fcc332f", "url": "https://api.github.com/repos/rust-lang/rust/commits/482153bc208df5fc236cc0e1cddb24e93fcc332f", "html_url": "https://github.com/rust-lang/rust/commit/482153bc208df5fc236cc0e1cddb24e93fcc332f"}], "stats": {"total": 34, "additions": 15, "deletions": 19}, "files": [{"sha": "8d5e91f58c6105d853e80a18b8a76d22c92a347a", "filename": "src/librustdoc/clean/inline.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/04f570aad0b89d4475fbf65c6f9567e6f11cad20/src%2Flibrustdoc%2Fclean%2Finline.rs", "raw_url": "https://github.com/rust-lang/rust/raw/04f570aad0b89d4475fbf65c6f9567e6f11cad20/src%2Flibrustdoc%2Fclean%2Finline.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Finline.rs?ref=04f570aad0b89d4475fbf65c6f9567e6f11cad20", "patch": "@@ -304,14 +304,14 @@ fn merge_attrs(\n         both.extend_from_slice(old_attrs);\n         (\n             if let Some(new_id) = parent_module {\n-                Attributes::from_ast(old_attrs, Some((inner, new_id)))\n+                Attributes::from_ast_with_additional(old_attrs, (inner, new_id))\n             } else {\n-                Attributes::from_ast(&both, None)\n+                Attributes::from_ast(&both)\n             },\n             both.cfg(cx.tcx, &cx.cache.hidden_cfg),\n         )\n     } else {\n-        (old_attrs.clean(cx), old_attrs.cfg(cx.tcx, &cx.cache.hidden_cfg))\n+        (Attributes::from_ast(&old_attrs), old_attrs.cfg(cx.tcx, &cx.cache.hidden_cfg))\n     }\n }\n "}, {"sha": "8626e8e305d1249b3166371bcce1966e6a2e3a9b", "filename": "src/librustdoc/clean/mod.rs", "status": "modified", "additions": 1, "deletions": 7, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/04f570aad0b89d4475fbf65c6f9567e6f11cad20/src%2Flibrustdoc%2Fclean%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/04f570aad0b89d4475fbf65c6f9567e6f11cad20/src%2Flibrustdoc%2Fclean%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Fmod.rs?ref=04f570aad0b89d4475fbf65c6f9567e6f11cad20", "patch": "@@ -121,12 +121,6 @@ impl<'tcx> Clean<'tcx, Item> for DocModule<'tcx> {\n     }\n }\n \n-impl<'tcx> Clean<'tcx, Attributes> for [ast::Attribute] {\n-    fn clean(&self, _cx: &mut DocContext<'_>) -> Attributes {\n-        Attributes::from_ast(self, None)\n-    }\n-}\n-\n impl<'tcx> Clean<'tcx, Option<GenericBound>> for hir::GenericBound<'tcx> {\n     fn clean(&self, cx: &mut DocContext<'tcx>) -> Option<GenericBound> {\n         Some(match *self {\n@@ -2097,7 +2091,7 @@ fn clean_extern_crate<'tcx>(\n     // FIXME: using `from_def_id_and_kind` breaks `rustdoc/masked` for some reason\n     vec![Item {\n         name: Some(name),\n-        attrs: Box::new(attrs.clean(cx)),\n+        attrs: Box::new(Attributes::from_ast(attrs)),\n         item_id: crate_def_id.into(),\n         visibility: clean_visibility(ty_vis),\n         kind: Box::new(ExternCrateItem { src: orig_name }),"}, {"sha": "712ec41023fa456fda28152a5cca6d7cdd0ae904", "filename": "src/librustdoc/clean/types.rs", "status": "modified", "additions": 9, "deletions": 7, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/04f570aad0b89d4475fbf65c6f9567e6f11cad20/src%2Flibrustdoc%2Fclean%2Ftypes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/04f570aad0b89d4475fbf65c6f9567e6f11cad20/src%2Flibrustdoc%2Fclean%2Ftypes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Ftypes.rs?ref=04f570aad0b89d4475fbf65c6f9567e6f11cad20", "patch": "@@ -34,10 +34,10 @@ use rustc_target::spec::abi::Abi;\n use rustc_typeck::check::intrinsic::intrinsic_operation_unsafety;\n \n use crate::clean::cfg::Cfg;\n+use crate::clean::clean_visibility;\n use crate::clean::external_path;\n use crate::clean::inline::{self, print_inlined_const};\n use crate::clean::utils::{is_literal_expr, print_const_expr, print_evaluated_const};\n-use crate::clean::{clean_visibility, Clean};\n use crate::core::DocContext;\n use crate::formats::cache::Cache;\n use crate::formats::item_type::ItemType;\n@@ -477,7 +477,7 @@ impl Item {\n             def_id,\n             name,\n             kind,\n-            Box::new(ast_attrs.clean(cx)),\n+            Box::new(Attributes::from_ast(ast_attrs)),\n             cx,\n             ast_attrs.cfg(cx.tcx, &cx.cache.hidden_cfg),\n         )\n@@ -1177,14 +1177,16 @@ impl Attributes {\n         false\n     }\n \n-    pub(crate) fn from_ast(\n+    pub(crate) fn from_ast(attrs: &[ast::Attribute]) -> Attributes {\n+        Attributes::from_ast_iter(attrs.iter().map(|attr| (attr, None)), false)\n+    }\n+\n+    pub(crate) fn from_ast_with_additional(\n         attrs: &[ast::Attribute],\n-        additional_attrs: Option<(&[ast::Attribute], DefId)>,\n+        (additional_attrs, def_id): (&[ast::Attribute], DefId),\n     ) -> Attributes {\n         // Additional documentation should be shown before the original documentation.\n-        let attrs1 = additional_attrs\n-            .into_iter()\n-            .flat_map(|(attrs, def_id)| attrs.iter().map(move |attr| (attr, Some(def_id))));\n+        let attrs1 = additional_attrs.iter().map(|attr| (attr, Some(def_id)));\n         let attrs2 = attrs.iter().map(|attr| (attr, None));\n         Attributes::from_ast_iter(attrs1.chain(attrs2), false)\n     }"}, {"sha": "35964e3ba38e4ad284dd0d0cb3698c2f5abdbe7f", "filename": "src/librustdoc/doctest.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/04f570aad0b89d4475fbf65c6f9567e6f11cad20/src%2Flibrustdoc%2Fdoctest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/04f570aad0b89d4475fbf65c6f9567e6f11cad20/src%2Flibrustdoc%2Fdoctest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fdoctest.rs?ref=04f570aad0b89d4475fbf65c6f9567e6f11cad20", "patch": "@@ -1222,7 +1222,7 @@ impl<'a, 'hir, 'tcx> HirCollector<'a, 'hir, 'tcx> {\n \n         // The collapse-docs pass won't combine sugared/raw doc attributes, or included files with\n         // anything else, this will combine them for us.\n-        let attrs = Attributes::from_ast(ast_attrs, None);\n+        let attrs = Attributes::from_ast(ast_attrs);\n         if let Some(doc) = attrs.collapsed_doc_value() {\n             // Use the outermost invocation, so that doctest names come from where the docs were written.\n             let span = ast_attrs"}, {"sha": "99cf4291927fb3dc2d84c60548c529711c96994d", "filename": "src/librustdoc/html/render/print_item.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/04f570aad0b89d4475fbf65c6f9567e6f11cad20/src%2Flibrustdoc%2Fhtml%2Frender%2Fprint_item.rs", "raw_url": "https://github.com/rust-lang/rust/raw/04f570aad0b89d4475fbf65c6f9567e6f11cad20/src%2Flibrustdoc%2Fhtml%2Frender%2Fprint_item.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fprint_item.rs?ref=04f570aad0b89d4475fbf65c6f9567e6f11cad20", "patch": "@@ -345,7 +345,7 @@ fn item_module(w: &mut Buffer, cx: &mut Context<'_>, item: &clean::Item, items:\n             clean::ImportItem(ref import) => {\n                 let (stab, stab_tags) = if let Some(import_def_id) = import.source.did {\n                     let ast_attrs = cx.tcx().get_attrs_unchecked(import_def_id);\n-                    let import_attrs = Box::new(clean::Attributes::from_ast(ast_attrs, None));\n+                    let import_attrs = Box::new(clean::Attributes::from_ast(ast_attrs));\n \n                     // Just need an item with the correct def_id and attrs\n                     let import_item = clean::Item {"}]}