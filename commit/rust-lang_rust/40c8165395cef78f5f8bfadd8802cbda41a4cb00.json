{"sha": "40c8165395cef78f5f8bfadd8802cbda41a4cb00", "node_id": "C_kwDOAAsO6NoAKDQwYzgxNjUzOTVjZWY3OGY1ZjhiZmFkZDg4MDJjYmRhNDFhNGNiMDA", "commit": {"author": {"name": "Camille GILLOT", "email": "gillot.camille@gmail.com", "date": "2022-12-09T16:36:28Z"}, "committer": {"name": "Camille GILLOT", "email": "gillot.camille@gmail.com", "date": "2022-12-25T18:48:36Z"}, "message": "Only enable relative span hashing on nightly.", "tree": {"sha": "be135ae7ea4f7d5a9ad3d532ffe48668449a14a7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/be135ae7ea4f7d5a9ad3d532ffe48668449a14a7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/40c8165395cef78f5f8bfadd8802cbda41a4cb00", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/40c8165395cef78f5f8bfadd8802cbda41a4cb00", "html_url": "https://github.com/rust-lang/rust/commit/40c8165395cef78f5f8bfadd8802cbda41a4cb00", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/40c8165395cef78f5f8bfadd8802cbda41a4cb00/comments", "author": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "committer": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "65f342daeaaab5b546e2e76d04140d1c788780b9", "url": "https://api.github.com/repos/rust-lang/rust/commits/65f342daeaaab5b546e2e76d04140d1c788780b9", "html_url": "https://github.com/rust-lang/rust/commit/65f342daeaaab5b546e2e76d04140d1c788780b9"}], "stats": {"total": 15, "additions": 12, "deletions": 3}, "files": [{"sha": "bb087326cb1450980caaf08ea432e5fa704cecb5", "filename": "compiler/rustc_ast_lowering/src/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/40c8165395cef78f5f8bfadd8802cbda41a4cb00/compiler%2Frustc_ast_lowering%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/40c8165395cef78f5f8bfadd8802cbda41a4cb00/compiler%2Frustc_ast_lowering%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast_lowering%2Fsrc%2Flib.rs?ref=40c8165395cef78f5f8bfadd8802cbda41a4cb00", "patch": "@@ -776,7 +776,7 @@ impl<'a, 'hir> LoweringContext<'a, 'hir> {\n     /// Intercept all spans entering HIR.\n     /// Mark a span as relative to the current owning item.\n     fn lower_span(&self, span: Span) -> Span {\n-        if self.tcx.sess.opts.incremental.is_some() {\n+        if self.tcx.sess.opts.incremental_relative_spans() {\n             span.with_parent(Some(self.current_hir_id_owner.def_id))\n         } else {\n             // Do not make spans relative when not using incremental compilation."}, {"sha": "5d47c1ed363fbf0463ddde0118bba718d9ca10ec", "filename": "compiler/rustc_expand/src/expand.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/40c8165395cef78f5f8bfadd8802cbda41a4cb00/compiler%2Frustc_expand%2Fsrc%2Fexpand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/40c8165395cef78f5f8bfadd8802cbda41a4cb00/compiler%2Frustc_expand%2Fsrc%2Fexpand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_expand%2Fsrc%2Fexpand.rs?ref=40c8165395cef78f5f8bfadd8802cbda41a4cb00", "patch": "@@ -587,7 +587,7 @@ impl<'a, 'b> MacroExpander<'a, 'b> {\n                 .resolver\n                 .visit_ast_fragment_with_placeholders(self.cx.current_expansion.id, &fragment);\n \n-            if self.cx.sess.opts.incremental.is_some() {\n+            if self.cx.sess.opts.incremental_relative_spans() {\n                 for (invoc, _) in invocations.iter_mut() {\n                     let expn_id = invoc.expansion_data.id;\n                     let parent_def = self.cx.resolver.invocation_parent(expn_id);"}, {"sha": "c35681b4b355f15f0b56301f67dccbf2806de434", "filename": "compiler/rustc_middle/src/hir/map/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/40c8165395cef78f5f8bfadd8802cbda41a4cb00/compiler%2Frustc_middle%2Fsrc%2Fhir%2Fmap%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/40c8165395cef78f5f8bfadd8802cbda41a4cb00/compiler%2Frustc_middle%2Fsrc%2Fhir%2Fmap%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fhir%2Fmap%2Fmod.rs?ref=40c8165395cef78f5f8bfadd8802cbda41a4cb00", "patch": "@@ -1162,7 +1162,7 @@ pub(super) fn crate_hash(tcx: TyCtxt<'_>, crate_num: CrateNum) -> Svh {\n         hir_body_hash.hash_stable(&mut hcx, &mut stable_hasher);\n         upstream_crates.hash_stable(&mut hcx, &mut stable_hasher);\n         source_file_names.hash_stable(&mut hcx, &mut stable_hasher);\n-        if tcx.sess.opts.incremental.is_some() {\n+        if tcx.sess.opts.incremental_relative_spans() {\n             let definitions = tcx.definitions_untracked();\n             let mut owner_spans: Vec<_> = krate\n                 .owners"}, {"sha": "02e3992a6a940d5b6a53c723fdba5c624f979c03", "filename": "compiler/rustc_session/src/config.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/40c8165395cef78f5f8bfadd8802cbda41a4cb00/compiler%2Frustc_session%2Fsrc%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/40c8165395cef78f5f8bfadd8802cbda41a4cb00/compiler%2Frustc_session%2Fsrc%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Fconfig.rs?ref=40c8165395cef78f5f8bfadd8802cbda41a4cb00", "patch": "@@ -787,6 +787,12 @@ impl Options {\n     pub fn get_symbol_mangling_version(&self) -> SymbolManglingVersion {\n         self.cg.symbol_mangling_version.unwrap_or(SymbolManglingVersion::Legacy)\n     }\n+\n+    #[allow(rustc::bad_opt_access)]\n+    pub fn incremental_relative_spans(&self) -> bool {\n+        self.unstable_opts.incremental_relative_spans\n+            || (self.unstable_features.is_nightly_build() && self.incremental.is_some())\n+    }\n }\n \n impl UnstableOptions {"}, {"sha": "83a3fd752651f826ffca2187f163adfd91fe3fc2", "filename": "compiler/rustc_session/src/options.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/40c8165395cef78f5f8bfadd8802cbda41a4cb00/compiler%2Frustc_session%2Fsrc%2Foptions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/40c8165395cef78f5f8bfadd8802cbda41a4cb00/compiler%2Frustc_session%2Fsrc%2Foptions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Foptions.rs?ref=40c8165395cef78f5f8bfadd8802cbda41a4cb00", "patch": "@@ -1338,6 +1338,9 @@ options! {\n     incremental_info: bool = (false, parse_bool, [UNTRACKED],\n         \"print high-level information about incremental reuse (or the lack thereof) \\\n         (default: no)\"),\n+    #[rustc_lint_opt_deny_field_access(\"use `Session::incremental_relative_spans` instead of this field\")]\n+    incremental_relative_spans: bool = (false, parse_bool, [TRACKED],\n+        \"hash spans relative to their parent item for incr. comp. (default: no)\"),\n     incremental_verify_ich: bool = (false, parse_bool, [UNTRACKED],\n         \"verify incr. comp. hashes of green query instances (default: no)\"),\n     inline_in_all_cgus: Option<bool> = (None, parse_opt_bool, [TRACKED],"}]}