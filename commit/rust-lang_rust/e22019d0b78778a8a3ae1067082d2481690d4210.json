{"sha": "e22019d0b78778a8a3ae1067082d2481690d4210", "node_id": "C_kwDOAAsO6NoAKGUyMjAxOWQwYjc4Nzc4YThhM2FlMTA2NzA4MmQyNDgxNjkwZDQyMTA", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-04-10T21:52:47Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-04-10T21:52:47Z"}, "message": "Auto merge of #10593 - feniljain:fix-needless-return, r=xFrednet\n\nfix(needless_return): do not trigger on ambiguous match arms return\n\nIf we see a case where match returns something other than `()`, we just skip `needless_return` lint in that case\n\nShould fix #10546\n\nRelevant Zulip Discussion: https://rust-lang.zulipchat.com/#narrow/stream/257328-clippy/topic/Issue.20.2310546\n\n---\n\nchangelog: FP: [`needless_return`]: No longer lints match statements with incompatible branches\n[#10593](https://github.com/rust-lang/rust-clippy/pull/10593)\n<!-- changelog_checked -->", "tree": {"sha": "e54ee7bdc39a24e85aa8da2212470e21436d50d9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e54ee7bdc39a24e85aa8da2212470e21436d50d9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e22019d0b78778a8a3ae1067082d2481690d4210", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e22019d0b78778a8a3ae1067082d2481690d4210", "html_url": "https://github.com/rust-lang/rust/commit/e22019d0b78778a8a3ae1067082d2481690d4210", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e22019d0b78778a8a3ae1067082d2481690d4210/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4904d754e07fd802bcd377c7e19d877a2f2895c8", "url": "https://api.github.com/repos/rust-lang/rust/commits/4904d754e07fd802bcd377c7e19d877a2f2895c8", "html_url": "https://github.com/rust-lang/rust/commit/4904d754e07fd802bcd377c7e19d877a2f2895c8"}, {"sha": "9cf57d0a8f95c51b0faeda4ce5c5b4cd629f1cae", "url": "https://api.github.com/repos/rust-lang/rust/commits/9cf57d0a8f95c51b0faeda4ce5c5b4cd629f1cae", "html_url": "https://github.com/rust-lang/rust/commit/9cf57d0a8f95c51b0faeda4ce5c5b4cd629f1cae"}], "stats": {"total": 50, "additions": 43, "deletions": 7}, "files": [{"sha": "df126d7617ebe6ca13cd69e50e204d8c5bc04994", "filename": "clippy_lints/src/returns.rs", "status": "modified", "additions": 25, "deletions": 7, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/e22019d0b78778a8a3ae1067082d2481690d4210/clippy_lints%2Fsrc%2Freturns.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e22019d0b78778a8a3ae1067082d2481690d4210/clippy_lints%2Fsrc%2Freturns.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Freturns.rs?ref=e22019d0b78778a8a3ae1067082d2481690d4210", "patch": "@@ -9,7 +9,7 @@ use rustc_hir::intravisit::FnKind;\n use rustc_hir::{Block, Body, Expr, ExprKind, FnDecl, LangItem, MatchSource, PatKind, QPath, StmtKind};\n use rustc_lint::{LateContext, LateLintPass, LintContext};\n use rustc_middle::lint::in_external_macro;\n-use rustc_middle::ty::subst::GenericArgKind;\n+use rustc_middle::ty::{self, subst::GenericArgKind, Ty};\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n use rustc_span::def_id::LocalDefId;\n use rustc_span::source_map::Span;\n@@ -175,7 +175,7 @@ impl<'tcx> LateLintPass<'tcx> for Return {\n                 } else {\n                     RetReplacement::Empty\n                 };\n-                check_final_expr(cx, body.value, vec![], replacement);\n+                check_final_expr(cx, body.value, vec![], replacement, None);\n             },\n             FnKind::ItemFn(..) | FnKind::Method(..) => {\n                 check_block_return(cx, &body.value.kind, sp, vec![]);\n@@ -188,11 +188,11 @@ impl<'tcx> LateLintPass<'tcx> for Return {\n fn check_block_return<'tcx>(cx: &LateContext<'tcx>, expr_kind: &ExprKind<'tcx>, sp: Span, mut semi_spans: Vec<Span>) {\n     if let ExprKind::Block(block, _) = expr_kind {\n         if let Some(block_expr) = block.expr {\n-            check_final_expr(cx, block_expr, semi_spans, RetReplacement::Empty);\n+            check_final_expr(cx, block_expr, semi_spans, RetReplacement::Empty, None);\n         } else if let Some(stmt) = block.stmts.iter().last() {\n             match stmt.kind {\n                 StmtKind::Expr(expr) => {\n-                    check_final_expr(cx, expr, semi_spans, RetReplacement::Empty);\n+                    check_final_expr(cx, expr, semi_spans, RetReplacement::Empty, None);\n                 },\n                 StmtKind::Semi(semi_expr) => {\n                     // Remove ending semicolons and any whitespace ' ' in between.\n@@ -202,7 +202,7 @@ fn check_block_return<'tcx>(cx: &LateContext<'tcx>, expr_kind: &ExprKind<'tcx>,\n                             span_find_starting_semi(cx.sess().source_map(), semi_span.with_hi(sp.hi()));\n                         semi_spans.push(semi_span_to_remove);\n                     }\n-                    check_final_expr(cx, semi_expr, semi_spans, RetReplacement::Empty);\n+                    check_final_expr(cx, semi_expr, semi_spans, RetReplacement::Empty, None);\n                 },\n                 _ => (),\n             }\n@@ -216,6 +216,7 @@ fn check_final_expr<'tcx>(\n     semi_spans: Vec<Span>, /* containing all the places where we would need to remove semicolons if finding an\n                             * needless return */\n     replacement: RetReplacement<'tcx>,\n+    match_ty_opt: Option<Ty<'_>>,\n ) {\n     let peeled_drop_expr = expr.peel_drop_temps();\n     match &peeled_drop_expr.kind {\n@@ -244,7 +245,22 @@ fn check_final_expr<'tcx>(\n                     RetReplacement::Expr(snippet, applicability)\n                 }\n             } else {\n-                replacement\n+                match match_ty_opt {\n+                    Some(match_ty) => {\n+                        match match_ty.kind() {\n+                            // If the code got till here with\n+                            // tuple not getting detected before it,\n+                            // then we are sure it's going to be Unit\n+                            // type\n+                            ty::Tuple(_) => RetReplacement::Unit,\n+                            // We don't want to anything in this case\n+                            // cause we can't predict what the user would\n+                            // want here\n+                            _ => return,\n+                        }\n+                    },\n+                    None => replacement,\n+                }\n             };\n \n             if !cx.tcx.hir().attrs(expr.hir_id).is_empty() {\n@@ -268,8 +284,9 @@ fn check_final_expr<'tcx>(\n         // note, if without else is going to be a type checking error anyways\n         // (except for unit type functions) so we don't match it\n         ExprKind::Match(_, arms, MatchSource::Normal) => {\n+            let match_ty = cx.typeck_results().expr_ty(peeled_drop_expr);\n             for arm in arms.iter() {\n-                check_final_expr(cx, arm.body, semi_spans.clone(), RetReplacement::Unit);\n+                check_final_expr(cx, arm.body, semi_spans.clone(), RetReplacement::Unit, Some(match_ty));\n             }\n         },\n         // if it's a whole block, check it\n@@ -293,6 +310,7 @@ fn emit_return_lint(cx: &LateContext<'_>, ret_span: Span, semi_spans: Vec<Span>,\n     if ret_span.from_expansion() {\n         return;\n     }\n+\n     let applicability = replacement.applicability().unwrap_or(Applicability::MachineApplicable);\n     let return_replacement = replacement.to_string();\n     let sugg_help = replacement.sugg_help();"}, {"sha": "57c08996ce25d38660d096451594efdeea17948d", "filename": "tests/ui/needless_return.fixed", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/e22019d0b78778a8a3ae1067082d2481690d4210/tests%2Fui%2Fneedless_return.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/e22019d0b78778a8a3ae1067082d2481690d4210/tests%2Fui%2Fneedless_return.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fneedless_return.fixed?ref=e22019d0b78778a8a3ae1067082d2481690d4210", "patch": "@@ -307,4 +307,13 @@ mod issue10049 {\n     }\n }\n \n+fn test_match_as_stmt() {\n+    let x = 9;\n+    match x {\n+        1 => 2,\n+        2 => return,\n+        _ => 0,\n+    };\n+}\n+\n fn main() {}"}, {"sha": "7c1feefbe32bb026fa06e4393c3e8fe0d83e24b0", "filename": "tests/ui/needless_return.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/e22019d0b78778a8a3ae1067082d2481690d4210/tests%2Fui%2Fneedless_return.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e22019d0b78778a8a3ae1067082d2481690d4210/tests%2Fui%2Fneedless_return.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fneedless_return.rs?ref=e22019d0b78778a8a3ae1067082d2481690d4210", "patch": "@@ -317,4 +317,13 @@ mod issue10049 {\n     }\n }\n \n+fn test_match_as_stmt() {\n+    let x = 9;\n+    match x {\n+        1 => 2,\n+        2 => return,\n+        _ => 0,\n+    };\n+}\n+\n fn main() {}"}]}