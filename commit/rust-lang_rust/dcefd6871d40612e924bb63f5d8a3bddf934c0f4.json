{"sha": "dcefd6871d40612e924bb63f5d8a3bddf934c0f4", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRjZWZkNjg3MWQ0MDYxMmU5MjRiYjYzZjVkOGEzYmRkZjkzNGMwZjQ=", "commit": {"author": {"name": "Mara Bos", "email": "m-ou.se@m-ou.se", "date": "2021-09-01T07:23:22Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-09-01T07:23:22Z"}, "message": "Rollup merge of #86376 - asquared31415:extern-no-mangle-84204, r=Mark-Simulacrum\n\nEmit specific warning to clarify that `#[no_mangle]` should not be applied on foreign statics or functions\n\nForeign statics and foreign functions should not have `#[no_mangle]` applied, as it does nothing to the name and has some extra hidden behavior that is normally unwanted.  There was an existing warning for this, but it says the attribute is only allowed on \"statics or functions\", which to the user can be confusing.\n\nThis PR adds a specific version of the unused `#[no_mangle]` warning that explains that the target is a *foreign* static or function and that they do not need the attribute.\n\nFixes #78989", "tree": {"sha": "953aa1266c594791fe1cffcd77bf5fd70fc06e75", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/953aa1266c594791fe1cffcd77bf5fd70fc06e75"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/dcefd6871d40612e924bb63f5d8a3bddf934c0f4", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhLyprCRBK7hj4Ov3rIwAAF8MIAK3DSt92mx2OD/GPvjcsiRf1\nSV4MrYYK+9SbXv0TLfbP35qJNbNl6NdDcZnDS5mN6hNMsiwT+GsOeMUKkanbVTvg\nXCOkFqtKV5+Vic8dFb+vbBA73ci53Y/16sPP+EJ5kXp1DjMV1oIImGQ7eiJXbV4x\nW1/7MSb+6KztMlb3YxLc0kBZZgM2noVpPXwTAwOrkW73Uy1DJfDZmjTmGhnoHssD\nP/puulBGPX/M9nts5d5UjO6AkrW9WaeNt9qLvRWGNZF03gqlO1GjYr/ilREVgJL2\nJhEMOdK9KwSJu5v7d+zTZ7kOheyHCyc8rsAMXV/D8L1d1zv7k407uyivqddMFGI=\n=6OG7\n-----END PGP SIGNATURE-----\n", "payload": "tree 953aa1266c594791fe1cffcd77bf5fd70fc06e75\nparent c4f26b15e37101c54829efab456922a53e3103ad\nparent fc125a52ec3a342c91ca399cafaeb0504a253991\nauthor Mara Bos <m-ou.se@m-ou.se> 1630481002 +0200\ncommitter GitHub <noreply@github.com> 1630481002 +0200\n\nRollup merge of #86376 - asquared31415:extern-no-mangle-84204, r=Mark-Simulacrum\n\nEmit specific warning to clarify that `#[no_mangle]` should not be applied on foreign statics or functions\n\nForeign statics and foreign functions should not have `#[no_mangle]` applied, as it does nothing to the name and has some extra hidden behavior that is normally unwanted.  There was an existing warning for this, but it says the attribute is only allowed on \"statics or functions\", which to the user can be confusing.\n\nThis PR adds a specific version of the unused `#[no_mangle]` warning that explains that the target is a *foreign* static or function and that they do not need the attribute.\n\nFixes #78989\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/dcefd6871d40612e924bb63f5d8a3bddf934c0f4", "html_url": "https://github.com/rust-lang/rust/commit/dcefd6871d40612e924bb63f5d8a3bddf934c0f4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/dcefd6871d40612e924bb63f5d8a3bddf934c0f4/comments", "author": {"login": "m-ou-se", "id": 783247, "node_id": "MDQ6VXNlcjc4MzI0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/783247?v=4", "gravatar_id": "", "url": "https://api.github.com/users/m-ou-se", "html_url": "https://github.com/m-ou-se", "followers_url": "https://api.github.com/users/m-ou-se/followers", "following_url": "https://api.github.com/users/m-ou-se/following{/other_user}", "gists_url": "https://api.github.com/users/m-ou-se/gists{/gist_id}", "starred_url": "https://api.github.com/users/m-ou-se/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/m-ou-se/subscriptions", "organizations_url": "https://api.github.com/users/m-ou-se/orgs", "repos_url": "https://api.github.com/users/m-ou-se/repos", "events_url": "https://api.github.com/users/m-ou-se/events{/privacy}", "received_events_url": "https://api.github.com/users/m-ou-se/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c4f26b15e37101c54829efab456922a53e3103ad", "url": "https://api.github.com/repos/rust-lang/rust/commits/c4f26b15e37101c54829efab456922a53e3103ad", "html_url": "https://github.com/rust-lang/rust/commit/c4f26b15e37101c54829efab456922a53e3103ad"}, {"sha": "fc125a52ec3a342c91ca399cafaeb0504a253991", "url": "https://api.github.com/repos/rust-lang/rust/commits/fc125a52ec3a342c91ca399cafaeb0504a253991", "html_url": "https://github.com/rust-lang/rust/commit/fc125a52ec3a342c91ca399cafaeb0504a253991"}], "stats": {"total": 102, "additions": 102, "deletions": 0}, "files": [{"sha": "fd438bdc9005ac5557c389bfa58ec7c9a5c860fe", "filename": "compiler/rustc_passes/src/check_attr.rs", "status": "modified", "additions": 30, "deletions": 0, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/dcefd6871d40612e924bb63f5d8a3bddf934c0f4/compiler%2Frustc_passes%2Fsrc%2Fcheck_attr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dcefd6871d40612e924bb63f5d8a3bddf934c0f4/compiler%2Frustc_passes%2Fsrc%2Fcheck_attr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fcheck_attr.rs?ref=dcefd6871d40612e924bb63f5d8a3bddf934c0f4", "patch": "@@ -1331,6 +1331,36 @@ impl CheckAttrVisitor<'tcx> {\n             Target::Field | Target::Arm | Target::MacroDef => {\n                 self.inline_attr_str_error_with_macro_def(hir_id, attr, \"no_mangle\");\n             }\n+            // FIXME: #[no_mangle] was previously allowed on non-functions/statics, this should be an error\n+            // The error should specify that the item that is wrong is specifically a *foreign* fn/static\n+            // otherwise the error seems odd\n+            Target::ForeignFn | Target::ForeignStatic => {\n+                let foreign_item_kind = match target {\n+                    Target::ForeignFn => \"function\",\n+                    Target::ForeignStatic => \"static\",\n+                    _ => unreachable!(),\n+                };\n+                self.tcx.struct_span_lint_hir(UNUSED_ATTRIBUTES, hir_id, attr.span, |lint| {\n+                    lint.build(&format!(\n+                        \"`#[no_mangle]` has no effect on a foreign {}\",\n+                        foreign_item_kind\n+                    ))\n+                    .warn(\n+                        \"this was previously accepted by the compiler but is \\\n+                            being phased out; it will become a hard error in \\\n+                            a future release!\",\n+                    )\n+                    .span_label(*span, format!(\"foreign {}\", foreign_item_kind))\n+                    .note(\"symbol names in extern blocks are not mangled\")\n+                    .span_suggestion(\n+                        attr.span,\n+                        \"remove this attribute\",\n+                        String::new(),\n+                        Applicability::MachineApplicable,\n+                    )\n+                    .emit();\n+                });\n+            }\n             _ => {\n                 // FIXME: #[no_mangle] was previously allowed on non-functions/statics and some\n                 // crates used this, so only emit a warning."}, {"sha": "ab7c9824af03915711e99d77a94712d101983b5a", "filename": "src/test/ui/extern/extern-no-mangle.rs", "status": "added", "additions": 30, "deletions": 0, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/dcefd6871d40612e924bb63f5d8a3bddf934c0f4/src%2Ftest%2Fui%2Fextern%2Fextern-no-mangle.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dcefd6871d40612e924bb63f5d8a3bddf934c0f4/src%2Ftest%2Fui%2Fextern%2Fextern-no-mangle.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fextern%2Fextern-no-mangle.rs?ref=dcefd6871d40612e924bb63f5d8a3bddf934c0f4", "patch": "@@ -0,0 +1,30 @@\n+#![warn(unused_attributes)]\n+\n+// Tests that placing the #[no_mangle] attribute on a foreign fn or static emits\n+// a specialized warning.\n+// The previous warning only talks about a \"function or static\" but foreign fns/statics\n+// are also not allowed to have #[no_mangle]\n+\n+// build-pass\n+\n+extern \"C\" {\n+    #[no_mangle]\n+    //~^ WARNING `#[no_mangle]` has no effect on a foreign static\n+    //~^^ WARNING this was previously accepted by the compiler\n+    pub static FOO: u8;\n+\n+    #[no_mangle]\n+    //~^ WARNING `#[no_mangle]` has no effect on a foreign function\n+    //~^^ WARNING this was previously accepted by the compiler\n+    pub fn bar();\n+}\n+\n+fn no_new_warn() {\n+    // Should emit the generic \"not a function or static\" warning\n+    #[no_mangle]\n+    //~^ WARNING attribute should be applied to a free function, impl method or static\n+    //~^^ WARNING this was previously accepted by the compiler\n+    let x = 0_u8;\n+}\n+\n+fn main() {}"}, {"sha": "b56428141141dacbcb81946c6b5023bc61fb1a0d", "filename": "src/test/ui/extern/extern-no-mangle.stderr", "status": "added", "additions": 42, "deletions": 0, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/dcefd6871d40612e924bb63f5d8a3bddf934c0f4/src%2Ftest%2Fui%2Fextern%2Fextern-no-mangle.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/dcefd6871d40612e924bb63f5d8a3bddf934c0f4/src%2Ftest%2Fui%2Fextern%2Fextern-no-mangle.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fextern%2Fextern-no-mangle.stderr?ref=dcefd6871d40612e924bb63f5d8a3bddf934c0f4", "patch": "@@ -0,0 +1,42 @@\n+warning: attribute should be applied to a free function, impl method or static\n+  --> $DIR/extern-no-mangle.rs:24:5\n+   |\n+LL |     #[no_mangle]\n+   |     ^^^^^^^^^^^^\n+...\n+LL |     let x = 0_u8;\n+   |     ------------- not a free function, impl method or static\n+   |\n+note: the lint level is defined here\n+  --> $DIR/extern-no-mangle.rs:1:9\n+   |\n+LL | #![warn(unused_attributes)]\n+   |         ^^^^^^^^^^^^^^^^^\n+   = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n+\n+warning: `#[no_mangle]` has no effect on a foreign static\n+  --> $DIR/extern-no-mangle.rs:11:5\n+   |\n+LL |     #[no_mangle]\n+   |     ^^^^^^^^^^^^ help: remove this attribute\n+...\n+LL |     pub static FOO: u8;\n+   |     ------------------- foreign static\n+   |\n+   = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n+   = note: symbol names in extern blocks are not mangled\n+\n+warning: `#[no_mangle]` has no effect on a foreign function\n+  --> $DIR/extern-no-mangle.rs:16:5\n+   |\n+LL |     #[no_mangle]\n+   |     ^^^^^^^^^^^^ help: remove this attribute\n+...\n+LL |     pub fn bar();\n+   |     ------------- foreign function\n+   |\n+   = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n+   = note: symbol names in extern blocks are not mangled\n+\n+warning: 3 warnings emitted\n+"}]}