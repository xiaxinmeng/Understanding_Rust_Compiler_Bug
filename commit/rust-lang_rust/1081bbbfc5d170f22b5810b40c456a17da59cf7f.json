{"sha": "1081bbbfc5d170f22b5810b40c456a17da59cf7f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjEwODFiYmJmYzVkMTcwZjIyYjU4MTBiNDBjNDU2YTE3ZGE1OWNmN2Y=", "commit": {"author": {"name": "Zack M. Davis", "email": "code@zackmdavis.net", "date": "2018-10-03T04:43:05Z"}, "committer": {"name": "Zack M. Davis", "email": "code@zackmdavis.net", "date": "2018-10-03T06:02:51Z"}, "message": "abolish ICE when pretty-printing async block\n\nJoshua Netterfield reported an ICE when the unused-parentheses lint\ntriggered around an async block (#54752). In order to compose an\nautofixable suggestion, the lint invokes the pretty-printer on the\nunnecessarily-parenthesized expression. (One wonders why the lint\ndoesn't just use `SourceMap::span_to_snippet` instead, to preserve the\nformatting of the original source?\u2014but for that, you'd have to ask the\nauthor of 5c9f806d.)\n\nBut then the pretty-printer panics when trying to call `<pprust::State\nas PrintState>::end` when `State.boxes` is empty. Empirically, the\nproblem would seem to be solved if we start some \"boxes\" beforehand in\nthe `ast::ExprKind::Async` arm of the big match in\n`print_expr_outer_attr_style`, exactly like we do in the\nimmediately-preceding match arm for `ast::ExprKind::Block`\u2014it would\nseem pretty (\"pretty\") reasonable for the pretty-printing of async\nblocks to work a lot like the pretty-printing of ordinary non-async\nblocks, right??\n\nOf course, it would be shamefully cargo-culty to commit code on the\nbasis of this kind of mere reasoning-by-analogy (in contrast to\nunderstanding the design of the pretty-printer in such detail that the\ncorrectness of the patch is comprehended with all the lucid certainty\nof mathematical proof, rather than being merely surmised by\nintuition). But maybe we care more about fixing the bug with high\nprobability today, than with certainty in some indefinite hypothetical\nfuture?  Maybe the effort is worth a fifth of a shirt??\n\nHumbly resolves #54752.", "tree": {"sha": "1173edef0f401a7670d77fdc72baf1d32ac7ca1b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1173edef0f401a7670d77fdc72baf1d32ac7ca1b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1081bbbfc5d170f22b5810b40c456a17da59cf7f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1081bbbfc5d170f22b5810b40c456a17da59cf7f", "html_url": "https://github.com/rust-lang/rust/commit/1081bbbfc5d170f22b5810b40c456a17da59cf7f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1081bbbfc5d170f22b5810b40c456a17da59cf7f/comments", "author": {"login": "zackmdavis", "id": 1076988, "node_id": "MDQ6VXNlcjEwNzY5ODg=", "avatar_url": "https://avatars.githubusercontent.com/u/1076988?v=4", "gravatar_id": "", "url": "https://api.github.com/users/zackmdavis", "html_url": "https://github.com/zackmdavis", "followers_url": "https://api.github.com/users/zackmdavis/followers", "following_url": "https://api.github.com/users/zackmdavis/following{/other_user}", "gists_url": "https://api.github.com/users/zackmdavis/gists{/gist_id}", "starred_url": "https://api.github.com/users/zackmdavis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/zackmdavis/subscriptions", "organizations_url": "https://api.github.com/users/zackmdavis/orgs", "repos_url": "https://api.github.com/users/zackmdavis/repos", "events_url": "https://api.github.com/users/zackmdavis/events{/privacy}", "received_events_url": "https://api.github.com/users/zackmdavis/received_events", "type": "User", "site_admin": false}, "committer": {"login": "zackmdavis", "id": 1076988, "node_id": "MDQ6VXNlcjEwNzY5ODg=", "avatar_url": "https://avatars.githubusercontent.com/u/1076988?v=4", "gravatar_id": "", "url": "https://api.github.com/users/zackmdavis", "html_url": "https://github.com/zackmdavis", "followers_url": "https://api.github.com/users/zackmdavis/followers", "following_url": "https://api.github.com/users/zackmdavis/following{/other_user}", "gists_url": "https://api.github.com/users/zackmdavis/gists{/gist_id}", "starred_url": "https://api.github.com/users/zackmdavis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/zackmdavis/subscriptions", "organizations_url": "https://api.github.com/users/zackmdavis/orgs", "repos_url": "https://api.github.com/users/zackmdavis/repos", "events_url": "https://api.github.com/users/zackmdavis/events{/privacy}", "received_events_url": "https://api.github.com/users/zackmdavis/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4cf11765dc98536c6eedf33f2df7f72f6e161263", "url": "https://api.github.com/repos/rust-lang/rust/commits/4cf11765dc98536c6eedf33f2df7f72f6e161263", "html_url": "https://github.com/rust-lang/rust/commit/4cf11765dc98536c6eedf33f2df7f72f6e161263"}], "stats": {"total": 10, "additions": 10, "deletions": 0}, "files": [{"sha": "83a05921510b4d2dcc37a0d9b1aabedf46a8156f", "filename": "src/libsyntax/print/pprust.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/1081bbbfc5d170f22b5810b40c456a17da59cf7f/src%2Flibsyntax%2Fprint%2Fpprust.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1081bbbfc5d170f22b5810b40c456a17da59cf7f/src%2Flibsyntax%2Fprint%2Fpprust.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fprint%2Fpprust.rs?ref=1081bbbfc5d170f22b5810b40c456a17da59cf7f", "patch": "@@ -2228,6 +2228,9 @@ impl<'a> State<'a> {\n                 self.word_nbsp(\"async\")?;\n                 self.print_capture_clause(capture_clause)?;\n                 self.s.space()?;\n+                // cbox/ibox in analogy to the `ExprKind::Block` arm above\n+                self.cbox(INDENT_UNIT)?;\n+                self.ibox(0)?;\n                 self.print_block_with_attrs(blk, attrs)?;\n             }\n             ast::ExprKind::Assign(ref lhs, ref rhs) => {"}, {"sha": "6930ee1a386fe2d311d1f0d4578f02b4b70b795f", "filename": "src/test/pretty/issue-54752-async-block.rs", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/1081bbbfc5d170f22b5810b40c456a17da59cf7f/src%2Ftest%2Fpretty%2Fissue-54752-async-block.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1081bbbfc5d170f22b5810b40c456a17da59cf7f/src%2Ftest%2Fpretty%2Fissue-54752-async-block.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fpretty%2Fissue-54752-async-block.rs?ref=1081bbbfc5d170f22b5810b40c456a17da59cf7f", "patch": "@@ -0,0 +1,7 @@\n+#![feature(async_await)]\n+#![allow(unused_parens)]\n+\n+// edition:2018\n+// pp-exact\n+\n+fn main() { let _a = (async  { }); }"}]}