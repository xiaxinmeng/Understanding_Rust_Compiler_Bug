{"sha": "e38cbc78aa18354a8b4e1477cd090bd83c298ced", "node_id": "C_kwDOAAsO6NoAKGUzOGNiYzc4YWExODM1NGE4YjRlMTQ3N2NkMDkwYmQ4M2MyOThjZWQ", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-01-21T21:03:14Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-01-21T21:03:14Z"}, "message": "Rollup merge of #92835 - iwanders:issue-66450-improve-cfg-error-message, r=nagisa\n\nImprove error message for key=\"value\" cfg arguments.\n\nHi, I ran into difficulties using the `--cfg` flag syntax, first hit when googling for the error was issue https://github.com/rust-lang/rust/issues/66450. Reading that issue, it sounded like the best way to improve the experience was to improve the error message, this is low risk and doesn't introduce any additional argument parsing.\n\nThe issue mentions that it is entirely dependent on the shell, while this may be true, I think guiding the the user into the realization that the quotes may need to be escaped is helpful. The two suggested escapings both work in Bash and in the Windows command prompt.\n\nfyi `@ehuss`", "tree": {"sha": "e7af78ff9601cdcba2bd921c36afe4ee4f7a1f7c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e7af78ff9601cdcba2bd921c36afe4ee4f7a1f7c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e38cbc78aa18354a8b4e1477cd090bd83c298ced", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJh6x+SCRBK7hj4Ov3rIwAAbzUIAChsUeOPWEVpXRWoWcwYuc/n\nVykqWlXakbT2jZWFmTUYUFCYwEtwQwrBXiKqFEYLWeQrpwVVbb/SdwpUYrPTO4JU\nUmA+aXcOliJCuA/Ze4wo/nothIZhkz0HR4wpI/ymXwvK4a6/BlJU7gxB2H7753L4\nUFmI7tpOV+EM+znGvodN0C8I1LQ+m1+mF9jw2aEoDZu6IL6q0HyWo3R3Qs9l+RzS\nR0l9mnC24AXW39iPKTVgz5v2FOkpDsF/yYV9xtQyrwA6elcUhTHwtRNSZmFPBZ3q\nqHqLlTRNXEfWmP5gamBydl88BaOxk2x7gmiVIAwwJXO8HEdfzq01jHcCq9gFCAA=\n=/7uf\n-----END PGP SIGNATURE-----\n", "payload": "tree e7af78ff9601cdcba2bd921c36afe4ee4f7a1f7c\nparent 701a8330e8ee2135137fa3fed5154e5d03945df9\nparent af87248037a8c86f580c469ce7d2a10c0b12f2fd\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1642798994 +0100\ncommitter GitHub <noreply@github.com> 1642798994 +0100\n\nRollup merge of #92835 - iwanders:issue-66450-improve-cfg-error-message, r=nagisa\n\nImprove error message for key=\"value\" cfg arguments.\n\nHi, I ran into difficulties using the `--cfg` flag syntax, first hit when googling for the error was issue https://github.com/rust-lang/rust/issues/66450. Reading that issue, it sounded like the best way to improve the experience was to improve the error message, this is low risk and doesn't introduce any additional argument parsing.\n\nThe issue mentions that it is entirely dependent on the shell, while this may be true, I think guiding the the user into the realization that the quotes may need to be escaped is helpful. The two suggested escapings both work in Bash and in the Windows command prompt.\n\nfyi `@ehuss`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e38cbc78aa18354a8b4e1477cd090bd83c298ced", "html_url": "https://github.com/rust-lang/rust/commit/e38cbc78aa18354a8b4e1477cd090bd83c298ced", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e38cbc78aa18354a8b4e1477cd090bd83c298ced/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "701a8330e8ee2135137fa3fed5154e5d03945df9", "url": "https://api.github.com/repos/rust-lang/rust/commits/701a8330e8ee2135137fa3fed5154e5d03945df9", "html_url": "https://github.com/rust-lang/rust/commit/701a8330e8ee2135137fa3fed5154e5d03945df9"}, {"sha": "af87248037a8c86f580c469ce7d2a10c0b12f2fd", "url": "https://api.github.com/repos/rust-lang/rust/commits/af87248037a8c86f580c469ce7d2a10c0b12f2fd", "html_url": "https://github.com/rust-lang/rust/commit/af87248037a8c86f580c469ce7d2a10c0b12f2fd"}], "stats": {"total": 21, "additions": 18, "deletions": 3}, "files": [{"sha": "263435619590e1ba78a938f701318bd2f3d1b74d", "filename": "compiler/rustc_interface/src/interface.rs", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/e38cbc78aa18354a8b4e1477cd090bd83c298ced/compiler%2Frustc_interface%2Fsrc%2Finterface.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e38cbc78aa18354a8b4e1477cd090bd83c298ced/compiler%2Frustc_interface%2Fsrc%2Finterface.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_interface%2Fsrc%2Finterface.rs?ref=e38cbc78aa18354a8b4e1477cd090bd83c298ced", "patch": "@@ -124,7 +124,16 @@ pub fn parse_cfgspecs(cfgspecs: Vec<String>) -> FxHashSet<(String, Option<String\n                     Err(errs) => errs.into_iter().for_each(|mut err| err.cancel()),\n                 }\n \n-                error!(r#\"expected `key` or `key=\"value\"`\"#);\n+                // If the user tried to use a key=\"value\" flag, but is missing the quotes, provide\n+                // a hint about how to resolve this.\n+                if s.contains(\"=\") && !s.contains(\"=\\\"\") && !s.ends_with(\"\\\"\") {\n+                    error!(concat!(\n+                        r#\"expected `key` or `key=\"value\"`, ensure escaping is appropriate\"#,\n+                        r#\" for your shell, try 'key=\"value\"' or key=\\\"value\\\"\"#\n+                    ));\n+                } else {\n+                    error!(r#\"expected `key` or `key=\"value\"`\"#);\n+                }\n             })\n             .collect::<CrateConfig>();\n         cfg.into_iter().map(|(a, b)| (a.to_string(), b.map(|b| b.to_string()))).collect()"}, {"sha": "d20e79b9db3384990fac26906a7fe21316f47e71", "filename": "src/test/ui/conditional-compilation/cfg-arg-invalid-1.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e38cbc78aa18354a8b4e1477cd090bd83c298ced/src%2Ftest%2Fui%2Fconditional-compilation%2Fcfg-arg-invalid-1.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e38cbc78aa18354a8b4e1477cd090bd83c298ced/src%2Ftest%2Fui%2Fconditional-compilation%2Fcfg-arg-invalid-1.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconditional-compilation%2Fcfg-arg-invalid-1.rs?ref=e38cbc78aa18354a8b4e1477cd090bd83c298ced", "patch": "@@ -1,3 +1,3 @@\n // compile-flags: --cfg a(b=c)\n-// error-pattern: invalid `--cfg` argument: `a(b=c)` (expected `key` or `key=\"value\"`)\n+// error-pattern: invalid `--cfg` argument: `a(b=c)` (expected `key` or `key=\"value\"`, ensure escaping is appropriate for your shell, try 'key=\"value\"' or key=\\\"value\\\")\n fn main() {}"}, {"sha": "3a12e97868000498ecfb2163553873e0a0145310", "filename": "src/test/ui/conditional-compilation/cfg-arg-invalid-1.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e38cbc78aa18354a8b4e1477cd090bd83c298ced/src%2Ftest%2Fui%2Fconditional-compilation%2Fcfg-arg-invalid-1.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/e38cbc78aa18354a8b4e1477cd090bd83c298ced/src%2Ftest%2Fui%2Fconditional-compilation%2Fcfg-arg-invalid-1.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconditional-compilation%2Fcfg-arg-invalid-1.stderr?ref=e38cbc78aa18354a8b4e1477cd090bd83c298ced", "patch": "@@ -1,2 +1,2 @@\n-error: invalid `--cfg` argument: `a(b=c)` (expected `key` or `key=\"value\"`)\n+error: invalid `--cfg` argument: `a(b=c)` (expected `key` or `key=\"value\"`, ensure escaping is appropriate for your shell, try 'key=\"value\"' or key=\\\"value\\\")\n "}, {"sha": "628b335c873025697f17275fea8ea2996196954f", "filename": "src/test/ui/conditional-compilation/cfg-arg-invalid-9.rs", "status": "added", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/e38cbc78aa18354a8b4e1477cd090bd83c298ced/src%2Ftest%2Fui%2Fconditional-compilation%2Fcfg-arg-invalid-9.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e38cbc78aa18354a8b4e1477cd090bd83c298ced/src%2Ftest%2Fui%2Fconditional-compilation%2Fcfg-arg-invalid-9.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconditional-compilation%2Fcfg-arg-invalid-9.rs?ref=e38cbc78aa18354a8b4e1477cd090bd83c298ced", "patch": "@@ -0,0 +1,4 @@\n+// Test for missing quotes around value, issue #66450.\n+// compile-flags: --cfg key=value\n+// error-pattern: invalid `--cfg` argument: `key=value` (expected `key` or `key=\"value\"`, ensure escaping is appropriate for your shell, try 'key=\"value\"' or key=\\\"value\\\")\n+fn main() {}"}, {"sha": "985b525225839e2d79b9d223ebe821c8cc2ff86e", "filename": "src/test/ui/conditional-compilation/cfg-arg-invalid-9.stderr", "status": "added", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e38cbc78aa18354a8b4e1477cd090bd83c298ced/src%2Ftest%2Fui%2Fconditional-compilation%2Fcfg-arg-invalid-9.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/e38cbc78aa18354a8b4e1477cd090bd83c298ced/src%2Ftest%2Fui%2Fconditional-compilation%2Fcfg-arg-invalid-9.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconditional-compilation%2Fcfg-arg-invalid-9.stderr?ref=e38cbc78aa18354a8b4e1477cd090bd83c298ced", "patch": "@@ -0,0 +1,2 @@\n+error: invalid `--cfg` argument: `key=value` (expected `key` or `key=\"value\"`, ensure escaping is appropriate for your shell, try 'key=\"value\"' or key=\\\"value\\\")\n+"}]}