{"sha": "ffe0a1c9fd6a75bb91955e50d639c619ecbcdd92", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZmZTBhMWM5ZmQ2YTc1YmI5MTk1NWU1MGQ2MzljNjE5ZWNiY2RkOTI=", "commit": {"author": {"name": "Dylan DPC", "email": "dylan.dpc@gmail.com", "date": "2020-05-03T08:48:00Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-05-03T08:48:00Z"}, "message": "Rollup merge of #71314 - mibac138:cfg-version, r=petrochenkov\n\nImplement RFC 2523, `#[cfg(version(..))]`\n\nHi! This is my first contribution to rust, I hope I didn't miss anything. I tried to implement this feature so that `#[cfg(version(1.44.0))]` works but the parser was printing an error that I wasn't sure how to fix so I just opted for implementing `#[cfg(version(\"1.44.0\"))]` (note the quotes).\n\nTracking issue: #64796", "tree": {"sha": "96caedc580f761423bdda7222332f6ab58949291", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/96caedc580f761423bdda7222332f6ab58949291"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ffe0a1c9fd6a75bb91955e50d639c619ecbcdd92", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJeroVACRBK7hj4Ov3rIwAAdHIIADmHrhCi5245iFDLrxZUFilT\nwH3sra/3ZxEHmhWsY+0GmSIV/GiSgKzJimRP95lbiSfpspK0gN4gChMlyJcA2p3p\n5z6HcyGAlMgl966t7KG4YSs+JU0xy78sOPPrIzNpRQiR0rsy2wuiCSG2dK7558Tl\nFveNkqOGEid8NvYapoS8397Vtt7mjOvTvzvMvq5sb8lA3vV23g9DZUO0auI0W370\nxiNC0i0VnwoYIZHP7aiLeMeCGbQQbDpvnrQaT/0b81RsWDiH5gW4wI+TQQEwnNKO\nOqKRBMaPdWcr6IMW4vogPfsT0Z2TGyNcsM/v+Q8I9aMD2fG/y7Ta0ColXuKHpxk=\n=9b4n\n-----END PGP SIGNATURE-----\n", "payload": "tree 96caedc580f761423bdda7222332f6ab58949291\nparent 8cb8d9cfe26d9044efca0343067857229fd90b97\nparent 8a77d1ca3fc2df789157f7986ddbaf2a377ff0fe\nauthor Dylan DPC <dylan.dpc@gmail.com> 1588495680 +0530\ncommitter GitHub <noreply@github.com> 1588495680 +0530\n\nRollup merge of #71314 - mibac138:cfg-version, r=petrochenkov\n\nImplement RFC 2523, `#[cfg(version(..))]`\n\nHi! This is my first contribution to rust, I hope I didn't miss anything. I tried to implement this feature so that `#[cfg(version(1.44.0))]` works but the parser was printing an error that I wasn't sure how to fix so I just opted for implementing `#[cfg(version(\"1.44.0\"))]` (note the quotes).\n\nTracking issue: #64796\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ffe0a1c9fd6a75bb91955e50d639c619ecbcdd92", "html_url": "https://github.com/rust-lang/rust/commit/ffe0a1c9fd6a75bb91955e50d639c619ecbcdd92", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ffe0a1c9fd6a75bb91955e50d639c619ecbcdd92/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8cb8d9cfe26d9044efca0343067857229fd90b97", "url": "https://api.github.com/repos/rust-lang/rust/commits/8cb8d9cfe26d9044efca0343067857229fd90b97", "html_url": "https://github.com/rust-lang/rust/commit/8cb8d9cfe26d9044efca0343067857229fd90b97"}, {"sha": "8a77d1ca3fc2df789157f7986ddbaf2a377ff0fe", "url": "https://api.github.com/repos/rust-lang/rust/commits/8a77d1ca3fc2df789157f7986ddbaf2a377ff0fe", "html_url": "https://github.com/rust-lang/rust/commit/8a77d1ca3fc2df789157f7986ddbaf2a377ff0fe"}], "stats": {"total": 302, "additions": 283, "deletions": 19}, "files": [{"sha": "0fed32f4a9d0466f62799c7ba953fce2a2b64946", "filename": "Cargo.lock", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/ffe0a1c9fd6a75bb91955e50d639c619ecbcdd92/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/ffe0a1c9fd6a75bb91955e50d639c619ecbcdd92/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=ffe0a1c9fd6a75bb91955e50d639c619ecbcdd92", "patch": "@@ -3593,6 +3593,7 @@ dependencies = [\n  \"rustc_session\",\n  \"rustc_span\",\n  \"serialize\",\n+ \"version_check\",\n ]\n \n [[package]]"}, {"sha": "2b1e50835b7676ace00a28da09b1fdf041113f07", "filename": "src/doc/unstable-book/src/language-features/cfg-version.md", "status": "added", "additions": 34, "deletions": 0, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/ffe0a1c9fd6a75bb91955e50d639c619ecbcdd92/src%2Fdoc%2Funstable-book%2Fsrc%2Flanguage-features%2Fcfg-version.md", "raw_url": "https://github.com/rust-lang/rust/raw/ffe0a1c9fd6a75bb91955e50d639c619ecbcdd92/src%2Fdoc%2Funstable-book%2Fsrc%2Flanguage-features%2Fcfg-version.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Funstable-book%2Fsrc%2Flanguage-features%2Fcfg-version.md?ref=ffe0a1c9fd6a75bb91955e50d639c619ecbcdd92", "patch": "@@ -0,0 +1,34 @@\n+# `cfg_version`\n+\n+The tracking issue for this feature is: [#64796]\n+\n+[#64796]: https://github.com/rust-lang/rust/issues/64796\n+\n+------------------------\n+\n+The `cfg_version` feature makes it possible to execute different code\n+depending on the compiler version.\n+\n+## Examples\n+\n+```rust\n+#![feature(cfg_version)]\n+\n+#[cfg(version(\"1.42\"))]\n+fn a() {\n+    // ...\n+}\n+\n+#[cfg(not(version(\"1.42\")))]\n+fn a() {\n+    // ...\n+}\n+\n+fn b() {\n+    if cfg!(version(\"1.42\")) {\n+        // ...\n+    } else {\n+        // ...\n+    }\n+}\n+```"}, {"sha": "d7af7fe6143e543985d41d1a33756f8ed91871a6", "filename": "src/librustc_attr/Cargo.toml", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ffe0a1c9fd6a75bb91955e50d639c619ecbcdd92/src%2Flibrustc_attr%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/ffe0a1c9fd6a75bb91955e50d639c619ecbcdd92/src%2Flibrustc_attr%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_attr%2FCargo.toml?ref=ffe0a1c9fd6a75bb91955e50d639c619ecbcdd92", "patch": "@@ -3,6 +3,7 @@ authors = [\"The Rust Project Developers\"]\n name = \"rustc_attr\"\n version = \"0.0.0\"\n edition = \"2018\"\n+build = \"build.rs\"\n \n [lib]\n name = \"rustc_attr\"\n@@ -19,3 +20,4 @@ rustc_feature = { path = \"../librustc_feature\" }\n rustc_macros = { path = \"../librustc_macros\" }\n rustc_session = { path = \"../librustc_session\" }\n rustc_ast = { path = \"../librustc_ast\" }\n+version_check = \"0.9\""}, {"sha": "d230ba91039adc9581745ee39a492fa91e3b52b0", "filename": "src/librustc_attr/build.rs", "status": "added", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/ffe0a1c9fd6a75bb91955e50d639c619ecbcdd92/src%2Flibrustc_attr%2Fbuild.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ffe0a1c9fd6a75bb91955e50d639c619ecbcdd92/src%2Flibrustc_attr%2Fbuild.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_attr%2Fbuild.rs?ref=ffe0a1c9fd6a75bb91955e50d639c619ecbcdd92", "patch": "@@ -0,0 +1,4 @@\n+fn main() {\n+    println!(\"cargo:rerun-if-changed=build.rs\");\n+    println!(\"cargo:rerun-if-env-changed=CFG_VERSION\");\n+}"}, {"sha": "ce38e3f5f4e4efe8eda12a21f04513241eca45d3", "filename": "src/librustc_attr/builtin.rs", "status": "modified", "additions": 50, "deletions": 13, "changes": 63, "blob_url": "https://github.com/rust-lang/rust/blob/ffe0a1c9fd6a75bb91955e50d639c619ecbcdd92/src%2Flibrustc_attr%2Fbuiltin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ffe0a1c9fd6a75bb91955e50d639c619ecbcdd92/src%2Flibrustc_attr%2Fbuiltin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_attr%2Fbuiltin.rs?ref=ffe0a1c9fd6a75bb91955e50d639c619ecbcdd92", "patch": "@@ -2,7 +2,7 @@\n \n use super::{find_by_name, mark_used};\n \n-use rustc_ast::ast::{self, Attribute, MetaItem, MetaItemKind, NestedMetaItem};\n+use rustc_ast::ast::{self, Attribute, Lit, LitKind, MetaItem, MetaItemKind, NestedMetaItem};\n use rustc_ast_pretty::pprust;\n use rustc_errors::{struct_span_err, Applicability, Handler};\n use rustc_feature::{find_gated_cfg, is_builtin_attr_name, Features, GatedCfg};\n@@ -11,6 +11,7 @@ use rustc_session::parse::{feature_err, ParseSess};\n use rustc_span::hygiene::Transparency;\n use rustc_span::{symbol::sym, symbol::Symbol, Span};\n use std::num::NonZeroU32;\n+use version_check::Version;\n \n pub fn is_builtin_attr(attr: &Attribute) -> bool {\n     attr.is_doc_comment() || attr.ident().filter(|ident| is_builtin_attr_name(ident.name)).is_some()\n@@ -568,11 +569,8 @@ pub fn find_crate_name(attrs: &[Attribute]) -> Option<Symbol> {\n \n /// Tests if a cfg-pattern matches the cfg set\n pub fn cfg_matches(cfg: &ast::MetaItem, sess: &ParseSess, features: Option<&Features>) -> bool {\n-    eval_condition(cfg, sess, &mut |cfg| {\n-        let gate = find_gated_cfg(|sym| cfg.check_name(sym));\n-        if let (Some(feats), Some(gated_cfg)) = (features, gate) {\n-            gate_cfg(&gated_cfg, cfg.span, sess, feats);\n-        }\n+    eval_condition(cfg, sess, features, &mut |cfg| {\n+        try_gate_cfg(cfg, sess, features);\n         let error = |span, msg| {\n             sess.span_diagnostic.span_err(span, msg);\n             true\n@@ -603,6 +601,13 @@ pub fn cfg_matches(cfg: &ast::MetaItem, sess: &ParseSess, features: Option<&Feat\n     })\n }\n \n+fn try_gate_cfg(cfg: &ast::MetaItem, sess: &ParseSess, features: Option<&Features>) {\n+    let gate = find_gated_cfg(|sym| cfg.check_name(sym));\n+    if let (Some(feats), Some(gated_cfg)) = (features, gate) {\n+        gate_cfg(&gated_cfg, cfg.span, sess, feats);\n+    }\n+}\n+\n fn gate_cfg(gated_cfg: &GatedCfg, cfg_span: Span, sess: &ParseSess, features: &Features) {\n     let (cfg, feature, has_feature) = gated_cfg;\n     if !has_feature(features) && !cfg_span.allows_unstable(*feature) {\n@@ -616,9 +621,41 @@ fn gate_cfg(gated_cfg: &GatedCfg, cfg_span: Span, sess: &ParseSess, features: &F\n pub fn eval_condition(\n     cfg: &ast::MetaItem,\n     sess: &ParseSess,\n+    features: Option<&Features>,\n     eval: &mut impl FnMut(&ast::MetaItem) -> bool,\n ) -> bool {\n     match cfg.kind {\n+        ast::MetaItemKind::List(ref mis) if cfg.name_or_empty() == sym::version => {\n+            try_gate_cfg(cfg, sess, features);\n+            let (min_version, span) = match &mis[..] {\n+                [NestedMetaItem::Literal(Lit { kind: LitKind::Str(sym, ..), span, .. })] => {\n+                    (sym, span)\n+                }\n+                [NestedMetaItem::Literal(Lit { span, .. })\n+                | NestedMetaItem::MetaItem(MetaItem { span, .. })] => {\n+                    sess.span_diagnostic\n+                        .struct_span_err(*span, &*format!(\"expected a version literal\"))\n+                        .emit();\n+                    return false;\n+                }\n+                [..] => {\n+                    sess.span_diagnostic\n+                        .struct_span_err(cfg.span, \"expected single version literal\")\n+                        .emit();\n+                    return false;\n+                }\n+            };\n+            let min_version = match Version::parse(&min_version.as_str()) {\n+                Some(ver) => ver,\n+                None => {\n+                    sess.span_diagnostic.struct_span_err(*span, \"invalid version literal\").emit();\n+                    return false;\n+                }\n+            };\n+            let version = Version::parse(env!(\"CFG_VERSION\")).unwrap();\n+\n+            version >= min_version\n+        }\n         ast::MetaItemKind::List(ref mis) => {\n             for mi in mis.iter() {\n                 if !mi.is_meta_item() {\n@@ -634,12 +671,12 @@ pub fn eval_condition(\n             // The unwraps below may look dangerous, but we've already asserted\n             // that they won't fail with the loop above.\n             match cfg.name_or_empty() {\n-                sym::any => {\n-                    mis.iter().any(|mi| eval_condition(mi.meta_item().unwrap(), sess, eval))\n-                }\n-                sym::all => {\n-                    mis.iter().all(|mi| eval_condition(mi.meta_item().unwrap(), sess, eval))\n-                }\n+                sym::any => mis\n+                    .iter()\n+                    .any(|mi| eval_condition(mi.meta_item().unwrap(), sess, features, eval)),\n+                sym::all => mis\n+                    .iter()\n+                    .all(|mi| eval_condition(mi.meta_item().unwrap(), sess, features, eval)),\n                 sym::not => {\n                     if mis.len() != 1 {\n                         struct_span_err!(\n@@ -652,7 +689,7 @@ pub fn eval_condition(\n                         return false;\n                     }\n \n-                    !eval_condition(mis[0].meta_item().unwrap(), sess, eval)\n+                    !eval_condition(mis[0].meta_item().unwrap(), sess, features, eval)\n                 }\n                 _ => {\n                     struct_span_err!("}, {"sha": "66c4495c5afc8fe81fffe8939c483c937a00479f", "filename": "src/librustc_attr/lib.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ffe0a1c9fd6a75bb91955e50d639c619ecbcdd92/src%2Flibrustc_attr%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ffe0a1c9fd6a75bb91955e50d639c619ecbcdd92/src%2Flibrustc_attr%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_attr%2Flib.rs?ref=ffe0a1c9fd6a75bb91955e50d639c619ecbcdd92", "patch": "@@ -4,6 +4,8 @@\n //! The goal is to move the definition of `MetaItem` and things that don't need to be in `syntax`\n //! to this crate.\n \n+#![feature(or_patterns)]\n+\n mod builtin;\n \n pub use builtin::*;"}, {"sha": "a1dd7a5ca5225ea471b66082c22ba6eebb5e9e32", "filename": "src/librustc_feature/active.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/ffe0a1c9fd6a75bb91955e50d639c619ecbcdd92/src%2Flibrustc_feature%2Factive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ffe0a1c9fd6a75bb91955e50d639c619ecbcdd92/src%2Flibrustc_feature%2Factive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_feature%2Factive.rs?ref=ffe0a1c9fd6a75bb91955e50d639c619ecbcdd92", "patch": "@@ -562,6 +562,9 @@ declare_features! (\n     /// Allows the use of `#[target_feature]` on safe functions.\n     (active, target_feature_11, \"1.45.0\", Some(69098), None),\n \n+    /// Allow conditional compilation depending on rust version\n+    (active, cfg_version, \"1.45.0\", Some(64796), None),\n+\n     // -------------------------------------------------------------------------\n     // feature-group-end: actual feature gates\n     // -------------------------------------------------------------------------"}, {"sha": "466b318bca7305386e02c705678e681b37ce6c5c", "filename": "src/librustc_feature/builtin_attrs.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/ffe0a1c9fd6a75bb91955e50d639c619ecbcdd92/src%2Flibrustc_feature%2Fbuiltin_attrs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ffe0a1c9fd6a75bb91955e50d639c619ecbcdd92/src%2Flibrustc_feature%2Fbuiltin_attrs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_feature%2Fbuiltin_attrs.rs?ref=ffe0a1c9fd6a75bb91955e50d639c619ecbcdd92", "patch": "@@ -26,6 +26,7 @@ const GATED_CFGS: &[GatedCfg] = &[\n     (sym::target_has_atomic, sym::cfg_target_has_atomic, cfg_fn!(cfg_target_has_atomic)),\n     (sym::target_has_atomic_load_store, sym::cfg_target_has_atomic, cfg_fn!(cfg_target_has_atomic)),\n     (sym::sanitize, sym::cfg_sanitize, cfg_fn!(cfg_sanitize)),\n+    (sym::version, sym::cfg_version, cfg_fn!(cfg_version)),\n ];\n \n /// Find a gated cfg determined by the `pred`icate which is given the cfg's name."}, {"sha": "f194506e66069b6ba2d8a4eedcbfb2c1697caa62", "filename": "src/librustc_span/symbol.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ffe0a1c9fd6a75bb91955e50d639c619ecbcdd92/src%2Flibrustc_span%2Fsymbol.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ffe0a1c9fd6a75bb91955e50d639c619ecbcdd92/src%2Flibrustc_span%2Fsymbol.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_span%2Fsymbol.rs?ref=ffe0a1c9fd6a75bb91955e50d639c619ecbcdd92", "patch": "@@ -192,6 +192,7 @@ symbols! {\n         cfg_target_has_atomic,\n         cfg_target_thread_local,\n         cfg_target_vendor,\n+        cfg_version,\n         char,\n         clippy,\n         clone,\n@@ -805,6 +806,7 @@ symbols! {\n         var,\n         vec,\n         Vec,\n+        version,\n         vis,\n         visible_private_types,\n         volatile,"}, {"sha": "3fbc0b7f08e5f1a52bdc2e975a582ca2b4eb0f54", "filename": "src/librustc_trait_selection/traits/on_unimplemented.rs", "status": "modified", "additions": 11, "deletions": 6, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/ffe0a1c9fd6a75bb91955e50d639c619ecbcdd92/src%2Flibrustc_trait_selection%2Ftraits%2Fon_unimplemented.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ffe0a1c9fd6a75bb91955e50d639c619ecbcdd92/src%2Flibrustc_trait_selection%2Ftraits%2Fon_unimplemented.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trait_selection%2Ftraits%2Fon_unimplemented.rs?ref=ffe0a1c9fd6a75bb91955e50d639c619ecbcdd92", "patch": "@@ -81,7 +81,7 @@ impl<'tcx> OnUnimplementedDirective {\n                         None,\n                     )\n                 })?;\n-            attr::eval_condition(cond, &tcx.sess.parse_sess, &mut |_| true);\n+            attr::eval_condition(cond, &tcx.sess.parse_sess, Some(tcx.features()), &mut |_| true);\n             Some(cond.clone())\n         };\n \n@@ -208,11 +208,16 @@ impl<'tcx> OnUnimplementedDirective {\n \n         for command in self.subcommands.iter().chain(Some(self)).rev() {\n             if let Some(ref condition) = command.condition {\n-                if !attr::eval_condition(condition, &tcx.sess.parse_sess, &mut |c| {\n-                    c.ident().map_or(false, |ident| {\n-                        options.contains(&(ident.name, c.value_str().map(|s| s.to_string())))\n-                    })\n-                }) {\n+                if !attr::eval_condition(\n+                    condition,\n+                    &tcx.sess.parse_sess,\n+                    Some(tcx.features()),\n+                    &mut |c| {\n+                        c.ident().map_or(false, |ident| {\n+                            options.contains(&(ident.name, c.value_str().map(|s| s.to_string())))\n+                        })\n+                    },\n+                ) {\n                     debug!(\"evaluate: skipping {:?} due to condition\", command);\n                     continue;\n                 }"}, {"sha": "c29ef99945e71a07c9cf6d91a1bf509d3cebbab4", "filename": "src/test/ui/feature-gates/feature-gate-cfg-version.rs", "status": "added", "additions": 41, "deletions": 0, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/ffe0a1c9fd6a75bb91955e50d639c619ecbcdd92/src%2Ftest%2Fui%2Ffeature-gates%2Ffeature-gate-cfg-version.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ffe0a1c9fd6a75bb91955e50d639c619ecbcdd92/src%2Ftest%2Fui%2Ffeature-gates%2Ffeature-gate-cfg-version.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffeature-gates%2Ffeature-gate-cfg-version.rs?ref=ffe0a1c9fd6a75bb91955e50d639c619ecbcdd92", "patch": "@@ -0,0 +1,41 @@\n+#[cfg(version(\"1.44\"))]\n+//~^ ERROR `cfg(version)` is experimental and subject to change\n+fn foo() -> bool { true }\n+#[cfg(not(version(\"1.44\")))]\n+//~^ ERROR `cfg(version)` is experimental and subject to change\n+fn foo() -> bool { false }\n+\n+#[cfg(version(\"1.43\", \"1.44\", \"1.45\"))] //~ ERROR: expected single version literal\n+//~^ ERROR `cfg(version)` is experimental and subject to change\n+fn bar() -> bool  { false }\n+#[cfg(version(false))] //~ ERROR: expected a version literal\n+//~^ ERROR `cfg(version)` is experimental and subject to change\n+fn bar() -> bool  { false }\n+#[cfg(version(\"foo\"))] //~ ERROR: invalid version literal\n+//~^ ERROR `cfg(version)` is experimental and subject to change\n+fn bar() -> bool  { false }\n+#[cfg(version(\"999\"))]\n+//~^ ERROR `cfg(version)` is experimental and subject to change\n+fn bar() -> bool  { false }\n+#[cfg(version(\"-1\"))] //~ ERROR: invalid version literal\n+//~^ ERROR `cfg(version)` is experimental and subject to change\n+fn bar() -> bool  { false }\n+#[cfg(version(\"65536\"))] //~ ERROR: invalid version literal\n+//~^ ERROR `cfg(version)` is experimental and subject to change\n+fn bar() -> bool  { false }\n+#[cfg(version(\"0\"))]\n+//~^ ERROR `cfg(version)` is experimental and subject to change\n+fn bar() -> bool { true }\n+\n+#[cfg(version(\"1.65536.2\"))]\n+//~^ ERROR `cfg(version)` is experimental and subject to change\n+fn version_check_bug() {}\n+\n+fn main() {\n+    // This should fail but due to a bug in version_check `1.65536.2` is interpreted as `1.2`.\n+    // See https://github.com/SergioBenitez/version_check/issues/11\n+    version_check_bug();\n+    assert!(foo());\n+    assert!(bar());\n+    assert!(cfg!(version(\"1.42\"))); //~ ERROR `cfg(version)` is experimental and subject to change\n+}"}, {"sha": "bdf160b5a02700febd6038979a41f01eaadaac34", "filename": "src/test/ui/feature-gates/feature-gate-cfg-version.stderr", "status": "added", "additions": 132, "deletions": 0, "changes": 132, "blob_url": "https://github.com/rust-lang/rust/blob/ffe0a1c9fd6a75bb91955e50d639c619ecbcdd92/src%2Ftest%2Fui%2Ffeature-gates%2Ffeature-gate-cfg-version.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/ffe0a1c9fd6a75bb91955e50d639c619ecbcdd92/src%2Ftest%2Fui%2Ffeature-gates%2Ffeature-gate-cfg-version.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffeature-gates%2Ffeature-gate-cfg-version.stderr?ref=ffe0a1c9fd6a75bb91955e50d639c619ecbcdd92", "patch": "@@ -0,0 +1,132 @@\n+error[E0658]: `cfg(version)` is experimental and subject to change\n+  --> $DIR/feature-gate-cfg-version.rs:1:7\n+   |\n+LL | #[cfg(version(\"1.44\"))]\n+   |       ^^^^^^^^^^^^^^^\n+   |\n+   = note: see issue #64796 <https://github.com/rust-lang/rust/issues/64796> for more information\n+   = help: add `#![feature(cfg_version)]` to the crate attributes to enable\n+\n+error[E0658]: `cfg(version)` is experimental and subject to change\n+  --> $DIR/feature-gate-cfg-version.rs:4:11\n+   |\n+LL | #[cfg(not(version(\"1.44\")))]\n+   |           ^^^^^^^^^^^^^^^\n+   |\n+   = note: see issue #64796 <https://github.com/rust-lang/rust/issues/64796> for more information\n+   = help: add `#![feature(cfg_version)]` to the crate attributes to enable\n+\n+error[E0658]: `cfg(version)` is experimental and subject to change\n+  --> $DIR/feature-gate-cfg-version.rs:8:7\n+   |\n+LL | #[cfg(version(\"1.43\", \"1.44\", \"1.45\"))]\n+   |       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+   = note: see issue #64796 <https://github.com/rust-lang/rust/issues/64796> for more information\n+   = help: add `#![feature(cfg_version)]` to the crate attributes to enable\n+\n+error: expected single version literal\n+  --> $DIR/feature-gate-cfg-version.rs:8:7\n+   |\n+LL | #[cfg(version(\"1.43\", \"1.44\", \"1.45\"))]\n+   |       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error[E0658]: `cfg(version)` is experimental and subject to change\n+  --> $DIR/feature-gate-cfg-version.rs:11:7\n+   |\n+LL | #[cfg(version(false))]\n+   |       ^^^^^^^^^^^^^^\n+   |\n+   = note: see issue #64796 <https://github.com/rust-lang/rust/issues/64796> for more information\n+   = help: add `#![feature(cfg_version)]` to the crate attributes to enable\n+\n+error: expected a version literal\n+  --> $DIR/feature-gate-cfg-version.rs:11:15\n+   |\n+LL | #[cfg(version(false))]\n+   |               ^^^^^\n+\n+error[E0658]: `cfg(version)` is experimental and subject to change\n+  --> $DIR/feature-gate-cfg-version.rs:14:7\n+   |\n+LL | #[cfg(version(\"foo\"))]\n+   |       ^^^^^^^^^^^^^^\n+   |\n+   = note: see issue #64796 <https://github.com/rust-lang/rust/issues/64796> for more information\n+   = help: add `#![feature(cfg_version)]` to the crate attributes to enable\n+\n+error: invalid version literal\n+  --> $DIR/feature-gate-cfg-version.rs:14:15\n+   |\n+LL | #[cfg(version(\"foo\"))]\n+   |               ^^^^^\n+\n+error[E0658]: `cfg(version)` is experimental and subject to change\n+  --> $DIR/feature-gate-cfg-version.rs:17:7\n+   |\n+LL | #[cfg(version(\"999\"))]\n+   |       ^^^^^^^^^^^^^^\n+   |\n+   = note: see issue #64796 <https://github.com/rust-lang/rust/issues/64796> for more information\n+   = help: add `#![feature(cfg_version)]` to the crate attributes to enable\n+\n+error[E0658]: `cfg(version)` is experimental and subject to change\n+  --> $DIR/feature-gate-cfg-version.rs:20:7\n+   |\n+LL | #[cfg(version(\"-1\"))]\n+   |       ^^^^^^^^^^^^^\n+   |\n+   = note: see issue #64796 <https://github.com/rust-lang/rust/issues/64796> for more information\n+   = help: add `#![feature(cfg_version)]` to the crate attributes to enable\n+\n+error: invalid version literal\n+  --> $DIR/feature-gate-cfg-version.rs:20:15\n+   |\n+LL | #[cfg(version(\"-1\"))]\n+   |               ^^^^\n+\n+error[E0658]: `cfg(version)` is experimental and subject to change\n+  --> $DIR/feature-gate-cfg-version.rs:23:7\n+   |\n+LL | #[cfg(version(\"65536\"))]\n+   |       ^^^^^^^^^^^^^^^^\n+   |\n+   = note: see issue #64796 <https://github.com/rust-lang/rust/issues/64796> for more information\n+   = help: add `#![feature(cfg_version)]` to the crate attributes to enable\n+\n+error: invalid version literal\n+  --> $DIR/feature-gate-cfg-version.rs:23:15\n+   |\n+LL | #[cfg(version(\"65536\"))]\n+   |               ^^^^^^^\n+\n+error[E0658]: `cfg(version)` is experimental and subject to change\n+  --> $DIR/feature-gate-cfg-version.rs:26:7\n+   |\n+LL | #[cfg(version(\"0\"))]\n+   |       ^^^^^^^^^^^^\n+   |\n+   = note: see issue #64796 <https://github.com/rust-lang/rust/issues/64796> for more information\n+   = help: add `#![feature(cfg_version)]` to the crate attributes to enable\n+\n+error[E0658]: `cfg(version)` is experimental and subject to change\n+  --> $DIR/feature-gate-cfg-version.rs:30:7\n+   |\n+LL | #[cfg(version(\"1.65536.2\"))]\n+   |       ^^^^^^^^^^^^^^^^^^^^\n+   |\n+   = note: see issue #64796 <https://github.com/rust-lang/rust/issues/64796> for more information\n+   = help: add `#![feature(cfg_version)]` to the crate attributes to enable\n+\n+error[E0658]: `cfg(version)` is experimental and subject to change\n+  --> $DIR/feature-gate-cfg-version.rs:40:18\n+   |\n+LL |     assert!(cfg!(version(\"1.42\")));\n+   |                  ^^^^^^^^^^^^^^^\n+   |\n+   = note: see issue #64796 <https://github.com/rust-lang/rust/issues/64796> for more information\n+   = help: add `#![feature(cfg_version)]` to the crate attributes to enable\n+\n+error: aborting due to 16 previous errors\n+\n+For more information about this error, try `rustc --explain E0658`."}]}