{"sha": "067f628286216cd3a78524da28fab29bfb0f516a", "node_id": "C_kwDOAAsO6NoAKDA2N2Y2MjgyODYyMTZjZDNhNzg1MjRkYTI4ZmFiMjliZmIwZjUxNmE", "commit": {"author": {"name": "Erik Desjardins", "email": "erikdesjardins@users.noreply.github.com", "date": "2022-02-20T16:37:22Z"}, "committer": {"name": "Erik Desjardins", "email": "erikdesjardins@users.noreply.github.com", "date": "2022-02-20T16:37:22Z"}, "message": "add check for llvm 14", "tree": {"sha": "9b3544381b8e5962212e76792a69691535912216", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9b3544381b8e5962212e76792a69691535912216"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/067f628286216cd3a78524da28fab29bfb0f516a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/067f628286216cd3a78524da28fab29bfb0f516a", "html_url": "https://github.com/rust-lang/rust/commit/067f628286216cd3a78524da28fab29bfb0f516a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/067f628286216cd3a78524da28fab29bfb0f516a/comments", "author": {"login": "erikdesjardins", "id": 7673145, "node_id": "MDQ6VXNlcjc2NzMxNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/7673145?v=4", "gravatar_id": "", "url": "https://api.github.com/users/erikdesjardins", "html_url": "https://github.com/erikdesjardins", "followers_url": "https://api.github.com/users/erikdesjardins/followers", "following_url": "https://api.github.com/users/erikdesjardins/following{/other_user}", "gists_url": "https://api.github.com/users/erikdesjardins/gists{/gist_id}", "starred_url": "https://api.github.com/users/erikdesjardins/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/erikdesjardins/subscriptions", "organizations_url": "https://api.github.com/users/erikdesjardins/orgs", "repos_url": "https://api.github.com/users/erikdesjardins/repos", "events_url": "https://api.github.com/users/erikdesjardins/events{/privacy}", "received_events_url": "https://api.github.com/users/erikdesjardins/received_events", "type": "User", "site_admin": false}, "committer": {"login": "erikdesjardins", "id": 7673145, "node_id": "MDQ6VXNlcjc2NzMxNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/7673145?v=4", "gravatar_id": "", "url": "https://api.github.com/users/erikdesjardins", "html_url": "https://github.com/erikdesjardins", "followers_url": "https://api.github.com/users/erikdesjardins/followers", "following_url": "https://api.github.com/users/erikdesjardins/following{/other_user}", "gists_url": "https://api.github.com/users/erikdesjardins/gists{/gist_id}", "starred_url": "https://api.github.com/users/erikdesjardins/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/erikdesjardins/subscriptions", "organizations_url": "https://api.github.com/users/erikdesjardins/orgs", "repos_url": "https://api.github.com/users/erikdesjardins/repos", "events_url": "https://api.github.com/users/erikdesjardins/events{/privacy}", "received_events_url": "https://api.github.com/users/erikdesjardins/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c2e84fa5fc4788a8bcb97fbcdc2fa78359e44121", "url": "https://api.github.com/repos/rust-lang/rust/commits/c2e84fa5fc4788a8bcb97fbcdc2fa78359e44121", "html_url": "https://github.com/rust-lang/rust/commit/c2e84fa5fc4788a8bcb97fbcdc2fa78359e44121"}], "stats": {"total": 9, "additions": 8, "deletions": 1}, "files": [{"sha": "9ab822f01f1ec6928d7583f38fc207d9d17e4447", "filename": "compiler/rustc_codegen_llvm/src/consts.rs", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/067f628286216cd3a78524da28fab29bfb0f516a/compiler%2Frustc_codegen_llvm%2Fsrc%2Fconsts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/067f628286216cd3a78524da28fab29bfb0f516a/compiler%2Frustc_codegen_llvm%2Fsrc%2Fconsts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fconsts.rs?ref=067f628286216cd3a78524da28fab29bfb0f516a", "patch": "@@ -2,6 +2,7 @@ use crate::base;\n use crate::common::CodegenCx;\n use crate::debuginfo;\n use crate::llvm::{self, True};\n+use crate::llvm_util;\n use crate::type_::Type;\n use crate::type_of::LayoutLlvmExt;\n use crate::value::Value;\n@@ -57,7 +58,13 @@ pub fn const_alloc_to_llvm<'ll>(cx: &CodegenCx<'ll, '_>, alloc: &Allocation) ->\n         // to avoid the cost of generating large complex const expressions.\n         // For example, `[(u32, u8); 1024 * 1024]` contains uninit padding in each element,\n         // and would result in `{ [5 x i8] zeroinitializer, [3 x i8] undef, ...repeat 1M times... }`.\n-        let max = cx.sess().opts.debugging_opts.uninit_const_chunk_threshold;\n+        let max = if llvm_util::get_version() < (14, 0, 0) {\n+            // Generating partially-uninit consts inhibits optimizations in LLVM < 14.\n+            // See https://github.com/rust-lang/rust/issues/84565.\n+            1\n+        } else {\n+            cx.sess().opts.debugging_opts.uninit_const_chunk_threshold\n+        };\n         let allow_uninit_chunks = chunks.clone().take(max.saturating_add(1)).count() <= max;\n \n         if allow_uninit_chunks {"}]}