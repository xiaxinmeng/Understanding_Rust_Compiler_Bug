{"sha": "0237347abcdcb8a173fe144d91673952530c785c", "node_id": "MDY6Q29tbWl0NzI0NzEyOjAyMzczNDdhYmNkY2I4YTE3M2ZlMTQ0ZDkxNjczOTUyNTMwYzc4NWM=", "commit": {"author": {"name": "topecongiro", "email": "seuchida@gmail.com", "date": "2017-07-05T09:30:11Z"}, "committer": {"name": "topecongiro", "email": "seuchida@gmail.com", "date": "2017-07-05T09:30:11Z"}, "message": "Update heuristic in rewrite_assign_rhs\n\nPut the rhs of assignement on the next line when putting next to `lhs = ` will\ncause rhs to go multi line, but putting on the next line makes it fits\nin a single line.", "tree": {"sha": "942e49c0ec9149c9ad57274b9c350e04b11642ce", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/942e49c0ec9149c9ad57274b9c350e04b11642ce"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0237347abcdcb8a173fe144d91673952530c785c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0237347abcdcb8a173fe144d91673952530c785c", "html_url": "https://github.com/rust-lang/rust/commit/0237347abcdcb8a173fe144d91673952530c785c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0237347abcdcb8a173fe144d91673952530c785c/comments", "author": {"login": "topecongiro", "id": 21980157, "node_id": "MDQ6VXNlcjIxOTgwMTU3", "avatar_url": "https://avatars.githubusercontent.com/u/21980157?v=4", "gravatar_id": "", "url": "https://api.github.com/users/topecongiro", "html_url": "https://github.com/topecongiro", "followers_url": "https://api.github.com/users/topecongiro/followers", "following_url": "https://api.github.com/users/topecongiro/following{/other_user}", "gists_url": "https://api.github.com/users/topecongiro/gists{/gist_id}", "starred_url": "https://api.github.com/users/topecongiro/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/topecongiro/subscriptions", "organizations_url": "https://api.github.com/users/topecongiro/orgs", "repos_url": "https://api.github.com/users/topecongiro/repos", "events_url": "https://api.github.com/users/topecongiro/events{/privacy}", "received_events_url": "https://api.github.com/users/topecongiro/received_events", "type": "User", "site_admin": false}, "committer": {"login": "topecongiro", "id": 21980157, "node_id": "MDQ6VXNlcjIxOTgwMTU3", "avatar_url": "https://avatars.githubusercontent.com/u/21980157?v=4", "gravatar_id": "", "url": "https://api.github.com/users/topecongiro", "html_url": "https://github.com/topecongiro", "followers_url": "https://api.github.com/users/topecongiro/followers", "following_url": "https://api.github.com/users/topecongiro/following{/other_user}", "gists_url": "https://api.github.com/users/topecongiro/gists{/gist_id}", "starred_url": "https://api.github.com/users/topecongiro/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/topecongiro/subscriptions", "organizations_url": "https://api.github.com/users/topecongiro/orgs", "repos_url": "https://api.github.com/users/topecongiro/repos", "events_url": "https://api.github.com/users/topecongiro/events{/privacy}", "received_events_url": "https://api.github.com/users/topecongiro/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "101df143cfd60fcf5132aeb579da43684b32c509", "url": "https://api.github.com/repos/rust-lang/rust/commits/101df143cfd60fcf5132aeb579da43684b32c509", "html_url": "https://github.com/rust-lang/rust/commit/101df143cfd60fcf5132aeb579da43684b32c509"}], "stats": {"total": 23, "additions": 14, "deletions": 9}, "files": [{"sha": "9069422611379d7e120569e27b3bf12a6b733e12", "filename": "src/expr.rs", "status": "modified", "additions": 14, "deletions": 9, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/0237347abcdcb8a173fe144d91673952530c785c/src%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0237347abcdcb8a173fe144d91673952530c785c/src%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fexpr.rs?ref=0237347abcdcb8a173fe144d91673952530c785c", "patch": "@@ -2937,26 +2937,21 @@ pub fn rewrite_assign_rhs<S: Into<String>>(\n     let orig_shape = try_opt!(shape.offset_left(last_line_width + 1));\n     let rhs = ex.rewrite(context, orig_shape);\n \n-    fn count_line_breaks(src: &str) -> usize {\n-        src.chars().filter(|&x| x == '\\n').count()\n-    }\n-\n     match rhs {\n-        Some(ref new_str) if count_line_breaks(new_str) < 2 => {\n+        Some(ref new_str) if !new_str.contains('\\n') => {\n             result.push(' ');\n             result.push_str(new_str);\n         }\n         _ => {\n-            // Expression did not fit on the same line as the identifier or is\n-            // at least three lines big. Try splitting the line and see\n-            // if that works better.\n+            // Expression did not fit on the same line as the identifier.\n+            // Try splitting the line and see if that works better.\n             let new_shape = try_opt!(shape.block_left(context.config.tab_spaces()));\n             let new_rhs = ex.rewrite(context, new_shape);\n \n             // FIXME: DRY!\n             match (rhs, new_rhs) {\n                 (Some(ref orig_rhs), Some(ref replacement_rhs))\n-                    if count_line_breaks(orig_rhs) > count_line_breaks(replacement_rhs) + 1 => {\n+                    if prefer_next_line(orig_rhs, replacement_rhs) => {\n                     result.push_str(&format!(\"\\n{}\", new_shape.indent.to_string(context.config)));\n                     result.push_str(replacement_rhs);\n                 }\n@@ -2976,6 +2971,16 @@ pub fn rewrite_assign_rhs<S: Into<String>>(\n     Some(result)\n }\n \n+fn prefer_next_line(orig_rhs: &str, next_line_rhs: &str) -> bool {\n+\n+    fn count_line_breaks(src: &str) -> usize {\n+        src.chars().filter(|&x| x == '\\n').count()\n+    }\n+\n+    !next_line_rhs.contains('\\n') ||\n+        count_line_breaks(orig_rhs) > count_line_breaks(next_line_rhs) + 1\n+}\n+\n fn rewrite_expr_addrof(\n     context: &RewriteContext,\n     mutability: ast::Mutability,"}]}