{"sha": "4fecede7fdaeeb859b066394bf27401fd13743a7", "node_id": "C_kwDOAAsO6NoAKDRmZWNlZGU3ZmRhZWViODU5YjA2NjM5NGJmMjc0MDFmZDEzNzQzYTc", "commit": {"author": {"name": "Caleb Cartwright", "email": "caleb.cartwright@outlook.com", "date": "2022-03-29T01:27:42Z"}, "committer": {"name": "Caleb Cartwright", "email": "calebcartwright@users.noreply.github.com", "date": "2022-03-29T02:33:45Z"}, "message": "Revert \"Use cargo-fmt in self_tests\"\n\nThis reverts commit c63d42e80473a0c18714b55058f27506fd24955c.", "tree": {"sha": "b690a017e0962e2d5f6faaf1039f3b1e3e6ab3d8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b690a017e0962e2d5f6faaf1039f3b1e3e6ab3d8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4fecede7fdaeeb859b066394bf27401fd13743a7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4fecede7fdaeeb859b066394bf27401fd13743a7", "html_url": "https://github.com/rust-lang/rust/commit/4fecede7fdaeeb859b066394bf27401fd13743a7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4fecede7fdaeeb859b066394bf27401fd13743a7/comments", "author": {"login": "calebcartwright", "id": 13042488, "node_id": "MDQ6VXNlcjEzMDQyNDg4", "avatar_url": "https://avatars.githubusercontent.com/u/13042488?v=4", "gravatar_id": "", "url": "https://api.github.com/users/calebcartwright", "html_url": "https://github.com/calebcartwright", "followers_url": "https://api.github.com/users/calebcartwright/followers", "following_url": "https://api.github.com/users/calebcartwright/following{/other_user}", "gists_url": "https://api.github.com/users/calebcartwright/gists{/gist_id}", "starred_url": "https://api.github.com/users/calebcartwright/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/calebcartwright/subscriptions", "organizations_url": "https://api.github.com/users/calebcartwright/orgs", "repos_url": "https://api.github.com/users/calebcartwright/repos", "events_url": "https://api.github.com/users/calebcartwright/events{/privacy}", "received_events_url": "https://api.github.com/users/calebcartwright/received_events", "type": "User", "site_admin": false}, "committer": {"login": "calebcartwright", "id": 13042488, "node_id": "MDQ6VXNlcjEzMDQyNDg4", "avatar_url": "https://avatars.githubusercontent.com/u/13042488?v=4", "gravatar_id": "", "url": "https://api.github.com/users/calebcartwright", "html_url": "https://github.com/calebcartwright", "followers_url": "https://api.github.com/users/calebcartwright/followers", "following_url": "https://api.github.com/users/calebcartwright/following{/other_user}", "gists_url": "https://api.github.com/users/calebcartwright/gists{/gist_id}", "starred_url": "https://api.github.com/users/calebcartwright/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/calebcartwright/subscriptions", "organizations_url": "https://api.github.com/users/calebcartwright/orgs", "repos_url": "https://api.github.com/users/calebcartwright/repos", "events_url": "https://api.github.com/users/calebcartwright/events{/privacy}", "received_events_url": "https://api.github.com/users/calebcartwright/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "63acf90044f9e27ca4683af9e8ec9afb6daa39f6", "url": "https://api.github.com/repos/rust-lang/rust/commits/63acf90044f9e27ca4683af9e8ec9afb6daa39f6", "html_url": "https://github.com/rust-lang/rust/commit/63acf90044f9e27ca4683af9e8ec9afb6daa39f6"}], "stats": {"total": 46, "additions": 34, "deletions": 12}, "files": [{"sha": "ab966d4a36075168684fea3103a6271694c33ca7", "filename": "src/test/mod.rs", "status": "modified", "additions": 34, "deletions": 12, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/4fecede7fdaeeb859b066394bf27401fd13743a7/src%2Ftest%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4fecede7fdaeeb859b066394bf27401fd13743a7/src%2Ftest%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmod.rs?ref=4fecede7fdaeeb859b066394bf27401fd13743a7", "patch": "@@ -375,21 +375,43 @@ fn idempotence_tests() {\n     });\n }\n \n+// Run rustfmt on itself. This operation must be idempotent. We also check that\n+// no warnings are emitted.\n+// Issue-3443: these tests require nightly\n #[nightly_only_test]\n #[test]\n fn self_tests() {\n-    let get_exe_path = |name| {\n-        let mut path = env::current_exe().unwrap();\n-        path.pop();\n-        path.set_file_name(format!(\"{name}{}\", env::consts::EXE_SUFFIX));\n-        path\n-    };\n-    let status = Command::new(get_exe_path(\"cargo-fmt\"))\n-        .args([\"--check\", \"--all\"])\n-        .env(\"RUSTFMT\", get_exe_path(\"rustfmt\"))\n-        .status()\n-        .unwrap();\n-    assert!(status.success());\n+    init_log();\n+    let mut files = get_test_files(Path::new(\"tests\"), false);\n+    let bin_directories = vec![\"cargo-fmt\", \"git-rustfmt\", \"bin\", \"format-diff\"];\n+    for dir in bin_directories {\n+        let mut path = PathBuf::from(\"src\");\n+        path.push(dir);\n+        path.push(\"main.rs\");\n+        files.push(path);\n+    }\n+    files.push(PathBuf::from(\"src/lib.rs\"));\n+\n+    let (reports, count, fails) = check_files(files, &Some(PathBuf::from(\"rustfmt.toml\")));\n+    let mut warnings = 0;\n+\n+    // Display results.\n+    println!(\"Ran {} self tests.\", count);\n+    assert_eq!(fails, 0, \"{} self tests failed\", fails);\n+\n+    for format_report in reports {\n+        println!(\n+            \"{}\",\n+            FormatReportFormatterBuilder::new(&format_report).build()\n+        );\n+        warnings += format_report.warning_count();\n+    }\n+\n+    assert_eq!(\n+        warnings, 0,\n+        \"Rustfmt's code generated {} warnings\",\n+        warnings\n+    );\n }\n \n #[test]"}]}