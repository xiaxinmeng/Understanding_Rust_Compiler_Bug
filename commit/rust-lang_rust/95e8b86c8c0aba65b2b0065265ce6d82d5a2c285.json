{"sha": "95e8b86c8c0aba65b2b0065265ce6d82d5a2c285", "node_id": "C_kwDOAAsO6NoAKDk1ZThiODZjOGMwYWJhNjViMmIwMDY1MjY1Y2U2ZDgyZDVhMmMyODU", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-07-13T05:24:18Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-07-13T05:24:18Z"}, "message": "Auto merge of #99149 - ferrocene:pa-nightly-branch, r=Mark-Simulacrum\n\nConfigure nightly branch name in `stage0.json`\n\nThe beta version number detection code relies on git to know how many merge commits were made since we branched off, and in doing so hardcodes `master` as the default branch name. This works for rust-lang/rust, but is problematic for forks that use a different default branch name (in Ferrocene we use `main` instead).\n\nThis PR changes the code to instead load the default branch name from `src/stage0.json`. `bump-stage0` has also been updated to remove the need to update it every time a new field is added to `stage0.json`.", "tree": {"sha": "9ac870bba91f79f5e4f3b34e2d7f3c59bb452080", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9ac870bba91f79f5e4f3b34e2d7f3c59bb452080"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/95e8b86c8c0aba65b2b0065265ce6d82d5a2c285", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/95e8b86c8c0aba65b2b0065265ce6d82d5a2c285", "html_url": "https://github.com/rust-lang/rust/commit/95e8b86c8c0aba65b2b0065265ce6d82d5a2c285", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/95e8b86c8c0aba65b2b0065265ce6d82d5a2c285/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7b5715289f813460ac95189fb7d3479e8edd23eb", "url": "https://api.github.com/repos/rust-lang/rust/commits/7b5715289f813460ac95189fb7d3479e8edd23eb", "html_url": "https://github.com/rust-lang/rust/commit/7b5715289f813460ac95189fb7d3479e8edd23eb"}, {"sha": "6bc97d0adcc7e9bd828de1ccf9c9ffc9b30165ee", "url": "https://api.github.com/repos/rust-lang/rust/commits/6bc97d0adcc7e9bd828de1ccf9c9ffc9b30165ee", "html_url": "https://github.com/rust-lang/rust/commit/6bc97d0adcc7e9bd828de1ccf9c9ffc9b30165ee"}], "stats": {"total": 28, "additions": 15, "deletions": 13}, "files": [{"sha": "62dd9a6b36502bb7bb76217261985c23e80eebc6", "filename": "src/bootstrap/config.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/95e8b86c8c0aba65b2b0065265ce6d82d5a2c285/src%2Fbootstrap%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/95e8b86c8c0aba65b2b0065265ce6d82d5a2c285/src%2Fbootstrap%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fconfig.rs?ref=95e8b86c8c0aba65b2b0065265ce6d82d5a2c285", "patch": "@@ -226,6 +226,7 @@ pub struct Stage0Config {\n     pub artifacts_server: String,\n     pub artifacts_with_llvm_assertions_server: String,\n     pub git_merge_commit_email: String,\n+    pub nightly_branch: String,\n }\n #[derive(Default, Deserialize)]\n #[cfg_attr(test, derive(Clone))]"}, {"sha": "cd421c249d8da660eb7f0fe5d9391b64a418182b", "filename": "src/bootstrap/lib.rs", "status": "modified", "additions": 5, "deletions": 8, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/95e8b86c8c0aba65b2b0065265ce6d82d5a2c285/src%2Fbootstrap%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/95e8b86c8c0aba65b2b0065265ce6d82d5a2c285/src%2Fbootstrap%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Flib.rs?ref=95e8b86c8c0aba65b2b0065265ce6d82d5a2c285", "patch": "@@ -1280,14 +1280,11 @@ impl Build {\n         // Figure out how many merge commits happened since we branched off master.\n         // That's our beta number!\n         // (Note that we use a `..` range, not the `...` symmetric difference.)\n-        let count = output(\n-            self.config\n-                .git()\n-                .arg(\"rev-list\")\n-                .arg(\"--count\")\n-                .arg(\"--merges\")\n-                .arg(\"refs/remotes/origin/master..HEAD\"),\n-        );\n+        let count =\n+            output(self.config.git().arg(\"rev-list\").arg(\"--count\").arg(\"--merges\").arg(format!(\n+                \"refs/remotes/origin/{}..HEAD\",\n+                self.config.stage0_metadata.config.nightly_branch\n+            )));\n         let n = count.trim().parse().unwrap();\n         self.prerelease_version.set(Some(n));\n         n"}, {"sha": "ab8a79e2af595d30e9d84ff0f3559476ff1a52ec", "filename": "src/stage0.json", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/95e8b86c8c0aba65b2b0065265ce6d82d5a2c285/src%2Fstage0.json", "raw_url": "https://github.com/rust-lang/rust/raw/95e8b86c8c0aba65b2b0065265ce6d82d5a2c285/src%2Fstage0.json", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fstage0.json?ref=95e8b86c8c0aba65b2b0065265ce6d82d5a2c285", "patch": "@@ -3,7 +3,8 @@\n     \"dist_server\": \"https://static.rust-lang.org\",\n     \"artifacts_server\": \"https://ci-artifacts.rust-lang.org/rustc-builds\",\n     \"artifacts_with_llvm_assertions_server\": \"https://ci-artifacts.rust-lang.org/rustc-builds-alt\",\n-    \"git_merge_commit_email\": \"bors@rust-lang.org\"\n+    \"git_merge_commit_email\": \"bors@rust-lang.org\",\n+    \"nightly_branch\": \"master\"\n   },\n   \"__comments\": [\n     \"The configuration above this comment is editable, and can be changed\","}, {"sha": "352a855561417c9981f2a5722d55be70a53e3faf", "filename": "src/tools/bump-stage0/Cargo.toml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/95e8b86c8c0aba65b2b0065265ce6d82d5a2c285/src%2Ftools%2Fbump-stage0%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/95e8b86c8c0aba65b2b0065265ce6d82d5a2c285/src%2Ftools%2Fbump-stage0%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fbump-stage0%2FCargo.toml?ref=95e8b86c8c0aba65b2b0065265ce6d82d5a2c285", "patch": "@@ -10,5 +10,5 @@ anyhow = \"1.0.34\"\n curl = \"0.4.38\"\n indexmap = { version = \"1.7.0\", features = [\"serde\"] }\n serde = { version = \"1.0.125\", features = [\"derive\"] }\n-serde_json = \"1.0.59\"\n+serde_json = { version = \"1.0.59\", features = [\"preserve_order\"] }\n toml = \"0.5.7\""}, {"sha": "aa346daf7e5f3a4b99d45b8440aab47507b095e4", "filename": "src/tools/bump-stage0/src/main.rs", "status": "modified", "additions": 6, "deletions": 3, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/95e8b86c8c0aba65b2b0065265ce6d82d5a2c285/src%2Ftools%2Fbump-stage0%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/95e8b86c8c0aba65b2b0065265ce6d82d5a2c285/src%2Ftools%2Fbump-stage0%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fbump-stage0%2Fsrc%2Fmain.rs?ref=95e8b86c8c0aba65b2b0065265ce6d82d5a2c285", "patch": "@@ -198,9 +198,12 @@ struct Stage0 {\n #[derive(Debug, serde::Serialize, serde::Deserialize)]\n struct Config {\n     dist_server: String,\n-    artifacts_server: String,\n-    artifacts_with_llvm_assertions_server: String,\n-    git_merge_commit_email: String,\n+    // There are other fields in the configuration, which will be read by src/bootstrap or other\n+    // tools consuming stage0.json. To avoid the need to update bump-stage0 every time a new field\n+    // is added, we collect all the fields in an untyped Value and serialize them back with the\n+    // same order and structure they were deserialized in.\n+    #[serde(flatten)]\n+    other: serde_json::Value,\n }\n \n #[derive(Debug, serde::Serialize, serde::Deserialize)]"}]}