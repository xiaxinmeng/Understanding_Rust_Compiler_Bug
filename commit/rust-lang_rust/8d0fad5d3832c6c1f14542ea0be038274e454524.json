{"sha": "8d0fad5d3832c6c1f14542ea0be038274e454524", "node_id": "MDY6Q29tbWl0NzI0NzEyOjhkMGZhZDVkMzgzMmM2YzFmMTQ1NDJlYTBiZTAzODI3NGU0NTQ1MjQ=", "commit": {"author": {"name": "Nicholas Nethercote", "email": "nnethercote@mozilla.com", "date": "2018-05-22T05:27:58Z"}, "committer": {"name": "Nicholas Nethercote", "email": "nnethercote@mozilla.com", "date": "2018-05-22T22:55:35Z"}, "message": "Shrink `LiveNode`.\n\n`Liveness::users` is a vector that is occasionally enormous. For\nexample, doing a \"clean incremental\" check build of `inflate`, there is\none instance that represents 5,499 live nodes and 1087 vars, which\nrequires 5,977,413 entries. At 24 bytes per entry, that is 143MB.\n\nThis patch changes LiveNode from a usize to a u32. On 64-bit machines\nthat halves the size of these entries, significantly reducing peak\nmemory usage and memory traffic, and speeding up \"clean incremental\"\nbuilds of `inflate` by about 10%.", "tree": {"sha": "b7be9ffb122750e8585070ba3b0a14cd50a7a90d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b7be9ffb122750e8585070ba3b0a14cd50a7a90d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8d0fad5d3832c6c1f14542ea0be038274e454524", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8d0fad5d3832c6c1f14542ea0be038274e454524", "html_url": "https://github.com/rust-lang/rust/commit/8d0fad5d3832c6c1f14542ea0be038274e454524", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8d0fad5d3832c6c1f14542ea0be038274e454524/comments", "author": {"login": "nnethercote", "id": 1940286, "node_id": "MDQ6VXNlcjE5NDAyODY=", "avatar_url": "https://avatars.githubusercontent.com/u/1940286?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nnethercote", "html_url": "https://github.com/nnethercote", "followers_url": "https://api.github.com/users/nnethercote/followers", "following_url": "https://api.github.com/users/nnethercote/following{/other_user}", "gists_url": "https://api.github.com/users/nnethercote/gists{/gist_id}", "starred_url": "https://api.github.com/users/nnethercote/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nnethercote/subscriptions", "organizations_url": "https://api.github.com/users/nnethercote/orgs", "repos_url": "https://api.github.com/users/nnethercote/repos", "events_url": "https://api.github.com/users/nnethercote/events{/privacy}", "received_events_url": "https://api.github.com/users/nnethercote/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nnethercote", "id": 1940286, "node_id": "MDQ6VXNlcjE5NDAyODY=", "avatar_url": "https://avatars.githubusercontent.com/u/1940286?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nnethercote", "html_url": "https://github.com/nnethercote", "followers_url": "https://api.github.com/users/nnethercote/followers", "following_url": "https://api.github.com/users/nnethercote/following{/other_user}", "gists_url": "https://api.github.com/users/nnethercote/gists{/gist_id}", "starred_url": "https://api.github.com/users/nnethercote/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nnethercote/subscriptions", "organizations_url": "https://api.github.com/users/nnethercote/orgs", "repos_url": "https://api.github.com/users/nnethercote/repos", "events_url": "https://api.github.com/users/nnethercote/events{/privacy}", "received_events_url": "https://api.github.com/users/nnethercote/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4c26e2e3fba61f18caca8bd43c57e1f1d799f07b", "url": "https://api.github.com/repos/rust-lang/rust/commits/4c26e2e3fba61f18caca8bd43c57e1f1d799f07b", "html_url": "https://github.com/rust-lang/rust/commit/4c26e2e3fba61f18caca8bd43c57e1f1d799f07b"}], "stats": {"total": 34, "additions": 14, "deletions": 20}, "files": [{"sha": "ad39f48972f69bff28969f87140d6aa8573f3243", "filename": "src/librustc/middle/liveness.rs", "status": "modified", "additions": 14, "deletions": 20, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/8d0fad5d3832c6c1f14542ea0be038274e454524/src%2Flibrustc%2Fmiddle%2Fliveness.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8d0fad5d3832c6c1f14542ea0be038274e454524/src%2Flibrustc%2Fmiddle%2Fliveness.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fliveness.rs?ref=8d0fad5d3832c6c1f14542ea0be038274e454524", "patch": "@@ -51,8 +51,8 @@\n //! enclosing function.  On the way down the tree, it identifies those AST\n //! nodes and variable IDs that will be needed for the liveness analysis\n //! and assigns them contiguous IDs.  The liveness id for an AST node is\n-//! called a `live_node` (it's a newtype'd usize) and the id for a variable\n-//! is called a `variable` (another newtype'd usize).\n+//! called a `live_node` (it's a newtype'd u32) and the id for a variable\n+//! is called a `variable` (another newtype'd u32).\n //!\n //! On the way back up the tree, as we are about to exit from a function\n //! declaration we allocate a `liveness` instance.  Now that we know\n@@ -112,7 +112,7 @@ use lint;\n use util::nodemap::{NodeMap, NodeSet};\n \n use std::collections::VecDeque;\n-use std::{fmt, usize};\n+use std::{fmt, u32};\n use std::io::prelude::*;\n use std::io;\n use std::rc::Rc;\n@@ -134,23 +134,17 @@ enum LoopKind<'a> {\n }\n \n #[derive(Copy, Clone, PartialEq)]\n-struct Variable(usize);\n+struct Variable(u32);\n \n-#[derive(Copy, PartialEq)]\n-struct LiveNode(usize);\n+#[derive(Copy, Clone, PartialEq)]\n+struct LiveNode(u32);\n \n impl Variable {\n-    fn get(&self) -> usize { let Variable(v) = *self; v }\n+    fn get(&self) -> usize { self.0 as usize }\n }\n \n impl LiveNode {\n-    fn get(&self) -> usize { let LiveNode(v) = *self; v }\n-}\n-\n-impl Clone for LiveNode {\n-    fn clone(&self) -> LiveNode {\n-        LiveNode(self.get())\n-    }\n+    fn get(&self) -> usize { self.0 as usize }\n }\n \n #[derive(Copy, Clone, PartialEq, Debug)]\n@@ -233,11 +227,11 @@ impl fmt::Debug for Variable {\n \n impl LiveNode {\n     fn is_valid(&self) -> bool {\n-        self.get() != usize::MAX\n+        self.0 != u32::MAX\n     }\n }\n \n-fn invalid_node() -> LiveNode { LiveNode(usize::MAX) }\n+fn invalid_node() -> LiveNode { LiveNode(u32::MAX) }\n \n struct CaptureInfo {\n     ln: LiveNode,\n@@ -285,7 +279,7 @@ impl<'a, 'tcx> IrMaps<'a, 'tcx> {\n     }\n \n     fn add_live_node(&mut self, lnk: LiveNodeKind) -> LiveNode {\n-        let ln = LiveNode(self.num_live_nodes);\n+        let ln = LiveNode(self.num_live_nodes as u32);\n         self.lnks.push(lnk);\n         self.num_live_nodes += 1;\n \n@@ -303,7 +297,7 @@ impl<'a, 'tcx> IrMaps<'a, 'tcx> {\n     }\n \n     fn add_variable(&mut self, vk: VarKind) -> Variable {\n-        let v = Variable(self.num_vars);\n+        let v = Variable(self.num_vars as u32);\n         self.var_kinds.push(vk);\n         self.num_vars += 1;\n \n@@ -708,7 +702,7 @@ impl<'a, 'tcx> Liveness<'a, 'tcx> {\n         for var_idx in 0..self.ir.num_vars {\n             let idx = node_base_idx + var_idx;\n             if test(idx).is_valid() {\n-                write!(wr, \" {:?}\", Variable(var_idx))?;\n+                write!(wr, \" {:?}\", Variable(var_idx as u32))?;\n             }\n         }\n         Ok(())\n@@ -848,7 +842,7 @@ impl<'a, 'tcx> Liveness<'a, 'tcx> {\n         debug!(\"^^ liveness computation results for body {} (entry={:?})\",\n                {\n                    for ln_idx in 0..self.ir.num_live_nodes {\n-                       debug!(\"{:?}\", self.ln_str(LiveNode(ln_idx)));\n+                       debug!(\"{:?}\", self.ln_str(LiveNode(ln_idx as u32)));\n                    }\n                    body.id\n                },"}]}