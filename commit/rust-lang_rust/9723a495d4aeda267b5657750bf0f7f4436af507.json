{"sha": "9723a495d4aeda267b5657750bf0f7f4436af507", "node_id": "MDY6Q29tbWl0NzI0NzEyOjk3MjNhNDk1ZDRhZWRhMjY3YjU2NTc3NTBiZjBmN2Y0NDM2YWY1MDc=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-12-22T17:46:11Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-12-22T17:46:11Z"}, "message": "Auto merge of #56680 - vakaras:issue56280, r=nagisa\n\nUse compiletest timestamp to check if the tests should be rerun.\n\nAn attempt to fix  #56280 by checking if timestamps of compile test files are older than the timestamp of the stamp file.\n\n?r nagisa", "tree": {"sha": "2d13b334e3ac75a87b68e6b78e3737e6a4045bb5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2d13b334e3ac75a87b68e6b78e3737e6a4045bb5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9723a495d4aeda267b5657750bf0f7f4436af507", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9723a495d4aeda267b5657750bf0f7f4436af507", "html_url": "https://github.com/rust-lang/rust/commit/9723a495d4aeda267b5657750bf0f7f4436af507", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9723a495d4aeda267b5657750bf0f7f4436af507/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "fa922ab876cb3140de2ead9c8ad88a75982c167c", "url": "https://api.github.com/repos/rust-lang/rust/commits/fa922ab876cb3140de2ead9c8ad88a75982c167c", "html_url": "https://github.com/rust-lang/rust/commit/fa922ab876cb3140de2ead9c8ad88a75982c167c"}, {"sha": "d966e57407fc2c09ce3345b7d797633aa4046912", "url": "https://api.github.com/repos/rust-lang/rust/commits/d966e57407fc2c09ce3345b7d797633aa4046912", "html_url": "https://github.com/rust-lang/rust/commit/d966e57407fc2c09ce3345b7d797633aa4046912"}], "stats": {"total": 27, "additions": 17, "deletions": 10}, "files": [{"sha": "365d14c579bdb2463345152758cd2da5e4ab7c90", "filename": "Cargo.lock", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/9723a495d4aeda267b5657750bf0f7f4436af507/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/9723a495d4aeda267b5657750bf0f7f4436af507/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=9723a495d4aeda267b5657750bf0f7f4436af507", "patch": "@@ -431,6 +431,7 @@ dependencies = [\n  \"serde 1.0.81 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"serde_derive 1.0.81 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"serde_json 1.0.33 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"walkdir 2.2.7 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"winapi 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)\",\n ]\n "}, {"sha": "edf4aeab1c70fb1ba0c4fa1e1186c8ae416d28d7", "filename": "src/tools/compiletest/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/9723a495d4aeda267b5657750bf0f7f4436af507/src%2Ftools%2Fcompiletest%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/9723a495d4aeda267b5657750bf0f7f4436af507/src%2Ftools%2Fcompiletest%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2FCargo.toml?ref=9723a495d4aeda267b5657750bf0f7f4436af507", "patch": "@@ -15,6 +15,7 @@ serde_json = \"1.0\"\n serde_derive = \"1.0\"\n rustfix = \"0.4.1\"\n lazy_static = \"1.0\"\n+walkdir = \"2\"\n \n [target.'cfg(unix)'.dependencies]\n libc = \"0.2\""}, {"sha": "a532e900ea3e0854e953876c0907d058c320ab24", "filename": "src/tools/compiletest/src/main.rs", "status": "modified", "additions": 15, "deletions": 10, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/9723a495d4aeda267b5657750bf0f7f4436af507/src%2Ftools%2Fcompiletest%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9723a495d4aeda267b5657750bf0f7f4436af507/src%2Ftools%2Fcompiletest%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fmain.rs?ref=9723a495d4aeda267b5657750bf0f7f4436af507", "patch": "@@ -28,6 +28,7 @@ extern crate serde_derive;\n extern crate serde_json;\n extern crate test;\n extern crate rustfix;\n+extern crate walkdir;\n \n use common::CompareMode;\n use common::{expected_output_path, output_base_dir, output_relative_path, UI_EXTENSIONS};\n@@ -43,6 +44,7 @@ use std::path::{Path, PathBuf};\n use std::process::Command;\n use test::ColorConfig;\n use util::logv;\n+use walkdir::WalkDir;\n \n use self::header::{EarlyProps, Ignore};\n \n@@ -682,6 +684,15 @@ fn stamp(config: &Config, testpaths: &TestPaths, revision: Option<&str>) -> Path\n     output_base_dir(config, testpaths, revision).join(\"stamp\")\n }\n \n+/// Return an iterator over timestamps of files in the directory at `path`.\n+fn collect_timestamps(path: &PathBuf) -> impl Iterator<Item=FileTime> {\n+    WalkDir::new(path)\n+        .into_iter()\n+        .map(|entry| entry.unwrap())\n+        .filter(|entry| entry.metadata().unwrap().is_file())\n+        .map(|entry| mtime(entry.path()))\n+}\n+\n fn up_to_date(\n     config: &Config,\n     testpaths: &TestPaths,\n@@ -725,16 +736,7 @@ fn up_to_date(\n     for pretty_printer_file in &pretty_printer_files {\n         inputs.push(mtime(&rust_src_dir.join(pretty_printer_file)));\n     }\n-    let mut entries = config.run_lib_path.read_dir().unwrap().collect::<Vec<_>>();\n-    while let Some(entry) = entries.pop() {\n-        let entry = entry.unwrap();\n-        let path = entry.path();\n-        if entry.metadata().unwrap().is_file() {\n-            inputs.push(mtime(&path));\n-        } else {\n-            entries.extend(path.read_dir().unwrap());\n-        }\n-    }\n+    inputs.extend(collect_timestamps(&config.run_lib_path));\n     if let Some(ref rustdoc_path) = config.rustdoc_path {\n         inputs.push(mtime(&rustdoc_path));\n         inputs.push(mtime(&rust_src_dir.join(\"src/etc/htmldocck.py\")));\n@@ -746,6 +748,9 @@ fn up_to_date(\n         inputs.push(mtime(path));\n     }\n \n+    // Compiletest itself.\n+    inputs.extend(collect_timestamps(&rust_src_dir.join(\"src/tools/compiletest/\")));\n+\n     inputs.iter().any(|input| *input > stamp)\n }\n "}]}