{"sha": "1d4388f6bd02e6dda816028f0bdac7b39225ca0b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFkNDM4OGY2YmQwMmU2ZGRhODE2MDI4ZjBiZGFjN2IzOTIyNWNhMGI=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-06-19T19:47:30Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-06-19T19:47:30Z"}, "message": "Merge #4950\n\n4950: Use correct substs for super trait assoc types r=matklad a=flodiebold\n\nWhen referring to an associated type of a super trait, we used the substs of the\r\nsubtrait. That led to the #4931 crash if the subtrait had less parameters, but\r\nit could also lead to other incorrectness if just the order was different.\r\n\r\nFixes #4931.\n\nCo-authored-by: Florian Diebold <florian.diebold@freiheit.com>", "tree": {"sha": "518fe5b3895e021e1d35e90d6e7d71abfc36692a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/518fe5b3895e021e1d35e90d6e7d71abfc36692a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1d4388f6bd02e6dda816028f0bdac7b39225ca0b", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJe7RZSCRBK7hj4Ov3rIwAAdHIIAFFqg7Zi6lXzRb1Xr03Ge7CO\nc+tXyoU+bfPcUm+PQB3oWfIemZmH6RoubSnpOKn7pnzOd+dzfWqwH5wX4nnqlVuP\nlwwVleYq6vsqLp1rLiVtlXX42MwKXZHMnN5DpN+KTPql/j23ak6jJmZYMhzOt+si\ndgmhjhAprxLMHjV0CrNGQ1yf52S6cT2ly+0VaBxSgKLquMlCJO8Q0jPJ32ArM6qZ\nQyakBelJiM9hXLw4aOWUHTz+5m5U6DVcm+UEQNzJ5MxJJZ1jsp2bIhBCzGpMWx+M\nRn+Jt8s7m2ibJMkNkVuQrE1+BtZ+5PtAGTWiJU628mSy6dtEG+fFzjZHbIYn3Ks=\n=aOdF\n-----END PGP SIGNATURE-----\n", "payload": "tree 518fe5b3895e021e1d35e90d6e7d71abfc36692a\nparent 6654055308515cb330f23942f347de5605f69be1\nparent 2745cb37c16600c99083cefdf5eb45a5205dd86d\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1592596050 +0000\ncommitter GitHub <noreply@github.com> 1592596050 +0000\n\nMerge #4950\n\n4950: Use correct substs for super trait assoc types r=matklad a=flodiebold\n\nWhen referring to an associated type of a super trait, we used the substs of the\r\nsubtrait. That led to the #4931 crash if the subtrait had less parameters, but\r\nit could also lead to other incorrectness if just the order was different.\r\n\r\nFixes #4931.\n\nCo-authored-by: Florian Diebold <florian.diebold@freiheit.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1d4388f6bd02e6dda816028f0bdac7b39225ca0b", "html_url": "https://github.com/rust-lang/rust/commit/1d4388f6bd02e6dda816028f0bdac7b39225ca0b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1d4388f6bd02e6dda816028f0bdac7b39225ca0b/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6654055308515cb330f23942f347de5605f69be1", "url": "https://api.github.com/repos/rust-lang/rust/commits/6654055308515cb330f23942f347de5605f69be1", "html_url": "https://github.com/rust-lang/rust/commit/6654055308515cb330f23942f347de5605f69be1"}, {"sha": "2745cb37c16600c99083cefdf5eb45a5205dd86d", "url": "https://api.github.com/repos/rust-lang/rust/commits/2745cb37c16600c99083cefdf5eb45a5205dd86d", "html_url": "https://github.com/rust-lang/rust/commit/2745cb37c16600c99083cefdf5eb45a5205dd86d"}], "stats": {"total": 64, "additions": 47, "deletions": 17}, "files": [{"sha": "7a7fcb0aba64e47faf7db541558f90a5647e1338", "filename": "crates/ra_hir_ty/src/lower.rs", "status": "modified", "additions": 11, "deletions": 11, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/1d4388f6bd02e6dda816028f0bdac7b39225ca0b/crates%2Fra_hir_ty%2Fsrc%2Flower.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d4388f6bd02e6dda816028f0bdac7b39225ca0b/crates%2Fra_hir_ty%2Fsrc%2Flower.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_ty%2Fsrc%2Flower.rs?ref=1d4388f6bd02e6dda816028f0bdac7b39225ca0b", "patch": "@@ -337,17 +337,17 @@ impl Ty {\n                     TraitRef::from_resolved_path(ctx, trait_, resolved_segment, self_ty);\n                 let ty = if remaining_segments.len() == 1 {\n                     let segment = remaining_segments.first().unwrap();\n-                    let associated_ty = associated_type_by_name_including_super_traits(\n-                        ctx.db.upcast(),\n-                        trait_ref.trait_,\n+                    let found = associated_type_by_name_including_super_traits(\n+                        ctx.db,\n+                        trait_ref.clone(),\n                         &segment.name,\n                     );\n-                    match associated_ty {\n-                        Some(associated_ty) => {\n+                    match found {\n+                        Some((super_trait_ref, associated_ty)) => {\n                             // FIXME handle type parameters on the segment\n                             Ty::Projection(ProjectionTy {\n                                 associated_ty,\n-                                parameters: trait_ref.substs,\n+                                parameters: super_trait_ref.substs,\n                             })\n                         }\n                         None => {\n@@ -706,17 +706,17 @@ fn assoc_type_bindings_from_type_bound<'a>(\n         .flat_map(|segment| segment.args_and_bindings.into_iter())\n         .flat_map(|args_and_bindings| args_and_bindings.bindings.iter())\n         .flat_map(move |binding| {\n-            let associated_ty = associated_type_by_name_including_super_traits(\n-                ctx.db.upcast(),\n-                trait_ref.trait_,\n+            let found = associated_type_by_name_including_super_traits(\n+                ctx.db,\n+                trait_ref.clone(),\n                 &binding.name,\n             );\n-            let associated_ty = match associated_ty {\n+            let (super_trait_ref, associated_ty) = match found {\n                 None => return SmallVec::<[GenericPredicate; 1]>::new(),\n                 Some(t) => t,\n             };\n             let projection_ty =\n-                ProjectionTy { associated_ty, parameters: trait_ref.substs.clone() };\n+                ProjectionTy { associated_ty, parameters: super_trait_ref.substs.clone() };\n             let mut preds = SmallVec::with_capacity(\n                 binding.type_ref.as_ref().map_or(0, |_| 1) + binding.bounds.len(),\n             );"}, {"sha": "8dc5603b747d7f1d77b7868b7923094a9bdf92a3", "filename": "crates/ra_hir_ty/src/tests/regression.rs", "status": "modified", "additions": 28, "deletions": 0, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/1d4388f6bd02e6dda816028f0bdac7b39225ca0b/crates%2Fra_hir_ty%2Fsrc%2Ftests%2Fregression.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d4388f6bd02e6dda816028f0bdac7b39225ca0b/crates%2Fra_hir_ty%2Fsrc%2Ftests%2Fregression.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_ty%2Fsrc%2Ftests%2Fregression.rs?ref=1d4388f6bd02e6dda816028f0bdac7b39225ca0b", "patch": "@@ -665,3 +665,31 @@ impl Foo<i64> {\n     \"###\n     );\n }\n+\n+#[test]\n+fn issue_4931() {\n+    assert_snapshot!(\n+        infer(r#\"\n+trait Div<T> {\n+    type Output;\n+}\n+\n+trait CheckedDiv: Div<()> {}\n+\n+trait PrimInt: CheckedDiv<Output = ()> {\n+    fn pow(self);\n+}\n+\n+fn check<T: PrimInt>(i: T) {\n+    i.pow();\n+}\n+\"#),\n+        @r###\"\n+    118..122 'self': Self\n+    149..150 'i': T\n+    155..171 '{     ...w(); }': ()\n+    161..162 'i': T\n+    161..168 'i.pow()': ()\n+    \"###\n+    );\n+}"}, {"sha": "c45820ff059bfd5ebfca3279b614321e3a59e271", "filename": "crates/ra_hir_ty/src/utils.rs", "status": "modified", "additions": 8, "deletions": 6, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/1d4388f6bd02e6dda816028f0bdac7b39225ca0b/crates%2Fra_hir_ty%2Fsrc%2Futils.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d4388f6bd02e6dda816028f0bdac7b39225ca0b/crates%2Fra_hir_ty%2Fsrc%2Futils.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_ty%2Fsrc%2Futils.rs?ref=1d4388f6bd02e6dda816028f0bdac7b39225ca0b", "patch": "@@ -143,13 +143,14 @@ pub(super) fn find_super_trait_path(\n }\n \n pub(super) fn associated_type_by_name_including_super_traits(\n-    db: &dyn DefDatabase,\n-    trait_: TraitId,\n+    db: &dyn HirDatabase,\n+    trait_ref: TraitRef,\n     name: &Name,\n-) -> Option<TypeAliasId> {\n-    all_super_traits(db, trait_)\n-        .into_iter()\n-        .find_map(|t| db.trait_data(t).associated_type_by_name(name))\n+) -> Option<(TraitRef, TypeAliasId)> {\n+    all_super_trait_refs(db, trait_ref).into_iter().find_map(|t| {\n+        let assoc_type = db.trait_data(t.trait_).associated_type_by_name(name)?;\n+        Some((t, assoc_type))\n+    })\n }\n \n pub(super) fn variant_data(db: &dyn DefDatabase, var: VariantId) -> Arc<VariantData> {\n@@ -176,6 +177,7 @@ pub(crate) fn generics(db: &dyn DefDatabase, def: GenericDefId) -> Generics {\n     Generics { def, params: db.generic_params(def), parent_generics }\n }\n \n+#[derive(Debug)]\n pub(crate) struct Generics {\n     def: GenericDefId,\n     pub(crate) params: Arc<GenericParams>,"}]}