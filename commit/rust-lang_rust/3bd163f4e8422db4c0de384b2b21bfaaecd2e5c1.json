{"sha": "3bd163f4e8422db4c0de384b2b21bfaaecd2e5c1", "node_id": "C_kwDOAAsO6NoAKDNiZDE2M2Y0ZTg0MjJkYjRjMGRlMzg0YjJiMjFiZmFhZWNkMmU1YzE", "commit": {"author": {"name": "Dylan DPC", "email": "99973273+Dylan-DPC@users.noreply.github.com", "date": "2022-02-24T20:42:19Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-02-24T20:42:19Z"}, "message": "Rollup merge of #94327 - Mark-Simulacrum:avoid-macro-sp, r=petrochenkov\n\nAvoid emitting full macro body into JSON errors\n\nWhile investigating https://github.com/rust-lang/rust/issues/94322, it was noted that currently the JSON diagnostics for macro backtraces include the full def_site span -- the whole macro body.\n\nIt seems like this shouldn't be necessary, so this PR adjusts the span to just be the \"guessed head\", typically the macro name. It doesn't look like we keep enough information to synthesize a nicer span here at this time.\n\nAtop #92123, this reduces output for the src/test/ui/suggestions/missing-lifetime-specifier.rs test from 660 KB to 156 KB locally.", "tree": {"sha": "23fbd4cd23c587684432375a288e303b80be8051", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/23fbd4cd23c587684432375a288e303b80be8051"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3bd163f4e8422db4c0de384b2b21bfaaecd2e5c1", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJiF+2rCRBK7hj4Ov3rIwAAxQcIAAlEfTkcse6mzToJCJRsnQzA\nFBlUtc196wd2XN24fMo+zt+ryRjOwfUzNwCjPyFvxoO0WqiEFjPe9dlrB3qDFMl1\nsiEd74J40ZmHUuSoiSveBbQ4eGZVNjBYcPQP20668PL1Gwn1VkRhMhpIJ5T3MYE5\n85qlzYnFSe4WmygJwEKsWxEIRnZe01LbShWigPRwj97CLvNhNgSkK0F++KzKnyoU\nY2UShOqlMDQdWn5bWwbF+2t9HTv2uqH8CJN/2heAlo+dPDIRf+p1d70/5H758snw\nRLjzfwgcBPQTR6V2seKJvX3dmhLo+tO5myzJkzyH/BbDvmRzCZHpbyX7WpZBnlg=\n=9AgQ\n-----END PGP SIGNATURE-----\n", "payload": "tree 23fbd4cd23c587684432375a288e303b80be8051\nparent ec44d48ae396e596f07ecc496f95da2b5ec36223\nparent 34319ff4e1d4b50a2406c03df0befe15362b4227\nauthor Dylan DPC <99973273+Dylan-DPC@users.noreply.github.com> 1645735339 +0100\ncommitter GitHub <noreply@github.com> 1645735339 +0100\n\nRollup merge of #94327 - Mark-Simulacrum:avoid-macro-sp, r=petrochenkov\n\nAvoid emitting full macro body into JSON errors\n\nWhile investigating https://github.com/rust-lang/rust/issues/94322, it was noted that currently the JSON diagnostics for macro backtraces include the full def_site span -- the whole macro body.\n\nIt seems like this shouldn't be necessary, so this PR adjusts the span to just be the \"guessed head\", typically the macro name. It doesn't look like we keep enough information to synthesize a nicer span here at this time.\n\nAtop #92123, this reduces output for the src/test/ui/suggestions/missing-lifetime-specifier.rs test from 660 KB to 156 KB locally.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3bd163f4e8422db4c0de384b2b21bfaaecd2e5c1", "html_url": "https://github.com/rust-lang/rust/commit/3bd163f4e8422db4c0de384b2b21bfaaecd2e5c1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3bd163f4e8422db4c0de384b2b21bfaaecd2e5c1/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ec44d48ae396e596f07ecc496f95da2b5ec36223", "url": "https://api.github.com/repos/rust-lang/rust/commits/ec44d48ae396e596f07ecc496f95da2b5ec36223", "html_url": "https://github.com/rust-lang/rust/commit/ec44d48ae396e596f07ecc496f95da2b5ec36223"}, {"sha": "34319ff4e1d4b50a2406c03df0befe15362b4227", "url": "https://api.github.com/repos/rust-lang/rust/commits/34319ff4e1d4b50a2406c03df0befe15362b4227", "html_url": "https://github.com/rust-lang/rust/commit/34319ff4e1d4b50a2406c03df0befe15362b4227"}], "stats": {"total": 10, "additions": 8, "deletions": 2}, "files": [{"sha": "dc28d1bb4523496cf09107f8310fb658c6ae6565", "filename": "compiler/rustc_errors/src/json.rs", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/3bd163f4e8422db4c0de384b2b21bfaaecd2e5c1/compiler%2Frustc_errors%2Fsrc%2Fjson.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3bd163f4e8422db4c0de384b2b21bfaaecd2e5c1/compiler%2Frustc_errors%2Fsrc%2Fjson.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_errors%2Fsrc%2Fjson.rs?ref=3bd163f4e8422db4c0de384b2b21bfaaecd2e5c1", "patch": "@@ -454,8 +454,14 @@ impl DiagnosticSpan {\n         let end = je.sm.lookup_char_pos(span.hi());\n         let backtrace_step = backtrace.next().map(|bt| {\n             let call_site = Self::from_span_full(bt.call_site, false, None, None, backtrace, je);\n-            let def_site_span =\n-                Self::from_span_full(bt.def_site, false, None, None, [].into_iter(), je);\n+            let def_site_span = Self::from_span_full(\n+                je.sm.guess_head_span(bt.def_site),\n+                false,\n+                None,\n+                None,\n+                [].into_iter(),\n+                je,\n+            );\n             Box::new(DiagnosticSpanMacroExpansion {\n                 span: call_site,\n                 macro_decl_name: bt.kind.descr(),"}]}