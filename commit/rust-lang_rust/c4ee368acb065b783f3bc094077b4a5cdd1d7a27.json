{"sha": "c4ee368acb065b783f3bc094077b4a5cdd1d7a27", "node_id": "C_kwDOAAsO6NoAKGM0ZWUzNjhhY2IwNjViNzgzZjNiYzA5NDA3N2I0YTVjZGQxZDdhMjc", "commit": {"author": {"name": "Mateusz Gienieczko", "email": "mat@gienieczko.com", "date": "2022-05-21T16:17:25Z"}, "committer": {"name": "Mateusz Gienieczko", "email": "mat@gienieczko.com", "date": "2022-05-21T16:17:25Z"}, "message": "Set page size in GetSystemInfo.", "tree": {"sha": "a3446186368c8b4fe4f4cc951ca81924c107d8c6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a3446186368c8b4fe4f4cc951ca81924c107d8c6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c4ee368acb065b783f3bc094077b4a5cdd1d7a27", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niHUEABYIAB0WIQS6ttWmD/dycqbuYdU4bLXkFRN0aQUCYokQlQAKCRA4bLXkFRN0\naUKVAQDeiTj5uZ1EUP7UKXUkG6thUTRllWGG8dQ4hocLE35f6QD+NH3TtglcCBT8\nS1uxYDjDV5gcF4HCj7hf54LT+EGNygw=\n=Tq7A\n-----END PGP SIGNATURE-----", "payload": "tree a3446186368c8b4fe4f4cc951ca81924c107d8c6\nparent e932ea50ba21b355b08a5572a20cb53d2c74aacb\nauthor Mateusz Gienieczko <mat@gienieczko.com> 1653149845 +0200\ncommitter Mateusz Gienieczko <mat@gienieczko.com> 1653149845 +0200\n\nSet page size in GetSystemInfo.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c4ee368acb065b783f3bc094077b4a5cdd1d7a27", "html_url": "https://github.com/rust-lang/rust/commit/c4ee368acb065b783f3bc094077b4a5cdd1d7a27", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c4ee368acb065b783f3bc094077b4a5cdd1d7a27/comments", "author": {"login": "V0ldek", "id": 20441980, "node_id": "MDQ6VXNlcjIwNDQxOTgw", "avatar_url": "https://avatars.githubusercontent.com/u/20441980?v=4", "gravatar_id": "", "url": "https://api.github.com/users/V0ldek", "html_url": "https://github.com/V0ldek", "followers_url": "https://api.github.com/users/V0ldek/followers", "following_url": "https://api.github.com/users/V0ldek/following{/other_user}", "gists_url": "https://api.github.com/users/V0ldek/gists{/gist_id}", "starred_url": "https://api.github.com/users/V0ldek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/V0ldek/subscriptions", "organizations_url": "https://api.github.com/users/V0ldek/orgs", "repos_url": "https://api.github.com/users/V0ldek/repos", "events_url": "https://api.github.com/users/V0ldek/events{/privacy}", "received_events_url": "https://api.github.com/users/V0ldek/received_events", "type": "User", "site_admin": false}, "committer": {"login": "V0ldek", "id": 20441980, "node_id": "MDQ6VXNlcjIwNDQxOTgw", "avatar_url": "https://avatars.githubusercontent.com/u/20441980?v=4", "gravatar_id": "", "url": "https://api.github.com/users/V0ldek", "html_url": "https://github.com/V0ldek", "followers_url": "https://api.github.com/users/V0ldek/followers", "following_url": "https://api.github.com/users/V0ldek/following{/other_user}", "gists_url": "https://api.github.com/users/V0ldek/gists{/gist_id}", "starred_url": "https://api.github.com/users/V0ldek/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/V0ldek/subscriptions", "organizations_url": "https://api.github.com/users/V0ldek/orgs", "repos_url": "https://api.github.com/users/V0ldek/repos", "events_url": "https://api.github.com/users/V0ldek/events{/privacy}", "received_events_url": "https://api.github.com/users/V0ldek/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e932ea50ba21b355b08a5572a20cb53d2c74aacb", "url": "https://api.github.com/repos/rust-lang/rust/commits/e932ea50ba21b355b08a5572a20cb53d2c74aacb", "html_url": "https://github.com/rust-lang/rust/commit/e932ea50ba21b355b08a5572a20cb53d2c74aacb"}], "stats": {"total": 15, "additions": 13, "deletions": 2}, "files": [{"sha": "8fc599dd2d0b1827da73a67ef6be66e3626afc7e", "filename": "src/shims/windows/foreign_items.rs", "status": "modified", "additions": 13, "deletions": 2, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/c4ee368acb065b783f3bc094077b4a5cdd1d7a27/src%2Fshims%2Fwindows%2Fforeign_items.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c4ee368acb065b783f3bc094077b4a5cdd1d7a27/src%2Fshims%2Fwindows%2Fforeign_items.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fshims%2Fwindows%2Fforeign_items.rs?ref=c4ee368acb065b783f3bc094077b4a5cdd1d7a27", "patch": "@@ -119,9 +119,20 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n                     system_info.ptr,\n                     iter::repeat(0u8).take(system_info.layout.size.bytes() as usize),\n                 )?;\n-                // Set number of processors.\n                 let dword_size = Size::from_bytes(4);\n-                let num_cpus = this.mplace_field(&system_info, 6)?;\n+\n+                // In WinApi SYSTEM_INFO's first field is a 4-byte union, but num_cpus\n+                // inlines it as two 2-byte fields. In num_cpus case all fields are offset by 1\n+                // compared to WinApi. See https://github.com/rust-lang/miri/issues/2136#issuecomment-1133661262.\n+                let first_field = this.mplace_field(&system_info, 0)?;\n+                let offset = if first_field.layout.size.bytes() == 2 { 1 } else { 0 };\n+\n+                let page_size = this.mplace_field(&system_info, 1 + offset)?;\n+                let num_cpus = this.mplace_field(&system_info, 5 + offset)?;\n+\n+                // Set page size.\n+                this.write_scalar(Scalar::from_int(PAGE_SIZE, dword_size), &page_size.into())?;\n+                // Set number of processors.\n                 this.write_scalar(Scalar::from_int(NUM_CPUS, dword_size), &num_cpus.into())?;\n             }\n "}]}