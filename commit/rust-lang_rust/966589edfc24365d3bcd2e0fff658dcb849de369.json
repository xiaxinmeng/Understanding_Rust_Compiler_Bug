{"sha": "966589edfc24365d3bcd2e0fff658dcb849de369", "node_id": "MDY6Q29tbWl0NzI0NzEyOjk2NjU4OWVkZmMyNDM2NWQzYmNkMmUwZmZmNjU4ZGNiODQ5ZGUzNjk=", "commit": {"author": {"name": "Dylan DPC", "email": "dylan.dpc@gmail.com", "date": "2020-05-09T01:10:11Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-05-09T01:10:11Z"}, "message": "Rollup merge of #71947 - mibac138:dead-code, r=cramertj\n\nDead-code pass highlights too much of impl functions\n\nFixes #66627.\nPrevious diagnostic:\n```\nerror: method is never used: `unused_impl_fn_3`\n  --> src/main.rs:28:5\n   |\n28 | /     fn unused_impl_fn_3(\n29 | |         var: i32,\n30 | |     ) {\n31 | |         println!(\"bar {}\", var);\n32 | |     }\n   | |_____^\n```\nNew diagnostic:\n```\nerror: associated function is never used: `unused_impl_fn_3`\n  --> $DIR/lint-dead-code-6.rs:13:8\n   |\nLL |     fn unused_impl_fn_3(\n   |        ^^^^^^^^^^^^^^^^\n```\n\nThis makes associated functions in line with free-standing functions.", "tree": {"sha": "a007bacdbaff934e1975f26b82ef87a81251b52d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a007bacdbaff934e1975f26b82ef87a81251b52d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/966589edfc24365d3bcd2e0fff658dcb849de369", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJetgLzCRBK7hj4Ov3rIwAAdHIIAJrFT05ETzp/fkFuH6lSk3pr\nCEiqsgZgyNsmFNwZEmEvapWQtnojiDSIJEVpZG3AdYXUYikcJUrypILHKlfwDJ4m\nSFnYbNnCGGwBA2983UTtvDi7DCTSc1d+z5JmSfvrGP+0inREGqLHauF1CwFZRmuW\nJVPtuxVF9ETEV8x4J3UCpFIA4Q7GadODk2g+d9neUu1w+bNdVTI3gqnYD2PPsc8C\nF0Xq3bVjGl6wDiA33G+LH6dDL+g3Uu2mrASdpM/28lFQAAw3nLtyye7w3FAR4w4E\nYvAyaFB7pnkPJikFcabzqmEt7EsxskaQeK5uh4taIBqxNGliB2z1p4ldGFAVfw0=\n=dbtT\n-----END PGP SIGNATURE-----\n", "payload": "tree a007bacdbaff934e1975f26b82ef87a81251b52d\nparent 2b3a114633c23acb96f94ed66b620e74b832c19b\nparent b6d5d1fb7901b4c0fe4c9ffa2854f616fd60e541\nauthor Dylan DPC <dylan.dpc@gmail.com> 1588986611 +0200\ncommitter GitHub <noreply@github.com> 1588986611 +0200\n\nRollup merge of #71947 - mibac138:dead-code, r=cramertj\n\nDead-code pass highlights too much of impl functions\n\nFixes #66627.\nPrevious diagnostic:\n```\nerror: method is never used: `unused_impl_fn_3`\n  --> src/main.rs:28:5\n   |\n28 | /     fn unused_impl_fn_3(\n29 | |         var: i32,\n30 | |     ) {\n31 | |         println!(\"bar {}\", var);\n32 | |     }\n   | |_____^\n```\nNew diagnostic:\n```\nerror: associated function is never used: `unused_impl_fn_3`\n  --> $DIR/lint-dead-code-6.rs:13:8\n   |\nLL |     fn unused_impl_fn_3(\n   |        ^^^^^^^^^^^^^^^^\n```\n\nThis makes associated functions in line with free-standing functions.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/966589edfc24365d3bcd2e0fff658dcb849de369", "html_url": "https://github.com/rust-lang/rust/commit/966589edfc24365d3bcd2e0fff658dcb849de369", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/966589edfc24365d3bcd2e0fff658dcb849de369/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2b3a114633c23acb96f94ed66b620e74b832c19b", "url": "https://api.github.com/repos/rust-lang/rust/commits/2b3a114633c23acb96f94ed66b620e74b832c19b", "html_url": "https://github.com/rust-lang/rust/commit/2b3a114633c23acb96f94ed66b620e74b832c19b"}, {"sha": "b6d5d1fb7901b4c0fe4c9ffa2854f616fd60e541", "url": "https://api.github.com/repos/rust-lang/rust/commits/b6d5d1fb7901b4c0fe4c9ffa2854f616fd60e541", "html_url": "https://github.com/rust-lang/rust/commit/b6d5d1fb7901b4c0fe4c9ffa2854f616fd60e541"}], "stats": {"total": 70, "additions": 66, "deletions": 4}, "files": [{"sha": "22ff87efd2edef72b8e6bcf167175640fe9c9bae", "filename": "src/librustc_passes/dead.rs", "status": "modified", "additions": 12, "deletions": 2, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/966589edfc24365d3bcd2e0fff658dcb849de369/src%2Flibrustc_passes%2Fdead.rs", "raw_url": "https://github.com/rust-lang/rust/raw/966589edfc24365d3bcd2e0fff658dcb849de369/src%2Flibrustc_passes%2Fdead.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_passes%2Fdead.rs?ref=966589edfc24365d3bcd2e0fff658dcb849de369", "patch": "@@ -589,7 +589,7 @@ impl Visitor<'tcx> for DeadVisitor<'tcx> {\n                     // FIXME(66095): Because item.span is annotated with things\n                     // like expansion data, and ident.span isn't, we use the\n                     // def_span method if it's part of a macro invocation\n-                    // (and thus has asource_callee set).\n+                    // (and thus has a source_callee set).\n                     // We should probably annotate ident.span with the macro\n                     // context, but that's a larger change.\n                     if item.span.source_callee().is_some() {\n@@ -653,7 +653,17 @@ impl Visitor<'tcx> for DeadVisitor<'tcx> {\n             }\n             hir::ImplItemKind::Fn(_, body_id) => {\n                 if !self.symbol_is_live(impl_item.hir_id) {\n-                    let span = self.tcx.sess.source_map().guess_head_span(impl_item.span);\n+                    // FIXME(66095): Because impl_item.span is annotated with things\n+                    // like expansion data, and ident.span isn't, we use the\n+                    // def_span method if it's part of a macro invocation\n+                    // (and thus has a source_callee set).\n+                    // We should probably annotate ident.span with the macro\n+                    // context, but that's a larger change.\n+                    let span = if impl_item.span.source_callee().is_some() {\n+                        self.tcx.sess.source_map().guess_head_span(impl_item.span)\n+                    } else {\n+                        impl_item.ident.span\n+                    };\n                     self.warn_dead_code(impl_item.hir_id, span, impl_item.ident.name, \"used\");\n                 }\n                 self.visit_nested_body(body_id)"}, {"sha": "6d174e8d9bc382bc9d554ab7635535eae60fa47f", "filename": "src/test/ui/lint/dead-code/lint-dead-code-3.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/966589edfc24365d3bcd2e0fff658dcb849de369/src%2Ftest%2Fui%2Flint%2Fdead-code%2Flint-dead-code-3.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/966589edfc24365d3bcd2e0fff658dcb849de369/src%2Ftest%2Fui%2Flint%2Fdead-code%2Flint-dead-code-3.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Fdead-code%2Flint-dead-code-3.stderr?ref=966589edfc24365d3bcd2e0fff658dcb849de369", "patch": "@@ -11,10 +11,10 @@ LL | #![deny(dead_code)]\n    |         ^^^^^^^^^\n \n error: associated function is never used: `foo`\n-  --> $DIR/lint-dead-code-3.rs:15:5\n+  --> $DIR/lint-dead-code-3.rs:15:8\n    |\n LL |     fn foo(&self) {\n-   |     ^^^^^^^^^^^^^\n+   |        ^^^\n \n error: function is never used: `bar`\n   --> $DIR/lint-dead-code-3.rs:20:4"}, {"sha": "0a543d5c6228d1e0eef70e2667374649ae009ee7", "filename": "src/test/ui/lint/dead-code/lint-dead-code-6.rs", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/966589edfc24365d3bcd2e0fff658dcb849de369/src%2Ftest%2Fui%2Flint%2Fdead-code%2Flint-dead-code-6.rs", "raw_url": "https://github.com/rust-lang/rust/raw/966589edfc24365d3bcd2e0fff658dcb849de369/src%2Ftest%2Fui%2Flint%2Fdead-code%2Flint-dead-code-6.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Fdead-code%2Flint-dead-code-6.rs?ref=966589edfc24365d3bcd2e0fff658dcb849de369", "patch": "@@ -0,0 +1,20 @@\n+#![deny(dead_code)]\n+\n+struct UnusedStruct; //~ ERROR struct is never constructed: `UnusedStruct`\n+impl UnusedStruct {\n+    fn unused_impl_fn_1() { //~ ERROR associated function is never used: `unused_impl_fn_1`\n+        println!(\"blah\");\n+    }\n+\n+    fn unused_impl_fn_2(var: i32) { //~ ERROR associated function is never used: `unused_impl_fn_2`\n+        println!(\"foo {}\", var);\n+    }\n+\n+    fn unused_impl_fn_3( //~ ERROR associated function is never used: `unused_impl_fn_3`\n+        var: i32,\n+    ) {\n+        println!(\"bar {}\", var);\n+    }\n+}\n+\n+fn main() {}"}, {"sha": "7dc60730d6aad04242b53272529eda215e4836f4", "filename": "src/test/ui/lint/dead-code/lint-dead-code-6.stderr", "status": "added", "additions": 32, "deletions": 0, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/966589edfc24365d3bcd2e0fff658dcb849de369/src%2Ftest%2Fui%2Flint%2Fdead-code%2Flint-dead-code-6.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/966589edfc24365d3bcd2e0fff658dcb849de369/src%2Ftest%2Fui%2Flint%2Fdead-code%2Flint-dead-code-6.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Fdead-code%2Flint-dead-code-6.stderr?ref=966589edfc24365d3bcd2e0fff658dcb849de369", "patch": "@@ -0,0 +1,32 @@\n+error: struct is never constructed: `UnusedStruct`\n+  --> $DIR/lint-dead-code-6.rs:3:8\n+   |\n+LL | struct UnusedStruct;\n+   |        ^^^^^^^^^^^^\n+   |\n+note: the lint level is defined here\n+  --> $DIR/lint-dead-code-6.rs:1:9\n+   |\n+LL | #![deny(dead_code)]\n+   |         ^^^^^^^^^\n+\n+error: associated function is never used: `unused_impl_fn_1`\n+  --> $DIR/lint-dead-code-6.rs:5:8\n+   |\n+LL |     fn unused_impl_fn_1() {\n+   |        ^^^^^^^^^^^^^^^^\n+\n+error: associated function is never used: `unused_impl_fn_2`\n+  --> $DIR/lint-dead-code-6.rs:9:8\n+   |\n+LL |     fn unused_impl_fn_2(var: i32) {\n+   |        ^^^^^^^^^^^^^^^^\n+\n+error: associated function is never used: `unused_impl_fn_3`\n+  --> $DIR/lint-dead-code-6.rs:13:8\n+   |\n+LL |     fn unused_impl_fn_3(\n+   |        ^^^^^^^^^^^^^^^^\n+\n+error: aborting due to 4 previous errors\n+"}]}