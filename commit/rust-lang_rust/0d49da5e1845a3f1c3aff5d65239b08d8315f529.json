{"sha": "0d49da5e1845a3f1c3aff5d65239b08d8315f529", "node_id": "C_kwDOAAsO6NoAKDBkNDlkYTVlMTg0NWEzZjFjM2FmZjVkNjUyMzliMDhkODMxNWY1Mjk", "commit": {"author": {"name": "Giacomo Stevanato", "email": "giaco.stevanato@gmail.com", "date": "2021-09-21T13:36:52Z"}, "committer": {"name": "Giacomo Stevanato", "email": "giaco.stevanato@gmail.com", "date": "2021-09-27T14:59:25Z"}, "message": "Move `GenericParams`'s handling of `impl Trait` into `GenericParams::generic_params_query`", "tree": {"sha": "41b8c21bc31c398b5dbe91758f1b9bb179cb1253", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/41b8c21bc31c398b5dbe91758f1b9bb179cb1253"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0d49da5e1845a3f1c3aff5d65239b08d8315f529", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0d49da5e1845a3f1c3aff5d65239b08d8315f529", "html_url": "https://github.com/rust-lang/rust/commit/0d49da5e1845a3f1c3aff5d65239b08d8315f529", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0d49da5e1845a3f1c3aff5d65239b08d8315f529/comments", "author": {"login": "SkiFire13", "id": 9020423, "node_id": "MDQ6VXNlcjkwMjA0MjM=", "avatar_url": "https://avatars.githubusercontent.com/u/9020423?v=4", "gravatar_id": "", "url": "https://api.github.com/users/SkiFire13", "html_url": "https://github.com/SkiFire13", "followers_url": "https://api.github.com/users/SkiFire13/followers", "following_url": "https://api.github.com/users/SkiFire13/following{/other_user}", "gists_url": "https://api.github.com/users/SkiFire13/gists{/gist_id}", "starred_url": "https://api.github.com/users/SkiFire13/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/SkiFire13/subscriptions", "organizations_url": "https://api.github.com/users/SkiFire13/orgs", "repos_url": "https://api.github.com/users/SkiFire13/repos", "events_url": "https://api.github.com/users/SkiFire13/events{/privacy}", "received_events_url": "https://api.github.com/users/SkiFire13/received_events", "type": "User", "site_admin": false}, "committer": {"login": "SkiFire13", "id": 9020423, "node_id": "MDQ6VXNlcjkwMjA0MjM=", "avatar_url": "https://avatars.githubusercontent.com/u/9020423?v=4", "gravatar_id": "", "url": "https://api.github.com/users/SkiFire13", "html_url": "https://github.com/SkiFire13", "followers_url": "https://api.github.com/users/SkiFire13/followers", "following_url": "https://api.github.com/users/SkiFire13/following{/other_user}", "gists_url": "https://api.github.com/users/SkiFire13/gists{/gist_id}", "starred_url": "https://api.github.com/users/SkiFire13/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/SkiFire13/subscriptions", "organizations_url": "https://api.github.com/users/SkiFire13/orgs", "repos_url": "https://api.github.com/users/SkiFire13/repos", "events_url": "https://api.github.com/users/SkiFire13/events{/privacy}", "received_events_url": "https://api.github.com/users/SkiFire13/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5347c3ab5989a968b8e942104bdb3b55fb7e7d6f", "url": "https://api.github.com/repos/rust-lang/rust/commits/5347c3ab5989a968b8e942104bdb3b55fb7e7d6f", "html_url": "https://github.com/rust-lang/rust/commit/5347c3ab5989a968b8e942104bdb3b55fb7e7d6f"}], "stats": {"total": 75, "additions": 50, "deletions": 25}, "files": [{"sha": "8c5313fa458c9c478b16150e9b60378b9b45a128", "filename": "crates/hir_def/src/generics.rs", "status": "modified", "additions": 41, "deletions": 9, "changes": 50, "blob_url": "https://github.com/rust-lang/rust/blob/0d49da5e1845a3f1c3aff5d65239b08d8315f529/crates%2Fhir_def%2Fsrc%2Fgenerics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0d49da5e1845a3f1c3aff5d65239b08d8315f529/crates%2Fhir_def%2Fsrc%2Fgenerics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fgenerics.rs?ref=0d49da5e1845a3f1c3aff5d65239b08d8315f529", "patch": "@@ -7,22 +7,24 @@ use base_db::FileId;\n use either::Either;\n use hir_expand::{\n     name::{AsName, Name},\n-    HirFileId, InFile,\n+    ExpandResult, HirFileId, InFile,\n };\n use la_arena::{Arena, ArenaMap};\n+use once_cell::unsync::Lazy;\n+use std::ops::DerefMut;\n use syntax::ast::{self, HasGenericParams, HasName, HasTypeBounds};\n \n use crate::{\n-    body::LowerCtx,\n+    body::{Expander, LowerCtx},\n     child_by_source::ChildBySource,\n     db::DefDatabase,\n     dyn_map::DynMap,\n     intern::Interned,\n     keys,\n     src::{HasChildSource, HasSource},\n     type_ref::{LifetimeRef, TypeBound, TypeRef},\n-    AdtId, ConstParamId, GenericDefId, LifetimeParamId, LocalConstParamId, LocalLifetimeParamId,\n-    LocalTypeParamId, Lookup, TypeParamId,\n+    AdtId, ConstParamId, GenericDefId, HasModule, LifetimeParamId, LocalConstParamId,\n+    LocalLifetimeParamId, LocalTypeParamId, Lookup, TypeParamId,\n };\n \n /// Data about a generic type parameter (to a function, struct, impl, ...).\n@@ -99,10 +101,23 @@ impl GenericParams {\n \n         match def {\n             GenericDefId::FunctionId(id) => {\n-                let id = id.lookup(db).id;\n-                let tree = id.item_tree(db);\n-                let item = &tree[id.value];\n-                item.generic_params.clone()\n+                let loc = id.lookup(db);\n+                let tree = loc.id.item_tree(db);\n+                let item = &tree[loc.id.value];\n+\n+                let mut generic_params = GenericParams::clone(&item.explicit_generic_params);\n+\n+                let module = loc.container.module(db);\n+                let func_data = db.function_data(id);\n+\n+                // Don't create an `Expander` nor call `loc.source(db)` if not needed since this\n+                // causes a reparse after the `ItemTree` has been created.\n+                let mut expander = Lazy::new(|| Expander::new(db, loc.source(db).file_id, module));\n+                for param in &func_data.params {\n+                    generic_params.fill_implicit_impl_trait_args(db, &mut expander, param);\n+                }\n+\n+                Interned::new(generic_params)\n             }\n             GenericDefId::AdtId(AdtId::StructId(id)) => {\n                 let id = id.lookup(db).id;\n@@ -259,7 +274,12 @@ impl GenericParams {\n         self.where_predicates.push(predicate);\n     }\n \n-    pub(crate) fn fill_implicit_impl_trait_args(&mut self, type_ref: &TypeRef) {\n+    pub(crate) fn fill_implicit_impl_trait_args(\n+        &mut self,\n+        db: &dyn DefDatabase,\n+        expander: &mut impl DerefMut<Target = Expander>,\n+        type_ref: &TypeRef,\n+    ) {\n         type_ref.walk(&mut |type_ref| {\n             if let TypeRef::ImplTrait(bounds) = type_ref {\n                 let param = TypeParamData {\n@@ -275,6 +295,18 @@ impl GenericParams {\n                     });\n                 }\n             }\n+            if let TypeRef::Macro(mc) = type_ref {\n+                let macro_call = mc.to_node(db.upcast());\n+                match expander.enter_expand::<ast::Type>(db, macro_call) {\n+                    Ok(ExpandResult { value: Some((mark, expanded)), .. }) => {\n+                        let ctx = LowerCtx::new(db, mc.file_id);\n+                        let type_ref = TypeRef::from_ast(&ctx, expanded);\n+                        self.fill_implicit_impl_trait_args(db, expander, &type_ref);\n+                        expander.exit(db, mark);\n+                    }\n+                    _ => {}\n+                }\n+            }\n         });\n     }\n "}, {"sha": "3900e7e97cc8d45cfd864b859ebd5f76f700239d", "filename": "crates/hir_def/src/item_tree.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0d49da5e1845a3f1c3aff5d65239b08d8315f529/crates%2Fhir_def%2Fsrc%2Fitem_tree.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0d49da5e1845a3f1c3aff5d65239b08d8315f529/crates%2Fhir_def%2Fsrc%2Fitem_tree.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fitem_tree.rs?ref=0d49da5e1845a3f1c3aff5d65239b08d8315f529", "patch": "@@ -605,7 +605,7 @@ pub struct ExternBlock {\n pub struct Function {\n     pub name: Name,\n     pub visibility: RawVisibilityId,\n-    pub generic_params: Interned<GenericParams>,\n+    pub explicit_generic_params: Interned<GenericParams>,\n     pub abi: Option<Interned<str>>,\n     pub params: IdRange<Param>,\n     pub ret_type: Interned<TypeRef>,"}, {"sha": "9c278f5ac6b9203e4761bdf9fe263a036c639380", "filename": "crates/hir_def/src/item_tree/lower.rs", "status": "modified", "additions": 5, "deletions": 12, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/0d49da5e1845a3f1c3aff5d65239b08d8315f529/crates%2Fhir_def%2Fsrc%2Fitem_tree%2Flower.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0d49da5e1845a3f1c3aff5d65239b08d8315f529/crates%2Fhir_def%2Fsrc%2Fitem_tree%2Flower.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fitem_tree%2Flower.rs?ref=0d49da5e1845a3f1c3aff5d65239b08d8315f529", "patch": "@@ -401,15 +401,16 @@ impl<'a> Ctx<'a> {\n         let mut res = Function {\n             name,\n             visibility,\n-            generic_params: Interned::new(GenericParams::default()),\n+            explicit_generic_params: Interned::new(GenericParams::default()),\n             abi,\n             params,\n             ret_type: Interned::new(ret_type),\n             async_ret_type: async_ret_type.map(Interned::new),\n             ast_id,\n             flags,\n         };\n-        res.generic_params = self.lower_generic_params(GenericsOwner::Function(&res), func);\n+        res.explicit_generic_params =\n+            self.lower_generic_params(GenericsOwner::Function(&res), func);\n \n         Some(id(self.data().functions.alloc(res)))\n     }\n@@ -664,16 +665,8 @@ impl<'a> Ctx<'a> {\n     ) -> Interned<GenericParams> {\n         let mut generics = GenericParams::default();\n         match owner {\n-            GenericsOwner::Function(func) => {\n-                generics.fill(&self.body_ctx, node);\n-                // lower `impl Trait` in arguments\n-                for id in func.params.clone() {\n-                    if let Param::Normal(ty) = &self.data().params[id] {\n-                        generics.fill_implicit_impl_trait_args(ty);\n-                    }\n-                }\n-            }\n-            GenericsOwner::Struct\n+            GenericsOwner::Function(_)\n+            | GenericsOwner::Struct\n             | GenericsOwner::Enum\n             | GenericsOwner::Union\n             | GenericsOwner::TypeAlias => {"}, {"sha": "49dc1eef18b6ced74d990f6aa2aa71dd9e3ac096", "filename": "crates/hir_def/src/item_tree/pretty.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/0d49da5e1845a3f1c3aff5d65239b08d8315f529/crates%2Fhir_def%2Fsrc%2Fitem_tree%2Fpretty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0d49da5e1845a3f1c3aff5d65239b08d8315f529/crates%2Fhir_def%2Fsrc%2Fitem_tree%2Fpretty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fitem_tree%2Fpretty.rs?ref=0d49da5e1845a3f1c3aff5d65239b08d8315f529", "patch": "@@ -234,7 +234,7 @@ impl<'a> Printer<'a> {\n                 let Function {\n                     name,\n                     visibility,\n-                    generic_params,\n+                    explicit_generic_params,\n                     abi,\n                     params,\n                     ret_type,\n@@ -250,7 +250,7 @@ impl<'a> Printer<'a> {\n                     w!(self, \"extern \\\"{}\\\" \", abi);\n                 }\n                 w!(self, \"fn {}\", name);\n-                self.print_generic_params(generic_params);\n+                self.print_generic_params(explicit_generic_params);\n                 w!(self, \"(\");\n                 if !params.is_empty() {\n                     self.indented(|this| {\n@@ -271,7 +271,7 @@ impl<'a> Printer<'a> {\n                 }\n                 w!(self, \") -> \");\n                 self.print_type_ref(ret_type);\n-                self.print_where_clause(generic_params);\n+                self.print_where_clause(explicit_generic_params);\n                 wln!(self, \";\");\n             }\n             ModItem::Struct(it) => {"}]}