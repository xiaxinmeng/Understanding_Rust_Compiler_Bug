{"sha": "124f19485dcfdcbc081f667036e82d0daf98927e", "node_id": "C_kwDOAAsO6NoAKDEyNGYxOTQ4NWRjZmRjYmMwODFmNjY3MDM2ZTgyZDBkYWY5ODkyN2U", "commit": {"author": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2022-12-15T02:51:55Z"}, "committer": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2022-12-15T02:51:55Z"}, "message": "Tweak output for bare `dyn Trait` in arguments\n\nFix #35825.", "tree": {"sha": "88cfc4f79de9a0191e98c283dd52418710123735", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/88cfc4f79de9a0191e98c283dd52418710123735"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/124f19485dcfdcbc081f667036e82d0daf98927e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/124f19485dcfdcbc081f667036e82d0daf98927e", "html_url": "https://github.com/rust-lang/rust/commit/124f19485dcfdcbc081f667036e82d0daf98927e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/124f19485dcfdcbc081f667036e82d0daf98927e/comments", "author": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "committer": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ba64ba8b0dfd57f7d6d7399d0df7ded37d2af18d", "url": "https://api.github.com/repos/rust-lang/rust/commits/ba64ba8b0dfd57f7d6d7399d0df7ded37d2af18d", "html_url": "https://github.com/rust-lang/rust/commit/ba64ba8b0dfd57f7d6d7399d0df7ded37d2af18d"}], "stats": {"total": 108, "additions": 85, "deletions": 23}, "files": [{"sha": "97f07c3cc820b277aea9f87afde3def9bda1b8cb", "filename": "compiler/rustc_trait_selection/src/traits/error_reporting/suggestions.rs", "status": "modified", "additions": 20, "deletions": 8, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/124f19485dcfdcbc081f667036e82d0daf98927e/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/124f19485dcfdcbc081f667036e82d0daf98927e/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs?ref=124f19485dcfdcbc081f667036e82d0daf98927e", "patch": "@@ -1618,7 +1618,7 @@ impl<'tcx> TypeErrCtxtExt<'tcx> for TypeErrCtxt<'_, 'tcx> {\n         let trait_obj = if has_dyn { &snippet[4..] } else { &snippet };\n         if only_never_return {\n             // No return paths, probably using `panic!()` or similar.\n-            // Suggest `-> T`, `-> impl Trait`, and if `Trait` is object safe, `-> Box<dyn Trait>`.\n+            // Suggest `-> impl Trait`, and if `Trait` is object safe, `-> Box<dyn Trait>`.\n             suggest_trait_object_return_type_alternatives(\n                 err,\n                 ret_ty.span,\n@@ -2540,6 +2540,25 @@ impl<'tcx> TypeErrCtxtExt<'tcx> for TypeErrCtxt<'_, 'tcx> {\n             }\n             ObligationCauseCode::SizedArgumentType(sp) => {\n                 if let Some(span) = sp {\n+                    if let ty::PredicateKind::Clause(clause) = predicate.kind().skip_binder()\n+                        && let ty::Clause::Trait(trait_pred) = clause\n+                        && let ty::Dynamic(..) = trait_pred.self_ty().kind()\n+                    {\n+                        let span = if let Ok(snippet) = self.tcx.sess.source_map().span_to_snippet(span)\n+                            && snippet.starts_with(\"dyn \")\n+                        {\n+                            let pos = snippet.len() - snippet[3..].trim_start().len();\n+                            span.with_hi(span.lo() + BytePos(pos as u32))\n+                        } else {\n+                            span.shrink_to_lo()\n+                        };\n+                        err.span_suggestion_verbose(\n+                            span,\n+                            \"you can use `impl Trait` as the argument type\",\n+                            \"impl \".to_string(),\n+                            Applicability::MaybeIncorrect,\n+                        );\n+                    }\n                     err.span_suggestion_verbose(\n                         span.shrink_to_lo(),\n                         \"function arguments must have a statically known size, borrowed types \\\n@@ -3580,13 +3599,6 @@ fn suggest_trait_object_return_type_alternatives(\n     trait_obj: &str,\n     is_object_safe: bool,\n ) {\n-    err.span_suggestion(\n-        ret_ty,\n-        \"use some type `T` that is `T: Sized` as the return type if all return paths have the \\\n-            same type\",\n-        \"T\",\n-        Applicability::MaybeIncorrect,\n-    );\n     err.span_suggestion(\n         ret_ty,\n         &format!("}, {"sha": "c04e57843d4b21f4d16e5205630273d4f199cc37", "filename": "src/test/ui/feature-gates/feature-gate-unsized_fn_params.rs", "status": "modified", "additions": 9, "deletions": 5, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/124f19485dcfdcbc081f667036e82d0daf98927e/src%2Ftest%2Fui%2Ffeature-gates%2Ffeature-gate-unsized_fn_params.rs", "raw_url": "https://github.com/rust-lang/rust/raw/124f19485dcfdcbc081f667036e82d0daf98927e/src%2Ftest%2Fui%2Ffeature-gates%2Ffeature-gate-unsized_fn_params.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffeature-gates%2Ffeature-gate-unsized_fn_params.rs?ref=124f19485dcfdcbc081f667036e82d0daf98927e", "patch": "@@ -1,5 +1,5 @@\n+#![allow(unused, bare_trait_objects)]\n #[repr(align(256))]\n-#[allow(dead_code)]\n struct A {\n     v: u8,\n }\n@@ -14,13 +14,17 @@ impl Foo for A {\n     }\n }\n \n-fn foo(x: dyn Foo) {\n-    //~^ ERROR [E0277]\n+fn foo(x: dyn Foo) { //~ ERROR [E0277]\n     x.foo()\n }\n \n+fn bar(x: Foo) { //~ ERROR [E0277]\n+    x.foo()\n+}\n+\n+fn qux(_: [()]) {} //~ ERROR [E0277]\n+\n fn main() {\n     let x: Box<dyn Foo> = Box::new(A { v: 22 });\n-    foo(*x);\n-    //~^ ERROR [E0277]\n+    foo(*x); //~ ERROR [E0277]\n }"}, {"sha": "92c71392672e197537c6a72525b9059a31c19852", "filename": "src/test/ui/feature-gates/feature-gate-unsized_fn_params.stderr", "status": "modified", "additions": 36, "deletions": 2, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/124f19485dcfdcbc081f667036e82d0daf98927e/src%2Ftest%2Fui%2Ffeature-gates%2Ffeature-gate-unsized_fn_params.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/124f19485dcfdcbc081f667036e82d0daf98927e/src%2Ftest%2Fui%2Ffeature-gates%2Ffeature-gate-unsized_fn_params.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffeature-gates%2Ffeature-gate-unsized_fn_params.stderr?ref=124f19485dcfdcbc081f667036e82d0daf98927e", "patch": "@@ -6,13 +6,47 @@ LL | fn foo(x: dyn Foo) {\n    |\n    = help: the trait `Sized` is not implemented for `(dyn Foo + 'static)`\n    = help: unsized fn params are gated as an unstable feature\n+help: you can use `impl Trait` as the argument type\n+   |\n+LL | fn foo(x: impl Foo) {\n+   |           ~~~~\n help: function arguments must have a statically known size, borrowed types always have a known size\n    |\n LL | fn foo(x: &dyn Foo) {\n    |           +\n \n error[E0277]: the size for values of type `(dyn Foo + 'static)` cannot be known at compilation time\n-  --> $DIR/feature-gate-unsized_fn_params.rs:24:9\n+  --> $DIR/feature-gate-unsized_fn_params.rs:21:8\n+   |\n+LL | fn bar(x: Foo) {\n+   |        ^ doesn't have a size known at compile-time\n+   |\n+   = help: the trait `Sized` is not implemented for `(dyn Foo + 'static)`\n+   = help: unsized fn params are gated as an unstable feature\n+help: you can use `impl Trait` as the argument type\n+   |\n+LL | fn bar(x: impl Foo) {\n+   |           ++++\n+help: function arguments must have a statically known size, borrowed types always have a known size\n+   |\n+LL | fn bar(x: &Foo) {\n+   |           +\n+\n+error[E0277]: the size for values of type `[()]` cannot be known at compilation time\n+  --> $DIR/feature-gate-unsized_fn_params.rs:25:8\n+   |\n+LL | fn qux(_: [()]) {}\n+   |        ^ doesn't have a size known at compile-time\n+   |\n+   = help: the trait `Sized` is not implemented for `[()]`\n+   = help: unsized fn params are gated as an unstable feature\n+help: function arguments must have a statically known size, borrowed types always have a known size\n+   |\n+LL | fn qux(_: &[()]) {}\n+   |           +\n+\n+error[E0277]: the size for values of type `(dyn Foo + 'static)` cannot be known at compilation time\n+  --> $DIR/feature-gate-unsized_fn_params.rs:29:9\n    |\n LL |     foo(*x);\n    |         ^^ doesn't have a size known at compile-time\n@@ -21,6 +55,6 @@ LL |     foo(*x);\n    = note: all function arguments must have a statically known size\n    = help: unsized fn params are gated as an unstable feature\n \n-error: aborting due to 2 previous errors\n+error: aborting due to 4 previous errors\n \n For more information about this error, try `rustc --explain E0277`."}, {"sha": "9aeeb88cf04f2befd08f101afdb57860769e220d", "filename": "src/test/ui/feature-gates/feature-gate-unsized_locals.stderr", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/124f19485dcfdcbc081f667036e82d0daf98927e/src%2Ftest%2Fui%2Ffeature-gates%2Ffeature-gate-unsized_locals.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/124f19485dcfdcbc081f667036e82d0daf98927e/src%2Ftest%2Fui%2Ffeature-gates%2Ffeature-gate-unsized_locals.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffeature-gates%2Ffeature-gate-unsized_locals.stderr?ref=124f19485dcfdcbc081f667036e82d0daf98927e", "patch": "@@ -6,6 +6,10 @@ LL | fn f(f: dyn FnOnce()) {}\n    |\n    = help: the trait `Sized` is not implemented for `(dyn FnOnce() + 'static)`\n    = help: unsized fn params are gated as an unstable feature\n+help: you can use `impl Trait` as the argument type\n+   |\n+LL | fn f(f: impl FnOnce()) {}\n+   |         ~~~~\n help: function arguments must have a statically known size, borrowed types always have a known size\n    |\n LL | fn f(f: &dyn FnOnce()) {}"}, {"sha": "7f73d5e12d1962a9288eb62d472d632b983b1ae4", "filename": "src/test/ui/impl-trait/dyn-trait-return-should-be-impl-trait.stderr", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/124f19485dcfdcbc081f667036e82d0daf98927e/src%2Ftest%2Fui%2Fimpl-trait%2Fdyn-trait-return-should-be-impl-trait.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/124f19485dcfdcbc081f667036e82d0daf98927e/src%2Ftest%2Fui%2Fimpl-trait%2Fdyn-trait-return-should-be-impl-trait.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fimpl-trait%2Fdyn-trait-return-should-be-impl-trait.stderr?ref=124f19485dcfdcbc081f667036e82d0daf98927e", "patch": "@@ -70,10 +70,6 @@ error[E0746]: return type cannot have an unboxed trait object\n LL | fn bak() -> dyn Trait { unimplemented!() }\n    |             ^^^^^^^^^ doesn't have a size known at compile-time\n    |\n-help: use some type `T` that is `T: Sized` as the return type if all return paths have the same type\n-   |\n-LL | fn bak() -> T { unimplemented!() }\n-   |             ~\n help: use `impl Trait` as the return type if all return paths have the same type but you want to expose only the trait in the signature\n    |\n LL | fn bak() -> impl Trait { unimplemented!() }"}, {"sha": "1669b550a9bafe26442e406d91bb02a980d135e7", "filename": "src/test/ui/issues/issue-18107.stderr", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/124f19485dcfdcbc081f667036e82d0daf98927e/src%2Ftest%2Fui%2Fissues%2Fissue-18107.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/124f19485dcfdcbc081f667036e82d0daf98927e/src%2Ftest%2Fui%2Fissues%2Fissue-18107.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-18107.stderr?ref=124f19485dcfdcbc081f667036e82d0daf98927e", "patch": "@@ -4,10 +4,6 @@ error[E0746]: return type cannot have an unboxed trait object\n LL |     dyn AbstractRenderer\n    |     ^^^^^^^^^^^^^^^^^^^^ doesn't have a size known at compile-time\n    |\n-help: use some type `T` that is `T: Sized` as the return type if all return paths have the same type\n-   |\n-LL |     T\n-   |\n help: use `impl AbstractRenderer` as the return type if all return paths have the same type but you want to expose only the trait in the signature\n    |\n LL |     impl AbstractRenderer"}, {"sha": "3ca6a2957e14b91768b6c421dc222634f5886677", "filename": "src/test/ui/issues/issue-42312.stderr", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/124f19485dcfdcbc081f667036e82d0daf98927e/src%2Ftest%2Fui%2Fissues%2Fissue-42312.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/124f19485dcfdcbc081f667036e82d0daf98927e/src%2Ftest%2Fui%2Fissues%2Fissue-42312.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-42312.stderr?ref=124f19485dcfdcbc081f667036e82d0daf98927e", "patch": "@@ -23,6 +23,10 @@ LL | pub fn f(_: dyn ToString) {}\n    |\n    = help: the trait `Sized` is not implemented for `(dyn ToString + 'static)`\n    = help: unsized fn params are gated as an unstable feature\n+help: you can use `impl Trait` as the argument type\n+   |\n+LL | pub fn f(_: impl ToString) {}\n+   |             ~~~~\n help: function arguments must have a statically known size, borrowed types always have a known size\n    |\n LL | pub fn f(_: &dyn ToString) {}"}, {"sha": "ffff403e0d4656508d4dbdbf3c4e7b32f6bb749f", "filename": "src/test/ui/issues/issue-5883.stderr", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/124f19485dcfdcbc081f667036e82d0daf98927e/src%2Ftest%2Fui%2Fissues%2Fissue-5883.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/124f19485dcfdcbc081f667036e82d0daf98927e/src%2Ftest%2Fui%2Fissues%2Fissue-5883.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-5883.stderr?ref=124f19485dcfdcbc081f667036e82d0daf98927e", "patch": "@@ -6,6 +6,10 @@ LL |     r: dyn A + 'static\n    |\n    = help: the trait `Sized` is not implemented for `(dyn A + 'static)`\n    = help: unsized fn params are gated as an unstable feature\n+help: you can use `impl Trait` as the argument type\n+   |\n+LL |     r: impl A + 'static\n+   |        ~~~~\n help: function arguments must have a statically known size, borrowed types always have a known size\n    |\n LL |     r: &dyn A + 'static"}, {"sha": "558e6b7b118d8221125e8cdd953d2ac1b9834bdd", "filename": "src/test/ui/resolve/issue-5035-2.stderr", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/124f19485dcfdcbc081f667036e82d0daf98927e/src%2Ftest%2Fui%2Fresolve%2Fissue-5035-2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/124f19485dcfdcbc081f667036e82d0daf98927e/src%2Ftest%2Fui%2Fresolve%2Fissue-5035-2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fresolve%2Fissue-5035-2.stderr?ref=124f19485dcfdcbc081f667036e82d0daf98927e", "patch": "@@ -6,6 +6,10 @@ LL | fn foo(_x: K) {}\n    |\n    = help: the trait `Sized` is not implemented for `(dyn I + 'static)`\n    = help: unsized fn params are gated as an unstable feature\n+help: you can use `impl Trait` as the argument type\n+   |\n+LL | fn foo(_x: impl K) {}\n+   |            ++++\n help: function arguments must have a statically known size, borrowed types always have a known size\n    |\n LL | fn foo(_x: &K) {}"}, {"sha": "36b08a7d3093141c3ee61e6ff410794cc2092341", "filename": "src/test/ui/traits/bound/not-on-bare-trait.stderr", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/124f19485dcfdcbc081f667036e82d0daf98927e/src%2Ftest%2Fui%2Ftraits%2Fbound%2Fnot-on-bare-trait.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/124f19485dcfdcbc081f667036e82d0daf98927e/src%2Ftest%2Fui%2Ftraits%2Fbound%2Fnot-on-bare-trait.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftraits%2Fbound%2Fnot-on-bare-trait.stderr?ref=124f19485dcfdcbc081f667036e82d0daf98927e", "patch": "@@ -20,6 +20,10 @@ LL | fn foo(_x: Foo + Send) {\n    |\n    = help: the trait `Sized` is not implemented for `(dyn Foo + Send + 'static)`\n    = help: unsized fn params are gated as an unstable feature\n+help: you can use `impl Trait` as the argument type\n+   |\n+LL | fn foo(_x: impl Foo + Send) {\n+   |            ++++\n help: function arguments must have a statically known size, borrowed types always have a known size\n    |\n LL | fn foo(_x: &Foo + Send) {"}]}