{"sha": "80829ceaa7e89f42f8f2b45d79f29e137e2bac0f", "node_id": "C_kwDOAAsO6NoAKDgwODI5Y2VhYTdlODlmNDJmOGYyYjQ1ZDc5ZjI5ZTEzN2UyYmFjMGY", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2023-06-08T08:15:12Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-06-08T08:15:12Z"}, "message": "Rollup merge of #112392 - jieyouxu:issue-112385, r=compiler-errors\n\nFix ICE for while loop with assignment condition with LHS place expr\n\nFixes #112385.", "tree": {"sha": "164f3842ac931fd79b00dca684575ceb063d641d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/164f3842ac931fd79b00dca684575ceb063d641d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/80829ceaa7e89f42f8f2b45d79f29e137e2bac0f", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkgY4QCRBK7hj4Ov3rIwAAt44IAC7diDU3sF+7wLUuiJ0dJprW\nvNzD3wbpwHrjWfO8FnA61i/h2SwZ/CS0z3LecV/aDcWS8L68hxxGd76cOwwwfT/0\nXRX7fMW/Wcj3avmTL8IrKB5v6nT3gfNJdWuL546Efw4MeKFTwwmwd8+bAfJ6ViHb\n+ZuU8TfBQNB2yk7Qq8Mkq5rHchLm0R+7xUarYrtxbHgbygRIcu/JdVXpWV1ds+X2\nVVaf/boZdwyl18BamGvEhMSs9FPS/UJB7FU0ivmyjN7RCkQxQrkeET6khVKVR1dE\nXHCXzH1eIUl80IVRs5Fv9ZtpXyql9q+0OQuMOV7WX2GbUMJ7IFbK2mwWF4FMumE=\n=cphd\n-----END PGP SIGNATURE-----\n", "payload": "tree 164f3842ac931fd79b00dca684575ceb063d641d\nparent 5b7eba6a29e3def0437317369c67f3b266032db7\nparent adbfd0da6860a29d6c7a2adb315e79c91202f7ef\nauthor Guillaume Gomez <guillaume1.gomez@gmail.com> 1686212112 +0200\ncommitter GitHub <noreply@github.com> 1686212112 +0200\n\nRollup merge of #112392 - jieyouxu:issue-112385, r=compiler-errors\n\nFix ICE for while loop with assignment condition with LHS place expr\n\nFixes #112385.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/80829ceaa7e89f42f8f2b45d79f29e137e2bac0f", "html_url": "https://github.com/rust-lang/rust/commit/80829ceaa7e89f42f8f2b45d79f29e137e2bac0f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/80829ceaa7e89f42f8f2b45d79f29e137e2bac0f/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5b7eba6a29e3def0437317369c67f3b266032db7", "url": "https://api.github.com/repos/rust-lang/rust/commits/5b7eba6a29e3def0437317369c67f3b266032db7", "html_url": "https://github.com/rust-lang/rust/commit/5b7eba6a29e3def0437317369c67f3b266032db7"}, {"sha": "adbfd0da6860a29d6c7a2adb315e79c91202f7ef", "url": "https://api.github.com/repos/rust-lang/rust/commits/adbfd0da6860a29d6c7a2adb315e79c91202f7ef", "html_url": "https://github.com/rust-lang/rust/commit/adbfd0da6860a29d6c7a2adb315e79c91202f7ef"}], "stats": {"total": 51, "additions": 47, "deletions": 4}, "files": [{"sha": "30a543aab508fbd1d51a1999e936508c05855a5c", "filename": "compiler/rustc_hir_typeck/src/fn_ctxt/checks.rs", "status": "modified", "additions": 11, "deletions": 2, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/80829ceaa7e89f42f8f2b45d79f29e137e2bac0f/compiler%2Frustc_hir_typeck%2Fsrc%2Ffn_ctxt%2Fchecks.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80829ceaa7e89f42f8f2b45d79f29e137e2bac0f/compiler%2Frustc_hir_typeck%2Fsrc%2Ffn_ctxt%2Fchecks.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_typeck%2Fsrc%2Ffn_ctxt%2Fchecks.rs?ref=80829ceaa7e89f42f8f2b45d79f29e137e2bac0f", "patch": "@@ -1640,7 +1640,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                                                 hir::Stmt {\n                                                     kind:\n                                                         hir::StmtKind::Expr(hir::Expr {\n-                                                            kind: hir::ExprKind::Assign(..),\n+                                                            kind: hir::ExprKind::Assign(lhs, ..),\n                                                             ..\n                                                         }),\n                                                     ..\n@@ -1650,7 +1650,16 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                                     } = blk\n                                     {\n                                         self.comes_from_while_condition(blk.hir_id, |_| {\n-                                            err.downgrade_to_delayed_bug();\n+                                            // We cannot suppress the error if the LHS of assignment\n+                                            // is a syntactic place expression because E0070 would\n+                                            // not be emitted by `check_lhs_assignable`.\n+                                            let res = self.typeck_results.borrow().expr_ty_opt(lhs);\n+\n+                                            if !lhs.is_syntactic_place_expr()\n+                                                || res.references_error()\n+                                            {\n+                                                err.downgrade_to_delayed_bug();\n+                                            }\n                                         })\n                                     }\n                                 }"}, {"sha": "21b254054bbc043609ec58fa09bede1cd54cf979", "filename": "tests/ui/suggestions/while-let-typo.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/80829ceaa7e89f42f8f2b45d79f29e137e2bac0f/tests%2Fui%2Fsuggestions%2Fwhile-let-typo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80829ceaa7e89f42f8f2b45d79f29e137e2bac0f/tests%2Fui%2Fsuggestions%2Fwhile-let-typo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fsuggestions%2Fwhile-let-typo.rs?ref=80829ceaa7e89f42f8f2b45d79f29e137e2bac0f", "patch": "@@ -2,7 +2,7 @@ fn main() {\n     let foo = Some(0);\n     let bar = None;\n     while Some(x) = foo {} //~ ERROR cannot find value `x` in this scope\n-    while Some(foo) = bar {}\n+    while Some(foo) = bar {} //~ ERROR mismatched types\n     while 3 = foo {} //~ ERROR mismatched types\n     while Some(3) = foo {} //~ ERROR invalid left-hand side of assignment\n     while x = 5 {} //~ ERROR cannot find value `x` in this scope"}, {"sha": "69a7e5761d42111837735519a5b81e892499570d", "filename": "tests/ui/suggestions/while-let-typo.stderr", "status": "modified", "additions": 12, "deletions": 1, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/80829ceaa7e89f42f8f2b45d79f29e137e2bac0f/tests%2Fui%2Fsuggestions%2Fwhile-let-typo.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/80829ceaa7e89f42f8f2b45d79f29e137e2bac0f/tests%2Fui%2Fsuggestions%2Fwhile-let-typo.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fsuggestions%2Fwhile-let-typo.stderr?ref=80829ceaa7e89f42f8f2b45d79f29e137e2bac0f", "patch": "@@ -20,6 +20,17 @@ help: you might have meant to use pattern matching\n LL |     while let x = 5 {}\n    |           +++\n \n+error[E0308]: mismatched types\n+  --> $DIR/while-let-typo.rs:5:11\n+   |\n+LL |     while Some(foo) = bar {}\n+   |           ^^^^^^^^^^^^^^^ expected `bool`, found `()`\n+   |\n+help: consider adding `let`\n+   |\n+LL |     while let Some(foo) = bar {}\n+   |           +++\n+\n error[E0308]: mismatched types\n   --> $DIR/while-let-typo.rs:6:11\n    |\n@@ -39,7 +50,7 @@ help: you might have meant to use pattern destructuring\n LL |     while let Some(3) = foo {}\n    |           +++\n \n-error: aborting due to 4 previous errors\n+error: aborting due to 5 previous errors\n \n Some errors have detailed explanations: E0070, E0308, E0425.\n For more information about an error, try `rustc --explain E0070`."}, {"sha": "3cb011dc06fcd1574a2d32b955e83d81e3b74955", "filename": "tests/ui/typeck/issue-112385-while-assign-lhs-place-expr-ice.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/80829ceaa7e89f42f8f2b45d79f29e137e2bac0f/tests%2Fui%2Ftypeck%2Fissue-112385-while-assign-lhs-place-expr-ice.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80829ceaa7e89f42f8f2b45d79f29e137e2bac0f/tests%2Fui%2Ftypeck%2Fissue-112385-while-assign-lhs-place-expr-ice.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ftypeck%2Fissue-112385-while-assign-lhs-place-expr-ice.rs?ref=80829ceaa7e89f42f8f2b45d79f29e137e2bac0f", "patch": "@@ -0,0 +1,9 @@\n+// Previously, the while loop with an assignment statement (mistakenly) as the condition\n+// which has a place expr as the LHS would trigger an ICE in typeck.\n+// Reduced from https://github.com/rust-lang/rust/issues/112385.\n+\n+fn main() {\n+    let foo = Some(());\n+    while Some(foo) = None {}\n+    //~^ ERROR mismatched types\n+}"}, {"sha": "cf2648d084079c627c4dc9568aeaaedf7688dca4", "filename": "tests/ui/typeck/issue-112385-while-assign-lhs-place-expr-ice.stderr", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/80829ceaa7e89f42f8f2b45d79f29e137e2bac0f/tests%2Fui%2Ftypeck%2Fissue-112385-while-assign-lhs-place-expr-ice.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/80829ceaa7e89f42f8f2b45d79f29e137e2bac0f/tests%2Fui%2Ftypeck%2Fissue-112385-while-assign-lhs-place-expr-ice.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ftypeck%2Fissue-112385-while-assign-lhs-place-expr-ice.stderr?ref=80829ceaa7e89f42f8f2b45d79f29e137e2bac0f", "patch": "@@ -0,0 +1,14 @@\n+error[E0308]: mismatched types\n+  --> $DIR/issue-112385-while-assign-lhs-place-expr-ice.rs:7:11\n+   |\n+LL |     while Some(foo) = None {}\n+   |           ^^^^^^^^^^^^^^^^ expected `bool`, found `()`\n+   |\n+help: consider adding `let`\n+   |\n+LL |     while let Some(foo) = None {}\n+   |           +++\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0308`."}]}