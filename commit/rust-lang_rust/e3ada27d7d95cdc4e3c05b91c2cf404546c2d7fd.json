{"sha": "e3ada27d7d95cdc4e3c05b91c2cf404546c2d7fd", "node_id": "C_kwDOAAsO6NoAKGUzYWRhMjdkN2Q5NWNkYzRlM2MwNWI5MWMyY2Y0MDQ1NDZjMmQ3ZmQ", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2022-05-05T01:20:37Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-05-05T01:20:37Z"}, "message": "Rollup merge of #96677 - jyn514:label-break-value-tests, r=petrochenkov\n\nAdd more tests for label-break-value\n\nHelps with https://github.com/rust-lang/rust/issues/48594. The tests are adapted from https://github.com/rust-lang/rust/issues/48594#issuecomment-421625182.", "tree": {"sha": "41e945cc06cfdf870b2735623bb4abfbcbc55093", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/41e945cc06cfdf870b2735623bb4abfbcbc55093"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e3ada27d7d95cdc4e3c05b91c2cf404546c2d7fd", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJicyZlCRBK7hj4Ov3rIwAAmDIIACfESf9C9uKyfI+UmUhRzDN+\n3Kek0sjTsb9kQ3S14ibrKc8lafMb00rMoSS4Vqb77HKpQ468jx1qKbq/V97d/swM\n35i1xYFm+PoICVEKAXsg/Ufhrpxy2xIIW4zM7b62Rp34110pVRlNZ/2jP+u/EWzl\nGunf1F+gKGO5CpKkoivctRfKkjfi9nfkAEEEk3MbZ11StJMUJ5YJ3iJ7fh4AdEen\nhL1wnKqDg3VtVn23M6XiuPx7bYVri/OO1T4sIQyFpeJY515evumjLTDa8kfgmnwZ\nSl4/ZqEKz5D0Pwfy+SP7DA+axZvraLBOZHfpOSgFuOASRCVHg++0oyQsUAyOuDA=\n=+pmN\n-----END PGP SIGNATURE-----\n", "payload": "tree 41e945cc06cfdf870b2735623bb4abfbcbc55093\nparent 31703217064ab550f9272d4d6de7e9e9320ced72\nparent cd63b22e80e61fc4deb3da85a733d6c9266783e1\nauthor Yuki Okushi <jtitor@2k36.org> 1651713637 +0900\ncommitter GitHub <noreply@github.com> 1651713637 +0900\n\nRollup merge of #96677 - jyn514:label-break-value-tests, r=petrochenkov\n\nAdd more tests for label-break-value\n\nHelps with https://github.com/rust-lang/rust/issues/48594. The tests are adapted from https://github.com/rust-lang/rust/issues/48594#issuecomment-421625182.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e3ada27d7d95cdc4e3c05b91c2cf404546c2d7fd", "html_url": "https://github.com/rust-lang/rust/commit/e3ada27d7d95cdc4e3c05b91c2cf404546c2d7fd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e3ada27d7d95cdc4e3c05b91c2cf404546c2d7fd/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "31703217064ab550f9272d4d6de7e9e9320ced72", "url": "https://api.github.com/repos/rust-lang/rust/commits/31703217064ab550f9272d4d6de7e9e9320ced72", "html_url": "https://github.com/rust-lang/rust/commit/31703217064ab550f9272d4d6de7e9e9320ced72"}, {"sha": "cd63b22e80e61fc4deb3da85a733d6c9266783e1", "url": "https://api.github.com/repos/rust-lang/rust/commits/cd63b22e80e61fc4deb3da85a733d6c9266783e1", "html_url": "https://github.com/rust-lang/rust/commit/cd63b22e80e61fc4deb3da85a733d6c9266783e1"}], "stats": {"total": 209, "additions": 208, "deletions": 1}, "files": [{"sha": "5776c0b1e0c77c7403f1c5ca8c2c02774a679e64", "filename": "src/test/ui/for-loop-while/label_break_value.rs", "status": "modified", "additions": 52, "deletions": 1, "changes": 53, "blob_url": "https://github.com/rust-lang/rust/blob/e3ada27d7d95cdc4e3c05b91c2cf404546c2d7fd/src%2Ftest%2Fui%2Ffor-loop-while%2Flabel_break_value.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e3ada27d7d95cdc4e3c05b91c2cf404546c2d7fd/src%2Ftest%2Fui%2Ffor-loop-while%2Flabel_break_value.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffor-loop-while%2Flabel_break_value.rs?ref=e3ada27d7d95cdc4e3c05b91c2cf404546c2d7fd", "patch": "@@ -95,6 +95,50 @@ fn label_break_mixed(v: u32) -> u32 {\n     r\n }\n \n+fn label_break_match(c: u8, xe: u8, ye: i8) {\n+    let mut x = 0;\n+    let y = 'a: {\n+        match c {\n+            0 => break 'a 0,\n+            v if { if v % 2 == 0 { break 'a 1; }; v % 3 == 0 } => { x += 1; },\n+            v if { 'b: { break 'b v == 5; } } => { x = 41; },\n+            _ => 'b: { //~ WARNING `'b` shadows a label\n+                break 'b ();\n+            },\n+        }\n+        x += 1;\n+        -1\n+    };\n+\n+    assert_eq!(x, xe);\n+    assert_eq!(y, ye);\n+}\n+\n+#[allow(unused_labels)]\n+fn label_break_macro() {\n+    macro_rules! mac1 {\n+        ($target:lifetime, $val:expr) => {\n+            break $target $val;\n+        };\n+    }\n+    let x: u8 = 'a: {\n+        'b: {\n+            mac1!('b, 1);\n+        };\n+        0\n+    };\n+    assert_eq!(x, 0);\n+    let x: u8 = 'a: { //~ WARNING `'a` shadows a label\n+        'b: { //~ WARNING `'b` shadows a label\n+            if true {\n+                mac1!('a, 1);\n+            }\n+        };\n+        0\n+    };\n+    assert_eq!(x, 1);\n+}\n+\n pub fn main() {\n     assert_eq!(label_break(true, false), 1);\n     assert_eq!(label_break(false, true), 2);\n@@ -112,5 +156,12 @@ pub fn main() {\n     assert_eq!(label_break_mixed(5), 5);\n     assert_eq!(label_break_mixed(6), 6);\n \n-    // FIXME: ensure that labeled blocks work if produced by macros and in match arms\n+    label_break_match(0, 0, 0);\n+    label_break_match(1, 1, -1);\n+    label_break_match(2, 0, 1);\n+    label_break_match(3, 2, -1);\n+    label_break_match(5, 42, -1);\n+    label_break_match(7, 1, -1);\n+\n+    label_break_macro();\n }"}, {"sha": "b1eb3204fd5997166ca0eac767e228dac6ea49e2", "filename": "src/test/ui/for-loop-while/label_break_value.stderr", "status": "added", "additions": 28, "deletions": 0, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/e3ada27d7d95cdc4e3c05b91c2cf404546c2d7fd/src%2Ftest%2Fui%2Ffor-loop-while%2Flabel_break_value.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/e3ada27d7d95cdc4e3c05b91c2cf404546c2d7fd/src%2Ftest%2Fui%2Ffor-loop-while%2Flabel_break_value.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffor-loop-while%2Flabel_break_value.stderr?ref=e3ada27d7d95cdc4e3c05b91c2cf404546c2d7fd", "patch": "@@ -0,0 +1,28 @@\n+warning: label name `'b` shadows a label name that is already in scope\n+  --> $DIR/label_break_value.rs:105:18\n+   |\n+LL |             v if { 'b: { break 'b v == 5; } } => { x = 41; },\n+   |                    -- first declared here\n+LL |             _ => 'b: {\n+   |                  ^^ label `'b` already in scope\n+\n+warning: label name `'a` shadows a label name that is already in scope\n+  --> $DIR/label_break_value.rs:131:17\n+   |\n+LL |     let x: u8 = 'a: {\n+   |                 -- first declared here\n+...\n+LL |     let x: u8 = 'a: {\n+   |                 ^^ label `'a` already in scope\n+\n+warning: label name `'b` shadows a label name that is already in scope\n+  --> $DIR/label_break_value.rs:132:9\n+   |\n+LL |         'b: {\n+   |         -- first declared here\n+...\n+LL |         'b: {\n+   |         ^^ label `'b` already in scope\n+\n+warning: 3 warnings emitted\n+"}, {"sha": "e603c8463b578ce6c2c942b5174f8cbdae2f4a79", "filename": "src/test/ui/for-loop-while/label_break_value_invalid.rs", "status": "added", "additions": 39, "deletions": 0, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/e3ada27d7d95cdc4e3c05b91c2cf404546c2d7fd/src%2Ftest%2Fui%2Ffor-loop-while%2Flabel_break_value_invalid.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e3ada27d7d95cdc4e3c05b91c2cf404546c2d7fd/src%2Ftest%2Fui%2Ffor-loop-while%2Flabel_break_value_invalid.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffor-loop-while%2Flabel_break_value_invalid.rs?ref=e3ada27d7d95cdc4e3c05b91c2cf404546c2d7fd", "patch": "@@ -0,0 +1,39 @@\n+#![crate_type = \"lib\"]\n+#![feature(label_break_value)]\n+\n+fn lbv_macro_test_hygiene_respected() {\n+    macro_rules! mac2 {\n+        ($val:expr) => {\n+            break 'a $val; //~ ERROR undeclared label `'a` [E0426]\n+        };\n+    }\n+    let x: u8 = 'a: {\n+        'b: {\n+            if true {\n+                mac2!(2);\n+            }\n+        };\n+        0\n+    };\n+    assert_eq!(x, 2);\n+\n+    macro_rules! mac3 {\n+        ($val:expr) => {\n+            'a: {\n+            //~^ WARNING `'a` shadows a label\n+            //~| WARNING `'a` shadows a label\n+            //~| WARNING `'a` shadows a label\n+                $val\n+            }\n+        };\n+    }\n+    let x: u8 = mac3!('b: { //~ WARNING `'b` shadows a label\n+        if true {\n+            break 'a 3; //~ ERROR undeclared label `'a` [E0426]\n+        }\n+        0\n+    });\n+    assert_eq!(x, 3);\n+    let x: u8 = mac3!(break 'a 4); //~ ERROR undeclared label `'a` [E0426]\n+    assert_eq!(x, 4);\n+}"}, {"sha": "549b394e14b101e564d39214ce33d8368a01879b", "filename": "src/test/ui/for-loop-while/label_break_value_invalid.stderr", "status": "added", "additions": 89, "deletions": 0, "changes": 89, "blob_url": "https://github.com/rust-lang/rust/blob/e3ada27d7d95cdc4e3c05b91c2cf404546c2d7fd/src%2Ftest%2Fui%2Ffor-loop-while%2Flabel_break_value_invalid.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/e3ada27d7d95cdc4e3c05b91c2cf404546c2d7fd/src%2Ftest%2Fui%2Ffor-loop-while%2Flabel_break_value_invalid.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffor-loop-while%2Flabel_break_value_invalid.stderr?ref=e3ada27d7d95cdc4e3c05b91c2cf404546c2d7fd", "patch": "@@ -0,0 +1,89 @@\n+error[E0426]: use of undeclared label `'a`\n+  --> $DIR/label_break_value_invalid.rs:7:19\n+   |\n+LL |             break 'a $val;\n+   |                   ^^ undeclared label `'a`\n+...\n+LL |                 mac2!(2);\n+   |                 -------- in this macro invocation\n+   |\n+   = note: this error originates in the macro `mac2` (in Nightly builds, run with -Z macro-backtrace for more info)\n+\n+error[E0426]: use of undeclared label `'a`\n+  --> $DIR/label_break_value_invalid.rs:32:19\n+   |\n+LL |     let x: u8 = mac3!('b: {\n+   |                       -- a label with a similar name is reachable\n+LL |         if true {\n+LL |             break 'a 3;\n+   |                   ^^\n+   |                   |\n+   |                   undeclared label `'a`\n+   |                   help: try using similarly named label: `'b`\n+\n+error[E0426]: use of undeclared label `'a`\n+  --> $DIR/label_break_value_invalid.rs:37:29\n+   |\n+LL |     let x: u8 = mac3!(break 'a 4);\n+   |                             ^^ undeclared label `'a`\n+\n+warning: label name `'a` shadows a label name that is already in scope\n+  --> $DIR/label_break_value_invalid.rs:22:13\n+   |\n+LL |       let x: u8 = 'a: {\n+   |                   -- first declared here\n+...\n+LL |               'a: {\n+   |               ^^ label `'a` already in scope\n+...\n+LL |       let x: u8 = mac3!('b: {\n+   |  _________________-\n+LL | |         if true {\n+LL | |             break 'a 3;\n+LL | |         }\n+LL | |         0\n+LL | |     });\n+   | |______- in this macro invocation\n+   |\n+   = note: this warning originates in the macro `mac3` (in Nightly builds, run with -Z macro-backtrace for more info)\n+\n+warning: label name `'b` shadows a label name that is already in scope\n+  --> $DIR/label_break_value_invalid.rs:30:23\n+   |\n+LL |         'b: {\n+   |         -- first declared here\n+...\n+LL |     let x: u8 = mac3!('b: {\n+   |                       ^^ label `'b` already in scope\n+\n+warning: label name `'a` shadows a label name that is already in scope\n+  --> $DIR/label_break_value_invalid.rs:22:13\n+   |\n+LL |     let x: u8 = 'a: {\n+   |                 -- first declared here\n+...\n+LL |             'a: {\n+   |             ^^ label `'a` already in scope\n+...\n+LL |     let x: u8 = mac3!(break 'a 4);\n+   |                 ----------------- in this macro invocation\n+   |\n+   = note: this warning originates in the macro `mac3` (in Nightly builds, run with -Z macro-backtrace for more info)\n+\n+warning: label name `'a` shadows a label name that is already in scope\n+  --> $DIR/label_break_value_invalid.rs:22:13\n+   |\n+LL |             'a: {\n+   |             ^^\n+   |             |\n+   |             first declared here\n+   |             label `'a` already in scope\n+...\n+LL |     let x: u8 = mac3!(break 'a 4);\n+   |                 ----------------- in this macro invocation\n+   |\n+   = note: this warning originates in the macro `mac3` (in Nightly builds, run with -Z macro-backtrace for more info)\n+\n+error: aborting due to 3 previous errors; 4 warnings emitted\n+\n+For more information about this error, try `rustc --explain E0426`."}]}