{"sha": "53cce257aebe822735ed9eecde152d928a3e7378", "node_id": "MDY6Q29tbWl0NzI0NzEyOjUzY2NlMjU3YWViZTgyMjczNWVkOWVlY2RlMTUyZDkyOGEzZTczNzg=", "commit": {"author": {"name": "Aaron Hill", "email": "aa1ronham@gmail.com", "date": "2020-09-03T16:11:18Z"}, "committer": {"name": "Aaron Hill", "email": "aa1ronham@gmail.com", "date": "2020-09-03T16:13:26Z"}, "message": "Respect `-Z proc-macro-backtrace` flag for panics inside libproc_macro\n\nFixes #76270\n\nPreviously, any panic occuring during a call to a libproc_macro method\n(e.g. calling `Ident::new` with an invalid identifier) would always\ncause an ICE message to be printed.", "tree": {"sha": "45b5847afa7720f8f4f401f2db94179451ed59a0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/45b5847afa7720f8f4f401f2db94179451ed59a0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/53cce257aebe822735ed9eecde152d928a3e7378", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE7J9Gc3TfBwj2K399tAh+UQ6YsWQFAl9RFikACgkQtAh+UQ6Y\nsWQRRA//U9rAP04uOsSIluiEfXnlp39mD86gASmqZULyoealv5MlgcV0kSLwWIqr\n7paTOCzMzOMFWh++//MD2A3ja/MfEcU+l8Heo/j3uWrveVEfArZiXfyJT3bITuq+\nXdn7qxZXZNPSZIUQW6JkKJWx2vqlfaxoLoSBT5XeXJY4YFDbjVo8Sa0F6bWg9bON\n3bpALFZxKmrZboeSiHwWYPxXu9OxeVxbkGb5uON1E+kBeX+Maa6dZlp8h5khBtBZ\neYVl5aKoIeyx8VAaQNDg5YvoUfFtUzt7gwZ8JRIMdUuesWXyNk7EkCPO8KKuAMTp\nKXw5r6jox+kaXs1pcTk2gfb7ChpGf2LAlNPEGhN1EcwzH08J3mhJvpW7PMBi+jyU\nzO7UbiDRWATtsCi4NI1g++yjUu5JoY5kmdE15lSkBdicSx9yc8oQGCMIUtTo1asQ\n6UE66yXdl4amO5Qe5lDCi7MjC6vzrEA9uttnqMoPA3mpPtJ7QPa7+o07+0nS/5dV\nq5uhlYZZFvD4d+WvwWogUYImRJ26MwLgjUGnzbIe6n6SBDG2XxeuaatEOUvBCFdj\nOLqWrKOxbnO6D/inX0OGOm9t1o7iH/rK2ez73G/eTeRS6N/LzrJLOfr12ziqlYlt\nv1ZFviElGiVS/pZbRvrzsAuS6/zC0DHSi8NkO4OFTY/Ery6zGRY=\n=6LuW\n-----END PGP SIGNATURE-----", "payload": "tree 45b5847afa7720f8f4f401f2db94179451ed59a0\nparent 08deb863bdebfcbbb71c18acf903eca84f1df4e7\nauthor Aaron Hill <aa1ronham@gmail.com> 1599149478 -0400\ncommitter Aaron Hill <aa1ronham@gmail.com> 1599149606 -0400\n\nRespect `-Z proc-macro-backtrace` flag for panics inside libproc_macro\n\nFixes #76270\n\nPreviously, any panic occuring during a call to a libproc_macro method\n(e.g. calling `Ident::new` with an invalid identifier) would always\ncause an ICE message to be printed.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/53cce257aebe822735ed9eecde152d928a3e7378", "html_url": "https://github.com/rust-lang/rust/commit/53cce257aebe822735ed9eecde152d928a3e7378", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/53cce257aebe822735ed9eecde152d928a3e7378/comments", "author": {"login": "Aaron1011", "id": 1408859, "node_id": "MDQ6VXNlcjE0MDg4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1408859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Aaron1011", "html_url": "https://github.com/Aaron1011", "followers_url": "https://api.github.com/users/Aaron1011/followers", "following_url": "https://api.github.com/users/Aaron1011/following{/other_user}", "gists_url": "https://api.github.com/users/Aaron1011/gists{/gist_id}", "starred_url": "https://api.github.com/users/Aaron1011/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Aaron1011/subscriptions", "organizations_url": "https://api.github.com/users/Aaron1011/orgs", "repos_url": "https://api.github.com/users/Aaron1011/repos", "events_url": "https://api.github.com/users/Aaron1011/events{/privacy}", "received_events_url": "https://api.github.com/users/Aaron1011/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Aaron1011", "id": 1408859, "node_id": "MDQ6VXNlcjE0MDg4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1408859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Aaron1011", "html_url": "https://github.com/Aaron1011", "followers_url": "https://api.github.com/users/Aaron1011/followers", "following_url": "https://api.github.com/users/Aaron1011/following{/other_user}", "gists_url": "https://api.github.com/users/Aaron1011/gists{/gist_id}", "starred_url": "https://api.github.com/users/Aaron1011/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Aaron1011/subscriptions", "organizations_url": "https://api.github.com/users/Aaron1011/orgs", "repos_url": "https://api.github.com/users/Aaron1011/repos", "events_url": "https://api.github.com/users/Aaron1011/events{/privacy}", "received_events_url": "https://api.github.com/users/Aaron1011/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "08deb863bdebfcbbb71c18acf903eca84f1df4e7", "url": "https://api.github.com/repos/rust-lang/rust/commits/08deb863bdebfcbbb71c18acf903eca84f1df4e7", "html_url": "https://github.com/rust-lang/rust/commit/08deb863bdebfcbbb71c18acf903eca84f1df4e7"}], "stats": {"total": 45, "additions": 42, "deletions": 3}, "files": [{"sha": "39daad4da127d3392e93d86b99d740fb89377f29", "filename": "library/proc_macro/src/bridge/client.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/53cce257aebe822735ed9eecde152d928a3e7378/library%2Fproc_macro%2Fsrc%2Fbridge%2Fclient.rs", "raw_url": "https://github.com/rust-lang/rust/raw/53cce257aebe822735ed9eecde152d928a3e7378/library%2Fproc_macro%2Fsrc%2Fbridge%2Fclient.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fproc_macro%2Fsrc%2Fbridge%2Fclient.rs?ref=53cce257aebe822735ed9eecde152d928a3e7378", "patch": "@@ -305,6 +305,7 @@ impl Bridge<'_> {\n     }\n \n     fn enter<R>(self, f: impl FnOnce() -> R) -> R {\n+        let force_show_panics = self.force_show_panics;\n         // Hide the default panic output within `proc_macro` expansions.\n         // NB. the server can't do this because it may use a different libstd.\n         static HIDE_PANICS_DURING_EXPANSION: Once = Once::new();\n@@ -313,9 +314,7 @@ impl Bridge<'_> {\n             panic::set_hook(Box::new(move |info| {\n                 let show = BridgeState::with(|state| match state {\n                     BridgeState::NotConnected => true,\n-                    // Something weird is going on, so don't suppress any backtraces\n-                    BridgeState::InUse => true,\n-                    BridgeState::Connected(bridge) => bridge.force_show_panics,\n+                    BridgeState::Connected(_) | BridgeState::InUse => force_show_panics,\n                 });\n                 if show {\n                     prev(info)"}, {"sha": "fc15bb9c59db3de0323fd2160f1cc4f89ab33a1f", "filename": "src/test/ui-fulldeps/auxiliary/proc-macro-panic.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/53cce257aebe822735ed9eecde152d928a3e7378/src%2Ftest%2Fui-fulldeps%2Fauxiliary%2Fproc-macro-panic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/53cce257aebe822735ed9eecde152d928a3e7378/src%2Ftest%2Fui-fulldeps%2Fauxiliary%2Fproc-macro-panic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui-fulldeps%2Fauxiliary%2Fproc-macro-panic.rs?ref=53cce257aebe822735ed9eecde152d928a3e7378", "patch": "@@ -0,0 +1,13 @@\n+// force-host\n+// no-prefer-dynamic\n+\n+#![crate_type = \"proc-macro\"]\n+\n+extern crate proc_macro;\n+use proc_macro::{TokenStream, Ident, Span};\n+\n+#[proc_macro]\n+pub fn panic_in_libproc_macro(_: TokenStream) -> TokenStream {\n+    Ident::new(\"\", Span::call_site());\n+    TokenStream::new()\n+}"}, {"sha": "981abb4e2c4d23f80440d59a47e278dd5abd993d", "filename": "src/test/ui-fulldeps/issue-76270-panic-in-libproc-macro.rs", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/53cce257aebe822735ed9eecde152d928a3e7378/src%2Ftest%2Fui-fulldeps%2Fissue-76270-panic-in-libproc-macro.rs", "raw_url": "https://github.com/rust-lang/rust/raw/53cce257aebe822735ed9eecde152d928a3e7378/src%2Ftest%2Fui-fulldeps%2Fissue-76270-panic-in-libproc-macro.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui-fulldeps%2Fissue-76270-panic-in-libproc-macro.rs?ref=53cce257aebe822735ed9eecde152d928a3e7378", "patch": "@@ -0,0 +1,17 @@\n+// aux-build:proc-macro-panic.rs\n+// edition:2018\n+// ignore-stage1\n+// only-linux\n+//\n+// FIXME: This should be a normal (stage1, all platforms) test in\n+// src/test/ui/proc-macro once issue #59998 is fixed.\n+\n+// Regression test for issue #76270\n+// Tests that we don't print an ICE message when a panic\n+// occurs in libproc-macro (when `-Z proc-macro-backtrace` is not specified)\n+\n+extern crate proc_macro_panic;\n+\n+proc_macro_panic::panic_in_libproc_macro!(); //~ ERROR proc macro panicked\n+\n+fn main() {}"}, {"sha": "e472242ce4b07a7f548b132d6f1c6e4160d002f7", "filename": "src/test/ui-fulldeps/issue-76270-panic-in-libproc-macro.stderr", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/53cce257aebe822735ed9eecde152d928a3e7378/src%2Ftest%2Fui-fulldeps%2Fissue-76270-panic-in-libproc-macro.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/53cce257aebe822735ed9eecde152d928a3e7378/src%2Ftest%2Fui-fulldeps%2Fissue-76270-panic-in-libproc-macro.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui-fulldeps%2Fissue-76270-panic-in-libproc-macro.stderr?ref=53cce257aebe822735ed9eecde152d928a3e7378", "patch": "@@ -0,0 +1,10 @@\n+error: proc macro panicked\n+  --> $DIR/issue-76270-panic-in-libproc-macro.rs:15:1\n+   |\n+LL | proc_macro_panic::panic_in_libproc_macro!();\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+   = help: message: `\"\"` is not a valid identifier\n+\n+error: aborting due to previous error\n+"}]}