{"sha": "507dfd2148f68bc3bd6349d5e666b12e360a9d15", "node_id": "MDY6Q29tbWl0NzI0NzEyOjUwN2RmZDIxNDhmNjhiYzNiZDYzNDlkNWU2NjZiMTJlMzYwYTlkMTU=", "commit": {"author": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2018-06-06T07:30:25Z"}, "committer": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2018-06-06T15:49:42Z"}, "message": "Use spans pointing at the inside of a rustdoc attribute", "tree": {"sha": "b15e743eb1f1a57b01b47163bc82f92647ae3ccd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b15e743eb1f1a57b01b47163bc82f92647ae3ccd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/507dfd2148f68bc3bd6349d5e666b12e360a9d15", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/507dfd2148f68bc3bd6349d5e666b12e360a9d15", "html_url": "https://github.com/rust-lang/rust/commit/507dfd2148f68bc3bd6349d5e666b12e360a9d15", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/507dfd2148f68bc3bd6349d5e666b12e360a9d15/comments", "author": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "committer": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "41affd03eb169830773cd1b11efda562ab81fad0", "url": "https://api.github.com/repos/rust-lang/rust/commits/41affd03eb169830773cd1b11efda562ab81fad0", "html_url": "https://github.com/rust-lang/rust/commit/41affd03eb169830773cd1b11efda562ab81fad0"}], "stats": {"total": 117, "additions": 68, "deletions": 49}, "files": [{"sha": "8055c99ceb8393094aa91d163e3877912c95bf45", "filename": "src/librustdoc/clean/mod.rs", "status": "modified", "additions": 30, "deletions": 16, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/507dfd2148f68bc3bd6349d5e666b12e360a9d15/src%2Flibrustdoc%2Fclean%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/507dfd2148f68bc3bd6349d5e666b12e360a9d15/src%2Flibrustdoc%2Fclean%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Fmod.rs?ref=507dfd2148f68bc3bd6349d5e666b12e360a9d15", "patch": "@@ -1191,30 +1191,44 @@ fn resolution_failure(\n     link_range: Option<Range<usize>>,\n ) {\n     let sp = span_of_attrs(attrs);\n-    let mut diag = cx.sess()\n-        .struct_span_warn(sp, &format!(\"[{}] cannot be resolved, ignoring it...\", path_str));\n+    let msg = format!(\"`[{}]` cannot be resolved, ignoring it...\", path_str);\n \n-    if let Some(link_range) = link_range {\n+    let code_dox = sp.to_src(cx);\n+    // The whitespace before the `///` to properly find the original span location.\n+    let dox_leading_whitespace = code_dox.lines().nth(1)\n+        .map(|x| x.len() - x.trim_left().len()).unwrap_or(0);\n+\n+    let doc_comment_padding = 3;\n+    let mut diag = if let Some(link_range) = link_range {\n         // blah blah blah\\nblah\\nblah [blah] blah blah\\nblah blah\n         //                       ^    ~~~~~~\n         //                       |    link_range\n         //                       last_new_line_offset\n \n-        let last_new_line_offset = dox[..link_range.start].rfind('\\n').map_or(0, |n| n + 1);\n-        let line = dox[last_new_line_offset..].lines().next().unwrap_or(\"\");\n-\n-        // Print the line containing the `link_range` and manually mark it with '^'s\n-        diag.note(&format!(\n-            \"the link appears in this line:\\n\\n{line}\\n{indicator: <before$}{indicator:^<found$}\",\n-            line=line,\n-            indicator=\"\",\n-            before=link_range.start - last_new_line_offset,\n-            found=link_range.len(),\n-        ));\n-    } else {\n+        let line_offset = dox[..link_range.start].lines().count();\n+        let code_dox_len = if line_offset <= 1 {\n+            // The span starts in the `///`, so we don't have to account for the leading whitespace\n+            doc_comment_padding\n+        } else {\n+            // The first `///`\n+            doc_comment_padding +\n+                // Each subsequent leading whitespace and `///`\n+                (doc_comment_padding + dox_leading_whitespace)\n+                // The line position inside the doc string\n+                * (line_offset - 1)\n+        };\n \n-    }\n+        // Extract the specific span\n+        let lo = sp.lo() + syntax_pos::BytePos((link_range.start + code_dox_len) as u32);\n+        let hi = lo + syntax_pos::BytePos(link_range.len() as u32);\n+        let sp = sp.with_lo(lo).with_hi(hi);\n \n+        let mut diag = cx.sess().struct_span_warn(sp, &msg);\n+        diag.span_label(sp, \"cannot be resolved, ignoring\");\n+        diag\n+    } else {\n+        cx.sess().struct_span_warn(sp, &msg)\n+    };\n     diag.emit();\n }\n "}, {"sha": "0d886bf0972261bc128d133843915bb3e0c040aa", "filename": "src/test/rustdoc-ui/intra-links-warning.rs", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/507dfd2148f68bc3bd6349d5e666b12e360a9d15/src%2Ftest%2Frustdoc-ui%2Fintra-links-warning.rs", "raw_url": "https://github.com/rust-lang/rust/raw/507dfd2148f68bc3bd6349d5e666b12e360a9d15/src%2Ftest%2Frustdoc-ui%2Fintra-links-warning.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fintra-links-warning.rs?ref=507dfd2148f68bc3bd6349d5e666b12e360a9d15", "patch": "@@ -10,10 +10,12 @@\n \n // compile-pass\n \n-//! Test with [Foo::baz], [Bar::foo], ...\n-//!\n-//! and [Uniooon::X].\n+       //! Test with [Foo::baz], [Bar::foo], ...\n+       //! , [Uniooon::X] and [Qux::Z].\n+       //! .\n+       //! , [Uniooon::X] and [Qux::Z].\n \n+       /// [Qux:Y]\n pub struct Foo {\n     pub bar: usize,\n }"}, {"sha": "a5a5598ed8fc8a4c974cce67f44411bf9ebf19ce", "filename": "src/test/rustdoc-ui/intra-links-warning.stderr", "status": "modified", "additions": 33, "deletions": 30, "changes": 63, "blob_url": "https://github.com/rust-lang/rust/blob/507dfd2148f68bc3bd6349d5e666b12e360a9d15/src%2Ftest%2Frustdoc-ui%2Fintra-links-warning.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/507dfd2148f68bc3bd6349d5e666b12e360a9d15/src%2Ftest%2Frustdoc-ui%2Fintra-links-warning.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fintra-links-warning.stderr?ref=507dfd2148f68bc3bd6349d5e666b12e360a9d15", "patch": "@@ -1,39 +1,42 @@\n-warning: [Foo::baz] cannot be resolved, ignoring it...\n-  --> $DIR/intra-links-warning.rs:13:1\n+warning: `[Foo::baz]` cannot be resolved, ignoring it...\n+  --> $DIR/intra-links-warning.rs:13:23\n    |\n-13 | / //! Test with [Foo::baz], [Bar::foo], ...\n-14 | | //!\n-15 | | //! and [Uniooon::X].\n-   | |_____________________^\n+13 |        //! Test with [Foo::baz], [Bar::foo], ...\n+   |                       ^^^^^^^^ cannot be resolved, ignoring\n+\n+warning: `[Bar::foo]` cannot be resolved, ignoring it...\n+  --> $DIR/intra-links-warning.rs:13:35\n    |\n-   = note: the link appears in this line:\n-           \n-            Test with [Foo::baz], [Bar::foo], ...\n-                       ^^^^^^^^\n+13 |        //! Test with [Foo::baz], [Bar::foo], ...\n+   |                                   ^^^^^^^^ cannot be resolved, ignoring\n \n-warning: [Bar::foo] cannot be resolved, ignoring it...\n-  --> $DIR/intra-links-warning.rs:13:1\n+warning: `[Uniooon::X]` cannot be resolved, ignoring it...\n+  --> $DIR/intra-links-warning.rs:14:15\n    |\n-13 | / //! Test with [Foo::baz], [Bar::foo], ...\n-14 | | //!\n-15 | | //! and [Uniooon::X].\n-   | |_____________________^\n+14 |        //! , [Uniooon::X] and [Qux::Z].\n+   |               ^^^^^^^^^^ cannot be resolved, ignoring\n+\n+warning: `[Qux::Z]` cannot be resolved, ignoring it...\n+  --> $DIR/intra-links-warning.rs:14:32\n    |\n-   = note: the link appears in this line:\n-           \n-            Test with [Foo::baz], [Bar::foo], ...\n-                                   ^^^^^^^^\n+14 |        //! , [Uniooon::X] and [Qux::Z].\n+   |                                ^^^^^^ cannot be resolved, ignoring\n \n-warning: [Uniooon::X] cannot be resolved, ignoring it...\n-  --> $DIR/intra-links-warning.rs:13:1\n+warning: `[Uniooon::X]` cannot be resolved, ignoring it...\n+  --> $DIR/intra-links-warning.rs:16:15\n    |\n-13 | / //! Test with [Foo::baz], [Bar::foo], ...\n-14 | | //!\n-15 | | //! and [Uniooon::X].\n-   | |_____________________^\n+16 |        //! , [Uniooon::X] and [Qux::Z].\n+   |               ^^^^^^^^^^ cannot be resolved, ignoring\n+\n+warning: `[Qux::Z]` cannot be resolved, ignoring it...\n+  --> $DIR/intra-links-warning.rs:16:32\n+   |\n+16 |        //! , [Uniooon::X] and [Qux::Z].\n+   |                                ^^^^^^ cannot be resolved, ignoring\n+\n+warning: `[Qux:Y]` cannot be resolved, ignoring it...\n+  --> $DIR/intra-links-warning.rs:18:13\n    |\n-   = note: the link appears in this line:\n-           \n-            and [Uniooon::X].\n-                 ^^^^^^^^^^\n+18 |        /// [Qux:Y]\n+   |             ^^^^^ cannot be resolved, ignoring\n "}]}