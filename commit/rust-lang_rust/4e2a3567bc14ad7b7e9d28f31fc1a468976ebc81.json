{"sha": "4e2a3567bc14ad7b7e9d28f31fc1a468976ebc81", "node_id": "C_kwDOAAsO6NoAKDRlMmEzNTY3YmMxNGFkN2I3ZTlkMjhmMzFmYzFhNDY4OTc2ZWJjODE", "commit": {"author": {"name": "Yuki Omoto", "email": "yukeomoto@gmail.com", "date": "2023-01-11T15:17:48Z"}, "committer": {"name": "Yuki Omoto", "email": "yukeomoto@gmail.com", "date": "2023-01-11T15:17:48Z"}, "message": "Add log-backtrace option to show backtraces along with logging", "tree": {"sha": "b1e06330b9cfad3f160b0acc8df47b7cf1602a99", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b1e06330b9cfad3f160b0acc8df47b7cf1602a99"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4e2a3567bc14ad7b7e9d28f31fc1a468976ebc81", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4e2a3567bc14ad7b7e9d28f31fc1a468976ebc81", "html_url": "https://github.com/rust-lang/rust/commit/4e2a3567bc14ad7b7e9d28f31fc1a468976ebc81", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4e2a3567bc14ad7b7e9d28f31fc1a468976ebc81/comments", "author": {"login": "yukiomoto", "id": 38450410, "node_id": "MDQ6VXNlcjM4NDUwNDEw", "avatar_url": "https://avatars.githubusercontent.com/u/38450410?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yukiomoto", "html_url": "https://github.com/yukiomoto", "followers_url": "https://api.github.com/users/yukiomoto/followers", "following_url": "https://api.github.com/users/yukiomoto/following{/other_user}", "gists_url": "https://api.github.com/users/yukiomoto/gists{/gist_id}", "starred_url": "https://api.github.com/users/yukiomoto/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yukiomoto/subscriptions", "organizations_url": "https://api.github.com/users/yukiomoto/orgs", "repos_url": "https://api.github.com/users/yukiomoto/repos", "events_url": "https://api.github.com/users/yukiomoto/events{/privacy}", "received_events_url": "https://api.github.com/users/yukiomoto/received_events", "type": "User", "site_admin": false}, "committer": {"login": "yukiomoto", "id": 38450410, "node_id": "MDQ6VXNlcjM4NDUwNDEw", "avatar_url": "https://avatars.githubusercontent.com/u/38450410?v=4", "gravatar_id": "", "url": "https://api.github.com/users/yukiomoto", "html_url": "https://github.com/yukiomoto", "followers_url": "https://api.github.com/users/yukiomoto/followers", "following_url": "https://api.github.com/users/yukiomoto/following{/other_user}", "gists_url": "https://api.github.com/users/yukiomoto/gists{/gist_id}", "starred_url": "https://api.github.com/users/yukiomoto/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/yukiomoto/subscriptions", "organizations_url": "https://api.github.com/users/yukiomoto/orgs", "repos_url": "https://api.github.com/users/yukiomoto/repos", "events_url": "https://api.github.com/users/yukiomoto/events{/privacy}", "received_events_url": "https://api.github.com/users/yukiomoto/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1e4f90061cc4bc566f99ab21b1f101182b10cf0c", "url": "https://api.github.com/repos/rust-lang/rust/commits/1e4f90061cc4bc566f99ab21b1f101182b10cf0c", "html_url": "https://github.com/rust-lang/rust/commit/1e4f90061cc4bc566f99ab21b1f101182b10cf0c"}], "stats": {"total": 87, "additions": 83, "deletions": 4}, "files": [{"sha": "b0f050a85d2f1edd00b23020ce8113ffd3b5a09c", "filename": "Cargo.lock", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/4e2a3567bc14ad7b7e9d28f31fc1a468976ebc81/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/4e2a3567bc14ad7b7e9d28f31fc1a468976ebc81/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=4e2a3567bc14ad7b7e9d28f31fc1a468976ebc81", "patch": "@@ -4273,6 +4273,7 @@ version = \"0.0.0\"\n dependencies = [\n  \"rustc_span\",\n  \"tracing\",\n+ \"tracing-core\",\n  \"tracing-subscriber\",\n  \"tracing-tree\",\n ]"}, {"sha": "dcce56ba763892db7399f2f814fe78e803241e38", "filename": "compiler/rustc_driver/src/lib.rs", "status": "modified", "additions": 12, "deletions": 2, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/4e2a3567bc14ad7b7e9d28f31fc1a468976ebc81/compiler%2Frustc_driver%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4e2a3567bc14ad7b7e9d28f31fc1a468976ebc81/compiler%2Frustc_driver%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_driver%2Fsrc%2Flib.rs?ref=4e2a3567bc14ad7b7e9d28f31fc1a468976ebc81", "patch": "@@ -231,6 +231,10 @@ fn run_compiler(\n         registry: diagnostics_registry(),\n     };\n \n+    if !tracing::dispatcher::has_been_set() {\n+        init_rustc_env_logger_with_backtrace_option(&config.opts.unstable_opts.log_backtrace);\n+    }\n+\n     match make_input(config.opts.error_format, &matches.free) {\n         Err(reported) => return Err(reported),\n         Ok(Some((input, input_file_path))) => {\n@@ -1299,7 +1303,14 @@ pub fn install_ice_hook() {\n /// This allows tools to enable rust logging without having to magically match rustc's\n /// tracing crate version.\n pub fn init_rustc_env_logger() {\n-    if let Err(error) = rustc_log::init_rustc_env_logger() {\n+    init_rustc_env_logger_with_backtrace_option(&None);\n+}\n+\n+/// This allows tools to enable rust logging without having to magically match rustc's\n+/// tracing crate version. In contrast to `init_rustc_env_logger` it allows you to\n+/// choose a target module you wish to show backtraces along with its logging.\n+pub fn init_rustc_env_logger_with_backtrace_option(backtrace_target: &Option<String>) {\n+    if let Err(error) = rustc_log::init_rustc_env_logger_with_backtrace_option(backtrace_target) {\n         early_error(ErrorOutputType::default(), &error.to_string());\n     }\n }\n@@ -1365,7 +1376,6 @@ mod signal_handler {\n pub fn main() -> ! {\n     let start_time = Instant::now();\n     let start_rss = get_resident_set_size();\n-    init_rustc_env_logger();\n     signal_handler::install();\n     let mut callbacks = TimePassesCallbacks::default();\n     install_ice_hook();"}, {"sha": "07b28cc86cee1c95601f320e5ead863001913ab7", "filename": "compiler/rustc_interface/src/tests.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/4e2a3567bc14ad7b7e9d28f31fc1a468976ebc81/compiler%2Frustc_interface%2Fsrc%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4e2a3567bc14ad7b7e9d28f31fc1a468976ebc81/compiler%2Frustc_interface%2Fsrc%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_interface%2Fsrc%2Ftests.rs?ref=4e2a3567bc14ad7b7e9d28f31fc1a468976ebc81", "patch": "@@ -748,6 +748,7 @@ fn test_unstable_options_tracking_hash() {\n     tracked!(link_only, true);\n     tracked!(llvm_plugins, vec![String::from(\"plugin_name\")]);\n     tracked!(location_detail, LocationDetail { file: true, line: false, column: false });\n+    tracked!(log_backtrace, Some(\"filter\".to_string()));\n     tracked!(maximal_hir_to_mir_coverage, true);\n     tracked!(merge_functions, Some(MergeFunctions::Disabled));\n     tracked!(mir_emit_retag, true);"}, {"sha": "7f955b0a75090ee7234784612bdd1a316a80f47b", "filename": "compiler/rustc_log/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/4e2a3567bc14ad7b7e9d28f31fc1a468976ebc81/compiler%2Frustc_log%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/4e2a3567bc14ad7b7e9d28f31fc1a468976ebc81/compiler%2Frustc_log%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_log%2FCargo.toml?ref=4e2a3567bc14ad7b7e9d28f31fc1a468976ebc81", "patch": "@@ -7,6 +7,7 @@ edition = \"2021\"\n tracing = \"0.1.28\"\n tracing-subscriber = { version = \"0.3.3\", default-features = false, features = [\"fmt\", \"env-filter\", \"smallvec\", \"parking_lot\", \"ansi\"] }\n tracing-tree = \"0.2.0\"\n+tracing-core = \"0.1.28\"\n \n [dev-dependencies]\n rustc_span = { path = \"../rustc_span\" }"}, {"sha": "fc1cabd2de95134ab892f7e9f06b8b09d90e2fa2", "filename": "compiler/rustc_log/src/lib.rs", "status": "modified", "additions": 56, "deletions": 2, "changes": 58, "blob_url": "https://github.com/rust-lang/rust/blob/4e2a3567bc14ad7b7e9d28f31fc1a468976ebc81/compiler%2Frustc_log%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4e2a3567bc14ad7b7e9d28f31fc1a468976ebc81/compiler%2Frustc_log%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_log%2Fsrc%2Flib.rs?ref=4e2a3567bc14ad7b7e9d28f31fc1a468976ebc81", "patch": "@@ -45,16 +45,34 @@\n use std::env::{self, VarError};\n use std::fmt::{self, Display};\n use std::io::{self, IsTerminal};\n+use tracing_core::{Event, Subscriber};\n use tracing_subscriber::filter::{Directive, EnvFilter, LevelFilter};\n+use tracing_subscriber::fmt::{\n+    format::{self, FormatEvent, FormatFields},\n+    FmtContext,\n+};\n use tracing_subscriber::layer::SubscriberExt;\n \n pub fn init_rustc_env_logger() -> Result<(), Error> {\n-    init_env_logger(\"RUSTC_LOG\")\n+    init_rustc_env_logger_with_backtrace_option(&None)\n+}\n+\n+pub fn init_rustc_env_logger_with_backtrace_option(\n+    backtrace_target: &Option<String>,\n+) -> Result<(), Error> {\n+    init_env_logger_with_backtrace_option(\"RUSTC_LOG\", backtrace_target)\n }\n \n /// In contrast to `init_rustc_env_logger` this allows you to choose an env var\n /// other than `RUSTC_LOG`.\n pub fn init_env_logger(env: &str) -> Result<(), Error> {\n+    init_env_logger_with_backtrace_option(env, &None)\n+}\n+\n+pub fn init_env_logger_with_backtrace_option(\n+    env: &str,\n+    backtrace_target: &Option<String>,\n+) -> Result<(), Error> {\n     let filter = match env::var(env) {\n         Ok(env) => EnvFilter::new(env),\n         _ => EnvFilter::default().add_directive(Directive::from(LevelFilter::WARN)),\n@@ -88,11 +106,47 @@ pub fn init_env_logger(env: &str) -> Result<(), Error> {\n     let layer = layer.with_thread_ids(true).with_thread_names(true);\n \n     let subscriber = tracing_subscriber::Registry::default().with(filter).with(layer);\n-    tracing::subscriber::set_global_default(subscriber).unwrap();\n+    match backtrace_target {\n+        Some(str) => {\n+            let fmt_layer = tracing_subscriber::fmt::layer()\n+                .with_writer(io::stderr)\n+                .without_time()\n+                .event_format(BacktraceFormatter { backtrace_target: str.to_string() });\n+            let subscriber = subscriber.with(fmt_layer);\n+            tracing::subscriber::set_global_default(subscriber).unwrap();\n+        }\n+        None => {\n+            tracing::subscriber::set_global_default(subscriber).unwrap();\n+        }\n+    };\n \n     Ok(())\n }\n \n+struct BacktraceFormatter {\n+    backtrace_target: String,\n+}\n+\n+impl<S, N> FormatEvent<S, N> for BacktraceFormatter\n+where\n+    S: Subscriber + for<'a> tracing_subscriber::registry::LookupSpan<'a>,\n+    N: for<'a> FormatFields<'a> + 'static,\n+{\n+    fn format_event(\n+        &self,\n+        _ctx: &FmtContext<'_, S, N>,\n+        mut writer: format::Writer<'_>,\n+        event: &Event<'_>,\n+    ) -> fmt::Result {\n+        let target = event.metadata().target();\n+        if !target.contains(&self.backtrace_target) {\n+            return Ok(());\n+        }\n+        let backtrace = std::backtrace::Backtrace::capture();\n+        writeln!(writer, \"stack backtrace: \\n{:?}\", backtrace)\n+    }\n+}\n+\n pub fn stdout_isatty() -> bool {\n     io::stdout().is_terminal()\n }"}, {"sha": "7b5fd6cc2a81d9a0c3bc45c660b34f3c7ec7fec3", "filename": "compiler/rustc_session/src/options.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/4e2a3567bc14ad7b7e9d28f31fc1a468976ebc81/compiler%2Frustc_session%2Fsrc%2Foptions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4e2a3567bc14ad7b7e9d28f31fc1a468976ebc81/compiler%2Frustc_session%2Fsrc%2Foptions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Foptions.rs?ref=4e2a3567bc14ad7b7e9d28f31fc1a468976ebc81", "patch": "@@ -1411,6 +1411,8 @@ options! {\n         \"what location details should be tracked when using caller_location, either \\\n         `none`, or a comma separated list of location details, for which \\\n         valid options are `file`, `line`, and `column` (default: `file,line,column`)\"),\n+    log_backtrace: Option<String> = (None, parse_opt_string, [TRACKED],\n+        \"add a backtrace along with logging\"),\n     ls: bool = (false, parse_bool, [UNTRACKED],\n         \"list the symbols defined by a library crate (default: no)\"),\n     macro_backtrace: bool = (false, parse_bool, [UNTRACKED],"}, {"sha": "4bdecdc1b79446302261626e67df86d9c77e6ad0", "filename": "tests/rustdoc-ui/z-help.stdout", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/4e2a3567bc14ad7b7e9d28f31fc1a468976ebc81/tests%2Frustdoc-ui%2Fz-help.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/4e2a3567bc14ad7b7e9d28f31fc1a468976ebc81/tests%2Frustdoc-ui%2Fz-help.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frustdoc-ui%2Fz-help.stdout?ref=4e2a3567bc14ad7b7e9d28f31fc1a468976ebc81", "patch": "@@ -76,6 +76,7 @@\n     -Z                            llvm-plugins=val -- a list LLVM plugins to enable (space separated)\n     -Z                         llvm-time-trace=val -- generate JSON tracing data file from LLVM data (default: no)\n     -Z                         location-detail=val -- what location details should be tracked when using caller_location, either `none`, or a comma separated list of location details, for which valid options are `file`, `line`, and `column` (default: `file,line,column`)\n+    -Z                           log-backtrace=val -- add a backtrace along with logging\n     -Z                                      ls=val -- list the symbols defined by a library crate (default: no)\n     -Z                         macro-backtrace=val -- show macro backtraces (default: no)\n     -Z             maximal-hir-to-mir-coverage=val -- save as much information as possible about the correspondence between MIR and HIR as source scopes (default: no)"}, {"sha": "3979d2001fc5957ae109d6e4bdd9f8b672a6b8b9", "filename": "tests/ui/attributes/log-backtrace.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/4e2a3567bc14ad7b7e9d28f31fc1a468976ebc81/tests%2Fui%2Fattributes%2Flog-backtrace.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4e2a3567bc14ad7b7e9d28f31fc1a468976ebc81/tests%2Fui%2Fattributes%2Flog-backtrace.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fattributes%2Flog-backtrace.rs?ref=4e2a3567bc14ad7b7e9d28f31fc1a468976ebc81", "patch": "@@ -0,0 +1,9 @@\n+// run-pass\n+//\n+// This test makes sure that log-backtrace option doesn't give a compilation error.\n+//\n+// dont-check-compiler-stdout\n+// dont-check-compiler-stderr\n+// rustc-env:RUSTC_LOG=info\n+// compile-flags: -Zlog-backtrace=rustc_metadata::creader\n+fn main() {}"}]}