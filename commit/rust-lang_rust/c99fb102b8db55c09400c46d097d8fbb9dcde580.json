{"sha": "c99fb102b8db55c09400c46d097d8fbb9dcde580", "node_id": "MDY6Q29tbWl0NzI0NzEyOmM5OWZiMTAyYjhkYjU1YzA5NDAwYzQ2ZDA5N2Q4ZmJiOWRjZGU1ODA=", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2020-09-12T11:33:30Z"}, "committer": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2020-09-17T15:33:47Z"}, "message": "test 'cargo miri run' CWD, also for subcrate in a workspace", "tree": {"sha": "09a117e8fa85ab3c7c9c3798478a2bec71087d79", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/09a117e8fa85ab3c7c9c3798478a2bec71087d79"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c99fb102b8db55c09400c46d097d8fbb9dcde580", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c99fb102b8db55c09400c46d097d8fbb9dcde580", "html_url": "https://github.com/rust-lang/rust/commit/c99fb102b8db55c09400c46d097d8fbb9dcde580", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c99fb102b8db55c09400c46d097d8fbb9dcde580/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "113a335c3eae30c0e7e2d691ccbba66bd1d1e75e", "url": "https://api.github.com/repos/rust-lang/rust/commits/113a335c3eae30c0e7e2d691ccbba66bd1d1e75e", "html_url": "https://github.com/rust-lang/rust/commit/113a335c3eae30c0e7e2d691ccbba66bd1d1e75e"}], "stats": {"total": 111, "additions": 74, "deletions": 37}, "files": [{"sha": "6bc70135a898a3226e9b8c85957fef2acadb4fb6", "filename": "test-cargo-miri/Cargo.lock", "status": "modified", "additions": 37, "deletions": 35, "changes": 72, "blob_url": "https://github.com/rust-lang/rust/blob/c99fb102b8db55c09400c46d097d8fbb9dcde580/test-cargo-miri%2FCargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/c99fb102b8db55c09400c46d097d8fbb9dcde580/test-cargo-miri%2FCargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/test-cargo-miri%2FCargo.lock?ref=c99fb102b8db55c09400c46d097d8fbb9dcde580", "patch": "@@ -4,120 +4,122 @@\n name = \"byteorder\"\n version = \"1.3.4\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"08c48aae112d48ed9f069b33538ea9e3e90aa263cfa3d1c24309612b1f7472de\"\n \n [[package]]\n name = \"cargo-miri-test\"\n version = \"0.1.0\"\n dependencies = [\n- \"byteorder 1.3.4 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"num_cpus 1.12.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"rand 0.7.3 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"byteorder\",\n+ \"num_cpus\",\n+ \"rand\",\n ]\n \n [[package]]\n name = \"cfg-if\"\n version = \"0.1.10\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"4785bdd1c96b2a846b2bd7cc02e86b6b3dbf14e7e53446c4f54c92a361040822\"\n \n [[package]]\n name = \"getrandom\"\n version = \"0.1.14\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"7abc8dd8451921606d809ba32e95b6111925cd2906060d2dcc29c070220503eb\"\n dependencies = [\n- \"cfg-if 0.1.10 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"libc 0.2.68 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"wasi 0.9.0+wasi-snapshot-preview1 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"cfg-if\",\n+ \"libc\",\n+ \"wasi\",\n ]\n \n [[package]]\n name = \"hermit-abi\"\n version = \"0.1.10\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"725cf19794cf90aa94e65050cb4191ff5d8fa87a498383774c47b332e3af952e\"\n dependencies = [\n- \"libc 0.2.68 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"libc\",\n ]\n \n [[package]]\n name = \"libc\"\n version = \"0.2.68\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"dea0c0405123bba743ee3f91f49b1c7cfb684eef0da0a50110f758ccf24cdff0\"\n \n [[package]]\n name = \"num_cpus\"\n version = \"1.12.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"46203554f085ff89c235cd12f7075f3233af9b11ed7c9e16dfe2560d03313ce6\"\n dependencies = [\n- \"hermit-abi 0.1.10 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"libc 0.2.68 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"hermit-abi\",\n+ \"libc\",\n ]\n \n [[package]]\n name = \"ppv-lite86\"\n version = \"0.2.6\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"74490b50b9fbe561ac330df47c08f3f33073d2d00c150f719147d7c54522fa1b\"\n \n [[package]]\n name = \"rand\"\n version = \"0.7.3\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"6a6b1679d49b24bbfe0c803429aa1874472f50d9b363131f0e89fc356b544d03\"\n dependencies = [\n- \"getrandom 0.1.14 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"libc 0.2.68 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"rand_chacha 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"rand_core 0.5.1 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"rand_hc 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"rand_pcg 0.2.1 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"getrandom\",\n+ \"libc\",\n+ \"rand_chacha\",\n+ \"rand_core\",\n+ \"rand_hc\",\n+ \"rand_pcg\",\n ]\n \n [[package]]\n name = \"rand_chacha\"\n version = \"0.2.2\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"f4c8ed856279c9737206bf725bf36935d8666ead7aa69b52be55af369d193402\"\n dependencies = [\n- \"ppv-lite86 0.2.6 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"rand_core 0.5.1 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"ppv-lite86\",\n+ \"rand_core\",\n ]\n \n [[package]]\n name = \"rand_core\"\n version = \"0.5.1\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"90bde5296fc891b0cef12a6d03ddccc162ce7b2aff54160af9338f8d40df6d19\"\n dependencies = [\n- \"getrandom 0.1.14 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"getrandom\",\n ]\n \n [[package]]\n name = \"rand_hc\"\n version = \"0.2.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"ca3129af7b92a17112d59ad498c6f81eaf463253766b90396d39ea7a39d6613c\"\n dependencies = [\n- \"rand_core 0.5.1 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"rand_core\",\n ]\n \n [[package]]\n name = \"rand_pcg\"\n version = \"0.2.1\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"16abd0c1b639e9eb4d7c50c0b8100b0d0f849be2349829c740fe8e6eb4816429\"\n dependencies = [\n- \"rand_core 0.5.1 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"rand_core\",\n ]\n \n+[[package]]\n+name = \"subcrate\"\n+version = \"0.1.0\"\n+\n [[package]]\n name = \"wasi\"\n version = \"0.9.0+wasi-snapshot-preview1\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-\n-[metadata]\n-\"checksum byteorder 1.3.4 (registry+https://github.com/rust-lang/crates.io-index)\" = \"08c48aae112d48ed9f069b33538ea9e3e90aa263cfa3d1c24309612b1f7472de\"\n-\"checksum cfg-if 0.1.10 (registry+https://github.com/rust-lang/crates.io-index)\" = \"4785bdd1c96b2a846b2bd7cc02e86b6b3dbf14e7e53446c4f54c92a361040822\"\n-\"checksum getrandom 0.1.14 (registry+https://github.com/rust-lang/crates.io-index)\" = \"7abc8dd8451921606d809ba32e95b6111925cd2906060d2dcc29c070220503eb\"\n-\"checksum hermit-abi 0.1.10 (registry+https://github.com/rust-lang/crates.io-index)\" = \"725cf19794cf90aa94e65050cb4191ff5d8fa87a498383774c47b332e3af952e\"\n-\"checksum libc 0.2.68 (registry+https://github.com/rust-lang/crates.io-index)\" = \"dea0c0405123bba743ee3f91f49b1c7cfb684eef0da0a50110f758ccf24cdff0\"\n-\"checksum num_cpus 1.12.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"46203554f085ff89c235cd12f7075f3233af9b11ed7c9e16dfe2560d03313ce6\"\n-\"checksum ppv-lite86 0.2.6 (registry+https://github.com/rust-lang/crates.io-index)\" = \"74490b50b9fbe561ac330df47c08f3f33073d2d00c150f719147d7c54522fa1b\"\n-\"checksum rand 0.7.3 (registry+https://github.com/rust-lang/crates.io-index)\" = \"6a6b1679d49b24bbfe0c803429aa1874472f50d9b363131f0e89fc356b544d03\"\n-\"checksum rand_chacha 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)\" = \"f4c8ed856279c9737206bf725bf36935d8666ead7aa69b52be55af369d193402\"\n-\"checksum rand_core 0.5.1 (registry+https://github.com/rust-lang/crates.io-index)\" = \"90bde5296fc891b0cef12a6d03ddccc162ce7b2aff54160af9338f8d40df6d19\"\n-\"checksum rand_hc 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"ca3129af7b92a17112d59ad498c6f81eaf463253766b90396d39ea7a39d6613c\"\n-\"checksum rand_pcg 0.2.1 (registry+https://github.com/rust-lang/crates.io-index)\" = \"16abd0c1b639e9eb4d7c50c0b8100b0d0f849be2349829c740fe8e6eb4816429\"\n-\"checksum wasi 0.9.0+wasi-snapshot-preview1 (registry+https://github.com/rust-lang/crates.io-index)\" = \"cccddf32554fecc6acb585f82a32a72e28b48f8c4c1883ddfeeeaa96f7d8e519\"\n+checksum = \"cccddf32554fecc6acb585f82a32a72e28b48f8c4c1883ddfeeeaa96f7d8e519\""}, {"sha": "131e18498539d95e11176e83c0e26fbb9fce861a", "filename": "test-cargo-miri/Cargo.toml", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/c99fb102b8db55c09400c46d097d8fbb9dcde580/test-cargo-miri%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/c99fb102b8db55c09400c46d097d8fbb9dcde580/test-cargo-miri%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/test-cargo-miri%2FCargo.toml?ref=c99fb102b8db55c09400c46d097d8fbb9dcde580", "patch": "@@ -1,7 +1,10 @@\n+[workspace]\n+members = [\"subcrate\"]\n+\n [package]\n name = \"cargo-miri-test\"\n version = \"0.1.0\"\n-authors = [\"Oliver Schneider <git-spam-no-reply9815368754983@oli-obk.de>\"]\n+authors = [\"Miri Team\"]\n edition = \"2018\"\n \n [dependencies]"}, {"sha": "430c8a75830da4df04be4504740534bc78f47b0a", "filename": "test-cargo-miri/run-test.py", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/c99fb102b8db55c09400c46d097d8fbb9dcde580/test-cargo-miri%2Frun-test.py", "raw_url": "https://github.com/rust-lang/rust/raw/c99fb102b8db55c09400c46d097d8fbb9dcde580/test-cargo-miri%2Frun-test.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/test-cargo-miri%2Frun-test.py?ref=c99fb102b8db55c09400c46d097d8fbb9dcde580", "patch": "@@ -63,6 +63,11 @@ def test_cargo_miri_run():\n         cargo_miri(\"run\") + [\"--bin\", \"cargo-miri-test\", \"--\", \"hello world\", '\"hello world\"'],\n         \"stdout.ref2\", \"stderr.ref2\"\n     )\n+    test(\"`cargo miri run` (subcrate)\",\n+        cargo_miri(\"run\") + [\"-p\", \"subcrate\"],\n+        \"stdout.ref3\", \"stderr.ref3\",\n+        env={'MIRIFLAGS': \"-Zmiri-disable-isolation\"},\n+    )\n \n def test_cargo_miri_test():\n     # rustdoc is not run on foreign targets"}, {"sha": "5f311441bfaf5ef67aa827c0eb8ab471586decf3", "filename": "test-cargo-miri/src/main.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/c99fb102b8db55c09400c46d097d8fbb9dcde580/test-cargo-miri%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c99fb102b8db55c09400c46d097d8fbb9dcde580/test-cargo-miri%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/test-cargo-miri%2Fsrc%2Fmain.rs?ref=c99fb102b8db55c09400c46d097d8fbb9dcde580", "patch": "@@ -1,4 +1,6 @@\n use byteorder::{BigEndian, ByteOrder};\n+use std::env;\n+use std::path::PathBuf;\n #[cfg(unix)]\n use std::io::{self, BufRead};\n \n@@ -17,8 +19,12 @@ fn main() {\n         eprintln!(\"{}\", arg);\n     }\n \n-    // If there were no arguments, access stdin.\n+    // If there were no arguments, access stdin and test working dir.\n     if std::env::args().len() <= 1 {\n+        let env_dir = env::current_dir().unwrap();\n+        let crate_dir = PathBuf::from(env::var_os(\"CARGO_MANIFEST_DIR\").unwrap());\n+        assert_eq!(env_dir, crate_dir);\n+\n         #[cfg(unix)]\n         for line in io::stdin().lock().lines() {\n             let num: i32 = line.unwrap().parse().unwrap();"}, {"sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391", "filename": "test-cargo-miri/stderr.ref3", "status": "added", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/c99fb102b8db55c09400c46d097d8fbb9dcde580/test-cargo-miri%2Fstderr.ref3", "raw_url": "https://github.com/rust-lang/rust/raw/c99fb102b8db55c09400c46d097d8fbb9dcde580/test-cargo-miri%2Fstderr.ref3", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/test-cargo-miri%2Fstderr.ref3?ref=c99fb102b8db55c09400c46d097d8fbb9dcde580"}, {"sha": "53340a502381d5a595671540cadf40e1a8ed2514", "filename": "test-cargo-miri/stdout.ref3", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/c99fb102b8db55c09400c46d097d8fbb9dcde580/test-cargo-miri%2Fstdout.ref3", "raw_url": "https://github.com/rust-lang/rust/raw/c99fb102b8db55c09400c46d097d8fbb9dcde580/test-cargo-miri%2Fstdout.ref3", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/test-cargo-miri%2Fstdout.ref3?ref=c99fb102b8db55c09400c46d097d8fbb9dcde580", "patch": "@@ -0,0 +1 @@\n+subcrate running"}, {"sha": "13e9aa4c1af205d6d786efd090808ccf57f98d82", "filename": "test-cargo-miri/subcrate/Cargo.toml", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/c99fb102b8db55c09400c46d097d8fbb9dcde580/test-cargo-miri%2Fsubcrate%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/c99fb102b8db55c09400c46d097d8fbb9dcde580/test-cargo-miri%2Fsubcrate%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/test-cargo-miri%2Fsubcrate%2FCargo.toml?ref=c99fb102b8db55c09400c46d097d8fbb9dcde580", "patch": "@@ -0,0 +1,9 @@\n+[package]\n+name = \"subcrate\"\n+version = \"0.1.0\"\n+authors = [\"Miri Team\"]\n+edition = \"2018\"\n+\n+[[bin]]\n+name = \"subcrate\"\n+path = \"main.rs\""}, {"sha": "db8ea7eb185579b8d1b663a4452415527f953072", "filename": "test-cargo-miri/subcrate/main.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/c99fb102b8db55c09400c46d097d8fbb9dcde580/test-cargo-miri%2Fsubcrate%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c99fb102b8db55c09400c46d097d8fbb9dcde580/test-cargo-miri%2Fsubcrate%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/test-cargo-miri%2Fsubcrate%2Fmain.rs?ref=c99fb102b8db55c09400c46d097d8fbb9dcde580", "patch": "@@ -0,0 +1,11 @@\n+use std::env;\n+use std::path::PathBuf;\n+\n+fn main() {\n+    println!(\"subcrate running\");\n+\n+    let env_dir = env::current_dir().unwrap();\n+    let crate_dir = PathBuf::from(env::var_os(\"CARGO_MANIFEST_DIR\").unwrap());\n+    // CWD should be workspace root, i.e., one level up from crate root.\n+    assert_eq!(env_dir, crate_dir.parent().unwrap());\n+}"}]}