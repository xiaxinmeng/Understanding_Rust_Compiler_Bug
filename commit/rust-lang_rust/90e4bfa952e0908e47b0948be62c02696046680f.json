{"sha": "90e4bfa952e0908e47b0948be62c02696046680f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjkwZTRiZmE5NTJlMDkwOGU0N2IwOTQ4YmU2MmMwMjY5NjA0NjY4MGY=", "commit": {"author": {"name": "Tyler Mandry", "email": "tmandry@gmail.com", "date": "2020-09-01T02:18:28Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-09-01T02:18:28Z"}, "message": "Rollup merge of #76166 - matklad:privatereader, r=petrochenkov\n\nMake `StringReader` private\n\nr? @ghost\n\ncloses #75619", "tree": {"sha": "8de1fbeb07f11e2683c9c7179ade19bc96f81c47", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8de1fbeb07f11e2683c9c7179ade19bc96f81c47"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/90e4bfa952e0908e47b0948be62c02696046680f", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfTa90CRBK7hj4Ov3rIwAAdHIIAAgjselelqOU+flj1exZ5PvG\nskcAGOaYVOVZKabqFRwJNF3ZxrdIFLInaOggmsME4DHUdlV9ltNJQnvCkEJ6KagH\nNCaK+FQeKu2Q8DmzucupJk2h28t6MHskdG+p0IQ8YFeHytTU6V8m9a0Thd5Hb9Bg\nsxIL7YXDj1Ml5OOmR7RaZulRbhiDWhMxIgBOL7tQXFtUlAF74G2AKWRN9efYLVSv\ntXLMP9/A1o9ZvD2D2nMD6cP4Pl67PrFo7e2m8LrYkbKbk4FsW9C7rJTE6rzBOmwy\nAwPk7LsiSmlMrdd2O3Tir/R4DISZbybrotJ2waqUc/rewQIvtweXSjp8TWAYb6Y=\n=JFVH\n-----END PGP SIGNATURE-----\n", "payload": "tree 8de1fbeb07f11e2683c9c7179ade19bc96f81c47\nparent e7b4cde330ba95f4b7c369653c98c093453d5ef9\nparent 30ce15f1fa763904835c5b3df155964668937683\nauthor Tyler Mandry <tmandry@gmail.com> 1598926708 -0700\ncommitter GitHub <noreply@github.com> 1598926708 -0700\n\nRollup merge of #76166 - matklad:privatereader, r=petrochenkov\n\nMake `StringReader` private\n\nr? @ghost\n\ncloses #75619\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/90e4bfa952e0908e47b0948be62c02696046680f", "html_url": "https://github.com/rust-lang/rust/commit/90e4bfa952e0908e47b0948be62c02696046680f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/90e4bfa952e0908e47b0948be62c02696046680f/comments", "author": {"login": "tmandry", "id": 2280544, "node_id": "MDQ6VXNlcjIyODA1NDQ=", "avatar_url": "https://avatars.githubusercontent.com/u/2280544?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmandry", "html_url": "https://github.com/tmandry", "followers_url": "https://api.github.com/users/tmandry/followers", "following_url": "https://api.github.com/users/tmandry/following{/other_user}", "gists_url": "https://api.github.com/users/tmandry/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmandry/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmandry/subscriptions", "organizations_url": "https://api.github.com/users/tmandry/orgs", "repos_url": "https://api.github.com/users/tmandry/repos", "events_url": "https://api.github.com/users/tmandry/events{/privacy}", "received_events_url": "https://api.github.com/users/tmandry/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e7b4cde330ba95f4b7c369653c98c093453d5ef9", "url": "https://api.github.com/repos/rust-lang/rust/commits/e7b4cde330ba95f4b7c369653c98c093453d5ef9", "html_url": "https://github.com/rust-lang/rust/commit/e7b4cde330ba95f4b7c369653c98c093453d5ef9"}, {"sha": "30ce15f1fa763904835c5b3df155964668937683", "url": "https://api.github.com/repos/rust-lang/rust/commits/30ce15f1fa763904835c5b3df155964668937683", "html_url": "https://github.com/rust-lang/rust/commit/30ce15f1fa763904835c5b3df155964668937683"}], "stats": {"total": 81, "additions": 35, "deletions": 46}, "files": [{"sha": "1131f00cb425e0250118cfd18cbcf59573c5ba20", "filename": "compiler/rustc_parse/src/lexer/mod.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/90e4bfa952e0908e47b0948be62c02696046680f/compiler%2Frustc_parse%2Fsrc%2Flexer%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/90e4bfa952e0908e47b0948be62c02696046680f/compiler%2Frustc_parse%2Fsrc%2Flexer%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse%2Fsrc%2Flexer%2Fmod.rs?ref=90e4bfa952e0908e47b0948be62c02696046680f", "patch": "@@ -27,7 +27,7 @@ pub struct UnmatchedBrace {\n     pub candidate_span: Option<Span>,\n }\n \n-pub struct StringReader<'a> {\n+crate struct StringReader<'a> {\n     sess: &'a ParseSess,\n     /// Initial position, read-only.\n     start_pos: BytePos,\n@@ -41,7 +41,7 @@ pub struct StringReader<'a> {\n }\n \n impl<'a> StringReader<'a> {\n-    pub fn new(\n+    crate fn new(\n         sess: &'a ParseSess,\n         source_file: Lrc<rustc_span::SourceFile>,\n         override_span: Option<Span>,\n@@ -66,7 +66,7 @@ impl<'a> StringReader<'a> {\n     }\n \n     /// Returns the next token, including trivia like whitespace or comments.\n-    pub fn next_token(&mut self) -> Token {\n+    fn next_token(&mut self) -> Token {\n         let start_src_index = self.src_index(self.pos);\n         let text: &str = &self.src[start_src_index..self.end_src_index];\n "}, {"sha": "beb1f13ca6f75667a1e66ff4c0791331a354f4f2", "filename": "src/librustdoc/passes/check_code_block_syntax.rs", "status": "modified", "additions": 32, "deletions": 43, "changes": 75, "blob_url": "https://github.com/rust-lang/rust/blob/90e4bfa952e0908e47b0948be62c02696046680f/src%2Flibrustdoc%2Fpasses%2Fcheck_code_block_syntax.rs", "raw_url": "https://github.com/rust-lang/rust/raw/90e4bfa952e0908e47b0948be62c02696046680f/src%2Flibrustdoc%2Fpasses%2Fcheck_code_block_syntax.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fcheck_code_block_syntax.rs?ref=90e4bfa952e0908e47b0948be62c02696046680f", "patch": "@@ -1,7 +1,6 @@\n-use rustc_ast::token;\n use rustc_data_structures::sync::{Lock, Lrc};\n use rustc_errors::{emitter::Emitter, Applicability, Diagnostic, Handler};\n-use rustc_parse::lexer::StringReader as Lexer;\n+use rustc_parse::parse_stream_from_source_str;\n use rustc_session::parse::ParseSess;\n use rustc_span::source_map::{FilePathMapping, SourceMap};\n use rustc_span::{FileName, InnerSpan};\n@@ -28,49 +27,34 @@ struct SyntaxChecker<'a, 'tcx> {\n \n impl<'a, 'tcx> SyntaxChecker<'a, 'tcx> {\n     fn check_rust_syntax(&self, item: &clean::Item, dox: &str, code_block: RustCodeBlock) {\n-        let buffered_messages = Lrc::new(Lock::new(vec![]));\n-\n-        let emitter = BufferEmitter { messages: Lrc::clone(&buffered_messages) };\n+        let buffer = Lrc::new(Lock::new(Buffer::default()));\n+        let emitter = BufferEmitter { buffer: Lrc::clone(&buffer) };\n \n         let sm = Lrc::new(SourceMap::new(FilePathMapping::empty()));\n         let handler = Handler::with_emitter(false, None, Box::new(emitter));\n+        let source = dox[code_block.code].to_owned();\n         let sess = ParseSess::with_span_handler(handler, sm);\n-        let source_file = sess.source_map().new_source_file(\n-            FileName::Custom(String::from(\"doctest\")),\n-            dox[code_block.code].to_owned(),\n-        );\n-\n-        let validation_status = rustc_driver::catch_fatal_errors(|| {\n-            let mut has_syntax_errors = false;\n-            let mut only_whitespace = true;\n-            // even if there is a syntax error, we need to run the lexer over the whole file\n-            let mut lexer = Lexer::new(&sess, source_file, None);\n-            loop {\n-                match lexer.next_token().kind {\n-                    token::Eof => break,\n-                    token::Whitespace => (),\n-                    token::Unknown(..) => has_syntax_errors = true,\n-                    _ => only_whitespace = false,\n-                }\n-            }\n \n-            if has_syntax_errors {\n-                Some(CodeBlockInvalid::SyntaxError)\n-            } else if only_whitespace {\n-                Some(CodeBlockInvalid::Empty)\n-            } else {\n-                None\n-            }\n+        let is_empty = rustc_driver::catch_fatal_errors(|| {\n+            parse_stream_from_source_str(\n+                FileName::Custom(String::from(\"doctest\")),\n+                source,\n+                &sess,\n+                None,\n+            )\n+            .is_empty()\n         })\n-        .unwrap_or(Some(CodeBlockInvalid::SyntaxError));\n+        .unwrap_or(false);\n+        let buffer = buffer.borrow();\n \n-        if let Some(code_block_invalid) = validation_status {\n+        if buffer.has_errors || is_empty {\n             let mut diag = if let Some(sp) =\n                 super::source_span_for_markdown_range(self.cx, &dox, &code_block.range, &item.attrs)\n             {\n-                let warning_message = match code_block_invalid {\n-                    CodeBlockInvalid::SyntaxError => \"could not parse code block as Rust code\",\n-                    CodeBlockInvalid::Empty => \"Rust code block is empty\",\n+                let warning_message = if buffer.has_errors {\n+                    \"could not parse code block as Rust code\"\n+                } else {\n+                    \"Rust code block is empty\"\n                 };\n \n                 let mut diag = self.cx.sess().struct_span_warn(sp, warning_message);\n@@ -102,7 +86,7 @@ impl<'a, 'tcx> SyntaxChecker<'a, 'tcx> {\n             };\n \n             // FIXME(#67563): Provide more context for these errors by displaying the spans inline.\n-            for message in buffered_messages.borrow().iter() {\n+            for message in buffer.messages.iter() {\n                 diag.note(&message);\n             }\n \n@@ -125,21 +109,26 @@ impl<'a, 'tcx> DocFolder for SyntaxChecker<'a, 'tcx> {\n     }\n }\n \n+#[derive(Default)]\n+struct Buffer {\n+    messages: Vec<String>,\n+    has_errors: bool,\n+}\n+\n struct BufferEmitter {\n-    messages: Lrc<Lock<Vec<String>>>,\n+    buffer: Lrc<Lock<Buffer>>,\n }\n \n impl Emitter for BufferEmitter {\n     fn emit_diagnostic(&mut self, diag: &Diagnostic) {\n-        self.messages.borrow_mut().push(format!(\"error from rustc: {}\", diag.message[0].0));\n+        let mut buffer = self.buffer.borrow_mut();\n+        buffer.messages.push(format!(\"error from rustc: {}\", diag.message[0].0));\n+        if diag.is_error() {\n+            buffer.has_errors = true;\n+        }\n     }\n \n     fn source_map(&self) -> Option<&Lrc<SourceMap>> {\n         None\n     }\n }\n-\n-enum CodeBlockInvalid {\n-    SyntaxError,\n-    Empty,\n-}"}]}