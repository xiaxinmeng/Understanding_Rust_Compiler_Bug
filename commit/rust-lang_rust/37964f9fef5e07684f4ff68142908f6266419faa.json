{"sha": "37964f9fef5e07684f4ff68142908f6266419faa", "node_id": "MDY6Q29tbWl0NzI0NzEyOjM3OTY0ZjlmZWY1ZTA3Njg0ZjRmZjY4MTQyOTA4ZjYyNjY0MTlmYWE=", "commit": {"author": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2021-03-17T17:59:54Z"}, "committer": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2021-03-17T18:12:28Z"}, "message": "Inject highlight into block doc comments", "tree": {"sha": "ae3bcf85fb3a3d215f0d75a5cc064fd628c61457", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ae3bcf85fb3a3d215f0d75a5cc064fd628c61457"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/37964f9fef5e07684f4ff68142908f6266419faa", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/37964f9fef5e07684f4ff68142908f6266419faa", "html_url": "https://github.com/rust-lang/rust/commit/37964f9fef5e07684f4ff68142908f6266419faa", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/37964f9fef5e07684f4ff68142908f6266419faa/comments", "author": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "edf11480ceae1ef77d7084604011c0ef6f692c72", "url": "https://api.github.com/repos/rust-lang/rust/commits/edf11480ceae1ef77d7084604011c0ef6f692c72", "html_url": "https://github.com/rust-lang/rust/commit/edf11480ceae1ef77d7084604011c0ef6f692c72"}], "stats": {"total": 100, "additions": 72, "deletions": 28}, "files": [{"sha": "7a4f2645fa256691001e7fc5baa2fbdc171b080a", "filename": "crates/ide/src/syntax_highlighting/inject.rs", "status": "modified", "additions": 37, "deletions": 25, "changes": 62, "blob_url": "https://github.com/rust-lang/rust/blob/37964f9fef5e07684f4ff68142908f6266419faa/crates%2Fide%2Fsrc%2Fsyntax_highlighting%2Finject.rs", "raw_url": "https://github.com/rust-lang/rust/raw/37964f9fef5e07684f4ff68142908f6266419faa/crates%2Fide%2Fsrc%2Fsyntax_highlighting%2Finject.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fsyntax_highlighting%2Finject.rs?ref=37964f9fef5e07684f4ff68142908f6266419faa", "patch": "@@ -1,5 +1,7 @@\n //! \"Recursive\" Syntax highlighting for code in doctests and fixtures.\n \n+use std::mem;\n+\n use either::Either;\n use hir::{HasAttrs, Semantics};\n use ide_db::call_info::ActiveParameter;\n@@ -186,34 +188,44 @@ pub(super) fn doc_comment(hl: &mut Highlights, sema: &Semantics<RootDatabase>, n\n             }\n         };\n \n-        match line.find(RUSTDOC_FENCE) {\n-            Some(idx) => {\n-                is_codeblock = !is_codeblock;\n-                // Check whether code is rust by inspecting fence guards\n-                let guards = &line[idx + RUSTDOC_FENCE.len()..];\n-                let is_rust =\n-                    guards.split(',').all(|sub| RUSTDOC_FENCE_TOKENS.contains(&sub.trim()));\n-                is_doctest = is_codeblock && is_rust;\n-                continue;\n+        let mut pos = TextSize::from(prefix.len() as u32);\n+        let mut range_start = range.start();\n+        for line in line.split('\\n') {\n+            let line_len = TextSize::from(line.len() as u32);\n+            let prev_range_start = {\n+                let next_range_start = range_start + line_len + TextSize::from(1);\n+                mem::replace(&mut range_start, next_range_start)\n+            };\n+            // only first line has the prefix so take it away for future iterations\n+            let mut pos = mem::take(&mut pos);\n+\n+            match line.find(RUSTDOC_FENCE) {\n+                Some(idx) => {\n+                    is_codeblock = !is_codeblock;\n+                    // Check whether code is rust by inspecting fence guards\n+                    let guards = &line[idx + RUSTDOC_FENCE.len()..];\n+                    let is_rust =\n+                        guards.split(',').all(|sub| RUSTDOC_FENCE_TOKENS.contains(&sub.trim()));\n+                    is_doctest = is_codeblock && is_rust;\n+                    continue;\n+                }\n+                None if !is_doctest => continue,\n+                None => (),\n             }\n-            None if !is_doctest => continue,\n-            None => (),\n-        }\n-\n-        let mut pos = TextSize::of(prefix);\n-        // whitespace after comment is ignored\n-        if let Some(ws) = line[pos.into()..].chars().next().filter(|c| c.is_whitespace()) {\n-            pos += TextSize::of(ws);\n-        }\n-        // lines marked with `#` should be ignored in output, we skip the `#` char\n-        if let Some(ws) = line[pos.into()..].chars().next().filter(|&c| c == '#') {\n-            pos += TextSize::of(ws);\n-        }\n \n-        new_comments.push(TextRange::at(range.start(), pos));\n+            // whitespace after comment is ignored\n+            if let Some(ws) = line[pos.into()..].chars().next().filter(|c| c.is_whitespace()) {\n+                pos += TextSize::of(ws);\n+            }\n+            // lines marked with `#` should be ignored in output, we skip the `#` char\n+            if line[pos.into()..].starts_with('#') {\n+                pos += TextSize::of('#');\n+            }\n \n-        inj.add(&line[pos.into()..], TextRange::new(range.start() + pos, range.end()));\n-        inj.add_unmapped(\"\\n\");\n+            new_comments.push(TextRange::at(prev_range_start, pos));\n+            inj.add(&line[pos.into()..], TextRange::new(pos, line_len) + prev_range_start);\n+            inj.add_unmapped(\"\\n\");\n+        }\n     }\n     inj.add_unmapped(\"\\n}\");\n "}, {"sha": "d792a23cfc2f03e6bdd4f27b7fd15ddd8de8a60e", "filename": "crates/ide/src/syntax_highlighting/test_data/highlight_doctest.html", "status": "modified", "additions": 18, "deletions": 2, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/37964f9fef5e07684f4ff68142908f6266419faa/crates%2Fide%2Fsrc%2Fsyntax_highlighting%2Ftest_data%2Fhighlight_doctest.html", "raw_url": "https://github.com/rust-lang/rust/raw/37964f9fef5e07684f4ff68142908f6266419faa/crates%2Fide%2Fsrc%2Fsyntax_highlighting%2Ftest_data%2Fhighlight_doctest.html", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fsyntax_highlighting%2Ftest_data%2Fhighlight_doctest.html?ref=37964f9fef5e07684f4ff68142908f6266419faa", "patch": "@@ -81,7 +81,7 @@\n     <span class=\"comment documentation\">/// </span><span class=\"comment injected\">       comment */</span>\n     <span class=\"comment documentation\">///</span>\n     <span class=\"comment documentation\">/// </span><span class=\"keyword injected\">let</span><span class=\"none injected\"> </span><span class=\"variable declaration injected\">multi_line_string</span><span class=\"none injected\"> </span><span class=\"operator injected\">=</span><span class=\"none injected\"> </span><span class=\"string_literal injected\">\"Foo</span>\n-    <span class=\"comment documentation\">/// </span><span class=\"string_literal injected\">  bar</span>\n+    <span class=\"comment documentation\">/// </span><span class=\"string_literal injected\">  bar</span><span class=\"escape_sequence injected\">\\n</span>\n     <span class=\"comment documentation\">/// </span><span class=\"string_literal injected\">         \"</span><span class=\"semicolon injected\">;</span>\n     <span class=\"comment documentation\">///</span>\n     <span class=\"comment documentation\">/// ```</span>\n@@ -121,4 +121,20 @@\n <span class=\"attribute attribute\">#</span><span class=\"attribute attribute\">[</span><span class=\"function attribute\">cfg_attr</span><span class=\"parenthesis attribute\">(</span><span class=\"attribute attribute\">not</span><span class=\"parenthesis attribute\">(</span><span class=\"attribute attribute\">feature </span><span class=\"operator attribute\">=</span><span class=\"attribute attribute\"> </span><span class=\"string_literal attribute\">\"alloc\"</span><span class=\"parenthesis attribute\">)</span><span class=\"comma attribute\">,</span><span class=\"attribute attribute\"> doc </span><span class=\"operator attribute\">=</span><span class=\"attribute attribute\"> </span><span class=\"string_literal attribute\">\"```ignore\"</span><span class=\"parenthesis attribute\">)</span><span class=\"attribute attribute\">]</span>\n <span class=\"comment documentation\">/// </span><span class=\"keyword injected\">let</span><span class=\"none injected\"> </span><span class=\"punctuation injected\">_</span><span class=\"none injected\"> </span><span class=\"operator injected\">=</span><span class=\"none injected\"> </span><span class=\"function injected\">example</span><span class=\"parenthesis injected\">(</span><span class=\"operator injected\">&</span><span class=\"none injected\">alloc::</span><span class=\"macro injected\">vec!</span><span class=\"bracket injected\">[</span><span class=\"numeric_literal injected\">1</span><span class=\"comma injected\">,</span><span class=\"none injected\"> </span><span class=\"numeric_literal injected\">2</span><span class=\"comma injected\">,</span><span class=\"none injected\"> </span><span class=\"numeric_literal injected\">3</span><span class=\"bracket injected\">]</span><span class=\"parenthesis injected\">)</span><span class=\"semicolon injected\">;</span>\n <span class=\"comment documentation\">/// ```</span>\n-<span class=\"keyword\">pub</span> <span class=\"keyword\">fn</span> <span class=\"function declaration\">mix_and_match</span><span class=\"parenthesis\">(</span><span class=\"parenthesis\">)</span> <span class=\"brace\">{</span><span class=\"brace\">}</span></code></pre>\n\\ No newline at end of file\n+<span class=\"keyword\">pub</span> <span class=\"keyword\">fn</span> <span class=\"function declaration\">mix_and_match</span><span class=\"parenthesis\">(</span><span class=\"parenthesis\">)</span> <span class=\"brace\">{</span><span class=\"brace\">}</span>\n+\n+<span class=\"comment documentation\">/**\n+It is beyond me why you'd use these when you got ///\n+```rust\n+</span><span class=\"keyword injected\">let</span><span class=\"none injected\"> </span><span class=\"punctuation injected\">_</span><span class=\"none injected\"> </span><span class=\"operator injected\">=</span><span class=\"none injected\"> </span><span class=\"function injected\">example</span><span class=\"parenthesis injected\">(</span><span class=\"operator injected\">&</span><span class=\"bracket injected\">[</span><span class=\"numeric_literal injected\">1</span><span class=\"comma injected\">,</span><span class=\"none injected\"> </span><span class=\"numeric_literal injected\">2</span><span class=\"comma injected\">,</span><span class=\"none injected\"> </span><span class=\"numeric_literal injected\">3</span><span class=\"bracket injected\">]</span><span class=\"parenthesis injected\">)</span><span class=\"semicolon injected\">;</span><span class=\"comment documentation\">\n+```\n+ */</span>\n+<span class=\"keyword\">pub</span> <span class=\"keyword\">fn</span> <span class=\"function declaration\">block_comments</span><span class=\"parenthesis\">(</span><span class=\"parenthesis\">)</span> <span class=\"brace\">{</span><span class=\"brace\">}</span>\n+\n+<span class=\"comment documentation\">/**\n+    Really, I don't get it\n+    ```rust\n+</span><span class=\"comment documentation\"> </span><span class=\"none injected\">   </span><span class=\"keyword injected\">let</span><span class=\"none injected\"> </span><span class=\"punctuation injected\">_</span><span class=\"none injected\"> </span><span class=\"operator injected\">=</span><span class=\"none injected\"> </span><span class=\"function injected\">example</span><span class=\"parenthesis injected\">(</span><span class=\"operator injected\">&</span><span class=\"bracket injected\">[</span><span class=\"numeric_literal injected\">1</span><span class=\"comma injected\">,</span><span class=\"none injected\"> </span><span class=\"numeric_literal injected\">2</span><span class=\"comma injected\">,</span><span class=\"none injected\"> </span><span class=\"numeric_literal injected\">3</span><span class=\"bracket injected\">]</span><span class=\"parenthesis injected\">)</span><span class=\"semicolon injected\">;</span><span class=\"comment documentation\">\n+    ```\n+*/</span>\n+<span class=\"keyword\">pub</span> <span class=\"keyword\">fn</span> <span class=\"function declaration\">block_comments2</span><span class=\"parenthesis\">(</span><span class=\"parenthesis\">)</span> <span class=\"brace\">{</span><span class=\"brace\">}</span></code></pre>\n\\ No newline at end of file"}, {"sha": "cf0b86ad00850bc0b0b3e5341c01837d32d8892a", "filename": "crates/ide/src/syntax_highlighting/tests.rs", "status": "modified", "additions": 17, "deletions": 1, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/37964f9fef5e07684f4ff68142908f6266419faa/crates%2Fide%2Fsrc%2Fsyntax_highlighting%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/37964f9fef5e07684f4ff68142908f6266419faa/crates%2Fide%2Fsrc%2Fsyntax_highlighting%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fsyntax_highlighting%2Ftests.rs?ref=37964f9fef5e07684f4ff68142908f6266419faa", "patch": "@@ -516,7 +516,7 @@ impl Foo {\n     ///        comment */\n     ///\n     /// let multi_line_string = \"Foo\n-    ///   bar\n+    ///   bar\\n\n     ///          \";\n     ///\n     /// ```\n@@ -557,6 +557,22 @@ macro_rules! noop {\n /// let _ = example(&alloc::vec![1, 2, 3]);\n /// ```\n pub fn mix_and_match() {}\n+\n+/**\n+It is beyond me why you'd use these when you got ///\n+```rust\n+let _ = example(&[1, 2, 3]);\n+```\n+ */\n+pub fn block_comments() {}\n+\n+/**\n+    Really, I don't get it\n+    ```rust\n+    let _ = example(&[1, 2, 3]);\n+    ```\n+*/\n+pub fn block_comments2() {}\n \"#\n         .trim(),\n         expect_file![\"./test_data/highlight_doctest.html\"],"}]}