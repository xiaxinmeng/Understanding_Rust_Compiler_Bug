{"sha": "d6de60fb322828ec3b828278f05598f2db282142", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQ2ZGU2MGZiMzIyODI4ZWMzYjgyODI3OGYwNTU5OGYyZGIyODIxNDI=", "commit": {"author": {"name": "Felix S. Klock II", "email": "pnkfelix@pnkfx.org", "date": "2021-03-15T21:37:06Z"}, "committer": {"name": "Felix S. Klock II", "email": "pnkfelix@pnkfx.org", "date": "2021-03-16T03:19:35Z"}, "message": "Make bootstrap be more informative when one does `x.py test` on a beta checkout without other mods.\n\nTo be clear, by default running `x.py test` on a checkout of the beta branch\ncurrently fails, and with this change will continue to fail, because `x.py\ntests` runs `x.py test src/tools/tidy` which tries to run `rustfmt` and that\nwill fail because the `rustfmt` binary is pinned to the current nighlty and we\ndo not attempt to distribute one for the beta builds.\n\nThis change gives a better error message than the current message, which is just\n\"./x.py fmt is not supported on this channel\" without providing any hint about\nwhat one might do about that problem.\n\n(update: placated tidy.)", "tree": {"sha": "950f091b717e5f03c008d1c4a95433662949d251", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/950f091b717e5f03c008d1c4a95433662949d251"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d6de60fb322828ec3b828278f05598f2db282142", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d6de60fb322828ec3b828278f05598f2db282142", "html_url": "https://github.com/rust-lang/rust/commit/d6de60fb322828ec3b828278f05598f2db282142", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d6de60fb322828ec3b828278f05598f2db282142/comments", "author": {"login": "pnkfelix", "id": 173127, "node_id": "MDQ6VXNlcjE3MzEyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pnkfelix", "html_url": "https://github.com/pnkfelix", "followers_url": "https://api.github.com/users/pnkfelix/followers", "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}", "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}", "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions", "organizations_url": "https://api.github.com/users/pnkfelix/orgs", "repos_url": "https://api.github.com/users/pnkfelix/repos", "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}", "received_events_url": "https://api.github.com/users/pnkfelix/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pnkfelix", "id": 173127, "node_id": "MDQ6VXNlcjE3MzEyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pnkfelix", "html_url": "https://github.com/pnkfelix", "followers_url": "https://api.github.com/users/pnkfelix/followers", "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}", "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}", "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions", "organizations_url": "https://api.github.com/users/pnkfelix/orgs", "repos_url": "https://api.github.com/users/pnkfelix/repos", "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}", "received_events_url": "https://api.github.com/users/pnkfelix/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "107896c32d5dda4db508968ff34997a39d286966", "url": "https://api.github.com/repos/rust-lang/rust/commits/107896c32d5dda4db508968ff34997a39d286966", "html_url": "https://github.com/rust-lang/rust/commit/107896c32d5dda4db508968ff34997a39d286966"}], "stats": {"total": 13, "additions": 13, "deletions": 0}, "files": [{"sha": "86d940cd733da56608338d5cdbb219fff4adab23", "filename": "src/bootstrap/test.rs", "status": "modified", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/d6de60fb322828ec3b828278f05598f2db282142/src%2Fbootstrap%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d6de60fb322828ec3b828278f05598f2db282142/src%2Fbootstrap%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Ftest.rs?ref=d6de60fb322828ec3b828278f05598f2db282142", "patch": "@@ -791,6 +791,19 @@ impl Step for Tidy {\n \n         if builder.config.channel == \"dev\" || builder.config.channel == \"nightly\" {\n             builder.info(\"fmt check\");\n+            if builder.config.initial_rustfmt.is_none() {\n+                let inferred_rustfmt_dir = builder.config.initial_rustc.parent().unwrap();\n+                eprintln!(\n+                    \"\\\n+error: no `rustfmt` binary found in {PATH}\n+info: `rust.channel` is currently set to \\\"{CHAN}\\\"\n+help: if you are testing a beta branch, set `rust.channel` to \\\"beta\\\" in the `config.toml` file\n+help: to skip test's attempt to check tidiness, pass `--exclude src/tools/tidy` to `x.py test`\",\n+                    PATH = inferred_rustfmt_dir.display(),\n+                    CHAN = builder.config.channel,\n+                );\n+                std::process::exit(1);\n+            }\n             crate::format::format(&builder.build, !builder.config.cmd.bless());\n         }\n     }"}]}