{"sha": "766c4a556e95b4c47f811932a710e326c263634c", "node_id": "MDY6Q29tbWl0NzI0NzEyOjc2NmM0YTU1NmU5NWI0YzQ3ZjgxMTkzMmE3MTBlMzI2YzI2MzYzNGM=", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2019-09-14T10:57:39Z"}, "committer": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2019-09-14T10:57:39Z"}, "message": "build-manifest: when Miri tests are not passing, do not add Miri component", "tree": {"sha": "029934c9b85beeadd3d196a110dafd8b1ff17f77", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/029934c9b85beeadd3d196a110dafd8b1ff17f77"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/766c4a556e95b4c47f811932a710e326c263634c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/766c4a556e95b4c47f811932a710e326c263634c", "html_url": "https://github.com/rust-lang/rust/commit/766c4a556e95b4c47f811932a710e326c263634c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/766c4a556e95b4c47f811932a710e326c263634c/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ee83402918b25172665ba5cc09bcf8adc5f55380", "url": "https://api.github.com/repos/rust-lang/rust/commits/ee83402918b25172665ba5cc09bcf8adc5f55380", "html_url": "https://github.com/rust-lang/rust/commit/ee83402918b25172665ba5cc09bcf8adc5f55380"}], "stats": {"total": 58, "additions": 53, "deletions": 5}, "files": [{"sha": "9ec76d6c3cf8b37e666abd6e856fc7ee45e271a0", "filename": "Cargo.lock", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/766c4a556e95b4c47f811932a710e326c263634c/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/766c4a556e95b4c47f811932a710e326c263634c/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=766c4a556e95b4c47f811932a710e326c263634c", "patch": "@@ -201,7 +201,9 @@ dependencies = [\n name = \"build-manifest\"\n version = \"0.1.0\"\n dependencies = [\n+ \"reqwest\",\n  \"serde\",\n+ \"serde_json\",\n  \"toml\",\n ]\n "}, {"sha": "63ae445f99b6003eb346dfebff7e9c55b6c9eaab", "filename": "src/tools/build-manifest/Cargo.toml", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/766c4a556e95b4c47f811932a710e326c263634c/src%2Ftools%2Fbuild-manifest%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/766c4a556e95b4c47f811932a710e326c263634c/src%2Ftools%2Fbuild-manifest%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fbuild-manifest%2FCargo.toml?ref=766c4a556e95b4c47f811932a710e326c263634c", "patch": "@@ -7,3 +7,5 @@ edition = \"2018\"\n [dependencies]\n toml = \"0.5\"\n serde = { version = \"1.0\", features = [\"derive\"] }\n+serde_json = \"1.0\"\n+reqwest = \"0.9\""}, {"sha": "c2d642bb136be9c7a7b9392707fcc5177f7c52c2", "filename": "src/tools/build-manifest/src/main.rs", "status": "modified", "additions": 49, "deletions": 5, "changes": 54, "blob_url": "https://github.com/rust-lang/rust/blob/766c4a556e95b4c47f811932a710e326c263634c/src%2Ftools%2Fbuild-manifest%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/766c4a556e95b4c47f811932a710e326c263634c/src%2Ftools%2Fbuild-manifest%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fbuild-manifest%2Fsrc%2Fmain.rs?ref=766c4a556e95b4c47f811932a710e326c263634c", "patch": "@@ -1,12 +1,19 @@\n+//! Build a dist manifest, hash and sign everything.\n+//! This gets called by `promote-release`\n+//! (https://github.com/rust-lang/rust-central-station/tree/master/promote-release)\n+//! via `x.py dist hash-and-sign`; the cmdline arguments are set up\n+//! by rustbuild (in `src/bootstrap/dist.rs`).\n+\n use toml;\n use serde::Serialize;\n \n use std::collections::BTreeMap;\n use std::env;\n use std::fs;\n-use std::io::{self, Read, Write};\n+use std::io::{self, Read, Write, BufRead, BufReader};\n use std::path::{PathBuf, Path};\n use std::process::{Command, Stdio};\n+use std::collections::HashMap;\n \n static HOSTS: &[&str] = &[\n     \"aarch64-unknown-linux-gnu\",\n@@ -146,6 +153,9 @@ static MINGW: &[&str] = &[\n     \"x86_64-pc-windows-gnu\",\n ];\n \n+static TOOLSTATE: &str =\n+    \"https://raw.githubusercontent.com/rust-lang-nursery/rust-toolstate/master/history/linux.tsv\";\n+\n #[derive(Serialize)]\n #[serde(rename_all = \"kebab-case\")]\n struct Manifest {\n@@ -270,6 +280,7 @@ fn main() {\n     // Do not ask for a passphrase while manually testing\n     let mut passphrase = String::new();\n     if should_sign {\n+        // `x.py` passes the passphrase via stdin.\n         t!(io::stdin().read_to_string(&mut passphrase));\n     }\n \n@@ -353,6 +364,7 @@ impl Builder {\n         self.lldb_git_commit_hash = self.git_commit_hash(\"lldb\", \"x86_64-unknown-linux-gnu\");\n         self.miri_git_commit_hash = self.git_commit_hash(\"miri\", \"x86_64-unknown-linux-gnu\");\n \n+        self.check_toolstate();\n         self.digest_and_sign();\n         let manifest = self.build_manifest();\n         self.write_channel_files(&self.rust_release, &manifest);\n@@ -362,6 +374,37 @@ impl Builder {\n         }\n     }\n \n+    /// If a tool does not pass its tests, don't ship it.\n+    /// Right now, we do this only for Miri.\n+    fn check_toolstate(&mut self) {\n+        // Get the toolstate for this rust revision.\n+        let rev = self.rust_git_commit_hash.as_ref().expect(\"failed to determine rust git hash\");\n+        let toolstates = reqwest::get(TOOLSTATE).expect(\"failed to get toolstates\");\n+        let toolstates = BufReader::new(toolstates);\n+        let toolstate = toolstates.lines()\n+            .find_map(|line| {\n+                let line = line.expect(\"failed to read toolstate lines\");\n+                let mut pieces = line.splitn(2, '\\t');\n+                let commit = pieces.next().expect(\"malformed toolstate line\");\n+                if commit != rev {\n+                    // Not the right commit.\n+                    return None;\n+                }\n+                // Return the 2nd piece, the JSON.\n+                Some(pieces.next().expect(\"malformed toolstate line\").to_owned())\n+            })\n+            .expect(\"failed to find toolstate for rust commit\");\n+        let toolstate: HashMap<String, String> =\n+            serde_json::from_str(&toolstate).expect(\"toolstate is malformed JSON\");\n+        // Mark some tools as missing based on toolstate.\n+        if toolstate.get(\"miri\").map(|s| &*s as &str) != Some(\"test-pass\") {\n+            println!(\"Miri tests are not passing, removing component\");\n+            self.miri_version = None;\n+            self.miri_git_commit_hash = None;\n+        }\n+    }\n+\n+    /// Hash all files, compute their signatures, and collect the hashes in `self.digests`.\n     fn digest_and_sign(&mut self) {\n         for file in t!(self.input.read_dir()).map(|e| t!(e).path()) {\n             let filename = file.file_name().unwrap().to_str().unwrap();\n@@ -532,19 +575,20 @@ impl Builder {\n             .as_ref()\n             .cloned()\n             .map(|version| (version, true))\n-            .unwrap_or_default();\n+            .unwrap_or_default(); // `is_present` defaults to `false` here.\n \n-        // miri needs to build std with xargo, which doesn't allow stable/beta:\n-        // <https://github.com/japaric/xargo/pull/204#issuecomment-374888868>\n+        // Miri is nightly-only; never ship it for other trains.\n         if pkgname == \"miri-preview\" && self.rust_release != \"nightly\" {\n-            is_present = false; // ignore it\n+            is_present = false; // Pretend the component is entirely missing.\n         }\n \n         let targets = targets.iter().map(|name| {\n             if is_present {\n+                // The component generally exists, but it might still be missing for this target.\n                 let filename = self.filename(pkgname, name);\n                 let digest = match self.digests.remove(&filename) {\n                     Some(digest) => digest,\n+                    // This component does not exist for this target -- skip it.\n                     None => return (name.to_string(), Target::unavailable()),\n                 };\n                 let xz_filename = filename.replace(\".tar.gz\", \".tar.xz\");"}]}