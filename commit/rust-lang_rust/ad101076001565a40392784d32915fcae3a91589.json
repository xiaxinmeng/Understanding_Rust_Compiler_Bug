{"sha": "ad101076001565a40392784d32915fcae3a91589", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFkMTAxMDc2MDAxNTY1YTQwMzkyNzg0ZDMyOTE1ZmNhZTNhOTE1ODk=", "commit": {"author": {"name": "Mara Bos", "email": "m-ou.se@m-ou.se", "date": "2021-07-09T14:20:32Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-07-09T14:20:32Z"}, "message": "Rollup merge of #86881 - tmiasko:lookup-line, r=nagisa\n\nInline implementation of lookup_line\n\nto avoid unnecessary conversions from `Option<usize>` to `isize` and back.", "tree": {"sha": "27d1688eeb980e32422514d4a559aea5f7eb9020", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/27d1688eeb980e32422514d4a559aea5f7eb9020"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ad101076001565a40392784d32915fcae3a91589", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJg6FsxCRBK7hj4Ov3rIwAA3nsIAAHx3Z7b0UHDMMQVD0dwgNDT\nyOfO1AfnSo/3kQjoP9WwP0WIE4cmaQYrCZjUgl6HwS3GMPH96UexiD+sq/Ba0Ge/\nMTA0NJdN+80ljBdUP7YKcQCg696/iU7zjb7mIKwr6HHfjmQn6ZbfVtgGRSSlverZ\nCBHrZ7lI61Sxwxu6HdUJqIZTP5GEXDSHbA9ePGSdhOGJ8I20DotIBpZW/g8UIbPE\n/uqfSzh3eW5A3Mhs1RpipVgItNNVEDE0Ba2GcY7s5z0JxKP7kjQrNJQutE0u+d74\nQyBXrN7tP5oiRyrBmdYoKul61PPhdzNkVpZsX+VieON3p9SVaHvEPItAmjtXNlQ=\n=ltMu\n-----END PGP SIGNATURE-----\n", "payload": "tree 27d1688eeb980e32422514d4a559aea5f7eb9020\nparent e920ef8785d472ac02c6b70117e95849273e4ea4\nparent 1719d4501351eff05299a124dc13846afa2994a0\nauthor Mara Bos <m-ou.se@m-ou.se> 1625840432 +0200\ncommitter GitHub <noreply@github.com> 1625840432 +0200\n\nRollup merge of #86881 - tmiasko:lookup-line, r=nagisa\n\nInline implementation of lookup_line\n\nto avoid unnecessary conversions from `Option<usize>` to `isize` and back.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ad101076001565a40392784d32915fcae3a91589", "html_url": "https://github.com/rust-lang/rust/commit/ad101076001565a40392784d32915fcae3a91589", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ad101076001565a40392784d32915fcae3a91589/comments", "author": {"login": "m-ou-se", "id": 783247, "node_id": "MDQ6VXNlcjc4MzI0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/783247?v=4", "gravatar_id": "", "url": "https://api.github.com/users/m-ou-se", "html_url": "https://github.com/m-ou-se", "followers_url": "https://api.github.com/users/m-ou-se/followers", "following_url": "https://api.github.com/users/m-ou-se/following{/other_user}", "gists_url": "https://api.github.com/users/m-ou-se/gists{/gist_id}", "starred_url": "https://api.github.com/users/m-ou-se/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/m-ou-se/subscriptions", "organizations_url": "https://api.github.com/users/m-ou-se/orgs", "repos_url": "https://api.github.com/users/m-ou-se/repos", "events_url": "https://api.github.com/users/m-ou-se/events{/privacy}", "received_events_url": "https://api.github.com/users/m-ou-se/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e920ef8785d472ac02c6b70117e95849273e4ea4", "url": "https://api.github.com/repos/rust-lang/rust/commits/e920ef8785d472ac02c6b70117e95849273e4ea4", "html_url": "https://github.com/rust-lang/rust/commit/e920ef8785d472ac02c6b70117e95849273e4ea4"}, {"sha": "1719d4501351eff05299a124dc13846afa2994a0", "url": "https://api.github.com/repos/rust-lang/rust/commits/1719d4501351eff05299a124dc13846afa2994a0", "html_url": "https://github.com/rust-lang/rust/commit/1719d4501351eff05299a124dc13846afa2994a0"}], "stats": {"total": 41, "additions": 16, "deletions": 25}, "files": [{"sha": "6265470e625947ea482ff789bb9df2bb55395421", "filename": "compiler/rustc_span/src/lib.rs", "status": "modified", "additions": 4, "deletions": 16, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/ad101076001565a40392784d32915fcae3a91589/compiler%2Frustc_span%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad101076001565a40392784d32915fcae3a91589/compiler%2Frustc_span%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_span%2Fsrc%2Flib.rs?ref=ad101076001565a40392784d32915fcae3a91589", "patch": "@@ -1552,13 +1552,11 @@ impl SourceFile {\n     /// number. If the source_file is empty or the position is located before the\n     /// first line, `None` is returned.\n     pub fn lookup_line(&self, pos: BytePos) -> Option<usize> {\n-        if self.lines.is_empty() {\n-            return None;\n+        match self.lines.binary_search(&pos) {\n+            Ok(idx) => Some(idx),\n+            Err(0) => None,\n+            Err(idx) => Some(idx - 1),\n         }\n-\n-        let line_index = lookup_line(&self.lines[..], pos);\n-        assert!(line_index < self.lines.len() as isize);\n-        if line_index >= 0 { Some(line_index as usize) } else { None }\n     }\n \n     pub fn line_bounds(&self, line_index: usize) -> Range<BytePos> {\n@@ -1957,16 +1955,6 @@ impl InnerSpan {\n     }\n }\n \n-// Given a slice of line start positions and a position, returns the index of\n-// the line the position is on. Returns -1 if the position is located before\n-// the first line.\n-fn lookup_line(lines: &[BytePos], pos: BytePos) -> isize {\n-    match lines.binary_search(&pos) {\n-        Ok(line) => line as isize,\n-        Err(line) => line as isize - 1,\n-    }\n-}\n-\n /// Requirements for a `StableHashingContext` to be used in this crate.\n ///\n /// This is a hack to allow using the [`HashStable_Generic`] derive macro"}, {"sha": "11edcacc0d43ba95917ffadae0dc14d44b3cfebd", "filename": "compiler/rustc_span/src/tests.rs", "status": "modified", "additions": 12, "deletions": 9, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/ad101076001565a40392784d32915fcae3a91589/compiler%2Frustc_span%2Fsrc%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad101076001565a40392784d32915fcae3a91589/compiler%2Frustc_span%2Fsrc%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_span%2Fsrc%2Ftests.rs?ref=ad101076001565a40392784d32915fcae3a91589", "patch": "@@ -2,18 +2,21 @@ use super::*;\n \n #[test]\n fn test_lookup_line() {\n-    let lines = &[BytePos(3), BytePos(17), BytePos(28)];\n+    let source = \"abcdefghijklm\\nabcdefghij\\n...\".to_owned();\n+    let sf =\n+        SourceFile::new(FileName::Anon(0), source, BytePos(3), SourceFileHashAlgorithm::Sha256);\n+    assert_eq!(sf.lines.as_slice(), &[BytePos(3), BytePos(17), BytePos(28)]);\n \n-    assert_eq!(lookup_line(lines, BytePos(0)), -1);\n-    assert_eq!(lookup_line(lines, BytePos(3)), 0);\n-    assert_eq!(lookup_line(lines, BytePos(4)), 0);\n+    assert_eq!(sf.lookup_line(BytePos(0)), None);\n+    assert_eq!(sf.lookup_line(BytePos(3)), Some(0));\n+    assert_eq!(sf.lookup_line(BytePos(4)), Some(0));\n \n-    assert_eq!(lookup_line(lines, BytePos(16)), 0);\n-    assert_eq!(lookup_line(lines, BytePos(17)), 1);\n-    assert_eq!(lookup_line(lines, BytePos(18)), 1);\n+    assert_eq!(sf.lookup_line(BytePos(16)), Some(0));\n+    assert_eq!(sf.lookup_line(BytePos(17)), Some(1));\n+    assert_eq!(sf.lookup_line(BytePos(18)), Some(1));\n \n-    assert_eq!(lookup_line(lines, BytePos(28)), 2);\n-    assert_eq!(lookup_line(lines, BytePos(29)), 2);\n+    assert_eq!(sf.lookup_line(BytePos(28)), Some(2));\n+    assert_eq!(sf.lookup_line(BytePos(29)), Some(2));\n }\n \n #[test]"}]}