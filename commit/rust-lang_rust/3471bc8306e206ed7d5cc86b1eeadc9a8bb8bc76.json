{"sha": "3471bc8306e206ed7d5cc86b1eeadc9a8bb8bc76", "node_id": "MDY6Q29tbWl0NzI0NzEyOjM0NzFiYzgzMDZlMjA2ZWQ3ZDVjYzg2YjFlZWFkYzlhOGJiOGJjNzY=", "commit": {"author": {"name": "mibac138", "email": "5672750+mibac138@users.noreply.github.com", "date": "2020-05-04T23:55:03Z"}, "committer": {"name": "mibac138", "email": "5672750+mibac138@users.noreply.github.com", "date": "2020-05-05T00:21:50Z"}, "message": "Fix unused_parens false positive when using binary operations", "tree": {"sha": "da17311f903cf0cf509ef2e7e5de9a789b2df672", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/da17311f903cf0cf509ef2e7e5de9a789b2df672"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3471bc8306e206ed7d5cc86b1eeadc9a8bb8bc76", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3471bc8306e206ed7d5cc86b1eeadc9a8bb8bc76", "html_url": "https://github.com/rust-lang/rust/commit/3471bc8306e206ed7d5cc86b1eeadc9a8bb8bc76", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3471bc8306e206ed7d5cc86b1eeadc9a8bb8bc76/comments", "author": {"login": "mibac138", "id": 5672750, "node_id": "MDQ6VXNlcjU2NzI3NTA=", "avatar_url": "https://avatars.githubusercontent.com/u/5672750?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mibac138", "html_url": "https://github.com/mibac138", "followers_url": "https://api.github.com/users/mibac138/followers", "following_url": "https://api.github.com/users/mibac138/following{/other_user}", "gists_url": "https://api.github.com/users/mibac138/gists{/gist_id}", "starred_url": "https://api.github.com/users/mibac138/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mibac138/subscriptions", "organizations_url": "https://api.github.com/users/mibac138/orgs", "repos_url": "https://api.github.com/users/mibac138/repos", "events_url": "https://api.github.com/users/mibac138/events{/privacy}", "received_events_url": "https://api.github.com/users/mibac138/received_events", "type": "User", "site_admin": false}, "committer": {"login": "mibac138", "id": 5672750, "node_id": "MDQ6VXNlcjU2NzI3NTA=", "avatar_url": "https://avatars.githubusercontent.com/u/5672750?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mibac138", "html_url": "https://github.com/mibac138", "followers_url": "https://api.github.com/users/mibac138/followers", "following_url": "https://api.github.com/users/mibac138/following{/other_user}", "gists_url": "https://api.github.com/users/mibac138/gists{/gist_id}", "starred_url": "https://api.github.com/users/mibac138/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mibac138/subscriptions", "organizations_url": "https://api.github.com/users/mibac138/orgs", "repos_url": "https://api.github.com/users/mibac138/repos", "events_url": "https://api.github.com/users/mibac138/events{/privacy}", "received_events_url": "https://api.github.com/users/mibac138/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d626e4dadc37d7027d65f087da0ad1ddb460959f", "url": "https://api.github.com/repos/rust-lang/rust/commits/d626e4dadc37d7027d65f087da0ad1ddb460959f", "html_url": "https://github.com/rust-lang/rust/commit/d626e4dadc37d7027d65f087da0ad1ddb460959f"}], "stats": {"total": 33, "additions": 29, "deletions": 4}, "files": [{"sha": "4f7a1f9c310918442c0ed0ceda306acbcb5c8c57", "filename": "src/librustc_lint/unused.rs", "status": "modified", "additions": 12, "deletions": 4, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/3471bc8306e206ed7d5cc86b1eeadc9a8bb8bc76/src%2Flibrustc_lint%2Funused.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3471bc8306e206ed7d5cc86b1eeadc9a8bb8bc76/src%2Flibrustc_lint%2Funused.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_lint%2Funused.rs?ref=3471bc8306e206ed7d5cc86b1eeadc9a8bb8bc76", "patch": "@@ -380,11 +380,19 @@ trait UnusedDelimLint {\n     );\n \n     fn is_expr_delims_necessary(inner: &ast::Expr, followed_by_block: bool) -> bool {\n-        followed_by_block\n-            && match inner.kind {\n-                ExprKind::Ret(_) | ExprKind::Break(..) => true,\n-                _ => parser::contains_exterior_struct_lit(&inner),\n+        // Prevent false-positives in cases like `fn x() -> u8 { ({ 0 } + 1) }`\n+        let lhs_needs_parens = match &inner.kind {\n+            ExprKind::Binary(_, lhs, _rhs) => {\n+                !rustc_ast::util::classify::expr_requires_semi_to_be_stmt(&*lhs)\n             }\n+            _ => false,\n+        };\n+        lhs_needs_parens\n+            || (followed_by_block\n+                && match inner.kind {\n+                    ExprKind::Ret(_) | ExprKind::Break(..) => true,\n+                    _ => parser::contains_exterior_struct_lit(&inner),\n+                })\n     }\n \n     fn emit_unused_delims_expr("}, {"sha": "619be02566f5616a42818b66e61db307962abb63", "filename": "src/test/ui/lint/issue-71290-unused-paren-binop.rs", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/3471bc8306e206ed7d5cc86b1eeadc9a8bb8bc76/src%2Ftest%2Fui%2Flint%2Fissue-71290-unused-paren-binop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3471bc8306e206ed7d5cc86b1eeadc9a8bb8bc76/src%2Ftest%2Fui%2Flint%2Fissue-71290-unused-paren-binop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Fissue-71290-unused-paren-binop.rs?ref=3471bc8306e206ed7d5cc86b1eeadc9a8bb8bc76", "patch": "@@ -0,0 +1,17 @@\n+// check-pass\n+// Make sure unused parens lint doesn't emit a false positive.\n+// See https://github.com/rust-lang/rust/issues/71290 for details.\n+\n+fn x() -> u8 {\n+    ({ 0 }) + 1\n+}\n+\n+fn y() -> u8 {\n+    ({ 0 } + 1)\n+}\n+\n+pub fn foo(a: bool, b: bool) -> u8 {\n+    (if a { 1 } else { 0 } + if b { 1 } else { 0 })\n+}\n+\n+fn main() {}"}]}