{"sha": "0fce0db96f5d7f3b42d25412d3989014551852ac", "node_id": "C_kwDOAAsO6NoAKDBmY2UwZGI5NmY1ZDdmM2I0MmQyNTQxMmQzOTg5MDE0NTUxODUyYWM", "commit": {"author": {"name": "Gary Guo", "email": "gary@garyguo.net", "date": "2022-04-28T15:22:40Z"}, "committer": {"name": "Gary Guo", "email": "gary@garyguo.net", "date": "2022-04-28T20:33:23Z"}, "message": "Add `@feat.00` symbol to symbols.o for COFF", "tree": {"sha": "42cc167583682c676b47470bc26a17312bd56209", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/42cc167583682c676b47470bc26a17312bd56209"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0fce0db96f5d7f3b42d25412d3989014551852ac", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0fce0db96f5d7f3b42d25412d3989014551852ac", "html_url": "https://github.com/rust-lang/rust/commit/0fce0db96f5d7f3b42d25412d3989014551852ac", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0fce0db96f5d7f3b42d25412d3989014551852ac/comments", "author": {"login": "nbdd0121", "id": 4065244, "node_id": "MDQ6VXNlcjQwNjUyNDQ=", "avatar_url": "https://avatars.githubusercontent.com/u/4065244?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nbdd0121", "html_url": "https://github.com/nbdd0121", "followers_url": "https://api.github.com/users/nbdd0121/followers", "following_url": "https://api.github.com/users/nbdd0121/following{/other_user}", "gists_url": "https://api.github.com/users/nbdd0121/gists{/gist_id}", "starred_url": "https://api.github.com/users/nbdd0121/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nbdd0121/subscriptions", "organizations_url": "https://api.github.com/users/nbdd0121/orgs", "repos_url": "https://api.github.com/users/nbdd0121/repos", "events_url": "https://api.github.com/users/nbdd0121/events{/privacy}", "received_events_url": "https://api.github.com/users/nbdd0121/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nbdd0121", "id": 4065244, "node_id": "MDQ6VXNlcjQwNjUyNDQ=", "avatar_url": "https://avatars.githubusercontent.com/u/4065244?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nbdd0121", "html_url": "https://github.com/nbdd0121", "followers_url": "https://api.github.com/users/nbdd0121/followers", "following_url": "https://api.github.com/users/nbdd0121/following{/other_user}", "gists_url": "https://api.github.com/users/nbdd0121/gists{/gist_id}", "starred_url": "https://api.github.com/users/nbdd0121/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nbdd0121/subscriptions", "organizations_url": "https://api.github.com/users/nbdd0121/orgs", "repos_url": "https://api.github.com/users/nbdd0121/repos", "events_url": "https://api.github.com/users/nbdd0121/events{/privacy}", "received_events_url": "https://api.github.com/users/nbdd0121/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4f9acb268704a1c7f78c8c55da0d7614eac57ade", "url": "https://api.github.com/repos/rust-lang/rust/commits/4f9acb268704a1c7f78c8c55da0d7614eac57ade", "html_url": "https://github.com/rust-lang/rust/commit/4f9acb268704a1c7f78c8c55da0d7614eac57ade"}], "stats": {"total": 35, "additions": 35, "deletions": 0}, "files": [{"sha": "886ca9681e2b28e0da728d9075381d1daa46851a", "filename": "compiler/rustc_codegen_ssa/src/back/link.rs", "status": "modified", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/0fce0db96f5d7f3b42d25412d3989014551852ac/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0fce0db96f5d7f3b42d25412d3989014551852ac/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs?ref=0fce0db96f5d7f3b42d25412d3989014551852ac", "patch": "@@ -1700,6 +1700,29 @@ fn add_linked_symbol_object(\n         // We handle the name decoration of COFF targets in `symbol_export.rs`, so disable the\n         // default mangler in `object` crate.\n         file.set_mangling(object::write::Mangling::None);\n+\n+        // Add feature flags to the object file. On MSVC this is optional but LLD will complain if\n+        // not present.\n+        let mut feature = 0;\n+\n+        if file.architecture() == object::Architecture::I386 {\n+            // Indicate that all SEH handlers are registered in .sxdata section.\n+            // We don't have generate any code, so we don't need .sxdata section but LLD still\n+            // expects us to set this bit (see #96498).\n+            // Reference: https://docs.microsoft.com/en-us/windows/win32/debug/pe-format\n+            feature |= 1;\n+        }\n+\n+        file.add_symbol(object::write::Symbol {\n+            name: \"@feat.00\".into(),\n+            value: feature,\n+            size: 0,\n+            kind: object::SymbolKind::Data,\n+            scope: object::SymbolScope::Compilation,\n+            weak: false,\n+            section: object::write::SymbolSection::Absolute,\n+            flags: object::SymbolFlags::None,\n+        });\n     }\n \n     for (sym, kind) in symbols.iter() {"}, {"sha": "eae6400aee43a5223e22c979b7998a4fdbaff7b3", "filename": "src/test/run-make/issue-96498/Makefile", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/0fce0db96f5d7f3b42d25412d3989014551852ac/src%2Ftest%2Frun-make%2Fissue-96498%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/0fce0db96f5d7f3b42d25412d3989014551852ac/src%2Ftest%2Frun-make%2Fissue-96498%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fissue-96498%2FMakefile?ref=0fce0db96f5d7f3b42d25412d3989014551852ac", "patch": "@@ -0,0 +1,8 @@\n+# only-windows\n+# needs-rust-lld\n+\n+-include ../../run-make-fulldeps/tools.mk\n+\n+# Ensure that LLD can link\n+all:\n+\t$(RUSTC) -C linker=rust-lld foo.rs"}, {"sha": "93ac3641b098ccbbbd64e868967fea51c7b81bd2", "filename": "src/test/run-make/issue-96498/foo.rs", "status": "added", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/0fce0db96f5d7f3b42d25412d3989014551852ac/src%2Ftest%2Frun-make%2Fissue-96498%2Ffoo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0fce0db96f5d7f3b42d25412d3989014551852ac/src%2Ftest%2Frun-make%2Fissue-96498%2Ffoo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fissue-96498%2Ffoo.rs?ref=0fce0db96f5d7f3b42d25412d3989014551852ac", "patch": "@@ -0,0 +1,4 @@\n+#![crate_type = \"cdylib\"]\n+\n+#[no_mangle]\n+extern \"C\" fn foo() {}"}]}