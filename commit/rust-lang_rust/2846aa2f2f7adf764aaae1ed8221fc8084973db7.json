{"sha": "2846aa2f2f7adf764aaae1ed8221fc8084973db7", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI4NDZhYTJmMmY3YWRmNzY0YWFhZTFlZDgyMjFmYzgwODQ5NzNkYjc=", "commit": {"author": {"name": "Dylan DPC", "email": "dylan.dpc@gmail.com", "date": "2020-04-24T11:14:20Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-04-24T11:14:20Z"}, "message": "Rollup merge of #71318 - RalfJung:miri-unleash-cleanup, r=oli-obk\n\nmiri-unleash tests: ensure they fire even with 'allow(const_err)'\n\nThis is easier with `static` than `const` so I switched some of them over.", "tree": {"sha": "c69c323c26375c010e451d070f2efd70f28a18f7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c69c323c26375c010e451d070f2efd70f28a18f7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2846aa2f2f7adf764aaae1ed8221fc8084973db7", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJeosoNCRBK7hj4Ov3rIwAAdHIIABPddcQ2rw3Ux5QVEXeDOPWR\nHJ97ckXPufFDdJK0OQApwMXXicym0kws5yVGXhwlQtfmb/i66e63lQxkLn3Jh/vA\nM3xK6f//Tfj+hpLHe1ARAPm07wFhax3XfWcKfa2AHb1J5fp1K/e7ocQtlTBaBZPS\n6MEgNPHZE2CvU2TyUrrf8h3+JrjxWL0okhybJ94Ce1tQSvvt343FCnRE5KmiYDY1\nBPj5Uo52KRty76RQCjs7Nlf9vBvMeRDCh4yrwOWOyyWAyFkk+RyvwNmEgCeRW3q+\ntwwNyfw1KiMWfs142EYGf4bCu0No72vh17TcM+PE6ct9gns3BokJZFto/2uc5hI=\n=dr0X\n-----END PGP SIGNATURE-----\n", "payload": "tree c69c323c26375c010e451d070f2efd70f28a18f7\nparent 7d8a3ad128381bbabb18f975130cfd7a92c1ceca\nparent 6b76b0e558d3d5b412b627e953a94e4a93a0ad2a\nauthor Dylan DPC <dylan.dpc@gmail.com> 1587726860 +0200\ncommitter GitHub <noreply@github.com> 1587726860 +0200\n\nRollup merge of #71318 - RalfJung:miri-unleash-cleanup, r=oli-obk\n\nmiri-unleash tests: ensure they fire even with 'allow(const_err)'\n\nThis is easier with `static` than `const` so I switched some of them over.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2846aa2f2f7adf764aaae1ed8221fc8084973db7", "html_url": "https://github.com/rust-lang/rust/commit/2846aa2f2f7adf764aaae1ed8221fc8084973db7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2846aa2f2f7adf764aaae1ed8221fc8084973db7/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7d8a3ad128381bbabb18f975130cfd7a92c1ceca", "url": "https://api.github.com/repos/rust-lang/rust/commits/7d8a3ad128381bbabb18f975130cfd7a92c1ceca", "html_url": "https://github.com/rust-lang/rust/commit/7d8a3ad128381bbabb18f975130cfd7a92c1ceca"}, {"sha": "6b76b0e558d3d5b412b627e953a94e4a93a0ad2a", "url": "https://api.github.com/repos/rust-lang/rust/commits/6b76b0e558d3d5b412b627e953a94e4a93a0ad2a", "html_url": "https://github.com/rust-lang/rust/commit/6b76b0e558d3d5b412b627e953a94e4a93a0ad2a"}], "stats": {"total": 337, "additions": 156, "deletions": 181}, "files": [{"sha": "a99e6327987f0cd6d02f2c6342d0f7f09c052696", "filename": "src/test/ui/consts/miri_unleashed/abi-mismatch.rs", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/2846aa2f2f7adf764aaae1ed8221fc8084973db7/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fabi-mismatch.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2846aa2f2f7adf764aaae1ed8221fc8084973db7/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fabi-mismatch.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fabi-mismatch.rs?ref=2846aa2f2f7adf764aaae1ed8221fc8084973db7", "patch": "@@ -2,15 +2,20 @@\n // compile-flags: -Z unleash-the-miri-inside-of-you\n \n #![feature(const_extern_fn)]\n+#![allow(const_err)]\n \n const extern \"C\" fn c_fn() {}\n \n const fn call_rust_fn(my_fn: extern \"Rust\" fn()) {\n-    my_fn(); //~ ERROR any use of this value will cause an error\n+    my_fn();\n     //~^ WARN skipping const checks\n+    //~| ERROR could not evaluate static initializer\n+    //~| NOTE calling a function with ABI C using caller ABI Rust\n+    //~| NOTE inside `call_rust_fn`\n }\n \n-const VAL: () = call_rust_fn(unsafe { std::mem::transmute(c_fn as extern \"C\" fn()) });\n+static VAL: () = call_rust_fn(unsafe { std::mem::transmute(c_fn as extern \"C\" fn()) });\n //~^ WARN skipping const checks\n+//~| NOTE inside `VAL`\n \n fn main() {}"}, {"sha": "674a293d2815e88bf052dd0ec76597b1e5b77c7e", "filename": "src/test/ui/consts/miri_unleashed/abi-mismatch.stderr", "status": "modified", "additions": 10, "deletions": 12, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/2846aa2f2f7adf764aaae1ed8221fc8084973db7/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fabi-mismatch.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2846aa2f2f7adf764aaae1ed8221fc8084973db7/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fabi-mismatch.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fabi-mismatch.stderr?ref=2846aa2f2f7adf764aaae1ed8221fc8084973db7", "patch": "@@ -1,29 +1,27 @@\n warning: skipping const checks\n-  --> $DIR/abi-mismatch.rs:9:5\n+  --> $DIR/abi-mismatch.rs:10:5\n    |\n LL |     my_fn();\n    |     ^^^^^^^\n \n warning: skipping const checks\n-  --> $DIR/abi-mismatch.rs:13:39\n+  --> $DIR/abi-mismatch.rs:17:40\n    |\n-LL | const VAL: () = call_rust_fn(unsafe { std::mem::transmute(c_fn as extern \"C\" fn()) });\n-   |                                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+LL | static VAL: () = call_rust_fn(unsafe { std::mem::transmute(c_fn as extern \"C\" fn()) });\n+   |                                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n-error: any use of this value will cause an error\n-  --> $DIR/abi-mismatch.rs:9:5\n+error[E0080]: could not evaluate static initializer\n+  --> $DIR/abi-mismatch.rs:10:5\n    |\n LL |     my_fn();\n    |     ^^^^^^^\n    |     |\n    |     calling a function with ABI C using caller ABI Rust\n-   |     inside `call_rust_fn` at $DIR/abi-mismatch.rs:9:5\n-   |     inside `VAL` at $DIR/abi-mismatch.rs:13:17\n+   |     inside `call_rust_fn` at $DIR/abi-mismatch.rs:10:5\n ...\n-LL | const VAL: () = call_rust_fn(unsafe { std::mem::transmute(c_fn as extern \"C\" fn()) });\n-   | --------------------------------------------------------------------------------------\n-   |\n-   = note: `#[deny(const_err)]` on by default\n+LL | static VAL: () = call_rust_fn(unsafe { std::mem::transmute(c_fn as extern \"C\" fn()) });\n+   |                  --------------------------------------------------------------------- inside `VAL` at $DIR/abi-mismatch.rs:17:18\n \n error: aborting due to previous error; 2 warnings emitted\n \n+For more information about this error, try `rustc --explain E0080`."}, {"sha": "1b18470eded42c4d315a9ff8fd2a6d29f653e954", "filename": "src/test/ui/consts/miri_unleashed/box.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/2846aa2f2f7adf764aaae1ed8221fc8084973db7/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fbox.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2846aa2f2f7adf764aaae1ed8221fc8084973db7/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fbox.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fbox.rs?ref=2846aa2f2f7adf764aaae1ed8221fc8084973db7", "patch": "@@ -1,6 +1,6 @@\n // compile-flags: -Zunleash-the-miri-inside-of-you\n #![feature(const_mut_refs, box_syntax)]\n-#![deny(const_err)]\n+#![allow(const_err)]\n \n use std::mem::ManuallyDrop;\n "}, {"sha": "11f4a30d1779b3c3a2182b014197ae73584ade2d", "filename": "src/test/ui/consts/miri_unleashed/const_refers_to_static.rs", "status": "modified", "additions": 14, "deletions": 16, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/2846aa2f2f7adf764aaae1ed8221fc8084973db7/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fconst_refers_to_static.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2846aa2f2f7adf764aaae1ed8221fc8084973db7/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fconst_refers_to_static.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fconst_refers_to_static.rs?ref=2846aa2f2f7adf764aaae1ed8221fc8084973db7", "patch": "@@ -1,39 +1,37 @@\n+// build-fail\n // compile-flags: -Zunleash-the-miri-inside-of-you\n-#![warn(const_err)]\n+#![allow(const_err)]\n \n #![feature(const_raw_ptr_deref)]\n \n use std::sync::atomic::AtomicUsize;\n use std::sync::atomic::Ordering;\n \n-const REF_INTERIOR_MUT: &usize = { //~ ERROR undefined behavior to use this value\n-    static FOO: AtomicUsize = AtomicUsize::new(0);\n-    unsafe { &*(&FOO as *const _ as *const usize) }\n-    //~^ WARN skipping const checks\n-};\n+// These tests only cause an error when *using* the const.\n \n const MUTATE_INTERIOR_MUT: usize = {\n     static FOO: AtomicUsize = AtomicUsize::new(0);\n-    FOO.fetch_add(1, Ordering::Relaxed) //~ WARN any use of this value will cause an error\n+    FOO.fetch_add(1, Ordering::Relaxed)\n     //~^ WARN skipping const checks\n     //~| WARN skipping const checks\n };\n \n const READ_INTERIOR_MUT: usize = {\n     static FOO: AtomicUsize = AtomicUsize::new(0);\n-    unsafe { *(&FOO as *const _ as *const usize) } //~ WARN any use of this value will cause an err\n+    unsafe { *(&FOO as *const _ as *const usize) }\n     //~^ WARN skipping const checks\n };\n \n static mut MUTABLE: u32 = 0;\n-const READ_MUT: u32 = unsafe { MUTABLE }; //~ WARN any use of this value will cause an error\n+const READ_MUT: u32 = unsafe { MUTABLE };\n //~^ WARN skipping const checks\n //~| WARN skipping const checks\n \n-// ok some day perhaps\n-const READ_IMMUT: &usize = { //~ ERROR it is undefined behavior to use this value\n-    static FOO: usize = 0;\n-    &FOO\n-    //~^ WARN skipping const checks\n-};\n-fn main() {}\n+fn main() {\n+    MUTATE_INTERIOR_MUT;\n+    //~^ ERROR: erroneous constant used\n+    READ_INTERIOR_MUT;\n+    //~^ ERROR: erroneous constant used\n+    READ_MUT;\n+    //~^ ERROR: erroneous constant used\n+}"}, {"sha": "788762808f13b1f3e0c7b4390a8f7e9008a135f5", "filename": "src/test/ui/consts/miri_unleashed/const_refers_to_static.stderr", "status": "modified", "additions": 18, "deletions": 73, "changes": 91, "blob_url": "https://github.com/rust-lang/rust/blob/2846aa2f2f7adf764aaae1ed8221fc8084973db7/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fconst_refers_to_static.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2846aa2f2f7adf764aaae1ed8221fc8084973db7/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fconst_refers_to_static.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fconst_refers_to_static.stderr?ref=2846aa2f2f7adf764aaae1ed8221fc8084973db7", "patch": "@@ -1,106 +1,51 @@\n warning: skipping const checks\n-  --> $DIR/const_refers_to_static.rs:11:18\n-   |\n-LL |     unsafe { &*(&FOO as *const _ as *const usize) }\n-   |                  ^^^\n-\n-warning: skipping const checks\n-  --> $DIR/const_refers_to_static.rs:17:5\n+  --> $DIR/const_refers_to_static.rs:14:5\n    |\n LL |     FOO.fetch_add(1, Ordering::Relaxed)\n    |     ^^^\n \n warning: skipping const checks\n-  --> $DIR/const_refers_to_static.rs:17:5\n+  --> $DIR/const_refers_to_static.rs:14:5\n    |\n LL |     FOO.fetch_add(1, Ordering::Relaxed)\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n warning: skipping const checks\n-  --> $DIR/const_refers_to_static.rs:24:17\n+  --> $DIR/const_refers_to_static.rs:21:17\n    |\n LL |     unsafe { *(&FOO as *const _ as *const usize) }\n    |                 ^^^\n \n warning: skipping const checks\n-  --> $DIR/const_refers_to_static.rs:29:32\n+  --> $DIR/const_refers_to_static.rs:26:32\n    |\n LL | const READ_MUT: u32 = unsafe { MUTABLE };\n    |                                ^^^^^^^\n \n warning: skipping const checks\n-  --> $DIR/const_refers_to_static.rs:29:32\n+  --> $DIR/const_refers_to_static.rs:26:32\n    |\n LL | const READ_MUT: u32 = unsafe { MUTABLE };\n    |                                ^^^^^^^\n \n-warning: skipping const checks\n-  --> $DIR/const_refers_to_static.rs:36:6\n+error[E0080]: erroneous constant used\n+  --> $DIR/const_refers_to_static.rs:31:5\n    |\n-LL |     &FOO\n-   |      ^^^\n+LL |     MUTATE_INTERIOR_MUT;\n+   |     ^^^^^^^^^^^^^^^^^^^ referenced constant has errors\n \n-error[E0080]: it is undefined behavior to use this value\n-  --> $DIR/const_refers_to_static.rs:9:1\n+error[E0080]: erroneous constant used\n+  --> $DIR/const_refers_to_static.rs:33:5\n    |\n-LL | / const REF_INTERIOR_MUT: &usize = {\n-LL | |     static FOO: AtomicUsize = AtomicUsize::new(0);\n-LL | |     unsafe { &*(&FOO as *const _ as *const usize) }\n-LL | |\n-LL | | };\n-   | |__^ type validation failed: encountered a reference pointing to a static variable\n-   |\n-   = note: The rules on what exactly is undefined behavior aren't clear, so this check might be overzealous. Please open an issue on the rustc repository if you believe it should not be considered undefined behavior.\n+LL |     READ_INTERIOR_MUT;\n+   |     ^^^^^^^^^^^^^^^^^ referenced constant has errors\n \n-warning: any use of this value will cause an error\n-  --> $DIR/const_refers_to_static.rs:17:5\n-   |\n-LL | / const MUTATE_INTERIOR_MUT: usize = {\n-LL | |     static FOO: AtomicUsize = AtomicUsize::new(0);\n-LL | |     FOO.fetch_add(1, Ordering::Relaxed)\n-   | |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ calling non-const function `std::sync::atomic::AtomicUsize::fetch_add`\n-LL | |\n-LL | |\n-LL | | };\n-   | |__-\n-   |\n-note: the lint level is defined here\n-  --> $DIR/const_refers_to_static.rs:2:9\n-   |\n-LL | #![warn(const_err)]\n-   |         ^^^^^^^^^\n-\n-warning: any use of this value will cause an error\n-  --> $DIR/const_refers_to_static.rs:24:14\n-   |\n-LL | / const READ_INTERIOR_MUT: usize = {\n-LL | |     static FOO: AtomicUsize = AtomicUsize::new(0);\n-LL | |     unsafe { *(&FOO as *const _ as *const usize) }\n-   | |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ constant accesses static\n-LL | |\n-LL | | };\n-   | |__-\n-\n-warning: any use of this value will cause an error\n-  --> $DIR/const_refers_to_static.rs:29:32\n-   |\n-LL | const READ_MUT: u32 = unsafe { MUTABLE };\n-   | -------------------------------^^^^^^^---\n-   |                                |\n-   |                                constant accesses static\n-\n-error[E0080]: it is undefined behavior to use this value\n-  --> $DIR/const_refers_to_static.rs:34:1\n-   |\n-LL | / const READ_IMMUT: &usize = {\n-LL | |     static FOO: usize = 0;\n-LL | |     &FOO\n-LL | |\n-LL | | };\n-   | |__^ type validation failed: encountered a reference pointing to a static variable\n+error[E0080]: erroneous constant used\n+  --> $DIR/const_refers_to_static.rs:35:5\n    |\n-   = note: The rules on what exactly is undefined behavior aren't clear, so this check might be overzealous. Please open an issue on the rustc repository if you believe it should not be considered undefined behavior.\n+LL |     READ_MUT;\n+   |     ^^^^^^^^ referenced constant has errors\n \n-error: aborting due to 2 previous errors; 10 warnings emitted\n+error: aborting due to 3 previous errors; 5 warnings emitted\n \n For more information about this error, try `rustc --explain E0080`."}, {"sha": "2704f2a7d73c1d1e6b5d6df90f9350941c5036a3", "filename": "src/test/ui/consts/miri_unleashed/const_refers_to_static2.rs", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/2846aa2f2f7adf764aaae1ed8221fc8084973db7/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fconst_refers_to_static2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2846aa2f2f7adf764aaae1ed8221fc8084973db7/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fconst_refers_to_static2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fconst_refers_to_static2.rs?ref=2846aa2f2f7adf764aaae1ed8221fc8084973db7", "patch": "@@ -0,0 +1,24 @@\n+// compile-flags: -Zunleash-the-miri-inside-of-you\n+#![allow(const_err)]\n+\n+#![feature(const_raw_ptr_deref)]\n+\n+use std::sync::atomic::AtomicUsize;\n+use std::sync::atomic::Ordering;\n+\n+// These tests cause immediate error when *defining* the const.\n+\n+const REF_INTERIOR_MUT: &usize = { //~ ERROR undefined behavior to use this value\n+    static FOO: AtomicUsize = AtomicUsize::new(0);\n+    unsafe { &*(&FOO as *const _ as *const usize) }\n+    //~^ WARN skipping const checks\n+};\n+\n+// ok some day perhaps\n+const READ_IMMUT: &usize = { //~ ERROR it is undefined behavior to use this value\n+    static FOO: usize = 0;\n+    &FOO\n+    //~^ WARN skipping const checks\n+};\n+\n+fn main() {}"}, {"sha": "2a233d63efef8348d491425c3ca04d34ca8ea496", "filename": "src/test/ui/consts/miri_unleashed/const_refers_to_static2.stderr", "status": "added", "additions": 39, "deletions": 0, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/2846aa2f2f7adf764aaae1ed8221fc8084973db7/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fconst_refers_to_static2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2846aa2f2f7adf764aaae1ed8221fc8084973db7/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fconst_refers_to_static2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fconst_refers_to_static2.stderr?ref=2846aa2f2f7adf764aaae1ed8221fc8084973db7", "patch": "@@ -0,0 +1,39 @@\n+warning: skipping const checks\n+  --> $DIR/const_refers_to_static2.rs:13:18\n+   |\n+LL |     unsafe { &*(&FOO as *const _ as *const usize) }\n+   |                  ^^^\n+\n+warning: skipping const checks\n+  --> $DIR/const_refers_to_static2.rs:20:6\n+   |\n+LL |     &FOO\n+   |      ^^^\n+\n+error[E0080]: it is undefined behavior to use this value\n+  --> $DIR/const_refers_to_static2.rs:11:1\n+   |\n+LL | / const REF_INTERIOR_MUT: &usize = {\n+LL | |     static FOO: AtomicUsize = AtomicUsize::new(0);\n+LL | |     unsafe { &*(&FOO as *const _ as *const usize) }\n+LL | |\n+LL | | };\n+   | |__^ type validation failed: encountered a reference pointing to a static variable\n+   |\n+   = note: The rules on what exactly is undefined behavior aren't clear, so this check might be overzealous. Please open an issue on the rustc repository if you believe it should not be considered undefined behavior.\n+\n+error[E0080]: it is undefined behavior to use this value\n+  --> $DIR/const_refers_to_static2.rs:18:1\n+   |\n+LL | / const READ_IMMUT: &usize = {\n+LL | |     static FOO: usize = 0;\n+LL | |     &FOO\n+LL | |\n+LL | | };\n+   | |__^ type validation failed: encountered a reference pointing to a static variable\n+   |\n+   = note: The rules on what exactly is undefined behavior aren't clear, so this check might be overzealous. Please open an issue on the rustc repository if you believe it should not be considered undefined behavior.\n+\n+error: aborting due to 2 previous errors; 2 warnings emitted\n+\n+For more information about this error, try `rustc --explain E0080`."}, {"sha": "3b9208dd12609c014e30e28855e07af4768521e9", "filename": "src/test/ui/consts/miri_unleashed/drop.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/2846aa2f2f7adf764aaae1ed8221fc8084973db7/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fdrop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2846aa2f2f7adf764aaae1ed8221fc8084973db7/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fdrop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fdrop.rs?ref=2846aa2f2f7adf764aaae1ed8221fc8084973db7", "patch": "@@ -1,6 +1,6 @@\n // compile-flags: -Zunleash-the-miri-inside-of-you\n // error-pattern: calling non-const function `<std::vec::Vec<i32> as std::ops::Drop>::drop`\n-#![deny(const_err)]\n+#![allow(const_err)]\n \n use std::mem::ManuallyDrop;\n "}, {"sha": "5cc8808be5dc13ccbed087c648afedd5ad7b10de", "filename": "src/test/ui/consts/miri_unleashed/mutable_const.rs", "status": "modified", "additions": 10, "deletions": 2, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/2846aa2f2f7adf764aaae1ed8221fc8084973db7/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fmutable_const.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2846aa2f2f7adf764aaae1ed8221fc8084973db7/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fmutable_const.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fmutable_const.rs?ref=2846aa2f2f7adf764aaae1ed8221fc8084973db7", "patch": "@@ -1,19 +1,27 @@\n // compile-flags: -Zunleash-the-miri-inside-of-you\n+// normalize-stderr-test \"alloc[0-9]+\" -> \"allocN\"\n \n #![feature(const_raw_ptr_deref)]\n #![feature(const_mut_refs)]\n-#![deny(const_err)]\n+#![deny(const_err)] // The `allow` variant is tested by `mutable_const2`.\n+//~^ NOTE lint level\n+// Here we check that even though `MUTABLE_BEHIND_RAW` is created from a mutable\n+// allocation, we intern that allocation as *immutable* and reject writes to it.\n+// We avoid the `delay_span_bug` ICE by having compilation fail via the `deny` above.\n \n use std::cell::UnsafeCell;\n \n // make sure we do not just intern this as mutable\n const MUTABLE_BEHIND_RAW: *mut i32 = &UnsafeCell::new(42) as *const _ as *mut _;\n //~^ WARN: skipping const checks\n \n-const MUTATING_BEHIND_RAW: () = {\n+const MUTATING_BEHIND_RAW: () = { //~ NOTE\n     // Test that `MUTABLE_BEHIND_RAW` is actually immutable, by doing this at const time.\n     unsafe {\n         *MUTABLE_BEHIND_RAW = 99 //~ ERROR any use of this value will cause an error\n+        //~^ NOTE: which is read-only\n+        // FIXME would be good to match more of the error message here, but looks like we\n+        // normalize *after* checking the annoations here.\n     }\n };\n "}, {"sha": "34993247fca80c2aec65fdbf36a595a0528dc531", "filename": "src/test/ui/consts/miri_unleashed/mutable_const.stderr", "status": "modified", "additions": 6, "deletions": 5, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/2846aa2f2f7adf764aaae1ed8221fc8084973db7/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fmutable_const.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2846aa2f2f7adf764aaae1ed8221fc8084973db7/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fmutable_const.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fmutable_const.stderr?ref=2846aa2f2f7adf764aaae1ed8221fc8084973db7", "patch": "@@ -1,25 +1,26 @@\n warning: skipping const checks\n-  --> $DIR/mutable_const.rs:10:38\n+  --> $DIR/mutable_const.rs:15:38\n    |\n LL | const MUTABLE_BEHIND_RAW: *mut i32 = &UnsafeCell::new(42) as *const _ as *mut _;\n    |                                      ^^^^^^^^^^^^^^^^^^^^\n \n error: any use of this value will cause an error\n-  --> $DIR/mutable_const.rs:16:9\n+  --> $DIR/mutable_const.rs:21:9\n    |\n LL | / const MUTATING_BEHIND_RAW: () = {\n LL | |     // Test that `MUTABLE_BEHIND_RAW` is actually immutable, by doing this at const time.\n LL | |     unsafe {\n LL | |         *MUTABLE_BEHIND_RAW = 99\n-   | |         ^^^^^^^^^^^^^^^^^^^^^^^^ writing to alloc2 which is read-only\n+   | |         ^^^^^^^^^^^^^^^^^^^^^^^^ writing to allocN which is read-only\n+...  |\n LL | |     }\n LL | | };\n    | |__-\n    |\n note: the lint level is defined here\n-  --> $DIR/mutable_const.rs:5:9\n+  --> $DIR/mutable_const.rs:6:9\n    |\n-LL | #![deny(const_err)]\n+LL | #![deny(const_err)] // The `allow` variant is tested by `mutable_const2`.\n    |         ^^^^^^^^^\n \n error: aborting due to previous error; 1 warning emitted"}, {"sha": "c2c7fb18e2a630ffb92f199b974e45a59a3b2ec0", "filename": "src/test/ui/consts/miri_unleashed/mutable_const2.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/2846aa2f2f7adf764aaae1ed8221fc8084973db7/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fmutable_const2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2846aa2f2f7adf764aaae1ed8221fc8084973db7/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fmutable_const2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fmutable_const2.rs?ref=2846aa2f2f7adf764aaae1ed8221fc8084973db7", "patch": "@@ -3,11 +3,11 @@\n // rustc-env:RUST_BACKTRACE=0\n // normalize-stderr-test \"note: rustc 1.* running on .*\" -> \"note: rustc VERSION running on TARGET\"\n // normalize-stderr-test \"note: compiler flags: .*\" -> \"note: compiler flags: FLAGS\"\n-// normalize-stderr-test \"interpret/intern.rs:[0-9]*:[0-9]*\" -> \"interpret/intern.rs:LL:CC\"\n+// normalize-stderr-test \"interpret/intern.rs:[0-9]+:[0-9]+\" -> \"interpret/intern.rs:LL:CC\"\n \n #![feature(const_raw_ptr_deref)]\n #![feature(const_mut_refs)]\n-#![deny(const_err)]\n+#![allow(const_err)]\n \n use std::cell::UnsafeCell;\n "}, {"sha": "9d8d5f513c76babf6a95c579f53be6b32e1d39b6", "filename": "src/test/ui/consts/miri_unleashed/mutable_references_ice.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/2846aa2f2f7adf764aaae1ed8221fc8084973db7/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fmutable_references_ice.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2846aa2f2f7adf764aaae1ed8221fc8084973db7/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fmutable_references_ice.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fmutable_references_ice.rs?ref=2846aa2f2f7adf764aaae1ed8221fc8084973db7", "patch": "@@ -3,7 +3,7 @@\n // rustc-env:RUST_BACKTRACE=0\n // normalize-stderr-test \"note: rustc 1.* running on .*\" -> \"note: rustc VERSION running on TARGET\"\n // normalize-stderr-test \"note: compiler flags: .*\" -> \"note: compiler flags: FLAGS\"\n-// normalize-stderr-test \"interpret/intern.rs:[0-9]*:[0-9]*\" -> \"interpret/intern.rs:LL:CC\"\n+// normalize-stderr-test \"interpret/intern.rs:[0-9]+:[0-9]+\" -> \"interpret/intern.rs:LL:CC\"\n \n #![allow(const_err)]\n "}, {"sha": "902fe0aa1e7e4e724e422da393610e22b915c1e6", "filename": "src/test/ui/consts/miri_unleashed/mutating_global.rs", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/2846aa2f2f7adf764aaae1ed8221fc8084973db7/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fmutating_global.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2846aa2f2f7adf764aaae1ed8221fc8084973db7/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fmutating_global.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fmutating_global.rs?ref=2846aa2f2f7adf764aaae1ed8221fc8084973db7", "patch": "@@ -1,14 +1,15 @@\n // compile-flags: -Zunleash-the-miri-inside-of-you\n+#![allow(const_err)]\n \n // Make sure we cannot mutate globals.\n \n static mut GLOBAL: i32 = 0;\n \n-const MUTATING_GLOBAL: () = {\n+static MUTATING_GLOBAL: () = {\n     unsafe {\n-        GLOBAL = 99 //~ ERROR any use of this value will cause an error\n-        //~^ WARN skipping const checks\n-        //~| WARN skipping const checks\n+        GLOBAL = 99\n+        //~^ ERROR could not evaluate static initializer\n+        //~| NOTE modifying a static's initial value\n     }\n };\n "}, {"sha": "ba9dd56190ac12d07035b6e12a9a5a6dfc738ffe", "filename": "src/test/ui/consts/miri_unleashed/mutating_global.stderr", "status": "modified", "additions": 5, "deletions": 25, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/2846aa2f2f7adf764aaae1ed8221fc8084973db7/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fmutating_global.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2846aa2f2f7adf764aaae1ed8221fc8084973db7/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fmutating_global.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fmutating_global.stderr?ref=2846aa2f2f7adf764aaae1ed8221fc8084973db7", "patch": "@@ -1,29 +1,9 @@\n-warning: skipping const checks\n-  --> $DIR/mutating_global.rs:9:9\n+error[E0080]: could not evaluate static initializer\n+  --> $DIR/mutating_global.rs:10:9\n    |\n LL |         GLOBAL = 99\n-   |         ^^^^^^\n+   |         ^^^^^^^^^^^ modifying a static's initial value from another static's initializer\n \n-warning: skipping const checks\n-  --> $DIR/mutating_global.rs:9:9\n-   |\n-LL |         GLOBAL = 99\n-   |         ^^^^^^\n-\n-error: any use of this value will cause an error\n-  --> $DIR/mutating_global.rs:9:9\n-   |\n-LL | / const MUTATING_GLOBAL: () = {\n-LL | |     unsafe {\n-LL | |         GLOBAL = 99\n-   | |         ^^^^^^^^^^^ modifying a static's initial value from another static's initializer\n-LL | |\n-LL | |\n-LL | |     }\n-LL | | };\n-   | |__-\n-   |\n-   = note: `#[deny(const_err)]` on by default\n-\n-error: aborting due to previous error; 2 warnings emitted\n+error: aborting due to previous error\n \n+For more information about this error, try `rustc --explain E0080`."}, {"sha": "b401884139d9f4e400efd8ec09e933708de0bc91", "filename": "src/test/ui/consts/miri_unleashed/non_const_fn.rs", "status": "modified", "additions": 5, "deletions": 9, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/2846aa2f2f7adf764aaae1ed8221fc8084973db7/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fnon_const_fn.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2846aa2f2f7adf764aaae1ed8221fc8084973db7/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fnon_const_fn.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fnon_const_fn.rs?ref=2846aa2f2f7adf764aaae1ed8221fc8084973db7", "patch": "@@ -1,17 +1,13 @@\n-// build-fail\n // compile-flags: -Zunleash-the-miri-inside-of-you\n \n-#![warn(const_err)]\n+#![allow(const_err)]\n \n // A test demonstrating that we prevent calling non-const fn during CTFE.\n \n fn foo() {}\n \n-const C: () = foo(); //~ WARN: skipping const checks\n-//~^ WARN any use of this value will cause an error\n+static C: () = foo(); //~ WARN: skipping const checks\n+//~^ ERROR could not evaluate static initializer\n+//~| NOTE calling non-const function `foo`\n \n-fn main() {\n-    println!(\"{:?}\", C);\n-    //~^ ERROR: evaluation of constant expression failed\n-    //~| WARN: erroneous constant used [const_err]\n-}\n+fn main() {}"}, {"sha": "d20cd6d6f0b9e557533eb2e16d944b28958c2cef", "filename": "src/test/ui/consts/miri_unleashed/non_const_fn.stderr", "status": "modified", "additions": 8, "deletions": 28, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/2846aa2f2f7adf764aaae1ed8221fc8084973db7/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fnon_const_fn.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2846aa2f2f7adf764aaae1ed8221fc8084973db7/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fnon_const_fn.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Fnon_const_fn.stderr?ref=2846aa2f2f7adf764aaae1ed8221fc8084973db7", "patch": "@@ -1,35 +1,15 @@\n warning: skipping const checks\n-  --> $DIR/non_const_fn.rs:10:15\n+  --> $DIR/non_const_fn.rs:9:16\n    |\n-LL | const C: () = foo();\n-   |               ^^^^^\n+LL | static C: () = foo();\n+   |                ^^^^^\n \n-warning: any use of this value will cause an error\n-  --> $DIR/non_const_fn.rs:10:15\n+error[E0080]: could not evaluate static initializer\n+  --> $DIR/non_const_fn.rs:9:16\n    |\n-LL | const C: () = foo();\n-   | --------------^^^^^-\n-   |               |\n-   |               calling non-const function `foo`\n-   |\n-note: the lint level is defined here\n-  --> $DIR/non_const_fn.rs:4:9\n-   |\n-LL | #![warn(const_err)]\n-   |         ^^^^^^^^^\n-\n-error[E0080]: evaluation of constant expression failed\n-  --> $DIR/non_const_fn.rs:14:22\n-   |\n-LL |     println!(\"{:?}\", C);\n-   |                      ^ referenced constant has errors\n-\n-warning: erroneous constant used\n-  --> $DIR/non_const_fn.rs:14:22\n-   |\n-LL |     println!(\"{:?}\", C);\n-   |                      ^ referenced constant has errors\n+LL | static C: () = foo();\n+   |                ^^^^^ calling non-const function `foo`\n \n-error: aborting due to previous error; 3 warnings emitted\n+error: aborting due to previous error; 1 warning emitted\n \n For more information about this error, try `rustc --explain E0080`."}]}