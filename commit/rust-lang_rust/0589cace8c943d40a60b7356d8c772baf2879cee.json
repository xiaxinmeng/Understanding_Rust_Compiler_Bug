{"sha": "0589cace8c943d40a60b7356d8c772baf2879cee", "node_id": "C_kwDOAAsO6NoAKDA1ODljYWNlOGM5NDNkNDBhNjBiNzM1NmQ4Yzc3MmJhZjI4NzljZWU", "commit": {"author": {"name": "Christopher Swenson", "email": "swenson@swenson.io", "date": "2022-01-10T23:31:11Z"}, "committer": {"name": "Christopher Swenson", "email": "swenson@swenson.io", "date": "2022-01-10T23:31:11Z"}, "message": "Simplify BigNum::bit_length() with log2()\n\nThank you to @scottmcm for suggesting the handy `log2()` function.", "tree": {"sha": "966bc0fd7b9001a128d61aa4a0cffa9f76548873", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/966bc0fd7b9001a128d61aa4a0cffa9f76548873"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0589cace8c943d40a60b7356d8c772baf2879cee", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0589cace8c943d40a60b7356d8c772baf2879cee", "html_url": "https://github.com/rust-lang/rust/commit/0589cace8c943d40a60b7356d8c772baf2879cee", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0589cace8c943d40a60b7356d8c772baf2879cee/comments", "author": {"login": "swenson", "id": 33404, "node_id": "MDQ6VXNlcjMzNDA0", "avatar_url": "https://avatars.githubusercontent.com/u/33404?v=4", "gravatar_id": "", "url": "https://api.github.com/users/swenson", "html_url": "https://github.com/swenson", "followers_url": "https://api.github.com/users/swenson/followers", "following_url": "https://api.github.com/users/swenson/following{/other_user}", "gists_url": "https://api.github.com/users/swenson/gists{/gist_id}", "starred_url": "https://api.github.com/users/swenson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/swenson/subscriptions", "organizations_url": "https://api.github.com/users/swenson/orgs", "repos_url": "https://api.github.com/users/swenson/repos", "events_url": "https://api.github.com/users/swenson/events{/privacy}", "received_events_url": "https://api.github.com/users/swenson/received_events", "type": "User", "site_admin": false}, "committer": {"login": "swenson", "id": 33404, "node_id": "MDQ6VXNlcjMzNDA0", "avatar_url": "https://avatars.githubusercontent.com/u/33404?v=4", "gravatar_id": "", "url": "https://api.github.com/users/swenson", "html_url": "https://github.com/swenson", "followers_url": "https://api.github.com/users/swenson/followers", "following_url": "https://api.github.com/users/swenson/following{/other_user}", "gists_url": "https://api.github.com/users/swenson/gists{/gist_id}", "starred_url": "https://api.github.com/users/swenson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/swenson/subscriptions", "organizations_url": "https://api.github.com/users/swenson/orgs", "repos_url": "https://api.github.com/users/swenson/repos", "events_url": "https://api.github.com/users/swenson/events{/privacy}", "received_events_url": "https://api.github.com/users/swenson/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "424f38f211c23a9cf3d70a3bed17c30e79d49760", "url": "https://api.github.com/repos/rust-lang/rust/commits/424f38f211c23a9cf3d70a3bed17c30e79d49760", "html_url": "https://github.com/rust-lang/rust/commit/424f38f211c23a9cf3d70a3bed17c30e79d49760"}], "stats": {"total": 14, "additions": 6, "deletions": 8}, "files": [{"sha": "98d8a8a1d74aebd822326df20390147d4e099d47", "filename": "library/core/src/num/bignum.rs", "status": "modified", "additions": 6, "deletions": 8, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/0589cace8c943d40a60b7356d8c772baf2879cee/library%2Fcore%2Fsrc%2Fnum%2Fbignum.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0589cace8c943d40a60b7356d8c772baf2879cee/library%2Fcore%2Fsrc%2Fnum%2Fbignum.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fnum%2Fbignum.rs?ref=0589cace8c943d40a60b7356d8c772baf2879cee", "patch": "@@ -158,17 +158,15 @@ macro_rules! define_bignum {\n             /// Returns the number of bits necessary to represent this value. Note that zero\n             /// is considered to need 0 bits.\n             pub fn bit_length(&self) -> usize {\n-                // Skip over the most significant digits which are zero.\n+                let digitbits = <$ty>::BITS as usize;\n                 let digits = self.digits();\n-                let zeros = digits.iter().rev().take_while(|&&x| x == 0).count();\n-                let end = digits.len() - zeros;\n-                if end == 0 {\n+                // Find the most significant non-zero digit.\n+                let msd = digits.iter().rposition(|&x| x != 0);\n+                match msd {\n+                    Some(msd) => msd * digitbits + digits[msd].log2() as usize + 1,\n                     // There are no non-zero digits, i.e., the number is zero.\n-                    return 0;\n+                    _ => 0,\n                 }\n-                let digitbits = <$ty>::BITS as usize;\n-                let end_leading_zeros = digits[end - 1].leading_zeros() as usize;\n-                end * digitbits - end_leading_zeros\n             }\n \n             /// Adds `other` to itself and returns its own mutable reference."}]}