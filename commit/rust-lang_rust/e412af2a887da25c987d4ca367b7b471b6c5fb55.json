{"sha": "e412af2a887da25c987d4ca367b7b471b6c5fb55", "node_id": "MDY6Q29tbWl0NzI0NzEyOmU0MTJhZjJhODg3ZGEyNWM5ODdkNGNhMzY3YjdiNDcxYjZjNWZiNTU=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2017-03-07T23:24:36Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2017-03-07T23:24:36Z"}, "message": "rustbuild: Assert directory creation succeeds\n\nI've been seeing failures on the bots when building jemalloc and my assumption\nis that it's because cwd isn't created. That may be possible if this\n`create_dir_all` call change in this commit fails, in which case we ignore the\nerror.\n\nThis commit updates the location to call `create_dir_racy` which handles\nconcurrent invocations, as multiple build scripts may be trying to create the\n`native` dir.", "tree": {"sha": "3dcb7d9de3e8c3a8bcef207ea4d8eac8b14e1596", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3dcb7d9de3e8c3a8bcef207ea4d8eac8b14e1596"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e412af2a887da25c987d4ca367b7b471b6c5fb55", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e412af2a887da25c987d4ca367b7b471b6c5fb55", "html_url": "https://github.com/rust-lang/rust/commit/e412af2a887da25c987d4ca367b7b471b6c5fb55", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e412af2a887da25c987d4ca367b7b471b6c5fb55/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b04ebef43242ade6be8968694caf56a0fb00a4d3", "url": "https://api.github.com/repos/rust-lang/rust/commits/b04ebef43242ade6be8968694caf56a0fb00a4d3", "html_url": "https://github.com/rust-lang/rust/commit/b04ebef43242ade6be8968694caf56a0fb00a4d3"}], "stats": {"total": 25, "additions": 22, "deletions": 3}, "files": [{"sha": "cb58a916fb7971305675e4d2a2e47ccc949569cd", "filename": "src/build_helper/lib.rs", "status": "modified", "additions": 22, "deletions": 3, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/e412af2a887da25c987d4ca367b7b471b6c5fb55/src%2Fbuild_helper%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e412af2a887da25c987d4ca367b7b471b6c5fb55/src%2Fbuild_helper%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbuild_helper%2Flib.rs?ref=e412af2a887da25c987d4ca367b7b471b6c5fb55", "patch": "@@ -12,10 +12,11 @@\n \n extern crate filetime;\n \n-use std::{fs, env};\n use std::fs::File;\n-use std::process::{Command, Stdio};\n+use std::io;\n use std::path::{Path, PathBuf};\n+use std::process::{Command, Stdio};\n+use std::{fs, env};\n \n use filetime::FileTime;\n \n@@ -196,7 +197,7 @@ pub fn native_lib_boilerplate(src_name: &str,\n \n     let out_dir = env::var_os(\"RUSTBUILD_NATIVE_DIR\").unwrap_or(env::var_os(\"OUT_DIR\").unwrap());\n     let out_dir = PathBuf::from(out_dir).join(out_name);\n-    let _ = fs::create_dir_all(&out_dir);\n+    t!(create_dir_racy(&out_dir));\n     println!(\"cargo:rustc-link-lib=static={}\", link_name);\n     println!(\"cargo:rustc-link-search=native={}\", out_dir.join(search_subdir).display());\n \n@@ -223,3 +224,21 @@ fn fail(s: &str) -> ! {\n     println!(\"\\n\\n{}\\n\\n\", s);\n     std::process::exit(1);\n }\n+\n+fn create_dir_racy(path: &Path) -> io::Result<()> {\n+    match fs::create_dir(path) {\n+        Ok(()) => return Ok(()),\n+        Err(ref e) if e.kind() == io::ErrorKind::AlreadyExists => return Ok(()),\n+        Err(ref e) if e.kind() == io::ErrorKind::NotFound => {}\n+        Err(e) => return Err(e),\n+    }\n+    match path.parent() {\n+        Some(p) => try!(create_dir_racy(p)),\n+        None => return Err(io::Error::new(io::ErrorKind::Other, \"failed to create whole tree\")),\n+    }\n+    match fs::create_dir(path) {\n+        Ok(()) => Ok(()),\n+        Err(ref e) if e.kind() == io::ErrorKind::AlreadyExists => Ok(()),\n+        Err(e) => Err(e),\n+    }\n+}"}]}