{"sha": "1860f9ab43acb77c9fdd7ca646ef65e9b008b932", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE4NjBmOWFiNDNhY2I3N2M5ZmRkN2NhNjQ2ZWY2NWU5YjAwOGI5MzI=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-11-11T08:26:57Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-11-11T08:26:57Z"}, "message": "Forbid visibility qualifiers in traits", "tree": {"sha": "50401900e5b97e1bb40ad1d82c902bc175960cfa", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/50401900e5b97e1bb40ad1d82c902bc175960cfa"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1860f9ab43acb77c9fdd7ca646ef65e9b008b932", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1860f9ab43acb77c9fdd7ca646ef65e9b008b932", "html_url": "https://github.com/rust-lang/rust/commit/1860f9ab43acb77c9fdd7ca646ef65e9b008b932", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1860f9ab43acb77c9fdd7ca646ef65e9b008b932/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a09b5b91ae2ce5e59f0fea97d07bf4aa1f550212", "url": "https://api.github.com/repos/rust-lang/rust/commits/a09b5b91ae2ce5e59f0fea97d07bf4aa1f550212", "html_url": "https://github.com/rust-lang/rust/commit/a09b5b91ae2ce5e59f0fea97d07bf4aa1f550212"}], "stats": {"total": 132, "additions": 131, "deletions": 1}, "files": [{"sha": "1f60a7aabd06f7ff40217458e3a30f4a8c5e5fea", "filename": "crates/ra_syntax/src/syntax_error.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/1860f9ab43acb77c9fdd7ca646ef65e9b008b932/crates%2Fra_syntax%2Fsrc%2Fsyntax_error.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1860f9ab43acb77c9fdd7ca646ef65e9b008b932/crates%2Fra_syntax%2Fsrc%2Fsyntax_error.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_syntax%2Fsrc%2Fsyntax_error.rs?ref=1860f9ab43acb77c9fdd7ca646ef65e9b008b932", "patch": "@@ -82,6 +82,7 @@ pub enum SyntaxErrorKind {\n     InvalidBlockAttr,\n     InvalidMatchInnerAttr,\n     InvalidTupleIndexFormat,\n+    VisibilityNotAllowed,\n }\n \n impl fmt::Display for SyntaxErrorKind {\n@@ -99,6 +100,9 @@ impl fmt::Display for SyntaxErrorKind {\n             }\n             ParseError(msg) => write!(f, \"{}\", msg.0),\n             EscapeError(err) => write!(f, \"{}\", err),\n+            VisibilityNotAllowed => {\n+                write!(f, \"unnecessary visibility qualifier\")\n+            }\n         }\n     }\n }"}, {"sha": "2d596763ee376cabca113b93b61ed90bf011d934", "filename": "crates/ra_syntax/src/validation.rs", "status": "modified", "additions": 22, "deletions": 1, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/1860f9ab43acb77c9fdd7ca646ef65e9b008b932/crates%2Fra_syntax%2Fsrc%2Fvalidation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1860f9ab43acb77c9fdd7ca646ef65e9b008b932/crates%2Fra_syntax%2Fsrc%2Fvalidation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_syntax%2Fsrc%2Fvalidation.rs?ref=1860f9ab43acb77c9fdd7ca646ef65e9b008b932", "patch": "@@ -6,7 +6,7 @@ use rustc_lexer::unescape;\n \n use crate::{\n     ast, match_ast, AstNode, SyntaxError, SyntaxErrorKind,\n-    SyntaxKind::{BYTE, BYTE_STRING, CHAR, INT_NUMBER, STRING},\n+    SyntaxKind::{BYTE, BYTE_STRING, CHAR, CONST_DEF, FN_DEF, INT_NUMBER, STRING, TYPE_ALIAS_DEF},\n     SyntaxNode, SyntaxToken, TextUnit, T,\n };\n \n@@ -102,6 +102,7 @@ pub(crate) fn validate(root: &SyntaxNode) -> Vec<SyntaxError> {\n                 ast::BlockExpr(it) => { block::validate_block_expr(it, &mut errors) },\n                 ast::FieldExpr(it) => { validate_numeric_name(it.name_ref(), &mut errors) },\n                 ast::RecordField(it) => { validate_numeric_name(it.name_ref(), &mut errors) },\n+                ast::Visibility(it) => { validate_visibility(it, &mut errors) },\n                 _ => (),\n             }\n         }\n@@ -206,3 +207,23 @@ fn validate_numeric_name(name_ref: Option<ast::NameRef>, errors: &mut Vec<Syntax\n         name_ref?.syntax().first_child_or_token()?.into_token().filter(|it| it.kind() == INT_NUMBER)\n     }\n }\n+\n+fn validate_visibility(vis: ast::Visibility, errors: &mut Vec<SyntaxError>) {\n+    let parent = match vis.syntax().parent() {\n+        Some(it) => it,\n+        None => return,\n+    };\n+    match parent.kind() {\n+        FN_DEF | CONST_DEF | TYPE_ALIAS_DEF => (),\n+        _ => return,\n+    }\n+    let impl_block = match parent.parent().and_then(|it| it.parent()).and_then(ast::ImplBlock::cast)\n+    {\n+        Some(it) => it,\n+        None => return,\n+    };\n+    if impl_block.target_trait().is_some() {\n+        errors\n+            .push(SyntaxError::new(SyntaxErrorKind::VisibilityNotAllowed, vis.syntax.text_range()))\n+    }\n+}"}, {"sha": "a43e7ef10c1f9c59afb9f0cd119d02048f89a376", "filename": "crates/ra_syntax/test_data/parser/err/0037_visibility_in_traits.rs", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/1860f9ab43acb77c9fdd7ca646ef65e9b008b932/crates%2Fra_syntax%2Ftest_data%2Fparser%2Ferr%2F0037_visibility_in_traits.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1860f9ab43acb77c9fdd7ca646ef65e9b008b932/crates%2Fra_syntax%2Ftest_data%2Fparser%2Ferr%2F0037_visibility_in_traits.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_syntax%2Ftest_data%2Fparser%2Ferr%2F0037_visibility_in_traits.rs?ref=1860f9ab43acb77c9fdd7ca646ef65e9b008b932", "patch": "@@ -0,0 +1,6 @@\n+impl T for () {\n+    fn foo() {}\n+    pub fn bar() {}\n+    pub(crate) type Baz = ();\n+    pub(crate) const C: i32 = 92;\n+}"}, {"sha": "749c8cddbcadcb3a4f0dfdf9616c3c46126cd898", "filename": "crates/ra_syntax/test_data/parser/err/0037_visibility_in_traits.txt", "status": "added", "additions": 99, "deletions": 0, "changes": 99, "blob_url": "https://github.com/rust-lang/rust/blob/1860f9ab43acb77c9fdd7ca646ef65e9b008b932/crates%2Fra_syntax%2Ftest_data%2Fparser%2Ferr%2F0037_visibility_in_traits.txt", "raw_url": "https://github.com/rust-lang/rust/raw/1860f9ab43acb77c9fdd7ca646ef65e9b008b932/crates%2Fra_syntax%2Ftest_data%2Fparser%2Ferr%2F0037_visibility_in_traits.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_syntax%2Ftest_data%2Fparser%2Ferr%2F0037_visibility_in_traits.txt?ref=1860f9ab43acb77c9fdd7ca646ef65e9b008b932", "patch": "@@ -0,0 +1,99 @@\n+SOURCE_FILE@[0; 118)\n+  IMPL_BLOCK@[0; 117)\n+    IMPL_KW@[0; 4) \"impl\"\n+    WHITESPACE@[4; 5) \" \"\n+    PATH_TYPE@[5; 6)\n+      PATH@[5; 6)\n+        PATH_SEGMENT@[5; 6)\n+          NAME_REF@[5; 6)\n+            IDENT@[5; 6) \"T\"\n+    WHITESPACE@[6; 7) \" \"\n+    FOR_KW@[7; 10) \"for\"\n+    WHITESPACE@[10; 11) \" \"\n+    TUPLE_TYPE@[11; 13)\n+      L_PAREN@[11; 12) \"(\"\n+      R_PAREN@[12; 13) \")\"\n+    WHITESPACE@[13; 14) \" \"\n+    ITEM_LIST@[14; 117)\n+      L_CURLY@[14; 15) \"{\"\n+      WHITESPACE@[15; 20) \"\\n    \"\n+      FN_DEF@[20; 31)\n+        FN_KW@[20; 22) \"fn\"\n+        WHITESPACE@[22; 23) \" \"\n+        NAME@[23; 26)\n+          IDENT@[23; 26) \"foo\"\n+        PARAM_LIST@[26; 28)\n+          L_PAREN@[26; 27) \"(\"\n+          R_PAREN@[27; 28) \")\"\n+        WHITESPACE@[28; 29) \" \"\n+        BLOCK_EXPR@[29; 31)\n+          BLOCK@[29; 31)\n+            L_CURLY@[29; 30) \"{\"\n+            R_CURLY@[30; 31) \"}\"\n+      WHITESPACE@[31; 36) \"\\n    \"\n+      FN_DEF@[36; 51)\n+        VISIBILITY@[36; 39)\n+          PUB_KW@[36; 39) \"pub\"\n+        WHITESPACE@[39; 40) \" \"\n+        FN_KW@[40; 42) \"fn\"\n+        WHITESPACE@[42; 43) \" \"\n+        NAME@[43; 46)\n+          IDENT@[43; 46) \"bar\"\n+        PARAM_LIST@[46; 48)\n+          L_PAREN@[46; 47) \"(\"\n+          R_PAREN@[47; 48) \")\"\n+        WHITESPACE@[48; 49) \" \"\n+        BLOCK_EXPR@[49; 51)\n+          BLOCK@[49; 51)\n+            L_CURLY@[49; 50) \"{\"\n+            R_CURLY@[50; 51) \"}\"\n+      WHITESPACE@[51; 56) \"\\n    \"\n+      TYPE_ALIAS_DEF@[56; 81)\n+        VISIBILITY@[56; 66)\n+          PUB_KW@[56; 59) \"pub\"\n+          L_PAREN@[59; 60) \"(\"\n+          CRATE_KW@[60; 65) \"crate\"\n+          R_PAREN@[65; 66) \")\"\n+        WHITESPACE@[66; 67) \" \"\n+        TYPE_KW@[67; 71) \"type\"\n+        WHITESPACE@[71; 72) \" \"\n+        NAME@[72; 75)\n+          IDENT@[72; 75) \"Baz\"\n+        WHITESPACE@[75; 76) \" \"\n+        EQ@[76; 77) \"=\"\n+        WHITESPACE@[77; 78) \" \"\n+        TUPLE_TYPE@[78; 80)\n+          L_PAREN@[78; 79) \"(\"\n+          R_PAREN@[79; 80) \")\"\n+        SEMI@[80; 81) \";\"\n+      WHITESPACE@[81; 86) \"\\n    \"\n+      CONST_DEF@[86; 115)\n+        VISIBILITY@[86; 96)\n+          PUB_KW@[86; 89) \"pub\"\n+          L_PAREN@[89; 90) \"(\"\n+          CRATE_KW@[90; 95) \"crate\"\n+          R_PAREN@[95; 96) \")\"\n+        WHITESPACE@[96; 97) \" \"\n+        CONST_KW@[97; 102) \"const\"\n+        WHITESPACE@[102; 103) \" \"\n+        NAME@[103; 104)\n+          IDENT@[103; 104) \"C\"\n+        COLON@[104; 105) \":\"\n+        WHITESPACE@[105; 106) \" \"\n+        PATH_TYPE@[106; 109)\n+          PATH@[106; 109)\n+            PATH_SEGMENT@[106; 109)\n+              NAME_REF@[106; 109)\n+                IDENT@[106; 109) \"i32\"\n+        WHITESPACE@[109; 110) \" \"\n+        EQ@[110; 111) \"=\"\n+        WHITESPACE@[111; 112) \" \"\n+        LITERAL@[112; 114)\n+          INT_NUMBER@[112; 114) \"92\"\n+        SEMI@[114; 115) \";\"\n+      WHITESPACE@[115; 116) \"\\n\"\n+      R_CURLY@[116; 117) \"}\"\n+  WHITESPACE@[117; 118) \"\\n\"\n+error [36; 39): unnecessary visibility qualifier\n+error [56; 66): unnecessary visibility qualifier\n+error [86; 96): unnecessary visibility qualifier"}]}