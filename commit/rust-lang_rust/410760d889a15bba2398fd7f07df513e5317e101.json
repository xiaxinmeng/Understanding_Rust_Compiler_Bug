{"sha": "410760d889a15bba2398fd7f07df513e5317e101", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQxMDc2MGQ4ODlhMTViYmEyMzk4ZmQ3ZjA3ZGY1MTNlNTMxN2UxMDE=", "commit": {"author": {"name": "Oliver Schneider", "email": "oli-obk@users.noreply.github.com", "date": "2017-11-07T07:24:49Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2017-11-07T07:24:49Z"}, "message": "Merge pull request #2206 from LaurentMazare/master\n\nRefactor the never-loop lint.", "tree": {"sha": "e41ac4d1f835abcdc3a187966ead49a2efd61c35", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e41ac4d1f835abcdc3a187966ead49a2efd61c35"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/410760d889a15bba2398fd7f07df513e5317e101", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJaAV/BCRBK7hj4Ov3rIwAAdHIIAABqHM//gtn71nYY8VdRwu2M\nCjNDy8scDvlUfrsbXB4k37j5rjbUo2c3M9zaN2JMzcG2fdh5ndpCZlHpy7pxV/cR\nRT77n21H0KEALAaga+6sfoJ3mYhVPZlNez7H4djANPU+fOvG1c44g1Z8iVYrPuF/\nyXgsXg/zKgfTMl2lI/R/0Rk6zK4pEhvbdORnrDONye0CzHDsRSALbzp0f8Kv9qjf\nQXb7DQaJ2wup8Wk9nMgKqUmx++oJEjvyuEbIQO15F3QuFyph/0BbQzkAcOKwe0Ux\nrRFi0ZKjnCvwzGdE0aFHpL4+bMUaakoKI73D0/vbpsx35PpEruoPNMhb+K81VCk=\n=j/DK\n-----END PGP SIGNATURE-----\n", "payload": "tree e41ac4d1f835abcdc3a187966ead49a2efd61c35\nparent 9cd778ac9aa8514fa921093e0963ba9b32fbc3a0\nparent c9681905baf3613dbc17308cc171a0b60788ae5d\nauthor Oliver Schneider <oli-obk@users.noreply.github.com> 1510039489 +0100\ncommitter GitHub <noreply@github.com> 1510039489 +0100\n\nMerge pull request #2206 from LaurentMazare/master\n\nRefactor the never-loop lint."}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/410760d889a15bba2398fd7f07df513e5317e101", "html_url": "https://github.com/rust-lang/rust/commit/410760d889a15bba2398fd7f07df513e5317e101", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/410760d889a15bba2398fd7f07df513e5317e101/comments", "author": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9cd778ac9aa8514fa921093e0963ba9b32fbc3a0", "url": "https://api.github.com/repos/rust-lang/rust/commits/9cd778ac9aa8514fa921093e0963ba9b32fbc3a0", "html_url": "https://github.com/rust-lang/rust/commit/9cd778ac9aa8514fa921093e0963ba9b32fbc3a0"}, {"sha": "c9681905baf3613dbc17308cc171a0b60788ae5d", "url": "https://api.github.com/repos/rust-lang/rust/commits/c9681905baf3613dbc17308cc171a0b60788ae5d", "html_url": "https://github.com/rust-lang/rust/commit/c9681905baf3613dbc17308cc171a0b60788ae5d"}], "stats": {"total": 181, "additions": 122, "deletions": 59}, "files": [{"sha": "80aa7892a2672a93b75b9b16a5c65e0ce811b3ac", "filename": "clippy_lints/src/loops.rs", "status": "modified", "additions": 103, "deletions": 56, "changes": 159, "blob_url": "https://github.com/rust-lang/rust/blob/410760d889a15bba2398fd7f07df513e5317e101/clippy_lints%2Fsrc%2Floops.rs", "raw_url": "https://github.com/rust-lang/rust/raw/410760d889a15bba2398fd7f07df513e5317e101/clippy_lints%2Fsrc%2Floops.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Floops.rs?ref=410760d889a15bba2398fd7f07df513e5317e101", "patch": "@@ -378,13 +378,10 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for Pass {\n         // check for never_loop\n         match expr.node {\n             ExprWhile(_, ref block, _) | ExprLoop(ref block, _, _) => {\n-                let mut state = NeverLoopState {\n-                    breaks: HashSet::new(),\n-                    continues: HashSet::new(),\n-                };\n-                let may_complete = never_loop_block(block, &mut state);\n-                if !may_complete && !state.continues.contains(&expr.id) {\n-                    span_lint(cx, NEVER_LOOP, expr.span, \"this loop never actually loops\");\n+                match never_loop_block(block, &expr.id) {\n+                    NeverLoopResult::AlwaysBreak =>\n+                        span_lint(cx, NEVER_LOOP, expr.span, \"this loop never actually loops\"),\n+                    NeverLoopResult::MayContinueMainLoop | NeverLoopResult::Otherwise => (),\n                 }\n             },\n             _ => (),\n@@ -491,16 +488,59 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for Pass {\n     }\n }\n \n-struct NeverLoopState {\n-    breaks: HashSet<NodeId>,\n-    continues: HashSet<NodeId>,\n+enum NeverLoopResult {\n+    // A break/return always get triggered but not necessarily for the main loop.\n+    AlwaysBreak,\n+    // A continue may occur for the main loop.\n+    MayContinueMainLoop,\n+    Otherwise,\n+}\n+\n+fn absorb_break(arg: &NeverLoopResult) -> NeverLoopResult {\n+    match *arg {\n+        NeverLoopResult::AlwaysBreak |\n+        NeverLoopResult::Otherwise => NeverLoopResult::Otherwise,\n+        NeverLoopResult::MayContinueMainLoop => NeverLoopResult::MayContinueMainLoop,\n+    }\n+}\n+\n+// Combine two results for parts that are called in order.\n+fn combine_seq(first: NeverLoopResult, second: NeverLoopResult) -> NeverLoopResult {\n+    match first {\n+        NeverLoopResult::AlwaysBreak | NeverLoopResult::MayContinueMainLoop => first,\n+        NeverLoopResult::Otherwise => second,\n+    }\n+}\n+\n+// Combine two results where both parts are called but not necessarily in order.\n+fn combine_both(left: NeverLoopResult, right: NeverLoopResult) -> NeverLoopResult {\n+    match (left, right) {\n+        (NeverLoopResult::MayContinueMainLoop, _) | (_, NeverLoopResult::MayContinueMainLoop) =>\n+            NeverLoopResult::MayContinueMainLoop,\n+        (NeverLoopResult::AlwaysBreak, _) | (_, NeverLoopResult::AlwaysBreak) =>\n+            NeverLoopResult::AlwaysBreak,\n+        (NeverLoopResult::Otherwise, NeverLoopResult::Otherwise) =>\n+            NeverLoopResult::Otherwise,\n+    }\n+}\n+\n+// Combine two results where only one of the part may have been executed.\n+fn combine_branches(b1: NeverLoopResult, b2: NeverLoopResult) -> NeverLoopResult {\n+    match (b1, b2) {\n+        (NeverLoopResult::AlwaysBreak, NeverLoopResult::AlwaysBreak) =>\n+            NeverLoopResult::AlwaysBreak,\n+        (NeverLoopResult::MayContinueMainLoop, _) | (_, NeverLoopResult::MayContinueMainLoop) =>\n+            NeverLoopResult::MayContinueMainLoop,\n+        (NeverLoopResult::Otherwise, _) | (_, NeverLoopResult::Otherwise) =>\n+            NeverLoopResult::Otherwise,\n+    }\n }\n \n-fn never_loop_block(block: &Block, state: &mut NeverLoopState) -> bool {\n+fn never_loop_block(block: &Block, main_loop_id: &NodeId) -> NeverLoopResult {\n     let stmts = block.stmts.iter().map(stmt_to_expr);\n     let expr = once(block.expr.as_ref().map(|p| &**p));\n     let mut iter = stmts.chain(expr).filter_map(|e| e);\n-    never_loop_expr_seq(&mut iter, state)\n+    never_loop_expr_seq(&mut iter, main_loop_id)\n }\n \n fn stmt_to_expr(stmt: &Stmt) -> Option<&Expr> {\n@@ -517,7 +557,7 @@ fn decl_to_expr(decl: &Decl) -> Option<&Expr> {\n     }\n }\n \n-fn never_loop_expr(expr: &Expr, state: &mut NeverLoopState) -> bool {\n+fn never_loop_expr(expr: &Expr, main_loop_id: &NodeId) -> NeverLoopResult {\n     match expr.node {\n         ExprBox(ref e) |\n         ExprUnary(_, ref e) |\n@@ -526,77 +566,84 @@ fn never_loop_expr(expr: &Expr, state: &mut NeverLoopState) -> bool {\n         ExprField(ref e, _) |\n         ExprTupField(ref e, _) |\n         ExprAddrOf(_, ref e) |\n-        ExprRepeat(ref e, _) => never_loop_expr(e, state),\n+        ExprStruct(_, _, Some(ref e)) |\n+        ExprRepeat(ref e, _) => never_loop_expr(e, main_loop_id),\n         ExprArray(ref es) | ExprMethodCall(_, _, ref es) | ExprTup(ref es) => {\n-            never_loop_expr_seq(&mut es.iter(), state)\n+            never_loop_expr_all(&mut es.iter(), main_loop_id)\n         },\n-        ExprCall(ref e, ref es) => never_loop_expr_seq(&mut once(&**e).chain(es.iter()), state),\n+        ExprCall(ref e, ref es) => never_loop_expr_all(&mut once(&**e).chain(es.iter()), main_loop_id),\n         ExprBinary(_, ref e1, ref e2) |\n         ExprAssign(ref e1, ref e2) |\n         ExprAssignOp(_, ref e1, ref e2) |\n-        ExprIndex(ref e1, ref e2) => never_loop_expr_seq(&mut [&**e1, &**e2].iter().cloned(), state),\n+        ExprIndex(ref e1, ref e2) => never_loop_expr_all(&mut [&**e1, &**e2].iter().cloned(), main_loop_id),\n         ExprIf(ref e, ref e2, ref e3) => {\n-            let e1 = never_loop_expr(e, state);\n-            let e2 = never_loop_expr(e2, state);\n-            match *e3 {\n-                Some(ref e3) => {\n-                    let e3 = never_loop_expr(e3, state);\n-                    e1 && (e2 || e3)\n-                },\n-                None => e1,\n-            }\n+            let e1 = never_loop_expr(e, main_loop_id);\n+            let e2 = never_loop_expr(e2, main_loop_id);\n+            let e3 = e3.as_ref().map_or(NeverLoopResult::Otherwise, |e| never_loop_expr(e, main_loop_id));\n+            combine_seq(e1, combine_branches(e2, e3))\n         },\n         ExprLoop(ref b, _, _) => {\n-            let block_may_complete = never_loop_block(b, state);\n-            let has_break = state.breaks.remove(&expr.id);\n-            state.continues.remove(&expr.id);\n-            block_may_complete || has_break\n+            // Break can come from the inner loop so remove them.\n+            absorb_break(&never_loop_block(b, main_loop_id))\n         },\n         ExprWhile(ref e, ref b, _) => {\n-            let e = never_loop_expr(e, state);\n-            let block_may_complete = never_loop_block(b, state);\n-            let has_break = state.breaks.remove(&expr.id);\n-            let has_continue = state.continues.remove(&expr.id);\n-            e && (block_may_complete || has_break || has_continue)\n+            let e = never_loop_expr(e, main_loop_id);\n+            let result = never_loop_block(b, main_loop_id);\n+            // Break can come from the inner loop so remove them.\n+            combine_seq(e, absorb_break(&result))\n         },\n         ExprMatch(ref e, ref arms, _) => {\n-            let e = never_loop_expr(e, state);\n-            let arms = never_loop_expr_branch(&mut arms.iter().map(|a| &*a.body), state);\n-            e && arms\n+            let e = never_loop_expr(e, main_loop_id);\n+            if arms.is_empty() {\n+                e\n+            } else {\n+                let arms = never_loop_expr_branch(&mut arms.iter().map(|a| &*a.body), main_loop_id);\n+                combine_seq(e, arms)\n+            }\n         },\n-        ExprBlock(ref b) => never_loop_block(b, state),\n+        ExprBlock(ref b) => never_loop_block(b, main_loop_id),\n         ExprAgain(d) => {\n             let id = d.target_id\n                 .opt_id()\n                 .expect(\"target id can only be missing in the presence of compilation errors\");\n-            state.continues.insert(id);\n-            false\n+            if id == *main_loop_id {\n+                NeverLoopResult::MayContinueMainLoop\n+            } else {\n+                NeverLoopResult::AlwaysBreak\n+            }\n         },\n-        ExprBreak(d, _) => {\n-            let id = d.target_id\n-                .opt_id()\n-                .expect(\"target id can only be missing in the presence of compilation errors\");\n-            state.breaks.insert(id);\n-            false\n+        ExprBreak(_, _) => {\n+            NeverLoopResult::AlwaysBreak\n         },\n         ExprRet(ref e) => {\n             if let Some(ref e) = *e {\n-                never_loop_expr(e, state);\n+                combine_seq(never_loop_expr(e, main_loop_id), NeverLoopResult::AlwaysBreak)\n+            } else {\n+                NeverLoopResult::AlwaysBreak\n             }\n-            false\n         },\n-        _ => true,\n+        ExprStruct(_, _, None) |\n+        ExprYield(_) |\n+        ExprClosure(_, _, _, _, _) |\n+        ExprInlineAsm(_, _, _) |\n+        ExprPath(_) |\n+        ExprLit(_) => NeverLoopResult::Otherwise,\n     }\n }\n \n-fn never_loop_expr_seq<'a, T: Iterator<Item = &'a Expr>>(es: &mut T, state: &mut NeverLoopState) -> bool {\n-    es.map(|e| never_loop_expr(e, state))\n-        .fold(true, |a, b| a && b)\n+fn never_loop_expr_seq<'a, T: Iterator<Item=&'a Expr>>(es: &mut T, main_loop_id: &NodeId) -> NeverLoopResult {\n+    es.map(|e| never_loop_expr(e, main_loop_id))\n+        .fold(NeverLoopResult::Otherwise, combine_seq)\n+}\n+\n+fn never_loop_expr_all<'a, T: Iterator<Item=&'a Expr>>(es: &mut T, main_loop_id: &NodeId) -> NeverLoopResult {\n+    es.map(|e| never_loop_expr(e, main_loop_id))\n+        .fold(NeverLoopResult::Otherwise, combine_both)\n }\n \n-fn never_loop_expr_branch<'a, T: Iterator<Item = &'a Expr>>(e: &mut T, state: &mut NeverLoopState) -> bool {\n-    e.map(|e| never_loop_expr(e, state))\n-        .fold(false, |a, b| a || b)\n+fn never_loop_expr_branch<'a, T: Iterator<Item=&'a Expr>>(e: &mut T, main_loop_id: &NodeId) -> NeverLoopResult {\n+    e.map(|e| never_loop_expr(e, main_loop_id))\n+        .fold(NeverLoopResult::AlwaysBreak, combine_branches)\n }\n \n fn check_for_loop<'a, 'tcx>("}, {"sha": "b7c671c0c4854f17cd250f2cf6e16f09a73261fb", "filename": "clippy_lints/src/strings.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/410760d889a15bba2398fd7f07df513e5317e101/clippy_lints%2Fsrc%2Fstrings.rs", "raw_url": "https://github.com/rust-lang/rust/raw/410760d889a15bba2398fd7f07df513e5317e101/clippy_lints%2Fsrc%2Fstrings.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fstrings.rs?ref=410760d889a15bba2398fd7f07df513e5317e101", "patch": "@@ -144,7 +144,6 @@ impl LintPass for StringLitAsBytes {\n \n impl<'a, 'tcx> LateLintPass<'a, 'tcx> for StringLitAsBytes {\n     fn check_expr(&mut self, cx: &LateContext<'a, 'tcx>, e: &'tcx Expr) {\n-        use std::ascii::AsciiExt;\n         use syntax::ast::LitKind;\n         use utils::{in_macro, snippet};\n "}, {"sha": "2712db2bd318657e7af092f798838e08c51f04b4", "filename": "tests/ui/never_loop.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/410760d889a15bba2398fd7f07df513e5317e101/tests%2Fui%2Fnever_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/410760d889a15bba2398fd7f07df513e5317e101/tests%2Fui%2Fnever_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fnever_loop.rs?ref=410760d889a15bba2398fd7f07df513e5317e101", "patch": "@@ -152,6 +152,15 @@ pub fn test14() {\n     }\n }\n \n+// Issue #1991: the outter loop should not warn.\n+pub fn test15() {\n+    'label: loop {\n+        while false {\n+            break 'label;\n+        }\n+    }\n+}\n+\n fn main() {\n     test1();\n     test2();"}, {"sha": "1f9df6f9ccc99820fdaa0e985549600a1326cea1", "filename": "tests/ui/never_loop.stderr", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/410760d889a15bba2398fd7f07df513e5317e101/tests%2Fui%2Fnever_loop.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/410760d889a15bba2398fd7f07df513e5317e101/tests%2Fui%2Fnever_loop.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fnever_loop.stderr?ref=410760d889a15bba2398fd7f07df513e5317e101", "patch": "@@ -80,3 +80,11 @@ error: this loop never actually loops\n 152 | |     }\n     | |_____^\n \n+error: this loop never actually loops\n+   --> $DIR/never_loop.rs:158:9\n+    |\n+158 | /         while false {\n+159 | |             break 'label;\n+160 | |         }\n+    | |_________^\n+"}, {"sha": "870a12ee4c45d9b2e6a6acf07bb04475b63632ec", "filename": "tests/ui/unicode.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/410760d889a15bba2398fd7f07df513e5317e101/tests%2Fui%2Funicode.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/410760d889a15bba2398fd7f07df513e5317e101/tests%2Fui%2Funicode.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Funicode.stderr?ref=410760d889a15bba2398fd7f07df513e5317e101", "patch": "@@ -2,7 +2,7 @@ error: zero-width space detected\n  --> $DIR/unicode.rs:6:12\n   |\n 6 |     print!(\"Here >\u200b< is a ZWS, and \u200banother\");\n-  |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+  |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n   |\n   = note: `-D zero-width-space` implied by `-D warnings`\n   = help: Consider replacing the string with:\n@@ -12,7 +12,7 @@ error: non-nfc unicode sequence detected\n   --> $DIR/unicode.rs:12:12\n    |\n 12 |     print!(\"\u0300a\u0300h?\");\n-   |            ^^^^^^^\n+   |            ^^^^^\n    |\n    = note: `-D unicode-not-nfc` implied by `-D warnings`\n    = help: Consider replacing the string with:"}]}