{"sha": "a31933e4b58f3520a04b99ee60acbabf5695d91e", "node_id": "MDY6Q29tbWl0NzI0NzEyOmEzMTkzM2U0YjU4ZjM1MjBhMDRiOTllZTYwYWNiYWJmNTY5NWQ5MWU=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-09-12T08:45:33Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-09-12T08:45:33Z"}, "message": "add quiet mode to analysis-stats", "tree": {"sha": "f34a9bc7eb5f8b12cbb4d74d13ef1b70b53c358b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f34a9bc7eb5f8b12cbb4d74d13ef1b70b53c358b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a31933e4b58f3520a04b99ee60acbabf5695d91e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a31933e4b58f3520a04b99ee60acbabf5695d91e", "html_url": "https://github.com/rust-lang/rust/commit/a31933e4b58f3520a04b99ee60acbabf5695d91e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a31933e4b58f3520a04b99ee60acbabf5695d91e/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7828f43303ea03810cd5cfe47297a8d95b6ceb51", "url": "https://api.github.com/repos/rust-lang/rust/commits/7828f43303ea03810cd5cfe47297a8d95b6ceb51", "html_url": "https://github.com/rust-lang/rust/commit/7828f43303ea03810cd5cfe47297a8d95b6ceb51"}], "stats": {"total": 198, "additions": 116, "deletions": 82}, "files": [{"sha": "8f4ce42da5dea404597db9eae7a4d5a9bdef8b17", "filename": "crates/ra_cli/src/analysis_stats.rs", "status": "modified", "additions": 17, "deletions": 8, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/a31933e4b58f3520a04b99ee60acbabf5695d91e/crates%2Fra_cli%2Fsrc%2Fanalysis_stats.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a31933e4b58f3520a04b99ee60acbabf5695d91e/crates%2Fra_cli%2Fsrc%2Fanalysis_stats.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_cli%2Fsrc%2Fanalysis_stats.rs?ref=a31933e4b58f3520a04b99ee60acbabf5695d91e", "patch": "@@ -4,9 +4,14 @@ use ra_db::SourceDatabase;\n use ra_hir::{Crate, HasBodySource, HasSource, HirDisplay, ImplItem, ModuleDef, Ty, TypeWalk};\n use ra_syntax::AstNode;\n \n-use crate::Result;\n+use crate::{Result, Verbosity};\n \n-pub fn run(verbose: bool, memory_usage: bool, path: &Path, only: Option<&str>) -> Result<()> {\n+pub fn run(\n+    verbosity: Verbosity,\n+    memory_usage: bool,\n+    path: &Path,\n+    only: Option<&str>,\n+) -> Result<()> {\n     let db_load_time = Instant::now();\n     let (mut host, roots) = ra_batch::load_cargo(path)?;\n     let db = host.raw_database();\n@@ -55,10 +60,14 @@ pub fn run(verbose: bool, memory_usage: bool, path: &Path, only: Option<&str>) -\n     println!(\"Item Collection: {:?}, {}\", analysis_time.elapsed(), ra_prof::memory_usage());\n \n     let inference_time = Instant::now();\n-    let bar = indicatif::ProgressBar::with_draw_target(\n-        funcs.len() as u64,\n-        indicatif::ProgressDrawTarget::stderr_nohz(),\n-    );\n+    let bar = match verbosity {\n+        Verbosity::Verbose | Verbosity::Normal => indicatif::ProgressBar::with_draw_target(\n+            funcs.len() as u64,\n+            indicatif::ProgressDrawTarget::stderr_nohz(),\n+        ),\n+        Verbosity::Quiet => indicatif::ProgressBar::hidden(),\n+    };\n+\n     bar.set_style(\n         indicatif::ProgressStyle::default_bar().template(\"{wide_bar} {pos}/{len}\\n{msg}\"),\n     );\n@@ -70,7 +79,7 @@ pub fn run(verbose: bool, memory_usage: bool, path: &Path, only: Option<&str>) -\n     for f in funcs {\n         let name = f.name(db);\n         let mut msg = format!(\"processing: {}\", name);\n-        if verbose {\n+        if verbosity.is_verbose() {\n             let src = f.source(db);\n             let original_file = src.file_id.original_file(db);\n             let path = db.file_relative_path(original_file);\n@@ -103,7 +112,7 @@ pub fn run(verbose: bool, memory_usage: bool, path: &Path, only: Option<&str>) -\n             }\n             if let Some(mismatch) = inference_result.type_mismatch_for_expr(expr_id) {\n                 num_type_mismatches += 1;\n-                if verbose {\n+                if verbosity.is_verbose() {\n                     let src = f.expr_source(db, expr_id);\n                     if let Some(src) = src {\n                         // FIXME: it might be nice to have a function (on Analysis?) that goes from Source<T> -> (LineCol, LineCol) directly"}, {"sha": "2a74b8733aeb0637a91d56bbfe536cb20a08908e", "filename": "crates/ra_cli/src/help.rs", "status": "modified", "additions": 73, "deletions": 72, "changes": 145, "blob_url": "https://github.com/rust-lang/rust/blob/a31933e4b58f3520a04b99ee60acbabf5695d91e/crates%2Fra_cli%2Fsrc%2Fhelp.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a31933e4b58f3520a04b99ee60acbabf5695d91e/crates%2Fra_cli%2Fsrc%2Fhelp.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_cli%2Fsrc%2Fhelp.rs?ref=a31933e4b58f3520a04b99ee60acbabf5695d91e", "patch": "@@ -1,72 +1,73 @@\n-pub const GLOBAL_HELP: &str = \"ra-cli\r\n-\r\n-USAGE:\r\n-    ra_cli <SUBCOMMAND>\r\n-\r\n-FLAGS:\r\n-    -h, --help        Prints help information\r\n-\r\n-SUBCOMMANDS:\r\n-    analysis-bench\r\n-    analysis-stats\r\n-    highlight\r\n-    parse\r\n-    symbols\";\r\n-\r\n-pub const ANALYSIS_BENCH_HELP: &str = \"ra_cli-analysis-bench\r\n-\r\n-USAGE:\r\n-    ra_cli analysis-bench [FLAGS] [OPTIONS] [PATH]\r\n-\r\n-FLAGS:\r\n-    -h, --help        Prints help information\r\n-    -v, --verbose\r\n-    \r\n-OPTIONS:\r\n-    --complete <PATH:LINE:COLUMN>    Compute completions at this location\r\n-    --highlight <PATH>               Hightlight this file\r\n-    \r\n-ARGS:\r\n-    <PATH>    Project to analyse\";\r\n-\r\n-pub const ANALYSIS_STATS_HELP: &str = \"ra-cli-analysis-stats\r\n-\r\n-USAGE:\r\n-    ra_cli analysis-stats [FLAGS] [OPTIONS] [PATH]\r\n-    \r\n-FLAGS:\r\n-    -h, --help            Prints help information\r\n-        --memory-usage\r\n-    -v, --verbose\r\n-    \r\n-OPTIONS:\r\n-    -o <ONLY>\r\n-    \r\n-ARGS:\r\n-    <PATH>\";\r\n-\r\n-pub const HIGHLIGHT_HELP: &str = \"ra-cli-highlight\r\n-    \r\n-USAGE:\r\n-    ra_cli highlight [FLAGS]\r\n-    \r\n-FLAGS:\r\n-    -h, --help       Prints help information\r\n-    -r, --rainbow\";\r\n-\r\n-pub const SYMBOLS_HELP: &str = \"ra-cli-symbols\r\n-    \r\n-USAGE:\r\n-    ra_cli highlight [FLAGS]\r\n-    \r\n-FLAGS:\r\n-    -h, --help    Prints help inforamtion\";\r\n-\r\n-pub const PARSE_HELP: &str = \"ra-cli-parse\r\n-    \r\n-USAGE:\r\n-    ra_cli parse [FLAGS]\r\n-    \r\n-FLAGS:\r\n-    -h, --help       Prints help inforamtion\r\n-        --no-dump\";\r\n+pub const GLOBAL_HELP: &str = \"ra-cli\n+\n+USAGE:\n+    ra_cli <SUBCOMMAND>\n+\n+FLAGS:\n+    -h, --help        Prints help information\n+\n+SUBCOMMANDS:\n+    analysis-bench\n+    analysis-stats\n+    highlight\n+    parse\n+    symbols\";\n+\n+pub const ANALYSIS_BENCH_HELP: &str = \"ra_cli-analysis-bench\n+\n+USAGE:\n+    ra_cli analysis-bench [FLAGS] [OPTIONS] [PATH]\n+\n+FLAGS:\n+    -h, --help        Prints help information\n+    -v, --verbose\n+\n+OPTIONS:\n+    --complete <PATH:LINE:COLUMN>    Compute completions at this location\n+    --highlight <PATH>               Hightlight this file\n+\n+ARGS:\n+    <PATH>    Project to analyse\";\n+\n+pub const ANALYSIS_STATS_HELP: &str = \"ra-cli-analysis-stats\n+\n+USAGE:\n+    ra_cli analysis-stats [FLAGS] [OPTIONS] [PATH]\n+\n+FLAGS:\n+    -h, --help            Prints help information\n+        --memory-usage\n+    -v, --verbose\n+    -q, --quiet\n+\n+OPTIONS:\n+    -o <ONLY>\n+\n+ARGS:\n+    <PATH>\";\n+\n+pub const HIGHLIGHT_HELP: &str = \"ra-cli-highlight\n+\n+USAGE:\n+    ra_cli highlight [FLAGS]\n+\n+FLAGS:\n+    -h, --help       Prints help information\n+    -r, --rainbow\";\n+\n+pub const SYMBOLS_HELP: &str = \"ra-cli-symbols\n+\n+USAGE:\n+    ra_cli highlight [FLAGS]\n+\n+FLAGS:\n+    -h, --help    Prints help inforamtion\";\n+\n+pub const PARSE_HELP: &str = \"ra-cli-parse\n+\n+USAGE:\n+    ra_cli parse [FLAGS]\n+\n+FLAGS:\n+    -h, --help       Prints help inforamtion\n+        --no-dump\";"}, {"sha": "ca9275cd45c786dd718ea30b25a3a62200473b1e", "filename": "crates/ra_cli/src/main.rs", "status": "modified", "additions": 26, "deletions": 2, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/a31933e4b58f3520a04b99ee60acbabf5695d91e/crates%2Fra_cli%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a31933e4b58f3520a04b99ee60acbabf5695d91e/crates%2Fra_cli%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_cli%2Fsrc%2Fmain.rs?ref=a31933e4b58f3520a04b99ee60acbabf5695d91e", "patch": "@@ -12,6 +12,22 @@ use ra_syntax::{AstNode, SourceFile};\n \n type Result<T> = std::result::Result<T, Box<dyn Error + Send + Sync>>;\n \n+#[derive(Clone, Copy)]\n+pub enum Verbosity {\n+    Verbose,\n+    Normal,\n+    Quiet,\n+}\n+\n+impl Verbosity {\n+    fn is_verbose(&self) -> bool {\n+        match self {\n+            Verbosity::Verbose => true,\n+            _ => false,\n+        }\n+    }\n+}\n+\n fn main() -> Result<()> {\n     Logger::with_env().start()?;\n \n@@ -67,7 +83,15 @@ fn main() -> Result<()> {\n                 eprintln!(\"{}\", help::ANALYSIS_STATS_HELP);\n                 return Ok(());\n             }\n-            let verbose = matches.contains([\"-v\", \"--verbose\"]);\n+            let verbosity = match (\n+                matches.contains([\"-v\", \"--verbose\"]),\n+                matches.contains([\"-q\", \"--quiet\"]),\n+            ) {\n+                (false, false) => Verbosity::Normal,\n+                (false, true) => Verbosity::Quiet,\n+                (true, false) => Verbosity::Verbose,\n+                (true, true) => Err(\"Invalid flags: -q conflicts with -v\")?,\n+            };\n             let memory_usage = matches.contains(\"--memory-usage\");\n             let only = matches.value_from_str([\"-o\", \"--only\"])?.map(|v: String| v.to_owned());\n             let path = {\n@@ -79,7 +103,7 @@ fn main() -> Result<()> {\n                 trailing.pop().unwrap()\n             };\n             analysis_stats::run(\n-                verbose,\n+                verbosity,\n                 memory_usage,\n                 path.as_ref(),\n                 only.as_ref().map(String::as_ref),"}]}