{"sha": "5e01ba36c9f1037c4cf3e7421413fc6c41f85d05", "node_id": "C_kwDOAAsO6NoAKDVlMDFiYTM2YzlmMTAzN2M0Y2YzZTc0MjE0MTNmYzZjNDFmODVkMDU", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume.gomez@huawei.com", "date": "2022-05-10T14:09:41Z"}, "committer": {"name": "Guillaume Gomez", "email": "guillaume.gomez@huawei.com", "date": "2022-05-14T15:21:52Z"}, "message": "Improve settings menu display", "tree": {"sha": "ac6728ed03e920f49834b83efc07635063354b9f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ac6728ed03e920f49834b83efc07635063354b9f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5e01ba36c9f1037c4cf3e7421413fc6c41f85d05", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5e01ba36c9f1037c4cf3e7421413fc6c41f85d05", "html_url": "https://github.com/rust-lang/rust/commit/5e01ba36c9f1037c4cf3e7421413fc6c41f85d05", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5e01ba36c9f1037c4cf3e7421413fc6c41f85d05/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "17180f4a56aedfb5fa2daa0973c85784c361c339", "url": "https://api.github.com/repos/rust-lang/rust/commits/17180f4a56aedfb5fa2daa0973c85784c361c339", "html_url": "https://github.com/rust-lang/rust/commit/17180f4a56aedfb5fa2daa0973c85784c361c339"}], "stats": {"total": 141, "additions": 110, "deletions": 31}, "files": [{"sha": "57c2ba8611443a8d3c3b7f0f9c7a2453882a1858", "filename": "src/librustdoc/html/static/css/rustdoc.css", "status": "modified", "additions": 33, "deletions": 0, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/5e01ba36c9f1037c4cf3e7421413fc6c41f85d05/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Frustdoc.css", "raw_url": "https://github.com/rust-lang/rust/raw/5e01ba36c9f1037c4cf3e7421413fc6c41f85d05/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Frustdoc.css", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Frustdoc.css?ref=5e01ba36c9f1037c4cf3e7421413fc6c41f85d05", "patch": "@@ -1404,6 +1404,15 @@ pre.rust {\n \tborder-radius: 2px;\n \tcursor: pointer;\n }\n+#settings-menu {\n+\tpadding: 0;\n+}\n+#settings-menu > a {\n+\tpadding: 5px;\n+\twidth: 100%;\n+\theight: 100%;\n+\tdisplay: block;\n+}\n \n @keyframes rotating {\n \tfrom {\n@@ -1416,6 +1425,30 @@ pre.rust {\n #settings-menu.rotate img {\n \tanimation: rotating 2s linear infinite;\n }\n+#settings-menu #settings {\n+\tposition: absolute;\n+\tright: 0;\n+\tz-index: 1;\n+\tdisplay: block;\n+\tmargin-top: 7px;\n+\tborder-radius: 3px;\n+\tborder: 1px solid;\n+}\n+#settings-menu #settings .setting-line {\n+\tmargin: 0.6em;\n+}\n+/* This rule is to draw the little arrow connecting the settings menu to the gear icon. */\n+#settings-menu #settings::before {\n+\tcontent: '';\n+\tposition: absolute;\n+\tright: 11px;\n+\tborder: solid;\n+\tborder-width: 1px 1px 0 0;\n+\tdisplay: inline-block;\n+\tpadding: 4px;\n+\ttransform: rotate(-45deg);\n+\ttop: -5px;\n+}\n \n #help-button {\n \tfont-family: \"Fira Sans\", Arial, sans-serif;"}, {"sha": "ad8f642152babd9c23b23e4c739d8384234d160e", "filename": "src/librustdoc/html/static/css/themes/ayu.css", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/5e01ba36c9f1037c4cf3e7421413fc6c41f85d05/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Fthemes%2Fayu.css", "raw_url": "https://github.com/rust-lang/rust/raw/5e01ba36c9f1037c4cf3e7421413fc6c41f85d05/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Fthemes%2Fayu.css", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Fthemes%2Fayu.css?ref=5e01ba36c9f1037c4cf3e7421413fc6c41f85d05", "patch": "@@ -5,7 +5,7 @@ Original by Dempfi (https://github.com/dempfi/ayu)\n \n /* General structure and fonts */\n \n-body {\n+body, #settings-menu #settings, #settings-menu #settings::before {\n \tbackground-color: #0f1419;\n \tcolor: #c5c5c5;\n }\n@@ -541,6 +541,10 @@ kbd {\n \tfilter: invert(100);\n }\n \n+#settings-menu #settings, #settings-menu #settings::before {\n+\tborder-color: #5c6773;\n+}\n+\n #copy-path {\n \tcolor: #fff;\n }"}, {"sha": "dc38b04c887893881bcde81525fe4fe0a45259c0", "filename": "src/librustdoc/html/static/css/themes/dark.css", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/5e01ba36c9f1037c4cf3e7421413fc6c41f85d05/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Fthemes%2Fdark.css", "raw_url": "https://github.com/rust-lang/rust/raw/5e01ba36c9f1037c4cf3e7421413fc6c41f85d05/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Fthemes%2Fdark.css", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Fthemes%2Fdark.css?ref=5e01ba36c9f1037c4cf3e7421413fc6c41f85d05", "patch": "@@ -1,4 +1,4 @@\n-body {\n+body, #settings-menu #settings, #settings-menu #settings::before {\n \tbackground-color: #353535;\n \tcolor: #ddd;\n }\n@@ -420,6 +420,10 @@ kbd {\n \tborder-color: #ffb900;\n }\n \n+#settings-menu #settings, #settings-menu #settings::before {\n+\tborder-color: #d2d2d2;\n+}\n+\n #copy-path {\n \tcolor: #999;\n }"}, {"sha": "48f67af040e6d8dbab0505266b5c9b5e8a8d0b40", "filename": "src/librustdoc/html/static/css/themes/light.css", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/5e01ba36c9f1037c4cf3e7421413fc6c41f85d05/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Fthemes%2Flight.css", "raw_url": "https://github.com/rust-lang/rust/raw/5e01ba36c9f1037c4cf3e7421413fc6c41f85d05/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Fthemes%2Flight.css", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Fthemes%2Flight.css?ref=5e01ba36c9f1037c4cf3e7421413fc6c41f85d05", "patch": "@@ -1,6 +1,6 @@\n /* General structure and fonts */\n \n-body {\n+body, #settings-menu #settings, #settings-menu #settings::before {\n \tbackground-color: white;\n \tcolor: black;\n }\n@@ -405,6 +405,10 @@ kbd {\n \tborder-color: #717171;\n }\n \n+#settings-menu #settings, #settings-menu #settings::before {\n+\tborder-color: #DDDDDD;\n+}\n+\n #copy-path {\n \tcolor: #999;\n }"}, {"sha": "df828b5ce4c3a35f0b0629b0bcf74b4a19bc0f0c", "filename": "src/librustdoc/html/static/js/settings.js", "status": "modified", "additions": 57, "deletions": 25, "changes": 82, "blob_url": "https://github.com/rust-lang/rust/blob/5e01ba36c9f1037c4cf3e7421413fc6c41f85d05/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsettings.js", "raw_url": "https://github.com/rust-lang/rust/raw/5e01ba36c9f1037c4cf3e7421413fc6c41f85d05/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsettings.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsettings.js?ref=5e01ba36c9f1037c4cf3e7421413fc6c41f85d05", "patch": "@@ -1,7 +1,7 @@\n // Local js definitions:\n /* global getSettingValue, getVirtualKey, updateLocalStorage, updateSystemTheme */\n-/* global addClass, removeClass, onEach, onEachLazy, NOT_DISPLAYED_ID */\n-/* global MAIN_ID, getVar, getSettingsButton, switchDisplayedElement, getNotDisplayedElem */\n+/* global addClass, removeClass, onEach, onEachLazy */\n+/* global MAIN_ID, getVar, getSettingsButton */\n \n \"use strict\";\n \n@@ -206,38 +206,60 @@\n         ];\n \n         // Then we build the DOM.\n-        const el = document.createElement(\"section\");\n-        el.id = \"settings\";\n-        let innerHTML = `\n-            <div class=\"main-heading\">\n+        let innerHTML = \"\";\n+        let elementKind = \"div\";\n+\n+        if (isSettingsPage) {\n+            elementKind = \"section\";\n+            innerHTML = `<div class=\"main-heading\">\n                 <h1 class=\"fqn\">\n                     <span class=\"in-band\">Rustdoc settings</span>\n                 </h1>\n-                <span class=\"out-of-band\">`;\n-\n-        if (isSettingsPage) {\n-            innerHTML +=\n-                \"<a id=\\\"back\\\" href=\\\"javascript:void(0)\\\" onclick=\\\"history.back();\\\">Back</a>\";\n-        } else {\n-            innerHTML += \"<a id=\\\"back\\\" href=\\\"javascript:void(0)\\\" \" +\n-                \"onclick=\\\"switchDisplayedElement(null);\\\">Back</a>\";\n+                <span class=\"out-of-band\">\n+                    <a id=\"back\" href=\"javascript:void(0)\" onclick=\"history.back();\">Back</a>\n+                </span>\n+                </div>`;\n         }\n-        innerHTML += `</span>\n-            </div>\n-            <div class=\"settings\">${buildSettingsPageSections(settings)}</div>`;\n+        innerHTML += `<div class=\"settings\">${buildSettingsPageSections(settings)}</div>`;\n \n+        const el = document.createElement(elementKind);\n+        el.id = \"settings\";\n         el.innerHTML = innerHTML;\n \n         if (isSettingsPage) {\n             document.getElementById(MAIN_ID).appendChild(el);\n         } else {\n-            getNotDisplayedElem().appendChild(el);\n+            el.setAttribute(\"tabindex\", \"-1\");\n+            getSettingsButton().appendChild(el);\n         }\n         return el;\n     }\n \n     const settingsMenu = buildSettingsPage();\n \n+    function displaySettings() {\n+        settingsMenu.style.display = \"\";\n+    }\n+\n+    function elemIsInParent(elem, parent) {\n+        while (elem && elem !== document.body) {\n+            if (elem === parent) {\n+                return true;\n+            }\n+            elem = elem.parentElement;\n+        }\n+        return false;\n+    }\n+\n+    function blurHandler(event) {\n+        const settingsButton = getSettingsButton();\n+        if (!elemIsInParent(document.activeElement, settingsButton) &&\n+            !elemIsInParent(event.relatedTarget, settingsButton))\n+        {\n+            window.hideSettings();\n+        }\n+    }\n+\n     if (isSettingsPage) {\n         // We replace the existing \"onclick\" callback to do nothing if clicked.\n         getSettingsButton().onclick = function(event) {\n@@ -246,25 +268,35 @@\n     } else {\n         // We replace the existing \"onclick\" callback.\n         const settingsButton = getSettingsButton();\n+        const settingsMenu = document.getElementById(\"settings\");\n+        window.hideSettings = function() {\n+            settingsMenu.style.display = \"none\";\n+        };\n         settingsButton.onclick = function(event) {\n+            if (elemIsInParent(event.target, settingsMenu)) {\n+                return;\n+            }\n             event.preventDefault();\n-            if (settingsMenu.parentElement.id === NOT_DISPLAYED_ID) {\n-                switchDisplayedElement(settingsMenu);\n-            } else {\n+            if (settingsMenu.style.display !== \"none\") {\n                 window.hideSettings();\n+            } else {\n+                displaySettings();\n             }\n         };\n-        window.hideSettings = function() {\n-            switchDisplayedElement(null);\n-        };\n+        settingsButton.onblur = blurHandler;\n+        settingsButton.querySelector(\"a\").onblur = blurHandler;\n+        onEachLazy(settingsMenu.querySelectorAll(\"input\"), el => {\n+            el.onblur = blurHandler;\n+        });\n+        settingsMenu.onblur = blurHandler;\n     }\n \n     // We now wait a bit for the web browser to end re-computing the DOM...\n     setTimeout(() => {\n         setEvents(settingsMenu);\n         // The setting menu is already displayed if we're on the settings page.\n         if (!isSettingsPage) {\n-            switchDisplayedElement(settingsMenu);\n+            displaySettings();\n         }\n         removeClass(getSettingsButton(), \"rotate\");\n     }, 0);"}, {"sha": "e57d08c9456e1e0d1463fc560401553693f75da6", "filename": "src/librustdoc/html/templates/page.html", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/5e01ba36c9f1037c4cf3e7421413fc6c41f85d05/src%2Flibrustdoc%2Fhtml%2Ftemplates%2Fpage.html", "raw_url": "https://github.com/rust-lang/rust/raw/5e01ba36c9f1037c4cf3e7421413fc6c41f85d05/src%2Flibrustdoc%2Fhtml%2Ftemplates%2Fpage.html", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Ftemplates%2Fpage.html?ref=5e01ba36c9f1037c4cf3e7421413fc6c41f85d05", "patch": "@@ -126,10 +126,12 @@ <h2 class=\"location\"></h2>\n                                 placeholder=\"Click or press \u2018S\u2019 to search, \u2018?\u2019 for more options\u2026\" {# -#}\n                                 type=\"search\"> {#- -#}\n                             <button type=\"button\" id=\"help-button\" title=\"help\">?</button> {#- -#}\n-                            <a id=\"settings-menu\" href=\"{{page.root_path|safe}}settings.html\" title=\"settings\"> {#- -#}\n-                                <img width=\"22\" height=\"22\" alt=\"Change settings\" {# -#}\n+                            <div id=\"settings-menu\" tabindex=\"-1\">\n+                                <a href=\"{{page.root_path|safe}}settings.html\" title=\"settings\"> {#- -#}\n+                                    <img width=\"22\" height=\"22\" alt=\"Change settings\" {# -#}\n                                      src=\"{{static_root_path|safe}}wheel{{page.resource_suffix}}.svg\"> {#- -#}\n-                            </a> {#- -#}\n+                                </a> {#- -#}\n+                            </div>\n                         </div> {#- -#}\n                     </form> {#- -#}\n                 </nav> {#- -#}"}]}