{"sha": "40334da7a6cc0602aa16252cf8f78dc0beb48159", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQwMzM0ZGE3YTZjYzA2MDJhYTE2MjUyY2Y4Zjc4ZGMwYmViNDgxNTk=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-03-29T08:27:59Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-03-29T08:27:59Z"}, "message": "Auto merge of #83565 - RalfJung:miri, r=oli-obk\n\nupdate Miri, and also run test suite with mir-opt-level=4\n\nIn the Miri repo, we run the Miri test suite once with default flags and once with `-O -Zmir-opt-level=4`. This helps identify and document situations where MIR optimizations mask UB -- it is okay for that to happen, but it might be god to look into it when it does happen. Recently these tests failed fairly frequently as new MIR optimizations were added, and since we only run them on the Miri side, it is not even clear which rustc PR introduced the change. So I propose we also run these tests in the rustc repo, such that toolstate tracking will tell us the exact PR (or at least the rollup) that caused the change.\n\nr? `@oli-obk`\nFixes https://github.com/rust-lang/rust/issues/83590", "tree": {"sha": "bb9c99392d2668edbe04b2d782e2dd2e3a61f3d6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bb9c99392d2668edbe04b2d782e2dd2e3a61f3d6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/40334da7a6cc0602aa16252cf8f78dc0beb48159", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/40334da7a6cc0602aa16252cf8f78dc0beb48159", "html_url": "https://github.com/rust-lang/rust/commit/40334da7a6cc0602aa16252cf8f78dc0beb48159", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/40334da7a6cc0602aa16252cf8f78dc0beb48159/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cc4103089f40a163f6d143f06359cba7043da29b", "url": "https://api.github.com/repos/rust-lang/rust/commits/cc4103089f40a163f6d143f06359cba7043da29b", "html_url": "https://github.com/rust-lang/rust/commit/cc4103089f40a163f6d143f06359cba7043da29b"}, {"sha": "a515cfd966d68a5a0a1b2d90425580f81cdabdbf", "url": "https://api.github.com/repos/rust-lang/rust/commits/a515cfd966d68a5a0a1b2d90425580f81cdabdbf", "html_url": "https://github.com/rust-lang/rust/commit/a515cfd966d68a5a0a1b2d90425580f81cdabdbf"}], "stats": {"total": 11, "additions": 9, "deletions": 2}, "files": [{"sha": "b3cf30672c82f330509ecce63145536426b208f8", "filename": "src/bootstrap/test.rs", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/40334da7a6cc0602aa16252cf8f78dc0beb48159/src%2Fbootstrap%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/40334da7a6cc0602aa16252cf8f78dc0beb48159/src%2Fbootstrap%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Ftest.rs?ref=40334da7a6cc0602aa16252cf8f78dc0beb48159", "patch": "@@ -452,7 +452,14 @@ impl Step for Miri {\n \n             cargo.add_rustc_lib_path(builder, compiler);\n \n-            if !try_run(builder, &mut cargo.into()) {\n+            let mut cargo = Command::from(cargo);\n+            if !try_run(builder, &mut cargo) {\n+                return;\n+            }\n+\n+            // # Run `cargo test` with `-Zmir-opt-level=4`.\n+            cargo.env(\"MIRIFLAGS\", \"-O -Zmir-opt-level=4\");\n+            if !try_run(builder, &mut cargo) {\n                 return;\n             }\n "}, {"sha": "2cdd1744b896e8129322229f253f95fd7ad491f1", "filename": "src/tools/miri", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": null, "raw_url": null, "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fmiri?ref=40334da7a6cc0602aa16252cf8f78dc0beb48159", "patch": "@@ -1 +1 @@\n-Subproject commit 12dac5c0f7acd106401aa14fec758f0ff552f678\n+Subproject commit 2cdd1744b896e8129322229f253f95fd7ad491f1"}]}