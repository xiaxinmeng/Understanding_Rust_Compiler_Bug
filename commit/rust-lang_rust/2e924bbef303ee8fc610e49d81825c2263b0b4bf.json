{"sha": "2e924bbef303ee8fc610e49d81825c2263b0b4bf", "node_id": "C_kwDOAAsO6NoAKDJlOTI0YmJlZjMwM2VlOGZjNjEwZTQ5ZDgxODI1YzIyNjNiMGI0YmY", "commit": {"author": {"name": "Arpad Borsos", "email": "swatinem@swatinem.de", "date": "2022-10-28T09:43:30Z"}, "committer": {"name": "Arpad Borsos", "email": "arpad.borsos@sentry.io", "date": "2023-03-31T12:01:53Z"}, "message": "Stabilize rustdoc `--test-run-directory`", "tree": {"sha": "fc473fe3184d9003cbfb2c1c9f74d07ab98f90c5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fc473fe3184d9003cbfb2c1c9f74d07ab98f90c5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2e924bbef303ee8fc610e49d81825c2263b0b4bf", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEGpY8kJL+amSMRbJCVw8gFjFZy1UFAmQmy7YACgkQVw8gFjFZ\ny1We/A/+InGdBiDjPaI2IWDnWWbqjx8ZODTE9cOsKDXrpXxsglE4K/EqPhbBm9aT\nNOgqy6BJUYkwwL4UBgFehvrh0KHsu96ajml8XQtxQYAQg9ILKCfayy5ZhWjz5oTA\nWRMayYJ4wNaxvm1Pf7Zg66/+GSdENX8a6RxgJ6q5cWVZZ0X4pDZBwmnxCgfZhxE2\nw2YzAo9nFPrtBbENgxOE+aY9Mpi5Gfd4bkW7ciB+WFz3EG5E0BGEWaIgtU/5phOl\n24oi6w/ODTbw7/Lyq9qiUhdoO7yc0m5PhyjWIGCHlzxexdn61/poPlV6sFD8eUbk\nvCbiqEHTKpI3KhtkGhwCxqt2wJcyTBwiMQJsB/CldrfDQW2hp78SQ5VW98AQfvB/\n7o6kC6j+bfCGBCqWrLHDX7EPqEnjj/tG7aC+aiY4h3qGPxkW+q2/ZekiGjWh0I7t\nWnC5bm7ja4PsIhjP8DgRMqyTeUTICSvRDu95YD7NGdOwe8H0t+T1efDSzr/EEdqW\nU5e0p4AzgJj4cJTIwY1LOiyLidPdxtLxw4IndRs9oHyjA2nyKILY/Gr8IvkRsTS4\neO0yJgcLLJ5VcWDPjPA8fjMPKsAxrYgknqGeBdTmvWTmv8mVflyFzXdx3WSLnSlC\nfJ8aWI7zIMtsD/Sd0f6or7iVG2IcmcpQ2AfAw2ETaANnRQO1FaU=\n=0Mnd\n-----END PGP SIGNATURE-----", "payload": "tree fc473fe3184d9003cbfb2c1c9f74d07ab98f90c5\nparent cf32b9de1e8f66526c36ad2927458558d2e81093\nauthor Arpad Borsos <swatinem@swatinem.de> 1666950210 +0200\ncommitter Arpad Borsos <arpad.borsos@sentry.io> 1680264113 +0200\n\nStabilize rustdoc `--test-run-directory`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2e924bbef303ee8fc610e49d81825c2263b0b4bf", "html_url": "https://github.com/rust-lang/rust/commit/2e924bbef303ee8fc610e49d81825c2263b0b4bf", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2e924bbef303ee8fc610e49d81825c2263b0b4bf/comments", "author": {"login": "Swatinem", "id": 580492, "node_id": "MDQ6VXNlcjU4MDQ5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/580492?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Swatinem", "html_url": "https://github.com/Swatinem", "followers_url": "https://api.github.com/users/Swatinem/followers", "following_url": "https://api.github.com/users/Swatinem/following{/other_user}", "gists_url": "https://api.github.com/users/Swatinem/gists{/gist_id}", "starred_url": "https://api.github.com/users/Swatinem/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Swatinem/subscriptions", "organizations_url": "https://api.github.com/users/Swatinem/orgs", "repos_url": "https://api.github.com/users/Swatinem/repos", "events_url": "https://api.github.com/users/Swatinem/events{/privacy}", "received_events_url": "https://api.github.com/users/Swatinem/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Swatinem", "id": 580492, "node_id": "MDQ6VXNlcjU4MDQ5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/580492?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Swatinem", "html_url": "https://github.com/Swatinem", "followers_url": "https://api.github.com/users/Swatinem/followers", "following_url": "https://api.github.com/users/Swatinem/following{/other_user}", "gists_url": "https://api.github.com/users/Swatinem/gists{/gist_id}", "starred_url": "https://api.github.com/users/Swatinem/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Swatinem/subscriptions", "organizations_url": "https://api.github.com/users/Swatinem/orgs", "repos_url": "https://api.github.com/users/Swatinem/repos", "events_url": "https://api.github.com/users/Swatinem/events{/privacy}", "received_events_url": "https://api.github.com/users/Swatinem/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cf32b9de1e8f66526c36ad2927458558d2e81093", "url": "https://api.github.com/repos/rust-lang/rust/commits/cf32b9de1e8f66526c36ad2927458558d2e81093", "html_url": "https://github.com/rust-lang/rust/commit/cf32b9de1e8f66526c36ad2927458558d2e81093"}], "stats": {"total": 33, "additions": 29, "deletions": 4}, "files": [{"sha": "e80ee08aa3051d2a5a2a32e14bfa88487ea3db94", "filename": "src/doc/rustdoc/src/command-line-arguments.md", "status": "modified", "additions": 14, "deletions": 1, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/2e924bbef303ee8fc610e49d81825c2263b0b4bf/src%2Fdoc%2Frustdoc%2Fsrc%2Fcommand-line-arguments.md", "raw_url": "https://github.com/rust-lang/rust/raw/2e924bbef303ee8fc610e49d81825c2263b0b4bf/src%2Fdoc%2Frustdoc%2Fsrc%2Fcommand-line-arguments.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Frustdoc%2Fsrc%2Fcommand-line-arguments.md?ref=2e924bbef303ee8fc610e49d81825c2263b0b4bf", "patch": "@@ -179,7 +179,7 @@ $ rustdoc src/lib.rs --test\n This flag will run your code examples as tests. For more, see [the chapter\n on documentation tests](write-documentation/documentation-tests.md).\n \n-See also `--test-args`.\n+See also `--test-args` and `--test-run-directory`.\n \n ## `--test-args`: pass options to test runner\n \n@@ -194,6 +194,19 @@ For more, see [the chapter on documentation tests](write-documentation/documenta\n \n See also `--test`.\n \n+## `--test-run-directory`: run code examples in a specific directory\n+\n+Using this flag looks like this:\n+\n+```bash\n+$ rustdoc src/lib.rs --test --test-run-directory=/path/to/working/directory\n+```\n+\n+This flag will run your code examples in the specified working directory.\n+For more, see [the chapter on documentation tests](write-documentation/documentation-tests.md).\n+\n+See also `--test`.\n+\n ## `--target`: generate documentation for the specified target triple\n \n Using this flag looks like this:"}, {"sha": "a7d3186fb78b7afcea61203d90046840fa405aa2", "filename": "src/doc/rustdoc/src/write-documentation/documentation-tests.md", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/2e924bbef303ee8fc610e49d81825c2263b0b4bf/src%2Fdoc%2Frustdoc%2Fsrc%2Fwrite-documentation%2Fdocumentation-tests.md", "raw_url": "https://github.com/rust-lang/rust/raw/2e924bbef303ee8fc610e49d81825c2263b0b4bf/src%2Fdoc%2Frustdoc%2Fsrc%2Fwrite-documentation%2Fdocumentation-tests.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Frustdoc%2Fsrc%2Fwrite-documentation%2Fdocumentation-tests.md?ref=2e924bbef303ee8fc610e49d81825c2263b0b4bf", "patch": "@@ -443,3 +443,15 @@ pub struct ReadmeDoctests;\n \n This will include your README as documentation on the hidden struct `ReadmeDoctests`, which will\n then be tested alongside the rest of your doctests.\n+\n+## Controlling the compilation and run directories\n+\n+By default, `rustdoc --test` will compile and run documentation test examples\n+from the same working directory.\n+The compilation directory is being used for compiler diagnostics, the `file!()` macro and\n+the output of `rustdoc` test runner itself, whereas the run directory has an influence on file-system\n+operations within documentation test examples, such as `std::fs::read_to_string`.\n+\n+The `--test-run-directory` flag allows controlling the run directory separately from the compilation directory.\n+This is particularly useful in workspaces, where compiler invocations and thus diagnostics should be\n+relative to the workspace directory, but documentation test examples should run relative to the crate directory."}, {"sha": "6d78bd6b9a77add307505762260f377973ca323d", "filename": "src/librustdoc/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/2e924bbef303ee8fc610e49d81825c2263b0b4bf/src%2Flibrustdoc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2e924bbef303ee8fc610e49d81825c2263b0b4bf/src%2Flibrustdoc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Flib.rs?ref=2e924bbef303ee8fc610e49d81825c2263b0b4bf", "patch": "@@ -284,7 +284,7 @@ fn opts() -> Vec<RustcOptGroup> {\n         stable(\"test-args\", |o| {\n             o.optmulti(\"\", \"test-args\", \"arguments to pass to the test runner\", \"ARGS\")\n         }),\n-        unstable(\"test-run-directory\", |o| {\n+        stable(\"test-run-directory\", |o| {\n             o.optopt(\n                 \"\",\n                 \"test-run-directory\","}, {"sha": "b8d0647f08d8e0d8a35e70f78febb154da8fa0ab", "filename": "tests/rustdoc-ui/run-directory.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/2e924bbef303ee8fc610e49d81825c2263b0b4bf/tests%2Frustdoc-ui%2Frun-directory.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2e924bbef303ee8fc610e49d81825c2263b0b4bf/tests%2Frustdoc-ui%2Frun-directory.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frustdoc-ui%2Frun-directory.rs?ref=2e924bbef303ee8fc610e49d81825c2263b0b4bf", "patch": "@@ -2,8 +2,8 @@\n \n // revisions: correct incorrect\n // check-pass\n-// [correct]compile-flags:--test --test-run-directory={{src-base}} -Zunstable-options\n-// [incorrect]compile-flags:--test --test-run-directory={{src-base}}/coverage -Zunstable-options\n+// [correct]compile-flags:--test --test-run-directory={{src-base}}\n+// [incorrect]compile-flags:--test --test-run-directory={{src-base}}/coverage\n // normalize-stdout-test: \"tests/rustdoc-ui\" -> \"$$DIR\"\n // normalize-stdout-test \"finished in \\d+\\.\\d+s\" -> \"finished in $$TIME\"\n "}]}