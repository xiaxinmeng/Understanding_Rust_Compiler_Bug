{"sha": "3543f58c8449431f072316175da9dbf0a9c68ee4", "node_id": "MDY6Q29tbWl0NzI0NzEyOjM1NDNmNThjODQ0OTQzMWYwNzIzMTYxNzVkYTlkYmYwYTljNjhlZTQ=", "commit": {"author": {"name": "flip1995", "email": "hello@philkrones.com", "date": "2019-05-15T12:57:56Z"}, "committer": {"name": "flip1995", "email": "hello@philkrones.com", "date": "2019-05-15T12:57:56Z"}, "message": "Add macro check for unreadable_literal lint\n\nCloses #4094", "tree": {"sha": "098453058cd6a6c17b4995c973c576916d3c40d5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/098453058cd6a6c17b4995c973c576916d3c40d5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3543f58c8449431f072316175da9dbf0a9c68ee4", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEdgbJzPSa+gJi9jP1Acg2tkD/37EFAlzcDNQACgkQAcg2tkD/\n37HGPg/8CmNUB34NzW8hgaWOAJGGHS12TZfaS8oq+P4FGTxEoIpAc8Ap6A2wdZ+r\nKauFOAezDtCisE0GFoA/6U6QBkUmXu0d2SMdDZ5bFzGiIANH26rgmvT8Kexejq/C\nmVEjWqz/fibV+F78svwKOisZ15gU0EPXI8x4CgDVGnMNNB4Qx6yzKUHv7p6mRQAt\n4jCQ2mT4E8kkglOrjuDTRbnUVqQ2uGmwajKQknVvKcZ2X7egjCd5K7i0MzoyJq4B\n8SCLzfrYTlJsQe6KPLQ2gdapSR/MI/F0SWVNenDQ5lVqZPIQw6HIIVkqvVuTYdGR\nVw+xiUucBop50ABk0ws80kei8kLsQp25tUrLD7o+xzpti1cfTNCGvq9CMFzmM1bc\nppvQ7eNd9vVio888uavBVCJjaOpGOEH2ZdpQ/8PG7LdVKv3NJTP1qoVC8mznWApR\noxnz7xqxGu+83wlZ9QH8zAB3iKa6UqZHY/zwixAkR3PKX+cQGDrFwPfJW2csfccn\ngLG0bY0NMLpSp+QF9h/GI90LP4wKR1F6FJQc9xAWGsV/nhZSIAkF4g9RHJVPJgaD\n8i5NlZcwuSAn+oo4vsxjxX6AK/SCy/D1oTF38StaGOE2FNQJidXWdYvwnQ+6GLgZ\nlylbQIEMUcRdgUq2wE0QCvybpU6GrLVKOJxIZxGg+nc9n/kiyH8=\n=UWfW\n-----END PGP SIGNATURE-----", "payload": "tree 098453058cd6a6c17b4995c973c576916d3c40d5\nparent f49d878ce5aede7e99d284a97cfdca321314ccc2\nauthor flip1995 <hello@philkrones.com> 1557925076 +0200\ncommitter flip1995 <hello@philkrones.com> 1557925076 +0200\n\nAdd macro check for unreadable_literal lint\n\nCloses #4094\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3543f58c8449431f072316175da9dbf0a9c68ee4", "html_url": "https://github.com/rust-lang/rust/commit/3543f58c8449431f072316175da9dbf0a9c68ee4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3543f58c8449431f072316175da9dbf0a9c68ee4/comments", "author": {"login": "flip1995", "id": 9744647, "node_id": "MDQ6VXNlcjk3NDQ2NDc=", "avatar_url": "https://avatars.githubusercontent.com/u/9744647?v=4", "gravatar_id": "", "url": "https://api.github.com/users/flip1995", "html_url": "https://github.com/flip1995", "followers_url": "https://api.github.com/users/flip1995/followers", "following_url": "https://api.github.com/users/flip1995/following{/other_user}", "gists_url": "https://api.github.com/users/flip1995/gists{/gist_id}", "starred_url": "https://api.github.com/users/flip1995/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/flip1995/subscriptions", "organizations_url": "https://api.github.com/users/flip1995/orgs", "repos_url": "https://api.github.com/users/flip1995/repos", "events_url": "https://api.github.com/users/flip1995/events{/privacy}", "received_events_url": "https://api.github.com/users/flip1995/received_events", "type": "User", "site_admin": false}, "committer": {"login": "flip1995", "id": 9744647, "node_id": "MDQ6VXNlcjk3NDQ2NDc=", "avatar_url": "https://avatars.githubusercontent.com/u/9744647?v=4", "gravatar_id": "", "url": "https://api.github.com/users/flip1995", "html_url": "https://github.com/flip1995", "followers_url": "https://api.github.com/users/flip1995/followers", "following_url": "https://api.github.com/users/flip1995/following{/other_user}", "gists_url": "https://api.github.com/users/flip1995/gists{/gist_id}", "starred_url": "https://api.github.com/users/flip1995/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/flip1995/subscriptions", "organizations_url": "https://api.github.com/users/flip1995/orgs", "repos_url": "https://api.github.com/users/flip1995/repos", "events_url": "https://api.github.com/users/flip1995/events{/privacy}", "received_events_url": "https://api.github.com/users/flip1995/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f49d878ce5aede7e99d284a97cfdca321314ccc2", "url": "https://api.github.com/repos/rust-lang/rust/commits/f49d878ce5aede7e99d284a97cfdca321314ccc2", "html_url": "https://github.com/rust-lang/rust/commit/f49d878ce5aede7e99d284a97cfdca321314ccc2"}], "stats": {"total": 51, "additions": 36, "deletions": 15}, "files": [{"sha": "c2892a278d495d6d9d4e96c76d0c856af6a5010b", "filename": "clippy_lints/src/literal_representation.rs", "status": "modified", "additions": 7, "deletions": 6, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/3543f58c8449431f072316175da9dbf0a9c68ee4/clippy_lints%2Fsrc%2Fliteral_representation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3543f58c8449431f072316175da9dbf0a9c68ee4/clippy_lints%2Fsrc%2Fliteral_representation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fliteral_representation.rs?ref=3543f58c8449431f072316175da9dbf0a9c68ee4", "patch": "@@ -1,7 +1,7 @@\n //! Lints concerned with the grouping of digits with underscores in integral or\n //! floating-point literal expressions.\n \n-use crate::utils::{snippet_opt, span_lint_and_sugg};\n+use crate::utils::{in_macro, snippet_opt, span_lint_and_sugg};\n use if_chain::if_chain;\n use rustc::lint::{in_external_macro, EarlyContext, EarlyLintPass, LintArray, LintContext, LintPass};\n use rustc::{declare_lint_pass, declare_tool_lint, impl_lint_pass};\n@@ -355,6 +355,7 @@ impl EarlyLintPass for LiteralDigitGrouping {\n \n impl LiteralDigitGrouping {\n     fn check_lit(self, cx: &EarlyContext<'_>, lit: &Lit) {\n+        let in_macro = in_macro(lit.span);\n         match lit.node {\n             LitKind::Int(..) => {\n                 // Lint integral literals.\n@@ -364,7 +365,7 @@ impl LiteralDigitGrouping {\n                     if char::to_digit(firstch, 10).is_some();\n                     then {\n                         let digit_info = DigitInfo::new(&src, false);\n-                        let _ = Self::do_lint(digit_info.digits, digit_info.suffix).map_err(|warning_type| {\n+                        let _ = Self::do_lint(digit_info.digits, digit_info.suffix, in_macro).map_err(|warning_type| {\n                             warning_type.display(&digit_info.grouping_hint(), cx, lit.span)\n                         });\n                     }\n@@ -386,12 +387,12 @@ impl LiteralDigitGrouping {\n \n                         // Lint integral and fractional parts separately, and then check consistency of digit\n                         // groups if both pass.\n-                        let _ = Self::do_lint(parts[0], digit_info.suffix)\n+                        let _ = Self::do_lint(parts[0], digit_info.suffix, in_macro)\n                             .map(|integral_group_size| {\n                                 if parts.len() > 1 {\n                                     // Lint the fractional part of literal just like integral part, but reversed.\n                                     let fractional_part = &parts[1].chars().rev().collect::<String>();\n-                                    let _ = Self::do_lint(fractional_part, None)\n+                                    let _ = Self::do_lint(fractional_part, None, in_macro)\n                                         .map(|fractional_group_size| {\n                                             let consistent = Self::parts_consistent(integral_group_size,\n                                                                                     fractional_group_size,\n@@ -436,7 +437,7 @@ impl LiteralDigitGrouping {\n \n     /// Performs lint on `digits` (no decimal point) and returns the group\n     /// size on success or `WarningType` when emitting a warning.\n-    fn do_lint(digits: &str, suffix: Option<&str>) -> Result<usize, WarningType> {\n+    fn do_lint(digits: &str, suffix: Option<&str>, in_macro: bool) -> Result<usize, WarningType> {\n         if let Some(suffix) = suffix {\n             if is_mistyped_suffix(suffix) {\n                 return Err(WarningType::MistypedLiteralSuffix);\n@@ -452,7 +453,7 @@ impl LiteralDigitGrouping {\n \n         if underscore_positions.is_empty() {\n             // Check if literal needs underscores.\n-            if digits.len() > 5 {\n+            if !in_macro && digits.len() > 5 {\n                 Err(WarningType::UnreadableLiteral)\n             } else {\n                 Ok(0)"}, {"sha": "679b962756ca41f4fb5eb00145ee9df582c59afa", "filename": "tests/ui/unreadable_literal.fixed", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/3543f58c8449431f072316175da9dbf0a9c68ee4/tests%2Fui%2Funreadable_literal.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/3543f58c8449431f072316175da9dbf0a9c68ee4/tests%2Fui%2Funreadable_literal.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Funreadable_literal.fixed?ref=3543f58c8449431f072316175da9dbf0a9c68ee4", "patch": "@@ -1,5 +1,13 @@\n // run-rustfix\n \n+struct Foo(u64);\n+\n+macro_rules! foo {\n+    () => {\n+        Foo(123123123123)\n+    };\n+}\n+\n #[warn(clippy::unreadable_literal)]\n #[allow(unused_variables)]\n fn main() {\n@@ -22,4 +30,6 @@ fn main() {\n     let fail10: u32 = 0xBAFE_BAFE;\n     let fail11 = 0x0abc_deff;\n     let fail12: i128 = 0x00ab_cabc_abca_bcab_cabc;\n+\n+    let _ = foo!();\n }"}, {"sha": "9922f01aa00f94cf09c7229371ed435aa79bc230", "filename": "tests/ui/unreadable_literal.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/3543f58c8449431f072316175da9dbf0a9c68ee4/tests%2Fui%2Funreadable_literal.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3543f58c8449431f072316175da9dbf0a9c68ee4/tests%2Fui%2Funreadable_literal.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Funreadable_literal.rs?ref=3543f58c8449431f072316175da9dbf0a9c68ee4", "patch": "@@ -1,5 +1,13 @@\n // run-rustfix\n \n+struct Foo(u64);\n+\n+macro_rules! foo {\n+    () => {\n+        Foo(123123123123)\n+    };\n+}\n+\n #[warn(clippy::unreadable_literal)]\n #[allow(unused_variables)]\n fn main() {\n@@ -22,4 +30,6 @@ fn main() {\n     let fail10: u32 = 0xBAFEBAFE;\n     let fail11 = 0xabcdeff;\n     let fail12: i128 = 0xabcabcabcabcabcabc;\n+\n+    let _ = foo!();\n }"}, {"sha": "a31ff75955ca6f7e2e1d8d83ee511c7169f60538", "filename": "tests/ui/unreadable_literal.stderr", "status": "modified", "additions": 9, "deletions": 9, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/3543f58c8449431f072316175da9dbf0a9c68ee4/tests%2Fui%2Funreadable_literal.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/3543f58c8449431f072316175da9dbf0a9c68ee4/tests%2Fui%2Funreadable_literal.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Funreadable_literal.stderr?ref=3543f58c8449431f072316175da9dbf0a9c68ee4", "patch": "@@ -1,55 +1,55 @@\n error: long literal lacking separators\n-  --> $DIR/unreadable_literal.rs:17:16\n+  --> $DIR/unreadable_literal.rs:25:16\n    |\n LL |     let bad = (0b110110_i64, 0x12345678901_usize, 123456_f32, 1.234567_f32);\n    |                ^^^^^^^^^^^^ help: consider: `0b11_0110_i64`\n    |\n    = note: `-D clippy::unreadable-literal` implied by `-D warnings`\n \n error: long literal lacking separators\n-  --> $DIR/unreadable_literal.rs:17:30\n+  --> $DIR/unreadable_literal.rs:25:30\n    |\n LL |     let bad = (0b110110_i64, 0x12345678901_usize, 123456_f32, 1.234567_f32);\n    |                              ^^^^^^^^^^^^^^^^^^^ help: consider: `0x0123_4567_8901_usize`\n \n error: long literal lacking separators\n-  --> $DIR/unreadable_literal.rs:17:51\n+  --> $DIR/unreadable_literal.rs:25:51\n    |\n LL |     let bad = (0b110110_i64, 0x12345678901_usize, 123456_f32, 1.234567_f32);\n    |                                                   ^^^^^^^^^^ help: consider: `123_456_f32`\n \n error: long literal lacking separators\n-  --> $DIR/unreadable_literal.rs:17:63\n+  --> $DIR/unreadable_literal.rs:25:63\n    |\n LL |     let bad = (0b110110_i64, 0x12345678901_usize, 123456_f32, 1.234567_f32);\n    |                                                               ^^^^^^^^^^^^ help: consider: `1.234_567_f32`\n \n error: long literal lacking separators\n-  --> $DIR/unreadable_literal.rs:19:19\n+  --> $DIR/unreadable_literal.rs:27:19\n    |\n LL |     let bad_sci = 1.123456e1;\n    |                   ^^^^^^^^^^ help: consider: `1.123_456e1`\n \n error: long literal lacking separators\n-  --> $DIR/unreadable_literal.rs:21:17\n+  --> $DIR/unreadable_literal.rs:29:17\n    |\n LL |     let fail9 = 0xabcdef;\n    |                 ^^^^^^^^ help: consider: `0x00ab_cdef`\n \n error: long literal lacking separators\n-  --> $DIR/unreadable_literal.rs:22:23\n+  --> $DIR/unreadable_literal.rs:30:23\n    |\n LL |     let fail10: u32 = 0xBAFEBAFE;\n    |                       ^^^^^^^^^^ help: consider: `0xBAFE_BAFE`\n \n error: long literal lacking separators\n-  --> $DIR/unreadable_literal.rs:23:18\n+  --> $DIR/unreadable_literal.rs:31:18\n    |\n LL |     let fail11 = 0xabcdeff;\n    |                  ^^^^^^^^^ help: consider: `0x0abc_deff`\n \n error: long literal lacking separators\n-  --> $DIR/unreadable_literal.rs:24:24\n+  --> $DIR/unreadable_literal.rs:32:24\n    |\n LL |     let fail12: i128 = 0xabcabcabcabcabcabc;\n    |                        ^^^^^^^^^^^^^^^^^^^^ help: consider: `0x00ab_cabc_abca_bcab_cabc`"}]}