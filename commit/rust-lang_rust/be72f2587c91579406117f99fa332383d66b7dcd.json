{"sha": "be72f2587c91579406117f99fa332383d66b7dcd", "node_id": "C_kwDOAAsO6NoAKGJlNzJmMjU4N2M5MTU3OTQwNjExN2Y5OWZhMzMyMzgzZDY2YjdkY2Q", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-05-26T06:20:21Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-05-26T06:20:21Z"}, "message": "Auto merge of #111918 - compiler-errors:custom-type-ops-err, r=lcnr\n\nUse `ErrorGuaranteed` more in MIR type ops\n\nDelay bugs more eagerly and pass them through type op infra instead of delaying them at all the usage-sites.\n\nFollow up to: https://github.com/rust-lang/rust/pull/111741#discussion_r1203840588\n\nr? `@lcnr`", "tree": {"sha": "6fa8c399df1e4f02383ea857aa6470689d50171f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6fa8c399df1e4f02383ea857aa6470689d50171f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/be72f2587c91579406117f99fa332383d66b7dcd", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/be72f2587c91579406117f99fa332383d66b7dcd", "html_url": "https://github.com/rust-lang/rust/commit/be72f2587c91579406117f99fa332383d66b7dcd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/be72f2587c91579406117f99fa332383d66b7dcd/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c86212f9bccb4d5ec625b0607053b067732724ab", "url": "https://api.github.com/repos/rust-lang/rust/commits/c86212f9bccb4d5ec625b0607053b067732724ab", "html_url": "https://github.com/rust-lang/rust/commit/c86212f9bccb4d5ec625b0607053b067732724ab"}, {"sha": "0a35db5e0d0f855ec9706280cef21fdc8a1f6ce5", "url": "https://api.github.com/repos/rust-lang/rust/commits/0a35db5e0d0f855ec9706280cef21fdc8a1f6ce5", "html_url": "https://github.com/rust-lang/rust/commit/0a35db5e0d0f855ec9706280cef21fdc8a1f6ce5"}], "stats": {"total": 317, "additions": 158, "deletions": 159}, "files": [{"sha": "f527eee7bda054f217087d039864942e803139f8", "filename": "compiler/rustc_borrowck/src/type_check/canonical.rs", "status": "modified", "additions": 13, "deletions": 32, "changes": 45, "blob_url": "https://github.com/rust-lang/rust/blob/be72f2587c91579406117f99fa332383d66b7dcd/compiler%2Frustc_borrowck%2Fsrc%2Ftype_check%2Fcanonical.rs", "raw_url": "https://github.com/rust-lang/rust/raw/be72f2587c91579406117f99fa332383d66b7dcd/compiler%2Frustc_borrowck%2Fsrc%2Ftype_check%2Fcanonical.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_borrowck%2Fsrc%2Ftype_check%2Fcanonical.rs?ref=be72f2587c91579406117f99fa332383d66b7dcd", "patch": "@@ -1,12 +1,12 @@\n use std::fmt;\n \n+use rustc_errors::ErrorGuaranteed;\n use rustc_infer::infer::canonical::Canonical;\n use rustc_middle::mir::ConstraintCategory;\n use rustc_middle::ty::{self, ToPredicate, Ty, TyCtxt, TypeFoldable};\n use rustc_span::def_id::DefId;\n use rustc_span::Span;\n use rustc_trait_selection::traits::query::type_op::{self, TypeOpOutput};\n-use rustc_trait_selection::traits::query::{Fallible, NoSolution};\n use rustc_trait_selection::traits::ObligationCause;\n \n use crate::diagnostics::{ToUniverseInfo, UniverseInfo};\n@@ -30,14 +30,15 @@ impl<'a, 'tcx> TypeChecker<'a, 'tcx> {\n         locations: Locations,\n         category: ConstraintCategory<'tcx>,\n         op: Op,\n-    ) -> Fallible<R>\n+    ) -> Result<R, ErrorGuaranteed>\n     where\n         Op: type_op::TypeOp<'tcx, Output = R>,\n         Op::ErrorInfo: ToUniverseInfo<'tcx>,\n     {\n         let old_universe = self.infcx.universe();\n \n-        let TypeOpOutput { output, constraints, error_info } = op.fully_perform(self.infcx)?;\n+        let TypeOpOutput { output, constraints, error_info } =\n+            op.fully_perform(self.infcx, locations.span(self.body))?;\n \n         debug!(?output, ?constraints);\n \n@@ -135,14 +136,11 @@ impl<'a, 'tcx> TypeChecker<'a, 'tcx> {\n     ) {\n         let param_env = self.param_env;\n         let predicate = predicate.to_predicate(self.tcx());\n-        self.fully_perform_op(\n+        let _: Result<_, ErrorGuaranteed> = self.fully_perform_op(\n             locations,\n             category,\n             param_env.and(type_op::prove_predicate::ProvePredicate::new(predicate)),\n-        )\n-        .unwrap_or_else(|NoSolution| {\n-            span_mirbug!(self, NoSolution, \"could not prove {:?}\", predicate);\n-        })\n+        );\n     }\n \n     pub(super) fn normalize<T>(&mut self, value: T, location: impl NormalizeLocation) -> T\n@@ -163,15 +161,12 @@ impl<'a, 'tcx> TypeChecker<'a, 'tcx> {\n         T: type_op::normalize::Normalizable<'tcx> + fmt::Display + Copy + 'tcx,\n     {\n         let param_env = self.param_env;\n-        self.fully_perform_op(\n+        let result: Result<_, ErrorGuaranteed> = self.fully_perform_op(\n             location.to_locations(),\n             category,\n             param_env.and(type_op::normalize::Normalize::new(value)),\n-        )\n-        .unwrap_or_else(|NoSolution| {\n-            span_mirbug!(self, NoSolution, \"failed to normalize `{:?}`\", value);\n-            value\n-        })\n+        );\n+        result.unwrap_or(value)\n     }\n \n     #[instrument(skip(self), level = \"debug\")]\n@@ -181,18 +176,11 @@ impl<'a, 'tcx> TypeChecker<'a, 'tcx> {\n         user_ty: ty::UserType<'tcx>,\n         span: Span,\n     ) {\n-        self.fully_perform_op(\n+        let _: Result<_, ErrorGuaranteed> = self.fully_perform_op(\n             Locations::All(span),\n             ConstraintCategory::Boring,\n             self.param_env.and(type_op::ascribe_user_type::AscribeUserType::new(mir_ty, user_ty)),\n-        )\n-        .unwrap_or_else(|err| {\n-            span_mirbug!(\n-                self,\n-                span,\n-                \"ascribe_user_type `{mir_ty:?}=={user_ty:?}` failed with `{err:?}`\",\n-            );\n-        });\n+        );\n     }\n \n     /// *Incorrectly* skips the WF checks we normally do in `ascribe_user_type`.\n@@ -219,7 +207,7 @@ impl<'a, 'tcx> TypeChecker<'a, 'tcx> {\n \n         let cause = ObligationCause::dummy_with_span(span);\n         let param_env = self.param_env;\n-        self.fully_perform_op(\n+        let _: Result<_, ErrorGuaranteed> = self.fully_perform_op(\n             Locations::All(span),\n             ConstraintCategory::Boring,\n             type_op::custom::CustomTypeOp::new(\n@@ -230,13 +218,6 @@ impl<'a, 'tcx> TypeChecker<'a, 'tcx> {\n                 },\n                 \"ascribe_user_type_skip_wf\",\n             ),\n-        )\n-        .unwrap_or_else(|err| {\n-            span_mirbug!(\n-                self,\n-                span,\n-                \"ascribe_user_type_skip_wf `{mir_ty:?}=={user_ty:?}` failed with `{err:?}`\",\n-            );\n-        });\n+        );\n     }\n }"}, {"sha": "c8ec1257d376ef4faf78995507244cd60b111f14", "filename": "compiler/rustc_borrowck/src/type_check/free_region_relations.rs", "status": "modified", "additions": 7, "deletions": 14, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/be72f2587c91579406117f99fa332383d66b7dcd/compiler%2Frustc_borrowck%2Fsrc%2Ftype_check%2Ffree_region_relations.rs", "raw_url": "https://github.com/rust-lang/rust/raw/be72f2587c91579406117f99fa332383d66b7dcd/compiler%2Frustc_borrowck%2Fsrc%2Ftype_check%2Ffree_region_relations.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_borrowck%2Fsrc%2Ftype_check%2Ffree_region_relations.rs?ref=be72f2587c91579406117f99fa332383d66b7dcd", "patch": "@@ -8,7 +8,7 @@ use rustc_infer::infer::InferCtxt;\n use rustc_middle::mir::ConstraintCategory;\n use rustc_middle::traits::query::OutlivesBound;\n use rustc_middle::ty::{self, RegionVid, Ty};\n-use rustc_span::Span;\n+use rustc_span::{Span, DUMMY_SP};\n use rustc_trait_selection::traits::query::type_op::{self, TypeOp};\n use std::rc::Rc;\n use type_op::TypeOpOutput;\n@@ -243,18 +243,11 @@ impl<'tcx> UniversalRegionRelationsBuilder<'_, 'tcx> {\n             let TypeOpOutput { output: norm_ty, constraints: constraints_normalize, .. } = self\n                 .param_env\n                 .and(type_op::normalize::Normalize::new(ty))\n-                .fully_perform(self.infcx)\n-                .unwrap_or_else(|_| {\n-                    let guar = self\n-                        .infcx\n-                        .tcx\n-                        .sess\n-                        .delay_span_bug(span, format!(\"failed to normalize {:?}\", ty));\n-                    TypeOpOutput {\n-                        output: self.infcx.tcx.ty_error(guar),\n-                        constraints: None,\n-                        error_info: None,\n-                    }\n+                .fully_perform(self.infcx, span)\n+                .unwrap_or_else(|guar| TypeOpOutput {\n+                    output: self.infcx.tcx.ty_error(guar),\n+                    constraints: None,\n+                    error_info: None,\n                 });\n             if let Some(c) = constraints_normalize {\n                 constraints.push(c)\n@@ -324,7 +317,7 @@ impl<'tcx> UniversalRegionRelationsBuilder<'_, 'tcx> {\n         let TypeOpOutput { output: bounds, constraints, .. } = self\n             .param_env\n             .and(type_op::implied_outlives_bounds::ImpliedOutlivesBounds { ty })\n-            .fully_perform(self.infcx)\n+            .fully_perform(self.infcx, DUMMY_SP)\n             .unwrap_or_else(|_| bug!(\"failed to compute implied bounds {:?}\", ty));\n         debug!(?bounds, ?constraints);\n         self.add_outlives_bounds(bounds);"}, {"sha": "fd94ac86d7dc2729f4e593304c273bccff802837", "filename": "compiler/rustc_borrowck/src/type_check/liveness/trace.rs", "status": "modified", "additions": 11, "deletions": 5, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/be72f2587c91579406117f99fa332383d66b7dcd/compiler%2Frustc_borrowck%2Fsrc%2Ftype_check%2Fliveness%2Ftrace.rs", "raw_url": "https://github.com/rust-lang/rust/raw/be72f2587c91579406117f99fa332383d66b7dcd/compiler%2Frustc_borrowck%2Fsrc%2Ftype_check%2Fliveness%2Ftrace.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_borrowck%2Fsrc%2Ftype_check%2Fliveness%2Ftrace.rs?ref=be72f2587c91579406117f99fa332383d66b7dcd", "patch": "@@ -4,6 +4,7 @@ use rustc_index::interval::IntervalSet;\n use rustc_infer::infer::canonical::QueryRegionConstraints;\n use rustc_middle::mir::{BasicBlock, Body, ConstraintCategory, Local, Location};\n use rustc_middle::ty::{Ty, TyCtxt, TypeVisitable, TypeVisitableExt};\n+use rustc_span::DUMMY_SP;\n use rustc_trait_selection::traits::query::dropck_outlives::DropckOutlivesResult;\n use rustc_trait_selection::traits::query::type_op::outlives::DropckOutlives;\n use rustc_trait_selection::traits::query::type_op::{TypeOp, TypeOpOutput};\n@@ -568,10 +569,15 @@ impl<'tcx> LivenessContext<'_, '_, '_, 'tcx> {\n     ) -> DropData<'tcx> {\n         debug!(\"compute_drop_data(dropped_ty={:?})\", dropped_ty,);\n \n-        let param_env = typeck.param_env;\n-        let TypeOpOutput { output, constraints, .. } =\n-            param_env.and(DropckOutlives::new(dropped_ty)).fully_perform(typeck.infcx).unwrap();\n-\n-        DropData { dropck_result: output, region_constraint_data: constraints }\n+        match typeck\n+            .param_env\n+            .and(DropckOutlives::new(dropped_ty))\n+            .fully_perform(typeck.infcx, DUMMY_SP)\n+        {\n+            Ok(TypeOpOutput { output, constraints, .. }) => {\n+                DropData { dropck_result: output, region_constraint_data: constraints }\n+            }\n+            Err(_) => DropData { dropck_result: Default::default(), region_constraint_data: None },\n+        }\n     }\n }"}, {"sha": "51a84ce6cadeac2914e5f5745362639dfbab5338", "filename": "compiler/rustc_borrowck/src/type_check/mod.rs", "status": "modified", "additions": 36, "deletions": 27, "changes": 63, "blob_url": "https://github.com/rust-lang/rust/blob/be72f2587c91579406117f99fa332383d66b7dcd/compiler%2Frustc_borrowck%2Fsrc%2Ftype_check%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/be72f2587c91579406117f99fa332383d66b7dcd/compiler%2Frustc_borrowck%2Fsrc%2Ftype_check%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_borrowck%2Fsrc%2Ftype_check%2Fmod.rs?ref=be72f2587c91579406117f99fa332383d66b7dcd", "patch": "@@ -10,6 +10,7 @@ use either::Either;\n use hir::OpaqueTyOrigin;\n use rustc_data_structures::frozen::Frozen;\n use rustc_data_structures::fx::{FxIndexMap, FxIndexSet};\n+use rustc_errors::ErrorGuaranteed;\n use rustc_hir as hir;\n use rustc_hir::def::DefKind;\n use rustc_hir::def_id::LocalDefId;\n@@ -26,6 +27,7 @@ use rustc_middle::mir::tcx::PlaceTy;\n use rustc_middle::mir::visit::{NonMutatingUseContext, PlaceContext, Visitor};\n use rustc_middle::mir::AssertKind;\n use rustc_middle::mir::*;\n+use rustc_middle::traits::query::NoSolution;\n use rustc_middle::ty::adjustment::PointerCast;\n use rustc_middle::ty::cast::CastTy;\n use rustc_middle::ty::subst::{SubstsRef, UserSubsts};\n@@ -41,7 +43,7 @@ use rustc_target::abi::{FieldIdx, FIRST_VARIANT};\n use rustc_trait_selection::traits::query::type_op::custom::scrape_region_constraints;\n use rustc_trait_selection::traits::query::type_op::custom::CustomTypeOp;\n use rustc_trait_selection::traits::query::type_op::{TypeOp, TypeOpOutput};\n-use rustc_trait_selection::traits::query::Fallible;\n+\n use rustc_trait_selection::traits::PredicateObligation;\n \n use rustc_mir_dataflow::impls::MaybeInitializedPlaces;\n@@ -216,24 +218,22 @@ pub(crate) fn type_check<'mir, 'tcx>(\n     let opaque_type_values = opaque_type_values\n         .into_iter()\n         .map(|(opaque_type_key, decl)| {\n-            checker\n-                .fully_perform_op(\n-                    Locations::All(body.span),\n-                    ConstraintCategory::OpaqueType,\n-                    CustomTypeOp::new(\n-                        |ocx| {\n-                            ocx.infcx.register_member_constraints(\n-                                param_env,\n-                                opaque_type_key,\n-                                decl.hidden_type.ty,\n-                                decl.hidden_type.span,\n-                            );\n-                            Ok(())\n-                        },\n-                        \"opaque_type_map\",\n-                    ),\n-                )\n-                .unwrap();\n+            let _: Result<_, ErrorGuaranteed> = checker.fully_perform_op(\n+                Locations::All(body.span),\n+                ConstraintCategory::OpaqueType,\n+                CustomTypeOp::new(\n+                    |ocx| {\n+                        ocx.infcx.register_member_constraints(\n+                            param_env,\n+                            opaque_type_key,\n+                            decl.hidden_type.ty,\n+                            decl.hidden_type.span,\n+                        );\n+                        Ok(())\n+                    },\n+                    \"opaque_type_map\",\n+                ),\n+            );\n             let mut hidden_type = infcx.resolve_vars_if_possible(decl.hidden_type);\n             trace!(\"finalized opaque type {:?} to {:#?}\", opaque_type_key, hidden_type.ty.kind());\n             if hidden_type.has_non_region_infer() {\n@@ -1134,7 +1134,7 @@ impl<'a, 'tcx> TypeChecker<'a, 'tcx> {\n         sup: Ty<'tcx>,\n         locations: Locations,\n         category: ConstraintCategory<'tcx>,\n-    ) -> Fallible<()> {\n+    ) -> Result<(), NoSolution> {\n         // Use this order of parameters because the sup type is usually the\n         // \"expected\" type in diagnostics.\n         self.relate_types(sup, ty::Variance::Contravariant, sub, locations, category)\n@@ -1147,7 +1147,7 @@ impl<'a, 'tcx> TypeChecker<'a, 'tcx> {\n         found: Ty<'tcx>,\n         locations: Locations,\n         category: ConstraintCategory<'tcx>,\n-    ) -> Fallible<()> {\n+    ) -> Result<(), NoSolution> {\n         self.relate_types(expected, ty::Variance::Invariant, found, locations, category)\n     }\n \n@@ -1159,7 +1159,7 @@ impl<'a, 'tcx> TypeChecker<'a, 'tcx> {\n         user_ty: &UserTypeProjection,\n         locations: Locations,\n         category: ConstraintCategory<'tcx>,\n-    ) -> Fallible<()> {\n+    ) -> Result<(), NoSolution> {\n         let annotated_type = self.user_type_annotations[user_ty.base].inferred_ty;\n         trace!(?annotated_type);\n         let mut curr_projected_ty = PlaceTy::from_ty(annotated_type);\n@@ -2755,11 +2755,20 @@ impl<'tcx> TypeOp<'tcx> for InstantiateOpaqueType<'tcx> {\n     /// constraints in our `InferCtxt`\n     type ErrorInfo = InstantiateOpaqueType<'tcx>;\n \n-    fn fully_perform(mut self, infcx: &InferCtxt<'tcx>) -> Fallible<TypeOpOutput<'tcx, Self>> {\n-        let (mut output, region_constraints) = scrape_region_constraints(infcx, |ocx| {\n-            ocx.register_obligations(self.obligations.clone());\n-            Ok(())\n-        })?;\n+    fn fully_perform(\n+        mut self,\n+        infcx: &InferCtxt<'tcx>,\n+        span: Span,\n+    ) -> Result<TypeOpOutput<'tcx, Self>, ErrorGuaranteed> {\n+        let (mut output, region_constraints) = scrape_region_constraints(\n+            infcx,\n+            |ocx| {\n+                ocx.register_obligations(self.obligations.clone());\n+                Ok(())\n+            },\n+            \"InstantiateOpaqueType\",\n+            span,\n+        )?;\n         self.region_constraints = Some(region_constraints);\n         output.error_info = Some(self);\n         Ok(output)"}, {"sha": "8c4bfb2c6e0d30721edb6459c35c95292bcb6cb8", "filename": "compiler/rustc_borrowck/src/type_check/relate_tys.rs", "status": "modified", "additions": 6, "deletions": 15, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/be72f2587c91579406117f99fa332383d66b7dcd/compiler%2Frustc_borrowck%2Fsrc%2Ftype_check%2Frelate_tys.rs", "raw_url": "https://github.com/rust-lang/rust/raw/be72f2587c91579406117f99fa332383d66b7dcd/compiler%2Frustc_borrowck%2Fsrc%2Ftype_check%2Frelate_tys.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_borrowck%2Fsrc%2Ftype_check%2Frelate_tys.rs?ref=be72f2587c91579406117f99fa332383d66b7dcd", "patch": "@@ -1,12 +1,13 @@\n+use rustc_errors::ErrorGuaranteed;\n use rustc_infer::infer::nll_relate::{TypeRelating, TypeRelatingDelegate};\n use rustc_infer::infer::NllRegionVariableOrigin;\n use rustc_infer::traits::PredicateObligations;\n use rustc_middle::mir::ConstraintCategory;\n+use rustc_middle::traits::query::NoSolution;\n use rustc_middle::ty::relate::TypeRelation;\n use rustc_middle::ty::{self, Ty};\n use rustc_span::symbol::sym;\n use rustc_span::{Span, Symbol};\n-use rustc_trait_selection::traits::query::Fallible;\n \n use crate::constraints::OutlivesConstraint;\n use crate::diagnostics::UniverseInfo;\n@@ -30,7 +31,7 @@ impl<'a, 'tcx> TypeChecker<'a, 'tcx> {\n         b: Ty<'tcx>,\n         locations: Locations,\n         category: ConstraintCategory<'tcx>,\n-    ) -> Fallible<()> {\n+    ) -> Result<(), NoSolution> {\n         TypeRelating::new(\n             self.infcx,\n             NllTypeRelatingDelegate::new(self, locations, category, UniverseInfo::relate(a, b)),\n@@ -47,7 +48,7 @@ impl<'a, 'tcx> TypeChecker<'a, 'tcx> {\n         b: ty::SubstsRef<'tcx>,\n         locations: Locations,\n         category: ConstraintCategory<'tcx>,\n-    ) -> Fallible<()> {\n+    ) -> Result<(), NoSolution> {\n         TypeRelating::new(\n             self.infcx,\n             NllTypeRelatingDelegate::new(self, locations, category, UniverseInfo::other()),\n@@ -185,7 +186,7 @@ impl<'tcx> TypeRelatingDelegate<'tcx> for NllTypeRelatingDelegate<'_, '_, 'tcx>\n     }\n \n     fn register_obligations(&mut self, obligations: PredicateObligations<'tcx>) {\n-        match self.type_checker.fully_perform_op(\n+        let _: Result<_, ErrorGuaranteed> = self.type_checker.fully_perform_op(\n             self.locations,\n             self.category,\n             InstantiateOpaqueType {\n@@ -194,16 +195,6 @@ impl<'tcx> TypeRelatingDelegate<'tcx> for NllTypeRelatingDelegate<'_, '_, 'tcx>\n                 base_universe: None,\n                 region_constraints: None,\n             },\n-        ) {\n-            Ok(()) => {}\n-            Err(_) => {\n-                // It's a bit redundant to delay a bug here, but I'd rather\n-                // delay more bugs than accidentally not delay a bug at all.\n-                self.type_checker.tcx().sess.delay_span_bug(\n-                    self.locations.span(self.type_checker.body),\n-                    \"errors selecting obligation during MIR typeck\",\n-                );\n-            }\n-        };\n+        );\n     }\n }"}, {"sha": "88256c819f4d4a0976fa77aafb047b2b92e9f033", "filename": "compiler/rustc_infer/src/infer/canonical/query_response.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/be72f2587c91579406117f99fa332383d66b7dcd/compiler%2Frustc_infer%2Fsrc%2Finfer%2Fcanonical%2Fquery_response.rs", "raw_url": "https://github.com/rust-lang/rust/raw/be72f2587c91579406117f99fa332383d66b7dcd/compiler%2Frustc_infer%2Fsrc%2Finfer%2Fcanonical%2Fquery_response.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_infer%2Fsrc%2Finfer%2Fcanonical%2Fquery_response.rs?ref=be72f2587c91579406117f99fa332383d66b7dcd", "patch": "@@ -15,7 +15,7 @@ use crate::infer::canonical::{\n use crate::infer::nll_relate::{TypeRelating, TypeRelatingDelegate};\n use crate::infer::region_constraints::{Constraint, RegionConstraintData};\n use crate::infer::{DefineOpaqueTypes, InferCtxt, InferOk, InferResult, NllRegionVariableOrigin};\n-use crate::traits::query::{Fallible, NoSolution};\n+use crate::traits::query::NoSolution;\n use crate::traits::{Obligation, ObligationCause, PredicateObligation};\n use crate::traits::{PredicateObligations, TraitEngine, TraitEngineExt};\n use rustc_data_structures::captures::Captures;\n@@ -57,7 +57,7 @@ impl<'tcx> InferCtxt<'tcx> {\n         inference_vars: CanonicalVarValues<'tcx>,\n         answer: T,\n         fulfill_cx: &mut dyn TraitEngine<'tcx>,\n-    ) -> Fallible<CanonicalQueryResponse<'tcx, T>>\n+    ) -> Result<CanonicalQueryResponse<'tcx, T>, NoSolution>\n     where\n         T: Debug + TypeFoldable<TyCtxt<'tcx>>,\n         Canonical<'tcx, QueryResponse<'tcx, T>>: ArenaAllocatable<'tcx>,"}, {"sha": "eae5a280e114d0a9aa953b6a7212a6ca58ffdbd0", "filename": "compiler/rustc_middle/src/traits/query.rs", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/be72f2587c91579406117f99fa332383d66b7dcd/compiler%2Frustc_middle%2Fsrc%2Ftraits%2Fquery.rs", "raw_url": "https://github.com/rust-lang/rust/raw/be72f2587c91579406117f99fa332383d66b7dcd/compiler%2Frustc_middle%2Fsrc%2Ftraits%2Fquery.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Ftraits%2Fquery.rs?ref=be72f2587c91579406117f99fa332383d66b7dcd", "patch": "@@ -95,8 +95,6 @@ pub type CanonicalTypeOpNormalizeGoal<'tcx, T> =\n #[derive(Copy, Clone, Debug, HashStable, PartialEq, Eq)]\n pub struct NoSolution;\n \n-pub type Fallible<T> = Result<T, NoSolution>;\n-\n impl<'tcx> From<TypeError<'tcx>> for NoSolution {\n     fn from(_: TypeError<'tcx>) -> NoSolution {\n         NoSolution"}, {"sha": "312bd38178fdda3e18587a6a68aa879b711e6ee0", "filename": "compiler/rustc_trait_selection/src/infer.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/be72f2587c91579406117f99fa332383d66b7dcd/compiler%2Frustc_trait_selection%2Fsrc%2Finfer.rs", "raw_url": "https://github.com/rust-lang/rust/raw/be72f2587c91579406117f99fa332383d66b7dcd/compiler%2Frustc_trait_selection%2Fsrc%2Finfer.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Finfer.rs?ref=be72f2587c91579406117f99fa332383d66b7dcd", "patch": "@@ -5,7 +5,7 @@ use rustc_hir::def_id::DefId;\n use rustc_hir::lang_items::LangItem;\n use rustc_middle::arena::ArenaAllocatable;\n use rustc_middle::infer::canonical::{Canonical, CanonicalQueryResponse, QueryResponse};\n-use rustc_middle::traits::query::Fallible;\n+use rustc_middle::traits::query::NoSolution;\n use rustc_middle::ty::{self, Ty, TyCtxt, TypeFoldable, TypeVisitableExt};\n use rustc_middle::ty::{GenericArg, ToPredicate};\n use rustc_span::DUMMY_SP;\n@@ -82,8 +82,8 @@ pub trait InferCtxtBuilderExt<'tcx> {\n     fn enter_canonical_trait_query<K, R>(\n         &mut self,\n         canonical_key: &Canonical<'tcx, K>,\n-        operation: impl FnOnce(&ObligationCtxt<'_, 'tcx>, K) -> Fallible<R>,\n-    ) -> Fallible<CanonicalQueryResponse<'tcx, R>>\n+        operation: impl FnOnce(&ObligationCtxt<'_, 'tcx>, K) -> Result<R, NoSolution>,\n+    ) -> Result<CanonicalQueryResponse<'tcx, R>, NoSolution>\n     where\n         K: TypeFoldable<TyCtxt<'tcx>>,\n         R: Debug + TypeFoldable<TyCtxt<'tcx>>,\n@@ -110,8 +110,8 @@ impl<'tcx> InferCtxtBuilderExt<'tcx> for InferCtxtBuilder<'tcx> {\n     fn enter_canonical_trait_query<K, R>(\n         &mut self,\n         canonical_key: &Canonical<'tcx, K>,\n-        operation: impl FnOnce(&ObligationCtxt<'_, 'tcx>, K) -> Fallible<R>,\n-    ) -> Fallible<CanonicalQueryResponse<'tcx, R>>\n+        operation: impl FnOnce(&ObligationCtxt<'_, 'tcx>, K) -> Result<R, NoSolution>,\n+    ) -> Result<CanonicalQueryResponse<'tcx, R>, NoSolution>\n     where\n         K: TypeFoldable<TyCtxt<'tcx>>,\n         R: Debug + TypeFoldable<TyCtxt<'tcx>>,"}, {"sha": "2c5ffd664fe1de46269a8afd006d48c94c255a6a", "filename": "compiler/rustc_trait_selection/src/traits/engine.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/be72f2587c91579406117f99fa332383d66b7dcd/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fengine.rs", "raw_url": "https://github.com/rust-lang/rust/raw/be72f2587c91579406117f99fa332383d66b7dcd/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fengine.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fengine.rs?ref=be72f2587c91579406117f99fa332383d66b7dcd", "patch": "@@ -14,11 +14,11 @@ use rustc_infer::infer::canonical::{\n };\n use rustc_infer::infer::outlives::env::OutlivesEnvironment;\n use rustc_infer::infer::{DefineOpaqueTypes, InferCtxt, InferOk};\n-use rustc_infer::traits::query::Fallible;\n use rustc_infer::traits::{\n     FulfillmentError, Obligation, ObligationCause, PredicateObligation, TraitEngineExt as _,\n };\n use rustc_middle::arena::ArenaAllocatable;\n+use rustc_middle::traits::query::NoSolution;\n use rustc_middle::ty::error::TypeError;\n use rustc_middle::ty::ToPredicate;\n use rustc_middle::ty::TypeFoldable;\n@@ -235,7 +235,7 @@ impl<'a, 'tcx> ObligationCtxt<'a, 'tcx> {\n         &self,\n         inference_vars: CanonicalVarValues<'tcx>,\n         answer: T,\n-    ) -> Fallible<CanonicalQueryResponse<'tcx, T>>\n+    ) -> Result<CanonicalQueryResponse<'tcx, T>, NoSolution>\n     where\n         T: Debug + TypeFoldable<TyCtxt<'tcx>>,\n         Canonical<'tcx, QueryResponse<'tcx, T>>: ArenaAllocatable<'tcx>,"}, {"sha": "0e797a1cb60d58189f5753ec3c10baf8867e4d25", "filename": "compiler/rustc_trait_selection/src/traits/outlives_bounds.rs", "status": "modified", "additions": 4, "deletions": 8, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/be72f2587c91579406117f99fa332383d66b7dcd/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Foutlives_bounds.rs", "raw_url": "https://github.com/rust-lang/rust/raw/be72f2587c91579406117f99fa332383d66b7dcd/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Foutlives_bounds.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Foutlives_bounds.rs?ref=be72f2587c91579406117f99fa332383d66b7dcd", "patch": "@@ -1,8 +1,8 @@\n use crate::infer::InferCtxt;\n use crate::traits::query::type_op::{self, TypeOp, TypeOpOutput};\n-use crate::traits::query::NoSolution;\n use crate::traits::{ObligationCause, ObligationCtxt};\n use rustc_data_structures::fx::FxIndexSet;\n+use rustc_errors::ErrorGuaranteed;\n use rustc_infer::infer::resolve::OpportunisticRegionResolver;\n use rustc_middle::ty::{self, ParamEnv, Ty, TypeFolder, TypeVisitableExt};\n use rustc_span::def_id::LocalDefId;\n@@ -69,16 +69,12 @@ impl<'a, 'tcx: 'a> InferCtxtExt<'a, 'tcx> for InferCtxt<'tcx> {\n         }\n \n         let span = self.tcx.def_span(body_id);\n-        let result = param_env\n+        let result: Result<_, ErrorGuaranteed> = param_env\n             .and(type_op::implied_outlives_bounds::ImpliedOutlivesBounds { ty })\n-            .fully_perform(self);\n+            .fully_perform(self, span);\n         let result = match result {\n             Ok(r) => r,\n-            Err(NoSolution) => {\n-                self.tcx.sess.delay_span_bug(\n-                    span,\n-                    \"implied_outlives_bounds failed to solve all obligations\",\n-                );\n+            Err(_) => {\n                 return vec![];\n             }\n         };"}, {"sha": "c61f5454ec52e4f31f09ba865cd7ae50d909e391", "filename": "compiler/rustc_trait_selection/src/traits/query/type_op/ascribe_user_type.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/be72f2587c91579406117f99fa332383d66b7dcd/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Ftype_op%2Fascribe_user_type.rs", "raw_url": "https://github.com/rust-lang/rust/raw/be72f2587c91579406117f99fa332383d66b7dcd/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Ftype_op%2Fascribe_user_type.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Ftype_op%2Fascribe_user_type.rs?ref=be72f2587c91579406117f99fa332383d66b7dcd", "patch": "@@ -1,5 +1,5 @@\n use crate::infer::canonical::{Canonical, CanonicalQueryResponse};\n-use crate::traits::query::Fallible;\n+use rustc_middle::traits::query::NoSolution;\n use rustc_middle::ty::{ParamEnvAnd, TyCtxt};\n \n pub use rustc_middle::traits::query::type_op::AscribeUserType;\n@@ -17,7 +17,7 @@ impl<'tcx> super::QueryTypeOp<'tcx> for AscribeUserType<'tcx> {\n     fn perform_query(\n         tcx: TyCtxt<'tcx>,\n         canonicalized: Canonical<'tcx, ParamEnvAnd<'tcx, Self>>,\n-    ) -> Fallible<CanonicalQueryResponse<'tcx, ()>> {\n+    ) -> Result<CanonicalQueryResponse<'tcx, ()>, NoSolution> {\n         tcx.type_op_ascribe_user_type(canonicalized)\n     }\n }"}, {"sha": "6d8d2103f39040a9a68c037b42a57e6a603af4e6", "filename": "compiler/rustc_trait_selection/src/traits/query/type_op/custom.rs", "status": "modified", "additions": 19, "deletions": 11, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/be72f2587c91579406117f99fa332383d66b7dcd/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Ftype_op%2Fcustom.rs", "raw_url": "https://github.com/rust-lang/rust/raw/be72f2587c91579406117f99fa332383d66b7dcd/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Ftype_op%2Fcustom.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Ftype_op%2Fcustom.rs?ref=be72f2587c91579406117f99fa332383d66b7dcd", "patch": "@@ -1,11 +1,12 @@\n use crate::infer::canonical::query_response;\n use crate::infer::InferCtxt;\n use crate::traits::query::type_op::TypeOpOutput;\n-use crate::traits::query::Fallible;\n use crate::traits::ObligationCtxt;\n+use rustc_errors::ErrorGuaranteed;\n use rustc_infer::infer::region_constraints::RegionConstraintData;\n use rustc_middle::traits::query::NoSolution;\n use rustc_span::source_map::DUMMY_SP;\n+use rustc_span::Span;\n \n use std::fmt;\n \n@@ -17,15 +18,15 @@ pub struct CustomTypeOp<F> {\n impl<F> CustomTypeOp<F> {\n     pub fn new<'tcx, R>(closure: F, description: &'static str) -> Self\n     where\n-        F: FnOnce(&ObligationCtxt<'_, 'tcx>) -> Fallible<R>,\n+        F: FnOnce(&ObligationCtxt<'_, 'tcx>) -> Result<R, NoSolution>,\n     {\n         CustomTypeOp { closure, description }\n     }\n }\n \n impl<'tcx, F, R: fmt::Debug> super::TypeOp<'tcx> for CustomTypeOp<F>\n where\n-    F: FnOnce(&ObligationCtxt<'_, 'tcx>) -> Fallible<R>,\n+    F: FnOnce(&ObligationCtxt<'_, 'tcx>) -> Result<R, NoSolution>,\n {\n     type Output = R;\n     /// We can't do any custom error reporting for `CustomTypeOp`, so\n@@ -35,12 +36,16 @@ where\n     /// Processes the operation and all resulting obligations,\n     /// returning the final result along with any region constraints\n     /// (they will be given over to the NLL region solver).\n-    fn fully_perform(self, infcx: &InferCtxt<'tcx>) -> Fallible<TypeOpOutput<'tcx, Self>> {\n+    fn fully_perform(\n+        self,\n+        infcx: &InferCtxt<'tcx>,\n+        span: Span,\n+    ) -> Result<TypeOpOutput<'tcx, Self>, ErrorGuaranteed> {\n         if cfg!(debug_assertions) {\n             info!(\"fully_perform({:?})\", self);\n         }\n \n-        Ok(scrape_region_constraints(infcx, self.closure)?.0)\n+        Ok(scrape_region_constraints(infcx, self.closure, self.description, span)?.0)\n     }\n }\n \n@@ -54,8 +59,10 @@ impl<F> fmt::Debug for CustomTypeOp<F> {\n /// constraints that result, creating query-region-constraints.\n pub fn scrape_region_constraints<'tcx, Op: super::TypeOp<'tcx, Output = R>, R>(\n     infcx: &InferCtxt<'tcx>,\n-    op: impl FnOnce(&ObligationCtxt<'_, 'tcx>) -> Fallible<R>,\n-) -> Fallible<(TypeOpOutput<'tcx, Op>, RegionConstraintData<'tcx>)> {\n+    op: impl FnOnce(&ObligationCtxt<'_, 'tcx>) -> Result<R, NoSolution>,\n+    name: &'static str,\n+    span: Span,\n+) -> Result<(TypeOpOutput<'tcx, Op>, RegionConstraintData<'tcx>), ErrorGuaranteed> {\n     // During NLL, we expect that nobody will register region\n     // obligations **except** as part of a custom type op (and, at the\n     // end of each custom type op, we scrape out the region\n@@ -70,16 +77,17 @@ pub fn scrape_region_constraints<'tcx, Op: super::TypeOp<'tcx, Output = R>, R>(\n \n     let value = infcx.commit_if_ok(|_| {\n         let ocx = ObligationCtxt::new_in_snapshot(infcx);\n-        let value = op(&ocx)?;\n+        let value = op(&ocx).map_err(|_| {\n+            infcx.tcx.sess.delay_span_bug(span, format!(\"error performing operation: {name}\"))\n+        })?;\n         let errors = ocx.select_all_or_error();\n         if errors.is_empty() {\n             Ok(value)\n         } else {\n-            infcx.tcx.sess.delay_span_bug(\n+            Err(infcx.tcx.sess.delay_span_bug(\n                 DUMMY_SP,\n                 format!(\"errors selecting obligation during MIR typeck: {:?}\", errors),\n-            );\n-            Err(NoSolution)\n+            ))\n         }\n     })?;\n "}, {"sha": "40f8ecfd4ce101b7cf54bfff0e63cbfb7f90d0bd", "filename": "compiler/rustc_trait_selection/src/traits/query/type_op/eq.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/be72f2587c91579406117f99fa332383d66b7dcd/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Ftype_op%2Feq.rs", "raw_url": "https://github.com/rust-lang/rust/raw/be72f2587c91579406117f99fa332383d66b7dcd/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Ftype_op%2Feq.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Ftype_op%2Feq.rs?ref=be72f2587c91579406117f99fa332383d66b7dcd", "patch": "@@ -1,5 +1,5 @@\n use crate::infer::canonical::{Canonical, CanonicalQueryResponse};\n-use crate::traits::query::Fallible;\n+use rustc_middle::traits::query::NoSolution;\n use rustc_middle::ty::{ParamEnvAnd, TyCtxt};\n \n pub use rustc_middle::traits::query::type_op::Eq;\n@@ -17,7 +17,7 @@ impl<'tcx> super::QueryTypeOp<'tcx> for Eq<'tcx> {\n     fn perform_query(\n         tcx: TyCtxt<'tcx>,\n         canonicalized: Canonical<'tcx, ParamEnvAnd<'tcx, Self>>,\n-    ) -> Fallible<CanonicalQueryResponse<'tcx, ()>> {\n+    ) -> Result<CanonicalQueryResponse<'tcx, ()>, NoSolution> {\n         tcx.type_op_eq(canonicalized)\n     }\n }"}, {"sha": "26f0d554d350851f4d4e432745686c139de829f7", "filename": "compiler/rustc_trait_selection/src/traits/query/type_op/implied_outlives_bounds.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/be72f2587c91579406117f99fa332383d66b7dcd/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Ftype_op%2Fimplied_outlives_bounds.rs", "raw_url": "https://github.com/rust-lang/rust/raw/be72f2587c91579406117f99fa332383d66b7dcd/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Ftype_op%2Fimplied_outlives_bounds.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Ftype_op%2Fimplied_outlives_bounds.rs?ref=be72f2587c91579406117f99fa332383d66b7dcd", "patch": "@@ -1,6 +1,6 @@\n use crate::infer::canonical::{Canonical, CanonicalQueryResponse};\n-use crate::traits::query::Fallible;\n use rustc_infer::traits::query::OutlivesBound;\n+use rustc_middle::traits::query::NoSolution;\n use rustc_middle::ty::{self, ParamEnvAnd, Ty, TyCtxt};\n \n #[derive(Copy, Clone, Debug, HashStable, TypeFoldable, TypeVisitable, Lift)]\n@@ -28,7 +28,7 @@ impl<'tcx> super::QueryTypeOp<'tcx> for ImpliedOutlivesBounds<'tcx> {\n     fn perform_query(\n         tcx: TyCtxt<'tcx>,\n         canonicalized: Canonical<'tcx, ParamEnvAnd<'tcx, Self>>,\n-    ) -> Fallible<CanonicalQueryResponse<'tcx, Self::QueryResponse>> {\n+    ) -> Result<CanonicalQueryResponse<'tcx, Self::QueryResponse>, NoSolution> {\n         // FIXME this `unchecked_map` is only necessary because the\n         // query is defined as taking a `ParamEnvAnd<Ty>`; it should\n         // take an `ImpliedOutlivesBounds` instead"}, {"sha": "642326598480426e18a6faea247b19b4eb5a56dd", "filename": "compiler/rustc_trait_selection/src/traits/query/type_op/mod.rs", "status": "modified", "additions": 30, "deletions": 13, "changes": 43, "blob_url": "https://github.com/rust-lang/rust/blob/be72f2587c91579406117f99fa332383d66b7dcd/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Ftype_op%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/be72f2587c91579406117f99fa332383d66b7dcd/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Ftype_op%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Ftype_op%2Fmod.rs?ref=be72f2587c91579406117f99fa332383d66b7dcd", "patch": "@@ -2,13 +2,14 @@ use crate::infer::canonical::{\n     Canonical, CanonicalQueryResponse, OriginalQueryValues, QueryRegionConstraints,\n };\n use crate::infer::{InferCtxt, InferOk};\n-use crate::traits::query::Fallible;\n use crate::traits::ObligationCause;\n+use rustc_errors::ErrorGuaranteed;\n use rustc_infer::infer::canonical::Certainty;\n-use rustc_infer::traits::query::NoSolution;\n use rustc_infer::traits::PredicateObligations;\n+use rustc_middle::traits::query::NoSolution;\n use rustc_middle::ty::fold::TypeFoldable;\n use rustc_middle::ty::{ParamEnvAnd, TyCtxt};\n+use rustc_span::Span;\n use std::fmt;\n \n pub mod ascribe_user_type;\n@@ -32,7 +33,11 @@ pub trait TypeOp<'tcx>: Sized + fmt::Debug {\n     /// Processes the operation and all resulting obligations,\n     /// returning the final result along with any region constraints\n     /// (they will be given over to the NLL region solver).\n-    fn fully_perform(self, infcx: &InferCtxt<'tcx>) -> Fallible<TypeOpOutput<'tcx, Self>>;\n+    fn fully_perform(\n+        self,\n+        infcx: &InferCtxt<'tcx>,\n+        span: Span,\n+    ) -> Result<TypeOpOutput<'tcx, Self>, ErrorGuaranteed>;\n }\n \n /// The output from performing a type op\n@@ -74,18 +79,21 @@ pub trait QueryTypeOp<'tcx>: fmt::Debug + Copy + TypeFoldable<TyCtxt<'tcx>> + 't\n     fn perform_query(\n         tcx: TyCtxt<'tcx>,\n         canonicalized: Canonical<'tcx, ParamEnvAnd<'tcx, Self>>,\n-    ) -> Fallible<CanonicalQueryResponse<'tcx, Self::QueryResponse>>;\n+    ) -> Result<CanonicalQueryResponse<'tcx, Self::QueryResponse>, NoSolution>;\n \n     fn fully_perform_into(\n         query_key: ParamEnvAnd<'tcx, Self>,\n         infcx: &InferCtxt<'tcx>,\n         output_query_region_constraints: &mut QueryRegionConstraints<'tcx>,\n-    ) -> Fallible<(\n-        Self::QueryResponse,\n-        Option<Canonical<'tcx, ParamEnvAnd<'tcx, Self>>>,\n-        PredicateObligations<'tcx>,\n-        Certainty,\n-    )> {\n+    ) -> Result<\n+        (\n+            Self::QueryResponse,\n+            Option<Canonical<'tcx, ParamEnvAnd<'tcx, Self>>>,\n+            PredicateObligations<'tcx>,\n+            Certainty,\n+        ),\n+        NoSolution,\n+    > {\n         if let Some(result) = QueryTypeOp::try_fast_path(infcx.tcx, &query_key) {\n             return Ok((result, None, vec![], Certainty::Proven));\n         }\n@@ -120,10 +128,16 @@ where\n     type Output = Q::QueryResponse;\n     type ErrorInfo = Canonical<'tcx, ParamEnvAnd<'tcx, Q>>;\n \n-    fn fully_perform(self, infcx: &InferCtxt<'tcx>) -> Fallible<TypeOpOutput<'tcx, Self>> {\n+    fn fully_perform(\n+        self,\n+        infcx: &InferCtxt<'tcx>,\n+        span: Span,\n+    ) -> Result<TypeOpOutput<'tcx, Self>, ErrorGuaranteed> {\n         let mut region_constraints = QueryRegionConstraints::default();\n         let (output, error_info, mut obligations, _) =\n-            Q::fully_perform_into(self, infcx, &mut region_constraints)?;\n+            Q::fully_perform_into(self, infcx, &mut region_constraints).map_err(|_| {\n+                infcx.tcx.sess.delay_span_bug(span, format!(\"error performing {self:?}\"))\n+            })?;\n \n         // Typically, instantiating NLL query results does not\n         // create obligations. However, in some cases there\n@@ -151,7 +165,10 @@ where\n                 }\n             }\n             if !progress {\n-                return Err(NoSolution);\n+                return Err(infcx.tcx.sess.delay_span_bug(\n+                    span,\n+                    format!(\"ambiguity processing {obligations:?} from {self:?}\"),\n+                ));\n             }\n         }\n "}, {"sha": "776c74fdfae4b9c96ac9b3397f72fb59e31c6a5c", "filename": "compiler/rustc_trait_selection/src/traits/query/type_op/normalize.rs", "status": "modified", "additions": 7, "deletions": 7, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/be72f2587c91579406117f99fa332383d66b7dcd/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Ftype_op%2Fnormalize.rs", "raw_url": "https://github.com/rust-lang/rust/raw/be72f2587c91579406117f99fa332383d66b7dcd/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Ftype_op%2Fnormalize.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Ftype_op%2Fnormalize.rs?ref=be72f2587c91579406117f99fa332383d66b7dcd", "patch": "@@ -1,5 +1,5 @@\n use crate::infer::canonical::{Canonical, CanonicalQueryResponse};\n-use crate::traits::query::Fallible;\n+use rustc_middle::traits::query::NoSolution;\n use rustc_middle::ty::fold::TypeFoldable;\n use rustc_middle::ty::{self, Lift, ParamEnvAnd, Ty, TyCtxt, TypeVisitableExt};\n use std::fmt;\n@@ -19,7 +19,7 @@ where\n     fn perform_query(\n         tcx: TyCtxt<'tcx>,\n         canonicalized: Canonical<'tcx, ParamEnvAnd<'tcx, Self>>,\n-    ) -> Fallible<CanonicalQueryResponse<'tcx, Self::QueryResponse>> {\n+    ) -> Result<CanonicalQueryResponse<'tcx, Self::QueryResponse>, NoSolution> {\n         T::type_op_method(tcx, canonicalized)\n     }\n }\n@@ -28,14 +28,14 @@ pub trait Normalizable<'tcx>: fmt::Debug + TypeFoldable<TyCtxt<'tcx>> + Lift<'tc\n     fn type_op_method(\n         tcx: TyCtxt<'tcx>,\n         canonicalized: Canonical<'tcx, ParamEnvAnd<'tcx, Normalize<Self>>>,\n-    ) -> Fallible<CanonicalQueryResponse<'tcx, Self>>;\n+    ) -> Result<CanonicalQueryResponse<'tcx, Self>, NoSolution>;\n }\n \n impl<'tcx> Normalizable<'tcx> for Ty<'tcx> {\n     fn type_op_method(\n         tcx: TyCtxt<'tcx>,\n         canonicalized: Canonical<'tcx, ParamEnvAnd<'tcx, Normalize<Self>>>,\n-    ) -> Fallible<CanonicalQueryResponse<'tcx, Self>> {\n+    ) -> Result<CanonicalQueryResponse<'tcx, Self>, NoSolution> {\n         tcx.type_op_normalize_ty(canonicalized)\n     }\n }\n@@ -44,7 +44,7 @@ impl<'tcx> Normalizable<'tcx> for ty::Predicate<'tcx> {\n     fn type_op_method(\n         tcx: TyCtxt<'tcx>,\n         canonicalized: Canonical<'tcx, ParamEnvAnd<'tcx, Normalize<Self>>>,\n-    ) -> Fallible<CanonicalQueryResponse<'tcx, Self>> {\n+    ) -> Result<CanonicalQueryResponse<'tcx, Self>, NoSolution> {\n         tcx.type_op_normalize_predicate(canonicalized)\n     }\n }\n@@ -53,7 +53,7 @@ impl<'tcx> Normalizable<'tcx> for ty::PolyFnSig<'tcx> {\n     fn type_op_method(\n         tcx: TyCtxt<'tcx>,\n         canonicalized: Canonical<'tcx, ParamEnvAnd<'tcx, Normalize<Self>>>,\n-    ) -> Fallible<CanonicalQueryResponse<'tcx, Self>> {\n+    ) -> Result<CanonicalQueryResponse<'tcx, Self>, NoSolution> {\n         tcx.type_op_normalize_poly_fn_sig(canonicalized)\n     }\n }\n@@ -62,7 +62,7 @@ impl<'tcx> Normalizable<'tcx> for ty::FnSig<'tcx> {\n     fn type_op_method(\n         tcx: TyCtxt<'tcx>,\n         canonicalized: Canonical<'tcx, ParamEnvAnd<'tcx, Normalize<Self>>>,\n-    ) -> Fallible<CanonicalQueryResponse<'tcx, Self>> {\n+    ) -> Result<CanonicalQueryResponse<'tcx, Self>, NoSolution> {\n         tcx.type_op_normalize_fn_sig(canonicalized)\n     }\n }"}, {"sha": "7ce09bbdb7af366ee3acb78aae5718e29a4df847", "filename": "compiler/rustc_trait_selection/src/traits/query/type_op/outlives.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/be72f2587c91579406117f99fa332383d66b7dcd/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Ftype_op%2Foutlives.rs", "raw_url": "https://github.com/rust-lang/rust/raw/be72f2587c91579406117f99fa332383d66b7dcd/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Ftype_op%2Foutlives.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Ftype_op%2Foutlives.rs?ref=be72f2587c91579406117f99fa332383d66b7dcd", "patch": "@@ -1,6 +1,6 @@\n use crate::infer::canonical::{Canonical, CanonicalQueryResponse};\n use crate::traits::query::dropck_outlives::{trivial_dropck_outlives, DropckOutlivesResult};\n-use crate::traits::query::Fallible;\n+use rustc_middle::traits::query::NoSolution;\n use rustc_middle::ty::{ParamEnvAnd, Ty, TyCtxt};\n \n #[derive(Copy, Clone, Debug, HashStable, TypeFoldable, TypeVisitable, Lift)]\n@@ -27,7 +27,7 @@ impl<'tcx> super::QueryTypeOp<'tcx> for DropckOutlives<'tcx> {\n     fn perform_query(\n         tcx: TyCtxt<'tcx>,\n         canonicalized: Canonical<'tcx, ParamEnvAnd<'tcx, Self>>,\n-    ) -> Fallible<CanonicalQueryResponse<'tcx, Self::QueryResponse>> {\n+    ) -> Result<CanonicalQueryResponse<'tcx, Self::QueryResponse>, NoSolution> {\n         // Subtle: note that we are not invoking\n         // `infcx.at(...).dropck_outlives(...)` here, but rather the\n         // underlying `dropck_outlives` query. This same underlying"}, {"sha": "7c02f363960d7aca560b7b0f6e1069a03ac5a9a2", "filename": "compiler/rustc_trait_selection/src/traits/query/type_op/prove_predicate.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/be72f2587c91579406117f99fa332383d66b7dcd/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Ftype_op%2Fprove_predicate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/be72f2587c91579406117f99fa332383d66b7dcd/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Ftype_op%2Fprove_predicate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Ftype_op%2Fprove_predicate.rs?ref=be72f2587c91579406117f99fa332383d66b7dcd", "patch": "@@ -1,5 +1,5 @@\n use crate::infer::canonical::{Canonical, CanonicalQueryResponse};\n-use crate::traits::query::Fallible;\n+use rustc_middle::traits::query::NoSolution;\n use rustc_middle::ty::{self, ParamEnvAnd, TyCtxt};\n \n pub use rustc_middle::traits::query::type_op::ProvePredicate;\n@@ -33,7 +33,7 @@ impl<'tcx> super::QueryTypeOp<'tcx> for ProvePredicate<'tcx> {\n     fn perform_query(\n         tcx: TyCtxt<'tcx>,\n         canonicalized: Canonical<'tcx, ParamEnvAnd<'tcx, Self>>,\n-    ) -> Fallible<CanonicalQueryResponse<'tcx, ()>> {\n+    ) -> Result<CanonicalQueryResponse<'tcx, ()>, NoSolution> {\n         tcx.type_op_prove_predicate(canonicalized)\n     }\n }"}, {"sha": "2f2b931afcff4beb461bb075498c29ec5e20e430", "filename": "compiler/rustc_trait_selection/src/traits/query/type_op/subtype.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/be72f2587c91579406117f99fa332383d66b7dcd/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Ftype_op%2Fsubtype.rs", "raw_url": "https://github.com/rust-lang/rust/raw/be72f2587c91579406117f99fa332383d66b7dcd/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Ftype_op%2Fsubtype.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Ftype_op%2Fsubtype.rs?ref=be72f2587c91579406117f99fa332383d66b7dcd", "patch": "@@ -1,5 +1,5 @@\n use crate::infer::canonical::{Canonical, CanonicalQueryResponse};\n-use crate::traits::query::Fallible;\n+use rustc_middle::traits::query::NoSolution;\n use rustc_middle::ty::{ParamEnvAnd, TyCtxt};\n \n pub use rustc_middle::traits::query::type_op::Subtype;\n@@ -14,7 +14,7 @@ impl<'tcx> super::QueryTypeOp<'tcx> for Subtype<'tcx> {\n     fn perform_query(\n         tcx: TyCtxt<'tcx>,\n         canonicalized: Canonical<'tcx, ParamEnvAnd<'tcx, Self>>,\n-    ) -> Fallible<CanonicalQueryResponse<'tcx, ()>> {\n+    ) -> Result<CanonicalQueryResponse<'tcx, ()>, NoSolution> {\n         tcx.type_op_subtype(canonicalized)\n     }\n }"}, {"sha": "49cbf9efa749379643d7ab5757e8be40f665d8b1", "filename": "compiler/rustc_traits/src/implied_outlives_bounds.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/be72f2587c91579406117f99fa332383d66b7dcd/compiler%2Frustc_traits%2Fsrc%2Fimplied_outlives_bounds.rs", "raw_url": "https://github.com/rust-lang/rust/raw/be72f2587c91579406117f99fa332383d66b7dcd/compiler%2Frustc_traits%2Fsrc%2Fimplied_outlives_bounds.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_traits%2Fsrc%2Fimplied_outlives_bounds.rs?ref=be72f2587c91579406117f99fa332383d66b7dcd", "patch": "@@ -11,7 +11,7 @@ use rustc_middle::ty::{self, Ty, TyCtxt, TypeVisitableExt};\n use rustc_span::def_id::CRATE_DEF_ID;\n use rustc_span::source_map::DUMMY_SP;\n use rustc_trait_selection::infer::InferCtxtBuilderExt;\n-use rustc_trait_selection::traits::query::{CanonicalTyGoal, Fallible, NoSolution};\n+use rustc_trait_selection::traits::query::{CanonicalTyGoal, NoSolution};\n use rustc_trait_selection::traits::wf;\n use rustc_trait_selection::traits::ObligationCtxt;\n use smallvec::{smallvec, SmallVec};\n@@ -37,7 +37,7 @@ fn compute_implied_outlives_bounds<'tcx>(\n     ocx: &ObligationCtxt<'_, 'tcx>,\n     param_env: ty::ParamEnv<'tcx>,\n     ty: Ty<'tcx>,\n-) -> Fallible<Vec<OutlivesBound<'tcx>>> {\n+) -> Result<Vec<OutlivesBound<'tcx>>, NoSolution> {\n     let tcx = ocx.infcx.tcx;\n \n     // Sometimes when we ask what it takes for T: WF, we get back that"}, {"sha": "faf985169deff14e6b8e31a199c27cc9959f68ba", "filename": "compiler/rustc_traits/src/type_op.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/be72f2587c91579406117f99fa332383d66b7dcd/compiler%2Frustc_traits%2Fsrc%2Ftype_op.rs", "raw_url": "https://github.com/rust-lang/rust/raw/be72f2587c91579406117f99fa332383d66b7dcd/compiler%2Frustc_traits%2Fsrc%2Ftype_op.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_traits%2Fsrc%2Ftype_op.rs?ref=be72f2587c91579406117f99fa332383d66b7dcd", "patch": "@@ -2,6 +2,7 @@ use rustc_hir as hir;\n use rustc_infer::infer::canonical::{Canonical, QueryResponse};\n use rustc_infer::infer::TyCtxtInferExt;\n use rustc_middle::query::Providers;\n+use rustc_middle::traits::query::NoSolution;\n use rustc_middle::traits::{DefiningAnchor, ObligationCauseCode};\n use rustc_middle::ty::{self, FnSig, Lift, PolyFnSig, Ty, TyCtxt, TypeFoldable};\n use rustc_middle::ty::{ParamEnvAnd, Predicate};\n@@ -15,7 +16,6 @@ use rustc_trait_selection::traits::query::type_op::eq::Eq;\n use rustc_trait_selection::traits::query::type_op::normalize::Normalize;\n use rustc_trait_selection::traits::query::type_op::prove_predicate::ProvePredicate;\n use rustc_trait_selection::traits::query::type_op::subtype::Subtype;\n-use rustc_trait_selection::traits::query::{Fallible, NoSolution};\n use rustc_trait_selection::traits::{Normalized, Obligation, ObligationCause, ObligationCtxt};\n use std::fmt;\n \n@@ -160,7 +160,7 @@ fn type_op_eq<'tcx>(\n fn type_op_normalize<'tcx, T>(\n     ocx: &ObligationCtxt<'_, 'tcx>,\n     key: ParamEnvAnd<'tcx, Normalize<T>>,\n-) -> Fallible<T>\n+) -> Result<T, NoSolution>\n where\n     T: fmt::Debug + TypeFoldable<TyCtxt<'tcx>> + Lift<'tcx>,\n {"}]}