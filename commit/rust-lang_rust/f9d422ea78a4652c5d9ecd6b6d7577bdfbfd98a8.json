{"sha": "f9d422ea78a4652c5d9ecd6b6d7577bdfbfd98a8", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY5ZDQyMmVhNzhhNDY1MmM1ZDllY2Q2YjZkNzU3N2JkZmJmZDk4YTg=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-08-04T19:37:01Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-08-04T19:37:01Z"}, "message": "Auto merge of #75136 - JohnTitor:unsizing-casts-non-null, r=oli-obk\n\nForbid non-derefable types explicitly in unsizing casts\n\nFixes #75118\nr? @oli-obk", "tree": {"sha": "e734b60aa68298a317cc0d0a0377e082507ad4db", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e734b60aa68298a317cc0d0a0377e082507ad4db"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f9d422ea78a4652c5d9ecd6b6d7577bdfbfd98a8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f9d422ea78a4652c5d9ecd6b6d7577bdfbfd98a8", "html_url": "https://github.com/rust-lang/rust/commit/f9d422ea78a4652c5d9ecd6b6d7577bdfbfd98a8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f9d422ea78a4652c5d9ecd6b6d7577bdfbfd98a8/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d08eb98698cbce56e599324fb83d55eef2cac408", "url": "https://api.github.com/repos/rust-lang/rust/commits/d08eb98698cbce56e599324fb83d55eef2cac408", "html_url": "https://github.com/rust-lang/rust/commit/d08eb98698cbce56e599324fb83d55eef2cac408"}, {"sha": "cd7204ef394d1e53bb967086186e9b8664d7e268", "url": "https://api.github.com/repos/rust-lang/rust/commits/cd7204ef394d1e53bb967086186e9b8664d7e268", "html_url": "https://github.com/rust-lang/rust/commit/cd7204ef394d1e53bb967086186e9b8664d7e268"}], "stats": {"total": 32, "additions": 31, "deletions": 1}, "files": [{"sha": "34fa840408f79a7d213bf4e25c40fccc7b975d4b", "filename": "src/librustc_mir/transform/qualify_min_const_fn.rs", "status": "modified", "additions": 9, "deletions": 1, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/f9d422ea78a4652c5d9ecd6b6d7577bdfbfd98a8/src%2Flibrustc_mir%2Ftransform%2Fqualify_min_const_fn.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f9d422ea78a4652c5d9ecd6b6d7577bdfbfd98a8/src%2Flibrustc_mir%2Ftransform%2Fqualify_min_const_fn.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fqualify_min_const_fn.rs?ref=f9d422ea78a4652c5d9ecd6b6d7577bdfbfd98a8", "patch": "@@ -193,7 +193,15 @@ fn check_rvalue(\n             _,\n         ) => Err((span, \"function pointer casts are not allowed in const fn\".into())),\n         Rvalue::Cast(CastKind::Pointer(PointerCast::Unsize), op, cast_ty) => {\n-            let pointee_ty = cast_ty.builtin_deref(true).unwrap().ty;\n+            let pointee_ty = if let Some(deref_ty) = cast_ty.builtin_deref(true) {\n+                deref_ty.ty\n+            } else {\n+                // We cannot allow this for now.\n+                return Err((\n+                    span,\n+                    \"unsizing casts are only allowed for references right now\".into(),\n+                ));\n+            };\n             let unsized_ty = tcx.struct_tail_erasing_lifetimes(pointee_ty, tcx.param_env(def_id));\n             if let ty::Slice(_) | ty::Str = unsized_ty.kind {\n                 check_operand(tcx, op, span, def_id, body)?;"}, {"sha": "67d9f6baca5b447a440c09036d63474d3c5beb5e", "filename": "src/test/ui/consts/unsizing-cast-non-null.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/f9d422ea78a4652c5d9ecd6b6d7577bdfbfd98a8/src%2Ftest%2Fui%2Fconsts%2Funsizing-cast-non-null.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f9d422ea78a4652c5d9ecd6b6d7577bdfbfd98a8/src%2Ftest%2Fui%2Fconsts%2Funsizing-cast-non-null.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Funsizing-cast-non-null.rs?ref=f9d422ea78a4652c5d9ecd6b6d7577bdfbfd98a8", "patch": "@@ -0,0 +1,10 @@\n+// Regression test for #75118.\n+\n+use std::ptr::NonNull;\n+\n+pub const fn dangling_slice<T>() -> NonNull<[T]> {\n+    NonNull::<[T; 0]>::dangling()\n+    //~^ ERROR: unsizing casts are only allowed for references right now\n+}\n+\n+fn main() {}"}, {"sha": "6575355daadd7fb34a83abb08529854ae9beeefd", "filename": "src/test/ui/consts/unsizing-cast-non-null.stderr", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/f9d422ea78a4652c5d9ecd6b6d7577bdfbfd98a8/src%2Ftest%2Fui%2Fconsts%2Funsizing-cast-non-null.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/f9d422ea78a4652c5d9ecd6b6d7577bdfbfd98a8/src%2Ftest%2Fui%2Fconsts%2Funsizing-cast-non-null.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Funsizing-cast-non-null.stderr?ref=f9d422ea78a4652c5d9ecd6b6d7577bdfbfd98a8", "patch": "@@ -0,0 +1,12 @@\n+error[E0723]: unsizing casts are only allowed for references right now\n+  --> $DIR/unsizing-cast-non-null.rs:6:5\n+   |\n+LL |     NonNull::<[T; 0]>::dangling()\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+   = note: see issue #57563 <https://github.com/rust-lang/rust/issues/57563> for more information\n+   = help: add `#![feature(const_fn)]` to the crate attributes to enable\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0723`."}]}