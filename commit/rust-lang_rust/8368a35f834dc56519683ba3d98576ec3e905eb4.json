{"sha": "8368a35f834dc56519683ba3d98576ec3e905eb4", "node_id": "MDY6Q29tbWl0NzI0NzEyOjgzNjhhMzVmODM0ZGM1NjUxOTY4M2JhM2Q5ODU3NmVjM2U5MDVlYjQ=", "commit": {"author": {"name": "Joshua M. Clulow", "email": "jmc@oxide.computer", "date": "2020-07-08T23:39:09Z"}, "committer": {"name": "Joshua M. Clulow", "email": "jmc@oxide.computer", "date": "2020-07-08T23:39:09Z"}, "message": "build dist for x86_64-unknown-illumos\n\nThis change creates a new Docker image, \"dist-x86_64-illumos\", and sets\nthings up to build the full set of \"dist\" packages for illumos hosts, so\nthat illumos users can use \"rustup\" to install packages.  It also\nadjusts the manifest builder to expect complete toolchains for this\nplatform.", "tree": {"sha": "50af7eb49bfeed242baf5a3eb2907c06b5cd6562", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/50af7eb49bfeed242baf5a3eb2907c06b5cd6562"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8368a35f834dc56519683ba3d98576ec3e905eb4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8368a35f834dc56519683ba3d98576ec3e905eb4", "html_url": "https://github.com/rust-lang/rust/commit/8368a35f834dc56519683ba3d98576ec3e905eb4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8368a35f834dc56519683ba3d98576ec3e905eb4/comments", "author": {"login": "jclulow", "id": 304070, "node_id": "MDQ6VXNlcjMwNDA3MA==", "avatar_url": "https://avatars.githubusercontent.com/u/304070?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jclulow", "html_url": "https://github.com/jclulow", "followers_url": "https://api.github.com/users/jclulow/followers", "following_url": "https://api.github.com/users/jclulow/following{/other_user}", "gists_url": "https://api.github.com/users/jclulow/gists{/gist_id}", "starred_url": "https://api.github.com/users/jclulow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jclulow/subscriptions", "organizations_url": "https://api.github.com/users/jclulow/orgs", "repos_url": "https://api.github.com/users/jclulow/repos", "events_url": "https://api.github.com/users/jclulow/events{/privacy}", "received_events_url": "https://api.github.com/users/jclulow/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jclulow", "id": 304070, "node_id": "MDQ6VXNlcjMwNDA3MA==", "avatar_url": "https://avatars.githubusercontent.com/u/304070?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jclulow", "html_url": "https://github.com/jclulow", "followers_url": "https://api.github.com/users/jclulow/followers", "following_url": "https://api.github.com/users/jclulow/following{/other_user}", "gists_url": "https://api.github.com/users/jclulow/gists{/gist_id}", "starred_url": "https://api.github.com/users/jclulow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jclulow/subscriptions", "organizations_url": "https://api.github.com/users/jclulow/orgs", "repos_url": "https://api.github.com/users/jclulow/repos", "events_url": "https://api.github.com/users/jclulow/events{/privacy}", "received_events_url": "https://api.github.com/users/jclulow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1d919c9377f4602d991ca1c7ba852e7555943740", "url": "https://api.github.com/repos/rust-lang/rust/commits/1d919c9377f4602d991ca1c7ba852e7555943740", "html_url": "https://github.com/rust-lang/rust/commit/1d919c9377f4602d991ca1c7ba852e7555943740"}], "stats": {"total": 218, "additions": 218, "deletions": 0}, "files": [{"sha": "66f201db01acb96f78dcce02d06f53bf33d2b1df", "filename": ".github/workflows/ci.yml", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/8368a35f834dc56519683ba3d98576ec3e905eb4/.github%2Fworkflows%2Fci.yml", "raw_url": "https://github.com/rust-lang/rust/raw/8368a35f834dc56519683ba3d98576ec3e905eb4/.github%2Fworkflows%2Fci.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.github%2Fworkflows%2Fci.yml?ref=8368a35f834dc56519683ba3d98576ec3e905eb4", "patch": "@@ -309,6 +309,9 @@ jobs:\n           - name: dist-x86_64-freebsd\n             os: ubuntu-latest-xl\n             env: {}\n+          - name: dist-x86_64-illumos\n+            os: ubuntu-latest-xl\n+            env: {}\n           - name: dist-x86_64-linux\n             os: ubuntu-latest-xl\n             env: {}"}, {"sha": "0b460bbe865ee89f056a9e9fe3d92e642fd856be", "filename": "src/ci/azure-pipelines/auto.yml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/8368a35f834dc56519683ba3d98576ec3e905eb4/src%2Fci%2Fazure-pipelines%2Fauto.yml", "raw_url": "https://github.com/rust-lang/rust/raw/8368a35f834dc56519683ba3d98576ec3e905eb4/src%2Fci%2Fazure-pipelines%2Fauto.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fazure-pipelines%2Fauto.yml?ref=8368a35f834dc56519683ba3d98576ec3e905eb4", "patch": "@@ -55,6 +55,7 @@ jobs:\n       dist-powerpc64le-linux: {}\n       dist-s390x-linux: {}\n       dist-x86_64-freebsd: {}\n+      dist-x86_64-illumos: {}\n       dist-x86_64-musl: {}\n       dist-x86_64-netbsd: {}\n       i686-gnu: {}"}, {"sha": "2a0f6a39c57816e498cca4028c45e42344020076", "filename": "src/ci/docker/host-x86_64/dist-x86_64-illumos/Dockerfile", "status": "added", "additions": 33, "deletions": 0, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/8368a35f834dc56519683ba3d98576ec3e905eb4/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-x86_64-illumos%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/8368a35f834dc56519683ba3d98576ec3e905eb4/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-x86_64-illumos%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-x86_64-illumos%2FDockerfile?ref=8368a35f834dc56519683ba3d98576ec3e905eb4", "patch": "@@ -0,0 +1,33 @@\n+FROM ubuntu:18.04\n+\n+# Enable source repositories, which are disabled by default on Ubuntu >= 18.04\n+RUN sed -i 's/^# deb-src/deb-src/' /etc/apt/sources.list\n+\n+COPY scripts/cross-apt-packages.sh /tmp/\n+RUN bash /tmp/cross-apt-packages.sh\n+\n+# Required for cross-build gcc\n+RUN apt-get update && \\\n+    apt-get install -y --no-install-recommends \\\n+      libgmp-dev \\\n+      libmpfr-dev \\\n+      libmpc-dev\n+\n+COPY scripts/illumos-toolchain.sh /tmp/\n+\n+RUN bash /tmp/illumos-toolchain.sh x86_64 sysroot\n+RUN bash /tmp/illumos-toolchain.sh x86_64 binutils\n+RUN bash /tmp/illumos-toolchain.sh x86_64 gcc\n+\n+COPY scripts/sccache.sh /scripts/\n+RUN sh /scripts/sccache.sh\n+\n+ENV \\\n+    AR_x86_64_unknown_illumos=x86_64-illumos-ar \\\n+    CC_x86_64_unknown_illumos=x86_64-illumos-gcc \\\n+    CXX_x86_64_unknown_illumos=x86_64-illumos-g++\n+\n+ENV HOSTS=x86_64-unknown-illumos\n+\n+ENV RUST_CONFIGURE_ARGS --enable-extended --disable-docs\n+ENV SCRIPT python3 ../x.py dist --host $HOSTS --target $HOSTS"}, {"sha": "8cb5712657947f969ee6e71b2d259dd0c3f25c35", "filename": "src/ci/docker/scripts/illumos-toolchain.sh", "status": "added", "additions": 177, "deletions": 0, "changes": 177, "blob_url": "https://github.com/rust-lang/rust/blob/8368a35f834dc56519683ba3d98576ec3e905eb4/src%2Fci%2Fdocker%2Fscripts%2Fillumos-toolchain.sh", "raw_url": "https://github.com/rust-lang/rust/raw/8368a35f834dc56519683ba3d98576ec3e905eb4/src%2Fci%2Fdocker%2Fscripts%2Fillumos-toolchain.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fscripts%2Fillumos-toolchain.sh?ref=8368a35f834dc56519683ba3d98576ec3e905eb4", "patch": "@@ -0,0 +1,177 @@\n+#!/bin/bash\n+\n+set -o errexit\n+set -o pipefail\n+set -o xtrace\n+\n+ARCH=\"$1\"\n+PHASE=\"$2\"\n+\n+JOBS=\"$(getconf _NPROCESSORS_ONLN)\"\n+\n+case \"$ARCH\" in\n+x86_64)\n+        SYSROOT_MACH='i386'\n+        ;;\n+*)\n+        printf 'ERROR: unknown architecture: %s\\n' \"$ARCH\"\n+        exit 1\n+esac\n+\n+BUILD_TARGET=\"$ARCH-sun-solaris2.10\"\n+\n+#\n+# The illumos and the Solaris build both use the same GCC-level host triple,\n+# though different versions of GCC are used and with different configure\n+# options.  To ensure as little accidental cross-pollination as possible, we\n+# build the illumos toolchain in a specific directory tree and just symlink the\n+# expected tools into /usr/local/bin at the end.  We omit /usr/local/bin from\n+# PATH here for similar reasons.\n+#\n+PREFIX=\"/opt/illumos/$ARCH\"\n+export PATH=\"$PREFIX/bin:/usr/bin:/bin:/usr/sbin:/sbin\"\n+\n+#\n+# NOTE: The compiler version selected here is more specific than might appear.\n+# GCC 7.X releases do not appear to cross-compile correctly for Solaris\n+# targets, at least insofar as they refuse to enable TLS in libstdc++.  When\n+# changing the GCC version in future, one must carefully verify that TLS is\n+# enabled in all of the static libraries we intend to include in output\n+# binaries.\n+#\n+GCC_VERSION='8.4.0'\n+GCC_SUM='e30a6e52d10e1f27ed55104ad233c30bd1e99cfb5ff98ab022dc941edd1b2dd4'\n+GCC_BASE=\"gcc-$GCC_VERSION\"\n+GCC_TAR=\"gcc-$GCC_VERSION.tar.xz\"\n+GCC_URL=\"https://ftp.gnu.org/gnu/gcc/$GCC_BASE/$GCC_TAR\"\n+\n+SYSROOT_VER='20181213-de6af22ae73b-v1'\n+SYSROOT_SUM='ee792d956dfa6967453cebe9286a149143290d296a8ce4b8a91d36bea89f8112'\n+SYSROOT_TAR=\"illumos-sysroot-$SYSROOT_MACH-$SYSROOT_VER.tar.gz\"\n+SYSROOT_URL='https://github.com/illumos/sysroot/releases/download/'\n+SYSROOT_URL+=\"$SYSROOT_VER/$SYSROOT_TAR\"\n+SYSROOT_DIR=\"$PREFIX/sysroot\"\n+\n+BINUTILS_VERSION='2.25.1'\n+BINUTILS_SUM='b5b14added7d78a8d1ca70b5cb75fef57ce2197264f4f5835326b0df22ac9f22'\n+BINUTILS_BASE=\"binutils-$BINUTILS_VERSION\"\n+BINUTILS_TAR=\"$BINUTILS_BASE.tar.bz2\"\n+BINUTILS_URL=\"https://ftp.gnu.org/gnu/binutils/$BINUTILS_TAR\"\n+\n+\n+download_file() {\n+        local file=\"$1\"\n+        local url=\"$2\"\n+        local sum=\"$3\"\n+\n+        while :; do\n+                if [[ -f \"$file\" ]]; then\n+                        if ! h=\"$(sha256sum \"$file\" | awk '{ print $1 }')\"; then\n+                                printf 'ERROR: reading hash\\n' >&2\n+                                exit 1\n+                        fi\n+\n+                        if [[ \"$h\" == \"$sum\" ]]; then\n+                                return 0\n+                        fi\n+\n+                        printf 'WARNING: hash mismatch: %s != expected %s\\n' \\\n+                            \"$h\" \"$sum\" >&2\n+                        rm -f \"$file\"\n+                fi\n+\n+                printf 'Downloading: %s\\n' \"$url\"\n+                if ! curl -f -L -o \"$file\" \"$url\"; then\n+                        rm -f \"$file\"\n+                        sleep 1\n+                fi\n+        done\n+}\n+\n+\n+case \"$PHASE\" in\n+sysroot)\n+        download_file \"/tmp/$SYSROOT_TAR\" \"$SYSROOT_URL\" \"$SYSROOT_SUM\"\n+        mkdir -p \"$SYSROOT_DIR\"\n+        cd \"$SYSROOT_DIR\"\n+        tar -xzf \"/tmp/$SYSROOT_TAR\"\n+        rm -f \"/tmp/$SYSROOT_TAR\"\n+        ;;\n+\n+binutils)\n+        download_file \"/tmp/$BINUTILS_TAR\" \"$BINUTILS_URL\" \"$BINUTILS_SUM\"\n+        mkdir -p /ws/src/binutils\n+        cd /ws/src/binutils\n+        tar -xjf \"/tmp/$BINUTILS_TAR\"\n+        rm -f \"/tmp/$BINUTILS_TAR\"\n+\n+        mkdir -p /ws/build/binutils\n+        cd /ws/build/binutils\n+        \"/ws/src/binutils/$BINUTILS_BASE/configure\" \\\n+            --prefix=\"$PREFIX\" \\\n+            --target=\"$BUILD_TARGET\" \\\n+            --program-prefix=\"$ARCH-illumos-\" \\\n+            --with-sysroot=\"$SYSROOT_DIR\"\n+\n+        make -j \"$JOBS\"\n+\n+        mkdir -p \"$PREFIX\"\n+        make install\n+\n+        cd /\n+        rm -rf /ws/src/binutils /ws/build/binutils\n+        ;;\n+\n+gcc)\n+        download_file \"/tmp/$GCC_TAR\" \"$GCC_URL\" \"$GCC_SUM\"\n+        mkdir -p /ws/src/gcc\n+        cd /ws/src/gcc\n+        tar -xJf \"/tmp/$GCC_TAR\"\n+        rm -f \"/tmp/$GCC_TAR\"\n+\n+        mkdir -p /ws/build/gcc\n+        cd /ws/build/gcc\n+        export CFLAGS='-fPIC'\n+        export CXXFLAGS='-fPIC'\n+        export CXXFLAGS_FOR_TARGET='-fPIC'\n+        export CFLAGS_FOR_TARGET='-fPIC'\n+        \"/ws/src/gcc/$GCC_BASE/configure\" \\\n+            --prefix=\"$PREFIX\" \\\n+            --target=\"$BUILD_TARGET\" \\\n+            --program-prefix=\"$ARCH-illumos-\" \\\n+            --with-sysroot=\"$SYSROOT_DIR\" \\\n+            --with-gnu-as \\\n+            --with-gnu-ld \\\n+            --disable-nls \\\n+            --disable-libgomp \\\n+            --disable-libquadmath \\\n+            --disable-libssp \\\n+            --disable-libvtv \\\n+            --disable-libcilkrts \\\n+            --disable-libada \\\n+            --disable-libsanitizer \\\n+            --disable-libquadmath-support \\\n+            --disable-shared \\\n+            --enable-tls\n+\n+        make -j \"$JOBS\"\n+\n+        mkdir -p \"$PREFIX\"\n+        make install\n+\n+        #\n+        # Link toolchain commands into /usr/local/bin so that cmake and others\n+        # can find them:\n+        #\n+        (cd \"$PREFIX/bin\" && ls -U) | grep \"^$ARCH-illumos-\" |\n+            xargs -t -I% ln -s \"$PREFIX/bin/%\" '/usr/local/bin/'\n+\n+        cd /\n+        rm -rf /ws/src/gcc /ws/build/gcc\n+        ;;\n+\n+*)\n+        printf 'ERROR: unknown phase \"%s\"\\n' \"$PHASE\" >&2\n+        exit 100\n+        ;;\n+esac"}, {"sha": "052ab37ecf3c81beeb33f86abc957d4122abca85", "filename": "src/ci/github-actions/ci.yml", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/8368a35f834dc56519683ba3d98576ec3e905eb4/src%2Fci%2Fgithub-actions%2Fci.yml", "raw_url": "https://github.com/rust-lang/rust/raw/8368a35f834dc56519683ba3d98576ec3e905eb4/src%2Fci%2Fgithub-actions%2Fci.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fgithub-actions%2Fci.yml?ref=8368a35f834dc56519683ba3d98576ec3e905eb4", "patch": "@@ -353,6 +353,9 @@ jobs:\n           - name: dist-x86_64-freebsd\n             <<: *job-linux-xl\n \n+          - name: dist-x86_64-illumos\n+            <<: *job-linux-xl\n+\n           - name: dist-x86_64-linux\n             <<: *job-linux-xl\n "}, {"sha": "2c64abb4be6bd224591e518ceb522b277c8237f8", "filename": "src/tools/build-manifest/src/main.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/8368a35f834dc56519683ba3d98576ec3e905eb4/src%2Ftools%2Fbuild-manifest%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8368a35f834dc56519683ba3d98576ec3e905eb4/src%2Ftools%2Fbuild-manifest%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fbuild-manifest%2Fsrc%2Fmain.rs?ref=8368a35f834dc56519683ba3d98576ec3e905eb4", "patch": "@@ -39,6 +39,7 @@ static HOSTS: &[&str] = &[\n     \"x86_64-pc-windows-gnu\",\n     \"x86_64-pc-windows-msvc\",\n     \"x86_64-unknown-freebsd\",\n+    \"x86_64-unknown-illumos\",\n     \"x86_64-unknown-linux-gnu\",\n     \"x86_64-unknown-linux-musl\",\n     \"x86_64-unknown-netbsd\","}]}