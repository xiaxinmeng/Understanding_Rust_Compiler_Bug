{"sha": "074bbc6b878f6afc5d6cfd1b5cce1e03588d8184", "node_id": "C_kwDOAAsO6NoAKDA3NGJiYzZiODc4ZjZhZmM1ZDZjZmQxYjVjY2UxZTAzNTg4ZDgxODQ", "commit": {"author": {"name": "Nikita Popov", "email": "nikita.ppv@gmail.com", "date": "2021-09-13T16:18:59Z"}, "committer": {"name": "Nikita Popov", "email": "nikita.ppv@gmail.com", "date": "2021-09-25T09:24:23Z"}, "message": "Use correct pipeline for LTO at O0\n\nUnlike the pre-link piplines, the LTO pipelines do support O0,\nand using them is required to avoid leaving behind undefined\nreferences for the linker.", "tree": {"sha": "a1ed3159c1b16707da66d66d510aeaac707e5b7d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a1ed3159c1b16707da66d66d510aeaac707e5b7d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/074bbc6b878f6afc5d6cfd1b5cce1e03588d8184", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/074bbc6b878f6afc5d6cfd1b5cce1e03588d8184", "html_url": "https://github.com/rust-lang/rust/commit/074bbc6b878f6afc5d6cfd1b5cce1e03588d8184", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/074bbc6b878f6afc5d6cfd1b5cce1e03588d8184/comments", "author": {"login": "nikic", "id": 216080, "node_id": "MDQ6VXNlcjIxNjA4MA==", "avatar_url": "https://avatars.githubusercontent.com/u/216080?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikic", "html_url": "https://github.com/nikic", "followers_url": "https://api.github.com/users/nikic/followers", "following_url": "https://api.github.com/users/nikic/following{/other_user}", "gists_url": "https://api.github.com/users/nikic/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikic/subscriptions", "organizations_url": "https://api.github.com/users/nikic/orgs", "repos_url": "https://api.github.com/users/nikic/repos", "events_url": "https://api.github.com/users/nikic/events{/privacy}", "received_events_url": "https://api.github.com/users/nikic/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nikic", "id": 216080, "node_id": "MDQ6VXNlcjIxNjA4MA==", "avatar_url": "https://avatars.githubusercontent.com/u/216080?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikic", "html_url": "https://github.com/nikic", "followers_url": "https://api.github.com/users/nikic/followers", "following_url": "https://api.github.com/users/nikic/following{/other_user}", "gists_url": "https://api.github.com/users/nikic/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikic/subscriptions", "organizations_url": "https://api.github.com/users/nikic/orgs", "repos_url": "https://api.github.com/users/nikic/repos", "events_url": "https://api.github.com/users/nikic/events{/privacy}", "received_events_url": "https://api.github.com/users/nikic/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "be01f42f73137129f5998e626e0639270066f5c9", "url": "https://api.github.com/repos/rust-lang/rust/commits/be01f42f73137129f5998e626e0639270066f5c9", "html_url": "https://github.com/rust-lang/rust/commit/be01f42f73137129f5998e626e0639270066f5c9"}], "stats": {"total": 5, "additions": 4, "deletions": 1}, "files": [{"sha": "48eb50953a957dc759f4e867a9a3564c9fe6a192", "filename": "compiler/rustc_llvm/llvm-wrapper/PassWrapper.cpp", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/074bbc6b878f6afc5d6cfd1b5cce1e03588d8184/compiler%2Frustc_llvm%2Fllvm-wrapper%2FPassWrapper.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/074bbc6b878f6afc5d6cfd1b5cce1e03588d8184/compiler%2Frustc_llvm%2Fllvm-wrapper%2FPassWrapper.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_llvm%2Fllvm-wrapper%2FPassWrapper.cpp?ref=074bbc6b878f6afc5d6cfd1b5cce1e03588d8184", "patch": "@@ -1004,7 +1004,10 @@ LLVMRustOptimizeWithNewPassManager(\n #endif\n   bool NeedThinLTOBufferPasses = UseThinLTOBuffers;\n   if (!NoPrepopulatePasses) {\n-    if (OptLevel == OptimizationLevel::O0) {\n+    // The pre-link pipelines don't support O0 and require using budilO0DefaultPipeline() instead.\n+    // At the same time, the LTO pipelines do support O0 and using them is required.\n+    bool IsLTO = OptStage == LLVMRustOptStage::ThinLTO || OptStage == LLVMRustOptStage::FatLTO;\n+    if (OptLevel == OptimizationLevel::O0 && !IsLTO) {\n #if LLVM_VERSION_GE(12, 0)\n       for (const auto &C : PipelineStartEPCallbacks)\n         PB.registerPipelineStartEPCallback(C);"}]}