{"sha": "74ddaf000cd6c17b9b99721fa84d091922c6eb14", "node_id": "MDY6Q29tbWl0NzI0NzEyOjc0ZGRhZjAwMGNkNmMxN2I5Yjk5NzIxZmE4NGQwOTE5MjJjNmViMTQ=", "commit": {"author": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2021-01-21T01:57:47Z"}, "committer": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2021-01-22T05:41:46Z"}, "message": "Avoid emitting redundant \"unused label\" lint", "tree": {"sha": "6afb9bf34c74e9094f84220e0e07dc6321084b62", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6afb9bf34c74e9094f84220e0e07dc6321084b62"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/74ddaf000cd6c17b9b99721fa84d091922c6eb14", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/74ddaf000cd6c17b9b99721fa84d091922c6eb14", "html_url": "https://github.com/rust-lang/rust/commit/74ddaf000cd6c17b9b99721fa84d091922c6eb14", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/74ddaf000cd6c17b9b99721fa84d091922c6eb14/comments", "author": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "committer": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c065234b341b285bb9a082d8303131a6a0207f0f", "url": "https://api.github.com/repos/rust-lang/rust/commits/c065234b341b285bb9a082d8303131a6a0207f0f", "html_url": "https://github.com/rust-lang/rust/commit/c065234b341b285bb9a082d8303131a6a0207f0f"}], "stats": {"total": 84, "additions": 20, "deletions": 64}, "files": [{"sha": "bed7a350ea86daf6f721258a0d8543039653d94d", "filename": "compiler/rustc_resolve/src/late/diagnostics.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/74ddaf000cd6c17b9b99721fa84d091922c6eb14/compiler%2Frustc_resolve%2Fsrc%2Flate%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/74ddaf000cd6c17b9b99721fa84d091922c6eb14/compiler%2Frustc_resolve%2Fsrc%2Flate%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Flate%2Fdiagnostics.rs?ref=74ddaf000cd6c17b9b99721fa84d091922c6eb14", "patch": "@@ -545,7 +545,7 @@ impl<'a: 'ast, 'ast> LateResolutionVisitor<'a, '_, 'ast> {\n         if let Some(err_code) = &err.code {\n             if err_code == &rustc_errors::error_code!(E0425) {\n                 for label_rib in &self.label_ribs {\n-                    for (label_ident, _) in &label_rib.bindings {\n+                    for (label_ident, node_id) in &label_rib.bindings {\n                         if format!(\"'{}\", ident) == label_ident.to_string() {\n                             err.span_label(label_ident.span, \"a label with a similar name exists\");\n                             if let PathSource::Expr(Some(Expr {\n@@ -559,6 +559,8 @@ impl<'a: 'ast, 'ast> LateResolutionVisitor<'a, '_, 'ast> {\n                                     label_ident.name.to_string(),\n                                     Applicability::MaybeIncorrect,\n                                 );\n+                                // Do not lint against unused label when we suggest them.\n+                                self.diagnostic_metadata.unused_labels.remove(node_id);\n                             }\n                         }\n                     }"}, {"sha": "e3180b06ecb2bfa33694e7c94c64efde0a8d801e", "filename": "src/test/ui/label/label_misspelled.rs", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/74ddaf000cd6c17b9b99721fa84d091922c6eb14/src%2Ftest%2Fui%2Flabel%2Flabel_misspelled.rs", "raw_url": "https://github.com/rust-lang/rust/raw/74ddaf000cd6c17b9b99721fa84d091922c6eb14/src%2Ftest%2Fui%2Flabel%2Flabel_misspelled.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flabel%2Flabel_misspelled.rs?ref=74ddaf000cd6c17b9b99721fa84d091922c6eb14", "patch": "@@ -25,22 +25,18 @@ fn main() {\n \n fn foo() {\n     'LOOP: loop {\n-        //~^ WARN unused label\n         break LOOP;\n         //~^ ERROR cannot find value `LOOP` in this scope\n     };\n     'while_loop: while true { //~ WARN denote infinite loops with\n-        //~^ WARN unused label\n         break while_loop;\n         //~^ ERROR cannot find value `while_loop` in this scope\n     };\n     'while_let: while let Some(_) = Some(()) {\n-        //~^ WARN unused label\n         break while_let;\n         //~^ ERROR cannot find value `while_let` in this scope\n     }\n     'for_loop: for _ in 0..3 {\n-        //~^ WARN unused label\n         break for_loop;\n         //~^ ERROR cannot find value `for_loop` in this scope\n     };"}, {"sha": "b09695787a443ae6108a5c200d15c00352c66e55", "filename": "src/test/ui/label/label_misspelled.stderr", "status": "modified", "additions": 13, "deletions": 41, "changes": 54, "blob_url": "https://github.com/rust-lang/rust/blob/74ddaf000cd6c17b9b99721fa84d091922c6eb14/src%2Ftest%2Fui%2Flabel%2Flabel_misspelled.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/74ddaf000cd6c17b9b99721fa84d091922c6eb14/src%2Ftest%2Fui%2Flabel%2Flabel_misspelled.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flabel%2Flabel_misspelled.stderr?ref=74ddaf000cd6c17b9b99721fa84d091922c6eb14", "patch": "@@ -35,47 +35,43 @@ LL |         LOOP;\n    |         ^^^^ not found in this scope\n \n error[E0425]: cannot find value `LOOP` in this scope\n-  --> $DIR/label_misspelled.rs:29:15\n+  --> $DIR/label_misspelled.rs:28:15\n    |\n LL |     'LOOP: loop {\n    |     ----- a label with a similar name exists\n-LL |\n LL |         break LOOP;\n    |               ^^^^\n    |               |\n    |               not found in this scope\n    |               help: use the similarly named label: `'LOOP`\n \n error[E0425]: cannot find value `while_loop` in this scope\n-  --> $DIR/label_misspelled.rs:34:15\n+  --> $DIR/label_misspelled.rs:32:15\n    |\n LL |     'while_loop: while true {\n    |     ----------- a label with a similar name exists\n-LL |\n LL |         break while_loop;\n    |               ^^^^^^^^^^\n    |               |\n    |               not found in this scope\n    |               help: use the similarly named label: `'while_loop`\n \n error[E0425]: cannot find value `while_let` in this scope\n-  --> $DIR/label_misspelled.rs:39:15\n+  --> $DIR/label_misspelled.rs:36:15\n    |\n LL |     'while_let: while let Some(_) = Some(()) {\n    |     ---------- a label with a similar name exists\n-LL |\n LL |         break while_let;\n    |               ^^^^^^^^^\n    |               |\n    |               not found in this scope\n    |               help: use the similarly named label: `'while_let`\n \n error[E0425]: cannot find value `for_loop` in this scope\n-  --> $DIR/label_misspelled.rs:44:15\n+  --> $DIR/label_misspelled.rs:40:15\n    |\n LL |     'for_loop: for _ in 0..3 {\n    |     --------- a label with a similar name exists\n-LL |\n LL |         break for_loop;\n    |               ^^^^^^^^\n    |               |\n@@ -120,62 +116,38 @@ warning: unused label\n LL |     'LOOP: loop {\n    |     ^^^^^\n \n-warning: unused label\n-  --> $DIR/label_misspelled.rs:27:5\n-   |\n-LL |     'LOOP: loop {\n-   |     ^^^^^\n-\n-warning: unused label\n-  --> $DIR/label_misspelled.rs:32:5\n-   |\n-LL |     'while_loop: while true {\n-   |     ^^^^^^^^^^^\n-\n warning: denote infinite loops with `loop { ... }`\n-  --> $DIR/label_misspelled.rs:32:5\n+  --> $DIR/label_misspelled.rs:31:5\n    |\n LL |     'while_loop: while true {\n    |     ^^^^^^^^^^^^^^^^^^^^^^^ help: use `loop`\n \n warning: unused label\n-  --> $DIR/label_misspelled.rs:37:5\n-   |\n-LL |     'while_let: while let Some(_) = Some(()) {\n-   |     ^^^^^^^^^^\n-\n-warning: unused label\n-  --> $DIR/label_misspelled.rs:42:5\n-   |\n-LL |     'for_loop: for _ in 0..3 {\n-   |     ^^^^^^^^^\n-\n-warning: unused label\n-  --> $DIR/label_misspelled.rs:51:5\n+  --> $DIR/label_misspelled.rs:47:5\n    |\n LL |     'while_loop: while true {\n    |     ^^^^^^^^^^^\n \n warning: denote infinite loops with `loop { ... }`\n-  --> $DIR/label_misspelled.rs:51:5\n+  --> $DIR/label_misspelled.rs:47:5\n    |\n LL |     'while_loop: while true {\n    |     ^^^^^^^^^^^^^^^^^^^^^^^ help: use `loop`\n \n warning: unused label\n-  --> $DIR/label_misspelled.rs:56:5\n+  --> $DIR/label_misspelled.rs:52:5\n    |\n LL |     'while_let: while let Some(_) = Some(()) {\n    |     ^^^^^^^^^^\n \n warning: unused label\n-  --> $DIR/label_misspelled.rs:61:5\n+  --> $DIR/label_misspelled.rs:57:5\n    |\n LL |     'for_loop: for _ in 0..3 {\n    |     ^^^^^^^^^\n \n error[E0571]: `break` with value from a `while` loop\n-  --> $DIR/label_misspelled.rs:53:9\n+  --> $DIR/label_misspelled.rs:49:9\n    |\n LL |     'while_loop: while true {\n    |     ----------------------- you can't `break` with a value in a `while` loop\n@@ -193,7 +165,7 @@ LL |         break 'while_loop;\n    |               ^^^^^^^^^^^\n \n error[E0571]: `break` with value from a `while` loop\n-  --> $DIR/label_misspelled.rs:58:9\n+  --> $DIR/label_misspelled.rs:54:9\n    |\n LL |     'while_let: while let Some(_) = Some(()) {\n    |     ---------------------------------------- you can't `break` with a value in a `while` loop\n@@ -211,7 +183,7 @@ LL |         break 'while_let;\n    |               ^^^^^^^^^^\n \n error[E0571]: `break` with value from a `for` loop\n-  --> $DIR/label_misspelled.rs:63:9\n+  --> $DIR/label_misspelled.rs:59:9\n    |\n LL |     'for_loop: for _ in 0..3 {\n    |     ------------------------ you can't `break` with a value in a `for` loop\n@@ -228,7 +200,7 @@ help: alternatively, you might have meant to use the available loop label\n LL |         break 'for_loop;\n    |               ^^^^^^^^^\n \n-error: aborting due to 11 previous errors; 14 warnings emitted\n+error: aborting due to 11 previous errors; 10 warnings emitted\n \n Some errors have detailed explanations: E0425, E0571.\n For more information about an error, try `rustc --explain E0425`."}, {"sha": "28bfe6f26cf0887633c3d1098a06ead5813927f7", "filename": "src/test/ui/label/label_misspelled_2.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/74ddaf000cd6c17b9b99721fa84d091922c6eb14/src%2Ftest%2Fui%2Flabel%2Flabel_misspelled_2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/74ddaf000cd6c17b9b99721fa84d091922c6eb14/src%2Ftest%2Fui%2Flabel%2Flabel_misspelled_2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flabel%2Flabel_misspelled_2.rs?ref=74ddaf000cd6c17b9b99721fa84d091922c6eb14", "patch": "@@ -5,7 +5,6 @@ fn main() {\n         break 'a;\n     }\n     'b: for _ in 0..1 {\n-        //~^ WARN unused label\n         break b; //~ ERROR cannot find value `b` in this scope\n     }\n     c: for _ in 0..1 { //~ ERROR expected identifier, found keyword `for`"}, {"sha": "c1921b952745f775c164b1af5c6d8307b854be24", "filename": "src/test/ui/label/label_misspelled_2.stderr", "status": "modified", "additions": 4, "deletions": 17, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/74ddaf000cd6c17b9b99721fa84d091922c6eb14/src%2Ftest%2Fui%2Flabel%2Flabel_misspelled_2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/74ddaf000cd6c17b9b99721fa84d091922c6eb14/src%2Ftest%2Fui%2Flabel%2Flabel_misspelled_2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flabel%2Flabel_misspelled_2.stderr?ref=74ddaf000cd6c17b9b99721fa84d091922c6eb14", "patch": "@@ -1,11 +1,11 @@\n error: expected identifier, found keyword `for`\n-  --> $DIR/label_misspelled_2.rs:11:8\n+  --> $DIR/label_misspelled_2.rs:10:8\n    |\n LL |     c: for _ in 0..1 {\n    |        ^^^ expected identifier, found keyword\n \n error: expected `<`, found reserved identifier `_`\n-  --> $DIR/label_misspelled_2.rs:11:12\n+  --> $DIR/label_misspelled_2.rs:10:12\n    |\n LL |     c: for _ in 0..1 {\n    |      -     ^ expected `<`\n@@ -16,29 +16,16 @@ LL |     c: for _ in 0..1 {\n    = note: see issue #23416 <https://github.com/rust-lang/rust/issues/23416> for more information\n \n error[E0425]: cannot find value `b` in this scope\n-  --> $DIR/label_misspelled_2.rs:9:15\n+  --> $DIR/label_misspelled_2.rs:8:15\n    |\n LL |     'b: for _ in 0..1 {\n    |     -- a label with a similar name exists\n-LL |\n LL |         break b;\n    |               ^\n    |               |\n    |               not found in this scope\n    |               help: use the similarly named label: `'b`\n \n-warning: unused label\n-  --> $DIR/label_misspelled_2.rs:7:5\n-   |\n-LL |     'b: for _ in 0..1 {\n-   |     ^^\n-   |\n-note: the lint level is defined here\n-  --> $DIR/label_misspelled_2.rs:1:9\n-   |\n-LL | #![warn(unused_labels)]\n-   |         ^^^^^^^^^^^^^\n-\n-error: aborting due to 3 previous errors; 1 warning emitted\n+error: aborting due to 3 previous errors\n \n For more information about this error, try `rustc --explain E0425`."}]}