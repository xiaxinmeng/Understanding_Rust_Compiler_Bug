{"sha": "52b83d7e26e2ef3691f2e2d80588558c8f59af19", "node_id": "MDY6Q29tbWl0NzI0NzEyOjUyYjgzZDdlMjZlMmVmMzY5MWYyZTJkODA1ODg1NThjOGY1OWFmMTk=", "commit": {"author": {"name": "David Wood", "email": "david@davidtw.co", "date": "2018-05-19T15:21:17Z"}, "committer": {"name": "David Wood", "email": "david@davidtw.co", "date": "2018-05-20T18:34:37Z"}, "message": "Added rustdoc documentation step outputting into compiler documentation.", "tree": {"sha": "fd9b05519dab33d61003ab360af93eb602efef3e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fd9b05519dab33d61003ab360af93eb602efef3e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/52b83d7e26e2ef3691f2e2d80588558c8f59af19", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEWwgxPGhT5b/6kagXAXYLT59T8VQFAlsBv70ACgkQAXYLT59T\n8VTXxQ//TupBQSJeDwiHaPIHQJ9UXmHjklixQi9mm5zkwOYZOAkAJ3c2xUOGih2E\nSOcJ8rOpVZBw6LhwNiOd2NpLSXQF4slxc11NS1w3hlI8F/JVwVDcCiTdlrl4lMO+\nugdq7X9UBDVCp5VyfnTVwXU8wL8AP7G28WfiYInLhU/ioB1lbDJSKPoEex97hX6U\nASnKsY+DXXp4u26ngdbV+cC4W3/7Q95y4EaYyhRhxPCqauLfOzGWxAUMH1qOYteP\niQtK8en3DDOLHHAJZGGH9NOC+MkVTcfUbISVNcowbntoXjIfRjbx0n2QCgsNRJPf\nCY3qVOLAv2f8HuO5FEwZXm8Ht0LjqfGw06bV5Tb8cD3AbjkV4s35q/pM4dGL+0n3\n5pauDhiPIB8QNEBTR+7fctQd5s5edcywLYYf+uAUWAWEi+ZDrw9E/kn4RrgELZZu\nIAy4ECane6bN3afyYpS+dXi/ii+WiB4oEQH0+bPS7TE63gpdZpPtpODm3Lf4NQQt\nYu+j5mIo+HhtO8Xs+CHo9lhTPuWsLnup7iIMQirx6B3kWlbPV7TxqfbDfdRPXBTO\nBtHjuX5dbymjgUZagwEkkN6fRkyXCX6zu85imc/tx5/mtFJ6Pw62C6yC/30grSAt\n/9WxffyzDNI+nrEbdGjJS3JQ4+di1yb5MP17EZ8gvHlgHHc++40=\n=ptQ+\n-----END PGP SIGNATURE-----", "payload": "tree fd9b05519dab33d61003ab360af93eb602efef3e\nparent fd18d2537ddcffb24b3739393b085ed28dfc340e\nauthor David Wood <david@davidtw.co> 1526743277 +0100\ncommitter David Wood <david@davidtw.co> 1526841277 +0100\n\nAdded rustdoc documentation step outputting into compiler documentation.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/52b83d7e26e2ef3691f2e2d80588558c8f59af19", "html_url": "https://github.com/rust-lang/rust/commit/52b83d7e26e2ef3691f2e2d80588558c8f59af19", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/52b83d7e26e2ef3691f2e2d80588558c8f59af19/comments", "author": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "committer": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "fd18d2537ddcffb24b3739393b085ed28dfc340e", "url": "https://api.github.com/repos/rust-lang/rust/commits/fd18d2537ddcffb24b3739393b085ed28dfc340e", "html_url": "https://github.com/rust-lang/rust/commit/fd18d2537ddcffb24b3739393b085ed28dfc340e"}], "stats": {"total": 92, "additions": 84, "deletions": 8}, "files": [{"sha": "7b55a94a91c0de36fc99a07aab0f0faa7b3f7089", "filename": "src/bootstrap/builder.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/52b83d7e26e2ef3691f2e2d80588558c8f59af19/src%2Fbootstrap%2Fbuilder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/52b83d7e26e2ef3691f2e2d80588558c8f59af19/src%2Fbootstrap%2Fbuilder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuilder.rs?ref=52b83d7e26e2ef3691f2e2d80588558c8f59af19", "patch": "@@ -352,8 +352,8 @@ impl<'a> Builder<'a> {\n             Kind::Bench => describe!(test::Crate, test::CrateLibrustc),\n             Kind::Doc => describe!(doc::UnstableBook, doc::UnstableBookGen, doc::TheBook,\n                 doc::Standalone, doc::Std, doc::Test, doc::WhitelistedRustc, doc::Rustc,\n-                doc::ErrorIndex, doc::Nomicon, doc::Reference, doc::Rustdoc, doc::RustByExample,\n-                doc::RustcBook, doc::CargoBook),\n+                doc::Rustdoc, doc::ErrorIndex, doc::Nomicon, doc::Reference, doc::RustdocBook,\n+                doc::RustByExample, doc::RustcBook, doc::CargoBook),\n             Kind::Dist => describe!(dist::Docs, dist::RustcDocs, dist::Mingw, dist::Rustc,\n                 dist::DebuggerScripts, dist::Std, dist::Analysis, dist::Src,\n                 dist::PlainSourceTarball, dist::Cargo, dist::Rls, dist::Rustfmt, dist::Extended,"}, {"sha": "65493b9cfaef67aff1ff90043137a458b96bb956", "filename": "src/bootstrap/doc.rs", "status": "modified", "additions": 82, "deletions": 6, "changes": 88, "blob_url": "https://github.com/rust-lang/rust/blob/52b83d7e26e2ef3691f2e2d80588558c8f59af19/src%2Fbootstrap%2Fdoc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/52b83d7e26e2ef3691f2e2d80588558c8f59af19/src%2Fbootstrap%2Fdoc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fdoc.rs?ref=52b83d7e26e2ef3691f2e2d80588558c8f59af19", "patch": "@@ -28,7 +28,7 @@ use build_helper::up_to_date;\n \n use util::symlink_dir;\n use builder::{Builder, Compiler, RunConfig, ShouldRun, Step};\n-use tool::Tool;\n+use tool::{self, prepare_tool_cargo, Tool};\n use compile;\n use cache::{INTERNER, Interned};\n use config::Config;\n@@ -70,7 +70,7 @@ macro_rules! book {\n book!(\n     Nomicon, \"src/doc/nomicon\", \"nomicon\";\n     Reference, \"src/doc/reference\", \"reference\";\n-    Rustdoc, \"src/doc/rustdoc\", \"rustdoc\";\n+    RustdocBook, \"src/doc/rustdoc\", \"rustdoc\";\n     RustcBook, \"src/doc/rustc\", \"rustc\";\n     RustByExample, \"src/doc/rust-by-example\", \"rust-by-example\";\n );\n@@ -665,8 +665,12 @@ impl Step for Rustc {\n         let stage = self.stage;\n         let target = self.target;\n         builder.info(&format!(\"Documenting stage{} compiler ({})\", stage, target));\n+\n+        // This is the intended out directory for compiler documentation.\n         let out = builder.compiler_doc_out(target);\n         t!(fs::create_dir_all(&out));\n+\n+        // Get the correct compiler for this stage.\n         let compiler = builder.compiler(stage, builder.config.build);\n         let rustdoc = builder.rustdoc(compiler.host);\n         let compiler = if builder.force_use_stage1(compiler, target) {\n@@ -676,21 +680,23 @@ impl Step for Rustc {\n         };\n \n         if !builder.config.compiler_docs {\n-            builder.info(&format!(\"\\tskipping - compiler docs disabled\"));\n+            builder.info(&format!(\"\\tskipping - compiler/librustdoc docs disabled\"));\n             return;\n         }\n \n-        // Build libstd docs so that we generate relative links\n+        // Build libstd docs so that we generate relative links.\n         builder.ensure(Std { stage, target });\n \n+        // Build rustc.\n         builder.ensure(compile::Rustc { compiler, target });\n-        let out_dir = builder.stage_out(compiler, Mode::Librustc)\n-                           .join(target).join(\"doc\");\n+\n         // We do not symlink to the same shared folder that already contains std library\n         // documentation from previous steps as we do not want to include that.\n+        let out_dir = builder.stage_out(compiler, Mode::Librustc).join(target).join(\"doc\");\n         builder.clear_if_dirty(&out, &rustdoc);\n         t!(symlink_dir_force(&builder.config, &out, &out_dir));\n \n+        // Build cargo command.\n         let mut cargo = builder.cargo(compiler, Mode::Librustc, target, \"doc\");\n         cargo.env(\"RUSTDOCFLAGS\", \"--document-private-items\");\n         compile::rustc_cargo(builder, &mut cargo);\n@@ -729,6 +735,76 @@ fn find_compiler_crates(\n     }\n }\n \n+#[derive(Debug, Copy, Clone, Hash, PartialEq, Eq)]\n+pub struct Rustdoc {\n+    stage: u32,\n+    target: Interned<String>,\n+}\n+\n+impl Step for Rustdoc {\n+    type Output = ();\n+    const DEFAULT: bool = true;\n+    const ONLY_HOSTS: bool = true;\n+\n+    fn should_run(run: ShouldRun) -> ShouldRun {\n+        run.krate(\"rustdoc-tool\")\n+    }\n+\n+    fn make_run(run: RunConfig) {\n+        run.builder.ensure(Rustdoc {\n+            stage: run.builder.top_stage,\n+            target: run.target,\n+        });\n+    }\n+\n+    /// Generate compiler documentation.\n+    ///\n+    /// This will generate all documentation for compiler and dependencies.\n+    /// Compiler documentation is distributed separately, so we make sure\n+    /// we do not merge it with the other documentation from std, test and\n+    /// proc_macros. This is largely just a wrapper around `cargo doc`.\n+    fn run(self, builder: &Builder) {\n+        let stage = self.stage;\n+        let target = self.target;\n+        builder.info(&format!(\"Documenting stage{} rustdoc ({})\", stage, target));\n+\n+        // This is the intended out directory for compiler documentation.\n+        let out = builder.compiler_doc_out(target);\n+        t!(fs::create_dir_all(&out));\n+\n+        // Get the correct compiler for this stage.\n+        let compiler = builder.compiler(stage, builder.config.build);\n+        let rustdoc = builder.rustdoc(compiler.host);\n+        let compiler = if builder.force_use_stage1(compiler, target) {\n+            builder.compiler(1, compiler.host)\n+        } else {\n+            compiler\n+        };\n+\n+        if !builder.config.compiler_docs {\n+            builder.info(&format!(\"\\tskipping - compiler/librustdoc docs disabled\"));\n+            return;\n+        }\n+\n+        // Build libstd docs so that we generate relative links.\n+        builder.ensure(Std { stage, target });\n+\n+        // Build rustdoc.\n+        builder.ensure(tool::Rustdoc { host: compiler.host });\n+\n+        // Symlink compiler docs to the output directory of rustdoc documentation.\n+        let out_dir = builder.stage_out(compiler, Mode::Tool).join(target).join(\"doc\");\n+        t!(fs::create_dir_all(&out_dir));\n+        builder.clear_if_dirty(&out, &rustdoc);\n+        t!(symlink_dir_force(&builder.config, &out, &out_dir));\n+\n+        // Build cargo command.\n+        let mut cargo = prepare_tool_cargo(builder, compiler, target, \"doc\", \"src/tools/rustdoc\");\n+        cargo.env(\"RUSTDOCFLAGS\", \"--document-private-items\");\n+        builder.run(&mut cargo);\n+    }\n+}\n+\n #[derive(Debug, Copy, Clone, Hash, PartialEq, Eq)]\n pub struct ErrorIndex {\n     target: Interned<String>,"}]}