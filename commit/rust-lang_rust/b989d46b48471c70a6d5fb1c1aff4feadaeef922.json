{"sha": "b989d46b48471c70a6d5fb1c1aff4feadaeef922", "node_id": "MDY6Q29tbWl0NzI0NzEyOmI5ODlkNDZiNDg0NzFjNzBhNmQ1ZmIxYzFhZmY0ZmVhZGFlZWY5MjI=", "commit": {"author": {"name": "12101111", "email": "w12101111@gmail.com", "date": "2020-10-25T12:13:14Z"}, "committer": {"name": "12101111", "email": "w12101111@gmail.com", "date": "2020-10-26T02:34:07Z"}, "message": "Support enable/disable sanitizers/profiler per target", "tree": {"sha": "681cb69b809804a816271fddafb2cbe59a82fae2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/681cb69b809804a816271fddafb2cbe59a82fae2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b989d46b48471c70a6d5fb1c1aff4feadaeef922", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b989d46b48471c70a6d5fb1c1aff4feadaeef922", "html_url": "https://github.com/rust-lang/rust/commit/b989d46b48471c70a6d5fb1c1aff4feadaeef922", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b989d46b48471c70a6d5fb1c1aff4feadaeef922/comments", "author": {"login": "12101111", "id": 8438475, "node_id": "MDQ6VXNlcjg0Mzg0NzU=", "avatar_url": "https://avatars.githubusercontent.com/u/8438475?v=4", "gravatar_id": "", "url": "https://api.github.com/users/12101111", "html_url": "https://github.com/12101111", "followers_url": "https://api.github.com/users/12101111/followers", "following_url": "https://api.github.com/users/12101111/following{/other_user}", "gists_url": "https://api.github.com/users/12101111/gists{/gist_id}", "starred_url": "https://api.github.com/users/12101111/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/12101111/subscriptions", "organizations_url": "https://api.github.com/users/12101111/orgs", "repos_url": "https://api.github.com/users/12101111/repos", "events_url": "https://api.github.com/users/12101111/events{/privacy}", "received_events_url": "https://api.github.com/users/12101111/received_events", "type": "User", "site_admin": false}, "committer": {"login": "12101111", "id": 8438475, "node_id": "MDQ6VXNlcjg0Mzg0NzU=", "avatar_url": "https://avatars.githubusercontent.com/u/8438475?v=4", "gravatar_id": "", "url": "https://api.github.com/users/12101111", "html_url": "https://github.com/12101111", "followers_url": "https://api.github.com/users/12101111/followers", "following_url": "https://api.github.com/users/12101111/following{/other_user}", "gists_url": "https://api.github.com/users/12101111/gists{/gist_id}", "starred_url": "https://api.github.com/users/12101111/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/12101111/subscriptions", "organizations_url": "https://api.github.com/users/12101111/orgs", "repos_url": "https://api.github.com/users/12101111/repos", "events_url": "https://api.github.com/users/12101111/events{/privacy}", "received_events_url": "https://api.github.com/users/12101111/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b6ac411f45d38d867ce9f689bbd5c3e7456d0f65", "url": "https://api.github.com/repos/rust-lang/rust/commits/b6ac411f45d38d867ce9f689bbd5c3e7456d0f65", "html_url": "https://github.com/rust-lang/rust/commit/b6ac411f45d38d867ce9f689bbd5c3e7456d0f65"}], "stats": {"total": 72, "additions": 55, "deletions": 17}, "files": [{"sha": "e47002c04906689bea59e61ba0b49886763b1ac2", "filename": "config.toml.example", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/b989d46b48471c70a6d5fb1c1aff4feadaeef922/config.toml.example", "raw_url": "https://github.com/rust-lang/rust/raw/b989d46b48471c70a6d5fb1c1aff4feadaeef922/config.toml.example", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/config.toml.example?ref=b989d46b48471c70a6d5fb1c1aff4feadaeef922", "patch": "@@ -582,6 +582,15 @@ changelog-seen = 2\n # build native code.\n #android-ndk = \"/path/to/ndk\"\n \n+# Build the sanitizer runtimes for this target.\n+# This option will override the same option under [build] section.\n+#sanitizers = false\n+\n+# Build the profiler runtime for this target(required when compiling with options that depend\n+# on this runtime, such as `-C profile-generate` or `-Z instrument-coverage`).\n+# This option will override the same option under [build] section.\n+#profiler = false\n+\n # Force static or dynamic linkage of the standard library for this target. If\n # this target is a host for rustc, this will also affect the linkage of the\n # compiler itself. This is useful for building rustc on targets that normally"}, {"sha": "bc2d503c8c4cee8af49c0a1d2b0e2e44ba9291c0", "filename": "src/bootstrap/builder.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/b989d46b48471c70a6d5fb1c1aff4feadaeef922/src%2Fbootstrap%2Fbuilder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b989d46b48471c70a6d5fb1c1aff4feadaeef922/src%2Fbootstrap%2Fbuilder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuilder.rs?ref=b989d46b48471c70a6d5fb1c1aff4feadaeef922", "patch": "@@ -264,7 +264,7 @@ impl<'a> ShouldRun<'a> {\n     /// `all_krates` should probably be removed at some point.\n     pub fn all_krates(mut self, name: &str) -> Self {\n         let mut set = BTreeSet::new();\n-        for krate in self.builder.in_tree_crates(name) {\n+        for krate in self.builder.in_tree_crates(name, None) {\n             let path = krate.local_path(self.builder);\n             set.insert(path);\n         }\n@@ -277,7 +277,7 @@ impl<'a> ShouldRun<'a> {\n     ///\n     /// `make_run` will be called separately for each matching command-line path.\n     pub fn krate(mut self, name: &str) -> Self {\n-        for krate in self.builder.in_tree_crates(name) {\n+        for krate in self.builder.in_tree_crates(name, None) {\n             let path = krate.local_path(self.builder);\n             self.paths.insert(PathSet::one(path));\n         }"}, {"sha": "f44483095500ba379dc847f47fd2ab5116b8a5e9", "filename": "src/bootstrap/check.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/b989d46b48471c70a6d5fb1c1aff4feadaeef922/src%2Fbootstrap%2Fcheck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b989d46b48471c70a6d5fb1c1aff4feadaeef922/src%2Fbootstrap%2Fcheck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcheck.rs?ref=b989d46b48471c70a6d5fb1c1aff4feadaeef922", "patch": "@@ -91,7 +91,7 @@ impl Step for Std {\n             // Explicitly pass -p for all dependencies krates -- this will force cargo\n             // to also check the tests/benches/examples for these crates, rather\n             // than just the leaf crate.\n-            for krate in builder.in_tree_crates(\"test\") {\n+            for krate in builder.in_tree_crates(\"test\", Some(target)) {\n                 cargo.arg(\"-p\").arg(krate.name);\n             }\n \n@@ -155,7 +155,7 @@ impl Step for Rustc {\n         // Explicitly pass -p for all compiler krates -- this will force cargo\n         // to also check the tests/benches/examples for these crates, rather\n         // than just the leaf crate.\n-        for krate in builder.in_tree_crates(\"rustc-main\") {\n+        for krate in builder.in_tree_crates(\"rustc-main\", Some(target)) {\n             cargo.arg(\"-p\").arg(krate.name);\n         }\n "}, {"sha": "b6654e8868b5028d0fbb9038567ab1890665653d", "filename": "src/bootstrap/compile.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/b989d46b48471c70a6d5fb1c1aff4feadaeef922/src%2Fbootstrap%2Fcompile.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b989d46b48471c70a6d5fb1c1aff4feadaeef922/src%2Fbootstrap%2Fcompile.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcompile.rs?ref=b989d46b48471c70a6d5fb1c1aff4feadaeef922", "patch": "@@ -143,7 +143,7 @@ fn copy_third_party_objects(\n         }\n     }\n \n-    if builder.config.sanitizers && compiler.stage != 0 {\n+    if builder.config.sanitizers_enabled(target) && compiler.stage != 0 {\n         // The sanitizers are only copied in stage1 or above,\n         // to avoid creating dependency on LLVM.\n         target_deps.extend(\n@@ -251,7 +251,7 @@ pub fn std_cargo(builder: &Builder<'_>, target: TargetSelection, stage: u32, car\n             .arg(\"--features\")\n             .arg(features);\n     } else {\n-        let mut features = builder.std_features();\n+        let mut features = builder.std_features(target);\n         features.push_str(compiler_builtins_c_feature);\n \n         cargo"}, {"sha": "034b6c9bf1960f436f61117b6f53b2462ba456bd", "filename": "src/bootstrap/config.rs", "status": "modified", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/b989d46b48471c70a6d5fb1c1aff4feadaeef922/src%2Fbootstrap%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b989d46b48471c70a6d5fb1c1aff4feadaeef922/src%2Fbootstrap%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fconfig.rs?ref=b989d46b48471c70a6d5fb1c1aff4feadaeef922", "patch": "@@ -251,6 +251,8 @@ pub struct Target {\n     pub ranlib: Option<PathBuf>,\n     pub linker: Option<PathBuf>,\n     pub ndk: Option<PathBuf>,\n+    pub sanitizers: bool,\n+    pub profiler: bool,\n     pub crt_static: Option<bool>,\n     pub musl_root: Option<PathBuf>,\n     pub musl_libdir: Option<PathBuf>,\n@@ -474,6 +476,8 @@ struct TomlTarget {\n     llvm_config: Option<String>,\n     llvm_filecheck: Option<String>,\n     android_ndk: Option<String>,\n+    sanitizers: Option<bool>,\n+    profiler: Option<bool>,\n     crt_static: Option<bool>,\n     musl_root: Option<String>,\n     musl_libdir: Option<String>,\n@@ -857,6 +861,8 @@ impl Config {\n                 target.musl_libdir = cfg.musl_libdir.map(PathBuf::from);\n                 target.wasi_root = cfg.wasi_root.map(PathBuf::from);\n                 target.qemu_rootfs = cfg.qemu_rootfs.map(PathBuf::from);\n+                target.sanitizers = cfg.sanitizers.unwrap_or(build.sanitizers.unwrap_or_default());\n+                target.profiler = cfg.profiler.unwrap_or(build.profiler.unwrap_or_default());\n \n                 config.target_config.insert(TargetSelection::from_user(&triple), target);\n             }\n@@ -959,6 +965,22 @@ impl Config {\n         self.verbose > 1\n     }\n \n+    pub fn sanitizers_enabled(&self, target: TargetSelection) -> bool {\n+        self.target_config.get(&target).map(|t| t.sanitizers).unwrap_or(self.sanitizers)\n+    }\n+\n+    pub fn any_sanitizers_enabled(&self) -> bool {\n+        self.target_config.values().any(|t| t.sanitizers) || self.sanitizers\n+    }\n+\n+    pub fn profiler_enabled(&self, target: TargetSelection) -> bool {\n+        self.target_config.get(&target).map(|t| t.profiler).unwrap_or(self.profiler)\n+    }\n+\n+    pub fn any_profiler_enabled(&self) -> bool {\n+        self.target_config.values().any(|t| t.profiler) || self.profiler\n+    }\n+\n     pub fn llvm_enabled(&self) -> bool {\n         self.rust_codegen_backends.contains(&INTERNER.intern_str(\"llvm\"))\n     }"}, {"sha": "af7f7eff89418be4ad24d2c265712c0edea1fd32", "filename": "src/bootstrap/doc.rs", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/b989d46b48471c70a6d5fb1c1aff4feadaeef922/src%2Fbootstrap%2Fdoc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b989d46b48471c70a6d5fb1c1aff4feadaeef922/src%2Fbootstrap%2Fdoc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fdoc.rs?ref=b989d46b48471c70a6d5fb1c1aff4feadaeef922", "patch": "@@ -535,8 +535,12 @@ impl Step for Rustc {\n         // Find dependencies for top level crates.\n         let mut compiler_crates = HashSet::new();\n         for root_crate in &[\"rustc_driver\", \"rustc_codegen_llvm\", \"rustc_codegen_ssa\"] {\n-            compiler_crates\n-                .extend(builder.in_tree_crates(root_crate).into_iter().map(|krate| krate.name));\n+            compiler_crates.extend(\n+                builder\n+                    .in_tree_crates(root_crate, Some(target))\n+                    .into_iter()\n+                    .map(|krate| krate.name),\n+            );\n         }\n \n         for krate in &compiler_crates {"}, {"sha": "5593f72dfe3873c59e5bc85ef0089a8003470a1e", "filename": "src/bootstrap/lib.rs", "status": "modified", "additions": 7, "deletions": 4, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/b989d46b48471c70a6d5fb1c1aff4feadaeef922/src%2Fbootstrap%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b989d46b48471c70a6d5fb1c1aff4feadaeef922/src%2Fbootstrap%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Flib.rs?ref=b989d46b48471c70a6d5fb1c1aff4feadaeef922", "patch": "@@ -534,7 +534,7 @@ impl Build {\n \n     /// Gets the space-separated set of activated features for the standard\n     /// library.\n-    fn std_features(&self) -> String {\n+    fn std_features(&self, target: TargetSelection) -> String {\n         let mut features = \"panic-unwind\".to_string();\n \n         if self.config.llvm_libunwind {\n@@ -543,7 +543,7 @@ impl Build {\n         if self.config.backtrace {\n             features.push_str(\" backtrace\");\n         }\n-        if self.config.profiler {\n+        if self.config.profiler_enabled(target) {\n             features.push_str(\" profiler\");\n         }\n         features\n@@ -1105,7 +1105,7 @@ impl Build {\n     /// Returns a Vec of all the dependencies of the given root crate,\n     /// including transitive dependencies and the root itself. Only includes\n     /// \"local\" crates (those in the local source tree, not from a registry).\n-    fn in_tree_crates(&self, root: &str) -> Vec<&Crate> {\n+    fn in_tree_crates(&self, root: &str, target: Option<TargetSelection>) -> Vec<&Crate> {\n         let mut ret = Vec::new();\n         let mut list = vec![INTERNER.intern_str(root)];\n         let mut visited = HashSet::new();\n@@ -1122,7 +1122,10 @@ impl Build {\n                 // metadata::build.\n                 if visited.insert(dep)\n                     && dep != \"build_helper\"\n-                    && (dep != \"profiler_builtins\" || self.config.profiler)\n+                    && (dep != \"profiler_builtins\"\n+                        || target\n+                            .map(|t| self.config.profiler_enabled(t))\n+                            .unwrap_or(self.config.any_profiler_enabled()))\n                     && (dep != \"rustc_codegen_llvm\" || self.config.llvm_enabled())\n                 {\n                     list.push(*dep);"}, {"sha": "4cfcf6ca407b5b17a856f695ac64772738074933", "filename": "src/bootstrap/sanity.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b989d46b48471c70a6d5fb1c1aff4feadaeef922/src%2Fbootstrap%2Fsanity.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b989d46b48471c70a6d5fb1c1aff4feadaeef922/src%2Fbootstrap%2Fsanity.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fsanity.rs?ref=b989d46b48471c70a6d5fb1c1aff4feadaeef922", "patch": "@@ -91,7 +91,7 @@ pub fn check(build: &mut Build) {\n                 .unwrap_or(true)\n         })\n         .any(|build_llvm_ourselves| build_llvm_ourselves);\n-    if building_llvm || build.config.sanitizers {\n+    if building_llvm || build.config.any_sanitizers_enabled() {\n         cmd_finder.must_have(\"cmake\");\n     }\n "}, {"sha": "81b55b2564cef83f170e518cae5145bdfc4683ea", "filename": "src/bootstrap/test.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/b989d46b48471c70a6d5fb1c1aff4feadaeef922/src%2Fbootstrap%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b989d46b48471c70a6d5fb1c1aff4feadaeef922/src%2Fbootstrap%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Ftest.rs?ref=b989d46b48471c70a6d5fb1c1aff4feadaeef922", "patch": "@@ -1265,11 +1265,11 @@ note: if you're sure you want to do this, please open an issue as to why. In the\n         cmd.env(\"RUSTC_BOOTSTRAP\", \"1\");\n         builder.add_rust_test_threads(&mut cmd);\n \n-        if builder.config.sanitizers {\n+        if builder.config.sanitizers_enabled(target) {\n             cmd.env(\"RUSTC_SANITIZER_SUPPORT\", \"1\");\n         }\n \n-        if builder.config.profiler {\n+        if builder.config.profiler_enabled(target) {\n             cmd.env(\"RUSTC_PROFILER_SUPPORT\", \"1\");\n         }\n \n@@ -1585,7 +1585,7 @@ impl Step for CrateLibrustc {\n         let builder = run.builder;\n         let compiler = builder.compiler(builder.top_stage, run.build_triple());\n \n-        for krate in builder.in_tree_crates(\"rustc-main\") {\n+        for krate in builder.in_tree_crates(\"rustc-main\", Some(run.target)) {\n             if krate.path.ends_with(&run.path) {\n                 let test_kind = builder.kind.into();\n \n@@ -1692,7 +1692,7 @@ impl Step for Crate {\n             });\n         };\n \n-        for krate in builder.in_tree_crates(\"test\") {\n+        for krate in builder.in_tree_crates(\"test\", Some(run.target)) {\n             if krate.path.ends_with(&run.path) {\n                 make(Mode::Std, krate);\n             }"}]}