{"sha": "b2c20b51ed838368d3f2bdccb63f401bcddb7e1c", "node_id": "MDY6Q29tbWl0NzI0NzEyOmIyYzIwYjUxZWQ4MzgzNjhkM2YyYmRjY2I2M2Y0MDFiY2RkYjdlMWM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-04-20T03:08:24Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-04-20T03:08:24Z"}, "message": "Auto merge of #84295 - richkadel:continue-coverage, r=tmandry\n\nAdd coverage to continue statements\n\n`continue` statements were missing coverage. This was particularly\nnoticeable in a match pattern that contained only a `continue`\nstatement, leaving the branch appear uncounted. This PR addresses the\nproblem and adds tests to prove it.\n\nr? `@tmandry`\ncc: `@wesleywiser`", "tree": {"sha": "b0af4165f7549a3915410a8d8e52587a7e8bf948", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b0af4165f7549a3915410a8d8e52587a7e8bf948"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b2c20b51ed838368d3f2bdccb63f401bcddb7e1c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b2c20b51ed838368d3f2bdccb63f401bcddb7e1c", "html_url": "https://github.com/rust-lang/rust/commit/b2c20b51ed838368d3f2bdccb63f401bcddb7e1c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b2c20b51ed838368d3f2bdccb63f401bcddb7e1c/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e888a57da83fca78d6e64af0a347d06d9161affe", "url": "https://api.github.com/repos/rust-lang/rust/commits/e888a57da83fca78d6e64af0a347d06d9161affe", "html_url": "https://github.com/rust-lang/rust/commit/e888a57da83fca78d6e64af0a347d06d9161affe"}, {"sha": "d1d7fb1ae53a02f5073a7cf0ab1497aaa9617ebe", "url": "https://api.github.com/repos/rust-lang/rust/commits/d1d7fb1ae53a02f5073a7cf0ab1497aaa9617ebe", "html_url": "https://github.com/rust-lang/rust/commit/d1d7fb1ae53a02f5073a7cf0ab1497aaa9617ebe"}], "stats": {"total": 163, "additions": 161, "deletions": 2}, "files": [{"sha": "41fc925c0494ed850ee21c84354b1a0b038e8f1f", "filename": "compiler/rustc_mir_build/src/build/scope.rs", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/b2c20b51ed838368d3f2bdccb63f401bcddb7e1c/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fscope.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b2c20b51ed838368d3f2bdccb63f401bcddb7e1c/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fscope.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fscope.rs?ref=b2c20b51ed838368d3f2bdccb63f401bcddb7e1c", "patch": "@@ -618,6 +618,13 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n             }\n         } else {\n             assert!(value.is_none(), \"`return` and `break` should have a destination\");\n+            if self.tcx.sess.instrument_coverage() {\n+                // Unlike `break` and `return`, which push an `Assign` statement to MIR, from which\n+                // a Coverage code region can be generated, `continue` needs no `Assign`; but\n+                // without one, the `InstrumentCoverage` MIR pass cannot generate a code region for\n+                // `continue`. Coverage will be missing unless we add a dummy `Assign` to MIR.\n+                self.add_dummy_assignment(&span, block, source_info);\n+            }\n         }\n \n         let region_scope = self.scopes.breakable_scopes[break_index].region_scope;\n@@ -643,6 +650,14 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n         self.cfg.start_new_block().unit()\n     }\n \n+    // Add a dummy `Assign` statement to the CFG, with the span for the source code's `continue`\n+    // statement.\n+    fn add_dummy_assignment(&mut self, span: &Span, block: BasicBlock, source_info: SourceInfo) {\n+        let local_decl = LocalDecl::new(self.tcx.mk_unit(), *span).internal();\n+        let temp_place = Place::from(self.local_decls.push(local_decl));\n+        self.cfg.push_assign_unit(block, source_info, temp_place, self.tcx);\n+    }\n+\n     crate fn exit_top_scope(\n         &mut self,\n         mut block: BasicBlock,"}, {"sha": "28e0f1953e0499ac762619f1a084ccc42ea2b72b", "filename": "src/test/run-make-fulldeps/coverage-reports/expected_show_coverage.continue.txt", "status": "added", "additions": 75, "deletions": 0, "changes": 75, "blob_url": "https://github.com/rust-lang/rust/blob/b2c20b51ed838368d3f2bdccb63f401bcddb7e1c/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2Fexpected_show_coverage.continue.txt", "raw_url": "https://github.com/rust-lang/rust/raw/b2c20b51ed838368d3f2bdccb63f401bcddb7e1c/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2Fexpected_show_coverage.continue.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2Fexpected_show_coverage.continue.txt?ref=b2c20b51ed838368d3f2bdccb63f401bcddb7e1c", "patch": "@@ -0,0 +1,75 @@\n+    1|       |#![allow(unused_assignments, unused_variables)]\n+    2|       |\n+    3|      1|fn main() {\n+    4|      1|    let is_true = std::env::args().len() == 1;\n+    5|      1|\n+    6|      1|    let mut x = 0;\n+    7|     11|    for _ in 0..10 {\n+                      ^10\n+    8|     10|        match is_true {\n+    9|       |            true => {\n+   10|     10|                continue;\n+   11|       |            }\n+   12|      0|            _ => {\n+   13|      0|                x = 1;\n+   14|      0|            }\n+   15|      0|        }\n+   16|      0|        x = 3;\n+   17|       |    }\n+   18|     11|    for _ in 0..10 {\n+                      ^10\n+   19|     10|        match is_true {\n+   20|      0|            false => {\n+   21|      0|                x = 1;\n+   22|      0|            }\n+   23|       |            _ => {\n+   24|     10|                continue;\n+   25|       |            }\n+   26|       |        }\n+   27|      0|        x = 3;\n+   28|       |    }\n+   29|     11|    for _ in 0..10 {\n+                      ^10\n+   30|     10|        match is_true {\n+   31|     10|            true => {\n+   32|     10|                x = 1;\n+   33|     10|            }\n+   34|       |            _ => {\n+   35|      0|                continue;\n+   36|       |            }\n+   37|       |        }\n+   38|     10|        x = 3;\n+   39|       |    }\n+   40|     11|    for _ in 0..10 {\n+                      ^10\n+   41|     10|        if is_true {\n+   42|     10|            continue;\n+   43|      0|        }\n+   44|      0|        x = 3;\n+   45|       |    }\n+   46|     11|    for _ in 0..10 {\n+                      ^10\n+   47|     10|        match is_true {\n+   48|      0|            false => {\n+   49|      0|                x = 1;\n+   50|      0|            }\n+   51|     10|            _ => {\n+   52|     10|                let _ = x;\n+   53|     10|            }\n+   54|       |        }\n+   55|     10|        x = 3;\n+   56|       |    }\n+   57|      1|    for _ in 0..10 {\n+   58|      1|        match is_true {\n+   59|      0|            false => {\n+   60|      0|                x = 1;\n+   61|      0|            }\n+   62|       |            _ => {\n+   63|      1|                break;\n+   64|       |            }\n+   65|       |        }\n+   66|      0|        x = 3;\n+   67|       |    }\n+   68|       |    let _ = x;\n+   69|      1|}\n+"}, {"sha": "f5beb9ef24a0e4b355772651115ce519a316b16f", "filename": "src/test/run-make-fulldeps/coverage-reports/expected_show_coverage.uses_crate.txt", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/b2c20b51ed838368d3f2bdccb63f401bcddb7e1c/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2Fexpected_show_coverage.uses_crate.txt", "raw_url": "https://github.com/rust-lang/rust/raw/b2c20b51ed838368d3f2bdccb63f401bcddb7e1c/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2Fexpected_show_coverage.uses_crate.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2Fexpected_show_coverage.uses_crate.txt?ref=b2c20b51ed838368d3f2bdccb63f401bcddb7e1c", "patch": "@@ -19,12 +19,12 @@\n    18|      2|    println!(\"used_only_from_bin_crate_generic_function with {:?}\", arg);\n    19|      2|}\n   ------------------\n-  | used_crate::used_only_from_bin_crate_generic_function::<&alloc::vec::Vec<i32>>:\n+  | used_crate::used_only_from_bin_crate_generic_function::<&str>:\n   |   17|      1|pub fn used_only_from_bin_crate_generic_function<T: Debug>(arg: T) {\n   |   18|      1|    println!(\"used_only_from_bin_crate_generic_function with {:?}\", arg);\n   |   19|      1|}\n   ------------------\n-  | used_crate::used_only_from_bin_crate_generic_function::<&str>:\n+  | used_crate::used_only_from_bin_crate_generic_function::<&alloc::vec::Vec<i32>>:\n   |   17|      1|pub fn used_only_from_bin_crate_generic_function<T: Debug>(arg: T) {\n   |   18|      1|    println!(\"used_only_from_bin_crate_generic_function with {:?}\", arg);\n   |   19|      1|}"}, {"sha": "624aa98341b80c61ec28ed702991239ed82386e5", "filename": "src/test/run-make-fulldeps/coverage/continue.rs", "status": "added", "additions": 69, "deletions": 0, "changes": 69, "blob_url": "https://github.com/rust-lang/rust/blob/b2c20b51ed838368d3f2bdccb63f401bcddb7e1c/src%2Ftest%2Frun-make-fulldeps%2Fcoverage%2Fcontinue.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b2c20b51ed838368d3f2bdccb63f401bcddb7e1c/src%2Ftest%2Frun-make-fulldeps%2Fcoverage%2Fcontinue.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fcoverage%2Fcontinue.rs?ref=b2c20b51ed838368d3f2bdccb63f401bcddb7e1c", "patch": "@@ -0,0 +1,69 @@\n+#![allow(unused_assignments, unused_variables)]\n+\n+fn main() {\n+    let is_true = std::env::args().len() == 1;\n+\n+    let mut x = 0;\n+    for _ in 0..10 {\n+        match is_true {\n+            true => {\n+                continue;\n+            }\n+            _ => {\n+                x = 1;\n+            }\n+        }\n+        x = 3;\n+    }\n+    for _ in 0..10 {\n+        match is_true {\n+            false => {\n+                x = 1;\n+            }\n+            _ => {\n+                continue;\n+            }\n+        }\n+        x = 3;\n+    }\n+    for _ in 0..10 {\n+        match is_true {\n+            true => {\n+                x = 1;\n+            }\n+            _ => {\n+                continue;\n+            }\n+        }\n+        x = 3;\n+    }\n+    for _ in 0..10 {\n+        if is_true {\n+            continue;\n+        }\n+        x = 3;\n+    }\n+    for _ in 0..10 {\n+        match is_true {\n+            false => {\n+                x = 1;\n+            }\n+            _ => {\n+                let _ = x;\n+            }\n+        }\n+        x = 3;\n+    }\n+    for _ in 0..10 {\n+        match is_true {\n+            false => {\n+                x = 1;\n+            }\n+            _ => {\n+                break;\n+            }\n+        }\n+        x = 3;\n+    }\n+    let _ = x;\n+}"}]}