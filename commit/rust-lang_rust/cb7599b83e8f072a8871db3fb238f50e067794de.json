{"sha": "cb7599b83e8f072a8871db3fb238f50e067794de", "node_id": "MDY6Q29tbWl0NzI0NzEyOmNiNzU5OWI4M2U4ZjA3MmE4ODcxZGIzZmIyMzhmNTBlMDY3Nzk0ZGU=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2014-12-30T03:47:58Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2014-12-30T03:47:58Z"}, "message": "rollup merge of #20317: brson/rust-installer-v2", "tree": {"sha": "0d4d7e4caf5b32dfe639a4109009b0189c27dcae", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0d4d7e4caf5b32dfe639a4109009b0189c27dcae"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cb7599b83e8f072a8871db3fb238f50e067794de", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cb7599b83e8f072a8871db3fb238f50e067794de", "html_url": "https://github.com/rust-lang/rust/commit/cb7599b83e8f072a8871db3fb238f50e067794de", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cb7599b83e8f072a8871db3fb238f50e067794de/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "021c2f3712312d3170b1dbd27a3bd92360b541d3", "url": "https://api.github.com/repos/rust-lang/rust/commits/021c2f3712312d3170b1dbd27a3bd92360b541d3", "html_url": "https://github.com/rust-lang/rust/commit/021c2f3712312d3170b1dbd27a3bd92360b541d3"}, {"sha": "b12dfbb49124d6bae0fa6a4fdadde0bb1ba171cb", "url": "https://api.github.com/repos/rust-lang/rust/commits/b12dfbb49124d6bae0fa6a4fdadde0bb1ba171cb", "html_url": "https://github.com/rust-lang/rust/commit/b12dfbb49124d6bae0fa6a4fdadde0bb1ba171cb"}], "stats": {"total": 112, "additions": 83, "deletions": 29}, "files": [{"sha": "963627dbe099723f16c3cf12512f33d2d6815154", "filename": "mk/dist.mk", "status": "modified", "additions": 75, "deletions": 22, "changes": 97, "blob_url": "https://github.com/rust-lang/rust/blob/cb7599b83e8f072a8871db3fb238f50e067794de/mk%2Fdist.mk", "raw_url": "https://github.com/rust-lang/rust/raw/cb7599b83e8f072a8871db3fb238f50e067794de/mk%2Fdist.mk", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/mk%2Fdist.mk?ref=cb7599b83e8f072a8871db3fb238f50e067794de", "patch": "@@ -23,6 +23,8 @@\n # * dist-docs - Stage docs for upload\n \n PKG_NAME := $(CFG_PACKAGE_NAME)\n+DOC_PKG_NAME := rust-docs-$(CFG_PACKAGE_VERS)\n+MINGW_PKG_NAME := rust-mingw-$(CFG_PACKAGE_VERS)\n \n # License suitable for displaying in a popup\n LICENSE.txt: $(S)COPYRIGHT $(S)LICENSE-APACHE $(S)LICENSE-MIT\n@@ -229,10 +231,20 @@ dist-install-dir-$(1): prepare-base-dir-$(1) docs compiler-docs\n \t$$(Q)$$(PREPARE_MAN_CMD) $$(S)LICENSE-APACHE $$(PREPARE_DEST_DIR)\n \t$$(Q)$$(PREPARE_MAN_CMD) $$(S)LICENSE-MIT $$(PREPARE_DEST_DIR)\n \t$$(Q)$$(PREPARE_MAN_CMD) $$(S)README.md $$(PREPARE_DEST_DIR)\n-\t$$(Q)[ ! -d doc ] || cp -r doc $$(PREPARE_DEST_DIR)\n+\t$$(Q)mkdir -p $$(PREPARE_DEST_DIR)/share/doc/rust\n+\t$$(Q)$$(PREPARE_MAN_CMD) $$(S)COPYRIGHT $$(PREPARE_DEST_DIR)/share/doc/rust\n+\t$$(Q)$$(PREPARE_MAN_CMD) $$(S)LICENSE-APACHE $$(PREPARE_DEST_DIR)/share/doc/rust\n+\t$$(Q)$$(PREPARE_MAN_CMD) $$(S)LICENSE-MIT $$(PREPARE_DEST_DIR)/share/doc/rust\n+\t$$(Q)$$(PREPARE_MAN_CMD) $$(S)README.md $$(PREPARE_DEST_DIR)/share/doc/rust\n \n dist/$$(PKG_NAME)-$(1).tar.gz: dist-install-dir-$(1)\n \t@$(call E, build: $$@)\n+# Copy essential gcc components into installer\n+ifdef CFG_WINDOWSY_$(1)\n+\t$$(Q)rm -Rf dist/win-rust-gcc-$(1)\n+\t$$(Q)$$(CFG_PYTHON) $$(S)src/etc/make-win-dist.py tmp/dist/$$(PKG_NAME)-$(1)-image dist/win-rust-gcc-$(1) $(1)\n+\t$$(Q)cp -r $$(S)src/etc/third-party tmp/dist/$$(PKG_NAME)-$(1)-image/share/doc/\n+endif\n \t$$(Q)$$(S)src/rust-installer/gen-installer.sh \\\n \t\t--product-name=Rust \\\n \t\t--verify-bin=rustc \\\n@@ -242,9 +254,50 @@ dist/$$(PKG_NAME)-$(1).tar.gz: dist-install-dir-$(1)\n \t\t--work-dir=tmp/dist \\\n \t\t--output-dir=dist \\\n \t\t--non-installed-prefixes=$$(NON_INSTALLED_PREFIXES) \\\n-\t\t--package-name=$$(PKG_NAME)-$(1)\n+\t\t--package-name=$$(PKG_NAME)-$(1) \\\n+\t\t--component-name=rustc \\\n+\t\t--legacy-manifest-dirs=rustlib,cargo\n \t$$(Q)rm -R tmp/dist/$$(PKG_NAME)-$(1)-image\n \n+dist-doc-install-dir-$(1): docs compiler-docs\n+\t$$(Q)mkdir -p tmp/dist/$$(DOC_PKG_NAME)-$(1)-image/share/doc/rust\n+\t$$(Q)cp -r doc tmp/dist/$$(DOC_PKG_NAME)-$(1)-image/share/doc/rust/html\n+\n+dist/$$(DOC_PKG_NAME)-$(1).tar.gz: dist-doc-install-dir-$(1)\n+\t@$(call E, build: $$@)\n+\t$$(Q)$$(S)src/rust-installer/gen-installer.sh \\\n+\t\t--product-name=Rust-Documentation \\\n+\t\t--rel-manifest-dir=rustlib \\\n+\t\t--success-message=Rust-documentation-is-installed. \\\n+\t\t--image-dir=tmp/dist/$$(DOC_PKG_NAME)-$(1)-image \\\n+\t\t--work-dir=tmp/dist \\\n+\t\t--output-dir=dist \\\n+\t\t--package-name=$$(DOC_PKG_NAME)-$(1) \\\n+\t\t--component-name=rust-docs \\\n+\t\t--legacy-manifest-dirs=rustlib,cargo \\\n+\t\t--bulk-dirs=share/doc/rust/html\n+\t$$(Q)rm -R tmp/dist/$$(DOC_PKG_NAME)-$(1)-image\n+\n+dist-mingw-install-dir-$(1):\n+\t$$(Q)mkdir -p tmp/dist/rust-mingw-tmp-$(1)-image\n+\t$$(Q)rm -Rf tmp/dist/$$(MINGW_PKG_NAME)-$(1)-image\n+\t$$(Q)$$(CFG_PYTHON) $$(S)src/etc/make-win-dist.py \\\n+\t\ttmp/dist/rust-mingw-tmp-$(1)-image tmp/dist/$$(MINGW_PKG_NAME)-$(1)-image $(1)\n+\n+dist/$$(MINGW_PKG_NAME)-$(1).tar.gz: dist-mingw-install-dir-$(1)\n+\t@$(call E, build: $$@)\n+\t$$(Q)$$(S)src/rust-installer/gen-installer.sh \\\n+\t\t--product-name=Rust-MinGW \\\n+\t\t--rel-manifest-dir=rustlib \\\n+\t\t--success-message=Rust-MinGW-is-installed. \\\n+\t\t--image-dir=tmp/dist/$$(MINGW_PKG_NAME)-$(1)-image \\\n+\t\t--work-dir=tmp/dist \\\n+\t\t--output-dir=dist \\\n+\t\t--package-name=$$(MINGW_PKG_NAME)-$(1) \\\n+\t\t--component-name=rust-mingw \\\n+\t\t--legacy-manifest-dirs=rustlib,cargo\n+\t$$(Q)rm -R tmp/dist/$$(MINGW_PKG_NAME)-$(1)-image\n+\n endef\n \n ifneq ($(CFG_ENABLE_DIST_HOST_ONLY),)\n@@ -257,7 +310,16 @@ endif\n \n dist-install-dirs: $(foreach host,$(CFG_HOST),dist-install-dir-$(host))\n \n-dist-tar-bins: $(foreach host,$(CFG_HOST),dist/$(PKG_NAME)-$(host).tar.gz)\n+ifdef CFG_WINDOWSY_$(CFG_BUILD)\n+MAYBE_MINGW_TARBALLS=$(foreach host,$(CFG_HOST),dist/$(MINGW_PKG_NAME)-$(host).tar.gz)\n+endif\n+\n+ifeq ($(CFG_DISABLE_DOCS),)\n+MAYBE_DOC_TARBALLS=$(foreach host,$(CFG_HOST),dist/$(DOC_PKG_NAME)-$(host).tar.gz)\n+endif\n+\n+dist-tar-bins: $(foreach host,$(CFG_HOST),dist/$(PKG_NAME)-$(host).tar.gz) \\\n+\t$(MAYBE_DOC_TARBALLS) $(MAYBE_MINGW_TARBALLS)\n \n # Just try to run the compiler for the build host\n distcheck-tar-bins: dist-tar-bins\n@@ -289,27 +351,20 @@ distcheck-docs: dist-docs\n # Primary targets (dist, distcheck)\n ######################################################################\n \n-ifdef CFG_WINDOWSY_$(CFG_BUILD)\n-\n-dist: dist-win dist-tar-bins\n-\n-distcheck: distcheck-win\n-\t$(Q)rm -Rf tmp/distcheck\n-\t@echo\n-\t@echo -----------------------------------------------\n-\t@echo \"Rust ready for distribution (see ./dist)\"\n-\t@echo -----------------------------------------------\n-\n-else\n+MAYBE_DIST_TAR_SRC=dist-tar-src\n+MAYBE_DISTCHECK_TAR_SRC=distcheck-tar-src\n \n # FIXME #13224: On OS X don't produce tarballs simply because --exclude-vcs don't work.\n # This is a huge hack because I just don't have time to figure out another solution.\n ifeq ($(CFG_OSTYPE), apple-darwin)\n MAYBE_DIST_TAR_SRC=\n MAYBE_DISTCHECK_TAR_SRC=\n-else\n-MAYBE_DIST_TAR_SRC=dist-tar-src\n-MAYBE_DISTCHECK_TAR_SRC=distcheck-tar-src\n+endif\n+\n+# Don't bother with source tarballs on windows just because we historically haven't.\n+ifeq ($(CFG_OSTYPE), pc-windows-gnu)\n+MAYBE_DIST_TAR_SRC=\n+MAYBE_DISTCHECK_TAR_SRC=\n endif\n \n ifneq ($(CFG_DISABLE_DOCS),)\n@@ -320,15 +375,13 @@ MAYBE_DIST_DOCS=dist-docs\n MAYBE_DISTCHECK_DOCS=distcheck-docs\n endif\n \n-dist: $(MAYBE_DIST_TAR_SRC) dist-osx dist-tar-bins $(MAYBE_DIST_DOCS)\n+dist: $(MAYBE_DIST_TAR_SRC) dist-osx dist-win dist-tar-bins $(MAYBE_DIST_DOCS)\n \n-distcheck: $(MAYBE_DISTCHECK_TAR_SRC) distcheck-osx distcheck-tar-bins $(MAYBE_DISTCHECK_DOCS)\n+distcheck: $(MAYBE_DISTCHECK_TAR_SRC) distcheck-osx distcheck-win distcheck-tar-bins $(MAYBE_DISTCHECK_DOCS)\n \t$(Q)rm -Rf tmp/distcheck\n \t@echo\n \t@echo -----------------------------------------------\n \t@echo \"Rust ready for distribution (see ./dist)\"\n \t@echo -----------------------------------------------\n \n-endif\n-\n .PHONY: dist distcheck"}, {"sha": "f36ca4db7ca7ef13eddcbaa26cc46c5fc2e81af1", "filename": "mk/install.mk", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/cb7599b83e8f072a8871db3fb238f50e067794de/mk%2Finstall.mk", "raw_url": "https://github.com/rust-lang/rust/raw/cb7599b83e8f072a8871db3fb238f50e067794de/mk%2Finstall.mk", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/mk%2Finstall.mk?ref=cb7599b83e8f072a8871db3fb238f50e067794de", "patch": "@@ -20,6 +20,9 @@ ifeq (root user, $(USER) $(patsubst %,user,$(SUDO_USER)))\n \t$(Q)sudo -u \"$$SUDO_USER\" $(MAKE) prepare_install\n else\n \t$(Q)$(MAKE) prepare_install\n+endif\n+ifeq ($(CFG_DISABLE_DOCS),)\n+\t$(Q)cd tmp/empty_dir && sh ../../tmp/dist/$(DOC_PKG_NAME)-$(CFG_BUILD)/install.sh --prefix=\"$(DESTDIR)$(CFG_PREFIX)\" --libdir=\"$(DESTDIR)$(CFG_LIBDIR)\" --mandir=\"$(DESTDIR)$(CFG_MANDIR)\" \"$(MAYBE_DISABLE_VERIFY)\"\n endif\n \t$(Q)cd tmp/empty_dir && sh ../../tmp/dist/$(PKG_NAME)-$(CFG_BUILD)/install.sh --prefix=\"$(DESTDIR)$(CFG_PREFIX)\" --libdir=\"$(DESTDIR)$(CFG_LIBDIR)\" --mandir=\"$(DESTDIR)$(CFG_MANDIR)\" \"$(MAYBE_DISABLE_VERIFY)\"\n # Remove tmp files because it's a decent amount of disk space\n@@ -33,6 +36,9 @@ ifeq (root user, $(USER) $(patsubst %,user,$(SUDO_USER)))\n \t$(Q)sudo -u \"$$SUDO_USER\" $(MAKE) prepare_uninstall\n else\n \t$(Q)$(MAKE) prepare_uninstall\n+endif\n+ifeq ($(CFG_DISABLE_DOCS),)\n+\t$(Q)cd tmp/empty_dir && sh ../../tmp/dist/$(DOC_PKG_NAME)-$(CFG_BUILD)/install.sh --uninstall --prefix=\"$(DESTDIR)$(CFG_PREFIX)\" --libdir=\"$(DESTDIR)$(CFG_LIBDIR)\" --mandir=\"$(DESTDIR)$(CFG_MANDIR)\"\n endif\n \t$(Q)cd tmp/empty_dir && sh ../../tmp/dist/$(PKG_NAME)-$(CFG_BUILD)/install.sh --uninstall --prefix=\"$(DESTDIR)$(CFG_PREFIX)\" --libdir=\"$(DESTDIR)$(CFG_LIBDIR)\" --mandir=\"$(DESTDIR)$(CFG_MANDIR)\"\n # Remove tmp files because it's a decent amount of disk space"}, {"sha": "bf07d6de0e026eb766a27eeda227a63082f806af", "filename": "mk/tests.mk", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/cb7599b83e8f072a8871db3fb238f50e067794de/mk%2Ftests.mk", "raw_url": "https://github.com/rust-lang/rust/raw/cb7599b83e8f072a8871db3fb238f50e067794de/mk%2Ftests.mk", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/mk%2Ftests.mk?ref=cb7599b83e8f072a8871db3fb238f50e067794de", "patch": "@@ -289,6 +289,7 @@ tidy:\n \t\t| grep '^$(S)src/doc' -v \\\n \t\t| grep '^$(S)src/compiler-rt' -v \\\n \t\t| grep '^$(S)src/libbacktrace' -v \\\n+\t\t| grep '^$(S)src/rust-installer' -v \\\n \t\t| xargs $(CFG_PYTHON) $(S)src/etc/check-binaries.py\n \n endif"}, {"sha": "ea2a98db2dc1f94bc98fce3668c9a33fa18fadfd", "filename": "src/etc/make-win-dist.py", "status": "modified", "additions": 0, "deletions": 6, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/cb7599b83e8f072a8871db3fb238f50e067794de/src%2Fetc%2Fmake-win-dist.py", "raw_url": "https://github.com/rust-lang/rust/raw/cb7599b83e8f072a8871db3fb238f50e067794de/src%2Fetc%2Fmake-win-dist.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fetc%2Fmake-win-dist.py?ref=cb7599b83e8f072a8871db3fb238f50e067794de", "patch": "@@ -114,11 +114,5 @@ def make_win_dist(rust_root, gcc_root, target_triple):\n     for src in target_libs:\n         shutil.copy(src, target_lib_dir)\n \n-    # Copy license files\n-    lic_dir = os.path.join(rust_root, \"bin\", \"third-party\")\n-    if os.path.exists(lic_dir):\n-        shutil.rmtree(lic_dir) # copytree() won't overwrite existing files\n-    shutil.copytree(os.path.join(os.path.dirname(__file__), \"third-party\"), lic_dir)\n-\n if __name__==\"__main__\":\n     make_win_dist(sys.argv[1], sys.argv[2], sys.argv[3])"}, {"sha": "3a37981744a5af2433fed551f742465c78c9af7f", "filename": "src/rust-installer", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": null, "raw_url": null, "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frust-installer?ref=cb7599b83e8f072a8871db3fb238f50e067794de", "patch": "@@ -1 +1 @@\n-Subproject commit aed73472416064642911af790b25d57c9390b6c7\n+Subproject commit 3a37981744a5af2433fed551f742465c78c9af7f"}]}