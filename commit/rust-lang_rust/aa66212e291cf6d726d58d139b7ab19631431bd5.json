{"sha": "aa66212e291cf6d726d58d139b7ab19631431bd5", "node_id": "C_kwDOAAsO6NoAKGFhNjYyMTJlMjkxY2Y2ZDcyNmQ1OGQxMzliN2FiMTk2MzE0MzFiZDU", "commit": {"author": {"name": "xFrednet", "email": "xFrednet@gmail.com", "date": "2022-11-21T21:55:14Z"}, "committer": {"name": "xFrednet", "email": "xFrednet@gmail.com", "date": "2022-11-21T22:28:26Z"}, "message": "Cleanup `rustc_tool_util` and add a convenient macro for `build.rs`", "tree": {"sha": "38eae3b8f3d17d8423a09c1524ada6ed78399fef", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/38eae3b8f3d17d8423a09c1524ada6ed78399fef"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/aa66212e291cf6d726d58d139b7ab19631431bd5", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEwgBEOx3xlHwII7PG9cWdDmaeUwIFAmN7+4oACgkQ9cWdDmae\nUwL9Pw//TsKV38iwipMgeQKuLpKTno3Is5VGeGXKJZkKHO7YkS56aj6VNx0jg0Sz\nzFcmHJN2RpKgCS0idzMTCiJqgvFMl4+E4Lb7+8RVeMruHFdaoHZDidbGBUgkL00j\ndXeKju37O7aaSa9t1XXVH0U8yQU4TPC0FZUd1jF/ETIkw0MpI7ZboWSaQUgUYy+D\n5hwT1xSxT+vXjl5uqNYTB570C2F+ETExI7p/U3d3V+e6eburjdgxMv21TKUxb/xp\nFS+CoVMS39DL3JfjQ5lWzG61djkDaYFJVmQVEZuu6rbt8lvREmFuAgUOv6HZKdwo\n2E7x8JnH2UQvq/3v0nH4iEZK8ho2HZdLfhEIPSBizwAheP/GLVVUxztkJKw6DYoZ\nEiswNa/XbgYb1acUG3zK5990P1RJVD0Pg8Ar/jNyw3EmhDyCOLkA83WPfeuGUwnX\nOGtsrKJPhqVoHC0niJXNSw/5jZ+IoA6SBbq7Cs8hBABFh3y7kj4BwkGVfxMomG3r\nagH7OxALUB7HbjrRiQQdmK7jUJmJeFCBIrhNrjFmQOSqKlg2I4UOhBgQf38+BBW9\nFgOll7Jjaye/QUUNbbmt8FhWmCFVtpLtGwQqcZB+aJNA97xz9YU0bXZbBqHkhi2c\nJe5I18f8jxQnQ8IbvrtQ0ZSOOCzoMDp3EviGFx3eIZcSXWZ1n78=\n=xN1s\n-----END PGP SIGNATURE-----", "payload": "tree 38eae3b8f3d17d8423a09c1524ada6ed78399fef\nparent 73efce9ee6e971f45b20976c1efd96888faf4a1d\nauthor xFrednet <xFrednet@gmail.com> 1669067714 +0100\ncommitter xFrednet <xFrednet@gmail.com> 1669069706 +0100\n\nCleanup `rustc_tool_util` and add a convenient macro for `build.rs`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/aa66212e291cf6d726d58d139b7ab19631431bd5", "html_url": "https://github.com/rust-lang/rust/commit/aa66212e291cf6d726d58d139b7ab19631431bd5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/aa66212e291cf6d726d58d139b7ab19631431bd5/comments", "author": {"login": "xFrednet", "id": 17087237, "node_id": "MDQ6VXNlcjE3MDg3MjM3", "avatar_url": "https://avatars.githubusercontent.com/u/17087237?v=4", "gravatar_id": "", "url": "https://api.github.com/users/xFrednet", "html_url": "https://github.com/xFrednet", "followers_url": "https://api.github.com/users/xFrednet/followers", "following_url": "https://api.github.com/users/xFrednet/following{/other_user}", "gists_url": "https://api.github.com/users/xFrednet/gists{/gist_id}", "starred_url": "https://api.github.com/users/xFrednet/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/xFrednet/subscriptions", "organizations_url": "https://api.github.com/users/xFrednet/orgs", "repos_url": "https://api.github.com/users/xFrednet/repos", "events_url": "https://api.github.com/users/xFrednet/events{/privacy}", "received_events_url": "https://api.github.com/users/xFrednet/received_events", "type": "User", "site_admin": false}, "committer": {"login": "xFrednet", "id": 17087237, "node_id": "MDQ6VXNlcjE3MDg3MjM3", "avatar_url": "https://avatars.githubusercontent.com/u/17087237?v=4", "gravatar_id": "", "url": "https://api.github.com/users/xFrednet", "html_url": "https://github.com/xFrednet", "followers_url": "https://api.github.com/users/xFrednet/followers", "following_url": "https://api.github.com/users/xFrednet/following{/other_user}", "gists_url": "https://api.github.com/users/xFrednet/gists{/gist_id}", "starred_url": "https://api.github.com/users/xFrednet/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/xFrednet/subscriptions", "organizations_url": "https://api.github.com/users/xFrednet/orgs", "repos_url": "https://api.github.com/users/xFrednet/repos", "events_url": "https://api.github.com/users/xFrednet/events{/privacy}", "received_events_url": "https://api.github.com/users/xFrednet/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "73efce9ee6e971f45b20976c1efd96888faf4a1d", "url": "https://api.github.com/repos/rust-lang/rust/commits/73efce9ee6e971f45b20976c1efd96888faf4a1d", "html_url": "https://github.com/rust-lang/rust/commit/73efce9ee6e971f45b20976c1efd96888faf4a1d"}], "stats": {"total": 88, "additions": 43, "deletions": 45}, "files": [{"sha": "698ff035a861eaeac56fe6d5d27ff34108f0e5ce", "filename": "Cargo.toml", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/aa66212e291cf6d726d58d139b7ab19631431bd5/Cargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/aa66212e291cf6d726d58d139b7ab19631431bd5/Cargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.toml?ref=aa66212e291cf6d726d58d139b7ab19631431bd5", "patch": "@@ -23,7 +23,7 @@ path = \"src/driver.rs\"\n [dependencies]\n clippy_lints = { path = \"clippy_lints\" }\n semver = \"1.0\"\n-rustc_tools_util = \"0.2.1\"\n+rustc_tools_util = {version = \"0.2.1\", path = \"./rustc_tools_util\"}\n tempfile = { version = \"3.2\", optional = true }\n termize = \"0.1\"\n \n@@ -56,7 +56,7 @@ tokio = { version = \"1\", features = [\"io-util\"] }\n rustc-semver = \"1.1\"\n \n [build-dependencies]\n-rustc_tools_util = \"0.2.1\"\n+rustc_tools_util = {version = \"0.2.1\", path = \"./rustc_tools_util\"}\n \n [features]\n deny-warnings = [\"clippy_lints/deny-warnings\"]"}, {"sha": "b79d09b0dd2d2776e98a4ae73de9c2884e722677", "filename": "build.rs", "status": "modified", "additions": 1, "deletions": 13, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/aa66212e291cf6d726d58d139b7ab19631431bd5/build.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa66212e291cf6d726d58d139b7ab19631431bd5/build.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/build.rs?ref=aa66212e291cf6d726d58d139b7ab19631431bd5", "patch": "@@ -3,17 +3,5 @@ fn main() {\n     println!(\"cargo:rustc-env=PROFILE={}\", std::env::var(\"PROFILE\").unwrap());\n     // Don't rebuild even if nothing changed\n     println!(\"cargo:rerun-if-changed=build.rs\");\n-    // forward git repo hashes we build at\n-    println!(\n-        \"cargo:rustc-env=GIT_HASH={}\",\n-        rustc_tools_util::get_commit_hash().unwrap_or_default()\n-    );\n-    println!(\n-        \"cargo:rustc-env=COMMIT_DATE={}\",\n-        rustc_tools_util::get_commit_date().unwrap_or_default()\n-    );\n-    println!(\n-        \"cargo:rustc-env=RUSTC_RELEASE_CHANNEL={}\",\n-        rustc_tools_util::get_channel()\n-    );\n+    rustc_tools_util::setup_version_info!();\n }"}, {"sha": "6204ca174f35bc8e86a04bbce64050c19f500a1a", "filename": "rustc_tools_util/README.md", "status": "modified", "additions": 12, "deletions": 19, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/aa66212e291cf6d726d58d139b7ab19631431bd5/rustc_tools_util%2FREADME.md", "raw_url": "https://github.com/rust-lang/rust/raw/aa66212e291cf6d726d58d139b7ab19631431bd5/rustc_tools_util%2FREADME.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/rustc_tools_util%2FREADME.md?ref=aa66212e291cf6d726d58d139b7ab19631431bd5", "patch": "@@ -20,36 +20,29 @@ rustc_tools_util = \"0.2.1\"\n ````\n \n In `build.rs`, generate the data in your `main()`\n-````rust\n+\n+```rust\n fn main() {\n-    println!(\n-        \"cargo:rustc-env=GIT_HASH={}\",\n-        rustc_tools_util::get_commit_hash().unwrap_or_default()\n-    );\n-    println!(\n-        \"cargo:rustc-env=COMMIT_DATE={}\",\n-        rustc_tools_util::get_commit_date().unwrap_or_default()\n-    );\n-    println!(\n-        \"cargo:rustc-env=RUSTC_RELEASE_CHANNEL={}\",\n-        rustc_tools_util::get_channel().unwrap_or_default()\n-    );\n+    rustc_tools_util::setup_version_info!();\n }\n-\n-````\n+```\n \n Use the version information in your main.rs\n-````rust\n-use rustc_tools_util::*;\n \n+```rust\n fn show_version() {\n     let version_info = rustc_tools_util::get_version_info!();\n     println!(\"{}\", version_info);\n }\n-````\n+```\n+\n This gives the following output in clippy:\n-`clippy 0.0.212 (a416c5e 2018-12-14)`\n+`clippy 0.1.66 (a28f3c8 2022-11-20)`\n+\n+## Repository\n \n+This project is part of the rust-lang/rust-clippy repository. The source code\n+can be found under `./rustc_tools_util/`.\n \n ## License\n "}, {"sha": "5e856319c886de72c2e4606ae594db6fed337279", "filename": "rustc_tools_util/src/lib.rs", "status": "modified", "additions": 28, "deletions": 8, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/aa66212e291cf6d726d58d139b7ab19631431bd5/rustc_tools_util%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa66212e291cf6d726d58d139b7ab19631431bd5/rustc_tools_util%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/rustc_tools_util%2Fsrc%2Flib.rs?ref=aa66212e291cf6d726d58d139b7ab19631431bd5", "patch": "@@ -2,19 +2,21 @@\n \n use std::env;\n \n+/// This macro creates the version string during compilation from the\n+/// current environment\n #[macro_export]\n macro_rules! get_version_info {\n     () => {{\n-        let major = env!(\"CARGO_PKG_VERSION_MAJOR\").parse::<u8>().unwrap();\n-        let minor = env!(\"CARGO_PKG_VERSION_MINOR\").parse::<u8>().unwrap();\n-        let patch = env!(\"CARGO_PKG_VERSION_PATCH\").parse::<u16>().unwrap();\n-        let crate_name = String::from(env!(\"CARGO_PKG_NAME\"));\n+        let major = std::env!(\"CARGO_PKG_VERSION_MAJOR\").parse::<u8>().unwrap();\n+        let minor = std::env!(\"CARGO_PKG_VERSION_MINOR\").parse::<u8>().unwrap();\n+        let patch = std::env!(\"CARGO_PKG_VERSION_PATCH\").parse::<u16>().unwrap();\n+        let crate_name = String::from(std::env!(\"CARGO_PKG_NAME\"));\n \n-        let host_compiler = option_env!(\"RUSTC_RELEASE_CHANNEL\").map(str::to_string);\n-        let commit_hash = option_env!(\"GIT_HASH\").map(str::to_string);\n-        let commit_date = option_env!(\"COMMIT_DATE\").map(str::to_string);\n+        let host_compiler = std::option_env!(\"RUSTC_RELEASE_CHANNEL\").map(str::to_string);\n+        let commit_hash = std::option_env!(\"GIT_HASH\").map(str::to_string);\n+        let commit_date = std::option_env!(\"COMMIT_DATE\").map(str::to_string);\n \n-        VersionInfo {\n+        $crate::VersionInfo {\n             major,\n             minor,\n             patch,\n@@ -26,6 +28,24 @@ macro_rules! get_version_info {\n     }};\n }\n \n+/// This macro can be used in `build.rs` to automatically set the needed\n+/// environment values, namely `GIT_HASH`, `COMMIT_DATE` and\n+/// `RUSTC_RELEASE_CHANNEL`\n+#[macro_export]\n+macro_rules! setup_version_info {\n+    () => {{\n+        println!(\n+            \"cargo:rustc-env=GIT_HASH={}\",\n+            $crate::get_commit_hash().unwrap_or_default()\n+        );\n+        println!(\n+            \"cargo:rustc-env=COMMIT_DATE={}\",\n+            $crate::get_commit_date().unwrap_or_default()\n+        );\n+        println!(\"cargo:rustc-env=RUSTC_RELEASE_CHANNEL={}\", $crate::get_channel());\n+    }};\n+}\n+\n // some code taken and adapted from RLS and cargo\n pub struct VersionInfo {\n     pub major: u8,"}, {"sha": "0aa7d437b4da88c4c0484b313d1349bf94adf103", "filename": "src/driver.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/aa66212e291cf6d726d58d139b7ab19631431bd5/src%2Fdriver.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa66212e291cf6d726d58d139b7ab19631431bd5/src%2Fdriver.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdriver.rs?ref=aa66212e291cf6d726d58d139b7ab19631431bd5", "patch": "@@ -18,7 +18,6 @@ extern crate rustc_span;\n use rustc_interface::interface;\n use rustc_session::parse::ParseSess;\n use rustc_span::symbol::Symbol;\n-use rustc_tools_util::VersionInfo;\n \n use std::borrow::Cow;\n use std::env;"}, {"sha": "7a78b32620d0bf41301fa50cf781b6a5c658bb45", "filename": "src/main.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/aa66212e291cf6d726d58d139b7ab19631431bd5/src%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa66212e291cf6d726d58d139b7ab19631431bd5/src%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fmain.rs?ref=aa66212e291cf6d726d58d139b7ab19631431bd5", "patch": "@@ -2,7 +2,6 @@\n // warn on lints, that are included in `rust-lang/rust`s bootstrap\n #![warn(rust_2018_idioms, unused_lifetimes)]\n \n-use rustc_tools_util::VersionInfo;\n use std::env;\n use std::path::PathBuf;\n use std::process::{self, Command};"}, {"sha": "c721e9969c9aa67497c32ab03d2510e6e6ecaf11", "filename": "tests/versioncheck.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/aa66212e291cf6d726d58d139b7ab19631431bd5/tests%2Fversioncheck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa66212e291cf6d726d58d139b7ab19631431bd5/tests%2Fversioncheck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fversioncheck.rs?ref=aa66212e291cf6d726d58d139b7ab19631431bd5", "patch": "@@ -2,7 +2,6 @@\n #![warn(rust_2018_idioms, unused_lifetimes)]\n #![allow(clippy::single_match_else)]\n \n-use rustc_tools_util::VersionInfo;\n use std::fs;\n \n #[test]"}]}