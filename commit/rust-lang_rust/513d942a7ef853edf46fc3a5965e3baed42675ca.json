{"sha": "513d942a7ef853edf46fc3a5965e3baed42675ca", "node_id": "MDY6Q29tbWl0NzI0NzEyOjUxM2Q5NDJhN2VmODUzZWRmNDZmYzNhNTk2NWUzYmFlZDQyNjc1Y2E=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-01-11T15:45:28Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-01-11T15:45:28Z"}, "message": "Auto merge of #38989 - arielb1:constant-mir-overflow2, r=eddyb\n\nfix function arguments in constant promotion\n\nwe can't create the target block until *after* we promote the arguments - otherwise the arguments will be promoted into the target block. oops.\n\nFixes #38985.\n\nThis is a regression introduced in the beta-nominated #38833, so beta-nominating this one too (sorry @brson).\n\nr? @eddyb", "tree": {"sha": "3f22f01b181136b4468528b0171a910ffb7b8d49", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3f22f01b181136b4468528b0171a910ffb7b8d49"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/513d942a7ef853edf46fc3a5965e3baed42675ca", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/513d942a7ef853edf46fc3a5965e3baed42675ca", "html_url": "https://github.com/rust-lang/rust/commit/513d942a7ef853edf46fc3a5965e3baed42675ca", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/513d942a7ef853edf46fc3a5965e3baed42675ca/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "52c03d1d619fd25c961bc9de59bcc942b660d5db", "url": "https://api.github.com/repos/rust-lang/rust/commits/52c03d1d619fd25c961bc9de59bcc942b660d5db", "html_url": "https://github.com/rust-lang/rust/commit/52c03d1d619fd25c961bc9de59bcc942b660d5db"}, {"sha": "61b0b212f9609e56f06a63db8542c3a5288074d8", "url": "https://api.github.com/repos/rust-lang/rust/commits/61b0b212f9609e56f06a63db8542c3a5288074d8", "html_url": "https://github.com/rust-lang/rust/commit/61b0b212f9609e56f06a63db8542c3a5288074d8"}], "stats": {"total": 35, "additions": 22, "deletions": 13}, "files": [{"sha": "57cf4b1e8b02bf06edaa1cb49310b8e4c5289d40", "filename": "src/librustc_mir/transform/promote_consts.rs", "status": "modified", "additions": 15, "deletions": 13, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/513d942a7ef853edf46fc3a5965e3baed42675ca/src%2Flibrustc_mir%2Ftransform%2Fpromote_consts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/513d942a7ef853edf46fc3a5965e3baed42675ca/src%2Flibrustc_mir%2Ftransform%2Fpromote_consts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fpromote_consts.rs?ref=513d942a7ef853edf46fc3a5965e3baed42675ca", "patch": "@@ -237,7 +237,7 @@ impl<'a, 'tcx> Promoter<'a, 'tcx> {\n             self.visit_rvalue(&mut rvalue, loc);\n             self.assign(new_temp, rvalue, source_info.span);\n         } else {\n-            let mut terminator = if self.keep_original {\n+            let terminator = if self.keep_original {\n                 self.source[loc.block].terminator().clone()\n             } else {\n                 let terminator = self.source[loc.block].terminator_mut();\n@@ -255,28 +255,30 @@ impl<'a, 'tcx> Promoter<'a, 'tcx> {\n                 }\n             };\n \n-            let last = self.promoted.basic_blocks().last().unwrap();\n-            let new_target = self.new_block();\n-\n-            terminator.kind = match terminator.kind {\n+            match terminator.kind {\n                 TerminatorKind::Call { mut func, mut args, .. } => {\n                     self.visit_operand(&mut func, loc);\n                     for arg in &mut args {\n                         self.visit_operand(arg, loc);\n                     }\n-                    TerminatorKind::Call {\n-                        func: func,\n-                        args: args,\n-                        cleanup: None,\n-                        destination: Some((Lvalue::Local(new_temp), new_target))\n-                    }\n+\n+                    let last = self.promoted.basic_blocks().last().unwrap();\n+                    let new_target = self.new_block();\n+\n+                    *self.promoted[last].terminator_mut() = Terminator {\n+                        kind: TerminatorKind::Call {\n+                            func: func,\n+                            args: args,\n+                            cleanup: None,\n+                            destination: Some((Lvalue::Local(new_temp), new_target))\n+                        },\n+                        ..terminator\n+                    };\n                 }\n                 ref kind => {\n                     span_bug!(terminator.source_info.span, \"{:?} not promotable\", kind);\n                 }\n             };\n-\n-            *self.promoted[last].terminator_mut() = terminator;\n         };\n \n         self.keep_original = old_keep_original;"}, {"sha": "9bdde02d0061ce23b1643b4b34fedc0ef1e0cb83", "filename": "src/test/run-pass/issue-37991.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/513d942a7ef853edf46fc3a5965e3baed42675ca/src%2Ftest%2Frun-pass%2Fissue-37991.rs", "raw_url": "https://github.com/rust-lang/rust/raw/513d942a7ef853edf46fc3a5965e3baed42675ca/src%2Ftest%2Frun-pass%2Fissue-37991.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fissue-37991.rs?ref=513d942a7ef853edf46fc3a5965e3baed42675ca", "patch": "@@ -14,7 +14,14 @@ const fn foo() -> i64 {\n     3\n }\n \n+const fn bar(x: i64) -> i64 {\n+    x*2\n+}\n+\n fn main() {\n     let val = &(foo() % 2);\n     assert_eq!(*val, 1);\n+\n+    let val2 = &(bar(1+1) % 3);\n+    assert_eq!(*val2, 1);\n }"}]}