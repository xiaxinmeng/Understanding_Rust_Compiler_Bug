{"sha": "074d1ac2f7b3e8a6d4088983ac63235f71d3e6a5", "node_id": "MDY6Q29tbWl0NzI0NzEyOjA3NGQxYWMyZjdiM2U4YTZkNDA4ODk4M2FjNjMyMzVmNzFkM2U2YTU=", "commit": {"author": {"name": "Lauren\u021biu Nicola", "email": "lnicola@dend.ro", "date": "2020-05-03T09:46:20Z"}, "committer": {"name": "Lauren\u021biu Nicola", "email": "lnicola@dend.ro", "date": "2020-05-03T09:46:20Z"}, "message": "Log panics in apply_document_changes", "tree": {"sha": "3e4fd7284f6367961dc88ce65a1c6e387927d7f4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3e4fd7284f6367961dc88ce65a1c6e387927d7f4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/074d1ac2f7b3e8a6d4088983ac63235f71d3e6a5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/074d1ac2f7b3e8a6d4088983ac63235f71d3e6a5", "html_url": "https://github.com/rust-lang/rust/commit/074d1ac2f7b3e8a6d4088983ac63235f71d3e6a5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/074d1ac2f7b3e8a6d4088983ac63235f71d3e6a5/comments", "author": {"login": "lnicola", "id": 308347, "node_id": "MDQ6VXNlcjMwODM0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/308347?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lnicola", "html_url": "https://github.com/lnicola", "followers_url": "https://api.github.com/users/lnicola/followers", "following_url": "https://api.github.com/users/lnicola/following{/other_user}", "gists_url": "https://api.github.com/users/lnicola/gists{/gist_id}", "starred_url": "https://api.github.com/users/lnicola/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lnicola/subscriptions", "organizations_url": "https://api.github.com/users/lnicola/orgs", "repos_url": "https://api.github.com/users/lnicola/repos", "events_url": "https://api.github.com/users/lnicola/events{/privacy}", "received_events_url": "https://api.github.com/users/lnicola/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lnicola", "id": 308347, "node_id": "MDQ6VXNlcjMwODM0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/308347?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lnicola", "html_url": "https://github.com/lnicola", "followers_url": "https://api.github.com/users/lnicola/followers", "following_url": "https://api.github.com/users/lnicola/following{/other_user}", "gists_url": "https://api.github.com/users/lnicola/gists{/gist_id}", "starred_url": "https://api.github.com/users/lnicola/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lnicola/subscriptions", "organizations_url": "https://api.github.com/users/lnicola/orgs", "repos_url": "https://api.github.com/users/lnicola/repos", "events_url": "https://api.github.com/users/lnicola/events{/privacy}", "received_events_url": "https://api.github.com/users/lnicola/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "16d3bb9106762710d2a5314ae4042674dad1b446", "url": "https://api.github.com/repos/rust-lang/rust/commits/16d3bb9106762710d2a5314ae4042674dad1b446", "html_url": "https://github.com/rust-lang/rust/commit/16d3bb9106762710d2a5314ae4042674dad1b446"}], "stats": {"total": 18, "additions": 17, "deletions": 1}, "files": [{"sha": "7e7f05b6df4315c0c112fd81eb5ffb1eac6d3c6d", "filename": "crates/rust-analyzer/src/main_loop.rs", "status": "modified", "additions": 17, "deletions": 1, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/074d1ac2f7b3e8a6d4088983ac63235f71d3e6a5/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/074d1ac2f7b3e8a6d4088983ac63235f71d3e6a5/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs?ref=074d1ac2f7b3e8a6d4088983ac63235f71d3e6a5", "patch": "@@ -667,6 +667,10 @@ fn apply_document_changes(\n     mut line_index: Cow<'_, LineIndex>,\n     content_changes: Vec<TextDocumentContentChangeEvent>,\n ) {\n+    // Remove when https://github.com/rust-analyzer/rust-analyzer/issues/4263 is fixed.\n+    let backup_text = old_text.clone();\n+    let backup_changes = content_changes.clone();\n+\n     // The changes we got must be applied sequentially, but can cross lines so we\n     // have to keep our line index updated.\n     // Some clients (e.g. Code) sort the ranges in reverse. As an optimization, we\n@@ -694,7 +698,19 @@ fn apply_document_changes(\n                 }\n                 index_valid = IndexValid::UpToLine(range.start.line);\n                 let range = range.conv_with(&line_index);\n-                old_text.replace_range(Range::<usize>::from(range), &change.text);\n+                let mut text = old_text.to_owned();\n+                match std::panic::catch_unwind(move || {\n+                    text.replace_range(Range::<usize>::from(range), &change.text);\n+                    text\n+                }) {\n+                    Ok(t) => *old_text = t,\n+                    Err(e) => {\n+                        eprintln!(\"Bug in incremental text synchronization. Please report the following output on https://github.com/rust-analyzer/rust-analyzer/issues/4263\");\n+                        dbg!(&backup_text);\n+                        dbg!(&backup_changes);\n+                        std::panic::resume_unwind(e);\n+                    }\n+                }\n             }\n             None => {\n                 *old_text = change.text;"}]}