{"sha": "23c172ff0f2855446bb9242e3de69fbf67c99693", "node_id": "C_kwDOAAsO6NoAKDIzYzE3MmZmMGYyODU1NDQ2YmI5MjQyZTNkZTY5ZmJmNjdjOTk2OTM", "commit": {"author": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2021-12-17T07:10:53Z"}, "committer": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2021-12-17T07:10:53Z"}, "message": "Merge commit '533f0fc81ab9ba097779fcd27c8f9ea12261fef5' into psimd", "tree": {"sha": "2b3fcc15683085e611e550c1d67871ce82949480", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2b3fcc15683085e611e550c1d67871ce82949480"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/23c172ff0f2855446bb9242e3de69fbf67c99693", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/23c172ff0f2855446bb9242e3de69fbf67c99693", "html_url": "https://github.com/rust-lang/rust/commit/23c172ff0f2855446bb9242e3de69fbf67c99693", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/23c172ff0f2855446bb9242e3de69fbf67c99693/comments", "author": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "committer": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9b45f04414f3e4006fc2ed3d8e1fa7708efe0e53", "url": "https://api.github.com/repos/rust-lang/rust/commits/9b45f04414f3e4006fc2ed3d8e1fa7708efe0e53", "html_url": "https://github.com/rust-lang/rust/commit/9b45f04414f3e4006fc2ed3d8e1fa7708efe0e53"}, {"sha": "533f0fc81ab9ba097779fcd27c8f9ea12261fef5", "url": "https://api.github.com/repos/rust-lang/rust/commits/533f0fc81ab9ba097779fcd27c8f9ea12261fef5", "html_url": "https://github.com/rust-lang/rust/commit/533f0fc81ab9ba097779fcd27c8f9ea12261fef5"}], "stats": {"total": 87, "additions": 25, "deletions": 62}, "files": [{"sha": "b4217dc87ba9c209e3e07c57fe7120dc20bcb922", "filename": "library/portable-simd/crates/core_simd/src/masks/bitmask.rs", "status": "modified", "additions": 2, "deletions": 6, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/23c172ff0f2855446bb9242e3de69fbf67c99693/library%2Fportable-simd%2Fcrates%2Fcore_simd%2Fsrc%2Fmasks%2Fbitmask.rs", "raw_url": "https://github.com/rust-lang/rust/raw/23c172ff0f2855446bb9242e3de69fbf67c99693/library%2Fportable-simd%2Fcrates%2Fcore_simd%2Fsrc%2Fmasks%2Fbitmask.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fportable-simd%2Fcrates%2Fcore_simd%2Fsrc%2Fmasks%2Fbitmask.rs?ref=23c172ff0f2855446bb9242e3de69fbf67c99693", "patch": "@@ -105,18 +105,14 @@ where\n     #[must_use = \"method returns a new vector and does not mutate the original value\"]\n     pub fn to_int(self) -> Simd<T, LANES> {\n         unsafe {\n-            crate::intrinsics::simd_select_bitmask(\n-                self.0,\n-                Simd::splat(T::TRUE),\n-                Simd::splat(T::FALSE),\n-            )\n+            intrinsics::simd_select_bitmask(self.0, Simd::splat(T::TRUE), Simd::splat(T::FALSE))\n         }\n     }\n \n     #[inline]\n     #[must_use = \"method returns a new mask and does not mutate the original value\"]\n     pub unsafe fn from_int_unchecked(value: Simd<T, LANES>) -> Self {\n-        unsafe { Self(crate::intrinsics::simd_bitmask(value), PhantomData) }\n+        unsafe { Self(intrinsics::simd_bitmask(value), PhantomData) }\n     }\n \n     #[cfg(feature = \"generic_const_exprs\")]"}, {"sha": "e5bb784bb910f4b40da0746f3f7ad7604d25b285", "filename": "library/portable-simd/crates/core_simd/src/masks/full_masks.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/23c172ff0f2855446bb9242e3de69fbf67c99693/library%2Fportable-simd%2Fcrates%2Fcore_simd%2Fsrc%2Fmasks%2Ffull_masks.rs", "raw_url": "https://github.com/rust-lang/rust/raw/23c172ff0f2855446bb9242e3de69fbf67c99693/library%2Fportable-simd%2Fcrates%2Fcore_simd%2Fsrc%2Fmasks%2Ffull_masks.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fportable-simd%2Fcrates%2Fcore_simd%2Fsrc%2Fmasks%2Ffull_masks.rs?ref=23c172ff0f2855446bb9242e3de69fbf67c99693", "patch": "@@ -115,7 +115,7 @@ where\n     pub fn to_bitmask(self) -> [u8; LaneCount::<LANES>::BITMASK_LEN] {\n         unsafe {\n             let mut bitmask: [u8; LaneCount::<LANES>::BITMASK_LEN] =\n-                crate::intrinsics::simd_bitmask(self.0);\n+                intrinsics::simd_bitmask(self.0);\n \n             // There is a bug where LLVM appears to implement this operation with the wrong\n             // bit order.\n@@ -144,7 +144,7 @@ where\n                 }\n             }\n \n-            Self::from_int_unchecked(crate::intrinsics::simd_select_bitmask(\n+            Self::from_int_unchecked(intrinsics::simd_select_bitmask(\n                 bitmask,\n                 Self::splat(true).to_int(),\n                 Self::splat(false).to_int(),"}, {"sha": "85026265956a2092545c00a1e3ffa24e543aa672", "filename": "library/portable-simd/crates/core_simd/src/mod.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/23c172ff0f2855446bb9242e3de69fbf67c99693/library%2Fportable-simd%2Fcrates%2Fcore_simd%2Fsrc%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/23c172ff0f2855446bb9242e3de69fbf67c99693/library%2Fportable-simd%2Fcrates%2Fcore_simd%2Fsrc%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fportable-simd%2Fcrates%2Fcore_simd%2Fsrc%2Fmod.rs?ref=23c172ff0f2855446bb9242e3de69fbf67c99693", "patch": "@@ -27,7 +27,6 @@ pub mod simd {\n \n     pub use crate::core_simd::lane_count::{LaneCount, SupportedLaneCount};\n     pub use crate::core_simd::masks::*;\n-    pub use crate::core_simd::select::Select;\n     pub use crate::core_simd::swizzle::*;\n     pub use crate::core_simd::vector::*;\n }"}, {"sha": "8d521057fbd3ed7a9da2bc540af546f7d2cf9ee2", "filename": "library/portable-simd/crates/core_simd/src/select.rs", "status": "modified", "additions": 21, "deletions": 53, "changes": 74, "blob_url": "https://github.com/rust-lang/rust/blob/23c172ff0f2855446bb9242e3de69fbf67c99693/library%2Fportable-simd%2Fcrates%2Fcore_simd%2Fsrc%2Fselect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/23c172ff0f2855446bb9242e3de69fbf67c99693/library%2Fportable-simd%2Fcrates%2Fcore_simd%2Fsrc%2Fselect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fportable-simd%2Fcrates%2Fcore_simd%2Fsrc%2Fselect.rs?ref=23c172ff0f2855446bb9242e3de69fbf67c99693", "patch": "@@ -1,54 +1,6 @@\n use crate::simd::intrinsics;\n use crate::simd::{LaneCount, Mask, MaskElement, Simd, SimdElement, SupportedLaneCount};\n \n-mod sealed {\n-    pub trait Sealed<Mask> {\n-        fn select(mask: Mask, true_values: Self, false_values: Self) -> Self;\n-    }\n-}\n-use sealed::Sealed;\n-\n-/// Supporting trait for vector `select` function\n-pub trait Select<Mask>: Sealed<Mask> {}\n-\n-impl<T, const LANES: usize> Sealed<Mask<T::Mask, LANES>> for Simd<T, LANES>\n-where\n-    T: SimdElement,\n-    LaneCount<LANES>: SupportedLaneCount,\n-{\n-    #[inline]\n-    #[must_use = \"method returns a new vector and does not mutate the original inputs\"]\n-    fn select(mask: Mask<T::Mask, LANES>, true_values: Self, false_values: Self) -> Self {\n-        unsafe { intrinsics::simd_select(mask.to_int(), true_values, false_values) }\n-    }\n-}\n-\n-impl<T, const LANES: usize> Select<Mask<T::Mask, LANES>> for Simd<T, LANES>\n-where\n-    T: SimdElement,\n-    LaneCount<LANES>: SupportedLaneCount,\n-{\n-}\n-\n-impl<T, const LANES: usize> Sealed<Self> for Mask<T, LANES>\n-where\n-    T: MaskElement,\n-    LaneCount<LANES>: SupportedLaneCount,\n-{\n-    #[inline]\n-    #[must_use = \"method returns a new vector and does not mutate the original inputs\"]\n-    fn select(mask: Self, true_values: Self, false_values: Self) -> Self {\n-        mask & true_values | !mask & false_values\n-    }\n-}\n-\n-impl<T, const LANES: usize> Select<Self> for Mask<T, LANES>\n-where\n-    T: MaskElement,\n-    LaneCount<LANES>: SupportedLaneCount,\n-{\n-}\n-\n impl<T, const LANES: usize> Mask<T, LANES>\n where\n     T: MaskElement,\n@@ -69,21 +21,37 @@ where\n     /// let c = mask.select(a, b);\n     /// assert_eq!(c.to_array(), [0, 5, 6, 3]);\n     /// ```\n+    #[inline]\n+    #[must_use = \"method returns a new vector and does not mutate the original inputs\"]\n+    pub fn select<U>(\n+        self,\n+        true_values: Simd<U, LANES>,\n+        false_values: Simd<U, LANES>,\n+    ) -> Simd<U, LANES>\n+    where\n+        U: SimdElement<Mask = T>,\n+    {\n+        unsafe { intrinsics::simd_select(self.to_int(), true_values, false_values) }\n+    }\n+\n+    /// Choose lanes from two masks.\n+    ///\n+    /// For each lane in the mask, choose the corresponding lane from `true_values` if\n+    /// that lane mask is true, and `false_values` if that lane mask is false.\n     ///\n-    /// `select` can also be used on masks:\n     /// ```\n     /// # #![feature(portable_simd)]\n     /// # #[cfg(feature = \"std\")] use core_simd::Mask;\n     /// # #[cfg(not(feature = \"std\"))] use core::simd::Mask;\n     /// let a = Mask::<i32, 4>::from_array([true, true, false, false]);\n     /// let b = Mask::<i32, 4>::from_array([false, false, true, true]);\n     /// let mask = Mask::<i32, 4>::from_array([true, false, false, true]);\n-    /// let c = mask.select(a, b);\n+    /// let c = mask.select_mask(a, b);\n     /// assert_eq!(c.to_array(), [true, false, true, false]);\n     /// ```\n     #[inline]\n-    #[must_use = \"method returns a new vector and does not mutate the original inputs\"]\n-    pub fn select<S: Select<Self>>(self, true_values: S, false_values: S) -> S {\n-        S::select(self, true_values, false_values)\n+    #[must_use = \"method returns a new mask and does not mutate the original inputs\"]\n+    pub fn select_mask(self, true_values: Self, false_values: Self) -> Self {\n+        self & true_values | !self & false_values\n     }\n }"}]}