{"sha": "2252a65f238cac0ebf0c4c56d9b475fa0460d758", "node_id": "MDY6Q29tbWl0NzI0NzEyOjIyNTJhNjVmMjM4Y2FjMGViZjBjNGM1NmQ5YjQ3NWZhMDQ2MGQ3NTg=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-08-18T11:58:02Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-08-18T11:58:02Z"}, "message": "Merge #5687\n\n5687: Fix document symbols order r=matklad a=magurotuna\n\nResolves #5655 \r\nAnd adds tests for `handle_document_symbol`, both with `hierarchical_symbols` enabled and with it disabled.\r\n\r\nPreviously document symbols were displayed in reverse order  in sublime text with its LSP plugin, but this patch fixes it like this:\r\n\r\n![image](https://user-images.githubusercontent.com/23649474/89709020-fbccce00-d9b6-11ea-83b0-c88dc9f7977f.png)\r\n\n\nCo-authored-by: Yusuke Tanaka <yusuktan@maguro.dev>", "tree": {"sha": "cd9f08481a2f5bad16c16c2232c79c780f004623", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/cd9f08481a2f5bad16c16c2232c79c780f004623"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2252a65f238cac0ebf0c4c56d9b475fa0460d758", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfO8JKCRBK7hj4Ov3rIwAAdHIIAA7wchAnZzcOq4uRK5vz/0C+\nTjrsehmMUf7wv1Y87DP3I9OAe+EuCWGAXIyPStaCM3C5E9H+SacC7Lg9keGowagQ\nVQB6sk+8vgejJbkkYc23jF7fL8GjYuqMZ/YDkeYDnoZzTLCFagAbJM0ydTdSjs1O\np9Y69AJ9ceADSCGO5zD33DLWlVl3OHyoJYQe9aYJg9jqlwPRx+UMEuCxy0anwSrj\ndQrXvRVj8chcSXqyudu3OD4wwS4Dn5Ttpnm941yUtuItSffmEfbagD4cnYK7B/Qe\nrcpnoLs/3sMyxiYjDcFl3oBsVe20z0Fgltz/VdmsR4xQN1XMur5UEzgliZatXcY=\n=ZNFB\n-----END PGP SIGNATURE-----\n", "payload": "tree cd9f08481a2f5bad16c16c2232c79c780f004623\nparent 5dfb1e054aa5ab0636e6a0ff5e2bbf297a24869a\nparent e8e1eb4263d5bcf109550432143dd54de9f64946\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1597751882 +0000\ncommitter GitHub <noreply@github.com> 1597751882 +0000\n\nMerge #5687\n\n5687: Fix document symbols order r=matklad a=magurotuna\n\nResolves #5655 \r\nAnd adds tests for `handle_document_symbol`, both with `hierarchical_symbols` enabled and with it disabled.\r\n\r\nPreviously document symbols were displayed in reverse order  in sublime text with its LSP plugin, but this patch fixes it like this:\r\n\r\n![image](https://user-images.githubusercontent.com/23649474/89709020-fbccce00-d9b6-11ea-83b0-c88dc9f7977f.png)\r\n\n\nCo-authored-by: Yusuke Tanaka <yusuktan@maguro.dev>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2252a65f238cac0ebf0c4c56d9b475fa0460d758", "html_url": "https://github.com/rust-lang/rust/commit/2252a65f238cac0ebf0c4c56d9b475fa0460d758", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2252a65f238cac0ebf0c4c56d9b475fa0460d758/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5dfb1e054aa5ab0636e6a0ff5e2bbf297a24869a", "url": "https://api.github.com/repos/rust-lang/rust/commits/5dfb1e054aa5ab0636e6a0ff5e2bbf297a24869a", "html_url": "https://github.com/rust-lang/rust/commit/5dfb1e054aa5ab0636e6a0ff5e2bbf297a24869a"}, {"sha": "e8e1eb4263d5bcf109550432143dd54de9f64946", "url": "https://api.github.com/repos/rust-lang/rust/commits/e8e1eb4263d5bcf109550432143dd54de9f64946", "html_url": "https://github.com/rust-lang/rust/commit/e8e1eb4263d5bcf109550432143dd54de9f64946"}], "stats": {"total": 15, "additions": 10, "deletions": 5}, "files": [{"sha": "096127b0c2e80cd39c4e25234b39f4158700ca7a", "filename": "crates/rust-analyzer/src/handlers.rs", "status": "modified", "additions": 10, "deletions": 5, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/2252a65f238cac0ebf0c4c56d9b475fa0460d758/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2252a65f238cac0ebf0c4c56d9b475fa0460d758/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs?ref=2252a65f238cac0ebf0c4c56d9b475fa0460d758", "patch": "@@ -272,19 +272,24 @@ pub(crate) fn handle_document_symbol(\n         parents.push((doc_symbol, symbol.parent));\n     }\n     let mut document_symbols = Vec::new();\n+    // Constructs `document_symbols` from `parents`, in order from the end.\n     while let Some((node, parent)) = parents.pop() {\n         match parent {\n             None => document_symbols.push(node),\n             Some(i) => {\n-                let children = &mut parents[i].0.children;\n-                if children.is_none() {\n-                    *children = Some(Vec::new());\n-                }\n-                children.as_mut().unwrap().push(node);\n+                parents[i].0.children.get_or_insert_with(Vec::new).push(node);\n             }\n         }\n     }\n \n+    fn reverse(symbols: &mut Vec<DocumentSymbol>) {\n+        for sym in symbols.iter_mut() {\n+            sym.children.as_mut().map(|c| reverse(c));\n+        }\n+        symbols.reverse();\n+    }\n+    reverse(&mut document_symbols);\n+\n     let res = if snap.config.client_caps.hierarchical_symbols {\n         document_symbols.into()\n     } else {"}]}