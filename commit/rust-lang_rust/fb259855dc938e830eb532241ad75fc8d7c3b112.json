{"sha": "fb259855dc938e830eb532241ad75fc8d7c3b112", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZiMjU5ODU1ZGM5MzhlODMwZWI1MzIyNDFhZDc1ZmM4ZDdjM2IxMTI=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2013-09-30T23:08:12Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2013-10-01T03:31:20Z"}, "message": "rustdoc: Use a BufferedWriter when emitting source\n\nThis takes the rendering time of source files for libstd from 12.5s to 0.1s,\nturns out write! calls the write function *a lot*", "tree": {"sha": "1cdaa1aea09ce52395bc0a2a4264ca0010cbe768", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1cdaa1aea09ce52395bc0a2a4264ca0010cbe768"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fb259855dc938e830eb532241ad75fc8d7c3b112", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fb259855dc938e830eb532241ad75fc8d7c3b112", "html_url": "https://github.com/rust-lang/rust/commit/fb259855dc938e830eb532241ad75fc8d7c3b112", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fb259855dc938e830eb532241ad75fc8d7c3b112/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cc1791584f24f5cc734f2fe0a8d3937a72193076", "url": "https://api.github.com/repos/rust-lang/rust/commits/cc1791584f24f5cc734f2fe0a8d3937a72193076", "html_url": "https://github.com/rust-lang/rust/commit/cc1791584f24f5cc734f2fe0a8d3937a72193076"}], "stats": {"total": 16, "additions": 13, "deletions": 3}, "files": [{"sha": "20a3572942e458378891c5fdbd640f4dcf6070d4", "filename": "src/librustdoc/html/render.rs", "status": "modified", "additions": 12, "deletions": 2, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/fb259855dc938e830eb532241ad75fc8d7c3b112/src%2Flibrustdoc%2Fhtml%2Frender.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fb259855dc938e830eb532241ad75fc8d7c3b112/src%2Flibrustdoc%2Fhtml%2Frender.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender.rs?ref=fb259855dc938e830eb532241ad75fc8d7c3b112", "patch": "@@ -28,6 +28,7 @@ use std::vec;\n use extra::arc::RWArc;\n use extra::json::ToJson;\n use extra::sort;\n+use extra::time;\n \n use syntax::ast;\n use syntax::ast_util::is_local;\n@@ -179,6 +180,8 @@ pub fn run(mut crate: clean::Crate, dst: Path) {\n         w.flush();\n     }\n \n+    info2!(\"emitting source files\");\n+    let started = time::precise_time_ns();\n     {\n         let dst = cx.dst.push(\"src\");\n         mkdir(&dst);\n@@ -191,9 +194,14 @@ pub fn run(mut crate: clean::Crate, dst: Path) {\n         };\n         crate = folder.fold_crate(crate);\n     }\n+    let ended = time::precise_time_ns();\n+    info2!(\"Took {:.03f}s\", (ended as f64 - started as f64) / 1e9f64);\n \n-    // Now render the whole crate.\n+    info2!(\"rendering the whole crate\");\n+    let started = time::precise_time_ns();\n     cx.crate(crate, cache);\n+    let ended = time::precise_time_ns();\n+    info2!(\"Took {:.03f}s\", (ended as f64 - started as f64) / 1e9f64);\n }\n \n fn write(dst: Path, contents: &str) {\n@@ -289,7 +297,8 @@ impl<'self> SourceCollector<'self> {\n         }\n \n         let dst = cur.push(*p.components.last() + \".html\");\n-        let mut w = dst.open_writer(io::CreateOrTruncate);\n+        let w = dst.open_writer(io::CreateOrTruncate);\n+        let mut w = BufferedWriter::new(w);\n \n         let title = format!(\"{} -- source\", *dst.components.last());\n         let page = layout::Page {\n@@ -299,6 +308,7 @@ impl<'self> SourceCollector<'self> {\n         };\n         layout::render(&mut w as &mut io::Writer, &self.cx.layout,\n                        &page, &(\"\"), &Source(contents.as_slice()));\n+        w.flush();\n         return true;\n     }\n }"}, {"sha": "61a27e49f6663dbc1778f22717e119ae973f9732", "filename": "src/librustdoc/rustdoc.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/fb259855dc938e830eb532241ad75fc8d7c3b112/src%2Flibrustdoc%2Frustdoc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fb259855dc938e830eb532241ad75fc8d7c3b112/src%2Flibrustdoc%2Frustdoc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Frustdoc.rs?ref=fb259855dc938e830eb532241ad75fc8d7c3b112", "patch": "@@ -146,7 +146,7 @@ pub fn main_args(args: &[~str]) -> int {\n         }\n     }\n     let ended = time::precise_time_ns();\n-    info2!(\"Took {:.03f}s\", (ended as f64 - started as f64) / 1000000000f64);\n+    info2!(\"Took {:.03f}s\", (ended as f64 - started as f64) / 1e9f64);\n \n     return 0;\n }"}]}