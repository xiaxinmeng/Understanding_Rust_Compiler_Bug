{"sha": "5ad60888275852136adea38aebc7fcce69b52474", "node_id": "MDY6Q29tbWl0NzI0NzEyOjVhZDYwODg4Mjc1ODUyMTM2YWRlYTM4YWViYzdmY2NlNjliNTI0NzQ=", "commit": {"author": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2021-02-24T20:21:18Z"}, "committer": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2021-02-24T20:22:50Z"}, "message": "Substitute erased lifetimes on bad placeholder type\n\nFix #82455.", "tree": {"sha": "baa952d9dc92d7fac5742eea83b81c899020227c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/baa952d9dc92d7fac5742eea83b81c899020227c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5ad60888275852136adea38aebc7fcce69b52474", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5ad60888275852136adea38aebc7fcce69b52474", "html_url": "https://github.com/rust-lang/rust/commit/5ad60888275852136adea38aebc7fcce69b52474", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5ad60888275852136adea38aebc7fcce69b52474/comments", "author": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "committer": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3e826bb11228508fbe749e594038d6727208aa94", "url": "https://api.github.com/repos/rust-lang/rust/commits/3e826bb11228508fbe749e594038d6727208aa94", "html_url": "https://github.com/rust-lang/rust/commit/3e826bb11228508fbe749e594038d6727208aa94"}], "stats": {"total": 46, "additions": 44, "deletions": 2}, "files": [{"sha": "d754a24c58be103221a34ddfdc89c0c074d50f84", "filename": "compiler/rustc_typeck/src/collect.rs", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/5ad60888275852136adea38aebc7fcce69b52474/compiler%2Frustc_typeck%2Fsrc%2Fcollect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5ad60888275852136adea38aebc7fcce69b52474/compiler%2Frustc_typeck%2Fsrc%2Fcollect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcollect.rs?ref=5ad60888275852136adea38aebc7fcce69b52474", "patch": "@@ -371,6 +371,11 @@ impl AstConv<'tcx> for ItemCtxt<'tcx> {\n         span: Span,\n     ) -> &'tcx Const<'tcx> {\n         bad_placeholder_type(self.tcx(), vec![span]).emit();\n+        // Typeck doesn't expect erased regions to be returned from `type_of`.\n+        let ty = self.tcx.fold_regions(ty, &mut false, |r, _| match r {\n+            ty::ReErased => self.tcx.lifetimes.re_static,\n+            _ => r,\n+        });\n         self.tcx().const_error(ty)\n     }\n \n@@ -1647,6 +1652,12 @@ fn fn_sig(tcx: TyCtxt<'_>, def_id: DefId) -> ty::PolyFnSig<'_> {\n             match get_infer_ret_ty(&sig.decl.output) {\n                 Some(ty) => {\n                     let fn_sig = tcx.typeck(def_id).liberated_fn_sigs()[hir_id];\n+                    // Typeck doesn't expect erased regions to be returned from `type_of`.\n+                    let fn_sig = tcx.fold_regions(fn_sig, &mut false, |r, _| match r {\n+                        ty::ReErased => tcx.lifetimes.re_static,\n+                        _ => r,\n+                    });\n+\n                     let mut visitor = PlaceholderHirTyCollector::default();\n                     visitor.visit_ty(ty);\n                     let mut diag = bad_placeholder_type(tcx, visitor.0);\n@@ -1675,6 +1686,7 @@ fn fn_sig(tcx: TyCtxt<'_>, def_id: DefId) -> ty::PolyFnSig<'_> {\n                         }\n                     }\n                     diag.emit();\n+\n                     ty::Binder::bind(fn_sig)\n                 }\n                 None => AstConv::ty_of_fn("}, {"sha": "2523362fdc4b6637127f22ce983977642eab32f7", "filename": "src/test/ui/typeck/typeck_type_placeholder_item.rs", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/5ad60888275852136adea38aebc7fcce69b52474/src%2Ftest%2Fui%2Ftypeck%2Ftypeck_type_placeholder_item.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5ad60888275852136adea38aebc7fcce69b52474/src%2Ftest%2Fui%2Ftypeck%2Ftypeck_type_placeholder_item.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftypeck%2Ftypeck_type_placeholder_item.rs?ref=5ad60888275852136adea38aebc7fcce69b52474", "patch": "@@ -208,3 +208,15 @@ impl Qux for Struct {\n     const D: _ = 42;\n     //~^ ERROR the type placeholder `_` is not allowed within types on item signatures\n }\n+\n+fn map<T>(_: fn() -> Option<&'static T>) -> Option<T> {\n+    None\n+}\n+\n+fn value() -> Option<&'static _> {\n+//~^ ERROR the type placeholder `_` is not allowed within types on item signatures\n+    Option::<&'static u8>::None\n+}\n+\n+const _: Option<_> = map(value);\n+//~^ ERROR the type placeholder `_` is not allowed within types on item signatures"}, {"sha": "1034402bfb08d00ee67ecf490cfb5b13358ab07c", "filename": "src/test/ui/typeck/typeck_type_placeholder_item.stderr", "status": "modified", "additions": 20, "deletions": 2, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/5ad60888275852136adea38aebc7fcce69b52474/src%2Ftest%2Fui%2Ftypeck%2Ftypeck_type_placeholder_item.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/5ad60888275852136adea38aebc7fcce69b52474/src%2Ftest%2Fui%2Ftypeck%2Ftypeck_type_placeholder_item.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftypeck%2Ftypeck_type_placeholder_item.stderr?ref=5ad60888275852136adea38aebc7fcce69b52474", "patch": "@@ -158,7 +158,7 @@ LL | fn test11(x: &usize) -> &_ {\n    |                         -^\n    |                         ||\n    |                         |not allowed in type signatures\n-   |                         help: replace with the correct return type: `&&usize`\n+   |                         help: replace with the correct return type: `&'static &'static usize`\n \n error[E0121]: the type placeholder `_` is not allowed within types on item signatures\n   --> $DIR/typeck_type_placeholder_item.rs:52:52\n@@ -410,6 +410,24 @@ error[E0121]: the type placeholder `_` is not allowed within types on item signa\n LL | type Y = impl Trait<_>;\n    |                     ^ not allowed in type signatures\n \n+error[E0121]: the type placeholder `_` is not allowed within types on item signatures\n+  --> $DIR/typeck_type_placeholder_item.rs:216:31\n+   |\n+LL | fn value() -> Option<&'static _> {\n+   |               ----------------^-\n+   |               |               |\n+   |               |               not allowed in type signatures\n+   |               help: replace with the correct return type: `Option<&'static u8>`\n+\n+error[E0121]: the type placeholder `_` is not allowed within types on item signatures\n+  --> $DIR/typeck_type_placeholder_item.rs:221:10\n+   |\n+LL | const _: Option<_> = map(value);\n+   |          ^^^^^^^^^\n+   |          |\n+   |          not allowed in type signatures\n+   |          help: replace `_` with the correct type: `Option<u8>`\n+\n error[E0121]: the type placeholder `_` is not allowed within types on item signatures\n   --> $DIR/typeck_type_placeholder_item.rs:140:31\n    |\n@@ -614,7 +632,7 @@ LL |     const D: _ = 42;\n    |              not allowed in type signatures\n    |              help: replace `_` with the correct type: `i32`\n \n-error: aborting due to 67 previous errors\n+error: aborting due to 69 previous errors\n \n Some errors have detailed explanations: E0121, E0282, E0403.\n For more information about an error, try `rustc --explain E0121`."}]}