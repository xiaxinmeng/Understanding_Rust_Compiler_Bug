{"sha": "339a1867f45b6bbfa0f5f5f274706b1b81b71663", "node_id": "C_kwDOAAsO6NoAKDMzOWExODY3ZjQ1YjZiYmZhMGY1ZjVmMjc0NzA2YjFiODFiNzE2NjM", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-04-28T17:24:22Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-04-28T17:24:22Z"}, "message": "Auto merge of #12110 - jonas-schievink:inline-self-type, r=jonas-schievink\n\nfeat: Make \"inline type alias\" work for `Self`\n\nFixes https://github.com/rust-lang/rust-analyzer/issues/12109", "tree": {"sha": "e92c2d727f7b4eee3dd5bb0beffd4ad89363d8f5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e92c2d727f7b4eee3dd5bb0beffd4ad89363d8f5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/339a1867f45b6bbfa0f5f5f274706b1b81b71663", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/339a1867f45b6bbfa0f5f5f274706b1b81b71663", "html_url": "https://github.com/rust-lang/rust/commit/339a1867f45b6bbfa0f5f5f274706b1b81b71663", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/339a1867f45b6bbfa0f5f5f274706b1b81b71663/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d382e24a11c8706b201c8437894506d191691334", "url": "https://api.github.com/repos/rust-lang/rust/commits/d382e24a11c8706b201c8437894506d191691334", "html_url": "https://github.com/rust-lang/rust/commit/d382e24a11c8706b201c8437894506d191691334"}, {"sha": "c7027122db14317c4c4d72469e13af0292f64254", "url": "https://api.github.com/repos/rust-lang/rust/commits/c7027122db14317c4c4d72469e13af0292f64254", "html_url": "https://github.com/rust-lang/rust/commit/c7027122db14317c4c4d72469e13af0292f64254"}], "stats": {"total": 119, "additions": 102, "deletions": 17}, "files": [{"sha": "bc4a07358cc58948c15717e4d13bf02d51a828ea", "filename": "crates/ide_assists/src/handlers/inline_type_alias.rs", "status": "modified", "additions": 102, "deletions": 17, "changes": 119, "blob_url": "https://github.com/rust-lang/rust/blob/339a1867f45b6bbfa0f5f5f274706b1b81b71663/crates%2Fide_assists%2Fsrc%2Fhandlers%2Finline_type_alias.rs", "raw_url": "https://github.com/rust-lang/rust/raw/339a1867f45b6bbfa0f5f5f274706b1b81b71663/crates%2Fide_assists%2Fsrc%2Fhandlers%2Finline_type_alias.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_assists%2Fsrc%2Fhandlers%2Finline_type_alias.rs?ref=339a1867f45b6bbfa0f5f5f274706b1b81b71663", "patch": "@@ -3,7 +3,7 @@\n // - \"inline_alias_to_users\" assist #10881.\n // - Remove unused aliases if there are no longer any users, see inline_call.rs.\n \n-use hir::PathResolution;\n+use hir::{HasSource, PathResolution};\n use itertools::Itertools;\n use std::collections::HashMap;\n use syntax::{\n@@ -41,31 +41,48 @@ use crate::{\n // }\n // ```\n pub(crate) fn inline_type_alias(acc: &mut Assists, ctx: &AssistContext) -> Option<()> {\n-    let alias_instance = ctx.find_node_at_offset::<ast::PathType>()?;\n-    let alias = get_type_alias(&ctx, &alias_instance)?;\n-    let concrete_type = alias.ty()?;\n-\n     enum Replacement {\n         Generic { lifetime_map: LifetimeMap, const_and_type_map: ConstAndTypeMap },\n         Plain,\n     }\n \n-    let replacement = if let Some(alias_generics) = alias.generic_param_list() {\n-        if alias_generics.generic_params().next().is_none() {\n-            cov_mark::hit!(no_generics_params);\n-            return None;\n+    let alias_instance = ctx.find_node_at_offset::<ast::PathType>()?;\n+    let concrete_type;\n+    let replacement;\n+    match alias_instance.path()?.as_single_name_ref() {\n+        Some(nameref) if nameref.Self_token().is_some() => {\n+            match ctx.sema.resolve_path(&alias_instance.path()?)? {\n+                PathResolution::SelfType(imp) => {\n+                    concrete_type = imp.source(ctx.db())?.value.self_ty()?;\n+                }\n+                // FIXME: should also work in ADT definitions\n+                _ => return None,\n+            }\n+\n+            replacement = Replacement::Plain;\n         }\n+        _ => {\n+            let alias = get_type_alias(&ctx, &alias_instance)?;\n+            concrete_type = alias.ty()?;\n+\n+            replacement = if let Some(alias_generics) = alias.generic_param_list() {\n+                if alias_generics.generic_params().next().is_none() {\n+                    cov_mark::hit!(no_generics_params);\n+                    return None;\n+                }\n \n-        let instance_args =\n-            alias_instance.syntax().descendants().find_map(ast::GenericArgList::cast);\n+                let instance_args =\n+                    alias_instance.syntax().descendants().find_map(ast::GenericArgList::cast);\n \n-        Replacement::Generic {\n-            lifetime_map: LifetimeMap::new(&instance_args, &alias_generics)?,\n-            const_and_type_map: ConstAndTypeMap::new(&instance_args, &alias_generics)?,\n+                Replacement::Generic {\n+                    lifetime_map: LifetimeMap::new(&instance_args, &alias_generics)?,\n+                    const_and_type_map: ConstAndTypeMap::new(&instance_args, &alias_generics)?,\n+                }\n+            } else {\n+                Replacement::Plain\n+            };\n         }\n-    } else {\n-        Replacement::Plain\n-    };\n+    }\n \n     let target = alias_instance.syntax().text_range();\n \n@@ -752,6 +769,74 @@ mod foo {\n fn main() {\n     let a: String;\n }\n+\"#,\n+        );\n+    }\n+\n+    #[test]\n+    fn inline_self_type() {\n+        check_assist(\n+            inline_type_alias,\n+            r#\"\n+struct Strukt;\n+\n+impl Strukt {\n+    fn new() -> Self$0 {}\n+}\n+\"#,\n+            r#\"\n+struct Strukt;\n+\n+impl Strukt {\n+    fn new() -> Strukt {}\n+}\n+\"#,\n+        );\n+        check_assist(\n+            inline_type_alias,\n+            r#\"\n+struct Strukt<'a, T, const C: usize>(&'a [T; C]);\n+\n+impl<T, const C: usize> Strukt<'_, T, C> {\n+    fn new() -> Self$0 {}\n+}\n+\"#,\n+            r#\"\n+struct Strukt<'a, T, const C: usize>(&'a [T; C]);\n+\n+impl<T, const C: usize> Strukt<'_, T, C> {\n+    fn new() -> Strukt<'_, T, C> {}\n+}\n+\"#,\n+        );\n+        check_assist(\n+            inline_type_alias,\n+            r#\"\n+struct Strukt<'a, T, const C: usize>(&'a [T; C]);\n+\n+trait Tr<'b, T> {}\n+\n+impl<T, const C: usize> Tr<'static, u8> for Strukt<'_, T, C> {\n+    fn new() -> Self$0 {}\n+}\n+\"#,\n+            r#\"\n+struct Strukt<'a, T, const C: usize>(&'a [T; C]);\n+\n+trait Tr<'b, T> {}\n+\n+impl<T, const C: usize> Tr<'static, u8> for Strukt<'_, T, C> {\n+    fn new() -> Strukt<'_, T, C> {}\n+}\n+\"#,\n+        );\n+\n+        check_assist_not_applicable(\n+            inline_type_alias,\n+            r#\"\n+trait Tr {\n+    fn new() -> Self$0;\n+}\n \"#,\n         );\n     }"}]}