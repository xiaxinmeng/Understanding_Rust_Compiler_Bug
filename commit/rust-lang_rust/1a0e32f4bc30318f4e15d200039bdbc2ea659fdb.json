{"sha": "1a0e32f4bc30318f4e15d200039bdbc2ea659fdb", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFhMGUzMmY0YmMzMDMxOGY0ZTE1ZDIwMDAzOWJkYmMyZWE2NTlmZGI=", "commit": {"author": {"name": "Dylan DPC", "email": "dylan.dpc@gmail.com", "date": "2021-03-19T22:01:37Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-03-19T22:01:37Z"}, "message": "Rollup merge of #83244 - cuviper:vec_deque-zst, r=m-ou-se\n\nFix overflowing length in Vec<ZST> to VecDeque\n\n`Vec` can hold up to `usize::MAX` ZST items, but `VecDeque` has a lower\nlimit to keep its raw capacity as a power of two, so we should check\nthat in `From<Vec<T>> for VecDeque<T>`. We can also simplify the\ncapacity check for the remaining non-ZST case.\n\nBefore this fix, the new test would fail on the length:\n\n```\nthread 'collections::vec_deque::tests::test_from_vec_zst_overflow' panicked at 'assertion failed: `(left == right)`\n  left: `0`,\n right: `9223372036854775808`', library/alloc/src/collections/vec_deque/tests.rs:474:5\nnote: panic did not contain expected string\n      panic message: `\"assertion failed: `(left == right)`\\n  left: `0`,\\n right: `9223372036854775808`\"`,\n expected substring: `\"capacity overflow\"`\n```\n\nThat was a result of `len()` using a mask `& (size - 1)` with the\nimproper length. Now we do get a \"capacity overflow\" panic as soon as\nthat `VecDeque::from(vec)` is attempted.\n\nFixes #80167.", "tree": {"sha": "7ed7b88459086ffb2ae66fee9a37fca8e3482b0f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7ed7b88459086ffb2ae66fee9a37fca8e3482b0f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1a0e32f4bc30318f4e15d200039bdbc2ea659fdb", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgVR9BCRBK7hj4Ov3rIwAAdHIIAJZkhfWjfQktmZyKpaaI/1fs\n9IZUL7mmXEQ6JPPNn6iXr3FXubriQYxyYCyW2/SWD27naVq9GJGggAipN2ywyuaT\nSLuO8u3g207Ijc8VnnpEh50RsLucHx3nYfWPaT2sXIej/lxiMUc0AI7OkDNvap9r\nAXR/dXF1KTqVLUqlkm6JhxoX6JFvtICT8fcl0xfop+XMd6Rr3vGMYLSdswVnN/I7\nCetDIL7Wpm3l9FwgNo8WwYmXgAkNG4A93D76OmigkT3al+H+EJwNwiMJ7VKQp5EL\nYZUllRLBBxVpUWVwTG7elcKv0VbTnRp8cHKEZNHBkK8fP5fgB8Kv2hMv1iNvwk0=\n=ipsV\n-----END PGP SIGNATURE-----\n", "payload": "tree 7ed7b88459086ffb2ae66fee9a37fca8e3482b0f\nparent f7febc8865a2cb2287b034f6588d7617fa0fc6e9\nparent c07955c6b6a8901fc59d9c22004127b30a965407\nauthor Dylan DPC <dylan.dpc@gmail.com> 1616191297 +0100\ncommitter GitHub <noreply@github.com> 1616191297 +0100\n\nRollup merge of #83244 - cuviper:vec_deque-zst, r=m-ou-se\n\nFix overflowing length in Vec<ZST> to VecDeque\n\n`Vec` can hold up to `usize::MAX` ZST items, but `VecDeque` has a lower\nlimit to keep its raw capacity as a power of two, so we should check\nthat in `From<Vec<T>> for VecDeque<T>`. We can also simplify the\ncapacity check for the remaining non-ZST case.\n\nBefore this fix, the new test would fail on the length:\n\n```\nthread 'collections::vec_deque::tests::test_from_vec_zst_overflow' panicked at 'assertion failed: `(left == right)`\n  left: `0`,\n right: `9223372036854775808`', library/alloc/src/collections/vec_deque/tests.rs:474:5\nnote: panic did not contain expected string\n      panic message: `\"assertion failed: `(left == right)`\\n  left: `0`,\\n right: `9223372036854775808`\"`,\n expected substring: `\"capacity overflow\"`\n```\n\nThat was a result of `len()` using a mask `& (size - 1)` with the\nimproper length. Now we do get a \"capacity overflow\" panic as soon as\nthat `VecDeque::from(vec)` is attempted.\n\nFixes #80167.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1a0e32f4bc30318f4e15d200039bdbc2ea659fdb", "html_url": "https://github.com/rust-lang/rust/commit/1a0e32f4bc30318f4e15d200039bdbc2ea659fdb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1a0e32f4bc30318f4e15d200039bdbc2ea659fdb/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f7febc8865a2cb2287b034f6588d7617fa0fc6e9", "url": "https://api.github.com/repos/rust-lang/rust/commits/f7febc8865a2cb2287b034f6588d7617fa0fc6e9", "html_url": "https://github.com/rust-lang/rust/commit/f7febc8865a2cb2287b034f6588d7617fa0fc6e9"}, {"sha": "c07955c6b6a8901fc59d9c22004127b30a965407", "url": "https://api.github.com/repos/rust-lang/rust/commits/c07955c6b6a8901fc59d9c22004127b30a965407", "html_url": "https://github.com/rust-lang/rust/commit/c07955c6b6a8901fc59d9c22004127b30a965407"}], "stats": {"total": 52, "additions": 33, "deletions": 19}, "files": [{"sha": "7a0de74eb239d8b4261a9bca23647a208da507f7", "filename": "library/alloc/src/collections/vec_deque/mod.rs", "status": "modified", "additions": 18, "deletions": 19, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/1a0e32f4bc30318f4e15d200039bdbc2ea659fdb/library%2Falloc%2Fsrc%2Fcollections%2Fvec_deque%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1a0e32f4bc30318f4e15d200039bdbc2ea659fdb/library%2Falloc%2Fsrc%2Fcollections%2Fvec_deque%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Falloc%2Fsrc%2Fcollections%2Fvec_deque%2Fmod.rs?ref=1a0e32f4bc30318f4e15d200039bdbc2ea659fdb", "patch": "@@ -2783,27 +2783,26 @@ impl<T> From<Vec<T>> for VecDeque<T> {\n     /// This avoids reallocating where possible, but the conditions for that are\n     /// strict, and subject to change, and so shouldn't be relied upon unless the\n     /// `Vec<T>` came from `From<VecDeque<T>>` and hasn't been reallocated.\n-    fn from(other: Vec<T>) -> Self {\n-        unsafe {\n-            let mut other = ManuallyDrop::new(other);\n-            let other_buf = other.as_mut_ptr();\n-            let mut buf = RawVec::from_raw_parts(other_buf, other.capacity());\n-            let len = other.len();\n-\n-            // We need to extend the buf if it's not a power of two, too small\n-            // or doesn't have at least one free space.\n-            // We check if `T` is a ZST in the first condition,\n-            // because `usize::MAX` (the capacity returned by `capacity()` for ZST)\n-            // is not a power of two and thus it'll always try\n-            // to reserve more memory which will panic for ZST (rust-lang/rust#78532)\n-            if (!buf.capacity().is_power_of_two() && mem::size_of::<T>() != 0)\n-                || (buf.capacity() < (MINIMUM_CAPACITY + 1))\n-                || (buf.capacity() == len)\n-            {\n-                let cap = cmp::max(buf.capacity() + 1, MINIMUM_CAPACITY + 1).next_power_of_two();\n-                buf.reserve_exact(len, cap - len);\n+    fn from(mut other: Vec<T>) -> Self {\n+        let len = other.len();\n+        if mem::size_of::<T>() == 0 {\n+            // There's no actual allocation for ZSTs to worry about capacity,\n+            // but `VecDeque` can't handle as much length as `Vec`.\n+            assert!(len < MAXIMUM_ZST_CAPACITY, \"capacity overflow\");\n+        } else {\n+            // We need to resize if the capacity is not a power of two, too small or\n+            // doesn't have at least one free space. We do this while it's still in\n+            // the `Vec` so the items will drop on panic.\n+            let min_cap = cmp::max(MINIMUM_CAPACITY, len) + 1;\n+            let cap = cmp::max(min_cap, other.capacity()).next_power_of_two();\n+            if other.capacity() != cap {\n+                other.reserve_exact(cap - len);\n             }\n+        }\n \n+        unsafe {\n+            let (other_buf, len, capacity) = other.into_raw_parts();\n+            let buf = RawVec::from_raw_parts(other_buf, capacity);\n             VecDeque { tail: 0, head: len, buf }\n         }\n     }"}, {"sha": "6116cfe1d0110bdd33e0087e712a100ce5a066e7", "filename": "library/alloc/src/collections/vec_deque/tests.rs", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/1a0e32f4bc30318f4e15d200039bdbc2ea659fdb/library%2Falloc%2Fsrc%2Fcollections%2Fvec_deque%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1a0e32f4bc30318f4e15d200039bdbc2ea659fdb/library%2Falloc%2Fsrc%2Fcollections%2Fvec_deque%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Falloc%2Fsrc%2Fcollections%2Fvec_deque%2Ftests.rs?ref=1a0e32f4bc30318f4e15d200039bdbc2ea659fdb", "patch": "@@ -457,6 +457,21 @@ fn test_from_vec() {\n             assert!(vd.into_iter().eq(vec));\n         }\n     }\n+\n+    let vec = Vec::from([(); MAXIMUM_ZST_CAPACITY - 1]);\n+    let vd = VecDeque::from(vec.clone());\n+    assert!(vd.cap().is_power_of_two());\n+    assert_eq!(vd.len(), vec.len());\n+}\n+\n+#[test]\n+#[should_panic = \"capacity overflow\"]\n+fn test_from_vec_zst_overflow() {\n+    use crate::vec::Vec;\n+    let vec = Vec::from([(); MAXIMUM_ZST_CAPACITY]);\n+    let vd = VecDeque::from(vec.clone()); // no room for +1\n+    assert!(vd.cap().is_power_of_two());\n+    assert_eq!(vd.len(), vec.len());\n }\n \n #[test]"}]}