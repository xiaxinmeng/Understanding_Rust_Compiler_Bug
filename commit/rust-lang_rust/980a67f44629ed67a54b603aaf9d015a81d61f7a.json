{"sha": "980a67f44629ed67a54b603aaf9d015a81d61f7a", "node_id": "MDY6Q29tbWl0NzI0NzEyOjk4MGE2N2Y0NDYyOWVkNjdhNTRiNjAzYWFmOWQwMTVhODFkNjFmN2E=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-07-07T16:39:04Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-07-07T16:39:04Z"}, "message": "Merge #5253\n\n5253: Automate rust-analyzer promotion r=matklad a=matklad\n\n\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>", "tree": {"sha": "e954e38adb5ac1702f3c93cb08763af1a6a855bb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e954e38adb5ac1702f3c93cb08763af1a6a855bb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/980a67f44629ed67a54b603aaf9d015a81d61f7a", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfBKUoCRBK7hj4Ov3rIwAAdHIIADqh4EGSvrqPxoSLW/w09hTt\nbXbfiXniqvzasM+vT7Fvukav47Nt9eosq+s0i6oo4/5WjJ2AT8mIABB+1oLoiijK\nrte7eAVSixV3CXYF+CsHI668Y1NDxdRaV7ggByrE4Kbdllq4CfQdNCDXXbFssL6e\nk/5qptarLH00Zl7EyxZ5wI5dHCAPYE8W7hu+Q3O9JB6yb0cewRweUBQgQqq9uS8I\nBcxdj1WcGq67TxFH1nbEwnMNRIPMfqyQTuNswF3sGE2UCtu+fU5eZ50ojco7XkW6\nQFzNX1kCJdhzuiNNKY/ukBZPgS8RMJcl7UUXn29fa0siEt0KmnQnSZZTEP+gJus=\n=+B92\n-----END PGP SIGNATURE-----\n", "payload": "tree e954e38adb5ac1702f3c93cb08763af1a6a855bb\nparent 695f1a9af816e159ebe3ac7edb63ad81632192c2\nparent a614d84ff4b4edb43183e5d393ce042f186962a2\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1594139944 +0000\ncommitter GitHub <noreply@github.com> 1594139944 +0000\n\nMerge #5253\n\n5253: Automate rust-analyzer promotion r=matklad a=matklad\n\n\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/980a67f44629ed67a54b603aaf9d015a81d61f7a", "html_url": "https://github.com/rust-lang/rust/commit/980a67f44629ed67a54b603aaf9d015a81d61f7a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/980a67f44629ed67a54b603aaf9d015a81d61f7a/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "695f1a9af816e159ebe3ac7edb63ad81632192c2", "url": "https://api.github.com/repos/rust-lang/rust/commits/695f1a9af816e159ebe3ac7edb63ad81632192c2", "html_url": "https://github.com/rust-lang/rust/commit/695f1a9af816e159ebe3ac7edb63ad81632192c2"}, {"sha": "a614d84ff4b4edb43183e5d393ce042f186962a2", "url": "https://api.github.com/repos/rust-lang/rust/commits/a614d84ff4b4edb43183e5d393ce042f186962a2", "html_url": "https://github.com/rust-lang/rust/commit/a614d84ff4b4edb43183e5d393ce042f186962a2"}], "stats": {"total": 50, "additions": 47, "deletions": 3}, "files": [{"sha": "f447613d4306b7c9f1ec896e7ffd4f0753eb8050", "filename": "xtask/src/main.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/980a67f44629ed67a54b603aaf9d015a81d61f7a/xtask%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/980a67f44629ed67a54b603aaf9d015a81d61f7a/xtask%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/xtask%2Fsrc%2Fmain.rs?ref=980a67f44629ed67a54b603aaf9d015a81d61f7a", "patch": "@@ -17,7 +17,7 @@ use xtask::{\n     install::{ClientOpt, InstallCmd, ServerOpt},\n     not_bash::pushd,\n     pre_commit, project_root,\n-    release::ReleaseCmd,\n+    release::{PromoteCmd, ReleaseCmd},\n     run_clippy, run_fuzzer, run_pre_cache, run_rustfmt, Result,\n };\n \n@@ -105,6 +105,11 @@ FLAGS:\n             args.finish()?;\n             ReleaseCmd { dry_run }.run()\n         }\n+        \"promote\" => {\n+            let dry_run = args.contains(\"--dry-run\");\n+            args.finish()?;\n+            PromoteCmd { dry_run }.run()\n+        }\n         \"dist\" => {\n             let nightly = args.contains(\"--nightly\");\n             let client_version: Option<String> = args.opt_value_from_str(\"--client\")?;"}, {"sha": "8844fa2168a9f4229c046ca92f2ee68e31c37c78", "filename": "xtask/src/not_bash.rs", "status": "modified", "additions": 11, "deletions": 1, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/980a67f44629ed67a54b603aaf9d015a81d61f7a/xtask%2Fsrc%2Fnot_bash.rs", "raw_url": "https://github.com/rust-lang/rust/raw/980a67f44629ed67a54b603aaf9d015a81d61f7a/xtask%2Fsrc%2Fnot_bash.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/xtask%2Fsrc%2Fnot_bash.rs?ref=980a67f44629ed67a54b603aaf9d015a81d61f7a", "patch": "@@ -153,7 +153,17 @@ fn run_process_inner(cmd: &str, echo: bool, stdin: Option<&[u8]>) -> Result<Stri\n \n // FIXME: some real shell lexing here\n fn shelx(cmd: &str) -> Vec<String> {\n-    cmd.split_whitespace().map(|it| it.to_string()).collect()\n+    let mut res = Vec::new();\n+    for (string_piece, in_quotes) in cmd.split('\\'').zip([false, true].iter().copied().cycle()) {\n+        if in_quotes {\n+            res.push(string_piece.to_string())\n+        } else {\n+            if !string_piece.is_empty() {\n+                res.extend(string_piece.split_ascii_whitespace().map(|it| it.to_string()))\n+            }\n+        }\n+    }\n+    res\n }\n \n struct Env {"}, {"sha": "170cfee9fe8e40e57552579ac4e5b075ae116362", "filename": "xtask/src/release.rs", "status": "modified", "additions": 30, "deletions": 1, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/980a67f44629ed67a54b603aaf9d015a81d61f7a/xtask%2Fsrc%2Frelease.rs", "raw_url": "https://github.com/rust-lang/rust/raw/980a67f44629ed67a54b603aaf9d015a81d61f7a/xtask%2Fsrc%2Frelease.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/xtask%2Fsrc%2Frelease.rs?ref=980a67f44629ed67a54b603aaf9d015a81d61f7a", "patch": "@@ -1,6 +1,6 @@\n use crate::{\n     codegen, is_release_tag,\n-    not_bash::{date_iso, fs2, run},\n+    not_bash::{date_iso, fs2, pushd, run},\n     project_root, Mode, Result,\n };\n \n@@ -69,3 +69,32 @@ Release: release:{}[]\n         Ok(())\n     }\n }\n+\n+pub struct PromoteCmd {\n+    pub dry_run: bool,\n+}\n+\n+impl PromoteCmd {\n+    pub fn run(self) -> Result<()> {\n+        let _dir = pushd(\"../rust-rust-analyzer\");\n+        run!(\"git switch master\")?;\n+        run!(\"git fetch upstream\")?;\n+        run!(\"git reset --hard upstream/master\")?;\n+        run!(\"git submodule update --recursive\")?;\n+\n+        let branch = format!(\"rust-analyzer-{}\", date_iso()?);\n+        run!(\"git switch -c {}\", branch)?;\n+        {\n+            let _dir = pushd(\"src/tools/rust-analyzer\");\n+            run!(\"git fetch origin\")?;\n+            run!(\"git reset --hard origin/release\")?;\n+        }\n+        run!(\"git add src/tools/rust-analyzer\")?;\n+        run!(\"git commit -m':arrow_up: rust-analyzer'\")?;\n+        if !self.dry_run {\n+            run!(\"git push\")?;\n+            run!(\"xdg-open https://github.com/matklad/rust/pull/new/{}\", branch)?;\n+        }\n+        Ok(())\n+    }\n+}"}]}