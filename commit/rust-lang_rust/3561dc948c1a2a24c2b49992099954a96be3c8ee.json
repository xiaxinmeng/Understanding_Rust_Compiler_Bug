{"sha": "3561dc948c1a2a24c2b49992099954a96be3c8ee", "node_id": "C_kwDOAAsO6NoAKDM1NjFkYzk0OGMxYTJhMjRjMmI0OTk5MjA5OTk1NGE5NmJlM2M4ZWU", "commit": {"author": {"name": "Oleksii Lozovskyi", "email": "me@ilammy.net", "date": "2022-10-02T01:55:35Z"}, "committer": {"name": "Oleksii Lozovskyi", "email": "me@ilammy.net", "date": "2023-02-09T03:29:40Z"}, "message": "Emit an error if -Z instrument-xray is not supported\n\nThis is somewhat important because LLVM enables the pass based on\ntarget architecture, but support by the target OS also matters.\n\nFor example, XRay attributes are processed by codegen for macOS\ntargets, but Apple linker fails to process relocations in XRay\ndata sections, so the feature as a whole is not supported there\nfor the time being.", "tree": {"sha": "01b21b307e9a61c64f18d1f447fc7bb50549e8ec", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/01b21b307e9a61c64f18d1f447fc7bb50549e8ec"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3561dc948c1a2a24c2b49992099954a96be3c8ee", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3561dc948c1a2a24c2b49992099954a96be3c8ee", "html_url": "https://github.com/rust-lang/rust/commit/3561dc948c1a2a24c2b49992099954a96be3c8ee", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3561dc948c1a2a24c2b49992099954a96be3c8ee/comments", "author": {"login": "ilammy", "id": 1256587, "node_id": "MDQ6VXNlcjEyNTY1ODc=", "avatar_url": "https://avatars.githubusercontent.com/u/1256587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ilammy", "html_url": "https://github.com/ilammy", "followers_url": "https://api.github.com/users/ilammy/followers", "following_url": "https://api.github.com/users/ilammy/following{/other_user}", "gists_url": "https://api.github.com/users/ilammy/gists{/gist_id}", "starred_url": "https://api.github.com/users/ilammy/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ilammy/subscriptions", "organizations_url": "https://api.github.com/users/ilammy/orgs", "repos_url": "https://api.github.com/users/ilammy/repos", "events_url": "https://api.github.com/users/ilammy/events{/privacy}", "received_events_url": "https://api.github.com/users/ilammy/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ilammy", "id": 1256587, "node_id": "MDQ6VXNlcjEyNTY1ODc=", "avatar_url": "https://avatars.githubusercontent.com/u/1256587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ilammy", "html_url": "https://github.com/ilammy", "followers_url": "https://api.github.com/users/ilammy/followers", "following_url": "https://api.github.com/users/ilammy/following{/other_user}", "gists_url": "https://api.github.com/users/ilammy/gists{/gist_id}", "starred_url": "https://api.github.com/users/ilammy/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ilammy/subscriptions", "organizations_url": "https://api.github.com/users/ilammy/orgs", "repos_url": "https://api.github.com/users/ilammy/repos", "events_url": "https://api.github.com/users/ilammy/events{/privacy}", "received_events_url": "https://api.github.com/users/ilammy/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8e49c847400b0ec47d501a72e3c0ad95f81b5fe9", "url": "https://api.github.com/repos/rust-lang/rust/commits/8e49c847400b0ec47d501a72e3c0ad95f81b5fe9", "html_url": "https://github.com/rust-lang/rust/commit/8e49c847400b0ec47d501a72e3c0ad95f81b5fe9"}], "stats": {"total": 25, "additions": 25, "deletions": 0}, "files": [{"sha": "fe553edab4276ffacd618b99ffd877bad142a588", "filename": "compiler/rustc_error_messages/locales/en-US/session.ftl", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/3561dc948c1a2a24c2b49992099954a96be3c8ee/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fsession.ftl", "raw_url": "https://github.com/rust-lang/rust/raw/3561dc948c1a2a24c2b49992099954a96be3c8ee/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fsession.ftl", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fsession.ftl?ref=3561dc948c1a2a24c2b49992099954a96be3c8ee", "patch": "@@ -25,6 +25,8 @@ session_profile_sample_use_file_does_not_exist = file `{$path}` passed to `-C pr\n \n session_target_requires_unwind_tables = target requires unwind tables, they cannot be disabled with `-C force-unwind-tables=no`\n \n+session_instrumentation_not_supported = {$us} instrumentation is not supported for this target\n+\n session_sanitizer_not_supported = {$us} sanitizer is not supported for this target\n \n session_sanitizers_not_supported = {$us} sanitizers are not supported for this target"}, {"sha": "c851145440b863a55e957ba804af5d79722c0fa4", "filename": "compiler/rustc_session/src/errors.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/3561dc948c1a2a24c2b49992099954a96be3c8ee/compiler%2Frustc_session%2Fsrc%2Ferrors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3561dc948c1a2a24c2b49992099954a96be3c8ee/compiler%2Frustc_session%2Fsrc%2Ferrors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Ferrors.rs?ref=3561dc948c1a2a24c2b49992099954a96be3c8ee", "patch": "@@ -71,6 +71,12 @@ pub struct ProfileSampleUseFileDoesNotExist<'a> {\n #[diag(session_target_requires_unwind_tables)]\n pub struct TargetRequiresUnwindTables;\n \n+#[derive(Diagnostic)]\n+#[diag(session_instrumentation_not_supported)]\n+pub struct InstrumentationNotSupported {\n+    pub us: String,\n+}\n+\n #[derive(Diagnostic)]\n #[diag(session_sanitizer_not_supported)]\n pub struct SanitizerNotSupported {"}, {"sha": "fe6ac80fde6eb99e7cda05e7b248d1143d41fe2d", "filename": "compiler/rustc_session/src/session.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/3561dc948c1a2a24c2b49992099954a96be3c8ee/compiler%2Frustc_session%2Fsrc%2Fsession.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3561dc948c1a2a24c2b49992099954a96be3c8ee/compiler%2Frustc_session%2Fsrc%2Fsession.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Fsession.rs?ref=3561dc948c1a2a24c2b49992099954a96be3c8ee", "patch": "@@ -1589,6 +1589,10 @@ fn validate_commandline_args_with_session_available(sess: &Session) {\n     {\n         sess.emit_err(errors::SplitDebugInfoUnstablePlatform { debuginfo: sess.split_debuginfo() });\n     }\n+\n+    if sess.opts.unstable_opts.instrument_xray.is_some() && !sess.target.options.supports_xray {\n+        sess.emit_err(errors::InstrumentationNotSupported { us: \"XRay\".to_string() });\n+    }\n }\n \n /// Holds data on the current incremental compilation session, if there is one."}, {"sha": "e6bdd23e8fc3a1315755725498e05daeac77e19a", "filename": "tests/ui/instrument-xray/target-not-supported.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/3561dc948c1a2a24c2b49992099954a96be3c8ee/tests%2Fui%2Finstrument-xray%2Ftarget-not-supported.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3561dc948c1a2a24c2b49992099954a96be3c8ee/tests%2Fui%2Finstrument-xray%2Ftarget-not-supported.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Finstrument-xray%2Ftarget-not-supported.rs?ref=3561dc948c1a2a24c2b49992099954a96be3c8ee", "patch": "@@ -0,0 +1,9 @@\n+// Verifies that `-Z instrument-xray` cannot be used with unsupported targets,\n+//\n+// needs-llvm-components: x86\n+// compile-flags: -Z instrument-xray --target x86_64-apple-darwin\n+// error-pattern: error: XRay instrumentation is not supported for this target\n+\n+#![feature(no_core)]\n+#![no_core]\n+#![no_main]"}, {"sha": "6e3b0c8a380b8e0e1d4db3e407104d99c03d6913", "filename": "tests/ui/instrument-xray/target-not-supported.stderr", "status": "added", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/3561dc948c1a2a24c2b49992099954a96be3c8ee/tests%2Fui%2Finstrument-xray%2Ftarget-not-supported.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/3561dc948c1a2a24c2b49992099954a96be3c8ee/tests%2Fui%2Finstrument-xray%2Ftarget-not-supported.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Finstrument-xray%2Ftarget-not-supported.stderr?ref=3561dc948c1a2a24c2b49992099954a96be3c8ee", "patch": "@@ -0,0 +1,4 @@\n+error: XRay instrumentation is not supported for this target\n+\n+error: aborting due to previous error\n+"}]}