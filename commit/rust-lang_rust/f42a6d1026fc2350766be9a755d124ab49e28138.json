{"sha": "f42a6d1026fc2350766be9a755d124ab49e28138", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY0MmE2ZDEwMjZmYzIzNTA3NjZiZTlhNzU1ZDEyNGFiNDllMjgxMzg=", "commit": {"author": {"name": "hyd-dev", "email": "yd-huang@outlook.com", "date": "2021-05-26T22:40:47Z"}, "committer": {"name": "hyd-dev", "email": "yd-huang@outlook.com", "date": "2021-05-26T23:03:05Z"}, "message": "Skip doctests of `proc-macro` crates", "tree": {"sha": "cdf6c30a633a6d01a4fda4ebcd3314690d1f7704", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/cdf6c30a633a6d01a4fda4ebcd3314690d1f7704"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f42a6d1026fc2350766be9a755d124ab49e28138", "comment_count": 0, "verification": {"verified": false, "reason": "no_user", "signature": "-----BEGIN PGP SIGNATURE-----\n\niIsEABYIADMWIQRJ2jPMDdiQ+U4U42Z0+n/VuNoUuAUCYK7TqRUceWQtaHVhbmdA\nb3V0bG9vay5jb20ACgkQdPp/1bjaFLjh7wD+JInpE/SU1t2UQ2WbW6BR6iDqHQ9D\n8HN1GMHnmYcb0UsBAMg+1zTZvA5ujP9WPKFDsLdt8aCBtB+BPcIcz7lyi+oF\n=EbxF\n-----END PGP SIGNATURE-----", "payload": "tree cdf6c30a633a6d01a4fda4ebcd3314690d1f7704\nparent 62046bf8b4eadd4fb398d59f1eebcc140506bf85\nauthor hyd-dev <yd-huang@outlook.com> 1622068847 +0800\ncommitter hyd-dev <yd-huang@outlook.com> 1622070185 +0800\n\nSkip doctests of `proc-macro` crates\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f42a6d1026fc2350766be9a755d124ab49e28138", "html_url": "https://github.com/rust-lang/rust/commit/f42a6d1026fc2350766be9a755d124ab49e28138", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f42a6d1026fc2350766be9a755d124ab49e28138/comments", "author": null, "committer": null, "parents": [{"sha": "62046bf8b4eadd4fb398d59f1eebcc140506bf85", "url": "https://api.github.com/repos/rust-lang/rust/commits/62046bf8b4eadd4fb398d59f1eebcc140506bf85", "html_url": "https://github.com/rust-lang/rust/commit/62046bf8b4eadd4fb398d59f1eebcc140506bf85"}], "stats": {"total": 15, "additions": 15, "deletions": 0}, "files": [{"sha": "19d235cf67d71cb327160aaa751d277d325c4187", "filename": "cargo-miri/bin.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/f42a6d1026fc2350766be9a755d124ab49e28138/cargo-miri%2Fbin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f42a6d1026fc2350766be9a755d124ab49e28138/cargo-miri%2Fbin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/cargo-miri%2Fbin.rs?ref=f42a6d1026fc2350766be9a755d124ab49e28138", "patch": "@@ -903,6 +903,13 @@ fn phase_rustdoc(fst_arg: &str, mut args: env::Args) {\n         show_error(format!(\"cross-interpreting doc-tests is not currently supported by Miri.\"));\n     }\n \n+    // Doc-tests of `proc-macro` crates (and their dependencies) are always built for the host,\n+    // so we are not able to run them in Miri.\n+    if ArgFlagValueIter::new(\"--crate-type\").any(|crate_type| crate_type == \"proc-macro\") {\n+        eprintln!(\"Running doc-tests of `proc-macro` crates is not currently supported by Miri.\");\n+        return;\n+    }\n+\n     // For each doc-test, rustdoc starts two child processes: first the test is compiled,\n     // then the produced executable is invoked. We want to reroute both of these to cargo-miri,\n     // such that the first time we'll enter phase_cargo_rustc, and phase_cargo_runner second."}, {"sha": "c850e7d14591913f983b04ffbb4ae11a57f2c413", "filename": "test-cargo-miri/run-test.py", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/f42a6d1026fc2350766be9a755d124ab49e28138/test-cargo-miri%2Frun-test.py", "raw_url": "https://github.com/rust-lang/rust/raw/f42a6d1026fc2350766be9a755d124ab49e28138/test-cargo-miri%2Frun-test.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/test-cargo-miri%2Frun-test.py?ref=f42a6d1026fc2350766be9a755d124ab49e28138", "patch": "@@ -140,6 +140,10 @@ def test_cargo_miri_test():\n         \"test.subcrate.stdout.ref\", \"test.stderr-proc-macro.ref\",\n         env={'MIRIFLAGS': \"-Zmiri-disable-isolation\"},\n     )\n+    test(\"`cargo miri test` (subcrate, doctests)\",\n+        cargo_miri(\"test\") + [\"-p\", \"subcrate\", \"--doc\"],\n+        \"test.stdout-empty.ref\", \"test.stderr-proc-macro-doctest.ref\",\n+    )\n \n os.chdir(os.path.dirname(os.path.realpath(__file__)))\n os.environ[\"RUST_TEST_NOCAPTURE\"] = \"0\" # this affects test output, so make sure it is not set"}, {"sha": "07ed1acb7a05bc3fc8c9f4caa3f64b28d3ba31ba", "filename": "test-cargo-miri/subcrate/src/lib.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/f42a6d1026fc2350766be9a755d124ab49e28138/test-cargo-miri%2Fsubcrate%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f42a6d1026fc2350766be9a755d124ab49e28138/test-cargo-miri%2Fsubcrate%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/test-cargo-miri%2Fsubcrate%2Fsrc%2Flib.rs?ref=f42a6d1026fc2350766be9a755d124ab49e28138", "patch": "@@ -1,2 +1,5 @@\n+#[cfg(doctest)]\n+use num_cpus as _;\n+\n #[cfg(test)]\n compile_error!(\"Miri should not touch me\");"}, {"sha": "55d0f7cf54afdae63b4dda441bd066b5b445fb47", "filename": "test-cargo-miri/test.stderr-proc-macro-doctest.ref", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/f42a6d1026fc2350766be9a755d124ab49e28138/test-cargo-miri%2Ftest.stderr-proc-macro-doctest.ref", "raw_url": "https://github.com/rust-lang/rust/raw/f42a6d1026fc2350766be9a755d124ab49e28138/test-cargo-miri%2Ftest.stderr-proc-macro-doctest.ref", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/test-cargo-miri%2Ftest.stderr-proc-macro-doctest.ref?ref=f42a6d1026fc2350766be9a755d124ab49e28138", "patch": "@@ -0,0 +1 @@\n+Running doc-tests of `proc-macro` crates is not currently supported by Miri."}, {"sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391", "filename": "test-cargo-miri/test.stdout-empty.ref", "status": "added", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/f42a6d1026fc2350766be9a755d124ab49e28138/test-cargo-miri%2Ftest.stdout-empty.ref", "raw_url": "https://github.com/rust-lang/rust/raw/f42a6d1026fc2350766be9a755d124ab49e28138/test-cargo-miri%2Ftest.stdout-empty.ref", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/test-cargo-miri%2Ftest.stdout-empty.ref?ref=f42a6d1026fc2350766be9a755d124ab49e28138"}]}