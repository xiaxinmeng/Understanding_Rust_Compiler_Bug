{"sha": "aa15a5442a975180a367373e563b7f8c626b5344", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFhMTVhNTQ0MmE5NzUxODBhMzY3MzczZTU2M2I3ZjhjNjI2YjUzNDQ=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-05-12T08:01:10Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-05-12T08:01:10Z"}, "message": "Auto merge of #7197 - xFrednet:4310-depreciated-lints-collection, r=flip1995\n\nMetadata collection monster eating deprecated lints\n\nThis adds the collection of deprecated lints to the metadata collection monster. The JSON output has the same structure with the *new* lint group \"DEPRECATED\". Here is one of fourteen examples it was able to dig up in Clippy's code:\n\n```JSON\n  {\n    \"id\": \"assign_op_pattern\",\n    \"id_span\": {\n      \"path\": \"src/assign_ops.rs\",\n      \"line\": 34\n    },\n    \"group\": \"clippy::style\",\n    \"docs\": \" **What it does:** Checks for `a = a op b` or `a = b commutative_op a` patterns.\\n\\n **Why is this bad?** These can be written as the shorter `a op= b`.\\n\\n **Known problems:** While forbidden by the spec, `OpAssign` traits may have\\n implementations that differ from the regular `Op` impl.\\n\\n **Example:**\\n ```rust\\n let mut a = 5;\\n let b = 0;\\n // ...\\n // Bad\\n a = a + b;\\n\\n // Good\\n a += b;\\n ```\\n\",\n    \"applicability\": {\n      \"is_multi_part_suggestion\": false,\n      \"applicability\": \"MachineApplicable\"\n    }\n  }\n```\n\nAnd you! Yes you! Sir or Madam can get all of this **for free** in Clippy if this PR gets merged. (Sorry for the silliness ^^)\n\n---\n\nSee: #7172 for the full metadata collection to-do list or to suggest a new feature in connection to it :upside_down_face:\n\n---\n\nchangelog: none\n\nr? `@flip1995`", "tree": {"sha": "57359f3a59e7ef7dc6a3f616a092022d784e607e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/57359f3a59e7ef7dc6a3f616a092022d784e607e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/aa15a5442a975180a367373e563b7f8c626b5344", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/aa15a5442a975180a367373e563b7f8c626b5344", "html_url": "https://github.com/rust-lang/rust/commit/aa15a5442a975180a367373e563b7f8c626b5344", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/aa15a5442a975180a367373e563b7f8c626b5344/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0d4e24e73b28b33504df8daf1717e495f84fac40", "url": "https://api.github.com/repos/rust-lang/rust/commits/0d4e24e73b28b33504df8daf1717e495f84fac40", "html_url": "https://github.com/rust-lang/rust/commit/0d4e24e73b28b33504df8daf1717e495f84fac40"}, {"sha": "a988a90e112a68dd48222105f57556f97ea35fbd", "url": "https://api.github.com/repos/rust-lang/rust/commits/a988a90e112a68dd48222105f57556f97ea35fbd", "html_url": "https://github.com/rust-lang/rust/commit/a988a90e112a68dd48222105f57556f97ea35fbd"}], "stats": {"total": 86, "additions": 62, "deletions": 24}, "files": [{"sha": "50ffc2e3f1905c989f7ff95fba684269d68ba6e4", "filename": "clippy_lints/src/deprecated_lints.rs", "status": "modified", "additions": 9, "deletions": 2, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/aa15a5442a975180a367373e563b7f8c626b5344/clippy_lints%2Fsrc%2Fdeprecated_lints.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa15a5442a975180a367373e563b7f8c626b5344/clippy_lints%2Fsrc%2Fdeprecated_lints.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fdeprecated_lints.rs?ref=aa15a5442a975180a367373e563b7f8c626b5344", "patch": "@@ -1,6 +1,13 @@\n+/// This struct fakes the `Lint` declaration that is usually created by `declare_lint!`. This\n+/// enables the simple extraction of the metadata without changing the current deprecation\n+/// declaration.\n+pub struct ClippyDeprecatedLint;\n+\n macro_rules! declare_deprecated_lint {\n-    (pub $name: ident, $_reason: expr) => {\n-        declare_lint!(pub $name, Allow, \"deprecated lint\")\n+    { $(#[$attr:meta])* pub $name: ident, $_reason: expr} => {\n+        $(#[$attr])*\n+        #[allow(dead_code)]\n+        pub static $name: ClippyDeprecatedLint = ClippyDeprecatedLint {};\n     }\n }\n "}, {"sha": "0c86441cf3fe8b72c547787173c8077aac1b4a40", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/aa15a5442a975180a367373e563b7f8c626b5344/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa15a5442a975180a367373e563b7f8c626b5344/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=aa15a5442a975180a367373e563b7f8c626b5344", "patch": "@@ -162,6 +162,8 @@ macro_rules! extract_msrv_attr {\n mod consts;\n #[macro_use]\n mod utils;\n+#[cfg(feature = \"metadata-collector-lint\")]\n+mod deprecated_lints;\n \n // begin lints modules, do not remove this comment, it\u2019s used in `update_lints`\n mod absurd_extreme_comparisons;"}, {"sha": "fc4912ba52ff927fbe966d440f790ecd83bf22e9", "filename": "clippy_lints/src/utils/internal_lints/metadata_collector.rs", "status": "modified", "additions": 51, "deletions": 22, "changes": 73, "blob_url": "https://github.com/rust-lang/rust/blob/aa15a5442a975180a367373e563b7f8c626b5344/clippy_lints%2Fsrc%2Futils%2Finternal_lints%2Fmetadata_collector.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa15a5442a975180a367373e563b7f8c626b5344/clippy_lints%2Fsrc%2Futils%2Finternal_lints%2Fmetadata_collector.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Futils%2Finternal_lints%2Fmetadata_collector.rs?ref=aa15a5442a975180a367373e563b7f8c626b5344", "patch": "@@ -8,9 +8,6 @@\n //! during any comparison or mapping. (Please take care of this, it's not fun to spend time on such\n //! a simple mistake)\n \n-// # NITs\n-// - TODO xFrednet 2021-02-13: Collect depreciations and maybe renames\n-\n use if_chain::if_chain;\n use rustc_data_structures::fx::FxHashMap;\n use rustc_hir::{\n@@ -28,7 +25,7 @@ use std::path::Path;\n \n use crate::utils::internal_lints::is_lint_ref_type;\n use clippy_utils::{\n-    diagnostics::span_lint, last_path_segment, match_function_call, match_path, paths, ty::match_type,\n+    diagnostics::span_lint, last_path_segment, match_def_path, match_function_call, match_path, paths, ty::match_type,\n     ty::walk_ptrs_ty_depth,\n };\n \n@@ -41,6 +38,8 @@ const BLACK_LISTED_LINTS: [&str; 3] = [\"lint_author\", \"deep_code_inspection\", \"i\n const IGNORED_LINT_GROUPS: [&str; 1] = [\"clippy::all\"];\n /// Lints within this group will be excluded from the collection\n const EXCLUDED_LINT_GROUPS: [&str; 1] = [\"clippy::internal\"];\n+/// Collected deprecated lint will be assigned to this group in the JSON output\n+const DEPRECATED_LINT_GROUP_STR: &str = \"DEPRECATED\";\n \n const LINT_EMISSION_FUNCTIONS: [&[&str]; 7] = [\n     &[\"clippy_utils\", \"diagnostics\", \"span_lint\"],\n@@ -66,6 +65,7 @@ const SUGGESTION_FUNCTIONS: [&[&str]; 2] = [\n     &[\"clippy_utils\", \"diagnostics\", \"multispan_sugg\"],\n     &[\"clippy_utils\", \"diagnostics\", \"multispan_sugg_with_applicability\"],\n ];\n+const DEPRECATED_LINT_TYPE: [&str; 3] = [\"clippy_lints\", \"deprecated_lints\", \"ClippyDeprecatedLint\"];\n \n /// The index of the applicability name of `paths::APPLICABILITY_VALUES`\n const APPLICABILITY_NAME_INDEX: usize = 2;\n@@ -225,23 +225,42 @@ impl<'hir> LateLintPass<'hir> for MetadataCollector {\n     /// }\n     /// ```\n     fn check_item(&mut self, cx: &LateContext<'hir>, item: &'hir Item<'_>) {\n-        if_chain! {\n-            // item validation\n-            if let ItemKind::Static(ref ty, Mutability::Not, _) = item.kind;\n-            if is_lint_ref_type(cx, ty);\n-            // blacklist check\n-            let lint_name = sym_to_string(item.ident.name).to_ascii_lowercase();\n-            if !BLACK_LISTED_LINTS.contains(&lint_name.as_str());\n-            // metadata extraction\n-            if let Some(group) = get_lint_group_or_lint(cx, &lint_name, item);\n-            if let Some(docs) = extract_attr_docs_or_lint(cx, item);\n-            then {\n-                self.lints.push(LintMetadata::new(\n-                    lint_name,\n-                    SerializableSpan::from_item(cx, item),\n-                    group,\n-                    docs,\n-                ));\n+        if let ItemKind::Static(ref ty, Mutability::Not, _) = item.kind {\n+            // Normal lint\n+            if_chain! {\n+                // item validation\n+                if is_lint_ref_type(cx, ty);\n+                // blacklist check\n+                let lint_name = sym_to_string(item.ident.name).to_ascii_lowercase();\n+                if !BLACK_LISTED_LINTS.contains(&lint_name.as_str());\n+                // metadata extraction\n+                if let Some(group) = get_lint_group_or_lint(cx, &lint_name, item);\n+                if let Some(docs) = extract_attr_docs_or_lint(cx, item);\n+                then {\n+                    self.lints.push(LintMetadata::new(\n+                        lint_name,\n+                        SerializableSpan::from_item(cx, item),\n+                        group,\n+                        docs,\n+                    ));\n+                }\n+            }\n+\n+            if_chain! {\n+                if is_deprecated_lint(cx, ty);\n+                // blacklist check\n+                let lint_name = sym_to_string(item.ident.name).to_ascii_lowercase();\n+                if !BLACK_LISTED_LINTS.contains(&lint_name.as_str());\n+                // Metadata the little we can get from a deprecated lint\n+                if let Some(docs) = extract_attr_docs_or_lint(cx, item);\n+                then {\n+                    self.lints.push(LintMetadata::new(\n+                        lint_name,\n+                        SerializableSpan::from_item(cx, item),\n+                        DEPRECATED_LINT_GROUP_STR.to_string(),\n+                        docs,\n+                    ));\n+                }\n             }\n         }\n     }\n@@ -268,7 +287,7 @@ impl<'hir> LateLintPass<'hir> for MetadataCollector {\n                 // - src/misc.rs:734:9\n                 // - src/methods/mod.rs:3545:13\n                 // - src/methods/mod.rs:3496:13\n-                // We are basically unable to resolve the lint name it self.\n+                // We are basically unable to resolve the lint name itself.\n                 return;\n             }\n \n@@ -347,6 +366,16 @@ fn get_lint_group(cx: &LateContext<'_>, lint_id: LintId) -> Option<String> {\n     None\n }\n \n+fn is_deprecated_lint(cx: &LateContext<'_>, ty: &hir::Ty<'_>) -> bool {\n+    if let hir::TyKind::Path(ref path) = ty.kind {\n+        if let hir::def::Res::Def(DefKind::Struct, def_id) = cx.qpath_res(path, ty.hir_id) {\n+            return match_def_path(cx, def_id, &DEPRECATED_LINT_TYPE);\n+        }\n+    }\n+\n+    false\n+}\n+\n // ==================================================================\n // Lint emission\n // =================================================================="}]}