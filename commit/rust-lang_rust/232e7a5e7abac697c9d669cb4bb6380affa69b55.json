{"sha": "232e7a5e7abac697c9d669cb4bb6380affa69b55", "node_id": "MDY6Q29tbWl0NzI0NzEyOjIzMmU3YTVlN2FiYWM2OTdjOWQ2NjljYjRiYjYzODBhZmZhNjliNTU=", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2021-06-10T02:02:12Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-06-10T02:02:12Z"}, "message": "Rollup merge of #85997 - jyn514:rustdoc-diff, r=Mark-Simulacrum\n\nrustdoc: Print a warning if the diff when comparing to old nightlies is empty\n\nThis avoids confusing situations where it's unclear whether there's a\nbug in the diff tool or not:\n\n```\n26: `@has` check failed\n        `XPATH PATTERN` did not match\n        // `@has` - '//code/a[`@href=\"{{channel}}/std/primitive.i32.html\"]'` 'i32'\n\nEncountered 6 errors\n\n------------------------------------------\n\ninfo: generating a diff against nightly rustdoc\n\nfailures:\n    [rustdoc] rustdoc/primitive-reexport.rs\n```", "tree": {"sha": "345c74ef591d7ec893f7c24a26c0b61ab4cd45d0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/345c74ef591d7ec893f7c24a26c0b61ab4cd45d0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/232e7a5e7abac697c9d669cb4bb6380affa69b55", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgwXKkCRBK7hj4Ov3rIwAABSEIAG45QFxBbZbuY3O+tF2VqmOe\nv2GH9O++W83CB8Eg543iriNFSclFVEaVVvyrflWVPsBEdXJnfKZ5z85f/0yOaHGN\nflj3+12EsyxLDDlrbjsTNPqT8pLHU7P1kDbbqxU4ofVZuX8a91/0sutZBt64hpSL\nV7msXuPAnMTWFFIwLocwk0gpTGHZXLPg8UDV224RhLQbiUOwGb4JhFLuGPcbkQzA\nvq7K86p9smaMEEmuG0uDYQdNuObnt8IvTcJi5+FnXbte9kbpb+E4iqeVx5cuu78O\nKG02YQ/QQaN7qN9qIt630D5K9oDRK7dIPbDhpnxH0CbJjDOcxbddTjtFBFX1+7Q=\n=2o+S\n-----END PGP SIGNATURE-----\n", "payload": "tree 345c74ef591d7ec893f7c24a26c0b61ab4cd45d0\nparent 578eb6d65fbfaa30f6d0acd27ed2d506aa4d6117\nparent 2430ede36e1fba9044b82de9d09e6a71584f1db8\nauthor Yuki Okushi <jtitor@2k36.org> 1623290532 +0900\ncommitter GitHub <noreply@github.com> 1623290532 +0900\n\nRollup merge of #85997 - jyn514:rustdoc-diff, r=Mark-Simulacrum\n\nrustdoc: Print a warning if the diff when comparing to old nightlies is empty\n\nThis avoids confusing situations where it's unclear whether there's a\nbug in the diff tool or not:\n\n```\n26: `@has` check failed\n        `XPATH PATTERN` did not match\n        // `@has` - '//code/a[`@href=\"{{channel}}/std/primitive.i32.html\"]'` 'i32'\n\nEncountered 6 errors\n\n------------------------------------------\n\ninfo: generating a diff against nightly rustdoc\n\nfailures:\n    [rustdoc] rustdoc/primitive-reexport.rs\n```\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/232e7a5e7abac697c9d669cb4bb6380affa69b55", "html_url": "https://github.com/rust-lang/rust/commit/232e7a5e7abac697c9d669cb4bb6380affa69b55", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/232e7a5e7abac697c9d669cb4bb6380affa69b55/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "578eb6d65fbfaa30f6d0acd27ed2d506aa4d6117", "url": "https://api.github.com/repos/rust-lang/rust/commits/578eb6d65fbfaa30f6d0acd27ed2d506aa4d6117", "html_url": "https://github.com/rust-lang/rust/commit/578eb6d65fbfaa30f6d0acd27ed2d506aa4d6117"}, {"sha": "2430ede36e1fba9044b82de9d09e6a71584f1db8", "url": "https://api.github.com/repos/rust-lang/rust/commits/2430ede36e1fba9044b82de9d09e6a71584f1db8", "html_url": "https://github.com/rust-lang/rust/commit/2430ede36e1fba9044b82de9d09e6a71584f1db8"}], "stats": {"total": 30, "additions": 21, "deletions": 9}, "files": [{"sha": "1e7c3930246b30e77589057ff6c6497d2e105c9f", "filename": "src/tools/compiletest/src/runtest.rs", "status": "modified", "additions": 21, "deletions": 9, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/232e7a5e7abac697c9d669cb4bb6380affa69b55/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/232e7a5e7abac697c9d669cb4bb6380affa69b55/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs?ref=232e7a5e7abac697c9d669cb4bb6380affa69b55", "patch": "@@ -2488,6 +2488,7 @@ impl<'test> TestCx<'test> {\n \n         {\n             let mut diff_output = File::create(&diff_filename).unwrap();\n+            let mut wrote_data = false;\n             for entry in walkdir::WalkDir::new(out_dir) {\n                 let entry = entry.expect(\"failed to read file\");\n                 let extension = entry.path().extension().and_then(|p| p.to_str());\n@@ -2500,17 +2501,28 @@ impl<'test> TestCx<'test> {\n                         if let Ok(s) = std::fs::read(&expected_path) { s } else { continue };\n                     let actual_path = entry.path();\n                     let actual = std::fs::read(&actual_path).unwrap();\n-                    diff_output\n-                        .write_all(&unified_diff::diff(\n-                            &expected,\n-                            &expected_path.to_string_lossy(),\n-                            &actual,\n-                            &actual_path.to_string_lossy(),\n-                            3,\n-                        ))\n-                        .unwrap();\n+                    let diff = unified_diff::diff(\n+                        &expected,\n+                        &expected_path.to_string_lossy(),\n+                        &actual,\n+                        &actual_path.to_string_lossy(),\n+                        3,\n+                    );\n+                    wrote_data |= !diff.is_empty();\n+                    diff_output.write_all(&diff).unwrap();\n                 }\n             }\n+\n+            if !wrote_data {\n+                println!(\"note: diff is identical to nightly rustdoc\");\n+                assert!(diff_output.metadata().unwrap().len() == 0);\n+                return;\n+            } else if self.config.verbose {\n+                eprintln!(\"printing diff:\");\n+                let mut buf = Vec::new();\n+                diff_output.read_to_end(&mut buf).unwrap();\n+                std::io::stderr().lock().write_all(&mut buf).unwrap();\n+            }\n         }\n \n         match self.config.color {"}]}