{"sha": "aa8c982c3a989672e59e2f9ca01dcac4afc668b3", "node_id": "C_kwDOAAsO6NoAKGFhOGM5ODJjM2E5ODk2NzJlNTllMmY5Y2EwMWRjYWM0YWZjNjY4YjM", "commit": {"author": {"name": "Tianyi Song", "email": "42670338+tysg@users.noreply.github.com", "date": "2022-02-13T10:14:39Z"}, "committer": {"name": "Tianyi Song", "email": "42670338+tysg@users.noreply.github.com", "date": "2022-02-13T10:14:39Z"}, "message": "Address PR comments", "tree": {"sha": "b16fa2efc01db5a2f7713d444cd8f04b0e9a98a1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b16fa2efc01db5a2f7713d444cd8f04b0e9a98a1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/aa8c982c3a989672e59e2f9ca01dcac4afc668b3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/aa8c982c3a989672e59e2f9ca01dcac4afc668b3", "html_url": "https://github.com/rust-lang/rust/commit/aa8c982c3a989672e59e2f9ca01dcac4afc668b3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/aa8c982c3a989672e59e2f9ca01dcac4afc668b3/comments", "author": {"login": "tysg", "id": 42670338, "node_id": "MDQ6VXNlcjQyNjcwMzM4", "avatar_url": "https://avatars.githubusercontent.com/u/42670338?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tysg", "html_url": "https://github.com/tysg", "followers_url": "https://api.github.com/users/tysg/followers", "following_url": "https://api.github.com/users/tysg/following{/other_user}", "gists_url": "https://api.github.com/users/tysg/gists{/gist_id}", "starred_url": "https://api.github.com/users/tysg/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tysg/subscriptions", "organizations_url": "https://api.github.com/users/tysg/orgs", "repos_url": "https://api.github.com/users/tysg/repos", "events_url": "https://api.github.com/users/tysg/events{/privacy}", "received_events_url": "https://api.github.com/users/tysg/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tysg", "id": 42670338, "node_id": "MDQ6VXNlcjQyNjcwMzM4", "avatar_url": "https://avatars.githubusercontent.com/u/42670338?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tysg", "html_url": "https://github.com/tysg", "followers_url": "https://api.github.com/users/tysg/followers", "following_url": "https://api.github.com/users/tysg/following{/other_user}", "gists_url": "https://api.github.com/users/tysg/gists{/gist_id}", "starred_url": "https://api.github.com/users/tysg/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tysg/subscriptions", "organizations_url": "https://api.github.com/users/tysg/orgs", "repos_url": "https://api.github.com/users/tysg/repos", "events_url": "https://api.github.com/users/tysg/events{/privacy}", "received_events_url": "https://api.github.com/users/tysg/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e62e926a8a6e2446a1bb0908942247a63580f0a1", "url": "https://api.github.com/repos/rust-lang/rust/commits/e62e926a8a6e2446a1bb0908942247a63580f0a1", "html_url": "https://github.com/rust-lang/rust/commit/e62e926a8a6e2446a1bb0908942247a63580f0a1"}], "stats": {"total": 22, "additions": 15, "deletions": 7}, "files": [{"sha": "404e17c022b67bb15e4e06c21d5927980d39f240", "filename": "crates/ide_db/src/rename.rs", "status": "modified", "additions": 15, "deletions": 7, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/aa8c982c3a989672e59e2f9ca01dcac4afc668b3/crates%2Fide_db%2Fsrc%2Frename.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa8c982c3a989672e59e2f9ca01dcac4afc668b3/crates%2Fide_db%2Fsrc%2Frename.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_db%2Fsrc%2Frename.rs?ref=aa8c982c3a989672e59e2f9ca01dcac4afc668b3", "patch": "@@ -25,6 +25,7 @@ use std::fmt;\n use base_db::{AnchoredPathBuf, FileId, FileRange};\n use either::Either;\n use hir::{AsAssocItem, FieldSource, HasSource, InFile, ModuleSource, Semantics};\n+use stdx::never;\n use syntax::{\n     ast::{self, HasName},\n     AstNode, SyntaxKind, TextRange, T,\n@@ -187,13 +188,20 @@ fn rename_mod(\n         source_change.push_file_system_edit(move_file);\n     }\n \n-    if let Some(InFile { file_id, value: _ }) = module.declaration_source(sema.db) {\n-        let file_id = file_id.original_file(sema.db);\n-        if let Some(file_range) = Definition::Module(module).range_for_rename(sema) {\n-            source_change.insert_source_edit(\n-                file_id,\n-                TextEdit::replace(file_range.range, new_name.to_string()),\n-            )\n+    if let Some(src) = module.declaration_source(sema.db) {\n+        let file_id = src.file_id.original_file(sema.db);\n+        match src.value.name() {\n+            Some(name) => {\n+                if let Some(file_range) =\n+                    src.with_value(name.syntax()).original_file_range_opt(sema.db)\n+                {\n+                    source_change.insert_source_edit(\n+                        file_id,\n+                        TextEdit::replace(file_range.range, new_name.to_string()),\n+                    )\n+                };\n+            }\n+            _ => never!(\"Module source node is missing a name\"),\n         }\n     }\n "}]}