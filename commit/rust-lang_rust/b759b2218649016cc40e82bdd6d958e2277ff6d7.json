{"sha": "b759b2218649016cc40e82bdd6d958e2277ff6d7", "node_id": "C_kwDOAAsO6NoAKGI3NTliMjIxODY0OTAxNmNjNDBlODJiZGQ2ZDk1OGUyMjc3ZmY2ZDc", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-04-24T07:17:20Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-04-24T07:17:20Z"}, "message": "Auto merge of #96067 - jsgf:extern-nounused, r=compiler-errors\n\nAdd support for `nounused` --extern flag\n\nThis adds `nounused` to the set of extern flags:\n`--extern nounused:core=/path/to/core/libcore.rlib`.\n\nThe effect of this flag is to suppress `unused-crate-dependencies`\nwarnings relating to the crate.", "tree": {"sha": "a636703e82becf64d862221242b19471b364d579", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a636703e82becf64d862221242b19471b364d579"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b759b2218649016cc40e82bdd6d958e2277ff6d7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b759b2218649016cc40e82bdd6d958e2277ff6d7", "html_url": "https://github.com/rust-lang/rust/commit/b759b2218649016cc40e82bdd6d958e2277ff6d7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b759b2218649016cc40e82bdd6d958e2277ff6d7/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b21759f5509477522a208b27bec5822d89f7c6b8", "url": "https://api.github.com/repos/rust-lang/rust/commits/b21759f5509477522a208b27bec5822d89f7c6b8", "html_url": "https://github.com/rust-lang/rust/commit/b21759f5509477522a208b27bec5822d89f7c6b8"}, {"sha": "9102edf20861be49aac75c887b8c5096d82b1b55", "url": "https://api.github.com/repos/rust-lang/rust/commits/9102edf20861be49aac75c887b8c5096d82b1b55", "html_url": "https://github.com/rust-lang/rust/commit/9102edf20861be49aac75c887b8c5096d82b1b55"}], "stats": {"total": 39, "additions": 38, "deletions": 1}, "files": [{"sha": "6caa1032ba3cdffdadddc6404d437dbe71f7339f", "filename": "compiler/rustc_interface/src/tests.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/b759b2218649016cc40e82bdd6d958e2277ff6d7/compiler%2Frustc_interface%2Fsrc%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b759b2218649016cc40e82bdd6d958e2277ff6d7/compiler%2Frustc_interface%2Fsrc%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_interface%2Fsrc%2Ftests.rs?ref=b759b2218649016cc40e82bdd6d958e2277ff6d7", "patch": "@@ -66,6 +66,7 @@ where\n         location: ExternLocation::ExactPaths(locations),\n         is_private_dep: false,\n         add_prelude: true,\n+        nounused_dep: false,\n     }\n }\n "}, {"sha": "e8cdae7fd25ceb742492882fac8360b08774931a", "filename": "compiler/rustc_metadata/src/creader.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/b759b2218649016cc40e82bdd6d958e2277ff6d7/compiler%2Frustc_metadata%2Fsrc%2Fcreader.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b759b2218649016cc40e82bdd6d958e2277ff6d7/compiler%2Frustc_metadata%2Fsrc%2Fcreader.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_metadata%2Fsrc%2Fcreader.rs?ref=b759b2218649016cc40e82bdd6d958e2277ff6d7", "patch": "@@ -907,6 +907,10 @@ impl<'a> CrateLoader<'a> {\n                 // Don't worry about pathless `--extern foo` sysroot references\n                 continue;\n             }\n+            if entry.nounused_dep {\n+                // We're not worried about this one\n+                continue;\n+            }\n             let name_interned = Symbol::intern(name);\n             if self.used_extern_options.contains(&name_interned) {\n                 continue;"}, {"sha": "925f6bfd93d3cdf90f80671e2087fe1354175e0e", "filename": "compiler/rustc_session/src/config.rs", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/b759b2218649016cc40e82bdd6d958e2277ff6d7/compiler%2Frustc_session%2Fsrc%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b759b2218649016cc40e82bdd6d958e2277ff6d7/compiler%2Frustc_session%2Fsrc%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Fconfig.rs?ref=b759b2218649016cc40e82bdd6d958e2277ff6d7", "patch": "@@ -474,6 +474,11 @@ pub struct ExternEntry {\n     /// This can be disabled with the `noprelude` option like\n     /// `--extern noprelude:name`.\n     pub add_prelude: bool,\n+    /// The extern entry shouldn't be considered for unused dependency warnings.\n+    ///\n+    /// `--extern nounused:std=/path/to/lib/libstd.rlib`. This is used to\n+    /// suppress `unused-crate-dependencies` warnings.\n+    pub nounused_dep: bool,\n }\n \n #[derive(Clone, Debug)]\n@@ -512,7 +517,7 @@ impl Externs {\n \n impl ExternEntry {\n     fn new(location: ExternLocation) -> ExternEntry {\n-        ExternEntry { location, is_private_dep: false, add_prelude: false }\n+        ExternEntry { location, is_private_dep: false, add_prelude: false, nounused_dep: false }\n     }\n \n     pub fn files(&self) -> Option<impl Iterator<Item = &CanonicalizedPath>> {\n@@ -2131,6 +2136,7 @@ pub fn parse_externs(\n \n         let mut is_private_dep = false;\n         let mut add_prelude = true;\n+        let mut nounused_dep = false;\n         if let Some(opts) = options {\n             if !is_unstable_enabled {\n                 early_error(\n@@ -2152,6 +2158,7 @@ pub fn parse_externs(\n                             );\n                         }\n                     }\n+                    \"nounused\" => nounused_dep = true,\n                     _ => early_error(error_format, &format!(\"unknown --extern option `{opt}`\")),\n                 }\n             }\n@@ -2160,6 +2167,8 @@ pub fn parse_externs(\n         // Crates start out being not private, and go to being private `priv`\n         // is specified.\n         entry.is_private_dep |= is_private_dep;\n+        // likewise `nounused`\n+        entry.nounused_dep |= nounused_dep;\n         // If any flag is missing `noprelude`, then add to the prelude.\n         entry.add_prelude |= add_prelude;\n     }"}, {"sha": "5ec75595243a8831d609c53aa2505cc45c639ada", "filename": "src/test/ui/extern-flag/no-nounused.rs", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/b759b2218649016cc40e82bdd6d958e2277ff6d7/src%2Ftest%2Fui%2Fextern-flag%2Fno-nounused.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b759b2218649016cc40e82bdd6d958e2277ff6d7/src%2Ftest%2Fui%2Fextern-flag%2Fno-nounused.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fextern-flag%2Fno-nounused.rs?ref=b759b2218649016cc40e82bdd6d958e2277ff6d7", "patch": "@@ -0,0 +1,6 @@\n+// aux-crate:somedep=somedep.rs\n+// compile-flags: -Zunstable-options -Dunused-crate-dependencies\n+// edition:2018\n+\n+fn main() { //~ ERROR external crate `somedep` unused in `no_nounused`\n+}"}, {"sha": "6446c53236ca262afbfe36360fb2b8365f755d6e", "filename": "src/test/ui/extern-flag/no-nounused.stderr", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/b759b2218649016cc40e82bdd6d958e2277ff6d7/src%2Ftest%2Fui%2Fextern-flag%2Fno-nounused.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/b759b2218649016cc40e82bdd6d958e2277ff6d7/src%2Ftest%2Fui%2Fextern-flag%2Fno-nounused.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fextern-flag%2Fno-nounused.stderr?ref=b759b2218649016cc40e82bdd6d958e2277ff6d7", "patch": "@@ -0,0 +1,10 @@\n+error: external crate `somedep` unused in `no_nounused`: remove the dependency or add `use somedep as _;`\n+  --> $DIR/no-nounused.rs:5:1\n+   |\n+LL | fn main() {\n+   | ^\n+   |\n+   = note: requested on the command line with `-D unused-crate-dependencies`\n+\n+error: aborting due to previous error\n+"}, {"sha": "2513986bbec753031fb160739c10514f55e105d2", "filename": "src/test/ui/extern-flag/nounused.rs", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/b759b2218649016cc40e82bdd6d958e2277ff6d7/src%2Ftest%2Fui%2Fextern-flag%2Fnounused.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b759b2218649016cc40e82bdd6d958e2277ff6d7/src%2Ftest%2Fui%2Fextern-flag%2Fnounused.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fextern-flag%2Fnounused.rs?ref=b759b2218649016cc40e82bdd6d958e2277ff6d7", "patch": "@@ -0,0 +1,7 @@\n+// check-pass\n+// aux-crate:nounused:somedep=somedep.rs\n+// compile-flags: -Zunstable-options -Dunused-crate-dependencies\n+// edition:2018\n+\n+fn main() {\n+}"}]}