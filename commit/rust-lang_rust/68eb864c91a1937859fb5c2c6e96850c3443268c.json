{"sha": "68eb864c91a1937859fb5c2c6e96850c3443268c", "node_id": "C_kwDOAAsO6NoAKDY4ZWI4NjRjOTFhMTkzNzg1OWZiNWMyYzZlOTY4NTBjMzQ0MzI2OGM", "commit": {"author": {"name": "Alex Macleod", "email": "alex@macleod.io", "date": "2023-05-05T18:30:41Z"}, "committer": {"name": "Alex Macleod", "email": "alex@macleod.io", "date": "2023-05-05T18:35:54Z"}, "message": "Ignore expressions from macros in default_constructed_unit_structs", "tree": {"sha": "b234faf2f6e9ef84917ea8bedf1a52bb54ae0b8f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b234faf2f6e9ef84917ea8bedf1a52bb54ae0b8f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/68eb864c91a1937859fb5c2c6e96850c3443268c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/68eb864c91a1937859fb5c2c6e96850c3443268c", "html_url": "https://github.com/rust-lang/rust/commit/68eb864c91a1937859fb5c2c6e96850c3443268c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/68eb864c91a1937859fb5c2c6e96850c3443268c/comments", "author": {"login": "Alexendoo", "id": 1830331, "node_id": "MDQ6VXNlcjE4MzAzMzE=", "avatar_url": "https://avatars.githubusercontent.com/u/1830331?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Alexendoo", "html_url": "https://github.com/Alexendoo", "followers_url": "https://api.github.com/users/Alexendoo/followers", "following_url": "https://api.github.com/users/Alexendoo/following{/other_user}", "gists_url": "https://api.github.com/users/Alexendoo/gists{/gist_id}", "starred_url": "https://api.github.com/users/Alexendoo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Alexendoo/subscriptions", "organizations_url": "https://api.github.com/users/Alexendoo/orgs", "repos_url": "https://api.github.com/users/Alexendoo/repos", "events_url": "https://api.github.com/users/Alexendoo/events{/privacy}", "received_events_url": "https://api.github.com/users/Alexendoo/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Alexendoo", "id": 1830331, "node_id": "MDQ6VXNlcjE4MzAzMzE=", "avatar_url": "https://avatars.githubusercontent.com/u/1830331?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Alexendoo", "html_url": "https://github.com/Alexendoo", "followers_url": "https://api.github.com/users/Alexendoo/followers", "following_url": "https://api.github.com/users/Alexendoo/following{/other_user}", "gists_url": "https://api.github.com/users/Alexendoo/gists{/gist_id}", "starred_url": "https://api.github.com/users/Alexendoo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Alexendoo/subscriptions", "organizations_url": "https://api.github.com/users/Alexendoo/orgs", "repos_url": "https://api.github.com/users/Alexendoo/repos", "events_url": "https://api.github.com/users/Alexendoo/events{/privacy}", "received_events_url": "https://api.github.com/users/Alexendoo/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "371120bdbf58a331db5dcfb2d9cddc040f486de8", "url": "https://api.github.com/repos/rust-lang/rust/commits/371120bdbf58a331db5dcfb2d9cddc040f486de8", "html_url": "https://github.com/rust-lang/rust/commit/371120bdbf58a331db5dcfb2d9cddc040f486de8"}], "stats": {"total": 51, "additions": 47, "deletions": 4}, "files": [{"sha": "9bd7a0dc0f3b88f01abbbeba191239051ecedde4", "filename": "clippy_lints/src/default_constructed_unit_structs.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/68eb864c91a1937859fb5c2c6e96850c3443268c/clippy_lints%2Fsrc%2Fdefault_constructed_unit_structs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/68eb864c91a1937859fb5c2c6e96850c3443268c/clippy_lints%2Fsrc%2Fdefault_constructed_unit_structs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fdefault_constructed_unit_structs.rs?ref=68eb864c91a1937859fb5c2c6e96850c3443268c", "patch": "@@ -1,4 +1,4 @@\n-use clippy_utils::{diagnostics::span_lint_and_sugg, is_from_proc_macro, match_def_path, paths};\n+use clippy_utils::{diagnostics::span_lint_and_sugg, match_def_path, paths};\n use hir::{def::Res, ExprKind};\n use rustc_errors::Applicability;\n use rustc_hir as hir;\n@@ -55,7 +55,8 @@ impl LateLintPass<'_> for DefaultConstructedUnitStructs {\n             if let ty::Adt(def, ..) = cx.typeck_results().expr_ty(expr).kind();\n             if def.is_struct();\n             if let var @ ty::VariantDef { ctor: Some((hir::def::CtorKind::Const, _)), .. } = def.non_enum_variant();\n-            if !var.is_field_list_non_exhaustive() && !is_from_proc_macro(cx, expr);\n+            if !var.is_field_list_non_exhaustive();\n+            if !expr.span.from_expansion() && !qpath.span().from_expansion();\n             then {\n                 span_lint_and_sugg(\n                     cx,"}, {"sha": "e1012f38bba2adafee4cad0adb715e37e02ff2da", "filename": "tests/ui/default_constructed_unit_structs.fixed", "status": "modified", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/68eb864c91a1937859fb5c2c6e96850c3443268c/tests%2Fui%2Fdefault_constructed_unit_structs.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/68eb864c91a1937859fb5c2c6e96850c3443268c/tests%2Fui%2Fdefault_constructed_unit_structs.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fdefault_constructed_unit_structs.fixed?ref=68eb864c91a1937859fb5c2c6e96850c3443268c", "patch": "@@ -105,6 +105,7 @@ fn main() {\n     // should lint\n     let _ = PhantomData::<usize>;\n     let _: PhantomData<i32> = PhantomData;\n+    let _: PhantomData<i32> = std::marker::PhantomData;\n     let _ = UnitStruct;\n \n     // should not lint\n@@ -116,4 +117,21 @@ fn main() {\n     let _ = EmptyStruct::default();\n     let _ = FakeDefault::default();\n     let _ = <FakeDefault as Default>::default();\n+\n+    macro_rules! in_macro {\n+        ($i:ident) => {{\n+            let _ = UnitStruct::default();\n+            let _ = $i::default();\n+        }};\n+    }\n+\n+    in_macro!(UnitStruct);\n+\n+    macro_rules! struct_from_macro {\n+        () => {\n+            UnitStruct\n+        };\n+    }\n+\n+    let _ = <struct_from_macro!()>::default();\n }"}, {"sha": "c7b4313dbf0c92fdb9d5222acba3a19f78516b37", "filename": "tests/ui/default_constructed_unit_structs.rs", "status": "modified", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/68eb864c91a1937859fb5c2c6e96850c3443268c/tests%2Fui%2Fdefault_constructed_unit_structs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/68eb864c91a1937859fb5c2c6e96850c3443268c/tests%2Fui%2Fdefault_constructed_unit_structs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fdefault_constructed_unit_structs.rs?ref=68eb864c91a1937859fb5c2c6e96850c3443268c", "patch": "@@ -105,6 +105,7 @@ fn main() {\n     // should lint\n     let _ = PhantomData::<usize>::default();\n     let _: PhantomData<i32> = PhantomData::default();\n+    let _: PhantomData<i32> = std::marker::PhantomData::default();\n     let _ = UnitStruct::default();\n \n     // should not lint\n@@ -116,4 +117,21 @@ fn main() {\n     let _ = EmptyStruct::default();\n     let _ = FakeDefault::default();\n     let _ = <FakeDefault as Default>::default();\n+\n+    macro_rules! in_macro {\n+        ($i:ident) => {{\n+            let _ = UnitStruct::default();\n+            let _ = $i::default();\n+        }};\n+    }\n+\n+    in_macro!(UnitStruct);\n+\n+    macro_rules! struct_from_macro {\n+        () => {\n+            UnitStruct\n+        };\n+    }\n+\n+    let _ = <struct_from_macro!()>::default();\n }"}, {"sha": "61a32fb10e53b0ca39568d4ffc49e8f4f20983e2", "filename": "tests/ui/default_constructed_unit_structs.stderr", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/68eb864c91a1937859fb5c2c6e96850c3443268c/tests%2Fui%2Fdefault_constructed_unit_structs.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/68eb864c91a1937859fb5c2c6e96850c3443268c/tests%2Fui%2Fdefault_constructed_unit_structs.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fdefault_constructed_unit_structs.stderr?ref=68eb864c91a1937859fb5c2c6e96850c3443268c", "patch": "@@ -25,10 +25,16 @@ LL |     let _: PhantomData<i32> = PhantomData::default();\n    |                                          ^^^^^^^^^^^ help: remove this call to `default`\n \n error: use of `default` to create a unit struct\n-  --> $DIR/default_constructed_unit_structs.rs:108:23\n+  --> $DIR/default_constructed_unit_structs.rs:108:55\n+   |\n+LL |     let _: PhantomData<i32> = std::marker::PhantomData::default();\n+   |                                                       ^^^^^^^^^^^ help: remove this call to `default`\n+\n+error: use of `default` to create a unit struct\n+  --> $DIR/default_constructed_unit_structs.rs:109:23\n    |\n LL |     let _ = UnitStruct::default();\n    |                       ^^^^^^^^^^^ help: remove this call to `default`\n \n-error: aborting due to 5 previous errors\n+error: aborting due to 6 previous errors\n "}]}