{"sha": "7068c2d4e9af54c1e1a2fae2a7d17786c49fea7d", "node_id": "MDY6Q29tbWl0NzI0NzEyOjcwNjhjMmQ0ZTlhZjU0YzFlMWEyZmFlMmE3ZDE3Nzg2YzQ5ZmVhN2Q=", "commit": {"author": {"name": "Yuki Okushi", "email": "huyuumi.dev@gmail.com", "date": "2019-10-25T17:45:57Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-10-25T17:45:57Z"}, "message": "Rollup merge of #65749 - Centril:insurance-policy, r=RalfJung\n\nInsurance policy in case `iter.size_hint()` lies.\n\nFollow up to https://github.com/rust-lang/rust/pull/64949/files#r334235076.\n(If the perf impact is bad we can use `debug_assert!` instead.)\n\nThe good news is that the UI tests pass locally so `iter.size_hint()` seems to be honest *thus far*.\nOn the other hand, with the status quo we do not have an insurance policy should that change in some case. This is problematic because a) this could possibly make some program be accepted which shouldn't, b) the compiler itself could have memory unsafety if the correctness of the iterator is assumed in `unsafe { ... }` code (even though the blame lies with the `unsafe { ... }` block in question.)\n\nr? @RalfJung\ncc @nnethercote", "tree": {"sha": "d09174d556f7ae8ea90168673d9e28269b90f48d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d09174d556f7ae8ea90168673d9e28269b90f48d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7068c2d4e9af54c1e1a2fae2a7d17786c49fea7d", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJdszTVCRBK7hj4Ov3rIwAAdHIIAHSNXMTNFqoPoM54QW/1Ske4\nUZALnIyMMveCEPBS1Nfv+Y/vPlmZW6WOQkZzrHhIU31T/RHpIqh0KkJTE0A42ndZ\nC/DEK/XH5n+tuFJVK4Zx+c3CxEjoqWI8tYDl8SOIumH4M7W8fdj0XEujMaFcrgq9\nN/+bPOG818Sws7hGxIWzut2QaivVUgL058ZUVDB40wTs9t9yKgPuvx95K4A8kpoh\nOEQvyzeeXh94aujB/JqZzP4Tp4PYUA5hnoRuKOnLv/jhZp9AtHKsYIKAcHJbCdFi\ndq8tt++/Dd3c3KHEXfCQ0Bn4Cix8aor22Txb1SjMX7dHGsvPcX/ejSNISIWJ3Fw=\n=Lg91\n-----END PGP SIGNATURE-----\n", "payload": "tree d09174d556f7ae8ea90168673d9e28269b90f48d\nparent a808ba374f7fdf6fea3f0bde9ce09f98f0db7d2d\nparent dfcfca28ad1321aff82503ebfffd40cf6476a7a2\nauthor Yuki Okushi <huyuumi.dev@gmail.com> 1572025557 +0900\ncommitter GitHub <noreply@github.com> 1572025557 +0900\n\nRollup merge of #65749 - Centril:insurance-policy, r=RalfJung\n\nInsurance policy in case `iter.size_hint()` lies.\n\nFollow up to https://github.com/rust-lang/rust/pull/64949/files#r334235076.\n(If the perf impact is bad we can use `debug_assert!` instead.)\n\nThe good news is that the UI tests pass locally so `iter.size_hint()` seems to be honest *thus far*.\nOn the other hand, with the status quo we do not have an insurance policy should that change in some case. This is problematic because a) this could possibly make some program be accepted which shouldn't, b) the compiler itself could have memory unsafety if the correctness of the iterator is assumed in `unsafe { ... }` code (even though the blame lies with the `unsafe { ... }` block in question.)\n\nr? @RalfJung\ncc @nnethercote\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7068c2d4e9af54c1e1a2fae2a7d17786c49fea7d", "html_url": "https://github.com/rust-lang/rust/commit/7068c2d4e9af54c1e1a2fae2a7d17786c49fea7d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7068c2d4e9af54c1e1a2fae2a7d17786c49fea7d/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a808ba374f7fdf6fea3f0bde9ce09f98f0db7d2d", "url": "https://api.github.com/repos/rust-lang/rust/commits/a808ba374f7fdf6fea3f0bde9ce09f98f0db7d2d", "html_url": "https://github.com/rust-lang/rust/commit/a808ba374f7fdf6fea3f0bde9ce09f98f0db7d2d"}, {"sha": "dfcfca28ad1321aff82503ebfffd40cf6476a7a2", "url": "https://api.github.com/repos/rust-lang/rust/commits/dfcfca28ad1321aff82503ebfffd40cf6476a7a2", "html_url": "https://github.com/rust-lang/rust/commit/dfcfca28ad1321aff82503ebfffd40cf6476a7a2"}], "stats": {"total": 6, "additions": 5, "deletions": 1}, "files": [{"sha": "0f7d5d9a25e617d8b750e9b59bd16f980139f25b", "filename": "src/librustc/ty/context.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/7068c2d4e9af54c1e1a2fae2a7d17786c49fea7d/src%2Flibrustc%2Fty%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7068c2d4e9af54c1e1a2fae2a7d17786c49fea7d/src%2Flibrustc%2Fty%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fcontext.rs?ref=7068c2d4e9af54c1e1a2fae2a7d17786c49fea7d", "patch": "@@ -2930,14 +2930,18 @@ impl<T, R, E> InternIteratorElement<T, R> for Result<T, E> {\n         // lower bounds from `size_hint` agree they are correct.\n         Ok(match iter.size_hint() {\n             (1, Some(1)) => {\n-                f(&[iter.next().unwrap()?])\n+                let t0 = iter.next().unwrap()?;\n+                assert!(iter.next().is_none());\n+                f(&[t0])\n             }\n             (2, Some(2)) => {\n                 let t0 = iter.next().unwrap()?;\n                 let t1 = iter.next().unwrap()?;\n+                assert!(iter.next().is_none());\n                 f(&[t0, t1])\n             }\n             (0, Some(0)) => {\n+                assert!(iter.next().is_none());\n                 f(&[])\n             }\n             _ => {"}]}