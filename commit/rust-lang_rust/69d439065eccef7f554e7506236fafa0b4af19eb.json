{"sha": "69d439065eccef7f554e7506236fafa0b4af19eb", "node_id": "MDY6Q29tbWl0NzI0NzEyOjY5ZDQzOTA2NWVjY2VmN2Y1NTRlNzUwNjIzNmZhZmEwYjRhZjE5ZWI=", "commit": {"author": {"name": "Dharma Saputra Wijaya", "email": "dswijj@gmail.com", "date": "2021-08-01T09:47:29Z"}, "committer": {"name": "Dharma Saputra Wijaya", "email": "dswijj@gmail.com", "date": "2021-08-01T09:47:54Z"}, "message": "Handle `Result` on `map_flatten` lint\n\nAdds a check on `.map(..).flatten()` on `Result` type that follows the\nbehaviour on `Option` type.", "tree": {"sha": "3d7a68bcf2f4c5066feda997042ec8ec949a29bf", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3d7a68bcf2f4c5066feda997042ec8ec949a29bf"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/69d439065eccef7f554e7506236fafa0b4af19eb", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/69d439065eccef7f554e7506236fafa0b4af19eb", "html_url": "https://github.com/rust-lang/rust/commit/69d439065eccef7f554e7506236fafa0b4af19eb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/69d439065eccef7f554e7506236fafa0b4af19eb/comments", "author": {"login": "dswij", "id": 44697459, "node_id": "MDQ6VXNlcjQ0Njk3NDU5", "avatar_url": "https://avatars.githubusercontent.com/u/44697459?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dswij", "html_url": "https://github.com/dswij", "followers_url": "https://api.github.com/users/dswij/followers", "following_url": "https://api.github.com/users/dswij/following{/other_user}", "gists_url": "https://api.github.com/users/dswij/gists{/gist_id}", "starred_url": "https://api.github.com/users/dswij/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dswij/subscriptions", "organizations_url": "https://api.github.com/users/dswij/orgs", "repos_url": "https://api.github.com/users/dswij/repos", "events_url": "https://api.github.com/users/dswij/events{/privacy}", "received_events_url": "https://api.github.com/users/dswij/received_events", "type": "User", "site_admin": false}, "committer": {"login": "dswij", "id": 44697459, "node_id": "MDQ6VXNlcjQ0Njk3NDU5", "avatar_url": "https://avatars.githubusercontent.com/u/44697459?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dswij", "html_url": "https://github.com/dswij", "followers_url": "https://api.github.com/users/dswij/followers", "following_url": "https://api.github.com/users/dswij/following{/other_user}", "gists_url": "https://api.github.com/users/dswij/gists{/gist_id}", "starred_url": "https://api.github.com/users/dswij/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dswij/subscriptions", "organizations_url": "https://api.github.com/users/dswij/orgs", "repos_url": "https://api.github.com/users/dswij/repos", "events_url": "https://api.github.com/users/dswij/events{/privacy}", "received_events_url": "https://api.github.com/users/dswij/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "05fa78fd3edaf19a2508db9a74dbaa4cb009f236", "url": "https://api.github.com/repos/rust-lang/rust/commits/05fa78fd3edaf19a2508db9a74dbaa4cb009f236", "html_url": "https://github.com/rust-lang/rust/commit/05fa78fd3edaf19a2508db9a74dbaa4cb009f236"}], "stats": {"total": 70, "additions": 49, "deletions": 21}, "files": [{"sha": "08d3a7ce92bbea268cbdae460c78cc43e5bd3733", "filename": "clippy_lints/src/methods/map_flatten.rs", "status": "modified", "additions": 28, "deletions": 14, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/69d439065eccef7f554e7506236fafa0b4af19eb/clippy_lints%2Fsrc%2Fmethods%2Fmap_flatten.rs", "raw_url": "https://github.com/rust-lang/rust/raw/69d439065eccef7f554e7506236fafa0b4af19eb/clippy_lints%2Fsrc%2Fmethods%2Fmap_flatten.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmethods%2Fmap_flatten.rs?ref=69d439065eccef7f554e7506236fafa0b4af19eb", "patch": "@@ -52,18 +52,32 @@ pub(super) fn check<'tcx>(\n         );\n     }\n \n-    // lint if caller of `.map().flatten()` is an Option\n-    if is_type_diagnostic_item(cx, cx.typeck_results().expr_ty(recv), sym::option_type) {\n-        let func_snippet = snippet(cx, map_arg.span, \"..\");\n-        let hint = format!(\".and_then({})\", func_snippet);\n-        span_lint_and_sugg(\n-            cx,\n-            MAP_FLATTEN,\n-            expr.span.with_lo(recv.span.hi()),\n-            \"called `map(..).flatten()` on an `Option`\",\n-            \"try using `and_then` instead\",\n-            hint,\n-            Applicability::MachineApplicable,\n-        );\n-    }\n+    // lint if caller of `.map().flatten()` is an Option or Result\n+    let caller_type = match cx.typeck_results().expr_ty(recv).kind() {\n+        ty::Adt(adt, _) => {\n+            if cx.tcx.is_diagnostic_item(sym::option_type, adt.did) {\n+                \"Option\"\n+            } else if cx.tcx.is_diagnostic_item(sym::result_type, adt.did) {\n+                \"Result\"\n+            } else {\n+                return;\n+            }\n+        },\n+        _ => {\n+            return;\n+        },\n+    };\n+\n+    let func_snippet = snippet(cx, map_arg.span, \"..\");\n+    let hint = format!(\".and_then({})\", func_snippet);\n+    let lint_info = format!(\"called `map(..).flatten()` on an `{}`\", caller_type);\n+    span_lint_and_sugg(\n+        cx,\n+        MAP_FLATTEN,\n+        expr.span.with_lo(recv.span.hi()),\n+        &lint_info,\n+        \"try using `and_then` instead\",\n+        hint,\n+        Applicability::MachineApplicable,\n+    );\n }"}, {"sha": "18846c898da051566ee99796f98af0724f91def5", "filename": "tests/ui/map_flatten.fixed", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/69d439065eccef7f554e7506236fafa0b4af19eb/tests%2Fui%2Fmap_flatten.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/69d439065eccef7f554e7506236fafa0b4af19eb/tests%2Fui%2Fmap_flatten.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmap_flatten.fixed?ref=69d439065eccef7f554e7506236fafa0b4af19eb", "patch": "@@ -5,6 +5,7 @@\n #![allow(clippy::missing_docs_in_private_items)]\n #![allow(clippy::map_identity)]\n #![allow(clippy::unnecessary_wraps)]\n+#![feature(result_flattening)]\n \n fn main() {\n     // mapping to Option on Iterator\n@@ -23,4 +24,7 @@ fn main() {\n \n     // mapping to Option on Option\n     let _: Option<_> = (Some(Some(1))).and_then(|x| x);\n+\n+    // mapping to Result on Result\n+    let _: Result<_, &str> = (Ok(Ok(1))).and_then(|x| x);\n }"}, {"sha": "01db27876da703a698c4b0da0ccef2dcba2cf790", "filename": "tests/ui/map_flatten.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/69d439065eccef7f554e7506236fafa0b4af19eb/tests%2Fui%2Fmap_flatten.rs", "raw_url": "https://github.com/rust-lang/rust/raw/69d439065eccef7f554e7506236fafa0b4af19eb/tests%2Fui%2Fmap_flatten.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmap_flatten.rs?ref=69d439065eccef7f554e7506236fafa0b4af19eb", "patch": "@@ -5,6 +5,7 @@\n #![allow(clippy::missing_docs_in_private_items)]\n #![allow(clippy::map_identity)]\n #![allow(clippy::unnecessary_wraps)]\n+#![feature(result_flattening)]\n \n fn main() {\n     // mapping to Option on Iterator\n@@ -23,4 +24,7 @@ fn main() {\n \n     // mapping to Option on Option\n     let _: Option<_> = (Some(Some(1))).map(|x| x).flatten();\n+\n+    // mapping to Result on Result\n+    let _: Result<_, &str> = (Ok(Ok(1))).map(|x| x).flatten();\n }"}, {"sha": "38457c8ea4dd4ad16de7cb16eb7c880c90d176cf", "filename": "tests/ui/map_flatten.stderr", "status": "modified", "additions": 13, "deletions": 7, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/69d439065eccef7f554e7506236fafa0b4af19eb/tests%2Fui%2Fmap_flatten.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/69d439065eccef7f554e7506236fafa0b4af19eb/tests%2Fui%2Fmap_flatten.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmap_flatten.stderr?ref=69d439065eccef7f554e7506236fafa0b4af19eb", "patch": "@@ -1,40 +1,46 @@\n error: called `map(..).flatten()` on an `Iterator`\n-  --> $DIR/map_flatten.rs:16:46\n+  --> $DIR/map_flatten.rs:17:46\n    |\n LL |     let _: Vec<_> = vec![5_i8; 6].into_iter().map(option_id).flatten().collect();\n    |                                              ^^^^^^^^^^^^^^^^^^^^^^^^^ help: try using `filter_map` instead: `.filter_map(option_id)`\n    |\n    = note: `-D clippy::map-flatten` implied by `-D warnings`\n \n error: called `map(..).flatten()` on an `Iterator`\n-  --> $DIR/map_flatten.rs:17:46\n+  --> $DIR/map_flatten.rs:18:46\n    |\n LL |     let _: Vec<_> = vec![5_i8; 6].into_iter().map(option_id_ref).flatten().collect();\n    |                                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: try using `filter_map` instead: `.filter_map(option_id_ref)`\n \n error: called `map(..).flatten()` on an `Iterator`\n-  --> $DIR/map_flatten.rs:18:46\n+  --> $DIR/map_flatten.rs:19:46\n    |\n LL |     let _: Vec<_> = vec![5_i8; 6].into_iter().map(option_id_closure).flatten().collect();\n    |                                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: try using `filter_map` instead: `.filter_map(option_id_closure)`\n \n error: called `map(..).flatten()` on an `Iterator`\n-  --> $DIR/map_flatten.rs:19:46\n+  --> $DIR/map_flatten.rs:20:46\n    |\n LL |     let _: Vec<_> = vec![5_i8; 6].into_iter().map(|x| x.checked_add(1)).flatten().collect();\n    |                                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: try using `filter_map` instead: `.filter_map(|x| x.checked_add(1))`\n \n error: called `map(..).flatten()` on an `Iterator`\n-  --> $DIR/map_flatten.rs:22:46\n+  --> $DIR/map_flatten.rs:23:46\n    |\n LL |     let _: Vec<_> = vec![5_i8; 6].into_iter().map(|x| 0..x).flatten().collect();\n    |                                              ^^^^^^^^^^^^^^^^^^^^^^^^ help: try using `flat_map` instead: `.flat_map(|x| 0..x)`\n \n error: called `map(..).flatten()` on an `Option`\n-  --> $DIR/map_flatten.rs:25:39\n+  --> $DIR/map_flatten.rs:26:39\n    |\n LL |     let _: Option<_> = (Some(Some(1))).map(|x| x).flatten();\n    |                                       ^^^^^^^^^^^^^^^^^^^^^ help: try using `and_then` instead: `.and_then(|x| x)`\n \n-error: aborting due to 6 previous errors\n+error: called `map(..).flatten()` on an `Result`\n+  --> $DIR/map_flatten.rs:29:41\n+   |\n+LL |     let _: Result<_, &str> = (Ok(Ok(1))).map(|x| x).flatten();\n+   |                                         ^^^^^^^^^^^^^^^^^^^^^ help: try using `and_then` instead: `.and_then(|x| x)`\n+\n+error: aborting due to 7 previous errors\n "}]}