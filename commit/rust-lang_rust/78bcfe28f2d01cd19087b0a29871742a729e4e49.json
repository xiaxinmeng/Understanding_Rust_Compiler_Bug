{"sha": "78bcfe28f2d01cd19087b0a29871742a729e4e49", "node_id": "MDY6Q29tbWl0NzI0NzEyOjc4YmNmZTI4ZjJkMDFjZDE5MDg3YjBhMjk4NzE3NDJhNzI5ZTRlNDk=", "commit": {"author": {"name": "Patrick Walton", "email": "pcwalton@mimiga.net", "date": "2011-03-18T23:22:59Z"}, "committer": {"name": "Patrick Walton", "email": "pcwalton@mimiga.net", "date": "2011-03-18T23:24:01Z"}, "message": "rustc: Create global variable constants during the collection phase", "tree": {"sha": "7d43f82c401270054d31b46e7a398ca92988bab3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7d43f82c401270054d31b46e7a398ca92988bab3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/78bcfe28f2d01cd19087b0a29871742a729e4e49", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/78bcfe28f2d01cd19087b0a29871742a729e4e49", "html_url": "https://github.com/rust-lang/rust/commit/78bcfe28f2d01cd19087b0a29871742a729e4e49", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/78bcfe28f2d01cd19087b0a29871742a729e4e49/comments", "author": {"login": "pcwalton", "id": 157897, "node_id": "MDQ6VXNlcjE1Nzg5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/157897?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pcwalton", "html_url": "https://github.com/pcwalton", "followers_url": "https://api.github.com/users/pcwalton/followers", "following_url": "https://api.github.com/users/pcwalton/following{/other_user}", "gists_url": "https://api.github.com/users/pcwalton/gists{/gist_id}", "starred_url": "https://api.github.com/users/pcwalton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pcwalton/subscriptions", "organizations_url": "https://api.github.com/users/pcwalton/orgs", "repos_url": "https://api.github.com/users/pcwalton/repos", "events_url": "https://api.github.com/users/pcwalton/events{/privacy}", "received_events_url": "https://api.github.com/users/pcwalton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pcwalton", "id": 157897, "node_id": "MDQ6VXNlcjE1Nzg5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/157897?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pcwalton", "html_url": "https://github.com/pcwalton", "followers_url": "https://api.github.com/users/pcwalton/followers", "following_url": "https://api.github.com/users/pcwalton/following{/other_user}", "gists_url": "https://api.github.com/users/pcwalton/gists{/gist_id}", "starred_url": "https://api.github.com/users/pcwalton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pcwalton/subscriptions", "organizations_url": "https://api.github.com/users/pcwalton/orgs", "repos_url": "https://api.github.com/users/pcwalton/repos", "events_url": "https://api.github.com/users/pcwalton/events{/privacy}", "received_events_url": "https://api.github.com/users/pcwalton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "37cc67fbfe9a7ebb7795f05713f1c08513ea19ba", "url": "https://api.github.com/repos/rust-lang/rust/commits/37cc67fbfe9a7ebb7795f05713f1c08513ea19ba", "html_url": "https://github.com/rust-lang/rust/commit/37cc67fbfe9a7ebb7795f05713f1c08513ea19ba"}], "stats": {"total": 27, "additions": 13, "deletions": 14}, "files": [{"sha": "657af5a18614ec56eaa9c961afc7ce4f9e72c9db", "filename": "src/comp/middle/trans.rs", "status": "modified", "additions": 13, "deletions": 14, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/78bcfe28f2d01cd19087b0a29871742a729e4e49/src%2Fcomp%2Fmiddle%2Ftrans.rs", "raw_url": "https://github.com/rust-lang/rust/raw/78bcfe28f2d01cd19087b0a29871742a729e4e49/src%2Fcomp%2Fmiddle%2Ftrans.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcomp%2Fmiddle%2Ftrans.rs?ref=78bcfe28f2d01cd19087b0a29871742a729e4e49", "patch": "@@ -5277,19 +5277,12 @@ fn trans_const(@crate_ctxt cx, @ast.expr e,\n                &ast.def_id cid, &ast.ann ann) {\n     auto t = node_ann_type(cx, ann);\n     auto v = trans_const_expr(cx, e);\n-    if (ty.type_is_scalar(t)) {\n-        // The scalars come back as 1st class LLVM vals\n-        // which we have to stick into global constants.\n-        auto g = llvm.LLVMAddGlobal(cx.llmod, val_ty(v),\n-                                    _str.buf(cx.names.next(cx.path)));\n-        llvm.LLVMSetInitializer(g, v);\n-        llvm.LLVMSetGlobalConstant(g, True);\n-        llvm.LLVMSetLinkage(g, lib.llvm.LLVMPrivateLinkage\n-                            as llvm.Linkage);\n-        cx.consts.insert(cid, g);\n-    } else {\n-        cx.consts.insert(cid, v);\n-    }\n+\n+    // The scalars come back as 1st class LLVM vals\n+    // which we have to stick into global constants.\n+    auto g = cx.consts.get(cid);\n+    llvm.LLVMSetInitializer(g, v);\n+    llvm.LLVMSetGlobalConstant(g, True);\n }\n \n fn trans_item(@crate_ctxt cx, &ast.item item) {\n@@ -5488,8 +5481,14 @@ fn collect_native_item(&@crate_ctxt cx, @ast.native_item i) -> @crate_ctxt {\n fn collect_item(&@crate_ctxt cx, @ast.item i) -> @crate_ctxt {\n \n     alt (i.node) {\n-        case (ast.item_const(?name, _, _, ?cid, _)) {\n+        case (ast.item_const(?name, _, _, ?cid, ?ann)) {\n+            auto typ = node_ann_type(cx, ann);\n+            auto g = llvm.LLVMAddGlobal(cx.llmod, type_of(cx, typ),\n+                                        _str.buf(cx.names.next(name)));\n+            llvm.LLVMSetLinkage(g, lib.llvm.LLVMPrivateLinkage\n+                                as llvm.Linkage);\n             cx.items.insert(cid, i);\n+            cx.consts.insert(cid, g);\n         }\n \n         case (ast.item_mod(?name, ?m, ?mid)) {"}]}