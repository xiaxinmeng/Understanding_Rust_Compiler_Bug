{"sha": "b7657e9cecaf46128702c5a221c3a84fd6e7cae6", "node_id": "C_kwDOAAsO6NoAKGI3NjU3ZTljZWNhZjQ2MTI4NzAyYzVhMjIxYzNhODRmZDZlN2NhZTY", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-12-27T15:37:48Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-12-27T15:37:48Z"}, "message": "Rollup merge of #106066 - JohnTitor:rm-bindings-after-at-fixme, r=compiler-errors\n\nAlways suggest as `MachineApplicable` in `recover_intersection_pat`\n\nThis resolves one FIXME in `recover_intersection_pat` by always applying `MachineApplicable` when suggesting, as `bindings_after_at` is now stable.\nThis also separates a test to apply `// run-rustfix`.\n\nSigned-off-by: Yuki Okushi <jtitor@2k36.org>", "tree": {"sha": "b8df1df6806743449140c9966f285e3c166d00cd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b8df1df6806743449140c9966f285e3c166d00cd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b7657e9cecaf46128702c5a221c3a84fd6e7cae6", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjqxFMCRBK7hj4Ov3rIwAARU0IAFJsZFYTkZkl3m2QdVFK0Ja4\nDCFN6F6TXvfDKWmHp5vTzKX1NSVfKVoq0BikGhj82Eydo2L9aNg9QZbiB1UHBFfq\nRCx2zI/tN5qfQqRDWmf9ohM9XTfP+WZ3toUOL67B1dmr6ZhMxjEXTEFuJdIAt2v1\ny/ohXDvTXqW8VsGw56HPt3NgTNde2s511S7HWiIJn+SZseUDMWXxrVHh3eHdf3SA\nE7+LLPq67ocWx9Xb5XQDmdN2hEN2+5bBoQhZaDudWM3EEgRbUmzQ8npobFqs8B7f\nCPyVt6TC94n5i4nNFjBO0e0P6hR6qWaBF228WQzNqoFrQaNp2CsnwtKxJOdpbJ0=\n=Ceco\n-----END PGP SIGNATURE-----\n", "payload": "tree b8df1df6806743449140c9966f285e3c166d00cd\nparent d5b975cb7c227b5eec4a83c4651d1225f479c230\nparent 668d9fd7bc5094a5df76adde70d5947cb6705281\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1672155468 +0100\ncommitter GitHub <noreply@github.com> 1672155468 +0100\n\nRollup merge of #106066 - JohnTitor:rm-bindings-after-at-fixme, r=compiler-errors\n\nAlways suggest as `MachineApplicable` in `recover_intersection_pat`\n\nThis resolves one FIXME in `recover_intersection_pat` by always applying `MachineApplicable` when suggesting, as `bindings_after_at` is now stable.\nThis also separates a test to apply `// run-rustfix`.\n\nSigned-off-by: Yuki Okushi <jtitor@2k36.org>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b7657e9cecaf46128702c5a221c3a84fd6e7cae6", "html_url": "https://github.com/rust-lang/rust/commit/b7657e9cecaf46128702c5a221c3a84fd6e7cae6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b7657e9cecaf46128702c5a221c3a84fd6e7cae6/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d5b975cb7c227b5eec4a83c4651d1225f479c230", "url": "https://api.github.com/repos/rust-lang/rust/commits/d5b975cb7c227b5eec4a83c4651d1225f479c230", "html_url": "https://github.com/rust-lang/rust/commit/d5b975cb7c227b5eec4a83c4651d1225f479c230"}, {"sha": "668d9fd7bc5094a5df76adde70d5947cb6705281", "url": "https://api.github.com/repos/rust-lang/rust/commits/668d9fd7bc5094a5df76adde70d5947cb6705281", "html_url": "https://github.com/rust-lang/rust/commit/668d9fd7bc5094a5df76adde70d5947cb6705281"}], "stats": {"total": 116, "additions": 81, "deletions": 35}, "files": [{"sha": "0b057f2f577fe73e85489bf75063576cdf3c5d72", "filename": "compiler/rustc_parse/src/parser/pat.rs", "status": "modified", "additions": 6, "deletions": 12, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/b7657e9cecaf46128702c5a221c3a84fd6e7cae6/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fpat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b7657e9cecaf46128702c5a221c3a84fd6e7cae6/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fpat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fpat.rs?ref=b7657e9cecaf46128702c5a221c3a84fd6e7cae6", "patch": "@@ -491,17 +491,6 @@ impl<'a> Parser<'a> {\n \n         if let PatKind::Ident(_, _, sub @ None) = &mut rhs.kind {\n             // The user inverted the order, so help them fix that.\n-            let mut applicability = Applicability::MachineApplicable;\n-            // FIXME(bindings_after_at): Remove this code when stabilizing the feature.\n-            lhs.walk(&mut |p| match p.kind {\n-                // `check_match` is unhappy if the subpattern has a binding anywhere.\n-                PatKind::Ident(..) => {\n-                    applicability = Applicability::MaybeIncorrect;\n-                    false // Short-circuit.\n-                }\n-                _ => true,\n-            });\n-\n             let lhs_span = lhs.span;\n             // Move the LHS into the RHS as a subpattern.\n             // The RHS is now the full pattern.\n@@ -510,7 +499,12 @@ impl<'a> Parser<'a> {\n             self.struct_span_err(sp, \"pattern on wrong side of `@`\")\n                 .span_label(lhs_span, \"pattern on the left, should be on the right\")\n                 .span_label(rhs.span, \"binding on the right, should be on the left\")\n-                .span_suggestion(sp, \"switch the order\", pprust::pat_to_string(&rhs), applicability)\n+                .span_suggestion(\n+                    sp,\n+                    \"switch the order\",\n+                    pprust::pat_to_string(&rhs),\n+                    Applicability::MachineApplicable,\n+                )\n                 .emit();\n         } else {\n             // The special case above doesn't apply so we may have e.g. `A(x) @ B(y)`."}, {"sha": "44773095b87184bbee39c3acd0f2b293f217f672", "filename": "src/test/ui/parser/intersection-patterns-1.fixed", "status": "added", "additions": 35, "deletions": 0, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/b7657e9cecaf46128702c5a221c3a84fd6e7cae6/src%2Ftest%2Fui%2Fparser%2Fintersection-patterns-1.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/b7657e9cecaf46128702c5a221c3a84fd6e7cae6/src%2Ftest%2Fui%2Fparser%2Fintersection-patterns-1.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fintersection-patterns-1.fixed?ref=b7657e9cecaf46128702c5a221c3a84fd6e7cae6", "patch": "@@ -0,0 +1,35 @@\n+// This tests the parser recovery in `recover_intersection_pat`\n+// and serves as a regression test for the diagnostics issue #65400.\n+//\n+// The general idea is that for `$pat_lhs @ $pat_rhs` where\n+// `$pat_lhs` is not generated by `ref? mut? $ident` we want\n+// to suggest either switching the order or note that intersection\n+// patterns are not allowed.\n+\n+// run-rustfix\n+\n+#![allow(unused_variables)]\n+\n+fn main() {\n+    let s: Option<u8> = None;\n+\n+    match s {\n+        y @ Some(x) => {}\n+        //~^ ERROR pattern on wrong side of `@`\n+        //~| pattern on the left, should be on the right\n+        //~| binding on the right, should be on the left\n+        //~| HELP switch the order\n+        //~| SUGGESTION y @ Some(x)\n+        _ => {}\n+    }\n+\n+    match 2 {\n+        e @ 1..=5 => {}\n+        //~^ ERROR pattern on wrong side of `@`\n+        //~| pattern on the left, should be on the right\n+        //~| binding on the right, should be on the left\n+        //~| HELP switch the order\n+        //~| SUGGESTION e @ 1..=5\n+        _ => {}\n+    }\n+}"}, {"sha": "1036b9daf648a09730ad75aef4be40cb48847f52", "filename": "src/test/ui/parser/intersection-patterns-1.rs", "status": "renamed", "additions": 4, "deletions": 9, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/b7657e9cecaf46128702c5a221c3a84fd6e7cae6/src%2Ftest%2Fui%2Fparser%2Fintersection-patterns-1.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b7657e9cecaf46128702c5a221c3a84fd6e7cae6/src%2Ftest%2Fui%2Fparser%2Fintersection-patterns-1.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fintersection-patterns-1.rs?ref=b7657e9cecaf46128702c5a221c3a84fd6e7cae6", "patch": "@@ -6,6 +6,10 @@\n // to suggest either switching the order or note that intersection\n // patterns are not allowed.\n \n+// run-rustfix\n+\n+#![allow(unused_variables)]\n+\n fn main() {\n     let s: Option<u8> = None;\n \n@@ -19,15 +23,6 @@ fn main() {\n         _ => {}\n     }\n \n-    match s {\n-        Some(x) @ Some(y) => {}\n-        //~^ ERROR left-hand side of `@` must be a binding\n-        //~| interpreted as a pattern, not a binding\n-        //~| also a pattern\n-        //~| NOTE bindings are `x`, `mut x`, `ref x`, and `ref mut x`\n-        _ => {}\n-    }\n-\n     match 2 {\n         1 ..= 5 @ e => {}\n         //~^ ERROR pattern on wrong side of `@`", "previous_filename": "src/test/ui/parser/intersection-patterns.rs"}, {"sha": "dc968656c91ff226f3a301c108bf4699d9f8e9f2", "filename": "src/test/ui/parser/intersection-patterns-1.stderr", "status": "renamed", "additions": 3, "deletions": 14, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/b7657e9cecaf46128702c5a221c3a84fd6e7cae6/src%2Ftest%2Fui%2Fparser%2Fintersection-patterns-1.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/b7657e9cecaf46128702c5a221c3a84fd6e7cae6/src%2Ftest%2Fui%2Fparser%2Fintersection-patterns-1.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fintersection-patterns-1.stderr?ref=b7657e9cecaf46128702c5a221c3a84fd6e7cae6", "patch": "@@ -1,5 +1,5 @@\n error: pattern on wrong side of `@`\n-  --> $DIR/intersection-patterns.rs:13:9\n+  --> $DIR/intersection-patterns-1.rs:17:9\n    |\n LL |         Some(x) @ y => {}\n    |         -------^^^-\n@@ -8,19 +8,8 @@ LL |         Some(x) @ y => {}\n    |         pattern on the left, should be on the right\n    |         help: switch the order: `y @ Some(x)`\n \n-error: left-hand side of `@` must be a binding\n-  --> $DIR/intersection-patterns.rs:23:9\n-   |\n-LL |         Some(x) @ Some(y) => {}\n-   |         -------^^^-------\n-   |         |         |\n-   |         |         also a pattern\n-   |         interpreted as a pattern, not a binding\n-   |\n-   = note: bindings are `x`, `mut x`, `ref x`, and `ref mut x`\n-\n error: pattern on wrong side of `@`\n-  --> $DIR/intersection-patterns.rs:32:9\n+  --> $DIR/intersection-patterns-1.rs:27:9\n    |\n LL |         1 ..= 5 @ e => {}\n    |         -------^^^-\n@@ -29,5 +18,5 @@ LL |         1 ..= 5 @ e => {}\n    |         pattern on the left, should be on the right\n    |         help: switch the order: `e @ 1..=5`\n \n-error: aborting due to 3 previous errors\n+error: aborting due to 2 previous errors\n ", "previous_filename": "src/test/ui/parser/intersection-patterns.stderr"}, {"sha": "408415e87ef983762d9c6ee62e5c1dc8e5535d0f", "filename": "src/test/ui/parser/intersection-patterns-2.rs", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/b7657e9cecaf46128702c5a221c3a84fd6e7cae6/src%2Ftest%2Fui%2Fparser%2Fintersection-patterns-2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b7657e9cecaf46128702c5a221c3a84fd6e7cae6/src%2Ftest%2Fui%2Fparser%2Fintersection-patterns-2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fintersection-patterns-2.rs?ref=b7657e9cecaf46128702c5a221c3a84fd6e7cae6", "patch": "@@ -0,0 +1,20 @@\n+// This tests the parser recovery in `recover_intersection_pat`\n+// and serves as a regression test for the diagnostics issue #65400.\n+//\n+// The general idea is that for `$pat_lhs @ $pat_rhs` where\n+// `$pat_lhs` is not generated by `ref? mut? $ident` we want\n+// to suggest either switching the order or note that intersection\n+// patterns are not allowed.\n+\n+fn main() {\n+    let s: Option<u8> = None;\n+\n+    match s {\n+        Some(x) @ Some(y) => {}\n+        //~^ ERROR left-hand side of `@` must be a binding\n+        //~| interpreted as a pattern, not a binding\n+        //~| also a pattern\n+        //~| NOTE bindings are `x`, `mut x`, `ref x`, and `ref mut x`\n+        _ => {}\n+    }\n+}"}, {"sha": "f7e78814ca57c5f03183b62df02f54f1256eecbc", "filename": "src/test/ui/parser/intersection-patterns-2.stderr", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/b7657e9cecaf46128702c5a221c3a84fd6e7cae6/src%2Ftest%2Fui%2Fparser%2Fintersection-patterns-2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/b7657e9cecaf46128702c5a221c3a84fd6e7cae6/src%2Ftest%2Fui%2Fparser%2Fintersection-patterns-2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fintersection-patterns-2.stderr?ref=b7657e9cecaf46128702c5a221c3a84fd6e7cae6", "patch": "@@ -0,0 +1,13 @@\n+error: left-hand side of `@` must be a binding\n+  --> $DIR/intersection-patterns-2.rs:13:9\n+   |\n+LL |         Some(x) @ Some(y) => {}\n+   |         -------^^^-------\n+   |         |         |\n+   |         |         also a pattern\n+   |         interpreted as a pattern, not a binding\n+   |\n+   = note: bindings are `x`, `mut x`, `ref x`, and `ref mut x`\n+\n+error: aborting due to previous error\n+"}]}