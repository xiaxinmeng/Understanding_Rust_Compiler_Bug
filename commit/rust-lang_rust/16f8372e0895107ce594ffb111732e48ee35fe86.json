{"sha": "16f8372e0895107ce594ffb111732e48ee35fe86", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE2ZjgzNzJlMDg5NTEwN2NlNTk0ZmZiMTExNzMyZTQ4ZWUzNWZlODY=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2016-12-28T17:18:54Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2016-12-28T17:18:54Z"}, "message": "rustbuild: Implement DESTDIR support\n\nThis commit primarily starts supporting the `DESTDIR` environment variable like\nthe old build system. Along the way this brings `config.toml` up to date with\nsupport in `config.mk` with install options supported.\n\nCloses #38441", "tree": {"sha": "a086a9fd20e8e069d3d58444bfa47758835a8ebc", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a086a9fd20e8e069d3d58444bfa47758835a8ebc"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/16f8372e0895107ce594ffb111732e48ee35fe86", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/16f8372e0895107ce594ffb111732e48ee35fe86", "html_url": "https://github.com/rust-lang/rust/commit/16f8372e0895107ce594ffb111732e48ee35fe86", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/16f8372e0895107ce594ffb111732e48ee35fe86/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0807104c8fa90b084748940f7a7980b5a765264e", "url": "https://api.github.com/repos/rust-lang/rust/commits/0807104c8fa90b084748940f7a7980b5a765264e", "html_url": "https://github.com/rust-lang/rust/commit/0807104c8fa90b084748940f7a7980b5a765264e"}], "stats": {"total": 89, "additions": 65, "deletions": 24}, "files": [{"sha": "efc8ae5fe794b63106eb29067eae1bbcaf201fa6", "filename": "src/bootstrap/compile.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/16f8372e0895107ce594ffb111732e48ee35fe86/src%2Fbootstrap%2Fcompile.rs", "raw_url": "https://github.com/rust-lang/rust/raw/16f8372e0895107ce594ffb111732e48ee35fe86/src%2Fbootstrap%2Fcompile.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcompile.rs?ref=16f8372e0895107ce594ffb111732e48ee35fe86", "patch": "@@ -187,7 +187,7 @@ pub fn rustc<'a>(build: &'a Build, target: &str, compiler: &Compiler<'a>) {\n     cargo.env(\"CFG_RELEASE\", &build.release)\n          .env(\"CFG_RELEASE_CHANNEL\", &build.config.channel)\n          .env(\"CFG_VERSION\", &build.version)\n-         .env(\"CFG_PREFIX\", build.config.prefix.clone().unwrap_or(String::new()))\n+         .env(\"CFG_PREFIX\", build.config.prefix.clone().unwrap_or(PathBuf::new()))\n          .env(\"CFG_LIBDIR_RELATIVE\", \"lib\");\n \n     if let Some(ref ver_date) = build.ver_date {"}, {"sha": "337c2ab6b6c56f9f1b790d36561b69c65999bac8", "filename": "src/bootstrap/config.rs", "status": "modified", "additions": 15, "deletions": 9, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/16f8372e0895107ce594ffb111732e48ee35fe86/src%2Fbootstrap%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/16f8372e0895107ce594ffb111732e48ee35fe86/src%2Fbootstrap%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fconfig.rs?ref=16f8372e0895107ce594ffb111732e48ee35fe86", "patch": "@@ -84,10 +84,10 @@ pub struct Config {\n     pub quiet_tests: bool,\n     // Fallback musl-root for all targets\n     pub musl_root: Option<PathBuf>,\n-    pub prefix: Option<String>,\n-    pub docdir: Option<String>,\n-    pub libdir: Option<String>,\n-    pub mandir: Option<String>,\n+    pub prefix: Option<PathBuf>,\n+    pub docdir: Option<PathBuf>,\n+    pub libdir: Option<PathBuf>,\n+    pub mandir: Option<PathBuf>,\n     pub codegen_tests: bool,\n     pub nodejs: Option<PathBuf>,\n     pub gdb: Option<PathBuf>,\n@@ -140,6 +140,9 @@ struct Build {\n #[derive(RustcDecodable, Default, Clone)]\n struct Install {\n     prefix: Option<String>,\n+    mandir: Option<String>,\n+    docdir: Option<String>,\n+    libdir: Option<String>,\n }\n \n /// TOML representation of how the LLVM build is configured.\n@@ -266,7 +269,10 @@ impl Config {\n         set(&mut config.vendor, build.vendor);\n \n         if let Some(ref install) = toml.install {\n-            config.prefix = install.prefix.clone();\n+            config.prefix = install.prefix.clone().map(PathBuf::from);\n+            config.mandir = install.mandir.clone().map(PathBuf::from);\n+            config.docdir = install.docdir.clone().map(PathBuf::from);\n+            config.libdir = install.libdir.clone().map(PathBuf::from);\n         }\n \n         if let Some(ref llvm) = toml.llvm {\n@@ -451,16 +457,16 @@ impl Config {\n                     self.channel = value.to_string();\n                 }\n                 \"CFG_PREFIX\" => {\n-                    self.prefix = Some(value.to_string());\n+                    self.prefix = Some(PathBuf::from(value));\n                 }\n                 \"CFG_DOCDIR\" => {\n-                    self.docdir = Some(value.to_string());\n+                    self.docdir = Some(PathBuf::from(value));\n                 }\n                 \"CFG_LIBDIR\" => {\n-                    self.libdir = Some(value.to_string());\n+                    self.libdir = Some(PathBuf::from(value));\n                 }\n                 \"CFG_MANDIR\" => {\n-                    self.mandir = Some(value.to_string());\n+                    self.mandir = Some(PathBuf::from(value));\n                 }\n                 \"CFG_LLVM_ROOT\" if value.len() > 0 => {\n                     let target = self.target_config.entry(self.build.clone())"}, {"sha": "813517f977648f8ed79465e3efa652bf4bfe2ce7", "filename": "src/bootstrap/config.toml.example", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/16f8372e0895107ce594ffb111732e48ee35fe86/src%2Fbootstrap%2Fconfig.toml.example", "raw_url": "https://github.com/rust-lang/rust/raw/16f8372e0895107ce594ffb111732e48ee35fe86/src%2Fbootstrap%2Fconfig.toml.example", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fconfig.toml.example?ref=16f8372e0895107ce594ffb111732e48ee35fe86", "patch": "@@ -106,7 +106,16 @@\n [install]\n \n # Instead of installing to /usr/local, install to this path instead.\n-#prefix = \"/path/to/install\"\n+#prefix = \"/usr/local\"\n+\n+# Where to install libraries in `prefix` above\n+#libdir = \"lib\"\n+\n+# Where to install man pages in `prefix` above\n+#mandir = \"share/man\"\n+\n+# Where to install documentation in `prefix` above\n+#docdir = \"share/doc/rust\"\n \n # =============================================================================\n # Options for compiling Rust code itself"}, {"sha": "efc460f35838c3c4bc1e6e5ec4b6072700bcb249", "filename": "src/bootstrap/install.rs", "status": "modified", "additions": 39, "deletions": 13, "changes": 52, "blob_url": "https://github.com/rust-lang/rust/blob/16f8372e0895107ce594ffb111732e48ee35fe86/src%2Fbootstrap%2Finstall.rs", "raw_url": "https://github.com/rust-lang/rust/raw/16f8372e0895107ce594ffb111732e48ee35fe86/src%2Fbootstrap%2Finstall.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Finstall.rs?ref=16f8372e0895107ce594ffb111732e48ee35fe86", "patch": "@@ -13,33 +13,45 @@\n //! This module is responsible for installing the standard library,\n //! compiler, and documentation.\n \n+use std::env;\n use std::fs;\n-use std::borrow::Cow;\n-use std::path::Path;\n+use std::path::{Path, PathBuf, Component};\n use std::process::Command;\n \n use Build;\n use dist::{package_vers, sanitize_sh, tmpdir};\n \n /// Installs everything.\n pub fn install(build: &Build, stage: u32, host: &str) {\n-    let prefix = build.config.prefix.as_ref().clone().map(|x| Path::new(x))\n-        .unwrap_or(Path::new(\"/usr/local\"));\n-    let docdir = build.config.docdir.as_ref().clone().map(|x| Cow::Borrowed(Path::new(x)))\n-        .unwrap_or(Cow::Owned(prefix.join(\"share/doc/rust\")));\n-    let libdir = build.config.libdir.as_ref().clone().map(|x| Cow::Borrowed(Path::new(x)))\n-        .unwrap_or(Cow::Owned(prefix.join(\"lib\")));\n-    let mandir = build.config.mandir.as_ref().clone().map(|x| Cow::Borrowed(Path::new(x)))\n-        .unwrap_or(Cow::Owned(prefix.join(\"share/man\")));\n+    let prefix_default = PathBuf::from(\"/usr/local\");\n+    let docdir_default = PathBuf::from(\"share/doc/rust\");\n+    let mandir_default = PathBuf::from(\"share/man\");\n+    let libdir_default = PathBuf::from(\"lib\");\n+    let prefix = build.config.prefix.as_ref().unwrap_or(&prefix_default);\n+    let docdir = build.config.docdir.as_ref().unwrap_or(&docdir_default);\n+    let libdir = build.config.libdir.as_ref().unwrap_or(&libdir_default);\n+    let mandir = build.config.mandir.as_ref().unwrap_or(&mandir_default);\n+\n+    let docdir = prefix.join(docdir);\n+    let libdir = prefix.join(libdir);\n+    let mandir = prefix.join(mandir);\n+\n+    let destdir = env::var_os(\"DESTDIR\").map(PathBuf::from);\n+\n+    let prefix = add_destdir(&prefix, &destdir);\n+    let docdir = add_destdir(&docdir, &destdir);\n+    let libdir = add_destdir(&libdir, &destdir);\n+    let mandir = add_destdir(&mandir, &destdir);\n+\n     let empty_dir = build.out.join(\"tmp/empty_dir\");\n     t!(fs::create_dir_all(&empty_dir));\n     if build.config.docs {\n-        install_sh(&build, \"docs\", \"rust-docs\", stage, host, prefix,\n+        install_sh(&build, \"docs\", \"rust-docs\", stage, host, &prefix,\n                    &docdir, &libdir, &mandir, &empty_dir);\n     }\n-    install_sh(&build, \"std\", \"rust-std\", stage, host, prefix,\n+    install_sh(&build, \"std\", \"rust-std\", stage, host, &prefix,\n                &docdir, &libdir, &mandir, &empty_dir);\n-    install_sh(&build, \"rustc\", \"rustc\", stage, host, prefix,\n+    install_sh(&build, \"rustc\", \"rustc\", stage, host, &prefix,\n                &docdir, &libdir, &mandir, &empty_dir);\n     t!(fs::remove_dir_all(&empty_dir));\n }\n@@ -59,3 +71,17 @@ fn install_sh(build: &Build, package: &str, name: &str, stage: u32, host: &str,\n        .arg(\"--disable-ldconfig\");\n     build.run(&mut cmd);\n }\n+\n+fn add_destdir(path: &Path, destdir: &Option<PathBuf>) -> PathBuf {\n+    let mut ret = match *destdir {\n+        Some(ref dest) => dest.clone(),\n+        None => return path.to_path_buf(),\n+    };\n+    for part in path.components() {\n+        match part {\n+            Component::Normal(s) => ret.push(s),\n+            _ => {}\n+        }\n+    }\n+    return ret\n+}"}]}