{"sha": "68694919744709385e168f5812b73e28c513b5d6", "node_id": "C_kwDOAAsO6NoAKDY4Njk0OTE5NzQ0NzA5Mzg1ZTE2OGY1ODEyYjczZTI4YzUxM2I1ZDY", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-04-25T13:22:41Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-04-25T13:22:41Z"}, "message": "Auto merge of #12075 - jonas-schievink:less-aggressive-quickfixes, r=jonas-schievink\n\nfix: Don't emit a quickfix for placeholder suggestions from rustc/clippy\n\nFixes https://github.com/rust-lang/rust-analyzer/issues/12069", "tree": {"sha": "4185b3b15fa4cf8d34398a516ed82997874e7a32", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4185b3b15fa4cf8d34398a516ed82997874e7a32"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/68694919744709385e168f5812b73e28c513b5d6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/68694919744709385e168f5812b73e28c513b5d6", "html_url": "https://github.com/rust-lang/rust/commit/68694919744709385e168f5812b73e28c513b5d6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/68694919744709385e168f5812b73e28c513b5d6/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "60c4f072eb6dd0de3b551341a391758c7cd3a272", "url": "https://api.github.com/repos/rust-lang/rust/commits/60c4f072eb6dd0de3b551341a391758c7cd3a272", "html_url": "https://github.com/rust-lang/rust/commit/60c4f072eb6dd0de3b551341a391758c7cd3a272"}, {"sha": "36342b4b29dedde44b9aee6362ad5324e6282221", "url": "https://api.github.com/repos/rust-lang/rust/commits/36342b4b29dedde44b9aee6362ad5324e6282221", "html_url": "https://github.com/rust-lang/rust/commit/36342b4b29dedde44b9aee6362ad5324e6282221"}], "stats": {"total": 80, "additions": 13, "deletions": 67}, "files": [{"sha": "c3b540e31f77f9857544a1e71326519fc6cd1653", "filename": "crates/rust-analyzer/src/diagnostics/test_data/clippy_pass_by_ref.txt", "status": "modified", "additions": 1, "deletions": 65, "changes": 66, "blob_url": "https://github.com/rust-lang/rust/blob/68694919744709385e168f5812b73e28c513b5d6/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Ftest_data%2Fclippy_pass_by_ref.txt", "raw_url": "https://github.com/rust-lang/rust/raw/68694919744709385e168f5812b73e28c513b5d6/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Ftest_data%2Fclippy_pass_by_ref.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Ftest_data%2Fclippy_pass_by_ref.txt?ref=68694919744709385e168f5812b73e28c513b5d6", "patch": "@@ -296,70 +296,6 @@\n             tags: None,\n             data: None,\n         },\n-        fix: Some(\n-            Fix {\n-                ranges: [\n-                    Range {\n-                        start: Position {\n-                            line: 41,\n-                            character: 23,\n-                        },\n-                        end: Position {\n-                            line: 41,\n-                            character: 28,\n-                        },\n-                    },\n-                ],\n-                action: CodeAction {\n-                    title: \"consider passing by value instead: `self`\",\n-                    group: None,\n-                    kind: Some(\n-                        CodeActionKind(\n-                            \"quickfix\",\n-                        ),\n-                    ),\n-                    command: None,\n-                    edit: Some(\n-                        SnippetWorkspaceEdit {\n-                            changes: Some(\n-                                {\n-                                    Url {\n-                                        scheme: \"file\",\n-                                        cannot_be_a_base: false,\n-                                        username: \"\",\n-                                        password: None,\n-                                        host: None,\n-                                        port: None,\n-                                        path: \"/test/compiler/mir/tagset.rs\",\n-                                        query: None,\n-                                        fragment: None,\n-                                    }: [\n-                                        TextEdit {\n-                                            range: Range {\n-                                                start: Position {\n-                                                    line: 41,\n-                                                    character: 23,\n-                                                },\n-                                                end: Position {\n-                                                    line: 41,\n-                                                    character: 28,\n-                                                },\n-                                            },\n-                                            new_text: \"self\",\n-                                        },\n-                                    ],\n-                                },\n-                            ),\n-                            document_changes: None,\n-                            change_annotations: None,\n-                        },\n-                    ),\n-                    is_preferred: Some(\n-                        true,\n-                    ),\n-                    data: None,\n-                },\n-            },\n-        ),\n+        fix: None,\n     },\n ]"}, {"sha": "4b7805565662aceedcae263abdaff37eb0f803b8", "filename": "crates/rust-analyzer/src/diagnostics/to_proto.rs", "status": "modified", "additions": 12, "deletions": 2, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/68694919744709385e168f5812b73e28c513b5d6/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Fto_proto.rs", "raw_url": "https://github.com/rust-lang/rust/raw/68694919744709385e168f5812b73e28c513b5d6/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Fto_proto.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Fto_proto.rs?ref=68694919744709385e168f5812b73e28c513b5d6", "patch": "@@ -2,7 +2,7 @@\n //! `cargo check` json format to the LSP diagnostic format.\n use std::collections::HashMap;\n \n-use flycheck::{DiagnosticLevel, DiagnosticSpan};\n+use flycheck::{Applicability, DiagnosticLevel, DiagnosticSpan};\n use itertools::Itertools;\n use stdx::format_to;\n use vfs::{AbsPath, AbsPathBuf};\n@@ -159,7 +159,17 @@ fn map_rust_child_diagnostic(\n             }\n             let location = location(config, workspace_root, span);\n             let edit = lsp_types::TextEdit::new(location.range, suggested_replacement.clone());\n-            edit_map.entry(location.uri).or_default().push(edit);\n+\n+            // Only actually emit a quickfix if the suggestion is \"valid enough\".\n+            // We accept both \"MaybeIncorrect\" and \"MachineApplicable\". \"MaybeIncorrect\" means that\n+            // the suggestion is *complete* (contains no placeholders where code needs to be\n+            // inserted), but might not be what the user wants, or might need minor adjustments.\n+            if matches!(\n+                span.suggestion_applicability,\n+                None | Some(Applicability::MaybeIncorrect | Applicability::MachineApplicable)\n+            ) {\n+                edit_map.entry(location.uri).or_default().push(edit);\n+            }\n         }\n     }\n "}]}