{"sha": "16958569af5c3dca9d1a46b0485254e2c095f022", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE2OTU4NTY5YWY1YzNkY2E5ZDFhNDZiMDQ4NTI1NGUyYzA5NWYwMjI=", "commit": {"author": {"name": "varkor", "email": "github@varkor.com", "date": "2018-08-21T00:39:48Z"}, "committer": {"name": "varkor", "email": "github@varkor.com", "date": "2018-08-21T00:39:48Z"}, "message": "Iterate through all crates in stability.rs rather than lib_features.rs", "tree": {"sha": "a6dd4df818fce3120f6a5849ad752f9e4ed1261a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a6dd4df818fce3120f6a5849ad752f9e4ed1261a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/16958569af5c3dca9d1a46b0485254e2c095f022", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/16958569af5c3dca9d1a46b0485254e2c095f022", "html_url": "https://github.com/rust-lang/rust/commit/16958569af5c3dca9d1a46b0485254e2c095f022", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/16958569af5c3dca9d1a46b0485254e2c095f022/comments", "author": {"login": "varkor", "id": 3943692, "node_id": "MDQ6VXNlcjM5NDM2OTI=", "avatar_url": "https://avatars.githubusercontent.com/u/3943692?v=4", "gravatar_id": "", "url": "https://api.github.com/users/varkor", "html_url": "https://github.com/varkor", "followers_url": "https://api.github.com/users/varkor/followers", "following_url": "https://api.github.com/users/varkor/following{/other_user}", "gists_url": "https://api.github.com/users/varkor/gists{/gist_id}", "starred_url": "https://api.github.com/users/varkor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/varkor/subscriptions", "organizations_url": "https://api.github.com/users/varkor/orgs", "repos_url": "https://api.github.com/users/varkor/repos", "events_url": "https://api.github.com/users/varkor/events{/privacy}", "received_events_url": "https://api.github.com/users/varkor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "varkor", "id": 3943692, "node_id": "MDQ6VXNlcjM5NDM2OTI=", "avatar_url": "https://avatars.githubusercontent.com/u/3943692?v=4", "gravatar_id": "", "url": "https://api.github.com/users/varkor", "html_url": "https://github.com/varkor", "followers_url": "https://api.github.com/users/varkor/followers", "following_url": "https://api.github.com/users/varkor/following{/other_user}", "gists_url": "https://api.github.com/users/varkor/gists{/gist_id}", "starred_url": "https://api.github.com/users/varkor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/varkor/subscriptions", "organizations_url": "https://api.github.com/users/varkor/orgs", "repos_url": "https://api.github.com/users/varkor/repos", "events_url": "https://api.github.com/users/varkor/events{/privacy}", "received_events_url": "https://api.github.com/users/varkor/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d06fa3a46f8e6c938f51718ed964007a81d12a7d", "url": "https://api.github.com/repos/rust-lang/rust/commits/d06fa3a46f8e6c938f51718ed964007a81d12a7d", "html_url": "https://github.com/rust-lang/rust/commit/d06fa3a46f8e6c938f51718ed964007a81d12a7d"}], "stats": {"total": 39, "additions": 27, "deletions": 12}, "files": [{"sha": "ec618de677318a613953bb3283ad4a7a9a35164d", "filename": "src/librustc/middle/lib_features.rs", "status": "modified", "additions": 1, "deletions": 6, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/16958569af5c3dca9d1a46b0485254e2c095f022/src%2Flibrustc%2Fmiddle%2Flib_features.rs", "raw_url": "https://github.com/rust-lang/rust/raw/16958569af5c3dca9d1a46b0485254e2c095f022/src%2Flibrustc%2Fmiddle%2Flib_features.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Flib_features.rs?ref=16958569af5c3dca9d1a46b0485254e2c095f022", "patch": "@@ -17,7 +17,7 @@\n use ty::TyCtxt;\n use syntax::symbol::Symbol;\n use syntax::ast::{Attribute, MetaItem, MetaItemKind};\n-use syntax_pos::{Span, DUMMY_SP};\n+use syntax_pos::Span;\n use hir::intravisit::{self, NestedVisitorMap, Visitor};\n use rustc_data_structures::fx::{FxHashSet, FxHashMap};\n use errors::DiagnosticId;\n@@ -152,11 +152,6 @@ impl<'a, 'tcx> Visitor<'tcx> for LibFeatureCollector<'a, 'tcx> {\n \n pub fn collect<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>) -> LibFeatures {\n     let mut collector = LibFeatureCollector::new(tcx);\n-    for &cnum in tcx.crates().iter() {\n-        for &(feature, since) in tcx.defined_lib_features(cnum).iter() {\n-            collector.collect_feature(feature, since, DUMMY_SP);\n-        }\n-    }\n     intravisit::walk_crate(&mut collector, tcx.hir.krate());\n     collector.lib_features\n }"}, {"sha": "c9e521f1f203df86dd80ea52e49a17ec2e170a63", "filename": "src/librustc/middle/stability.rs", "status": "modified", "additions": 26, "deletions": 6, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/16958569af5c3dca9d1a46b0485254e2c095f022/src%2Flibrustc%2Fmiddle%2Fstability.rs", "raw_url": "https://github.com/rust-lang/rust/raw/16958569af5c3dca9d1a46b0485254e2c095f022/src%2Flibrustc%2Fmiddle%2Fstability.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fstability.rs?ref=16958569af5c3dca9d1a46b0485254e2c095f022", "patch": "@@ -846,14 +846,34 @@ pub fn check_unused_or_stable_features<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>) {\n     remaining_lib_features.remove(&Symbol::intern(\"libc\"));\n     remaining_lib_features.remove(&Symbol::intern(\"test\"));\n \n-    for (feature, stable) in tcx.lib_features().to_vec() {\n-        if let Some(since) = stable {\n-            if let Some(span) = remaining_lib_features.get(&feature) {\n-                // Warn if the user has enabled an already-stable lib feature.\n-                unnecessary_stable_feature_lint(tcx, *span, feature, since);\n+    let check_features =\n+        |remaining_lib_features: &mut FxHashMap<_, _>, defined_features: &Vec<_>| {\n+            for &(feature, since) in defined_features {\n+                if let Some(since) = since {\n+                    if let Some(span) = remaining_lib_features.get(&feature) {\n+                        // Warn if the user has enabled an already-stable lib feature.\n+                        unnecessary_stable_feature_lint(tcx, *span, feature, since);\n+                    }\n+                }\n+                remaining_lib_features.remove(&feature);\n+                if remaining_lib_features.is_empty() {\n+                    break;\n+                }\n+            }\n+        };\n+\n+    // We always collect the lib features declared in the current crate, even if there are\n+    // no unknown features, because the collection also does feature attribute validation.\n+    let local_defined_features = tcx.lib_features().to_vec();\n+    if !remaining_lib_features.is_empty() {\n+        check_features(&mut remaining_lib_features, &local_defined_features);\n+\n+        for &cnum in &*tcx.crates() {\n+            if remaining_lib_features.is_empty() {\n+                break;\n             }\n+            check_features(&mut remaining_lib_features, &tcx.defined_lib_features(cnum));\n         }\n-        remaining_lib_features.remove(&feature);\n     }\n \n     for (feature, span) in remaining_lib_features {"}]}