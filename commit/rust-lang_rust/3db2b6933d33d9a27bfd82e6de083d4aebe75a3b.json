{"sha": "3db2b6933d33d9a27bfd82e6de083d4aebe75a3b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjNkYjJiNjkzM2QzM2Q5YTI3YmZkODJlNmRlMDgzZDRhZWJlNzVhM2I=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-04-19T17:56:25Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-04-19T17:56:25Z"}, "message": "auto merge of #13628 : alexcrichton/rust/issue-13625, r=thestinger\n\nIn upgrading LLVM, only rust functions had the \"split-stack\" attribute added.\r\nThis commit changes the addition of LLVM's \"split-stack\" attribute to *always*\r\noccur and then we remove it sometimes if the \"no_split_stack\" rust attribute is\r\npresent.\r\n\r\nCloses #13625", "tree": {"sha": "85677a3099045450ce4ff4ffe35f0ceef068813d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/85677a3099045450ce4ff4ffe35f0ceef068813d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3db2b6933d33d9a27bfd82e6de083d4aebe75a3b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3db2b6933d33d9a27bfd82e6de083d4aebe75a3b", "html_url": "https://github.com/rust-lang/rust/commit/3db2b6933d33d9a27bfd82e6de083d4aebe75a3b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3db2b6933d33d9a27bfd82e6de083d4aebe75a3b/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ba25fecfeffdbc96d31172f483bd20cffa635b3e", "url": "https://api.github.com/repos/rust-lang/rust/commits/ba25fecfeffdbc96d31172f483bd20cffa635b3e", "html_url": "https://github.com/rust-lang/rust/commit/ba25fecfeffdbc96d31172f483bd20cffa635b3e"}, {"sha": "50fb57bb107b302f7d164e22aa75c8c2a2d48756", "url": "https://api.github.com/repos/rust-lang/rust/commits/50fb57bb107b302f7d164e22aa75c8c2a2d48756", "html_url": "https://github.com/rust-lang/rust/commit/50fb57bb107b302f7d164e22aa75c8c2a2d48756"}], "stats": {"total": 24, "additions": 22, "deletions": 2}, "files": [{"sha": "9e652536f6d21907680181c96fc0cf1baae7a06d", "filename": "src/librustc/lib/llvm.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/3db2b6933d33d9a27bfd82e6de083d4aebe75a3b/src%2Flibrustc%2Flib%2Fllvm.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3db2b6933d33d9a27bfd82e6de083d4aebe75a3b/src%2Flibrustc%2Flib%2Fllvm.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Flib%2Fllvm.rs?ref=3db2b6933d33d9a27bfd82e6de083d4aebe75a3b", "patch": "@@ -709,6 +709,7 @@ pub mod llvm {\n         pub fn LLVMSetGC(Fn: ValueRef, Name: *c_char);\n         pub fn LLVMAddFunctionAttr(Fn: ValueRef, PA: c_uint);\n         pub fn LLVMAddFunctionAttrString(Fn: ValueRef, Name: *c_char);\n+        pub fn LLVMRemoveFunctionAttrString(Fn: ValueRef, Name: *c_char);\n         pub fn LLVMGetFunctionAttr(Fn: ValueRef) -> c_ulonglong;\n \n         pub fn LLVMAddReturnAttribute(Fn: ValueRef, PA: c_uint);"}, {"sha": "735b60622ed62572f3e4c4eb18556469c535dafa", "filename": "src/librustc/middle/trans/base.rs", "status": "modified", "additions": 9, "deletions": 2, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/3db2b6933d33d9a27bfd82e6de083d4aebe75a3b/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3db2b6933d33d9a27bfd82e6de083d4aebe75a3b/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs?ref=3db2b6933d33d9a27bfd82e6de083d4aebe75a3b", "patch": "@@ -199,6 +199,7 @@ fn decl_fn(llmod: ModuleRef, name: &str, cc: lib::llvm::CallConv,\n     lib::llvm::SetFunctionCallConv(llfn, cc);\n     // Function addresses in Rust are never significant, allowing functions to be merged.\n     lib::llvm::SetUnnamedAddr(llfn, true);\n+    set_split_stack(llfn);\n \n     llfn\n }\n@@ -445,8 +446,8 @@ pub fn set_llvm_fn_attrs(attrs: &[ast::Attribute], llfn: ValueRef) {\n     }\n \n     // Add the no-split-stack attribute if requested\n-    if !contains_name(attrs, \"no_split_stack\") {\n-        set_split_stack(llfn);\n+    if contains_name(attrs, \"no_split_stack\") {\n+        unset_split_stack(llfn);\n     }\n \n     if contains_name(attrs, \"cold\") {\n@@ -464,6 +465,12 @@ pub fn set_split_stack(f: ValueRef) {\n     })\n }\n \n+pub fn unset_split_stack(f: ValueRef) {\n+    \"split-stack\".with_c_str(|buf| {\n+        unsafe { llvm::LLVMRemoveFunctionAttrString(f, buf); }\n+    })\n+}\n+\n // Double-check that we never ask LLVM to declare the same symbol twice. It\n // silently mangles such symbols, breaking our linkage model.\n pub fn note_unique_llvm_symbol(ccx: &CrateContext, sym: ~str) {"}, {"sha": "3fe1b1380da01498eedcbeda9fbf8db3628d82b4", "filename": "src/rustllvm/RustWrapper.cpp", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/3db2b6933d33d9a27bfd82e6de083d4aebe75a3b/src%2Frustllvm%2FRustWrapper.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/3db2b6933d33d9a27bfd82e6de083d4aebe75a3b/src%2Frustllvm%2FRustWrapper.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustllvm%2FRustWrapper.cpp?ref=3db2b6933d33d9a27bfd82e6de083d4aebe75a3b", "patch": "@@ -77,6 +77,18 @@ extern \"C\" void LLVMAddFunctionAttrString(LLVMValueRef fn, const char *Name) {\n   unwrap<Function>(fn)->addFnAttr(Name);\n }\n \n+extern \"C\" void LLVMRemoveFunctionAttrString(LLVMValueRef fn, const char *Name) {\n+  Function *f = unwrap<Function>(fn);\n+  LLVMContext &C = f->getContext();\n+  AttrBuilder B;\n+  B.addAttribute(Name);\n+  AttributeSet to_remove = AttributeSet::get(C, AttributeSet::FunctionIndex, B);\n+\n+  AttributeSet attrs = f->getAttributes();\n+  f->setAttributes(attrs.removeAttributes(f->getContext(),\n+                                          AttributeSet::FunctionIndex,\n+                                          to_remove));\n+}\n \n extern \"C\" void LLVMAddReturnAttribute(LLVMValueRef Fn, LLVMAttribute PA) {\n   Function *A = unwrap<Function>(Fn);"}]}