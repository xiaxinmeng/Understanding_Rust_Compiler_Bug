{"sha": "fadb9cc521da4f6010d80af5f750e8d9011c8f1c", "node_id": "C_kwDOAAsO6NoAKGZhZGI5Y2M1MjFkYTRmNjAxMGQ4MGFmNWY3NTBlOGQ5MDExYzhmMWM", "commit": {"author": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2021-10-31T00:00:00Z"}, "committer": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2021-10-31T17:33:29Z"}, "message": "Test that promotion follows references when looking for drop\n\nNoticed that this wasn't covered by any of existing tests.\n\nThe const checking and const qualification, which currently shares the\nimplementation with promotion, will likely need a different behaviour\nhere (see issue #90193).", "tree": {"sha": "eb541ffba89a830c54564e8397f516363eabb1a8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/eb541ffba89a830c54564e8397f516363eabb1a8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fadb9cc521da4f6010d80af5f750e8d9011c8f1c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fadb9cc521da4f6010d80af5f750e8d9011c8f1c", "html_url": "https://github.com/rust-lang/rust/commit/fadb9cc521da4f6010d80af5f750e8d9011c8f1c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fadb9cc521da4f6010d80af5f750e8d9011c8f1c/comments", "author": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "38b01d90657a355abf81b53cb3ee0b9a7dd88f98", "url": "https://api.github.com/repos/rust-lang/rust/commits/38b01d90657a355abf81b53cb3ee0b9a7dd88f98", "html_url": "https://github.com/rust-lang/rust/commit/38b01d90657a355abf81b53cb3ee0b9a7dd88f98"}], "stats": {"total": 109, "additions": 100, "deletions": 9}, "files": [{"sha": "6830b23cfa345eeb6ea83e49e8a156f107aaee53", "filename": "src/test/ui/consts/promote-not.rs", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/fadb9cc521da4f6010d80af5f750e8d9011c8f1c/src%2Ftest%2Fui%2Fconsts%2Fpromote-not.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fadb9cc521da4f6010d80af5f750e8d9011c8f1c/src%2Ftest%2Fui%2Fconsts%2Fpromote-not.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fpromote-not.rs?ref=fadb9cc521da4f6010d80af5f750e8d9011c8f1c", "patch": "@@ -39,6 +39,8 @@ const TEST_INTERIOR_MUT: () = {\n     let _val: &'static _ = &(Cell::new(1), 2).1; //~ ERROR temporary value dropped while borrowed\n };\n \n+const TEST_DROP: String = String::new();\n+\n fn main() {\n     // We must not promote things with interior mutability. Not even if we \"project it away\".\n     let _val: &'static _ = &(Cell::new(1), 2).0; //~ ERROR temporary value dropped while borrowed\n@@ -50,4 +52,17 @@ fn main() {\n     let _val: &'static _ = &(1%0); //~ ERROR temporary value dropped while borrowed\n     let _val: &'static _ = &(1%(1-1)); //~ ERROR temporary value dropped while borrowed\n     let _val: &'static _ = &([1,2,3][4]+1); //~ ERROR temporary value dropped while borrowed\n+\n+    // No promotion of temporaries that need to be dropped.\n+    let _val: &'static _ = &TEST_DROP;\n+    //~^ ERROR temporary value dropped while borrowed\n+    let _val: &'static _ = &&TEST_DROP;\n+    //~^ ERROR temporary value dropped while borrowed\n+    //~| ERROR temporary value dropped while borrowed\n+    let _val: &'static _ = &(&TEST_DROP,);\n+    //~^ ERROR temporary value dropped while borrowed\n+    //~| ERROR temporary value dropped while borrowed\n+    let _val: &'static _ = &[&TEST_DROP; 1];\n+    //~^ ERROR temporary value dropped while borrowed\n+    //~| ERROR temporary value dropped while borrowed\n }"}, {"sha": "0d0b0f9c689b5b6593d007015efb60d00f71fba3", "filename": "src/test/ui/consts/promote-not.stderr", "status": "modified", "additions": 85, "deletions": 9, "changes": 94, "blob_url": "https://github.com/rust-lang/rust/blob/fadb9cc521da4f6010d80af5f750e8d9011c8f1c/src%2Ftest%2Fui%2Fconsts%2Fpromote-not.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/fadb9cc521da4f6010d80af5f750e8d9011c8f1c/src%2Ftest%2Fui%2Fconsts%2Fpromote-not.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fpromote-not.stderr?ref=fadb9cc521da4f6010d80af5f750e8d9011c8f1c", "patch": "@@ -59,7 +59,7 @@ LL | };\n    | - temporary value is freed at the end of this statement\n \n error[E0716]: temporary value dropped while borrowed\n-  --> $DIR/promote-not.rs:44:29\n+  --> $DIR/promote-not.rs:46:29\n    |\n LL |     let _val: &'static _ = &(Cell::new(1), 2).0;\n    |               ----------    ^^^^^^^^^^^^^^^^^ creates a temporary which is freed while still in use\n@@ -70,7 +70,7 @@ LL | }\n    | - temporary value is freed at the end of this statement\n \n error[E0716]: temporary value dropped while borrowed\n-  --> $DIR/promote-not.rs:45:29\n+  --> $DIR/promote-not.rs:47:29\n    |\n LL |     let _val: &'static _ = &(Cell::new(1), 2).1;\n    |               ----------    ^^^^^^^^^^^^^^^^^ creates a temporary which is freed while still in use\n@@ -81,7 +81,7 @@ LL | }\n    | - temporary value is freed at the end of this statement\n \n error[E0716]: temporary value dropped while borrowed\n-  --> $DIR/promote-not.rs:48:29\n+  --> $DIR/promote-not.rs:50:29\n    |\n LL |     let _val: &'static _ = &(1/0);\n    |               ----------    ^^^^^ creates a temporary which is freed while still in use\n@@ -92,7 +92,7 @@ LL | }\n    | - temporary value is freed at the end of this statement\n \n error[E0716]: temporary value dropped while borrowed\n-  --> $DIR/promote-not.rs:49:29\n+  --> $DIR/promote-not.rs:51:29\n    |\n LL |     let _val: &'static _ = &(1/(1-1));\n    |               ----------    ^^^^^^^^^ creates a temporary which is freed while still in use\n@@ -103,7 +103,7 @@ LL | }\n    | - temporary value is freed at the end of this statement\n \n error[E0716]: temporary value dropped while borrowed\n-  --> $DIR/promote-not.rs:50:29\n+  --> $DIR/promote-not.rs:52:29\n    |\n LL |     let _val: &'static _ = &(1%0);\n    |               ----------    ^^^^^ creates a temporary which is freed while still in use\n@@ -114,26 +114,102 @@ LL | }\n    | - temporary value is freed at the end of this statement\n \n error[E0716]: temporary value dropped while borrowed\n-  --> $DIR/promote-not.rs:51:29\n+  --> $DIR/promote-not.rs:53:29\n    |\n LL |     let _val: &'static _ = &(1%(1-1));\n    |               ----------    ^^^^^^^^^ creates a temporary which is freed while still in use\n    |               |\n    |               type annotation requires that borrow lasts for `'static`\n-LL |     let _val: &'static _ = &([1,2,3][4]+1);\n+...\n LL | }\n    | - temporary value is freed at the end of this statement\n \n error[E0716]: temporary value dropped while borrowed\n-  --> $DIR/promote-not.rs:52:29\n+  --> $DIR/promote-not.rs:54:29\n    |\n LL |     let _val: &'static _ = &([1,2,3][4]+1);\n    |               ----------    ^^^^^^^^^^^^^^ creates a temporary which is freed while still in use\n    |               |\n    |               type annotation requires that borrow lasts for `'static`\n+...\n+LL | }\n+   | - temporary value is freed at the end of this statement\n+\n+error[E0716]: temporary value dropped while borrowed\n+  --> $DIR/promote-not.rs:57:29\n+   |\n+LL |     let _val: &'static _ = &TEST_DROP;\n+   |               ----------    ^^^^^^^^^ creates a temporary which is freed while still in use\n+   |               |\n+   |               type annotation requires that borrow lasts for `'static`\n+...\n+LL | }\n+   | - temporary value is freed at the end of this statement\n+\n+error[E0716]: temporary value dropped while borrowed\n+  --> $DIR/promote-not.rs:59:29\n+   |\n+LL |     let _val: &'static _ = &&TEST_DROP;\n+   |               ----------    ^^^^^^^^^^ creates a temporary which is freed while still in use\n+   |               |\n+   |               type annotation requires that borrow lasts for `'static`\n+...\n+LL | }\n+   | - temporary value is freed at the end of this statement\n+\n+error[E0716]: temporary value dropped while borrowed\n+  --> $DIR/promote-not.rs:59:30\n+   |\n+LL |     let _val: &'static _ = &&TEST_DROP;\n+   |               ----------     ^^^^^^^^^ creates a temporary which is freed while still in use\n+   |               |\n+   |               type annotation requires that borrow lasts for `'static`\n+...\n+LL | }\n+   | - temporary value is freed at the end of this statement\n+\n+error[E0716]: temporary value dropped while borrowed\n+  --> $DIR/promote-not.rs:62:29\n+   |\n+LL |     let _val: &'static _ = &(&TEST_DROP,);\n+   |               ----------    ^^^^^^^^^^^^^ creates a temporary which is freed while still in use\n+   |               |\n+   |               type annotation requires that borrow lasts for `'static`\n+...\n LL | }\n    | - temporary value is freed at the end of this statement\n \n-error: aborting due to 13 previous errors\n+error[E0716]: temporary value dropped while borrowed\n+  --> $DIR/promote-not.rs:62:31\n+   |\n+LL |     let _val: &'static _ = &(&TEST_DROP,);\n+   |               ----------      ^^^^^^^^^ creates a temporary which is freed while still in use\n+   |               |\n+   |               type annotation requires that borrow lasts for `'static`\n+...\n+LL | }\n+   | - temporary value is freed at the end of this statement\n+\n+error[E0716]: temporary value dropped while borrowed\n+  --> $DIR/promote-not.rs:65:29\n+   |\n+LL |     let _val: &'static _ = &[&TEST_DROP; 1];\n+   |               ----------    ^^^^^^^^^^^^^^^ creates a temporary which is freed while still in use\n+   |               |\n+   |               type annotation requires that borrow lasts for `'static`\n+...\n+LL | }\n+   | - temporary value is freed at the end of this statement\n+\n+error[E0716]: temporary value dropped while borrowed\n+  --> $DIR/promote-not.rs:65:31\n+   |\n+LL |     let _val: &'static _ = &[&TEST_DROP; 1];\n+   |               ----------      ^^^^^^^^^    - temporary value is freed at the end of this statement\n+   |               |               |\n+   |               |               creates a temporary which is freed while still in use\n+   |               type annotation requires that borrow lasts for `'static`\n+\n+error: aborting due to 20 previous errors\n \n For more information about this error, try `rustc --explain E0716`."}]}