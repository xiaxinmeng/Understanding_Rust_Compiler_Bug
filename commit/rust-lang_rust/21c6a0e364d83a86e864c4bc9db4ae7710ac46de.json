{"sha": "21c6a0e364d83a86e864c4bc9db4ae7710ac46de", "node_id": "C_kwDOAAsO6NoAKDIxYzZhMGUzNjRkODNhODZlODY0YzRiYzlkYjRhZTc3MTBhYzQ2ZGU", "commit": {"author": {"name": "Michael Howell", "email": "michael@notriddle.com", "date": "2022-10-09T01:15:01Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-10-09T01:15:01Z"}, "message": "Rollup merge of #102790 - cuviper:llvm-tblgen, r=jyn514\n\nFix llvm-tblgen for cross compiling\n\n- Let llvm-config tell us where to find its tools\n- Add llvm-tblgen to rust-dev for cross-compiling\n\nFixes #86890.\nr? ````@jyn514````", "tree": {"sha": "06e5c168cec2115d969a34277ac2d8b1761ee49b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/06e5c168cec2115d969a34277ac2d8b1761ee49b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/21c6a0e364d83a86e864c4bc9db4ae7710ac46de", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjQiCVCRBK7hj4Ov3rIwAAbTwIAFw2TJvP6u4FUkO9D9pVfvju\nYOSKRF/1JG8OGoqJJBvjKhWDyVv/NMqUSyYcup6WbBkw0X9pvAEqJdvMtlWmhd//\neZmWYe7AAmygfHcAyuyjJFXg2j6Gn/kfNghphD0v6lGRvi/ALK1tKj/Un3HsTVqf\n/vzOehaxi3fp9aUJhuB9LHuFr51/6IXam+6tH19MUjv7Am7IhzE507sIH2Wbg0V/\n0Nf0n7jeDv8bjkBCCReDmke+VqqUDVUiDba1PilaUjtIS2ojJGGrJFK3IJB86pL0\nRq8Sj/nnngDgK96Fj5pJoshbwY9S++U81IMAuWncCu79lL/wDUAj6JXkLo0pov8=\n=KAqp\n-----END PGP SIGNATURE-----\n", "payload": "tree 06e5c168cec2115d969a34277ac2d8b1761ee49b\nparent f1ab04ffbbb63a2a3ce9a9de07e0177988383ede\nparent a027474ea6b424aa4101edc9d15d8ebe677783e9\nauthor Michael Howell <michael@notriddle.com> 1665278101 -0700\ncommitter GitHub <noreply@github.com> 1665278101 -0700\n\nRollup merge of #102790 - cuviper:llvm-tblgen, r=jyn514\n\nFix llvm-tblgen for cross compiling\n\n- Let llvm-config tell us where to find its tools\n- Add llvm-tblgen to rust-dev for cross-compiling\n\nFixes #86890.\nr? ````@jyn514````\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/21c6a0e364d83a86e864c4bc9db4ae7710ac46de", "html_url": "https://github.com/rust-lang/rust/commit/21c6a0e364d83a86e864c4bc9db4ae7710ac46de", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/21c6a0e364d83a86e864c4bc9db4ae7710ac46de/comments", "author": {"login": "notriddle", "id": 1593513, "node_id": "MDQ6VXNlcjE1OTM1MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/1593513?v=4", "gravatar_id": "", "url": "https://api.github.com/users/notriddle", "html_url": "https://github.com/notriddle", "followers_url": "https://api.github.com/users/notriddle/followers", "following_url": "https://api.github.com/users/notriddle/following{/other_user}", "gists_url": "https://api.github.com/users/notriddle/gists{/gist_id}", "starred_url": "https://api.github.com/users/notriddle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/notriddle/subscriptions", "organizations_url": "https://api.github.com/users/notriddle/orgs", "repos_url": "https://api.github.com/users/notriddle/repos", "events_url": "https://api.github.com/users/notriddle/events{/privacy}", "received_events_url": "https://api.github.com/users/notriddle/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f1ab04ffbbb63a2a3ce9a9de07e0177988383ede", "url": "https://api.github.com/repos/rust-lang/rust/commits/f1ab04ffbbb63a2a3ce9a9de07e0177988383ede", "html_url": "https://github.com/rust-lang/rust/commit/f1ab04ffbbb63a2a3ce9a9de07e0177988383ede"}, {"sha": "a027474ea6b424aa4101edc9d15d8ebe677783e9", "url": "https://api.github.com/repos/rust-lang/rust/commits/a027474ea6b424aa4101edc9d15d8ebe677783e9", "html_url": "https://github.com/rust-lang/rust/commit/a027474ea6b424aa4101edc9d15d8ebe677783e9"}], "stats": {"total": 27, "additions": 14, "deletions": 13}, "files": [{"sha": "5a7a193897bfad3105da46cc20dfee5769115f7d", "filename": "src/bootstrap/dist.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/21c6a0e364d83a86e864c4bc9db4ae7710ac46de/src%2Fbootstrap%2Fdist.rs", "raw_url": "https://github.com/rust-lang/rust/raw/21c6a0e364d83a86e864c4bc9db4ae7710ac46de/src%2Fbootstrap%2Fdist.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fdist.rs?ref=21c6a0e364d83a86e864c4bc9db4ae7710ac46de", "patch": "@@ -2028,6 +2028,7 @@ impl Step for RustDev {\n             \"llvm-nm\",\n             \"llvm-dwarfdump\",\n             \"llvm-dis\",\n+            \"llvm-tblgen\",\n         ] {\n             tarball.add_file(src_bindir.join(exe(bin, target)), \"bin\", 0o755);\n         }"}, {"sha": "d19a1ae95cf145dcc44f488a8facbb356f12a35a", "filename": "src/bootstrap/download-ci-llvm-stamp", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/21c6a0e364d83a86e864c4bc9db4ae7710ac46de/src%2Fbootstrap%2Fdownload-ci-llvm-stamp", "raw_url": "https://github.com/rust-lang/rust/raw/21c6a0e364d83a86e864c4bc9db4ae7710ac46de/src%2Fbootstrap%2Fdownload-ci-llvm-stamp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fdownload-ci-llvm-stamp?ref=21c6a0e364d83a86e864c4bc9db4ae7710ac46de", "patch": "@@ -1,4 +1,4 @@\n Change this file to make users of the `download-ci-llvm` configuration download\n a new version of LLVM from CI, even if the LLVM submodule hasn\u2019t changed.\n \n-Last change is for: https://github.com/rust-lang/rust/pull/97550\n+Last change is for: https://github.com/rust-lang/rust/pull/102790"}, {"sha": "ea97ae4f65127822867a93b8b8d388ad60ace8a2", "filename": "src/bootstrap/native.rs", "status": "modified", "additions": 12, "deletions": 12, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/21c6a0e364d83a86e864c4bc9db4ae7710ac46de/src%2Fbootstrap%2Fnative.rs", "raw_url": "https://github.com/rust-lang/rust/raw/21c6a0e364d83a86e864c4bc9db4ae7710ac46de/src%2Fbootstrap%2Fnative.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fnative.rs?ref=21c6a0e364d83a86e864c4bc9db4ae7710ac46de", "patch": "@@ -497,18 +497,18 @@ impl Step for Llvm {\n \n         // https://llvm.org/docs/HowToCrossCompileLLVM.html\n         if target != builder.config.build {\n-            builder.ensure(Llvm { target: builder.config.build });\n-            // FIXME: if the llvm root for the build triple is overridden then we\n-            //        should use llvm-tblgen from there, also should verify that it\n-            //        actually exists most of the time in normal installs of LLVM.\n-            let host_bin = builder.llvm_out(builder.config.build).join(\"bin\");\n-            cfg.define(\"LLVM_TABLEGEN\", host_bin.join(\"llvm-tblgen\").with_extension(EXE_EXTENSION));\n-            // LLVM_NM is required for cross compiling using MSVC\n-            cfg.define(\"LLVM_NM\", host_bin.join(\"llvm-nm\").with_extension(EXE_EXTENSION));\n-            cfg.define(\n-                \"LLVM_CONFIG_PATH\",\n-                host_bin.join(\"llvm-config\").with_extension(EXE_EXTENSION),\n-            );\n+            let llvm_config = builder.ensure(Llvm { target: builder.config.build });\n+            if !builder.config.dry_run {\n+                let llvm_bindir = output(Command::new(&llvm_config).arg(\"--bindir\"));\n+                let host_bin = Path::new(llvm_bindir.trim());\n+                cfg.define(\n+                    \"LLVM_TABLEGEN\",\n+                    host_bin.join(\"llvm-tblgen\").with_extension(EXE_EXTENSION),\n+                );\n+                // LLVM_NM is required for cross compiling using MSVC\n+                cfg.define(\"LLVM_NM\", host_bin.join(\"llvm-nm\").with_extension(EXE_EXTENSION));\n+            }\n+            cfg.define(\"LLVM_CONFIG_PATH\", llvm_config);\n             if builder.config.llvm_clang {\n                 let build_bin = builder.llvm_out(builder.config.build).join(\"build\").join(\"bin\");\n                 let clang_tblgen = build_bin.join(\"clang-tblgen\").with_extension(EXE_EXTENSION);"}]}