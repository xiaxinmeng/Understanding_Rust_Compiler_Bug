{"sha": "27e84b89dae055fef9fd9e705be65c244b54e4c7", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI3ZTg0Yjg5ZGFlMDU1ZmVmOWZkOWU3MDViZTY1YzI0NGI1NGU0Yzc=", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2021-06-10T02:02:01Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-06-10T02:02:01Z"}, "message": "Rollup merge of #82037 - calavera:strip_debuginfo_osx, r=petrochenkov\n\nMake symbols stripping work on MacOS X\n\nAs reported in the [stabilization issue](https://github.com/rust-lang/rust/issues/72110), MacOS' linker doesn't support the `-s` and `-S` flags to strip symbols anymore. However, the os ships a separated tool to perform these operations.\n\nThis change allows the compiler to use that tool after a target has been compiled to strip symbols.\n\nFor rationale, see: https://github.com/rust-lang/rust/issues/72110#issuecomment-641169818\nFor option selection, see: https://www.unix.com/man-page/osx/1/strip/\n\nSigned-off-by: David Calavera <david.calavera@gmail.com>", "tree": {"sha": "c74541d74bba8818cd6becae5f9d7f81ffcd2af4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c74541d74bba8818cd6becae5f9d7f81ffcd2af4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/27e84b89dae055fef9fd9e705be65c244b54e4c7", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgwXKbCRBK7hj4Ov3rIwAAqKoIAFdrCxlEj7yEhGLtjAOEDdgH\nXwZXsGqcRL5QDPX5/acTfAF0V2G47UhxGsgKBR6Ppw0zCWjSld5yq18coTnSpCg7\njAH63l5cDouUd4MtzJ4KptacbL7sHdz52nnugECg5xKzY5kk2vC8peGDmozkhMrO\nVRVxbGaDRzFC/CPto4u+71JZwUz6AeBxJH46rGv5EeD3GOUVL7+Qw+T7Na85xUUw\n5rO2s19BNSVfA1Z4Oytr4ycldERMigEyXoj5ItfCKajbhBeCDQt8nn60EkcockHq\nGGf4VWjhU/POSMojSQthGCLVu7bhyaMXVkmShj1pxb3ug4+UBEGcgkpMsgF7TMA=\n=tReD\n-----END PGP SIGNATURE-----\n", "payload": "tree c74541d74bba8818cd6becae5f9d7f81ffcd2af4\nparent eab201df7028ebb6812c0b1a01702ac6ecfcceed\nparent df0fc6daeede7722d631bcb45ed3755eb693580e\nauthor Yuki Okushi <jtitor@2k36.org> 1623290521 +0900\ncommitter GitHub <noreply@github.com> 1623290521 +0900\n\nRollup merge of #82037 - calavera:strip_debuginfo_osx, r=petrochenkov\n\nMake symbols stripping work on MacOS X\n\nAs reported in the [stabilization issue](https://github.com/rust-lang/rust/issues/72110), MacOS' linker doesn't support the `-s` and `-S` flags to strip symbols anymore. However, the os ships a separated tool to perform these operations.\n\nThis change allows the compiler to use that tool after a target has been compiled to strip symbols.\n\nFor rationale, see: https://github.com/rust-lang/rust/issues/72110#issuecomment-641169818\nFor option selection, see: https://www.unix.com/man-page/osx/1/strip/\n\nSigned-off-by: David Calavera <david.calavera@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/27e84b89dae055fef9fd9e705be65c244b54e4c7", "html_url": "https://github.com/rust-lang/rust/commit/27e84b89dae055fef9fd9e705be65c244b54e4c7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/27e84b89dae055fef9fd9e705be65c244b54e4c7/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "eab201df7028ebb6812c0b1a01702ac6ecfcceed", "url": "https://api.github.com/repos/rust-lang/rust/commits/eab201df7028ebb6812c0b1a01702ac6ecfcceed", "html_url": "https://github.com/rust-lang/rust/commit/eab201df7028ebb6812c0b1a01702ac6ecfcceed"}, {"sha": "df0fc6daeede7722d631bcb45ed3755eb693580e", "url": "https://api.github.com/repos/rust-lang/rust/commits/df0fc6daeede7722d631bcb45ed3755eb693580e", "html_url": "https://github.com/rust-lang/rust/commit/df0fc6daeede7722d631bcb45ed3755eb693580e"}], "stats": {"total": 62, "additions": 49, "deletions": 13}, "files": [{"sha": "cb56e3f9e8a1995ef8adb936b539651437b7c027", "filename": "compiler/rustc_codegen_ssa/src/back/link.rs", "status": "modified", "additions": 42, "deletions": 9, "changes": 51, "blob_url": "https://github.com/rust-lang/rust/blob/27e84b89dae055fef9fd9e705be65c244b54e4c7/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/27e84b89dae055fef9fd9e705be65c244b54e4c7/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs?ref=27e84b89dae055fef9fd9e705be65c244b54e4c7", "patch": "@@ -5,7 +5,7 @@ use rustc_fs_util::fix_windows_verbatim_for_gcc;\n use rustc_hir::def_id::CrateNum;\n use rustc_middle::middle::cstore::{DllImport, LibSource};\n use rustc_middle::middle::dependency_format::Linkage;\n-use rustc_session::config::{self, CFGuard, CrateType, DebugInfo};\n+use rustc_session::config::{self, CFGuard, CrateType, DebugInfo, Strip};\n use rustc_session::config::{OutputFilenames, OutputType, PrintRequest};\n use rustc_session::output::{check_file_is_writeable, invalid_output_for_target, out_filename};\n use rustc_session::search_paths::PathKind;\n@@ -907,14 +907,6 @@ fn link_natively<'a, B: ArchiveBuilder<'a>>(\n         }\n     }\n \n-    fn escape_string(s: &[u8]) -> String {\n-        str::from_utf8(s).map(|s| s.to_owned()).unwrap_or_else(|_| {\n-            let mut x = \"Non-UTF-8 output: \".to_string();\n-            x.extend(s.iter().flat_map(|&b| ascii::escape_default(b)).map(char::from));\n-            x\n-        })\n-    }\n-\n     match prog {\n         Ok(prog) => {\n             if !prog.status.success() {\n@@ -1056,6 +1048,47 @@ fn link_natively<'a, B: ArchiveBuilder<'a>>(\n         // ... and otherwise we're processing a `*.dwp` packed dwarf file.\n         SplitDebuginfo::Packed => link_dwarf_object(sess, &out_filename),\n     }\n+\n+    if sess.target.is_like_osx {\n+        if let Some(option) = osx_strip_opt(sess.opts.debugging_opts.strip) {\n+            strip_symbols_in_osx(sess, &out_filename, option);\n+        }\n+    }\n+}\n+\n+fn strip_symbols_in_osx<'a>(sess: &'a Session, out_filename: &Path, option: &str) {\n+    let prog = Command::new(\"strip\").arg(option).arg(out_filename).output();\n+    match prog {\n+        Ok(prog) => {\n+            if !prog.status.success() {\n+                let mut output = prog.stderr.clone();\n+                output.extend_from_slice(&prog.stdout);\n+                sess.struct_warn(&format!(\n+                    \"stripping debug info with `strip` failed: {}\",\n+                    prog.status\n+                ))\n+                .note(&escape_string(&output))\n+                .emit();\n+            }\n+        }\n+        Err(e) => sess.fatal(&format!(\"unable to run `strip`: {}\", e)),\n+    }\n+}\n+\n+fn osx_strip_opt<'a>(strip: Strip) -> Option<&'a str> {\n+    match strip {\n+        Strip::Debuginfo => Some(\"-S\"),\n+        Strip::Symbols => Some(\"-x\"),\n+        Strip::None => None,\n+    }\n+}\n+\n+fn escape_string(s: &[u8]) -> String {\n+    str::from_utf8(s).map(|s| s.to_owned()).unwrap_or_else(|_| {\n+        let mut x = \"Non-UTF-8 output: \".to_string();\n+        x.extend(s.iter().flat_map(|&b| ascii::escape_default(b)).map(char::from));\n+        x\n+    })\n }\n \n fn add_sanitizer_libraries(sess: &Session, crate_type: CrateType, linker: &mut dyn Linker) {"}, {"sha": "43ff664c3e641059488a75f90f672990418144bb", "filename": "compiler/rustc_codegen_ssa/src/back/linker.rs", "status": "modified", "additions": 7, "deletions": 4, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/27e84b89dae055fef9fd9e705be65c244b54e4c7/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flinker.rs", "raw_url": "https://github.com/rust-lang/rust/raw/27e84b89dae055fef9fd9e705be65c244b54e4c7/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flinker.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flinker.rs?ref=27e84b89dae055fef9fd9e705be65c244b54e4c7", "patch": "@@ -526,15 +526,18 @@ impl<'a> Linker for GccLinker<'a> {\n     fn control_flow_guard(&mut self) {}\n \n     fn debuginfo(&mut self, strip: Strip) {\n+        // MacOS linker doesn't support stripping symbols directly anymore.\n+        if self.sess.target.is_like_osx {\n+            return;\n+        }\n+\n         match strip {\n             Strip::None => {}\n             Strip::Debuginfo => {\n-                // MacOS linker does not support longhand argument --strip-debug\n-                self.linker_arg(\"-S\");\n+                self.linker_arg(\"--strip-debug\");\n             }\n             Strip::Symbols => {\n-                // MacOS linker does not support longhand argument --strip-all\n-                self.linker_arg(\"-s\");\n+                self.linker_arg(\"--strip-all\");\n             }\n         }\n     }"}]}