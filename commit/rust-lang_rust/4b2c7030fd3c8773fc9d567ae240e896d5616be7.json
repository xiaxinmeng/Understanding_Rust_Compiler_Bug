{"sha": "4b2c7030fd3c8773fc9d567ae240e896d5616be7", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRiMmM3MDMwZmQzYzg3NzNmYzlkNTY3YWUyNDBlODk2ZDU2MTZiZTc=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-02-12T02:16:13Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-02-12T02:16:13Z"}, "message": "Auto merge of #30830 - arcnmx:static-extern, r=alexcrichton\n\nSee #29676\n\nr? @alexcrichton", "tree": {"sha": "8385625ed7515ff7e0364776c6d64786200ea7c6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8385625ed7515ff7e0364776c6d64786200ea7c6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4b2c7030fd3c8773fc9d567ae240e896d5616be7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4b2c7030fd3c8773fc9d567ae240e896d5616be7", "html_url": "https://github.com/rust-lang/rust/commit/4b2c7030fd3c8773fc9d567ae240e896d5616be7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4b2c7030fd3c8773fc9d567ae240e896d5616be7/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "78a5d5b54e0ff91bda8518df7ed9673cc657a4e6", "url": "https://api.github.com/repos/rust-lang/rust/commits/78a5d5b54e0ff91bda8518df7ed9673cc657a4e6", "html_url": "https://github.com/rust-lang/rust/commit/78a5d5b54e0ff91bda8518df7ed9673cc657a4e6"}, {"sha": "0ff055ad6640e26a4ddf783682545320de0d1c03", "url": "https://api.github.com/repos/rust-lang/rust/commits/0ff055ad6640e26a4ddf783682545320de0d1c03", "html_url": "https://github.com/rust-lang/rust/commit/0ff055ad6640e26a4ddf783682545320de0d1c03"}], "stats": {"total": 85, "additions": 42, "deletions": 43}, "files": [{"sha": "c2c23f6a0325094242c829c98012e6fe715cc62e", "filename": "src/librustc/middle/cstore.rs", "status": "modified", "additions": 2, "deletions": 4, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/4b2c7030fd3c8773fc9d567ae240e896d5616be7/src%2Flibrustc%2Fmiddle%2Fcstore.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4b2c7030fd3c8773fc9d567ae240e896d5616be7/src%2Flibrustc%2Fmiddle%2Fcstore.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fcstore.rs?ref=4b2c7030fd3c8773fc9d567ae240e896d5616be7", "patch": "@@ -187,8 +187,7 @@ pub trait CrateStore<'tcx> : Any {\n     fn is_defaulted_trait(&self, did: DefId) -> bool;\n     fn is_impl(&self, did: DefId) -> bool;\n     fn is_default_impl(&self, impl_did: DefId) -> bool;\n-    fn is_extern_fn(&self, tcx: &ty::ctxt<'tcx>, did: DefId) -> bool;\n-    fn is_static(&self, did: DefId) -> bool;\n+    fn is_extern_item(&self, tcx: &ty::ctxt<'tcx>, did: DefId) -> bool;\n     fn is_static_method(&self, did: DefId) -> bool;\n     fn is_statically_included_foreign_item(&self, id: ast::NodeId) -> bool;\n     fn is_typedef(&self, did: DefId) -> bool;\n@@ -357,8 +356,7 @@ impl<'tcx> CrateStore<'tcx> for DummyCrateStore {\n     fn is_defaulted_trait(&self, did: DefId) -> bool { unimplemented!() }\n     fn is_impl(&self, did: DefId) -> bool { unimplemented!() }\n     fn is_default_impl(&self, impl_did: DefId) -> bool { unimplemented!() }\n-    fn is_extern_fn(&self, tcx: &ty::ctxt<'tcx>, did: DefId) -> bool { unimplemented!() }\n-    fn is_static(&self, did: DefId) -> bool { unimplemented!() }\n+    fn is_extern_item(&self, tcx: &ty::ctxt<'tcx>, did: DefId) -> bool { unimplemented!() }\n     fn is_static_method(&self, did: DefId) -> bool { unimplemented!() }\n     fn is_statically_included_foreign_item(&self, id: ast::NodeId) -> bool { false }\n     fn is_typedef(&self, did: DefId) -> bool { unimplemented!() }"}, {"sha": "d2e1b3edc3a68e7af6f086f23a00bd9e9047dc41", "filename": "src/librustc/middle/reachable.rs", "status": "modified", "additions": 11, "deletions": 9, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/4b2c7030fd3c8773fc9d567ae240e896d5616be7/src%2Flibrustc%2Fmiddle%2Freachable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4b2c7030fd3c8773fc9d567ae240e896d5616be7/src%2Flibrustc%2Fmiddle%2Freachable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Freachable.rs?ref=4b2c7030fd3c8773fc9d567ae240e896d5616be7", "patch": "@@ -229,16 +229,18 @@ impl<'a, 'tcx> ReachableContext<'a, 'tcx> {\n     fn propagate_node(&mut self, node: &ast_map::Node,\n                       search_item: ast::NodeId) {\n         if !self.any_library {\n-            // If we are building an executable, then there's no need to flag\n-            // anything as external except for `extern fn` types. These\n-            // functions may still participate in some form of native interface,\n-            // but all other rust-only interfaces can be private (they will not\n-            // participate in linkage after this product is produced)\n+            // If we are building an executable, only explicitly extern\n+            // types need to be exported.\n             if let ast_map::NodeItem(item) = *node {\n-                if let hir::ItemFn(_, _, _, abi, _, _) = item.node {\n-                    if abi != Abi::Rust {\n-                        self.reachable_symbols.insert(search_item);\n-                    }\n+                let reachable = if let hir::ItemFn(_, _, _, abi, _, _) = item.node {\n+                    abi != Abi::Rust\n+                } else {\n+                    false\n+                };\n+                let is_extern = attr::contains_extern_indicator(&self.tcx.sess.diagnostic(),\n+                                                                &item.attrs);\n+                if reachable || is_extern {\n+                    self.reachable_symbols.insert(search_item);\n                 }\n             }\n         } else {"}, {"sha": "5eade3bc0a54ed7c82152832cccac8bad11fb60f", "filename": "src/librustc_metadata/csearch.rs", "status": "modified", "additions": 2, "deletions": 9, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/4b2c7030fd3c8773fc9d567ae240e896d5616be7/src%2Flibrustc_metadata%2Fcsearch.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4b2c7030fd3c8773fc9d567ae240e896d5616be7/src%2Flibrustc_metadata%2Fcsearch.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Fcsearch.rs?ref=4b2c7030fd3c8773fc9d567ae240e896d5616be7", "patch": "@@ -260,16 +260,9 @@ impl<'tcx> CrateStore<'tcx> for cstore::CStore {\n         decoder::is_default_impl(&*cdata, impl_did.index)\n     }\n \n-    fn is_extern_fn(&self, tcx: &ty::ctxt<'tcx>, did: DefId) -> bool\n-    {\n-        let cdata = self.get_crate_data(did.krate);\n-        decoder::is_extern_fn(&*cdata, did.index, tcx)\n-    }\n-\n-    fn is_static(&self, did: DefId) -> bool\n-    {\n+    fn is_extern_item(&self, tcx: &ty::ctxt<'tcx>, did: DefId) -> bool {\n         let cdata = self.get_crate_data(did.krate);\n-        decoder::is_static(&*cdata, did.index)\n+        decoder::is_extern_item(&*cdata, did.index, tcx)\n     }\n \n     fn is_static_method(&self, def: DefId) -> bool"}, {"sha": "8409a0c74b869eb05ea34623345b0feaa498f44e", "filename": "src/librustc_metadata/decoder.rs", "status": "modified", "additions": 21, "deletions": 19, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/4b2c7030fd3c8773fc9d567ae240e896d5616be7/src%2Flibrustc_metadata%2Fdecoder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4b2c7030fd3c8773fc9d567ae240e896d5616be7/src%2Flibrustc_metadata%2Fdecoder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Fdecoder.rs?ref=4b2c7030fd3c8773fc9d567ae240e896d5616be7", "patch": "@@ -1567,11 +1567,29 @@ pub fn is_const_fn(cdata: Cmd, id: DefIndex) -> bool {\n     }\n }\n \n-pub fn is_static(cdata: Cmd, id: DefIndex) -> bool {\n-    let item_doc = cdata.lookup_item(id);\n-    match item_family(item_doc) {\n+pub fn is_extern_item(cdata: Cmd, id: DefIndex, tcx: &ty::ctxt) -> bool {\n+    let item_doc = match cdata.get_item(id) {\n+        Some(doc) => doc,\n+        None => return false,\n+    };\n+    let applicable = match item_family(item_doc) {\n         ImmStatic | MutStatic => true,\n+        Fn => {\n+            let ty::TypeScheme { generics, ty } = get_type(cdata, id, tcx);\n+            let no_generics = generics.types.is_empty();\n+            match ty.sty {\n+                ty::TyBareFn(_, fn_ty) if fn_ty.abi != Abi::Rust => return no_generics,\n+                _ => no_generics,\n+            }\n+        },\n         _ => false,\n+    };\n+\n+    if applicable {\n+        attr::contains_extern_indicator(tcx.sess.diagnostic(),\n+                                        &get_attributes(item_doc))\n+    } else {\n+        false\n     }\n }\n \n@@ -1693,22 +1711,6 @@ pub fn get_imported_filemaps(metadata: &[u8]) -> Vec<codemap::FileMap> {\n     }).collect()\n }\n \n-pub fn is_extern_fn(cdata: Cmd, id: DefIndex, tcx: &ty::ctxt) -> bool {\n-    let item_doc = match cdata.get_item(id) {\n-        Some(doc) => doc,\n-        None => return false,\n-    };\n-    if let Fn = item_family(item_doc) {\n-        let ty::TypeScheme { generics, ty } = get_type(cdata, id, tcx);\n-        generics.types.is_empty() && match ty.sty {\n-            ty::TyBareFn(_, fn_ty) => fn_ty.abi != Abi::Rust,\n-            _ => false,\n-        }\n-    } else {\n-        false\n-    }\n-}\n-\n pub fn closure_kind(cdata: Cmd, closure_id: DefIndex) -> ty::ClosureKind {\n     let closure_doc = cdata.lookup_item(closure_id);\n     let closure_kind_doc = reader::get_doc(closure_doc, tag_items_closure_kind);"}, {"sha": "4748c62921de6f24e4376093d0460f11a97477ff", "filename": "src/librustc_trans/trans/base.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/4b2c7030fd3c8773fc9d567ae240e896d5616be7/src%2Flibrustc_trans%2Ftrans%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4b2c7030fd3c8773fc9d567ae240e896d5616be7/src%2Flibrustc_trans%2Ftrans%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Ftrans%2Fbase.rs?ref=4b2c7030fd3c8773fc9d567ae240e896d5616be7", "patch": "@@ -3281,8 +3281,7 @@ pub fn trans_crate<'tcx>(tcx: &ty::ctxt<'tcx>,\n         for cnum in sess.cstore.crates() {\n             let syms = sess.cstore.reachable_ids(cnum);\n             reachable_symbols.extend(syms.into_iter().filter(|did| {\n-                sess.cstore.is_extern_fn(shared_ccx.tcx(), *did) ||\n-                sess.cstore.is_static(*did)\n+                sess.cstore.is_extern_item(shared_ccx.tcx(), *did)\n             }).map(|did| {\n                 sess.cstore.item_symbol(did)\n             }));"}, {"sha": "9953947eb52b7c797c2a2a0538a1ddef76fbb602", "filename": "src/libsyntax/attr.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/4b2c7030fd3c8773fc9d567ae240e896d5616be7/src%2Flibsyntax%2Fattr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4b2c7030fd3c8773fc9d567ae240e896d5616be7/src%2Flibsyntax%2Fattr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fattr.rs?ref=4b2c7030fd3c8773fc9d567ae240e896d5616be7", "patch": "@@ -316,6 +316,11 @@ pub fn find_export_name_attr(diag: &Handler, attrs: &[Attribute]) -> Option<Inte\n     })\n }\n \n+pub fn contains_extern_indicator(diag: &Handler, attrs: &[Attribute]) -> bool {\n+    contains_name(attrs, \"no_mangle\") ||\n+        find_export_name_attr(diag, attrs).is_some()\n+}\n+\n #[derive(Copy, Clone, PartialEq)]\n pub enum InlineAttr {\n     None,"}]}