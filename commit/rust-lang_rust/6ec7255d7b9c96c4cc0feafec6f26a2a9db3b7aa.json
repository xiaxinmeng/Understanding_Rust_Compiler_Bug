{"sha": "6ec7255d7b9c96c4cc0feafec6f26a2a9db3b7aa", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZlYzcyNTVkN2I5Yzk2YzRjYzBmZWFmZWM2ZjI2YTJhOWRiM2I3YWE=", "commit": {"author": {"name": "Waffle", "email": "waffle.lapkin@gmail.com", "date": "2021-09-13T13:36:14Z"}, "committer": {"name": "Waffle", "email": "waffle.lapkin@gmail.com", "date": "2021-09-13T13:36:14Z"}, "message": "Highlight the const function if error happened because of a bound on the impl block\n\nCurrently, for the following code, the compiler produces the errors like the\nfollowing error:\n```rust\nstruct Type<T>\n\nimpl<T: Clone> Type<T> {\n\tfn const f() {}\n}\n```\n```text\nerror[E0658]: trait bounds other than `Sized` on const fn parameters are unstable\n --> ./test.rs:3:6\n  |\n3 | impl<T: Clone> Type<T> {\n  |      ^\n  |\n  = note: see issue #57563 <https://github.com/rust-lang/rust/issues/57563> for more information\n  = help: add `#![feature(const_fn_trait_bound)]` to the crate attributes to enable\n```\n\nThis can be confusing (especially to newcomers) since the error mentions\n\"const fn parameters\", but highlights only the impl.\n\nThis commits adds function highlighting, changing the error to the following:\n\n```text\nerror[E0658]: trait bounds other than `Sized` on const fn parameters are unstable\n --> ./test.rs:3:6\n  |\n3 | impl<T: Clone> Type<T> {\n  |      ^\n4 |     pub const fn f() {}\n  |     ---------------- function declared as const here\n  |\n  = note: see issue #57563 <https://github.com/rust-lang/rust/issues/57563> for more information\n  = help: add `#![feature(const_fn_trait_bound)]` to the crate attributes to enable\n```", "tree": {"sha": "333ca825ed2b1c1fef21c3d404a0abec64a749ea", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/333ca825ed2b1c1fef21c3d404a0abec64a749ea"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6ec7255d7b9c96c4cc0feafec6f26a2a9db3b7aa", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6ec7255d7b9c96c4cc0feafec6f26a2a9db3b7aa", "html_url": "https://github.com/rust-lang/rust/commit/6ec7255d7b9c96c4cc0feafec6f26a2a9db3b7aa", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6ec7255d7b9c96c4cc0feafec6f26a2a9db3b7aa/comments", "author": {"login": "WaffleLapkin", "id": 38225716, "node_id": "MDQ6VXNlcjM4MjI1NzE2", "avatar_url": "https://avatars.githubusercontent.com/u/38225716?v=4", "gravatar_id": "", "url": "https://api.github.com/users/WaffleLapkin", "html_url": "https://github.com/WaffleLapkin", "followers_url": "https://api.github.com/users/WaffleLapkin/followers", "following_url": "https://api.github.com/users/WaffleLapkin/following{/other_user}", "gists_url": "https://api.github.com/users/WaffleLapkin/gists{/gist_id}", "starred_url": "https://api.github.com/users/WaffleLapkin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/WaffleLapkin/subscriptions", "organizations_url": "https://api.github.com/users/WaffleLapkin/orgs", "repos_url": "https://api.github.com/users/WaffleLapkin/repos", "events_url": "https://api.github.com/users/WaffleLapkin/events{/privacy}", "received_events_url": "https://api.github.com/users/WaffleLapkin/received_events", "type": "User", "site_admin": false}, "committer": {"login": "WaffleLapkin", "id": 38225716, "node_id": "MDQ6VXNlcjM4MjI1NzE2", "avatar_url": "https://avatars.githubusercontent.com/u/38225716?v=4", "gravatar_id": "", "url": "https://api.github.com/users/WaffleLapkin", "html_url": "https://github.com/WaffleLapkin", "followers_url": "https://api.github.com/users/WaffleLapkin/followers", "following_url": "https://api.github.com/users/WaffleLapkin/following{/other_user}", "gists_url": "https://api.github.com/users/WaffleLapkin/gists{/gist_id}", "starred_url": "https://api.github.com/users/WaffleLapkin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/WaffleLapkin/subscriptions", "organizations_url": "https://api.github.com/users/WaffleLapkin/orgs", "repos_url": "https://api.github.com/users/WaffleLapkin/repos", "events_url": "https://api.github.com/users/WaffleLapkin/events{/privacy}", "received_events_url": "https://api.github.com/users/WaffleLapkin/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d2dfb0eb8e30d188fb1731e540bc1b418bcd046d", "url": "https://api.github.com/repos/rust-lang/rust/commits/d2dfb0eb8e30d188fb1731e540bc1b418bcd046d", "html_url": "https://github.com/rust-lang/rust/commit/d2dfb0eb8e30d188fb1731e540bc1b418bcd046d"}], "stats": {"total": 40, "additions": 34, "deletions": 6}, "files": [{"sha": "2a29675083888e9a8021e9e7082c89200027f91d", "filename": "compiler/rustc_const_eval/src/transform/check_consts/ops.rs", "status": "modified", "additions": 11, "deletions": 2, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/6ec7255d7b9c96c4cc0feafec6f26a2a9db3b7aa/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fops.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6ec7255d7b9c96c4cc0feafec6f26a2a9db3b7aa/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fops.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fops.rs?ref=6ec7255d7b9c96c4cc0feafec6f26a2a9db3b7aa", "patch": "@@ -599,12 +599,21 @@ pub mod ty {\n         }\n \n         fn build_error(&self, ccx: &ConstCx<'_, 'tcx>, span: Span) -> DiagnosticBuilder<'tcx> {\n-            feature_err(\n+            let mut builder = feature_err(\n                 &ccx.tcx.sess.parse_sess,\n                 sym::const_fn_trait_bound,\n                 span,\n                 \"trait bounds other than `Sized` on const fn parameters are unstable\",\n-            )\n+            );\n+\n+            match ccx.fn_sig() {\n+                Some(fn_sig) if !fn_sig.span.contains(span) => {\n+                    builder.span_label(fn_sig.span, \"function declared as const here\");\n+                }\n+                _ => {}\n+            }\n+\n+            builder\n         }\n     }\n "}, {"sha": "d1c2a04d6a61b395f67a759b81421dd4e7d9ac58", "filename": "src/test/ui/consts/min_const_fn/min_const_fn.stderr", "status": "modified", "additions": 18, "deletions": 3, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/6ec7255d7b9c96c4cc0feafec6f26a2a9db3b7aa/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_fn.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/6ec7255d7b9c96c4cc0feafec6f26a2a9db3b7aa/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_fn.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_fn.stderr?ref=6ec7255d7b9c96c4cc0feafec6f26a2a9db3b7aa", "patch": "@@ -214,6 +214,9 @@ error[E0658]: trait bounds other than `Sized` on const fn parameters are unstabl\n    |\n LL | impl<T: std::fmt::Debug> Foo<T> {\n    |      ^\n+LL |\n+LL |     const fn foo(&self) {}\n+   |     ------------------- function declared as const here\n    |\n    = note: see issue #57563 <https://github.com/rust-lang/rust/issues/57563> for more information\n    = help: add `#![feature(const_fn_trait_bound)]` to the crate attributes to enable\n@@ -223,6 +226,9 @@ error[E0658]: trait bounds other than `Sized` on const fn parameters are unstabl\n    |\n LL | impl<T: std::fmt::Debug + Sized> Foo<T> {\n    |      ^\n+LL |\n+LL |     const fn foo2(&self) {}\n+   |     -------------------- function declared as const here\n    |\n    = note: see issue #57563 <https://github.com/rust-lang/rust/issues/57563> for more information\n    = help: add `#![feature(const_fn_trait_bound)]` to the crate attributes to enable\n@@ -232,6 +238,9 @@ error[E0658]: trait bounds other than `Sized` on const fn parameters are unstabl\n    |\n LL | impl<T: Sync + Sized> Foo<T> {\n    |      ^\n+LL |\n+LL |     const fn foo3(&self) {}\n+   |     -------------------- function declared as const here\n    |\n    = note: see issue #57563 <https://github.com/rust-lang/rust/issues/57563> for more information\n    = help: add `#![feature(const_fn_trait_bound)]` to the crate attributes to enable\n@@ -292,7 +301,9 @@ error[E0658]: trait bounds other than `Sized` on const fn parameters are unstabl\n   --> $DIR/min_const_fn.rs:139:41\n    |\n LL | const fn really_no_traits_i_mean_it() { (&() as &dyn std::fmt::Debug, ()).1 }\n-   |                                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   | -------------------------------------   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   | |\n+   | function declared as const here\n    |\n    = note: see issue #57563 <https://github.com/rust-lang/rust/issues/57563> for more information\n    = help: add `#![feature(const_fn_trait_bound)]` to the crate attributes to enable\n@@ -301,7 +312,9 @@ error[E0658]: trait bounds other than `Sized` on const fn parameters are unstabl\n   --> $DIR/min_const_fn.rs:139:42\n    |\n LL | const fn really_no_traits_i_mean_it() { (&() as &dyn std::fmt::Debug, ()).1 }\n-   |                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   | -------------------------------------    ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   | |\n+   | function declared as const here\n    |\n    = note: see issue #57563 <https://github.com/rust-lang/rust/issues/57563> for more information\n    = help: add `#![feature(const_fn_trait_bound)]` to the crate attributes to enable\n@@ -310,7 +323,9 @@ error[E0658]: trait bounds other than `Sized` on const fn parameters are unstabl\n   --> $DIR/min_const_fn.rs:139:42\n    |\n LL | const fn really_no_traits_i_mean_it() { (&() as &dyn std::fmt::Debug, ()).1 }\n-   |                                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   | -------------------------------------    ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   | |\n+   | function declared as const here\n    |\n    = note: see issue #57563 <https://github.com/rust-lang/rust/issues/57563> for more information\n    = help: add `#![feature(const_fn_trait_bound)]` to the crate attributes to enable"}, {"sha": "2cad8a862be4cba54f578a270339ac0aa02d50bb", "filename": "src/test/ui/consts/min_const_fn/min_const_fn_dyn.stderr", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/6ec7255d7b9c96c4cc0feafec6f26a2a9db3b7aa/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_fn_dyn.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/6ec7255d7b9c96c4cc0feafec6f26a2a9db3b7aa/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_fn_dyn.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_fn_dyn.stderr?ref=6ec7255d7b9c96c4cc0feafec6f26a2a9db3b7aa", "patch": "@@ -1,6 +1,8 @@\n error[E0658]: trait bounds other than `Sized` on const fn parameters are unstable\n   --> $DIR/min_const_fn_dyn.rs:9:5\n    |\n+LL | const fn no_inner_dyn_trait2(x: Hide) {\n+   | ------------------------------------- function declared as const here\n LL |     x.0.field;\n    |     ^^^^^^^^^\n    |\n@@ -11,7 +13,9 @@ error[E0658]: trait bounds other than `Sized` on const fn parameters are unstabl\n   --> $DIR/min_const_fn_dyn.rs:12:66\n    |\n LL | const fn no_inner_dyn_trait_ret() -> Hide { Hide(HasDyn { field: &0 }) }\n-   |                                                                  ^^\n+   | -----------------------------------------                        ^^\n+   | |\n+   | function declared as const here\n    |\n    = note: see issue #57563 <https://github.com/rust-lang/rust/issues/57563> for more information\n    = help: add `#![feature(const_fn_trait_bound)]` to the crate attributes to enable"}]}