{"sha": "d49f977ed9fef7bc0734693eb6f6b1f41b72735e", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQ0OWY5NzdlZDlmZWY3YmMwNzM0NjkzZWI2ZjZiMWY0MWI3MjczNWU=", "commit": {"author": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2021-03-20T00:00:00Z"}, "committer": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2021-07-15T16:17:27Z"}, "message": "Layout error instead of an ICE for packed and aligned types", "tree": {"sha": "92b90c3fd472b692d913a2394662823fd4cb555c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/92b90c3fd472b692d913a2394662823fd4cb555c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d49f977ed9fef7bc0734693eb6f6b1f41b72735e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d49f977ed9fef7bc0734693eb6f6b1f41b72735e", "html_url": "https://github.com/rust-lang/rust/commit/d49f977ed9fef7bc0734693eb6f6b1f41b72735e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d49f977ed9fef7bc0734693eb6f6b1f41b72735e/comments", "author": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b9197978a90be6f7570741eabe2da175fec75375", "url": "https://api.github.com/repos/rust-lang/rust/commits/b9197978a90be6f7570741eabe2da175fec75375", "html_url": "https://github.com/rust-lang/rust/commit/b9197978a90be6f7570741eabe2da175fec75375"}], "stats": {"total": 36, "additions": 33, "deletions": 3}, "files": [{"sha": "e089b2526078c869db0fb00f23b4c4a8c3fb3abb", "filename": "compiler/rustc_middle/src/ty/layout.rs", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/d49f977ed9fef7bc0734693eb6f6b1f41b72735e/compiler%2Frustc_middle%2Fsrc%2Fty%2Flayout.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d49f977ed9fef7bc0734693eb6f6b1f41b72735e/compiler%2Frustc_middle%2Fsrc%2Fty%2Flayout.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Flayout.rs?ref=d49f977ed9fef7bc0734693eb6f6b1f41b72735e", "patch": "@@ -312,7 +312,8 @@ impl<'tcx> LayoutCx<'tcx, TyCtxt<'tcx>> {\n         let dl = self.data_layout();\n         let pack = repr.pack;\n         if pack.is_some() && repr.align.is_some() {\n-            bug!(\"struct cannot be packed and aligned\");\n+            self.tcx.sess.delay_span_bug(DUMMY_SP, \"struct cannot be packed and aligned\");\n+            return Err(LayoutError::Unknown(ty));\n         }\n \n         let mut align = if pack.is_some() { dl.i8_align } else { dl.aggregate_align };\n@@ -808,7 +809,11 @@ impl<'tcx> LayoutCx<'tcx, TyCtxt<'tcx>> {\n \n                 if def.is_union() {\n                     if def.repr.pack.is_some() && def.repr.align.is_some() {\n-                        bug!(\"union cannot be packed and aligned\");\n+                        self.tcx.sess.delay_span_bug(\n+                            tcx.def_span(def.did),\n+                            \"union cannot be packed and aligned\",\n+                        );\n+                        return Err(LayoutError::Unknown(ty));\n                     }\n \n                     let mut align ="}, {"sha": "ed82b6a742c8de7aebef7428e7ccb52728431e70", "filename": "src/test/ui/conflicting-repr-hints.rs", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/d49f977ed9fef7bc0734693eb6f6b1f41b72735e/src%2Ftest%2Fui%2Fconflicting-repr-hints.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d49f977ed9fef7bc0734693eb6f6b1f41b72735e/src%2Ftest%2Fui%2Fconflicting-repr-hints.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconflicting-repr-hints.rs?ref=d49f977ed9fef7bc0734693eb6f6b1f41b72735e", "patch": "@@ -66,4 +66,15 @@ union Z {\n     i: i32,\n }\n \n+#[repr(packed, align(0x100))]\n+pub struct S(u16); //~ ERROR type has conflicting packed and align representation hints\n+\n+#[repr(packed, align(0x100))]\n+pub union U { //~ ERROR type has conflicting packed and align representation hints\n+    u: u16\n+}\n+\n+static B: U = U { u: 0 };\n+static A: S = S(0);\n+\n fn main() {}"}, {"sha": "0f32fc0481bc6e251c2a581675d76a3ffa02ce63", "filename": "src/test/ui/conflicting-repr-hints.stderr", "status": "modified", "additions": 15, "deletions": 1, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/d49f977ed9fef7bc0734693eb6f6b1f41b72735e/src%2Ftest%2Fui%2Fconflicting-repr-hints.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/d49f977ed9fef7bc0734693eb6f6b1f41b72735e/src%2Ftest%2Fui%2Fconflicting-repr-hints.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconflicting-repr-hints.stderr?ref=d49f977ed9fef7bc0734693eb6f6b1f41b72735e", "patch": "@@ -74,7 +74,21 @@ LL | |     i: i32,\n LL | | }\n    | |_^\n \n-error: aborting due to 10 previous errors\n+error[E0587]: type has conflicting packed and align representation hints\n+  --> $DIR/conflicting-repr-hints.rs:70:1\n+   |\n+LL | pub struct S(u16);\n+   | ^^^^^^^^^^^^^^^^^^\n+\n+error[E0587]: type has conflicting packed and align representation hints\n+  --> $DIR/conflicting-repr-hints.rs:73:1\n+   |\n+LL | / pub union U {\n+LL | |     u: u16\n+LL | | }\n+   | |_^\n+\n+error: aborting due to 12 previous errors\n \n Some errors have detailed explanations: E0566, E0587, E0634.\n For more information about an error, try `rustc --explain E0566`."}]}