{"sha": "77af67ab64ffd3daaa255d6afff1f02bb1f5faa2", "node_id": "C_kwDOAAsO6NoAKDc3YWY2N2FiNjRmZmQzZGFhYTI1NWQ2YWZmZjFmMDJiYjFmNWZhYTI", "commit": {"author": {"name": "Zalathar", "email": "Zalathar@users.noreply.github.com", "date": "2023-04-28T11:05:17Z"}, "committer": {"name": "Zalathar", "email": "Zalathar@users.noreply.github.com", "date": "2023-05-01T01:01:12Z"}, "message": "Add `#[no_coverage]` to the test harness's `fn main`", "tree": {"sha": "ba8685bf0014b8f9ae10586315f93c3bb1ac276b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ba8685bf0014b8f9ae10586315f93c3bb1ac276b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/77af67ab64ffd3daaa255d6afff1f02bb1f5faa2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/77af67ab64ffd3daaa255d6afff1f02bb1f5faa2", "html_url": "https://github.com/rust-lang/rust/commit/77af67ab64ffd3daaa255d6afff1f02bb1f5faa2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/77af67ab64ffd3daaa255d6afff1f02bb1f5faa2/comments", "author": {"login": "Zalathar", "id": 20290842, "node_id": "MDQ6VXNlcjIwMjkwODQy", "avatar_url": "https://avatars.githubusercontent.com/u/20290842?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Zalathar", "html_url": "https://github.com/Zalathar", "followers_url": "https://api.github.com/users/Zalathar/followers", "following_url": "https://api.github.com/users/Zalathar/following{/other_user}", "gists_url": "https://api.github.com/users/Zalathar/gists{/gist_id}", "starred_url": "https://api.github.com/users/Zalathar/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Zalathar/subscriptions", "organizations_url": "https://api.github.com/users/Zalathar/orgs", "repos_url": "https://api.github.com/users/Zalathar/repos", "events_url": "https://api.github.com/users/Zalathar/events{/privacy}", "received_events_url": "https://api.github.com/users/Zalathar/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Zalathar", "id": 20290842, "node_id": "MDQ6VXNlcjIwMjkwODQy", "avatar_url": "https://avatars.githubusercontent.com/u/20290842?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Zalathar", "html_url": "https://github.com/Zalathar", "followers_url": "https://api.github.com/users/Zalathar/followers", "following_url": "https://api.github.com/users/Zalathar/following{/other_user}", "gists_url": "https://api.github.com/users/Zalathar/gists{/gist_id}", "starred_url": "https://api.github.com/users/Zalathar/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Zalathar/subscriptions", "organizations_url": "https://api.github.com/users/Zalathar/orgs", "repos_url": "https://api.github.com/users/Zalathar/repos", "events_url": "https://api.github.com/users/Zalathar/events{/privacy}", "received_events_url": "https://api.github.com/users/Zalathar/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9ecda8de85ce893cc3fc748ab06be0b8250147a7", "url": "https://api.github.com/repos/rust-lang/rust/commits/9ecda8de85ce893cc3fc748ab06be0b8250147a7", "html_url": "https://github.com/rust-lang/rust/commit/9ecda8de85ce893cc3fc748ab06be0b8250147a7"}], "stats": {"total": 28, "additions": 26, "deletions": 2}, "files": [{"sha": "9bc1e27b4ec74032c514114f09b375f6eb571f14", "filename": "compiler/rustc_builtin_macros/src/test_harness.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/77af67ab64ffd3daaa255d6afff1f02bb1f5faa2/compiler%2Frustc_builtin_macros%2Fsrc%2Ftest_harness.rs", "raw_url": "https://github.com/rust-lang/rust/raw/77af67ab64ffd3daaa255d6afff1f02bb1f5faa2/compiler%2Frustc_builtin_macros%2Fsrc%2Ftest_harness.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_builtin_macros%2Fsrc%2Ftest_harness.rs?ref=77af67ab64ffd3daaa255d6afff1f02bb1f5faa2", "patch": "@@ -232,7 +232,7 @@ fn generate_test_harness(\n     let expn_id = ext_cx.resolver.expansion_for_ast_pass(\n         DUMMY_SP,\n         AstPass::TestHarness,\n-        &[sym::test, sym::rustc_attrs],\n+        &[sym::test, sym::rustc_attrs, sym::no_coverage],\n         None,\n     );\n     let def_site = DUMMY_SP.with_def_site_ctxt(expn_id.to_expn_id());\n@@ -313,6 +313,8 @@ fn mk_main(cx: &mut TestCtxt<'_>) -> P<ast::Item> {\n \n     // #[rustc_main]\n     let main_attr = ecx.attr_word(sym::rustc_main, sp);\n+    // #[no_coverage]\n+    let no_coverage_attr = ecx.attr_word(sym::no_coverage, sp);\n \n     // pub fn main() { ... }\n     let main_ret_ty = ecx.ty(sp, ast::TyKind::Tup(ThinVec::new()));\n@@ -342,7 +344,7 @@ fn mk_main(cx: &mut TestCtxt<'_>) -> P<ast::Item> {\n \n     let main = P(ast::Item {\n         ident: main_id,\n-        attrs: thin_vec![main_attr],\n+        attrs: thin_vec![main_attr, no_coverage_attr],\n         id: ast::DUMMY_NODE_ID,\n         kind: main,\n         vis: ast::Visibility { span: sp, kind: ast::VisibilityKind::Public, tokens: None },"}, {"sha": "7d7f682130df86b6d780c3e51697e7c6f0a4dfee", "filename": "tests/pretty/tests-are-sorted.pp", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/77af67ab64ffd3daaa255d6afff1f02bb1f5faa2/tests%2Fpretty%2Ftests-are-sorted.pp", "raw_url": "https://github.com/rust-lang/rust/raw/77af67ab64ffd3daaa255d6afff1f02bb1f5faa2/tests%2Fpretty%2Ftests-are-sorted.pp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fpretty%2Ftests-are-sorted.pp?ref=77af67ab64ffd3daaa255d6afff1f02bb1f5faa2", "patch": "@@ -79,6 +79,7 @@\n     };\n fn a_test() {}\n #[rustc_main]\n+#[no_coverage]\n pub fn main() -> () {\n     extern crate test;\n     test::test_main_static(&[&a_test, &m_test, &z_test])"}, {"sha": "93bd1cfcb48971c55c1e21bb91f3c2cedeb2b5a8", "filename": "tests/run-make/coverage-reports/expected_show_coverage.test_harness.txt", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/77af67ab64ffd3daaa255d6afff1f02bb1f5faa2/tests%2Frun-make%2Fcoverage-reports%2Fexpected_show_coverage.test_harness.txt", "raw_url": "https://github.com/rust-lang/rust/raw/77af67ab64ffd3daaa255d6afff1f02bb1f5faa2/tests%2Frun-make%2Fcoverage-reports%2Fexpected_show_coverage.test_harness.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-make%2Fcoverage-reports%2Fexpected_show_coverage.test_harness.txt?ref=77af67ab64ffd3daaa255d6afff1f02bb1f5faa2", "patch": "@@ -0,0 +1,11 @@\n+    1|       |// Verify that the entry point injected by the test harness doesn't cause\n+    2|       |// weird artifacts in the coverage report (e.g. issue #10749).\n+    3|       |\n+    4|       |// compile-flags: --test\n+    5|       |\n+    6|       |#[allow(dead_code)]\n+    7|      0|fn unused() {}\n+    8|       |\n+    9|      1|#[test]\n+   10|      1|fn my_test() {}\n+"}, {"sha": "12a755734c198bd6d1b7a969c3def47c3b339ffc", "filename": "tests/run-make/coverage/test_harness.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/77af67ab64ffd3daaa255d6afff1f02bb1f5faa2/tests%2Frun-make%2Fcoverage%2Ftest_harness.rs", "raw_url": "https://github.com/rust-lang/rust/raw/77af67ab64ffd3daaa255d6afff1f02bb1f5faa2/tests%2Frun-make%2Fcoverage%2Ftest_harness.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-make%2Fcoverage%2Ftest_harness.rs?ref=77af67ab64ffd3daaa255d6afff1f02bb1f5faa2", "patch": "@@ -0,0 +1,10 @@\n+// Verify that the entry point injected by the test harness doesn't cause\n+// weird artifacts in the coverage report (e.g. issue #10749).\n+\n+// compile-flags: --test\n+\n+#[allow(dead_code)]\n+fn unused() {}\n+\n+#[test]\n+fn my_test() {}"}]}