{"sha": "32157d48f449125febaade6bda0184334b6da4fd", "node_id": "MDY6Q29tbWl0NzI0NzEyOjMyMTU3ZDQ4ZjQ0OTEyNWZlYmFhZGU2YmRhMDE4NDMzNGI2ZGE0ZmQ=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-06-11T10:18:53Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-06-11T10:18:53Z"}, "message": "Merge #4843\n\n4843: Don't guess macro expansion crate r=matklad a=matklad\n\n\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>", "tree": {"sha": "a0694e32148d1e9d6bf2264ce38d5bf280dd1769", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a0694e32148d1e9d6bf2264ce38d5bf280dd1769"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/32157d48f449125febaade6bda0184334b6da4fd", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJe4gUOCRBK7hj4Ov3rIwAAdHIIAJrK+8kgQMo0dfvoA5hL/osc\nOMTgyMI++4M7hgHVNGy9MGIvgrjx1LtR3cLGGPQAdoNt9/mN97T7tNXyXQrptv81\n+8npGXCpEUvpzIHQ9SfG9Tuv2KlY/vQXYk1VWRy7kcrMhPqDDwPQJI93z62nQLxL\nuedzbZIUB4O283NEz0mENfJrTLmpocg6VOH0YzOW9QavjnHmun8MmUwiSBNpejyi\nQX+ePAUyJe1YYAqFBtqOqMlDL0mckiXBhOdeCfEfqdD8yZwJeNcpaFdreI3j/8Kr\nUVo7fhAGCchtoS6AV9uap0WKAWvehc+hebRLjJLl6bGRrjeIMUj5Rx7G0QVNfVw=\n=M/o8\n-----END PGP SIGNATURE-----\n", "payload": "tree a0694e32148d1e9d6bf2264ce38d5bf280dd1769\nparent f320c38aec185de2a02e0febff133da1f6a3462b\nparent fac7b0e252ab305f5c8d69b04c46c587ee021aa9\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1591870733 +0000\ncommitter GitHub <noreply@github.com> 1591870733 +0000\n\nMerge #4843\n\n4843: Don't guess macro expansion crate r=matklad a=matklad\n\n\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/32157d48f449125febaade6bda0184334b6da4fd", "html_url": "https://github.com/rust-lang/rust/commit/32157d48f449125febaade6bda0184334b6da4fd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/32157d48f449125febaade6bda0184334b6da4fd/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f320c38aec185de2a02e0febff133da1f6a3462b", "url": "https://api.github.com/repos/rust-lang/rust/commits/f320c38aec185de2a02e0febff133da1f6a3462b", "html_url": "https://github.com/rust-lang/rust/commit/f320c38aec185de2a02e0febff133da1f6a3462b"}, {"sha": "fac7b0e252ab305f5c8d69b04c46c587ee021aa9", "url": "https://api.github.com/repos/rust-lang/rust/commits/fac7b0e252ab305f5c8d69b04c46c587ee021aa9", "html_url": "https://github.com/rust-lang/rust/commit/fac7b0e252ab305f5c8d69b04c46c587ee021aa9"}], "stats": {"total": 193, "additions": 116, "deletions": 77}, "files": [{"sha": "2cb34fa207adb26cc1e258ab0b5f576f49dbc9ad", "filename": "Cargo.lock", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/32157d48f449125febaade6bda0184334b6da4fd/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/32157d48f449125febaade6bda0184334b6da4fd/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=32157d48f449125febaade6bda0184334b6da4fd", "patch": "@@ -1013,6 +1013,7 @@ dependencies = [\n  \"ra_prof\",\n  \"ra_syntax\",\n  \"ra_tt\",\n+ \"rustc-hash\",\n  \"test_utils\",\n ]\n "}, {"sha": "bf26048f2adb86dfee8c092f5ca4e8e6e86d7e78", "filename": "crates/ra_db/src/input.rs", "status": "modified", "additions": 3, "deletions": 5, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/32157d48f449125febaade6bda0184334b6da4fd/crates%2Fra_db%2Fsrc%2Finput.rs", "raw_url": "https://github.com/rust-lang/rust/raw/32157d48f449125febaade6bda0184334b6da4fd/crates%2Fra_db%2Fsrc%2Finput.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_db%2Fsrc%2Finput.rs?ref=32157d48f449125febaade6bda0184334b6da4fd", "patch": "@@ -15,12 +15,10 @@ use std::{\n \n use ra_cfg::CfgOptions;\n use ra_syntax::SmolStr;\n-use rustc_hash::FxHashMap;\n-use rustc_hash::FxHashSet;\n+use ra_tt::TokenExpander;\n+use rustc_hash::{FxHashMap, FxHashSet};\n \n use crate::{RelativePath, RelativePathBuf};\n-use fmt::Display;\n-use ra_tt::TokenExpander;\n \n /// `FileId` is an integer which uniquely identifies a file. File paths are\n /// messy and system-dependent, so most of the code should work directly with\n@@ -111,7 +109,7 @@ impl CrateName {\n     }\n }\n \n-impl Display for CrateName {\n+impl fmt::Display for CrateName {\n     fn fmt(&self, f: &mut fmt::Formatter) -> fmt::Result {\n         write!(f, \"{}\", self.0)\n     }"}, {"sha": "80ddb6058afb06fd5b6ee8b812ab3bd677163f9d", "filename": "crates/ra_db/src/lib.rs", "status": "modified", "additions": 13, "deletions": 7, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/32157d48f449125febaade6bda0184334b6da4fd/crates%2Fra_db%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/32157d48f449125febaade6bda0184334b6da4fd/crates%2Fra_db%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_db%2Fsrc%2Flib.rs?ref=32157d48f449125febaade6bda0184334b6da4fd", "patch": "@@ -7,6 +7,7 @@ use std::{panic, sync::Arc};\n \n use ra_prof::profile;\n use ra_syntax::{ast, Parse, SourceFile, TextRange, TextSize};\n+use rustc_hash::FxHashSet;\n \n pub use crate::{\n     cancellation::Canceled,\n@@ -95,7 +96,7 @@ pub trait FileLoader {\n     /// `struct StrPath(str)` for clarity some day, but it's a bit messy, so we\n     /// get by with a `&str` for the time being.\n     fn resolve_path(&self, anchor: FileId, path: &str) -> Option<FileId>;\n-    fn relevant_crates(&self, file_id: FileId) -> Arc<Vec<CrateId>>;\n+    fn relevant_crates(&self, file_id: FileId) -> Arc<FxHashSet<CrateId>>;\n }\n \n /// Database which stores all significant input facts: source code and project\n@@ -133,16 +134,21 @@ pub trait SourceDatabaseExt: SourceDatabase {\n     #[salsa::input]\n     fn source_root(&self, id: SourceRootId) -> Arc<SourceRoot>;\n \n-    fn source_root_crates(&self, id: SourceRootId) -> Arc<Vec<CrateId>>;\n+    fn source_root_crates(&self, id: SourceRootId) -> Arc<FxHashSet<CrateId>>;\n }\n \n fn source_root_crates(\n     db: &(impl SourceDatabaseExt + SourceDatabase),\n     id: SourceRootId,\n-) -> Arc<Vec<CrateId>> {\n-    let root = db.source_root(id);\n+) -> Arc<FxHashSet<CrateId>> {\n     let graph = db.crate_graph();\n-    let res = root.walk().filter_map(|it| graph.crate_id_for_crate_root(it)).collect::<Vec<_>>();\n+    let res = graph\n+        .iter()\n+        .filter(|&krate| {\n+            let root_file = graph[krate].root_file_id;\n+            db.file_source_root(root_file) == id\n+        })\n+        .collect::<FxHashSet<_>>();\n     Arc::new(res)\n }\n \n@@ -156,7 +162,7 @@ impl<T: SourceDatabaseExt> FileLoader for FileLoaderDelegate<&'_ T> {\n     fn resolve_path(&self, anchor: FileId, path: &str) -> Option<FileId> {\n         // FIXME: this *somehow* should be platform agnostic...\n         if std::path::Path::new(path).is_absolute() {\n-            let krate = *self.relevant_crates(anchor).get(0)?;\n+            let krate = *self.relevant_crates(anchor).iter().next()?;\n             let (extern_source_id, relative_file) =\n                 self.0.crate_graph()[krate].extern_source.extern_path(path.as_ref())?;\n \n@@ -175,7 +181,7 @@ impl<T: SourceDatabaseExt> FileLoader for FileLoaderDelegate<&'_ T> {\n         }\n     }\n \n-    fn relevant_crates(&self, file_id: FileId) -> Arc<Vec<CrateId>> {\n+    fn relevant_crates(&self, file_id: FileId) -> Arc<FxHashSet<CrateId>> {\n         let source_root = self.0.file_source_root(file_id);\n         self.0.source_root_crates(source_root)\n     }"}, {"sha": "a232a58567ce65aa6099124f9d299ec03866026f", "filename": "crates/ra_hir/src/semantics.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/32157d48f449125febaade6bda0184334b6da4fd/crates%2Fra_hir%2Fsrc%2Fsemantics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/32157d48f449125febaade6bda0184334b6da4fd/crates%2Fra_hir%2Fsrc%2Fsemantics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fsemantics.rs?ref=32157d48f449125febaade6bda0184334b6da4fd", "patch": "@@ -122,8 +122,9 @@ impl<'db, DB: HirDatabase> Semantics<'db, DB> {\n         let macro_call =\n             self.find_file(actual_macro_call.syntax().clone()).with_value(actual_macro_call);\n         let sa = self.analyze2(macro_call.map(|it| it.syntax()), None);\n+        let krate = sa.resolver.krate()?;\n         let macro_call_id = macro_call\n-            .as_call_id(self.db, |path| sa.resolver.resolve_path_as_macro(self.db, &path))?;\n+            .as_call_id(self.db, krate, |path| sa.resolver.resolve_path_as_macro(self.db, &path))?;\n         hir_expand::db::expand_hypothetical(self.db, macro_call_id, hypothetical_args, token_to_map)\n     }\n "}, {"sha": "7c6bbea13c2941a29c226ff7a61b4a16a7cb46a5", "filename": "crates/ra_hir/src/source_analyzer.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/32157d48f449125febaade6bda0184334b6da4fd/crates%2Fra_hir%2Fsrc%2Fsource_analyzer.rs", "raw_url": "https://github.com/rust-lang/rust/raw/32157d48f449125febaade6bda0184334b6da4fd/crates%2Fra_hir%2Fsrc%2Fsource_analyzer.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fsource_analyzer.rs?ref=32157d48f449125febaade6bda0184334b6da4fd", "patch": "@@ -307,7 +307,8 @@ impl SourceAnalyzer {\n         db: &dyn HirDatabase,\n         macro_call: InFile<&ast::MacroCall>,\n     ) -> Option<HirFileId> {\n-        let macro_call_id = macro_call.as_call_id(db.upcast(), |path| {\n+        let krate = self.resolver.krate()?;\n+        let macro_call_id = macro_call.as_call_id(db.upcast(), krate, |path| {\n             self.resolver.resolve_path_as_macro(db.upcast(), &path)\n         })?;\n         Some(macro_call_id.as_file())"}, {"sha": "4f2350915dcb76ec3ce6009b6e3a792f8aacacfa", "filename": "crates/ra_hir_def/src/body.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/32157d48f449125febaade6bda0184334b6da4fd/crates%2Fra_hir_def%2Fsrc%2Fbody.rs", "raw_url": "https://github.com/rust-lang/rust/raw/32157d48f449125febaade6bda0184334b6da4fd/crates%2Fra_hir_def%2Fsrc%2Fbody.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_def%2Fsrc%2Fbody.rs?ref=32157d48f449125febaade6bda0184334b6da4fd", "patch": "@@ -97,7 +97,7 @@ impl Expander {\n \n         let macro_call = InFile::new(self.current_file_id, &macro_call);\n \n-        if let Some(call_id) = macro_call.as_call_id(db, |path| {\n+        if let Some(call_id) = macro_call.as_call_id(db, self.crate_def_map.krate, |path| {\n             if let Some(local_scope) = local_scope {\n                 if let Some(def) = path.as_ident().and_then(|n| local_scope.get_legacy_macro(n)) {\n                     return Some(def);"}, {"sha": "edc59e5a80f4ca549f590b36ebddb04771d19710", "filename": "crates/ra_hir_def/src/lib.rs", "status": "modified", "additions": 8, "deletions": 3, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/32157d48f449125febaade6bda0184334b6da4fd/crates%2Fra_hir_def%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/32157d48f449125febaade6bda0184334b6da4fd/crates%2Fra_hir_def%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_def%2Fsrc%2Flib.rs?ref=32157d48f449125febaade6bda0184334b6da4fd", "patch": "@@ -417,6 +417,7 @@ pub trait AsMacroCall {\n     fn as_call_id(\n         &self,\n         db: &dyn db::DefDatabase,\n+        krate: CrateId,\n         resolver: impl Fn(path::ModPath) -> Option<MacroDefId>,\n     ) -> Option<MacroCallId>;\n }\n@@ -425,13 +426,14 @@ impl AsMacroCall for InFile<&ast::MacroCall> {\n     fn as_call_id(\n         &self,\n         db: &dyn db::DefDatabase,\n+        krate: CrateId,\n         resolver: impl Fn(path::ModPath) -> Option<MacroDefId>,\n     ) -> Option<MacroCallId> {\n         let ast_id = AstId::new(self.file_id, db.ast_id_map(self.file_id).ast_id(self.value));\n         let h = Hygiene::new(db.upcast(), self.file_id);\n         let path = path::ModPath::from_src(self.value.path()?, &h)?;\n \n-        AstIdWithPath::new(ast_id.file_id, ast_id.value, path).as_call_id(db, resolver)\n+        AstIdWithPath::new(ast_id.file_id, ast_id.value, path).as_call_id(db, krate, resolver)\n     }\n }\n \n@@ -452,6 +454,7 @@ impl AsMacroCall for AstIdWithPath<ast::MacroCall> {\n     fn as_call_id(\n         &self,\n         db: &dyn db::DefDatabase,\n+        krate: CrateId,\n         resolver: impl Fn(path::ModPath) -> Option<MacroDefId>,\n     ) -> Option<MacroCallId> {\n         let def: MacroDefId = resolver(self.path.clone())?;\n@@ -461,13 +464,13 @@ impl AsMacroCall for AstIdWithPath<ast::MacroCall> {\n             let hygiene = Hygiene::new(db.upcast(), self.ast_id.file_id);\n \n             Some(\n-                expand_eager_macro(db.upcast(), macro_call, def, &|path: ast::Path| {\n+                expand_eager_macro(db.upcast(), krate, macro_call, def, &|path: ast::Path| {\n                     resolver(path::ModPath::from_src(path, &hygiene)?)\n                 })?\n                 .into(),\n             )\n         } else {\n-            Some(def.as_lazy_macro(db.upcast(), MacroCallKind::FnLike(self.ast_id)).into())\n+            Some(def.as_lazy_macro(db.upcast(), krate, MacroCallKind::FnLike(self.ast_id)).into())\n         }\n     }\n }\n@@ -476,12 +479,14 @@ impl AsMacroCall for AstIdWithPath<ast::ModuleItem> {\n     fn as_call_id(\n         &self,\n         db: &dyn db::DefDatabase,\n+        krate: CrateId,\n         resolver: impl Fn(path::ModPath) -> Option<MacroDefId>,\n     ) -> Option<MacroCallId> {\n         let def = resolver(self.path.clone())?;\n         Some(\n             def.as_lazy_macro(\n                 db.upcast(),\n+                krate,\n                 MacroCallKind::Attr(self.ast_id, self.path.segments.last()?.to_string()),\n             )\n             .into(),"}, {"sha": "976e5e5850f14e721deae0f802c8c3a898221bc3", "filename": "crates/ra_hir_def/src/nameres/collector.rs", "status": "modified", "additions": 22, "deletions": 17, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/32157d48f449125febaade6bda0184334b6da4fd/crates%2Fra_hir_def%2Fsrc%2Fnameres%2Fcollector.rs", "raw_url": "https://github.com/rust-lang/rust/raw/32157d48f449125febaade6bda0184334b6da4fd/crates%2Fra_hir_def%2Fsrc%2Fnameres%2Fcollector.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_def%2Fsrc%2Fnameres%2Fcollector.rs?ref=32157d48f449125febaade6bda0184334b6da4fd", "patch": "@@ -571,16 +571,18 @@ impl DefCollector<'_> {\n                 return false;\n             }\n \n-            if let Some(call_id) = directive.ast_id.as_call_id(self.db, |path| {\n-                let resolved_res = self.def_map.resolve_path_fp_with_macro(\n-                    self.db,\n-                    ResolveMode::Other,\n-                    directive.module_id,\n-                    &path,\n-                    BuiltinShadowMode::Module,\n-                );\n-                resolved_res.resolved_def.take_macros()\n-            }) {\n+            if let Some(call_id) =\n+                directive.ast_id.as_call_id(self.db, self.def_map.krate, |path| {\n+                    let resolved_res = self.def_map.resolve_path_fp_with_macro(\n+                        self.db,\n+                        ResolveMode::Other,\n+                        directive.module_id,\n+                        &path,\n+                        BuiltinShadowMode::Module,\n+                    );\n+                    resolved_res.resolved_def.take_macros()\n+                })\n+            {\n                 resolved.push((directive.module_id, call_id, directive.depth));\n                 res = ReachedFixedPoint::No;\n                 return false;\n@@ -589,9 +591,10 @@ impl DefCollector<'_> {\n             true\n         });\n         attribute_macros.retain(|directive| {\n-            if let Some(call_id) = directive\n-                .ast_id\n-                .as_call_id(self.db, |path| self.resolve_attribute_macro(&directive, &path))\n+            if let Some(call_id) =\n+                directive.ast_id.as_call_id(self.db, self.def_map.krate, |path| {\n+                    self.resolve_attribute_macro(&directive, &path)\n+                })\n             {\n                 resolved.push((directive.module_id, call_id, 0));\n                 res = ReachedFixedPoint::No;\n@@ -957,11 +960,13 @@ impl ModCollector<'_, '_> {\n         }\n \n         // Case 2: try to resolve in legacy scope and expand macro_rules\n-        if let Some(macro_call_id) = ast_id.as_call_id(self.def_collector.db, |path| {\n-            path.as_ident().and_then(|name| {\n-                self.def_collector.def_map[self.module_id].scope.get_legacy_macro(&name)\n+        if let Some(macro_call_id) =\n+            ast_id.as_call_id(self.def_collector.db, self.def_collector.def_map.krate, |path| {\n+                path.as_ident().and_then(|name| {\n+                    self.def_collector.def_map[self.module_id].scope.get_legacy_macro(&name)\n+                })\n             })\n-        }) {\n+        {\n             self.def_collector.unexpanded_macros.push(MacroDirective {\n                 module_id: self.module_id,\n                 ast_id,"}, {"sha": "4581d87453b2ee166dea46038a42ebc0ffd3ddd5", "filename": "crates/ra_hir_def/src/test_db.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/32157d48f449125febaade6bda0184334b6da4fd/crates%2Fra_hir_def%2Fsrc%2Ftest_db.rs", "raw_url": "https://github.com/rust-lang/rust/raw/32157d48f449125febaade6bda0184334b6da4fd/crates%2Fra_hir_def%2Fsrc%2Ftest_db.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_def%2Fsrc%2Ftest_db.rs?ref=32157d48f449125febaade6bda0184334b6da4fd", "patch": "@@ -7,6 +7,7 @@ use std::{\n \n use hir_expand::db::AstDatabase;\n use ra_db::{salsa, CrateId, FileId, FileLoader, FileLoaderDelegate, Upcast};\n+use rustc_hash::FxHashSet;\n \n use crate::db::DefDatabase;\n \n@@ -59,7 +60,7 @@ impl FileLoader for TestDB {\n     fn resolve_path(&self, anchor: FileId, path: &str) -> Option<FileId> {\n         FileLoaderDelegate(self).resolve_path(anchor, path)\n     }\n-    fn relevant_crates(&self, file_id: FileId) -> Arc<Vec<CrateId>> {\n+    fn relevant_crates(&self, file_id: FileId) -> Arc<FxHashSet<CrateId>> {\n         FileLoaderDelegate(self).relevant_crates(file_id)\n     }\n }"}, {"sha": "e5c9f3e997a7ee4a8221389003a6748a7f74ab02", "filename": "crates/ra_hir_expand/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/32157d48f449125febaade6bda0184334b6da4fd/crates%2Fra_hir_expand%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/32157d48f449125febaade6bda0184334b6da4fd/crates%2Fra_hir_expand%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_expand%2FCargo.toml?ref=32157d48f449125febaade6bda0184334b6da4fd", "patch": "@@ -10,6 +10,7 @@ doctest = false\n [dependencies]\n log = \"0.4.8\"\n either = \"1.5.3\"\n+rustc-hash = \"1.0.0\"\n \n ra_arena = { path = \"../ra_arena\" }\n ra_db = { path = \"../ra_db\" }"}, {"sha": "26b667b55715e791c0bc9bd020e3027c42989ea8", "filename": "crates/ra_hir_expand/src/builtin_derive.rs", "status": "modified", "additions": 13, "deletions": 18, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/32157d48f449125febaade6bda0184334b6da4fd/crates%2Fra_hir_expand%2Fsrc%2Fbuiltin_derive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/32157d48f449125febaade6bda0184334b6da4fd/crates%2Fra_hir_expand%2Fsrc%2Fbuiltin_derive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_expand%2Fsrc%2Fbuiltin_derive.rs?ref=32157d48f449125febaade6bda0184334b6da4fd", "patch": "@@ -8,8 +8,7 @@ use ra_syntax::{\n     match_ast,\n };\n \n-use crate::db::AstDatabase;\n-use crate::{name, quote, LazyMacroId, MacroCallId, MacroDefId, MacroDefKind};\n+use crate::{db::AstDatabase, name, quote, LazyMacroId, MacroDefId, MacroDefKind};\n \n macro_rules! register_builtin {\n     ( $($trait:ident => $expand:ident),* ) => {\n@@ -156,23 +155,13 @@ fn expand_simple_derive(\n fn find_builtin_crate(db: &dyn AstDatabase, id: LazyMacroId) -> tt::TokenTree {\n     // FIXME: make hygiene works for builtin derive macro\n     // such that $crate can be used here.\n-\n-    let m: MacroCallId = id.into();\n-    let file_id = m.as_file().original_file(db);\n     let cg = db.crate_graph();\n-    let krates = db.relevant_crates(file_id);\n-    let krate = match krates.get(0) {\n-        Some(krate) => krate,\n-        None => {\n-            let tt = quote! { core };\n-            return tt.token_trees[0].clone();\n-        }\n-    };\n+    let krate = db.lookup_intern_macro(id).krate;\n \n     // XXX\n     //  All crates except core itself should have a dependency on core,\n     //  We detect `core` by seeing whether it doesn't have such a dependency.\n-    let tt = if cg[*krate].dependencies.iter().any(|dep| dep.name == \"core\") {\n+    let tt = if cg[krate].dependencies.iter().any(|dep| dep.name == \"core\") {\n         quote! { core }\n     } else {\n         quote! { crate }\n@@ -264,10 +253,12 @@ fn partial_ord_expand(\n \n #[cfg(test)]\n mod tests {\n-    use super::*;\n-    use crate::{test_db::TestDB, AstId, MacroCallId, MacroCallKind, MacroCallLoc};\n     use name::{known, Name};\n-    use ra_db::{fixture::WithFixture, SourceDatabase};\n+    use ra_db::{fixture::WithFixture, CrateId, SourceDatabase};\n+\n+    use crate::{test_db::TestDB, AstId, MacroCallId, MacroCallKind, MacroCallLoc};\n+\n+    use super::*;\n \n     fn expand_builtin_derive(s: &str, name: Name) -> String {\n         let def = find_builtin_derive(&name).unwrap();\n@@ -291,7 +282,11 @@ mod tests {\n \n         let attr_id = AstId::new(file_id.into(), ast_id_map.ast_id(&items[0]));\n \n-        let loc = MacroCallLoc { def, kind: MacroCallKind::Attr(attr_id, name.to_string()) };\n+        let loc = MacroCallLoc {\n+            def,\n+            krate: CrateId(0),\n+            kind: MacroCallKind::Attr(attr_id, name.to_string()),\n+        };\n \n         let id: MacroCallId = db.intern_macro(loc).into();\n         let parsed = db.parse_or_expand(id.as_file()).unwrap();"}, {"sha": "b50eb347c8e42b3e021f3a21e4684d3d59d89cb6", "filename": "crates/ra_hir_expand/src/builtin_macro.rs", "status": "modified", "additions": 9, "deletions": 9, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/32157d48f449125febaade6bda0184334b6da4fd/crates%2Fra_hir_expand%2Fsrc%2Fbuiltin_macro.rs", "raw_url": "https://github.com/rust-lang/rust/raw/32157d48f449125febaade6bda0184334b6da4fd/crates%2Fra_hir_expand%2Fsrc%2Fbuiltin_macro.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_expand%2Fsrc%2Fbuiltin_macro.rs?ref=32157d48f449125febaade6bda0184334b6da4fd", "patch": "@@ -1,15 +1,14 @@\n //! Builtin macro\n-use crate::db::AstDatabase;\n use crate::{\n-    ast::{self, AstToken, HasStringValue},\n-    name, AstId, CrateId, MacroDefId, MacroDefKind, TextSize,\n+    db::AstDatabase, name, quote, AstId, CrateId, EagerMacroId, LazyMacroId, MacroCallId,\n+    MacroDefId, MacroDefKind, TextSize,\n };\n \n-use crate::{quote, EagerMacroId, LazyMacroId, MacroCallId};\n use either::Either;\n use mbe::parse_to_token_tree;\n use ra_db::FileId;\n use ra_parser::FragmentKind;\n+use ra_syntax::ast::{self, AstToken, HasStringValue};\n \n macro_rules! register_builtin {\n     ( LAZY: $(($name:ident, $kind: ident) => $expand:ident),* , EAGER: $(($e_name:ident, $e_kind: ident) => $e_expand:ident),*  ) => {\n@@ -333,10 +332,7 @@ fn include_expand(\n }\n \n fn get_env_inner(db: &dyn AstDatabase, arg_id: EagerMacroId, key: &str) -> Option<String> {\n-    let call_id: MacroCallId = arg_id.into();\n-    let original_file = call_id.as_file().original_file(db);\n-\n-    let krate = *db.relevant_crates(original_file).get(0)?;\n+    let krate = db.lookup_intern_eager_expansion(arg_id).krate;\n     db.crate_graph()[krate].env.get(key)\n }\n \n@@ -395,6 +391,7 @@ mod tests {\n \n         let expander = find_by_name(&macro_calls[0].name().unwrap().as_name()).unwrap();\n \n+        let krate = CrateId(0);\n         let file_id = match expander {\n             Either::Left(expander) => {\n                 // the first one should be a macro_rules\n@@ -407,6 +404,7 @@ mod tests {\n \n                 let loc = MacroCallLoc {\n                     def,\n+                    krate,\n                     kind: MacroCallKind::FnLike(AstId::new(\n                         file_id.into(),\n                         ast_id_map.ast_id(&macro_calls[1]),\n@@ -419,7 +417,7 @@ mod tests {\n             Either::Right(expander) => {\n                 // the first one should be a macro_rules\n                 let def = MacroDefId {\n-                    krate: Some(CrateId(0)),\n+                    krate: Some(krate),\n                     ast_id: Some(AstId::new(file_id.into(), ast_id_map.ast_id(&macro_calls[0]))),\n                     kind: MacroDefKind::BuiltInEager(expander),\n                     local_inner: false,\n@@ -433,6 +431,7 @@ mod tests {\n                         def,\n                         fragment: FragmentKind::Expr,\n                         subtree: Arc::new(parsed_args.clone()),\n+                        krate,\n                         file_id: file_id.into(),\n                     }\n                 });\n@@ -442,6 +441,7 @@ mod tests {\n                     def,\n                     fragment,\n                     subtree: Arc::new(subtree),\n+                    krate,\n                     file_id: file_id.into(),\n                 };\n "}, {"sha": "302d2b3e099c67afd2c2eb46beda4b0b142ef59c", "filename": "crates/ra_hir_expand/src/eager.rs", "status": "modified", "additions": 24, "deletions": 8, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/32157d48f449125febaade6bda0184334b6da4fd/crates%2Fra_hir_expand%2Fsrc%2Feager.rs", "raw_url": "https://github.com/rust-lang/rust/raw/32157d48f449125febaade6bda0184334b6da4fd/crates%2Fra_hir_expand%2Fsrc%2Feager.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_expand%2Fsrc%2Feager.rs?ref=32157d48f449125febaade6bda0184334b6da4fd", "patch": "@@ -25,12 +25,14 @@ use crate::{\n     EagerCallLoc, EagerMacroId, InFile, MacroCallId, MacroCallKind, MacroDefId, MacroDefKind,\n };\n \n+use ra_db::CrateId;\n use ra_parser::FragmentKind;\n use ra_syntax::{algo::SyntaxRewriter, SyntaxNode};\n use std::sync::Arc;\n \n pub fn expand_eager_macro(\n     db: &dyn AstDatabase,\n+    krate: CrateId,\n     macro_call: InFile<ast::MacroCall>,\n     def: MacroDefId,\n     resolver: &dyn Fn(ast::Path) -> Option<MacroDefId>,\n@@ -47,6 +49,7 @@ pub fn expand_eager_macro(\n             def,\n             fragment: FragmentKind::Expr,\n             subtree: Arc::new(parsed_args.clone()),\n+            krate,\n             file_id: macro_call.file_id,\n         }\n     });\n@@ -56,14 +59,20 @@ pub fn expand_eager_macro(\n     let result = eager_macro_recur(\n         db,\n         InFile::new(arg_file_id.as_file(), parsed_args.syntax_node()),\n+        krate,\n         resolver,\n     )?;\n     let subtree = to_subtree(&result)?;\n \n     if let MacroDefKind::BuiltInEager(eager) = def.kind {\n         let (subtree, fragment) = eager.expand(db, arg_id, &subtree).ok()?;\n-        let eager =\n-            EagerCallLoc { def, fragment, subtree: Arc::new(subtree), file_id: macro_call.file_id };\n+        let eager = EagerCallLoc {\n+            def,\n+            fragment,\n+            subtree: Arc::new(subtree),\n+            krate,\n+            file_id: macro_call.file_id,\n+        };\n \n         Some(db.intern_eager_expansion(eager))\n     } else {\n@@ -81,18 +90,20 @@ fn lazy_expand(\n     db: &dyn AstDatabase,\n     def: &MacroDefId,\n     macro_call: InFile<ast::MacroCall>,\n+    krate: CrateId,\n ) -> Option<InFile<SyntaxNode>> {\n     let ast_id = db.ast_id_map(macro_call.file_id).ast_id(&macro_call.value);\n \n     let id: MacroCallId =\n-        def.as_lazy_macro(db, MacroCallKind::FnLike(macro_call.with_value(ast_id))).into();\n+        def.as_lazy_macro(db, krate, MacroCallKind::FnLike(macro_call.with_value(ast_id))).into();\n \n     db.parse_or_expand(id.as_file()).map(|node| InFile::new(id.as_file(), node))\n }\n \n fn eager_macro_recur(\n     db: &dyn AstDatabase,\n     curr: InFile<SyntaxNode>,\n+    krate: CrateId,\n     macro_resolver: &dyn Fn(ast::Path) -> Option<MacroDefId>,\n ) -> Option<SyntaxNode> {\n     let original = curr.value.clone();\n@@ -105,18 +116,23 @@ fn eager_macro_recur(\n         let def: MacroDefId = macro_resolver(child.path()?)?;\n         let insert = match def.kind {\n             MacroDefKind::BuiltInEager(_) => {\n-                let id: MacroCallId =\n-                    expand_eager_macro(db, curr.with_value(child.clone()), def, macro_resolver)?\n-                        .into();\n+                let id: MacroCallId = expand_eager_macro(\n+                    db,\n+                    krate,\n+                    curr.with_value(child.clone()),\n+                    def,\n+                    macro_resolver,\n+                )?\n+                .into();\n                 db.parse_or_expand(id.as_file())?\n             }\n             MacroDefKind::Declarative\n             | MacroDefKind::BuiltIn(_)\n             | MacroDefKind::BuiltInDerive(_)\n             | MacroDefKind::CustomDerive(_) => {\n-                let expanded = lazy_expand(db, &def, curr.with_value(child.clone()))?;\n+                let expanded = lazy_expand(db, &def, curr.with_value(child.clone()), krate)?;\n                 // replace macro inside\n-                eager_macro_recur(db, expanded, macro_resolver)?\n+                eager_macro_recur(db, expanded, krate, macro_resolver)?\n             }\n         };\n "}, {"sha": "5eac2605b9c10e36eccc8e7e3e9e9e74e24c1e89", "filename": "crates/ra_hir_expand/src/lib.rs", "status": "modified", "additions": 9, "deletions": 2, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/32157d48f449125febaade6bda0184334b6da4fd/crates%2Fra_hir_expand%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/32157d48f449125febaade6bda0184334b6da4fd/crates%2Fra_hir_expand%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_expand%2Fsrc%2Flib.rs?ref=32157d48f449125febaade6bda0184334b6da4fd", "patch": "@@ -209,8 +209,13 @@ pub struct MacroDefId {\n }\n \n impl MacroDefId {\n-    pub fn as_lazy_macro(self, db: &dyn db::AstDatabase, kind: MacroCallKind) -> LazyMacroId {\n-        db.intern_macro(MacroCallLoc { def: self, kind })\n+    pub fn as_lazy_macro(\n+        self,\n+        db: &dyn db::AstDatabase,\n+        krate: CrateId,\n+        kind: MacroCallKind,\n+    ) -> LazyMacroId {\n+        db.intern_macro(MacroCallLoc { def: self, krate, kind })\n     }\n }\n \n@@ -227,6 +232,7 @@ pub enum MacroDefKind {\n #[derive(Debug, Clone, PartialEq, Eq, Hash)]\n pub struct MacroCallLoc {\n     pub(crate) def: MacroDefId,\n+    pub(crate) krate: CrateId,\n     pub(crate) kind: MacroCallKind,\n }\n \n@@ -274,6 +280,7 @@ pub struct EagerCallLoc {\n     pub(crate) def: MacroDefId,\n     pub(crate) fragment: FragmentKind,\n     pub(crate) subtree: Arc<tt::Subtree>,\n+    pub(crate) krate: CrateId,\n     pub(crate) file_id: HirFileId,\n }\n "}, {"sha": "09fc18c360f5b7edb4d3dbf3e6abb2bdfd4aa4c4", "filename": "crates/ra_hir_expand/src/test_db.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/32157d48f449125febaade6bda0184334b6da4fd/crates%2Fra_hir_expand%2Fsrc%2Ftest_db.rs", "raw_url": "https://github.com/rust-lang/rust/raw/32157d48f449125febaade6bda0184334b6da4fd/crates%2Fra_hir_expand%2Fsrc%2Ftest_db.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_expand%2Fsrc%2Ftest_db.rs?ref=32157d48f449125febaade6bda0184334b6da4fd", "patch": "@@ -6,6 +6,7 @@ use std::{\n };\n \n use ra_db::{salsa, CrateId, FileId, FileLoader, FileLoaderDelegate};\n+use rustc_hash::FxHashSet;\n \n #[salsa::database(\n     ra_db::SourceDatabaseExtStorage,\n@@ -44,7 +45,7 @@ impl FileLoader for TestDB {\n     fn resolve_path(&self, anchor: FileId, path: &str) -> Option<FileId> {\n         FileLoaderDelegate(self).resolve_path(anchor, path)\n     }\n-    fn relevant_crates(&self, file_id: FileId) -> Arc<Vec<CrateId>> {\n+    fn relevant_crates(&self, file_id: FileId) -> Arc<FxHashSet<CrateId>> {\n         FileLoaderDelegate(self).relevant_crates(file_id)\n     }\n }"}, {"sha": "ad04e3e0f908511b98f5ee199e40b1f65e80926c", "filename": "crates/ra_hir_ty/src/test_db.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/32157d48f449125febaade6bda0184334b6da4fd/crates%2Fra_hir_ty%2Fsrc%2Ftest_db.rs", "raw_url": "https://github.com/rust-lang/rust/raw/32157d48f449125febaade6bda0184334b6da4fd/crates%2Fra_hir_ty%2Fsrc%2Ftest_db.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_ty%2Fsrc%2Ftest_db.rs?ref=32157d48f449125febaade6bda0184334b6da4fd", "patch": "@@ -8,6 +8,7 @@ use std::{\n use hir_def::{db::DefDatabase, AssocItemId, ModuleDefId, ModuleId};\n use hir_expand::{db::AstDatabase, diagnostics::DiagnosticSink};\n use ra_db::{salsa, CrateId, FileId, FileLoader, FileLoaderDelegate, SourceDatabase, Upcast};\n+use rustc_hash::FxHashSet;\n use stdx::format_to;\n \n use crate::{db::HirDatabase, diagnostics::Diagnostic, expr::ExprValidator};\n@@ -73,7 +74,7 @@ impl FileLoader for TestDB {\n     fn resolve_path(&self, anchor: FileId, path: &str) -> Option<FileId> {\n         FileLoaderDelegate(self).resolve_path(anchor, path)\n     }\n-    fn relevant_crates(&self, file_id: FileId) -> Arc<Vec<CrateId>> {\n+    fn relevant_crates(&self, file_id: FileId) -> Arc<FxHashSet<CrateId>> {\n         FileLoaderDelegate(self).relevant_crates(file_id)\n     }\n }"}, {"sha": "480fd45764e9dd3d24fcaab99d51c2faf7fb51e2", "filename": "crates/ra_ide_db/src/lib.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/32157d48f449125febaade6bda0184334b6da4fd/crates%2Fra_ide_db%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/32157d48f449125febaade6bda0184334b6da4fd/crates%2Fra_ide_db%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_db%2Fsrc%2Flib.rs?ref=32157d48f449125febaade6bda0184334b6da4fd", "patch": "@@ -19,7 +19,7 @@ use ra_db::{\n     Canceled, CheckCanceled, CrateId, FileId, FileLoader, FileLoaderDelegate, SourceDatabase,\n     SourceRootId, Upcast,\n };\n-use rustc_hash::FxHashMap;\n+use rustc_hash::{FxHashMap, FxHashSet};\n \n use crate::{line_index::LineIndex, symbol_index::SymbolsDatabase};\n \n@@ -60,7 +60,7 @@ impl FileLoader for RootDatabase {\n     fn resolve_path(&self, anchor: FileId, path: &str) -> Option<FileId> {\n         FileLoaderDelegate(self).resolve_path(anchor, path)\n     }\n-    fn relevant_crates(&self, file_id: FileId) -> Arc<Vec<CrateId>> {\n+    fn relevant_crates(&self, file_id: FileId) -> Arc<FxHashSet<CrateId>> {\n         FileLoaderDelegate(self).relevant_crates(file_id)\n     }\n }"}]}