{"sha": "4f6d11804893f5cfbb6bd0809985f9c77acd9969", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRmNmQxMTgwNDg5M2Y1Y2ZiYjZiZDA4MDk5ODVmOWM3N2FjZDk5Njk=", "commit": {"author": {"name": "Oliver Schneider", "email": "git-no-reply-9879165716479413131@oli-obk.de", "date": "2018-04-13T15:56:45Z"}, "committer": {"name": "Oliver Schneider", "email": "git-no-reply-9879165716479413131@oli-obk.de", "date": "2018-04-13T15:56:45Z"}, "message": "Don't abort const eval due to long running evals, just warn", "tree": {"sha": "59eddd7e400194ab987616aeadf0b5678edfe068", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/59eddd7e400194ab987616aeadf0b5678edfe068"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4f6d11804893f5cfbb6bd0809985f9c77acd9969", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQJgBAABCgBKFiEEvpMjxK4/cnPNfesJHVy0/Fl8MAQFAlrQ0z0sHGdpdC1uby1y\nZXBseS05ODc5MTY1NzE2NDc5NDEzMTMxQG9saS1vYmsuZGUACgkQHVy0/Fl8MARe\ntw//csL9+XW/ZGd8bfQbihdKczCKzOZ+p9unAYuJ8WV2Cqj8+hj9j06lQf936Tuq\nt1zsczkaGVXco5NeeQV9tIlGYVtRIaYMp7/dDoAxOh25CH5pjf33MWT4/ZRT6o4h\na3bHcDaQsLwf6WFAYM8Lcfm1FenDr6TP4zoHfeLl9qK7Sn2vnO0gXDyjT84lUBro\nTgOshTtiN+ZOQloINAPrP6M8ap/lm2luQh00aOq29G1DNZ6THAo5X0IK8r83BkZe\nAoGeBdpAXiAFiEgZg8EOk42c+ih4U7rDbtp6NO5zwSjcevBPxoFb8gVtrTtVG72c\nVQjUBl6hJrCER4/+e90mkXB9M+Wg9+uYfqq4gfR62mgoJIhO4dFD5/+CMp2ksVN3\nVXRNHjvWqyZUobjCYiSQVudaWODe1Uu31/NRWyZ1UUQRV/N7/bs42mauvJSRnYew\nJXo365YpqVSuZjyUPZqGQqobcgapa9lCoZBRYXvwKwX/SKVObWhQTkSlOtw3Ef9K\nltQ8OPO9GWysoYoWnPpz53HRsDJ1lwHuY7XOmqlTiG+zU+8pqMQk7WNmPQRB9zrd\nGty18iUJKhTCFg87Mv0tybbKqNqW6KwJyRXphwgC61+LZ1MbaTh/ACyd3BLunFqL\nPssG4zhZObQhK1rs0a6Okee8rIY1pWc/DLZ60VtggpopzoU=\n=JmB/\n-----END PGP SIGNATURE-----", "payload": "tree 59eddd7e400194ab987616aeadf0b5678edfe068\nparent 99d4886ead646da864cff7963f540a44acd4af05\nauthor Oliver Schneider <git-no-reply-9879165716479413131@oli-obk.de> 1523635005 +0200\ncommitter Oliver Schneider <git-no-reply-9879165716479413131@oli-obk.de> 1523635005 +0200\n\nDon't abort const eval due to long running evals, just warn\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4f6d11804893f5cfbb6bd0809985f9c77acd9969", "html_url": "https://github.com/rust-lang/rust/commit/4f6d11804893f5cfbb6bd0809985f9c77acd9969", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4f6d11804893f5cfbb6bd0809985f9c77acd9969/comments", "author": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "committer": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "99d4886ead646da864cff7963f540a44acd4af05", "url": "https://api.github.com/repos/rust-lang/rust/commits/99d4886ead646da864cff7963f540a44acd4af05", "html_url": "https://github.com/rust-lang/rust/commit/99d4886ead646da864cff7963f540a44acd4af05"}], "stats": {"total": 27, "additions": 9, "deletions": 18}, "files": [{"sha": "5ba6a7246cff47fd7f47e010468ca9a682cb2542", "filename": "src/librustc/ich/impls_ty.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/4f6d11804893f5cfbb6bd0809985f9c77acd9969/src%2Flibrustc%2Fich%2Fimpls_ty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4f6d11804893f5cfbb6bd0809985f9c77acd9969/src%2Flibrustc%2Fich%2Fimpls_ty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fich%2Fimpls_ty.rs?ref=4f6d11804893f5cfbb6bd0809985f9c77acd9969", "patch": "@@ -550,7 +550,6 @@ for ::mir::interpret::EvalError<'gcx> {\n             InvalidPointerMath |\n             ReadUndefBytes |\n             DeadLocal |\n-            ExecutionTimeLimitReached |\n             StackFrameLimitReached |\n             OutOfTls |\n             TlsOutOfBounds |"}, {"sha": "b919f4d15a840a479678aafc968ffafc4cb05bfe", "filename": "src/librustc/mir/interpret/error.rs", "status": "modified", "additions": 0, "deletions": 3, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/4f6d11804893f5cfbb6bd0809985f9c77acd9969/src%2Flibrustc%2Fmir%2Finterpret%2Ferror.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4f6d11804893f5cfbb6bd0809985f9c77acd9969/src%2Flibrustc%2Fmir%2Finterpret%2Ferror.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmir%2Finterpret%2Ferror.rs?ref=4f6d11804893f5cfbb6bd0809985f9c77acd9969", "patch": "@@ -65,7 +65,6 @@ pub enum EvalErrorKind<'tcx> {\n     Intrinsic(String),\n     OverflowingMath,\n     InvalidChar(u128),\n-    ExecutionTimeLimitReached,\n     StackFrameLimitReached,\n     OutOfTls,\n     TlsOutOfBounds,\n@@ -188,8 +187,6 @@ impl<'tcx> Error for EvalError<'tcx> {\n                 \"mir not found\",\n             InvalidChar(..) =>\n                 \"tried to interpret an invalid 32-bit value as a char\",\n-            ExecutionTimeLimitReached =>\n-                \"the expression was too complex to be evaluated or resulted in an infinite loop\",\n             StackFrameLimitReached =>\n                 \"reached the configured maximum number of stack frames\",\n             OutOfTls =>"}, {"sha": "32de006459d32ca1837ad9ed54c93ae5f93b3269", "filename": "src/librustc/session/mod.rs", "status": "modified", "additions": 0, "deletions": 3, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/4f6d11804893f5cfbb6bd0809985f9c77acd9969/src%2Flibrustc%2Fsession%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4f6d11804893f5cfbb6bd0809985f9c77acd9969/src%2Flibrustc%2Fsession%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fsession%2Fmod.rs?ref=4f6d11804893f5cfbb6bd0809985f9c77acd9969", "patch": "@@ -112,8 +112,6 @@ pub struct Session {\n \n     /// The maximum number of stackframes allowed in const eval\n     pub const_eval_stack_frame_limit: usize,\n-    /// The maximum number miri steps per constant\n-    pub const_eval_step_limit: usize,\n \n     /// The metadata::creader module may inject an allocator/panic_runtime\n     /// dependency if it didn't already find one, and this tracks what was\n@@ -1103,7 +1101,6 @@ pub fn build_session_(\n         recursion_limit: Once::new(),\n         type_length_limit: Once::new(),\n         const_eval_stack_frame_limit: 100,\n-        const_eval_step_limit: 1_000_000,\n         next_node_id: OneThread::new(Cell::new(NodeId::new(1))),\n         injected_allocator: Once::new(),\n         allocator_kind: Once::new(),"}, {"sha": "7b4b7082bb6ceae41fb22c35d27e09fbe64aac2f", "filename": "src/librustc/ty/structural_impls.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/4f6d11804893f5cfbb6bd0809985f9c77acd9969/src%2Flibrustc%2Fty%2Fstructural_impls.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4f6d11804893f5cfbb6bd0809985f9c77acd9969/src%2Flibrustc%2Fty%2Fstructural_impls.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fstructural_impls.rs?ref=4f6d11804893f5cfbb6bd0809985f9c77acd9969", "patch": "@@ -509,7 +509,6 @@ impl<'a, 'tcx> Lift<'tcx> for interpret::EvalError<'a> {\n             Intrinsic(ref s) => Intrinsic(s.clone()),\n             OverflowingMath => OverflowingMath,\n             InvalidChar(c) => InvalidChar(c),\n-            ExecutionTimeLimitReached => ExecutionTimeLimitReached,\n             StackFrameLimitReached => StackFrameLimitReached,\n             OutOfTls => OutOfTls,\n             TlsOutOfBounds => TlsOutOfBounds,"}, {"sha": "7eced104bcac4f34d41ed7cb51e39f89d7acf87e", "filename": "src/librustc_mir/interpret/eval_context.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/4f6d11804893f5cfbb6bd0809985f9c77acd9969/src%2Flibrustc_mir%2Finterpret%2Feval_context.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4f6d11804893f5cfbb6bd0809985f9c77acd9969/src%2Flibrustc_mir%2Finterpret%2Feval_context.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Finterpret%2Feval_context.rs?ref=4f6d11804893f5cfbb6bd0809985f9c77acd9969", "patch": "@@ -45,7 +45,7 @@ pub struct EvalContext<'a, 'mir, 'tcx: 'a + 'mir, M: Machine<'mir, 'tcx>> {\n     /// The maximum number of terminators that may be evaluated.\n     /// This prevents infinite loops and huge computations from freezing up const eval.\n     /// Remove once halting problem is solved.\n-    pub(crate) steps_remaining: usize,\n+    pub(crate) terminators_remaining: usize,\n }\n \n /// A stack frame.\n@@ -195,7 +195,7 @@ impl<'a, 'mir, 'tcx: 'mir, M: Machine<'mir, 'tcx>> EvalContext<'a, 'mir, 'tcx, M\n             memory: Memory::new(tcx, memory_data),\n             stack: Vec::new(),\n             stack_limit: tcx.sess.const_eval_stack_frame_limit,\n-            steps_remaining: tcx.sess.const_eval_step_limit,\n+            terminators_remaining: 1_000_000,\n         }\n     }\n \n@@ -538,7 +538,7 @@ impl<'a, 'mir, 'tcx: 'mir, M: Machine<'mir, 'tcx>> EvalContext<'a, 'mir, 'tcx, M\n             }\n \n             Aggregate(ref kind, ref operands) => {\n-                self.inc_step_counter_and_check_limit(operands.len())?;\n+                self.inc_step_counter_and_check_limit(operands.len());\n \n                 let (dest, active_field_index) = match **kind {\n                     mir::AggregateKind::Adt(adt_def, variant_index, _, active_field_index) => {"}, {"sha": "f891d2b8ccb1d6f9afbb4fc7f4a9f1fe25cf6b61", "filename": "src/librustc_mir/interpret/step.rs", "status": "modified", "additions": 6, "deletions": 7, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/4f6d11804893f5cfbb6bd0809985f9c77acd9969/src%2Flibrustc_mir%2Finterpret%2Fstep.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4f6d11804893f5cfbb6bd0809985f9c77acd9969/src%2Flibrustc_mir%2Finterpret%2Fstep.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Finterpret%2Fstep.rs?ref=4f6d11804893f5cfbb6bd0809985f9c77acd9969", "patch": "@@ -8,12 +8,11 @@ use rustc::mir::interpret::EvalResult;\n use super::{EvalContext, Machine};\n \n impl<'a, 'mir, 'tcx, M: Machine<'mir, 'tcx>> EvalContext<'a, 'mir, 'tcx, M> {\n-    pub fn inc_step_counter_and_check_limit(&mut self, n: usize) -> EvalResult<'tcx> {\n-        self.steps_remaining = self.steps_remaining.saturating_sub(n);\n-        if self.steps_remaining > 0 {\n-            Ok(())\n-        } else {\n-            err!(ExecutionTimeLimitReached)\n+    pub fn inc_step_counter_and_check_limit(&mut self, n: usize) {\n+        self.terminators_remaining = self.terminators_remaining.saturating_sub(n);\n+        if self.terminators_remaining == 0 {\n+            self.tcx.sess.span_warn(self.frame().span, \"Constant evaluating a complex constant, this might take some time\");\n+            self.terminators_remaining = 1_000_000;\n         }\n     }\n \n@@ -36,7 +35,7 @@ impl<'a, 'mir, 'tcx, M: Machine<'mir, 'tcx>> EvalContext<'a, 'mir, 'tcx, M> {\n             return Ok(true);\n         }\n \n-        self.inc_step_counter_and_check_limit(1)?;\n+        self.inc_step_counter_and_check_limit(1);\n \n         let terminator = basic_block.terminator();\n         assert_eq!(old_frames, self.cur_frame());"}]}