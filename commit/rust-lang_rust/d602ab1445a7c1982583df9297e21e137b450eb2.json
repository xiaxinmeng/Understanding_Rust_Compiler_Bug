{"sha": "d602ab1445a7c1982583df9297e21e137b450eb2", "node_id": "C_kwDOAAsO6NoAKGQ2MDJhYjE0NDVhN2MxOTgyNTgzZGY5Mjk3ZTIxZTEzN2I0NTBlYjI", "commit": {"author": {"name": "Jason Newcomb", "email": "jsnewcomb@pm.me", "date": "2022-07-17T15:12:25Z"}, "committer": {"name": "Jason Newcomb", "email": "jsnewcomb@pm.me", "date": "2022-07-17T15:14:08Z"}, "message": "Don't lint `exlipicit_auto_deref` when other adjustments are needed", "tree": {"sha": "3d9fd8d79325a0342a4015ecac349666d938f527", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3d9fd8d79325a0342a4015ecac349666d938f527"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d602ab1445a7c1982583df9297e21e137b450eb2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d602ab1445a7c1982583df9297e21e137b450eb2", "html_url": "https://github.com/rust-lang/rust/commit/d602ab1445a7c1982583df9297e21e137b450eb2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d602ab1445a7c1982583df9297e21e137b450eb2/comments", "author": {"login": "Jarcho", "id": 7761774, "node_id": "MDQ6VXNlcjc3NjE3NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/7761774?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Jarcho", "html_url": "https://github.com/Jarcho", "followers_url": "https://api.github.com/users/Jarcho/followers", "following_url": "https://api.github.com/users/Jarcho/following{/other_user}", "gists_url": "https://api.github.com/users/Jarcho/gists{/gist_id}", "starred_url": "https://api.github.com/users/Jarcho/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Jarcho/subscriptions", "organizations_url": "https://api.github.com/users/Jarcho/orgs", "repos_url": "https://api.github.com/users/Jarcho/repos", "events_url": "https://api.github.com/users/Jarcho/events{/privacy}", "received_events_url": "https://api.github.com/users/Jarcho/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Jarcho", "id": 7761774, "node_id": "MDQ6VXNlcjc3NjE3NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/7761774?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Jarcho", "html_url": "https://github.com/Jarcho", "followers_url": "https://api.github.com/users/Jarcho/followers", "following_url": "https://api.github.com/users/Jarcho/following{/other_user}", "gists_url": "https://api.github.com/users/Jarcho/gists{/gist_id}", "starred_url": "https://api.github.com/users/Jarcho/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Jarcho/subscriptions", "organizations_url": "https://api.github.com/users/Jarcho/orgs", "repos_url": "https://api.github.com/users/Jarcho/repos", "events_url": "https://api.github.com/users/Jarcho/events{/privacy}", "received_events_url": "https://api.github.com/users/Jarcho/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "84e03b621522799a72f55d3e728d63aebb561139", "url": "https://api.github.com/repos/rust-lang/rust/commits/84e03b621522799a72f55d3e728d63aebb561139", "html_url": "https://github.com/rust-lang/rust/commit/84e03b621522799a72f55d3e728d63aebb561139"}], "stats": {"total": 32, "additions": 31, "deletions": 1}, "files": [{"sha": "05dbc7434855cd7a49856db6b74d3aa502af28b8", "filename": "clippy_lints/src/dereference.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/d602ab1445a7c1982583df9297e21e137b450eb2/clippy_lints%2Fsrc%2Fdereference.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d602ab1445a7c1982583df9297e21e137b450eb2/clippy_lints%2Fsrc%2Fdereference.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fdereference.rs?ref=d602ab1445a7c1982583df9297e21e137b450eb2", "patch": "@@ -357,7 +357,11 @@ impl<'tcx> LateLintPass<'tcx> for Dereferencing {\n                                 }),\n                                 StateData { span: expr.span, hir_id: expr.hir_id, position },\n                             ));\n-                        } else if position.is_deref_stable() {\n+                        } else if position.is_deref_stable()\n+                            // Auto-deref doesn't combine with other adjustments\n+                            && next_adjust.map_or(true, |a| matches!(a.kind, Adjust::Deref(_) | Adjust::Borrow(_)))\n+                            && iter.all(|a| matches!(a.kind, Adjust::Deref(_) | Adjust::Borrow(_)))\n+                        {\n                             self.state = Some((\n                                 State::Borrow { mutability },\n                                 StateData {"}, {"sha": "1e868af87cb80d94b2f6eef191ce68eca3363901", "filename": "tests/ui/explicit_auto_deref.fixed", "status": "modified", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/d602ab1445a7c1982583df9297e21e137b450eb2/tests%2Fui%2Fexplicit_auto_deref.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/d602ab1445a7c1982583df9297e21e137b450eb2/tests%2Fui%2Fexplicit_auto_deref.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fexplicit_auto_deref.fixed?ref=d602ab1445a7c1982583df9297e21e137b450eb2", "patch": "@@ -242,4 +242,17 @@ fn main() {\n     fn ret_any(x: &Box<dyn std::any::Any>) -> &dyn std::any::Any {\n         &**x\n     }\n+\n+    let x = String::new();\n+    let _: *const str = &*x;\n+\n+    struct S7([u32; 1]);\n+    impl core::ops::Deref for S7 {\n+        type Target = [u32; 1];\n+        fn deref(&self) -> &Self::Target {\n+            &self.0\n+        }\n+    }\n+    let x = S7([0]);\n+    let _: &[u32] = &*x;\n }"}, {"sha": "a2157d9b4f05ac7462d7533ff26b98bf7a2d6bbf", "filename": "tests/ui/explicit_auto_deref.rs", "status": "modified", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/d602ab1445a7c1982583df9297e21e137b450eb2/tests%2Fui%2Fexplicit_auto_deref.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d602ab1445a7c1982583df9297e21e137b450eb2/tests%2Fui%2Fexplicit_auto_deref.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fexplicit_auto_deref.rs?ref=d602ab1445a7c1982583df9297e21e137b450eb2", "patch": "@@ -242,4 +242,17 @@ fn main() {\n     fn ret_any(x: &Box<dyn std::any::Any>) -> &dyn std::any::Any {\n         &**x\n     }\n+\n+    let x = String::new();\n+    let _: *const str = &*x;\n+\n+    struct S7([u32; 1]);\n+    impl core::ops::Deref for S7 {\n+        type Target = [u32; 1];\n+        fn deref(&self) -> &Self::Target {\n+            &self.0\n+        }\n+    }\n+    let x = S7([0]);\n+    let _: &[u32] = &*x;\n }"}]}