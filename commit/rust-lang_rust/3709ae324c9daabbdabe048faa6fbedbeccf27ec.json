{"sha": "3709ae324c9daabbdabe048faa6fbedbeccf27ec", "node_id": "MDY6Q29tbWl0NzI0NzEyOjM3MDlhZTMyNGM5ZGFhYmJkYWJlMDQ4ZmFhNmZiZWRiZWNjZjI3ZWM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-04-25T20:42:11Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-04-25T20:42:11Z"}, "message": "Auto merge of #84325 - jsha:ephemeral-collapse, r=GuillaumeGomez\n\nrustdoc: make expand/collapse all ephemeral\n\nThe `[+]` in the upper right of a rustdoc page expands or collapses all toggles on the page. That state is stored across page loads, but is used inconsistently. This change explicitly stops storing or using the state.\n\nThis also moves the code for toggling display of trait implementations so that it's near the other toggling code.\n\nFixes #84318", "tree": {"sha": "8784b8d4916ddefdbc2eb7a764b6041a4a67e273", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8784b8d4916ddefdbc2eb7a764b6041a4a67e273"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3709ae324c9daabbdabe048faa6fbedbeccf27ec", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3709ae324c9daabbdabe048faa6fbedbeccf27ec", "html_url": "https://github.com/rust-lang/rust/commit/3709ae324c9daabbdabe048faa6fbedbeccf27ec", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3709ae324c9daabbdabe048faa6fbedbeccf27ec/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e7ed7e835494219eeab314ace8beef40b695ce30", "url": "https://api.github.com/repos/rust-lang/rust/commits/e7ed7e835494219eeab314ace8beef40b695ce30", "html_url": "https://github.com/rust-lang/rust/commit/e7ed7e835494219eeab314ace8beef40b695ce30"}, {"sha": "9fcfe5e0c7aaf8e6f0bdcdd36157e08dd67c8b42", "url": "https://api.github.com/repos/rust-lang/rust/commits/9fcfe5e0c7aaf8e6f0bdcdd36157e08dd67c8b42", "html_url": "https://github.com/rust-lang/rust/commit/9fcfe5e0c7aaf8e6f0bdcdd36157e08dd67c8b42"}], "stats": {"total": 46, "additions": 18, "deletions": 28}, "files": [{"sha": "d7e34ed02b3482b960ccad6cf4376514672cd8ee", "filename": "src/librustdoc/html/static/main.js", "status": "modified", "additions": 18, "deletions": 28, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/3709ae324c9daabbdabe048faa6fbedbeccf27ec/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fmain.js", "raw_url": "https://github.com/rust-lang/rust/raw/3709ae324c9daabbdabe048faa6fbedbeccf27ec/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fmain.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fmain.js?ref=3709ae324c9daabbdabe048faa6fbedbeccf27ec", "patch": "@@ -916,7 +916,6 @@ function hideThemeButtonState() {\n             return;\n         }\n         if (hasClass(innerToggle, \"will-expand\")) {\n-            updateLocalStorage(\"rustdoc-collapse\", \"false\");\n             removeClass(innerToggle, \"will-expand\");\n             onEachLazy(document.getElementsByTagName(\"details\"), function(e) {\n                 e.open = true;\n@@ -931,7 +930,6 @@ function hideThemeButtonState() {\n                 });\n             }\n         } else {\n-            updateLocalStorage(\"rustdoc-collapse\", \"true\");\n             addClass(innerToggle, \"will-expand\");\n             onEachLazy(document.getElementsByTagName(\"details\"), function(e) {\n                 e.open = false;\n@@ -1086,40 +1084,18 @@ function hideThemeButtonState() {\n         }\n     }\n \n-    function collapser(e, collapse) {\n+    function collapseNonInherent(e) {\n         // inherent impl ids are like \"impl\" or impl-<number>'.\n         // they will never be hidden by default.\n         var n = e.parentElement;\n         if (n.id.match(/^impl(?:-\\d+)?$/) === null) {\n             // Automatically minimize all non-inherent impls\n-            if (collapse || hasClass(n, \"impl\")) {\n+            if (hasClass(n, \"impl\")) {\n                 collapseDocs(e, \"hide\");\n             }\n         }\n     }\n \n-    function autoCollapse(collapse) {\n-        if (collapse) {\n-            toggleAllDocs(true);\n-        } else if (getSettingValue(\"auto-hide-trait-implementations\") !== \"false\") {\n-            var impl_list = document.getElementById(\"trait-implementations-list\");\n-\n-            if (impl_list !== null) {\n-                onEachLazy(impl_list.getElementsByClassName(\"collapse-toggle\"), function(e) {\n-                    collapser(e, collapse);\n-                });\n-            }\n-\n-            var blanket_list = document.getElementById(\"blanket-implementations-list\");\n-\n-            if (blanket_list !== null) {\n-                onEachLazy(blanket_list.getElementsByClassName(\"collapse-toggle\"), function(e) {\n-                    collapser(e, collapse);\n-                });\n-            }\n-        }\n-    }\n-\n     function insertAfter(newNode, referenceNode) {\n         referenceNode.parentNode.insertBefore(newNode, referenceNode.nextSibling);\n     }\n@@ -1178,6 +1154,22 @@ function hideThemeButtonState() {\n         var hideMethodDocs = getSettingValue(\"auto-hide-method-docs\") === \"true\";\n         var hideImplementors = getSettingValue(\"auto-collapse-implementors\") !== \"false\";\n         var hideLargeItemContents = getSettingValue(\"auto-hide-large-items\") !== \"false\";\n+        var hideTraitImplementations =\n+            getSettingValue(\"auto-hide-trait-implementations\") !== \"false\";\n+\n+        var impl_list = document.getElementById(\"trait-implementations-list\");\n+        if (impl_list !== null) {\n+            onEachLazy(impl_list.getElementsByClassName(\"collapse-toggle\"), function(e) {\n+                collapseNonInherent(e);\n+            });\n+        }\n+\n+        var blanket_list = document.getElementById(\"blanket-implementations-list\");\n+        if (blanket_list !== null) {\n+            onEachLazy(blanket_list.getElementsByClassName(\"collapse-toggle\"), function(e) {\n+                collapseNonInherent(e);\n+            });\n+        }\n \n         var func = function(e) {\n             var next = e.nextElementSibling;\n@@ -1348,8 +1340,6 @@ function hideThemeButtonState() {\n \n         onEachLazy(document.getElementsByClassName(\"docblock\"), buildToggleWrapper);\n \n-        autoCollapse(getSettingValue(\"collapse\") === \"true\");\n-\n         var pageId = getPageId();\n         if (pageId !== null) {\n             expandSection(pageId);"}]}