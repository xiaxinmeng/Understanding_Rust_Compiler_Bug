{"sha": "5c98737715f60ce180a3b607fd1b96c709f6807d", "node_id": "C_kwDOAAsO6NoAKDVjOTg3Mzc3MTVmNjBjZTE4MGEzYjYwN2ZkMWI5NmM3MDlmNjgwN2Q", "commit": {"author": {"name": "Eric Holk", "email": "ericholk@microsoft.com", "date": "2022-05-13T23:25:22Z"}, "committer": {"name": "Eric Holk", "email": "ericholk@microsoft.com", "date": "2022-05-13T23:25:22Z"}, "message": "Drop tracking: handle invalid assignments better\n\nPreviously this test case was crashing with an index out of bounds error\ndeep in the call to `needs_drop`. We avoid this by detecting clearly\ninvalid assignees in the `mutate` callback and ignoring these.", "tree": {"sha": "0a0e0ea2048b1ab1fd962e0c2f3611c543bb3feb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0a0e0ea2048b1ab1fd962e0c2f3611c543bb3feb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5c98737715f60ce180a3b607fd1b96c709f6807d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5c98737715f60ce180a3b607fd1b96c709f6807d", "html_url": "https://github.com/rust-lang/rust/commit/5c98737715f60ce180a3b607fd1b96c709f6807d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5c98737715f60ce180a3b607fd1b96c709f6807d/comments", "author": {"login": "eholk", "id": 105766, "node_id": "MDQ6VXNlcjEwNTc2Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/105766?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eholk", "html_url": "https://github.com/eholk", "followers_url": "https://api.github.com/users/eholk/followers", "following_url": "https://api.github.com/users/eholk/following{/other_user}", "gists_url": "https://api.github.com/users/eholk/gists{/gist_id}", "starred_url": "https://api.github.com/users/eholk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eholk/subscriptions", "organizations_url": "https://api.github.com/users/eholk/orgs", "repos_url": "https://api.github.com/users/eholk/repos", "events_url": "https://api.github.com/users/eholk/events{/privacy}", "received_events_url": "https://api.github.com/users/eholk/received_events", "type": "User", "site_admin": false}, "committer": {"login": "eholk", "id": 105766, "node_id": "MDQ6VXNlcjEwNTc2Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/105766?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eholk", "html_url": "https://github.com/eholk", "followers_url": "https://api.github.com/users/eholk/followers", "following_url": "https://api.github.com/users/eholk/following{/other_user}", "gists_url": "https://api.github.com/users/eholk/gists{/gist_id}", "starred_url": "https://api.github.com/users/eholk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eholk/subscriptions", "organizations_url": "https://api.github.com/users/eholk/orgs", "repos_url": "https://api.github.com/users/eholk/repos", "events_url": "https://api.github.com/users/eholk/events{/privacy}", "received_events_url": "https://api.github.com/users/eholk/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d4c364347ce65cf083d4419195b8232440928d4d", "url": "https://api.github.com/repos/rust-lang/rust/commits/d4c364347ce65cf083d4419195b8232440928d4d", "html_url": "https://github.com/rust-lang/rust/commit/d4c364347ce65cf083d4419195b8232440928d4d"}], "stats": {"total": 34, "additions": 34, "deletions": 0}, "files": [{"sha": "b3012cc677661028e39cb109efb4840a0f86b6d0", "filename": "compiler/rustc_typeck/src/check/generator_interior/drop_ranges/record_consumed_borrow.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/5c98737715f60ce180a3b607fd1b96c709f6807d/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fgenerator_interior%2Fdrop_ranges%2Frecord_consumed_borrow.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5c98737715f60ce180a3b607fd1b96c709f6807d/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fgenerator_interior%2Fdrop_ranges%2Frecord_consumed_borrow.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fgenerator_interior%2Fdrop_ranges%2Frecord_consumed_borrow.rs?ref=5c98737715f60ce180a3b607fd1b96c709f6807d", "patch": "@@ -180,6 +180,15 @@ impl<'tcx> expr_use_visitor::Delegate<'tcx> for ExprUseDelegate<'tcx> {\n         diag_expr_id: HirId,\n     ) {\n         debug!(\"mutate {assignee_place:?}; diag_expr_id={diag_expr_id:?}\");\n+\n+        if assignee_place.place.base == PlaceBase::Rvalue\n+            && assignee_place.place.projections.len() == 0\n+        {\n+            // Assigning to an Rvalue is illegal unless done through a dereference. We would have\n+            // already gotten a type error, so we will just return here.\n+            return;\n+        }\n+\n         // If the type being assigned needs dropped, then the mutation counts as a borrow\n         // since it is essentially doing `Drop::drop(&mut x); x = new_value;`.\n         if assignee_place.place.base_ty.needs_drop(self.tcx, self.param_env) {"}, {"sha": "c3423ad629f166f60b14f4a00d28aab4f04eeb7b", "filename": "src/test/ui/async-await/issue-73741-type-err-drop-tracking.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/5c98737715f60ce180a3b607fd1b96c709f6807d/src%2Ftest%2Fui%2Fasync-await%2Fissue-73741-type-err-drop-tracking.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5c98737715f60ce180a3b607fd1b96c709f6807d/src%2Ftest%2Fui%2Fasync-await%2Fissue-73741-type-err-drop-tracking.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasync-await%2Fissue-73741-type-err-drop-tracking.rs?ref=5c98737715f60ce180a3b607fd1b96c709f6807d", "patch": "@@ -0,0 +1,14 @@\n+// edition:2018\n+// compile-flags: -Zdrop-tracking\n+// Regression test for issue #73741\n+// Ensures that we don't emit spurious errors when\n+// a type error ocurrs in an `async fn`\n+\n+async fn weird() {\n+    1 = 2; //~ ERROR invalid left-hand side\n+\n+    let mut loop_count = 0;\n+    async {}.await\n+}\n+\n+fn main() {}"}, {"sha": "d4e3b6c3bf40dabbf30f22200a29cc2578dbd4d5", "filename": "src/test/ui/async-await/issue-73741-type-err-drop-tracking.stderr", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/5c98737715f60ce180a3b607fd1b96c709f6807d/src%2Ftest%2Fui%2Fasync-await%2Fissue-73741-type-err-drop-tracking.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/5c98737715f60ce180a3b607fd1b96c709f6807d/src%2Ftest%2Fui%2Fasync-await%2Fissue-73741-type-err-drop-tracking.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasync-await%2Fissue-73741-type-err-drop-tracking.stderr?ref=5c98737715f60ce180a3b607fd1b96c709f6807d", "patch": "@@ -0,0 +1,11 @@\n+error[E0070]: invalid left-hand side of assignment\n+  --> $DIR/issue-73741-type-err-drop-tracking.rs:8:7\n+   |\n+LL |     1 = 2;\n+   |     - ^\n+   |     |\n+   |     cannot assign to this expression\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0070`."}]}