{"sha": "3da3d15f9f150dafd7d635859795c4c714e7b7ad", "node_id": "MDY6Q29tbWl0NzI0NzEyOjNkYTNkMTVmOWYxNTBkYWZkN2Q2MzU4NTk3OTVjNGM3MTRlN2I3YWQ=", "commit": {"author": {"name": "Sam Elliott", "email": "selliott@lowrisc.org", "date": "2020-05-30T17:24:19Z"}, "committer": {"name": "Sam Elliott", "email": "selliott@lowrisc.org", "date": "2020-05-30T17:24:19Z"}, "message": "[RISC-V] Do not force frame pointers\n\nWe have been seeing some very inefficient code that went away when using\n`-Cforce-frame-pointers=no`. For instance `core::ptr::drop_in_place` at\n`-Oz` was compiled into a function which consisted entirely of saving\nregisters to the stack, then using the frame pointer to restore the same\nregisters (without any instructions between the prolog and epilog).\n\nThe RISC-V LLVM backend supports frame pointer elimination, so it makes\nsense to allow this to happen when using Rust. It's not clear to me that\nframe pointers have ever been required in the general case.\n\nIn rust-lang/rust#61675 it was pointed out that this made reassembling\nstack traces easier, which is true, but there is a code generation\noption for forcing frame pointers, and I feel the default should not be\nto require frame pointers, given it demonstrably makes code size worse\n(around 10% in some embedded applications).\n\nThe kinds of targets mentioned in rust-lang/rust#61675 are popular, but\nshould not dictate that code generation should be worse for all RISC-V\ntargets, especially as there is a way to use CFI information to\nreconstruct the stack when the frame pointer is eliminated. It is also\na misconception that `fp` is always used for the frame pointer. `fp` is\nan ABI name for `x8` (aka `s0`), and if no frame pointer is required,\n`x8` may be used for other callee-saved values.\n\nThis commit does ensure that the standard library is built with unwind\ntables, so that users do not need to rebuild the standard library in\norder to get a backtrace that includes standard library calls (which is\nthe original reason for forcing frame pointers).", "tree": {"sha": "3a05190a0d9068249309c8e200556d387b67a15c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3a05190a0d9068249309c8e200556d387b67a15c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3da3d15f9f150dafd7d635859795c4c714e7b7ad", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3da3d15f9f150dafd7d635859795c4c714e7b7ad", "html_url": "https://github.com/rust-lang/rust/commit/3da3d15f9f150dafd7d635859795c4c714e7b7ad", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3da3d15f9f150dafd7d635859795c4c714e7b7ad/comments", "author": {"login": "lenary", "id": 14548, "node_id": "MDQ6VXNlcjE0NTQ4", "avatar_url": "https://avatars.githubusercontent.com/u/14548?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lenary", "html_url": "https://github.com/lenary", "followers_url": "https://api.github.com/users/lenary/followers", "following_url": "https://api.github.com/users/lenary/following{/other_user}", "gists_url": "https://api.github.com/users/lenary/gists{/gist_id}", "starred_url": "https://api.github.com/users/lenary/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lenary/subscriptions", "organizations_url": "https://api.github.com/users/lenary/orgs", "repos_url": "https://api.github.com/users/lenary/repos", "events_url": "https://api.github.com/users/lenary/events{/privacy}", "received_events_url": "https://api.github.com/users/lenary/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lenary", "id": 14548, "node_id": "MDQ6VXNlcjE0NTQ4", "avatar_url": "https://avatars.githubusercontent.com/u/14548?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lenary", "html_url": "https://github.com/lenary", "followers_url": "https://api.github.com/users/lenary/followers", "following_url": "https://api.github.com/users/lenary/following{/other_user}", "gists_url": "https://api.github.com/users/lenary/gists{/gist_id}", "starred_url": "https://api.github.com/users/lenary/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lenary/subscriptions", "organizations_url": "https://api.github.com/users/lenary/orgs", "repos_url": "https://api.github.com/users/lenary/repos", "events_url": "https://api.github.com/users/lenary/events{/privacy}", "received_events_url": "https://api.github.com/users/lenary/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "91fb72a8a9f53de2bcc5638c1358fcb552dba8ce", "url": "https://api.github.com/repos/rust-lang/rust/commits/91fb72a8a9f53de2bcc5638c1358fcb552dba8ce", "html_url": "https://github.com/rust-lang/rust/commit/91fb72a8a9f53de2bcc5638c1358fcb552dba8ce"}], "stats": {"total": 15, "additions": 10, "deletions": 5}, "files": [{"sha": "46c43be992deda36dbc3434e924cdaae7bd9cd90", "filename": "src/bootstrap/compile.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/3da3d15f9f150dafd7d635859795c4c714e7b7ad/src%2Fbootstrap%2Fcompile.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3da3d15f9f150dafd7d635859795c4c714e7b7ad/src%2Fbootstrap%2Fcompile.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcompile.rs?ref=3da3d15f9f150dafd7d635859795c4c714e7b7ad", "patch": "@@ -244,6 +244,16 @@ pub fn std_cargo(builder: &Builder<'_>, target: Interned<String>, stage: u32, ca\n     if stage >= 1 {\n         cargo.rustflag(\"-Cembed-bitcode=yes\");\n     }\n+\n+    // By default, rustc does not include unwind tables unless they are required\n+    // for a particular target. They are not required by RISC-V targets, but\n+    // compiling the standard library with them means that users can get\n+    // backtraces without having to recompile the standard library themselves.\n+    //\n+    // This choice was discussed in https://github.com/rust-lang/rust/pull/69890\n+    if target.contains(\"riscv\") {\n+        cargo.rustflag(\"-Cforce-unwind-tables=yes\");\n+    }\n }\n \n #[derive(Debug, Copy, Clone, PartialEq, Eq, Hash)]"}, {"sha": "d7b3e7e15307a9345c1095847378ec17efa3ccda", "filename": "src/librustc_target/spec/riscv32i_unknown_none_elf.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/3da3d15f9f150dafd7d635859795c4c714e7b7ad/src%2Flibrustc_target%2Fspec%2Friscv32i_unknown_none_elf.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3da3d15f9f150dafd7d635859795c4c714e7b7ad/src%2Flibrustc_target%2Fspec%2Friscv32i_unknown_none_elf.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_target%2Fspec%2Friscv32i_unknown_none_elf.rs?ref=3da3d15f9f150dafd7d635859795c4c714e7b7ad", "patch": "@@ -25,7 +25,6 @@ pub fn target() -> TargetResult {\n             relocation_model: RelocModel::Static,\n             emit_debug_gdb_scripts: false,\n             abi_blacklist: super::riscv_base::abi_blacklist(),\n-            eliminate_frame_pointer: false,\n             ..Default::default()\n         },\n     })"}, {"sha": "b93b6fcf8002a0a950945fcb10ee480fd8de6d02", "filename": "src/librustc_target/spec/riscv32imac_unknown_none_elf.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/3da3d15f9f150dafd7d635859795c4c714e7b7ad/src%2Flibrustc_target%2Fspec%2Friscv32imac_unknown_none_elf.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3da3d15f9f150dafd7d635859795c4c714e7b7ad/src%2Flibrustc_target%2Fspec%2Friscv32imac_unknown_none_elf.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_target%2Fspec%2Friscv32imac_unknown_none_elf.rs?ref=3da3d15f9f150dafd7d635859795c4c714e7b7ad", "patch": "@@ -25,7 +25,6 @@ pub fn target() -> TargetResult {\n             relocation_model: RelocModel::Static,\n             emit_debug_gdb_scripts: false,\n             abi_blacklist: super::riscv_base::abi_blacklist(),\n-            eliminate_frame_pointer: false,\n             ..Default::default()\n         },\n     })"}, {"sha": "a16e7e31c6619efaa3a5943b9971766e42267866", "filename": "src/librustc_target/spec/riscv32imc_unknown_none_elf.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/3da3d15f9f150dafd7d635859795c4c714e7b7ad/src%2Flibrustc_target%2Fspec%2Friscv32imc_unknown_none_elf.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3da3d15f9f150dafd7d635859795c4c714e7b7ad/src%2Flibrustc_target%2Fspec%2Friscv32imc_unknown_none_elf.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_target%2Fspec%2Friscv32imc_unknown_none_elf.rs?ref=3da3d15f9f150dafd7d635859795c4c714e7b7ad", "patch": "@@ -25,7 +25,6 @@ pub fn target() -> TargetResult {\n             relocation_model: RelocModel::Static,\n             emit_debug_gdb_scripts: false,\n             abi_blacklist: super::riscv_base::abi_blacklist(),\n-            eliminate_frame_pointer: false,\n             ..Default::default()\n         },\n     })"}, {"sha": "e5147a12ed3204c9d2d203045c7be5daed11005e", "filename": "src/librustc_target/spec/riscv64gc_unknown_none_elf.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/3da3d15f9f150dafd7d635859795c4c714e7b7ad/src%2Flibrustc_target%2Fspec%2Friscv64gc_unknown_none_elf.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3da3d15f9f150dafd7d635859795c4c714e7b7ad/src%2Flibrustc_target%2Fspec%2Friscv64gc_unknown_none_elf.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_target%2Fspec%2Friscv64gc_unknown_none_elf.rs?ref=3da3d15f9f150dafd7d635859795c4c714e7b7ad", "patch": "@@ -26,7 +26,6 @@ pub fn target() -> TargetResult {\n             code_model: Some(CodeModel::Medium),\n             emit_debug_gdb_scripts: false,\n             abi_blacklist: super::riscv_base::abi_blacklist(),\n-            eliminate_frame_pointer: false,\n             ..Default::default()\n         },\n     })"}, {"sha": "dc056b55b38680540dae88c0c3cbcad44753b26f", "filename": "src/librustc_target/spec/riscv64imac_unknown_none_elf.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/3da3d15f9f150dafd7d635859795c4c714e7b7ad/src%2Flibrustc_target%2Fspec%2Friscv64imac_unknown_none_elf.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3da3d15f9f150dafd7d635859795c4c714e7b7ad/src%2Flibrustc_target%2Fspec%2Friscv64imac_unknown_none_elf.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_target%2Fspec%2Friscv64imac_unknown_none_elf.rs?ref=3da3d15f9f150dafd7d635859795c4c714e7b7ad", "patch": "@@ -26,7 +26,6 @@ pub fn target() -> TargetResult {\n             code_model: Some(CodeModel::Medium),\n             emit_debug_gdb_scripts: false,\n             abi_blacklist: super::riscv_base::abi_blacklist(),\n-            eliminate_frame_pointer: false,\n             ..Default::default()\n         },\n     })"}]}