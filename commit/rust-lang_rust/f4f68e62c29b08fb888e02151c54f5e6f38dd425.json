{"sha": "f4f68e62c29b08fb888e02151c54f5e6f38dd425", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY0ZjY4ZTYyYzI5YjA4ZmI4ODhlMDIxNTFjNTRmNWU2ZjM4ZGQ0MjU=", "commit": {"author": {"name": "Andr\u00e9 Oliveira", "email": "p32blo@gmail.com", "date": "2021-08-10T13:34:30Z"}, "committer": {"name": "Andr\u00e9 Oliveira", "email": "p32blo@gmail.com", "date": "2021-08-10T13:40:49Z"}, "message": "Use d3-graphviz for rendering crates graph on the extension side", "tree": {"sha": "49aa1fd21ecb251b33e83468ddc42cc25f6a281d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/49aa1fd21ecb251b33e83468ddc42cc25f6a281d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f4f68e62c29b08fb888e02151c54f5e6f38dd425", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f4f68e62c29b08fb888e02151c54f5e6f38dd425", "html_url": "https://github.com/rust-lang/rust/commit/f4f68e62c29b08fb888e02151c54f5e6f38dd425", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f4f68e62c29b08fb888e02151c54f5e6f38dd425/comments", "author": {"login": "p32blo", "id": 6619062, "node_id": "MDQ6VXNlcjY2MTkwNjI=", "avatar_url": "https://avatars.githubusercontent.com/u/6619062?v=4", "gravatar_id": "", "url": "https://api.github.com/users/p32blo", "html_url": "https://github.com/p32blo", "followers_url": "https://api.github.com/users/p32blo/followers", "following_url": "https://api.github.com/users/p32blo/following{/other_user}", "gists_url": "https://api.github.com/users/p32blo/gists{/gist_id}", "starred_url": "https://api.github.com/users/p32blo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/p32blo/subscriptions", "organizations_url": "https://api.github.com/users/p32blo/orgs", "repos_url": "https://api.github.com/users/p32blo/repos", "events_url": "https://api.github.com/users/p32blo/events{/privacy}", "received_events_url": "https://api.github.com/users/p32blo/received_events", "type": "User", "site_admin": false}, "committer": {"login": "p32blo", "id": 6619062, "node_id": "MDQ6VXNlcjY2MTkwNjI=", "avatar_url": "https://avatars.githubusercontent.com/u/6619062?v=4", "gravatar_id": "", "url": "https://api.github.com/users/p32blo", "html_url": "https://github.com/p32blo", "followers_url": "https://api.github.com/users/p32blo/followers", "following_url": "https://api.github.com/users/p32blo/following{/other_user}", "gists_url": "https://api.github.com/users/p32blo/gists{/gist_id}", "starred_url": "https://api.github.com/users/p32blo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/p32blo/subscriptions", "organizations_url": "https://api.github.com/users/p32blo/orgs", "repos_url": "https://api.github.com/users/p32blo/repos", "events_url": "https://api.github.com/users/p32blo/events{/privacy}", "received_events_url": "https://api.github.com/users/p32blo/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e1dcec0e02fdfaba47f68703bf82529165e99601", "url": "https://api.github.com/repos/rust-lang/rust/commits/e1dcec0e02fdfaba47f68703bf82529165e99601", "html_url": "https://github.com/rust-lang/rust/commit/e1dcec0e02fdfaba47f68703bf82529165e99601"}], "stats": {"total": 50, "additions": 34, "deletions": 16}, "files": [{"sha": "fd0e51ca7c793ebd53b2e0aed591ba835b0c81a6", "filename": "crates/rust-analyzer/src/handlers.rs", "status": "modified", "additions": 3, "deletions": 12, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/f4f68e62c29b08fb888e02151c54f5e6f38dd425/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f4f68e62c29b08fb888e02151c54f5e6f38dd425/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs?ref=f4f68e62c29b08fb888e02151c54f5e6f38dd425", "patch": "@@ -133,18 +133,9 @@ pub(crate) fn handle_view_crate_graph(\n     let _p = profile::span(\"handle_view_crate_graph\");\n     let dot = snap.analysis.view_crate_graph(params.full)??;\n \n-    // We shell out to `dot` to render to SVG, as there does not seem to be a pure-Rust renderer.\n-    let child = Command::new(\"dot\")\n-        .arg(\"-Tsvg\")\n-        .stdin(Stdio::piped())\n-        .stdout(Stdio::piped())\n-        .spawn()\n-        .map_err(|err| format!(\"failed to spawn `dot`: {}\", err))?;\n-    child.stdin.unwrap().write_all(dot.as_bytes())?;\n-\n-    let mut svg = String::new();\n-    child.stdout.unwrap().read_to_string(&mut svg)?;\n-    Ok(svg)\n+    eprintln!(\"{}\", dot);\n+\n+    Ok(dot)\n }\n \n pub(crate) fn handle_expand_macro("}, {"sha": "453abb6b1cf66047afe460dbd67b1165fd4a75b7", "filename": "editors/code/package.json", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/f4f68e62c29b08fb888e02151c54f5e6f38dd425/editors%2Fcode%2Fpackage.json", "raw_url": "https://github.com/rust-lang/rust/raw/f4f68e62c29b08fb888e02151c54f5e6f38dd425/editors%2Fcode%2Fpackage.json", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fpackage.json?ref=f4f68e62c29b08fb888e02151c54f5e6f38dd425", "patch": "@@ -38,7 +38,9 @@\n     \"dependencies\": {\n         \"https-proxy-agent\": \"^5.0.0\",\n         \"node-fetch\": \"^2.6.1\",\n-        \"vscode-languageclient\": \"^7.1.0-next.5\"\n+        \"vscode-languageclient\": \"^7.1.0-next.5\",\n+        \"d3\": \"^7.0.0\",\n+        \"d3-graphviz\": \"^4.0.0\"\n     },\n     \"devDependencies\": {\n         \"@types/glob\": \"^7.1.4\","}, {"sha": "6b69e5229b486a3500f2bebad5711a482cac1263", "filename": "editors/code/src/commands.ts", "status": "modified", "additions": 28, "deletions": 3, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/f4f68e62c29b08fb888e02151c54f5e6f38dd425/editors%2Fcode%2Fsrc%2Fcommands.ts", "raw_url": "https://github.com/rust-lang/rust/raw/f4f68e62c29b08fb888e02151c54f5e6f38dd425/editors%2Fcode%2Fsrc%2Fcommands.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fcommands.ts?ref=f4f68e62c29b08fb888e02151c54f5e6f38dd425", "patch": "@@ -472,12 +472,37 @@ export function viewItemTree(ctx: Ctx): Cmd {\n \n function crateGraph(ctx: Ctx, full: boolean): Cmd {\n     return async () => {\n-        const panel = vscode.window.createWebviewPanel(\"rust-analyzer.crate-graph\", \"rust-analyzer crate graph\", vscode.ViewColumn.Two);\n+        const panel = vscode.window.createWebviewPanel(\"rust-analyzer.crate-graph\", \"rust-analyzer crate graph\", vscode.ViewColumn.Two, {\n+            enableScripts: true,\n+            retainContextWhenHidden: true\n+          });\n         const params = {\n             full: full,\n         };\n-        const svg = await ctx.client.sendRequest(ra.viewCrateGraph, params);\n-        panel.webview.html = svg;\n+        const dot = await ctx.client.sendRequest(ra.viewCrateGraph, params);\n+\n+        console.log(dot);\n+\n+        const html = `\n+        <!DOCTYPE html>\n+        <meta charset=\"utf-8\">\n+\n+        <body>\n+            <script src=\"https://d3js.org/d3.v5.min.js\"></script>\n+            <script src=\"https://unpkg.com/@hpcc-js/wasm@0.3.11/dist/index.min.js\"></script>\n+            <script src=\"https://unpkg.com/d3-graphviz@3.0.5/build/d3-graphviz.js\"></script>\n+            <div id=\"graph\" style=\"text-align: center;\"></div>\n+            <script>\n+                let margin = 0;\n+                d3.select(\"#graph\").graphviz().fit(true).width(window.innerWidth - margin).height(window.innerHeight - margin)\n+                    .renderDot(\\`${dot}\\`);\n+            </script>\n+        </body>\n+        `;\n+\n+        console.log(html);\n+\n+        panel.webview.html = html;\n     };\n }\n "}]}