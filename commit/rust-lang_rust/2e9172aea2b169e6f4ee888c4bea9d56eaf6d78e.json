{"sha": "2e9172aea2b169e6f4ee888c4bea9d56eaf6d78e", "node_id": "MDY6Q29tbWl0NzI0NzEyOjJlOTE3MmFlYTJiMTY5ZTZmNGVlODg4YzRiZWE5ZDU2ZWFmNmQ3OGU=", "commit": {"author": {"name": "HMPerson1", "email": "hmperson1@gmail.com", "date": "2018-10-19T20:34:16Z"}, "committer": {"name": "HMPerson1", "email": "hmperson1@gmail.com", "date": "2018-10-19T20:34:16Z"}, "message": "Check for known array length in `needless_range_loop`", "tree": {"sha": "428cf1cbf2f32f957b81d12bba8b00580449fa11", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/428cf1cbf2f32f957b81d12bba8b00580449fa11"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2e9172aea2b169e6f4ee888c4bea9d56eaf6d78e", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQFIBAABCAAyFiEE30PRORiHa0gkBHJnH7R33dJ4Ic4FAlvKP+QUHGhtcGVyc29u\nMUBnbWFpbC5jb20ACgkQH7R33dJ4Ic6amwgAyKrlBk0/D3ZnDzqJmD62PkuXzvYE\npYa97tgE3od1L0dXAoNqXKrgxFniCaPi5lF7Fav55eSF9jY6MrzjLHpZBUbdV58E\nip16Tjg/uAOCLBaNKpZeUiJXpb+bM7gaP0cYV/QA1Dgq4+93xKhL5It3j07dQvAm\ndc5nYF6bpXYaBilu6Uar/1b4HD7pXF7XKho+sRslhwkkdOHtYpJ6ZnLI2mJps8E7\n1a3AosmNXQ2xLcCaz+2InprX/NS7S5jEFEWSS4db4NTbWY0EI22ZOyqdJdIp+Dsk\n12/Hq5bE/w8Qfkdf6RIPT0yiijRnzA6RYWN2g1twH77y011wIURswvScVQ==\n=pNGC\n-----END PGP SIGNATURE-----", "payload": "tree 428cf1cbf2f32f957b81d12bba8b00580449fa11\nparent b1d0343749bdc87e5cbbe7f1aeaa9d2a2c9dbc5b\nauthor HMPerson1 <hmperson1@gmail.com> 1539981256 -0400\ncommitter HMPerson1 <hmperson1@gmail.com> 1539981256 -0400\n\nCheck for known array length in `needless_range_loop`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2e9172aea2b169e6f4ee888c4bea9d56eaf6d78e", "html_url": "https://github.com/rust-lang/rust/commit/2e9172aea2b169e6f4ee888c4bea9d56eaf6d78e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2e9172aea2b169e6f4ee888c4bea9d56eaf6d78e/comments", "author": {"login": "HMPerson1", "id": 2219904, "node_id": "MDQ6VXNlcjIyMTk5MDQ=", "avatar_url": "https://avatars.githubusercontent.com/u/2219904?v=4", "gravatar_id": "", "url": "https://api.github.com/users/HMPerson1", "html_url": "https://github.com/HMPerson1", "followers_url": "https://api.github.com/users/HMPerson1/followers", "following_url": "https://api.github.com/users/HMPerson1/following{/other_user}", "gists_url": "https://api.github.com/users/HMPerson1/gists{/gist_id}", "starred_url": "https://api.github.com/users/HMPerson1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/HMPerson1/subscriptions", "organizations_url": "https://api.github.com/users/HMPerson1/orgs", "repos_url": "https://api.github.com/users/HMPerson1/repos", "events_url": "https://api.github.com/users/HMPerson1/events{/privacy}", "received_events_url": "https://api.github.com/users/HMPerson1/received_events", "type": "User", "site_admin": false}, "committer": {"login": "HMPerson1", "id": 2219904, "node_id": "MDQ6VXNlcjIyMTk5MDQ=", "avatar_url": "https://avatars.githubusercontent.com/u/2219904?v=4", "gravatar_id": "", "url": "https://api.github.com/users/HMPerson1", "html_url": "https://github.com/HMPerson1", "followers_url": "https://api.github.com/users/HMPerson1/followers", "following_url": "https://api.github.com/users/HMPerson1/following{/other_user}", "gists_url": "https://api.github.com/users/HMPerson1/gists{/gist_id}", "starred_url": "https://api.github.com/users/HMPerson1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/HMPerson1/subscriptions", "organizations_url": "https://api.github.com/users/HMPerson1/orgs", "repos_url": "https://api.github.com/users/HMPerson1/repos", "events_url": "https://api.github.com/users/HMPerson1/events{/privacy}", "received_events_url": "https://api.github.com/users/HMPerson1/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b1d0343749bdc87e5cbbe7f1aeaa9d2a2c9dbc5b", "url": "https://api.github.com/repos/rust-lang/rust/commits/b1d0343749bdc87e5cbbe7f1aeaa9d2a2c9dbc5b", "html_url": "https://github.com/rust-lang/rust/commit/b1d0343749bdc87e5cbbe7f1aeaa9d2a2c9dbc5b"}], "stats": {"total": 86, "additions": 79, "deletions": 7}, "files": [{"sha": "0d1b960cc1f58fa37a5a3755d5f21f457d8e183a", "filename": "clippy_lints/src/loops.rs", "status": "modified", "additions": 33, "deletions": 5, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/2e9172aea2b169e6f4ee888c4bea9d56eaf6d78e/clippy_lints%2Fsrc%2Floops.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2e9172aea2b169e6f4ee888c4bea9d56eaf6d78e/clippy_lints%2Fsrc%2Floops.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Floops.rs?ref=2e9172aea2b169e6f4ee888c4bea9d56eaf6d78e", "patch": "@@ -1068,7 +1068,7 @@ fn check_for_loop_range<'a, 'tcx>(\n \n             // linting condition: we only indexed one variable, and indexed it directly\n             if visitor.indexed_indirectly.is_empty() && visitor.indexed_directly.len() == 1 {\n-                let (indexed, indexed_extent) = visitor\n+                let (indexed, (indexed_extent, indexed_ty)) = visitor\n                     .indexed_directly\n                     .into_iter()\n                     .next()\n@@ -1119,7 +1119,7 @@ fn check_for_loop_range<'a, 'tcx>(\n                         }\n                     }\n \n-                    if is_len_call(end, indexed) {\n+                    if is_len_call(end, indexed) || is_end_eq_array_len(cx, end, limits, indexed_ty) {\n                         String::new()\n                     } else {\n                         match limits {\n@@ -1207,6 +1207,28 @@ fn is_len_call(expr: &Expr, var: Name) -> bool {\n     false\n }\n \n+fn is_end_eq_array_len(\n+    cx: &LateContext<'_, '_>,\n+    end: &Expr,\n+    limits: ast::RangeLimits,\n+    indexed_ty: Ty<'_>,\n+) -> bool {\n+    if_chain! {\n+        if let ExprKind::Lit(ref lit) = end.node;\n+        if let ast::LitKind::Int(end_int, _) = lit.node;\n+        if let ty::TyKind::Array(_, arr_len_const) = indexed_ty.sty;\n+        if let Some(arr_len) = arr_len_const.assert_usize(cx.tcx);\n+        then {\n+            return match limits {\n+                ast::RangeLimits::Closed => end_int + 1 >= arr_len.into(),\n+                ast::RangeLimits::HalfOpen => end_int >= arr_len.into(),\n+            };\n+        }\n+    }\n+\n+    false\n+}\n+\n fn check_for_loop_reverse_range<'a, 'tcx>(cx: &LateContext<'a, 'tcx>, arg: &'tcx Expr, expr: &'tcx Expr) {\n     // if this for loop is iterating over a two-sided range...\n     if let Some(higher::Range {\n@@ -1678,7 +1700,7 @@ struct VarVisitor<'a, 'tcx: 'a> {\n     indexed_indirectly: FxHashMap<Name, Option<region::Scope>>,\n     /// subset of `indexed` of vars that are indexed directly: `v[i]`\n     /// this will not contain cases like `v[calc_index(i)]` or `v[(i + 4) % N]`\n-    indexed_directly: FxHashMap<Name, Option<region::Scope>>,\n+    indexed_directly: FxHashMap<Name, (Option<region::Scope>, Ty<'tcx>)>,\n     /// Any names that are used outside an index operation.\n     /// Used to detect things like `&mut vec` used together with `vec[i]`\n     referenced: FxHashSet<Name>,\n@@ -1725,7 +1747,10 @@ impl<'a, 'tcx> VarVisitor<'a, 'tcx> {\n                                 self.indexed_indirectly.insert(seqvar.segments[0].ident.name, Some(extent));\n                             }\n                             if index_used_directly {\n-                                self.indexed_directly.insert(seqvar.segments[0].ident.name, Some(extent));\n+                                self.indexed_directly.insert(\n+                                    seqvar.segments[0].ident.name,\n+                                    (Some(extent), self.cx.tables.node_id_to_type(seqexpr.hir_id)),\n+                                );\n                             }\n                             return false;  // no need to walk further *on the variable*\n                         }\n@@ -1734,7 +1759,10 @@ impl<'a, 'tcx> VarVisitor<'a, 'tcx> {\n                                 self.indexed_indirectly.insert(seqvar.segments[0].ident.name, None);\n                             }\n                             if index_used_directly {\n-                                self.indexed_directly.insert(seqvar.segments[0].ident.name, None);\n+                                self.indexed_directly.insert(\n+                                    seqvar.segments[0].ident.name,\n+                                    (None, self.cx.tables.node_id_to_type(seqexpr.hir_id)),\n+                                );\n                             }\n                             return false;  // no need to walk further *on the variable*\n                         }"}, {"sha": "c1992bba548054c0eaea9d55d5d01595320f0fa2", "filename": "tests/ui/needless_range_loop.rs", "status": "modified", "additions": 15, "deletions": 1, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/2e9172aea2b169e6f4ee888c4bea9d56eaf6d78e/tests%2Fui%2Fneedless_range_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2e9172aea2b169e6f4ee888c4bea9d56eaf6d78e/tests%2Fui%2Fneedless_range_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fneedless_range_loop.rs?ref=2e9172aea2b169e6f4ee888c4bea9d56eaf6d78e", "patch": "@@ -13,7 +13,7 @@ fn calc_idx(i: usize) -> usize {\n }\n \n fn main() {\n-    let ns = [2, 3, 5, 7];\n+    let ns = vec![2, 3, 5, 7];\n \n     for i in 3..10 {\n         println!(\"{}\", ns[i]);\n@@ -76,4 +76,18 @@ fn main() {\n     for i in x..=x + 4 {\n         vec[i] += 1;\n     }\n+\n+    let arr = [1,2,3];\n+\n+    for i in 0..3 {\n+        println!(\"{}\", arr[i]);\n+    }\n+\n+    for i in 0..2 {\n+        println!(\"{}\", arr[i]);\n+    }\n+\n+    for i in 1..3 {\n+        println!(\"{}\", arr[i]);\n+    }\n }"}, {"sha": "688e9fc3a2c59c30d8f17361f19455df8c6f7d24", "filename": "tests/ui/needless_range_loop.stderr", "status": "modified", "additions": 31, "deletions": 1, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/2e9172aea2b169e6f4ee888c4bea9d56eaf6d78e/tests%2Fui%2Fneedless_range_loop.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2e9172aea2b169e6f4ee888c4bea9d56eaf6d78e/tests%2Fui%2Fneedless_range_loop.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fneedless_range_loop.stderr?ref=2e9172aea2b169e6f4ee888c4bea9d56eaf6d78e", "patch": "@@ -50,5 +50,35 @@ help: consider using an iterator\n 76 |     for <item> in vec.iter_mut().skip(x).take(4 + 1) {\n    |         ^^^^^^    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n-error: aborting due to 5 previous errors\n+error: the loop variable `i` is only used to index `arr`.\n+  --> $DIR/needless_range_loop.rs:82:14\n+   |\n+82 |     for i in 0..3 {\n+   |              ^^^^\n+help: consider using an iterator\n+   |\n+82 |     for <item> in &arr {\n+   |         ^^^^^^    ^^^^\n+\n+error: the loop variable `i` is only used to index `arr`.\n+  --> $DIR/needless_range_loop.rs:86:14\n+   |\n+86 |     for i in 0..2 {\n+   |              ^^^^\n+help: consider using an iterator\n+   |\n+86 |     for <item> in arr.iter().take(2) {\n+   |         ^^^^^^    ^^^^^^^^^^^^^^^^^^\n+\n+error: the loop variable `i` is only used to index `arr`.\n+  --> $DIR/needless_range_loop.rs:90:14\n+   |\n+90 |     for i in 1..3 {\n+   |              ^^^^\n+help: consider using an iterator\n+   |\n+90 |     for <item> in arr.iter().skip(1) {\n+   |         ^^^^^^    ^^^^^^^^^^^^^^^^^^\n+\n+error: aborting due to 8 previous errors\n "}]}