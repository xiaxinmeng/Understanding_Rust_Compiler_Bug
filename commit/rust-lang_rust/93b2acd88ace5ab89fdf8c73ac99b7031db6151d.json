{"sha": "93b2acd88ace5ab89fdf8c73ac99b7031db6151d", "node_id": "C_kwDOAAsO6NoAKDkzYjJhY2Q4OGFjZTVhYjg5ZmRmOGM3M2FjOTliNzAzMWRiNjE1MWQ", "commit": {"author": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-08-26T22:56:24Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-08-26T22:56:24Z"}, "message": "Rollup merge of #100744 - 5225225:migrate-rustc-mir-dataflow, r=davidtwco\n\nMigrate rustc_mir_dataflow to diagnostic structs", "tree": {"sha": "762fd889a5d1f2aa6241187dff1fb9aad40d4dea", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/762fd889a5d1f2aa6241187dff1fb9aad40d4dea"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/93b2acd88ace5ab89fdf8c73ac99b7031db6151d", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjCU+YCRBK7hj4Ov3rIwAACeQIADs6B6yxCIm8CbyFaj4YymaX\nadlc5AH/2F6zCvMztxszYzQNmDBipUWo1PI1Ang1nGYljky3dcwT/HK5vTmgZQE8\nE1IA+gPYVUm8NxJ8pwu0luBHUE99EJWyyFtulAg4qIKsIcpz/33gfIj5DjISrWEN\n/mP6XCdAAXGX+4d+8sj56Xb6++XcahbjFvQFD7dmGZXZQojAg8sFhgnsRAY72Ymt\nPV2UZ3VD0KLpHPI2pC0azEObioq4bPT0roie+2dSca7xmN/3F0BGIOC2z/F+Ht4P\nfxGaRY2BLbbs42zQ6Svu0GG1q57jdbgpEYumo+I2HrVbZgGHR4Bi4ZbGbnWm8X8=\n=hmMq\n-----END PGP SIGNATURE-----\n", "payload": "tree 762fd889a5d1f2aa6241187dff1fb9aad40d4dea\nparent b54344401adff783f93255f3263437156ef0f4bd\nparent f20cc9ae4ea6e9b5226680e93229a53468022350\nauthor Michael Goulet <michael@errs.io> 1661554584 -0700\ncommitter GitHub <noreply@github.com> 1661554584 -0700\n\nRollup merge of #100744 - 5225225:migrate-rustc-mir-dataflow, r=davidtwco\n\nMigrate rustc_mir_dataflow to diagnostic structs\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/93b2acd88ace5ab89fdf8c73ac99b7031db6151d", "html_url": "https://github.com/rust-lang/rust/commit/93b2acd88ace5ab89fdf8c73ac99b7031db6151d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/93b2acd88ace5ab89fdf8c73ac99b7031db6151d/comments", "author": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b54344401adff783f93255f3263437156ef0f4bd", "url": "https://api.github.com/repos/rust-lang/rust/commits/b54344401adff783f93255f3263437156ef0f4bd", "html_url": "https://github.com/rust-lang/rust/commit/b54344401adff783f93255f3263437156ef0f4bd"}, {"sha": "f20cc9ae4ea6e9b5226680e93229a53468022350", "url": "https://api.github.com/repos/rust-lang/rust/commits/f20cc9ae4ea6e9b5226680e93229a53468022350", "html_url": "https://github.com/rust-lang/rust/commit/f20cc9ae4ea6e9b5226680e93229a53468022350"}], "stats": {"total": 151, "additions": 129, "deletions": 22}, "files": [{"sha": "853d7102cb8e2d8ebe86e05e2072edf7a9e265b0", "filename": "Cargo.lock", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/93b2acd88ace5ab89fdf8c73ac99b7031db6151d/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/93b2acd88ace5ab89fdf8c73ac99b7031db6151d/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=93b2acd88ace5ab89fdf8c73ac99b7031db6151d", "patch": "@@ -4213,11 +4213,14 @@ dependencies = [\n  \"regex\",\n  \"rustc_ast\",\n  \"rustc_data_structures\",\n+ \"rustc_errors\",\n  \"rustc_graphviz\",\n  \"rustc_hir\",\n  \"rustc_index\",\n+ \"rustc_macros\",\n  \"rustc_middle\",\n  \"rustc_serialize\",\n+ \"rustc_session\",\n  \"rustc_span\",\n  \"rustc_target\",\n  \"smallvec\","}, {"sha": "988541525088367d86439fb99cbecf25753c2466", "filename": "compiler/rustc_error_messages/locales/en-US/mir_dataflow.ftl", "status": "added", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/93b2acd88ace5ab89fdf8c73ac99b7031db6151d/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fmir_dataflow.ftl", "raw_url": "https://github.com/rust-lang/rust/raw/93b2acd88ace5ab89fdf8c73ac99b7031db6151d/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fmir_dataflow.ftl", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fmir_dataflow.ftl?ref=93b2acd88ace5ab89fdf8c73ac99b7031db6151d", "patch": "@@ -0,0 +1,29 @@\n+mir_dataflow_path_must_end_in_filename =\n+    path must end in a filename\n+\n+mir_dataflow_unknown_formatter =\n+    unknown formatter\n+\n+mir_dataflow_duplicate_values_for =\n+    duplicate values for `{$name}`\n+\n+mir_dataflow_requires_an_argument =\n+    `{$name}` requires an argument\n+\n+mir_dataflow_stop_after_dataflow_ended_compilation =\n+    stop_after_dataflow ended compilation\n+\n+mir_dataflow_peek_must_be_place_or_ref_place =\n+    rustc_peek: argument expression must be either `place` or `&place`\n+\n+mir_dataflow_peek_must_be_not_temporary =\n+    dataflow::sanity_check cannot feed a non-temp to rustc_peek\n+\n+mir_dataflow_peek_bit_not_set =\n+    rustc_peek: bit not set\n+\n+mir_dataflow_peek_argument_not_a_local =\n+    rustc_peek: argument was not a local\n+\n+mir_dataflow_peek_argument_untracked =\n+    rustc_peek: argument untracked"}, {"sha": "b615b9dedbf0c59c7657e7874af4914b67aad96e", "filename": "compiler/rustc_error_messages/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/93b2acd88ace5ab89fdf8c73ac99b7031db6151d/compiler%2Frustc_error_messages%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/93b2acd88ace5ab89fdf8c73ac99b7031db6151d/compiler%2Frustc_error_messages%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_error_messages%2Fsrc%2Flib.rs?ref=93b2acd88ace5ab89fdf8c73ac99b7031db6151d", "patch": "@@ -47,6 +47,7 @@ fluent_messages! {\n     save_analysis => \"../locales/en-US/save_analysis.ftl\",\n     ty_utils => \"../locales/en-US/ty_utils.ftl\",\n     typeck => \"../locales/en-US/typeck.ftl\",\n+    mir_dataflow => \"../locales/en-US/mir_dataflow.ftl\",\n }\n \n pub use fluent_generated::{self as fluent, DEFAULT_LOCALE_RESOURCES};"}, {"sha": "385e9ba748fb9eeb6af6ad2bdaa2873118cb4e00", "filename": "compiler/rustc_mir_dataflow/Cargo.toml", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/93b2acd88ace5ab89fdf8c73ac99b7031db6151d/compiler%2Frustc_mir_dataflow%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/93b2acd88ace5ab89fdf8c73ac99b7031db6151d/compiler%2Frustc_mir_dataflow%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_dataflow%2FCargo.toml?ref=93b2acd88ace5ab89fdf8c73ac99b7031db6151d", "patch": "@@ -13,10 +13,13 @@ smallvec = { version = \"1.8.1\", features = [\"union\", \"may_dangle\"] }\n tracing = \"0.1\"\n rustc_ast = { path = \"../rustc_ast\" }\n rustc_data_structures = { path = \"../rustc_data_structures\" }\n+rustc_errors = { path = \"../rustc_errors\" }\n rustc_graphviz = { path = \"../rustc_graphviz\" }\n rustc_hir = { path = \"../rustc_hir\" }\n rustc_index = { path = \"../rustc_index\" }\n+rustc_macros = { path = \"../rustc_macros\" }\n rustc_middle = { path = \"../rustc_middle\" }\n rustc_serialize = { path = \"../rustc_serialize\" }\n+rustc_session = { path = \"../rustc_session\" }\n rustc_target = { path = \"../rustc_target\" }\n rustc_span = { path = \"../rustc_span\" }"}, {"sha": "cc14257876c5c86c6304fd53e04847a69f385b42", "filename": "compiler/rustc_mir_dataflow/src/errors.rs", "status": "added", "additions": 71, "deletions": 0, "changes": 71, "blob_url": "https://github.com/rust-lang/rust/blob/93b2acd88ace5ab89fdf8c73ac99b7031db6151d/compiler%2Frustc_mir_dataflow%2Fsrc%2Ferrors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/93b2acd88ace5ab89fdf8c73ac99b7031db6151d/compiler%2Frustc_mir_dataflow%2Fsrc%2Ferrors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_dataflow%2Fsrc%2Ferrors.rs?ref=93b2acd88ace5ab89fdf8c73ac99b7031db6151d", "patch": "@@ -0,0 +1,71 @@\n+use rustc_macros::SessionDiagnostic;\n+use rustc_span::{Span, Symbol};\n+\n+#[derive(SessionDiagnostic)]\n+#[diag(mir_dataflow::path_must_end_in_filename)]\n+pub(crate) struct PathMustEndInFilename {\n+    #[primary_span]\n+    pub span: Span,\n+}\n+\n+#[derive(SessionDiagnostic)]\n+#[diag(mir_dataflow::unknown_formatter)]\n+pub(crate) struct UnknownFormatter {\n+    #[primary_span]\n+    pub span: Span,\n+}\n+\n+#[derive(SessionDiagnostic)]\n+#[diag(mir_dataflow::duplicate_values_for)]\n+pub(crate) struct DuplicateValuesFor {\n+    #[primary_span]\n+    pub span: Span,\n+    pub name: Symbol,\n+}\n+\n+#[derive(SessionDiagnostic)]\n+#[diag(mir_dataflow::requires_an_argument)]\n+pub(crate) struct RequiresAnArgument {\n+    #[primary_span]\n+    pub span: Span,\n+    pub name: Symbol,\n+}\n+\n+#[derive(SessionDiagnostic)]\n+#[diag(mir_dataflow::stop_after_dataflow_ended_compilation)]\n+pub(crate) struct StopAfterDataFlowEndedCompilation;\n+\n+#[derive(SessionDiagnostic)]\n+#[diag(mir_dataflow::peek_must_be_place_or_ref_place)]\n+pub(crate) struct PeekMustBePlaceOrRefPlace {\n+    #[primary_span]\n+    pub span: Span,\n+}\n+\n+#[derive(SessionDiagnostic)]\n+#[diag(mir_dataflow::peek_must_be_not_temporary)]\n+pub(crate) struct PeekMustBeNotTemporary {\n+    #[primary_span]\n+    pub span: Span,\n+}\n+\n+#[derive(SessionDiagnostic)]\n+#[diag(mir_dataflow::peek_bit_not_set)]\n+pub(crate) struct PeekBitNotSet {\n+    #[primary_span]\n+    pub span: Span,\n+}\n+\n+#[derive(SessionDiagnostic)]\n+#[diag(mir_dataflow::peek_argument_not_a_local)]\n+pub(crate) struct PeekArgumentNotALocal {\n+    #[primary_span]\n+    pub span: Span,\n+}\n+\n+#[derive(SessionDiagnostic)]\n+#[diag(mir_dataflow::peek_argument_untracked)]\n+pub(crate) struct PeekArgumentUntracked {\n+    #[primary_span]\n+    pub span: Span,\n+}"}, {"sha": "112204c7599beb232fd34c27e60cb81dfa8858bf", "filename": "compiler/rustc_mir_dataflow/src/framework/engine.rs", "status": "modified", "additions": 7, "deletions": 6, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/93b2acd88ace5ab89fdf8c73ac99b7031db6151d/compiler%2Frustc_mir_dataflow%2Fsrc%2Fframework%2Fengine.rs", "raw_url": "https://github.com/rust-lang/rust/raw/93b2acd88ace5ab89fdf8c73ac99b7031db6151d/compiler%2Frustc_mir_dataflow%2Fsrc%2Fframework%2Fengine.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_dataflow%2Fsrc%2Fframework%2Fengine.rs?ref=93b2acd88ace5ab89fdf8c73ac99b7031db6151d", "patch": "@@ -1,5 +1,8 @@\n //! A solver for dataflow problems.\n \n+use crate::errors::{\n+    DuplicateValuesFor, PathMustEndInFilename, RequiresAnArgument, UnknownFormatter,\n+};\n use crate::framework::BitSetExt;\n \n use std::ffi::OsString;\n@@ -347,7 +350,7 @@ impl RustcMirAttrs {\n                     match path.file_name() {\n                         Some(_) => Ok(path),\n                         None => {\n-                            tcx.sess.span_err(attr.span(), \"path must end in a filename\");\n+                            tcx.sess.emit_err(PathMustEndInFilename { span: attr.span() });\n                             Err(())\n                         }\n                     }\n@@ -356,7 +359,7 @@ impl RustcMirAttrs {\n                 Self::set_field(&mut ret.formatter, tcx, &attr, |s| match s {\n                     sym::gen_kill | sym::two_phase => Ok(s),\n                     _ => {\n-                        tcx.sess.span_err(attr.span(), \"unknown formatter\");\n+                        tcx.sess.emit_err(UnknownFormatter { span: attr.span() });\n                         Err(())\n                     }\n                 })\n@@ -377,8 +380,7 @@ impl RustcMirAttrs {\n         mapper: impl FnOnce(Symbol) -> Result<T, ()>,\n     ) -> Result<(), ()> {\n         if field.is_some() {\n-            tcx.sess\n-                .span_err(attr.span(), &format!(\"duplicate values for `{}`\", attr.name_or_empty()));\n+            tcx.sess.emit_err(DuplicateValuesFor { span: attr.span(), name: attr.name_or_empty() });\n \n             return Err(());\n         }\n@@ -387,8 +389,7 @@ impl RustcMirAttrs {\n             *field = Some(mapper(s)?);\n             Ok(())\n         } else {\n-            tcx.sess\n-                .span_err(attr.span(), &format!(\"`{}` requires an argument\", attr.name_or_empty()));\n+            tcx.sess.emit_err(RequiresAnArgument { span: attr.span(), name: attr.name_or_empty() });\n             Err(())\n         }\n     }"}, {"sha": "62b712f7b8dbd32155e00ad4d2e9d94700c425c6", "filename": "compiler/rustc_mir_dataflow/src/lib.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/93b2acd88ace5ab89fdf8c73ac99b7031db6151d/compiler%2Frustc_mir_dataflow%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/93b2acd88ace5ab89fdf8c73ac99b7031db6151d/compiler%2Frustc_mir_dataflow%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_dataflow%2Fsrc%2Flib.rs?ref=93b2acd88ace5ab89fdf8c73ac99b7031db6151d", "patch": "@@ -7,6 +7,8 @@\n #![feature(stmt_expr_attributes)]\n #![feature(trusted_step)]\n #![recursion_limit = \"256\"]\n+#![deny(rustc::untranslatable_diagnostic)]\n+#![deny(rustc::diagnostic_outside_of_impl)]\n \n #[macro_use]\n extern crate tracing;\n@@ -33,6 +35,7 @@ use self::move_paths::MoveData;\n \n pub mod drop_flag_effects;\n pub mod elaborate_drops;\n+mod errors;\n mod framework;\n pub mod impls;\n pub mod move_paths;"}, {"sha": "5fb7cb6584beb159a82602718380201e25fbf85a", "filename": "compiler/rustc_mir_dataflow/src/rustc_peek.rs", "status": "modified", "additions": 12, "deletions": 16, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/93b2acd88ace5ab89fdf8c73ac99b7031db6151d/compiler%2Frustc_mir_dataflow%2Fsrc%2Frustc_peek.rs", "raw_url": "https://github.com/rust-lang/rust/raw/93b2acd88ace5ab89fdf8c73ac99b7031db6151d/compiler%2Frustc_mir_dataflow%2Fsrc%2Frustc_peek.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_dataflow%2Fsrc%2Frustc_peek.rs?ref=93b2acd88ace5ab89fdf8c73ac99b7031db6151d", "patch": "@@ -6,6 +6,10 @@ use rustc_middle::mir::MirPass;\n use rustc_middle::mir::{self, Body, Local, Location};\n use rustc_middle::ty::{self, Ty, TyCtxt};\n \n+use crate::errors::{\n+    PeekArgumentNotALocal, PeekArgumentUntracked, PeekBitNotSet, PeekMustBeNotTemporary,\n+    PeekMustBePlaceOrRefPlace, StopAfterDataFlowEndedCompilation,\n+};\n use crate::framework::BitSetExt;\n use crate::impls::{\n     DefinitelyInitializedPlaces, MaybeInitializedPlaces, MaybeLiveLocals, MaybeUninitializedPlaces,\n@@ -64,7 +68,7 @@ impl<'tcx> MirPass<'tcx> for SanityCheck {\n         }\n \n         if has_rustc_mir_with(tcx, def_id, sym::stop_after_dataflow).is_some() {\n-            tcx.sess.fatal(\"stop_after_dataflow ended compilation\");\n+            tcx.sess.emit_fatal(StopAfterDataFlowEndedCompilation);\n         }\n     }\n }\n@@ -133,9 +137,7 @@ pub fn sanity_check_via_rustc_peek<'tcx, A>(\n             }\n \n             _ => {\n-                let msg = \"rustc_peek: argument expression \\\n-                           must be either `place` or `&place`\";\n-                tcx.sess.span_err(call.span, msg);\n+                tcx.sess.emit_err(PeekMustBePlaceOrRefPlace { span: call.span });\n             }\n         }\n     }\n@@ -204,18 +206,12 @@ impl PeekCall {\n                         if let Some(local) = place.as_local() {\n                             local\n                         } else {\n-                            tcx.sess.diagnostic().span_err(\n-                                span,\n-                                \"dataflow::sanity_check cannot feed a non-temp to rustc_peek.\",\n-                            );\n+                            tcx.sess.emit_err(PeekMustBeNotTemporary { span });\n                             return None;\n                         }\n                     }\n                     _ => {\n-                        tcx.sess.diagnostic().span_err(\n-                            span,\n-                            \"dataflow::sanity_check cannot feed a non-temp to rustc_peek.\",\n-                        );\n+                        tcx.sess.emit_err(PeekMustBeNotTemporary { span });\n                         return None;\n                     }\n                 };\n@@ -255,12 +251,12 @@ where\n                 let bit_state = flow_state.contains(peek_mpi);\n                 debug!(\"rustc_peek({:?} = &{:?}) bit_state: {}\", call.arg, place, bit_state);\n                 if !bit_state {\n-                    tcx.sess.span_err(call.span, \"rustc_peek: bit not set\");\n+                    tcx.sess.emit_err(PeekBitNotSet { span: call.span });\n                 }\n             }\n \n             LookupResult::Parent(..) => {\n-                tcx.sess.span_err(call.span, \"rustc_peek: argument untracked\");\n+                tcx.sess.emit_err(PeekArgumentUntracked { span: call.span });\n             }\n         }\n     }\n@@ -276,12 +272,12 @@ impl<'tcx> RustcPeekAt<'tcx> for MaybeLiveLocals {\n     ) {\n         info!(?place, \"peek_at\");\n         let Some(local) = place.as_local() else {\n-            tcx.sess.span_err(call.span, \"rustc_peek: argument was not a local\");\n+            tcx.sess.emit_err(PeekArgumentNotALocal { span: call.span });\n             return;\n         };\n \n         if !flow_state.contains(local) {\n-            tcx.sess.span_err(call.span, \"rustc_peek: bit not set\");\n+            tcx.sess.emit_err(PeekBitNotSet { span: call.span });\n         }\n     }\n }"}]}