{"sha": "ccb6290e437bdeccbd509795f00a2390dad1fbeb", "node_id": "C_kwDOAAsO6NoAKGNjYjYyOTBlNDM3YmRlY2NiZDUwOTc5NWYwMGEyMzkwZGFkMWZiZWI", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-04-22T07:43:43Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-04-22T07:43:43Z"}, "message": "Auto merge of #110567 - JohnBobbo96:monomorphize-dyn-dispatch, r=b-naber\n\nRemove some uses of dynamic dispatch during monomorphization/partitioning.\n\nThis removes a few uses of dynamic dispatch and instead uses generics, as well as an enum to allow for other partitioning methods to be added later.", "tree": {"sha": "4fd0c37a0690f17b6f8eb7ab8cc95cc20f85bd3f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4fd0c37a0690f17b6f8eb7ab8cc95cc20f85bd3f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ccb6290e437bdeccbd509795f00a2390dad1fbeb", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ccb6290e437bdeccbd509795f00a2390dad1fbeb", "html_url": "https://github.com/rust-lang/rust/commit/ccb6290e437bdeccbd509795f00a2390dad1fbeb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ccb6290e437bdeccbd509795f00a2390dad1fbeb/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3128fd8ddfde44f09f7c3920c552122f5aec2395", "url": "https://api.github.com/repos/rust-lang/rust/commits/3128fd8ddfde44f09f7c3920c552122f5aec2395", "html_url": "https://github.com/rust-lang/rust/commit/3128fd8ddfde44f09f7c3920c552122f5aec2395"}, {"sha": "8a7a020a2a11dabf566552c78faf8174e34fc1ec", "url": "https://api.github.com/repos/rust-lang/rust/commits/8a7a020a2a11dabf566552c78faf8174e34fc1ec", "html_url": "https://github.com/rust-lang/rust/commit/8a7a020a2a11dabf566552c78faf8174e34fc1ec"}], "stats": {"total": 111, "additions": 91, "deletions": 20}, "files": [{"sha": "bd24deb590a711229f889668c5d69d865ae15ddb", "filename": "compiler/rustc_monomorphize/src/partitioning/default.rs", "status": "modified", "additions": 8, "deletions": 5, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/ccb6290e437bdeccbd509795f00a2390dad1fbeb/compiler%2Frustc_monomorphize%2Fsrc%2Fpartitioning%2Fdefault.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ccb6290e437bdeccbd509795f00a2390dad1fbeb/compiler%2Frustc_monomorphize%2Fsrc%2Fpartitioning%2Fdefault.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_monomorphize%2Fsrc%2Fpartitioning%2Fdefault.rs?ref=ccb6290e437bdeccbd509795f00a2390dad1fbeb", "patch": "@@ -16,17 +16,20 @@ use super::PartitioningCx;\n use crate::collector::InliningMap;\n use crate::partitioning::merging;\n use crate::partitioning::{\n-    MonoItemPlacement, Partitioner, PostInliningPartitioning, PreInliningPartitioning,\n+    MonoItemPlacement, Partition, PostInliningPartitioning, PreInliningPartitioning,\n };\n \n pub struct DefaultPartitioning;\n \n-impl<'tcx> Partitioner<'tcx> for DefaultPartitioning {\n-    fn place_root_mono_items(\n+impl<'tcx> Partition<'tcx> for DefaultPartitioning {\n+    fn place_root_mono_items<I>(\n         &mut self,\n         cx: &PartitioningCx<'_, 'tcx>,\n-        mono_items: &mut dyn Iterator<Item = MonoItem<'tcx>>,\n-    ) -> PreInliningPartitioning<'tcx> {\n+        mono_items: &mut I,\n+    ) -> PreInliningPartitioning<'tcx>\n+    where\n+        I: Iterator<Item = MonoItem<'tcx>>,\n+    {\n         let mut roots = FxHashSet::default();\n         let mut codegen_units = FxHashMap::default();\n         let is_incremental_build = cx.tcx.sess.opts.incremental.is_some();"}, {"sha": "993e35c7fd251e37486131be97b39480bdc2b924", "filename": "compiler/rustc_monomorphize/src/partitioning/mod.rs", "status": "modified", "additions": 83, "deletions": 15, "changes": 98, "blob_url": "https://github.com/rust-lang/rust/blob/ccb6290e437bdeccbd509795f00a2390dad1fbeb/compiler%2Frustc_monomorphize%2Fsrc%2Fpartitioning%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ccb6290e437bdeccbd509795f00a2390dad1fbeb/compiler%2Frustc_monomorphize%2Fsrc%2Fpartitioning%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_monomorphize%2Fsrc%2Fpartitioning%2Fmod.rs?ref=ccb6290e437bdeccbd509795f00a2390dad1fbeb", "patch": "@@ -118,18 +118,81 @@ use crate::errors::{\n     CouldntDumpMonoStats, SymbolAlreadyDefined, UnknownCguCollectionMode, UnknownPartitionStrategy,\n };\n \n+enum Partitioner {\n+    Default(default::DefaultPartitioning),\n+    // Other partitioning strategies can go here.\n+    Unknown,\n+}\n+\n+impl<'tcx> Partition<'tcx> for Partitioner {\n+    fn place_root_mono_items<I>(\n+        &mut self,\n+        cx: &PartitioningCx<'_, 'tcx>,\n+        mono_items: &mut I,\n+    ) -> PreInliningPartitioning<'tcx>\n+    where\n+        I: Iterator<Item = MonoItem<'tcx>>,\n+    {\n+        match self {\n+            Partitioner::Default(partitioner) => partitioner.place_root_mono_items(cx, mono_items),\n+            Partitioner::Unknown => cx.tcx.sess.emit_fatal(UnknownPartitionStrategy),\n+        }\n+    }\n+\n+    fn merge_codegen_units(\n+        &mut self,\n+        cx: &PartitioningCx<'_, 'tcx>,\n+        initial_partitioning: &mut PreInliningPartitioning<'tcx>,\n+    ) {\n+        match self {\n+            Partitioner::Default(partitioner) => {\n+                partitioner.merge_codegen_units(cx, initial_partitioning)\n+            }\n+            Partitioner::Unknown => cx.tcx.sess.emit_fatal(UnknownPartitionStrategy),\n+        }\n+    }\n+\n+    fn place_inlined_mono_items(\n+        &mut self,\n+        cx: &PartitioningCx<'_, 'tcx>,\n+        initial_partitioning: PreInliningPartitioning<'tcx>,\n+    ) -> PostInliningPartitioning<'tcx> {\n+        match self {\n+            Partitioner::Default(partitioner) => {\n+                partitioner.place_inlined_mono_items(cx, initial_partitioning)\n+            }\n+            Partitioner::Unknown => cx.tcx.sess.emit_fatal(UnknownPartitionStrategy),\n+        }\n+    }\n+\n+    fn internalize_symbols(\n+        &mut self,\n+        cx: &PartitioningCx<'_, 'tcx>,\n+        post_inlining_partitioning: &mut PostInliningPartitioning<'tcx>,\n+    ) {\n+        match self {\n+            Partitioner::Default(partitioner) => {\n+                partitioner.internalize_symbols(cx, post_inlining_partitioning)\n+            }\n+            Partitioner::Unknown => cx.tcx.sess.emit_fatal(UnknownPartitionStrategy),\n+        }\n+    }\n+}\n+\n pub struct PartitioningCx<'a, 'tcx> {\n     tcx: TyCtxt<'tcx>,\n     target_cgu_count: usize,\n     inlining_map: &'a InliningMap<'tcx>,\n }\n \n-trait Partitioner<'tcx> {\n-    fn place_root_mono_items(\n+trait Partition<'tcx> {\n+    fn place_root_mono_items<I>(\n         &mut self,\n         cx: &PartitioningCx<'_, 'tcx>,\n-        mono_items: &mut dyn Iterator<Item = MonoItem<'tcx>>,\n-    ) -> PreInliningPartitioning<'tcx>;\n+        mono_items: &mut I,\n+    ) -> PreInliningPartitioning<'tcx>\n+    where\n+        I: Iterator<Item = MonoItem<'tcx>>;\n \n     fn merge_codegen_units(\n         &mut self,\n@@ -150,26 +213,27 @@ trait Partitioner<'tcx> {\n     );\n }\n \n-fn get_partitioner<'tcx>(tcx: TyCtxt<'tcx>) -> Box<dyn Partitioner<'tcx>> {\n+fn get_partitioner(tcx: TyCtxt<'_>) -> Partitioner {\n     let strategy = match &tcx.sess.opts.unstable_opts.cgu_partitioning_strategy {\n         None => \"default\",\n         Some(s) => &s[..],\n     };\n \n     match strategy {\n-        \"default\" => Box::new(default::DefaultPartitioning),\n-        _ => {\n-            tcx.sess.emit_fatal(UnknownPartitionStrategy);\n-        }\n+        \"default\" => Partitioner::Default(default::DefaultPartitioning),\n+        _ => Partitioner::Unknown,\n     }\n }\n \n-pub fn partition<'tcx>(\n+pub fn partition<'tcx, I>(\n     tcx: TyCtxt<'tcx>,\n-    mono_items: &mut dyn Iterator<Item = MonoItem<'tcx>>,\n+    mono_items: &mut I,\n     max_cgu_count: usize,\n     inlining_map: &InliningMap<'tcx>,\n-) -> Vec<CodegenUnit<'tcx>> {\n+) -> Vec<CodegenUnit<'tcx>>\n+where\n+    I: Iterator<Item = MonoItem<'tcx>>,\n+{\n     let _prof_timer = tcx.prof.generic_activity(\"cgu_partitioning\");\n \n     let mut partitioner = get_partitioner(tcx);\n@@ -182,7 +246,9 @@ pub fn partition<'tcx>(\n         partitioner.place_root_mono_items(cx, mono_items)\n     };\n \n-    initial_partitioning.codegen_units.iter_mut().for_each(|cgu| cgu.create_size_estimate(tcx));\n+    for cgu in &mut initial_partitioning.codegen_units {\n+        cgu.create_size_estimate(tcx);\n+    }\n \n     debug_dump(tcx, \"INITIAL PARTITIONING:\", initial_partitioning.codegen_units.iter());\n \n@@ -202,7 +268,9 @@ pub fn partition<'tcx>(\n         partitioner.place_inlined_mono_items(cx, initial_partitioning)\n     };\n \n-    post_inlining.codegen_units.iter_mut().for_each(|cgu| cgu.create_size_estimate(tcx));\n+    for cgu in &mut post_inlining.codegen_units {\n+        cgu.create_size_estimate(tcx);\n+    }\n \n     debug_dump(tcx, \"POST INLINING:\", post_inlining.codegen_units.iter());\n \n@@ -380,7 +448,7 @@ fn collect_and_partition_mono_items(tcx: TyCtxt<'_>, (): ()) -> (&DefIdSet, &[Co\n             || {\n                 let mut codegen_units = partition(\n                     tcx,\n-                    &mut items.iter().cloned(),\n+                    &mut items.iter().copied(),\n                     tcx.sess.codegen_units(),\n                     &inlining_map,\n                 );"}]}