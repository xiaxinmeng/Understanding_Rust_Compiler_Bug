{"sha": "e1d94b8fd1ca1a1de6a56a3c53bb105fefacdd9c", "node_id": "C_kwDOAAsO6NoAKGUxZDk0YjhmZDFjYTFhMWRlNmE1NmEzYzUzYmIxMDVmZWZhY2RkOWM", "commit": {"author": {"name": "Hudson Ayers", "email": "hayers@stanford.edu", "date": "2021-10-14T16:20:32Z"}, "committer": {"name": "Hudson Ayers", "email": "hayers@stanford.edu", "date": "2021-10-21T17:41:19Z"}, "message": "Configure saved panic locations based on location-detail flag", "tree": {"sha": "9f048326e3bdd48a2c0612317248384e7cd6b9c4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9f048326e3bdd48a2c0612317248384e7cd6b9c4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e1d94b8fd1ca1a1de6a56a3c53bb105fefacdd9c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e1d94b8fd1ca1a1de6a56a3c53bb105fefacdd9c", "html_url": "https://github.com/rust-lang/rust/commit/e1d94b8fd1ca1a1de6a56a3c53bb105fefacdd9c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e1d94b8fd1ca1a1de6a56a3c53bb105fefacdd9c/comments", "author": {"login": "hudson-ayers", "id": 32688905, "node_id": "MDQ6VXNlcjMyNjg4OTA1", "avatar_url": "https://avatars.githubusercontent.com/u/32688905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hudson-ayers", "html_url": "https://github.com/hudson-ayers", "followers_url": "https://api.github.com/users/hudson-ayers/followers", "following_url": "https://api.github.com/users/hudson-ayers/following{/other_user}", "gists_url": "https://api.github.com/users/hudson-ayers/gists{/gist_id}", "starred_url": "https://api.github.com/users/hudson-ayers/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hudson-ayers/subscriptions", "organizations_url": "https://api.github.com/users/hudson-ayers/orgs", "repos_url": "https://api.github.com/users/hudson-ayers/repos", "events_url": "https://api.github.com/users/hudson-ayers/events{/privacy}", "received_events_url": "https://api.github.com/users/hudson-ayers/received_events", "type": "User", "site_admin": false}, "committer": {"login": "hudson-ayers", "id": 32688905, "node_id": "MDQ6VXNlcjMyNjg4OTA1", "avatar_url": "https://avatars.githubusercontent.com/u/32688905?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hudson-ayers", "html_url": "https://github.com/hudson-ayers", "followers_url": "https://api.github.com/users/hudson-ayers/followers", "following_url": "https://api.github.com/users/hudson-ayers/following{/other_user}", "gists_url": "https://api.github.com/users/hudson-ayers/gists{/gist_id}", "starred_url": "https://api.github.com/users/hudson-ayers/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hudson-ayers/subscriptions", "organizations_url": "https://api.github.com/users/hudson-ayers/orgs", "repos_url": "https://api.github.com/users/hudson-ayers/repos", "events_url": "https://api.github.com/users/hudson-ayers/events{/privacy}", "received_events_url": "https://api.github.com/users/hudson-ayers/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a9a1393cbff49bbba9e83aa164ef208485579f92", "url": "https://api.github.com/repos/rust-lang/rust/commits/a9a1393cbff49bbba9e83aa164ef208485579f92", "html_url": "https://github.com/rust-lang/rust/commit/a9a1393cbff49bbba9e83aa164ef208485579f92"}], "stats": {"total": 15, "additions": 11, "deletions": 4}, "files": [{"sha": "b5e97ec8fe0f466e94fbd39520bda32633831dda", "filename": "compiler/rustc_const_eval/src/interpret/intrinsics/caller_location.rs", "status": "modified", "additions": 11, "deletions": 4, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/e1d94b8fd1ca1a1de6a56a3c53bb105fefacdd9c/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Fintrinsics%2Fcaller_location.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e1d94b8fd1ca1a1de6a56a3c53bb105fefacdd9c/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Fintrinsics%2Fcaller_location.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Fintrinsics%2Fcaller_location.rs?ref=e1d94b8fd1ca1a1de6a56a3c53bb105fefacdd9c", "patch": "@@ -80,10 +80,17 @@ impl<'mir, 'tcx: 'mir, M: Machine<'mir, 'tcx>> InterpCx<'mir, 'tcx, M> {\n         line: u32,\n         col: u32,\n     ) -> MPlaceTy<'tcx, M::PointerTag> {\n-        let file =\n-            self.allocate_str(&filename.as_str(), MemoryKind::CallerLocation, Mutability::Not);\n-        let line = Scalar::from_u32(line);\n-        let col = Scalar::from_u32(col);\n+        let loc_details = &self.tcx.sess.opts.debugging_opts.location_detail;\n+        let file = if loc_details.file {\n+            self.allocate_str(&filename.as_str(), MemoryKind::CallerLocation, Mutability::Not)\n+        } else {\n+            // FIXME: This creates a new allocation each time. It might be preferable to\n+            // perform this allocation only once, and re-use the `MPlaceTy`.\n+            // See https://github.com/rust-lang/rust/pull/89920#discussion_r730012398\n+            self.allocate_str(\"<redacted>\", MemoryKind::CallerLocation, Mutability::Not)\n+        };\n+        let line = if loc_details.line { Scalar::from_u32(line) } else { Scalar::from_u32(0) };\n+        let col = if loc_details.column { Scalar::from_u32(col) } else { Scalar::from_u32(0) };\n \n         // Allocate memory for `CallerLocation` struct.\n         let loc_ty = self"}]}