{"sha": "abfa331f266c82fcd62d26ff248f92fe59e09956", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFiZmEzMzFmMjY2YzgyZmNkNjJkMjZmZjI0OGY5MmZlNTllMDk5NTY=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-11-08T11:41:22Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-11-08T11:41:22Z"}, "message": "Auto merge of #6205 - josephlr:empty-loop2, r=flip1995\n\nEnable empty_loop lint for no_std crates\n\nDepends on #6162. Fixes #6161\n\nWe skip the lint if the `loop {}` is in the `#[panic_handler]` as the\nmain recommendation we give is to panic, which obviously isn't\npossible in a panic handler.\n\nchangelog: Enable empty_loop lint for no_std crates", "tree": {"sha": "c679b1f86c68e0b1eddb249c772bf3bc2fb4d8ab", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c679b1f86c68e0b1eddb249c772bf3bc2fb4d8ab"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/abfa331f266c82fcd62d26ff248f92fe59e09956", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/abfa331f266c82fcd62d26ff248f92fe59e09956", "html_url": "https://github.com/rust-lang/rust/commit/abfa331f266c82fcd62d26ff248f92fe59e09956", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/abfa331f266c82fcd62d26ff248f92fe59e09956/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "96d5f45adee883c565062fbb44de7ea29918539d", "url": "https://api.github.com/repos/rust-lang/rust/commits/96d5f45adee883c565062fbb44de7ea29918539d", "html_url": "https://github.com/rust-lang/rust/commit/96d5f45adee883c565062fbb44de7ea29918539d"}, {"sha": "00dee9d9160e9030d387f2cef1ec2b6422478229", "url": "https://api.github.com/repos/rust-lang/rust/commits/00dee9d9160e9030d387f2cef1ec2b6422478229", "html_url": "https://github.com/rust-lang/rust/commit/00dee9d9160e9030d387f2cef1ec2b6422478229"}], "stats": {"total": 69, "additions": 49, "deletions": 20}, "files": [{"sha": "b246245af24ceb8b641f48b50d74bccec64c83ba", "filename": "clippy_lints/src/loops.rs", "status": "modified", "additions": 13, "deletions": 15, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/abfa331f266c82fcd62d26ff248f92fe59e09956/clippy_lints%2Fsrc%2Floops.rs", "raw_url": "https://github.com/rust-lang/rust/raw/abfa331f266c82fcd62d26ff248f92fe59e09956/clippy_lints%2Fsrc%2Floops.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Floops.rs?ref=abfa331f266c82fcd62d26ff248f92fe59e09956", "patch": "@@ -4,10 +4,10 @@ use crate::utils::sugg::Sugg;\n use crate::utils::usage::{is_unused, mutated_variables};\n use crate::utils::{\n     contains_name, get_enclosing_block, get_parent_expr, get_trait_def_id, has_iter_method, higher, implements_trait,\n-    indent_of, is_integer_const, is_no_std_crate, is_refutable, is_type_diagnostic_item, last_path_segment,\n-    match_trait_method, match_type, match_var, multispan_sugg, qpath_res, single_segment_path, snippet,\n-    snippet_with_applicability, snippet_with_macro_callsite, span_lint, span_lint_and_help, span_lint_and_sugg,\n-    span_lint_and_then, sugg, SpanlessEq,\n+    indent_of, is_in_panic_handler, is_integer_const, is_no_std_crate, is_refutable, is_type_diagnostic_item,\n+    last_path_segment, match_trait_method, match_type, match_var, multispan_sugg, qpath_res, single_segment_path,\n+    snippet, snippet_with_applicability, snippet_with_macro_callsite, span_lint, span_lint_and_help,\n+    span_lint_and_sugg, span_lint_and_then, sugg, SpanlessEq,\n };\n use if_chain::if_chain;\n use rustc_ast::ast;\n@@ -543,17 +543,15 @@ impl<'tcx> LateLintPass<'tcx> for Loops {\n         // (also matches an explicit \"match\" instead of \"if let\")\n         // (even if the \"match\" or \"if let\" is used for declaration)\n         if let ExprKind::Loop(ref block, _, LoopSource::Loop) = expr.kind {\n-            // also check for empty `loop {}` statements\n-            // TODO(issue #6161): Enable for no_std crates (outside of #[panic_handler])\n-            if block.stmts.is_empty() && block.expr.is_none() && !is_no_std_crate(cx.tcx.hir().krate()) {\n-                span_lint_and_help(\n-                    cx,\n-                    EMPTY_LOOP,\n-                    expr.span,\n-                    \"empty `loop {}` wastes CPU cycles\",\n-                    None,\n-                    \"You should either use `panic!()` or add `std::thread::sleep(..);` to the loop body.\",\n-                );\n+            // also check for empty `loop {}` statements, skipping those in #[panic_handler]\n+            if block.stmts.is_empty() && block.expr.is_none() && !is_in_panic_handler(cx, expr) {\n+                let msg = \"empty `loop {}` wastes CPU cycles\";\n+                let help = if is_no_std_crate(cx.tcx.hir().krate()) {\n+                    \"you should either use `panic!()` or add a call pausing or sleeping the thread to the loop body\"\n+                } else {\n+                    \"you should either use `panic!()` or add `std::thread::sleep(..);` to the loop body\"\n+                };\n+                span_lint_and_help(cx, EMPTY_LOOP, expr.span, msg, None, help);\n             }\n \n             // extract the expression from the first statement (if any) in a block"}, {"sha": "cba3a0502499531c99da4bc2b89b32e105ca1fd6", "filename": "clippy_lints/src/utils/mod.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/abfa331f266c82fcd62d26ff248f92fe59e09956/clippy_lints%2Fsrc%2Futils%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/abfa331f266c82fcd62d26ff248f92fe59e09956/clippy_lints%2Fsrc%2Futils%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Futils%2Fmod.rs?ref=abfa331f266c82fcd62d26ff248f92fe59e09956", "patch": "@@ -468,6 +468,13 @@ pub fn is_entrypoint_fn(cx: &LateContext<'_>, def_id: DefId) -> bool {\n         .map_or(false, |(entry_fn_def_id, _)| def_id == entry_fn_def_id.to_def_id())\n }\n \n+/// Returns `true` if the expression is in the program's `#[panic_handler]`.\n+pub fn is_in_panic_handler(cx: &LateContext<'_>, e: &Expr<'_>) -> bool {\n+    let parent = cx.tcx.hir().get_parent_item(e.hir_id);\n+    let def_id = cx.tcx.hir().local_def_id(parent).to_def_id();\n+    Some(def_id) == cx.tcx.lang_items().panic_impl()\n+}\n+\n /// Gets the name of the item the expression is in, if available.\n pub fn get_item_name(cx: &LateContext<'_>, expr: &Expr<'_>) -> Option<Symbol> {\n     let parent_id = cx.tcx.hir().get_parent_item(expr.hir_id);"}, {"sha": "0eb7bb12b3546e85ad492460d28736886f1bd02b", "filename": "tests/ui/crashes/ice-360.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/abfa331f266c82fcd62d26ff248f92fe59e09956/tests%2Fui%2Fcrashes%2Fice-360.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/abfa331f266c82fcd62d26ff248f92fe59e09956/tests%2Fui%2Fcrashes%2Fice-360.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcrashes%2Fice-360.stderr?ref=abfa331f266c82fcd62d26ff248f92fe59e09956", "patch": "@@ -19,7 +19,7 @@ LL |         loop {}\n    |         ^^^^^^^\n    |\n    = note: `-D clippy::empty-loop` implied by `-D warnings`\n-   = help: You should either use `panic!()` or add `std::thread::sleep(..);` to the loop body.\n+   = help: you should either use `panic!()` or add `std::thread::sleep(..);` to the loop body\n \n error: aborting due to 2 previous errors\n "}, {"sha": "555f3d3d884a9d6d6a5f4f7520d4b152a53cfd24", "filename": "tests/ui/empty_loop.stderr", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/abfa331f266c82fcd62d26ff248f92fe59e09956/tests%2Fui%2Fempty_loop.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/abfa331f266c82fcd62d26ff248f92fe59e09956/tests%2Fui%2Fempty_loop.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fempty_loop.stderr?ref=abfa331f266c82fcd62d26ff248f92fe59e09956", "patch": "@@ -5,23 +5,23 @@ LL |     loop {}\n    |     ^^^^^^^\n    |\n    = note: `-D clippy::empty-loop` implied by `-D warnings`\n-   = help: You should either use `panic!()` or add `std::thread::sleep(..);` to the loop body.\n+   = help: you should either use `panic!()` or add `std::thread::sleep(..);` to the loop body\n \n error: empty `loop {}` wastes CPU cycles\n   --> $DIR/empty_loop.rs:11:9\n    |\n LL |         loop {}\n    |         ^^^^^^^\n    |\n-   = help: You should either use `panic!()` or add `std::thread::sleep(..);` to the loop body.\n+   = help: you should either use `panic!()` or add `std::thread::sleep(..);` to the loop body\n \n error: empty `loop {}` wastes CPU cycles\n   --> $DIR/empty_loop.rs:15:9\n    |\n LL |         'inner: loop {}\n    |         ^^^^^^^^^^^^^^^\n    |\n-   = help: You should either use `panic!()` or add `std::thread::sleep(..);` to the loop body.\n+   = help: you should either use `panic!()` or add `std::thread::sleep(..);` to the loop body\n \n error: aborting due to 3 previous errors\n "}, {"sha": "4553d3ec505a33846cce213690a5a6905ef3330c", "filename": "tests/ui/empty_loop_no_std.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/abfa331f266c82fcd62d26ff248f92fe59e09956/tests%2Fui%2Fempty_loop_no_std.rs", "raw_url": "https://github.com/rust-lang/rust/raw/abfa331f266c82fcd62d26ff248f92fe59e09956/tests%2Fui%2Fempty_loop_no_std.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fempty_loop_no_std.rs?ref=abfa331f266c82fcd62d26ff248f92fe59e09956", "patch": "@@ -10,13 +10,18 @@ use core::panic::PanicInfo;\n \n #[start]\n fn main(argc: isize, argv: *const *const u8) -> isize {\n+    // This should trigger the lint\n     loop {}\n }\n \n #[panic_handler]\n fn panic(_info: &PanicInfo) -> ! {\n+    // This should NOT trigger the lint\n     loop {}\n }\n \n #[lang = \"eh_personality\"]\n-extern \"C\" fn eh_personality() {}\n+extern \"C\" fn eh_personality() {\n+    // This should also trigger the lint\n+    loop {}\n+}"}, {"sha": "520248fcb689c4e52b3a39c65873f0e2fc4d547d", "filename": "tests/ui/empty_loop_no_std.stderr", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/abfa331f266c82fcd62d26ff248f92fe59e09956/tests%2Fui%2Fempty_loop_no_std.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/abfa331f266c82fcd62d26ff248f92fe59e09956/tests%2Fui%2Fempty_loop_no_std.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fempty_loop_no_std.stderr?ref=abfa331f266c82fcd62d26ff248f92fe59e09956", "patch": "@@ -0,0 +1,19 @@\n+error: empty `loop {}` wastes CPU cycles\n+  --> $DIR/empty_loop_no_std.rs:14:5\n+   |\n+LL |     loop {}\n+   |     ^^^^^^^\n+   |\n+   = note: `-D clippy::empty-loop` implied by `-D warnings`\n+   = help: you should either use `panic!()` or add a call pausing or sleeping the thread to the loop body\n+\n+error: empty `loop {}` wastes CPU cycles\n+  --> $DIR/empty_loop_no_std.rs:26:5\n+   |\n+LL |     loop {}\n+   |     ^^^^^^^\n+   |\n+   = help: you should either use `panic!()` or add a call pausing or sleeping the thread to the loop body\n+\n+error: aborting due to 2 previous errors\n+"}]}