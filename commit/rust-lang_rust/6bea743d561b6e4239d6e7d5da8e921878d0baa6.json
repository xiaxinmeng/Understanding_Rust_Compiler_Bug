{"sha": "6bea743d561b6e4239d6e7d5da8e921878d0baa6", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZiZWE3NDNkNTYxYjZlNDIzOWQ2ZTdkNWRhOGU5MjE4NzhkMGJhYTY=", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2018-08-15T17:20:23Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2018-08-15T17:20:23Z"}, "message": "Rollup merge of #53342 - RalfJung:unsized-packed, r=cramertj\n\nfix error for unsized packed struct field\n\nIt was really confusing to be told \"only the last field of a struct may have a dynamically sized type\" when only the last field *was* unsized.", "tree": {"sha": "966790fe76c52ff645099a67f84dd7bed00c40d8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/966790fe76c52ff645099a67f84dd7bed00c40d8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6bea743d561b6e4239d6e7d5da8e921878d0baa6", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJbdGDYCRBK7hj4Ov3rIwAAdHIIAJctRFvdgrSo4S8Ox35Phfo5\nswRth56jzh214t5ODrOxBKosztcDSYt2QyfuQHEJeuBbXyn8B+2c+sw3smN8OnBm\nn6y/4am3ImnuETF5YBKt/dg93ERbdSFyJkzr+yvPOB3dixeTfqvnj5wPHX7zI9mV\n+XSKc5BKxi9A/AE+QMtKlExH85chrhHF6TAjvKSNo1tBXWds+RrCV7SmnxQuv11H\nrQ8nkleCBmk2bp9/eapEnf0Fasa66pmqaIuCA/XKJfoOxuvd0tLJoLVhZ2fGdwwu\nSrJ79Myw0XgRdNxGZSDIXp9yj/H67rXpV9KI1f+xd4j/j3hi/arDlEHzY+WSgXs=\n=Ib2c\n-----END PGP SIGNATURE-----\n", "payload": "tree 966790fe76c52ff645099a67f84dd7bed00c40d8\nparent 8e4f2d115ac5b3395c4f9b8b9bf89b63c35e8b14\nparent 2fd2f9cfaf04a128f1179703f8f7c3aaf0b0658d\nauthor Guillaume Gomez <guillaume1.gomez@gmail.com> 1534353623 +0200\ncommitter GitHub <noreply@github.com> 1534353623 +0200\n\nRollup merge of #53342 - RalfJung:unsized-packed, r=cramertj\n\nfix error for unsized packed struct field\n\nIt was really confusing to be told \"only the last field of a struct may have a dynamically sized type\" when only the last field *was* unsized.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6bea743d561b6e4239d6e7d5da8e921878d0baa6", "html_url": "https://github.com/rust-lang/rust/commit/6bea743d561b6e4239d6e7d5da8e921878d0baa6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6bea743d561b6e4239d6e7d5da8e921878d0baa6/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8e4f2d115ac5b3395c4f9b8b9bf89b63c35e8b14", "url": "https://api.github.com/repos/rust-lang/rust/commits/8e4f2d115ac5b3395c4f9b8b9bf89b63c35e8b14", "html_url": "https://github.com/rust-lang/rust/commit/8e4f2d115ac5b3395c4f9b8b9bf89b63c35e8b14"}, {"sha": "2fd2f9cfaf04a128f1179703f8f7c3aaf0b0658d", "url": "https://api.github.com/repos/rust-lang/rust/commits/2fd2f9cfaf04a128f1179703f8f7c3aaf0b0658d", "html_url": "https://github.com/rust-lang/rust/commit/2fd2f9cfaf04a128f1179703f8f7c3aaf0b0658d"}], "stats": {"total": 49, "additions": 32, "deletions": 17}, "files": [{"sha": "99b2f3e59feb66253d2f4bbffe67a5a6fc2af0bc", "filename": "src/librustc/traits/error_reporting.rs", "status": "modified", "additions": 8, "deletions": 3, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/6bea743d561b6e4239d6e7d5da8e921878d0baa6/src%2Flibrustc%2Ftraits%2Ferror_reporting.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6bea743d561b6e4239d6e7d5da8e921878d0baa6/src%2Flibrustc%2Ftraits%2Ferror_reporting.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Ftraits%2Ferror_reporting.rs?ref=6bea743d561b6e4239d6e7d5da8e921878d0baa6", "patch": "@@ -1472,11 +1472,16 @@ impl<'a, 'gcx, 'tcx> InferCtxt<'a, 'gcx, 'tcx> {\n             ObligationCauseCode::StructInitializerSized => {\n                 err.note(\"structs must have a statically known size to be initialized\");\n             }\n-            ObligationCauseCode::FieldSized(ref item) => {\n+            ObligationCauseCode::FieldSized { adt_kind: ref item, last } => {\n                 match *item {\n                     AdtKind::Struct => {\n-                        err.note(\"only the last field of a struct may have a dynamically \\\n-                                  sized type\");\n+                        if last {\n+                            err.note(\"the last field of a packed struct may only have a \\\n+                                      dynamically sized type if it does not need drop to be run\");\n+                        } else {\n+                            err.note(\"only the last field of a struct may have a dynamically \\\n+                                      sized type\");\n+                        }\n                     }\n                     AdtKind::Union => {\n                         err.note(\"no field of a union may have a dynamically sized type\");"}, {"sha": "08434b5f24ef9d2e19503a06fb4ae76bb5a89f78", "filename": "src/librustc/traits/mod.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/6bea743d561b6e4239d6e7d5da8e921878d0baa6/src%2Flibrustc%2Ftraits%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6bea743d561b6e4239d6e7d5da8e921878d0baa6/src%2Flibrustc%2Ftraits%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Ftraits%2Fmod.rs?ref=6bea743d561b6e4239d6e7d5da8e921878d0baa6", "patch": "@@ -192,8 +192,8 @@ pub enum ObligationCauseCode<'tcx> {\n     /// [T,..n] --> T must be Copy\n     RepeatVec,\n \n-    /// Types of fields (other than the last) in a struct must be sized.\n-    FieldSized(AdtKind),\n+    /// Types of fields (other than the last, except for packed structs) in a struct must be sized.\n+    FieldSized { adt_kind: AdtKind, last: bool },\n \n     /// Constant expressions must be sized.\n     ConstSized,"}, {"sha": "544e3f03c03b1c3d936999c31b0ffc8a4b5d5c39", "filename": "src/librustc/traits/structural_impls.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/6bea743d561b6e4239d6e7d5da8e921878d0baa6/src%2Flibrustc%2Ftraits%2Fstructural_impls.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6bea743d561b6e4239d6e7d5da8e921878d0baa6/src%2Flibrustc%2Ftraits%2Fstructural_impls.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Ftraits%2Fstructural_impls.rs?ref=6bea743d561b6e4239d6e7d5da8e921878d0baa6", "patch": "@@ -206,7 +206,7 @@ impl<'a, 'tcx> Lift<'tcx> for traits::ObligationCauseCode<'a> {\n             super::SizedReturnType => Some(super::SizedReturnType),\n             super::SizedYieldType => Some(super::SizedYieldType),\n             super::RepeatVec => Some(super::RepeatVec),\n-            super::FieldSized(item) => Some(super::FieldSized(item)),\n+            super::FieldSized { adt_kind, last } => Some(super::FieldSized { adt_kind, last }),\n             super::ConstSized => Some(super::ConstSized),\n             super::SharedStatic => Some(super::SharedStatic),\n             super::BuiltinDerivedObligation(ref cause) => {"}, {"sha": "4b609779540f02f674e9645dab463195e7e4874e", "filename": "src/librustc_typeck/check/wfcheck.rs", "status": "modified", "additions": 20, "deletions": 10, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/6bea743d561b6e4239d6e7d5da8e921878d0baa6/src%2Flibrustc_typeck%2Fcheck%2Fwfcheck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6bea743d561b6e4239d6e7d5da8e921878d0baa6/src%2Flibrustc_typeck%2Fcheck%2Fwfcheck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fwfcheck.rs?ref=6bea743d561b6e4239d6e7d5da8e921878d0baa6", "patch": "@@ -258,25 +258,35 @@ fn check_type_defn<'a, 'tcx, F>(tcx: TyCtxt<'a, 'tcx, 'tcx>,\n                     ty.needs_drop(fcx_tcx, fcx_tcx.param_env(def_id))\n                 }\n             };\n-            let unsized_len = if\n+            let all_sized =\n                 all_sized ||\n                 variant.fields.is_empty() ||\n-                needs_drop_copy()\n-            {\n+                needs_drop_copy();\n+            let unsized_len = if all_sized {\n                 0\n             } else {\n                 1\n             };\n-            for field in &variant.fields[..variant.fields.len() - unsized_len] {\n+            for (idx, field) in variant.fields[..variant.fields.len() - unsized_len]\n+                .iter()\n+                .enumerate()\n+            {\n+                let last = idx == variant.fields.len() - 1;\n                 fcx.register_bound(\n                     field.ty,\n                     fcx.tcx.require_lang_item(lang_items::SizedTraitLangItem),\n-                    traits::ObligationCause::new(field.span,\n-                                                    fcx.body_id,\n-                                                    traits::FieldSized(match item.node.adt_kind() {\n-                                                    Some(i) => i,\n-                                                    None => bug!(),\n-                                                    })));\n+                    traits::ObligationCause::new(\n+                        field.span,\n+                        fcx.body_id,\n+                        traits::FieldSized {\n+                            adt_kind: match item.node.adt_kind() {\n+                                Some(i) => i,\n+                                None => bug!(),\n+                            },\n+                            last\n+                        }\n+                    )\n+                );\n             }\n \n             // All field types must be well-formed."}, {"sha": "c9a29ac2199c0a4ecc773a4b02adca17281d2ba6", "filename": "src/test/ui/issues/issue-27060-2.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/6bea743d561b6e4239d6e7d5da8e921878d0baa6/src%2Ftest%2Fui%2Fissues%2Fissue-27060-2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/6bea743d561b6e4239d6e7d5da8e921878d0baa6/src%2Ftest%2Fui%2Fissues%2Fissue-27060-2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-27060-2.stderr?ref=6bea743d561b6e4239d6e7d5da8e921878d0baa6", "patch": "@@ -7,7 +7,7 @@ LL |     data: T, //~ ERROR the size for values of type\n    = help: the trait `std::marker::Sized` is not implemented for `T`\n    = note: to learn more, visit <https://doc.rust-lang.org/book/second-edition/ch19-04-advanced-types.html#dynamically-sized-types-and-the-sized-trait>\n    = help: consider adding a `where T: std::marker::Sized` bound\n-   = note: only the last field of a struct may have a dynamically sized type\n+   = note: the last field of a packed struct may only have a dynamically sized type if it does not need drop to be run\n \n error: aborting due to previous error\n "}]}