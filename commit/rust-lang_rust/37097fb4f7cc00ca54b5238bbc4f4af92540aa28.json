{"sha": "37097fb4f7cc00ca54b5238bbc4f4af92540aa28", "node_id": "MDY6Q29tbWl0NzI0NzEyOjM3MDk3ZmI0ZjdjYzAwY2E1NGI1MjM4YmJjNGY0YWY5MjU0MGFhMjg=", "commit": {"author": {"name": "Tom Tromey", "email": "tom@tromey.com", "date": "2020-04-22T03:48:54Z"}, "committer": {"name": "Tom Tromey", "email": "tromey@adacore.com", "date": "2020-04-22T13:54:33Z"}, "message": "Let compiletest recognize gdb 10.x\n\ngit gdb has moved to version 10.  My build prints this as its\n--version:\n\n    GNU gdb (GDB) 10.0.50.20200420-git\n\nUnfortunately this conflicts with this comment in compiletest:\n\n    // We limit major to 1 digit, otherwise, on openSUSE, we parse the openSUSE version\n\nThis patch changes the version parsing to follow the GNU coding\nstandard, which accounts for both the openSUSE case as well as\nhandling gdb 10.\n\nMy debuginfo test run now says:\n\nNOTE: compiletest thinks it is using GDB with native rust support\nNOTE: compiletest thinks it is using GDB version 10000050\n\n... where previously it failed to find that gdb 10 had rust support.", "tree": {"sha": "761c3f8491f126ef922c0d242a0c2412c7404802", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/761c3f8491f126ef922c0d242a0c2412c7404802"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/37097fb4f7cc00ca54b5238bbc4f4af92540aa28", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/37097fb4f7cc00ca54b5238bbc4f4af92540aa28", "html_url": "https://github.com/rust-lang/rust/commit/37097fb4f7cc00ca54b5238bbc4f4af92540aa28", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/37097fb4f7cc00ca54b5238bbc4f4af92540aa28/comments", "author": {"login": "tromey", "id": 1557670, "node_id": "MDQ6VXNlcjE1NTc2NzA=", "avatar_url": "https://avatars.githubusercontent.com/u/1557670?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tromey", "html_url": "https://github.com/tromey", "followers_url": "https://api.github.com/users/tromey/followers", "following_url": "https://api.github.com/users/tromey/following{/other_user}", "gists_url": "https://api.github.com/users/tromey/gists{/gist_id}", "starred_url": "https://api.github.com/users/tromey/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tromey/subscriptions", "organizations_url": "https://api.github.com/users/tromey/orgs", "repos_url": "https://api.github.com/users/tromey/repos", "events_url": "https://api.github.com/users/tromey/events{/privacy}", "received_events_url": "https://api.github.com/users/tromey/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tromey", "id": 1557670, "node_id": "MDQ6VXNlcjE1NTc2NzA=", "avatar_url": "https://avatars.githubusercontent.com/u/1557670?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tromey", "html_url": "https://github.com/tromey", "followers_url": "https://api.github.com/users/tromey/followers", "following_url": "https://api.github.com/users/tromey/following{/other_user}", "gists_url": "https://api.github.com/users/tromey/gists{/gist_id}", "starred_url": "https://api.github.com/users/tromey/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tromey/subscriptions", "organizations_url": "https://api.github.com/users/tromey/orgs", "repos_url": "https://api.github.com/users/tromey/repos", "events_url": "https://api.github.com/users/tromey/events{/privacy}", "received_events_url": "https://api.github.com/users/tromey/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "45d050cde277b22a755847338f2acc2c7b834141", "url": "https://api.github.com/repos/rust-lang/rust/commits/45d050cde277b22a755847338f2acc2c7b834141", "html_url": "https://github.com/rust-lang/rust/commit/45d050cde277b22a755847338f2acc2c7b834141"}], "stats": {"total": 22, "additions": 19, "deletions": 3}, "files": [{"sha": "3a8a5491255a0dce0d093c82747f4c6c6487362c", "filename": "src/tools/compiletest/src/main.rs", "status": "modified", "additions": 19, "deletions": 3, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/37097fb4f7cc00ca54b5238bbc4f4af92540aa28/src%2Ftools%2Fcompiletest%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/37097fb4f7cc00ca54b5238bbc4f4af92540aa28/src%2Ftools%2Fcompiletest%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fmain.rs?ref=37097fb4f7cc00ca54b5238bbc4f4af92540aa28", "patch": "@@ -831,12 +831,28 @@ fn extract_gdb_version(full_version_line: &str) -> Option<u32> {\n     // GDB versions look like this: \"major.minor.patch?.yyyymmdd?\", with both\n     // of the ? sections being optional\n \n-    // We will parse up to 3 digits for minor and patch, ignoring the date\n-    // We limit major to 1 digit, otherwise, on openSUSE, we parse the openSUSE version\n+    // We will parse up to 3 digits for each component, ignoring the date\n+\n+    // We skip text in parentheses.  This avoids accidentally parsing\n+    // the openSUSE version, which looks like:\n+    //  GNU gdb (GDB; openSUSE Leap 15.0) 8.1\n+    // This particular form is documented in the GNU coding standards:\n+    // https://www.gnu.org/prep/standards/html_node/_002d_002dversion.html#g_t_002d_002dversion\n \n     // don't start parsing in the middle of a number\n     let mut prev_was_digit = false;\n+    let mut in_parens = false;\n     for (pos, c) in full_version_line.char_indices() {\n+        if in_parens {\n+            if c == ')' {\n+                in_parens = false;\n+            }\n+            continue;\n+        } else if c == '(' {\n+            in_parens = true;\n+            continue;\n+        }\n+\n         if prev_was_digit || !c.is_digit(10) {\n             prev_was_digit = c.is_digit(10);\n             continue;\n@@ -876,7 +892,7 @@ fn extract_gdb_version(full_version_line: &str) -> Option<u32> {\n             None => (line, None),\n         };\n \n-        if major.len() != 1 || minor.is_empty() {\n+        if minor.is_empty() {\n             continue;\n         }\n "}]}