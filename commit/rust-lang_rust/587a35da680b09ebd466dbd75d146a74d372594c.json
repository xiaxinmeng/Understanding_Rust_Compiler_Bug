{"sha": "587a35da680b09ebd466dbd75d146a74d372594c", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU4N2EzNWRhNjgwYjA5ZWJkNDY2ZGJkNzVkMTQ2YTc0ZDM3MjU5NGM=", "commit": {"author": {"name": "Nick Cameron", "email": "ncameron@mozilla.com", "date": "2017-07-24T05:06:42Z"}, "committer": {"name": "Nick Cameron", "email": "ncameron@mozilla.com", "date": "2017-07-24T05:25:16Z"}, "message": "Make keep_ast configurable by driver clients", "tree": {"sha": "717aa01c4ec709939ff06b2a6b916f276cde8e0d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/717aa01c4ec709939ff06b2a6b916f276cde8e0d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/587a35da680b09ebd466dbd75d146a74d372594c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/587a35da680b09ebd466dbd75d146a74d372594c", "html_url": "https://github.com/rust-lang/rust/commit/587a35da680b09ebd466dbd75d146a74d372594c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/587a35da680b09ebd466dbd75d146a74d372594c/comments", "author": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "81fd86e0680947aa346c2c1d5b213ab036b68710", "url": "https://api.github.com/repos/rust-lang/rust/commits/81fd86e0680947aa346c2c1d5b213ab036b68710", "html_url": "https://github.com/rust-lang/rust/commit/81fd86e0680947aa346c2c1d5b213ab036b68710"}], "stats": {"total": 10, "additions": 6, "deletions": 4}, "files": [{"sha": "c592882a1e43b73e9b76a2d45255773364c21ce5", "filename": "src/librustc_driver/driver.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/587a35da680b09ebd466dbd75d146a74d372594c/src%2Flibrustc_driver%2Fdriver.rs", "raw_url": "https://github.com/rust-lang/rust/raw/587a35da680b09ebd466dbd75d146a74d372594c/src%2Flibrustc_driver%2Fdriver.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_driver%2Fdriver.rs?ref=587a35da680b09ebd466dbd75d146a74d372594c", "patch": "@@ -167,7 +167,7 @@ pub fn compile_input(sess: &Session,\n             hir::check_attr::check_crate(sess, &expanded_crate);\n         });\n \n-        let opt_crate = if keep_ast(sess) {\n+        let opt_crate = if control.keep_ast {\n             Some(&expanded_crate)\n         } else {\n             drop(expanded_crate);\n@@ -263,9 +263,6 @@ fn keep_hygiene_data(sess: &Session) -> bool {\n     sess.opts.debugging_opts.keep_hygiene_data\n }\n \n-fn keep_ast(sess: &Session) -> bool {\n-    sess.opts.debugging_opts.keep_ast || ::save_analysis(sess)\n-}\n \n /// The name used for source code that doesn't originate in a file\n /// (e.g. source from stdin or a string)\n@@ -304,6 +301,8 @@ pub struct CompileController<'a> {\n     pub compilation_done: PhaseController<'a>,\n \n     pub make_glob_map: MakeGlobMap,\n+    // Whether the compiler should keep the ast beyond parsing.\n+    pub keep_ast: bool,\n }\n \n impl<'a> CompileController<'a> {\n@@ -316,6 +315,7 @@ impl<'a> CompileController<'a> {\n             after_llvm: PhaseController::basic(),\n             compilation_done: PhaseController::basic(),\n             make_glob_map: MakeGlobMap::No,\n+            keep_ast: false,\n         }\n     }\n }"}, {"sha": "e139f81416e3d6ef1ad38adfb90b23e00509006d", "filename": "src/librustc_driver/lib.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/587a35da680b09ebd466dbd75d146a74d372594c/src%2Flibrustc_driver%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/587a35da680b09ebd466dbd75d146a74d372594c/src%2Flibrustc_driver%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_driver%2Flib.rs?ref=587a35da680b09ebd466dbd75d146a74d372594c", "patch": "@@ -518,6 +518,8 @@ impl<'a> CompilerCalls<'a> for RustcDefaultCalls {\n                         -> CompileController<'a> {\n         let mut control = CompileController::basic();\n \n+        control.keep_ast = sess.opts.debugging_opts.keep_ast || save_analysis(sess);\n+\n         if let Some((ppm, opt_uii)) = parse_pretty(sess, matches) {\n             if ppm.needs_ast_map(&opt_uii) {\n                 control.after_hir_lowering.stop = Compilation::Stop;"}]}