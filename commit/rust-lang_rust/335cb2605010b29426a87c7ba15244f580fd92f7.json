{"sha": "335cb2605010b29426a87c7ba15244f580fd92f7", "node_id": "C_kwDOAAsO6NoAKDMzNWNiMjYwNTAxMGIyOTQyNmE4N2M3YmExNTI0NGY1ODBmZDkyZjc", "commit": {"author": {"name": "Jonas Schievink", "email": "jonas.schievink@ferrous-systems.com", "date": "2022-11-29T18:20:32Z"}, "committer": {"name": "Jonas Schievink", "email": "jonas.schievink@ferrous-systems.com", "date": "2022-11-29T18:20:32Z"}, "message": "Version the inlay hint resolve data", "tree": {"sha": "4a86002c1d9cd5e3a7e4342924712cdef12eb2ca", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4a86002c1d9cd5e3a7e4342924712cdef12eb2ca"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/335cb2605010b29426a87c7ba15244f580fd92f7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/335cb2605010b29426a87c7ba15244f580fd92f7", "html_url": "https://github.com/rust-lang/rust/commit/335cb2605010b29426a87c7ba15244f580fd92f7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/335cb2605010b29426a87c7ba15244f580fd92f7/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e69fb5e9ef1051eb405865ad4aad7cc5a02877a2", "url": "https://api.github.com/repos/rust-lang/rust/commits/e69fb5e9ef1051eb405865ad4aad7cc5a02877a2", "html_url": "https://github.com/rust-lang/rust/commit/e69fb5e9ef1051eb405865ad4aad7cc5a02877a2"}], "stats": {"total": 46, "additions": 39, "deletions": 7}, "files": [{"sha": "4e7095b3ce3b122901c579dbadf29d57756192ec", "filename": "crates/rust-analyzer/src/from_proto.rs", "status": "modified", "additions": 9, "deletions": 1, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/335cb2605010b29426a87c7ba15244f580fd92f7/crates%2Frust-analyzer%2Fsrc%2Ffrom_proto.rs", "raw_url": "https://github.com/rust-lang/rust/raw/335cb2605010b29426a87c7ba15244f580fd92f7/crates%2Frust-analyzer%2Fsrc%2Ffrom_proto.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Ffrom_proto.rs?ref=335cb2605010b29426a87c7ba15244f580fd92f7", "patch": "@@ -67,7 +67,15 @@ pub(crate) fn file_range(\n     text_document_identifier: lsp_types::TextDocumentIdentifier,\n     range: lsp_types::Range,\n ) -> Result<FileRange> {\n-    let file_id = file_id(snap, &text_document_identifier.uri)?;\n+    file_range_uri(snap, &text_document_identifier.uri, range)\n+}\n+\n+pub(crate) fn file_range_uri(\n+    snap: &GlobalStateSnapshot,\n+    document: &lsp_types::Url,\n+    range: lsp_types::Range,\n+) -> Result<FileRange> {\n+    let file_id = file_id(snap, document)?;\n     let line_index = snap.file_line_index(file_id)?;\n     let range = text_range(&line_index, range)?;\n     Ok(FileRange { file_id, range })"}, {"sha": "1604a02fb135bda81be713f101d5bb8e2b287d9f", "filename": "crates/rust-analyzer/src/handlers.rs", "status": "modified", "additions": 20, "deletions": 2, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/335cb2605010b29426a87c7ba15244f580fd92f7/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/335cb2605010b29426a87c7ba15244f580fd92f7/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs?ref=335cb2605010b29426a87c7ba15244f580fd92f7", "patch": "@@ -29,6 +29,7 @@ use project_model::{ManifestPath, ProjectWorkspace, TargetKind};\n use serde_json::json;\n use stdx::{format_to, never};\n use syntax::{algo, ast, AstNode, TextRange, TextSize};\n+use tracing::error;\n use vfs::AbsPathBuf;\n \n use crate::{\n@@ -1372,9 +1373,26 @@ pub(crate) fn handle_inlay_hints_resolve(\n \n     let resolve_data: lsp_ext::InlayHintResolveData = serde_json::from_value(data)?;\n \n-    let file_range = from_proto::file_range(\n+    match snap.url_file_version(&resolve_data.text_document.uri) {\n+        Some(version) if version == resolve_data.text_document.version => {}\n+        Some(version) => {\n+            error!(\n+                \"attempted inlayHints/resolve of '{}' at version {} while server version is {}\",\n+                resolve_data.text_document.uri, resolve_data.text_document.version, version,\n+            );\n+            return Ok(hint);\n+        }\n+        None => {\n+            error!(\n+                \"attempted inlayHints/resolve of unknown file '{}' at version {}\",\n+                resolve_data.text_document.uri, resolve_data.text_document.version,\n+            );\n+            return Ok(hint);\n+        }\n+    }\n+    let file_range = from_proto::file_range_uri(\n         &snap,\n-        resolve_data.text_document,\n+        &resolve_data.text_document.uri,\n         match resolve_data.position {\n             PositionOrRange::Position(pos) => Range::new(pos, pos),\n             PositionOrRange::Range(range) => range,"}, {"sha": "a1df0b6d7dd5aae13fee85588f69ac20283c557c", "filename": "crates/rust-analyzer/src/lsp_ext.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/335cb2605010b29426a87c7ba15244f580fd92f7/crates%2Frust-analyzer%2Fsrc%2Flsp_ext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/335cb2605010b29426a87c7ba15244f580fd92f7/crates%2Frust-analyzer%2Fsrc%2Flsp_ext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Flsp_ext.rs?ref=335cb2605010b29426a87c7ba15244f580fd92f7", "patch": "@@ -3,11 +3,11 @@\n use std::{collections::HashMap, path::PathBuf};\n \n use lsp_types::request::Request;\n-use lsp_types::PositionEncodingKind;\n use lsp_types::{\n     notification::Notification, CodeActionKind, DocumentOnTypeFormattingParams,\n     PartialResultParams, Position, Range, TextDocumentIdentifier, WorkDoneProgressParams,\n };\n+use lsp_types::{PositionEncodingKind, VersionedTextDocumentIdentifier};\n use serde::{Deserialize, Serialize};\n \n pub enum AnalyzerStatus {}\n@@ -550,7 +550,7 @@ pub struct CompletionResolveData {\n \n #[derive(Debug, Serialize, Deserialize)]\n pub struct InlayHintResolveData {\n-    pub text_document: TextDocumentIdentifier,\n+    pub text_document: VersionedTextDocumentIdentifier,\n     pub position: PositionOrRange,\n }\n "}, {"sha": "3ce24bdd14fdceaee1575f2ad35b54ad0f1e722d", "filename": "crates/rust-analyzer/src/to_proto.rs", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/335cb2605010b29426a87c7ba15244f580fd92f7/crates%2Frust-analyzer%2Fsrc%2Fto_proto.rs", "raw_url": "https://github.com/rust-lang/rust/raw/335cb2605010b29426a87c7ba15244f580fd92f7/crates%2Frust-analyzer%2Fsrc%2Fto_proto.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fto_proto.rs?ref=335cb2605010b29426a87c7ba15244f580fd92f7", "patch": "@@ -492,7 +492,10 @@ pub(crate) fn inlay_hint(\n                 let uri = url(snap, file_id);\n                 let line_index = snap.file_line_index(file_id).ok()?;\n \n-                let text_document = lsp_types::TextDocumentIdentifier { uri };\n+                let text_document = lsp_types::VersionedTextDocumentIdentifier {\n+                    version: snap.url_file_version(&uri)?,\n+                    uri,\n+                };\n                 to_value(lsp_ext::InlayHintResolveData {\n                     text_document,\n                     position: lsp_ext::PositionOrRange::Position(position(&line_index, offset)),\n@@ -501,7 +504,10 @@ pub(crate) fn inlay_hint(\n             }\n             Some(ide::InlayTooltip::HoverRanged(file_id, text_range)) => {\n                 let uri = url(snap, file_id);\n-                let text_document = lsp_types::TextDocumentIdentifier { uri };\n+                let text_document = lsp_types::VersionedTextDocumentIdentifier {\n+                    version: snap.url_file_version(&uri)?,\n+                    uri,\n+                };\n                 let line_index = snap.file_line_index(file_id).ok()?;\n                 to_value(lsp_ext::InlayHintResolveData {\n                     text_document,"}]}