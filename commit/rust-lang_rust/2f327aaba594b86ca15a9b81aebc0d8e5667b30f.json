{"sha": "2f327aaba594b86ca15a9b81aebc0d8e5667b30f", "node_id": "C_kwDOAAsO6NoAKDJmMzI3YWFiYTU5NGI4NmNhMTVhOWI4MWFlYmMwZDhlNTY2N2IzMGY", "commit": {"author": {"name": "Ahmed Karaman", "email": "20889958+ahmedkrmn@users.noreply.github.com", "date": "2021-10-29T02:11:43Z"}, "committer": {"name": "Ahmed Karaman", "email": "20889958+ahmedkrmn@users.noreply.github.com", "date": "2021-10-29T20:07:05Z"}, "message": "Disable \"if_not_else\" lints firing on else-ifs\n\n1. Convert IfNotElse to LateLintPass and use clippy_utils::is_else_clause for checking.\n2. Handle the case where the span comes from desugaring.\n3. Update tests.", "tree": {"sha": "c115e7bfb8a1a8349c6a1e091bddeb010819d6c0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c115e7bfb8a1a8349c6a1e091bddeb010819d6c0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2f327aaba594b86ca15a9b81aebc0d8e5667b30f", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQJgBAABCgBKFiEEaAjZ2FUJmpS1SoC7n5Qg1iW7pQQFAmF8VLMsHDIwODg5OTU4\nK2FobWVka3JtbkB1c2Vycy5ub3JlcGx5LmdpdGh1Yi5jb20ACgkQn5Qg1iW7pQQJ\nAA//Ue2YBMuyb89qwU05s2i5YwNbz5pJjo96B4bsr5YKNkAjcxVAq6Fz2thQPDvB\nFUwudCZmOh0oyQDGawn7qziNcqwlxWZqzmFfx9XOfhJ1zqPyVLC6565JRkbc5vgL\nFs+xYpaAe7iC6HVLU5a6mghlZCnudIzdmPeR+kJRkZ2lj3PG5ZMRjZkBOlt4+xtp\npx5SqNcA4eKjAkjLKteNj2U2fGwpzGkEXPU4gpJJIudjKcnhEkhl7jHLDfDlzI9T\nQe187DPc9bYgnjWRdev5NxuZmNVfO1XQTaBbIzMZL6n0B8wgTAydz3mNdpfsTeY7\ntPNWXAXnDIqvkPOc70N4/qrB6FXJQC39DJVsHYC/qlsP8dXBH0DZVeIZVjULRwRc\n/EgYTi/yOvc3jqvSmUv4riqQKfZm6SJAaCuRUG6Vr5DDipL31O0BWjvy9ikHO2Vz\nBYPsPU/X99Doc4DsqRA9tFl02jvQw/PXjvdKDT55fhEh5vAArJylrAHVhrjq3yQB\nBaNLm/GL4FDYQhXgnXI4QVww6m3+j9eamNhoZtsU5MaeLQLH7vAKdRBOdSCTi60C\nXh0v2mOWLDP5pwv0aoEA5ahN58ixA7OzNyWubj1Jqbs7oGcNmq8iqx2R5YxMAhM7\ndZFJso/K5t9f7801bb9N/MaOsSYfv38nNiI3M0DRcl7HGnc=\n=smkx\n-----END PGP SIGNATURE-----", "payload": "tree c115e7bfb8a1a8349c6a1e091bddeb010819d6c0\nparent 00821ca937ab400e465a008eecdef60e985665ad\nauthor Ahmed Karaman <20889958+ahmedkrmn@users.noreply.github.com> 1635473503 +0200\ncommitter Ahmed Karaman <20889958+ahmedkrmn@users.noreply.github.com> 1635538025 +0200\n\nDisable \"if_not_else\" lints firing on else-ifs\n\n1. Convert IfNotElse to LateLintPass and use clippy_utils::is_else_clause for checking.\n2. Handle the case where the span comes from desugaring.\n3. Update tests.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2f327aaba594b86ca15a9b81aebc0d8e5667b30f", "html_url": "https://github.com/rust-lang/rust/commit/2f327aaba594b86ca15a9b81aebc0d8e5667b30f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2f327aaba594b86ca15a9b81aebc0d8e5667b30f/comments", "author": {"login": "ahmedkrmn", "id": 20889958, "node_id": "MDQ6VXNlcjIwODg5OTU4", "avatar_url": "https://avatars.githubusercontent.com/u/20889958?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ahmedkrmn", "html_url": "https://github.com/ahmedkrmn", "followers_url": "https://api.github.com/users/ahmedkrmn/followers", "following_url": "https://api.github.com/users/ahmedkrmn/following{/other_user}", "gists_url": "https://api.github.com/users/ahmedkrmn/gists{/gist_id}", "starred_url": "https://api.github.com/users/ahmedkrmn/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ahmedkrmn/subscriptions", "organizations_url": "https://api.github.com/users/ahmedkrmn/orgs", "repos_url": "https://api.github.com/users/ahmedkrmn/repos", "events_url": "https://api.github.com/users/ahmedkrmn/events{/privacy}", "received_events_url": "https://api.github.com/users/ahmedkrmn/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ahmedkrmn", "id": 20889958, "node_id": "MDQ6VXNlcjIwODg5OTU4", "avatar_url": "https://avatars.githubusercontent.com/u/20889958?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ahmedkrmn", "html_url": "https://github.com/ahmedkrmn", "followers_url": "https://api.github.com/users/ahmedkrmn/followers", "following_url": "https://api.github.com/users/ahmedkrmn/following{/other_user}", "gists_url": "https://api.github.com/users/ahmedkrmn/gists{/gist_id}", "starred_url": "https://api.github.com/users/ahmedkrmn/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ahmedkrmn/subscriptions", "organizations_url": "https://api.github.com/users/ahmedkrmn/orgs", "repos_url": "https://api.github.com/users/ahmedkrmn/repos", "events_url": "https://api.github.com/users/ahmedkrmn/events{/privacy}", "received_events_url": "https://api.github.com/users/ahmedkrmn/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "00821ca937ab400e465a008eecdef60e985665ad", "url": "https://api.github.com/repos/rust-lang/rust/commits/00821ca937ab400e465a008eecdef60e985665ad", "html_url": "https://github.com/rust-lang/rust/commit/00821ca937ab400e465a008eecdef60e985665ad"}], "stats": {"total": 39, "additions": 28, "deletions": 11}, "files": [{"sha": "ac938156237bf8f090feb281558f6301b685e6b0", "filename": "clippy_lints/src/if_not_else.rs", "status": "modified", "additions": 15, "deletions": 8, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/2f327aaba594b86ca15a9b81aebc0d8e5667b30f/clippy_lints%2Fsrc%2Fif_not_else.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f327aaba594b86ca15a9b81aebc0d8e5667b30f/clippy_lints%2Fsrc%2Fif_not_else.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fif_not_else.rs?ref=2f327aaba594b86ca15a9b81aebc0d8e5667b30f", "patch": "@@ -2,9 +2,9 @@\n //! on the condition\n \n use clippy_utils::diagnostics::span_lint_and_help;\n-use rustc_ast::ast::{BinOpKind, Expr, ExprKind, UnOp};\n-use rustc_lint::{EarlyContext, EarlyLintPass};\n-use rustc_middle::lint::in_external_macro;\n+use clippy_utils::is_else_clause;\n+use rustc_hir::{BinOpKind, Expr, ExprKind, UnOp};\n+use rustc_lint::{LateContext, LateLintPass};\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n \n declare_clippy_lint! {\n@@ -46,14 +46,21 @@ declare_clippy_lint! {\n \n declare_lint_pass!(IfNotElse => [IF_NOT_ELSE]);\n \n-impl EarlyLintPass for IfNotElse {\n-    fn check_expr(&mut self, cx: &EarlyContext<'_>, item: &Expr) {\n-        if in_external_macro(cx.sess, item.span) {\n+impl LateLintPass<'_> for IfNotElse {\n+    fn check_expr(&mut self, cx: &LateContext<'_>, item: &Expr<'_>) {\n+        // While loops will be desugared to ExprKind::If. This will cause the lint to fire.\n+        // To fix this, return early if this span comes from a macro or desugaring.\n+        if item.span.from_expansion() {\n             return;\n         }\n-        if let ExprKind::If(ref cond, _, Some(ref els)) = item.kind {\n+        if let ExprKind::If(cond, _, Some(els)) = item.kind {\n             if let ExprKind::Block(..) = els.kind {\n-                match cond.kind {\n+                // Disable firing the lint in \"else if\" expressions.\n+                if is_else_clause(cx.tcx, item) {\n+                    return;\n+                }\n+\n+                match cond.peel_drop_temps().kind {\n                     ExprKind::Unary(UnOp::Not, _) => {\n                         span_lint_and_help(\n                             cx,"}, {"sha": "7174d0a082e0f7627f062180d10f5ef47c170a4b", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/2f327aaba594b86ca15a9b81aebc0d8e5667b30f/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f327aaba594b86ca15a9b81aebc0d8e5667b30f/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=2f327aaba594b86ca15a9b81aebc0d8e5667b30f", "patch": "@@ -668,7 +668,6 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n     store.register_early_pass(|| Box::new(double_parens::DoubleParens));\n     store.register_late_pass(|| Box::new(to_string_in_display::ToStringInDisplay::new()));\n     store.register_early_pass(|| Box::new(unsafe_removed_from_name::UnsafeNameRemoval));\n-    store.register_early_pass(|| Box::new(if_not_else::IfNotElse));\n     store.register_early_pass(|| Box::new(else_if_without_else::ElseIfWithoutElse));\n     store.register_early_pass(|| Box::new(int_plus_one::IntPlusOne));\n     store.register_early_pass(|| Box::new(formatting::Formatting));\n@@ -722,6 +721,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n     store.register_late_pass(|| Box::new(option_if_let_else::OptionIfLetElse));\n     store.register_late_pass(|| Box::new(future_not_send::FutureNotSend));\n     store.register_late_pass(|| Box::new(if_let_mutex::IfLetMutex));\n+    store.register_late_pass(|| Box::new(if_not_else::IfNotElse));\n     store.register_late_pass(|| Box::new(equatable_if_let::PatternEquality));\n     store.register_late_pass(|| Box::new(mut_mutex_lock::MutMutexLock));\n     store.register_late_pass(|| Box::new(match_on_vec_items::MatchOnVecItems));"}, {"sha": "b7012b43d29766d154786e866357b15b838d5756", "filename": "tests/ui/if_not_else.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/2f327aaba594b86ca15a9b81aebc0d8e5667b30f/tests%2Fui%2Fif_not_else.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f327aaba594b86ca15a9b81aebc0d8e5667b30f/tests%2Fui%2Fif_not_else.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fif_not_else.rs?ref=2f327aaba594b86ca15a9b81aebc0d8e5667b30f", "patch": "@@ -1,6 +1,9 @@\n #![warn(clippy::all)]\n #![warn(clippy::if_not_else)]\n \n+fn foo() -> bool {\n+    unimplemented!()\n+}\n fn bla() -> bool {\n     unimplemented!()\n }\n@@ -16,4 +19,11 @@ fn main() {\n     } else {\n         println!(\"Bunny\");\n     }\n+    if !foo() {\n+        println!(\"Foo\");\n+    } else if !bla() {\n+        println!(\"Bugs\");\n+    } else {\n+        println!(\"Bunny\");\n+    }\n }"}, {"sha": "8c8cc44bb035882e2484a96a8874351632c6be89", "filename": "tests/ui/if_not_else.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/2f327aaba594b86ca15a9b81aebc0d8e5667b30f/tests%2Fui%2Fif_not_else.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2f327aaba594b86ca15a9b81aebc0d8e5667b30f/tests%2Fui%2Fif_not_else.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fif_not_else.stderr?ref=2f327aaba594b86ca15a9b81aebc0d8e5667b30f", "patch": "@@ -1,5 +1,5 @@\n error: unnecessary boolean `not` operation\n-  --> $DIR/if_not_else.rs:9:5\n+  --> $DIR/if_not_else.rs:12:5\n    |\n LL | /     if !bla() {\n LL | |         println!(\"Bugs\");\n@@ -12,7 +12,7 @@ LL | |     }\n    = help: remove the `!` and swap the blocks of the `if`/`else`\n \n error: unnecessary `!=` operation\n-  --> $DIR/if_not_else.rs:14:5\n+  --> $DIR/if_not_else.rs:17:5\n    |\n LL | /     if 4 != 5 {\n LL | |         println!(\"Bugs\");"}]}