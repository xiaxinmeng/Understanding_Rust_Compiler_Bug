{"sha": "4153a2ec45f79b4ddf1968b163590f3d1130007f", "node_id": "C_kwDOAAsO6NoAKDQxNTNhMmVjNDVmNzliNGRkZjE5NjhiMTYzNTkwZjNkMTEzMDAwN2Y", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-06-12T17:56:54Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-06-12T17:56:54Z"}, "message": "Auto merge of #97833 - tmiasko:borrowed-locals, r=nagisa\n\nRemove duplicated implementations of borrowed locals analysis", "tree": {"sha": "32f664b096899ab598bb47a296d56e7d3e4c0844", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/32f664b096899ab598bb47a296d56e7d3e4c0844"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4153a2ec45f79b4ddf1968b163590f3d1130007f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4153a2ec45f79b4ddf1968b163590f3d1130007f", "html_url": "https://github.com/rust-lang/rust/commit/4153a2ec45f79b4ddf1968b163590f3d1130007f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4153a2ec45f79b4ddf1968b163590f3d1130007f/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "53305f15625756dc3ec62ddc0ec070dee412a547", "url": "https://api.github.com/repos/rust-lang/rust/commits/53305f15625756dc3ec62ddc0ec070dee412a547", "html_url": "https://github.com/rust-lang/rust/commit/53305f15625756dc3ec62ddc0ec070dee412a547"}, {"sha": "777bf84f6c2033db6251df1220dae5a39d4598f1", "url": "https://api.github.com/repos/rust-lang/rust/commits/777bf84f6c2033db6251df1220dae5a39d4598f1", "html_url": "https://github.com/rust-lang/rust/commit/777bf84f6c2033db6251df1220dae5a39d4598f1"}], "stats": {"total": 170, "additions": 30, "deletions": 140}, "files": [{"sha": "627fe3f7f576be68db5d7e8ceb2cdff1043b43ff", "filename": "compiler/rustc_mir_dataflow/src/impls/borrowed_locals.rs", "status": "modified", "additions": 21, "deletions": 7, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/4153a2ec45f79b4ddf1968b163590f3d1130007f/compiler%2Frustc_mir_dataflow%2Fsrc%2Fimpls%2Fborrowed_locals.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4153a2ec45f79b4ddf1968b163590f3d1130007f/compiler%2Frustc_mir_dataflow%2Fsrc%2Fimpls%2Fborrowed_locals.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_dataflow%2Fsrc%2Fimpls%2Fborrowed_locals.rs?ref=4153a2ec45f79b4ddf1968b163590f3d1130007f", "patch": "@@ -85,13 +85,7 @@ where\n         self.super_rvalue(rvalue, location);\n \n         match rvalue {\n-            mir::Rvalue::AddressOf(_mt, borrowed_place) => {\n-                if !borrowed_place.is_indirect() {\n-                    self.trans.gen(borrowed_place.local);\n-                }\n-            }\n-\n-            mir::Rvalue::Ref(_, _kind, borrowed_place) => {\n+            mir::Rvalue::AddressOf(_, borrowed_place) | mir::Rvalue::Ref(_, _, borrowed_place) => {\n                 if !borrowed_place.is_indirect() {\n                     self.trans.gen(borrowed_place.local);\n                 }\n@@ -145,3 +139,23 @@ where\n         }\n     }\n }\n+\n+/// The set of locals that are borrowed at some point in the MIR body.\n+pub fn borrowed_locals(body: &Body<'_>) -> BitSet<Local> {\n+    struct Borrowed(BitSet<Local>);\n+\n+    impl GenKill<Local> for Borrowed {\n+        #[inline]\n+        fn gen(&mut self, elem: Local) {\n+            self.0.gen(elem)\n+        }\n+        #[inline]\n+        fn kill(&mut self, _: Local) {\n+            // Ignore borrow invalidation.\n+        }\n+    }\n+\n+    let mut borrowed = Borrowed(BitSet::new_empty(body.local_decls.len()));\n+    TransferFunction { trans: &mut borrowed }.visit_body(body);\n+    borrowed.0\n+}"}, {"sha": "af6a1bb1545ead0dc86071bfa5a174730f6eebf7", "filename": "compiler/rustc_mir_dataflow/src/impls/mod.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/4153a2ec45f79b4ddf1968b163590f3d1130007f/compiler%2Frustc_mir_dataflow%2Fsrc%2Fimpls%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4153a2ec45f79b4ddf1968b163590f3d1130007f/compiler%2Frustc_mir_dataflow%2Fsrc%2Fimpls%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_dataflow%2Fsrc%2Fimpls%2Fmod.rs?ref=4153a2ec45f79b4ddf1968b163590f3d1130007f", "patch": "@@ -23,6 +23,7 @@ mod init_locals;\n mod liveness;\n mod storage_liveness;\n \n+pub use self::borrowed_locals::borrowed_locals;\n pub use self::borrowed_locals::MaybeBorrowedLocals;\n pub use self::init_locals::MaybeInitializedLocals;\n pub use self::liveness::MaybeLiveLocals;"}, {"sha": "28f3790914b38e4d329600dd58d6a89f28320c8a", "filename": "compiler/rustc_mir_transform/src/dead_store_elimination.rs", "status": "modified", "additions": 6, "deletions": 68, "changes": 74, "blob_url": "https://github.com/rust-lang/rust/blob/4153a2ec45f79b4ddf1968b163590f3d1130007f/compiler%2Frustc_mir_transform%2Fsrc%2Fdead_store_elimination.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4153a2ec45f79b4ddf1968b163590f3d1130007f/compiler%2Frustc_mir_transform%2Fsrc%2Fdead_store_elimination.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_transform%2Fsrc%2Fdead_store_elimination.rs?ref=4153a2ec45f79b4ddf1968b163590f3d1130007f", "patch": "@@ -13,16 +13,15 @@\n //!\n \n use rustc_index::bit_set::BitSet;\n-use rustc_middle::{\n-    mir::{visit::Visitor, *},\n-    ty::TyCtxt,\n-};\n-use rustc_mir_dataflow::{impls::MaybeTransitiveLiveLocals, Analysis};\n+use rustc_middle::mir::*;\n+use rustc_middle::ty::TyCtxt;\n+use rustc_mir_dataflow::impls::{borrowed_locals, MaybeTransitiveLiveLocals};\n+use rustc_mir_dataflow::Analysis;\n \n /// Performs the optimization on the body\n ///\n /// The `borrowed` set must be a `BitSet` of all the locals that are ever borrowed in this body. It\n-/// can be generated via the [`get_borrowed_locals`] function.\n+/// can be generated via the [`borrowed_locals`] function.\n pub fn eliminate<'tcx>(tcx: TyCtxt<'tcx>, body: &mut Body<'tcx>, borrowed: &BitSet<Local>) {\n     let mut live = MaybeTransitiveLiveLocals::new(borrowed)\n         .into_engine(tcx, body)\n@@ -73,67 +72,6 @@ pub fn eliminate<'tcx>(tcx: TyCtxt<'tcx>, body: &mut Body<'tcx>, borrowed: &BitS\n     }\n }\n \n-pub fn get_borrowed_locals(body: &Body<'_>) -> BitSet<Local> {\n-    let mut b = BorrowedLocals(BitSet::new_empty(body.local_decls.len()));\n-    b.visit_body(body);\n-    b.0\n-}\n-\n-struct BorrowedLocals(BitSet<Local>);\n-\n-impl<'tcx> Visitor<'tcx> for BorrowedLocals {\n-    fn visit_rvalue(&mut self, rvalue: &Rvalue<'tcx>, loc: Location) {\n-        self.super_rvalue(rvalue, loc);\n-        match rvalue {\n-            Rvalue::AddressOf(_, borrowed_place) | Rvalue::Ref(_, _, borrowed_place) => {\n-                if !borrowed_place.is_indirect() {\n-                    self.0.insert(borrowed_place.local);\n-                }\n-            }\n-\n-            Rvalue::Cast(..)\n-            | Rvalue::ShallowInitBox(..)\n-            | Rvalue::Use(..)\n-            | Rvalue::Repeat(..)\n-            | Rvalue::Len(..)\n-            | Rvalue::BinaryOp(..)\n-            | Rvalue::CheckedBinaryOp(..)\n-            | Rvalue::NullaryOp(..)\n-            | Rvalue::UnaryOp(..)\n-            | Rvalue::Discriminant(..)\n-            | Rvalue::Aggregate(..)\n-            | Rvalue::ThreadLocalRef(..) => {}\n-        }\n-    }\n-\n-    fn visit_terminator(&mut self, terminator: &Terminator<'tcx>, location: Location) {\n-        self.super_terminator(terminator, location);\n-\n-        match terminator.kind {\n-            TerminatorKind::Drop { place: dropped_place, .. } => {\n-                if !dropped_place.is_indirect() {\n-                    self.0.insert(dropped_place.local);\n-                }\n-            }\n-\n-            TerminatorKind::Abort\n-            | TerminatorKind::DropAndReplace { .. }\n-            | TerminatorKind::Assert { .. }\n-            | TerminatorKind::Call { .. }\n-            | TerminatorKind::FalseEdge { .. }\n-            | TerminatorKind::FalseUnwind { .. }\n-            | TerminatorKind::GeneratorDrop\n-            | TerminatorKind::Goto { .. }\n-            | TerminatorKind::Resume\n-            | TerminatorKind::Return\n-            | TerminatorKind::SwitchInt { .. }\n-            | TerminatorKind::Unreachable\n-            | TerminatorKind::Yield { .. }\n-            | TerminatorKind::InlineAsm { .. } => {}\n-        }\n-    }\n-}\n-\n pub struct DeadStoreElimination;\n \n impl<'tcx> MirPass<'tcx> for DeadStoreElimination {\n@@ -142,7 +80,7 @@ impl<'tcx> MirPass<'tcx> for DeadStoreElimination {\n     }\n \n     fn run_pass(&self, tcx: TyCtxt<'tcx>, body: &mut Body<'tcx>) {\n-        let borrowed = get_borrowed_locals(body);\n+        let borrowed = borrowed_locals(body);\n         eliminate(tcx, body, &borrowed);\n     }\n }"}, {"sha": "84c7aada5e57f1fa43ffb5f8c272b2c927dfd533", "filename": "compiler/rustc_mir_transform/src/dest_prop.rs", "status": "modified", "additions": 2, "deletions": 65, "changes": 67, "blob_url": "https://github.com/rust-lang/rust/blob/4153a2ec45f79b4ddf1968b163590f3d1130007f/compiler%2Frustc_mir_transform%2Fsrc%2Fdest_prop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4153a2ec45f79b4ddf1968b163590f3d1130007f/compiler%2Frustc_mir_transform%2Fsrc%2Fdest_prop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_transform%2Fsrc%2Fdest_prop.rs?ref=4153a2ec45f79b4ddf1968b163590f3d1130007f", "patch": "@@ -104,7 +104,7 @@ use rustc_middle::mir::{\n     Rvalue, Statement, StatementKind, Terminator, TerminatorKind,\n };\n use rustc_middle::ty::TyCtxt;\n-use rustc_mir_dataflow::impls::{MaybeInitializedLocals, MaybeLiveLocals};\n+use rustc_mir_dataflow::impls::{borrowed_locals, MaybeInitializedLocals, MaybeLiveLocals};\n use rustc_mir_dataflow::Analysis;\n \n // Empirical measurements have resulted in some observations:\n@@ -805,7 +805,7 @@ fn find_candidates<'tcx>(body: &Body<'tcx>) -> Vec<CandidateAssignment<'tcx>> {\n     let mut visitor = FindAssignments {\n         body,\n         candidates: Vec::new(),\n-        ever_borrowed_locals: ever_borrowed_locals(body),\n+        ever_borrowed_locals: borrowed_locals(body),\n         locals_used_as_array_index: locals_used_as_array_index(body),\n     };\n     visitor.visit_body(body);\n@@ -886,69 +886,6 @@ fn is_local_required(local: Local, body: &Body<'_>) -> bool {\n     }\n }\n \n-/// Walks MIR to find all locals that have their address taken anywhere.\n-fn ever_borrowed_locals(body: &Body<'_>) -> BitSet<Local> {\n-    let mut visitor = BorrowCollector { locals: BitSet::new_empty(body.local_decls.len()) };\n-    visitor.visit_body(body);\n-    visitor.locals\n-}\n-\n-struct BorrowCollector {\n-    locals: BitSet<Local>,\n-}\n-\n-impl<'tcx> Visitor<'tcx> for BorrowCollector {\n-    fn visit_rvalue(&mut self, rvalue: &Rvalue<'tcx>, location: Location) {\n-        self.super_rvalue(rvalue, location);\n-\n-        match rvalue {\n-            Rvalue::AddressOf(_, borrowed_place) | Rvalue::Ref(_, _, borrowed_place) => {\n-                if !borrowed_place.is_indirect() {\n-                    self.locals.insert(borrowed_place.local);\n-                }\n-            }\n-\n-            Rvalue::Cast(..)\n-            | Rvalue::ShallowInitBox(..)\n-            | Rvalue::Use(..)\n-            | Rvalue::Repeat(..)\n-            | Rvalue::Len(..)\n-            | Rvalue::BinaryOp(..)\n-            | Rvalue::CheckedBinaryOp(..)\n-            | Rvalue::NullaryOp(..)\n-            | Rvalue::UnaryOp(..)\n-            | Rvalue::Discriminant(..)\n-            | Rvalue::Aggregate(..)\n-            | Rvalue::ThreadLocalRef(..) => {}\n-        }\n-    }\n-\n-    fn visit_terminator(&mut self, terminator: &Terminator<'tcx>, location: Location) {\n-        self.super_terminator(terminator, location);\n-\n-        match terminator.kind {\n-            TerminatorKind::Drop { place: dropped_place, .. }\n-            | TerminatorKind::DropAndReplace { place: dropped_place, .. } => {\n-                self.locals.insert(dropped_place.local);\n-            }\n-\n-            TerminatorKind::Abort\n-            | TerminatorKind::Assert { .. }\n-            | TerminatorKind::Call { .. }\n-            | TerminatorKind::FalseEdge { .. }\n-            | TerminatorKind::FalseUnwind { .. }\n-            | TerminatorKind::GeneratorDrop\n-            | TerminatorKind::Goto { .. }\n-            | TerminatorKind::Resume\n-            | TerminatorKind::Return\n-            | TerminatorKind::SwitchInt { .. }\n-            | TerminatorKind::Unreachable\n-            | TerminatorKind::Yield { .. }\n-            | TerminatorKind::InlineAsm { .. } => {}\n-        }\n-    }\n-}\n-\n /// `PlaceElem::Index` only stores a `Local`, so we can't replace that with a full `Place`.\n ///\n /// Collect locals used as indices so we don't generate candidates that are impossible to apply"}]}