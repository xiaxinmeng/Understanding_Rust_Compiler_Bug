{"sha": "5b8b01e8dc9d5ba7209256061c8ace789f95e432", "node_id": "MDY6Q29tbWl0NzI0NzEyOjViOGIwMWU4ZGM5ZDViYTcyMDkyNTYwNjFjOGFjZTc4OWY5NWU0MzI=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-01-03T15:08:47Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-01-03T15:08:47Z"}, "message": "Auto merge of #3519 - phansch:brave_newer_ui_tests, r=flip1995\n\nIntegrate rustfix into Clippy test suite\n\nOnce the [PR to compiletest-rs](https://github.com/laumann/compiletest-rs/pull/151) is reviewed and merged this fixes #2376.\n\nI will create a separate tracking issue for adding `run-rustfix` to all tests.", "tree": {"sha": "7a3fbe4c8c1ada6ce8ac9df739863bf200c1df4b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7a3fbe4c8c1ada6ce8ac9df739863bf200c1df4b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5b8b01e8dc9d5ba7209256061c8ace789f95e432", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5b8b01e8dc9d5ba7209256061c8ace789f95e432", "html_url": "https://github.com/rust-lang/rust/commit/5b8b01e8dc9d5ba7209256061c8ace789f95e432", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5b8b01e8dc9d5ba7209256061c8ace789f95e432/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "baec524fac2f627c1bddd3bce57448c32a86d8aa", "url": "https://api.github.com/repos/rust-lang/rust/commits/baec524fac2f627c1bddd3bce57448c32a86d8aa", "html_url": "https://github.com/rust-lang/rust/commit/baec524fac2f627c1bddd3bce57448c32a86d8aa"}, {"sha": "ec1395aafbf4c95ad9043cc256eb66bd0d622bb5", "url": "https://api.github.com/repos/rust-lang/rust/commits/ec1395aafbf4c95ad9043cc256eb66bd0d622bb5", "html_url": "https://github.com/rust-lang/rust/commit/ec1395aafbf4c95ad9043cc256eb66bd0d622bb5"}], "stats": {"total": 58, "additions": 47, "deletions": 11}, "files": [{"sha": "df216a8fbc953877d5b56399974c7be012b0b810", "filename": "CONTRIBUTING.md", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/5b8b01e8dc9d5ba7209256061c8ace789f95e432/CONTRIBUTING.md", "raw_url": "https://github.com/rust-lang/rust/raw/5b8b01e8dc9d5ba7209256061c8ace789f95e432/CONTRIBUTING.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/CONTRIBUTING.md?ref=5b8b01e8dc9d5ba7209256061c8ace789f95e432", "patch": "@@ -156,6 +156,15 @@ Therefore you should use `tests/ui/update-all-references.sh` (after running\n `cargo test`) and check whether the output looks as you expect with `git diff`. Commit all\n `*.stderr` files, too.\n \n+If the lint you are working on is making use of structured suggestions, the\n+test file should include a `// run-rustfix` comment at the top. This will\n+additionally run [rustfix](https://github.com/rust-lang-nursery/rustfix) for\n+that test. Rustfix will apply the suggestions from the lint to the code of the\n+test file and compare that to the contents of a `.fixed` file.\n+\n+Use `tests/ui/update-all-references.sh` to automatically generate the\n+`.fixed` file after running `cargo test`.\n+\n ### Running rustfmt\n \n [Rustfmt](https://github.com/rust-lang/rustfmt) is a tool for formatting Rust code according"}, {"sha": "ce609bb1addeef19636655e504740b3894bbac8b", "filename": "Cargo.toml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/5b8b01e8dc9d5ba7209256061c8ace789f95e432/Cargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/5b8b01e8dc9d5ba7209256061c8ace789f95e432/Cargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.toml?ref=5b8b01e8dc9d5ba7209256061c8ace789f95e432", "patch": "@@ -48,7 +48,7 @@ rustc_tools_util = { version = \"0.1.1\", path = \"rustc_tools_util\"}\n [dev-dependencies]\n clippy_dev = { version = \"0.0.1\", path = \"clippy_dev\" }\n cargo_metadata = \"0.6.2\"\n-compiletest_rs = \"0.3.16\"\n+compiletest_rs = \"0.3.18\"\n lazy_static = \"1.0\"\n serde_derive = \"1.0\"\n clippy-mini-macro-test = { version = \"0.2\", path = \"mini-macro\" }"}, {"sha": "54a9c0336f044b401c09537064becbffcf766cfa", "filename": "clippy_lints/src/reference.rs", "status": "modified", "additions": 2, "deletions": 6, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/5b8b01e8dc9d5ba7209256061c8ace789f95e432/clippy_lints%2Fsrc%2Freference.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5b8b01e8dc9d5ba7209256061c8ace789f95e432/clippy_lints%2Fsrc%2Freference.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Freference.rs?ref=5b8b01e8dc9d5ba7209256061c8ace789f95e432", "patch": "@@ -98,7 +98,7 @@ impl LintPass for DerefPass {\n impl EarlyLintPass for DerefPass {\n     fn check_expr(&mut self, cx: &EarlyContext<'_>, e: &Expr) {\n         if_chain! {\n-            if let ExprKind::Field(ref object, ref field_name) = e.node;\n+            if let ExprKind::Field(ref object, _) = e.node;\n             if let ExprKind::Paren(ref parened) = object.node;\n             if let ExprKind::AddrOf(_, ref inner) = parened.node;\n             then {\n@@ -109,11 +109,7 @@ impl EarlyLintPass for DerefPass {\n                     object.span,\n                     \"Creating a reference that is immediately dereferenced.\",\n                     \"try this\",\n-                    format!(\n-                        \"{}.{}\",\n-                        snippet_with_applicability(cx, inner.span, \"_\", &mut applicability),\n-                        snippet_with_applicability(cx, field_name.span, \"_\", &mut applicability)\n-                    ),\n+                    snippet_with_applicability(cx, inner.span, \"_\", &mut applicability).to_string(),\n                     applicability,\n                 );\n             }"}, {"sha": "3617641a116c4a0e34303f143a0dee721ec4d7a5", "filename": "tests/ui/unnecessary_ref.fixed", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/5b8b01e8dc9d5ba7209256061c8ace789f95e432/tests%2Fui%2Funnecessary_ref.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/5b8b01e8dc9d5ba7209256061c8ace789f95e432/tests%2Fui%2Funnecessary_ref.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Funnecessary_ref.fixed?ref=5b8b01e8dc9d5ba7209256061c8ace789f95e432", "patch": "@@ -0,0 +1,23 @@\n+// Copyright 2014-2018 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// run-rustfix\n+\n+#![feature(stmt_expr_attributes)]\n+#![allow(unused_variables)]\n+\n+struct Outer {\n+    inner: u32,\n+}\n+\n+#[deny(clippy::ref_in_deref)]\n+fn main() {\n+    let outer = Outer { inner: 0 };\n+    let inner = outer.inner;\n+}"}, {"sha": "48101c87a54ed80232a0482c547d901f3d567742", "filename": "tests/ui/unnecessary_ref.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/5b8b01e8dc9d5ba7209256061c8ace789f95e432/tests%2Fui%2Funnecessary_ref.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5b8b01e8dc9d5ba7209256061c8ace789f95e432/tests%2Fui%2Funnecessary_ref.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Funnecessary_ref.rs?ref=5b8b01e8dc9d5ba7209256061c8ace789f95e432", "patch": "@@ -7,8 +7,10 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n-#![feature(tool_attributes)]\n+// run-rustfix\n+\n #![feature(stmt_expr_attributes)]\n+#![allow(unused_variables)]\n \n struct Outer {\n     inner: u32,"}, {"sha": "863a6389e7fc99b702d7eb6fee8ead3c9a6eaaa1", "filename": "tests/ui/unnecessary_ref.stderr", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/5b8b01e8dc9d5ba7209256061c8ace789f95e432/tests%2Fui%2Funnecessary_ref.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/5b8b01e8dc9d5ba7209256061c8ace789f95e432/tests%2Fui%2Funnecessary_ref.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Funnecessary_ref.stderr?ref=5b8b01e8dc9d5ba7209256061c8ace789f95e432", "patch": "@@ -1,11 +1,11 @@\n error: Creating a reference that is immediately dereferenced.\n-  --> $DIR/unnecessary_ref.rs:20:17\n+  --> $DIR/unnecessary_ref.rs:22:17\n    |\n LL |     let inner = (&outer).inner;\n-   |                 ^^^^^^^^ help: try this: `outer.inner`\n+   |                 ^^^^^^^^ help: try this: `outer`\n    |\n note: lint level defined here\n-  --> $DIR/unnecessary_ref.rs:17:8\n+  --> $DIR/unnecessary_ref.rs:19:8\n    |\n LL | #[deny(clippy::ref_in_deref)]\n    |        ^^^^^^^^^^^^^^^^^^^^"}, {"sha": "d6995985a3b1de1a9f9d61859e1f2a752c4cbc3e", "filename": "tests/ui/update-references.sh", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/5b8b01e8dc9d5ba7209256061c8ace789f95e432/tests%2Fui%2Fupdate-references.sh", "raw_url": "https://github.com/rust-lang/rust/raw/5b8b01e8dc9d5ba7209256061c8ace789f95e432/tests%2Fui%2Fupdate-references.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fupdate-references.sh?ref=5b8b01e8dc9d5ba7209256061c8ace789f95e432", "patch": "@@ -34,6 +34,7 @@ shift\n while [[ \"$1\" != \"\" ]]; do\n     STDERR_NAME=\"${1/%.rs/.stderr}\"\n     STDOUT_NAME=\"${1/%.rs/.stdout}\"\n+    FIXED_NAME=\"${1/%.rs/.fixed}\"\n     shift\n     if [ -f $BUILD_DIR/$STDOUT_NAME ] && \\\n            ! (diff $BUILD_DIR/$STDOUT_NAME $MYDIR/$STDOUT_NAME >& /dev/null); then\n@@ -45,6 +46,11 @@ while [[ \"$1\" != \"\" ]]; do\n         echo updating $MYDIR/$STDERR_NAME\n         cp $BUILD_DIR/$STDERR_NAME $MYDIR/$STDERR_NAME\n     fi\n+    if [ -f $BUILD_DIR/$FIXED_NAME ] && \\\n+           ! (diff $BUILD_DIR/$FIXED_NAME $MYDIR/$FIXED_NAME >& /dev/null); then\n+        echo updating $MYDIR/$FIXED_NAME\n+        cp $BUILD_DIR/$FIXED_NAME $MYDIR/$FIXED_NAME\n+    fi\n done\n \n "}]}