{"sha": "5faf033f62512cbc2a0deaac7860950e38a60a45", "node_id": "C_kwDOAAsO6NoAKDVmYWYwMzNmNjI1MTJjYmMyYTBkZWFhYzc4NjA5NTBlMzhhNjBhNDU", "commit": {"author": {"name": "Dylan DPC", "email": "99973273+Dylan-DPC@users.noreply.github.com", "date": "2022-09-12T09:51:33Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-09-12T09:51:33Z"}, "message": "Rollup merge of #101676 - compiler-errors:rpitit-wf, r=lcnr\n\nCheck that the types in return position `impl Trait` in traits are well-formed\n\nThis effectively duplicates `check_associated_type_bounds`, but that shouldn't be for long, since we're going to remove it once we refactor RPITITs into regular associated items.\n\nFixes #101663\n\n---\n\nWe don't check\n\n```rust\ntrait Foo {\n  fn bar() -> impl ?Sized;\n}\n```\n\ncurrently, but that's for a different reason, which is that we don't currently check that a trait function's return type is sized (i.e. `fn bar() -> [u8]` also works in a trait).", "tree": {"sha": "8698ffce641d7f3e973df7300b7361fde9aca434", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8698ffce641d7f3e973df7300b7361fde9aca434"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5faf033f62512cbc2a0deaac7860950e38a60a45", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjHwElCRBK7hj4Ov3rIwAAtK8IAKjsT0B/XCTHjj+GCGxZy9Eg\nB1n4JP3QohS7I0rLi9BvsZyXtx4xSXMZc3NsomOVr6IwLDqSKPoRFDorHEXE/3AK\nlOSeyvMUDbDoRxcHojSeJS5MZ6nFUAPaMZYNMxxRiJIr/yrNYhdw6m2UOg39TZ5R\nmeC1Z4jtVigtXSN7oIkv5vmcJ3hEGU7ia5Pw//cZ5jPIPjEGUD/qPvc/XUPFdo/R\nhtNHnEYgwFM6rk1lOuf5BLiDkW8cgFdffUCFnvPz3az+cUvGwl+iKtZXufDdCsXc\n5FzbqPcZRaYyGMERPseUY1pytSRkH7knOEsVs610IFq9Gci05yW7c+EAIplLE2I=\n=dyrx\n-----END PGP SIGNATURE-----\n", "payload": "tree 8698ffce641d7f3e973df7300b7361fde9aca434\nparent 10af4fb5301a69cc9db46684290f3f77a4b65269\nparent fd2766e7fde443d46eb051bb5ef27bbb29ee101d\nauthor Dylan DPC <99973273+Dylan-DPC@users.noreply.github.com> 1662976293 +0530\ncommitter GitHub <noreply@github.com> 1662976293 +0530\n\nRollup merge of #101676 - compiler-errors:rpitit-wf, r=lcnr\n\nCheck that the types in return position `impl Trait` in traits are well-formed\n\nThis effectively duplicates `check_associated_type_bounds`, but that shouldn't be for long, since we're going to remove it once we refactor RPITITs into regular associated items.\n\nFixes #101663\n\n---\n\nWe don't check\n\n```rust\ntrait Foo {\n  fn bar() -> impl ?Sized;\n}\n```\n\ncurrently, but that's for a different reason, which is that we don't currently check that a trait function's return type is sized (i.e. `fn bar() -> [u8]` also works in a trait).\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5faf033f62512cbc2a0deaac7860950e38a60a45", "html_url": "https://github.com/rust-lang/rust/commit/5faf033f62512cbc2a0deaac7860950e38a60a45", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5faf033f62512cbc2a0deaac7860950e38a60a45/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "10af4fb5301a69cc9db46684290f3f77a4b65269", "url": "https://api.github.com/repos/rust-lang/rust/commits/10af4fb5301a69cc9db46684290f3f77a4b65269", "html_url": "https://github.com/rust-lang/rust/commit/10af4fb5301a69cc9db46684290f3f77a4b65269"}, {"sha": "fd2766e7fde443d46eb051bb5ef27bbb29ee101d", "url": "https://api.github.com/repos/rust-lang/rust/commits/fd2766e7fde443d46eb051bb5ef27bbb29ee101d", "html_url": "https://github.com/rust-lang/rust/commit/fd2766e7fde443d46eb051bb5ef27bbb29ee101d"}], "stats": {"total": 93, "additions": 93, "deletions": 0}, "files": [{"sha": "bc644c694a078c0869ca3e72fdef48a1b1c9d0a0", "filename": "compiler/rustc_typeck/src/check/wfcheck.rs", "status": "modified", "additions": 44, "deletions": 0, "changes": 44, "blob_url": "https://github.com/rust-lang/rust/blob/5faf033f62512cbc2a0deaac7860950e38a60a45/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fwfcheck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5faf033f62512cbc2a0deaac7860950e38a60a45/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fwfcheck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fwfcheck.rs?ref=5faf033f62512cbc2a0deaac7860950e38a60a45", "patch": "@@ -1,4 +1,5 @@\n use crate::constrained_generic_params::{identify_constrained_generic_params, Parameter};\n+use hir::def::DefKind;\n use rustc_ast as ast;\n use rustc_data_structures::fx::{FxHashMap, FxHashSet};\n use rustc_errors::{pluralize, struct_span_err, Applicability, DiagnosticBuilder, ErrorGuaranteed};\n@@ -1530,6 +1531,49 @@ fn check_fn_or_method<'tcx>(\n     );\n \n     check_where_clauses(wfcx, span, def_id);\n+\n+    check_return_position_impl_trait_in_trait_bounds(\n+        tcx,\n+        wfcx,\n+        def_id,\n+        sig.output(),\n+        hir_decl.output.span(),\n+    );\n+}\n+\n+/// Basically `check_associated_type_bounds`, but separated for now and should be\n+/// deduplicated when RPITITs get lowered into real associated items.\n+fn check_return_position_impl_trait_in_trait_bounds<'tcx>(\n+    tcx: TyCtxt<'tcx>,\n+    wfcx: &WfCheckingCtxt<'_, 'tcx>,\n+    fn_def_id: LocalDefId,\n+    fn_output: Ty<'tcx>,\n+    span: Span,\n+) {\n+    if let Some(assoc_item) = tcx.opt_associated_item(fn_def_id.to_def_id())\n+        && assoc_item.container == ty::AssocItemContainer::TraitContainer\n+    {\n+        for arg in fn_output.walk() {\n+            if let ty::GenericArgKind::Type(ty) = arg.unpack()\n+                && let ty::Projection(proj) = ty.kind()\n+                && tcx.def_kind(proj.item_def_id) == DefKind::ImplTraitPlaceholder\n+                && tcx.impl_trait_in_trait_parent(proj.item_def_id) == fn_def_id.to_def_id()\n+            {\n+                let bounds = wfcx.tcx().explicit_item_bounds(proj.item_def_id);\n+                let wf_obligations = bounds.iter().flat_map(|&(bound, bound_span)| {\n+                    let normalized_bound = wfcx.normalize(span, None, bound);\n+                    traits::wf::predicate_obligations(\n+                        wfcx.infcx,\n+                        wfcx.param_env,\n+                        wfcx.body_id,\n+                        normalized_bound,\n+                        bound_span,\n+                    )\n+                });\n+                wfcx.register_obligations(wf_obligations);\n+            }\n+        }\n+    }\n }\n \n const HELP_FOR_SELF_TYPE: &str = \"consider changing to `self`, `&self`, `&mut self`, `self: Box<Self>`, \\"}, {"sha": "2c71583b3123685e2077f9bb583dc8546ea60c18", "filename": "src/test/ui/impl-trait/in-trait/wf-bounds.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/5faf033f62512cbc2a0deaac7860950e38a60a45/src%2Ftest%2Fui%2Fimpl-trait%2Fin-trait%2Fwf-bounds.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5faf033f62512cbc2a0deaac7860950e38a60a45/src%2Ftest%2Fui%2Fimpl-trait%2Fin-trait%2Fwf-bounds.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fimpl-trait%2Fin-trait%2Fwf-bounds.rs?ref=5faf033f62512cbc2a0deaac7860950e38a60a45", "patch": "@@ -0,0 +1,16 @@\n+// issue #101663\n+\n+#![feature(return_position_impl_trait_in_trait)]\n+#![allow(incomplete_features)]\n+\n+trait Wf<T> {}\n+\n+trait Uwu {\n+    fn nya() -> impl Wf<Vec<[u8]>>;\n+    //~^ ERROR the size for values of type `[u8]` cannot be known at compilation time\n+\n+    fn nya2() -> impl Wf<[u8]>;\n+    //~^ ERROR the size for values of type `[u8]` cannot be known at compilation time\n+}\n+\n+fn main() {}"}, {"sha": "92e36841b70c208c4387bc1365b7a2d09368a3ec", "filename": "src/test/ui/impl-trait/in-trait/wf-bounds.stderr", "status": "added", "additions": 33, "deletions": 0, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/5faf033f62512cbc2a0deaac7860950e38a60a45/src%2Ftest%2Fui%2Fimpl-trait%2Fin-trait%2Fwf-bounds.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/5faf033f62512cbc2a0deaac7860950e38a60a45/src%2Ftest%2Fui%2Fimpl-trait%2Fin-trait%2Fwf-bounds.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fimpl-trait%2Fin-trait%2Fwf-bounds.stderr?ref=5faf033f62512cbc2a0deaac7860950e38a60a45", "patch": "@@ -0,0 +1,33 @@\n+error[E0277]: the size for values of type `[u8]` cannot be known at compilation time\n+  --> $DIR/wf-bounds.rs:9:22\n+   |\n+LL |     fn nya() -> impl Wf<Vec<[u8]>>;\n+   |                      ^^^^^^^^^^^^^ doesn't have a size known at compile-time\n+   |\n+   = help: the trait `Sized` is not implemented for `[u8]`\n+note: required by a bound in `Vec`\n+  --> $SRC_DIR/alloc/src/vec/mod.rs:LL:COL\n+   |\n+LL | pub struct Vec<T, #[unstable(feature = \"allocator_api\", issue = \"32838\")] A: Allocator = Global> {\n+   |                ^ required by this bound in `Vec`\n+\n+error[E0277]: the size for values of type `[u8]` cannot be known at compilation time\n+  --> $DIR/wf-bounds.rs:12:23\n+   |\n+LL |     fn nya2() -> impl Wf<[u8]>;\n+   |                       ^^^^^^^^ doesn't have a size known at compile-time\n+   |\n+   = help: the trait `Sized` is not implemented for `[u8]`\n+note: required by a bound in `Wf`\n+  --> $DIR/wf-bounds.rs:6:10\n+   |\n+LL | trait Wf<T> {}\n+   |          ^ required by this bound in `Wf`\n+help: consider relaxing the implicit `Sized` restriction\n+   |\n+LL | trait Wf<T: ?Sized> {}\n+   |           ++++++++\n+\n+error: aborting due to 2 previous errors\n+\n+For more information about this error, try `rustc --explain E0277`."}]}