{"sha": "83332539dd19f61893846e907d55c9abd613d007", "node_id": "C_kwDOAAsO6NoAKDgzMzMyNTM5ZGQxOWY2MTg5Mzg0NmU5MDdkNTVjOWFiZDYxM2QwMDc", "commit": {"author": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-10-22T06:43:51Z"}, "committer": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-10-22T06:44:41Z"}, "message": "Check fat pointer metadata compatibility modulo regions", "tree": {"sha": "fed89456e0cac8b0e433793461387b8e517c7d60", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fed89456e0cac8b0e433793461387b8e517c7d60"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/83332539dd19f61893846e907d55c9abd613d007", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/83332539dd19f61893846e907d55c9abd613d007", "html_url": "https://github.com/rust-lang/rust/commit/83332539dd19f61893846e907d55c9abd613d007", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/83332539dd19f61893846e907d55c9abd613d007/comments", "author": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0940040c0486a536be4f8685c7dd9a078f9e87c2", "url": "https://api.github.com/repos/rust-lang/rust/commits/0940040c0486a536be4f8685c7dd9a078f9e87c2", "html_url": "https://github.com/rust-lang/rust/commit/0940040c0486a536be4f8685c7dd9a078f9e87c2"}], "stats": {"total": 30, "additions": 24, "deletions": 6}, "files": [{"sha": "0757a2d6d9a38846e1e4103bef6a684223c0f7c6", "filename": "compiler/rustc_hir_typeck/src/cast.rs", "status": "modified", "additions": 7, "deletions": 6, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/83332539dd19f61893846e907d55c9abd613d007/compiler%2Frustc_hir_typeck%2Fsrc%2Fcast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/83332539dd19f61893846e907d55c9abd613d007/compiler%2Frustc_hir_typeck%2Fsrc%2Fcast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_typeck%2Fsrc%2Fcast.rs?ref=83332539dd19f61893846e907d55c9abd613d007", "patch": "@@ -33,6 +33,7 @@ use super::FnCtxt;\n use crate::type_error_struct;\n use rustc_errors::{struct_span_err, Applicability, DelayDm, DiagnosticBuilder, ErrorGuaranteed};\n use rustc_hir as hir;\n+use rustc_macros::{TypeFoldable, TypeVisitable};\n use rustc_middle::mir::Mutability;\n use rustc_middle::ty::adjustment::AllowTwoPhase;\n use rustc_middle::ty::cast::{CastKind, CastTy};\n@@ -65,7 +66,7 @@ pub struct CastCheck<'tcx> {\n /// The kind of pointer and associated metadata (thin, length or vtable) - we\n /// only allow casts between fat pointers if their metadata have the same\n /// kind.\n-#[derive(Copy, Clone, PartialEq, Eq)]\n+#[derive(Debug, Copy, Clone, PartialEq, Eq, TypeVisitable, TypeFoldable)]\n enum PointerKind<'tcx> {\n     /// No metadata attached, ie pointer to sized type or foreign type\n     Thin,\n@@ -74,11 +75,11 @@ enum PointerKind<'tcx> {\n     /// Slice\n     Length,\n     /// The unsize info of this projection\n-    OfProjection(&'tcx ty::ProjectionTy<'tcx>),\n+    OfProjection(ty::ProjectionTy<'tcx>),\n     /// The unsize info of this opaque ty\n     OfOpaque(DefId, SubstsRef<'tcx>),\n     /// The unsize info of this parameter\n-    OfParam(&'tcx ty::ParamTy),\n+    OfParam(ty::ParamTy),\n }\n \n impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n@@ -119,9 +120,9 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n             // Pointers to foreign types are thin, despite being unsized\n             ty::Foreign(..) => Some(PointerKind::Thin),\n             // We should really try to normalize here.\n-            ty::Projection(ref pi) => Some(PointerKind::OfProjection(pi)),\n+            ty::Projection(pi) => Some(PointerKind::OfProjection(pi)),\n             ty::Opaque(def_id, substs) => Some(PointerKind::OfOpaque(def_id, substs)),\n-            ty::Param(ref p) => Some(PointerKind::OfParam(p)),\n+            ty::Param(p) => Some(PointerKind::OfParam(p)),\n             // Insufficient type information.\n             ty::Placeholder(..) | ty::Bound(..) | ty::Infer(_) => None,\n \n@@ -903,7 +904,7 @@ impl<'a, 'tcx> CastCheck<'tcx> {\n         }\n \n         // vtable kinds must match\n-        if cast_kind == expr_kind {\n+        if fcx.tcx.erase_regions(cast_kind) == fcx.tcx.erase_regions(expr_kind) {\n             Ok(CastKind::PtrPtrCast)\n         } else {\n             Err(CastError::DifferingKinds)"}, {"sha": "f51c5f20f167c5e53959cca3bd3bdbc1db581820", "filename": "src/test/ui/cast/cast-pointee-projection.rs", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/83332539dd19f61893846e907d55c9abd613d007/src%2Ftest%2Fui%2Fcast%2Fcast-pointee-projection.rs", "raw_url": "https://github.com/rust-lang/rust/raw/83332539dd19f61893846e907d55c9abd613d007/src%2Ftest%2Fui%2Fcast%2Fcast-pointee-projection.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcast%2Fcast-pointee-projection.rs?ref=83332539dd19f61893846e907d55c9abd613d007", "patch": "@@ -0,0 +1,17 @@\n+// check-pass\n+\n+trait Tag<'a> {\n+    type Type: ?Sized;\n+}\n+\n+trait IntoRaw: for<'a> Tag<'a> {\n+    fn into_raw(this: *const <Self as Tag<'_>>::Type) -> *mut <Self as Tag<'_>>::Type;\n+}\n+\n+impl<T: for<'a> Tag<'a>> IntoRaw for T {\n+    fn into_raw(this: *const <Self as Tag<'_>>::Type) -> *mut <Self as Tag<'_>>::Type {\n+        this as *mut T::Type\n+    }\n+}\n+\n+fn main() {}"}]}