{"sha": "af7554d3a2e9e6171ca44bd1d4828606a9868f74", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFmNzU1NGQzYTJlOWU2MTcxY2E0NGJkMWQ0ODI4NjA2YTk4NjhmNzQ=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-12-02T00:08:58Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-12-02T00:08:58Z"}, "message": "Auto merge of #56396 - dlrobertson:fix_va_list_tests, r=nikic\n\ntests: Simplify VaList run-make test\n\nThe va_list tests were too complex and were causing some spurious\ntest failures on Windows.\n\nExample: https://github.com/rust-lang/rust/pull/55011#issuecomment-443211097", "tree": {"sha": "2aec26d88d736d19c4be7eb1ba486559cf7c19b5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2aec26d88d736d19c4be7eb1ba486559cf7c19b5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/af7554d3a2e9e6171ca44bd1d4828606a9868f74", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/af7554d3a2e9e6171ca44bd1d4828606a9868f74", "html_url": "https://github.com/rust-lang/rust/commit/af7554d3a2e9e6171ca44bd1d4828606a9868f74", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/af7554d3a2e9e6171ca44bd1d4828606a9868f74/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d311571906bd2b22e206b9a84ccb888e248820df", "url": "https://api.github.com/repos/rust-lang/rust/commits/d311571906bd2b22e206b9a84ccb888e248820df", "html_url": "https://github.com/rust-lang/rust/commit/d311571906bd2b22e206b9a84ccb888e248820df"}, {"sha": "28ca35fd132156b1c02110547975385a06ba52f7", "url": "https://api.github.com/repos/rust-lang/rust/commits/28ca35fd132156b1c02110547975385a06ba52f7", "html_url": "https://github.com/rust-lang/rust/commit/28ca35fd132156b1c02110547975385a06ba52f7"}], "stats": {"total": 231, "additions": 57, "deletions": 174}, "files": [{"sha": "90ad6011526c1d41fdb99c0a8ec7683cb9a87563", "filename": "src/test/run-make-fulldeps/c-link-to-rust-va-list-fn/checkrust.rs", "status": "modified", "additions": 45, "deletions": 107, "changes": 152, "blob_url": "https://github.com/rust-lang/rust/blob/af7554d3a2e9e6171ca44bd1d4828606a9868f74/src%2Ftest%2Frun-make-fulldeps%2Fc-link-to-rust-va-list-fn%2Fcheckrust.rs", "raw_url": "https://github.com/rust-lang/rust/raw/af7554d3a2e9e6171ca44bd1d4828606a9868f74/src%2Ftest%2Frun-make-fulldeps%2Fc-link-to-rust-va-list-fn%2Fcheckrust.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fc-link-to-rust-va-list-fn%2Fcheckrust.rs?ref=af7554d3a2e9e6171ca44bd1d4828606a9868f74", "patch": "@@ -16,127 +16,65 @@ extern crate libc;\n \n use libc::{c_char, c_double, c_int, c_long, c_longlong};\n use std::ffi::VaList;\n-use std::slice;\n-use std::ffi::CStr;\n+use std::ffi::{CString, CStr};\n \n-#[repr(C)]\n-#[derive(Clone, Copy, Debug)]\n-pub enum AnswerType {\n-    Double,\n-    Long,\n-    LongLong,\n-    Int,\n-    Byte,\n-    CStr,\n-    Skip,\n+macro_rules! continue_if {\n+    ($cond:expr) => {\n+        if !($cond) {\n+            return 0xff;\n+        }\n+    }\n }\n \n-#[repr(C)]\n-pub union AnswerData {\n-    pub double: c_double,\n-    pub long: c_long,\n-    pub longlong: c_longlong,\n-    pub int: c_int,\n-    pub byte: c_char,\n-    pub cstr: *const c_char,\n-    pub skip_ty: AnswerType,\n+unsafe fn compare_c_str(ptr: *const c_char, val: &str) -> bool {\n+    let cstr0 = CStr::from_ptr(ptr);\n+    let cstr1 = CString::new(val).unwrap();\n+    &*cstr1 == cstr0\n }\n \n-#[repr(C)]\n-pub struct Answer {\n-    tag: AnswerType,\n-    data: AnswerData,\n+#[no_mangle]\n+pub unsafe extern \"C\" fn check_list_0(mut ap: VaList) -> usize {\n+    continue_if!(ap.arg::<c_longlong>() == 1);\n+    continue_if!(ap.arg::<c_int>() == 2);\n+    continue_if!(ap.arg::<c_longlong>() == 3);\n+    0\n }\n \n #[no_mangle]\n-pub unsafe fn compare_answers(answers: &[Answer], mut ap: VaList) -> usize {\n-    for (i, answer) in answers.iter().enumerate() {\n-        match answer {\n-            Answer { tag: AnswerType::Double, data: AnswerData { double: d } } => {\n-                let tmp = ap.arg::<c_double>();\n-                if d.floor() != tmp.floor() {\n-                    println!(\"Double: {} != {}\", d, tmp);\n-                    return i + 1;\n-                }\n-            }\n-            Answer { tag: AnswerType::Long, data: AnswerData { long: l } } => {\n-                let tmp =  ap.arg::<c_long>();\n-                if *l != tmp {\n-                    println!(\"Long: {} != {}\", l, tmp);\n-                    return i + 1;\n-                }\n-            }\n-            Answer { tag: AnswerType::LongLong, data: AnswerData { longlong: l } } => {\n-                let tmp =  ap.arg::<c_longlong>();\n-                if *l != tmp {\n-                    println!(\"Long Long: {} != {}\", l, tmp);\n-                    return i + 1;\n-                }\n-            }\n-            Answer { tag: AnswerType::Int, data: AnswerData { int: n } } => {\n-                let tmp = ap.arg::<c_int>();\n-                if *n != tmp {\n-                    println!(\"Int: {} != {}\", n, tmp);\n-                    return i + 1;\n-                }\n-            }\n-            Answer { tag: AnswerType::Byte, data: AnswerData { byte: b } } => {\n-                let tmp = ap.arg::<c_char>();\n-                if *b != tmp {\n-                    println!(\"Byte: {} != {}\", b, tmp);\n-                    return i + 1;\n-                }\n-            }\n-            Answer { tag: AnswerType::CStr, data: AnswerData { cstr: c0 } } => {\n-                let c1 = ap.arg::<*const c_char>();\n-                let cstr0 = CStr::from_ptr(*c0);\n-                let cstr1 = CStr::from_ptr(c1);\n-                if cstr0 != cstr1 {\n-                    println!(\"C String: {:?} != {:?}\", cstr0, cstr1);\n-                    return i + 1;\n-                }\n-            }\n-            _ => {\n-                println!(\"Unknown type!\");\n-                return i + 1;\n-            }\n-        }\n-    }\n-    return 0;\n+pub unsafe extern \"C\" fn check_list_1(mut ap: VaList) -> usize {\n+    continue_if!(ap.arg::<c_int>() == -1);\n+    continue_if!(ap.arg::<c_char>() == 'A' as c_char);\n+    continue_if!(ap.arg::<c_char>() == '4' as c_char);\n+    continue_if!(ap.arg::<c_char>() == ';' as c_char);\n+    continue_if!(ap.arg::<c_int>() == 0x32);\n+    continue_if!(ap.arg::<c_int>() == 0x10000001);\n+    continue_if!(compare_c_str(ap.arg::<*const c_char>(), \"Valid!\"));\n+    0\n }\n \n #[no_mangle]\n-pub unsafe extern \"C\" fn check_rust(argc: usize, answers: *const Answer, ap: VaList) -> usize {\n-    let slice = slice::from_raw_parts(answers, argc);\n-    compare_answers(slice, ap)\n+pub unsafe extern \"C\" fn check_list_2(mut ap: VaList) -> usize {\n+    continue_if!(ap.arg::<c_double>().floor() == 3.14f64.floor());\n+    continue_if!(ap.arg::<c_long>() == 12);\n+    continue_if!(ap.arg::<c_char>() == 'a' as c_char);\n+    continue_if!(ap.arg::<c_double>().floor() == 6.18f64.floor());\n+    continue_if!(compare_c_str(ap.arg::<*const c_char>(), \"Hello\"));\n+    continue_if!(ap.arg::<c_int>() == 42);\n+    continue_if!(compare_c_str(ap.arg::<*const c_char>(), \"World\"));\n+    0\n }\n \n #[no_mangle]\n-pub unsafe extern \"C\" fn check_rust_copy(argc: usize, answers: *const Answer,\n-                                         mut ap: VaList) -> usize {\n-    let slice = slice::from_raw_parts(answers, argc);\n-    let mut skip_n = 0;\n-    for (i, answer) in slice.iter().enumerate() {\n-        match answer {\n-            Answer { tag: AnswerType::Skip, data: AnswerData { skip_ty } } => {\n-                match skip_ty {\n-                    AnswerType::Double => { ap.arg::<c_double>(); }\n-                    AnswerType::Long => { ap.arg::<c_long>(); }\n-                    AnswerType::LongLong => { ap.arg::<c_longlong>(); }\n-                    AnswerType::Int => { ap.arg::<c_int>(); }\n-                    AnswerType::Byte => { ap.arg::<c_char>(); }\n-                    AnswerType::CStr => { ap.arg::<*const c_char>(); }\n-                    _ => { return i; }\n-                };\n-            }\n-            _ => {\n-                skip_n = i;\n-                break;\n-            }\n+pub unsafe extern \"C\" fn check_list_copy_0(mut ap: VaList) -> usize {\n+    continue_if!(ap.arg::<c_double>().floor() == 6.28f64.floor());\n+    continue_if!(ap.arg::<c_int>() == 16);\n+    continue_if!(ap.arg::<c_char>() == 'A' as c_char);\n+    continue_if!(compare_c_str(ap.arg::<*const c_char>(), \"Skip Me!\"));\n+    ap.copy(|mut ap| {\n+        if compare_c_str(ap.arg::<*const c_char>(), \"Correct\") {\n+            0\n+        } else {\n+            0xff\n         }\n-    }\n-\n-    ap.copy(|ap| {\n-        compare_answers(&slice[skip_n..], ap)\n     })\n }"}, {"sha": "e9edf59d2c9c5cd86fd57f14e41d6763c9f7997d", "filename": "src/test/run-make-fulldeps/c-link-to-rust-va-list-fn/test.c", "status": "modified", "additions": 12, "deletions": 67, "changes": 79, "blob_url": "https://github.com/rust-lang/rust/blob/af7554d3a2e9e6171ca44bd1d4828606a9868f74/src%2Ftest%2Frun-make-fulldeps%2Fc-link-to-rust-va-list-fn%2Ftest.c", "raw_url": "https://github.com/rust-lang/rust/raw/af7554d3a2e9e6171ca44bd1d4828606a9868f74/src%2Ftest%2Frun-make-fulldeps%2Fc-link-to-rust-va-list-fn%2Ftest.c", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fc-link-to-rust-va-list-fn%2Ftest.c?ref=af7554d3a2e9e6171ca44bd1d4828606a9868f74", "patch": "@@ -12,84 +12,29 @@\n #include <assert.h>\n #include <stdint.h>\n #include <stdlib.h>\n+#include <stdio.h>\n \n-typedef enum {\n-    TAG_DOUBLE,\n-    TAG_LONG,\n-    TAG_LONGLONG,\n-    TAG_INT,\n-    TAG_BYTE,\n-    TAG_CSTR,\n-    TAG_SKIP,\n-} tag;\n+extern size_t check_list_0(va_list ap);\n+extern size_t check_list_1(va_list ap);\n+extern size_t check_list_2(va_list ap);\n+extern size_t check_list_copy_0(va_list ap);\n \n-typedef struct {\n-    tag answer_type;\n-    union {\n-        double double_precision;\n-        long num_long;\n-        long long num_longlong;\n-        int num_int;\n-        int8_t byte;\n-        char* cstr;\n-        tag skip_ty;\n-    } answer_data;\n-} answer;\n-\n-#define MK_DOUBLE(n) \\\n-    { TAG_DOUBLE, { .double_precision = n } }\n-#define MK_LONG(n) \\\n-    { TAG_LONG, { .num_long = n } }\n-#define MK_LONGLONG(n) \\\n-    { TAG_LONGLONG, { .num_longlong = n } }\n-#define MK_INT(n) \\\n-    { TAG_INT, { .num_int = n } }\n-#define MK_BYTE(b) \\\n-    { TAG_BYTE, { .byte = b } }\n-#define MK_CSTR(s) \\\n-    { TAG_CSTR, { .cstr = s } }\n-#define MK_SKIP(ty) \\\n-    { TAG_SKIP, { .skip_ty = TAG_ ## ty } }\n-\n-extern size_t check_rust(size_t argc, const answer* answers, va_list ap);\n-extern size_t check_rust_copy(size_t argc, const answer* answers, va_list ap);\n-\n-size_t test_check_rust(size_t argc, const answer* answers, ...) {\n-    size_t ret = 0;\n-    va_list ap;\n-    va_start(ap, answers);\n-    ret = check_rust(argc, answers, ap);\n-    va_end(ap);\n-    return ret;\n-}\n-\n-size_t test_check_rust_copy(size_t argc, const answer* answers, ...) {\n+int test_rust(size_t (*fn)(va_list), ...) {\n     size_t ret = 0;\n     va_list ap;\n-    va_start(ap, answers);\n-    ret = check_rust_copy(argc, answers, ap);\n+    va_start(ap, fn);\n+    ret = fn(ap);\n     va_end(ap);\n     return ret;\n }\n \n int main(int argc, char* argv[]) {\n-    answer test_alignment0[] = {MK_LONGLONG(0x01LL), MK_INT(0x02), MK_LONGLONG(0x03LL)};\n-    assert(test_check_rust(3, test_alignment0, 0x01LL, 0x02, 0x03LL) == 0);\n+    assert(test_rust(check_list_0, 0x01LL, 0x02, 0x03LL) == 0);\n \n-    answer test_alignment1[] = {MK_INT(-1), MK_BYTE('A'), MK_BYTE('4'), MK_BYTE(';'),\n-                                MK_INT(0x32), MK_INT(0x10000001), MK_CSTR(\"Valid!\")};\n-    assert(test_check_rust(7, test_alignment1, -1, 'A', '4', ';', 0x32, 0x10000001,\n-                           \"Valid!\") == 0);\n+    assert(test_rust(check_list_1, -1, 'A', '4', ';', 0x32, 0x10000001, \"Valid!\") == 0);\n \n-    answer basic_answers[] = {MK_DOUBLE(3.14), MK_LONG(12l), MK_BYTE('a'),\n-                              MK_DOUBLE(6.28), MK_CSTR(\"Hello\"), MK_INT(42),\n-                              MK_CSTR(\"World\")};\n-    assert(test_check_rust(7, basic_answers, 3.14, 12l, 'a', 6.28, \"Hello\",\n-                           42, \"World\") == 0);\n+    assert(test_rust(check_list_2, 3.14, 12l, 'a', 6.28, \"Hello\", 42, \"World\") == 0);\n \n-    answer copy_answers[] = { MK_SKIP(DOUBLE), MK_SKIP(INT), MK_SKIP(BYTE), MK_SKIP(CSTR),\n-                              MK_CSTR(\"Correctly skipped and copied list\") };\n-    assert(test_check_rust_copy(5, copy_answers, 6.28, 16, 'A', \"Skip Me!\",\n-                                \"Correctly skipped and copied list\") == 0);\n+    assert(test_rust(check_list_copy_0, 6.28, 16, 'A', \"Skip Me!\", \"Correct\") == 0);\n     return 0;\n }"}]}