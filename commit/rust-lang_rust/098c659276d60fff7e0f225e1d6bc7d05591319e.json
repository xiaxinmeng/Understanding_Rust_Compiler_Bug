{"sha": "098c659276d60fff7e0f225e1d6bc7d05591319e", "node_id": "MDY6Q29tbWl0NzI0NzEyOjA5OGM2NTkyNzZkNjBmZmY3ZTBmMjI1ZTFkNmJjN2QwNTU5MTMxOWU=", "commit": {"author": {"name": "Aaron Hill", "email": "aa1ronham@gmail.com", "date": "2018-10-25T19:14:32Z"}, "committer": {"name": "Aaron Hill", "email": "aa1ronham@gmail.com", "date": "2018-10-25T19:14:32Z"}, "message": "Check for negative impls when finding auto traits\n\nFixes #55321\n\nWhen AutoTraitFinder begins examining a type, it checks for an explicit\nnegative impl. However, it wasn't checking for negative impls found when\ncalling 'select' on predicates found from nested obligations.\n\nThis commit makes AutoTraitFinder check for negative impls whenever it\nmakes a call to 'select'. If a negative impl is found, it immediately\nbails out.\n\nNormal users of SelectioContext don't need to worry about this, since\nthey stop as soon as an Unimplemented error is encountered. However, we\nadd predicates to our ParamEnv when we encounter this error, so we need\nto handle negative impls specially (so that we don't try adding them to\nour ParamEnv).", "tree": {"sha": "9f4a05de3af7ab19c93955ae57154eed06dd66ae", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9f4a05de3af7ab19c93955ae57154eed06dd66ae"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/098c659276d60fff7e0f225e1d6bc7d05591319e", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE7J9Gc3TfBwj2K399tAh+UQ6YsWQFAlvSF8MACgkQtAh+UQ6Y\nsWQjmQ//dc8h8POkD4XELaN+Kh4nllNRCBhOc5VFvn1UFWotqKMtPo1ccSTtW+R9\nbmoQgm0JJlgSXgj9TszkBlECPm06l1/sg2JwJrm54WMwcqdVDwMg2Yn5FdmBJRsp\n60r8RdLGONGibJKrJ+zWkaE+PX3n5DeVx9VEfKxTIjKtNFuqrjGQ/q80s32e6zbJ\n4s9NsJz9fPbVnfhR0hSqbS22VM6T4kB0rwpP8i2azGOKxzwJBbmK50DqQhgTEf6H\nI0bah0klTXtgtRJ5KmujcnxI40zmIBYdNLBeTG9BUwMBT8bmWuOENe0cQoMMxahg\nBUJaQv/WoUEob22XKYPRUSDM97UV+MBx7PUd8fzWVn9UygcWrWtLCQtkod3uiMOt\n04vNTWeaeR8tmr9As0DMtIMRsQwo7n+c2xpHKMbcvbiuNXCPq8n62ANMbV/WEY9H\nUp15OqYJGefAkb20MQzdKZ5BPISxM7dFx0ixou2ni6o3CXgRBf2yq4EfLygoOySP\niGoZLI3n696DgAKpCERgjqHbtXnDl6tQcUUlcsYkVmtAGaZg15HRc23YsPWAbHDC\nYxSBJ7sPax1MGqPKyOIh/Vr003dtdPFFU5DPE4lU7Uj3RGkvXxzjem1VCFkqapu3\nXgvzQLbRNC69GDk+uq42bAiM+f7jfsZZBadZKvEmqpZ6g6jJi2A=\n=TlKl\n-----END PGP SIGNATURE-----", "payload": "tree 9f4a05de3af7ab19c93955ae57154eed06dd66ae\nparent 8ec22e7ec7ed0da2add0763d239e77c5474f3d4a\nauthor Aaron Hill <aa1ronham@gmail.com> 1540494872 -0400\ncommitter Aaron Hill <aa1ronham@gmail.com> 1540494872 -0400\n\nCheck for negative impls when finding auto traits\n\nFixes #55321\n\nWhen AutoTraitFinder begins examining a type, it checks for an explicit\nnegative impl. However, it wasn't checking for negative impls found when\ncalling 'select' on predicates found from nested obligations.\n\nThis commit makes AutoTraitFinder check for negative impls whenever it\nmakes a call to 'select'. If a negative impl is found, it immediately\nbails out.\n\nNormal users of SelectioContext don't need to worry about this, since\nthey stop as soon as an Unimplemented error is encountered. However, we\nadd predicates to our ParamEnv when we encounter this error, so we need\nto handle negative impls specially (so that we don't try adding them to\nour ParamEnv).\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/098c659276d60fff7e0f225e1d6bc7d05591319e", "html_url": "https://github.com/rust-lang/rust/commit/098c659276d60fff7e0f225e1d6bc7d05591319e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/098c659276d60fff7e0f225e1d6bc7d05591319e/comments", "author": {"login": "Aaron1011", "id": 1408859, "node_id": "MDQ6VXNlcjE0MDg4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1408859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Aaron1011", "html_url": "https://github.com/Aaron1011", "followers_url": "https://api.github.com/users/Aaron1011/followers", "following_url": "https://api.github.com/users/Aaron1011/following{/other_user}", "gists_url": "https://api.github.com/users/Aaron1011/gists{/gist_id}", "starred_url": "https://api.github.com/users/Aaron1011/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Aaron1011/subscriptions", "organizations_url": "https://api.github.com/users/Aaron1011/orgs", "repos_url": "https://api.github.com/users/Aaron1011/repos", "events_url": "https://api.github.com/users/Aaron1011/events{/privacy}", "received_events_url": "https://api.github.com/users/Aaron1011/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Aaron1011", "id": 1408859, "node_id": "MDQ6VXNlcjE0MDg4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1408859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Aaron1011", "html_url": "https://github.com/Aaron1011", "followers_url": "https://api.github.com/users/Aaron1011/followers", "following_url": "https://api.github.com/users/Aaron1011/following{/other_user}", "gists_url": "https://api.github.com/users/Aaron1011/gists{/gist_id}", "starred_url": "https://api.github.com/users/Aaron1011/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Aaron1011/subscriptions", "organizations_url": "https://api.github.com/users/Aaron1011/orgs", "repos_url": "https://api.github.com/users/Aaron1011/repos", "events_url": "https://api.github.com/users/Aaron1011/events{/privacy}", "received_events_url": "https://api.github.com/users/Aaron1011/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8ec22e7ec7ed0da2add0763d239e77c5474f3d4a", "url": "https://api.github.com/repos/rust-lang/rust/commits/8ec22e7ec7ed0da2add0763d239e77c5474f3d4a", "html_url": "https://github.com/rust-lang/rust/commit/8ec22e7ec7ed0da2add0763d239e77c5474f3d4a"}], "stats": {"total": 42, "additions": 41, "deletions": 1}, "files": [{"sha": "1600634a199e43a5b999656f77955ab66c08725c", "filename": "src/librustc/traits/auto_trait.rs", "status": "modified", "additions": 14, "deletions": 1, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/098c659276d60fff7e0f225e1d6bc7d05591319e/src%2Flibrustc%2Ftraits%2Fauto_trait.rs", "raw_url": "https://github.com/rust-lang/rust/raw/098c659276d60fff7e0f225e1d6bc7d05591319e/src%2Flibrustc%2Ftraits%2Fauto_trait.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Ftraits%2Fauto_trait.rs?ref=098c659276d60fff7e0f225e1d6bc7d05591319e", "patch": "@@ -309,7 +309,7 @@ impl<'a, 'tcx> AutoTraitFinder<'a, 'tcx> {\n     ) -> Option<(ty::ParamEnv<'c>, ty::ParamEnv<'c>)> {\n         let tcx = infcx.tcx;\n \n-        let mut select = SelectionContext::new(&infcx);\n+        let mut select = SelectionContext::with_negative(&infcx, true);\n \n         let mut already_visited = FxHashSet::default();\n         let mut predicates = VecDeque::new();\n@@ -338,6 +338,19 @@ impl<'a, 'tcx> AutoTraitFinder<'a, 'tcx> {\n \n             match &result {\n                 &Ok(Some(ref vtable)) => {\n+                    // If we see an explicit negative impl (e.g. 'impl !Send for MyStruct'),\n+                    // we immediately bail out, since it's impossible for us to continue'\n+                    match vtable {\n+                        Vtable::VtableImpl(VtableImplData { impl_def_id, .. }) => {\n+                            if infcx.tcx.impl_polarity(*impl_def_id) == hir::ImplPolarity::Negative {\n+                                debug!(\"evaluate_nested_obligations: Found explicit negative impl\\\n+                                        {:?}, bailing out\", impl_def_id);\n+                                return None;\n+                            }\n+                        },\n+                        _ => {}\n+                    }\n+\n                     let obligations = vtable.clone().nested_obligations().into_iter();\n \n                     if !self.evaluate_nested_obligations("}, {"sha": "f6ba7c7be177e7867298c702c24626a65441270d", "filename": "src/test/rustdoc/issue-55321.rs", "status": "added", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/098c659276d60fff7e0f225e1d6bc7d05591319e/src%2Ftest%2Frustdoc%2Fissue-55321.rs", "raw_url": "https://github.com/rust-lang/rust/raw/098c659276d60fff7e0f225e1d6bc7d05591319e/src%2Ftest%2Frustdoc%2Fissue-55321.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fissue-55321.rs?ref=098c659276d60fff7e0f225e1d6bc7d05591319e", "patch": "@@ -0,0 +1,27 @@\n+// Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+\n+#![feature(optin_builtin_traits)]\n+\n+// @has issue_55321/struct.A.html\n+// @has - '//*[@id=\"implementations-list\"]/*[@class=\"impl\"]//*/code' \"impl !Send for A\"\n+// @has - '//*[@id=\"implementations-list\"]/*[@class=\"impl\"]//*/code' \"impl !Sync for A\"\n+pub struct A();\n+\n+impl !Send for A {}\n+impl !Sync for A {}\n+\n+// @has issue_55321/struct.B.html\n+// @has - '//*[@id=\"synthetic-implementations-list\"]/*[@class=\"impl\"]//*/code' \"impl<T> !Send for \\\n+// B<T>\"\n+// @has - '//*[@id=\"synthetic-implementations-list\"]/*[@class=\"impl\"]//*/code' \"impl<T> !Sync for \\\n+// B<T>\"\n+pub struct B<T: ?Sized>(A, Box<T>);"}]}