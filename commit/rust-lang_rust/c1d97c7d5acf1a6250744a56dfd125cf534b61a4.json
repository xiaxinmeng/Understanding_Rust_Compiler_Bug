{"sha": "c1d97c7d5acf1a6250744a56dfd125cf534b61a4", "node_id": "MDY6Q29tbWl0NzI0NzEyOmMxZDk3YzdkNWFjZjFhNjI1MDc0NGE1NmRmZDEyNWNmNTM0YjYxYTQ=", "commit": {"author": {"name": "achernyak", "email": "artemchernyak@gmail.com", "date": "2017-05-02T11:53:34Z"}, "committer": {"name": "achernyak", "email": "artemchernyak@gmail.com", "date": "2017-05-02T11:53:34Z"}, "message": "query for deprecation", "tree": {"sha": "fadf19771241b0c6d41dbcd3eb59812d787f277a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fadf19771241b0c6d41dbcd3eb59812d787f277a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c1d97c7d5acf1a6250744a56dfd125cf534b61a4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c1d97c7d5acf1a6250744a56dfd125cf534b61a4", "html_url": "https://github.com/rust-lang/rust/commit/c1d97c7d5acf1a6250744a56dfd125cf534b61a4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c1d97c7d5acf1a6250744a56dfd125cf534b61a4/comments", "author": {"login": "hackeryarn", "id": 827709, "node_id": "MDQ6VXNlcjgyNzcwOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/827709?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hackeryarn", "html_url": "https://github.com/hackeryarn", "followers_url": "https://api.github.com/users/hackeryarn/followers", "following_url": "https://api.github.com/users/hackeryarn/following{/other_user}", "gists_url": "https://api.github.com/users/hackeryarn/gists{/gist_id}", "starred_url": "https://api.github.com/users/hackeryarn/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hackeryarn/subscriptions", "organizations_url": "https://api.github.com/users/hackeryarn/orgs", "repos_url": "https://api.github.com/users/hackeryarn/repos", "events_url": "https://api.github.com/users/hackeryarn/events{/privacy}", "received_events_url": "https://api.github.com/users/hackeryarn/received_events", "type": "User", "site_admin": false}, "committer": {"login": "hackeryarn", "id": 827709, "node_id": "MDQ6VXNlcjgyNzcwOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/827709?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hackeryarn", "html_url": "https://github.com/hackeryarn", "followers_url": "https://api.github.com/users/hackeryarn/followers", "following_url": "https://api.github.com/users/hackeryarn/following{/other_user}", "gists_url": "https://api.github.com/users/hackeryarn/gists{/gist_id}", "starred_url": "https://api.github.com/users/hackeryarn/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hackeryarn/subscriptions", "organizations_url": "https://api.github.com/users/hackeryarn/orgs", "repos_url": "https://api.github.com/users/hackeryarn/repos", "events_url": "https://api.github.com/users/hackeryarn/events{/privacy}", "received_events_url": "https://api.github.com/users/hackeryarn/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "33535afda497e1de8a831e8270ae8099434f662b", "url": "https://api.github.com/repos/rust-lang/rust/commits/33535afda497e1de8a831e8270ae8099434f662b", "html_url": "https://github.com/rust-lang/rust/commit/33535afda497e1de8a831e8270ae8099434f662b"}], "stats": {"total": 42, "additions": 24, "deletions": 18}, "files": [{"sha": "0f31fae507ee480217b5b61d561654122082caf1", "filename": "src/librustc/dep_graph/dep_node.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/c1d97c7d5acf1a6250744a56dfd125cf534b61a4/src%2Flibrustc%2Fdep_graph%2Fdep_node.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c1d97c7d5acf1a6250744a56dfd125cf534b61a4/src%2Flibrustc%2Fdep_graph%2Fdep_node.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fdep_graph%2Fdep_node.rs?ref=c1d97c7d5acf1a6250744a56dfd125cf534b61a4", "patch": "@@ -151,6 +151,8 @@ pub enum DepNode<D: Clone + Debug> {\n \n     DescribeDef(D),\n     DefSpan(D),\n+    Stability(D),\n+    Deprecation(D),\n }\n \n impl<D: Clone + Debug> DepNode<D> {\n@@ -258,6 +260,8 @@ impl<D: Clone + Debug> DepNode<D> {\n             }\n             DescribeDef(ref d) => op(d).map(DescribeDef),\n             DefSpan(ref d) => op(d).map(DefSpan),\n+            Stability(ref d) => op(d).map(Stability),\n+            Deprecation(ref d) => op(d).map(Deprecation),\n         }\n     }\n }"}, {"sha": "303c5059e7cf3d6136445d2a076dbe601243aeb4", "filename": "src/librustc/middle/cstore.rs", "status": "modified", "additions": 0, "deletions": 5, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/c1d97c7d5acf1a6250744a56dfd125cf534b61a4/src%2Flibrustc%2Fmiddle%2Fcstore.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c1d97c7d5acf1a6250744a56dfd125cf534b61a4/src%2Flibrustc%2Fmiddle%2Fcstore.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fcstore.rs?ref=c1d97c7d5acf1a6250744a56dfd125cf534b61a4", "patch": "@@ -38,7 +38,6 @@ use std::any::Any;\n use std::path::PathBuf;\n use std::rc::Rc;\n use syntax::ast;\n-use syntax::attr;\n use syntax::ext::base::SyntaxExtension;\n use syntax::symbol::Symbol;\n use syntax_pos::Span;\n@@ -180,8 +179,6 @@ pub trait CrateStore {\n     fn crate_data_as_rc_any(&self, krate: CrateNum) -> Rc<Any>;\n \n     // item info\n-    fn stability(&self, def: DefId) -> Option<attr::Stability>;\n-    fn deprecation(&self, def: DefId) -> Option<attr::Deprecation>;\n     fn visibility(&self, def: DefId) -> ty::Visibility;\n     fn visible_parent_map<'a>(&'a self) -> ::std::cell::Ref<'a, DefIdMap<DefId>>;\n     fn item_generics_cloned(&self, def: DefId) -> ty::Generics;\n@@ -306,8 +303,6 @@ impl CrateStore for DummyCrateStore {\n     fn crate_data_as_rc_any(&self, krate: CrateNum) -> Rc<Any>\n         { bug!(\"crate_data_as_rc_any\") }\n     // item info\n-    fn stability(&self, def: DefId) -> Option<attr::Stability> { bug!(\"stability\") }\n-    fn deprecation(&self, def: DefId) -> Option<attr::Deprecation> { bug!(\"deprecation\") }\n     fn visibility(&self, def: DefId) -> ty::Visibility { bug!(\"visibility\") }\n     fn visible_parent_map<'a>(&'a self) -> ::std::cell::Ref<'a, DefIdMap<DefId>> {\n         bug!(\"visible_parent_map\")"}, {"sha": "198f7420f5d2b7af19a79a06ccb481ff2e5c1522", "filename": "src/librustc/middle/stability.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/c1d97c7d5acf1a6250744a56dfd125cf534b61a4/src%2Flibrustc%2Fmiddle%2Fstability.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c1d97c7d5acf1a6250744a56dfd125cf534b61a4/src%2Flibrustc%2Fmiddle%2Fstability.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fstability.rs?ref=c1d97c7d5acf1a6250744a56dfd125cf534b61a4", "patch": "@@ -636,7 +636,7 @@ impl<'a, 'gcx, 'tcx> TyCtxt<'a, 'gcx, 'tcx> {\n         if id.is_local() {\n             None // The stability cache is filled partially lazily\n         } else {\n-            self.sess.cstore.stability(id).map(|st| self.intern_stability(st))\n+            self.stability(id).map(|st| self.intern_stability(st))\n         }\n     }\n \n@@ -645,7 +645,7 @@ impl<'a, 'gcx, 'tcx> TyCtxt<'a, 'gcx, 'tcx> {\n         if id.is_local() {\n             None // The stability cache is filled partially lazily\n         } else {\n-            self.sess.cstore.deprecation(id).map(DeprecationEntry::external)\n+            self.deprecation(id).map(DeprecationEntry::external)\n         }\n     }\n }"}, {"sha": "013e1646f2cbce6cf62b1506c4bf6cfdd9dc847e", "filename": "src/librustc/ty/maps.rs", "status": "modified", "additions": 16, "deletions": 1, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/c1d97c7d5acf1a6250744a56dfd125cf534b61a4/src%2Flibrustc%2Fty%2Fmaps.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c1d97c7d5acf1a6250744a56dfd125cf534b61a4/src%2Flibrustc%2Fty%2Fmaps.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fmaps.rs?ref=c1d97c7d5acf1a6250744a56dfd125cf534b61a4", "patch": "@@ -28,6 +28,7 @@ use std::collections::BTreeMap;\n use std::ops::Deref;\n use std::rc::Rc;\n use syntax_pos::{Span, DUMMY_SP};\n+use syntax::attr;\n use syntax::symbol::Symbol;\n \n trait Key {\n@@ -292,6 +293,19 @@ impl<'tcx> QueryDescription for queries::def_span<'tcx> {\n     }\n }\n \n+\n+impl<'tcx> QueryDescription for queries::stability<'tcx> {\n+    fn describe(_: TyCtxt, _: DefId) -> String {\n+        bug!(\"stability\")\n+    }\n+}\n+\n+impl<'tcx> QueryDescription for queries::deprecation<'tcx> {\n+    fn describe(_: TyCtxt, _: DefId) -> String {\n+        bug!(\"deprecation\")\n+    }\n+}\n+\n impl<'tcx> QueryDescription for queries::item_body_nested_bodies<'tcx> {\n     fn describe(tcx: TyCtxt, def_id: DefId) -> String {\n         format!(\"nested item bodies of `{}`\", tcx.item_path_str(def_id))\n@@ -599,7 +613,8 @@ define_maps! { <'tcx>\n \n     [] describe_def: DescribeDef(DefId) -> Option<Def>,\n     [] def_span: DefSpan(DefId) -> Span,\n-\n+    [] stability: Stability(DefId) -> Option<attr::Stability>,\n+    [] deprecation: Deprecation(DefId) -> Option<attr::Deprecation>,\n     [] item_body_nested_bodies: metadata_dep_node(DefId) -> Rc<BTreeMap<hir::BodyId, hir::Body>>,\n     [] const_is_rvalue_promotable_to_static: metadata_dep_node(DefId) -> bool,\n     [] is_item_mir_available: metadata_dep_node(DefId) -> bool,"}, {"sha": "3c88aa25e98861f419b9e37678e36827bd5f5f4d", "filename": "src/librustc_metadata/cstore_impl.rs", "status": "modified", "additions": 2, "deletions": 10, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/c1d97c7d5acf1a6250744a56dfd125cf534b61a4/src%2Flibrustc_metadata%2Fcstore_impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c1d97c7d5acf1a6250744a56dfd125cf534b61a4/src%2Flibrustc_metadata%2Fcstore_impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Fcstore_impl.rs?ref=c1d97c7d5acf1a6250744a56dfd125cf534b61a4", "patch": "@@ -115,6 +115,8 @@ provide! { <'tcx> tcx, def_id, cdata\n     is_foreign_item => { cdata.is_foreign_item(def_id.index) }\n     describe_def => { cdata.get_def(def_id.index) }\n     def_span => { cdata.get_span(def_id.index, &tcx.sess) }\n+    stability => { cdata.get_stability(def_id.index) }\n+    deprecation => { cdata.get_deprecation(def_id.index) }\n     item_body_nested_bodies => {\n         let map: BTreeMap<_, _> = cdata.entry(def_id.index).ast.into_iter().flat_map(|ast| {\n             ast.decode(cdata).nested_bodies.decode(cdata).map(|body| (body.id(), body))\n@@ -137,16 +139,6 @@ impl CrateStore for cstore::CStore {\n         self.get_crate_data(krate)\n     }\n \n-    fn stability(&self, def: DefId) -> Option<attr::Stability> {\n-        self.dep_graph.read(DepNode::MetaData(def));\n-        self.get_crate_data(def.krate).get_stability(def.index)\n-    }\n-\n-    fn deprecation(&self, def: DefId) -> Option<attr::Deprecation> {\n-        self.dep_graph.read(DepNode::MetaData(def));\n-        self.get_crate_data(def.krate).get_deprecation(def.index)\n-    }\n-\n     fn visibility(&self, def: DefId) -> ty::Visibility {\n         self.dep_graph.read(DepNode::MetaData(def));\n         self.get_crate_data(def.krate).get_visibility(def.index)"}]}