{"sha": "95e6481d02ed600ca19775414231de774febe9a7", "node_id": "MDY6Q29tbWl0NzI0NzEyOjk1ZTY0ODFkMDJlZDYwMGNhMTk3NzU0MTQyMzFkZTc3NGZlYmU5YTc=", "commit": {"author": {"name": "Alan Egerton", "email": "eggyal@gmail.com", "date": "2021-04-30T10:02:34Z"}, "committer": {"name": "Alan Egerton", "email": "eggyal@gmail.com", "date": "2021-04-30T10:02:34Z"}, "message": "Set correct segment from #[link_section] for MachO", "tree": {"sha": "c592e2a07d133ce89dbc9b1b3a02ab28d3efccde", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c592e2a07d133ce89dbc9b1b3a02ab28d3efccde"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/95e6481d02ed600ca19775414231de774febe9a7", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE1ycQ10Ou2Tzw/6ueaKZbzZ0on/4FAmCL1fgACgkQaKZbzZ0o\nn/5FiQ/+PCQmZw9r2OThTr6GHUkS0J+HdNyndaJI+ptFSnc+kERKQAOezeNejUd2\nHPhhlIJwxFs+h7XgbDdJi5TRSf39YRQvV/SwtzDZ03yayLStCgEVrH35BZK8lPvv\nNOSG0nNxM5fpI0s++gDxXC+dvtTVXkWaZFs7AFlol0mPiiYaTl+/6M9/1oIcRs/L\nVB+CIAwKwWsfTJSC9GN3FiddXcohVNb7E5j8lkjgfQUK/xnLCoL+PkHCdIkfZsYb\nfpjnoj+9/lqkEqQvmwUCjU9xebWBfw978Bs/w6js3T/4TtffFuQS1oht24TF3b+m\n2CegqtW3vP23RuPHW1fzcC3QBcCz+108sbvX62+ZVl1WulduJiwRZJnkwXHdZrS8\nfsYmmjePkubK6ekW8fEsrRq/6kZTjZiEeCNnYNPSg53Jkxj4dBQYct5rNj/RL4s9\nSjX+1gmHg0HhCeZ7NQaHIX5TPG5EL7FFpUxd+JpNy79CFCQVI/IjEbN2klPZwEgF\nIPbuzf/JY/yn0zVhVuiEjz7/pGeoCi2t/B1RFJefGKCu7HWp7Ep7WvEyW96MtqSA\novREHZHjECnzCsh71pp39mElCEFwt+XxFFUDUqmU21v6Phg9E9tTT30ebyvqi3Mi\nxEqUC7BnyOfbTg+KCkE7yaIHyO8xmQEBXESSp/3rBTrYfq/d/ak=\n=J07I\n-----END PGP SIGNATURE-----", "payload": "tree c592e2a07d133ce89dbc9b1b3a02ab28d3efccde\nparent ddd4ce25535cf71203ba3700896131ce55fde795\nauthor Alan Egerton <eggyal@gmail.com> 1619776954 +0100\ncommitter Alan Egerton <eggyal@gmail.com> 1619776954 +0100\n\nSet correct segment from #[link_section] for MachO\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/95e6481d02ed600ca19775414231de774febe9a7", "html_url": "https://github.com/rust-lang/rust/commit/95e6481d02ed600ca19775414231de774febe9a7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/95e6481d02ed600ca19775414231de774febe9a7/comments", "author": {"login": "eggyal", "id": 3089613, "node_id": "MDQ6VXNlcjMwODk2MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/3089613?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eggyal", "html_url": "https://github.com/eggyal", "followers_url": "https://api.github.com/users/eggyal/followers", "following_url": "https://api.github.com/users/eggyal/following{/other_user}", "gists_url": "https://api.github.com/users/eggyal/gists{/gist_id}", "starred_url": "https://api.github.com/users/eggyal/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eggyal/subscriptions", "organizations_url": "https://api.github.com/users/eggyal/orgs", "repos_url": "https://api.github.com/users/eggyal/repos", "events_url": "https://api.github.com/users/eggyal/events{/privacy}", "received_events_url": "https://api.github.com/users/eggyal/received_events", "type": "User", "site_admin": false}, "committer": {"login": "eggyal", "id": 3089613, "node_id": "MDQ6VXNlcjMwODk2MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/3089613?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eggyal", "html_url": "https://github.com/eggyal", "followers_url": "https://api.github.com/users/eggyal/followers", "following_url": "https://api.github.com/users/eggyal/following{/other_user}", "gists_url": "https://api.github.com/users/eggyal/gists{/gist_id}", "starred_url": "https://api.github.com/users/eggyal/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eggyal/subscriptions", "organizations_url": "https://api.github.com/users/eggyal/orgs", "repos_url": "https://api.github.com/users/eggyal/repos", "events_url": "https://api.github.com/users/eggyal/events{/privacy}", "received_events_url": "https://api.github.com/users/eggyal/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ddd4ce25535cf71203ba3700896131ce55fde795", "url": "https://api.github.com/repos/rust-lang/rust/commits/ddd4ce25535cf71203ba3700896131ce55fde795", "html_url": "https://github.com/rust-lang/rust/commit/ddd4ce25535cf71203ba3700896131ce55fde795"}], "stats": {"total": 15, "additions": 13, "deletions": 2}, "files": [{"sha": "39daf887a22fec797af7841e588afef0e21a8537", "filename": "src/constant.rs", "status": "modified", "additions": 13, "deletions": 2, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/95e6481d02ed600ca19775414231de774febe9a7/src%2Fconstant.rs", "raw_url": "https://github.com/rust-lang/rust/raw/95e6481d02ed600ca19775414231de774febe9a7/src%2Fconstant.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fconstant.rs?ref=95e6481d02ed600ca19775414231de774febe9a7", "patch": "@@ -374,8 +374,19 @@ fn define_all_allocs(tcx: TyCtxt<'_>, module: &mut dyn Module, cx: &mut Constant\n         data_ctx.set_align(alloc.align.bytes());\n \n         if let Some(section_name) = section_name {\n-            // FIXME set correct segment for Mach-O files\n-            data_ctx.set_segment_section(\"\", &*section_name);\n+            let (segment_name, section_name) = if tcx.sess.target.is_like_osx {\n+                if let Some(names) = section_name.split_once(',') {\n+                    names\n+                } else {\n+                    tcx.sess.fatal(&format!(\n+                        \"#[link_section = \\\"{}\\\"] is not valid for macos target: must be segment and section separated by comma\",\n+                        section_name\n+                    ));\n+                }\n+            } else {\n+                (\"\", &*section_name)\n+            };\n+            data_ctx.set_segment_section(segment_name, section_name);\n         }\n \n         let bytes = alloc.inspect_with_uninit_and_ptr_outside_interpreter(0..alloc.len()).to_vec();"}]}