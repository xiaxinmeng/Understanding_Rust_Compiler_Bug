{"sha": "17e9d9ae82149202908b5674966df86c0a1a5799", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE3ZTlkOWFlODIxNDkyMDI5MDhiNTY3NDk2NmRmODZjMGExYTU3OTk=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-10-29T04:31:26Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2016-10-29T04:31:26Z"}, "message": "Auto merge of #37385 - raphlinus:fuchsia_random, r=alexcrichton\n\nAdd support for kernel randomness for Fuchsia\n\nWire up cprng syscall as provider for rand::os::OsRng on Fuchsia.", "tree": {"sha": "36d34dc574666b9fd35aa6f34566d5a5a66a9b48", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/36d34dc574666b9fd35aa6f34566d5a5a66a9b48"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/17e9d9ae82149202908b5674966df86c0a1a5799", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/17e9d9ae82149202908b5674966df86c0a1a5799", "html_url": "https://github.com/rust-lang/rust/commit/17e9d9ae82149202908b5674966df86c0a1a5799", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/17e9d9ae82149202908b5674966df86c0a1a5799/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e9b2fcb2fec4c9bff790adfcd1f5f6f307f2d835", "url": "https://api.github.com/repos/rust-lang/rust/commits/e9b2fcb2fec4c9bff790adfcd1f5f6f307f2d835", "html_url": "https://github.com/rust-lang/rust/commit/e9b2fcb2fec4c9bff790adfcd1f5f6f307f2d835"}, {"sha": "592d7bfb3af75ded9c5233ee243cc6c751531671", "url": "https://api.github.com/repos/rust-lang/rust/commits/592d7bfb3af75ded9c5233ee243cc6c751531671", "html_url": "https://github.com/rust-lang/rust/commit/592d7bfb3af75ded9c5233ee243cc6c751531671"}], "stats": {"total": 56, "additions": 55, "deletions": 1}, "files": [{"sha": "72cd6e4830bca0a374619ee73a3977709aeea118", "filename": "src/libstd/build.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/17e9d9ae82149202908b5674966df86c0a1a5799/src%2Flibstd%2Fbuild.rs", "raw_url": "https://github.com/rust-lang/rust/raw/17e9d9ae82149202908b5674966df86c0a1a5799/src%2Flibstd%2Fbuild.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fbuild.rs?ref=17e9d9ae82149202908b5674966df86c0a1a5799", "patch": "@@ -58,6 +58,8 @@ fn main() {\n         println!(\"cargo:rustc-link-lib=ws2_32\");\n         println!(\"cargo:rustc-link-lib=userenv\");\n         println!(\"cargo:rustc-link-lib=shell32\");\n+    } else if target.contains(\"fuchsia\") {\n+        println!(\"cargo:rustc-link-lib=magenta\");\n     }\n }\n "}, {"sha": "3aebb8c18ec869b6d39c015cf59e3e2e98da6d8f", "filename": "src/libstd/sys/unix/rand.rs", "status": "modified", "additions": 53, "deletions": 1, "changes": 54, "blob_url": "https://github.com/rust-lang/rust/blob/17e9d9ae82149202908b5674966df86c0a1a5799/src%2Flibstd%2Fsys%2Funix%2Frand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/17e9d9ae82149202908b5674966df86c0a1a5799/src%2Flibstd%2Fsys%2Funix%2Frand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Funix%2Frand.rs?ref=17e9d9ae82149202908b5674966df86c0a1a5799", "patch": "@@ -27,7 +27,8 @@ fn next_u64(mut fill_buf: &mut FnMut(&mut [u8])) -> u64 {\n #[cfg(all(unix,\n           not(target_os = \"ios\"),\n           not(target_os = \"openbsd\"),\n-          not(target_os = \"freebsd\")))]\n+          not(target_os = \"freebsd\"),\n+          not(target_os = \"fuchsia\")))]\n mod imp {\n     use self::OsRngInner::*;\n     use super::{next_u32, next_u64};\n@@ -339,3 +340,54 @@ mod imp {\n         }\n     }\n }\n+\n+#[cfg(target_os = \"fuchsia\")]\n+mod imp {\n+    use super::{next_u32, next_u64};\n+\n+    use io;\n+    use rand::Rng;\n+\n+    #[link(name = \"magenta\")]\n+    extern {\n+        fn mx_cprng_draw(buffer: *mut u8, len: usize) -> isize;\n+    }\n+\n+    fn getrandom(buf: &mut [u8]) -> isize {\n+        unsafe { mx_cprng_draw(buf.as_mut_ptr(), buf.len()) }\n+    }\n+\n+    pub struct OsRng {\n+        // dummy field to ensure that this struct cannot be constructed outside\n+        // of this module\n+        _dummy: (),\n+    }\n+\n+    impl OsRng {\n+        /// Create a new `OsRng`.\n+        pub fn new() -> io::Result<OsRng> {\n+            Ok(OsRng { _dummy: () })\n+        }\n+    }\n+\n+    impl Rng for OsRng {\n+        fn next_u32(&mut self) -> u32 {\n+            next_u32(&mut |v| self.fill_bytes(v))\n+        }\n+        fn next_u64(&mut self) -> u64 {\n+            next_u64(&mut |v| self.fill_bytes(v))\n+        }\n+        fn fill_bytes(&mut self, v: &mut [u8]) {\n+            let mut buf = v;\n+            while !buf.is_empty() {\n+                let ret = getrandom(buf);\n+                if ret < 0 {\n+                    panic!(\"kernel mx_cprng_draw call failed! (returned {}, buf.len() {})\",\n+                        ret, buf.len());\n+                }\n+                let move_buf = buf;\n+                buf = &mut move_buf[(ret as usize)..];\n+            }\n+        }\n+    }\n+}"}]}