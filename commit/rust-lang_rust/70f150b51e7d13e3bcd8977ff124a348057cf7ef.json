{"sha": "70f150b51e7d13e3bcd8977ff124a348057cf7ef", "node_id": "MDY6Q29tbWl0NzI0NzEyOjcwZjE1MGI1MWU3ZDEzZTNiY2Q4OTc3ZmYxMjRhMzQ4MDU3Y2Y3ZWY=", "commit": {"author": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2020-09-26T00:00:00Z"}, "committer": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2020-09-26T13:38:51Z"}, "message": "liveness: Delay conversion from a symbol to a string until linting", "tree": {"sha": "f575881fd9d84459f3ad69bc55c6ed57b1e49ebb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f575881fd9d84459f3ad69bc55c6ed57b1e49ebb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/70f150b51e7d13e3bcd8977ff124a348057cf7ef", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/70f150b51e7d13e3bcd8977ff124a348057cf7ef", "html_url": "https://github.com/rust-lang/rust/commit/70f150b51e7d13e3bcd8977ff124a348057cf7ef", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/70f150b51e7d13e3bcd8977ff124a348057cf7ef/comments", "author": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2fb1564457b47bd31087e2aba1b8eb6f15c000ef", "url": "https://api.github.com/repos/rust-lang/rust/commits/2fb1564457b47bd31087e2aba1b8eb6f15c000ef", "html_url": "https://github.com/rust-lang/rust/commit/2fb1564457b47bd31087e2aba1b8eb6f15c000ef"}], "stats": {"total": 17, "additions": 12, "deletions": 5}, "files": [{"sha": "4f9ee6df4aaa52d9555b24d4d3410878eb0541f3", "filename": "compiler/rustc_passes/src/liveness.rs", "status": "modified", "additions": 12, "deletions": 5, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/70f150b51e7d13e3bcd8977ff124a348057cf7ef/compiler%2Frustc_passes%2Fsrc%2Fliveness.rs", "raw_url": "https://github.com/rust-lang/rust/raw/70f150b51e7d13e3bcd8977ff124a348057cf7ef/compiler%2Frustc_passes%2Fsrc%2Fliveness.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fliveness.rs?ref=70f150b51e7d13e3bcd8977ff124a348057cf7ef", "patch": "@@ -96,7 +96,7 @@ use rustc_middle::hir::map::Map;\n use rustc_middle::ty::query::Providers;\n use rustc_middle::ty::{self, TyCtxt};\n use rustc_session::lint;\n-use rustc_span::symbol::{sym, Symbol};\n+use rustc_span::symbol::{kw, sym, Symbol};\n use rustc_span::Span;\n \n use std::collections::VecDeque;\n@@ -309,9 +309,9 @@ impl IrMaps<'tcx> {\n         }\n     }\n \n-    fn variable_name(&self, var: Variable) -> String {\n+    fn variable_name(&self, var: Variable) -> Symbol {\n         match self.var_kinds[var.get()] {\n-            Local(LocalInfo { name, .. }) | Param(_, name) | Upvar(_, name) => name.to_string(),\n+            Local(LocalInfo { name, .. }) | Param(_, name) | Upvar(_, name) => name,\n         }\n     }\n \n@@ -1587,7 +1587,14 @@ impl<'tcx> Liveness<'_, 'tcx> {\n \n     fn should_warn(&self, var: Variable) -> Option<String> {\n         let name = self.ir.variable_name(var);\n-        if name.is_empty() || name.as_bytes()[0] == b'_' { None } else { Some(name) }\n+        if name == kw::Invalid {\n+            return None;\n+        }\n+        let name: &str = &name.as_str();\n+        if name.as_bytes()[0] == b'_' {\n+            return None;\n+        }\n+        Some(name.to_owned())\n     }\n \n     fn warn_about_unused_upvars(&self, entry_ln: LiveNode) {\n@@ -1659,7 +1666,7 @@ impl<'tcx> Liveness<'_, 'tcx> {\n         // bindings, and we also consider the first pattern to be the \"authoritative\" set of ids.\n         // However, we should take the ids and spans of variables with the same name from the later\n         // patterns so the suggestions to prefix with underscores will apply to those too.\n-        let mut vars: FxIndexMap<String, (LiveNode, Variable, Vec<(HirId, Span)>)> = <_>::default();\n+        let mut vars: FxIndexMap<Symbol, (LiveNode, Variable, Vec<(HirId, Span)>)> = <_>::default();\n \n         pat.each_binding(|_, hir_id, pat_sp, ident| {\n             let ln = entry_ln.unwrap_or_else(|| self.live_node(hir_id, pat_sp));"}]}