{"sha": "82d73963334f01b818cda767b44cd0c8f3baf4cc", "node_id": "MDY6Q29tbWl0NzI0NzEyOjgyZDczOTYzMzM0ZjAxYjgxOGNkYTc2N2I0NGNkMGM4ZjNiYWY0Y2M=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-02-07T12:02:51Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-02-07T12:02:51Z"}, "message": "auto merge of #4823 : pcwalton/rust/enum-variant-discriminants, r=graydon\n\nr? @graydon", "tree": {"sha": "4c617b1505cb0e7de6b0bd6d1150882ec3e14bba", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4c617b1505cb0e7de6b0bd6d1150882ec3e14bba"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/82d73963334f01b818cda767b44cd0c8f3baf4cc", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/82d73963334f01b818cda767b44cd0c8f3baf4cc", "html_url": "https://github.com/rust-lang/rust/commit/82d73963334f01b818cda767b44cd0c8f3baf4cc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/82d73963334f01b818cda767b44cd0c8f3baf4cc/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "fa69739320d84956ccea20f2f6b526d64d6e9504", "url": "https://api.github.com/repos/rust-lang/rust/commits/fa69739320d84956ccea20f2f6b526d64d6e9504", "html_url": "https://github.com/rust-lang/rust/commit/fa69739320d84956ccea20f2f6b526d64d6e9504"}, {"sha": "6d13c9025611cf904c0ef209dfad3d0d29fd7d5a", "url": "https://api.github.com/repos/rust-lang/rust/commits/6d13c9025611cf904c0ef209dfad3d0d29fd7d5a", "html_url": "https://github.com/rust-lang/rust/commit/6d13c9025611cf904c0ef209dfad3d0d29fd7d5a"}], "stats": {"total": 27, "additions": 3, "deletions": 24}, "files": [{"sha": "a1f863332bdddf83d10de33f12c057a98b3252a0", "filename": "src/librustc/middle/trans/base.rs", "status": "modified", "additions": 0, "deletions": 21, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/82d73963334f01b818cda767b44cd0c8f3baf4cc/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/82d73963334f01b818cda767b44cd0c8f3baf4cc/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs?ref=82d73963334f01b818cda767b44cd0c8f3baf4cc", "patch": "@@ -813,27 +813,6 @@ pub fn get_discrim_val(cx: @crate_ctxt, span: span, enum_did: ast::def_id,\n     }\n }\n \n-pub fn lookup_discriminant(ccx: @crate_ctxt, vid: ast::def_id) -> ValueRef {\n-    unsafe {\n-        let _icx = ccx.insn_ctxt(\"lookup_discriminant\");\n-        match ccx.discrims.find(&vid) {\n-            None => {\n-                // It's an external discriminant that we haven't seen yet.\n-                assert (vid.crate != ast::local_crate);\n-                let sym = csearch::get_symbol(ccx.sess.cstore, vid);\n-                let gvar = str::as_c_str(sym, |buf| {\n-                    llvm::LLVMAddGlobal(ccx.llmod, ccx.int_type, buf)\n-                });\n-                lib::llvm::SetLinkage(gvar, lib::llvm::ExternalLinkage);\n-                llvm::LLVMSetGlobalConstant(gvar, True);\n-                ccx.discrims.insert(vid, gvar);\n-                return gvar;\n-            }\n-            Some(llval) => return llval,\n-        }\n-    }\n-}\n-\n pub fn invoke(bcx: block, llfn: ValueRef, +llargs: ~[ValueRef]) -> block {\n     let _icx = bcx.insn_ctxt(\"invoke_\");\n     if bcx.unreachable { return bcx; }"}, {"sha": "56833d373c5cd89b158ce635dffbdba6dea2c214", "filename": "src/librustc/middle/trans/expr.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/82d73963334f01b818cda767b44cd0c8f3baf4cc/src%2Flibrustc%2Fmiddle%2Ftrans%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/82d73963334f01b818cda767b44cd0c8f3baf4cc/src%2Flibrustc%2Fmiddle%2Ftrans%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fexpr.rs?ref=82d73963334f01b818cda767b44cd0c8f3baf4cc", "patch": "@@ -696,15 +696,15 @@ fn trans_def_dps_unadjusted(bcx: block, ref_expr: @ast::expr,\n             return fn_data_to_datum(bcx, impl_did, fn_data, lldest);\n         }\n         ast::def_variant(tid, vid) => {\n-            if ty::enum_variant_with_id(ccx.tcx, tid, vid).args.len() > 0u {\n+            let variant_info = ty::enum_variant_with_id(ccx.tcx, tid, vid);\n+            if variant_info.args.len() > 0u {\n                 // N-ary variant.\n                 let fn_data = callee::trans_fn_ref(bcx, vid, ref_expr.id);\n                 return fn_data_to_datum(bcx, vid, fn_data, lldest);\n             } else {\n                 // Nullary variant.\n                 let lldiscrimptr = GEPi(bcx, lldest, [0u, 0u]);\n-                let lldiscrim_gv = base::lookup_discriminant(ccx, vid);\n-                let lldiscrim = Load(bcx, lldiscrim_gv);\n+                let lldiscrim = C_int(bcx.ccx(), variant_info.disr_val);\n                 Store(bcx, lldiscrim, lldiscrimptr);\n                 return bcx;\n             }"}]}