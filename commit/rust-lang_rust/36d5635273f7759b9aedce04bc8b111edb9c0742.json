{"sha": "36d5635273f7759b9aedce04bc8b111edb9c0742", "node_id": "MDY6Q29tbWl0NzI0NzEyOjM2ZDU2MzUyNzNmNzc1OWI5YWVkY2UwNGJjOGIxMTFlZGI5YzA3NDI=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2014-04-14T19:30:52Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2014-04-17T18:11:39Z"}, "message": "etc: The --system-libs flag is LLVM 3.5+\n\nOlder version of LLVM did not have this flag, so we need to fall back to our\nprevious library detection when using older versions of LLVM.", "tree": {"sha": "08b1942dcebf5e42c2cdae4ecfebc239dffff288", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/08b1942dcebf5e42c2cdae4ecfebc239dffff288"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/36d5635273f7759b9aedce04bc8b111edb9c0742", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/36d5635273f7759b9aedce04bc8b111edb9c0742", "html_url": "https://github.com/rust-lang/rust/commit/36d5635273f7759b9aedce04bc8b111edb9c0742", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/36d5635273f7759b9aedce04bc8b111edb9c0742/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "682c401045fbc24ecec8cab0e315293192825c69", "url": "https://api.github.com/repos/rust-lang/rust/commits/682c401045fbc24ecec8cab0e315293192825c69", "html_url": "https://github.com/rust-lang/rust/commit/682c401045fbc24ecec8cab0e315293192825c69"}], "stats": {"total": 51, "additions": 25, "deletions": 26}, "files": [{"sha": "364564168a5e88af7241788aee0c14c10c51e9fa", "filename": "src/etc/mklldeps.py", "status": "modified", "additions": 25, "deletions": 26, "changes": 51, "blob_url": "https://github.com/rust-lang/rust/blob/36d5635273f7759b9aedce04bc8b111edb9c0742/src%2Fetc%2Fmklldeps.py", "raw_url": "https://github.com/rust-lang/rust/raw/36d5635273f7759b9aedce04bc8b111edb9c0742/src%2Fetc%2Fmklldeps.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fetc%2Fmklldeps.py?ref=36d5635273f7759b9aedce04bc8b111edb9c0742", "patch": "@@ -31,11 +31,20 @@\n //          take a look at src/etc/mklldeps.py if you're interested\n \"\"\")\n \n+def run(args):\n+    proc = subprocess.Popen(args, stdout=subprocess.PIPE, stderr=subprocess.PIPE)\n+    out, err = proc.communicate()\n+\n+    if err:\n+        print(\"failed to run llconfig: args = `{}`\".format(args))\n+        print(err)\n+        sys.exit(1)\n+    return out\n+\n for llconfig in sys.argv[3:]:\n     f.write(\"\\n\")\n \n-    proc = subprocess.Popen([llconfig, '--host-target'], stdout = subprocess.PIPE)\n-    out, err = proc.communicate()\n+    out = run([llconfig, '--host-target'])\n     arch, os = out.split('-', 1)\n     arch = 'x86' if arch == 'i686' or arch == 'i386' else arch\n     if 'darwin' in os:\n@@ -55,16 +64,15 @@\n \n     f.write(\"#[cfg(\" + ', '.join(cfg) + \")]\\n\")\n \n+    version = run([llconfig, '--version']).strip()\n+\n     # LLVM libs\n-    args = [llconfig, '--libs', '--system-libs']\n+    if version < '3.5':\n+      args = [llconfig, '--libs']\n+    else:\n+      args = [llconfig, '--libs', '--system-libs']\n     args.extend(components)\n-    proc = subprocess.Popen(args, stdout=subprocess.PIPE, stderr=subprocess.PIPE)\n-    out, err = proc.communicate()\n-\n-    if err:\n-        print(\"failed to run llconfig: args = `{}`\".format(args))\n-        sys.exit(1)\n-\n+    out = run(args)\n     for lib in out.strip().replace(\"\\n\", ' ').split(' '):\n         lib = lib.strip()[2:] # chop of the leading '-l'\n         f.write(\"#[link(name = \\\"\" + lib + \"\\\"\")\n@@ -73,28 +81,19 @@\n             f.write(\", kind = \\\"static\\\"\")\n         f.write(\")]\\n\")\n \n-    # LLVM ldflags\n-    args = [llconfig, '--ldflags']\n-    proc = subprocess.Popen(args, stdout=subprocess.PIPE, stderr=subprocess.PIPE)\n-    out, err = proc.communicate()\n-\n-    if err:\n-        print(\"failed to run llconfig: args = `{}`\".format(args))\n-        sys.exit(1)\n+    # llvm-config before 3.5 didn't have a system-libs flag\n+    if version < '3.5':\n+      if os == 'win32':\n+        f.write(\"#[link(name = \\\"imagehlp\\\")]\")\n \n+    # LLVM ldflags\n+    out = run([llconfig, '--ldflags'])\n     for lib in out.strip().split(' '):\n         if lib[:2] == \"-l\":\n             f.write(\"#[link(name = \\\"\" + lib[2:] + \"\\\")]\\n\")\n \n     # C++ runtime library\n-    args = [llconfig, '--cxxflags']\n-    proc = subprocess.Popen(args, stdout=subprocess.PIPE, stderr=subprocess.PIPE)\n-    out, err = proc.communicate()\n-\n-    if err:\n-        print(\"failed to run llconfig: args = `{}`\".format(args))\n-        sys.exit(1)\n-\n+    out = run([llconfig, '--cxxflags'])\n     if 'stdlib=libc++' in out:\n         f.write(\"#[link(name = \\\"c++\\\")]\\n\")\n     else:"}]}