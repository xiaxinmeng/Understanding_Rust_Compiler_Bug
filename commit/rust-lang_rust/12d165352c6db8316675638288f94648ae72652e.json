{"sha": "12d165352c6db8316675638288f94648ae72652e", "node_id": "MDY6Q29tbWl0NzI0NzEyOjEyZDE2NTM1MmM2ZGI4MzE2Njc1NjM4Mjg4Zjk0NjQ4YWU3MjY1MmU=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-06-02T17:55:43Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-06-02T17:55:43Z"}, "message": "Auto merge of #33583 - luqmana:tri-bool-mir, r=arielb1\n\nMIR: Don't generate 3-armed boolean switch from match.\n\nFixes #33540.\n\nSnippet from issue:\n```Rust\nfn foo(x: bool, y: bool) -> u32 {\n    match (x, y) {\n         (false, _) => 0,\n         (_, false) => 1,\n         (true, true) => 2,\n    }\n}\n```\n\nGenerated MIR:\n```\nfn foo(arg0: bool, arg1: bool) -> u32 {\n    let var0: bool;                      // \"x\" in scope 1 at 3bbm.rs:17:8: 17:9\n    let var1: bool;                      // \"y\" in scope 1 at 3bbm.rs:17:17: 17:18\n    let mut tmp0: (bool, bool);\n    let mut tmp1: bool;\n    let mut tmp2: bool;\n    let mut tmp3: (&'static str, &'static str, u32);\n    let mut tmp4: &'static (&'static str, &'static str, u32);\n\n    bb0: {\n        var0 = arg0;                     // scope 1 at 3bbm.rs:17:8: 17:9\n        var1 = arg1;                     // scope 1 at 3bbm.rs:17:17: 17:18\n        tmp1 = var0;                     // scope 5 at 3bbm.rs:18:12: 18:13\n        tmp2 = var1;                     // scope 6 at 3bbm.rs:18:15: 18:16\n        tmp0 = (tmp1, tmp2);             // scope 4 at 3bbm.rs:18:11: 18:17\n        if((tmp0.0: bool)) -> [true: bb4, false: bb1]; // scope 3 at 3bbm.rs:19:10: 19:15\n    }\n\n    bb1: {\n        return = const 0u32;             // scope 10 at 3bbm.rs:19:23: 19:24\n        goto -> bb7;                     // scope 3 at 3bbm.rs:18:5: 22:6\n    }\n\n    bb2: {\n        return = const 1u32;             // scope 11 at 3bbm.rs:20:23: 20:24\n        goto -> bb7;                     // scope 3 at 3bbm.rs:18:5: 22:6\n    }\n\n    bb3: {\n        return = const 2u32;             // scope 12 at 3bbm.rs:21:25: 21:26\n        goto -> bb7;                     // scope 3 at 3bbm.rs:18:5: 22:6\n    }\n\n    bb4: {\n        if((tmp0.1: bool)) -> [true: bb5, false: bb2]; // scope 3 at 3bbm.rs:20:13: 20:18\n    }\n\n    bb5: {\n        if((tmp0.0: bool)) -> [true: bb3, false: bb6]; // scope 3 at 3bbm.rs:21:10: 21:14\n    }\n\n    bb6: {\n        tmp4 = promoted0;                // scope 3 at 3bbm.rs:18:5: 22:6\n        core::panicking::panic(tmp4);    // scope 3 at 3bbm.rs:18:5: 22:6\n    }\n\n    bb7: {\n        return;                          // scope 0 at 3bbm.rs:17:1: 23:2\n    }\n}\n```\n\nNot sure about this approach. I was also thinking maybe just a standalone pass?\n\ncc @arielb1, @nagisa", "tree": {"sha": "d9fa126b571e6936da9d63ffc206689e10ee5d44", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d9fa126b571e6936da9d63ffc206689e10ee5d44"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/12d165352c6db8316675638288f94648ae72652e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/12d165352c6db8316675638288f94648ae72652e", "html_url": "https://github.com/rust-lang/rust/commit/12d165352c6db8316675638288f94648ae72652e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/12d165352c6db8316675638288f94648ae72652e/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b47a442f0b868b8501a894c3fdc05719eb337962", "url": "https://api.github.com/repos/rust-lang/rust/commits/b47a442f0b868b8501a894c3fdc05719eb337962", "html_url": "https://github.com/rust-lang/rust/commit/b47a442f0b868b8501a894c3fdc05719eb337962"}, {"sha": "a97f6b35ac0532866763c3fa604460497fd3b635", "url": "https://api.github.com/repos/rust-lang/rust/commits/a97f6b35ac0532866763c3fa604460497fd3b635", "html_url": "https://github.com/rust-lang/rust/commit/a97f6b35ac0532866763c3fa604460497fd3b635"}], "stats": {"total": 90, "additions": 78, "deletions": 12}, "files": [{"sha": "79656ea21f755bacbbf0debd5ba1d225962c56ad", "filename": "src/librustc_mir/build/matches/test.rs", "status": "modified", "additions": 44, "deletions": 12, "changes": 56, "blob_url": "https://github.com/rust-lang/rust/blob/12d165352c6db8316675638288f94648ae72652e/src%2Flibrustc_mir%2Fbuild%2Fmatches%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/12d165352c6db8316675638288f94648ae72652e/src%2Flibrustc_mir%2Fbuild%2Fmatches%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fbuild%2Fmatches%2Ftest.rs?ref=12d165352c6db8316675638288f94648ae72652e", "patch": "@@ -162,21 +162,53 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n             }\n \n             TestKind::SwitchInt { switch_ty, ref options, indices: _ } => {\n-                let otherwise = self.cfg.start_new_block();\n-                let targets: Vec<_> =\n-                    options.iter()\n-                           .map(|_| self.cfg.start_new_block())\n-                           .chain(Some(otherwise))\n-                           .collect();\n+                let (targets, term) = match switch_ty.sty {\n+                    // If we're matching on boolean we can\n+                    // use the If TerminatorKind instead\n+                    ty::TyBool => {\n+                        assert!(options.len() > 0 && options.len() <= 2);\n+\n+                        let (true_bb, else_bb) =\n+                            (self.cfg.start_new_block(),\n+                             self.cfg.start_new_block());\n+\n+                        let targets = match &options[0] {\n+                            &ConstVal::Bool(true) => vec![true_bb, else_bb],\n+                            &ConstVal::Bool(false) => vec![else_bb, true_bb],\n+                            v => span_bug!(test.span, \"expected boolean value but got {:?}\", v)\n+                        };\n+\n+                        (targets,\n+                         TerminatorKind::If {\n+                             cond: Operand::Consume(lvalue.clone()),\n+                             targets: (true_bb, else_bb)\n+                         })\n+\n+                    }\n+                    _ => {\n+                        // The switch may be inexhaustive so we\n+                        // add a catch all block\n+                        let otherwise = self.cfg.start_new_block();\n+                        let targets: Vec<_> =\n+                            options.iter()\n+                                   .map(|_| self.cfg.start_new_block())\n+                                   .chain(Some(otherwise))\n+                                   .collect();\n+\n+                        (targets.clone(),\n+                         TerminatorKind::SwitchInt {\n+                             discr: lvalue.clone(),\n+                             switch_ty: switch_ty,\n+                             values: options.clone(),\n+                             targets: targets\n+                         })\n+                    }\n+                };\n+\n                 self.cfg.terminate(block,\n                                    scope_id,\n                                    test.span,\n-                                   TerminatorKind::SwitchInt {\n-                                       discr: lvalue.clone(),\n-                                       switch_ty: switch_ty,\n-                                       values: options.clone(),\n-                                       targets: targets.clone(),\n-                                   });\n+                                   term);\n                 targets\n             }\n "}, {"sha": "d88a5f12e303dd17ce017b1accfe197f7437080b", "filename": "src/test/run-pass/exhaustive-bool-match-sanity.rs", "status": "added", "additions": 34, "deletions": 0, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/12d165352c6db8316675638288f94648ae72652e/src%2Ftest%2Frun-pass%2Fexhaustive-bool-match-sanity.rs", "raw_url": "https://github.com/rust-lang/rust/raw/12d165352c6db8316675638288f94648ae72652e/src%2Ftest%2Frun-pass%2Fexhaustive-bool-match-sanity.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fexhaustive-bool-match-sanity.rs?ref=12d165352c6db8316675638288f94648ae72652e", "patch": "@@ -0,0 +1,34 @@\n+// Copyright 2016 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// Issue #33540\n+// We previously used to generate a 3-armed boolean `SwitchInt` in the\n+// MIR of the function `foo` below. #33583 changed rustc to\n+// generate an `If` terminator instead. This test is to just ensure\n+// sanity in that we generate an if-else chain giving the correct\n+// results.\n+\n+#![feature(rustc_attrs)]\n+\n+#[rustc_mir]\n+fn foo(x: bool, y: bool) -> u32 {\n+    match (x, y) {\n+        (false, _) => 0,\n+        (_, false) => 1,\n+        (true, true) => 2\n+    }\n+}\n+\n+fn main() {\n+    assert_eq!(foo(false, true), 0);\n+    assert_eq!(foo(false, false), 0);\n+    assert_eq!(foo(true, false), 1);\n+    assert_eq!(foo(true, true), 2);\n+}"}]}