{"sha": "f6281e858699b482088e5f5cadcc6a0b7ab9e975", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY2MjgxZTg1ODY5OWI0ODIwODhlNWY1Y2FkY2M2YTBiN2FiOWU5NzU=", "commit": {"author": {"name": "Mark Rousskov", "email": "mark.simulacrum@gmail.com", "date": "2019-12-16T21:23:07Z"}, "committer": {"name": "Mark Rousskov", "email": "mark.simulacrum@gmail.com", "date": "2019-12-16T23:31:56Z"}, "message": "Change the default thread count to min(4, vCPUs)\n\nThis avoids the problems of high thread counts (i.e., contention in the\nkernel on the jobserver pipe due to thundering herd of readers) while\nstil giving rustc some parallelism to work with.", "tree": {"sha": "58cd07dc6e62d131978a977bd8d261e466911353", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/58cd07dc6e62d131978a977bd8d261e466911353"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f6281e858699b482088e5f5cadcc6a0b7ab9e975", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f6281e858699b482088e5f5cadcc6a0b7ab9e975", "html_url": "https://github.com/rust-lang/rust/commit/f6281e858699b482088e5f5cadcc6a0b7ab9e975", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f6281e858699b482088e5f5cadcc6a0b7ab9e975/comments", "author": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f0d4b571936d4072ed90ab7750636f68f1443b3e", "url": "https://api.github.com/repos/rust-lang/rust/commits/f0d4b571936d4072ed90ab7750636f68f1443b3e", "html_url": "https://github.com/rust-lang/rust/commit/f0d4b571936d4072ed90ab7750636f68f1443b3e"}], "stats": {"total": 10, "additions": 5, "deletions": 5}, "files": [{"sha": "359c8b3e73a908457b534317a1f779998acef721", "filename": "src/librustc_session/config.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/f6281e858699b482088e5f5cadcc6a0b7ab9e975/src%2Flibrustc_session%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f6281e858699b482088e5f5cadcc6a0b7ab9e975/src%2Flibrustc_session%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_session%2Fconfig.rs?ref=f6281e858699b482088e5f5cadcc6a0b7ab9e975", "patch": "@@ -1358,11 +1358,11 @@ options! {DebuggingOptions, DebuggingSetter, basic_debugging_options,\n         \"prints the LLVM optimization passes being run\"),\n     ast_json: bool = (false, parse_bool, [UNTRACKED],\n         \"print the AST as JSON and halt\"),\n-    // We default to 1 here since we want to behave like\n-    // a sequential compiler for now. This'll likely be adjusted\n-    // in the future. Note that -Zthreads=0 is the way to get\n-    // the num_cpus behavior.\n-    threads: usize = (1, parse_threads, [UNTRACKED],\n+    // We default to min(4, vCPUs) here since we want to avoid spawning *too*\n+    // many threads -- that causes scalability issues due to contention on\n+    // the jobserver pipe (at least) -- but 4 is a reasonable amount on systems\n+    // with lots of cores.\n+    threads: usize = (std::cmp::min(::num_cpus::get(), 4), parse_threads, [UNTRACKED],\n         \"use a thread pool with N threads\"),\n     ast_json_noexpand: bool = (false, parse_bool, [UNTRACKED],\n         \"print the pre-expansion AST as JSON and halt\"),"}]}