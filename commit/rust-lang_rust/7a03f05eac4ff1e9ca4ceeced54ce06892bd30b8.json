{"sha": "7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdhMDNmMDVlYWM0ZmYxZTljYTRjZWVjZWQ1NGNlMDY4OTJiZDMwYjg=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-08-09T23:16:58Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-08-09T23:16:58Z"}, "message": "Merge #5692\n\n5692: Add support for extern crate r=jonas-schievink a=Nashenas88\n\nThis adds syntax highlighting, hover and goto def functionality for extern crate.\r\n\r\nFixes #5690 \n\nCo-authored-by: Paul Daniel Faria <Nashenas88@users.noreply.github.com>", "tree": {"sha": "2a8074952398d7d72d8a83ddda35785c4821e20b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2a8074952398d7d72d8a83ddda35785c4821e20b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfMIPqCRBK7hj4Ov3rIwAAdHIIAGHLUULoJIN8nAGZ3aQvhjTD\nvYZc+qyp/lmMDoGUcXezzBz05mmtt4YBO1OQ0rBCUffmu9HPab0WqWCV3nVVYvJf\neZdoKnCnaENsOzFoW9SVLw2xx+aTo+T4H53lMlbqZ+YbpKKxtnvtL7vX75BAYvXW\nSHeyTmUchRV/8dJFlsA5GdXTXN/yW0PKQfaNWVo6wHK2V6KUnM/5TZLbBnCIrNfj\nj2CPK9+BxTM71Jt7PCMmlAIFChZ3dDlH/SEwg9Bmld966IDJ0VxJ7idv37VwvosI\nmui5LUwCMSEQRByxQiltA651QjWU8/gQT9tIM7KoHrxqITLVxh3UNCmMVjW1cGg=\n=FXBc\n-----END PGP SIGNATURE-----\n", "payload": "tree 2a8074952398d7d72d8a83ddda35785c4821e20b\nparent b1cb4ac13d5b625dd497692b6396287a30ff12e2\nparent bf9b4578bbe038501ef7c337e22b448de477f61c\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1597015018 +0000\ncommitter GitHub <noreply@github.com> 1597015018 +0000\n\nMerge #5692\n\n5692: Add support for extern crate r=jonas-schievink a=Nashenas88\n\nThis adds syntax highlighting, hover and goto def functionality for extern crate.\r\n\r\nFixes #5690 \n\nCo-authored-by: Paul Daniel Faria <Nashenas88@users.noreply.github.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8", "html_url": "https://github.com/rust-lang/rust/commit/7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b1cb4ac13d5b625dd497692b6396287a30ff12e2", "url": "https://api.github.com/repos/rust-lang/rust/commits/b1cb4ac13d5b625dd497692b6396287a30ff12e2", "html_url": "https://github.com/rust-lang/rust/commit/b1cb4ac13d5b625dd497692b6396287a30ff12e2"}, {"sha": "bf9b4578bbe038501ef7c337e22b448de477f61c", "url": "https://api.github.com/repos/rust-lang/rust/commits/bf9b4578bbe038501ef7c337e22b448de477f61c", "html_url": "https://github.com/rust-lang/rust/commit/bf9b4578bbe038501ef7c337e22b448de477f61c"}], "stats": {"total": 283, "additions": 224, "deletions": 59}, "files": [{"sha": "537322a72c3426e7a55843a8ced2851c8a04e791", "filename": "crates/ra_assists/src/handlers/add_turbo_fish.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8/crates%2Fra_assists%2Fsrc%2Fhandlers%2Fadd_turbo_fish.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8/crates%2Fra_assists%2Fsrc%2Fhandlers%2Fadd_turbo_fish.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_assists%2Fsrc%2Fhandlers%2Fadd_turbo_fish.rs?ref=7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8", "patch": "@@ -41,7 +41,7 @@ pub(crate) fn add_turbo_fish(acc: &mut Assists, ctx: &AssistContext) -> Option<(\n     let name_ref = ast::NameRef::cast(ident.parent())?;\n     let def = match classify_name_ref(&ctx.sema, &name_ref)? {\n         NameRefClass::Definition(def) => def,\n-        NameRefClass::FieldShorthand { .. } => return None,\n+        NameRefClass::ExternCrate(_) | NameRefClass::FieldShorthand { .. } => return None,\n     };\n     let fun = match def {\n         Definition::ModuleDef(hir::ModuleDef::Function(it)) => it,"}, {"sha": "0de6fdf3fb8a548dbf9f76f8dc157190e200f7a2", "filename": "crates/ra_assists/src/utils.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8/crates%2Fra_assists%2Fsrc%2Futils.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8/crates%2Fra_assists%2Fsrc%2Futils.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_assists%2Fsrc%2Futils.rs?ref=7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8", "patch": "@@ -257,7 +257,7 @@ pub use prelude::*;\n             .find(|dep| &dep.name.to_string() == std_crate)?\n             .krate;\n \n-        let mut module = std_crate.root_module(db)?;\n+        let mut module = std_crate.root_module(db);\n         for segment in path {\n             module = module.children(db).find_map(|child| {\n                 let name = child.name(db)?;"}, {"sha": "44456e49e2bca2e9c61eb97db287356f933c907f", "filename": "crates/ra_hir/src/code_model.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8/crates%2Fra_hir%2Fsrc%2Fcode_model.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8/crates%2Fra_hir%2Fsrc%2Fcode_model.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fcode_model.rs?ref=7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8", "patch": "@@ -83,9 +83,9 @@ impl Crate {\n             .collect()\n     }\n \n-    pub fn root_module(self, db: &dyn HirDatabase) -> Option<Module> {\n+    pub fn root_module(self, db: &dyn HirDatabase) -> Module {\n         let module_id = db.crate_def_map(self.id).root;\n-        Some(Module::new(self, module_id))\n+        Module::new(self, module_id)\n     }\n \n     pub fn root_file(self, db: &dyn HirDatabase) -> FileId {"}, {"sha": "e392130ab6d57fbf07a4003efb94266d2be47c9f", "filename": "crates/ra_hir/src/semantics.rs", "status": "modified", "additions": 22, "deletions": 3, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8/crates%2Fra_hir%2Fsrc%2Fsemantics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8/crates%2Fra_hir%2Fsrc%2Fsemantics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fsemantics.rs?ref=7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8", "patch": "@@ -8,7 +8,7 @@ use hir_def::{\n     resolver::{self, HasResolver, Resolver},\n     AsMacroCall, FunctionId, TraitId, VariantId,\n };\n-use hir_expand::{diagnostics::AstDiagnostic, hygiene::Hygiene, ExpansionInfo};\n+use hir_expand::{diagnostics::AstDiagnostic, hygiene::Hygiene, name::AsName, ExpansionInfo};\n use hir_ty::associated_type_shorthand_candidates;\n use itertools::Itertools;\n use ra_db::{FileId, FileRange};\n@@ -24,8 +24,8 @@ use crate::{\n     diagnostics::Diagnostic,\n     semantics::source_to_def::{ChildContainer, SourceToDefCache, SourceToDefCtx},\n     source_analyzer::{resolve_hir_path, resolve_hir_path_qualifier, SourceAnalyzer},\n-    AssocItem, Callable, Field, Function, HirFileId, ImplDef, InFile, Local, MacroDef, Module,\n-    ModuleDef, Name, Origin, Path, ScopeDef, Trait, Type, TypeAlias, TypeParam, VariantDef,\n+    AssocItem, Callable, Crate, Field, Function, HirFileId, ImplDef, InFile, Local, MacroDef,\n+    Module, ModuleDef, Name, Origin, Path, ScopeDef, Trait, Type, TypeAlias, TypeParam, VariantDef,\n };\n use resolver::TypeNs;\n \n@@ -228,6 +228,10 @@ impl<'db, DB: HirDatabase> Semantics<'db, DB> {\n         self.imp.resolve_path(path)\n     }\n \n+    pub fn resolve_extern_crate(&self, extern_crate: &ast::ExternCrate) -> Option<Crate> {\n+        self.imp.resolve_extern_crate(extern_crate)\n+    }\n+\n     pub fn resolve_variant(&self, record_lit: ast::RecordExpr) -> Option<VariantDef> {\n         self.imp.resolve_variant(record_lit).map(VariantDef::from)\n     }\n@@ -443,6 +447,17 @@ impl<'db> SemanticsImpl<'db> {\n         self.analyze(path.syntax()).resolve_path(self.db, path)\n     }\n \n+    fn resolve_extern_crate(&self, extern_crate: &ast::ExternCrate) -> Option<Crate> {\n+        let krate = self.scope(extern_crate.syntax()).krate()?;\n+        krate.dependencies(self.db).into_iter().find_map(|dep| {\n+            if dep.name == extern_crate.name_ref()?.as_name() {\n+                Some(dep.krate)\n+            } else {\n+                None\n+            }\n+        })\n+    }\n+\n     fn resolve_variant(&self, record_lit: ast::RecordExpr) -> Option<VariantId> {\n         self.analyze(record_lit.syntax()).resolve_variant(self.db, record_lit)\n     }\n@@ -612,6 +627,10 @@ impl<'a> SemanticsScope<'a> {\n         Some(Module { id: self.resolver.module()? })\n     }\n \n+    pub fn krate(&self) -> Option<Crate> {\n+        Some(Crate { id: self.resolver.krate()? })\n+    }\n+\n     /// Note: `FxHashSet<TraitId>` should be treated as an opaque type, passed into `Type\n     // FIXME: rename to visible_traits to not repeat scope?\n     pub fn traits_in_scope(&self) -> FxHashSet<TraitId> {"}, {"sha": "b5ff9fa2deb605261ccbb4a8d7f1a3fd04b64410", "filename": "crates/ra_ide/src/display/short_label.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8/crates%2Fra_ide%2Fsrc%2Fdisplay%2Fshort_label.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8/crates%2Fra_ide%2Fsrc%2Fdisplay%2Fshort_label.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fdisplay%2Fshort_label.rs?ref=7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8", "patch": "@@ -47,6 +47,12 @@ impl ShortLabel for ast::Module {\n     }\n }\n \n+impl ShortLabel for ast::SourceFile {\n+    fn short_label(&self) -> Option<String> {\n+        None\n+    }\n+}\n+\n impl ShortLabel for ast::TypeAlias {\n     fn short_label(&self) -> Option<String> {\n         short_label_from_node(self, \"type \")"}, {"sha": "45389fd23fedc2e38b201b233390593c8f82ad89", "filename": "crates/ra_ide/src/goto_definition.rs", "status": "modified", "additions": 29, "deletions": 7, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8/crates%2Fra_ide%2Fsrc%2Fgoto_definition.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8/crates%2Fra_ide%2Fsrc%2Fgoto_definition.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fgoto_definition.rs?ref=7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8", "patch": "@@ -1,6 +1,6 @@\n use hir::Semantics;\n use ra_ide_db::{\n-    defs::{classify_name, classify_name_ref, NameClass},\n+    defs::{classify_name, classify_name_ref},\n     symbol_index, RootDatabase,\n };\n use ra_syntax::{\n@@ -40,10 +40,7 @@ pub(crate) fn goto_definition(\n                 reference_definition(&sema, &name_ref).to_vec()\n             },\n             ast::Name(name) => {\n-                let def = match classify_name(&sema, &name)? {\n-                    NameClass::Definition(def) | NameClass::ConstReference(def) => def,\n-                    NameClass::FieldShorthand { local: _, field } => field,\n-                };\n+                let def = classify_name(&sema, &name)?.definition(sema.db);\n                 let nav = def.try_to_nav(sema.db)?;\n                 vec![nav]\n             },\n@@ -86,8 +83,7 @@ pub(crate) fn reference_definition(\n ) -> ReferenceResult {\n     let name_kind = classify_name_ref(sema, name_ref);\n     if let Some(def) = name_kind {\n-        let def = def.definition();\n-\n+        let def = def.definition(sema.db);\n         return match def.try_to_nav(sema.db) {\n             Some(nav) => ReferenceResult::Exact(nav),\n             None => ReferenceResult::Approximate(Vec::new()),\n@@ -133,6 +129,32 @@ mod tests {\n         assert_eq!(expected, FileRange { file_id: nav.file_id, range: nav.focus_or_full_range() });\n     }\n \n+    #[test]\n+    fn goto_def_for_extern_crate() {\n+        check(\n+            r#\"\n+            //- /main.rs\n+            extern crate std<|>;\n+            //- /std/lib.rs\n+            // empty\n+            //^ file\n+            \"#,\n+        )\n+    }\n+\n+    #[test]\n+    fn goto_def_for_renamed_extern_crate() {\n+        check(\n+            r#\"\n+            //- /main.rs\n+            extern crate std as abc<|>;\n+            //- /std/lib.rs\n+            // empty\n+            //^ file\n+            \"#,\n+        )\n+    }\n+\n     #[test]\n     fn goto_def_in_items() {\n         check("}, {"sha": "9c7348898a14efc5d84addb566c03d3971414bbb", "filename": "crates/ra_ide/src/hover.rs", "status": "modified", "additions": 46, "deletions": 3, "changes": 49, "blob_url": "https://github.com/rust-lang/rust/blob/7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8/crates%2Fra_ide%2Fsrc%2Fhover.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8/crates%2Fra_ide%2Fsrc%2Fhover.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fhover.rs?ref=7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8", "patch": "@@ -85,8 +85,8 @@ pub(crate) fn hover(db: &RootDatabase, position: FilePosition) -> Option<RangeIn\n     let node = token.parent();\n     let definition = match_ast! {\n         match node {\n-            ast::NameRef(name_ref) => classify_name_ref(&sema, &name_ref).map(|d| d.definition()),\n-            ast::Name(name) => classify_name(&sema, &name).map(|d| d.definition()),\n+            ast::NameRef(name_ref) => classify_name_ref(&sema, &name_ref).map(|d| d.definition(sema.db)),\n+            ast::Name(name) => classify_name(&sema, &name).map(|d| d.definition(sema.db)),\n             _ => None,\n         }\n     };\n@@ -304,7 +304,10 @@ fn hover_for_definition(db: &RootDatabase, def: Definition) -> Option<Markup> {\n                     let docs = Documentation::from_ast(&it).map(Into::into);\n                     hover_markup(docs, it.short_label(), mod_path)\n                 }\n-                _ => None,\n+                ModuleSource::SourceFile(it) => {\n+                    let docs = Documentation::from_ast(&it).map(Into::into);\n+                    hover_markup(docs, it.short_label(), mod_path)\n+                }\n             },\n             ModuleDef::Function(it) => from_def_source(db, it, mod_path),\n             ModuleDef::Adt(Adt::Struct(it)) => from_def_source(db, it, mod_path),\n@@ -1137,6 +1140,46 @@ fn bar() { fo<|>o(); }\n         );\n     }\n \n+    #[test]\n+    fn test_hover_extern_crate() {\n+        check(\n+            r#\"\n+//- /main.rs\n+extern crate st<|>d;\n+//- /std/lib.rs\n+//! Standard library for this test\n+//!\n+//! Printed?\n+//! abc123\n+            \"#,\n+            expect![[r#\"\n+            *std*\n+            Standard library for this test\n+\n+            Printed?\n+            abc123\n+            \"#]],\n+        );\n+        check(\n+            r#\"\n+//- /main.rs\n+extern crate std as ab<|>c;\n+//- /std/lib.rs\n+//! Standard library for this test\n+//!\n+//! Printed?\n+//! abc123\n+            \"#,\n+            expect![[r#\"\n+            *abc*\n+            Standard library for this test\n+\n+            Printed?\n+            abc123\n+            \"#]],\n+        );\n+    }\n+\n     #[test]\n     fn test_hover_mod_with_same_name_as_function() {\n         check("}, {"sha": "453985de3e3b28379117431302a7e2f5ef8e2f2e", "filename": "crates/ra_ide/src/references.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8/crates%2Fra_ide%2Fsrc%2Freferences.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8/crates%2Fra_ide%2Fsrc%2Freferences.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Freferences.rs?ref=7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8", "patch": "@@ -130,13 +130,13 @@ fn find_name(\n     opt_name: Option<ast::Name>,\n ) -> Option<RangeInfo<Definition>> {\n     if let Some(name) = opt_name {\n-        let def = classify_name(sema, &name)?.definition();\n+        let def = classify_name(sema, &name)?.definition(sema.db);\n         let range = name.syntax().text_range();\n         return Some(RangeInfo::new(range, def));\n     }\n     let name_ref =\n         sema.find_node_at_offset_with_descend::<ast::NameRef>(&syntax, position.offset)?;\n-    let def = classify_name_ref(sema, &name_ref)?.definition();\n+    let def = classify_name_ref(sema, &name_ref)?.definition(sema.db);\n     let range = name_ref.syntax().text_range();\n     Some(RangeInfo::new(range, def))\n }"}, {"sha": "6b7874460a23c1e62e975a6a768217690eb1d6ca", "filename": "crates/ra_ide/src/syntax_highlighting.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8/crates%2Fra_ide%2Fsrc%2Fsyntax_highlighting.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8/crates%2Fra_ide%2Fsrc%2Fsyntax_highlighting.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fsyntax_highlighting.rs?ref=7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8", "patch": "@@ -495,6 +495,7 @@ fn highlight_element(\n             };\n \n             match name_kind {\n+                Some(NameClass::ExternCrate(_)) => HighlightTag::Module.into(),\n                 Some(NameClass::Definition(def)) => {\n                     highlight_name(db, def, false) | HighlightModifier::Definition\n                 }\n@@ -522,6 +523,7 @@ fn highlight_element(\n             let possibly_unsafe = is_possibly_unsafe(&name_ref);\n             match classify_name_ref(sema, &name_ref) {\n                 Some(name_kind) => match name_kind {\n+                    NameRefClass::ExternCrate(_) => HighlightTag::Module.into(),\n                     NameRefClass::Definition(def) => {\n                         if let Definition::Local(local) = &def {\n                             if let Some(name) = local.name(db) {"}, {"sha": "09062c38e7581344e33f2bff701a06d6f9f4fd30", "filename": "crates/ra_ide/src/syntax_highlighting/tests.rs", "status": "modified", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8/crates%2Fra_ide%2Fsrc%2Fsyntax_highlighting%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8/crates%2Fra_ide%2Fsrc%2Fsyntax_highlighting%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fsyntax_highlighting%2Ftests.rs?ref=7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8", "patch": "@@ -391,6 +391,23 @@ macro_rules! noop {\n     );\n }\n \n+#[test]\n+fn test_extern_crate() {\n+    check_highlighting(\n+        r#\"\n+        //- /main.rs\n+        extern crate std;\n+        extern crate alloc as abc;\n+        //- /std/lib.rs\n+        pub struct S;\n+        //- /alloc/lib.rs\n+        pub struct A\n+        \"#,\n+        expect_file![\"crates/ra_ide/test_data/highlight_extern_crate.html\"],\n+        false,\n+    );\n+}\n+\n /// Highlights the code given by the `ra_fixture` argument, renders the\n /// result as HTML, and compares it with the HTML file given as `snapshot`.\n /// Note that the `snapshot` file is overwritten by the rendered HTML."}, {"sha": "800d894c7693d2a4649dfe9c691219c6833e4d01", "filename": "crates/ra_ide/test_data/highlight_extern_crate.html", "status": "added", "additions": 40, "deletions": 0, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8/crates%2Fra_ide%2Ftest_data%2Fhighlight_extern_crate.html", "raw_url": "https://github.com/rust-lang/rust/raw/7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8/crates%2Fra_ide%2Ftest_data%2Fhighlight_extern_crate.html", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Ftest_data%2Fhighlight_extern_crate.html?ref=7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8", "patch": "@@ -0,0 +1,40 @@\n+\n+<style>\n+body                { margin: 0; }\n+pre                 { color: #DCDCCC; background: #3F3F3F; font-size: 22px; padding: 0.4em; }\n+\n+.lifetime           { color: #DFAF8F; font-style: italic; }\n+.comment            { color: #7F9F7F; }\n+.documentation      { color: #629755; }\n+.injected           { opacity: 0.65 ; }\n+.struct, .enum      { color: #7CB8BB; }\n+.enum_variant       { color: #BDE0F3; }\n+.string_literal     { color: #CC9393; }\n+.field              { color: #94BFF3; }\n+.function           { color: #93E0E3; }\n+.function.unsafe    { color: #BC8383; }\n+.operator.unsafe    { color: #BC8383; }\n+.parameter          { color: #94BFF3; }\n+.text               { color: #DCDCCC; }\n+.type               { color: #7CB8BB; }\n+.builtin_type       { color: #8CD0D3; }\n+.type_param         { color: #DFAF8F; }\n+.attribute          { color: #94BFF3; }\n+.numeric_literal    { color: #BFEBBF; }\n+.bool_literal       { color: #BFE6EB; }\n+.macro              { color: #94BFF3; }\n+.module             { color: #AFD8AF; }\n+.value_param        { color: #DCDCCC; }\n+.variable           { color: #DCDCCC; }\n+.format_specifier   { color: #CC696B; }\n+.mutable            { text-decoration: underline; }\n+.escape_sequence    { color: #94BFF3; }\n+.keyword            { color: #F0DFAF; font-weight: bold; }\n+.keyword.unsafe     { color: #BC8383; font-weight: bold; }\n+.control            { font-style: italic; }\n+\n+.unresolved_reference { color: #FC5555; text-decoration: wavy underline; }\n+</style>\n+<pre><code><span class=\"keyword\">extern</span> <span class=\"keyword\">crate</span> <span class=\"module\">std</span><span class=\"punctuation\">;</span>\n+<span class=\"keyword\">extern</span> <span class=\"keyword\">crate</span> <span class=\"module\">alloc</span> <span class=\"keyword\">as</span> <span class=\"module\">abc</span><span class=\"punctuation\">;</span>\n+</code></pre>\n\\ No newline at end of file"}, {"sha": "9bb95277d0da3e29765c4d2e350fe5ebcbf3f94a", "filename": "crates/ra_ide_db/src/defs.rs", "status": "modified", "additions": 53, "deletions": 37, "changes": 90, "blob_url": "https://github.com/rust-lang/rust/blob/7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8/crates%2Fra_ide_db%2Fsrc%2Fdefs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8/crates%2Fra_ide_db%2Fsrc%2Fdefs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_db%2Fsrc%2Fdefs.rs?ref=7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8", "patch": "@@ -6,8 +6,8 @@\n // FIXME: this badly needs rename/rewrite (matklad, 2020-02-06).\n \n use hir::{\n-    Field, HasVisibility, ImplDef, Local, MacroDef, Module, ModuleDef, Name, PathResolution,\n-    Semantics, TypeParam, Visibility,\n+    db::HirDatabase, Crate, Field, HasVisibility, ImplDef, Local, MacroDef, Module, ModuleDef,\n+    Name, PathResolution, Semantics, TypeParam, Visibility,\n };\n use ra_prof::profile;\n use ra_syntax::{\n@@ -80,6 +80,7 @@ impl Definition {\n \n #[derive(Debug)]\n pub enum NameClass {\n+    ExternCrate(Crate),\n     Definition(Definition),\n     /// `None` in `if let None = Some(82) {}`\n     ConstReference(Definition),\n@@ -90,16 +91,18 @@ pub enum NameClass {\n }\n \n impl NameClass {\n-    pub fn into_definition(self) -> Option<Definition> {\n-        match self {\n-            NameClass::Definition(it) => Some(it),\n-            NameClass::ConstReference(_) => None,\n-            NameClass::FieldShorthand { local, field: _ } => Some(Definition::Local(local)),\n-        }\n+    pub fn into_definition(self, db: &dyn HirDatabase) -> Option<Definition> {\n+        Some(match self {\n+            NameClass::ExternCrate(krate) => Definition::ModuleDef(krate.root_module(db).into()),\n+            NameClass::Definition(it) => it,\n+            NameClass::ConstReference(_) => return None,\n+            NameClass::FieldShorthand { local, field: _ } => Definition::Local(local),\n+        })\n     }\n \n-    pub fn definition(self) -> Definition {\n+    pub fn definition(self, db: &dyn HirDatabase) -> Definition {\n         match self {\n+            NameClass::ExternCrate(krate) => Definition::ModuleDef(krate.root_module(db).into()),\n             NameClass::Definition(it) | NameClass::ConstReference(it) => it,\n             NameClass::FieldShorthand { local: _, field } => field,\n         }\n@@ -120,32 +123,37 @@ pub fn classify_name(sema: &Semantics<RootDatabase>, name: &ast::Name) -> Option\n     match_ast! {\n         match parent {\n             ast::Rename(it) => {\n-                let use_tree = it.syntax().parent().and_then(ast::UseTree::cast)?;\n-                let path = use_tree.path()?;\n-                let path_segment = path.segment()?;\n-                let name_ref_class = path_segment\n-                    .name_ref()\n-                    // The rename might be from a `self` token, so fallback to the name higher\n-                    // in the use tree.\n-                    .or_else(||{\n-                        if path_segment.self_token().is_none() {\n-                            return None;\n-                        }\n+                if let Some(use_tree) = it.syntax().parent().and_then(ast::UseTree::cast) {\n+                    let path = use_tree.path()?;\n+                    let path_segment = path.segment()?;\n+                    let name_ref_class = path_segment\n+                        .name_ref()\n+                        // The rename might be from a `self` token, so fallback to the name higher\n+                        // in the use tree.\n+                        .or_else(||{\n+                            if path_segment.self_token().is_none() {\n+                                return None;\n+                            }\n \n-                        let use_tree = use_tree\n-                            .syntax()\n-                            .parent()\n-                            .as_ref()\n-                            // Skip over UseTreeList\n-                            .and_then(SyntaxNode::parent)\n-                            .and_then(ast::UseTree::cast)?;\n-                        let path = use_tree.path()?;\n-                        let path_segment = path.segment()?;\n-                        path_segment.name_ref()\n-                    })\n-                    .and_then(|name_ref| classify_name_ref(sema, &name_ref))?;\n+                            let use_tree = use_tree\n+                                .syntax()\n+                                .parent()\n+                                .as_ref()\n+                                // Skip over UseTreeList\n+                                .and_then(SyntaxNode::parent)\n+                                .and_then(ast::UseTree::cast)?;\n+                            let path = use_tree.path()?;\n+                            let path_segment = path.segment()?;\n+                            path_segment.name_ref()\n+                        })\n+                        .and_then(|name_ref| classify_name_ref(sema, &name_ref))?;\n \n-                Some(NameClass::Definition(name_ref_class.definition()))\n+                    Some(NameClass::Definition(name_ref_class.definition(sema.db)))\n+                } else {\n+                    let extern_crate = it.syntax().parent().and_then(ast::ExternCrate::cast)?;\n+                    let resolved = sema.resolve_extern_crate(&extern_crate)?;\n+                    Some(NameClass::ExternCrate(resolved))\n+                }\n             },\n             ast::IdentPat(it) => {\n                 let local = sema.to_def(&it)?;\n@@ -220,13 +228,15 @@ pub fn classify_name(sema: &Semantics<RootDatabase>, name: &ast::Name) -> Option\n \n #[derive(Debug)]\n pub enum NameRefClass {\n+    ExternCrate(Crate),\n     Definition(Definition),\n     FieldShorthand { local: Local, field: Definition },\n }\n \n impl NameRefClass {\n-    pub fn definition(self) -> Definition {\n+    pub fn definition(self, db: &dyn HirDatabase) -> Definition {\n         match self {\n+            NameRefClass::ExternCrate(krate) => Definition::ModuleDef(krate.root_module(db).into()),\n             NameRefClass::Definition(def) => def,\n             NameRefClass::FieldShorthand { local, field: _ } => Definition::Local(local),\n         }\n@@ -307,9 +317,15 @@ pub fn classify_name_ref(\n         }\n     }\n \n-    let path = name_ref.syntax().ancestors().find_map(ast::Path::cast)?;\n-    let resolved = sema.resolve_path(&path)?;\n-    Some(NameRefClass::Definition(resolved.into()))\n+    if let Some(path) = name_ref.syntax().ancestors().find_map(ast::Path::cast) {\n+        if let Some(resolved) = sema.resolve_path(&path) {\n+            return Some(NameRefClass::Definition(resolved.into()));\n+        }\n+    }\n+\n+    let extern_crate = ast::ExternCrate::cast(parent)?;\n+    let resolved = sema.resolve_extern_crate(&extern_crate)?;\n+    Some(NameRefClass::ExternCrate(resolved))\n }\n \n impl From<PathResolution> for Definition {"}, {"sha": "9e040973b3b3c6adbcc73ba31969140108f2e35a", "filename": "crates/ra_ide_db/src/imports_locator.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8/crates%2Fra_ide_db%2Fsrc%2Fimports_locator.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8/crates%2Fra_ide_db%2Fsrc%2Fimports_locator.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_db%2Fsrc%2Fimports_locator.rs?ref=7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8", "patch": "@@ -61,5 +61,5 @@ fn get_name_definition<'a>(\n         candidate_node\n     };\n     let name = ast::Name::cast(candidate_name_node)?;\n-    classify_name(sema, &name)?.into_definition()\n+    classify_name(sema, &name)?.into_definition(sema.db)\n }"}, {"sha": "0d386841e52350b53fd2d1a94856ade2b781ba31", "filename": "crates/rust-analyzer/src/cli/analysis_stats.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fanalysis_stats.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fanalysis_stats.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fanalysis_stats.rs?ref=7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8", "patch": "@@ -72,7 +72,7 @@ impl AnalysisStatsCmd {\n             shuffle(&mut rng, &mut krates);\n         }\n         for krate in krates {\n-            let module = krate.root_module(db).expect(\"crate without root module\");\n+            let module = krate.root_module(db);\n             let file_id = module.definition_source(db).file_id;\n             let file_id = file_id.original_file(db);\n             let source_root = db.file_source_root(file_id);"}, {"sha": "f17fc5dfe907134c03e53f452c2182e7bceb5fe4", "filename": "crates/rust-analyzer/src/cli/diagnostics.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fdiagnostics.rs?ref=7a03f05eac4ff1e9ca4ceeced54ce06892bd30b8", "patch": "@@ -28,7 +28,7 @@ pub fn diagnostics(\n     let mut work = Vec::new();\n     let krates = Crate::all(db);\n     for krate in krates {\n-        let module = krate.root_module(db).expect(\"crate without root module\");\n+        let module = krate.root_module(db);\n         let file_id = module.definition_source(db).file_id;\n         let file_id = file_id.original_file(db);\n         let source_root = db.file_source_root(file_id);"}]}