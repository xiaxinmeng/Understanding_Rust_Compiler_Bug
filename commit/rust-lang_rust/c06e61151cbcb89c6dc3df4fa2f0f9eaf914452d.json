{"sha": "c06e61151cbcb89c6dc3df4fa2f0f9eaf914452d", "node_id": "C_kwDOAAsO6NoAKGMwNmU2MTE1MWNiY2I4OWM2ZGMzZGY0ZmEyZjBmOWVhZjkxNDQ1MmQ", "commit": {"author": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2023-04-09T00:49:50Z"}, "committer": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2023-05-12T18:47:45Z"}, "message": "do not allow inference in `pred_known_to_hold_modulo_regions`", "tree": {"sha": "447991e4afb38a80e8a0e9b5507128d347e8ec47", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/447991e4afb38a80e8a0e9b5507128d347e8ec47"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c06e61151cbcb89c6dc3df4fa2f0f9eaf914452d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c06e61151cbcb89c6dc3df4fa2f0f9eaf914452d", "html_url": "https://github.com/rust-lang/rust/commit/c06e61151cbcb89c6dc3df4fa2f0f9eaf914452d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c06e61151cbcb89c6dc3df4fa2f0f9eaf914452d/comments", "author": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "dbbb42442cdb8fdfa610a03355f8614bd1d08ffb", "url": "https://api.github.com/repos/rust-lang/rust/commits/dbbb42442cdb8fdfa610a03355f8614bd1d08ffb", "html_url": "https://github.com/rust-lang/rust/commit/dbbb42442cdb8fdfa610a03355f8614bd1d08ffb"}], "stats": {"total": 61, "additions": 38, "deletions": 23}, "files": [{"sha": "53398a5971253ff74bad7d8e1d61ec746549f96d", "filename": "compiler/rustc_trait_selection/src/traits/mod.rs", "status": "modified", "additions": 21, "deletions": 20, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/c06e61151cbcb89c6dc3df4fa2f0f9eaf914452d/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c06e61151cbcb89c6dc3df4fa2f0f9eaf914452d/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fmod.rs?ref=c06e61151cbcb89c6dc3df4fa2f0f9eaf914452d", "patch": "@@ -142,35 +142,36 @@ pub fn type_known_to_meet_bound_modulo_regions<'tcx>(\n fn pred_known_to_hold_modulo_regions<'tcx>(\n     infcx: &InferCtxt<'tcx>,\n     param_env: ty::ParamEnv<'tcx>,\n-    pred: impl ToPredicate<'tcx> + TypeVisitable<TyCtxt<'tcx>>,\n+    pred: impl ToPredicate<'tcx>,\n ) -> bool {\n-    let has_non_region_infer = pred.has_non_region_infer();\n     let obligation = Obligation::new(infcx.tcx, ObligationCause::dummy(), param_env, pred);\n \n     let result = infcx.evaluate_obligation_no_overflow(&obligation);\n     debug!(?result);\n \n-    if result.must_apply_modulo_regions() && !has_non_region_infer {\n+    if result.must_apply_modulo_regions() {\n         true\n     } else if result.may_apply() {\n-        // Because of inference \"guessing\", selection can sometimes claim\n-        // to succeed while the success requires a guess. To ensure\n-        // this function's result remains infallible, we must confirm\n-        // that guess. While imperfect, I believe this is sound.\n-\n-        // The handling of regions in this area of the code is terrible,\n-        // see issue #29149. We should be able to improve on this with\n-        // NLL.\n-        let ocx = ObligationCtxt::new(infcx);\n-        ocx.register_obligation(obligation);\n-        let errors = ocx.select_all_or_error();\n-        match errors.as_slice() {\n-            [] => true,\n-            errors => {\n-                debug!(?errors);\n-                false\n+        // Sometimes obligations are ambiguous because the recursive evaluator\n+        // is not smart enough, so we fall back to fulfillment when we're not certain\n+        // that an obligation holds or not. Even still, we must make sure that\n+        // the we do no inference in the process of checking this obligation.\n+        let goal = infcx.resolve_vars_if_possible((obligation.predicate, obligation.param_env));\n+        infcx.probe(|_| {\n+            let ocx = ObligationCtxt::new_in_snapshot(infcx);\n+            ocx.register_obligation(obligation);\n+\n+            let errors = ocx.select_all_or_error();\n+            match errors.as_slice() {\n+                // Only known to hold if we did no inference.\n+                [] => infcx.shallow_resolve(goal) == goal,\n+\n+                errors => {\n+                    debug!(?errors);\n+                    false\n+                }\n             }\n-        }\n+        })\n     } else {\n         false\n     }"}, {"sha": "ed0410178af518d3955372d6483e7de7dcd8a35c", "filename": "compiler/rustc_trait_selection/src/traits/select/mod.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/c06e61151cbcb89c6dc3df4fa2f0f9eaf914452d/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c06e61151cbcb89c6dc3df4fa2f0f9eaf914452d/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fmod.rs?ref=c06e61151cbcb89c6dc3df4fa2f0f9eaf914452d", "patch": "@@ -537,7 +537,8 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n         obligation: &PredicateObligation<'tcx>,\n     ) -> Result<EvaluationResult, OverflowError> {\n         self.evaluation_probe(|this| {\n-            let goal = infcx.resolve_vars_if_possible((obligation.predicate, obligation.param_env));\n+            let goal =\n+                this.infcx.resolve_vars_if_possible((obligation.predicate, obligation.param_env));\n             let mut result = if this.tcx().trait_solver_next() {\n                 this.evaluate_predicates_recursively_in_new_solver([obligation.clone()])?\n             } else {"}, {"sha": "c1ed4c28a0300573ea5e8690d85c6ab15e31715c", "filename": "tests/ui/traits/copy-guessing.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/c06e61151cbcb89c6dc3df4fa2f0f9eaf914452d/tests%2Fui%2Ftraits%2Fcopy-guessing.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c06e61151cbcb89c6dc3df4fa2f0f9eaf914452d/tests%2Fui%2Ftraits%2Fcopy-guessing.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ftraits%2Fcopy-guessing.rs?ref=c06e61151cbcb89c6dc3df4fa2f0f9eaf914452d", "patch": "@@ -1,5 +1,3 @@\n-// run-pass\n-\n #![allow(dead_code)]\n #![allow(drop_copy)]\n \n@@ -20,6 +18,7 @@ fn assert_impls_fn<R,T: Fn()->R>(_: &T){}\n \n fn main() {\n     let n = None;\n+    //~^ ERROR type annotations needed for `Option<T>`\n     let e = S(&n);\n     let f = || {\n         // S being copy is critical for this to work"}, {"sha": "568b7e5a64af967bd857cd3a79c82a10d097ea05", "filename": "tests/ui/traits/copy-guessing.stderr", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/c06e61151cbcb89c6dc3df4fa2f0f9eaf914452d/tests%2Fui%2Ftraits%2Fcopy-guessing.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c06e61151cbcb89c6dc3df4fa2f0f9eaf914452d/tests%2Fui%2Ftraits%2Fcopy-guessing.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ftraits%2Fcopy-guessing.stderr?ref=c06e61151cbcb89c6dc3df4fa2f0f9eaf914452d", "patch": "@@ -0,0 +1,14 @@\n+error[E0282]: type annotations needed for `Option<T>`\n+  --> $DIR/copy-guessing.rs:20:9\n+   |\n+LL |     let n = None;\n+   |         ^\n+   |\n+help: consider giving `n` an explicit type, where the type for type parameter `T` is specified\n+   |\n+LL |     let n: Option<T> = None;\n+   |          +++++++++++\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0282`."}]}