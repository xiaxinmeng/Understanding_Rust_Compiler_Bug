{"sha": "c337fd5467f52b5f79f653b7e71f945cc8cf09d1", "node_id": "MDY6Q29tbWl0NzI0NzEyOmMzMzdmZDU0NjdmNTJiNWY3OWY2NTNiN2U3MWY5NDVjYzhjZjA5ZDE=", "commit": {"author": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2011-09-07T01:16:39Z"}, "committer": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2011-09-07T17:32:58Z"}, "message": "Child tasks take a ref to their parents\n\nThis is so that when a child dies after the parent, it still holds a valid\npointer and can call supervisor->kill() safely.", "tree": {"sha": "8c7151c29e0e53578b18a60a96d03e95369da95d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8c7151c29e0e53578b18a60a96d03e95369da95d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c337fd5467f52b5f79f653b7e71f945cc8cf09d1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c337fd5467f52b5f79f653b7e71f945cc8cf09d1", "html_url": "https://github.com/rust-lang/rust/commit/c337fd5467f52b5f79f653b7e71f945cc8cf09d1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c337fd5467f52b5f79f653b7e71f945cc8cf09d1/comments", "author": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "committer": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "25ae3d655cef63041d405a45f4797d21f8904502", "url": "https://api.github.com/repos/rust-lang/rust/commits/25ae3d655cef63041d405a45f4797d21f8904502", "html_url": "https://github.com/rust-lang/rust/commit/25ae3d655cef63041d405a45f4797d21f8904502"}], "stats": {"total": 24, "additions": 24, "deletions": 0}, "files": [{"sha": "31a3324f1d46f5dbd56248a284ff7a265a836389", "filename": "src/rt/rust_task.cpp", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/c337fd5467f52b5f79f653b7e71f945cc8cf09d1/src%2Frt%2Frust_task.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/c337fd5467f52b5f79f653b7e71f945cc8cf09d1/src%2Frt%2Frust_task.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_task.cpp?ref=c337fd5467f52b5f79f653b7e71f945cc8cf09d1", "patch": "@@ -86,6 +86,9 @@ rust_task::rust_task(rust_scheduler *sched, rust_task_list *state,\n \n     stk = new_stk(sched, this, 0);\n     user.rust_sp = stk->limit;\n+    if (supervisor) {\n+        supervisor->ref();\n+    }\n }\n \n rust_task::~rust_task()\n@@ -107,6 +110,10 @@ rust_task::~rust_task()\n         }\n     }\n \n+    if (supervisor) {\n+        supervisor->deref();\n+    }\n+\n     kernel->release_task_id(user.id);\n \n     /* FIXME: tighten this up, there are some more\n@@ -294,6 +301,9 @@ rust_task::unsupervise()\n              \"task %s @0x%\" PRIxPTR\n              \" disconnecting from supervisor %s @0x%\" PRIxPTR,\n              name, this, supervisor->name, supervisor);\n+    if (supervisor) {\n+        supervisor->deref();\n+    }\n     supervisor = NULL;\n     propagate_failure = false;\n }"}, {"sha": "0ff641fbe953f6f318ce28d3349b9fe74dabc79b", "filename": "src/test/run-fail/spawnfail.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/c337fd5467f52b5f79f653b7e71f945cc8cf09d1/src%2Ftest%2Frun-fail%2Fspawnfail.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c337fd5467f52b5f79f653b7e71f945cc8cf09d1/src%2Ftest%2Frun-fail%2Fspawnfail.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-fail%2Fspawnfail.rs?ref=c337fd5467f52b5f79f653b7e71f945cc8cf09d1", "patch": "@@ -0,0 +1,14 @@\n+// Currently failure doesn't propagate correctly to owning tasks so xfailed\n+// xfail-test\n+// error-pattern:explicit\n+use std;\n+import std::task;\n+\n+// We don't want to see any invalid reads\n+fn main() {\n+    fn f() {\n+        fail;\n+    }\n+    let g = f;\n+    task::spawn(g);\n+}\n\\ No newline at end of file"}]}