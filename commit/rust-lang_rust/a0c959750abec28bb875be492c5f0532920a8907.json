{"sha": "a0c959750abec28bb875be492c5f0532920a8907", "node_id": "C_kwDOAAsO6NoAKGEwYzk1OTc1MGFiZWMyOGJiODc1YmU0OTJjNWYwNTMyOTIwYTg5MDc", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2021-11-29T15:21:35Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2021-11-29T15:23:46Z"}, "message": "std: Stabilize the `thread_local_const_init` feature\n\nThis commit is intended to follow the stabilization disposition of the\nFCP that has now finished in #84223. This stabilizes the ability to flag\nthread local initializers as `const` expressions which enables the macro\nto generate more efficient code for accessing it, notably removing\nruntime checks for initialization.\n\nMore information can also be found in #84223 as well as the tests where\nthe feature usage was removed in this PR.\n\nCloses #84223", "tree": {"sha": "96a798597c4ccc2f4c6c05642fb257172f2a9ea4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/96a798597c4ccc2f4c6c05642fb257172f2a9ea4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a0c959750abec28bb875be492c5f0532920a8907", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a0c959750abec28bb875be492c5f0532920a8907", "html_url": "https://github.com/rust-lang/rust/commit/a0c959750abec28bb875be492c5f0532920a8907", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a0c959750abec28bb875be492c5f0532920a8907/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8b954910c59a7a362c60959e93110892b6e9a691", "url": "https://api.github.com/repos/rust-lang/rust/commits/8b954910c59a7a362c60959e93110892b6e9a691", "html_url": "https://github.com/rust-lang/rust/commit/8b954910c59a7a362c60959e93110892b6e9a691"}], "stats": {"total": 35, "additions": 1, "deletions": 34}, "files": [{"sha": "66d1ae1420a143d11f46ff2aaaae422cb38e4862", "filename": "compiler/rustc_middle/src/lib.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/a0c959750abec28bb875be492c5f0532920a8907/compiler%2Frustc_middle%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a0c959750abec28bb875be492c5f0532920a8907/compiler%2Frustc_middle%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Flib.rs?ref=a0c959750abec28bb875be492c5f0532920a8907", "patch": "@@ -51,7 +51,6 @@\n #![feature(control_flow_enum)]\n #![feature(associated_type_defaults)]\n #![feature(iter_zip)]\n-#![feature(thread_local_const_init)]\n #![feature(trusted_step)]\n #![feature(try_blocks)]\n #![feature(try_reserve_kind)]"}, {"sha": "0da141f6836f68a3281c963124009697b81c4eeb", "filename": "compiler/rustc_query_system/src/lib.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/a0c959750abec28bb875be492c5f0532920a8907/compiler%2Frustc_query_system%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a0c959750abec28bb875be492c5f0532920a8907/compiler%2Frustc_query_system%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_query_system%2Fsrc%2Flib.rs?ref=a0c959750abec28bb875be492c5f0532920a8907", "patch": "@@ -5,7 +5,6 @@\n #![feature(iter_zip)]\n #![feature(let_else)]\n #![feature(min_specialization)]\n-#![feature(thread_local_const_init)]\n #![feature(extern_types)]\n \n #[macro_use]"}, {"sha": "e06379cadddd5e94df02912a0cd698a9cc7808de", "filename": "compiler/rustc_span/src/lib.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/a0c959750abec28bb875be492c5f0532920a8907/compiler%2Frustc_span%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a0c959750abec28bb875be492c5f0532920a8907/compiler%2Frustc_span%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_span%2Fsrc%2Flib.rs?ref=a0c959750abec28bb875be492c5f0532920a8907", "patch": "@@ -20,7 +20,6 @@\n #![feature(negative_impls)]\n #![feature(nll)]\n #![feature(min_specialization)]\n-#![feature(thread_local_const_init)]\n \n #[macro_use]\n extern crate rustc_macros;"}, {"sha": "380de97407df26cec3ccaeff479b16f1965306b9", "filename": "library/std/src/lib.rs", "status": "modified", "additions": 1, "deletions": 4, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/a0c959750abec28bb875be492c5f0532920a8907/library%2Fstd%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a0c959750abec28bb875be492c5f0532920a8907/library%2Fstd%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Flib.rs?ref=a0c959750abec28bb875be492c5f0532920a8907", "patch": "@@ -216,10 +216,7 @@\n // std may use features in a platform-specific way\n #![allow(unused_features)]\n #![feature(rustc_allow_const_fn_unstable)]\n-#![cfg_attr(\n-    test,\n-    feature(internal_output_capture, print_internals, update_panic_count, thread_local_const_init)\n-)]\n+#![cfg_attr(test, feature(internal_output_capture, print_internals, update_panic_count))]\n #![cfg_attr(\n     all(target_vendor = \"fortanix\", target_env = \"sgx\"),\n     feature(slice_index_methods, coerce_unsized, sgx_platform)"}, {"sha": "ed0c47bc18f13c77ad786e5b1ba4a4bcb907b17a", "filename": "library/std/src/thread/local.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/a0c959750abec28bb875be492c5f0532920a8907/library%2Fstd%2Fsrc%2Fthread%2Flocal.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a0c959750abec28bb875be492c5f0532920a8907/library%2Fstd%2Fsrc%2Fthread%2Flocal.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fthread%2Flocal.rs?ref=a0c959750abec28bb875be492c5f0532920a8907", "patch": "@@ -164,7 +164,6 @@ macro_rules! __thread_local_inner {\n     (@key $t:ty, const $init:expr) => {{\n         #[cfg_attr(not(windows), inline)] // see comments below\n         unsafe fn __getit() -> $crate::option::Option<&'static $t> {\n-            const _REQUIRE_UNSTABLE: () = $crate::thread::require_unstable_const_init_thread_local();\n             const INIT_EXPR: $t = $init;\n \n             // wasm without atomics maps directly to `static mut`, and dtors"}, {"sha": "64f6c7fa022fc7268392897dacbf9bb7ae47dd9b", "filename": "library/std/src/thread/mod.rs", "status": "modified", "additions": 0, "deletions": 7, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/a0c959750abec28bb875be492c5f0532920a8907/library%2Fstd%2Fsrc%2Fthread%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a0c959750abec28bb875be492c5f0532920a8907/library%2Fstd%2Fsrc%2Fthread%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fthread%2Fmod.rs?ref=a0c959750abec28bb875be492c5f0532920a8907", "patch": "@@ -204,13 +204,6 @@ pub use self::local::os::Key as __OsLocalKeyInner;\n #[doc(hidden)]\n pub use self::local::statik::Key as __StaticLocalKeyInner;\n \n-// This is only used to make thread locals with `const { .. }` initialization\n-// expressions unstable. If and/or when that syntax is stabilized with thread\n-// locals this will simply be removed.\n-#[doc(hidden)]\n-#[unstable(feature = \"thread_local_const_init\", issue = \"84223\")]\n-pub const fn require_unstable_const_init_thread_local() {}\n-\n ////////////////////////////////////////////////////////////////////////////////\n // Builder\n ////////////////////////////////////////////////////////////////////////////////"}, {"sha": "bebaa7754dd5a55dd061beac22bbdb5a63b8661e", "filename": "src/test/codegen/auxiliary/thread_local_aux.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/a0c959750abec28bb875be492c5f0532920a8907/src%2Ftest%2Fcodegen%2Fauxiliary%2Fthread_local_aux.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a0c959750abec28bb875be492c5f0532920a8907/src%2Ftest%2Fcodegen%2Fauxiliary%2Fthread_local_aux.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fauxiliary%2Fthread_local_aux.rs?ref=a0c959750abec28bb875be492c5f0532920a8907", "patch": "@@ -1,5 +1,4 @@\n #![crate_type = \"lib\"]\n-#![feature(thread_local_const_init)]\n \n use std::cell::Cell;\n "}, {"sha": "5ac30d949fa4e4c5aff0611d88ca4fca41a6e892", "filename": "src/test/codegen/thread-local.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/a0c959750abec28bb875be492c5f0532920a8907/src%2Ftest%2Fcodegen%2Fthread-local.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a0c959750abec28bb875be492c5f0532920a8907/src%2Ftest%2Fcodegen%2Fthread-local.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fthread-local.rs?ref=a0c959750abec28bb875be492c5f0532920a8907", "patch": "@@ -6,7 +6,6 @@\n // ignore-android does not use #[thread_local]\n \n #![crate_type = \"lib\"]\n-#![feature(thread_local_const_init)]\n \n extern crate thread_local_aux as aux;\n "}, {"sha": "6584ffa7cf949f91833cdf9e69b55a851bd8ba74", "filename": "src/test/ui/feature-gates/thread-local-const-init.rs", "status": "removed", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/8b954910c59a7a362c60959e93110892b6e9a691/src%2Ftest%2Fui%2Ffeature-gates%2Fthread-local-const-init.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8b954910c59a7a362c60959e93110892b6e9a691/src%2Ftest%2Fui%2Ffeature-gates%2Fthread-local-const-init.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffeature-gates%2Fthread-local-const-init.rs?ref=8b954910c59a7a362c60959e93110892b6e9a691", "patch": "@@ -1,4 +0,0 @@\n-thread_local!(static X: u32 = const { 0 });\n-//~^ ERROR: use of unstable library feature 'thread_local_const_init'\n-\n-fn main() {}"}, {"sha": "f80506831b4e8172a3c3d4a69f99e8a17ba2b12f", "filename": "src/test/ui/feature-gates/thread-local-const-init.stderr", "status": "removed", "additions": 0, "deletions": 13, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/8b954910c59a7a362c60959e93110892b6e9a691/src%2Ftest%2Fui%2Ffeature-gates%2Fthread-local-const-init.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/8b954910c59a7a362c60959e93110892b6e9a691/src%2Ftest%2Fui%2Ffeature-gates%2Fthread-local-const-init.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffeature-gates%2Fthread-local-const-init.stderr?ref=8b954910c59a7a362c60959e93110892b6e9a691", "patch": "@@ -1,13 +0,0 @@\n-error[E0658]: use of unstable library feature 'thread_local_const_init'\n-  --> $DIR/thread-local-const-init.rs:1:1\n-   |\n-LL | thread_local!(static X: u32 = const { 0 });\n-   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n-   |\n-   = note: see issue #84223 <https://github.com/rust-lang/rust/issues/84223> for more information\n-   = help: add `#![feature(thread_local_const_init)]` to the crate attributes to enable\n-   = note: this error originates in the macro `$crate::__thread_local_inner` (in Nightly builds, run with -Z macro-backtrace for more info)\n-\n-error: aborting due to previous error\n-\n-For more information about this error, try `rustc --explain E0658`."}]}