{"sha": "1ff143191c62bc7cfa17da99dac59a871f39a462", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFmZjE0MzE5MWM2MmJjN2NmYTE3ZGE5OWRhYzU5YTg3MWYzOWE0NjI=", "commit": {"author": {"name": "Dylan MacKenzie", "email": "ecstaticmorse@gmail.com", "date": "2020-09-24T23:17:03Z"}, "committer": {"name": "Dylan MacKenzie", "email": "ecstaticmorse@gmail.com", "date": "2020-09-27T17:46:41Z"}, "message": "Add a feature gate for basic function pointer use in `const fn`", "tree": {"sha": "fbe81a340ed6bf484052c517c12285eab67b567c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fbe81a340ed6bf484052c517c12285eab67b567c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1ff143191c62bc7cfa17da99dac59a871f39a462", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1ff143191c62bc7cfa17da99dac59a871f39a462", "html_url": "https://github.com/rust-lang/rust/commit/1ff143191c62bc7cfa17da99dac59a871f39a462", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1ff143191c62bc7cfa17da99dac59a871f39a462/comments", "author": {"login": "ecstatic-morse", "id": 29463364, "node_id": "MDQ6VXNlcjI5NDYzMzY0", "avatar_url": "https://avatars.githubusercontent.com/u/29463364?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ecstatic-morse", "html_url": "https://github.com/ecstatic-morse", "followers_url": "https://api.github.com/users/ecstatic-morse/followers", "following_url": "https://api.github.com/users/ecstatic-morse/following{/other_user}", "gists_url": "https://api.github.com/users/ecstatic-morse/gists{/gist_id}", "starred_url": "https://api.github.com/users/ecstatic-morse/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ecstatic-morse/subscriptions", "organizations_url": "https://api.github.com/users/ecstatic-morse/orgs", "repos_url": "https://api.github.com/users/ecstatic-morse/repos", "events_url": "https://api.github.com/users/ecstatic-morse/events{/privacy}", "received_events_url": "https://api.github.com/users/ecstatic-morse/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ecstatic-morse", "id": 29463364, "node_id": "MDQ6VXNlcjI5NDYzMzY0", "avatar_url": "https://avatars.githubusercontent.com/u/29463364?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ecstatic-morse", "html_url": "https://github.com/ecstatic-morse", "followers_url": "https://api.github.com/users/ecstatic-morse/followers", "following_url": "https://api.github.com/users/ecstatic-morse/following{/other_user}", "gists_url": "https://api.github.com/users/ecstatic-morse/gists{/gist_id}", "starred_url": "https://api.github.com/users/ecstatic-morse/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ecstatic-morse/subscriptions", "organizations_url": "https://api.github.com/users/ecstatic-morse/orgs", "repos_url": "https://api.github.com/users/ecstatic-morse/repos", "events_url": "https://api.github.com/users/ecstatic-morse/events{/privacy}", "received_events_url": "https://api.github.com/users/ecstatic-morse/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1d216fef3ea9446a020cf86ae438ae9a0d40563f", "url": "https://api.github.com/repos/rust-lang/rust/commits/1d216fef3ea9446a020cf86ae438ae9a0d40563f", "html_url": "https://github.com/rust-lang/rust/commit/1d216fef3ea9446a020cf86ae438ae9a0d40563f"}], "stats": {"total": 36, "additions": 29, "deletions": 7}, "files": [{"sha": "7f5b19134804e3ac03acf62a1bb2c00d3751faf5", "filename": "compiler/rustc_feature/src/active.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/1ff143191c62bc7cfa17da99dac59a871f39a462/compiler%2Frustc_feature%2Fsrc%2Factive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1ff143191c62bc7cfa17da99dac59a871f39a462/compiler%2Frustc_feature%2Fsrc%2Factive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_feature%2Fsrc%2Factive.rs?ref=1ff143191c62bc7cfa17da99dac59a871f39a462", "patch": "@@ -587,6 +587,9 @@ declare_features! (\n     /// Allows basic arithmetic on floating point types in a `const fn`.\n     (active, const_fn_floating_point_arithmetic, \"1.48.0\", Some(57241), None),\n \n+    /// Allows using and casting function pointers in a `const fn`.\n+    (active, const_fn_fn_ptr_basics, \"1.48.0\", Some(57563), None),\n+\n     // -------------------------------------------------------------------------\n     // feature-group-end: actual feature gates\n     // -------------------------------------------------------------------------"}, {"sha": "3b8d8a5aa99dd12ce69630dff74619919de70543", "filename": "compiler/rustc_mir/src/transform/check_consts/ops.rs", "status": "modified", "additions": 21, "deletions": 7, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/1ff143191c62bc7cfa17da99dac59a871f39a462/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fcheck_consts%2Fops.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1ff143191c62bc7cfa17da99dac59a871f39a462/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fcheck_consts%2Fops.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fcheck_consts%2Fops.rs?ref=1ff143191c62bc7cfa17da99dac59a871f39a462", "patch": "@@ -213,11 +213,21 @@ impl NonConstOp for FnPtrCast {\n     const STOPS_CONST_CHECKING: bool = true;\n \n     fn status_in_item(&self, ccx: &ConstCx<'_, '_>) -> Status {\n-        mcf_status_in_item(ccx)\n+        if ccx.const_kind() != hir::ConstContext::ConstFn {\n+            Status::Allowed\n+        } else {\n+            Status::Unstable(sym::const_fn_fn_ptr_basics)\n+        }\n     }\n \n     fn emit_error(&self, ccx: &ConstCx<'_, '_>, span: Span) {\n-        mcf_emit_error(ccx, span, \"function pointer casts are not allowed in const fn\");\n+        feature_err(\n+            &ccx.tcx.sess.parse_sess,\n+            sym::const_fn_fn_ptr_basics,\n+            span,\n+            &format!(\"function pointer casts are not allowed in {}s\", ccx.const_kind()),\n+        )\n+        .emit()\n     }\n }\n \n@@ -596,17 +606,21 @@ pub mod ty {\n         const STOPS_CONST_CHECKING: bool = true;\n \n         fn status_in_item(&self, ccx: &ConstCx<'_, '_>) -> Status {\n-            // FIXME: This attribute a hack to allow the specialization of the `futures` API. See\n-            // #59739. We should have a proper feature gate for this.\n-            if ccx.tcx.has_attr(ccx.def_id.to_def_id(), sym::rustc_allow_const_fn_ptr) {\n+            if ccx.const_kind() != hir::ConstContext::ConstFn {\n                 Status::Allowed\n             } else {\n-                mcf_status_in_item(ccx)\n+                Status::Unstable(sym::const_fn_fn_ptr_basics)\n             }\n         }\n \n         fn emit_error(&self, ccx: &ConstCx<'_, '_>, span: Span) {\n-            mcf_emit_error(ccx, span, \"function pointers in const fn are unstable\");\n+            feature_err(\n+                &ccx.tcx.sess.parse_sess,\n+                sym::const_fn_fn_ptr_basics,\n+                span,\n+                &format!(\"function pointers cannot appear in {}s\", ccx.const_kind()),\n+            )\n+            .emit()\n         }\n     }\n "}, {"sha": "7332a7ea3317c2370395dfbffbe4119510fe225e", "filename": "compiler/rustc_span/src/symbol.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/1ff143191c62bc7cfa17da99dac59a871f39a462/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1ff143191c62bc7cfa17da99dac59a871f39a462/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs?ref=1ff143191c62bc7cfa17da99dac59a871f39a462", "patch": "@@ -353,6 +353,7 @@ symbols! {\n         const_extern_fn,\n         const_fn,\n         const_fn_floating_point_arithmetic,\n+        const_fn_fn_ptr_basics,\n         const_fn_transmute,\n         const_fn_union,\n         const_generics,"}, {"sha": "22bf2b15d6695651a91bd67ae29a4fd955bdef8a", "filename": "library/core/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/1ff143191c62bc7cfa17da99dac59a871f39a462/library%2Fcore%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1ff143191c62bc7cfa17da99dac59a871f39a462/library%2Fcore%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Flib.rs?ref=1ff143191c62bc7cfa17da99dac59a871f39a462", "patch": "@@ -83,6 +83,7 @@\n #![feature(const_fn_union)]\n #![feature(const_fn)]\n #![cfg_attr(not(bootstrap), feature(const_fn_floating_point_arithmetic))]\n+#![cfg_attr(not(bootstrap), feature(const_fn_fn_ptr_basics))]\n #![feature(const_generics)]\n #![feature(const_option)]\n #![feature(const_precise_live_drops)]"}, {"sha": "109dbfda105e3f5899dbded1fd72ea81a2f131dd", "filename": "library/core/src/task/wake.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/1ff143191c62bc7cfa17da99dac59a871f39a462/library%2Fcore%2Fsrc%2Ftask%2Fwake.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1ff143191c62bc7cfa17da99dac59a871f39a462/library%2Fcore%2Fsrc%2Ftask%2Fwake.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Ftask%2Fwake.rs?ref=1ff143191c62bc7cfa17da99dac59a871f39a462", "patch": "@@ -136,6 +136,7 @@ impl RawWakerVTable {\n     // (see https://github.com/rust-rfcs/const-eval/issues/19#issuecomment-472799062)\n     #[rustc_allow_const_fn_ptr]\n     #[rustc_const_stable(feature = \"futures_api\", since = \"1.36.0\")]\n+    #[cfg_attr(not(bootstrap), allow_internal_unstable(const_fn_fn_ptr_basics))]\n     pub const fn new(\n         clone: unsafe fn(*const ()) -> RawWaker,\n         wake: unsafe fn(*const ()),"}, {"sha": "93fa1f4e585739971d68cd75e89273e9cb148df5", "filename": "library/proc_macro/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/1ff143191c62bc7cfa17da99dac59a871f39a462/library%2Fproc_macro%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1ff143191c62bc7cfa17da99dac59a871f39a462/library%2Fproc_macro%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fproc_macro%2Fsrc%2Flib.rs?ref=1ff143191c62bc7cfa17da99dac59a871f39a462", "patch": "@@ -21,6 +21,7 @@\n #![feature(nll)]\n #![feature(staged_api)]\n #![feature(const_fn)]\n+#![cfg_attr(not(bootstrap), feature(const_fn_fn_ptr_basics))]\n #![feature(allow_internal_unstable)]\n #![feature(decl_macro)]\n #![feature(extern_types)]"}, {"sha": "e343eef91126edc0c2482771257e2e2049471276", "filename": "library/std/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/1ff143191c62bc7cfa17da99dac59a871f39a462/library%2Fstd%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1ff143191c62bc7cfa17da99dac59a871f39a462/library%2Fstd%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Flib.rs?ref=1ff143191c62bc7cfa17da99dac59a871f39a462", "patch": "@@ -239,6 +239,7 @@\n #![cfg_attr(not(bootstrap), feature(const_fn_floating_point_arithmetic))]\n #![feature(const_fn_transmute)]\n #![feature(const_fn)]\n+#![cfg_attr(not(bootstrap), feature(const_fn_fn_ptr_basics))]\n #![feature(const_ip)]\n #![feature(const_ipv6)]\n #![feature(const_raw_ptr_deref)]"}]}