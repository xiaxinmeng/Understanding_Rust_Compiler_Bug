{"sha": "8214bf04450db9e57975993290d3c35a66a40707", "node_id": "MDY6Q29tbWl0NzI0NzEyOjgyMTRiZjA0NDUwZGI5ZTU3OTc1OTkzMjkwZDNjMzVhNjZhNDA3MDc=", "commit": {"author": {"name": "Yoshitomo Nakanishi", "email": "yurayura.rounin.3@gmail.com", "date": "2021-04-16T07:07:20Z"}, "committer": {"name": "Yoshitomo Nakanishi", "email": "yurayura.rounin.3@gmail.com", "date": "2021-05-13T01:36:09Z"}, "message": "match_single_binding: Fix invalid suggestion when match scrutinee has side effects", "tree": {"sha": "c4051f920da85bf4a7312865700e657259023042", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c4051f920da85bf4a7312865700e657259023042"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8214bf04450db9e57975993290d3c35a66a40707", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8214bf04450db9e57975993290d3c35a66a40707", "html_url": "https://github.com/rust-lang/rust/commit/8214bf04450db9e57975993290d3c35a66a40707", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8214bf04450db9e57975993290d3c35a66a40707/comments", "author": {"login": "Y-Nak", "id": 6376004, "node_id": "MDQ6VXNlcjYzNzYwMDQ=", "avatar_url": "https://avatars.githubusercontent.com/u/6376004?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Y-Nak", "html_url": "https://github.com/Y-Nak", "followers_url": "https://api.github.com/users/Y-Nak/followers", "following_url": "https://api.github.com/users/Y-Nak/following{/other_user}", "gists_url": "https://api.github.com/users/Y-Nak/gists{/gist_id}", "starred_url": "https://api.github.com/users/Y-Nak/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Y-Nak/subscriptions", "organizations_url": "https://api.github.com/users/Y-Nak/orgs", "repos_url": "https://api.github.com/users/Y-Nak/repos", "events_url": "https://api.github.com/users/Y-Nak/events{/privacy}", "received_events_url": "https://api.github.com/users/Y-Nak/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Y-Nak", "id": 6376004, "node_id": "MDQ6VXNlcjYzNzYwMDQ=", "avatar_url": "https://avatars.githubusercontent.com/u/6376004?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Y-Nak", "html_url": "https://github.com/Y-Nak", "followers_url": "https://api.github.com/users/Y-Nak/followers", "following_url": "https://api.github.com/users/Y-Nak/following{/other_user}", "gists_url": "https://api.github.com/users/Y-Nak/gists{/gist_id}", "starred_url": "https://api.github.com/users/Y-Nak/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Y-Nak/subscriptions", "organizations_url": "https://api.github.com/users/Y-Nak/orgs", "repos_url": "https://api.github.com/users/Y-Nak/repos", "events_url": "https://api.github.com/users/Y-Nak/events{/privacy}", "received_events_url": "https://api.github.com/users/Y-Nak/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "08e36d7527c6f65b8f537c4644c762efe09880c5", "url": "https://api.github.com/repos/rust-lang/rust/commits/08e36d7527c6f65b8f537c4644c762efe09880c5", "html_url": "https://github.com/rust-lang/rust/commit/08e36d7527c6f65b8f537c4644c762efe09880c5"}], "stats": {"total": 135, "additions": 100, "deletions": 35}, "files": [{"sha": "345b360e633e5f3a79c75a91219ca4bedf91fd6c", "filename": "clippy_lints/src/matches.rs", "status": "modified", "additions": 28, "deletions": 9, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/8214bf04450db9e57975993290d3c35a66a40707/clippy_lints%2Fsrc%2Fmatches.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8214bf04450db9e57975993290d3c35a66a40707/clippy_lints%2Fsrc%2Fmatches.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmatches.rs?ref=8214bf04450db9e57975993290d3c35a66a40707", "patch": "@@ -1479,15 +1479,34 @@ fn check_match_single_binding<'a>(cx: &LateContext<'a>, ex: &Expr<'a>, arms: &[A\n             );\n         },\n         PatKind::Wild => {\n-            span_lint_and_sugg(\n-                cx,\n-                MATCH_SINGLE_BINDING,\n-                expr.span,\n-                \"this match could be replaced by its body itself\",\n-                \"consider using the match body instead\",\n-                snippet_body,\n-                Applicability::MachineApplicable,\n-            );\n+            if ex.can_have_side_effects() {\n+                let indent = \" \".repeat(indent_of(cx, expr.span).unwrap_or(0));\n+                let sugg = format!(\n+                    \"{};\\n{}{}\",\n+                    snippet_with_applicability(cx, ex.span, \"..\", &mut applicability),\n+                    indent,\n+                    snippet_body\n+                );\n+                span_lint_and_sugg(\n+                    cx,\n+                    MATCH_SINGLE_BINDING,\n+                    expr.span,\n+                    \"this match could be replaced by its scrutinee and body\",\n+                    \"consider using the scrutinee and body instead\",\n+                    sugg,\n+                    applicability,\n+                )\n+            } else {\n+                span_lint_and_sugg(\n+                    cx,\n+                    MATCH_SINGLE_BINDING,\n+                    expr.span,\n+                    \"this match could be replaced by its body itself\",\n+                    \"consider using the match body instead\",\n+                    snippet_body,\n+                    Applicability::MachineApplicable,\n+                );\n+            }\n         },\n         _ => (),\n     }"}, {"sha": "30bf64022533c7bbc452e04f3176756e74718a5e", "filename": "tests/ui/match_single_binding.fixed", "status": "modified", "additions": 1, "deletions": 4, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/8214bf04450db9e57975993290d3c35a66a40707/tests%2Fui%2Fmatch_single_binding.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/8214bf04450db9e57975993290d3c35a66a40707/tests%2Fui%2Fmatch_single_binding.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmatch_single_binding.fixed?ref=8214bf04450db9e57975993290d3c35a66a40707", "patch": "@@ -94,10 +94,7 @@ fn main() {\n         0 => println!(\"Disabled branch\"),\n         _ => println!(\"Enabled branch\"),\n     }\n-    // Lint\n-    let x = 1;\n-    let y = 1;\n-    println!(\"Single branch\");\n+\n     // Ok\n     let x = 1;\n     let y = 1;"}, {"sha": "d8bb80d8b96c49fbe58722f9312e88f10f3e286b", "filename": "tests/ui/match_single_binding.rs", "status": "modified", "additions": 1, "deletions": 9, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/8214bf04450db9e57975993290d3c35a66a40707/tests%2Fui%2Fmatch_single_binding.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8214bf04450db9e57975993290d3c35a66a40707/tests%2Fui%2Fmatch_single_binding.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmatch_single_binding.rs?ref=8214bf04450db9e57975993290d3c35a66a40707", "patch": "@@ -106,15 +106,7 @@ fn main() {\n         0 => println!(\"Disabled branch\"),\n         _ => println!(\"Enabled branch\"),\n     }\n-    // Lint\n-    let x = 1;\n-    let y = 1;\n-    match match y {\n-        0 => 1,\n-        _ => 2,\n-    } {\n-        _ => println!(\"Single branch\"),\n-    }\n+\n     // Ok\n     let x = 1;\n     let y = 1;"}, {"sha": "795c8c3e24d7e44816419aabc3c3f2256feb2b4f", "filename": "tests/ui/match_single_binding.stderr", "status": "modified", "additions": 1, "deletions": 12, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/8214bf04450db9e57975993290d3c35a66a40707/tests%2Fui%2Fmatch_single_binding.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/8214bf04450db9e57975993290d3c35a66a40707/tests%2Fui%2Fmatch_single_binding.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmatch_single_binding.stderr?ref=8214bf04450db9e57975993290d3c35a66a40707", "patch": "@@ -167,16 +167,5 @@ LL |             unwrapped\n LL |         })\n    |\n \n-error: this match could be replaced by its body itself\n-  --> $DIR/match_single_binding.rs:112:5\n-   |\n-LL | /     match match y {\n-LL | |         0 => 1,\n-LL | |         _ => 2,\n-LL | |     } {\n-LL | |         _ => println!(\"Single branch\"),\n-LL | |     }\n-   | |_____^ help: consider using the match body instead: `println!(\"Single branch\");`\n-\n-error: aborting due to 12 previous errors\n+error: aborting due to 11 previous errors\n "}, {"sha": "a91fcc2125d4178087319b60b8c69dd285c15450", "filename": "tests/ui/match_single_binding2.fixed", "status": "modified", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/8214bf04450db9e57975993290d3c35a66a40707/tests%2Fui%2Fmatch_single_binding2.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/8214bf04450db9e57975993290d3c35a66a40707/tests%2Fui%2Fmatch_single_binding2.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmatch_single_binding2.fixed?ref=8214bf04450db9e57975993290d3c35a66a40707", "patch": "@@ -34,4 +34,20 @@ fn main() {\n         },\n         None => println!(\"nothing\"),\n     }\n+\n+    fn side_effects() {}\n+\n+    // Lint (scrutinee has side effects)\n+    // issue #7094\n+    side_effects();\n+    println!(\"Side effects\");\n+\n+    // Lint (scrutinee has side effects)\n+    // issue #7094\n+    let x = 1;\n+    match x {\n+        0 => 1,\n+        _ => 2,\n+    };\n+    println!(\"Single branch\");\n }"}, {"sha": "476386ebabe20a5a731daac2f8bd03ec1ff0cc12", "filename": "tests/ui/match_single_binding2.rs", "status": "modified", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/8214bf04450db9e57975993290d3c35a66a40707/tests%2Fui%2Fmatch_single_binding2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8214bf04450db9e57975993290d3c35a66a40707/tests%2Fui%2Fmatch_single_binding2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmatch_single_binding2.rs?ref=8214bf04450db9e57975993290d3c35a66a40707", "patch": "@@ -34,4 +34,22 @@ fn main() {\n         },\n         None => println!(\"nothing\"),\n     }\n+\n+    fn side_effects() {}\n+\n+    // Lint (scrutinee has side effects)\n+    // issue #7094\n+    match side_effects() {\n+        _ => println!(\"Side effects\"),\n+    }\n+\n+    // Lint (scrutinee has side effects)\n+    // issue #7094\n+    let x = 1;\n+    match match x {\n+        0 => 1,\n+        _ => 2,\n+    } {\n+        _ => println!(\"Single branch\"),\n+    }\n }"}, {"sha": "4372f55af8767978d764ba5bc1b99c64384fbca0", "filename": "tests/ui/match_single_binding2.stderr", "status": "modified", "additions": 35, "deletions": 1, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/8214bf04450db9e57975993290d3c35a66a40707/tests%2Fui%2Fmatch_single_binding2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/8214bf04450db9e57975993290d3c35a66a40707/tests%2Fui%2Fmatch_single_binding2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmatch_single_binding2.stderr?ref=8214bf04450db9e57975993290d3c35a66a40707", "patch": "@@ -30,5 +30,39 @@ LL |             let (a, b) = get_tup();\n LL |             println!(\"a {:?} and b {:?}\", a, b);\n    |\n \n-error: aborting due to 2 previous errors\n+error: this match could be replaced by its scrutinee and body\n+  --> $DIR/match_single_binding2.rs:42:5\n+   |\n+LL | /     match side_effects() {\n+LL | |         _ => println!(\"Side effects\"),\n+LL | |     }\n+   | |_____^\n+   |\n+help: consider using the scrutinee and body instead\n+   |\n+LL |     side_effects();\n+LL |     println!(\"Side effects\");\n+   |\n+\n+error: this match could be replaced by its scrutinee and body\n+  --> $DIR/match_single_binding2.rs:49:5\n+   |\n+LL | /     match match x {\n+LL | |         0 => 1,\n+LL | |         _ => 2,\n+LL | |     } {\n+LL | |         _ => println!(\"Single branch\"),\n+LL | |     }\n+   | |_____^\n+   |\n+help: consider using the scrutinee and body instead\n+   |\n+LL |     match x {\n+LL |         0 => 1,\n+LL |         _ => 2,\n+LL |     };\n+LL |     println!(\"Single branch\");\n+   |\n+\n+error: aborting due to 4 previous errors\n "}]}