{"sha": "ad5c29a445692c0c074ee1f019fe1ff2056da23f", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFkNWMyOWE0NDU2OTJjMGMwNzRlZTFmMDE5ZmUxZmYyMDU2ZGEyM2Y=", "commit": {"author": {"name": "Josh Mcguigan", "email": "joshmcg88@gmail.com", "date": "2018-10-09T02:04:29Z"}, "committer": {"name": "Josh Mcguigan", "email": "joshmcg88@gmail.com", "date": "2018-10-09T02:04:29Z"}, "message": "Fixes #2925 cmp_owned false positive", "tree": {"sha": "72aa4e9bd39ffeb69feb79c9f83420d96def7e29", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/72aa4e9bd39ffeb69feb79c9f83420d96def7e29"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ad5c29a445692c0c074ee1f019fe1ff2056da23f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ad5c29a445692c0c074ee1f019fe1ff2056da23f", "html_url": "https://github.com/rust-lang/rust/commit/ad5c29a445692c0c074ee1f019fe1ff2056da23f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ad5c29a445692c0c074ee1f019fe1ff2056da23f/comments", "author": {"login": "JoshMcguigan", "id": 22216761, "node_id": "MDQ6VXNlcjIyMjE2NzYx", "avatar_url": "https://avatars.githubusercontent.com/u/22216761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JoshMcguigan", "html_url": "https://github.com/JoshMcguigan", "followers_url": "https://api.github.com/users/JoshMcguigan/followers", "following_url": "https://api.github.com/users/JoshMcguigan/following{/other_user}", "gists_url": "https://api.github.com/users/JoshMcguigan/gists{/gist_id}", "starred_url": "https://api.github.com/users/JoshMcguigan/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JoshMcguigan/subscriptions", "organizations_url": "https://api.github.com/users/JoshMcguigan/orgs", "repos_url": "https://api.github.com/users/JoshMcguigan/repos", "events_url": "https://api.github.com/users/JoshMcguigan/events{/privacy}", "received_events_url": "https://api.github.com/users/JoshMcguigan/received_events", "type": "User", "site_admin": false}, "committer": {"login": "JoshMcguigan", "id": 22216761, "node_id": "MDQ6VXNlcjIyMjE2NzYx", "avatar_url": "https://avatars.githubusercontent.com/u/22216761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JoshMcguigan", "html_url": "https://github.com/JoshMcguigan", "followers_url": "https://api.github.com/users/JoshMcguigan/followers", "following_url": "https://api.github.com/users/JoshMcguigan/following{/other_user}", "gists_url": "https://api.github.com/users/JoshMcguigan/gists{/gist_id}", "starred_url": "https://api.github.com/users/JoshMcguigan/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JoshMcguigan/subscriptions", "organizations_url": "https://api.github.com/users/JoshMcguigan/orgs", "repos_url": "https://api.github.com/users/JoshMcguigan/repos", "events_url": "https://api.github.com/users/JoshMcguigan/events{/privacy}", "received_events_url": "https://api.github.com/users/JoshMcguigan/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "02705d4cf5334844545aff99418d10644447aabd", "url": "https://api.github.com/repos/rust-lang/rust/commits/02705d4cf5334844545aff99418d10644447aabd", "html_url": "https://github.com/rust-lang/rust/commit/02705d4cf5334844545aff99418d10644447aabd"}], "stats": {"total": 42, "additions": 27, "deletions": 15}, "files": [{"sha": "4e6d5b72efce74fd6fea9d2ace77e31366279d18", "filename": "clippy_lints/src/misc.rs", "status": "modified", "additions": 14, "deletions": 12, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/ad5c29a445692c0c074ee1f019fe1ff2056da23f/clippy_lints%2Fsrc%2Fmisc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad5c29a445692c0c074ee1f019fe1ff2056da23f/clippy_lints%2Fsrc%2Fmisc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmisc.rs?ref=ad5c29a445692c0c074ee1f019fe1ff2056da23f", "patch": "@@ -334,11 +334,11 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for Pass {\n                     |db| {\n                         let sugg = if binop.node == BinOpKind::Or { !sugg } else { sugg };\n                         db.span_suggestion_with_applicability(\n-                            s.span, \n+                            s.span,\n                             \"replace it with\",\n                             format!(\n                                 \"if {} {{ {}; }}\",\n-                                sugg, \n+                                sugg,\n                                 &snippet(cx, b.span, \"..\"),\n                             ),\n                             Applicability::MachineApplicable, // snippet\n@@ -520,16 +520,17 @@ fn check_to_owned(cx: &LateContext<'_, '_>, expr: &Expr, other: &Expr) {\n         None => return,\n     };\n \n-    // *arg impls PartialEq<other>\n-    if !arg_ty\n+    let deref_arg_impl_partial_eq_other = arg_ty\n         .builtin_deref(true)\n-        .map_or(false, |tam| implements_trait(cx, tam.ty, partial_eq_trait_id, &[other_ty.into()]))\n-        // arg impls PartialEq<*other>\n-        && !other_ty\n+        .map_or(false, |tam| implements_trait(cx, tam.ty, partial_eq_trait_id, &[other_ty.into()]));\n+    let arg_impl_partial_eq_deref_other = other_ty\n         .builtin_deref(true)\n-        .map_or(false, |tam| implements_trait(cx, arg_ty, partial_eq_trait_id, &[tam.ty.into()]))\n-        // arg impls PartialEq<other>\n-        && !implements_trait(cx, arg_ty, partial_eq_trait_id, &[other_ty.into()])\n+        .map_or(false, |tam| implements_trait(cx, arg_ty, partial_eq_trait_id, &[tam.ty.into()]));\n+    let arg_impl_partial_eq_other = implements_trait(cx, arg_ty, partial_eq_trait_id, &[other_ty.into()]);\n+\n+    if !deref_arg_impl_partial_eq_other\n+        && !arg_impl_partial_eq_deref_other\n+        && !arg_impl_partial_eq_other\n     {\n         return;\n     }\n@@ -559,10 +560,11 @@ fn check_to_owned(cx: &LateContext<'_, '_>, expr: &Expr, other: &Expr) {\n                     }\n                 }\n             }\n+            let try_hint = if deref_arg_impl_partial_eq_other { format!(\"*{}\", snip) } else { snip.to_string() };\n             db.span_suggestion_with_applicability(\n-                expr.span, \n+                expr.span,\n                 \"try\",\n-                snip.to_string(),\n+                try_hint,\n                 Applicability::MachineApplicable, // snippet\n             );\n         },"}, {"sha": "031809f5df5f391884eef7825ac9a80416211c58", "filename": "tests/ui/cmp_owned.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/ad5c29a445692c0c074ee1f019fe1ff2056da23f/tests%2Fui%2Fcmp_owned.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad5c29a445692c0c074ee1f019fe1ff2056da23f/tests%2Fui%2Fcmp_owned.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcmp_owned.rs?ref=ad5c29a445692c0c074ee1f019fe1ff2056da23f", "patch": "@@ -31,6 +31,10 @@ fn main() {\n     42.to_string() == \"42\";\n \n     Foo.to_owned() == Foo;\n+\n+    \"abc\".chars().filter(|c| c.to_owned() != 'X');\n+\n+    \"abc\".chars().filter(|c| *c != 'X');\n }\n \n struct Foo;"}, {"sha": "5434b68de9fc4751e6c7f1d9cc861ee997a0311b", "filename": "tests/ui/cmp_owned.stderr", "status": "modified", "additions": 9, "deletions": 3, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/ad5c29a445692c0c074ee1f019fe1ff2056da23f/tests%2Fui%2Fcmp_owned.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/ad5c29a445692c0c074ee1f019fe1ff2056da23f/tests%2Fui%2Fcmp_owned.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcmp_owned.stderr?ref=ad5c29a445692c0c074ee1f019fe1ff2056da23f", "patch": "@@ -31,10 +31,16 @@ error: this creates an owned instance just for comparison\n    |     ^^^^^^^^^^^^^^ help: try: `Foo`\n \n error: this creates an owned instance just for comparison\n-  --> $DIR/cmp_owned.rs:40:9\n+  --> $DIR/cmp_owned.rs:35:30\n    |\n-40 |         self.to_owned() == *other\n+35 |     \"abc\".chars().filter(|c| c.to_owned() != 'X');\n+   |                              ^^^^^^^^^^^^ help: try: `*c`\n+\n+error: this creates an owned instance just for comparison\n+  --> $DIR/cmp_owned.rs:44:9\n+   |\n+44 |         self.to_owned() == *other\n    |         ^^^^^^^^^^^^^^^ try calling implementing the comparison without allocating\n \n-error: aborting due to 6 previous errors\n+error: aborting due to 7 previous errors\n "}]}