{"sha": "8956b91a93e3c524870cf44b6fc6fafe1fc9898b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg5NTZiOTFhOTNlM2M1MjQ4NzBjZjQ0YjZmYzZmYWZlMWZjOTg5OGI=", "commit": {"author": {"name": "Nick Cameron", "email": "nrc@ncameron.org", "date": "2018-06-07T20:46:28Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2018-06-07T20:46:28Z"}, "message": "Merge pull request #2774 from csmoe/repair_label\n\nFix break_label formatting", "tree": {"sha": "0437b8f2713899ecc185499e04d3e49257eded02", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0437b8f2713899ecc185499e04d3e49257eded02"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8956b91a93e3c524870cf44b6fc6fafe1fc9898b", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJbGZmkCRBK7hj4Ov3rIwAAdHIIAAa57ai6WQw24hsXSxlTeisV\ncC3nKNGQMiN9vKBQHEfKsABdXaKmbgeYqMlTRXu2zPcu8BSgBuD6C+iVvpYb0uCm\n9AXDKti7lQap5HznCcOqk5zZ9nT8HRP2NXdhlKe1wLeicSuxU0yMXdAhvbSu6xLB\n41IoCIODyJY8oYgm+6AGBFClg22c1DstyFWfDafgl3J6OFxsVnZmLxLSD1JYaf0c\n6hNc98L8oJI0fdwZOKBS74DgQ4Izxz6ttvUDrJbrdErDtZVK0mM7Wjgy48W60cMO\nMnckRhfPOq1bFehmyyO6YI6Y0yO6BRGzRiF7kKbGiCBvZfo+fUfotadBOuHu/OM=\n=C5e3\n-----END PGP SIGNATURE-----\n", "payload": "tree 0437b8f2713899ecc185499e04d3e49257eded02\nparent 08da30d72c9abfff4d41f6f081e31fd2929b820d\nparent c791a54ff4ac27d8d2126a36993756f0a78ef43c\nauthor Nick Cameron <nrc@ncameron.org> 1528404388 +1200\ncommitter GitHub <noreply@github.com> 1528404388 +1200\n\nMerge pull request #2774 from csmoe/repair_label\n\nFix break_label formatting"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8956b91a93e3c524870cf44b6fc6fafe1fc9898b", "html_url": "https://github.com/rust-lang/rust/commit/8956b91a93e3c524870cf44b6fc6fafe1fc9898b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8956b91a93e3c524870cf44b6fc6fafe1fc9898b/comments", "author": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "08da30d72c9abfff4d41f6f081e31fd2929b820d", "url": "https://api.github.com/repos/rust-lang/rust/commits/08da30d72c9abfff4d41f6f081e31fd2929b820d", "html_url": "https://github.com/rust-lang/rust/commit/08da30d72c9abfff4d41f6f081e31fd2929b820d"}, {"sha": "c791a54ff4ac27d8d2126a36993756f0a78ef43c", "url": "https://api.github.com/repos/rust-lang/rust/commits/c791a54ff4ac27d8d2126a36993756f0a78ef43c", "html_url": "https://github.com/rust-lang/rust/commit/c791a54ff4ac27d8d2126a36993756f0a78ef43c"}], "stats": {"total": 50, "additions": 31, "deletions": 19}, "files": [{"sha": "3d0a52de0dcac5f53cfbc0d78484d8ef6913e0d6", "filename": "src/closures.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/8956b91a93e3c524870cf44b6fc6fafe1fc9898b/src%2Fclosures.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8956b91a93e3c524870cf44b6fc6fafe1fc9898b/src%2Fclosures.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fclosures.rs?ref=8956b91a93e3c524870cf44b6fc6fafe1fc9898b", "patch": "@@ -140,7 +140,7 @@ fn rewrite_closure_with_block(\n         span: body.span,\n         recovered: false,\n     };\n-    let block = ::expr::rewrite_block_with_visitor(context, \"\", &block, None, shape, false)?;\n+    let block = ::expr::rewrite_block_with_visitor(context, \"\", &block, None, None, shape, false)?;\n     Some(format!(\"{} {}\", prefix, block))\n }\n "}, {"sha": "112383e7e4c20ee93c1d6188e689238bc1bb70a3", "filename": "src/expr.rs", "status": "modified", "additions": 28, "deletions": 16, "changes": 44, "blob_url": "https://github.com/rust-lang/rust/blob/8956b91a93e3c524870cf44b6fc6fafe1fc9898b/src%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8956b91a93e3c524870cf44b6fc6fafe1fc9898b/src%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fexpr.rs?ref=8956b91a93e3c524870cf44b6fc6fafe1fc9898b", "patch": "@@ -124,7 +124,7 @@ pub fn format_expr(\n                     if is_unsafe_block(block) {\n                         rewrite_block(block, Some(&expr.attrs), opt_label, context, shape)\n                     } else if let rw @ Some(_) =\n-                        rewrite_empty_block(context, block, Some(&expr.attrs), \"\", shape)\n+                        rewrite_empty_block(context, block, Some(&expr.attrs), opt_label, \"\", shape)\n                     {\n                         // Rewrite block without trying to put it in a single line.\n                         rw\n@@ -136,6 +136,7 @@ pub fn format_expr(\n                             &prefix,\n                             block,\n                             Some(&expr.attrs),\n+                            opt_label,\n                             shape,\n                             true,\n                         )\n@@ -316,9 +317,14 @@ pub fn format_expr(\n         // satisfy our width restrictions.\n         ast::ExprKind::InlineAsm(..) => Some(context.snippet(expr.span).to_owned()),\n         ast::ExprKind::Catch(ref block) => {\n-            if let rw @ Some(_) =\n-                rewrite_single_line_block(context, \"do catch \", block, Some(&expr.attrs), shape)\n-            {\n+            if let rw @ Some(_) = rewrite_single_line_block(\n+                context,\n+                \"do catch \",\n+                block,\n+                Some(&expr.attrs),\n+                None,\n+                shape,\n+            ) {\n                 rw\n             } else {\n                 // 9 = `do catch `\n@@ -543,16 +549,18 @@ fn rewrite_empty_block(\n     context: &RewriteContext,\n     block: &ast::Block,\n     attrs: Option<&[ast::Attribute]>,\n+    label: Option<ast::Label>,\n     prefix: &str,\n     shape: Shape,\n ) -> Option<String> {\n+    let label_str = rewrite_label(label);\n     if attrs.map_or(false, |a| !inner_attributes(a).is_empty()) {\n         return None;\n     }\n \n     if block.stmts.is_empty() && !block_contains_comment(block, context.codemap) && shape.width >= 2\n     {\n-        return Some(format!(\"{}{{}}\", prefix));\n+        return Some(format!(\"{}{}{{}}\", prefix, label_str));\n     }\n \n     // If a block contains only a single-line comment, then leave it on one line.\n@@ -565,7 +573,7 @@ fn rewrite_empty_block(\n             && !comment_str.starts_with(\"//\")\n             && comment_str.len() + 4 <= shape.width\n         {\n-            return Some(format!(\"{}{{ {} }}\", prefix, comment_str));\n+            return Some(format!(\"{}{}{{ {} }}\", prefix, label_str, comment_str));\n         }\n     }\n \n@@ -605,12 +613,14 @@ fn rewrite_single_line_block(\n     prefix: &str,\n     block: &ast::Block,\n     attrs: Option<&[ast::Attribute]>,\n+    label: Option<ast::Label>,\n     shape: Shape,\n ) -> Option<String> {\n     if is_simple_block(block, attrs, context.codemap) {\n         let expr_shape = shape.offset_left(last_line_width(prefix))?;\n         let expr_str = block.stmts[0].rewrite(context, expr_shape)?;\n-        let result = format!(\"{}{{ {} }}\", prefix, expr_str);\n+        let label_str = rewrite_label(label);\n+        let result = format!(\"{}{}{{ {} }}\", prefix, label_str, expr_str);\n         if result.len() <= shape.width && !result.contains('\\n') {\n             return Some(result);\n         }\n@@ -623,10 +633,11 @@ pub fn rewrite_block_with_visitor(\n     prefix: &str,\n     block: &ast::Block,\n     attrs: Option<&[ast::Attribute]>,\n+    label: Option<ast::Label>,\n     shape: Shape,\n     has_braces: bool,\n ) -> Option<String> {\n-    if let rw @ Some(_) = rewrite_empty_block(context, block, attrs, prefix, shape) {\n+    if let rw @ Some(_) = rewrite_empty_block(context, block, attrs, label, prefix, shape) {\n         return rw;\n     }\n \n@@ -643,8 +654,9 @@ pub fn rewrite_block_with_visitor(\n     }\n \n     let inner_attrs = attrs.map(inner_attributes);\n+    let label_str = rewrite_label(label);\n     visitor.visit_block(block, inner_attrs.as_ref().map(|a| &**a), has_braces);\n-    Some(format!(\"{}{}\", prefix, visitor.buffer))\n+    Some(format!(\"{}{}{}\", prefix, label_str, visitor.buffer))\n }\n \n impl Rewrite for ast::Block {\n@@ -660,20 +672,20 @@ fn rewrite_block(\n     context: &RewriteContext,\n     shape: Shape,\n ) -> Option<String> {\n-    let unsafe_string = block_prefix(context, block, shape)?;\n-    let label_string = rewrite_label(label);\n-    let prefix = format!(\"{}{}\", unsafe_string, label_string);\n+    let prefix = block_prefix(context, block, shape)?;\n \n     // shape.width is used only for the single line case: either the empty block `{}`,\n     // or an unsafe expression `unsafe { e }`.\n-    if let rw @ Some(_) = rewrite_empty_block(context, block, attrs, &prefix, shape) {\n+    if let rw @ Some(_) = rewrite_empty_block(context, block, attrs, label, &prefix, shape) {\n         return rw;\n     }\n \n-    let result = rewrite_block_with_visitor(context, &prefix, block, attrs, shape, true);\n+    let result = rewrite_block_with_visitor(context, &prefix, block, attrs, label, shape, true);\n     if let Some(ref result_str) = result {\n         if result_str.lines().count() <= 3 {\n-            if let rw @ Some(_) = rewrite_single_line_block(context, &prefix, block, attrs, shape) {\n+            if let rw @ Some(_) =\n+                rewrite_single_line_block(context, &prefix, block, attrs, label, shape)\n+            {\n                 return rw;\n             }\n         }\n@@ -1125,7 +1137,7 @@ impl<'a> Rewrite for ControlFlow<'a> {\n         let block_str = {\n             let old_val = context.is_if_else_block.replace(self.else_block.is_some());\n             let result =\n-                rewrite_block_with_visitor(context, \"\", self.block, None, block_shape, true);\n+                rewrite_block_with_visitor(context, \"\", self.block, None, None, block_shape, true);\n             context.is_if_else_block.replace(old_val);\n             result?\n         };"}, {"sha": "728d78137c99ecba6cd3773883d717879dc8e848", "filename": "tests/target/label_break.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/8956b91a93e3c524870cf44b6fc6fafe1fc9898b/tests%2Ftarget%2Flabel_break.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8956b91a93e3c524870cf44b6fc6fafe1fc9898b/tests%2Ftarget%2Flabel_break.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Flabel_break.rs?ref=8956b91a93e3c524870cf44b6fc6fafe1fc9898b", "patch": "@@ -1,8 +1,8 @@\n // format with label break value.\n fn main() {\n-    {}\n+    'empty_block: {}\n \n-    {\n+    'block: {\n         do_thing();\n         if condition_not_met() {\n             break 'block;"}]}