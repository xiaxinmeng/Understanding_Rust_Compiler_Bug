{"sha": "ad9ceeebdcce3d844c065777d1c2d3d74aff0047", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFkOWNlZWViZGNjZTNkODQ0YzA2NTc3N2QxYzJkM2Q3NGFmZjAwNDc=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-02-07T09:55:32Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-02-07T09:55:32Z"}, "message": "Auto merge of #6685 - magurotuna:filter_map_identity, r=phansch\n\nAdd new lint `filter_map_identity`\n\n<!--\nThank you for making Clippy better!\n\nWe're collecting our changelog from pull request descriptions.\nIf your PR only includes internal changes, you can just write\n`changelog: none`. Otherwise, please write a short comment\nexplaining your change.\n\nIf your PR fixes an issue, you can add \"fixes #issue_number\" into this\nPR description. This way the issue will be automatically closed when\nyour PR is merged.\n\nIf you added a new lint, here's a checklist for things that will be\nchecked during review or continuous integration.\n\n- \\[x] Followed [lint naming conventions][lint_naming]\n- \\[x] Added passing UI tests (including committed `.stderr` file)\n- \\[x] `cargo test` passes locally\n- \\[x] Executed `cargo dev update_lints`\n- \\[x] Added lint documentation\n- \\[x] Run `cargo dev fmt`\n\n[lint_naming]: https://rust-lang.github.io/rfcs/0344-conventions-galore.html#lints\n\nNote that you can skip the above if you are just opening a WIP PR in\norder to get feedback.\n\nDelete this line and everything above before opening your PR.\n-->\n\nThis commit adds a new lint named filter_map_identity.\nThis lint is the same as `flat_map_identity` except that it checks for the usage of `filter_map`.\n\n---\n\nCloses #6643\n\nchangelog: Added a new lint: `filter_map_identity`", "tree": {"sha": "446f41937402df5ee65457cea05b7ec865f426e1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/446f41937402df5ee65457cea05b7ec865f426e1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ad9ceeebdcce3d844c065777d1c2d3d74aff0047", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ad9ceeebdcce3d844c065777d1c2d3d74aff0047", "html_url": "https://github.com/rust-lang/rust/commit/ad9ceeebdcce3d844c065777d1c2d3d74aff0047", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ad9ceeebdcce3d844c065777d1c2d3d74aff0047/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "001185d863a2b49852f0fe2a955d250af0947bce", "url": "https://api.github.com/repos/rust-lang/rust/commits/001185d863a2b49852f0fe2a955d250af0947bce", "html_url": "https://github.com/rust-lang/rust/commit/001185d863a2b49852f0fe2a955d250af0947bce"}, {"sha": "fbe436b1d4369603a6f89cbb8fb382ef5fe210f7", "url": "https://api.github.com/repos/rust-lang/rust/commits/fbe436b1d4369603a6f89cbb8fb382ef5fe210f7", "html_url": "https://github.com/rust-lang/rust/commit/fbe436b1d4369603a6f89cbb8fb382ef5fe210f7"}], "stats": {"total": 146, "additions": 144, "deletions": 2}, "files": [{"sha": "b74841c779405d723cb344ca0431b16f353bdc5d", "filename": "CHANGELOG.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/ad9ceeebdcce3d844c065777d1c2d3d74aff0047/CHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/ad9ceeebdcce3d844c065777d1c2d3d74aff0047/CHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/CHANGELOG.md?ref=ad9ceeebdcce3d844c065777d1c2d3d74aff0047", "patch": "@@ -1955,6 +1955,7 @@ Released 2018-09-13\n [`field_reassign_with_default`]: https://rust-lang.github.io/rust-clippy/master/index.html#field_reassign_with_default\n [`filetype_is_file`]: https://rust-lang.github.io/rust-clippy/master/index.html#filetype_is_file\n [`filter_map`]: https://rust-lang.github.io/rust-clippy/master/index.html#filter_map\n+[`filter_map_identity`]: https://rust-lang.github.io/rust-clippy/master/index.html#filter_map_identity\n [`filter_map_next`]: https://rust-lang.github.io/rust-clippy/master/index.html#filter_map_next\n [`filter_next`]: https://rust-lang.github.io/rust-clippy/master/index.html#filter_next\n [`find_map`]: https://rust-lang.github.io/rust-clippy/master/index.html#find_map"}, {"sha": "fe4aa584b1878604af99e8d2d1e6ebae22b538bc", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/ad9ceeebdcce3d844c065777d1c2d3d74aff0047/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad9ceeebdcce3d844c065777d1c2d3d74aff0047/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=ad9ceeebdcce3d844c065777d1c2d3d74aff0047", "patch": "@@ -743,6 +743,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n         &methods::EXPECT_USED,\n         &methods::FILETYPE_IS_FILE,\n         &methods::FILTER_MAP,\n+        &methods::FILTER_MAP_IDENTITY,\n         &methods::FILTER_MAP_NEXT,\n         &methods::FILTER_NEXT,\n         &methods::FLAT_MAP_IDENTITY,\n@@ -1535,6 +1536,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n         LintId::of(&methods::CLONE_DOUBLE_REF),\n         LintId::of(&methods::CLONE_ON_COPY),\n         LintId::of(&methods::EXPECT_FUN_CALL),\n+        LintId::of(&methods::FILTER_MAP_IDENTITY),\n         LintId::of(&methods::FILTER_NEXT),\n         LintId::of(&methods::FLAT_MAP_IDENTITY),\n         LintId::of(&methods::FROM_ITER_INSTEAD_OF_COLLECT),\n@@ -1842,6 +1844,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n         LintId::of(&matches::WILDCARD_IN_OR_PATTERNS),\n         LintId::of(&methods::BIND_INSTEAD_OF_MAP),\n         LintId::of(&methods::CLONE_ON_COPY),\n+        LintId::of(&methods::FILTER_MAP_IDENTITY),\n         LintId::of(&methods::FILTER_NEXT),\n         LintId::of(&methods::FLAT_MAP_IDENTITY),\n         LintId::of(&methods::INSPECT_FOR_EACH),"}, {"sha": "b5a9632ee1986707469756fd81a4399c81fe6081", "filename": "clippy_lints/src/loops.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ad9ceeebdcce3d844c065777d1c2d3d74aff0047/clippy_lints%2Fsrc%2Floops.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad9ceeebdcce3d844c065777d1c2d3d74aff0047/clippy_lints%2Fsrc%2Floops.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Floops.rs?ref=ad9ceeebdcce3d844c065777d1c2d3d74aff0047", "patch": "@@ -738,7 +738,7 @@ fn combine_branches(b1: NeverLoopResult, b2: NeverLoopResult) -> NeverLoopResult\n fn never_loop_block(block: &Block<'_>, main_loop_id: HirId) -> NeverLoopResult {\n     let stmts = block.stmts.iter().map(stmt_to_expr);\n     let expr = once(block.expr.as_deref());\n-    let mut iter = stmts.chain(expr).filter_map(|e| e);\n+    let mut iter = stmts.chain(expr).flatten();\n     never_loop_expr_seq(&mut iter, main_loop_id)\n }\n "}, {"sha": "d04e4be87ac299f19ac6925dc7347901e8125f2e", "filename": "clippy_lints/src/methods/filter_map_identity.rs", "status": "added", "additions": 56, "deletions": 0, "changes": 56, "blob_url": "https://github.com/rust-lang/rust/blob/ad9ceeebdcce3d844c065777d1c2d3d74aff0047/clippy_lints%2Fsrc%2Fmethods%2Ffilter_map_identity.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad9ceeebdcce3d844c065777d1c2d3d74aff0047/clippy_lints%2Fsrc%2Fmethods%2Ffilter_map_identity.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmethods%2Ffilter_map_identity.rs?ref=ad9ceeebdcce3d844c065777d1c2d3d74aff0047", "patch": "@@ -0,0 +1,56 @@\n+use crate::utils::{match_qpath, match_trait_method, paths, span_lint_and_sugg};\n+use if_chain::if_chain;\n+use rustc_errors::Applicability;\n+use rustc_hir as hir;\n+use rustc_lint::LateContext;\n+use rustc_span::source_map::Span;\n+\n+use super::FILTER_MAP_IDENTITY;\n+\n+pub(super) fn check(\n+    cx: &LateContext<'_>,\n+    expr: &hir::Expr<'_>,\n+    filter_map_args: &[hir::Expr<'_>],\n+    filter_map_span: Span,\n+) {\n+    if match_trait_method(cx, expr, &paths::ITERATOR) {\n+        let arg_node = &filter_map_args[1].kind;\n+\n+        let apply_lint = |message: &str| {\n+            span_lint_and_sugg(\n+                cx,\n+                FILTER_MAP_IDENTITY,\n+                filter_map_span.with_hi(expr.span.hi()),\n+                message,\n+                \"try\",\n+                \"flatten()\".to_string(),\n+                Applicability::MachineApplicable,\n+            );\n+        };\n+\n+        if_chain! {\n+            if let hir::ExprKind::Closure(_, _, body_id, _, _) = arg_node;\n+            let body = cx.tcx.hir().body(*body_id);\n+\n+            if let hir::PatKind::Binding(_, _, binding_ident, _) = body.params[0].pat.kind;\n+            if let hir::ExprKind::Path(hir::QPath::Resolved(_, ref path)) = body.value.kind;\n+\n+            if path.segments.len() == 1;\n+            if path.segments[0].ident.name == binding_ident.name;\n+\n+            then {\n+                apply_lint(\"called `filter_map(|x| x)` on an `Iterator`\");\n+            }\n+        }\n+\n+        if_chain! {\n+            if let hir::ExprKind::Path(ref qpath) = arg_node;\n+\n+            if match_qpath(qpath, &paths::STD_CONVERT_IDENTITY);\n+\n+            then {\n+                apply_lint(\"called `filter_map(std::convert::identity)` on an `Iterator`\");\n+            }\n+        }\n+    }\n+}"}, {"sha": "3e34fc1aed169d7a00bd3151b8ef8745177c1063", "filename": "clippy_lints/src/methods/mod.rs", "status": "modified", "additions": 29, "deletions": 1, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/ad9ceeebdcce3d844c065777d1c2d3d74aff0047/clippy_lints%2Fsrc%2Fmethods%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad9ceeebdcce3d844c065777d1c2d3d74aff0047/clippy_lints%2Fsrc%2Fmethods%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmethods%2Fmod.rs?ref=ad9ceeebdcce3d844c065777d1c2d3d74aff0047", "patch": "@@ -1,4 +1,5 @@\n mod bind_instead_of_map;\n+mod filter_map_identity;\n mod inefficient_to_string;\n mod inspect_for_each;\n mod manual_saturating_arithmetic;\n@@ -1466,6 +1467,29 @@ declare_clippy_lint! {\n     \"using `.inspect().for_each()`, which can be replaced with `.for_each()`\"\n }\n \n+declare_clippy_lint! {\n+    /// **What it does:** Checks for usage of `filter_map(|x| x)`.\n+    ///\n+    /// **Why is this bad?** Readability, this can be written more concisely by using `flatten`.\n+    ///\n+    /// **Known problems:** None.\n+    ///\n+    /// **Example:**\n+    ///\n+    /// ```rust\n+    /// # let iter = vec![Some(1)].into_iter();\n+    /// iter.filter_map(|x| x);\n+    /// ```\n+    /// Use instead:\n+    /// ```rust\n+    /// # let iter = vec![Some(1)].into_iter();\n+    /// iter.flatten();\n+    /// ```\n+    pub FILTER_MAP_IDENTITY,\n+    complexity,\n+    \"call to `filter_map` where `flatten` is sufficient\"\n+}\n+\n pub struct Methods {\n     msrv: Option<RustcVersion>,\n }\n@@ -1503,6 +1527,7 @@ impl_lint_pass!(Methods => [\n     FILTER_NEXT,\n     SKIP_WHILE_NEXT,\n     FILTER_MAP,\n+    FILTER_MAP_IDENTITY,\n     MANUAL_FILTER_MAP,\n     MANUAL_FIND_MAP,\n     FILTER_MAP_NEXT,\n@@ -1596,7 +1621,10 @@ impl<'tcx> LateLintPass<'tcx> for Methods {\n             [\"as_ref\"] => lint_asref(cx, expr, \"as_ref\", arg_lists[0]),\n             [\"as_mut\"] => lint_asref(cx, expr, \"as_mut\", arg_lists[0]),\n             [\"fold\", ..] => lint_unnecessary_fold(cx, expr, arg_lists[0], method_spans[0]),\n-            [\"filter_map\", ..] => unnecessary_filter_map::lint(cx, expr, arg_lists[0]),\n+            [\"filter_map\", ..] => {\n+                unnecessary_filter_map::lint(cx, expr, arg_lists[0]);\n+                filter_map_identity::check(cx, expr, arg_lists[0], method_spans[0]);\n+            },\n             [\"count\", \"map\"] => lint_suspicious_map(cx, expr),\n             [\"assume_init\"] => lint_maybe_uninit(cx, &arg_lists[0][0], expr),\n             [\"unwrap_or\", arith @ (\"checked_add\" | \"checked_sub\" | \"checked_mul\")] => {"}, {"sha": "23ce28d8e9be4c2238afe40f3a664419763305d0", "filename": "tests/ui/filter_map_identity.fixed", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/ad9ceeebdcce3d844c065777d1c2d3d74aff0047/tests%2Fui%2Ffilter_map_identity.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/ad9ceeebdcce3d844c065777d1c2d3d74aff0047/tests%2Fui%2Ffilter_map_identity.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ffilter_map_identity.fixed?ref=ad9ceeebdcce3d844c065777d1c2d3d74aff0047", "patch": "@@ -0,0 +1,16 @@\n+// run-rustfix\n+\n+#![allow(unused_imports)]\n+#![warn(clippy::filter_map_identity)]\n+\n+fn main() {\n+    let iterator = vec![Some(1), None, Some(2)].into_iter();\n+    let _ = iterator.flatten();\n+\n+    let iterator = vec![Some(1), None, Some(2)].into_iter();\n+    let _ = iterator.flatten();\n+\n+    use std::convert::identity;\n+    let iterator = vec![Some(1), None, Some(2)].into_iter();\n+    let _ = iterator.flatten();\n+}"}, {"sha": "e698df13eea47ef4ff3eaca9319a0a0b82b14ad5", "filename": "tests/ui/filter_map_identity.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/ad9ceeebdcce3d844c065777d1c2d3d74aff0047/tests%2Fui%2Ffilter_map_identity.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad9ceeebdcce3d844c065777d1c2d3d74aff0047/tests%2Fui%2Ffilter_map_identity.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ffilter_map_identity.rs?ref=ad9ceeebdcce3d844c065777d1c2d3d74aff0047", "patch": "@@ -0,0 +1,16 @@\n+// run-rustfix\n+\n+#![allow(unused_imports)]\n+#![warn(clippy::filter_map_identity)]\n+\n+fn main() {\n+    let iterator = vec![Some(1), None, Some(2)].into_iter();\n+    let _ = iterator.filter_map(|x| x);\n+\n+    let iterator = vec![Some(1), None, Some(2)].into_iter();\n+    let _ = iterator.filter_map(std::convert::identity);\n+\n+    use std::convert::identity;\n+    let iterator = vec![Some(1), None, Some(2)].into_iter();\n+    let _ = iterator.filter_map(identity);\n+}"}, {"sha": "596a6320608c7c0acf8725c40c88c82461b20309", "filename": "tests/ui/filter_map_identity.stderr", "status": "added", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/ad9ceeebdcce3d844c065777d1c2d3d74aff0047/tests%2Fui%2Ffilter_map_identity.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/ad9ceeebdcce3d844c065777d1c2d3d74aff0047/tests%2Fui%2Ffilter_map_identity.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ffilter_map_identity.stderr?ref=ad9ceeebdcce3d844c065777d1c2d3d74aff0047", "patch": "@@ -0,0 +1,22 @@\n+error: called `filter_map(|x| x)` on an `Iterator`\n+  --> $DIR/filter_map_identity.rs:8:22\n+   |\n+LL |     let _ = iterator.filter_map(|x| x);\n+   |                      ^^^^^^^^^^^^^^^^^ help: try: `flatten()`\n+   |\n+   = note: `-D clippy::filter-map-identity` implied by `-D warnings`\n+\n+error: called `filter_map(std::convert::identity)` on an `Iterator`\n+  --> $DIR/filter_map_identity.rs:11:22\n+   |\n+LL |     let _ = iterator.filter_map(std::convert::identity);\n+   |                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: try: `flatten()`\n+\n+error: called `filter_map(std::convert::identity)` on an `Iterator`\n+  --> $DIR/filter_map_identity.rs:15:22\n+   |\n+LL |     let _ = iterator.filter_map(identity);\n+   |                      ^^^^^^^^^^^^^^^^^^^^ help: try: `flatten()`\n+\n+error: aborting due to 3 previous errors\n+"}]}