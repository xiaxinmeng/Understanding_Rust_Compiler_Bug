{"sha": "d2128fd16667e5b7ec3624fc1733bb573a80441a", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQyMTI4ZmQxNjY2N2U1YjdlYzM2MjRmYzE3MzNiYjU3M2E4MDQ0MWE=", "commit": {"author": {"name": "Corey Farwell", "email": "coreyf@rwell.org", "date": "2017-03-31T15:43:30Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2017-03-31T15:43:30Z"}, "message": "Rollup merge of #40694 - frewsxcv:unstable-book-checker, r=steveklabnik\n\nSync all unstable features with Unstable Book; add tidy lint.\n\nAdd a tidy lint that checks for...\n\n* Unstable Book sections with no corresponding SUMMARY.md links\n* unstable features that don't have Unstable Book sections\n* Unstable Book sections that don't have corresponding unstable features", "tree": {"sha": "b1934a47949d09cd1fcaa3da58135483aa16eb77", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b1934a47949d09cd1fcaa3da58135483aa16eb77"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d2128fd16667e5b7ec3624fc1733bb573a80441a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d2128fd16667e5b7ec3624fc1733bb573a80441a", "html_url": "https://github.com/rust-lang/rust/commit/d2128fd16667e5b7ec3624fc1733bb573a80441a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d2128fd16667e5b7ec3624fc1733bb573a80441a/comments", "author": {"login": "frewsxcv", "id": 416575, "node_id": "MDQ6VXNlcjQxNjU3NQ==", "avatar_url": "https://avatars.githubusercontent.com/u/416575?v=4", "gravatar_id": "", "url": "https://api.github.com/users/frewsxcv", "html_url": "https://github.com/frewsxcv", "followers_url": "https://api.github.com/users/frewsxcv/followers", "following_url": "https://api.github.com/users/frewsxcv/following{/other_user}", "gists_url": "https://api.github.com/users/frewsxcv/gists{/gist_id}", "starred_url": "https://api.github.com/users/frewsxcv/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/frewsxcv/subscriptions", "organizations_url": "https://api.github.com/users/frewsxcv/orgs", "repos_url": "https://api.github.com/users/frewsxcv/repos", "events_url": "https://api.github.com/users/frewsxcv/events{/privacy}", "received_events_url": "https://api.github.com/users/frewsxcv/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a9329d3aa3974cfe7fda57a67b3898434f410131", "url": "https://api.github.com/repos/rust-lang/rust/commits/a9329d3aa3974cfe7fda57a67b3898434f410131", "html_url": "https://github.com/rust-lang/rust/commit/a9329d3aa3974cfe7fda57a67b3898434f410131"}, {"sha": "eef2a9598b9a149d45d440efe0580604b5726527", "url": "https://api.github.com/repos/rust-lang/rust/commits/eef2a9598b9a149d45d440efe0580604b5726527", "html_url": "https://github.com/rust-lang/rust/commit/eef2a9598b9a149d45d440efe0580604b5726527"}], "stats": {"total": 328, "additions": 243, "deletions": 85}, "files": [{"sha": "1fa256197ce528a537269316cc7e2c873b2b9ef0", "filename": "src/Cargo.lock", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/d2128fd16667e5b7ec3624fc1733bb573a80441a/src%2FCargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/d2128fd16667e5b7ec3624fc1733bb573a80441a/src%2FCargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2FCargo.lock?ref=d2128fd16667e5b7ec3624fc1733bb573a80441a", "patch": "@@ -926,6 +926,9 @@ dependencies = [\n [[package]]\n name = \"tidy\"\n version = \"0.1.0\"\n+dependencies = [\n+ \"regex 0.2.1 (registry+https://github.com/rust-lang/crates.io-index)\",\n+]\n \n [[package]]\n name = \"toml\""}, {"sha": "292f5a1ec816af92e6569d03e0084ee4b0c957b5", "filename": "src/doc/unstable-book/src/SUMMARY.md", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/d2128fd16667e5b7ec3624fc1733bb573a80441a/src%2Fdoc%2Funstable-book%2Fsrc%2FSUMMARY.md", "raw_url": "https://github.com/rust-lang/rust/raw/d2128fd16667e5b7ec3624fc1733bb573a80441a/src%2Fdoc%2Funstable-book%2Fsrc%2FSUMMARY.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Funstable-book%2Fsrc%2FSUMMARY.md?ref=d2128fd16667e5b7ec3624fc1733bb573a80441a", "patch": "@@ -146,7 +146,6 @@\n - [proc_macro](proc-macro.md)\n - [proc_macro_internals](proc-macro-internals.md)\n - [process_try_wait](process-try-wait.md)\n-- [pub_restricted](pub-restricted.md)\n - [question_mark_carrier](question-mark-carrier.md)\n - [quote](quote.md)\n - [rand](rand.md)\n@@ -156,11 +155,11 @@\n - [relaxed_adts](relaxed-adts.md)\n - [repr_simd](repr-simd.md)\n - [retain_hash_collection](retain-hash-collection.md)\n+- [reverse_cmp_key](reverse-cmp-key.md)\n - [rt](rt.md)\n - [rustc_attrs](rustc-attrs.md)\n - [rustc_diagnostic_macros](rustc-diagnostic-macros.md)\n - [rustc_private](rustc-private.md)\n-- [rustdoc](rustdoc.md)\n - [rvalue_static_promotion](rvalue-static-promotion.md)\n - [sanitizer_runtime](sanitizer-runtime.md)\n - [sanitizer_runtime_lib](sanitizer-runtime-lib.md)\n@@ -181,6 +180,7 @@\n - [step_by](step-by.md)\n - [step_trait](step-trait.md)\n - [stmt_expr_attributes](stmt-expr-attributes.md)\n+- [str_checked_slicing](str-checked-slicing.md)\n - [str_escape](str-escape.md)\n - [str_internals](str-internals.md)\n - [struct_field_attributes](struct-field-attributes.md)"}, {"sha": "6b1e88b8603014a9c5bceb76c3d0088ce46098fd", "filename": "src/doc/unstable-book/src/pub-restricted.md", "status": "removed", "additions": 0, "deletions": 7, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/a9329d3aa3974cfe7fda57a67b3898434f410131/src%2Fdoc%2Funstable-book%2Fsrc%2Fpub-restricted.md", "raw_url": "https://github.com/rust-lang/rust/raw/a9329d3aa3974cfe7fda57a67b3898434f410131/src%2Fdoc%2Funstable-book%2Fsrc%2Fpub-restricted.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Funstable-book%2Fsrc%2Fpub-restricted.md?ref=a9329d3aa3974cfe7fda57a67b3898434f410131", "patch": "@@ -1,7 +0,0 @@\n-# `pub_restricted`\n-\n-The tracking issue for this feature is: [#32409]\n-\n-[#38356]: https://github.com/rust-lang/rust/issues/32409\n-\n-------------------------"}, {"sha": "a1a851d6ed6328847bcc9c9a130df9ebe4ff74f1", "filename": "src/doc/unstable-book/src/reverse-cmp-key.md", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/d2128fd16667e5b7ec3624fc1733bb573a80441a/src%2Fdoc%2Funstable-book%2Fsrc%2Freverse-cmp-key.md", "raw_url": "https://github.com/rust-lang/rust/raw/d2128fd16667e5b7ec3624fc1733bb573a80441a/src%2Fdoc%2Funstable-book%2Fsrc%2Freverse-cmp-key.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Funstable-book%2Fsrc%2Freverse-cmp-key.md?ref=d2128fd16667e5b7ec3624fc1733bb573a80441a", "patch": "@@ -0,0 +1,7 @@\n+# `reverse_cmp_key`\n+\n+The tracking issue for this feature is: [#40893]\n+\n+[#40893]: https://github.com/rust-lang/rust/issues/40893\n+\n+------------------------"}, {"sha": "c7491ab034bffd9e7aaf0d6689a9fa1bd1817e7f", "filename": "src/doc/unstable-book/src/rustdoc.md", "status": "removed", "additions": 0, "deletions": 7, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/a9329d3aa3974cfe7fda57a67b3898434f410131/src%2Fdoc%2Funstable-book%2Fsrc%2Frustdoc.md", "raw_url": "https://github.com/rust-lang/rust/raw/a9329d3aa3974cfe7fda57a67b3898434f410131/src%2Fdoc%2Funstable-book%2Fsrc%2Frustdoc.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Funstable-book%2Fsrc%2Frustdoc.md?ref=a9329d3aa3974cfe7fda57a67b3898434f410131", "patch": "@@ -1,7 +0,0 @@\n-# `rustdoc`\n-\n-The tracking issue for this feature is: [#27812]\n-\n-[#27812]: https://github.com/rust-lang/rust/issues/27812\n-\n-------------------------"}, {"sha": "d390139a6befaef8024cbac2fe7fefa32417264f", "filename": "src/doc/unstable-book/src/str-checked-slicing.md", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/d2128fd16667e5b7ec3624fc1733bb573a80441a/src%2Fdoc%2Funstable-book%2Fsrc%2Fstr-checked-slicing.md", "raw_url": "https://github.com/rust-lang/rust/raw/d2128fd16667e5b7ec3624fc1733bb573a80441a/src%2Fdoc%2Funstable-book%2Fsrc%2Fstr-checked-slicing.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Funstable-book%2Fsrc%2Fstr-checked-slicing.md?ref=d2128fd16667e5b7ec3624fc1733bb573a80441a", "patch": "@@ -0,0 +1,7 @@\n+# `str_checked_slicing`\n+\n+The tracking issue for this feature is: [#39932]\n+\n+[#39932]: https://github.com/rust-lang/rust/issues/39932\n+\n+------------------------"}, {"sha": "371922c9e6bb22ddd4e05389a7bb6a435b825112", "filename": "src/tools/tidy/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d2128fd16667e5b7ec3624fc1733bb573a80441a/src%2Ftools%2Ftidy%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/d2128fd16667e5b7ec3624fc1733bb573a80441a/src%2Ftools%2Ftidy%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2FCargo.toml?ref=d2128fd16667e5b7ec3624fc1733bb573a80441a", "patch": "@@ -4,3 +4,4 @@ version = \"0.1.0\"\n authors = [\"Alex Crichton <alex@alexcrichton.com>\"]\n \n [dependencies]\n+regex = \"0.2\"\n\\ No newline at end of file"}, {"sha": "e1fdc19c27d2585a902cd19bfcd203707fd809de", "filename": "src/tools/tidy/src/features.rs", "status": "modified", "additions": 81, "deletions": 69, "changes": 150, "blob_url": "https://github.com/rust-lang/rust/blob/d2128fd16667e5b7ec3624fc1733bb573a80441a/src%2Ftools%2Ftidy%2Fsrc%2Ffeatures.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d2128fd16667e5b7ec3624fc1733bb573a80441a/src%2Ftools%2Ftidy%2Fsrc%2Ffeatures.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Ffeatures.rs?ref=d2128fd16667e5b7ec3624fc1733bb573a80441a", "patch": "@@ -24,8 +24,8 @@ use std::fs::File;\n use std::io::prelude::*;\n use std::path::Path;\n \n-#[derive(PartialEq)]\n-enum Status {\n+#[derive(Debug, PartialEq)]\n+pub enum Status {\n     Stable,\n     Removed,\n     Unstable,\n@@ -42,78 +42,21 @@ impl fmt::Display for Status {\n     }\n }\n \n-struct Feature {\n-    level: Status,\n-    since: String,\n-    has_gate_test: bool,\n+#[derive(Debug)]\n+pub struct Feature {\n+    pub level: Status,\n+    pub since: String,\n+    pub has_gate_test: bool,\n }\n \n pub fn check(path: &Path, bad: &mut bool) {\n-    let mut features = collect_lang_features(&path.join(\"libsyntax/feature_gate.rs\"));\n+    let mut features = collect_lang_features(path);\n     assert!(!features.is_empty());\n-    let mut lib_features = HashMap::<String, Feature>::new();\n-\n-    let mut contents = String::new();\n-    super::walk(path,\n-                &mut |path| super::filter_dirs(path) || path.ends_with(\"src/test\"),\n-                &mut |file| {\n-        let filename = file.file_name().unwrap().to_string_lossy();\n-        if !filename.ends_with(\".rs\") || filename == \"features.rs\" ||\n-           filename == \"diagnostic_list.rs\" {\n-            return;\n-        }\n-\n-        contents.truncate(0);\n-        t!(t!(File::open(&file), &file).read_to_string(&mut contents));\n \n-        for (i, line) in contents.lines().enumerate() {\n-            let mut err = |msg: &str| {\n-                println!(\"{}:{}: {}\", file.display(), i + 1, msg);\n-                *bad = true;\n-            };\n-            let level = if line.contains(\"[unstable(\") {\n-                Status::Unstable\n-            } else if line.contains(\"[stable(\") {\n-                Status::Stable\n-            } else {\n-                continue;\n-            };\n-            let feature_name = match find_attr_val(line, \"feature\") {\n-                Some(name) => name,\n-                None => {\n-                    err(\"malformed stability attribute\");\n-                    continue;\n-                }\n-            };\n-            let since = match find_attr_val(line, \"since\") {\n-                Some(name) => name,\n-                None if level == Status::Stable => {\n-                    err(\"malformed stability attribute\");\n-                    continue;\n-                }\n-                None => \"None\",\n-            };\n+    let lib_features = collect_lib_features(path, bad, &features);\n+    assert!(!lib_features.is_empty());\n \n-            if features.contains_key(feature_name) {\n-                err(\"duplicating a lang feature\");\n-            }\n-            if let Some(ref s) = lib_features.get(feature_name) {\n-                if s.level != level {\n-                    err(\"different stability level than before\");\n-                }\n-                if s.since != since {\n-                    err(\"different `since` than before\");\n-                }\n-                continue;\n-            }\n-            lib_features.insert(feature_name.to_owned(),\n-                                Feature {\n-                                    level: level,\n-                                    since: since.to_owned(),\n-                                    has_gate_test: false,\n-                                });\n-        }\n-    });\n+    let mut contents = String::new();\n \n     super::walk_many(&[&path.join(\"test/compile-fail\"),\n                        &path.join(\"test/compile-fail-fulldeps\"),\n@@ -233,8 +176,9 @@ fn test_filen_gate(filen_underscore: &str,\n     return false;\n }\n \n-fn collect_lang_features(path: &Path) -> HashMap<String, Feature> {\n+pub fn collect_lang_features(base_src_path: &Path) -> HashMap<String, Feature> {\n     let mut contents = String::new();\n+    let path = base_src_path.join(\"libsyntax/feature_gate.rs\");\n     t!(t!(File::open(path)).read_to_string(&mut contents));\n \n     contents.lines()\n@@ -257,3 +201,71 @@ fn collect_lang_features(path: &Path) -> HashMap<String, Feature> {\n         })\n         .collect()\n }\n+\n+pub fn collect_lib_features(base_src_path: &Path,\n+                            bad: &mut bool,\n+                            features: &HashMap<String, Feature>) -> HashMap<String, Feature> {\n+    let mut lib_features = HashMap::<String, Feature>::new();\n+    let mut contents = String::new();\n+    super::walk(base_src_path,\n+                &mut |path| super::filter_dirs(path) || path.ends_with(\"src/test\"),\n+                &mut |file| {\n+        let filename = file.file_name().unwrap().to_string_lossy();\n+        if !filename.ends_with(\".rs\") || filename == \"features.rs\" ||\n+           filename == \"diagnostic_list.rs\" {\n+            return;\n+        }\n+\n+        contents.truncate(0);\n+        t!(t!(File::open(&file), &file).read_to_string(&mut contents));\n+\n+        for (i, line) in contents.lines().enumerate() {\n+            let mut err = |msg: &str| {\n+                println!(\"{}:{}: {}\", file.display(), i + 1, msg);\n+                *bad = true;\n+            };\n+            let level = if line.contains(\"[unstable(\") {\n+                Status::Unstable\n+            } else if line.contains(\"[stable(\") {\n+                Status::Stable\n+            } else {\n+                continue;\n+            };\n+            let feature_name = match find_attr_val(line, \"feature\") {\n+                Some(name) => name,\n+                None => {\n+                    err(\"malformed stability attribute\");\n+                    continue;\n+                }\n+            };\n+            let since = match find_attr_val(line, \"since\") {\n+                Some(name) => name,\n+                None if level == Status::Stable => {\n+                    err(\"malformed stability attribute\");\n+                    continue;\n+                }\n+                None => \"None\",\n+            };\n+\n+            if features.contains_key(feature_name) {\n+                err(\"duplicating a lang feature\");\n+            }\n+            if let Some(ref s) = lib_features.get(feature_name) {\n+                if s.level != level {\n+                    err(\"different stability level than before\");\n+                }\n+                if s.since != since {\n+                    err(\"different `since` than before\");\n+                }\n+                continue;\n+            }\n+            lib_features.insert(feature_name.to_owned(),\n+                                Feature {\n+                                    level: level,\n+                                    since: since.to_owned(),\n+                                    has_gate_test: false,\n+                                });\n+        }\n+    });\n+    lib_features\n+}\n\\ No newline at end of file"}, {"sha": "501e35e03e8a70e971fb827c2155304e54045911", "filename": "src/tools/tidy/src/main.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/d2128fd16667e5b7ec3624fc1733bb573a80441a/src%2Ftools%2Ftidy%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d2128fd16667e5b7ec3624fc1733bb573a80441a/src%2Ftools%2Ftidy%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Fmain.rs?ref=d2128fd16667e5b7ec3624fc1733bb573a80441a", "patch": "@@ -14,6 +14,8 @@\n //! etc. This is run by default on `make check` and as part of the auto\n //! builders.\n \n+extern crate regex;\n+\n use std::fs;\n use std::path::{PathBuf, Path};\n use std::env;\n@@ -37,6 +39,7 @@ mod features;\n mod cargo;\n mod pal;\n mod deps;\n+mod unstable_book;\n \n fn main() {\n     let path = env::args_os().skip(1).next().expect(\"need an argument\");\n@@ -51,6 +54,7 @@ fn main() {\n     cargo::check(&path, &mut bad);\n     features::check(&path, &mut bad);\n     pal::check(&path, &mut bad);\n+    unstable_book::check(&path, &mut bad);\n     if !args.iter().any(|s| *s == \"--no-vendor\") {\n         deps::check(&path, &mut bad);\n     }"}, {"sha": "c10e31077944f0950e496115e7a5864444573832", "filename": "src/tools/tidy/src/unstable_book.rs", "status": "added", "additions": 138, "deletions": 0, "changes": 138, "blob_url": "https://github.com/rust-lang/rust/blob/d2128fd16667e5b7ec3624fc1733bb573a80441a/src%2Ftools%2Ftidy%2Fsrc%2Funstable_book.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d2128fd16667e5b7ec3624fc1733bb573a80441a/src%2Ftools%2Ftidy%2Fsrc%2Funstable_book.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Funstable_book.rs?ref=d2128fd16667e5b7ec3624fc1733bb573a80441a", "patch": "@@ -0,0 +1,138 @@\n+// Copyright 2017 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+use std::collections::HashSet;\n+use std::fs;\n+use std::io::{self, BufRead, Write};\n+use std::path;\n+use features::{collect_lang_features, collect_lib_features, Status};\n+\n+const PATH_STR: &'static str = \"doc/unstable-book/src\";\n+\n+const SUMMARY_FILE_NAME: &'static str = \"SUMMARY.md\";\n+\n+static EXCLUDE: &'static [&'static str; 2] = &[SUMMARY_FILE_NAME, \"the-unstable-book.md\"];\n+\n+/// Build the path to the Unstable Book source directory from the Rust 'src' directory\n+fn unstable_book_path(base_src_path: &path::Path) -> path::PathBuf {\n+    base_src_path.join(PATH_STR)\n+}\n+\n+/// Build the path to the Unstable Book SUMMARY file from the Rust 'src' directory\n+fn unstable_book_summary_path(base_src_path: &path::Path) -> path::PathBuf {\n+    unstable_book_path(base_src_path).join(SUMMARY_FILE_NAME)\n+}\n+\n+/// Open the Unstable Book SUMMARY file\n+fn open_unstable_book_summary_file(base_src_path: &path::Path) -> fs::File {\n+    fs::File::open(unstable_book_summary_path(base_src_path))\n+        .expect(\"could not open Unstable Book SUMMARY.md\")\n+}\n+\n+/// Test to determine if DirEntry is a file\n+fn dir_entry_is_file(dir_entry: &fs::DirEntry) -> bool {\n+    dir_entry.file_type().expect(\"could not determine file type of directory entry\").is_file()\n+}\n+\n+/// Retrieve names of all lang-related unstable features\n+fn collect_unstable_lang_feature_names(base_src_path: &path::Path) -> HashSet<String> {\n+    collect_lang_features(base_src_path)\n+        .into_iter()\n+        .filter(|&(_, ref f)| f.level == Status::Unstable)\n+        .map(|(ref name, _)| name.to_owned())\n+        .collect()\n+}\n+\n+/// Retrieve names of all lib-related unstable features\n+fn collect_unstable_lib_feature_names(base_src_path: &path::Path) -> HashSet<String> {\n+    let mut bad = true;\n+    let lang_features = collect_lang_features(base_src_path);\n+    collect_lib_features(base_src_path, &mut bad, &lang_features)\n+        .into_iter()\n+        .filter(|&(_, ref f)| f.level == Status::Unstable)\n+        .map(|(ref name, _)| name.to_owned())\n+        .collect()\n+}\n+\n+/// Retrieve names of all unstable features\n+fn collect_unstable_feature_names(base_src_path: &path::Path) -> HashSet<String> {\n+    collect_unstable_lib_feature_names(base_src_path)\n+        .union(&collect_unstable_lang_feature_names(base_src_path))\n+        .map(|n| n.to_owned())\n+        .collect::<HashSet<_, _>>()\n+}\n+\n+/// Retrieve file names of all sections in the Unstable Book with:\n+///\n+/// * hyphens replaced by underscores\n+/// * the markdown suffix ('.md') removed\n+fn collect_unstable_book_section_file_names(base_src_path: &path::Path) -> HashSet<String> {\n+    fs::read_dir(unstable_book_path(base_src_path))\n+        .expect(\"could not read directory\")\n+        .into_iter()\n+        .map(|entry| entry.expect(\"could not read directory entry\"))\n+        .filter(dir_entry_is_file)\n+        .map(|entry| entry.file_name().into_string().unwrap())\n+        .filter(|n| EXCLUDE.iter().all(|e| n != e))\n+        .map(|n| n.trim_right_matches(\".md\").replace('-', \"_\"))\n+        .collect()\n+}\n+\n+/// Retrieve unstable feature names that are in the Unstable Book SUMMARY file\n+fn collect_unstable_book_summary_links(base_src_path: &path::Path) -> HashSet<String> {\n+    let summary_link_regex =\n+        ::regex::Regex::new(r\"^- \\[(\\S+)\\]\\(\\S+\\.md\\)\").expect(\"invalid regex\");\n+    io::BufReader::new(open_unstable_book_summary_file(base_src_path))\n+        .lines()\n+        .map(|l| l.expect(\"could not read line from file\"))\n+        .filter_map(|line| {\n+            summary_link_regex.captures(&line).map(|c| {\n+                                                       c.get(1)\n+                                                           .unwrap()\n+                                                           .as_str()\n+                                                           .to_owned()\n+                                                   })\n+        })\n+        .collect()\n+}\n+\n+pub fn check(path: &path::Path, bad: &mut bool) {\n+    let unstable_feature_names = collect_unstable_feature_names(path);\n+    let unstable_book_section_file_names = collect_unstable_book_section_file_names(path);\n+    let unstable_book_links = collect_unstable_book_summary_links(path);\n+\n+    // Check for Unstable Book section names with no corresponding SUMMARY.md link\n+    for feature_name in &unstable_book_section_file_names - &unstable_book_links {\n+        *bad = true;\n+        writeln!(io::stderr(),\n+                 \"The Unstable Book section '{}' needs to have a link in SUMMARY.md\",\n+                 feature_name)\n+                .expect(\"could not write to stderr\")\n+    }\n+\n+    // Check for unstable features that don't have Unstable Book sections\n+    for feature_name in &unstable_feature_names - &unstable_book_section_file_names {\n+        *bad = true;\n+        writeln!(io::stderr(),\n+                 \"Unstable feature '{}' needs to have a section in The Unstable Book\",\n+                 feature_name)\n+                .expect(\"could not write to stderr\")\n+    }\n+\n+    // Check for Unstable Book sections that don't have a corresponding unstable feature\n+    for feature_name in &unstable_book_section_file_names - &unstable_feature_names {\n+        *bad = true;\n+        writeln!(io::stderr(),\n+                 \"The Unstable Book has a section '{}' which doesn't correspond \\\n+                  to an unstable feature\",\n+                 feature_name)\n+                .expect(\"could not write to stderr\")\n+    }\n+}"}]}