{"sha": "3b2602cbb265ee68a3e3658072d58ff504675252", "node_id": "MDY6Q29tbWl0NzI0NzEyOjNiMjYwMmNiYjI2NWVlNjhhM2UzNjU4MDcyZDU4ZmY1MDQ2NzUyNTI=", "commit": {"author": {"name": "Lauren\u021biu Nicola", "email": "lnicola@dend.ro", "date": "2021-07-08T08:22:29Z"}, "committer": {"name": "Lauren\u021biu Nicola", "email": "lnicola@dend.ro", "date": "2021-07-08T09:55:00Z"}, "message": "Don't unify array elements with their arrays", "tree": {"sha": "d0893eead13eb5d401421b965f88aeeb33c6fd11", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d0893eead13eb5d401421b965f88aeeb33c6fd11"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3b2602cbb265ee68a3e3658072d58ff504675252", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3b2602cbb265ee68a3e3658072d58ff504675252", "html_url": "https://github.com/rust-lang/rust/commit/3b2602cbb265ee68a3e3658072d58ff504675252", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3b2602cbb265ee68a3e3658072d58ff504675252/comments", "author": {"login": "lnicola", "id": 308347, "node_id": "MDQ6VXNlcjMwODM0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/308347?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lnicola", "html_url": "https://github.com/lnicola", "followers_url": "https://api.github.com/users/lnicola/followers", "following_url": "https://api.github.com/users/lnicola/following{/other_user}", "gists_url": "https://api.github.com/users/lnicola/gists{/gist_id}", "starred_url": "https://api.github.com/users/lnicola/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lnicola/subscriptions", "organizations_url": "https://api.github.com/users/lnicola/orgs", "repos_url": "https://api.github.com/users/lnicola/repos", "events_url": "https://api.github.com/users/lnicola/events{/privacy}", "received_events_url": "https://api.github.com/users/lnicola/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lnicola", "id": 308347, "node_id": "MDQ6VXNlcjMwODM0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/308347?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lnicola", "html_url": "https://github.com/lnicola", "followers_url": "https://api.github.com/users/lnicola/followers", "following_url": "https://api.github.com/users/lnicola/following{/other_user}", "gists_url": "https://api.github.com/users/lnicola/gists{/gist_id}", "starred_url": "https://api.github.com/users/lnicola/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lnicola/subscriptions", "organizations_url": "https://api.github.com/users/lnicola/orgs", "repos_url": "https://api.github.com/users/lnicola/repos", "events_url": "https://api.github.com/users/lnicola/events{/privacy}", "received_events_url": "https://api.github.com/users/lnicola/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "85f0f9eb1bb7eedf11a3947508fccba66f22d108", "url": "https://api.github.com/repos/rust-lang/rust/commits/85f0f9eb1bb7eedf11a3947508fccba66f22d108", "html_url": "https://github.com/rust-lang/rust/commit/85f0f9eb1bb7eedf11a3947508fccba66f22d108"}], "stats": {"total": 30, "additions": 21, "deletions": 9}, "files": [{"sha": "746c3e4ee8803be68605af35e022073f064db8ee", "filename": "crates/hir_ty/src/infer/expr.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/3b2602cbb265ee68a3e3658072d58ff504675252/crates%2Fhir_ty%2Fsrc%2Finfer%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3b2602cbb265ee68a3e3658072d58ff504675252/crates%2Fhir_ty%2Fsrc%2Finfer%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Finfer%2Fexpr.rs?ref=3b2602cbb265ee68a3e3658072d58ff504675252", "patch": "@@ -735,10 +735,11 @@ impl<'a> InferenceContext<'a> {\n                         _ => self.table.new_type_var(),\n                     };\n \n+                let expected = Expectation::has_type(elem_ty.clone());\n                 let len = match array {\n                     Array::ElementList(items) => {\n                         for expr in items.iter() {\n-                            let cur_elem_ty = self.infer_expr_inner(*expr, expected);\n+                            let cur_elem_ty = self.infer_expr_inner(*expr, &expected);\n                             elem_ty = self.coerce_merge_branch(Some(*expr), &elem_ty, &cur_elem_ty);\n                         }\n                         Some(items.len() as u64)"}, {"sha": "915dfbbc0d49ba1d9f24a2dab5fc8d7ddb166d94", "filename": "crates/hir_ty/src/tests/regression.rs", "status": "modified", "additions": 19, "deletions": 8, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/3b2602cbb265ee68a3e3658072d58ff504675252/crates%2Fhir_ty%2Fsrc%2Ftests%2Fregression.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3b2602cbb265ee68a3e3658072d58ff504675252/crates%2Fhir_ty%2Fsrc%2Ftests%2Fregression.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Ftests%2Fregression.rs?ref=3b2602cbb265ee68a3e3658072d58ff504675252", "patch": "@@ -117,23 +117,34 @@ fn recursive_vars_2() {\n         \"#,\n         expect![[r#\"\n             10..79 '{     ...x)]; }': ()\n-            20..21 'x': {unknown}\n-            24..31 'unknown': {unknown}\n+            20..21 'x': &{unknown}\n+            24..31 'unknown': &{unknown}\n             41..42 'y': {unknown}\n             45..52 'unknown': {unknown}\n-            58..76 '[(x, y..., &x)]': [({unknown}, {unknown}); 2]\n-            59..65 '(x, y)': ({unknown}, {unknown})\n-            60..61 'x': {unknown}\n+            58..76 '[(x, y..., &x)]': [(&{unknown}, {unknown}); 2]\n+            59..65 '(x, y)': (&{unknown}, {unknown})\n+            60..61 'x': &{unknown}\n             63..64 'y': {unknown}\n-            67..75 '(&y, &x)': (&{unknown}, &{unknown})\n+            67..75 '(&y, &x)': (&{unknown}, {unknown})\n             68..70 '&y': &{unknown}\n             69..70 'y': {unknown}\n-            72..74 '&x': &{unknown}\n-            73..74 'x': {unknown}\n+            72..74 '&x': &&{unknown}\n+            73..74 'x': &{unknown}\n         \"#]],\n     );\n }\n \n+#[test]\n+fn array_elements_expected_type() {\n+    check_no_mismatches(\n+        r#\"\n+        fn test() {\n+            let x: [[u32; 2]; 2] = [[1, 2], [3, 4]];\n+        }\n+        \"#,\n+    );\n+}\n+\n #[test]\n fn infer_std_crash_1() {\n     // caused stack overflow, taken from std"}]}