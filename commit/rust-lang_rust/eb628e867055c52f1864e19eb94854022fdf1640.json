{"sha": "eb628e867055c52f1864e19eb94854022fdf1640", "node_id": "C_kwDOAAsO6NoAKGViNjI4ZTg2NzA1NWM1MmYxODY0ZTE5ZWI5NDg1NDAyMmZkZjE2NDA", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-09-24T12:29:53Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-09-24T12:29:53Z"}, "message": "Rollup merge of #102109 - petrochenkov:addids, r=oli-obk\n\nresolve: Set effective visibilities for imports more precisely\n\nInstead of setting them for all primary and additional IDs of the import, only set them for the binding's true ID.", "tree": {"sha": "57b9d8a4afaf6ec6c0055fdb3c9571282afc9594", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/57b9d8a4afaf6ec6c0055fdb3c9571282afc9594"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/eb628e867055c52f1864e19eb94854022fdf1640", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjLvhBCRBK7hj4Ov3rIwAAn8cIADFA9W5aSAi16i2rNyQIiwh+\ntWPnrD2OxqFb5Pa+8bCorLjkmLqsNI4POzzeuAVP0OhTLmMe3g+eiKyaHhQSh518\nFGqYjKEOVPFzvtIVFUQahORaeOjeV6lWgevl9Qs8Pi0FROfj5rYVfQmnp+G8iLpg\nvTE18Cc/4vHASg15+ZPlOV1Y1w436UdoGoU0itUTlkKQlWvG2gj4rJeD1K5LfUAA\nhPYF4LsBnbkfxl3N0bK1qLxBvLMuBakW2diFSbFWqxqlSW1JFhBcbB4WFz8xyIdP\nlVI8Kcp4mJiO0uwVzcOGyrw9Q+jslDneZDKfwIxRLMuGYjJiESzX0IUV93lavi0=\n=+10t\n-----END PGP SIGNATURE-----\n", "payload": "tree 57b9d8a4afaf6ec6c0055fdb3c9571282afc9594\nparent bf167e0ae59a00324ebf49fd3f812144266135b4\nparent 4ddff03917daea2ff42a5b5a42d38bbeaa051680\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1664022593 +0200\ncommitter GitHub <noreply@github.com> 1664022593 +0200\n\nRollup merge of #102109 - petrochenkov:addids, r=oli-obk\n\nresolve: Set effective visibilities for imports more precisely\n\nInstead of setting them for all primary and additional IDs of the import, only set them for the binding's true ID.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/eb628e867055c52f1864e19eb94854022fdf1640", "html_url": "https://github.com/rust-lang/rust/commit/eb628e867055c52f1864e19eb94854022fdf1640", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/eb628e867055c52f1864e19eb94854022fdf1640/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "bf167e0ae59a00324ebf49fd3f812144266135b4", "url": "https://api.github.com/repos/rust-lang/rust/commits/bf167e0ae59a00324ebf49fd3f812144266135b4", "html_url": "https://github.com/rust-lang/rust/commit/bf167e0ae59a00324ebf49fd3f812144266135b4"}, {"sha": "4ddff03917daea2ff42a5b5a42d38bbeaa051680", "url": "https://api.github.com/repos/rust-lang/rust/commits/4ddff03917daea2ff42a5b5a42d38bbeaa051680", "html_url": "https://github.com/rust-lang/rust/commit/4ddff03917daea2ff42a5b5a42d38bbeaa051680"}], "stats": {"total": 87, "additions": 75, "deletions": 12}, "files": [{"sha": "d806441716fdabd860a841e2b02d6962301320d5", "filename": "compiler/rustc_resolve/src/access_levels.rs", "status": "modified", "additions": 4, "deletions": 9, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/eb628e867055c52f1864e19eb94854022fdf1640/compiler%2Frustc_resolve%2Fsrc%2Faccess_levels.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eb628e867055c52f1864e19eb94854022fdf1640/compiler%2Frustc_resolve%2Fsrc%2Faccess_levels.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Faccess_levels.rs?ref=eb628e867055c52f1864e19eb94854022fdf1640", "patch": "@@ -1,4 +1,3 @@\n-use crate::imports::ImportKind;\n use crate::NameBinding;\n use crate::NameBindingKind;\n use crate::Resolver;\n@@ -54,15 +53,11 @@ impl<'r, 'a> AccessLevelsVisitor<'r, 'a> {\n         // sets the rest of the `use` chain to `AccessLevel::Exported` until\n         // we hit the actual exported item.\n         let set_import_binding_access_level =\n-            |this: &mut Self, mut binding: &NameBinding<'a>, mut access_level| {\n+            |this: &mut Self, mut binding: &NameBinding<'a>, mut access_level, ns| {\n                 while let NameBindingKind::Import { binding: nested_binding, import, .. } =\n                     binding.kind\n                 {\n-                    this.set_access_level(import.id, access_level);\n-                    if let ImportKind::Single { additional_ids, .. } = import.kind {\n-                        this.set_access_level(additional_ids.0, access_level);\n-                        this.set_access_level(additional_ids.1, access_level);\n-                    }\n+                    this.set_access_level(this.r.import_id_for_ns(import, ns), access_level);\n \n                     access_level = Some(AccessLevel::Exported);\n                     binding = nested_binding;\n@@ -72,11 +67,11 @@ impl<'r, 'a> AccessLevelsVisitor<'r, 'a> {\n         let module = self.r.get_module(module_id.to_def_id()).unwrap();\n         let resolutions = self.r.resolutions(module);\n \n-        for (.., name_resolution) in resolutions.borrow().iter() {\n+        for (key, name_resolution) in resolutions.borrow().iter() {\n             if let Some(binding) = name_resolution.borrow().binding() && binding.vis.is_public() && !binding.is_ambiguity() {\n                 let access_level = match binding.is_import() {\n                     true => {\n-                        set_import_binding_access_level(self, binding, module_level);\n+                        set_import_binding_access_level(self, binding, module_level, key.ns);\n                         Some(AccessLevel::Exported)\n                     },\n                     false => module_level,"}, {"sha": "5bdb4274781994f3228b26e73262e6b00d259950", "filename": "compiler/rustc_resolve/src/imports.rs", "status": "modified", "additions": 26, "deletions": 1, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/eb628e867055c52f1864e19eb94854022fdf1640/compiler%2Frustc_resolve%2Fsrc%2Fimports.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eb628e867055c52f1864e19eb94854022fdf1640/compiler%2Frustc_resolve%2Fsrc%2Fimports.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Fimports.rs?ref=eb628e867055c52f1864e19eb94854022fdf1640", "patch": "@@ -2,7 +2,7 @@\n \n use crate::diagnostics::Suggestion;\n use crate::Determinacy::{self, *};\n-use crate::Namespace::{MacroNS, TypeNS};\n+use crate::Namespace::{self, *};\n use crate::{module_to_string, names_to_string};\n use crate::{AmbiguityKind, BindingKey, ModuleKind, ResolutionError, Resolver, Segment};\n use crate::{Finalize, Module, ModuleOrUniformRoot, ParentScope, PerNS, ScopeSet};\n@@ -371,6 +371,31 @@ impl<'a> Resolver<'a> {\n             self.used_imports.insert(import.id);\n         }\n     }\n+\n+    /// Take primary and additional node IDs from an import and select one that corresponds to the\n+    /// given namespace. The logic must match the corresponding logic from `fn lower_use_tree` that\n+    /// assigns resolutons to IDs.\n+    pub(crate) fn import_id_for_ns(&self, import: &Import<'_>, ns: Namespace) -> NodeId {\n+        if let ImportKind::Single { additional_ids: (id1, id2), .. } = import.kind {\n+            if let Some(resolutions) = self.import_res_map.get(&import.id) {\n+                assert!(resolutions[ns].is_some(), \"incorrectly finalized import\");\n+                return match ns {\n+                    TypeNS => import.id,\n+                    ValueNS => match resolutions.type_ns {\n+                        Some(_) => id1,\n+                        None => import.id,\n+                    },\n+                    MacroNS => match (resolutions.type_ns, resolutions.value_ns) {\n+                        (Some(_), Some(_)) => id2,\n+                        (Some(_), None) | (None, Some(_)) => id1,\n+                        (None, None) => import.id,\n+                    },\n+                };\n+            }\n+        }\n+\n+        import.id\n+    }\n }\n \n /// An error that may be transformed into a diagnostic later. Used to combine multiple unresolved"}, {"sha": "bf94d980678f506c74d004ae62b77a2ac69bbc09", "filename": "src/test/ui/privacy/access_levels.rs", "status": "modified", "additions": 14, "deletions": 1, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/eb628e867055c52f1864e19eb94854022fdf1640/src%2Ftest%2Fui%2Fprivacy%2Faccess_levels.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eb628e867055c52f1864e19eb94854022fdf1640/src%2Ftest%2Fui%2Fprivacy%2Faccess_levels.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fprivacy%2Faccess_levels.rs?ref=eb628e867055c52f1864e19eb94854022fdf1640", "patch": "@@ -55,8 +55,21 @@ mod outer { //~ ERROR Public: pub(self), Exported: pub(self), Reachable: pub(sel\n     }\n }\n \n-pub use outer::inner1;\n+#[rustc_effective_visibility]\n+pub use outer::inner1; //~ ERROR Public: pub, Exported: pub, Reachable: pub, ReachableFromImplTrait: pub\n \n pub fn foo() -> outer::ReachableStruct { outer::ReachableStruct {a: 0} }\n \n+mod half_public_import {\n+    #[rustc_effective_visibility]\n+    pub type HalfPublicImport = u8; //~ ERROR Public: pub(self), Exported: pub, Reachable: pub, ReachableFromImplTrait: pub\n+    #[rustc_effective_visibility]\n+    #[allow(non_upper_case_globals)]\n+    pub(crate) const HalfPublicImport: u8 = 0; //~ ERROR Public: pub(self), Exported: pub(self), Reachable: pub(self), ReachableFromImplTrait: pub(self)\n+}\n+\n+#[rustc_effective_visibility]\n+pub use half_public_import::HalfPublicImport; //~ ERROR Public: pub, Exported: pub, Reachable: pub, ReachableFromImplTrait: pub\n+                                              //~^ ERROR Public: pub(self), Exported: pub(self), Reachable: pub(self), ReachableFromImplTrait: pub(self)\n+\n fn main() {}"}, {"sha": "81514d1fbab45a04ad2c7406cf2fd44395d36c35", "filename": "src/test/ui/privacy/access_levels.stderr", "status": "modified", "additions": 31, "deletions": 1, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/eb628e867055c52f1864e19eb94854022fdf1640/src%2Ftest%2Fui%2Fprivacy%2Faccess_levels.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/eb628e867055c52f1864e19eb94854022fdf1640/src%2Ftest%2Fui%2Fprivacy%2Faccess_levels.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fprivacy%2Faccess_levels.stderr?ref=eb628e867055c52f1864e19eb94854022fdf1640", "patch": "@@ -88,6 +88,36 @@ error: Public: pub(self), Exported: pub(self), Reachable: pub, ReachableFromImpl\n LL |         pub a: u8,\n    |         ^^^^^^^^^\n \n+error: Public: pub, Exported: pub, Reachable: pub, ReachableFromImplTrait: pub\n+  --> $DIR/access_levels.rs:59:9\n+   |\n+LL | pub use outer::inner1;\n+   |         ^^^^^^^^^^^^^\n+\n+error: Public: pub(self), Exported: pub, Reachable: pub, ReachableFromImplTrait: pub\n+  --> $DIR/access_levels.rs:65:5\n+   |\n+LL |     pub type HalfPublicImport = u8;\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: Public: pub(self), Exported: pub(self), Reachable: pub(self), ReachableFromImplTrait: pub(self)\n+  --> $DIR/access_levels.rs:68:5\n+   |\n+LL |     pub(crate) const HalfPublicImport: u8 = 0;\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: Public: pub, Exported: pub, Reachable: pub, ReachableFromImplTrait: pub\n+  --> $DIR/access_levels.rs:72:9\n+   |\n+LL | pub use half_public_import::HalfPublicImport;\n+   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: Public: pub(self), Exported: pub(self), Reachable: pub(self), ReachableFromImplTrait: pub(self)\n+  --> $DIR/access_levels.rs:72:9\n+   |\n+LL | pub use half_public_import::HalfPublicImport;\n+   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n error: Public: pub(self), Exported: pub, Reachable: pub, ReachableFromImplTrait: pub\n   --> $DIR/access_levels.rs:14:13\n    |\n@@ -100,5 +130,5 @@ error: Public: pub(self), Exported: pub, Reachable: pub, ReachableFromImplTrait:\n LL |             type B;\n    |             ^^^^^^\n \n-error: aborting due to 17 previous errors\n+error: aborting due to 22 previous errors\n "}]}