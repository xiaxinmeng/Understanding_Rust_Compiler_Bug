{"sha": "a8aa5114bf13d9c6b2b870c5bf63eab8e70a0018", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE4YWE1MTE0YmYxM2Q5YzZiMmI4NzBjNWJmNjNlYWI4ZTcwYTAwMTg=", "commit": {"author": {"name": "Tyler Mandry", "email": "tmandry@gmail.com", "date": "2019-09-18T04:27:22Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-09-18T04:27:22Z"}, "message": "Rollup merge of #64486 - matthewjasper:hygiene-debugging, r=petrochenkov\n\nPrint out more information for `-Zunpretty=expanded,hygiene`\n\nI've found this helpful when trying to understand how hygiene works.\n\nCloses #16420", "tree": {"sha": "5f0c4c78b70920beb1643481dd1b264430fccf5d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5f0c4c78b70920beb1643481dd1b264430fccf5d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a8aa5114bf13d9c6b2b870c5bf63eab8e70a0018", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJdgbIqCRBK7hj4Ov3rIwAAdHIIABdLB82hxpff/q/ZIyETJQgr\nJqAplHJ7qCtzTRRdeMv1I6XYESWnnQ4nBEciSXzN29fyLuZtLSjRyM1xHVbUAFOY\nEmAiEn0HS+IFm+63Gq+ObIc9kUwbnF/LXYEuKGbVp3daahGGC3wKPfOLrgJupE4u\nF0SEbETDubWKMZWpZnKI27U3kLLBLC5z5x/YIUVD/2WH76rpUgV+UlbctCQijaC7\nRYUgNzJvQLGbRT24QktXeoXx1wec9duWqZNTGud9kh0CZoSrGq15lqhw53j3pwE1\nzs2dUpBd9O45rWJgWqMqvUq8ypHe3+uC+VKcKYrmMy1BLG7n8dXMwvYo2RNO9gA=\n=RY9s\n-----END PGP SIGNATURE-----\n", "payload": "tree 5f0c4c78b70920beb1643481dd1b264430fccf5d\nparent 528379121ceb5fca5382b4337be7ac064890ec8c\nparent 3c2fd1a72d2e8cc80b354b4d2dd7931a7afe1b02\nauthor Tyler Mandry <tmandry@gmail.com> 1568780842 -0700\ncommitter GitHub <noreply@github.com> 1568780842 -0700\n\nRollup merge of #64486 - matthewjasper:hygiene-debugging, r=petrochenkov\n\nPrint out more information for `-Zunpretty=expanded,hygiene`\n\nI've found this helpful when trying to understand how hygiene works.\n\nCloses #16420\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a8aa5114bf13d9c6b2b870c5bf63eab8e70a0018", "html_url": "https://github.com/rust-lang/rust/commit/a8aa5114bf13d9c6b2b870c5bf63eab8e70a0018", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a8aa5114bf13d9c6b2b870c5bf63eab8e70a0018/comments", "author": {"login": "tmandry", "id": 2280544, "node_id": "MDQ6VXNlcjIyODA1NDQ=", "avatar_url": "https://avatars.githubusercontent.com/u/2280544?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmandry", "html_url": "https://github.com/tmandry", "followers_url": "https://api.github.com/users/tmandry/followers", "following_url": "https://api.github.com/users/tmandry/following{/other_user}", "gists_url": "https://api.github.com/users/tmandry/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmandry/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmandry/subscriptions", "organizations_url": "https://api.github.com/users/tmandry/orgs", "repos_url": "https://api.github.com/users/tmandry/repos", "events_url": "https://api.github.com/users/tmandry/events{/privacy}", "received_events_url": "https://api.github.com/users/tmandry/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "528379121ceb5fca5382b4337be7ac064890ec8c", "url": "https://api.github.com/repos/rust-lang/rust/commits/528379121ceb5fca5382b4337be7ac064890ec8c", "html_url": "https://github.com/rust-lang/rust/commit/528379121ceb5fca5382b4337be7ac064890ec8c"}, {"sha": "3c2fd1a72d2e8cc80b354b4d2dd7931a7afe1b02", "url": "https://api.github.com/repos/rust-lang/rust/commits/3c2fd1a72d2e8cc80b354b4d2dd7931a7afe1b02", "html_url": "https://github.com/rust-lang/rust/commit/3c2fd1a72d2e8cc80b354b4d2dd7931a7afe1b02"}], "stats": {"total": 65, "additions": 59, "deletions": 6}, "files": [{"sha": "fa9504e22019ebfe585ca78846509f892675f7f9", "filename": "src/librustc_driver/pretty.rs", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/a8aa5114bf13d9c6b2b870c5bf63eab8e70a0018/src%2Flibrustc_driver%2Fpretty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a8aa5114bf13d9c6b2b870c5bf63eab8e70a0018/src%2Flibrustc_driver%2Fpretty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_driver%2Fpretty.rs?ref=a8aa5114bf13d9c6b2b870c5bf63eab8e70a0018", "patch": "@@ -326,6 +326,7 @@ impl<'hir> pprust::PpAnn for IdentifiedAnnotation<'hir> {\n     }\n     fn post(&self, s: &mut pprust::State<'_>, node: pprust::AnnNode<'_>) {\n         match node {\n+            pprust::AnnNode::Crate(_) |\n             pprust::AnnNode::Ident(_) |\n             pprust::AnnNode::Name(_) => {},\n \n@@ -431,14 +432,18 @@ impl<'a> pprust::PpAnn for HygieneAnnotation<'a> {\n         match node {\n             pprust::AnnNode::Ident(&ast::Ident { name, span }) => {\n                 s.s.space();\n-                // FIXME #16420: this doesn't display the connections\n-                // between syntax contexts\n                 s.synth_comment(format!(\"{}{:?}\", name.as_u32(), span.ctxt()))\n             }\n             pprust::AnnNode::Name(&name) => {\n                 s.s.space();\n                 s.synth_comment(name.as_u32().to_string())\n             }\n+            pprust::AnnNode::Crate(_) => {\n+                s.s.hardbreak();\n+                let verbose = self.sess.verbose();\n+                s.synth_comment(syntax_pos::hygiene::debug_hygiene_data(verbose));\n+                s.s.hardbreak_if_not_bol();\n+            }\n             _ => {}\n         }\n     }"}, {"sha": "b634dcca7fca24215ed3a3ae0e0e8569a46192f1", "filename": "src/libsyntax/ast.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a8aa5114bf13d9c6b2b870c5bf63eab8e70a0018/src%2Flibsyntax%2Fast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a8aa5114bf13d9c6b2b870c5bf63eab8e70a0018/src%2Flibsyntax%2Fast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fast.rs?ref=a8aa5114bf13d9c6b2b870c5bf63eab8e70a0018", "patch": "@@ -2387,7 +2387,7 @@ pub enum ItemKind {\n     ),\n     /// A macro invocation.\n     ///\n-    /// E.g., `macro_rules! foo { .. }` or `foo!(..)`.\n+    /// E.g., `foo!(..)`.\n     Mac(Mac),\n \n     /// A macro definition."}, {"sha": "bf36c0d2f56581286703234e657585446f85175f", "filename": "src/libsyntax/print/pprust.rs", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/a8aa5114bf13d9c6b2b870c5bf63eab8e70a0018/src%2Flibsyntax%2Fprint%2Fpprust.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a8aa5114bf13d9c6b2b870c5bf63eab8e70a0018/src%2Flibsyntax%2Fprint%2Fpprust.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fprint%2Fpprust.rs?ref=a8aa5114bf13d9c6b2b870c5bf63eab8e70a0018", "patch": "@@ -35,6 +35,7 @@ pub enum AnnNode<'a> {\n     SubItem(ast::NodeId),\n     Expr(&'a ast::Expr),\n     Pat(&'a ast::Pat),\n+    Crate(&'a ast::Crate),\n }\n \n pub trait PpAnn {\n@@ -140,6 +141,7 @@ pub fn print_crate<'a>(cm: &'a SourceMap,\n \n     s.print_mod(&krate.module, &krate.attrs);\n     s.print_remaining_comments();\n+    s.ann.post(&mut s, AnnNode::Crate(krate));\n     s.s.eof()\n }\n \n@@ -1369,8 +1371,12 @@ impl<'a> State<'a> {\n                 }\n             }\n             ast::ItemKind::MacroDef(ref macro_def) => {\n-                let (kw, has_bang) =\n-                    if macro_def.legacy { (\"macro_rules\", true) } else { (\"macro\", false) };\n+                let (kw, has_bang) = if macro_def.legacy {\n+                    (\"macro_rules\", true)\n+                } else {\n+                    self.print_visibility(&item.vis);\n+                    (\"macro\", false)\n+                };\n                 self.print_mac_common(\n                     Some(MacHeader::Keyword(kw)),\n                     has_bang,"}, {"sha": "e28d93267579a6d9026eb82e520d22a05465af89", "filename": "src/libsyntax_pos/hygiene.rs", "status": "modified", "additions": 32, "deletions": 0, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/a8aa5114bf13d9c6b2b870c5bf63eab8e70a0018/src%2Flibsyntax_pos%2Fhygiene.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a8aa5114bf13d9c6b2b870c5bf63eab8e70a0018/src%2Flibsyntax_pos%2Fhygiene.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax_pos%2Fhygiene.rs?ref=a8aa5114bf13d9c6b2b870c5bf63eab8e70a0018", "patch": "@@ -343,6 +343,38 @@ pub fn update_dollar_crate_names(mut get_name: impl FnMut(SyntaxContext) -> Symb\n     }))\n }\n \n+pub fn debug_hygiene_data(verbose: bool) -> String {\n+    HygieneData::with(|data| {\n+        if verbose {\n+            format!(\"{:#?}\", data)\n+        } else {\n+            let mut s = String::from(\"\");\n+            s.push_str(\"Expansions:\");\n+            data.expn_data.iter().enumerate().for_each(|(id, expn_info)| {\n+                let expn_info = expn_info.as_ref().expect(\"no expansion data for an expansion ID\");\n+                s.push_str(&format!(\n+                    \"\\n{}: parent: {:?}, call_site_ctxt: {:?}, kind: {:?}\",\n+                    id,\n+                    expn_info.parent,\n+                    expn_info.call_site.ctxt(),\n+                    expn_info.kind,\n+                ));\n+            });\n+            s.push_str(\"\\n\\nSyntaxContexts:\");\n+            data.syntax_context_data.iter().enumerate().for_each(|(id, ctxt)| {\n+                s.push_str(&format!(\n+                    \"\\n#{}: parent: {:?}, outer_mark: ({:?}, {:?})\",\n+                    id,\n+                    ctxt.parent,\n+                    ctxt.outer_expn,\n+                    ctxt.outer_transparency,\n+                ));\n+            });\n+            s\n+        }\n+    })\n+}\n+\n impl SyntaxContext {\n     #[inline]\n     pub const fn root() -> Self {"}, {"sha": "1e1e1dbfb3ea58a1a94ff6077c5b5e76d12497c3", "filename": "src/test/pretty/macro.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a8aa5114bf13d9c6b2b870c5bf63eab8e70a0018/src%2Ftest%2Fpretty%2Fmacro.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a8aa5114bf13d9c6b2b870c5bf63eab8e70a0018/src%2Ftest%2Fpretty%2Fmacro.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fpretty%2Fmacro.rs?ref=a8aa5114bf13d9c6b2b870c5bf63eab8e70a0018", "patch": "@@ -2,6 +2,6 @@\n \n #![feature(decl_macro)]\n \n-macro mac { ($ arg : expr) => { $ arg + $ arg } }\n+pub(crate) macro mac { ($ arg : expr) => { $ arg + $ arg } }\n \n fn main() { }"}, {"sha": "6971873ba601e814670599a3c1a234b798d6e211", "filename": "src/test/ui/hygiene/unpretty-debug.stdout", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/a8aa5114bf13d9c6b2b870c5bf63eab8e70a0018/src%2Ftest%2Fui%2Fhygiene%2Funpretty-debug.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/a8aa5114bf13d9c6b2b870c5bf63eab8e70a0018/src%2Ftest%2Fui%2Fhygiene%2Funpretty-debug.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fhygiene%2Funpretty-debug.stdout?ref=a8aa5114bf13d9c6b2b870c5bf63eab8e70a0018", "patch": "@@ -13,3 +13,13 @@ macro_rules! foo /* 0#0 */ { ($ x : ident) => { y + $ x } }\n fn bar /* 0#0 */() { let x /* 0#0 */ = 1; y /* 0#1 */ + x /* 0#0 */ }\n \n fn y /* 0#0 */() { }\n+\n+/*\n+Expansions:\n+0: parent: ExpnId(0), call_site_ctxt: #0, kind: Root\n+1: parent: ExpnId(0), call_site_ctxt: #0, kind: Macro(Bang, foo)\n+\n+SyntaxContexts:\n+#0: parent: #0, outer_mark: (ExpnId(0), Opaque)\n+#1: parent: #0, outer_mark: (ExpnId(1), SemiTransparent)\n+*/"}]}