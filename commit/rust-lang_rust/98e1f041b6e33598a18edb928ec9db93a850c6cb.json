{"sha": "98e1f041b6e33598a18edb928ec9db93a850c6cb", "node_id": "C_kwDOAAsO6NoAKDk4ZTFmMDQxYjZlMzM1OThhMThlZGI5MjhlYzlkYjkzYTg1MGM2Y2I", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-09-11T22:19:24Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-09-11T22:19:24Z"}, "message": "Auto merge of #101442 - joboet:null_check_tcs, r=thomcc\n\nCheck if TCS is a null pointer on SGX\n\nThe `EENTER` instruction only checks if the TCS is aligned, not if it zero. Saying the address returned is a `NonNull<u8>` (for which `Tcs` is a type alias) is unsound. As well-behaved runners will not put the TCS at address zero, so the definition of `Tcs` is correct. However, `std` should check the address before casting it to a `NonNull`.\n\nping `@jethrogb` `@raoulstrackx`\n`@rustbot` label I-unsound", "tree": {"sha": "e75bb7a5a5a60cc124da5fd38839fd366af20ccc", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e75bb7a5a5a60cc124da5fd38839fd366af20ccc"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/98e1f041b6e33598a18edb928ec9db93a850c6cb", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/98e1f041b6e33598a18edb928ec9db93a850c6cb", "html_url": "https://github.com/rust-lang/rust/commit/98e1f041b6e33598a18edb928ec9db93a850c6cb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/98e1f041b6e33598a18edb928ec9db93a850c6cb/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "59e7a308e40fbc6b0901c9a8ee8ed51b17f9e772", "url": "https://api.github.com/repos/rust-lang/rust/commits/59e7a308e40fbc6b0901c9a8ee8ed51b17f9e772", "html_url": "https://github.com/rust-lang/rust/commit/59e7a308e40fbc6b0901c9a8ee8ed51b17f9e772"}, {"sha": "2fa58080cbcdb42bda0438e2d37bdd8a4436a6f4", "url": "https://api.github.com/repos/rust-lang/rust/commits/2fa58080cbcdb42bda0438e2d37bdd8a4436a6f4", "html_url": "https://github.com/rust-lang/rust/commit/2fa58080cbcdb42bda0438e2d37bdd8a4436a6f4"}], "stats": {"total": 8, "additions": 6, "deletions": 2}, "files": [{"sha": "2b23e368cc31a30c82af14fa1ca5130a7aec1f2e", "filename": "library/std/src/sys/sgx/abi/thread.rs", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/98e1f041b6e33598a18edb928ec9db93a850c6cb/library%2Fstd%2Fsrc%2Fsys%2Fsgx%2Fabi%2Fthread.rs", "raw_url": "https://github.com/rust-lang/rust/raw/98e1f041b6e33598a18edb928ec9db93a850c6cb/library%2Fstd%2Fsrc%2Fsys%2Fsgx%2Fabi%2Fthread.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Fsgx%2Fabi%2Fthread.rs?ref=98e1f041b6e33598a18edb928ec9db93a850c6cb", "patch": "@@ -7,7 +7,11 @@ use fortanix_sgx_abi::Tcs;\n #[unstable(feature = \"sgx_platform\", issue = \"56975\")]\n pub fn current() -> Tcs {\n     extern \"C\" {\n-        fn get_tcs_addr() -> Tcs;\n+        fn get_tcs_addr() -> *mut u8;\n+    }\n+    let addr = unsafe { get_tcs_addr() };\n+    match Tcs::new(addr) {\n+        Some(tcs) => tcs,\n+        None => rtabort!(\"TCS must not be placed at address zero (this is a linker error)\"),\n     }\n-    unsafe { get_tcs_addr() }\n }"}]}