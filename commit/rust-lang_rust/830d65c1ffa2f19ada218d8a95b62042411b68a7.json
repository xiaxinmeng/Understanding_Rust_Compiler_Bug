{"sha": "830d65c1ffa2f19ada218d8a95b62042411b68a7", "node_id": "MDY6Q29tbWl0NzI0NzEyOjgzMGQ2NWMxZmZhMmYxOWFkYTIxOGQ4YTk1YjYyMDQyNDExYjY4YTc=", "commit": {"author": {"name": "Mikhail Modin", "email": "mikhailm1@gmail.com", "date": "2017-11-10T11:11:25Z"}, "committer": {"name": "Mikhail Modin", "email": "mikhailm1@gmail.com", "date": "2017-11-15T08:21:05Z"}, "message": "add `StorageDead` handling", "tree": {"sha": "f129fb45a983a806efee7d76f05bdf23d02be0ea", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f129fb45a983a806efee7d76f05bdf23d02be0ea"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/830d65c1ffa2f19ada218d8a95b62042411b68a7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/830d65c1ffa2f19ada218d8a95b62042411b68a7", "html_url": "https://github.com/rust-lang/rust/commit/830d65c1ffa2f19ada218d8a95b62042411b68a7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/830d65c1ffa2f19ada218d8a95b62042411b68a7/comments", "author": {"login": "mikhail-m1", "id": 5663581, "node_id": "MDQ6VXNlcjU2NjM1ODE=", "avatar_url": "https://avatars.githubusercontent.com/u/5663581?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mikhail-m1", "html_url": "https://github.com/mikhail-m1", "followers_url": "https://api.github.com/users/mikhail-m1/followers", "following_url": "https://api.github.com/users/mikhail-m1/following{/other_user}", "gists_url": "https://api.github.com/users/mikhail-m1/gists{/gist_id}", "starred_url": "https://api.github.com/users/mikhail-m1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mikhail-m1/subscriptions", "organizations_url": "https://api.github.com/users/mikhail-m1/orgs", "repos_url": "https://api.github.com/users/mikhail-m1/repos", "events_url": "https://api.github.com/users/mikhail-m1/events{/privacy}", "received_events_url": "https://api.github.com/users/mikhail-m1/received_events", "type": "User", "site_admin": false}, "committer": {"login": "mikhail-m1", "id": 5663581, "node_id": "MDQ6VXNlcjU2NjM1ODE=", "avatar_url": "https://avatars.githubusercontent.com/u/5663581?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mikhail-m1", "html_url": "https://github.com/mikhail-m1", "followers_url": "https://api.github.com/users/mikhail-m1/followers", "following_url": "https://api.github.com/users/mikhail-m1/following{/other_user}", "gists_url": "https://api.github.com/users/mikhail-m1/gists{/gist_id}", "starred_url": "https://api.github.com/users/mikhail-m1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mikhail-m1/subscriptions", "organizations_url": "https://api.github.com/users/mikhail-m1/orgs", "repos_url": "https://api.github.com/users/mikhail-m1/repos", "events_url": "https://api.github.com/users/mikhail-m1/events{/privacy}", "received_events_url": "https://api.github.com/users/mikhail-m1/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f93a4928c2168bcc475b4fe77ba9f9e5494ffe1c", "url": "https://api.github.com/repos/rust-lang/rust/commits/f93a4928c2168bcc475b4fe77ba9f9e5494ffe1c", "html_url": "https://github.com/rust-lang/rust/commit/f93a4928c2168bcc475b4fe77ba9f9e5494ffe1c"}], "stats": {"total": 74, "additions": 59, "deletions": 15}, "files": [{"sha": "7ef9cc6fc3f49f0508c931178dcba2ae6effed72", "filename": "src/librustc_mir/dataflow/drop_flag_effects.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/830d65c1ffa2f19ada218d8a95b62042411b68a7/src%2Flibrustc_mir%2Fdataflow%2Fdrop_flag_effects.rs", "raw_url": "https://github.com/rust-lang/rust/raw/830d65c1ffa2f19ada218d8a95b62042411b68a7/src%2Flibrustc_mir%2Fdataflow%2Fdrop_flag_effects.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fdataflow%2Fdrop_flag_effects.rs?ref=830d65c1ffa2f19ada218d8a95b62042411b68a7", "patch": "@@ -231,8 +231,13 @@ pub(crate) fn drop_flag_effects_for_location<'a, 'gcx, 'tcx, F>(\n                     }\n                 }\n             }\n+            mir::StatementKind::StorageDead(local) => {\n+                on_lookup_result_bits(tcx, mir, move_data,\n+                                      move_data.rev_lookup.find(&mir::Lvalue::Local(local)),\n+                                      |mpi| callback(mpi, DropFlagState::Absent))\n+\n+            }\n             mir::StatementKind::StorageLive(_) |\n-            mir::StatementKind::StorageDead(_) |\n             mir::StatementKind::InlineAsm { .. } |\n             mir::StatementKind::EndRegion(_) |\n             mir::StatementKind::Validate(..) |"}, {"sha": "524f8ffed83f33cafb2f3a03519e8318b7d9082e", "filename": "src/librustc_mir/dataflow/impls/mod.rs", "status": "modified", "additions": 14, "deletions": 7, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/830d65c1ffa2f19ada218d8a95b62042411b68a7/src%2Flibrustc_mir%2Fdataflow%2Fimpls%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/830d65c1ffa2f19ada218d8a95b62042411b68a7/src%2Flibrustc_mir%2Fdataflow%2Fimpls%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fdataflow%2Fimpls%2Fmod.rs?ref=830d65c1ffa2f19ada218d8a95b62042411b68a7", "patch": "@@ -456,14 +456,21 @@ impl<'a, 'gcx, 'tcx> BitDenotation for MovingOutStatements<'a, 'gcx, 'tcx> {\n         let path_map = &move_data.path_map;\n         let rev_lookup = &move_data.rev_lookup;\n \n-        debug!(\"stmt {:?} at loc {:?} moves out of move_indexes {:?}\",\n-               stmt, location, &loc_map[location]);\n-        for move_index in &loc_map[location] {\n-            // Every path deinitialized by a *particular move*\n-            // has corresponding bit, \"gen'ed\" (i.e. set)\n-            // here, in dataflow vector\n-            zero_to_one(sets.gen_set.words_mut(), *move_index);\n+        match stmt.kind {\n+            // skip move out for StorageDead\n+            mir::StatementKind::StorageDead(_) => {}\n+            _ => {\n+                debug!(\"stmt {:?} at loc {:?} moves out of move_indexes {:?}\",\n+                       stmt, location, &loc_map[location]);\n+                for move_index in &loc_map[location] {\n+                    // Every path deinitialized by a *particular move*\n+                    // has corresponding bit, \"gen'ed\" (i.e. set)\n+                    // here, in dataflow vector\n+                    zero_to_one(sets.gen_set.words_mut(), *move_index);\n+                }\n+            }\n         }\n+\n         let bits_per_block = self.bits_per_block();\n         match stmt.kind {\n             mir::StatementKind::SetDiscriminant { .. } => {"}, {"sha": "a0212de605eeee4a7802ef95dba1468bf9dd79a8", "filename": "src/librustc_mir/dataflow/move_paths/builder.rs", "status": "modified", "additions": 9, "deletions": 7, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/830d65c1ffa2f19ada218d8a95b62042411b68a7/src%2Flibrustc_mir%2Fdataflow%2Fmove_paths%2Fbuilder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/830d65c1ffa2f19ada218d8a95b62042411b68a7/src%2Flibrustc_mir%2Fdataflow%2Fmove_paths%2Fbuilder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fdataflow%2Fmove_paths%2Fbuilder.rs?ref=830d65c1ffa2f19ada218d8a95b62042411b68a7", "patch": "@@ -250,8 +250,10 @@ impl<'b, 'a, 'gcx, 'tcx> Gatherer<'b, 'a, 'gcx, 'tcx> {\n                 }\n                 self.gather_rvalue(rval);\n             }\n-            StatementKind::StorageLive(_) |\n-            StatementKind::StorageDead(_) => {}\n+            StatementKind::StorageLive(_) => {}\n+            StatementKind::StorageDead(local) => {\n+                self.gather_move(&Lvalue::Local(local), true);\n+            }\n             StatementKind::SetDiscriminant{ .. } => {\n                 span_bug!(stmt.source_info.span,\n                           \"SetDiscriminant should not exist during borrowck\");\n@@ -309,7 +311,7 @@ impl<'b, 'a, 'gcx, 'tcx> Gatherer<'b, 'a, 'gcx, 'tcx> {\n             TerminatorKind::Unreachable => { }\n \n             TerminatorKind::Return => {\n-                self.gather_move(&Lvalue::Local(RETURN_POINTER));\n+                self.gather_move(&Lvalue::Local(RETURN_POINTER), false);\n             }\n \n             TerminatorKind::Assert { .. } |\n@@ -322,7 +324,7 @@ impl<'b, 'a, 'gcx, 'tcx> Gatherer<'b, 'a, 'gcx, 'tcx> {\n             }\n \n             TerminatorKind::Drop { ref location, target: _, unwind: _ } => {\n-                self.gather_move(location);\n+                self.gather_move(location, false);\n             }\n             TerminatorKind::DropAndReplace { ref location, ref value, .. } => {\n                 self.create_move_path(location);\n@@ -344,19 +346,19 @@ impl<'b, 'a, 'gcx, 'tcx> Gatherer<'b, 'a, 'gcx, 'tcx> {\n         match *operand {\n             Operand::Constant(..) => {} // not-a-move\n             Operand::Consume(ref lval) => { // a move\n-                self.gather_move(lval);\n+                self.gather_move(lval, false);\n             }\n         }\n     }\n \n-    fn gather_move(&mut self, lval: &Lvalue<'tcx>) {\n+    fn gather_move(&mut self, lval: &Lvalue<'tcx>, force: bool) {\n         debug!(\"gather_move({:?}, {:?})\", self.loc, lval);\n \n         let tcx = self.builder.tcx;\n         let gcx = tcx.global_tcx();\n         let lv_ty = lval.ty(self.builder.mir, tcx).to_ty(tcx);\n         let erased_ty = gcx.lift(&tcx.erase_regions(&lv_ty)).unwrap();\n-        if !erased_ty.moves_by_default(gcx, self.builder.param_env, DUMMY_SP) {\n+        if !force && !erased_ty.moves_by_default(gcx, self.builder.param_env, DUMMY_SP) {\n             debug!(\"gather_move({:?}, {:?}) - {:?} is Copy. skipping\", self.loc, lval, lv_ty);\n             return\n         }"}, {"sha": "5ef502acd8113234e39c5b3ce89d792cb8cc4458", "filename": "src/test/compile-fail/borrowck/borrowck-storage-dead.rs", "status": "added", "additions": 30, "deletions": 0, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/830d65c1ffa2f19ada218d8a95b62042411b68a7/src%2Ftest%2Fcompile-fail%2Fborrowck%2Fborrowck-storage-dead.rs", "raw_url": "https://github.com/rust-lang/rust/raw/830d65c1ffa2f19ada218d8a95b62042411b68a7/src%2Ftest%2Fcompile-fail%2Fborrowck%2Fborrowck-storage-dead.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fborrowck%2Fborrowck-storage-dead.rs?ref=830d65c1ffa2f19ada218d8a95b62042411b68a7", "patch": "@@ -0,0 +1,30 @@\n+// Copyright 2012 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// compile-flags: -Z emit-end-regions -Z borrowck-mir\n+\n+fn ok() {\n+    loop {\n+        let _x = 1;\n+    }\n+}\n+\n+fn fail() {\n+    loop {\n+        let x: i32;\n+        let _ = x + 1; //~ERROR (Ast) [E0381]\n+                       //~^ ERROR (Mir) [E0381]\n+    }\n+}\n+\n+fn main() {\n+    ok();\n+    fail();\n+}"}]}