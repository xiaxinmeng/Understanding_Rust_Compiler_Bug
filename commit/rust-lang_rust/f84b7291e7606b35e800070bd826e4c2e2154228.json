{"sha": "f84b7291e7606b35e800070bd826e4c2e2154228", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY4NGI3MjkxZTc2MDZiMzVlODAwMDcwYmQ4MjZlNGMyZTIxNTQyMjg=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-01-29T23:01:43Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-01-29T23:01:43Z"}, "message": "auto merge of #11776 : FlaPer87/rust/issue-11681-static-lifetime, r=nikomatsakis\n\nCloses #11681\r\nCloses #11854", "tree": {"sha": "67f40e6c5c50e61f732ba45b6a70f14cb78e72e7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/67f40e6c5c50e61f732ba45b6a70f14cb78e72e7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f84b7291e7606b35e800070bd826e4c2e2154228", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f84b7291e7606b35e800070bd826e4c2e2154228", "html_url": "https://github.com/rust-lang/rust/commit/f84b7291e7606b35e800070bd826e4c2e2154228", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f84b7291e7606b35e800070bd826e4c2e2154228/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1e23c5c051c5a106b3143ca78e4f97e2c438285b", "url": "https://api.github.com/repos/rust-lang/rust/commits/1e23c5c051c5a106b3143ca78e4f97e2c438285b", "html_url": "https://github.com/rust-lang/rust/commit/1e23c5c051c5a106b3143ca78e4f97e2c438285b"}, {"sha": "cb5d7236f14209209e637e475bcefece935a6b56", "url": "https://api.github.com/repos/rust-lang/rust/commits/cb5d7236f14209209e637e475bcefece935a6b56", "html_url": "https://github.com/rust-lang/rust/commit/cb5d7236f14209209e637e475bcefece935a6b56"}], "stats": {"total": 90, "additions": 69, "deletions": 21}, "files": [{"sha": "ce1840283b2e4e3691c7f373dbeee6cc70159b8d", "filename": "src/librustc/middle/mem_categorization.rs", "status": "modified", "additions": 19, "deletions": 17, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/f84b7291e7606b35e800070bd826e4c2e2154228/src%2Flibrustc%2Fmiddle%2Fmem_categorization.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f84b7291e7606b35e800070bd826e4c2e2154228/src%2Flibrustc%2Fmiddle%2Fmem_categorization.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fmem_categorization.rs?ref=f84b7291e7606b35e800070bd826e4c2e2154228", "patch": "@@ -356,7 +356,7 @@ impl mem_categorization_ctxt {\n                         // Convert a bare fn to a closure by adding NULL env.\n                         // Result is an rvalue.\n                         let expr_ty = ty::expr_ty_adjusted(self.tcx, expr);\n-                        self.cat_rvalue_node(expr, expr_ty)\n+                        self.cat_rvalue_node(expr.id(), expr.span(), expr_ty)\n                     }\n \n                     ty::AutoDerefRef(ty::AutoDerefRef {\n@@ -365,7 +365,7 @@ impl mem_categorization_ctxt {\n                         // Equivalent to &*expr or something similar.\n                         // Result is an rvalue.\n                         let expr_ty = ty::expr_ty_adjusted(self.tcx, expr);\n-                        self.cat_rvalue_node(expr, expr_ty)\n+                        self.cat_rvalue_node(expr.id(), expr.span(), expr_ty)\n                     }\n \n                     ty::AutoDerefRef(ty::AutoDerefRef {\n@@ -398,7 +398,7 @@ impl mem_categorization_ctxt {\n           ast::ExprUnary(_, ast::UnDeref, e_base) => {\n             let method_map = self.method_map.borrow();\n             if method_map.get().contains_key(&expr.id) {\n-                return self.cat_rvalue_node(expr, expr_ty);\n+                return self.cat_rvalue_node(expr.id(), expr.span(), expr_ty);\n             }\n \n             let base_cmt = self.cat_expr(e_base);\n@@ -418,7 +418,7 @@ impl mem_categorization_ctxt {\n           ast::ExprIndex(_, base, _) => {\n             let method_map = self.method_map.borrow();\n             if method_map.get().contains_key(&expr.id) {\n-                return self.cat_rvalue_node(expr, expr_ty);\n+                return self.cat_rvalue_node(expr.id(), expr.span(), expr_ty);\n             }\n \n             let base_cmt = self.cat_expr(base);\n@@ -444,7 +444,7 @@ impl mem_categorization_ctxt {\n           ast::ExprLit(..) | ast::ExprBreak(..) | ast::ExprMac(..) |\n           ast::ExprAgain(..) | ast::ExprStruct(..) | ast::ExprRepeat(..) |\n           ast::ExprInlineAsm(..) | ast::ExprBox(..) => {\n-            return self.cat_rvalue_node(expr, expr_ty);\n+            return self.cat_rvalue_node(expr.id(), expr.span(), expr_ty);\n           }\n \n           ast::ExprForLoop(..) => fail!(\"non-desugared expr_for_loop\")\n@@ -457,13 +457,18 @@ impl mem_categorization_ctxt {\n                    expr_ty: ty::t,\n                    def: ast::Def)\n                    -> cmt {\n+        debug!(\"cat_def: id={} expr={}\",\n+               id, ty_to_str(self.tcx, expr_ty));\n+\n+\n         match def {\n+          ast::DefStruct(..) | ast::DefVariant(..) => {\n+                self.cat_rvalue_node(id, span, expr_ty)\n+          }\n           ast::DefFn(..) | ast::DefStaticMethod(..) | ast::DefMod(_) |\n           ast::DefForeignMod(_) | ast::DefStatic(_, false) |\n-          ast::DefUse(_) | ast::DefVariant(..) |\n-          ast::DefTrait(_) | ast::DefTy(_) | ast::DefPrimTy(_) |\n-          ast::DefTyParam(..) | ast::DefStruct(..) |\n-          ast::DefTyParamBinder(..) | ast::DefRegion(_) |\n+          ast::DefUse(_) | ast::DefTrait(_) | ast::DefTy(_) | ast::DefPrimTy(_) |\n+          ast::DefTyParam(..) | ast::DefTyParamBinder(..) | ast::DefRegion(_) |\n           ast::DefLabel(_) | ast::DefSelfTy(..) | ast::DefMethod(..) => {\n               @cmt_ {\n                   id:id,\n@@ -571,16 +576,13 @@ impl mem_categorization_ctxt {\n         }\n     }\n \n-    pub fn cat_rvalue_node<N:ast_node>(&self,\n-                                       node: &N,\n-                                       expr_ty: ty::t) -> cmt {\n-        match self.tcx.region_maps.temporary_scope(node.id()) {\n+    pub fn cat_rvalue_node(&self, id: ast::NodeId, span: Span, expr_ty: ty::t) -> cmt {\n+        match self.tcx.region_maps.temporary_scope(id) {\n             Some(scope) => {\n-                self.cat_rvalue(node.id(), node.span(),\n-                                ty::ReScope(scope), expr_ty)\n+                self.cat_rvalue(id, span, ty::ReScope(scope), expr_ty)\n             }\n             None => {\n-                self.cat_rvalue(node.id(), node.span(), ty::ReStatic, expr_ty)\n+                self.cat_rvalue(id, span, ty::ReStatic, expr_ty)\n             }\n         }\n     }\n@@ -986,7 +988,7 @@ impl mem_categorization_ctxt {\n               }\n               for &slice_pat in slice.iter() {\n                   let slice_ty = self.pat_ty(slice_pat);\n-                  let slice_cmt = self.cat_rvalue_node(pat, slice_ty);\n+                  let slice_cmt = self.cat_rvalue_node(pat.id(), pat.span(), slice_ty);\n                   self.cat_pattern(slice_cmt, slice_pat, |x,y| op(x,y));\n               }\n               for &after_pat in after.iter() {"}, {"sha": "9c11b89bb7e7ddcbfb7eb67bbfca34b2c93b5502", "filename": "src/librustc/middle/region.rs", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/f84b7291e7606b35e800070bd826e4c2e2154228/src%2Flibrustc%2Fmiddle%2Fregion.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f84b7291e7606b35e800070bd826e4c2e2154228/src%2Flibrustc%2Fmiddle%2Fregion.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fregion.rs?ref=f84b7291e7606b35e800070bd826e4c2e2154228", "patch": "@@ -172,7 +172,14 @@ impl RegionMaps {\n         }\n \n         // else, locate the innermost terminating scope\n-        let mut id = self.encl_scope(expr_id);\n+        // if there's one. Static items, for instance, won't\n+        // have an enclusing scope, hence no scope will be\n+        // returned.\n+        let mut id = match self.opt_encl_scope(expr_id) {\n+            Some(i) => i,\n+            None => { return None; }\n+        };\n+\n         let terminating_scopes = self.terminating_scopes.borrow();\n         while !terminating_scopes.get().contains(&id) {\n             match self.opt_encl_scope(id) {"}, {"sha": "c266952f08f0871f17a5e989029645ff9aeb1059", "filename": "src/test/compile-fail/regions-lifetime-of-struct-or-enum-variant.rs", "status": "added", "additions": 32, "deletions": 0, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/f84b7291e7606b35e800070bd826e4c2e2154228/src%2Ftest%2Fcompile-fail%2Fregions-lifetime-of-struct-or-enum-variant.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f84b7291e7606b35e800070bd826e4c2e2154228/src%2Ftest%2Fcompile-fail%2Fregions-lifetime-of-struct-or-enum-variant.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fregions-lifetime-of-struct-or-enum-variant.rs?ref=f84b7291e7606b35e800070bd826e4c2e2154228", "patch": "@@ -0,0 +1,32 @@\n+// Copyright 2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// This tests verifies that unary structs and enum variants\n+// are treated as rvalues and their lifetime is not bounded to\n+// the static scope.\n+\n+struct Test;\n+\n+enum MyEnum {\n+    Variant1\n+}\n+\n+fn structLifetime() -> &Test {\n+  let testValue = &Test; //~ ERROR borrowed value does not live long enough\n+  testValue\n+}\n+\n+fn variantLifetime() -> &MyEnum {\n+  let testValue = &Variant1; //~ ERROR borrowed value does not live long enough\n+  testValue\n+}\n+\n+\n+fn main() {}"}, {"sha": "e20717553c4c48618683bb098c922f8e6dc041ff", "filename": "src/test/run-pass/regions-lifetime-static-items-enclosing-scopes.rs", "status": "renamed", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/f84b7291e7606b35e800070bd826e4c2e2154228/src%2Ftest%2Frun-pass%2Fregions-lifetime-static-items-enclosing-scopes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f84b7291e7606b35e800070bd826e4c2e2154228/src%2Ftest%2Frun-pass%2Fregions-lifetime-static-items-enclosing-scopes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fregions-lifetime-static-items-enclosing-scopes.rs?ref=f84b7291e7606b35e800070bd826e4c2e2154228", "patch": "@@ -1,4 +1,4 @@\n-// Copyright 2012 The Rust Project Developers. See the COPYRIGHT\n+// Copyright 2014 The Rust Project Developers. See the COPYRIGHT\n // file at the top-level directory of this distribution and at\n // http://rust-lang.org/COPYRIGHT.\n //\n@@ -8,14 +8,21 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n+// This test verifies that temporary lifetime is correctly computed\n+// for static objects in enclosing scopes.\n+\n extern mod extra;\n use std::cmp::Eq;\n \n fn f<T:Eq>(o: &mut Option<T>) {\n     assert!(*o == None);\n }\n \n-fn main() {\n+pub fn main() {\n+    mod t {\n+        enum E {V=1, A=0}\n+        static C: E = V;\n+    }\n+\n     f::<int>(&mut None);\n-    //~^ ERROR cannot borrow\n }", "previous_filename": "src/test/compile-fail/issue-511.rs"}]}