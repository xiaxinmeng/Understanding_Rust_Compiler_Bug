{"sha": "39b57115fbf5d91df3382699b1dbde7ea8716f6c", "node_id": "MDY6Q29tbWl0NzI0NzEyOjM5YjU3MTE1ZmJmNWQ5MWRmMzM4MjY5OWIxZGJkZTdlYTg3MTZmNmM=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2014-12-09T17:24:39Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2014-12-09T17:24:39Z"}, "message": "rollup merge of #19577: aidancully/master\n\npthread_key_create can be 0.\naddresses issue #19567.", "tree": {"sha": "87f8e467e4a237bd9e95bd710d2fa93103d91338", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/87f8e467e4a237bd9e95bd710d2fa93103d91338"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/39b57115fbf5d91df3382699b1dbde7ea8716f6c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/39b57115fbf5d91df3382699b1dbde7ea8716f6c", "html_url": "https://github.com/rust-lang/rust/commit/39b57115fbf5d91df3382699b1dbde7ea8716f6c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/39b57115fbf5d91df3382699b1dbde7ea8716f6c/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a09632f7cb19d0fc6526cc6e4f514472809f24ac", "url": "https://api.github.com/repos/rust-lang/rust/commits/a09632f7cb19d0fc6526cc6e4f514472809f24ac", "html_url": "https://github.com/rust-lang/rust/commit/a09632f7cb19d0fc6526cc6e4f514472809f24ac"}, {"sha": "c394a6c238a2e981f9092e142029ec5b465c1dcd", "url": "https://api.github.com/repos/rust-lang/rust/commits/c394a6c238a2e981f9092e142029ec5b465c1dcd", "html_url": "https://github.com/rust-lang/rust/commit/c394a6c238a2e981f9092e142029ec5b465c1dcd"}], "stats": {"total": 18, "additions": 17, "deletions": 1}, "files": [{"sha": "3eb0e3f46cb90e81cdb229ecb0251e18ad5d291b", "filename": "src/libstd/sys/common/thread_local.rs", "status": "modified", "additions": 17, "deletions": 1, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/39b57115fbf5d91df3382699b1dbde7ea8716f6c/src%2Flibstd%2Fsys%2Fcommon%2Fthread_local.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39b57115fbf5d91df3382699b1dbde7ea8716f6c/src%2Flibstd%2Fsys%2Fcommon%2Fthread_local.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Fcommon%2Fthread_local.rs?ref=39b57115fbf5d91df3382699b1dbde7ea8716f6c", "patch": "@@ -185,7 +185,23 @@ impl StaticKey {\n     }\n \n     unsafe fn lazy_init(&self) -> uint {\n-        let key = imp::create(self.dtor);\n+        // POSIX allows the key created here to be 0, but the compare_and_swap\n+        // below relies on using 0 as a sentinel value to check who won the\n+        // race to set the shared TLS key. As far as I know, there is no\n+        // guaranteed value that cannot be returned as a posix_key_create key,\n+        // so there is no value we can initialize the inner key with to\n+        // prove that it has not yet been set. As such, we'll continue using a\n+        // value of 0, but with some gyrations to make sure we have a non-0\n+        // value returned from the creation routine.\n+        // FIXME: this is clearly a hack, and should be cleaned up.\n+        let key1 = imp::create(self.dtor);\n+        let key = if key1 != 0 {\n+            key1\n+        } else {\n+            let key2 = imp::create(self.dtor);\n+            imp::destroy(key1);\n+            key2\n+        };\n         assert!(key != 0);\n         match self.inner.key.compare_and_swap(0, key as uint, atomic::SeqCst) {\n             // The CAS succeeded, so we've created the actual key"}]}