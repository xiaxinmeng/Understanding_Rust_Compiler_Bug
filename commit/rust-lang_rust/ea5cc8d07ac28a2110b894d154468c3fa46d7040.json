{"sha": "ea5cc8d07ac28a2110b894d154468c3fa46d7040", "node_id": "MDY6Q29tbWl0NzI0NzEyOmVhNWNjOGQwN2FjMjhhMjExMGI4OTRkMTU0NDY4YzNmYTQ2ZDcwNDA=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2020-12-19T00:09:48Z"}, "committer": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2020-12-19T00:10:56Z"}, "message": "More accurate `#[derive]` parsing\n\nThis now allows full paths to the derive macro", "tree": {"sha": "d03e228616092a32a75c7c8af624d4e9c7f7fb2f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d03e228616092a32a75c7c8af624d4e9c7f7fb2f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ea5cc8d07ac28a2110b894d154468c3fa46d7040", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ea5cc8d07ac28a2110b894d154468c3fa46d7040", "html_url": "https://github.com/rust-lang/rust/commit/ea5cc8d07ac28a2110b894d154468c3fa46d7040", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ea5cc8d07ac28a2110b894d154468c3fa46d7040/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c7b7c37ea5f25806d8c523e309b7ee9be27f2cde", "url": "https://api.github.com/repos/rust-lang/rust/commits/c7b7c37ea5f25806d8c523e309b7ee9be27f2cde", "html_url": "https://github.com/rust-lang/rust/commit/c7b7c37ea5f25806d8c523e309b7ee9be27f2cde"}], "stats": {"total": 87, "additions": 60, "deletions": 27}, "files": [{"sha": "18525406c92a810e0a196b460af20ecff303e7ad", "filename": "crates/hir_def/src/attr.rs", "status": "modified", "additions": 43, "deletions": 3, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/ea5cc8d07ac28a2110b894d154468c3fa46d7040/crates%2Fhir_def%2Fsrc%2Fattr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ea5cc8d07ac28a2110b894d154468c3fa46d7040/crates%2Fhir_def%2Fsrc%2Fattr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fattr.rs?ref=ea5cc8d07ac28a2110b894d154468c3fa46d7040", "patch": "@@ -5,7 +5,7 @@ use std::{ops, sync::Arc};\n use base_db::CrateId;\n use cfg::{CfgExpr, CfgOptions};\n use either::Either;\n-use hir_expand::{hygiene::Hygiene, AstId, InFile};\n+use hir_expand::{hygiene::Hygiene, name::AsName, AstId, InFile};\n use itertools::Itertools;\n use mbe::ast_to_token_tree;\n use syntax::{\n@@ -19,7 +19,7 @@ use crate::{\n     db::DefDatabase,\n     item_tree::{ItemTreeId, ItemTreeNode},\n     nameres::ModuleSource,\n-    path::ModPath,\n+    path::{ModPath, PathKind},\n     src::HasChildSource,\n     AdtId, AttrDefId, Lookup,\n };\n@@ -357,6 +357,46 @@ impl Attr {\n         };\n         Some(Attr { path, input })\n     }\n+\n+    /// Parses this attribute as a `#[derive]`, returns an iterator that yields all contained paths\n+    /// to derive macros.\n+    ///\n+    /// Returns `None` when the attribute is not a well-formed `#[derive]` attribute.\n+    pub(crate) fn parse_derive(&self) -> Option<impl Iterator<Item = ModPath>> {\n+        if self.path.as_ident() != Some(&hir_expand::name![derive]) {\n+            return None;\n+        }\n+\n+        match &self.input {\n+            Some(AttrInput::TokenTree(args)) => {\n+                let mut counter = 0;\n+                let paths = args\n+                    .token_trees\n+                    .iter()\n+                    .group_by(move |tt| {\n+                        match tt {\n+                            tt::TokenTree::Leaf(tt::Leaf::Punct(p)) if p.char == ',' => {\n+                                counter += 1;\n+                            }\n+                            _ => {}\n+                        }\n+                        counter\n+                    })\n+                    .into_iter()\n+                    .map(|(_, tts)| {\n+                        let segments = tts.filter_map(|tt| match tt {\n+                            tt::TokenTree::Leaf(tt::Leaf::Ident(id)) => Some(id.as_name()),\n+                            _ => None,\n+                        });\n+                        ModPath::from_segments(PathKind::Plain, segments)\n+                    })\n+                    .collect::<Vec<_>>();\n+\n+                Some(paths.into_iter())\n+            }\n+            _ => None,\n+        }\n+    }\n }\n \n #[derive(Debug, Clone, Copy)]\n@@ -384,7 +424,7 @@ impl<'a> AttrQuery<'a> {\n         self.attrs().next().is_some()\n     }\n \n-    fn attrs(self) -> impl Iterator<Item = &'a Attr> {\n+    pub(crate) fn attrs(self) -> impl Iterator<Item = &'a Attr> {\n         let key = self.key;\n         self.attrs\n             .iter()"}, {"sha": "a636ec77d71b9dac4f7c4a5e3cf84f5d24e5a291", "filename": "crates/hir_def/src/nameres/collector.rs", "status": "modified", "additions": 14, "deletions": 14, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/ea5cc8d07ac28a2110b894d154468c3fa46d7040/crates%2Fhir_def%2Fsrc%2Fnameres%2Fcollector.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ea5cc8d07ac28a2110b894d154468c3fa46d7040/crates%2Fhir_def%2Fsrc%2Fnameres%2Fcollector.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fnameres%2Fcollector.rs?ref=ea5cc8d07ac28a2110b894d154468c3fa46d7040", "patch": "@@ -1289,20 +1289,20 @@ impl ModCollector<'_, '_> {\n     }\n \n     fn collect_derives(&mut self, attrs: &Attrs, ast_id: FileAstId<ast::Item>) {\n-        for derive_subtree in attrs.by_key(\"derive\").tt_values() {\n-            // for #[derive(Copy, Clone)], `derive_subtree` is the `(Copy, Clone)` subtree\n-            for tt in &derive_subtree.token_trees {\n-                let ident = match &tt {\n-                    tt::TokenTree::Leaf(tt::Leaf::Ident(ident)) => ident,\n-                    tt::TokenTree::Leaf(tt::Leaf::Punct(_)) => continue, // , is ok\n-                    _ => continue, // anything else would be an error (which we currently ignore)\n-                };\n-                let path = ModPath::from_tt_ident(ident);\n-\n-                let ast_id = AstIdWithPath::new(self.file_id, ast_id, path);\n-                self.def_collector\n-                    .unexpanded_attribute_macros\n-                    .push(DeriveDirective { module_id: self.module_id, ast_id });\n+        for derive in attrs.by_key(\"derive\").attrs() {\n+            match derive.parse_derive() {\n+                Some(derive_macros) => {\n+                    for path in derive_macros {\n+                        let ast_id = AstIdWithPath::new(self.file_id, ast_id, path);\n+                        self.def_collector\n+                            .unexpanded_attribute_macros\n+                            .push(DeriveDirective { module_id: self.module_id, ast_id });\n+                    }\n+                }\n+                None => {\n+                    // FIXME: diagnose\n+                    log::debug!(\"malformed derive: {:?}\", derive);\n+                }\n             }\n         }\n     }"}, {"sha": "e2bf85bbc3a145080d5e15c02959275bb6a66e38", "filename": "crates/hir_def/src/path.rs", "status": "modified", "additions": 2, "deletions": 10, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/ea5cc8d07ac28a2110b894d154468c3fa46d7040/crates%2Fhir_def%2Fsrc%2Fpath.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ea5cc8d07ac28a2110b894d154468c3fa46d7040/crates%2Fhir_def%2Fsrc%2Fpath.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fpath.rs?ref=ea5cc8d07ac28a2110b894d154468c3fa46d7040", "patch": "@@ -9,11 +9,8 @@ use std::{\n \n use crate::{body::LowerCtx, type_ref::LifetimeRef};\n use base_db::CrateId;\n-use hir_expand::{\n-    hygiene::Hygiene,\n-    name::{AsName, Name},\n-};\n-use syntax::ast::{self};\n+use hir_expand::{hygiene::Hygiene, name::Name};\n+use syntax::ast;\n \n use crate::{\n     type_ref::{TypeBound, TypeRef},\n@@ -56,11 +53,6 @@ impl ModPath {\n         ModPath { kind, segments }\n     }\n \n-    /// Converts an `tt::Ident` into a single-identifier `Path`.\n-    pub(crate) fn from_tt_ident(ident: &tt::Ident) -> ModPath {\n-        ident.as_name().into()\n-    }\n-\n     /// Calls `cb` with all paths, represented by this use item.\n     pub(crate) fn expand_use_item(\n         item_src: InFile<ast::Use>,"}, {"sha": "2f44876a8a3c382320363705d67dda4d821c0458", "filename": "crates/hir_expand/src/name.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/ea5cc8d07ac28a2110b894d154468c3fa46d7040/crates%2Fhir_expand%2Fsrc%2Fname.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ea5cc8d07ac28a2110b894d154468c3fa46d7040/crates%2Fhir_expand%2Fsrc%2Fname.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_expand%2Fsrc%2Fname.rs?ref=ea5cc8d07ac28a2110b894d154468c3fa46d7040", "patch": "@@ -152,6 +152,7 @@ pub mod known {\n         str,\n         // Special names\n         macro_rules,\n+        derive,\n         doc,\n         cfg_attr,\n         // Components of known path (value or mod name)"}]}