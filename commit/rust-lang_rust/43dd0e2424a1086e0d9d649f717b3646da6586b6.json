{"sha": "43dd0e2424a1086e0d9d649f717b3646da6586b6", "node_id": "C_kwDOAAsO6NoAKDQzZGQwZTI0MjRhMTA4NmUwZDlkNjQ5ZjcxN2IzNjQ2ZGE2NTg2YjY", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-06-27T06:06:46Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-06-27T06:06:46Z"}, "message": "Rollup merge of #97780 - compiler-errors:field-wfcheck-before-sized, r=jackh726\n\nCheck ADT field is well-formed before checking it is sized\n\nFixes #96810.\n\nThere is one diagnostics regression, in [`src/test/ui/generic-associated-types/bugs/issue-80626.stderr`](https://github.com/rust-lang/rust/pull/97780/files#diff-53795946378e78a0af23a10277c628ff79091c18090fdc385801ee70c1ba6963). I am not super concerned about it, since it's GAT related.\nWe _could_ fix it, possibly by using the `FieldSized` obligation cause code instead of `BuiltinDerivedObligation`. But that would require changing `Sized` trait confirmation and the `adt_sized_constraint` query.", "tree": {"sha": "921c85bf70f40a09829523d678cded26ad5ab950", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/921c85bf70f40a09829523d678cded26ad5ab950"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/43dd0e2424a1086e0d9d649f717b3646da6586b6", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJiuUj3CRBK7hj4Ov3rIwAAnsAIAGB3Ke4o386or0iqgKyOQV5d\nGAd2AX7JcW8yDLIpjVtp3fz+/Z2+OLQ5MLFjownL95jAb0SqmXx9EWzPeElwj1s3\nzR+A6vPGKaF3mG0AeR/xB0ULBZJMkJQDL80Qhr+2JyeL885uDQ36ORFc4CiCj2rS\nl/BCxDG3BdGaphSRp6pk0sy4h+K8xpAoUaH0YFXnt2eLR6m6iXWVvB1ieGcJYrpi\njLOAuqE/OjQ4FgS1AFL7pWCWD5MUaiVkAOpaRZfeTHFKkbRRdii4YYuqePWFUv/H\nBp+kDU7jW6BtB82V054QiMKbpAfOrk50giDQzvKSEEI3oBpgPn86QPKPtRI+MLc=\n=kbx4\n-----END PGP SIGNATURE-----\n", "payload": "tree 921c85bf70f40a09829523d678cded26ad5ab950\nparent 3694e40ffa55d65cb72148570f0fcab311741586\nparent c1f4f980f4706365d56136f8761537f8e9b56bb4\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1656310006 +0200\ncommitter GitHub <noreply@github.com> 1656310006 +0200\n\nRollup merge of #97780 - compiler-errors:field-wfcheck-before-sized, r=jackh726\n\nCheck ADT field is well-formed before checking it is sized\n\nFixes #96810.\n\nThere is one diagnostics regression, in [`src/test/ui/generic-associated-types/bugs/issue-80626.stderr`](https://github.com/rust-lang/rust/pull/97780/files#diff-53795946378e78a0af23a10277c628ff79091c18090fdc385801ee70c1ba6963). I am not super concerned about it, since it's GAT related.\nWe _could_ fix it, possibly by using the `FieldSized` obligation cause code instead of `BuiltinDerivedObligation`. But that would require changing `Sized` trait confirmation and the `adt_sized_constraint` query.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/43dd0e2424a1086e0d9d649f717b3646da6586b6", "html_url": "https://github.com/rust-lang/rust/commit/43dd0e2424a1086e0d9d649f717b3646da6586b6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/43dd0e2424a1086e0d9d649f717b3646da6586b6/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3694e40ffa55d65cb72148570f0fcab311741586", "url": "https://api.github.com/repos/rust-lang/rust/commits/3694e40ffa55d65cb72148570f0fcab311741586", "html_url": "https://github.com/rust-lang/rust/commit/3694e40ffa55d65cb72148570f0fcab311741586"}, {"sha": "c1f4f980f4706365d56136f8761537f8e9b56bb4", "url": "https://api.github.com/repos/rust-lang/rust/commits/c1f4f980f4706365d56136f8761537f8e9b56bb4", "html_url": "https://github.com/rust-lang/rust/commit/c1f4f980f4706365d56136f8761537f8e9b56bb4"}], "stats": {"total": 85, "additions": 51, "deletions": 34}, "files": [{"sha": "94ec89776a9582100ea2a6dabd38039a67eae050", "filename": "compiler/rustc_middle/src/traits/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/43dd0e2424a1086e0d9d649f717b3646da6586b6/compiler%2Frustc_middle%2Fsrc%2Ftraits%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/43dd0e2424a1086e0d9d649f717b3646da6586b6/compiler%2Frustc_middle%2Fsrc%2Ftraits%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Ftraits%2Fmod.rs?ref=43dd0e2424a1086e0d9d649f717b3646da6586b6", "patch": "@@ -406,7 +406,7 @@ pub enum ObligationCauseCode<'tcx> {\n     QuestionMark,\n \n     /// Well-formed checking. If a `WellFormedLoc` is provided,\n-    /// then it will be used to eprform HIR-based wf checking\n+    /// then it will be used to perform HIR-based wf checking\n     /// after an error occurs, in order to generate a more precise error span.\n     /// This is purely for diagnostic purposes - it is always\n     /// correct to use `MiscObligation` instead, or to specify"}, {"sha": "e78d58dc2109983b26d6d86aa7b94469e8c02d20", "filename": "compiler/rustc_typeck/src/check/wfcheck.rs", "status": "modified", "additions": 10, "deletions": 9, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/43dd0e2424a1086e0d9d649f717b3646da6586b6/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fwfcheck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/43dd0e2424a1086e0d9d649f717b3646da6586b6/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fwfcheck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fwfcheck.rs?ref=43dd0e2424a1086e0d9d649f717b3646da6586b6", "patch": "@@ -990,6 +990,15 @@ fn check_type_defn<'tcx, F>(\n         let packed = tcx.adt_def(item.def_id).repr().packed();\n \n         for variant in &variants {\n+            // All field types must be well-formed.\n+            for field in &variant.fields {\n+                fcx.register_wf_obligation(\n+                    field.ty.into(),\n+                    field.span,\n+                    ObligationCauseCode::WellFormed(Some(WellFormedLoc::Ty(field.def_id))),\n+                )\n+            }\n+\n             // For DST, or when drop needs to copy things around, all\n             // intermediate types must be sized.\n             let needs_drop_copy = || {\n@@ -1006,6 +1015,7 @@ fn check_type_defn<'tcx, F>(\n                     }\n                 }\n             };\n+            // All fields (except for possibly the last) should be sized.\n             let all_sized = all_sized || variant.fields.is_empty() || needs_drop_copy();\n             let unsized_len = if all_sized { 0 } else { 1 };\n             for (idx, field) in\n@@ -1030,15 +1040,6 @@ fn check_type_defn<'tcx, F>(\n                 );\n             }\n \n-            // All field types must be well-formed.\n-            for field in &variant.fields {\n-                fcx.register_wf_obligation(\n-                    field.ty.into(),\n-                    field.span,\n-                    ObligationCauseCode::WellFormed(Some(WellFormedLoc::Ty(field.def_id))),\n-                )\n-            }\n-\n             // Explicit `enum` discriminant values must const-evaluate successfully.\n             if let Some(discr_def_id) = variant.explicit_discr {\n                 let discr_substs = InternalSubsts::identity_for_item(tcx, discr_def_id.to_def_id());"}, {"sha": "487b83dfa3fccc5dd925bd1290145aa8a3152598", "filename": "src/test/ui/generic-associated-types/bugs/issue-80626.stderr", "status": "modified", "additions": 4, "deletions": 9, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/43dd0e2424a1086e0d9d649f717b3646da6586b6/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fbugs%2Fissue-80626.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/43dd0e2424a1086e0d9d649f717b3646da6586b6/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fbugs%2Fissue-80626.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fbugs%2Fissue-80626.stderr?ref=43dd0e2424a1086e0d9d649f717b3646da6586b6", "patch": "@@ -4,16 +4,11 @@ error[E0275]: overflow evaluating the requirement `LinkedList<A>: Sized`\n LL |     Next(A::Allocated<Self>)\n    |          ^^^^^^^^^^^^^^^^^^\n    |\n-   = note: no field of an enum variant may have a dynamically sized type\n-   = help: change the field's type to have a statically known size\n-help: borrowed types always have a statically known size\n+note: required by a bound in `Allocator::Allocated`\n+  --> $DIR/issue-80626.rs:9:20\n    |\n-LL |     Next(&A::Allocated<Self>)\n-   |          +\n-help: the `Box` type always has a statically known size and allocates its contents in the heap\n-   |\n-LL |     Next(Box<A::Allocated<Self>>)\n-   |          ++++                  +\n+LL |     type Allocated<T>;\n+   |                    ^ required by this bound in `Allocator::Allocated`\n \n error: aborting due to previous error\n "}, {"sha": "5bb98675361a0852e2ba176eaa5acc7ed219c3c7", "filename": "src/test/ui/union/issue-81199.stderr", "status": "modified", "additions": 5, "deletions": 15, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/43dd0e2424a1086e0d9d649f717b3646da6586b6/src%2Ftest%2Fui%2Funion%2Fissue-81199.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/43dd0e2424a1086e0d9d649f717b3646da6586b6/src%2Ftest%2Fui%2Funion%2Fissue-81199.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Funion%2Fissue-81199.stderr?ref=43dd0e2424a1086e0d9d649f717b3646da6586b6", "patch": "@@ -1,28 +1,18 @@\n-error[E0277]: the trait bound `T: Pointee` is not satisfied in `PtrComponents<T>`\n+error[E0277]: the trait bound `T: Pointee` is not satisfied\n   --> $DIR/issue-81199.rs:5:17\n    |\n LL |     components: PtrComponents<T>,\n-   |                 ^^^^^^^^^^^^^^^^ within `PtrComponents<T>`, the trait `Pointee` is not implemented for `T`\n+   |                 ^^^^^^^^^^^^^^^^ the trait `Pointee` is not implemented for `T`\n    |\n-note: required because it appears within the type `PtrComponents<T>`\n-  --> $DIR/issue-81199.rs:10:8\n+note: required by a bound in `PtrComponents`\n+  --> $DIR/issue-81199.rs:10:25\n    |\n LL | struct PtrComponents<T: Pointee + ?Sized> {\n-   |        ^^^^^^^^^^^^^\n-   = note: no field of a union may have a dynamically sized type\n-   = help: change the field's type to have a statically known size\n+   |                         ^^^^^^^ required by this bound in `PtrComponents`\n help: consider further restricting this bound\n    |\n LL | union PtrRepr<T: ?Sized + Pointee> {\n    |                         +++++++++\n-help: borrowed types always have a statically known size\n-   |\n-LL |     components: &PtrComponents<T>,\n-   |                 +\n-help: the `Box` type always has a statically known size and allocates its contents in the heap\n-   |\n-LL |     components: Box<PtrComponents<T>>,\n-   |                 ++++                +\n \n error: aborting due to previous error\n "}, {"sha": "c2948086b200b7f1812a6e613f3bd0c61a341852", "filename": "src/test/ui/wf/issue-96810.rs", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/43dd0e2424a1086e0d9d649f717b3646da6586b6/src%2Ftest%2Fui%2Fwf%2Fissue-96810.rs", "raw_url": "https://github.com/rust-lang/rust/raw/43dd0e2424a1086e0d9d649f717b3646da6586b6/src%2Ftest%2Fui%2Fwf%2Fissue-96810.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fwf%2Fissue-96810.rs?ref=43dd0e2424a1086e0d9d649f717b3646da6586b6", "patch": "@@ -0,0 +1,12 @@\n+struct S<T: Tr>(T::Assoc);\n+\n+trait Tr {\n+    type Assoc;\n+}\n+\n+struct Hoge<K> {\n+    s: S<K>, //~ ERROR the trait bound `K: Tr` is not satisfied\n+    a: u32,\n+}\n+\n+fn main() {}"}, {"sha": "1407e62b1e13955aa10798d9ac72b1c404f328b3", "filename": "src/test/ui/wf/issue-96810.stderr", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/43dd0e2424a1086e0d9d649f717b3646da6586b6/src%2Ftest%2Fui%2Fwf%2Fissue-96810.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/43dd0e2424a1086e0d9d649f717b3646da6586b6/src%2Ftest%2Fui%2Fwf%2Fissue-96810.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fwf%2Fissue-96810.stderr?ref=43dd0e2424a1086e0d9d649f717b3646da6586b6", "patch": "@@ -0,0 +1,19 @@\n+error[E0277]: the trait bound `K: Tr` is not satisfied\n+  --> $DIR/issue-96810.rs:8:8\n+   |\n+LL |     s: S<K>,\n+   |        ^^^^ the trait `Tr` is not implemented for `K`\n+   |\n+note: required by a bound in `S`\n+  --> $DIR/issue-96810.rs:1:13\n+   |\n+LL | struct S<T: Tr>(T::Assoc);\n+   |             ^^ required by this bound in `S`\n+help: consider restricting type parameter `K`\n+   |\n+LL | struct Hoge<K: Tr> {\n+   |              ++++\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0277`."}]}