{"sha": "b445bf2bd1139236fd815bf93610ddaf17726111", "node_id": "MDY6Q29tbWl0NzI0NzEyOmI0NDViZjJiZDExMzkyMzZmZDgxNWJmOTM2MTBkZGFmMTc3MjYxMTE=", "commit": {"author": {"name": "Felix S. Klock II", "email": "pnkfelix@pnkfx.org", "date": "2015-02-04T12:24:44Z"}, "committer": {"name": "Felix S. Klock II", "email": "pnkfelix@pnkfx.org", "date": "2015-02-05T23:07:37Z"}, "message": "make `for PAT in ITER_EXPR { ... }` a terminating-scope for ITER_EXPR.\n\nIn effect, temporary anonymous values created during the evaluation of\nITER_EXPR no longer not live for the entirety of the block surrounding\nthe for-loop; instead they only live for the extent of the for-loop\nitself, and no longer.\n\n----\n\nThere is one case I know of that this breaks, demonstrated to me by\nniko (but it is also a corner-case that is useless in practice).  Here\nis that case:\n\n```\nfn main() {\n    let mut foo: Vec<&i8> = Vec::new();\n    for i in &[1, 2, 3] { foo.push(i) }\n}\n```\n\nNote that if you add any code following the for-loop above, or even a\nsemicolon to the end of it, then the code will stop compiling (i.e.,\nit gathers a vector of references but the gathered vector cannot\nactually be used.)\n\n(The above code, despite being useless, did occur in one run-pass test\nby accident; that test is updated here to accommodate the new\nstriction.)\n\n----\n\nSo, technically this is a:\n\n[breaking-change]", "tree": {"sha": "099d8982a9a68f8446ef32a736fc56e588bb0174", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/099d8982a9a68f8446ef32a736fc56e588bb0174"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b445bf2bd1139236fd815bf93610ddaf17726111", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b445bf2bd1139236fd815bf93610ddaf17726111", "html_url": "https://github.com/rust-lang/rust/commit/b445bf2bd1139236fd815bf93610ddaf17726111", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b445bf2bd1139236fd815bf93610ddaf17726111/comments", "author": {"login": "pnkfelix", "id": 173127, "node_id": "MDQ6VXNlcjE3MzEyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pnkfelix", "html_url": "https://github.com/pnkfelix", "followers_url": "https://api.github.com/users/pnkfelix/followers", "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}", "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}", "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions", "organizations_url": "https://api.github.com/users/pnkfelix/orgs", "repos_url": "https://api.github.com/users/pnkfelix/repos", "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}", "received_events_url": "https://api.github.com/users/pnkfelix/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pnkfelix", "id": 173127, "node_id": "MDQ6VXNlcjE3MzEyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pnkfelix", "html_url": "https://github.com/pnkfelix", "followers_url": "https://api.github.com/users/pnkfelix/followers", "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}", "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}", "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions", "organizations_url": "https://api.github.com/users/pnkfelix/orgs", "repos_url": "https://api.github.com/users/pnkfelix/repos", "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}", "received_events_url": "https://api.github.com/users/pnkfelix/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "189930fcae287565dcef856ae8d60a83190a4b92", "url": "https://api.github.com/repos/rust-lang/rust/commits/189930fcae287565dcef856ae8d60a83190a4b92", "html_url": "https://github.com/rust-lang/rust/commit/189930fcae287565dcef856ae8d60a83190a4b92"}], "stats": {"total": 30, "additions": 21, "deletions": 9}, "files": [{"sha": "d75766c608ba03fd121905f8bbfd65128bfd61bf", "filename": "src/libsyntax/ext/expand.rs", "status": "modified", "additions": 20, "deletions": 8, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/b445bf2bd1139236fd815bf93610ddaf17726111/src%2Flibsyntax%2Fext%2Fexpand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b445bf2bd1139236fd815bf93610ddaf17726111/src%2Flibsyntax%2Fext%2Fexpand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fexpand.rs?ref=b445bf2bd1139236fd815bf93610ddaf17726111", "patch": "@@ -230,15 +230,18 @@ pub fn expand_expr(e: P<ast::Expr>, fld: &mut MacroExpander) -> P<ast::Expr> {\n         ast::ExprForLoop(pat, head, body, opt_ident) => {\n             // to:\n             //\n-            //   match ::std::iter::IntoIterator::into_iter(<head>) {\n-            //     mut iter => {\n-            //       [opt_ident]: loop {\n-            //         match ::std::iter::Iterator::next(&mut iter) {\n-            //           ::std::option::Option::Some(<pat>) => <body>,\n-            //           ::std::option::Option::None => break\n+            //   {\n+            //     let result = match ::std::iter::IntoIterator::into_iter(<head>) {\n+            //       mut iter => {\n+            //         [opt_ident]: loop {\n+            //           match ::std::iter::Iterator::next(&mut iter) {\n+            //             ::std::option::Option::Some(<pat>) => <body>,\n+            //             ::std::option::Option::None => break\n+            //           }\n             //         }\n             //       }\n-            //     }\n+            //     };\n+            //     result\n             //   }\n \n             // expand <head>\n@@ -319,7 +322,16 @@ pub fn expand_expr(e: P<ast::Expr>, fld: &mut MacroExpander) -> P<ast::Expr> {\n \n                 fld.cx.expr_call(span, fld.cx.expr_path(into_iter_path), vec![head])\n             };\n-            fld.cx.expr_match(span, into_iter_expr, vec![iter_arm])\n+\n+            let match_expr = fld.cx.expr_match(span, into_iter_expr, vec![iter_arm]);\n+\n+            // `{ let result = ...; result }`\n+            let result_ident = token::gensym_ident(\"result\");\n+            fld.cx.expr_block(\n+                fld.cx.block_all(\n+                    span,\n+                    vec![fld.cx.stmt_let(span, false, result_ident, match_expr)],\n+                    Some(fld.cx.expr_ident(span, result_ident))))\n         }\n \n         ast::ExprClosure(capture_clause, fn_decl, block) => {"}, {"sha": "d96ff869fa0ab06567d81b4d1a1f8b4c263cb99e", "filename": "src/test/run-pass/loop-label-shadowing.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b445bf2bd1139236fd815bf93610ddaf17726111/src%2Ftest%2Frun-pass%2Floop-label-shadowing.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b445bf2bd1139236fd815bf93610ddaf17726111/src%2Ftest%2Frun-pass%2Floop-label-shadowing.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Floop-label-shadowing.rs?ref=b445bf2bd1139236fd815bf93610ddaf17726111", "patch": "@@ -13,7 +13,7 @@\n fn main() {\n     let mut foo = Vec::new();\n     'foo: for i in &[1, 2, 3] {\n-        foo.push(i);\n+        foo.push(*i);\n     }\n }\n "}]}