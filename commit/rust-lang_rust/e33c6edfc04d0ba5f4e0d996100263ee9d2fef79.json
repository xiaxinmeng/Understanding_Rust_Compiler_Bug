{"sha": "e33c6edfc04d0ba5f4e0d996100263ee9d2fef79", "node_id": "C_kwDOAAsO6NoAKGUzM2M2ZWRmYzA0ZDBiYTVmNGUwZDk5NjEwMDI2M2VlOWQyZmVmNzk", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-06-03T22:42:49Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-06-03T22:42:49Z"}, "message": "Rollup merge of #97446 - cjgillot:get-generics, r=michaelwoerister\n\nMake hir().get_generics and generics_of consistent.\n\nFetching generics from a HIR node is currently implemented differently in 4 different places.\nThis PR makes the 4 implementations call the single `hir::Node::generics`, which implements the more general version from `generics_of` query.", "tree": {"sha": "12dbcf29329a3daf382e2167629178da85cebc9b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/12dbcf29329a3daf382e2167629178da85cebc9b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e33c6edfc04d0ba5f4e0d996100263ee9d2fef79", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJimo5pCRBK7hj4Ov3rIwAAQVIIAGW4mfjpilxZoocCjDMXwn4r\nCSJe7bVVmlU+We/NxWcE+E05TJ1NIvEaxpEBaWYDMsv4xpDJHeamoG0a3GpxnQZS\nfkvattJInf374AT99k5JBfzhfKALGnwecKjG1lCgjpDlLL34K+s3zcEClyjX6iRq\nOpxe2Dnkva10qjh5dC5qqii09gFAWvphx6MPjhXtdDvBjDs+/QwXuGX3OoSeBV+j\n6JJJYNdMyCTZmv41NOlJtPq8uzMohW5nSHyQCrQel0gvroHsHgRSKRLPKLMCVytb\nvVulV4KjsOH6R/lRrn5zsi9EjA2qJDJgP2s2mRzkNYMEkwzSKAhHqx4aRNdk3Vk=\n=lnNB\n-----END PGP SIGNATURE-----\n", "payload": "tree 12dbcf29329a3daf382e2167629178da85cebc9b\nparent a6b8c6954829669a5c4fa320c3e6132edf04fcfc\nparent 623ea5f5d283dfb57e17e2671bebe63ff7d1e936\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1654296169 +0200\ncommitter GitHub <noreply@github.com> 1654296169 +0200\n\nRollup merge of #97446 - cjgillot:get-generics, r=michaelwoerister\n\nMake hir().get_generics and generics_of consistent.\n\nFetching generics from a HIR node is currently implemented differently in 4 different places.\nThis PR makes the 4 implementations call the single `hir::Node::generics`, which implements the more general version from `generics_of` query.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e33c6edfc04d0ba5f4e0d996100263ee9d2fef79", "html_url": "https://github.com/rust-lang/rust/commit/e33c6edfc04d0ba5f4e0d996100263ee9d2fef79", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e33c6edfc04d0ba5f4e0d996100263ee9d2fef79/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a6b8c6954829669a5c4fa320c3e6132edf04fcfc", "url": "https://api.github.com/repos/rust-lang/rust/commits/a6b8c6954829669a5c4fa320c3e6132edf04fcfc", "html_url": "https://github.com/rust-lang/rust/commit/a6b8c6954829669a5c4fa320c3e6132edf04fcfc"}, {"sha": "623ea5f5d283dfb57e17e2671bebe63ff7d1e936", "url": "https://api.github.com/repos/rust-lang/rust/commits/623ea5f5d283dfb57e17e2671bebe63ff7d1e936", "html_url": "https://github.com/rust-lang/rust/commit/623ea5f5d283dfb57e17e2671bebe63ff7d1e936"}], "stats": {"total": 94, "additions": 23, "deletions": 71}, "files": [{"sha": "cb2e66090e7c393317c45563b4ad6a8add3d45db", "filename": "compiler/rustc_hir/src/hir.rs", "status": "modified", "additions": 9, "deletions": 12, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/e33c6edfc04d0ba5f4e0d996100263ee9d2fef79/compiler%2Frustc_hir%2Fsrc%2Fhir.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e33c6edfc04d0ba5f4e0d996100263ee9d2fef79/compiler%2Frustc_hir%2Fsrc%2Fhir.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir%2Fsrc%2Fhir.rs?ref=e33c6edfc04d0ba5f4e0d996100263ee9d2fef79", "patch": "@@ -3004,13 +3004,12 @@ impl ItemKind<'_> {\n         Some(match *self {\n             ItemKind::Fn(_, ref generics, _)\n             | ItemKind::TyAlias(_, ref generics)\n-            | ItemKind::OpaqueTy(OpaqueTy {\n-                ref generics, origin: OpaqueTyOrigin::TyAlias, ..\n-            })\n+            | ItemKind::OpaqueTy(OpaqueTy { ref generics, .. })\n             | ItemKind::Enum(_, ref generics)\n             | ItemKind::Struct(_, ref generics)\n             | ItemKind::Union(_, ref generics)\n             | ItemKind::Trait(_, _, ref generics, _, _)\n+            | ItemKind::TraitAlias(ref generics, _)\n             | ItemKind::Impl(Impl { ref generics, .. }) => generics,\n             _ => return None,\n         })\n@@ -3210,13 +3209,8 @@ impl<'hir> OwnerNode<'hir> {\n         }\n     }\n \n-    pub fn generics(&self) -> Option<&'hir Generics<'hir>> {\n-        match self {\n-            OwnerNode::TraitItem(TraitItem { generics, .. })\n-            | OwnerNode::ImplItem(ImplItem { generics, .. }) => Some(generics),\n-            OwnerNode::Item(item) => item.kind.generics(),\n-            _ => None,\n-        }\n+    pub fn generics(self) -> Option<&'hir Generics<'hir>> {\n+        Node::generics(self.into())\n     }\n \n     pub fn def_id(self) -> LocalDefId {\n@@ -3403,9 +3397,12 @@ impl<'hir> Node<'hir> {\n         }\n     }\n \n-    pub fn generics(&self) -> Option<&'hir Generics<'hir>> {\n+    pub fn generics(self) -> Option<&'hir Generics<'hir>> {\n         match self {\n-            Node::TraitItem(TraitItem { generics, .. })\n+            Node::ForeignItem(ForeignItem {\n+                kind: ForeignItemKind::Fn(_, _, generics), ..\n+            })\n+            | Node::TraitItem(TraitItem { generics, .. })\n             | Node::ImplItem(ImplItem { generics, .. }) => Some(generics),\n             Node::Item(item) => item.kind.generics(),\n             _ => None,"}, {"sha": "779af7a382765f08f45144107174edf0ee8c2d7a", "filename": "compiler/rustc_middle/src/hir/map/mod.rs", "status": "modified", "additions": 1, "deletions": 21, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/e33c6edfc04d0ba5f4e0d996100263ee9d2fef79/compiler%2Frustc_middle%2Fsrc%2Fhir%2Fmap%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e33c6edfc04d0ba5f4e0d996100263ee9d2fef79/compiler%2Frustc_middle%2Fsrc%2Fhir%2Fmap%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fhir%2Fmap%2Fmod.rs?ref=e33c6edfc04d0ba5f4e0d996100263ee9d2fef79", "patch": "@@ -361,27 +361,7 @@ impl<'hir> Map<'hir> {\n \n     pub fn get_generics(self, id: LocalDefId) -> Option<&'hir Generics<'hir>> {\n         let node = self.tcx.hir_owner(id)?;\n-        match node.node {\n-            OwnerNode::ImplItem(impl_item) => Some(&impl_item.generics),\n-            OwnerNode::TraitItem(trait_item) => Some(&trait_item.generics),\n-            OwnerNode::ForeignItem(ForeignItem {\n-                kind: ForeignItemKind::Fn(_, _, generics),\n-                ..\n-            })\n-            | OwnerNode::Item(Item {\n-                kind:\n-                    ItemKind::Fn(_, generics, _)\n-                    | ItemKind::TyAlias(_, generics)\n-                    | ItemKind::Enum(_, generics)\n-                    | ItemKind::Struct(_, generics)\n-                    | ItemKind::Union(_, generics)\n-                    | ItemKind::Trait(_, _, generics, ..)\n-                    | ItemKind::TraitAlias(generics, _)\n-                    | ItemKind::Impl(Impl { generics, .. }),\n-                ..\n-            }) => Some(generics),\n-            _ => None,\n-        }\n+        node.node.generics()\n     }\n \n     pub fn item(self, id: ItemId) -> &'hir Item<'hir> {"}, {"sha": "838980e08aa0459687fe5baa6372dafde0f2a88a", "filename": "compiler/rustc_typeck/src/collect.rs", "status": "modified", "additions": 13, "deletions": 38, "changes": 51, "blob_url": "https://github.com/rust-lang/rust/blob/e33c6edfc04d0ba5f4e0d996100263ee9d2fef79/compiler%2Frustc_typeck%2Fsrc%2Fcollect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e33c6edfc04d0ba5f4e0d996100263ee9d2fef79/compiler%2Frustc_typeck%2Fsrc%2Fcollect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcollect.rs?ref=e33c6edfc04d0ba5f4e0d996100263ee9d2fef79", "patch": "@@ -1588,41 +1588,20 @@ fn generics_of(tcx: TyCtxt<'_>, def_id: DefId) -> ty::Generics {\n         _ => None,\n     };\n \n-    let mut opt_self = None;\n-    let mut allow_defaults = false;\n-\n     let no_generics = hir::Generics::empty();\n-    let ast_generics = match node {\n-        Node::TraitItem(item) => &item.generics,\n-\n-        Node::ImplItem(item) => &item.generics,\n-\n+    let ast_generics = node.generics().unwrap_or(&no_generics);\n+    let (opt_self, allow_defaults) = match node {\n         Node::Item(item) => {\n             match item.kind {\n-                ItemKind::Fn(.., ref generics, _)\n-                | ItemKind::Impl(hir::Impl { ref generics, .. }) => generics,\n-\n-                ItemKind::TyAlias(_, ref generics)\n-                | ItemKind::Enum(_, ref generics)\n-                | ItemKind::Struct(_, ref generics)\n-                | ItemKind::OpaqueTy(hir::OpaqueTy { ref generics, .. })\n-                | ItemKind::Union(_, ref generics) => {\n-                    allow_defaults = true;\n-                    generics\n-                }\n-\n-                ItemKind::Trait(_, _, ref generics, ..)\n-                | ItemKind::TraitAlias(ref generics, ..) => {\n+                ItemKind::Trait(..) | ItemKind::TraitAlias(..) => {\n                     // Add in the self type parameter.\n                     //\n                     // Something of a hack: use the node id for the trait, also as\n                     // the node id for the Self type parameter.\n-                    let param_id = item.def_id;\n-\n-                    opt_self = Some(ty::GenericParamDef {\n+                    let opt_self = Some(ty::GenericParamDef {\n                         index: 0,\n                         name: kw::SelfUpper,\n-                        def_id: param_id.to_def_id(),\n+                        def_id,\n                         pure_wrt_drop: false,\n                         kind: ty::GenericParamDefKind::Type {\n                             has_default: false,\n@@ -1631,21 +1610,17 @@ fn generics_of(tcx: TyCtxt<'_>, def_id: DefId) -> ty::Generics {\n                         },\n                     });\n \n-                    allow_defaults = true;\n-                    generics\n+                    (opt_self, true)\n                 }\n-\n-                _ => &no_generics,\n+                ItemKind::TyAlias(..)\n+                | ItemKind::Enum(..)\n+                | ItemKind::Struct(..)\n+                | ItemKind::OpaqueTy(..)\n+                | ItemKind::Union(..) => (None, true),\n+                _ => (None, false),\n             }\n         }\n-\n-        Node::ForeignItem(item) => match item.kind {\n-            ForeignItemKind::Static(..) => &no_generics,\n-            ForeignItemKind::Fn(_, _, ref generics) => generics,\n-            ForeignItemKind::Type => &no_generics,\n-        },\n-\n-        _ => &no_generics,\n+        _ => (None, false),\n     };\n \n     let has_self = opt_self.is_some();"}]}