{"sha": "a83c35692fa5fc65ec9860599501f1a5a5e98214", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE4M2MzNTY5MmZhNWZjNjVlYzk4NjA1OTk1MDFmMWE1YTVlOTgyMTQ=", "commit": {"author": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2019-08-19T20:44:57Z"}, "committer": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2019-08-21T08:53:39Z"}, "message": "expand: Do not do questionable span adjustment before eagerly expanding an expression\n\nMaybe it made sense when it was introduced, but now it's doing something incorrect.", "tree": {"sha": "8f5717d8d6c0b3f19b067e5ea704a27dbcceac2e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8f5717d8d6c0b3f19b067e5ea704a27dbcceac2e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a83c35692fa5fc65ec9860599501f1a5a5e98214", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a83c35692fa5fc65ec9860599501f1a5a5e98214", "html_url": "https://github.com/rust-lang/rust/commit/a83c35692fa5fc65ec9860599501f1a5a5e98214", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a83c35692fa5fc65ec9860599501f1a5a5e98214/comments", "author": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "committer": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "96032aa5efd82c3cddc485332162614b9b8dd3dd", "url": "https://api.github.com/repos/rust-lang/rust/commits/96032aa5efd82c3cddc485332162614b9b8dd3dd", "html_url": "https://github.com/rust-lang/rust/commit/96032aa5efd82c3cddc485332162614b9b8dd3dd"}], "stats": {"total": 20, "additions": 4, "deletions": 16}, "files": [{"sha": "376df4062b116bb8d5a1d6dfd2bff3ea8bd17de5", "filename": "src/libsyntax/ext/base.rs", "status": "modified", "additions": 1, "deletions": 4, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/a83c35692fa5fc65ec9860599501f1a5a5e98214/src%2Flibsyntax%2Fext%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a83c35692fa5fc65ec9860599501f1a5a5e98214/src%2Flibsyntax%2Fext%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fbase.rs?ref=a83c35692fa5fc65ec9860599501f1a5a5e98214", "patch": "@@ -908,12 +908,9 @@ impl<'a> ExtCtxt<'a> {\n /// compilation on error, merely emits a non-fatal error and returns `None`.\n pub fn expr_to_spanned_string<'a>(\n     cx: &'a mut ExtCtxt<'_>,\n-    mut expr: P<ast::Expr>,\n+    expr: P<ast::Expr>,\n     err_msg: &str,\n ) -> Result<(Symbol, ast::StrStyle, Span), Option<DiagnosticBuilder<'a>>> {\n-    // Update `expr.span`'s ctxt now in case expr is an `include!` macro invocation.\n-    expr.span = expr.span.apply_mark(cx.current_expansion.id);\n-\n     // Perform eager expansion on the expression.\n     // We want to be able to handle e.g., `concat!(\"foo\", \"bar\")`.\n     let expr = cx.expander().fully_expand_fragment(AstFragment::Expr(expr)).make_expr();"}, {"sha": "6f3215dd697f321cf279482cba388e45741c4936", "filename": "src/test/ui/hygiene/eager-from-opaque.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/a83c35692fa5fc65ec9860599501f1a5a5e98214/src%2Ftest%2Fui%2Fhygiene%2Feager-from-opaque.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a83c35692fa5fc65ec9860599501f1a5a5e98214/src%2Ftest%2Fui%2Fhygiene%2Feager-from-opaque.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fhygiene%2Feager-from-opaque.rs?ref=a83c35692fa5fc65ec9860599501f1a5a5e98214", "patch": "@@ -1,6 +1,8 @@\n // Opaque macro can eagerly expand its input without breaking its resolution.\n // Regression test for issue #63685.\n \n+// check-pass\n+\n macro_rules! foo {\n     () => {\n         \"foo\"\n@@ -9,7 +11,7 @@ macro_rules! foo {\n \n macro_rules! bar {\n     () => {\n-        foo!() //~ ERROR cannot find macro `foo!` in this scope\n+        foo!()\n     };\n }\n "}, {"sha": "f696e6caff7ca9462d532b4332434efbcd9e2b14", "filename": "src/test/ui/hygiene/eager-from-opaque.stderr", "status": "removed", "additions": 0, "deletions": 11, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/96032aa5efd82c3cddc485332162614b9b8dd3dd/src%2Ftest%2Fui%2Fhygiene%2Feager-from-opaque.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/96032aa5efd82c3cddc485332162614b9b8dd3dd/src%2Ftest%2Fui%2Fhygiene%2Feager-from-opaque.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fhygiene%2Feager-from-opaque.stderr?ref=96032aa5efd82c3cddc485332162614b9b8dd3dd", "patch": "@@ -1,11 +0,0 @@\n-error: cannot find macro `foo!` in this scope\n-  --> $DIR/eager-from-opaque.rs:12:9\n-   |\n-LL |         foo!()\n-   |         ^^^\n-...\n-LL |     format_args!(bar!());\n-   |                  ------ in this macro invocation\n-\n-error: aborting due to previous error\n-"}]}