{"sha": "0b971625c389c1638957b010a35c7bb1a6bd69b9", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBiOTcxNjI1YzM4OWMxNjM4OTU3YjAxMGEzNWM3YmIxYTZiZDY5Yjk=", "commit": {"author": {"name": "Paul Daniel Faria", "email": "nashenas88@users.noreply.github.com", "date": "2020-06-23T02:28:09Z"}, "committer": {"name": "Paul Daniel Faria", "email": "nashenas88@users.noreply.github.com", "date": "2020-06-23T02:29:08Z"}, "message": "Fix underflow panic when doctests are at top of file", "tree": {"sha": "c6efdc103468ee72475c7f9b10902f15df6522fd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c6efdc103468ee72475c7f9b10902f15df6522fd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0b971625c389c1638957b010a35c7bb1a6bd69b9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0b971625c389c1638957b010a35c7bb1a6bd69b9", "html_url": "https://github.com/rust-lang/rust/commit/0b971625c389c1638957b010a35c7bb1a6bd69b9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0b971625c389c1638957b010a35c7bb1a6bd69b9/comments", "author": {"login": "Nashenas88", "id": 1673130, "node_id": "MDQ6VXNlcjE2NzMxMzA=", "avatar_url": "https://avatars.githubusercontent.com/u/1673130?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Nashenas88", "html_url": "https://github.com/Nashenas88", "followers_url": "https://api.github.com/users/Nashenas88/followers", "following_url": "https://api.github.com/users/Nashenas88/following{/other_user}", "gists_url": "https://api.github.com/users/Nashenas88/gists{/gist_id}", "starred_url": "https://api.github.com/users/Nashenas88/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Nashenas88/subscriptions", "organizations_url": "https://api.github.com/users/Nashenas88/orgs", "repos_url": "https://api.github.com/users/Nashenas88/repos", "events_url": "https://api.github.com/users/Nashenas88/events{/privacy}", "received_events_url": "https://api.github.com/users/Nashenas88/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Nashenas88", "id": 1673130, "node_id": "MDQ6VXNlcjE2NzMxMzA=", "avatar_url": "https://avatars.githubusercontent.com/u/1673130?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Nashenas88", "html_url": "https://github.com/Nashenas88", "followers_url": "https://api.github.com/users/Nashenas88/followers", "following_url": "https://api.github.com/users/Nashenas88/following{/other_user}", "gists_url": "https://api.github.com/users/Nashenas88/gists{/gist_id}", "starred_url": "https://api.github.com/users/Nashenas88/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Nashenas88/subscriptions", "organizations_url": "https://api.github.com/users/Nashenas88/orgs", "repos_url": "https://api.github.com/users/Nashenas88/repos", "events_url": "https://api.github.com/users/Nashenas88/events{/privacy}", "received_events_url": "https://api.github.com/users/Nashenas88/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d8842e89e9053b62c081d2995cbf43b8fd5c51b2", "url": "https://api.github.com/repos/rust-lang/rust/commits/d8842e89e9053b62c081d2995cbf43b8fd5c51b2", "html_url": "https://github.com/rust-lang/rust/commit/d8842e89e9053b62c081d2995cbf43b8fd5c51b2"}], "stats": {"total": 20, "additions": 15, "deletions": 5}, "files": [{"sha": "ac546806eb98476c238d33398613b90209c7c615", "filename": "crates/ra_ide/src/snapshots/highlight_doctest.html", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/0b971625c389c1638957b010a35c7bb1a6bd69b9/crates%2Fra_ide%2Fsrc%2Fsnapshots%2Fhighlight_doctest.html", "raw_url": "https://github.com/rust-lang/rust/raw/0b971625c389c1638957b010a35c7bb1a6bd69b9/crates%2Fra_ide%2Fsrc%2Fsnapshots%2Fhighlight_doctest.html", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fsnapshots%2Fhighlight_doctest.html?ref=0b971625c389c1638957b010a35c7bb1a6bd69b9", "patch": "@@ -32,7 +32,10 @@\n .keyword.unsafe     { color: #BC8383; font-weight: bold; }\n .control            { font-style: italic; }\n </style>\n-<pre><code><span class=\"keyword\">struct</span> <span class=\"struct declaration\">Foo</span> {\n+<pre><code><span class=\"comment documentation\">/// ```</span>\n+<span class=\"comment documentation\">/// </span><span class=\"keyword\">let</span> _ = <span class=\"string_literal\">\"early doctests should not go boom\"</span>;\n+<span class=\"comment documentation\">/// ```</span>\n+<span class=\"keyword\">struct</span> <span class=\"struct declaration\">Foo</span> {\n     <span class=\"field declaration\">bar</span>: <span class=\"builtin_type\">bool</span>,\n }\n "}, {"sha": "9d82b400951ad28fa7cf4f0e2cb77cf1528f725a", "filename": "crates/ra_ide/src/syntax_highlighting/injection.rs", "status": "modified", "additions": 8, "deletions": 4, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/0b971625c389c1638957b010a35c7bb1a6bd69b9/crates%2Fra_ide%2Fsrc%2Fsyntax_highlighting%2Finjection.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0b971625c389c1638957b010a35c7bb1a6bd69b9/crates%2Fra_ide%2Fsrc%2Fsyntax_highlighting%2Finjection.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fsyntax_highlighting%2Finjection.rs?ref=0b971625c389c1638957b010a35c7bb1a6bd69b9", "patch": "@@ -155,17 +155,21 @@ pub(super) fn highlight_doc_comment(\n         let mut start_offset = None;\n         let mut end_offset = None;\n         for (line_start, orig_line_start) in range_mapping.range(..h.range.end()).rev() {\n+            // It's possible for orig_line_start - line_start to be negative. Add h.range.start()\n+            // here and remove it from the end range after the loop below so that the values are\n+            // always non-negative.\n+            let offset = h.range.start() + orig_line_start - line_start;\n             if line_start <= &h.range.start() {\n-                start_offset.get_or_insert(orig_line_start - line_start);\n+                start_offset.get_or_insert(offset);\n                 break;\n             } else {\n-                end_offset.get_or_insert(orig_line_start - line_start);\n+                end_offset.get_or_insert(offset);\n             }\n         }\n         if let Some(start_offset) = start_offset {\n             h.range = TextRange::new(\n-                h.range.start() + start_offset,\n-                h.range.end() + end_offset.unwrap_or(start_offset),\n+                start_offset,\n+                h.range.end() + end_offset.unwrap_or(start_offset) - h.range.start(),\n             );\n \n             stack.add(h);"}, {"sha": "b1f48f03bc14bc598c58f7e627a0bcc3d08634e9", "filename": "crates/ra_ide/src/syntax_highlighting/tests.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/0b971625c389c1638957b010a35c7bb1a6bd69b9/crates%2Fra_ide%2Fsrc%2Fsyntax_highlighting%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0b971625c389c1638957b010a35c7bb1a6bd69b9/crates%2Fra_ide%2Fsrc%2Fsyntax_highlighting%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fsyntax_highlighting%2Ftests.rs?ref=0b971625c389c1638957b010a35c7bb1a6bd69b9", "patch": "@@ -291,6 +291,9 @@ fn main() {\n fn test_highlight_doctest() {\n     check_highlighting(\n         r#\"\n+/// ```\n+/// let _ = \"early doctests should not go boom\";\n+/// ```\n struct Foo {\n     bar: bool,\n }"}]}