{"sha": "d5175f4405029cf456ca0cd44b438a7f86ffdc06", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQ1MTc1ZjQ0MDUwMjljZjQ1NmNhMGNkNDRiNDM4YTdmODZmZmRjMDY=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-12-29T10:17:10Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-12-29T10:17:10Z"}, "message": "Auto merge of #57160 - petrochenkov:impice2, r=estebank\n\nresolve: Fix an ICE in import validation\n\nFixes ICE reported in the comment https://github.com/rust-lang/rust/issues/56596#issuecomment-449866807", "tree": {"sha": "ad58cce3e53053f33a8c2c574c8a7e9b05795f07", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ad58cce3e53053f33a8c2c574c8a7e9b05795f07"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d5175f4405029cf456ca0cd44b438a7f86ffdc06", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d5175f4405029cf456ca0cd44b438a7f86ffdc06", "html_url": "https://github.com/rust-lang/rust/commit/d5175f4405029cf456ca0cd44b438a7f86ffdc06", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d5175f4405029cf456ca0cd44b438a7f86ffdc06/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "35a64f8bbfab3e063754cc9fc51a6ad795269b50", "url": "https://api.github.com/repos/rust-lang/rust/commits/35a64f8bbfab3e063754cc9fc51a6ad795269b50", "html_url": "https://github.com/rust-lang/rust/commit/35a64f8bbfab3e063754cc9fc51a6ad795269b50"}, {"sha": "ce73bc7d47fc58d5e1436df10b2a2ceaddf511bd", "url": "https://api.github.com/repos/rust-lang/rust/commits/ce73bc7d47fc58d5e1436df10b2a2ceaddf511bd", "html_url": "https://github.com/rust-lang/rust/commit/ce73bc7d47fc58d5e1436df10b2a2ceaddf511bd"}], "stats": {"total": 51, "additions": 45, "deletions": 6}, "files": [{"sha": "5830aa3713d830d8d0f5c21c04f8dfcdbe4561b9", "filename": "src/librustc_resolve/resolve_imports.rs", "status": "modified", "additions": 12, "deletions": 6, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/d5175f4405029cf456ca0cd44b438a7f86ffdc06/src%2Flibrustc_resolve%2Fresolve_imports.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d5175f4405029cf456ca0cd44b438a7f86ffdc06/src%2Flibrustc_resolve%2Fresolve_imports.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_resolve%2Fresolve_imports.rs?ref=d5175f4405029cf456ca0cd44b438a7f86ffdc06", "patch": "@@ -223,19 +223,25 @@ impl<'a> Resolver<'a> {\n         }\n \n         let check_usable = |this: &mut Self, binding: &'a NameBinding<'a>| {\n-            if let Some(blacklisted_binding) = this.blacklisted_binding {\n-                if ptr::eq(binding, blacklisted_binding) {\n-                    return Err((Determined, Weak::No));\n-                }\n-            }\n             // `extern crate` are always usable for backwards compatibility, see issue #37020,\n             // remove this together with `PUB_USE_OF_PRIVATE_EXTERN_CRATE`.\n             let usable = this.is_accessible(binding.vis) || binding.is_extern_crate();\n             if usable { Ok(binding) } else { Err((Determined, Weak::No)) }\n         };\n \n         if record_used {\n-            return resolution.binding.ok_or((Determined, Weak::No)).and_then(|binding| {\n+            return resolution.binding.and_then(|binding| {\n+                // If the primary binding is blacklisted, search further and return the shadowed\n+                // glob binding if it exists. What we really want here is having two separate\n+                // scopes in a module - one for non-globs and one for globs, but until that's done\n+                // use this hack to avoid inconsistent resolution ICEs during import validation.\n+                if let Some(blacklisted_binding) = self.blacklisted_binding {\n+                    if ptr::eq(binding, blacklisted_binding) {\n+                        return resolution.shadowed_glob;\n+                    }\n+                }\n+                Some(binding)\n+            }).ok_or((Determined, Weak::No)).and_then(|binding| {\n                 if self.last_import_segment && check_usable(self, binding).is_err() {\n                     Err((Determined, Weak::No))\n                 } else {"}, {"sha": "bc010a3dd2ba0fa324c7aa2b7c4ff9ccfa19f271", "filename": "src/test/ui/rust-2018/uniform-paths/auxiliary/issue-56596.rs", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d5175f4405029cf456ca0cd44b438a7f86ffdc06/src%2Ftest%2Fui%2Frust-2018%2Funiform-paths%2Fauxiliary%2Fissue-56596.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d5175f4405029cf456ca0cd44b438a7f86ffdc06/src%2Ftest%2Fui%2Frust-2018%2Funiform-paths%2Fauxiliary%2Fissue-56596.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frust-2018%2Funiform-paths%2Fauxiliary%2Fissue-56596.rs?ref=d5175f4405029cf456ca0cd44b438a7f86ffdc06", "patch": "@@ -0,0 +1 @@\n+// Nothing here"}, {"sha": "5c40d78d81c29f9a00d215a8dec3e1f310272a6b", "filename": "src/test/ui/rust-2018/uniform-paths/issue-56596.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/d5175f4405029cf456ca0cd44b438a7f86ffdc06/src%2Ftest%2Fui%2Frust-2018%2Funiform-paths%2Fissue-56596.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d5175f4405029cf456ca0cd44b438a7f86ffdc06/src%2Ftest%2Fui%2Frust-2018%2Funiform-paths%2Fissue-56596.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frust-2018%2Funiform-paths%2Fissue-56596.rs?ref=d5175f4405029cf456ca0cd44b438a7f86ffdc06", "patch": "@@ -0,0 +1,14 @@\n+// edition:2018\n+// compile-flags: --extern issue_56596\n+// aux-build:issue-56596.rs\n+\n+#![feature(uniform_paths)]\n+\n+mod m {\n+    pub mod issue_56596 {}\n+}\n+\n+use m::*;\n+use issue_56596; //~ ERROR `issue_56596` is ambiguous\n+\n+fn main() {}"}, {"sha": "293d0ec6a720858e7a78c692ad8705b943d7a3db", "filename": "src/test/ui/rust-2018/uniform-paths/issue-56596.stderr", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/d5175f4405029cf456ca0cd44b438a7f86ffdc06/src%2Ftest%2Fui%2Frust-2018%2Funiform-paths%2Fissue-56596.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/d5175f4405029cf456ca0cd44b438a7f86ffdc06/src%2Ftest%2Fui%2Frust-2018%2Funiform-paths%2Fissue-56596.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frust-2018%2Funiform-paths%2Fissue-56596.stderr?ref=d5175f4405029cf456ca0cd44b438a7f86ffdc06", "patch": "@@ -0,0 +1,18 @@\n+error[E0659]: `issue_56596` is ambiguous (name vs any other name during import resolution)\n+  --> $DIR/issue-56596.rs:12:5\n+   |\n+LL | use issue_56596; //~ ERROR `issue_56596` is ambiguous\n+   |     ^^^^^^^^^^^ ambiguous name\n+   |\n+   = note: `issue_56596` could refer to an extern crate passed with `--extern`\n+   = help: use `::issue_56596` to refer to this extern crate unambiguously\n+note: `issue_56596` could also refer to the module imported here\n+  --> $DIR/issue-56596.rs:11:5\n+   |\n+LL | use m::*;\n+   |     ^^^^\n+   = help: use `crate::issue_56596` to refer to this module unambiguously\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0659`."}]}