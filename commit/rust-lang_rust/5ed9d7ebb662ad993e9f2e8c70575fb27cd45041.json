{"sha": "5ed9d7ebb662ad993e9f2e8c70575fb27cd45041", "node_id": "MDY6Q29tbWl0NzI0NzEyOjVlZDlkN2ViYjY2MmFkOTkzZTlmMmU4YzcwNTc1ZmIyN2NkNDUwNDE=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2020-03-23T03:26:04Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-03-23T03:26:04Z"}, "message": "Rollup merge of #69251 - anp:track-caller-in-traits, r=eddyb\n\n#[track_caller] in traits\n\nPer https://github.com/rust-lang/rust/issues/47809#issuecomment-572791760, this allows the `#[track_caller]` attribute on trait methods.\n\nIncludes tests for `#[track_caller]` with:\n\n* \"regular\" trait impls\n* default trait impls\n* \"blanket-tracked\" trait impls, where the annotation is in the trait definition and is inherited by \"regular\" impls of the trait", "tree": {"sha": "02634cf6a1d092d5781e3ca0f755abe1cff0a8c7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/02634cf6a1d092d5781e3ca0f755abe1cff0a8c7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5ed9d7ebb662ad993e9f2e8c70575fb27cd45041", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJeeCxMCRBK7hj4Ov3rIwAAdHIIAD+U/1mL3RC9OpcvKDkDtoo/\nVRhlTt81fx4XBHU40uE7LhP41GVLcwIBfst043lVhp7SXeeZ9DWgIKR9UA8MXgPK\nXT4jFTJcrfb1qslCoLtZWWdl9B+yXOeU3zbbZqXJeJDJxV5r1yWCXLMDu2scCO0n\nlk13mm8RlsS+w+RL9k+tudLP1jm8M49R6zeC4cYSgoZ9P0FWBaY4j0f3/vLIHe2Q\n6HjyCEQkxbwEhWjP6tXF2mYRSCyKo8ScqdBT0n1wlC04Hf/frTMKU77xdPP2TBxb\nh7GoEbBv8nLMzaIvj8khIMhhnc3pb6rKp33ftQeCV6jlrm4aohkJmSoQ5+TBHN8=\n=hKW0\n-----END PGP SIGNATURE-----\n", "payload": "tree 02634cf6a1d092d5781e3ca0f755abe1cff0a8c7\nparent e4b01c7791446b2f79a1b1d517223378df2bf5f2\nparent 69bd46a6a18a5b44972ccebb96de1294f4b760b1\nauthor Mazdak Farrokhzad <twingoow@gmail.com> 1584933964 +0100\ncommitter GitHub <noreply@github.com> 1584933964 +0100\n\nRollup merge of #69251 - anp:track-caller-in-traits, r=eddyb\n\n#[track_caller] in traits\n\nPer https://github.com/rust-lang/rust/issues/47809#issuecomment-572791760, this allows the `#[track_caller]` attribute on trait methods.\n\nIncludes tests for `#[track_caller]` with:\n\n* \"regular\" trait impls\n* default trait impls\n* \"blanket-tracked\" trait impls, where the annotation is in the trait definition and is inherited by \"regular\" impls of the trait\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5ed9d7ebb662ad993e9f2e8c70575fb27cd45041", "html_url": "https://github.com/rust-lang/rust/commit/5ed9d7ebb662ad993e9f2e8c70575fb27cd45041", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5ed9d7ebb662ad993e9f2e8c70575fb27cd45041/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e4b01c7791446b2f79a1b1d517223378df2bf5f2", "url": "https://api.github.com/repos/rust-lang/rust/commits/e4b01c7791446b2f79a1b1d517223378df2bf5f2", "html_url": "https://github.com/rust-lang/rust/commit/e4b01c7791446b2f79a1b1d517223378df2bf5f2"}, {"sha": "69bd46a6a18a5b44972ccebb96de1294f4b760b1", "url": "https://api.github.com/repos/rust-lang/rust/commits/69bd46a6a18a5b44972ccebb96de1294f4b760b1", "html_url": "https://github.com/rust-lang/rust/commit/69bd46a6a18a5b44972ccebb96de1294f4b760b1"}], "stats": {"total": 336, "additions": 217, "deletions": 119}, "files": [{"sha": "6f18560a02d7f76dfc1f9232b54030fb57af3ca2", "filename": "src/librustc/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/5ed9d7ebb662ad993e9f2e8c70575fb27cd45041/src%2Flibrustc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5ed9d7ebb662ad993e9f2e8c70575fb27cd45041/src%2Flibrustc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Flib.rs?ref=5ed9d7ebb662ad993e9f2e8c70575fb27cd45041", "patch": "@@ -38,6 +38,7 @@\n #![feature(extern_types)]\n #![feature(nll)]\n #![feature(option_expect_none)]\n+#![feature(or_patterns)]\n #![feature(range_is_empty)]\n #![feature(specialization)]\n #![feature(trusted_len)]"}, {"sha": "e7316ea763e8a7acb9bc01012196fe7900031890", "filename": "src/librustc/ty/mod.rs", "status": "modified", "additions": 4, "deletions": 14, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/5ed9d7ebb662ad993e9f2e8c70575fb27cd45041/src%2Flibrustc%2Fty%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5ed9d7ebb662ad993e9f2e8c70575fb27cd45041/src%2Flibrustc%2Fty%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fmod.rs?ref=5ed9d7ebb662ad993e9f2e8c70575fb27cd45041", "patch": "@@ -35,7 +35,7 @@ use rustc_data_structures::stable_hasher::{HashStable, StableHasher};\n use rustc_data_structures::sync::{self, par_iter, Lrc, ParallelIterator};\n use rustc_hir as hir;\n use rustc_hir::def::{CtorKind, CtorOf, DefKind, Namespace, Res};\n-use rustc_hir::def_id::{CrateNum, DefId, DefIdMap, LocalDefId, CRATE_DEF_INDEX, LOCAL_CRATE};\n+use rustc_hir::def_id::{CrateNum, DefId, DefIdMap, LocalDefId, CRATE_DEF_INDEX};\n use rustc_hir::{Constness, GlobMap, Node, TraitMap};\n use rustc_index::vec::{Idx, IndexVec};\n use rustc_macros::HashStable;\n@@ -2875,8 +2875,8 @@ impl<'tcx> TyCtxt<'tcx> {\n                 _ => false,\n             }\n         } else {\n-            match self.def_kind(def_id).expect(\"no def for `DefId`\") {\n-                DefKind::AssocConst | DefKind::AssocFn | DefKind::AssocTy => true,\n+            match self.def_kind(def_id) {\n+                Some(DefKind::AssocConst | DefKind::AssocFn | DefKind::AssocTy) => true,\n                 _ => false,\n             }\n         };\n@@ -3054,17 +3054,7 @@ impl<'tcx> TyCtxt<'tcx> {\n     /// If the given defid describes a method belonging to an impl, returns the\n     /// `DefId` of the impl that the method belongs to; otherwise, returns `None`.\n     pub fn impl_of_method(self, def_id: DefId) -> Option<DefId> {\n-        let item = if def_id.krate != LOCAL_CRATE {\n-            if let Some(DefKind::AssocFn) = self.def_kind(def_id) {\n-                Some(self.associated_item(def_id))\n-            } else {\n-                None\n-            }\n-        } else {\n-            self.opt_associated_item(def_id)\n-        };\n-\n-        item.and_then(|trait_item| match trait_item.container {\n+        self.opt_associated_item(def_id).and_then(|trait_item| match trait_item.container {\n             TraitContainer(_) => None,\n             ImplContainer(def_id) => Some(def_id),\n         })"}, {"sha": "8f31b701e495e7d609135e2dee50035d72f7c59b", "filename": "src/librustc_error_codes/error_codes/E0738.md", "status": "modified", "additions": 4, "deletions": 41, "changes": 45, "blob_url": "https://github.com/rust-lang/rust/blob/5ed9d7ebb662ad993e9f2e8c70575fb27cd45041/src%2Flibrustc_error_codes%2Ferror_codes%2FE0738.md", "raw_url": "https://github.com/rust-lang/rust/raw/5ed9d7ebb662ad993e9f2e8c70575fb27cd45041/src%2Flibrustc_error_codes%2Ferror_codes%2FE0738.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_error_codes%2Ferror_codes%2FE0738.md?ref=5ed9d7ebb662ad993e9f2e8c70575fb27cd45041", "patch": "@@ -1,48 +1,11 @@\n-`#[track_caller]` cannot be used in traits yet. This is due to limitations in\n-the compiler which are likely to be temporary. See [RFC 2091] for details on\n-this and other restrictions.\n+`#[track_caller]` cannot be used to annotate foreign functions.\n \n-Erroneous example with a trait method implementation:\n+Erroneous example:\n \n ```compile_fail,E0738\n #![feature(track_caller)]\n-\n-trait Foo {\n-    fn bar(&self);\n-}\n-\n-impl Foo for u64 {\n-    #[track_caller]\n-    fn bar(&self) {}\n-}\n-```\n-\n-Erroneous example with a blanket trait method implementation:\n-\n-```compile_fail,E0738\n-#![feature(track_caller)]\n-\n-trait Foo {\n+extern \"Rust\" {\n     #[track_caller]\n-    fn bar(&self) {}\n-    fn baz(&self);\n+    fn bar();\n }\n ```\n-\n-Erroneous example with a trait method declaration:\n-\n-```compile_fail,E0738\n-#![feature(track_caller)]\n-\n-trait Foo {\n-    fn bar(&self) {}\n-\n-    #[track_caller]\n-    fn baz(&self);\n-}\n-```\n-\n-Note that while the compiler may be able to support the attribute in traits in\n-the future, [RFC 2091] prohibits their implementation without a follow-up RFC.\n-\n-[RFC 2091]: https://github.com/rust-lang/rfcs/blob/master/text/2091-inline-semantic.md"}, {"sha": "583e1fdc1f05f40f0ed70c683b3e928e154fca66", "filename": "src/librustc_passes/check_attr.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/5ed9d7ebb662ad993e9f2e8c70575fb27cd45041/src%2Flibrustc_passes%2Fcheck_attr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5ed9d7ebb662ad993e9f2e8c70575fb27cd45041/src%2Flibrustc_passes%2Fcheck_attr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_passes%2Fcheck_attr.rs?ref=5ed9d7ebb662ad993e9f2e8c70575fb27cd45041", "patch": "@@ -151,17 +151,17 @@ impl CheckAttrVisitor<'tcx> {\n                 .emit();\n                 false\n             }\n-            Target::Fn | Target::Method(MethodKind::Inherent) => true,\n-            Target::Method(_) => {\n+            Target::ForeignFn => {\n                 struct_span_err!(\n                     self.tcx.sess,\n                     *attr_span,\n                     E0738,\n-                    \"`#[track_caller]` may not be used on trait methods\",\n+                    \"`#[track_caller]` is not supported on foreign functions\",\n                 )\n                 .emit();\n                 false\n             }\n+            Target::Fn | Target::Method(..) => true,\n             _ => {\n                 struct_span_err!(\n                     self.tcx.sess,"}, {"sha": "bb9354b8ab339c9638b55e1133e7228d56e1ec30", "filename": "src/librustc_typeck/collect.rs", "status": "modified", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/5ed9d7ebb662ad993e9f2e8c70575fb27cd45041/src%2Flibrustc_typeck%2Fcollect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5ed9d7ebb662ad993e9f2e8c70575fb27cd45041/src%2Flibrustc_typeck%2Fcollect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcollect.rs?ref=5ed9d7ebb662ad993e9f2e8c70575fb27cd45041", "patch": "@@ -2339,6 +2339,9 @@ fn codegen_fn_attrs(tcx: TyCtxt<'_>, id: DefId) -> CodegenFnAttrs {\n     let attrs = tcx.get_attrs(id);\n \n     let mut codegen_fn_attrs = CodegenFnAttrs::new();\n+    if should_inherit_track_caller(tcx, id) {\n+        codegen_fn_attrs.flags |= CodegenFnAttrFlags::TRACK_CALLER;\n+    }\n \n     let whitelist = tcx.target_features_whitelist(LOCAL_CRATE);\n \n@@ -2583,6 +2586,32 @@ fn codegen_fn_attrs(tcx: TyCtxt<'_>, id: DefId) -> CodegenFnAttrs {\n     codegen_fn_attrs\n }\n \n+/// Checks if the provided DefId is a method in a trait impl for a trait which has track_caller\n+/// applied to the method prototype.\n+fn should_inherit_track_caller(tcx: TyCtxt<'_>, def_id: DefId) -> bool {\n+    if let Some(impl_item) = tcx.opt_associated_item(def_id) {\n+        if let ty::AssocItemContainer::ImplContainer(impl_def_id) = impl_item.container {\n+            if let Some(trait_def_id) = tcx.trait_id_of_impl(impl_def_id) {\n+                if let Some(trait_item) = tcx\n+                    .associated_items(trait_def_id)\n+                    .filter_by_name_unhygienic(impl_item.ident.name)\n+                    .find(move |trait_item| {\n+                        trait_item.kind == ty::AssocKind::Method\n+                            && tcx.hygienic_eq(impl_item.ident, trait_item.ident, trait_def_id)\n+                    })\n+                {\n+                    return tcx\n+                        .codegen_fn_attrs(trait_item.def_id)\n+                        .flags\n+                        .intersects(CodegenFnAttrFlags::TRACK_CALLER);\n+                }\n+            }\n+        }\n+    }\n+\n+    false\n+}\n+\n fn check_link_ordinal(tcx: TyCtxt<'_>, attr: &ast::Attribute) -> Option<usize> {\n     use rustc_ast::ast::{Lit, LitIntType, LitKind};\n     let meta_item_list = attr.meta_item_list();"}, {"sha": "9f6a69a51c0ceca41873815d6a28172e7ae86e52", "filename": "src/test/ui/rfc-2091-track-caller/error-extern-fn.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/5ed9d7ebb662ad993e9f2e8c70575fb27cd45041/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ferror-extern-fn.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5ed9d7ebb662ad993e9f2e8c70575fb27cd45041/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ferror-extern-fn.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ferror-extern-fn.rs?ref=5ed9d7ebb662ad993e9f2e8c70575fb27cd45041", "patch": "@@ -0,0 +1,9 @@\n+#![feature(track_caller)]\n+#![allow(dead_code)]\n+\n+extern \"Rust\" {\n+    #[track_caller] //~ ERROR: `#[track_caller]` is not supported on foreign functions\n+    fn bar();\n+}\n+\n+fn main() {}"}, {"sha": "b03f5fbbdb20e1bf5ba06f205d61a3f2fd5d6c55", "filename": "src/test/ui/rfc-2091-track-caller/error-extern-fn.stderr", "status": "renamed", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/5ed9d7ebb662ad993e9f2e8c70575fb27cd45041/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ferror-extern-fn.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/5ed9d7ebb662ad993e9f2e8c70575fb27cd45041/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ferror-extern-fn.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ferror-extern-fn.stderr?ref=5ed9d7ebb662ad993e9f2e8c70575fb27cd45041", "patch": "@@ -1,5 +1,5 @@\n-error[E0738]: `#[track_caller]` may not be used on trait methods\n-  --> $DIR/error-with-trait-decl.rs:4:5\n+error[E0738]: `#[track_caller]` is not supported on foreign functions\n+  --> $DIR/error-extern-fn.rs:5:5\n    |\n LL |     #[track_caller]\n    |     ^^^^^^^^^^^^^^^", "previous_filename": "src/test/ui/rfc-2091-track-caller/error-with-trait-decl.stderr"}, {"sha": "ef037ab62aa3e001f9e4230a234eb55d288ff9cc", "filename": "src/test/ui/rfc-2091-track-caller/error-with-trait-decl.rs", "status": "removed", "additions": 0, "deletions": 12, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/e4b01c7791446b2f79a1b1d517223378df2bf5f2/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ferror-with-trait-decl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e4b01c7791446b2f79a1b1d517223378df2bf5f2/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ferror-with-trait-decl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ferror-with-trait-decl.rs?ref=e4b01c7791446b2f79a1b1d517223378df2bf5f2", "patch": "@@ -1,12 +0,0 @@\n-#![feature(track_caller)]\n-\n-trait Trait {\n-    #[track_caller] //~ ERROR: `#[track_caller]` may not be used on trait methods\n-    fn unwrap(&self);\n-}\n-\n-impl Trait for u64 {\n-    fn unwrap(&self) {}\n-}\n-\n-fn main() {}"}, {"sha": "17e4bf41ddb53930f81973bde0955c078c73e4cb", "filename": "src/test/ui/rfc-2091-track-caller/error-with-trait-default-impl.rs", "status": "removed", "additions": 0, "deletions": 8, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/e4b01c7791446b2f79a1b1d517223378df2bf5f2/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ferror-with-trait-default-impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e4b01c7791446b2f79a1b1d517223378df2bf5f2/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ferror-with-trait-default-impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ferror-with-trait-default-impl.rs?ref=e4b01c7791446b2f79a1b1d517223378df2bf5f2", "patch": "@@ -1,8 +0,0 @@\n-#![feature(track_caller)]\n-\n-trait Trait {\n-    #[track_caller] //~ ERROR: `#[track_caller]` may not be used on trait methods\n-    fn unwrap(&self) {}\n-}\n-\n-fn main() {}"}, {"sha": "867eb918b6e087eb2e149f698622f110f928128b", "filename": "src/test/ui/rfc-2091-track-caller/error-with-trait-default-impl.stderr", "status": "removed", "additions": 0, "deletions": 9, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/e4b01c7791446b2f79a1b1d517223378df2bf5f2/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ferror-with-trait-default-impl.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/e4b01c7791446b2f79a1b1d517223378df2bf5f2/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ferror-with-trait-default-impl.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ferror-with-trait-default-impl.stderr?ref=e4b01c7791446b2f79a1b1d517223378df2bf5f2", "patch": "@@ -1,9 +0,0 @@\n-error[E0738]: `#[track_caller]` may not be used on trait methods\n-  --> $DIR/error-with-trait-default-impl.rs:4:5\n-   |\n-LL |     #[track_caller]\n-   |     ^^^^^^^^^^^^^^^\n-\n-error: aborting due to previous error\n-\n-For more information about this error, try `rustc --explain E0738`."}, {"sha": "75f20f76e660d618c1bd10874deffab0ae044e44", "filename": "src/test/ui/rfc-2091-track-caller/error-with-trait-fn-impl.rs", "status": "removed", "additions": 0, "deletions": 21, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/e4b01c7791446b2f79a1b1d517223378df2bf5f2/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ferror-with-trait-fn-impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e4b01c7791446b2f79a1b1d517223378df2bf5f2/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ferror-with-trait-fn-impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ferror-with-trait-fn-impl.rs?ref=e4b01c7791446b2f79a1b1d517223378df2bf5f2", "patch": "@@ -1,21 +0,0 @@\n-// check-fail\n-\n-#![feature(track_caller)]\n-\n-trait Trait {\n-    fn unwrap(&self);\n-}\n-\n-impl Trait for u64 {\n-    #[track_caller] //~ ERROR: `#[track_caller]` may not be used on trait methods\n-    fn unwrap(&self) {}\n-}\n-\n-struct S;\n-\n-impl S {\n-    #[track_caller] // ok\n-    fn foo() {}\n-}\n-\n-fn main() {}"}, {"sha": "fafceefbfd8397f859eac694f6bca8f91a5ab945", "filename": "src/test/ui/rfc-2091-track-caller/error-with-trait-fn-impl.stderr", "status": "removed", "additions": 0, "deletions": 9, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/e4b01c7791446b2f79a1b1d517223378df2bf5f2/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ferror-with-trait-fn-impl.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/e4b01c7791446b2f79a1b1d517223378df2bf5f2/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ferror-with-trait-fn-impl.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ferror-with-trait-fn-impl.stderr?ref=e4b01c7791446b2f79a1b1d517223378df2bf5f2", "patch": "@@ -1,9 +0,0 @@\n-error[E0738]: `#[track_caller]` may not be used on trait methods\n-  --> $DIR/error-with-trait-fn-impl.rs:10:5\n-   |\n-LL |     #[track_caller]\n-   |     ^^^^^^^^^^^^^^^\n-\n-error: aborting due to previous error\n-\n-For more information about this error, try `rustc --explain E0738`."}, {"sha": "b17c1efb3d38c4cfcfb22514ce766be5249c5195", "filename": "src/test/ui/rfc-2091-track-caller/tracked-fn-ptr-with-arg.rs", "status": "modified", "additions": 43, "deletions": 0, "changes": 43, "blob_url": "https://github.com/rust-lang/rust/blob/5ed9d7ebb662ad993e9f2e8c70575fb27cd45041/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ftracked-fn-ptr-with-arg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5ed9d7ebb662ad993e9f2e8c70575fb27cd45041/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ftracked-fn-ptr-with-arg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ftracked-fn-ptr-with-arg.rs?ref=5ed9d7ebb662ad993e9f2e8c70575fb27cd45041", "patch": "@@ -14,6 +14,49 @@ fn tracked_unit(_: ()) {\n     assert_eq!(location.line(), expected_line, \"call shims report location as fn definition\");\n }\n \n+trait Trait {\n+    fn trait_tracked_unit(_: ());\n+}\n+\n+impl Trait for () {\n+    #[track_caller]\n+    fn trait_tracked_unit(_: ()) {\n+        let expected_line = line!() - 1;\n+        let location = std::panic::Location::caller();\n+        assert_eq!(location.file(), file!());\n+        assert_eq!(location.line(), expected_line, \"call shims report location as fn definition\");\n+    }\n+}\n+\n+trait TrackedTrait {\n+    #[track_caller]\n+    fn trait_tracked_unit_default(_: ()) {\n+        let expected_line = line!() - 1;\n+        let location = std::panic::Location::caller();\n+        assert_eq!(location.file(), file!());\n+        assert_eq!(location.line(), expected_line, \"call shims report location as fn definition\");\n+    }\n+}\n+\n+impl TrackedTrait for () {}\n+\n+trait BlanketTrackedTrait {\n+    #[track_caller]\n+    fn tracked_blanket(_: ());\n+}\n+\n+impl BlanketTrackedTrait for () {\n+    fn tracked_blanket(_: ()) {\n+        let expected_line = line!() - 1;\n+        let location = std::panic::Location::caller();\n+        assert_eq!(location.file(), file!());\n+        assert_eq!(location.line(), expected_line, \"call shims report location as fn definition\");\n+    }\n+}\n+\n fn main() {\n     pass_to_ptr_call(tracked_unit, ());\n+    pass_to_ptr_call(<() as Trait>::trait_tracked_unit, ());\n+    pass_to_ptr_call(<() as TrackedTrait>::trait_tracked_unit_default, ());\n+    pass_to_ptr_call(<() as BlanketTrackedTrait>::tracked_blanket, ());\n }"}, {"sha": "8ee4d4fa168714a74599920527374c3985edbb0a", "filename": "src/test/ui/rfc-2091-track-caller/tracked-fn-ptr.rs", "status": "modified", "additions": 43, "deletions": 0, "changes": 43, "blob_url": "https://github.com/rust-lang/rust/blob/5ed9d7ebb662ad993e9f2e8c70575fb27cd45041/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ftracked-fn-ptr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5ed9d7ebb662ad993e9f2e8c70575fb27cd45041/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ftracked-fn-ptr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ftracked-fn-ptr.rs?ref=5ed9d7ebb662ad993e9f2e8c70575fb27cd45041", "patch": "@@ -14,6 +14,49 @@ fn tracked() {\n     assert_eq!(location.line(), expected_line, \"call shims report location as fn definition\");\n }\n \n+trait Trait {\n+    fn trait_tracked();\n+}\n+\n+impl Trait for () {\n+    #[track_caller]\n+    fn trait_tracked() {\n+        let expected_line = line!() - 1;\n+        let location = std::panic::Location::caller();\n+        assert_eq!(location.file(), file!());\n+        assert_eq!(location.line(), expected_line, \"call shims report location as fn definition\");\n+    }\n+}\n+\n+trait TrackedTrait {\n+    #[track_caller]\n+    fn trait_tracked_default() {\n+        let expected_line = line!() - 1;\n+        let location = std::panic::Location::caller();\n+        assert_eq!(location.file(), file!());\n+        assert_eq!(location.line(), expected_line, \"call shims report location as fn definition\");\n+    }\n+}\n+\n+impl TrackedTrait for () {}\n+\n+trait TraitBlanketTracked {\n+    #[track_caller]\n+    fn tracked_blanket();\n+}\n+\n+impl TraitBlanketTracked for () {\n+    fn tracked_blanket() {\n+        let expected_line = line!() - 1;\n+        let location = std::panic::Location::caller();\n+        assert_eq!(location.file(), file!());\n+        assert_eq!(location.line(), expected_line, \"call shims report location as fn definition\");\n+    }\n+}\n+\n fn main() {\n     ptr_call(tracked);\n+    ptr_call(<() as Trait>::trait_tracked);\n+    ptr_call(<() as TrackedTrait>::trait_tracked_default);\n+    ptr_call(<() as TraitBlanketTracked>::tracked_blanket);\n }"}, {"sha": "0a5f92bb635e58795f6ef2f9ab0d7c5e27bbfa7e", "filename": "src/test/ui/rfc-2091-track-caller/tracked-trait-impls.rs", "status": "added", "additions": 79, "deletions": 0, "changes": 79, "blob_url": "https://github.com/rust-lang/rust/blob/5ed9d7ebb662ad993e9f2e8c70575fb27cd45041/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ftracked-trait-impls.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5ed9d7ebb662ad993e9f2e8c70575fb27cd45041/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ftracked-trait-impls.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ftracked-trait-impls.rs?ref=5ed9d7ebb662ad993e9f2e8c70575fb27cd45041", "patch": "@@ -0,0 +1,79 @@\n+// run-pass\n+\n+#![feature(track_caller)]\n+\n+macro_rules! assert_expansion_site_is_tracked {\n+    () => {{\n+        let location = std::panic::Location::caller();\n+        assert_eq!(location.file(), file!());\n+        assert_ne!(location.line(), line!(), \"line should be outside this fn\");\n+    }}\n+}\n+\n+trait Tracked {\n+    fn local_tracked(&self);\n+\n+    #[track_caller]\n+    fn blanket_tracked(&self);\n+\n+    #[track_caller]\n+    fn default_tracked(&self) {\n+        assert_expansion_site_is_tracked!();\n+    }\n+}\n+\n+impl Tracked for () {\n+    #[track_caller]\n+    fn local_tracked(&self) {\n+        assert_expansion_site_is_tracked!();\n+    }\n+\n+    fn blanket_tracked(&self) {\n+        assert_expansion_site_is_tracked!();\n+    }\n+}\n+\n+impl Tracked for bool {\n+    #[track_caller]\n+    fn local_tracked(&self) {\n+        assert_expansion_site_is_tracked!();\n+    }\n+\n+    fn blanket_tracked(&self) {\n+        assert_expansion_site_is_tracked!();\n+    }\n+\n+    fn default_tracked(&self) {\n+        assert_expansion_site_is_tracked!();\n+    }\n+}\n+\n+impl Tracked for u8 {\n+    #[track_caller]\n+    fn local_tracked(&self) {\n+        assert_expansion_site_is_tracked!();\n+    }\n+\n+    fn blanket_tracked(&self) {\n+        assert_expansion_site_is_tracked!();\n+    }\n+\n+    #[track_caller]\n+    fn default_tracked(&self) {\n+        assert_expansion_site_is_tracked!();\n+    }\n+}\n+\n+fn main() {\n+    ().local_tracked();\n+    ().default_tracked();\n+    ().blanket_tracked();\n+\n+    true.local_tracked();\n+    true.default_tracked();\n+    true.blanket_tracked();\n+\n+    0u8.local_tracked();\n+    0u8.default_tracked();\n+    0u8.blanket_tracked();\n+}"}]}