{"sha": "163dbda22bb70d9ed05147b85670cc13dcf906f3", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE2M2RiZGEyMmJiNzBkOWVkMDUxNDdiODU2NzBjYzEzZGNmOTA2ZjM=", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2021-06-16T04:31:04Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-06-16T04:31:04Z"}, "message": "Rollup merge of #85283 - Swatinem:ordered-profraw, r=tmandry\n\nAvoid possible filename collision in coverage tests\n\nPreviously, coverage tests were writing profiler data to files based on\ntheir pid. As rustdoc spawns each doctest as its own process, it might\nbe possible in rare cases that a pid is being reused which would cause\na file to be overwritten, leading to incorrect coverage results.\n\nshould help with #83262\n\nr? `@tmandry`", "tree": {"sha": "b7de6a9358f69db2f4b9be551bf1c2d4c9ed2351", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b7de6a9358f69db2f4b9be551bf1c2d4c9ed2351"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/163dbda22bb70d9ed05147b85670cc13dcf906f3", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgyX6JCRBK7hj4Ov3rIwAAnf4IAKGtC/qnMAH7DaUMChKH69Lp\nYfPQ2sDiGO0oWN3vNQkbkJq7yQWDJAC+s7AfvdboQUFe4jByrRzIXvqzkaRYaC/o\ngeT3KloIjIhW8y7T0qQQoY42e62GjfOo+uS0uDL+r7rEi4rtQXC5fnEn1wp/wEBs\n6ErXWlwRhAQEoJYVw91nHs3Wxry8LSVJ5E8A0HB1RvpkQCPjhCY9eXiWs4pFtKr8\n9xKU0OlwUXo13y0LRV8U6g7jrJQZVQeItYSsxQ6UhSe/grVivgen8HtL+8xGz/9Y\nfwq0uMhLvJJ9j6Kk9Ti8AiM4jrC46HbeZeMXQnsWGT4duOTDS1ATy6mUYnIGdxc=\n=5+ve\n-----END PGP SIGNATURE-----\n", "payload": "tree b7de6a9358f69db2f4b9be551bf1c2d4c9ed2351\nparent d192c80d2284ba6b5146bb3da586354c3762c72b\nparent 084794ed164199619d9bd6e5422b4feaee4a0a9a\nauthor Yuki Okushi <jtitor@2k36.org> 1623817864 +0900\ncommitter GitHub <noreply@github.com> 1623817864 +0900\n\nRollup merge of #85283 - Swatinem:ordered-profraw, r=tmandry\n\nAvoid possible filename collision in coverage tests\n\nPreviously, coverage tests were writing profiler data to files based on\ntheir pid. As rustdoc spawns each doctest as its own process, it might\nbe possible in rare cases that a pid is being reused which would cause\na file to be overwritten, leading to incorrect coverage results.\n\nshould help with #83262\n\nr? `@tmandry`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/163dbda22bb70d9ed05147b85670cc13dcf906f3", "html_url": "https://github.com/rust-lang/rust/commit/163dbda22bb70d9ed05147b85670cc13dcf906f3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/163dbda22bb70d9ed05147b85670cc13dcf906f3/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d192c80d2284ba6b5146bb3da586354c3762c72b", "url": "https://api.github.com/repos/rust-lang/rust/commits/d192c80d2284ba6b5146bb3da586354c3762c72b", "html_url": "https://github.com/rust-lang/rust/commit/d192c80d2284ba6b5146bb3da586354c3762c72b"}, {"sha": "084794ed164199619d9bd6e5422b4feaee4a0a9a", "url": "https://api.github.com/repos/rust-lang/rust/commits/084794ed164199619d9bd6e5422b4feaee4a0a9a", "html_url": "https://github.com/rust-lang/rust/commit/084794ed164199619d9bd6e5422b4feaee4a0a9a"}], "stats": {"total": 14, "additions": 8, "deletions": 6}, "files": [{"sha": "78fbf811f12bf5b70aa2ad0842db9bbb5a5ad748", "filename": "src/test/run-make-fulldeps/coverage-reports/Makefile", "status": "modified", "additions": 8, "deletions": 6, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/163dbda22bb70d9ed05147b85670cc13dcf906f3/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/163dbda22bb70d9ed05147b85670cc13dcf906f3/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2FMakefile?ref=163dbda22bb70d9ed05147b85670cc13dcf906f3", "patch": "@@ -87,7 +87,7 @@ endif\n \t# Run it in order to generate some profiling data,\n \t# with `LLVM_PROFILE_FILE=<profdata_file>` environment variable set to\n \t# output the coverage stats for this run.\n-\tLLVM_PROFILE_FILE=\"$(TMPDIR)\"/$@-%p.profraw \\\n+\tLLVM_PROFILE_FILE=\"$(TMPDIR)\"/$@.profraw \\\n \t\t\t$(call RUN,$@) || \\\n \t\t\t( \\\n \t\t\t\tstatus=$$?; \\\n@@ -97,16 +97,19 @@ endif\n \t\t\t\t) \\\n \t\t\t)\n \n-\t# Run it through rustdoc as well to cover doctests\n-\tLLVM_PROFILE_FILE=\"$(TMPDIR)\"/$@-%p.profraw \\\n+\t# Run it through rustdoc as well to cover doctests.\n+\t# `%p` is the pid, and `%m` the binary signature. We suspect that the pid alone\n+\t# might result in overwritten files and failed tests, as rustdoc spawns each\n+\t# doctest as its own process, so make sure the filename is as unique as possible.\n+\tLLVM_PROFILE_FILE=\"$(TMPDIR)\"/$@-%p-%m.profraw \\\n \t\t\t$(RUSTDOC) --crate-name workaround_for_79771 --test $(SOURCEDIR)/$@.rs \\\n \t\t\t$$( sed -n 's/^\\/\\/ compile-flags: \\([^#]*\\).*/\\1/p' $(SOURCEDIR)/$@.rs ) \\\n \t\t\t-L \"$(TMPDIR)\" -Zinstrument-coverage \\\n \t\t\t-Z unstable-options --persist-doctests=$(TMPDIR)/rustdoc-$@\n \n \t# Postprocess the profiling data so it can be used by the llvm-cov tool\n \t\"$(LLVM_BIN_DIR)\"/llvm-profdata merge --sparse \\\n-\t\t\t\"$(TMPDIR)\"/$@-*.profraw \\\n+\t\t\t\"$(TMPDIR)\"/$@*.profraw \\\n \t\t\t-o \"$(TMPDIR)\"/$@.profdata\n \n \t# Generate a coverage report using `llvm-cov show`.\n@@ -118,8 +121,7 @@ endif\n \t\t\t--instr-profile=\"$(TMPDIR)\"/$@.profdata \\\n \t\t\t$(call BIN,\"$(TMPDIR)\"/$@) \\\n \t\t\t$$( \\\n-\t\t\t\tfor file in $(TMPDIR)/rustdoc-$@/*/rust_out; \\\n-\t\t\t\tdo \\\n+\t\t\t\tfor file in $(TMPDIR)/rustdoc-$@/*/rust_out; do \\\n \t\t\t\t[ -x \"$$file\" ] && printf \"%s %s \" -object $$file; \\\n \t\t\t\tdone \\\n \t\t\t) \\"}]}