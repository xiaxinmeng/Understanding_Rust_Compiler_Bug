{"sha": "1aceaaa969d85195966e453590cbfc68771bf904", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFhY2VhYWE5NjlkODUxOTU5NjZlNDUzNTkwY2JmYzY4NzcxYmY5MDQ=", "commit": {"author": {"name": "Nicholas Nethercote", "email": "nnethercote@mozilla.com", "date": "2019-10-31T21:52:14Z"}, "committer": {"name": "Nicholas Nethercote", "email": "nnethercote@mozilla.com", "date": "2019-11-03T23:15:55Z"}, "message": "Avoid hashing the key twice in `get_query()`.\n\nFor a single-threaded parallel compiler, this reduces instruction counts\nacross several benchmarks, by up to 2.8%.\n\nThe commit also adds documentation about `Sharded`'s use of `FxHasher`.", "tree": {"sha": "532279a17abc0c00c22481366e65954081e7e47f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/532279a17abc0c00c22481366e65954081e7e47f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1aceaaa969d85195966e453590cbfc68771bf904", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1aceaaa969d85195966e453590cbfc68771bf904", "html_url": "https://github.com/rust-lang/rust/commit/1aceaaa969d85195966e453590cbfc68771bf904", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1aceaaa969d85195966e453590cbfc68771bf904/comments", "author": {"login": "nnethercote", "id": 1940286, "node_id": "MDQ6VXNlcjE5NDAyODY=", "avatar_url": "https://avatars.githubusercontent.com/u/1940286?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nnethercote", "html_url": "https://github.com/nnethercote", "followers_url": "https://api.github.com/users/nnethercote/followers", "following_url": "https://api.github.com/users/nnethercote/following{/other_user}", "gists_url": "https://api.github.com/users/nnethercote/gists{/gist_id}", "starred_url": "https://api.github.com/users/nnethercote/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nnethercote/subscriptions", "organizations_url": "https://api.github.com/users/nnethercote/orgs", "repos_url": "https://api.github.com/users/nnethercote/repos", "events_url": "https://api.github.com/users/nnethercote/events{/privacy}", "received_events_url": "https://api.github.com/users/nnethercote/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nnethercote", "id": 1940286, "node_id": "MDQ6VXNlcjE5NDAyODY=", "avatar_url": "https://avatars.githubusercontent.com/u/1940286?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nnethercote", "html_url": "https://github.com/nnethercote", "followers_url": "https://api.github.com/users/nnethercote/followers", "following_url": "https://api.github.com/users/nnethercote/following{/other_user}", "gists_url": "https://api.github.com/users/nnethercote/gists{/gist_id}", "starred_url": "https://api.github.com/users/nnethercote/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nnethercote/subscriptions", "organizations_url": "https://api.github.com/users/nnethercote/orgs", "repos_url": "https://api.github.com/users/nnethercote/repos", "events_url": "https://api.github.com/users/nnethercote/events{/privacy}", "received_events_url": "https://api.github.com/users/nnethercote/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b497e18995d6b6992f97512c6b86b5cb3f2f34f5", "url": "https://api.github.com/repos/rust-lang/rust/commits/b497e18995d6b6992f97512c6b86b5cb3f2f34f5", "html_url": "https://github.com/rust-lang/rust/commit/b497e18995d6b6992f97512c6b86b5cb3f2f34f5"}], "stats": {"total": 23, "additions": 20, "deletions": 3}, "files": [{"sha": "3c4845e6346cf75a3bcd3558a1f2f1eb116cf88c", "filename": "src/librustc/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/1aceaaa969d85195966e453590cbfc68771bf904/src%2Flibrustc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1aceaaa969d85195966e453590cbfc68771bf904/src%2Flibrustc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Flib.rs?ref=1aceaaa969d85195966e453590cbfc68771bf904", "patch": "@@ -61,6 +61,7 @@\n #![feature(log_syntax)]\n #![feature(associated_type_bounds)]\n #![feature(rustc_attrs)]\n+#![feature(hash_raw_entry)]\n \n #![recursion_limit=\"512\"]\n "}, {"sha": "323c8eb18b0c11e1478fd3c9cb200d1673c438b8", "filename": "src/librustc/ty/query/plumbing.rs", "status": "modified", "additions": 13, "deletions": 3, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/1aceaaa969d85195966e453590cbfc68771bf904/src%2Flibrustc%2Fty%2Fquery%2Fplumbing.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1aceaaa969d85195966e453590cbfc68771bf904/src%2Flibrustc%2Fty%2Fquery%2Fplumbing.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fquery%2Fplumbing.rs?ref=1aceaaa969d85195966e453590cbfc68771bf904", "patch": "@@ -14,12 +14,13 @@ use errors::Level;\n use errors::Diagnostic;\n use errors::FatalError;\n use errors::Handler;\n-use rustc_data_structures::fx::{FxHashMap};\n+use rustc_data_structures::fx::{FxHasher, FxHashMap};\n use rustc_data_structures::sync::{Lrc, Lock};\n use rustc_data_structures::sharded::Sharded;\n use rustc_data_structures::thin_vec::ThinVec;\n #[cfg(not(parallel_compiler))]\n use rustc_data_structures::cold_path;\n+use std::hash::{Hash, Hasher};\n use std::mem;\n use std::ptr;\n use std::collections::hash_map::Entry;\n@@ -80,8 +81,17 @@ impl<'a, 'tcx, Q: QueryDescription<'tcx>> JobOwner<'a, 'tcx, Q> {\n     pub(super) fn try_get(tcx: TyCtxt<'tcx>, span: Span, key: &Q::Key) -> TryGetJob<'a, 'tcx, Q> {\n         let cache = Q::query_cache(tcx);\n         loop {\n-            let mut lock = cache.get_shard_by_value(key).lock();\n-            if let Some(value) = lock.results.get(key) {\n+            // We compute the key's hash once and then use it for both the\n+            // shard lookup and the hashmap lookup. This relies on the fact\n+            // that both of them use `FxHasher`.\n+            let mut state = FxHasher::default();\n+            key.hash(&mut state);\n+            let key_hash = state.finish();\n+\n+            let mut lock = cache.get_shard_by_hash(key_hash).lock();\n+            if let Some((_, value)) =\n+                lock.results.raw_entry().from_key_hashed_nocheck(key_hash, key)\n+            {\n                 tcx.prof.query_cache_hit(Q::NAME);\n                 let result = (value.value.clone(), value.index);\n                 #[cfg(debug_assertions)]"}, {"sha": "a28a5e0f0415a575a8c32683f36153c7674b3b9f", "filename": "src/librustc_data_structures/sharded.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/1aceaaa969d85195966e453590cbfc68771bf904/src%2Flibrustc_data_structures%2Fsharded.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1aceaaa969d85195966e453590cbfc68771bf904/src%2Flibrustc_data_structures%2Fsharded.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_data_structures%2Fsharded.rs?ref=1aceaaa969d85195966e453590cbfc68771bf904", "patch": "@@ -60,6 +60,7 @@ impl<T> Sharded<T> {\n         }\n     }\n \n+    /// The shard is selected by hashing `val` with `FxHasher`.\n     #[inline]\n     pub fn get_shard_by_value<K: Hash + ?Sized>(&self, val: &K) -> &Lock<T> {\n         if SHARDS == 1 {\n@@ -69,6 +70,11 @@ impl<T> Sharded<T> {\n         }\n     }\n \n+    /// Get a shard with a pre-computed hash value. If `get_shard_by_value` is\n+    /// ever used in combination with `get_shard_by_hash` on a single `Sharded`\n+    /// instance, then `hash` must be computed with `FxHasher`. Otherwise,\n+    /// `hash` can be computed with any hasher, so long as that hasher is used\n+    /// consistently for each `Sharded` instance.\n     #[inline]\n     pub fn get_shard_by_hash(&self, hash: u64) -> &Lock<T> {\n         let hash_len = mem::size_of::<usize>();"}]}