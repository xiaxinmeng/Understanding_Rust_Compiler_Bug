{"sha": "1dc13b5904cde9279b76909013cd40e1661fe8eb", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFkYzEzYjU5MDRjZGU5Mjc5Yjc2OTA5MDEzY2Q0MGUxNjYxZmU4ZWI=", "commit": {"author": {"name": "Tomas Koutsky", "email": "tomas@stepnivlk.net", "date": "2019-04-21T14:09:30Z"}, "committer": {"name": "Tomas Koutsky", "email": "tomas@stepnivlk.net", "date": "2019-04-22T21:17:19Z"}, "message": "Remove visit_subpats from check_pat in favor of state in EllipsisInclusiveRangePatterns", "tree": {"sha": "cbb7faf6130dfec55050c6dde83cb8688400e0ca", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/cbb7faf6130dfec55050c6dde83cb8688400e0ca"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1dc13b5904cde9279b76909013cd40e1661fe8eb", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1dc13b5904cde9279b76909013cd40e1661fe8eb", "html_url": "https://github.com/rust-lang/rust/commit/1dc13b5904cde9279b76909013cd40e1661fe8eb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1dc13b5904cde9279b76909013cd40e1661fe8eb/comments", "author": null, "committer": null, "parents": [{"sha": "6d599337fa7047307ba72786bbabe6b9c9e4daac", "url": "https://api.github.com/repos/rust-lang/rust/commits/6d599337fa7047307ba72786bbabe6b9c9e4daac", "html_url": "https://github.com/rust-lang/rust/commit/6d599337fa7047307ba72786bbabe6b9c9e4daac"}], "stats": {"total": 48, "additions": 37, "deletions": 11}, "files": [{"sha": "34bf4adffc6b805e4bf2b030ba8a2a917cf0874f", "filename": "src/librustc/lint/context.rs", "status": "modified", "additions": 3, "deletions": 5, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/1dc13b5904cde9279b76909013cd40e1661fe8eb/src%2Flibrustc%2Flint%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1dc13b5904cde9279b76909013cd40e1661fe8eb/src%2Flibrustc%2Flint%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Flint%2Fcontext.rs?ref=1dc13b5904cde9279b76909013cd40e1661fe8eb", "patch": "@@ -1164,12 +1164,10 @@ impl<'a, T: EarlyLintPass> ast_visit::Visitor<'a> for EarlyContextAndPass<'a, T>\n     }\n \n     fn visit_pat(&mut self, p: &'a ast::Pat) {\n-        let mut visit_subpats = true;\n-        run_early_pass!(self, check_pat, p, &mut visit_subpats);\n+        run_early_pass!(self, check_pat, p);\n         self.check_id(p.id);\n-        if visit_subpats {\n-            ast_visit::walk_pat(self, p);\n-        }\n+        ast_visit::walk_pat(self, p);\n+        run_early_pass!(self, check_pat_post, p);\n     }\n \n     fn visit_expr(&mut self, e: &'a ast::Expr) {"}, {"sha": "6613440ee7c9e52cbef0971c77f7646f35ab8b2c", "filename": "src/librustc/lint/mod.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/1dc13b5904cde9279b76909013cd40e1661fe8eb/src%2Flibrustc%2Flint%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1dc13b5904cde9279b76909013cd40e1661fe8eb/src%2Flibrustc%2Flint%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Flint%2Fmod.rs?ref=1dc13b5904cde9279b76909013cd40e1661fe8eb", "patch": "@@ -371,7 +371,8 @@ macro_rules! early_lint_methods {\n             fn check_block_post(a: &ast::Block);\n             fn check_stmt(a: &ast::Stmt);\n             fn check_arm(a: &ast::Arm);\n-            fn check_pat(a: &ast::Pat, b: &mut bool); // FIXME: &mut bool looks just broken\n+            fn check_pat(a: &ast::Pat);\n+            fn check_pat_post(a: &ast::Pat);\n             fn check_expr(a: &ast::Expr);\n             fn check_expr_post(a: &ast::Expr);\n             fn check_ty(a: &ast::Ty);"}, {"sha": "57bc44ee30cd96549c04feddc78cd36b2ab22aac", "filename": "src/librustc_lint/builtin.rs", "status": "modified", "additions": 30, "deletions": 3, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/1dc13b5904cde9279b76909013cd40e1661fe8eb/src%2Flibrustc_lint%2Fbuiltin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1dc13b5904cde9279b76909013cd40e1661fe8eb/src%2Flibrustc_lint%2Fbuiltin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_lint%2Fbuiltin.rs?ref=1dc13b5904cde9279b76909013cd40e1661fe8eb", "patch": "@@ -1285,10 +1285,29 @@ declare_lint! {\n     \"`...` range patterns are deprecated\"\n }\n \n-declare_lint_pass!(EllipsisInclusiveRangePatterns => [ELLIPSIS_INCLUSIVE_RANGE_PATTERNS]);\n+pub struct EllipsisInclusiveRangePatterns {\n+    /// If `Some(_)`, suppress all subsequent pattern\n+    /// warnings for better diagnostics.\n+    node_id: Option<ast::NodeId>,\n+}\n+\n+impl_lint_pass!(EllipsisInclusiveRangePatterns => [ELLIPSIS_INCLUSIVE_RANGE_PATTERNS]);\n+\n+impl EllipsisInclusiveRangePatterns {\n+    pub fn new() -> Self {\n+        Self {\n+            node_id: None,\n+        }\n+    }\n+}\n \n impl EarlyLintPass for EllipsisInclusiveRangePatterns {\n-    fn check_pat(&mut self, cx: &EarlyContext<'_>, pat: &ast::Pat, visit_subpats: &mut bool) {\n+    fn check_pat(&mut self, cx: &EarlyContext<'_>, pat: &ast::Pat) {\n+        if self.node_id.is_some() {\n+            // Don't recursively warn about patterns inside range endpoints.\n+            return\n+        }\n+\n         use self::ast::{PatKind, RangeEnd, RangeSyntax::DotDotDot};\n \n         /// If `pat` is a `...` pattern, return the start and end of the range, as well as the span\n@@ -1311,7 +1330,7 @@ impl EarlyLintPass for EllipsisInclusiveRangePatterns {\n             let msg = \"`...` range patterns are deprecated\";\n             let suggestion = \"use `..=` for an inclusive range\";\n             if parenthesise {\n-                *visit_subpats = false;\n+                self.node_id = Some(pat.id);\n                 let mut err = cx.struct_span_lint(ELLIPSIS_INCLUSIVE_RANGE_PATTERNS, pat.span, msg);\n                 err.span_suggestion(\n                     pat.span,\n@@ -1332,6 +1351,14 @@ impl EarlyLintPass for EllipsisInclusiveRangePatterns {\n             };\n         }\n     }\n+\n+    fn check_pat_post(&mut self, _cx: &EarlyContext<'_>, pat: &ast::Pat) {\n+        if let Some(node_id) = self.node_id {\n+            if pat.id == node_id {\n+                self.node_id = None\n+            }\n+        }\n+    }\n }\n \n declare_lint! {"}, {"sha": "68ea219561962280e30a1aa994bd90c3ab4615ab", "filename": "src/librustc_lint/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1dc13b5904cde9279b76909013cd40e1661fe8eb/src%2Flibrustc_lint%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1dc13b5904cde9279b76909013cd40e1661fe8eb/src%2Flibrustc_lint%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_lint%2Flib.rs?ref=1dc13b5904cde9279b76909013cd40e1661fe8eb", "patch": "@@ -94,7 +94,7 @@ macro_rules! early_lint_passes {\n             UnusedImportBraces: UnusedImportBraces,\n             UnsafeCode: UnsafeCode,\n             AnonymousParameters: AnonymousParameters,\n-            EllipsisInclusiveRangePatterns: EllipsisInclusiveRangePatterns,\n+            EllipsisInclusiveRangePatterns: EllipsisInclusiveRangePatterns::new(),\n             NonCamelCaseTypes: NonCamelCaseTypes,\n             DeprecatedAttr: DeprecatedAttr::new(),\n         ]);"}, {"sha": "043bc62ddce602dc98c70b96d599b1a56ea6408d", "filename": "src/librustc_lint/unused.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1dc13b5904cde9279b76909013cd40e1661fe8eb/src%2Flibrustc_lint%2Funused.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1dc13b5904cde9279b76909013cd40e1661fe8eb/src%2Flibrustc_lint%2Funused.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_lint%2Funused.rs?ref=1dc13b5904cde9279b76909013cd40e1661fe8eb", "patch": "@@ -407,7 +407,7 @@ impl EarlyLintPass for UnusedParens {\n         self.check_unused_parens_expr(cx, &value, msg, followed_by_block);\n     }\n \n-    fn check_pat(&mut self, cx: &EarlyContext<'_>, p: &ast::Pat, _: &mut bool) {\n+    fn check_pat(&mut self, cx: &EarlyContext<'_>, p: &ast::Pat) {\n         use ast::PatKind::{Paren, Range};\n         // The lint visitor will visit each subpattern of `p`. We do not want to lint any range\n         // pattern no matter where it occurs in the pattern. For something like `&(a..=b)`, there"}]}