{"sha": "a966f54bbb4325c74450ae65d2ca771eca652516", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE5NjZmNTRiYmI0MzI1Yzc0NDUwYWU2NWQyY2E3NzFlY2E2NTI1MTY=", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2020-09-28T16:39:47Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-09-28T16:39:47Z"}, "message": "Rollup merge of #77288 - RalfJung:miri-macos, r=Amanieu\n\nfix building libstd for Miri on macOS\n\nFixes a Miri regression introduced by https://github.com/rust-lang/rust/pull/75295\nCc @tmiasko @Amanieu", "tree": {"sha": "3cf055350f52d0b246d59efab93979fa990f825e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3cf055350f52d0b246d59efab93979fa990f825e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a966f54bbb4325c74450ae65d2ca771eca652516", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfchHUCRBK7hj4Ov3rIwAAdHIIAA8IIKEPRRCtNIBL0SOF/Oaf\nm877JB8wvkftwltjhEV4t+jsgD19JvJPdoClzNJTcnv607HL5Mz3pQ8ma8PQcDer\n67bb6lMsSBdN0K/LN8fn5dN+iUMNIxotU3Tv42ym8315i3euBHPW+5J0hv8kB3uU\nabGDp1Z14NAPj2pko4EvC/U8P9v+lIiKQiMfyMXslzsT1nTg9Ju0+7jt79MQ4Q2c\nyi1oblerMFXVqT7Epom4viBfazqJOvmVfpzaY7bl0+fuOUo04wVuGZYqtrsJj6Jp\nG383l0rktrQZ8u/uTxv1AjX8eoE1e7W4Mjfz4GN0BR/q/YeunCoomaPMom95mys=\n=Yv6j\n-----END PGP SIGNATURE-----\n", "payload": "tree 3cf055350f52d0b246d59efab93979fa990f825e\nparent aba966a592b29249a652c3632f4c209e00e30795\nparent dc8414b6076656b0722b0d5a8230a8613d8ccb57\nauthor Ralf Jung <post@ralfj.de> 1601311187 +0200\ncommitter GitHub <noreply@github.com> 1601311187 +0200\n\nRollup merge of #77288 - RalfJung:miri-macos, r=Amanieu\n\nfix building libstd for Miri on macOS\n\nFixes a Miri regression introduced by https://github.com/rust-lang/rust/pull/75295\nCc @tmiasko @Amanieu\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a966f54bbb4325c74450ae65d2ca771eca652516", "html_url": "https://github.com/rust-lang/rust/commit/a966f54bbb4325c74450ae65d2ca771eca652516", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a966f54bbb4325c74450ae65d2ca771eca652516/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "aba966a592b29249a652c3632f4c209e00e30795", "url": "https://api.github.com/repos/rust-lang/rust/commits/aba966a592b29249a652c3632f4c209e00e30795", "html_url": "https://github.com/rust-lang/rust/commit/aba966a592b29249a652c3632f4c209e00e30795"}, {"sha": "dc8414b6076656b0722b0d5a8230a8613d8ccb57", "url": "https://api.github.com/repos/rust-lang/rust/commits/dc8414b6076656b0722b0d5a8230a8613d8ccb57", "html_url": "https://github.com/rust-lang/rust/commit/dc8414b6076656b0722b0d5a8230a8613d8ccb57"}], "stats": {"total": 99, "additions": 50, "deletions": 49}, "files": [{"sha": "00680fadc18dc58e225cc4e6a2baff186f326fcd", "filename": "library/std/src/sys/unix/mod.rs", "status": "modified", "additions": 50, "deletions": 49, "changes": 99, "blob_url": "https://github.com/rust-lang/rust/blob/a966f54bbb4325c74450ae65d2ca771eca652516/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a966f54bbb4325c74450ae65d2ca771eca652516/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fmod.rs?ref=a966f54bbb4325c74450ae65d2ca771eca652516", "patch": "@@ -93,60 +93,61 @@ pub fn init() {\n         reset_sigpipe();\n     }\n \n-    // In the case when all file descriptors are open, the poll has been\n-    // observed to perform better than fcntl (on GNU/Linux).\n-    #[cfg(not(any(\n-        miri,\n-        target_os = \"emscripten\",\n-        target_os = \"fuchsia\",\n-        // The poll on Darwin doesn't set POLLNVAL for closed fds.\n-        target_os = \"macos\",\n-        target_os = \"ios\",\n-        target_os = \"redox\",\n-    )))]\n-    unsafe fn sanitize_standard_fds() {\n-        use crate::sys::os::errno;\n-        let pfds: &mut [_] = &mut [\n-            libc::pollfd { fd: 0, events: 0, revents: 0 },\n-            libc::pollfd { fd: 1, events: 0, revents: 0 },\n-            libc::pollfd { fd: 2, events: 0, revents: 0 },\n-        ];\n-        while libc::poll(pfds.as_mut_ptr(), 3, 0) == -1 {\n-            if errno() == libc::EINTR {\n-                continue;\n-            }\n-            libc::abort();\n-        }\n-        for pfd in pfds {\n-            if pfd.revents & libc::POLLNVAL == 0 {\n-                continue;\n-            }\n-            if libc::open(\"/dev/null\\0\".as_ptr().cast(), libc::O_RDWR, 0) == -1 {\n-                // If the stream is closed but we failed to reopen it, abort the\n-                // process. Otherwise we wouldn't preserve the safety of\n-                // operations on the corresponding Rust object Stdin, Stdout, or\n-                // Stderr.\n-                libc::abort();\n-            }\n-        }\n-    }\n-    #[cfg(any(target_os = \"macos\", target_os = \"ios\", target_os = \"redox\"))]\n-    unsafe fn sanitize_standard_fds() {\n-        use crate::sys::os::errno;\n-        for fd in 0..3 {\n-            if libc::fcntl(fd, libc::F_GETFD) == -1 && errno() == libc::EBADF {\n-                if libc::open(\"/dev/null\\0\".as_ptr().cast(), libc::O_RDWR, 0) == -1 {\n+    cfg_if::cfg_if! {\n+        if #[cfg(miri)] {\n+            // The standard fds are always available in Miri.\n+            unsafe fn sanitize_standard_fds() {}\n+        } else if #[cfg(not(any(\n+            target_os = \"emscripten\",\n+            target_os = \"fuchsia\",\n+            // The poll on Darwin doesn't set POLLNVAL for closed fds.\n+            target_os = \"macos\",\n+            target_os = \"ios\",\n+            target_os = \"redox\",\n+        )))] {\n+            // In the case when all file descriptors are open, the poll has been\n+            // observed to perform better than fcntl (on GNU/Linux).\n+            unsafe fn sanitize_standard_fds() {\n+                use crate::sys::os::errno;\n+                let pfds: &mut [_] = &mut [\n+                    libc::pollfd { fd: 0, events: 0, revents: 0 },\n+                    libc::pollfd { fd: 1, events: 0, revents: 0 },\n+                    libc::pollfd { fd: 2, events: 0, revents: 0 },\n+                ];\n+                while libc::poll(pfds.as_mut_ptr(), 3, 0) == -1 {\n+                    if errno() == libc::EINTR {\n+                        continue;\n+                    }\n                     libc::abort();\n                 }\n+                for pfd in pfds {\n+                    if pfd.revents & libc::POLLNVAL == 0 {\n+                        continue;\n+                    }\n+                    if libc::open(\"/dev/null\\0\".as_ptr().cast(), libc::O_RDWR, 0) == -1 {\n+                        // If the stream is closed but we failed to reopen it, abort the\n+                        // process. Otherwise we wouldn't preserve the safety of\n+                        // operations on the corresponding Rust object Stdin, Stdout, or\n+                        // Stderr.\n+                        libc::abort();\n+                    }\n+                }\n+            }\n+        } else if #[cfg(any(target_os = \"macos\", target_os = \"ios\", target_os = \"redox\"))] {\n+            unsafe fn sanitize_standard_fds() {\n+                use crate::sys::os::errno;\n+                for fd in 0..3 {\n+                    if libc::fcntl(fd, libc::F_GETFD) == -1 && errno() == libc::EBADF {\n+                        if libc::open(\"/dev/null\\0\".as_ptr().cast(), libc::O_RDWR, 0) == -1 {\n+                            libc::abort();\n+                        }\n+                    }\n+                }\n             }\n+        } else {\n+            unsafe fn sanitize_standard_fds() {}\n         }\n     }\n-    #[cfg(any(\n-        // The standard fds are always available in Miri.\n-        miri,\n-        target_os = \"emscripten\",\n-        target_os = \"fuchsia\"))]\n-    unsafe fn sanitize_standard_fds() {}\n \n     #[cfg(not(any(target_os = \"emscripten\", target_os = \"fuchsia\")))]\n     unsafe fn reset_sigpipe() {"}]}