{"sha": "1d72037dd39e3e53172d7605f22851b75f4e1a1b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFkNzIwMzdkZDM5ZTNlNTMxNzJkNzYwNWYyMjg1MWI3NWY0ZTFhMWI=", "commit": {"author": {"name": "Dan Robertson", "email": "dan@dlrobertson.com", "date": "2019-03-07T03:50:50Z"}, "committer": {"name": "Dan Robertson", "email": "dan@dlrobertson.com", "date": "2019-03-07T16:31:01Z"}, "message": "Fix segfaults in release build C-variadic fns\n\n`va_start` and `va_end` must be called to initialize/cleanup the\n\"spoofed\" `VaList` in a Rust defined C-variadic function even if\nthe `VaList` is not used.", "tree": {"sha": "1a5c3a32f019c6ca48114ab9e1316e9a5c90ffe3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1a5c3a32f019c6ca48114ab9e1316e9a5c90ffe3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1d72037dd39e3e53172d7605f22851b75f4e1a1b", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEF5dO2RaKc5C+SCJ9RcSmUsR+QqUFAlyBR0gACgkQRcSmUsR+\nQqUP4Q/9Et6x/3XL3Nw6IAnuXF6PEr/Uv4G529CR5CiQcaKQAlDlN/C05nkVXags\nJ2MCppuw3z+QXFCLXcDw7Rng2yGXj9gx+JWVBLnOPjjpMK3Da1nXU0z2g1/jsueA\n+avifP6KkAfQADCNctjmKsR1Tf/j/YIVgmI5GEepxo3C0pyJATDfmJO+qPCwyeXi\nACbs4cFraGZMgp5KZw9YSYOAPo/1gut3mtVtE+p2m5OApa9oEAN4YIUvHJmE/e6A\n6547rar2BX6jvkbkrKOW4Fw53/atpbAsQ8t6jxHNHUAgoQnx3yWntiD+XsPPoW0v\nZ7kuG3GYmiqAZVcZouUgPRH+x1MTMwd1hya05+JPZ+xNwJyyXquDd1SlIf7MKmQt\n3StK0a23Y3G+juoKH2qfPXkr/RZQPGsHn1IvhNVTtWekGyfgVv1IhWzRoLjrhwpP\n8YLaV/PNz61a6ZkKWzNmtK2Twcrx2e32uRoFmQYcPn6ro232zDLglhy5Xb4IBPQb\n3LIJEU9r7aK1mn7/fA0FtHhN7vfzR33L3xQTUFRcOY5/AetHaJoTeO4jziMrOW8i\nn4CSDg53FbRAagoYlH9N2BhYB2lGN4Aj7Pk5wthNRTi7G19s+YN7M/1FUT6UB4SI\nfVKOpYOW7IdfgJUuPBipkLczaoC3IuSNJAK1UAl2f80Da2028z4=\n=bdaT\n-----END PGP SIGNATURE-----", "payload": "tree 1a5c3a32f019c6ca48114ab9e1316e9a5c90ffe3\nparent f22dca0a1bef4141e75326caacc3cd59f3d5be8e\nauthor Dan Robertson <dan@dlrobertson.com> 1551930650 +0000\ncommitter Dan Robertson <dan@dlrobertson.com> 1551976261 +0000\n\nFix segfaults in release build C-variadic fns\n\n`va_start` and `va_end` must be called to initialize/cleanup the\n\"spoofed\" `VaList` in a Rust defined C-variadic function even if\nthe `VaList` is not used.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1d72037dd39e3e53172d7605f22851b75f4e1a1b", "html_url": "https://github.com/rust-lang/rust/commit/1d72037dd39e3e53172d7605f22851b75f4e1a1b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1d72037dd39e3e53172d7605f22851b75f4e1a1b/comments", "author": {"login": "dlrobertson", "id": 7504153, "node_id": "MDQ6VXNlcjc1MDQxNTM=", "avatar_url": "https://avatars.githubusercontent.com/u/7504153?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dlrobertson", "html_url": "https://github.com/dlrobertson", "followers_url": "https://api.github.com/users/dlrobertson/followers", "following_url": "https://api.github.com/users/dlrobertson/following{/other_user}", "gists_url": "https://api.github.com/users/dlrobertson/gists{/gist_id}", "starred_url": "https://api.github.com/users/dlrobertson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dlrobertson/subscriptions", "organizations_url": "https://api.github.com/users/dlrobertson/orgs", "repos_url": "https://api.github.com/users/dlrobertson/repos", "events_url": "https://api.github.com/users/dlrobertson/events{/privacy}", "received_events_url": "https://api.github.com/users/dlrobertson/received_events", "type": "User", "site_admin": false}, "committer": {"login": "dlrobertson", "id": 7504153, "node_id": "MDQ6VXNlcjc1MDQxNTM=", "avatar_url": "https://avatars.githubusercontent.com/u/7504153?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dlrobertson", "html_url": "https://github.com/dlrobertson", "followers_url": "https://api.github.com/users/dlrobertson/followers", "following_url": "https://api.github.com/users/dlrobertson/following{/other_user}", "gists_url": "https://api.github.com/users/dlrobertson/gists{/gist_id}", "starred_url": "https://api.github.com/users/dlrobertson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dlrobertson/subscriptions", "organizations_url": "https://api.github.com/users/dlrobertson/orgs", "repos_url": "https://api.github.com/users/dlrobertson/repos", "events_url": "https://api.github.com/users/dlrobertson/events{/privacy}", "received_events_url": "https://api.github.com/users/dlrobertson/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f22dca0a1bef4141e75326caacc3cd59f3d5be8e", "url": "https://api.github.com/repos/rust-lang/rust/commits/f22dca0a1bef4141e75326caacc3cd59f3d5be8e", "html_url": "https://github.com/rust-lang/rust/commit/f22dca0a1bef4141e75326caacc3cd59f3d5be8e"}], "stats": {"total": 36, "additions": 27, "deletions": 9}, "files": [{"sha": "35fd30f34ad24e2a248224ff8fc6e73ce99cb3f7", "filename": "src/librustc_codegen_ssa/mir/block.rs", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/1d72037dd39e3e53172d7605f22851b75f4e1a1b/src%2Flibrustc_codegen_ssa%2Fmir%2Fblock.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d72037dd39e3e53172d7605f22851b75f4e1a1b/src%2Flibrustc_codegen_ssa%2Fmir%2Fblock.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_ssa%2Fmir%2Fblock.rs?ref=1d72037dd39e3e53172d7605f22851b75f4e1a1b", "patch": "@@ -233,8 +233,13 @@ impl<'a, 'tcx: 'a, Bx: BuilderMethods<'a, 'tcx>> FunctionCx<'a, 'tcx, Bx> {\n         mut bx: Bx,\n     ) {\n         if self.fn_ty.c_variadic {\n-            if let Some(va_list) = self.va_list_ref {\n-                bx.va_end(va_list.llval);\n+            match self.va_list_ref {\n+                Some(va_list) => {\n+                    bx.va_end(va_list.llval);\n+                }\n+                None => {\n+                    bug!(\"C-variadic function must have a `va_list_ref`\");\n+                }\n             }\n         }\n         let llval = match self.fn_ty.ret.mode {"}, {"sha": "c1b7502cd8fb2fe27f9203a5ac7eb47c22e1f647", "filename": "src/librustc_codegen_ssa/mir/mod.rs", "status": "modified", "additions": 1, "deletions": 7, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/1d72037dd39e3e53172d7605f22851b75f4e1a1b/src%2Flibrustc_codegen_ssa%2Fmir%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d72037dd39e3e53172d7605f22851b75f4e1a1b/src%2Flibrustc_codegen_ssa%2Fmir%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_ssa%2Fmir%2Fmod.rs?ref=1d72037dd39e3e53172d7605f22851b75f4e1a1b", "patch": "@@ -532,13 +532,7 @@ fn arg_local_refs<'a, 'tcx: 'a, Bx: BuilderMethods<'a, 'tcx>>(\n                 PassMode::Ignore(IgnoreMode::Zst) => {\n                     return local(OperandRef::new_zst(bx.cx(), arg.layout));\n                 }\n-                PassMode::Ignore(IgnoreMode::CVarArgs) => {\n-                    let backend_type = bx.cx().immediate_backend_type(arg.layout);\n-                    return local(OperandRef {\n-                        val: OperandValue::Immediate(bx.cx().const_undef(backend_type)),\n-                        layout: arg.layout,\n-                    });\n-                }\n+                PassMode::Ignore(IgnoreMode::CVarArgs) => {}\n                 PassMode::Direct(_) => {\n                     let llarg = bx.get_param(bx.llfn(), llarg_idx as c_uint);\n                     bx.set_value_name(llarg, &name);"}, {"sha": "8594d309b0a5aa743434ed3fae201c00a02e3b7c", "filename": "src/test/codegen/c-variadic-opt.rs", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/1d72037dd39e3e53172d7605f22851b75f4e1a1b/src%2Ftest%2Fcodegen%2Fc-variadic-opt.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d72037dd39e3e53172d7605f22851b75f4e1a1b/src%2Ftest%2Fcodegen%2Fc-variadic-opt.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fc-variadic-opt.rs?ref=1d72037dd39e3e53172d7605f22851b75f4e1a1b", "patch": "@@ -0,0 +1,19 @@\n+// compile-flags: -C opt-level=3\n+\n+#![crate_type = \"lib\"]\n+#![feature(c_variadic)]\n+#![no_std]\n+use core::ffi::VaList;\n+\n+extern \"C\" {\n+    fn vprintf(fmt: *const i8, ap: VaList) -> i32;\n+}\n+\n+// Ensure that `va_start` and `va_end` are properly injected even\n+// when the \"spoofed\" `VaList` is not used.\n+#[no_mangle]\n+pub unsafe extern \"C\" fn c_variadic_no_use(fmt: *const i8, mut ap: ...) -> i32 {\n+    // CHECK: call void @llvm.va_start\n+    vprintf(fmt, ap)\n+    // CHECK: call void @llvm.va_end\n+}"}]}