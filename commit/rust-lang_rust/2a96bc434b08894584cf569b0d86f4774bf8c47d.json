{"sha": "2a96bc434b08894584cf569b0d86f4774bf8c47d", "node_id": "MDY6Q29tbWl0NzI0NzEyOjJhOTZiYzQzNGIwODg5NDU4NGNmNTY5YjBkODZmNDc3NGJmOGM0N2Q=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-04-12T18:00:38Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-04-12T18:00:38Z"}, "message": "Auto merge of #7067 - TaKO8Ki:fix-false-negative-on-needless-return, r=llogiq\n\nFix a false negative on `needless return`\n\ncloses #7042\n\nchangelog: fix a false negative on `needless return`", "tree": {"sha": "98722dbe75972e92d718abe9a709a92cb6129087", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/98722dbe75972e92d718abe9a709a92cb6129087"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2a96bc434b08894584cf569b0d86f4774bf8c47d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2a96bc434b08894584cf569b0d86f4774bf8c47d", "html_url": "https://github.com/rust-lang/rust/commit/2a96bc434b08894584cf569b0d86f4774bf8c47d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2a96bc434b08894584cf569b0d86f4774bf8c47d/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "411c0df1d09813e58e009db4cd0e0161b0de1d03", "url": "https://api.github.com/repos/rust-lang/rust/commits/411c0df1d09813e58e009db4cd0e0161b0de1d03", "html_url": "https://github.com/rust-lang/rust/commit/411c0df1d09813e58e009db4cd0e0161b0de1d03"}, {"sha": "e6c67ad2bfd7bb9b4777bb95aea7c4ce70e2dd8a", "url": "https://api.github.com/repos/rust-lang/rust/commits/e6c67ad2bfd7bb9b4777bb95aea7c4ce70e2dd8a", "html_url": "https://github.com/rust-lang/rust/commit/e6c67ad2bfd7bb9b4777bb95aea7c4ce70e2dd8a"}], "stats": {"total": 299, "additions": 268, "deletions": 31}, "files": [{"sha": "3a6151dce710f13446b555d71b2426111de902e5", "filename": "clippy_lints/src/returns.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/2a96bc434b08894584cf569b0d86f4774bf8c47d/clippy_lints%2Fsrc%2Freturns.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2a96bc434b08894584cf569b0d86f4774bf8c47d/clippy_lints%2Fsrc%2Freturns.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Freturns.rs?ref=2a96bc434b08894584cf569b0d86f4774bf8c47d", "patch": "@@ -223,6 +223,7 @@ fn check_final_expr<'tcx>(\n             },\n             _ => (),\n         },\n+        ExprKind::DropTemps(expr) => check_final_expr(cx, expr, None, RetReplacement::Empty),\n         _ => (),\n     }\n }"}, {"sha": "5c4fd466c04187df5abf52be6a504374c59c919b", "filename": "tests/ui/needless_return.fixed", "status": "modified", "additions": 82, "deletions": 6, "changes": 88, "blob_url": "https://github.com/rust-lang/rust/blob/2a96bc434b08894584cf569b0d86f4774bf8c47d/tests%2Fui%2Fneedless_return.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/2a96bc434b08894584cf569b0d86f4774bf8c47d/tests%2Fui%2Fneedless_return.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fneedless_return.fixed?ref=2a96bc434b08894584cf569b0d86f4774bf8c47d", "patch": "@@ -1,4 +1,5 @@\n // run-rustfix\n+// edition:2018\n \n #![allow(unused)]\n #![allow(\n@@ -125,10 +126,85 @@ mod issue6501 {\n     }\n }\n \n-fn main() {\n-    let _ = test_end_of_fn();\n-    let _ = test_no_semicolon();\n-    let _ = test_if_block();\n-    let _ = test_match(true);\n-    test_closure();\n+async fn async_test_end_of_fn() -> bool {\n+    if true {\n+        // no error!\n+        return true;\n+    }\n+    true\n+}\n+\n+async fn async_test_no_semicolon() -> bool {\n+    true\n+}\n+\n+async fn async_test_if_block() -> bool {\n+    if true {\n+        true\n+    } else {\n+        false\n+    }\n+}\n+\n+async fn async_test_match(x: bool) -> bool {\n+    match x {\n+        true => false,\n+        false => {\n+            true\n+        },\n+    }\n+}\n+\n+async fn async_test_closure() {\n+    let _ = || {\n+        true\n+    };\n+    let _ = || true;\n+}\n+\n+async fn async_test_macro_call() -> i32 {\n+    return the_answer!();\n+}\n+\n+async fn async_test_void_fun() {\n+    \n+}\n+\n+async fn async_test_void_if_fun(b: bool) {\n+    if b {\n+        \n+    } else {\n+        \n+    }\n+}\n+\n+async fn async_test_void_match(x: u32) {\n+    match x {\n+        0 => (),\n+        _ => {},\n+    }\n+}\n+\n+async fn async_read_line() -> String {\n+    use std::io::BufRead;\n+    let stdin = ::std::io::stdin();\n+    return stdin.lock().lines().next().unwrap().unwrap();\n }\n+\n+async fn async_borrows_but_not_last(value: bool) -> String {\n+    if value {\n+        use std::io::BufRead;\n+        let stdin = ::std::io::stdin();\n+        let _a = stdin.lock().lines().next().unwrap().unwrap();\n+        String::from(\"test\")\n+    } else {\n+        String::new()\n+    }\n+}\n+\n+async fn async_test_return_in_macro() {\n+    needed_return!(10);\n+    needed_return!(0);\n+}\n+\n+fn main() {}"}, {"sha": "34811db7413a3ac5d90254dd7591c02b53b6556b", "filename": "tests/ui/needless_return.rs", "status": "modified", "additions": 82, "deletions": 6, "changes": 88, "blob_url": "https://github.com/rust-lang/rust/blob/2a96bc434b08894584cf569b0d86f4774bf8c47d/tests%2Fui%2Fneedless_return.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2a96bc434b08894584cf569b0d86f4774bf8c47d/tests%2Fui%2Fneedless_return.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fneedless_return.rs?ref=2a96bc434b08894584cf569b0d86f4774bf8c47d", "patch": "@@ -1,4 +1,5 @@\n // run-rustfix\n+// edition:2018\n \n #![allow(unused)]\n #![allow(\n@@ -125,10 +126,85 @@ mod issue6501 {\n     }\n }\n \n-fn main() {\n-    let _ = test_end_of_fn();\n-    let _ = test_no_semicolon();\n-    let _ = test_if_block();\n-    let _ = test_match(true);\n-    test_closure();\n+async fn async_test_end_of_fn() -> bool {\n+    if true {\n+        // no error!\n+        return true;\n+    }\n+    return true;\n+}\n+\n+async fn async_test_no_semicolon() -> bool {\n+    return true;\n+}\n+\n+async fn async_test_if_block() -> bool {\n+    if true {\n+        return true;\n+    } else {\n+        return false;\n+    }\n+}\n+\n+async fn async_test_match(x: bool) -> bool {\n+    match x {\n+        true => return false,\n+        false => {\n+            return true;\n+        },\n+    }\n+}\n+\n+async fn async_test_closure() {\n+    let _ = || {\n+        return true;\n+    };\n+    let _ = || return true;\n+}\n+\n+async fn async_test_macro_call() -> i32 {\n+    return the_answer!();\n+}\n+\n+async fn async_test_void_fun() {\n+    return;\n+}\n+\n+async fn async_test_void_if_fun(b: bool) {\n+    if b {\n+        return;\n+    } else {\n+        return;\n+    }\n+}\n+\n+async fn async_test_void_match(x: u32) {\n+    match x {\n+        0 => (),\n+        _ => return,\n+    }\n+}\n+\n+async fn async_read_line() -> String {\n+    use std::io::BufRead;\n+    let stdin = ::std::io::stdin();\n+    return stdin.lock().lines().next().unwrap().unwrap();\n }\n+\n+async fn async_borrows_but_not_last(value: bool) -> String {\n+    if value {\n+        use std::io::BufRead;\n+        let stdin = ::std::io::stdin();\n+        let _a = stdin.lock().lines().next().unwrap().unwrap();\n+        return String::from(\"test\");\n+    } else {\n+        return String::new();\n+    }\n+}\n+\n+async fn async_test_return_in_macro() {\n+    needed_return!(10);\n+    needed_return!(0);\n+}\n+\n+fn main() {}"}, {"sha": "74dda971fdabb632633f4a125ba15d6e2d5ad1a3", "filename": "tests/ui/needless_return.stderr", "status": "modified", "additions": 103, "deletions": 19, "changes": 122, "blob_url": "https://github.com/rust-lang/rust/blob/2a96bc434b08894584cf569b0d86f4774bf8c47d/tests%2Fui%2Fneedless_return.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2a96bc434b08894584cf569b0d86f4774bf8c47d/tests%2Fui%2Fneedless_return.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fneedless_return.stderr?ref=2a96bc434b08894584cf569b0d86f4774bf8c47d", "patch": "@@ -1,112 +1,196 @@\n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:23:5\n+  --> $DIR/needless_return.rs:24:5\n    |\n LL |     return true;\n    |     ^^^^^^^^^^^^ help: remove `return`: `true`\n    |\n    = note: `-D clippy::needless-return` implied by `-D warnings`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:27:5\n+  --> $DIR/needless_return.rs:28:5\n    |\n LL |     return true;\n    |     ^^^^^^^^^^^^ help: remove `return`: `true`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:32:9\n+  --> $DIR/needless_return.rs:33:9\n    |\n LL |         return true;\n    |         ^^^^^^^^^^^^ help: remove `return`: `true`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:34:9\n+  --> $DIR/needless_return.rs:35:9\n    |\n LL |         return false;\n    |         ^^^^^^^^^^^^^ help: remove `return`: `false`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:40:17\n+  --> $DIR/needless_return.rs:41:17\n    |\n LL |         true => return false,\n    |                 ^^^^^^^^^^^^ help: remove `return`: `false`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:42:13\n+  --> $DIR/needless_return.rs:43:13\n    |\n LL |             return true;\n    |             ^^^^^^^^^^^^ help: remove `return`: `true`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:49:9\n+  --> $DIR/needless_return.rs:50:9\n    |\n LL |         return true;\n    |         ^^^^^^^^^^^^ help: remove `return`: `true`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:51:16\n+  --> $DIR/needless_return.rs:52:16\n    |\n LL |     let _ = || return true;\n    |                ^^^^^^^^^^^ help: remove `return`: `true`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:59:5\n+  --> $DIR/needless_return.rs:60:5\n    |\n LL |     return;\n    |     ^^^^^^^ help: remove `return`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:64:9\n+  --> $DIR/needless_return.rs:65:9\n    |\n LL |         return;\n    |         ^^^^^^^ help: remove `return`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:66:9\n+  --> $DIR/needless_return.rs:67:9\n    |\n LL |         return;\n    |         ^^^^^^^ help: remove `return`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:73:14\n+  --> $DIR/needless_return.rs:74:14\n    |\n LL |         _ => return,\n    |              ^^^^^^ help: replace `return` with an empty block: `{}`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:88:9\n+  --> $DIR/needless_return.rs:89:9\n    |\n LL |         return String::from(\"test\");\n    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: remove `return`: `String::from(\"test\")`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:90:9\n+  --> $DIR/needless_return.rs:91:9\n    |\n LL |         return String::new();\n    |         ^^^^^^^^^^^^^^^^^^^^^ help: remove `return`: `String::new()`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:111:32\n+  --> $DIR/needless_return.rs:112:32\n    |\n LL |         bar.unwrap_or_else(|_| return)\n    |                                ^^^^^^ help: replace `return` with an empty block: `{}`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:116:13\n+  --> $DIR/needless_return.rs:117:13\n    |\n LL |             return;\n    |             ^^^^^^^ help: remove `return`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:118:20\n+  --> $DIR/needless_return.rs:119:20\n    |\n LL |         let _ = || return;\n    |                    ^^^^^^ help: replace `return` with an empty block: `{}`\n \n error: unneeded `return` statement\n-  --> $DIR/needless_return.rs:124:32\n+  --> $DIR/needless_return.rs:125:32\n    |\n LL |         res.unwrap_or_else(|_| return Foo)\n    |                                ^^^^^^^^^^ help: remove `return`: `Foo`\n \n-error: aborting due to 18 previous errors\n+error: unneeded `return` statement\n+  --> $DIR/needless_return.rs:134:5\n+   |\n+LL |     return true;\n+   |     ^^^^^^^^^^^^ help: remove `return`: `true`\n+\n+error: unneeded `return` statement\n+  --> $DIR/needless_return.rs:138:5\n+   |\n+LL |     return true;\n+   |     ^^^^^^^^^^^^ help: remove `return`: `true`\n+\n+error: unneeded `return` statement\n+  --> $DIR/needless_return.rs:143:9\n+   |\n+LL |         return true;\n+   |         ^^^^^^^^^^^^ help: remove `return`: `true`\n+\n+error: unneeded `return` statement\n+  --> $DIR/needless_return.rs:145:9\n+   |\n+LL |         return false;\n+   |         ^^^^^^^^^^^^^ help: remove `return`: `false`\n+\n+error: unneeded `return` statement\n+  --> $DIR/needless_return.rs:151:17\n+   |\n+LL |         true => return false,\n+   |                 ^^^^^^^^^^^^ help: remove `return`: `false`\n+\n+error: unneeded `return` statement\n+  --> $DIR/needless_return.rs:153:13\n+   |\n+LL |             return true;\n+   |             ^^^^^^^^^^^^ help: remove `return`: `true`\n+\n+error: unneeded `return` statement\n+  --> $DIR/needless_return.rs:160:9\n+   |\n+LL |         return true;\n+   |         ^^^^^^^^^^^^ help: remove `return`: `true`\n+\n+error: unneeded `return` statement\n+  --> $DIR/needless_return.rs:162:16\n+   |\n+LL |     let _ = || return true;\n+   |                ^^^^^^^^^^^ help: remove `return`: `true`\n+\n+error: unneeded `return` statement\n+  --> $DIR/needless_return.rs:170:5\n+   |\n+LL |     return;\n+   |     ^^^^^^^ help: remove `return`\n+\n+error: unneeded `return` statement\n+  --> $DIR/needless_return.rs:175:9\n+   |\n+LL |         return;\n+   |         ^^^^^^^ help: remove `return`\n+\n+error: unneeded `return` statement\n+  --> $DIR/needless_return.rs:177:9\n+   |\n+LL |         return;\n+   |         ^^^^^^^ help: remove `return`\n+\n+error: unneeded `return` statement\n+  --> $DIR/needless_return.rs:184:14\n+   |\n+LL |         _ => return,\n+   |              ^^^^^^ help: replace `return` with an empty block: `{}`\n+\n+error: unneeded `return` statement\n+  --> $DIR/needless_return.rs:199:9\n+   |\n+LL |         return String::from(\"test\");\n+   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: remove `return`: `String::from(\"test\")`\n+\n+error: unneeded `return` statement\n+  --> $DIR/needless_return.rs:201:9\n+   |\n+LL |         return String::new();\n+   |         ^^^^^^^^^^^^^^^^^^^^^ help: remove `return`: `String::new()`\n+\n+error: aborting due to 32 previous errors\n "}]}