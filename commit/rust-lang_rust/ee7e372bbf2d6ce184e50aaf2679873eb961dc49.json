{"sha": "ee7e372bbf2d6ce184e50aaf2679873eb961dc49", "node_id": "MDY6Q29tbWl0NzI0NzEyOmVlN2UzNzJiYmYyZDZjZTE4NGU1MGFhZjI2Nzk4NzNlYjk2MWRjNDk=", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2017-10-29T17:22:13Z"}, "committer": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2017-11-01T12:41:43Z"}, "message": "Remove duplicated results in the search", "tree": {"sha": "257081d9713fefc097a9a1db55bc1710885be7e7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/257081d9713fefc097a9a1db55bc1710885be7e7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ee7e372bbf2d6ce184e50aaf2679873eb961dc49", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ee7e372bbf2d6ce184e50aaf2679873eb961dc49", "html_url": "https://github.com/rust-lang/rust/commit/ee7e372bbf2d6ce184e50aaf2679873eb961dc49", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ee7e372bbf2d6ce184e50aaf2679873eb961dc49/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e8db5adcce3034b7cde6c62f7bcf9ff52970105c", "url": "https://api.github.com/repos/rust-lang/rust/commits/e8db5adcce3034b7cde6c62f7bcf9ff52970105c", "html_url": "https://github.com/rust-lang/rust/commit/e8db5adcce3034b7cde6c62f7bcf9ff52970105c"}], "stats": {"total": 135, "additions": 88, "deletions": 47}, "files": [{"sha": "b1120e0af38949e13daa2d1eb2125e2098291766", "filename": "src/librustdoc/html/static/main.js", "status": "modified", "additions": 88, "deletions": 47, "changes": 135, "blob_url": "https://github.com/rust-lang/rust/blob/ee7e372bbf2d6ce184e50aaf2679873eb961dc49/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fmain.js", "raw_url": "https://github.com/rust-lang/rust/raw/ee7e372bbf2d6ce184e50aaf2679873eb961dc49/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fmain.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fmain.js?ref=ee7e372bbf2d6ce184e50aaf2679873eb961dc49", "patch": "@@ -349,7 +349,7 @@\n             var valLower = query.query.toLowerCase(),\n                 val = valLower,\n                 typeFilter = itemTypeFromName(query.type),\n-                results = [],\n+                results = {},\n                 split = valLower.split(\"::\");\n \n             // remove empty keywords\n@@ -360,6 +360,23 @@\n                 }\n             }\n \n+            function min(a, b) {\n+                if (a < b) {\n+                    return a;\n+                }\n+                return b;\n+            }\n+\n+            function nbElements(obj) {\n+                var size = 0, key;\n+                for (key in obj) {\n+                    if (obj.hasOwnProperty(key)) {\n+                        size += 1;\n+                    }\n+                }\n+                return size;\n+            }\n+\n             function findArg(obj, val) {\n                 var lev_distance = MAX_LEV_DISTANCE + 1;\n                 if (obj && obj.type && obj.type.inputs.length > 0) {\n@@ -368,23 +385,27 @@\n                             // No need to check anything else: we found it. Let's just move on.\n                             return 0;\n                         }\n-                        var tmp = levenshtein(obj.type.inputs[i].name, val);\n-                        if (tmp < lev_distance) {\n-                            lev_distance = tmp;\n+                        lev_distance = min(levenshtein(obj.type.inputs[i].name, val), lev_distance);\n+                        if (lev_distance === 0) {\n+                            return 0;\n                         }\n                     }\n                 }\n                 return lev_distance;\n             }\n \n             function checkReturned(obj, val) {\n+                var lev_distance = MAX_LEV_DISTANCE + 1;\n                 if (obj && obj.type && obj.type.output) {\n                     if (obj.type.output.name.toLowerCase() === val) {\n                         return 0;\n                     }\n-                    return levenshtein(obj.type.output.name.toLowerCase(), val);\n+                    lev_distance = min(levenshtein(obj.type.output.name, val));\n+                    if (lev_distance === 0) {\n+                        return 0;\n+                    }\n                 }\n-                return MAX_LEV_DISTANCE + 1;\n+                return lev_distance;\n             }\n \n             function typePassesFilter(filter, type) {\n@@ -414,22 +435,27 @@\n             if ((val.charAt(0) === \"\\\"\" || val.charAt(0) === \"'\") &&\n                 val.charAt(val.length - 1) === val.charAt(0))\n             {\n-                val = val.substr(1, val.length - 2);\n+                val = val.substr(1, val.length - 2).toLowerCase();\n                 for (var i = 0; i < nSearchWords; ++i) {\n+                    var ty = searchIndex[i];\n                     if (searchWords[i] === val) {\n                         // filter type: ... queries\n                         if (typePassesFilter(typeFilter, searchIndex[i].ty)) {\n-                            results.push({id: i, index: -1});\n+                            results[ty.path + ty.name] = {id: i, index: -1};\n                         }\n-                    } else if (findArg(searchIndex[i], val.toLowerCase()) ||\n-                               (searchIndex[i].type &&\n-                                searchIndex[i].type.output &&\n-                                searchIndex[i].type.output.name === val.toLowerCase())) {\n+                    } else if (findArg(searchIndex[i], val) ||\n+                               (ty.type &&\n+                                ty.type.output &&\n+                                ty.type.output.name === val)) {\n                         if (typePassesFilter(typeFilter, searchIndex[i].ty)) {\n-                            results.push({id: i, index: -1, dontValidate: true});\n+                            results[ty.path + ty.name] = {\n+                                id: i,\n+                                index: -1,\n+                                dontValidate: true,\n+                            };\n                         }\n                     }\n-                    if (results.length === max) {\n+                    if (nbElements(results) === max) {\n                         break;\n                     }\n                 }\n@@ -447,6 +473,7 @@\n \n                 for (var i = 0; i < nSearchWords; ++i) {\n                     var type = searchIndex[i].type;\n+                    var ty = searchIndex[i];\n                     if (!type) {\n                         continue;\n                     }\n@@ -460,7 +487,7 @@\n                     var typeOutput = type.output ? type.output.name : \"\";\n                     if (output === \"*\" || output == typeOutput) {\n                         if (input === \"*\") {\n-                            results.push({id: i, index: -1, dontValidate: true});\n+                            results[ty.path + ty.name] = {id: i, index: -1, dontValidate: true};\n                         } else {\n                             var allFound = true;\n                             for (var it = 0; allFound === true && it < inputs.length; it++) {\n@@ -471,7 +498,11 @@\n                                 allFound = found;\n                             }\n                             if (allFound === true) {\n-                                results.push({id: i, index: -1, dontValidate: true});\n+                                results[ty.path + ty.name] = {\n+                                    id: i,\n+                                    index: -1,\n+                                    dontValidate: true,\n+                                };\n                             }\n                         }\n                     }\n@@ -487,57 +518,77 @@\n                 for (var i = 0; i < split.length; ++i) {\n                     for (var j = 0; j < nSearchWords; ++j) {\n                         var lev_distance;\n+                        var ty = searchIndex[j];\n+                        if (!ty) {\n+                            continue;\n+                        }\n                         if (searchWords[j].indexOf(split[i]) > -1 ||\n                             searchWords[j].indexOf(val) > -1 ||\n                             searchWords[j].replace(/_/g, \"\").indexOf(val) > -1)\n                         {\n                             // filter type: ... queries\n                             if (typePassesFilter(typeFilter, searchIndex[j].ty)) {\n-                                results.push({\n+                                results[ty.path + ty.name] = {\n                                     id: j,\n                                     index: searchWords[j].replace(/_/g, \"\").indexOf(val),\n                                     lev: 0,\n-                                });\n+                                };\n                             }\n                         } else if (\n                             (lev_distance = levenshtein(searchWords[j], val)) <= MAX_LEV_DISTANCE) {\n                             if (typePassesFilter(typeFilter, searchIndex[j].ty)) {\n-                                results.push({\n-                                    id: j,\n-                                    index: 0,\n-                                    // we want lev results to go lower than others\n-                                    lev: lev_distance,\n-                                });\n+                                if (results[ty.path + ty.name] === undefined ||\n+                                    results[ty.path + ty.name].lev > lev_distance) {\n+                                    results[ty.path + ty.name] = {\n+                                        id: j,\n+                                        index: 0,\n+                                        // we want lev results to go lower than others\n+                                        lev: lev_distance,\n+                                    };\n+                                }\n                             }\n                         } else if (\n                             (lev_distance = findArg(searchIndex[j], val)) <= MAX_LEV_DISTANCE) {\n                             if (typePassesFilter(typeFilter, searchIndex[j].ty)) {\n-                                results.push({\n-                                    id: j,\n-                                    index: 0,\n-                                    // we want lev results to go lower than others\n-                                    lev: lev_distance,\n-                                });\n+                                if (results[ty.path + ty.name] === undefined ||\n+                                    results[ty.path + ty.name].lev > lev_distance) {\n+                                    results[ty.path + ty.name] = {\n+                                        id: j,\n+                                        index: 0,\n+                                        // we want lev results to go lower than others\n+                                        lev: lev_distance,\n+                                    };\n+                                }\n                             }\n                         } else if (\n                             (lev_distance = checkReturned(searchIndex[j], val)) <=\n                             MAX_LEV_DISTANCE) {\n                             if (typePassesFilter(typeFilter, searchIndex[j].ty)) {\n-                                results.push({\n-                                    id: j,\n-                                    index: 0,\n-                                    // we want lev results to go lower than others\n-                                    lev: lev_distance,\n-                                });\n+                                if (results[ty.path + ty.name] === undefined ||\n+                                    results[ty.path + ty.name].lev > lev_distance) {\n+                                    results[ty.path + ty.name] = {\n+                                        id: j,\n+                                        index: 0,\n+                                        // we want lev results to go lower than others\n+                                        lev: lev_distance,\n+                                    };\n+                                }\n                             }\n                         }\n-                        if (results.length === max) {\n+                        if (nbElements(results) === max) {\n                             break;\n                         }\n                     }\n                 }\n             }\n \n+            var ar = [];\n+            for (var entry in results) {\n+                if (results.hasOwnProperty(entry)) {\n+                    ar.push(results[entry]);\n+                }\n+            }\n+            results = ar;\n             var nresults = results.length;\n             for (var i = 0; i < nresults; ++i) {\n                 results[i].word = searchWords[results[i].id];\n@@ -613,16 +664,6 @@\n                 return 0;\n             });\n \n-            // remove duplicates, according to the data provided\n-            for (var i = results.length - 1; i > 0; i -= 1) {\n-                if (results[i].word === results[i - 1].word &&\n-                    results[i].item.ty === results[i - 1].item.ty &&\n-                    results[i].item.path === results[i - 1].item.path &&\n-                    (results[i].item.parent || {}).name === (results[i - 1].item.parent || {}).name)\n-                {\n-                    results[i].id = -1;\n-                }\n-            }\n             for (var i = 0; i < results.length; ++i) {\n                 var result = results[i],\n                     name = result.item.name.toLowerCase(),"}]}