{"sha": "fd318a2f9b3027be74900114a5c6edfc5fb8ec86", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZkMzE4YTJmOWIzMDI3YmU3NDkwMDExNGE1YzZlZGZjNWZiOGVjODY=", "commit": {"author": {"name": "Camille GILLOT", "email": "gillot.camille@gmail.com", "date": "2021-05-10T17:09:30Z"}, "committer": {"name": "Camille GILLOT", "email": "gillot.camille@gmail.com", "date": "2021-05-30T13:15:22Z"}, "message": "Reduce amount of function pointers.", "tree": {"sha": "c3ed9c7adfaa6ab21d4a0a4b0eddf7065ed10166", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c3ed9c7adfaa6ab21d4a0a4b0eddf7065ed10166"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fd318a2f9b3027be74900114a5c6edfc5fb8ec86", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fd318a2f9b3027be74900114a5c6edfc5fb8ec86", "html_url": "https://github.com/rust-lang/rust/commit/fd318a2f9b3027be74900114a5c6edfc5fb8ec86", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fd318a2f9b3027be74900114a5c6edfc5fb8ec86/comments", "author": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "committer": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f60a67025607e74fbee31c2007f8791c2f352b6a", "url": "https://api.github.com/repos/rust-lang/rust/commits/f60a67025607e74fbee31c2007f8791c2f352b6a", "html_url": "https://github.com/rust-lang/rust/commit/f60a67025607e74fbee31c2007f8791c2f352b6a"}], "stats": {"total": 97, "additions": 58, "deletions": 39}, "files": [{"sha": "de1f89b4468fd0ac97597e2039607ac8c462de03", "filename": "compiler/rustc_query_impl/src/plumbing.rs", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/fd318a2f9b3027be74900114a5c6edfc5fb8ec86/compiler%2Frustc_query_impl%2Fsrc%2Fplumbing.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd318a2f9b3027be74900114a5c6edfc5fb8ec86/compiler%2Frustc_query_impl%2Fsrc%2Fplumbing.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_query_impl%2Fsrc%2Fplumbing.rs?ref=fd318a2f9b3027be74900114a5c6edfc5fb8ec86", "patch": "@@ -386,14 +386,15 @@ macro_rules! define_queries {\n             }\n \n             #[inline]\n-            fn compute(tcx: QueryCtxt<'tcx>, key: Self::Key) -> Self::Value {\n+            fn compute_fn(tcx: QueryCtxt<'tcx>, key: &Self::Key) ->\n+                fn(TyCtxt<'tcx>, Self::Key) -> Self::Value\n+            {\n                 let is_local = key.query_crate() == LOCAL_CRATE;\n-                let provider = if is_local {\n+                if is_local {\n                     tcx.queries.local_providers.$name\n                 } else {\n                     tcx.queries.extern_providers.$name\n-                };\n-                provider(*tcx, key)\n+                }\n             }\n \n             fn hash_result("}, {"sha": "d1e527dff9840e6b5fa0ab314c93083a34d36a4b", "filename": "compiler/rustc_query_system/src/query/config.rs", "status": "modified", "additions": 1, "deletions": 9, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/fd318a2f9b3027be74900114a5c6edfc5fb8ec86/compiler%2Frustc_query_system%2Fsrc%2Fquery%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd318a2f9b3027be74900114a5c6edfc5fb8ec86/compiler%2Frustc_query_system%2Fsrc%2Fquery%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_query_system%2Fsrc%2Fquery%2Fconfig.rs?ref=fd318a2f9b3027be74900114a5c6edfc5fb8ec86", "patch": "@@ -23,9 +23,6 @@ pub(crate) struct QueryVtable<CTX: QueryContext, K, V> {\n     pub dep_kind: CTX::DepKind,\n     pub eval_always: bool,\n \n-    // Don't use this method to compute query results, instead use the methods on TyCtxt\n-    pub compute: fn(CTX, K) -> V,\n-\n     pub hash_result: fn(&mut CTX::StableHashingContext, &V) -> Option<Fingerprint>,\n     pub handle_cycle_error: fn(CTX, DiagnosticBuilder<'_>) -> V,\n     pub cache_on_disk: fn(CTX, &K, Option<&V>) -> bool,\n@@ -40,10 +37,6 @@ impl<CTX: QueryContext, K, V> QueryVtable<CTX, K, V> {\n         DepNode::construct(tcx, self.dep_kind, key)\n     }\n \n-    pub(crate) fn compute(&self, tcx: CTX, key: K) -> V {\n-        (self.compute)(tcx, key)\n-    }\n-\n     pub(crate) fn hash_result(\n         &self,\n         hcx: &mut CTX::StableHashingContext,\n@@ -79,7 +72,7 @@ pub trait QueryAccessors<CTX: QueryContext>: QueryConfig {\n         CTX: 'a;\n \n     // Don't use this method to compute query results, instead use the methods on TyCtxt\n-    fn compute(tcx: CTX, key: Self::Key) -> Self::Value;\n+    fn compute_fn(tcx: CTX, key: &Self::Key) -> fn(CTX::DepContext, Self::Key) -> Self::Value;\n \n     fn hash_result(\n         hcx: &mut CTX::StableHashingContext,\n@@ -115,7 +108,6 @@ where\n         anon: Q::ANON,\n         dep_kind: Q::DEP_KIND,\n         eval_always: Q::EVAL_ALWAYS,\n-        compute: Q::compute,\n         hash_result: Q::hash_result,\n         handle_cycle_error: Q::handle_cycle_error,\n         cache_on_disk: Q::cache_on_disk,"}, {"sha": "c227c2aaff549164f2101449b12dac782666132e", "filename": "compiler/rustc_query_system/src/query/plumbing.rs", "status": "modified", "additions": 52, "deletions": 26, "changes": 78, "blob_url": "https://github.com/rust-lang/rust/blob/fd318a2f9b3027be74900114a5c6edfc5fb8ec86/compiler%2Frustc_query_system%2Fsrc%2Fquery%2Fplumbing.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd318a2f9b3027be74900114a5c6edfc5fb8ec86/compiler%2Frustc_query_system%2Fsrc%2Fquery%2Fplumbing.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_query_system%2Fsrc%2Fquery%2Fplumbing.rs?ref=fd318a2f9b3027be74900114a5c6edfc5fb8ec86", "patch": "@@ -428,6 +428,7 @@ fn try_execute_query<CTX, C>(\n     key: C::Key,\n     lookup: QueryLookup,\n     query: &QueryVtable<CTX, C::Key, C::Value>,\n+    compute: fn(CTX::DepContext, C::Key) -> C::Value,\n ) -> C::Stored\n where\n     C: QueryCache,\n@@ -457,7 +458,7 @@ where\n     // Fast path for when incr. comp. is off.\n     if !dep_graph.is_fully_enabled() {\n         let prof_timer = tcx.dep_context().profiler().query_provider();\n-        let result = tcx.start_query(job.id, None, || query.compute(tcx, key));\n+        let result = tcx.start_query(job.id, None, || compute(*tcx.dep_context(), key));\n         let dep_node_index = dep_graph.next_virtual_depnode_index();\n         prof_timer.finish_with_query_invocation_id(dep_node_index.into());\n         return job.complete(result, dep_node_index);\n@@ -468,8 +469,9 @@ where\n \n         let ((result, dep_node_index), diagnostics) = with_diagnostics(|diagnostics| {\n             tcx.start_query(job.id, diagnostics, || {\n-                dep_graph\n-                    .with_anon_task(*tcx.dep_context(), query.dep_kind, || query.compute(tcx, key))\n+                dep_graph.with_anon_task(*tcx.dep_context(), query.dep_kind, || {\n+                    compute(*tcx.dep_context(), key)\n+                })\n             })\n         });\n \n@@ -501,6 +503,7 @@ where\n                         dep_node_index,\n                         &dep_node,\n                         query,\n+                        compute,\n                     ),\n                     dep_node_index,\n                 )\n@@ -511,7 +514,7 @@ where\n         }\n     }\n \n-    let (result, dep_node_index) = force_query_with_job(tcx, key, job, dep_node, query);\n+    let (result, dep_node_index) = force_query_with_job(tcx, key, job, dep_node, query, compute);\n     dep_graph.read_index(dep_node_index);\n     result\n }\n@@ -523,6 +526,7 @@ fn load_from_disk_and_cache_in_memory<CTX, K, V: Debug>(\n     dep_node_index: DepNodeIndex,\n     dep_node: &DepNode<CTX::DepKind>,\n     query: &QueryVtable<CTX, K, V>,\n+    compute: fn(CTX::DepContext, K) -> V,\n ) -> V\n where\n     CTX: QueryContext,\n@@ -565,7 +569,7 @@ where\n         let prof_timer = tcx.dep_context().profiler().query_provider();\n \n         // The dep-graph for this computation is already in-place.\n-        let result = tcx.dep_context().dep_graph().with_ignore(|| query.compute(tcx, key));\n+        let result = tcx.dep_context().dep_graph().with_ignore(|| compute(*tcx.dep_context(), key));\n \n         prof_timer.finish_with_query_invocation_id(dep_node_index.into());\n \n@@ -627,6 +631,7 @@ fn force_query_with_job<C, CTX>(\n     job: JobOwner<'_, CTX::DepKind, C>,\n     dep_node: DepNode<CTX::DepKind>,\n     query: &QueryVtable<CTX, C::Key, C::Value>,\n+    compute: fn(CTX::DepContext, C::Key) -> C::Value,\n ) -> (C::Stored, DepNodeIndex)\n where\n     C: QueryCache,\n@@ -653,17 +658,17 @@ where\n             if query.eval_always {\n                 tcx.dep_context().dep_graph().with_eval_always_task(\n                     dep_node,\n-                    tcx,\n+                    *tcx.dep_context(),\n                     key,\n-                    query.compute,\n+                    compute,\n                     query.hash_result,\n                 )\n             } else {\n                 tcx.dep_context().dep_graph().with_task(\n                     dep_node,\n-                    tcx,\n+                    *tcx.dep_context(),\n                     key,\n-                    query.compute,\n+                    compute,\n                     query.hash_result,\n                 )\n             }\n@@ -690,13 +695,14 @@ fn get_query_impl<CTX, C>(\n     key: C::Key,\n     lookup: QueryLookup,\n     query: &QueryVtable<CTX, C::Key, C::Value>,\n+    compute: fn(CTX::DepContext, C::Key) -> C::Value,\n ) -> C::Stored\n where\n     CTX: QueryContext,\n     C: QueryCache,\n     C::Key: DepNodeParams<CTX::DepContext>,\n {\n-    try_execute_query(tcx, state, cache, span, key, lookup, query)\n+    try_execute_query(tcx, state, cache, span, key, lookup, query, compute)\n }\n \n /// Ensure that either this query has all green inputs or been executed.\n@@ -744,8 +750,10 @@ fn force_query_impl<CTX, C>(\n     tcx: CTX,\n     state: &QueryState<CTX::DepKind, C::Key>,\n     cache: &QueryCacheStore<C>,\n+    key: C::Key,\n     dep_node: DepNode<CTX::DepKind>,\n     query: &QueryVtable<CTX, C::Key, C::Value>,\n+    compute: fn(CTX::DepContext, C::Key) -> C::Value,\n ) -> bool\n where\n     C: QueryCache,\n@@ -754,18 +762,6 @@ where\n {\n     debug_assert!(!query.anon);\n \n-    if !<C::Key as DepNodeParams<CTX::DepContext>>::can_reconstruct_query_key() {\n-        return false;\n-    }\n-\n-    let key = if let Some(key) =\n-        <C::Key as DepNodeParams<CTX::DepContext>>::recover(*tcx.dep_context(), &dep_node)\n-    {\n-        key\n-    } else {\n-        return false;\n-    };\n-\n     // We may be concurrently trying both execute and force a query.\n     // Ensure that only one of them runs the query.\n     let cached = cache.cache.lookup(cache, &key, |_, index| {\n@@ -798,7 +794,7 @@ where\n         TryGetJob::JobCompleted(_) => return true,\n     };\n \n-    force_query_with_job(tcx, key, job, dep_node, query);\n+    force_query_with_job(tcx, key, job, dep_node, query, compute);\n \n     true\n }\n@@ -828,8 +824,17 @@ where\n     }\n \n     debug!(\"ty::query::get_query<{}>(key={:?}, span={:?})\", Q::NAME, key, span);\n-    let value =\n-        get_query_impl(tcx, Q::query_state(tcx), Q::query_cache(tcx), span, key, lookup, query);\n+    let compute = Q::compute_fn(tcx, &key);\n+    let value = get_query_impl(\n+        tcx,\n+        Q::query_state(tcx),\n+        Q::query_cache(tcx),\n+        span,\n+        key,\n+        lookup,\n+        query,\n+        compute,\n+    );\n     Some(value)\n }\n \n@@ -843,5 +848,26 @@ where\n         return false;\n     }\n \n-    force_query_impl(tcx, Q::query_state(tcx), Q::query_cache(tcx), *dep_node, &Q::VTABLE)\n+    if !<Q::Key as DepNodeParams<CTX::DepContext>>::can_reconstruct_query_key() {\n+        return false;\n+    }\n+\n+    let key = if let Some(key) =\n+        <Q::Key as DepNodeParams<CTX::DepContext>>::recover(*tcx.dep_context(), &dep_node)\n+    {\n+        key\n+    } else {\n+        return false;\n+    };\n+\n+    let compute = Q::compute_fn(tcx, &key);\n+    force_query_impl(\n+        tcx,\n+        Q::query_state(tcx),\n+        Q::query_cache(tcx),\n+        key,\n+        *dep_node,\n+        &Q::VTABLE,\n+        compute,\n+    )\n }"}]}