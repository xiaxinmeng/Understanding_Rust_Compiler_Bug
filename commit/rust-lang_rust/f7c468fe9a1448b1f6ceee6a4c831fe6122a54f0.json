{"sha": "f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY3YzQ2OGZlOWExNDQ4YjFmNmNlZWU2YTRjODMxZmU2MTIyYTU0ZjA=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-04-25T01:57:10Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-04-25T01:57:10Z"}, "message": "Auto merge of #80339 - jyn514:no-span, r=GuillaumeGomez\n\nCalculate `span` info on-demand\n\n- Add helper `attr_span` for common reused function\n- Stop storing `Span`s on `Item` directly; calculate them on demand instead\n- Special case modules, which have different spans depending on whether\n  you use inner or outer attributes\n- Special case impls with fake IDs, which can have either dummy spans (for auto traits) or the DefId of the impl block (for blanket impls)\n- Use a fake ID for primitives instead of the ID of the crate; this lets\n  `source()` know that it should use a dummy span instead of the span of\n  the crate.\n\nThis shrinks `Item` from 48 to 40 bytes.\n\nHelps with https://github.com/rust-lang/rust/issues/76382.", "tree": {"sha": "c068cc9a2a5b1aa8b29d30d48fd551f813067a58", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c068cc9a2a5b1aa8b29d30d48fd551f813067a58"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0", "html_url": "https://github.com/rust-lang/rust/commit/f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b56b175c6c3d77f66793b2062b6325f822c87136", "url": "https://api.github.com/repos/rust-lang/rust/commits/b56b175c6c3d77f66793b2062b6325f822c87136", "html_url": "https://github.com/rust-lang/rust/commit/b56b175c6c3d77f66793b2062b6325f822c87136"}, {"sha": "ba361428509ddabfcee5b4274d4068d4d612f963", "url": "https://api.github.com/repos/rust-lang/rust/commits/ba361428509ddabfcee5b4274d4068d4d612f963", "html_url": "https://github.com/rust-lang/rust/commit/ba361428509ddabfcee5b4274d4068d4d612f963"}], "stats": {"total": 135, "additions": 80, "deletions": 55}, "files": [{"sha": "010059a89c9b1ae0b94d10eb883d193d7624a534", "filename": "src/librustdoc/clean/auto_trait.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0/src%2Flibrustdoc%2Fclean%2Fauto_trait.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0/src%2Flibrustdoc%2Fclean%2Fauto_trait.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Fauto_trait.rs?ref=f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0", "patch": "@@ -110,12 +110,12 @@ impl<'a, 'tcx> AutoTraitFinder<'a, 'tcx> {\n         };\n \n         Some(Item {\n-            span: Span::dummy(),\n             name: None,\n             attrs: Default::default(),\n             visibility: Inherited,\n             def_id: self.cx.next_def_id(item_def_id.krate),\n             kind: box ImplItem(Impl {\n+                span: Span::dummy(),\n                 unsafety: hir::Unsafety::Normal,\n                 generics: new_generics,\n                 provided_trait_methods: Default::default(),"}, {"sha": "50c0fb85d5aa04fc0b3f035bd8e9b93f9d86dd16", "filename": "src/librustdoc/clean/blanket_impl.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0/src%2Flibrustdoc%2Fclean%2Fblanket_impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0/src%2Flibrustdoc%2Fclean%2Fblanket_impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Fblanket_impl.rs?ref=f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0", "patch": "@@ -100,12 +100,12 @@ impl<'a, 'tcx> BlanketImplFinder<'a, 'tcx> {\n                     .collect();\n \n                 impls.push(Item {\n-                    span: self.cx.tcx.def_span(impl_def_id).clean(self.cx),\n                     name: None,\n                     attrs: Default::default(),\n                     visibility: Inherited,\n                     def_id: self.cx.next_def_id(impl_def_id.krate),\n                     kind: box ImplItem(Impl {\n+                        span: self.cx.tcx.def_span(impl_def_id).clean(self.cx),\n                         unsafety: hir::Unsafety::Normal,\n                         generics: (\n                             self.cx.tcx.generics_of(impl_def_id),"}, {"sha": "e88a739d04296500ffc2a06f19361885d9fdd079", "filename": "src/librustdoc/clean/inline.rs", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0/src%2Flibrustdoc%2Fclean%2Finline.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0/src%2Flibrustdoc%2Fclean%2Finline.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Finline.rs?ref=f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0", "patch": "@@ -6,7 +6,7 @@ use rustc_ast as ast;\n use rustc_data_structures::fx::FxHashSet;\n use rustc_hir as hir;\n use rustc_hir::def::{DefKind, Res};\n-use rustc_hir::def_id::{DefId, CRATE_DEF_INDEX};\n+use rustc_hir::def_id::DefId;\n use rustc_hir::Mutability;\n use rustc_metadata::creader::LoadedMacro;\n use rustc_middle::ty::{self, TyCtxt};\n@@ -422,6 +422,7 @@ crate fn build_impl(\n         did,\n         None,\n         clean::ImplItem(clean::Impl {\n+            span: clean::types::rustc_span(did, cx.tcx),\n             unsafety: hir::Unsafety::Normal,\n             generics,\n             provided_trait_methods: provided,\n@@ -459,8 +460,7 @@ fn build_module(\n                 items.push(clean::Item {\n                     name: None,\n                     attrs: box clean::Attributes::default(),\n-                    span: clean::Span::dummy(),\n-                    def_id: DefId::local(CRATE_DEF_INDEX),\n+                    def_id: cx.next_def_id(did.krate),\n                     visibility: clean::Public,\n                     kind: box clean::ImportItem(clean::Import::new_simple(\n                         item.ident.name,\n@@ -487,7 +487,8 @@ fn build_module(\n         }\n     }\n \n-    clean::Module { items }\n+    let span = clean::Span::from_rustc_span(cx.tcx.def_span(did));\n+    clean::Module { items, span }\n }\n \n crate fn print_inlined_const(tcx: TyCtxt<'_>, did: DefId) -> String {"}, {"sha": "c0a8c88bdeba09dd9b10b1e9510642bbdb6f0785", "filename": "src/librustdoc/clean/mod.rs", "status": "modified", "additions": 9, "deletions": 6, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0/src%2Flibrustdoc%2Fclean%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0/src%2Flibrustdoc%2Fclean%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Fmod.rs?ref=f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0", "patch": "@@ -100,7 +100,7 @@ impl Clean<Item> for doctree::Module<'_> {\n \n         // determine if we should display the inner contents or\n         // the outer `mod` item for the source code.\n-        let span = {\n+        let span = Span::from_rustc_span({\n             let sm = cx.sess().source_map();\n             let outer = sm.lookup_char_pos(self.where_outer.lo());\n             let inner = sm.lookup_char_pos(self.where_inner.lo());\n@@ -111,11 +111,14 @@ impl Clean<Item> for doctree::Module<'_> {\n                 // mod foo; (and a separate SourceFile for the contents)\n                 self.where_inner\n             }\n-        };\n+        });\n \n-        let what_rustc_thinks =\n-            Item::from_hir_id_and_parts(self.id, Some(self.name), ModuleItem(Module { items }), cx);\n-        Item { span: span.clean(cx), ..what_rustc_thinks }\n+        Item::from_hir_id_and_parts(\n+            self.id,\n+            Some(self.name),\n+            ModuleItem(Module { items, span }),\n+            cx,\n+        )\n     }\n }\n \n@@ -1942,6 +1945,7 @@ fn clean_impl(impl_: &hir::Impl<'_>, hir_id: hir::HirId, cx: &mut DocContext<'_>\n     });\n     let mut make_item = |trait_: Option<Type>, for_: Type, items: Vec<Item>| {\n         let kind = ImplItem(Impl {\n+            span: types::rustc_span(tcx.hir().local_def_id(hir_id).to_def_id(), tcx),\n             unsafety: impl_.unsafety,\n             generics: impl_.generics.clean(cx),\n             provided_trait_methods: provided.clone(),\n@@ -2001,7 +2005,6 @@ fn clean_extern_crate(\n     vec![Item {\n         name: Some(name),\n         attrs: box attrs.clean(cx),\n-        span: krate.span.clean(cx),\n         def_id: crate_def_id,\n         visibility: krate.vis.clean(cx),\n         kind: box ExternCrateItem { src: orig_name },"}, {"sha": "607a634c1bced5fbb7be140e5b1347c6ec13e58b", "filename": "src/librustdoc/clean/types.rs", "status": "modified", "additions": 33, "deletions": 13, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0/src%2Flibrustdoc%2Fclean%2Ftypes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0/src%2Flibrustdoc%2Fclean%2Ftypes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Ftypes.rs?ref=f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0", "patch": "@@ -211,7 +211,6 @@ impl ExternalCrate {\n /// directly to the AST's concept of an item; it's a strict superset.\n #[derive(Clone)]\n crate struct Item {\n-    crate span: Span,\n     /// The name of this item.\n     /// Optional because not every item has a name, e.g. impls.\n     crate name: Option<Symbol>,\n@@ -225,14 +224,13 @@ crate struct Item {\n \n // `Item` is used a lot. Make sure it doesn't unintentionally get bigger.\n #[cfg(all(target_arch = \"x86_64\", target_pointer_width = \"64\"))]\n-rustc_data_structures::static_assert_size!(Item, 48);\n+rustc_data_structures::static_assert_size!(Item, 40);\n \n impl fmt::Debug for Item {\n     fn fmt(&self, fmt: &mut fmt::Formatter<'_>) -> fmt::Result {\n         let def_id: &dyn fmt::Debug = if self.is_fake() { &\"**FAKE**\" } else { &self.def_id };\n \n         fmt.debug_struct(\"Item\")\n-            .field(\"source\", &self.span)\n             .field(\"name\", &self.name)\n             .field(\"attrs\", &self.attrs)\n             .field(\"kind\", &self.kind)\n@@ -242,6 +240,16 @@ impl fmt::Debug for Item {\n     }\n }\n \n+crate fn rustc_span(def_id: DefId, tcx: TyCtxt<'_>) -> Span {\n+    Span::from_rustc_span(def_id.as_local().map_or_else(\n+        || tcx.def_span(def_id),\n+        |local| {\n+            let hir = tcx.hir();\n+            hir.span_with_body(hir.local_def_id_to_hir_id(local))\n+        },\n+    ))\n+}\n+\n impl Item {\n     crate fn stability<'tcx>(&self, tcx: TyCtxt<'tcx>) -> Option<&'tcx Stability> {\n         if self.is_fake() { None } else { tcx.lookup_stability(self.def_id) }\n@@ -255,6 +263,26 @@ impl Item {\n         if self.is_fake() { None } else { tcx.lookup_deprecation(self.def_id) }\n     }\n \n+    crate fn span(&self, tcx: TyCtxt<'_>) -> Span {\n+        let kind = match &*self.kind {\n+            ItemKind::StrippedItem(k) => k,\n+            _ => &*self.kind,\n+        };\n+        if let ItemKind::ModuleItem(Module { span, .. }) | ItemKind::ImplItem(Impl { span, .. }) =\n+            kind\n+        {\n+            *span\n+        } else if self.is_fake() {\n+            Span::dummy()\n+        } else {\n+            rustc_span(self.def_id, tcx)\n+        }\n+    }\n+\n+    crate fn attr_span(&self, tcx: TyCtxt<'_>) -> rustc_span::Span {\n+        crate::passes::span_of_attrs(&self.attrs).unwrap_or_else(|| self.span(tcx).inner())\n+    }\n+\n     /// Finds the `doc` attribute as a NameValue and returns the corresponding\n     /// value found.\n     crate fn doc_value(&self) -> Option<String> {\n@@ -296,20 +324,10 @@ impl Item {\n     ) -> Item {\n         debug!(\"name={:?}, def_id={:?}\", name, def_id);\n \n-        // `span_if_local()` lies about functions and only gives the span of the function signature\n-        let span = def_id.as_local().map_or_else(\n-            || cx.tcx.def_span(def_id),\n-            |local| {\n-                let hir = cx.tcx.hir();\n-                hir.span_with_body(hir.local_def_id_to_hir_id(local))\n-            },\n-        );\n-\n         Item {\n             def_id,\n             kind: box kind,\n             name,\n-            span: span.clean(cx),\n             attrs,\n             visibility: cx.tcx.visibility(def_id).clean(cx),\n         }\n@@ -605,6 +623,7 @@ impl ItemKind {\n #[derive(Clone, Debug)]\n crate struct Module {\n     crate items: Vec<Item>,\n+    crate span: Span,\n }\n \n crate struct ListAttributesIter<'a> {\n@@ -2108,6 +2127,7 @@ impl Constant {\n \n #[derive(Clone, Debug)]\n crate struct Impl {\n+    crate span: Span,\n     crate unsafety: hir::Unsafety,\n     crate generics: Generics,\n     crate provided_trait_methods: FxHashSet<Symbol>,"}, {"sha": "37d11d4ed47c445a5fbbe0c904b63e2aab80903c", "filename": "src/librustdoc/fold.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0/src%2Flibrustdoc%2Ffold.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0/src%2Flibrustdoc%2Ffold.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Ffold.rs?ref=f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0", "patch": "@@ -80,7 +80,10 @@ crate trait DocFolder: Sized {\n     }\n \n     fn fold_mod(&mut self, m: Module) -> Module {\n-        Module { items: m.items.into_iter().filter_map(|i| self.fold_item(i)).collect() }\n+        Module {\n+            span: m.span,\n+            items: m.items.into_iter().filter_map(|i| self.fold_item(i)).collect(),\n+        }\n     }\n \n     fn fold_crate(&mut self, mut c: Crate) -> Crate {"}, {"sha": "6d45ed69c123208fdc630e94677652571fc344d5", "filename": "src/librustdoc/html/render/context.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0/src%2Flibrustdoc%2Fhtml%2Frender%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0/src%2Flibrustdoc%2Fhtml%2Frender%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fcontext.rs?ref=f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0", "patch": "@@ -281,15 +281,15 @@ impl<'tcx> Context<'tcx> {\n     /// may happen, for example, with externally inlined items where the source\n     /// of their crate documentation isn't known.\n     pub(super) fn src_href(&self, item: &clean::Item) -> Option<String> {\n-        if item.span.is_dummy() {\n+        if item.span(self.tcx()).is_dummy() {\n             return None;\n         }\n         let mut root = self.root_path();\n         let mut path = String::new();\n-        let cnum = item.span.cnum(self.sess());\n+        let cnum = item.span(self.tcx()).cnum(self.sess());\n \n         // We can safely ignore synthetic `SourceFile`s.\n-        let file = match item.span.filename(self.sess()) {\n+        let file = match item.span(self.tcx()).filename(self.sess()) {\n             FileName::Real(ref path) => path.local_path().to_path_buf(),\n             _ => return None,\n         };\n@@ -323,8 +323,8 @@ impl<'tcx> Context<'tcx> {\n             (&*symbol, &path)\n         };\n \n-        let loline = item.span.lo(self.sess()).line;\n-        let hiline = item.span.hi(self.sess()).line;\n+        let loline = item.span(self.tcx()).lo(self.sess()).line;\n+        let hiline = item.span(self.tcx()).hi(self.sess()).line;\n         let lines =\n             if loline == hiline { loline.to_string() } else { format!(\"{}-{}\", loline, hiline) };\n         Some(format!("}, {"sha": "f1d79ab097b9f5cca26740aff6e379ebe53175d8", "filename": "src/librustdoc/html/render/print_item.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0/src%2Flibrustdoc%2Fhtml%2Frender%2Fprint_item.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0/src%2Flibrustdoc%2Fhtml%2Frender%2Fprint_item.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fprint_item.rs?ref=f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0", "patch": "@@ -1013,7 +1013,7 @@ fn item_macro(w: &mut Buffer, cx: &Context<'_>, it: &clean::Item, t: &clean::Mac\n             Some(\"macro\"),\n             None,\n             None,\n-            it.span.inner().edition(),\n+            it.span(cx.tcx()).inner().edition(),\n         );\n     });\n     document(w, cx, it, None)"}, {"sha": "3d4d8df0a71989165dcc65095b3fdeca34021989", "filename": "src/librustdoc/html/sources.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0/src%2Flibrustdoc%2Fhtml%2Fsources.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0/src%2Flibrustdoc%2Fhtml%2Fsources.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fsources.rs?ref=f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0", "patch": "@@ -41,11 +41,11 @@ impl DocFolder for SourceCollector<'_, '_> {\n         // then we need to render it out to the filesystem.\n         if self.scx.include_sources\n             // skip all synthetic \"files\"\n-            && item.span.filename(self.sess()).is_real()\n+            && item.span(self.scx.tcx).filename(self.sess()).is_real()\n             // skip non-local files\n-            && item.span.cnum(self.sess()) == LOCAL_CRATE\n+            && item.span(self.scx.tcx).cnum(self.sess()) == LOCAL_CRATE\n         {\n-            let filename = item.span.filename(self.sess());\n+            let filename = item.span(self.scx.tcx).filename(self.sess());\n             // If it turns out that we couldn't read this file, then we probably\n             // can't read any of the files (generating html output from json or\n             // something like that), so just don't include sources for the\n@@ -55,7 +55,7 @@ impl DocFolder for SourceCollector<'_, '_> {\n                 Ok(()) => true,\n                 Err(e) => {\n                     self.scx.tcx.sess.span_err(\n-                        item.span.inner(),\n+                        item.span(self.scx.tcx).inner(),\n                         &format!(\"failed to render source code for `{}`: {}\", filename, e),\n                     );\n                     false"}, {"sha": "42cd765c294b11b89d9832690ecf1721988f4d5d", "filename": "src/librustdoc/json/conversions.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0/src%2Flibrustdoc%2Fjson%2Fconversions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0/src%2Flibrustdoc%2Fjson%2Fconversions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fjson%2Fconversions.rs?ref=f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0", "patch": "@@ -40,7 +40,8 @@ impl JsonRenderer<'_> {\n             .iter()\n             .map(rustc_ast_pretty::pprust::attribute_to_string)\n             .collect();\n-        let clean::Item { span, name, attrs: _, kind: _, visibility, def_id } = item;\n+        let span = item.span(self.tcx);\n+        let clean::Item { name, attrs: _, kind: _, visibility, def_id } = item;\n         let inner = match *item.kind {\n             clean::StrippedItem(_) => return None,\n             _ => from_clean_item(item, self.tcx),\n@@ -462,6 +463,7 @@ impl FromWithTcx<clean::Impl> for Impl {\n             negative_polarity,\n             synthetic,\n             blanket_impl,\n+            span: _span,\n         } = impl_;\n         Impl {\n             is_unsafe: unsafety == rustc_hir::Unsafety::Unsafe,"}, {"sha": "56ef15eb8842017b1320425fb719f4cf8390895c", "filename": "src/librustdoc/passes/bare_urls.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0/src%2Flibrustdoc%2Fpasses%2Fbare_urls.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0/src%2Flibrustdoc%2Fpasses%2Fbare_urls.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fbare_urls.rs?ref=f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0", "patch": "@@ -1,4 +1,4 @@\n-use super::{span_of_attrs, Pass};\n+use super::Pass;\n use crate::clean::*;\n use crate::core::DocContext;\n use crate::fold::DocFolder;\n@@ -69,8 +69,7 @@ impl<'a, 'tcx> DocFolder for BareUrlsLinter<'a, 'tcx> {\n         if !dox.is_empty() {\n             let report_diag = |cx: &DocContext<'_>, msg: &str, url: &str, range: Range<usize>| {\n                 let sp = super::source_span_for_markdown_range(cx.tcx, &dox, &range, &item.attrs)\n-                    .or_else(|| span_of_attrs(&item.attrs))\n-                    .unwrap_or(item.span.inner());\n+                    .unwrap_or_else(|| item.attr_span(cx.tcx));\n                 cx.tcx.struct_span_lint_hir(crate::lint::BARE_URLS, hir_id, sp, |lint| {\n                     lint.build(msg)\n                         .note(\"bare URLs are not automatically turned into clickable links\")"}, {"sha": "c8b82fb1563dfa63d801ba92320c873bc36f028c", "filename": "src/librustdoc/passes/calculate_doc_coverage.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0/src%2Flibrustdoc%2Fpasses%2Fcalculate_doc_coverage.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0/src%2Flibrustdoc%2Fpasses%2Fcalculate_doc_coverage.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fcalculate_doc_coverage.rs?ref=f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0", "patch": "@@ -211,7 +211,7 @@ impl<'a, 'b> fold::DocFolder for CoverageCalculator<'a, 'b> {\n                     None,\n                 );\n \n-                let filename = i.span.filename(self.ctx.sess());\n+                let filename = i.span(self.ctx.tcx).filename(self.ctx.sess());\n                 let has_doc_example = tests.found_tests != 0;\n                 let hir_id = self.ctx.tcx.hir().local_def_id_to_hir_id(i.def_id.expect_local());\n                 let (level, source) = self.ctx.tcx.lint_level_at_node(MISSING_DOCS, hir_id);"}, {"sha": "68a66806e04765994cf30f6ef8d63dd09639e755", "filename": "src/librustdoc/passes/check_code_block_syntax.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0/src%2Flibrustdoc%2Fpasses%2Fcheck_code_block_syntax.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0/src%2Flibrustdoc%2Fpasses%2Fcheck_code_block_syntax.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fcheck_code_block_syntax.rs?ref=f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0", "patch": "@@ -9,7 +9,7 @@ use crate::clean;\n use crate::core::DocContext;\n use crate::fold::DocFolder;\n use crate::html::markdown::{self, RustCodeBlock};\n-use crate::passes::{span_of_attrs, Pass};\n+use crate::passes::Pass;\n \n crate const CHECK_CODE_BLOCK_SYNTAX: Pass = Pass {\n     name: \"check-code-block-syntax\",\n@@ -86,7 +86,7 @@ impl<'a, 'tcx> SyntaxChecker<'a, 'tcx> {\n                 // We couldn't calculate the span of the markdown block that had the error, so our\n                 // diagnostics are going to be a bit lacking.\n                 let mut diag = self.cx.sess().struct_span_warn(\n-                    super::span_of_attrs(&item.attrs).unwrap_or(item.span.inner()),\n+                    item.attr_span(self.cx.tcx),\n                     \"doc comment contains an invalid Rust code block\",\n                 );\n \n@@ -110,7 +110,7 @@ impl<'a, 'tcx> SyntaxChecker<'a, 'tcx> {\n impl<'a, 'tcx> DocFolder for SyntaxChecker<'a, 'tcx> {\n     fn fold_item(&mut self, item: clean::Item) -> Option<clean::Item> {\n         if let Some(dox) = &item.attrs.collapsed_doc_value() {\n-            let sp = span_of_attrs(&item.attrs).unwrap_or(item.span.inner());\n+            let sp = item.attr_span(self.cx.tcx);\n             let extra = crate::html::markdown::ExtraInfo::new_did(self.cx.tcx, item.def_id, sp);\n             for code_block in markdown::rust_code_blocks(&dox, &extra) {\n                 self.check_rust_syntax(&item, &dox, code_block);"}, {"sha": "dad6593248dae7be9162a39297aff2e7a3e69433", "filename": "src/librustdoc/passes/collect_intra_doc_links.rs", "status": "modified", "additions": 3, "deletions": 6, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0/src%2Flibrustdoc%2Fpasses%2Fcollect_intra_doc_links.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0/src%2Flibrustdoc%2Fpasses%2Fcollect_intra_doc_links.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fcollect_intra_doc_links.rs?ref=f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0", "patch": "@@ -37,8 +37,6 @@ use crate::html::markdown::{markdown_links, MarkdownLink};\n use crate::lint::{BROKEN_INTRA_DOC_LINKS, PRIVATE_INTRA_DOC_LINKS};\n use crate::passes::Pass;\n \n-use super::span_of_attrs;\n-\n mod early;\n crate use early::IntraLinkCrateLoader;\n \n@@ -1242,7 +1240,7 @@ impl LinkCollector<'_, '_> {\n                             &ori_link.range,\n                             &item.attrs,\n                         )\n-                        .unwrap_or_else(|| span_of_attrs(&item.attrs).unwrap_or(item.span.inner()));\n+                        .unwrap_or_else(|| item.attr_span(self.cx.tcx));\n \n                         rustc_session::parse::feature_err(\n                             &self.cx.tcx.sess.parse_sess,\n@@ -1695,13 +1693,12 @@ fn report_diagnostic(\n         }\n     };\n \n-    let attrs = &item.attrs;\n-    let sp = span_of_attrs(attrs).unwrap_or(item.span.inner());\n+    let sp = item.attr_span(tcx);\n \n     tcx.struct_span_lint_hir(lint, hir_id, sp, |lint| {\n         let mut diag = lint.build(msg);\n \n-        let span = super::source_span_for_markdown_range(tcx, dox, link_range, attrs);\n+        let span = super::source_span_for_markdown_range(tcx, dox, link_range, &item.attrs);\n \n         if let Some(sp) = span {\n             diag.set_span(sp);"}, {"sha": "c8d2263d81d5404017d2ba2d79673b8f0b3da1b2", "filename": "src/librustdoc/passes/doc_test_lints.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0/src%2Flibrustdoc%2Fpasses%2Fdoc_test_lints.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0/src%2Flibrustdoc%2Fpasses%2Fdoc_test_lints.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fdoc_test_lints.rs?ref=f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0", "patch": "@@ -3,7 +3,7 @@\n //! - MISSING_DOC_CODE_EXAMPLES: this lint is **UNSTABLE** and looks for public items missing doctests\n //! - PRIVATE_DOC_TESTS: this lint is **STABLE** and looks for private items with doctests.\n \n-use super::{span_of_attrs, Pass};\n+use super::Pass;\n use crate::clean;\n use crate::clean::*;\n use crate::core::DocContext;\n@@ -97,7 +97,7 @@ crate fn look_for_tests<'tcx>(cx: &DocContext<'tcx>, dox: &str, item: &Item) {\n     if tests.found_tests == 0 && cx.tcx.sess.is_nightly_build() {\n         if should_have_doc_example(cx, &item) {\n             debug!(\"reporting error for {:?} (hir_id={:?})\", item, hir_id);\n-            let sp = span_of_attrs(&item.attrs).unwrap_or(item.span.inner());\n+            let sp = item.attr_span(cx.tcx);\n             cx.tcx.struct_span_lint_hir(\n                 crate::lint::MISSING_DOC_CODE_EXAMPLES,\n                 hir_id,\n@@ -109,7 +109,7 @@ crate fn look_for_tests<'tcx>(cx: &DocContext<'tcx>, dox: &str, item: &Item) {\n         cx.tcx.struct_span_lint_hir(\n             crate::lint::PRIVATE_DOC_TESTS,\n             hir_id,\n-            span_of_attrs(&item.attrs).unwrap_or(item.span.inner()),\n+            item.attr_span(cx.tcx),\n             |lint| lint.build(\"documentation test in private item\").emit(),\n         );\n     }"}, {"sha": "f29d38e3e078a51251edb7668d72fa0465f0a8ef", "filename": "src/librustdoc/passes/html_tags.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0/src%2Flibrustdoc%2Fpasses%2Fhtml_tags.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0/src%2Flibrustdoc%2Fpasses%2Fhtml_tags.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fhtml_tags.rs?ref=f7c468fe9a1448b1f6ceee6a4c831fe6122a54f0", "patch": "@@ -1,4 +1,4 @@\n-use super::{span_of_attrs, Pass};\n+use super::Pass;\n use crate::clean::*;\n use crate::core::DocContext;\n use crate::fold::DocFolder;\n@@ -181,7 +181,7 @@ impl<'a, 'tcx> DocFolder for InvalidHtmlTagsLinter<'a, 'tcx> {\n                 let sp = match super::source_span_for_markdown_range(tcx, &dox, range, &item.attrs)\n                 {\n                     Some(sp) => sp,\n-                    None => span_of_attrs(&item.attrs).unwrap_or(item.span.inner()),\n+                    None => item.attr_span(tcx),\n                 };\n                 tcx.struct_span_lint_hir(crate::lint::INVALID_HTML_TAGS, hir_id, sp, |lint| {\n                     lint.build(msg).emit()"}]}