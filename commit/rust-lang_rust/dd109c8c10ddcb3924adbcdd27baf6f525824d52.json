{"sha": "dd109c8c10ddcb3924adbcdd27baf6f525824d52", "node_id": "C_kwDOAAsO6NoAKGRkMTA5YzhjMTBkZGNiMzkyNGFkYmNkZDI3YmFmNmY1MjU4MjRkNTI", "commit": {"author": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-07-17T00:04:30Z"}, "committer": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-07-19T16:41:32Z"}, "message": "better error for bad depth on macro metavar expr", "tree": {"sha": "f4c6a15b15b0781f917d8632ed15b78fa6b219f4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f4c6a15b15b0781f917d8632ed15b78fa6b219f4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/dd109c8c10ddcb3924adbcdd27baf6f525824d52", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/dd109c8c10ddcb3924adbcdd27baf6f525824d52", "html_url": "https://github.com/rust-lang/rust/commit/dd109c8c10ddcb3924adbcdd27baf6f525824d52", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/dd109c8c10ddcb3924adbcdd27baf6f525824d52/comments", "author": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a289cfcfb32593c63d75f113547f63ffe2dde285", "url": "https://api.github.com/repos/rust-lang/rust/commits/a289cfcfb32593c63d75f113547f63ffe2dde285", "html_url": "https://github.com/rust-lang/rust/commit/a289cfcfb32593c63d75f113547f63ffe2dde285"}], "stats": {"total": 48, "additions": 39, "deletions": 9}, "files": [{"sha": "3037855ae28a6b6c7ea6d742bf9678a07b387c4b", "filename": "compiler/rustc_expand/src/mbe/transcribe.rs", "status": "modified", "additions": 12, "deletions": 1, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/dd109c8c10ddcb3924adbcdd27baf6f525824d52/compiler%2Frustc_expand%2Fsrc%2Fmbe%2Ftranscribe.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dd109c8c10ddcb3924adbcdd27baf6f525824d52/compiler%2Frustc_expand%2Fsrc%2Fmbe%2Ftranscribe.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_expand%2Fsrc%2Fmbe%2Ftranscribe.rs?ref=dd109c8c10ddcb3924adbcdd27baf6f525824d52", "patch": "@@ -512,7 +512,18 @@ fn out_of_bounds_err<'a>(\n     span: Span,\n     ty: &str,\n ) -> DiagnosticBuilder<'a, ErrorGuaranteed> {\n-    cx.struct_span_err(span, &format!(\"{ty} depth must be less than {max}\"))\n+    let msg = if max == 0 {\n+        format!(\n+            \"meta-variable expression `{ty}` with depth parameter \\\n+             must be called inside of a macro repetition\"\n+        )\n+    } else {\n+        format!(\n+            \"depth parameter on meta-variable expression `{ty}` \\\n+             must be less than {max}\"\n+        )\n+    };\n+    cx.struct_span_err(span, &msg)\n }\n \n fn transcribe_metavar_expr<'a>("}, {"sha": "b7fb947854f04fe0ffb7c23e94b73931d028256f", "filename": "src/test/ui/macros/meta-variable-depth-outside-repeat.rs", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/dd109c8c10ddcb3924adbcdd27baf6f525824d52/src%2Ftest%2Fui%2Fmacros%2Fmeta-variable-depth-outside-repeat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dd109c8c10ddcb3924adbcdd27baf6f525824d52/src%2Ftest%2Fui%2Fmacros%2Fmeta-variable-depth-outside-repeat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmacros%2Fmeta-variable-depth-outside-repeat.rs?ref=dd109c8c10ddcb3924adbcdd27baf6f525824d52", "patch": "@@ -0,0 +1,12 @@\n+#![feature(macro_metavar_expr)]\n+\n+macro_rules! metavar {\n+    ( $i:expr ) => {\n+        ${length(0)}\n+        //~^ ERROR meta-variable expression `length` with depth parameter must be called inside of a macro repetition\n+    };\n+}\n+\n+const _: i32 = metavar!(0);\n+\n+fn main() {}"}, {"sha": "fad150cadfca6ccd3c1f760dffa6bc5992b325ea", "filename": "src/test/ui/macros/meta-variable-depth-outside-repeat.stderr", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/dd109c8c10ddcb3924adbcdd27baf6f525824d52/src%2Ftest%2Fui%2Fmacros%2Fmeta-variable-depth-outside-repeat.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/dd109c8c10ddcb3924adbcdd27baf6f525824d52/src%2Ftest%2Fui%2Fmacros%2Fmeta-variable-depth-outside-repeat.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmacros%2Fmeta-variable-depth-outside-repeat.stderr?ref=dd109c8c10ddcb3924adbcdd27baf6f525824d52", "patch": "@@ -0,0 +1,8 @@\n+error: meta-variable expression `length` with depth parameter must be called inside of a macro repetition\n+  --> $DIR/meta-variable-depth-outside-repeat.rs:5:10\n+   |\n+LL |         ${length(0)}\n+   |          ^^^^^^^^^^^\n+\n+error: aborting due to previous error\n+"}, {"sha": "6a0d68bd6b16a73ffb060d55f71ea384cc8a7803", "filename": "src/test/ui/macros/rfc-3086-metavar-expr/out-of-bounds-arguments.rs", "status": "modified", "additions": 4, "deletions": 5, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/dd109c8c10ddcb3924adbcdd27baf6f525824d52/src%2Ftest%2Fui%2Fmacros%2Frfc-3086-metavar-expr%2Fout-of-bounds-arguments.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dd109c8c10ddcb3924adbcdd27baf6f525824d52/src%2Ftest%2Fui%2Fmacros%2Frfc-3086-metavar-expr%2Fout-of-bounds-arguments.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmacros%2Frfc-3086-metavar-expr%2Fout-of-bounds-arguments.rs?ref=dd109c8c10ddcb3924adbcdd27baf6f525824d52", "patch": "@@ -5,7 +5,7 @@ macro_rules! a {\n         (\n             ${count(foo, 0)},\n             ${count(foo, 10)},\n-            //~^ ERROR count depth must be less than 4\n+            //~^ ERROR depth parameter on meta-variable expression `count` must be less than 4\n         )\n     };\n }\n@@ -17,7 +17,7 @@ macro_rules! b {\n                 ${ignore(foo)}\n                 ${index(0)},\n                 ${index(10)},\n-                //~^ ERROR index depth must be less than 3\n+                //~^ ERROR depth parameter on meta-variable expression `index` must be less than 3\n             )* )* )*\n         )\n     };\n@@ -30,15 +30,14 @@ macro_rules! c {\n                 ${ignore(foo)}\n                 ${length(0)}\n                 ${length(10)}\n-                //~^ ERROR length depth must be less than 2\n+                //~^ ERROR depth parameter on meta-variable expression `length` must be less than 2\n             )* )*\n         )\n     };\n }\n \n-\n fn main() {\n     a!( { [ (a) ] [ (b c) ] } );\n     b!( { [ a b ] } );\n-    c!( { a } );\n+    c!({ a });\n }"}, {"sha": "236122b6465b2cdfe9f8ab960d1187c2a89a9c1d", "filename": "src/test/ui/macros/rfc-3086-metavar-expr/out-of-bounds-arguments.stderr", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/dd109c8c10ddcb3924adbcdd27baf6f525824d52/src%2Ftest%2Fui%2Fmacros%2Frfc-3086-metavar-expr%2Fout-of-bounds-arguments.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/dd109c8c10ddcb3924adbcdd27baf6f525824d52/src%2Ftest%2Fui%2Fmacros%2Frfc-3086-metavar-expr%2Fout-of-bounds-arguments.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmacros%2Frfc-3086-metavar-expr%2Fout-of-bounds-arguments.stderr?ref=dd109c8c10ddcb3924adbcdd27baf6f525824d52", "patch": "@@ -1,16 +1,16 @@\n-error: count depth must be less than 4\n+error: depth parameter on meta-variable expression `count` must be less than 4\n   --> $DIR/out-of-bounds-arguments.rs:7:14\n    |\n LL |             ${count(foo, 10)},\n    |              ^^^^^^^^^^^^^^^^\n \n-error: index depth must be less than 3\n+error: depth parameter on meta-variable expression `index` must be less than 3\n   --> $DIR/out-of-bounds-arguments.rs:19:18\n    |\n LL |                 ${index(10)},\n    |                  ^^^^^^^^^^^\n \n-error: length depth must be less than 2\n+error: depth parameter on meta-variable expression `length` must be less than 2\n   --> $DIR/out-of-bounds-arguments.rs:32:18\n    |\n LL |                 ${length(10)}"}]}