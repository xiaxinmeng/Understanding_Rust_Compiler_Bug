{"sha": "9e5c24eaf886a314312b4e5047ffd30addb0fe90", "node_id": "C_kwDOAAsO6NoAKDllNWMyNGVhZjg4NmEzMTQzMTJiNGU1MDQ3ZmZkMzBhZGRiMGZlOTA", "commit": {"author": {"name": "gimbles", "email": "yusharora@protonmail.com", "date": "2022-05-19T14:33:40Z"}, "committer": {"name": "gimbles", "email": "yusharora@protonmail.com", "date": "2022-05-19T14:33:40Z"}, "message": "Improve u32 to char diagnostic", "tree": {"sha": "15ed9f5c7d2876b38ddcd215348c78cf5ce95911", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/15ed9f5c7d2876b38ddcd215348c78cf5ce95911"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9e5c24eaf886a314312b4e5047ffd30addb0fe90", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9e5c24eaf886a314312b4e5047ffd30addb0fe90", "html_url": "https://github.com/rust-lang/rust/commit/9e5c24eaf886a314312b4e5047ffd30addb0fe90", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9e5c24eaf886a314312b4e5047ffd30addb0fe90/comments", "author": null, "committer": null, "parents": [{"sha": "e6327bc8b8d437b66ff91d9ce798a9eb45310967", "url": "https://api.github.com/repos/rust-lang/rust/commits/e6327bc8b8d437b66ff91d9ce798a9eb45310967", "html_url": "https://github.com/rust-lang/rust/commit/e6327bc8b8d437b66ff91d9ce798a9eb45310967"}], "stats": {"total": 53, "additions": 25, "deletions": 28}, "files": [{"sha": "d9aaf730efcc472e146a18d2aea7f6023fb64128", "filename": "compiler/rustc_typeck/src/check/cast.rs", "status": "modified", "additions": 16, "deletions": 10, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/9e5c24eaf886a314312b4e5047ffd30addb0fe90/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fcast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9e5c24eaf886a314312b4e5047ffd30addb0fe90/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fcast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fcast.rs?ref=9e5c24eaf886a314312b4e5047ffd30addb0fe90", "patch": "@@ -347,16 +347,22 @@ impl<'a, 'tcx> CastCheck<'tcx> {\n                 );\n                 err.span_label(self.span, \"invalid cast\");\n                 if self.expr_ty.is_numeric() {\n-                    err.span_help(\n-                        self.span,\n-                        if self.expr_ty == fcx.tcx.types.i8 {\n-                            \"try casting from `u8` instead\"\n-                        } else if self.expr_ty == fcx.tcx.types.u32 {\n-                            \"try `char::from_u32` instead\"\n-                        } else {\n-                            \"try `char::from_u32` instead (via a `u32`)\"\n-                        },\n-                    );\n+                    if self.expr_ty == fcx.tcx.types.u32 {\n+                        match fcx.tcx.sess.source_map().span_to_snippet(self.expr.span) {\n+                            Ok(snippet) => err.span_suggestion(\n+                                self.span,\n+                                \"try `char::from_u32` instead\",\n+                                format!(\"char::from_u32({snippet})\"),\n+                                Applicability::MachineApplicable,\n+                            ),\n+\n+                            Err(_) => err.span_help(self.span, \"try `char::from_u32` instead\"),\n+                        };\n+                    } else if self.expr_ty == fcx.tcx.types.i8 {\n+                        err.span_help(self.span, \"try casting from `u8` instead\");\n+                    } else {\n+                        err.span_help(self.span, \"try `char::from_u32` instead (via a `u32`)\");\n+                    };\n                 }\n                 err.emit();\n             }"}, {"sha": "68da03928b783ebb9013e912ddc29a7fb67bc4ad", "filename": "src/test/ui/error-codes/E0604.stderr", "status": "modified", "additions": 3, "deletions": 6, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/9e5c24eaf886a314312b4e5047ffd30addb0fe90/src%2Ftest%2Fui%2Ferror-codes%2FE0604.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/9e5c24eaf886a314312b4e5047ffd30addb0fe90/src%2Ftest%2Fui%2Ferror-codes%2FE0604.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ferror-codes%2FE0604.stderr?ref=9e5c24eaf886a314312b4e5047ffd30addb0fe90", "patch": "@@ -1,14 +1,11 @@\n error[E0604]: only `u8` can be cast as `char`, not `u32`\n   --> $DIR/E0604.rs:2:5\n    |\n-LL |     1u32 as char;\n-   |     ^^^^^^^^^^^^ invalid cast\n-   |\n-help: try `char::from_u32` instead\n-  --> $DIR/E0604.rs:2:5\n-   |\n LL |     1u32 as char;\n    |     ^^^^^^^^^^^^\n+   |     |\n+   |     invalid cast\n+   |     help: try `char::from_u32` instead: `char::from_u32(1u32)`\n \n error: aborting due to previous error\n "}, {"sha": "81aa268cacc5cd62c11f9d082247d321361c3958", "filename": "src/test/ui/error-festival.stderr", "status": "modified", "additions": 3, "deletions": 6, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/9e5c24eaf886a314312b4e5047ffd30addb0fe90/src%2Ftest%2Fui%2Ferror-festival.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/9e5c24eaf886a314312b4e5047ffd30addb0fe90/src%2Ftest%2Fui%2Ferror-festival.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ferror-festival.stderr?ref=9e5c24eaf886a314312b4e5047ffd30addb0fe90", "patch": "@@ -56,14 +56,11 @@ LL | | }\n error[E0604]: only `u8` can be cast as `char`, not `u32`\n   --> $DIR/error-festival.rs:25:5\n    |\n-LL |     0u32 as char;\n-   |     ^^^^^^^^^^^^ invalid cast\n-   |\n-help: try `char::from_u32` instead\n-  --> $DIR/error-festival.rs:25:5\n-   |\n LL |     0u32 as char;\n    |     ^^^^^^^^^^^^\n+   |     |\n+   |     invalid cast\n+   |     help: try `char::from_u32` instead: `char::from_u32(0u32)`\n \n error[E0605]: non-primitive cast: `u8` as `Vec<u8>`\n   --> $DIR/error-festival.rs:29:5"}, {"sha": "3a508459cc0466316473a5e2e349787b9d26f943", "filename": "src/test/ui/mismatched_types/cast-rfc0401.stderr", "status": "modified", "additions": 3, "deletions": 6, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/9e5c24eaf886a314312b4e5047ffd30addb0fe90/src%2Ftest%2Fui%2Fmismatched_types%2Fcast-rfc0401.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/9e5c24eaf886a314312b4e5047ffd30addb0fe90/src%2Ftest%2Fui%2Fmismatched_types%2Fcast-rfc0401.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmismatched_types%2Fcast-rfc0401.stderr?ref=9e5c24eaf886a314312b4e5047ffd30addb0fe90", "patch": "@@ -97,14 +97,11 @@ LL |     let _ = E::A as bool;\n error[E0604]: only `u8` can be cast as `char`, not `u32`\n   --> $DIR/cast-rfc0401.rs:41:13\n    |\n-LL |     let _ = 0x61u32 as char;\n-   |             ^^^^^^^^^^^^^^^ invalid cast\n-   |\n-help: try `char::from_u32` instead\n-  --> $DIR/cast-rfc0401.rs:41:13\n-   |\n LL |     let _ = 0x61u32 as char;\n    |             ^^^^^^^^^^^^^^^\n+   |             |\n+   |             invalid cast\n+   |             help: try `char::from_u32` instead: `char::from_u32(0x61u32)`\n \n error[E0606]: casting `bool` as `f32` is invalid\n   --> $DIR/cast-rfc0401.rs:43:13"}]}