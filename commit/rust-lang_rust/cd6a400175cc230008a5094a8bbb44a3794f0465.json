{"sha": "cd6a400175cc230008a5094a8bbb44a3794f0465", "node_id": "MDY6Q29tbWl0NzI0NzEyOmNkNmE0MDAxNzVjYzIzMDAwOGE1MDk0YThiYmI0NGEzNzk0ZjA0NjU=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-05-16T21:41:50Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-05-16T21:41:50Z"}, "message": "Auto merge of #33588 - nikomatsakis:compiletest-ui, r=acrichto\n\nadd UI testing framework\n\nThis adds a framework for capturing and tracking the precise output of rustc, which allows us to check all manner of minor details with the output. It's pretty strict right now -- the output must match almost exactly -- and hence maybe a bit too strict. But I figure we can add wildcards or whatever later. There is also a script intended to make updating the references easy, though the script could make things a *bit* easier (in particular, it'd be nice if it would find the build directory for you automatically).\n\nOne thing I was wondering about is the best way to test colors. Since windows doesn't embed those in the output stream, this test framework can't test colors on windows -- so I figure we can just write tests that are ignored on windows and which pass `--color=always` or whatever to rustc.\n\ncc @jonathandturner\nr? @alexcrichton", "tree": {"sha": "bbddcde08c131f5dd1f3ba58eb5c1dfcb5d0b3ab", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bbddcde08c131f5dd1f3ba58eb5c1dfcb5d0b3ab"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cd6a400175cc230008a5094a8bbb44a3794f0465", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cd6a400175cc230008a5094a8bbb44a3794f0465", "html_url": "https://github.com/rust-lang/rust/commit/cd6a400175cc230008a5094a8bbb44a3794f0465", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cd6a400175cc230008a5094a8bbb44a3794f0465/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4fdf2c4f976ce52163841ba5b3117bb2bb06d97e", "url": "https://api.github.com/repos/rust-lang/rust/commits/4fdf2c4f976ce52163841ba5b3117bb2bb06d97e", "html_url": "https://github.com/rust-lang/rust/commit/4fdf2c4f976ce52163841ba5b3117bb2bb06d97e"}, {"sha": "24cfa1efb0385ede414d47a4a59f7673045151dc", "url": "https://api.github.com/repos/rust-lang/rust/commits/24cfa1efb0385ede414d47a4a59f7673045151dc", "html_url": "https://github.com/rust-lang/rust/commit/24cfa1efb0385ede414d47a4a59f7673045151dc"}], "stats": {"total": 357, "additions": 354, "deletions": 3}, "files": [{"sha": "f9ab84e3f8ccf4f2c45624cb6f737c675bc45e26", "filename": "mk/tests.mk", "status": "modified", "additions": 13, "deletions": 2, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/cd6a400175cc230008a5094a8bbb44a3794f0465/mk%2Ftests.mk", "raw_url": "https://github.com/rust-lang/rust/raw/cd6a400175cc230008a5094a8bbb44a3794f0465/mk%2Ftests.mk", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/mk%2Ftests.mk?ref=cd6a400175cc230008a5094a8bbb44a3794f0465", "patch": "@@ -274,6 +274,7 @@ check-stage$(1)-T-$(2)-H-$(3)-exec: \\\n \tcheck-stage$(1)-T-$(2)-H-$(3)-debuginfo-gdb-exec \\\n \tcheck-stage$(1)-T-$(2)-H-$(3)-debuginfo-lldb-exec \\\n \tcheck-stage$(1)-T-$(2)-H-$(3)-incremental-exec \\\n+\tcheck-stage$(1)-T-$(2)-H-$(3)-ui-exec \\\n \tcheck-stage$(1)-T-$(2)-H-$(3)-doc-exec \\\n \tcheck-stage$(1)-T-$(2)-H-$(3)-pretty-exec\n \n@@ -452,6 +453,9 @@ CODEGEN_CC := $(call rwildcard,$(S)src/test/codegen/,*.cc)\n CODEGEN_UNITS_RS := $(call rwildcard,$(S)src/test/codegen-units/,*.rs)\n INCREMENTAL_RS := $(call rwildcard,$(S)src/test/incremental/,*.rs)\n RMAKE_RS := $(wildcard $(S)src/test/run-make/*/Makefile)\n+UI_RS := $(call rwildcard,$(S)src/test/ui/,*.rs) \\\n+         $(call rwildcard,$(S)src/test/ui/,*.stdout) \\\n+         $(call rwildcard,$(S)src/test/ui/,*.stderr)\n RUSTDOCCK_RS := $(call rwildcard,$(S)src/test/rustdoc/,*.rs)\n \n RPASS_TESTS := $(RPASS_RS)\n@@ -469,6 +473,7 @@ CODEGEN_TESTS := $(CODEGEN_RS) $(CODEGEN_CC)\n CODEGEN_UNITS_TESTS := $(CODEGEN_UNITS_RS)\n INCREMENTAL_TESTS := $(INCREMENTAL_RS)\n RMAKE_TESTS := $(RMAKE_RS)\n+UI_TESTS := $(UI_RS)\n RUSTDOCCK_TESTS := $(RUSTDOCCK_RS)\n \n CTEST_SRC_BASE_rpass = run-pass\n@@ -541,6 +546,11 @@ CTEST_BUILD_BASE_rmake = run-make\n CTEST_MODE_rmake = run-make\n CTEST_RUNTOOL_rmake = $(CTEST_RUNTOOL)\n \n+CTEST_SRC_BASE_ui = ui\n+CTEST_BUILD_BASE_ui = ui\n+CTEST_MODE_ui = ui\n+CTEST_RUNTOOL_ui = $(CTEST_RUNTOOL)\n+\n CTEST_SRC_BASE_rustdocck = rustdoc\n CTEST_BUILD_BASE_rustdocck = rustdoc\n CTEST_MODE_rustdocck = rustdoc\n@@ -672,7 +682,7 @@ CTEST_DEPS_codegen-units_$(1)-T-$(2)-H-$(3) = $$(CODEGEN_UNITS_TESTS)\n CTEST_DEPS_incremental_$(1)-T-$(2)-H-$(3) = $$(INCREMENTAL_TESTS)\n CTEST_DEPS_rmake_$(1)-T-$(2)-H-$(3) = $$(RMAKE_TESTS) \\\n \t$$(CSREQ$(1)_T_$(3)_H_$(3)) $$(SREQ$(1)_T_$(2)_H_$(3))\n-\n+CTEST_DEPS_ui_$(1)-T-$(2)-H-$(3) = $$(UI_TESTS)\n CTEST_DEPS_rustdocck_$(1)-T-$(2)-H-$(3) = $$(RUSTDOCCK_TESTS) \\\n \t\t$$(HBIN$(1)_H_$(3))/rustdoc$$(X_$(3)) \\\n \t\t$(S)src/etc/htmldocck.py\n@@ -744,7 +754,7 @@ endef\n \n CTEST_NAMES = rpass rpass-valgrind rpass-full rfail-full cfail-full rfail cfail pfail \\\n \tdebuginfo-gdb debuginfo-lldb codegen codegen-units rustdocck incremental \\\n-\trmake\n+\trmake ui\n \n $(foreach host,$(CFG_HOST), \\\n  $(eval $(foreach target,$(CFG_TARGET), \\\n@@ -943,6 +953,7 @@ TEST_GROUPS = \\\n \tcodegen \\\n \tcodegen-units \\\n \tincremental \\\n+\tui \\\n \tdoc \\\n \t$(foreach docname,$(DOC_NAMES),doc-$(docname)) \\\n \tpretty \\"}, {"sha": "3284b5dfe9c0755b6b07c35d973ebc32d2cb6ec1", "filename": "src/bootstrap/build/mod.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/cd6a400175cc230008a5094a8bbb44a3794f0465/src%2Fbootstrap%2Fbuild%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cd6a400175cc230008a5094a8bbb44a3794f0465/src%2Fbootstrap%2Fbuild%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuild%2Fmod.rs?ref=cd6a400175cc230008a5094a8bbb44a3794f0465", "patch": "@@ -342,6 +342,14 @@ impl Build {\n                     check::compiletest(self, &compiler, target.target,\n                                        \"codegen-units\", \"codegen-units\");\n                 }\n+                CheckIncremental { compiler } => {\n+                    check::compiletest(self, &compiler, target.target,\n+                                       \"incremental\", \"incremental\");\n+                }\n+                CheckUi { compiler } => {\n+                    check::compiletest(self, &compiler, target.target,\n+                                       \"ui\", \"ui\");\n+                }\n                 CheckDebuginfo { compiler } => {\n                     if target.target.contains(\"msvc\") ||\n                        target.target.contains(\"android\") {"}, {"sha": "4e53ddef5945716aad3563dc13cce0bfd023d9d0", "filename": "src/bootstrap/build/step.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/cd6a400175cc230008a5094a8bbb44a3794f0465/src%2Fbootstrap%2Fbuild%2Fstep.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cd6a400175cc230008a5094a8bbb44a3794f0465/src%2Fbootstrap%2Fbuild%2Fstep.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuild%2Fstep.rs?ref=cd6a400175cc230008a5094a8bbb44a3794f0465", "patch": "@@ -111,6 +111,8 @@ macro_rules! targets {\n             (check_pfail, CheckPFail { compiler: Compiler<'a> }),\n             (check_codegen, CheckCodegen { compiler: Compiler<'a> }),\n             (check_codegen_units, CheckCodegenUnits { compiler: Compiler<'a> }),\n+            (check_incremental, CheckIncremental { compiler: Compiler<'a> }),\n+            (check_ui, CheckUi { compiler: Compiler<'a> }),\n             (check_debuginfo, CheckDebuginfo { compiler: Compiler<'a> }),\n             (check_rustdoc, CheckRustdoc { compiler: Compiler<'a> }),\n             (check_pretty, CheckPretty { compiler: Compiler<'a> }),\n@@ -379,6 +381,8 @@ impl<'a> Step<'a> {\n                     self.check_cfail(compiler),\n                     self.check_rfail(compiler),\n                     self.check_pfail(compiler),\n+                    self.check_incremental(compiler),\n+                    self.check_ui(compiler),\n                     self.check_crate_std(compiler),\n                     self.check_crate_test(compiler),\n                     self.check_crate_rustc(compiler),\n@@ -412,6 +416,8 @@ impl<'a> Step<'a> {\n             Source::CheckPFail { compiler } |\n             Source::CheckCodegen { compiler } |\n             Source::CheckCodegenUnits { compiler } |\n+            Source::CheckIncremental { compiler } |\n+            Source::CheckUi { compiler } |\n             Source::CheckRustdoc { compiler } |\n             Source::CheckPretty { compiler } |\n             Source::CheckCFail { compiler } |"}, {"sha": "dcdeabd80322f6016f2009ba23a0c4f745e4964e", "filename": "src/test/ui/README.md", "status": "added", "additions": 31, "deletions": 0, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/cd6a400175cc230008a5094a8bbb44a3794f0465/src%2Ftest%2Fui%2FREADME.md", "raw_url": "https://github.com/rust-lang/rust/raw/cd6a400175cc230008a5094a8bbb44a3794f0465/src%2Ftest%2Fui%2FREADME.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2FREADME.md?ref=cd6a400175cc230008a5094a8bbb44a3794f0465", "patch": "@@ -0,0 +1,31 @@\n+# Guide to the UI Tests\n+\n+The UI tests are intended to capture the compiler's complete output,\n+so that we can test all aspects of the presentation. They work by\n+compiling a file (e.g., `hello_world/main.rs`), capturing the output,\n+and then applying some normalization (see below). This normalized\n+result is then compared against reference files named\n+`hello_world/main.stderr` and `hello_world/main.stdout`. If either of\n+those files doesn't exist, the output must be empty. If the test run\n+fails, we will print out the current output, but it is also saved in\n+`build/<target-triple>/test/ui/hello_world/main.stdout` (this path is\n+printed as part of the test failure mesage), so you can run `diff` and\n+so forth.\n+\n+# Editing and updating the reference files\n+\n+If you have changed the compiler's output intentionally, or you are\n+making a new test, you can use the script `update-references.sh` to\n+update the references. When you run the test framework, it will report\n+various errors: in those errors is a command you can use to run the\n+`update-references.sh` script, which will then copy over the files\n+from the build directory and use them as the new reference. You can\n+also just run `update-all-references.sh`. In both cases, you can run\n+the script with `--help` to get a help message.\n+\n+# Normalization\n+\n+The normalization applied is aimed at filenames:\n+\n+- the test directory is replaced with `$DIR`\n+- all backslashes (\\) are converted to forward slashes (/) (for windows)"}, {"sha": "6118397557701ec1239805e12b416904b01ab108", "filename": "src/test/ui/hello_world/main.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/cd6a400175cc230008a5094a8bbb44a3794f0465/src%2Ftest%2Fui%2Fhello_world%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cd6a400175cc230008a5094a8bbb44a3794f0465/src%2Ftest%2Fui%2Fhello_world%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fhello_world%2Fmain.rs?ref=cd6a400175cc230008a5094a8bbb44a3794f0465", "patch": "@@ -0,0 +1,15 @@\n+// Copyright 2013-2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// Test that compiling hello world succeeds with no output of any kind.\n+\n+fn main() {\n+    println!(\"Hello, world!\");\n+}"}, {"sha": "85d9fa53fcf00d98416b4cfdc374a8fbe2f7c9de", "filename": "src/test/ui/mismatched_types/main.rs", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/cd6a400175cc230008a5094a8bbb44a3794f0465/src%2Ftest%2Fui%2Fmismatched_types%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cd6a400175cc230008a5094a8bbb44a3794f0465/src%2Ftest%2Fui%2Fmismatched_types%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmismatched_types%2Fmain.rs?ref=cd6a400175cc230008a5094a8bbb44a3794f0465", "patch": "@@ -0,0 +1,17 @@\n+// Copyright 2013-2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// rustc-env:RUST_NEW_ERROR_FORMAT\n+\n+fn main() {\n+    let x: u32 = (\n+    );\n+}\n+"}, {"sha": "98bc11752e0edaa7dc15c9fbb44caefad8047c95", "filename": "src/test/ui/mismatched_types/main.stderr", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/cd6a400175cc230008a5094a8bbb44a3794f0465/src%2Ftest%2Fui%2Fmismatched_types%2Fmain.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/cd6a400175cc230008a5094a8bbb44a3794f0465/src%2Ftest%2Fui%2Fmismatched_types%2Fmain.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmismatched_types%2Fmain.stderr?ref=cd6a400175cc230008a5094a8bbb44a3794f0465", "patch": "@@ -0,0 +1,8 @@\n+error: mismatched types [--explain E0308]\n+  --> $DIR/main.rs:14:18\n+14 |>     let x: u32 = (\n+   |>                  ^ expected u32, found ()\n+note: expected type `u32`\n+note:    found type `()`\n+\n+error: aborting due to previous error"}, {"sha": "ddd69c399a5c17969e7b75b5fc2fad30646f5c6d", "filename": "src/test/ui/update-all-references.sh", "status": "added", "additions": 31, "deletions": 0, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/cd6a400175cc230008a5094a8bbb44a3794f0465/src%2Ftest%2Fui%2Fupdate-all-references.sh", "raw_url": "https://github.com/rust-lang/rust/raw/cd6a400175cc230008a5094a8bbb44a3794f0465/src%2Ftest%2Fui%2Fupdate-all-references.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fupdate-all-references.sh?ref=cd6a400175cc230008a5094a8bbb44a3794f0465", "patch": "@@ -0,0 +1,31 @@\n+#!/bin/bash\n+#\n+# Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+# file at the top-level directory of this distribution and at\n+# http://rust-lang.org/COPYRIGHT.\n+#\n+# Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+# http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+# <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+# option. This file may not be copied, modified, or distributed\n+# except according to those terms.\n+\n+# A script to update the references for all tests. The idea is that\n+# you do a run, which will generate files in the build directory\n+# containing the (normalized) actual output of the compiler. You then\n+# run this script, which will copy those files over. If you find\n+# yourself manually editing a foo.stderr file, you're doing it wrong.\n+#\n+# See all `update-references.sh`, if you just want to update a single test.\n+\n+if [[ \"$1\" == \"--help\" || \"$1\" == \"-h\" || \"$1\" == \"\" || \"$2\" != \"\" ]]; then\n+    echo \"usage: $0 <build-directory>\"\n+    echo \"\"\n+    echo \"For example:\"\n+    echo \"   $0 ../../../build/x86_64-apple-darwin/test/ui\"\n+fi\n+\n+BUILD_DIR=$PWD/$1\n+MY_DIR=$(dirname $0)\n+cd $MY_DIR\n+find . -name '*.rs' | xargs ./update-references.sh $BUILD_DIR"}, {"sha": "f0a6f8a3d44082283c3e11e796cec8e4b61de279", "filename": "src/test/ui/update-references.sh", "status": "added", "additions": 50, "deletions": 0, "changes": 50, "blob_url": "https://github.com/rust-lang/rust/blob/cd6a400175cc230008a5094a8bbb44a3794f0465/src%2Ftest%2Fui%2Fupdate-references.sh", "raw_url": "https://github.com/rust-lang/rust/raw/cd6a400175cc230008a5094a8bbb44a3794f0465/src%2Ftest%2Fui%2Fupdate-references.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fupdate-references.sh?ref=cd6a400175cc230008a5094a8bbb44a3794f0465", "patch": "@@ -0,0 +1,50 @@\n+#!/bin/bash\n+#\n+# Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+# file at the top-level directory of this distribution and at\n+# http://rust-lang.org/COPYRIGHT.\n+#\n+# Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+# http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+# <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+# option. This file may not be copied, modified, or distributed\n+# except according to those terms.\n+\n+# A script to update the references for particular tests. The idea is\n+# that you do a run, which will generate files in the build directory\n+# containing the (normalized) actual output of the compiler. This\n+# script will then copy that output and replace the \"expected output\"\n+# files. You can then commit the changes.\n+#\n+# If you find yourself manually editing a foo.stderr file, you're\n+# doing it wrong.\n+\n+if [[ \"$1\" == \"--help\" || \"$1\" == \"-h\" || \"$1\" == \"\" || \"$2\" == \"\" ]]; then\n+    echo \"usage: $0 <build-directory> <relative-path-to-rs-files>\"\n+    echo \"\"\n+    echo \"For example:\"\n+    echo \"   $0 ../../../build/x86_64-apple-darwin/test/ui *.rs */*.rs\"\n+fi\n+\n+MYDIR=$(dirname $0)\n+\n+BUILD_DIR=\"$1\"\n+shift\n+\n+while [[ \"$1\" != \"\" ]]; do\n+    STDERR_NAME=\"${1/%.rs/.stderr}\"\n+    STDOUT_NAME=\"${1/%.rs/.stdout}\"\n+    shift\n+    if [ -f $BUILD_DIR/$STDOUT_NAME ] && \\\n+           ! (diff $BUILD_DIR/$STDOUT_NAME $MYDIR/$STDOUT_NAME > /dev/null); then\n+        echo updating $MYDIR/$STDOUT_NAME\n+        cp $BUILD_DIR/$STDOUT_NAME $MYDIR/$STDOUT_NAME\n+    fi\n+    if [ -f $BUILD_DIR/$STDERR_NAME ] && \\\n+           ! (diff $BUILD_DIR/$STDERR_NAME $MYDIR/$STDERR_NAME > /dev/null); then\n+        echo updating $MYDIR/$STDERR_NAME\n+        cp $BUILD_DIR/$STDERR_NAME $MYDIR/$STDERR_NAME\n+    fi\n+done\n+\n+"}, {"sha": "5ec62e06e37aea6bee989fb95e15229cf1b42b6e", "filename": "src/tools/compiletest/src/common.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/cd6a400175cc230008a5094a8bbb44a3794f0465/src%2Ftools%2Fcompiletest%2Fsrc%2Fcommon.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cd6a400175cc230008a5094a8bbb44a3794f0465/src%2Ftools%2Fcompiletest%2Fsrc%2Fcommon.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fcommon.rs?ref=cd6a400175cc230008a5094a8bbb44a3794f0465", "patch": "@@ -28,6 +28,7 @@ pub enum Mode {\n     CodegenUnits,\n     Incremental,\n     RunMake,\n+    Ui,\n }\n \n impl FromStr for Mode {\n@@ -47,6 +48,7 @@ impl FromStr for Mode {\n           \"codegen-units\" => Ok(CodegenUnits),\n           \"incremental\" => Ok(Incremental),\n           \"run-make\" => Ok(RunMake),\n+          \"ui\" => Ok(Ui),\n           _ => Err(()),\n         }\n     }\n@@ -68,6 +70,7 @@ impl fmt::Display for Mode {\n             CodegenUnits => \"codegen-units\",\n             Incremental => \"incremental\",\n             RunMake => \"run-make\",\n+            Ui => \"ui\",\n         }, f)\n     }\n }"}, {"sha": "cc687b532047e616ac3adc874afb676b3b1006f3", "filename": "src/tools/compiletest/src/main.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/cd6a400175cc230008a5094a8bbb44a3794f0465/src%2Ftools%2Fcompiletest%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cd6a400175cc230008a5094a8bbb44a3794f0465/src%2Ftools%2Fcompiletest%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fmain.rs?ref=cd6a400175cc230008a5094a8bbb44a3794f0465", "patch": "@@ -50,6 +50,7 @@ pub mod runtest;\n pub mod common;\n pub mod errors;\n mod raise_fd_limit;\n+mod uidiff;\n \n fn main() {\n     #[cfg(cargobuild)]"}, {"sha": "a213c6d2d54a27cc17bb9dac6808ff39d3fafc86", "filename": "src/tools/compiletest/src/runtest.rs", "status": "modified", "additions": 95, "deletions": 1, "changes": 96, "blob_url": "https://github.com/rust-lang/rust/blob/cd6a400175cc230008a5094a8bbb44a3794f0465/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cd6a400175cc230008a5094a8bbb44a3794f0465/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs?ref=cd6a400175cc230008a5094a8bbb44a3794f0465", "patch": "@@ -11,13 +11,14 @@\n use common::Config;\n use common::{CompileFail, ParseFail, Pretty, RunFail, RunPass, RunPassValgrind};\n use common::{Codegen, DebugInfoLldb, DebugInfoGdb, Rustdoc, CodegenUnits};\n-use common::{Incremental, RunMake};\n+use common::{Incremental, RunMake, Ui};\n use errors::{self, ErrorKind, Error};\n use json;\n use header::TestProps;\n use header;\n use procsrv;\n use test::TestPaths;\n+use uidiff;\n use util::logv;\n \n use std::env;\n@@ -29,6 +30,7 @@ use std::io::prelude::*;\n use std::net::TcpStream;\n use std::path::{Path, PathBuf};\n use std::process::{Command, Output, ExitStatus};\n+use std::str;\n \n pub fn run(config: Config, testpaths: &TestPaths) {\n     match &*config.target {\n@@ -118,6 +120,7 @@ impl<'test> TestCx<'test> {\n             CodegenUnits => self.run_codegen_units_test(),\n             Incremental => self.run_incremental_test(),\n             RunMake => self.run_rmake_test(),\n+            Ui => self.run_ui_test(),\n         }\n     }\n \n@@ -1314,6 +1317,7 @@ actual:\\n\\\n             Codegen |\n             Rustdoc |\n             RunMake |\n+            Ui |\n             CodegenUnits => {\n                 // do not use JSON output\n             }\n@@ -2096,6 +2100,96 @@ actual:\\n\\\n         }\n         fs::remove_dir(path)\n     }\n+\n+    fn run_ui_test(&self) {\n+        println!(\"ui: {}\", self.testpaths.file.display());\n+\n+        let proc_res = self.compile_test();\n+\n+        let expected_stderr_path = self.expected_output_path(\"stderr\");\n+        let expected_stderr = self.load_expected_output(&expected_stderr_path);\n+\n+        let expected_stdout_path = self.expected_output_path(\"stdout\");\n+        let expected_stdout = self.load_expected_output(&expected_stdout_path);\n+\n+        let normalized_stdout = self.normalize_output(&proc_res.stdout);\n+        let normalized_stderr = self.normalize_output(&proc_res.stderr);\n+\n+        let mut errors = 0;\n+        errors += self.compare_output(\"stdout\", &normalized_stdout, &expected_stdout);\n+        errors += self.compare_output(\"stderr\", &normalized_stderr, &expected_stderr);\n+\n+        if errors > 0 {\n+            println!(\"To update references, run this command from build directory:\");\n+            let relative_path_to_file =\n+                self.testpaths.relative_dir\n+                              .join(self.testpaths.file.file_name().unwrap());\n+            println!(\"{}/update-references.sh '{}' '{}'\",\n+                     self.config.src_base.display(),\n+                     self.config.build_base.display(),\n+                     relative_path_to_file.display());\n+            self.fatal_proc_rec(&format!(\"{} errors occurred comparing output.\", errors),\n+                                &proc_res);\n+        }\n+    }\n+\n+    fn normalize_output(&self, output: &str) -> String {\n+        let parent_dir = self.testpaths.file.parent().unwrap();\n+        let parent_dir_str = parent_dir.display().to_string();\n+        output.replace(&parent_dir_str, \"$DIR\")\n+              .replace(\"\\\\\", \"/\") // normalize for paths on windows\n+              .replace(\"\\r\\n\", \"\\n\") // normalize for linebreaks on windows\n+              .replace(\"\\t\", \"\\\\t\") // makes tabs visible\n+    }\n+\n+    fn expected_output_path(&self, kind: &str) -> PathBuf {\n+        let extension = match self.revision {\n+            Some(r) => format!(\"{}.{}\", r, kind),\n+            None => kind.to_string(),\n+        };\n+        self.testpaths.file.with_extension(extension)\n+    }\n+\n+    fn load_expected_output(&self, path: &Path) -> String {\n+        if !path.exists() {\n+            return String::new();\n+        }\n+\n+        let mut result = String::new();\n+        match File::open(path).and_then(|mut f| f.read_to_string(&mut result)) {\n+            Ok(_) => result,\n+            Err(e) => {\n+                self.fatal(&format!(\"failed to load expected output from `{}`: {}\",\n+                                    path.display(), e))\n+            }\n+        }\n+    }\n+\n+    fn compare_output(&self, kind: &str, actual: &str, expected: &str) -> usize {\n+        if actual == expected {\n+            return 0;\n+        }\n+\n+        println!(\"normalized {}:\\n{}\\n\", kind, actual);\n+        println!(\"expected {}:\\n{}\\n\", kind, expected);\n+        println!(\"diff of {}:\\n\", kind);\n+        for line in uidiff::diff_lines(actual, expected) {\n+            println!(\"{}\", line);\n+        }\n+\n+        let output_file = self.output_base_name().with_extension(kind);\n+        match File::create(&output_file).and_then(|mut f| f.write_all(actual.as_bytes())) {\n+            Ok(()) => { }\n+            Err(e) => {\n+                self.fatal(&format!(\"failed to write {} to `{}`: {}\",\n+                                    kind, output_file.display(), e))\n+            }\n+        }\n+\n+        println!(\"\\nThe actual {0} differed from the expected {0}.\", kind);\n+        println!(\"Actual {} saved to {}\", kind, output_file.display());\n+        1\n+    }\n }\n \n struct ProcArgs {"}, {"sha": "66573393971c4c6692ce2549017f28e7680b19db", "filename": "src/tools/compiletest/src/uidiff.rs", "status": "added", "additions": 76, "deletions": 0, "changes": 76, "blob_url": "https://github.com/rust-lang/rust/blob/cd6a400175cc230008a5094a8bbb44a3794f0465/src%2Ftools%2Fcompiletest%2Fsrc%2Fuidiff.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cd6a400175cc230008a5094a8bbb44a3794f0465/src%2Ftools%2Fcompiletest%2Fsrc%2Fuidiff.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fuidiff.rs?ref=cd6a400175cc230008a5094a8bbb44a3794f0465", "patch": "@@ -0,0 +1,76 @@\n+// Copyright 2012-2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+//! Code for checking whether the output of the compiler matches what is\n+//! expected.\n+\n+pub fn diff_lines(actual: &str, expected: &str) -> Vec<String> {\n+    // mega simplistic diff algorithm that just prints the things added/removed\n+    zip_all(actual.lines(), expected.lines()).enumerate().filter_map(|(i, (a,e))| {\n+        match (a, e) {\n+            (Some(a), Some(e)) => {\n+                if lines_match(e, a) {\n+                    None\n+                } else {\n+                    Some(format!(\"{:3} - |{}|\\n    + |{}|\\n\", i, e, a))\n+                }\n+            },\n+            (Some(a), None) => {\n+                Some(format!(\"{:3} -\\n    + |{}|\\n\", i, a))\n+            },\n+            (None, Some(e)) => {\n+                Some(format!(\"{:3} - |{}|\\n    +\\n\", i, e))\n+            },\n+            (None, None) => panic!(\"Cannot get here\")\n+        }\n+    }).collect()\n+}\n+\n+fn lines_match(expected: &str, mut actual: &str) -> bool {\n+    for (i, part) in expected.split(\"[..]\").enumerate() {\n+        match actual.find(part) {\n+            Some(j) => {\n+                if i == 0 && j != 0 {\n+                    return false\n+                }\n+                actual = &actual[j + part.len()..];\n+            }\n+            None => {\n+                return false\n+            }\n+        }\n+    }\n+    actual.is_empty() || expected.ends_with(\"[..]\")\n+}\n+\n+struct ZipAll<I1: Iterator, I2: Iterator> {\n+    first: I1,\n+    second: I2,\n+}\n+\n+impl<T, I1: Iterator<Item=T>, I2: Iterator<Item=T>> Iterator for ZipAll<I1, I2> {\n+    type Item = (Option<T>, Option<T>);\n+    fn next(&mut self) -> Option<(Option<T>, Option<T>)> {\n+        let first = self.first.next();\n+        let second = self.second.next();\n+\n+        match (first, second) {\n+            (None, None) => None,\n+            (a, b) => Some((a, b))\n+        }\n+    }\n+}\n+\n+fn zip_all<T, I1: Iterator<Item=T>, I2: Iterator<Item=T>>(a: I1, b: I2) -> ZipAll<I1, I2> {\n+    ZipAll {\n+        first: a,\n+        second: b,\n+    }\n+}"}]}