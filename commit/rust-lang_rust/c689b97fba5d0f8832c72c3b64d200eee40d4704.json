{"sha": "c689b97fba5d0f8832c72c3b64d200eee40d4704", "node_id": "MDY6Q29tbWl0NzI0NzEyOmM2ODliOTdmYmE1ZDBmODgzMmM3MmMzYjY0ZDIwMGVlZTQwZDQ3MDQ=", "commit": {"author": {"name": "Rune Tynan", "email": "runetynan@gmail.com", "date": "2021-01-22T21:09:24Z"}, "committer": {"name": "Rune Tynan", "email": "runetynan@gmail.com", "date": "2021-01-27T23:56:57Z"}, "message": "Split JSON into separately versioned crate", "tree": {"sha": "b24013b5ce38d0a2412c42be8c1c0462bb211673", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b24013b5ce38d0a2412c42be8c1c0462bb211673"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c689b97fba5d0f8832c72c3b64d200eee40d4704", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEETdpCnQmiF6hBYUqdfsyTL4sscx4FAmAR/dcACgkQfsyTL4ss\ncx5CmxAAvfCZWD/qXoUqxHdhjdhbIg4H9qqwpOdm3x8Yfj7nzO9sFxsV6evi1vUn\nKt3Lw7wA+lbsS0LbiggYxneXxEZ3ddp7Tc2Y2/hhCfrkiXNZHaibQ/rIOimZyCC3\nTYAX+2iBfyuMHlj95V5yq2JtHVQ/APVi1tBxsL3e7naXeyzJKL7bC7yKVF/37oZa\ntp0HrdieLs2RMdXa5Ou63H+tjuj+OC2rbqLfeWgOwe3MhemuS1/9EqTjFiLIE3e7\nSjvt7dSVfB5wSUkoX8ViWx438qcFqdv7dzL1vzJXebg/ULtvMnZt/vYzlFmkg5ZL\nhbzCB00cpiDDwbb0CCX8AGmJcMduLqT8m2hZpea3grRoiTXL7Rw4Jm0U2qAORpru\nXttSZ5xog4gWcMVPRXkVnhIhmznYm2jKnzdEGc8n/MvLDohKY6m9u8CaiIHpOv6f\nYujTWbF+3hX4AODIeLJ5K42h6fHF81XXdIkWBTEGxxb5UlP7b+dGSc03VZBcIAIZ\nf+QgnVgr1kASUB+oOD3VgnrYmVCv2FynHQw2B0Ak7csv2qe6P1aq2DBJRmlmayWN\n/ulQD/p3iunv4MuVRqskngxCgfyJWFaw7LO/kWbhrcusM6Y2ClavzMzzDHnEySLb\nYQzo7LjFNuxCwCCmxAXp20Hkgh5YOyooxjnUoYfYqy3ElQEM3ZQ=\n=5g02\n-----END PGP SIGNATURE-----", "payload": "tree b24013b5ce38d0a2412c42be8c1c0462bb211673\nparent a2f8f6281817d430e20726128b739d3c6708561c\nauthor Rune Tynan <runetynan@gmail.com> 1611349764 -0500\ncommitter Rune Tynan <runetynan@gmail.com> 1611791817 -0500\n\nSplit JSON into separately versioned crate\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c689b97fba5d0f8832c72c3b64d200eee40d4704", "html_url": "https://github.com/rust-lang/rust/commit/c689b97fba5d0f8832c72c3b64d200eee40d4704", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c689b97fba5d0f8832c72c3b64d200eee40d4704/comments", "author": {"login": "CraftSpider", "id": 13342132, "node_id": "MDQ6VXNlcjEzMzQyMTMy", "avatar_url": "https://avatars.githubusercontent.com/u/13342132?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CraftSpider", "html_url": "https://github.com/CraftSpider", "followers_url": "https://api.github.com/users/CraftSpider/followers", "following_url": "https://api.github.com/users/CraftSpider/following{/other_user}", "gists_url": "https://api.github.com/users/CraftSpider/gists{/gist_id}", "starred_url": "https://api.github.com/users/CraftSpider/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CraftSpider/subscriptions", "organizations_url": "https://api.github.com/users/CraftSpider/orgs", "repos_url": "https://api.github.com/users/CraftSpider/repos", "events_url": "https://api.github.com/users/CraftSpider/events{/privacy}", "received_events_url": "https://api.github.com/users/CraftSpider/received_events", "type": "User", "site_admin": false}, "committer": {"login": "CraftSpider", "id": 13342132, "node_id": "MDQ6VXNlcjEzMzQyMTMy", "avatar_url": "https://avatars.githubusercontent.com/u/13342132?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CraftSpider", "html_url": "https://github.com/CraftSpider", "followers_url": "https://api.github.com/users/CraftSpider/followers", "following_url": "https://api.github.com/users/CraftSpider/following{/other_user}", "gists_url": "https://api.github.com/users/CraftSpider/gists{/gist_id}", "starred_url": "https://api.github.com/users/CraftSpider/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CraftSpider/subscriptions", "organizations_url": "https://api.github.com/users/CraftSpider/orgs", "repos_url": "https://api.github.com/users/CraftSpider/repos", "events_url": "https://api.github.com/users/CraftSpider/events{/privacy}", "received_events_url": "https://api.github.com/users/CraftSpider/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a2f8f6281817d430e20726128b739d3c6708561c", "url": "https://api.github.com/repos/rust-lang/rust/commits/a2f8f6281817d430e20726128b739d3c6708561c", "html_url": "https://github.com/rust-lang/rust/commit/a2f8f6281817d430e20726128b739d3c6708561c"}], "stats": {"total": 131, "additions": 72, "deletions": 59}, "files": [{"sha": "5b58ed8f6a05020fc01af1f32b4e45330d97f2ba", "filename": "Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/c689b97fba5d0f8832c72c3b64d200eee40d4704/Cargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/c689b97fba5d0f8832c72c3b64d200eee40d4704/Cargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.toml?ref=c689b97fba5d0f8832c72c3b64d200eee40d4704", "patch": "@@ -4,6 +4,7 @@ members = [\n   \"compiler/rustc\",\n   \"library/std\",\n   \"library/test\",\n+  \"src/librustdoc/json-types\",\n   \"src/tools/cargotest\",\n   \"src/tools/clippy\",\n   \"src/tools/compiletest\","}, {"sha": "bc6eba74d2d48a1095d98c2f60af92bebfe78257", "filename": "src/librustdoc/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/c689b97fba5d0f8832c72c3b64d200eee40d4704/src%2Flibrustdoc%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/c689b97fba5d0f8832c72c3b64d200eee40d4704/src%2Flibrustdoc%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2FCargo.toml?ref=c689b97fba5d0f8832c72c3b64d200eee40d4704", "patch": "@@ -17,6 +17,7 @@ smallvec = \"1.0\"\n tempfile = \"3\"\n itertools = \"0.9\"\n regex = \"1\"\n+json-types = { path = \"./json-types\" }\n \n [dev-dependencies]\n expect-test = \"1.0\""}, {"sha": "b9c97c31c187727f906644001e667dc4aa6b4197", "filename": "src/librustdoc/json-types/Cargo.toml", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/c689b97fba5d0f8832c72c3b64d200eee40d4704/src%2Flibrustdoc%2Fjson-types%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/c689b97fba5d0f8832c72c3b64d200eee40d4704/src%2Flibrustdoc%2Fjson-types%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fjson-types%2FCargo.toml?ref=c689b97fba5d0f8832c72c3b64d200eee40d4704", "patch": "@@ -0,0 +1,11 @@\n+[package]\n+name = \"json-types\"\n+version = \"0.1.0\"\n+authors = [\"The Rust Project Developers\"]\n+edition = \"2018\"\n+\n+[lib]\n+path = \"lib.rs\"\n+\n+[dependencies]\n+serde = { version = \"1.0\", features = [\"derive\"] }"}, {"sha": "3fb2a32d5a0a33fc82d7badd7656d9a7b08eaca6", "filename": "src/librustdoc/json-types/lib.rs", "status": "renamed", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/c689b97fba5d0f8832c72c3b64d200eee40d4704/src%2Flibrustdoc%2Fjson-types%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c689b97fba5d0f8832c72c3b64d200eee40d4704/src%2Flibrustdoc%2Fjson-types%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fjson-types%2Flib.rs?ref=c689b97fba5d0f8832c72c3b64d200eee40d4704", "patch": "@@ -3,9 +3,9 @@\n //! These types are the public API exposed through the `--output-format json` flag. The [`Crate`]\n //! struct is the root of the JSON blob and all other items are contained within.\n \n+use std::collections::HashMap;\n use std::path::PathBuf;\n \n-use rustc_data_structures::fx::FxHashMap;\n use serde::{Deserialize, Serialize};\n \n /// A `Crate` is the root of the emitted JSON blob. It contains all type/documentation information\n@@ -21,11 +21,11 @@ pub struct Crate {\n     pub includes_private: bool,\n     /// A collection of all items in the local crate as well as some external traits and their\n     /// items that are referenced locally.\n-    pub index: FxHashMap<Id, Item>,\n+    pub index: HashMap<Id, Item>,\n     /// Maps IDs to fully qualified paths and other info helpful for generating links.\n-    pub paths: FxHashMap<Id, ItemSummary>,\n+    pub paths: HashMap<Id, ItemSummary>,\n     /// Maps `crate_id` of items to a crate name and html_root_url if it exists.\n-    pub external_crates: FxHashMap<u32, ExternalCrate>,\n+    pub external_crates: HashMap<u32, ExternalCrate>,\n     /// A single version number to be used in the future when making backwards incompatible changes\n     /// to the JSON output.\n     pub format_version: u32,\n@@ -72,7 +72,7 @@ pub struct Item {\n     /// Some(\"\") if there is some documentation but it is empty (EG `#[doc = \"\"]`).\n     pub docs: Option<String>,\n     /// This mapping resolves [intra-doc links](https://github.com/rust-lang/rfcs/blob/master/text/1946-intra-rustdoc-links.md) from the docstring to their IDs\n-    pub links: FxHashMap<String, Id>,\n+    pub links: HashMap<String, Id>,\n     /// Stringified versions of the attributes on this item (e.g. `\"#[inline]\"`)\n     pub attrs: Vec<String>,\n     pub deprecation: Option<Deprecation>,", "previous_filename": "src/librustdoc/json/types.rs"}, {"sha": "9b0603c4d55ba59d7b6d40d057a5d1090d33d042", "filename": "src/librustdoc/json/conversions.rs", "status": "modified", "additions": 37, "deletions": 46, "changes": 83, "blob_url": "https://github.com/rust-lang/rust/blob/c689b97fba5d0f8832c72c3b64d200eee40d4704/src%2Flibrustdoc%2Fjson%2Fconversions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c689b97fba5d0f8832c72c3b64d200eee40d4704/src%2Flibrustdoc%2Fjson%2Fconversions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fjson%2Fconversions.rs?ref=c689b97fba5d0f8832c72c3b64d200eee40d4704", "patch": "@@ -9,9 +9,10 @@ use rustc_hir::def::CtorKind;\n use rustc_span::def_id::{DefId, CRATE_DEF_INDEX};\n use rustc_span::Pos;\n \n+use json_types::*;\n+\n use crate::clean;\n use crate::formats::item_type::ItemType;\n-use crate::json::types::*;\n use crate::json::JsonRenderer;\n \n impl JsonRenderer<'_> {\n@@ -22,7 +23,7 @@ impl JsonRenderer<'_> {\n         match *kind {\n             clean::StrippedItem(_) => None,\n             kind => Some(Item {\n-                id: def_id.into(),\n+                id: from_def_id(def_id),\n                 crate_id: def_id.krate.as_u32(),\n                 name: name.map(|sym| sym.to_string()),\n                 source: self.convert_span(source),\n@@ -32,15 +33,15 @@ impl JsonRenderer<'_> {\n                     .links\n                     .into_iter()\n                     .filter_map(|clean::ItemLink { link, did, .. }| {\n-                        did.map(|did| (link, did.into()))\n+                        did.map(|did| (link, from_def_id(did)))\n                     })\n                     .collect(),\n                 attrs: attrs\n                     .other_attrs\n                     .iter()\n                     .map(rustc_ast_pretty::pprust::attribute_to_string)\n                     .collect(),\n-                deprecation: deprecation.map(Into::into),\n+                deprecation: deprecation.map(from_deprecation),\n                 kind: item_type.into(),\n                 inner: kind.into(),\n             }),\n@@ -74,19 +75,17 @@ impl JsonRenderer<'_> {\n             Inherited => Visibility::Default,\n             Restricted(did) if did.index == CRATE_DEF_INDEX => Visibility::Crate,\n             Restricted(did) => Visibility::Restricted {\n-                parent: did.into(),\n+                parent: from_def_id(did),\n                 path: self.tcx.def_path(did).to_string_no_crate_verbose(),\n             },\n         }\n     }\n }\n \n-impl From<rustc_attr::Deprecation> for Deprecation {\n-    fn from(deprecation: rustc_attr::Deprecation) -> Self {\n-        #[rustfmt::skip]\n-        let rustc_attr::Deprecation { since, note, is_since_rustc_version: _, suggestion: _ } = deprecation;\n-        Deprecation { since: since.map(|s| s.to_string()), note: note.map(|s| s.to_string()) }\n-    }\n+crate fn from_deprecation(deprecation: rustc_attr::Deprecation) -> Deprecation {\n+    #[rustfmt::skip]\n+    let rustc_attr::Deprecation { since, note, is_since_rustc_version: _, suggestion: _ } = deprecation;\n+    Deprecation { since: since.map(|s| s.to_string()), note: note.map(|s| s.to_string()) }\n }\n \n impl From<clean::GenericArgs> for GenericArgs {\n@@ -141,10 +140,8 @@ impl From<clean::TypeBindingKind> for TypeBindingKind {\n     }\n }\n \n-impl From<DefId> for Id {\n-    fn from(did: DefId) -> Self {\n-        Id(format!(\"{}:{}\", did.krate.as_u32(), u32::from(did.index)))\n-    }\n+crate fn from_def_id(did: DefId) -> Id {\n+    Id(format!(\"{}:{}\", did.krate.as_u32(), u32::from(did.index)))\n }\n \n impl From<clean::ItemKind> for ItemEnum {\n@@ -199,7 +196,7 @@ impl From<clean::Struct> for Struct {\n     fn from(struct_: clean::Struct) -> Self {\n         let clean::Struct { struct_type, generics, fields, fields_stripped } = struct_;\n         Struct {\n-            struct_type: struct_type.into(),\n+            struct_type: from_ctor_kind(struct_type),\n             generics: generics.into(),\n             fields_stripped,\n             fields: ids(fields),\n@@ -221,13 +218,11 @@ impl From<clean::Union> for Struct {\n     }\n }\n \n-impl From<CtorKind> for StructType {\n-    fn from(struct_type: CtorKind) -> Self {\n-        match struct_type {\n-            CtorKind::Fictive => StructType::Plain,\n-            CtorKind::Fn => StructType::Tuple,\n-            CtorKind::Const => StructType::Unit,\n-        }\n+crate fn from_ctor_kind(struct_type: CtorKind) -> StructType {\n+    match struct_type {\n+        CtorKind::Fictive => StructType::Plain,\n+        CtorKind::Fn => StructType::Tuple,\n+        CtorKind::Const => StructType::Unit,\n     }\n }\n \n@@ -310,22 +305,20 @@ impl From<clean::GenericBound> for GenericBound {\n                 GenericBound::TraitBound {\n                     trait_: trait_.into(),\n                     generic_params: generic_params.into_iter().map(Into::into).collect(),\n-                    modifier: modifier.into(),\n+                    modifier: from_trait_bound_modifier(modifier),\n                 }\n             }\n             Outlives(lifetime) => GenericBound::Outlives(lifetime.0.to_string()),\n         }\n     }\n }\n \n-impl From<rustc_hir::TraitBoundModifier> for TraitBoundModifier {\n-    fn from(modifier: rustc_hir::TraitBoundModifier) -> Self {\n-        use rustc_hir::TraitBoundModifier::*;\n-        match modifier {\n-            None => TraitBoundModifier::None,\n-            Maybe => TraitBoundModifier::Maybe,\n-            MaybeConst => TraitBoundModifier::MaybeConst,\n-        }\n+crate fn from_trait_bound_modifier(modifier: rustc_hir::TraitBoundModifier) -> TraitBoundModifier {\n+    use rustc_hir::TraitBoundModifier::*;\n+    match modifier {\n+        None => TraitBoundModifier::None,\n+        Maybe => TraitBoundModifier::Maybe,\n+        MaybeConst => TraitBoundModifier::MaybeConst,\n     }\n }\n \n@@ -335,7 +328,7 @@ impl From<clean::Type> for Type {\n         match ty {\n             ResolvedPath { path, param_names, did, is_generic: _ } => Type::ResolvedPath {\n                 name: path.whole_name(),\n-                id: did.into(),\n+                id: from_def_id(did),\n                 args: path.segments.last().map(|args| Box::new(args.clone().args.into())),\n                 param_names: param_names\n                     .map(|v| v.into_iter().map(Into::into).collect())\n@@ -470,7 +463,7 @@ impl From<clean::VariantStruct> for Struct {\n     fn from(struct_: clean::VariantStruct) -> Self {\n         let clean::VariantStruct { struct_type, fields, fields_stripped } = struct_;\n         Struct {\n-            struct_type: struct_type.into(),\n+            struct_type: from_ctor_kind(struct_type),\n             generics: Default::default(),\n             fields_stripped,\n             fields: ids(fields),\n@@ -497,13 +490,13 @@ impl From<clean::Import> for Import {\n             Simple(s) => Import {\n                 span: import.source.path.whole_name(),\n                 name: s.to_string(),\n-                id: import.source.did.map(Into::into),\n+                id: import.source.did.map(from_def_id),\n                 glob: false,\n             },\n             Glob => Import {\n                 span: import.source.path.whole_name(),\n                 name: import.source.path.last_name().to_string(),\n-                id: import.source.did.map(Into::into),\n+                id: import.source.did.map(from_def_id),\n                 glob: true,\n             },\n         }\n@@ -513,20 +506,18 @@ impl From<clean::Import> for Import {\n impl From<clean::ProcMacro> for ProcMacro {\n     fn from(mac: clean::ProcMacro) -> Self {\n         ProcMacro {\n-            kind: mac.kind.into(),\n+            kind: from_macro_kind(mac.kind),\n             helpers: mac.helpers.iter().map(|x| x.to_string()).collect(),\n         }\n     }\n }\n \n-impl From<rustc_span::hygiene::MacroKind> for MacroKind {\n-    fn from(kind: rustc_span::hygiene::MacroKind) -> Self {\n-        use rustc_span::hygiene::MacroKind::*;\n-        match kind {\n-            Bang => MacroKind::Bang,\n-            Attr => MacroKind::Attr,\n-            Derive => MacroKind::Derive,\n-        }\n+crate fn from_macro_kind(kind: rustc_span::hygiene::MacroKind) -> MacroKind {\n+    use rustc_span::hygiene::MacroKind::*;\n+    match kind {\n+        Bang => MacroKind::Bang,\n+        Attr => MacroKind::Attr,\n+        Derive => MacroKind::Derive,\n     }\n }\n \n@@ -599,5 +590,5 @@ impl From<ItemType> for ItemKind {\n }\n \n fn ids(items: impl IntoIterator<Item = clean::Item>) -> Vec<Id> {\n-    items.into_iter().filter(|x| !x.is_stripped()).map(|i| i.def_id.into()).collect()\n+    items.into_iter().filter(|x| !x.is_stripped()).map(|i| from_def_id(i.def_id)).collect()\n }"}, {"sha": "7d4d5598c6b9b0ea5afeb3200312502c9ef9fd6a", "filename": "src/librustdoc/json/mod.rs", "status": "modified", "additions": 17, "deletions": 8, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/c689b97fba5d0f8832c72c3b64d200eee40d4704/src%2Flibrustdoc%2Fjson%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c689b97fba5d0f8832c72c3b64d200eee40d4704/src%2Flibrustdoc%2Fjson%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fjson%2Fmod.rs?ref=c689b97fba5d0f8832c72c3b64d200eee40d4704", "patch": "@@ -5,7 +5,6 @@\n //! docs for usage and details.\n \n mod conversions;\n-pub mod types;\n \n use std::cell::RefCell;\n use std::fs::File;\n@@ -17,12 +16,15 @@ use rustc_middle::ty::TyCtxt;\n use rustc_session::Session;\n use rustc_span::edition::Edition;\n \n+use json_types as types;\n+\n use crate::clean;\n use crate::config::{RenderInfo, RenderOptions};\n use crate::error::Error;\n use crate::formats::cache::Cache;\n use crate::formats::FormatRenderer;\n use crate::html::render::cache::ExternalLocation;\n+use crate::json::conversions::from_def_id;\n \n #[derive(Clone)]\n crate struct JsonRenderer<'tcx> {\n@@ -50,7 +52,7 @@ impl JsonRenderer<'_> {\n                     .map(|i| {\n                         let item = &i.impl_item;\n                         self.item(item.clone()).unwrap();\n-                        item.def_id.into()\n+                        from_def_id(item.def_id)\n                     })\n                     .collect()\n             })\n@@ -68,7 +70,7 @@ impl JsonRenderer<'_> {\n                         let item = &i.impl_item;\n                         if item.def_id.is_local() {\n                             self.item(item.clone()).unwrap();\n-                            Some(item.def_id.into())\n+                            Some(from_def_id(item.def_id))\n                         } else {\n                             None\n                         }\n@@ -87,9 +89,9 @@ impl JsonRenderer<'_> {\n                 if !id.is_local() {\n                     trait_item.items.clone().into_iter().for_each(|i| self.item(i).unwrap());\n                     Some((\n-                        id.into(),\n+                        from_def_id(id),\n                         types::Item {\n-                            id: id.into(),\n+                            id: from_def_id(id),\n                             crate_id: id.krate.as_u32(),\n                             name: self\n                                 .cache\n@@ -163,7 +165,7 @@ impl<'tcx> FormatRenderer<'tcx> for JsonRenderer<'tcx> {\n             } else if let types::ItemEnum::EnumItem(ref mut e) = new_item.inner {\n                 e.impls = self.get_impls(id)\n             }\n-            let removed = self.index.borrow_mut().insert(id.into(), new_item.clone());\n+            let removed = self.index.borrow_mut().insert(from_def_id(id), new_item.clone());\n             // FIXME(adotinthevoid): Currently, the index is duplicated. This is a sanity check\n             // to make sure the items are unique.\n             if let Some(old_item) = removed {\n@@ -203,11 +205,18 @@ impl<'tcx> FormatRenderer<'tcx> for JsonRenderer<'tcx> {\n         debug!(\"Done with crate\");\n         let mut index = (*self.index).clone().into_inner();\n         index.extend(self.get_trait_items());\n+        let len = index.len();\n         let output = types::Crate {\n             root: types::Id(String::from(\"0:0\")),\n             crate_version: krate.version.clone(),\n             includes_private: self.cache.document_private,\n-            index,\n+            index: index.into_iter().fold(\n+                std::collections::HashMap::with_capacity(len),\n+                |mut acc, (key, val)| {\n+                    acc.insert(key, val);\n+                    acc\n+                },\n+            ),\n             paths: self\n                 .cache\n                 .paths\n@@ -216,7 +225,7 @@ impl<'tcx> FormatRenderer<'tcx> for JsonRenderer<'tcx> {\n                 .chain(self.cache.external_paths.clone().into_iter())\n                 .map(|(k, (path, kind))| {\n                     (\n-                        k.into(),\n+                        from_def_id(k),\n                         types::ItemSummary { crate_id: k.krate.as_u32(), path, kind: kind.into() },\n                     )\n                 })"}]}