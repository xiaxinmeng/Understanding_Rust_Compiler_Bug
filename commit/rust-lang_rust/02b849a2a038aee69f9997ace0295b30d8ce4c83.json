{"sha": "02b849a2a038aee69f9997ace0295b30d8ce4c83", "node_id": "MDY6Q29tbWl0NzI0NzEyOjAyYjg0OWEyYTAzOGFlZTY5Zjk5OTdhY2UwMjk1YjMwZDhjZTRjODM=", "commit": {"author": {"name": "Edwin Cheng", "email": "edwin0cheng@gmail.com", "date": "2020-03-31T14:01:34Z"}, "committer": {"name": "Edwin Cheng", "email": "edwin0cheng@gmail.com", "date": "2020-03-31T14:20:19Z"}, "message": "Refactor a bit", "tree": {"sha": "f7d191433e835b5985560842ead4dd226b9aea3b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f7d191433e835b5985560842ead4dd226b9aea3b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/02b849a2a038aee69f9997ace0295b30d8ce4c83", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/02b849a2a038aee69f9997ace0295b30d8ce4c83", "html_url": "https://github.com/rust-lang/rust/commit/02b849a2a038aee69f9997ace0295b30d8ce4c83", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/02b849a2a038aee69f9997ace0295b30d8ce4c83/comments", "author": {"login": "edwin0cheng", "id": 11014119, "node_id": "MDQ6VXNlcjExMDE0MTE5", "avatar_url": "https://avatars.githubusercontent.com/u/11014119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/edwin0cheng", "html_url": "https://github.com/edwin0cheng", "followers_url": "https://api.github.com/users/edwin0cheng/followers", "following_url": "https://api.github.com/users/edwin0cheng/following{/other_user}", "gists_url": "https://api.github.com/users/edwin0cheng/gists{/gist_id}", "starred_url": "https://api.github.com/users/edwin0cheng/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/edwin0cheng/subscriptions", "organizations_url": "https://api.github.com/users/edwin0cheng/orgs", "repos_url": "https://api.github.com/users/edwin0cheng/repos", "events_url": "https://api.github.com/users/edwin0cheng/events{/privacy}", "received_events_url": "https://api.github.com/users/edwin0cheng/received_events", "type": "User", "site_admin": false}, "committer": {"login": "edwin0cheng", "id": 11014119, "node_id": "MDQ6VXNlcjExMDE0MTE5", "avatar_url": "https://avatars.githubusercontent.com/u/11014119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/edwin0cheng", "html_url": "https://github.com/edwin0cheng", "followers_url": "https://api.github.com/users/edwin0cheng/followers", "following_url": "https://api.github.com/users/edwin0cheng/following{/other_user}", "gists_url": "https://api.github.com/users/edwin0cheng/gists{/gist_id}", "starred_url": "https://api.github.com/users/edwin0cheng/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/edwin0cheng/subscriptions", "organizations_url": "https://api.github.com/users/edwin0cheng/orgs", "repos_url": "https://api.github.com/users/edwin0cheng/repos", "events_url": "https://api.github.com/users/edwin0cheng/events{/privacy}", "received_events_url": "https://api.github.com/users/edwin0cheng/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f461dc48d116a97188ae6d9934c8e3b421c335ac", "url": "https://api.github.com/repos/rust-lang/rust/commits/f461dc48d116a97188ae6d9934c8e3b421c335ac", "html_url": "https://github.com/rust-lang/rust/commit/f461dc48d116a97188ae6d9934c8e3b421c335ac"}], "stats": {"total": 20, "additions": 9, "deletions": 11}, "files": [{"sha": "df4d6168279aee55b27792554b9dbf0e227fbcf5", "filename": "crates/ra_proc_macro/src/process.rs", "status": "modified", "additions": 9, "deletions": 11, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/02b849a2a038aee69f9997ace0295b30d8ce4c83/crates%2Fra_proc_macro%2Fsrc%2Fprocess.rs", "raw_url": "https://github.com/rust-lang/rust/raw/02b849a2a038aee69f9997ace0295b30d8ce4c83/crates%2Fra_proc_macro%2Fsrc%2Fprocess.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_proc_macro%2Fsrc%2Fprocess.rs?ref=02b849a2a038aee69f9997ace0295b30d8ce4c83", "patch": "@@ -29,7 +29,7 @@ pub(crate) struct ProcMacroProcessThread {\n \n struct Task {\n     req: Request,\n-    result_tx: Sender<Response>,\n+    result_tx: Sender<Option<Response>>,\n }\n \n struct Process {\n@@ -131,18 +131,21 @@ impl ProcMacroProcessSrv {\n             Some(it) => it,\n         };\n         sender.send(Task { req: req.into(), result_tx }).unwrap();\n+        let res = result_rx\n+            .recv()\n+            .map_err(|_| ra_tt::ExpansionError::Unknown(\"Proc macro thread is closed.\".into()))?;\n \n-        let res = result_rx.recv().unwrap();\n         match res {\n-            Response::Error(err) => {\n+            Some(Response::Error(err)) => {\n                 return Err(ra_tt::ExpansionError::ExpansionError(err.message));\n             }\n-            _ => Ok(res.try_into().map_err(|err| {\n+            Some(res) => Ok(res.try_into().map_err(|err| {\n                 ra_tt::ExpansionError::Unknown(format!(\n                     \"Fail to get response, reason : {:#?} \",\n                     err\n                 ))\n             })?),\n+            None => Err(ra_tt::ExpansionError::Unknown(\"Empty result\".into())),\n         }\n     }\n }\n@@ -156,8 +159,8 @@ fn client_loop(task_rx: Receiver<Task>, mut process: Process) {\n     for task in task_rx {\n         let Task { req, result_tx } = task;\n \n-        let res = match send_request(&mut stdin, &mut stdout, req) {\n-            Ok(res) => res,\n+        match send_request(&mut stdin, &mut stdout, req) {\n+            Ok(res) => result_tx.send(res).unwrap(),\n             Err(_err) => {\n                 let res = Response::Error(ResponseError {\n                     code: ErrorCode::ServerErrorEnd,\n@@ -174,12 +177,7 @@ fn client_loop(task_rx: Receiver<Task>, mut process: Process) {\n                 };\n                 stdin = stdio.0;\n                 stdout = stdio.1;\n-                continue;\n             }\n-        };\n-\n-        if let Some(res) = res {\n-            result_tx.send(res).unwrap();\n         }\n     }\n }"}]}