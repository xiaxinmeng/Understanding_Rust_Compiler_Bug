{"sha": "7ee72070bdb789f58f272fab50d49bd48dd9c11f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdlZTcyMDcwYmRiNzg5ZjU4ZjI3MmZhYjUwZDQ5YmQ0OGRkOWMxMWY=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-09-11T08:54:11Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-09-11T08:54:11Z"}, "message": "Auto merge of #51363 - japaric:stable-used, r=cramertj\n\nstabilize #[used]\n\ncloses #40289\n\nRFC for stabilization: rust-lang/rfcs#2386\n\nr? @Centril\n\nWhere should this be documented? Currently the documentation is in the unstable book", "tree": {"sha": "40074abd149490bdbfe0592f4e9e2c4c27b6ace5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/40074abd149490bdbfe0592f4e9e2c4c27b6ace5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7ee72070bdb789f58f272fab50d49bd48dd9c11f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7ee72070bdb789f58f272fab50d49bd48dd9c11f", "html_url": "https://github.com/rust-lang/rust/commit/7ee72070bdb789f58f272fab50d49bd48dd9c11f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7ee72070bdb789f58f272fab50d49bd48dd9c11f/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1f02f23263ff03d7f590f19d31741c5d6b08b44f", "url": "https://api.github.com/repos/rust-lang/rust/commits/1f02f23263ff03d7f590f19d31741c5d6b08b44f", "html_url": "https://github.com/rust-lang/rust/commit/1f02f23263ff03d7f590f19d31741c5d6b08b44f"}, {"sha": "d37658afbda2a74f35e0d3fb479fcb6985bb9e53", "url": "https://api.github.com/repos/rust-lang/rust/commits/d37658afbda2a74f35e0d3fb479fcb6985bb9e53", "html_url": "https://github.com/rust-lang/rust/commit/d37658afbda2a74f35e0d3fb479fcb6985bb9e53"}], "stats": {"total": 216, "additions": 11, "deletions": 205}, "files": [{"sha": "d49271382b60496d7e1b69d065f5408119e4f4d8", "filename": "src/doc/unstable-book/src/language-features/used.md", "status": "removed", "additions": 0, "deletions": 157, "changes": 157, "blob_url": "https://github.com/rust-lang/rust/blob/1f02f23263ff03d7f590f19d31741c5d6b08b44f/src%2Fdoc%2Funstable-book%2Fsrc%2Flanguage-features%2Fused.md", "raw_url": "https://github.com/rust-lang/rust/raw/1f02f23263ff03d7f590f19d31741c5d6b08b44f/src%2Fdoc%2Funstable-book%2Fsrc%2Flanguage-features%2Fused.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Funstable-book%2Fsrc%2Flanguage-features%2Fused.md?ref=1f02f23263ff03d7f590f19d31741c5d6b08b44f", "patch": "@@ -1,157 +0,0 @@\n-# `used`\n-\n-The tracking issue for this feature\n-is: [40289](https://github.com/rust-lang/rust/issues/40289).\n-\n-------------------------\n-\n-The `#[used]` attribute can be applied to `static` variables to prevent the Rust\n-compiler from optimizing them away even if they appear to be unused by the crate\n-(appear to be \"dead code\").\n-\n-``` rust\n-#![feature(used)]\n-\n-#[used]\n-static FOO: i32 = 1;\n-\n-static BAR: i32 = 2;\n-\n-fn main() {}\n-```\n-\n-If you compile this program into an object file, you'll see that `FOO` makes it\n-to the object file but `BAR` doesn't. Neither static variable is used by the\n-program.\n-\n-``` text\n-$ rustc -C opt-level=3 --emit=obj used.rs\n-\n-$ nm -C used.o\n-0000000000000000 T main\n-                 U std::rt::lang_start\n-0000000000000000 r used::FOO\n-0000000000000000 t used::main\n-```\n-\n-Note that the *linker* knows nothing about the `#[used]` attribute and will\n-remove `#[used]` symbols if they are not referenced by other parts of the\n-program:\n-\n-``` text\n-$ rustc -C opt-level=3 used.rs\n-\n-$ nm -C used | grep FOO\n-```\n-\n-\"This doesn't sound too useful then!\" you may think but keep reading.\n-\n-To preserve the symbols all the way to the final binary, you'll need the\n-cooperation of the linker. Here's one example:\n-\n-The ELF standard defines two special sections, `.init_array` and\n-`.pre_init_array`, that may contain function pointers which will be executed\n-*before* the `main` function is invoked. The linker will preserve symbols placed\n-in these sections (at least when linking programs that target the `*-*-linux-*`\n-targets).\n-\n-``` rust,ignore\n-#![feature(used)]\n-\n-extern \"C\" fn before_main() {\n-    println!(\"Hello, world!\");\n-}\n-\n-#[link_section = \".init_array\"]\n-#[used]\n-static INIT_ARRAY: [extern \"C\" fn(); 1] = [before_main];\n-\n-fn main() {}\n-```\n-\n-So, `#[used]` and `#[link_section]` can be combined to obtain \"life before\n-main\".\n-\n-``` text\n-$ rustc -C opt-level=3 before-main.rs\n-\n-$ ./before-main\n-Hello, world!\n-```\n-\n-Another example: ARM Cortex-M microcontrollers need their reset handler, a\n-pointer to the function that will executed right after the microcontroller is\n-turned on, to be placed near the start of their FLASH memory to boot properly.\n-\n-This condition can be met using `#[used]` and `#[link_section]` plus a linker\n-script.\n-\n-``` rust,ignore\n-#![feature(panic_handler)]\n-#![feature(used)]\n-#![no_main]\n-#![no_std]\n-\n-use core::panic::PanicInfo;\n-\n-extern \"C\" fn reset_handler() -> ! {\n-    loop {}\n-}\n-\n-#[link_section = \".reset_handler\"]\n-#[used]\n-static RESET_HANDLER: extern \"C\" fn() -> ! = reset_handler;\n-\n-#[panic_handler]\n-fn panic(info: &PanicInfo) -> ! {\n-    loop {}\n-}\n-```\n-\n-``` text\n-MEMORY\n-{\n-  FLASH : ORIGIN = 0x08000000, LENGTH = 128K\n-  RAM : ORIGIN = 0x20000000, LENGTH = 20K\n-}\n-\n-SECTIONS\n-{\n-  .text ORIGIN(FLASH) :\n-  {\n-    /* Vector table */\n-    LONG(ORIGIN(RAM) + LENGTH(RAM)); /* initial SP value */\n-    KEEP(*(.reset_handler));\n-\n-    /* Omitted: The rest of the vector table */\n-\n-    *(.text.*);\n-  } > FLASH\n-\n-  /DISCARD/ :\n-  {\n-    /* Unused unwinding stuff */\n-    *(.ARM.exidx.*)\n-  }\n-}\n-```\n-\n-``` text\n-$ xargo rustc --target thumbv7m-none-eabi --release -- \\\n-    -C link-arg=-Tlink.x -C link-arg=-nostartfiles\n-\n-$ arm-none-eabi-objdump -Cd target/thumbv7m-none-eabi/release/app\n-./target/thumbv7m-none-eabi/release/app:     file format elf32-littlearm\n-\n-\n-Disassembly of section .text:\n-\n-08000000 <app::RESET_HANDLER-0x4>:\n- 8000000:       20005000        .word   0x20005000\n-\n-08000004 <app::RESET_HANDLER>:\n- 8000004:       08000009                                ....\n-\n-08000008 <app::reset_handler>:\n- 8000008:       e7fe            b.n     8000008 <app::reset_handler>\n-```"}, {"sha": "5c9e88dc57ca6ea869c72dbca80edf95b7785fce", "filename": "src/libstd/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/7ee72070bdb789f58f272fab50d49bd48dd9c11f/src%2Flibstd%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7ee72070bdb789f58f272fab50d49bd48dd9c11f/src%2Flibstd%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Flib.rs?ref=7ee72070bdb789f58f272fab50d49bd48dd9c11f", "patch": "@@ -307,7 +307,7 @@\n #![feature(doc_cfg)]\n #![feature(doc_masked)]\n #![feature(doc_spotlight)]\n-#![cfg_attr(windows, feature(used))]\n+#![cfg_attr(all(windows, stage0), feature(used))]\n #![feature(doc_alias)]\n #![feature(doc_keyword)]\n #![feature(panic_info_message)]"}, {"sha": "d7ae88ea08ad25ff14540774652adcfec21c8902", "filename": "src/libsyntax/feature_gate.rs", "status": "modified", "additions": 4, "deletions": 7, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/7ee72070bdb789f58f272fab50d49bd48dd9c11f/src%2Flibsyntax%2Ffeature_gate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7ee72070bdb789f58f272fab50d49bd48dd9c11f/src%2Flibsyntax%2Ffeature_gate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Ffeature_gate.rs?ref=7ee72070bdb789f58f272fab50d49bd48dd9c11f", "patch": "@@ -349,9 +349,6 @@ declare_features! (\n     // Allows the `try {...}` expression\n     (active, try_blocks, \"1.29.0\", Some(31436), None),\n \n-    // Used to preserve symbols (see llvm.used)\n-    (active, used, \"1.18.0\", Some(40289), None),\n-\n     // Allows module-level inline assembly by way of global_asm!()\n     (active, global_asm, \"1.18.0\", Some(35119), None),\n \n@@ -677,6 +674,9 @@ declare_features! (\n     // Allows all literals in attribute lists and values of key-value pairs.\n     (accepted, attr_literals, \"1.30.0\", Some(34981), None),\n     (accepted, panic_handler, \"1.30.0\", Some(44489), None),\n+    // Used to preserve symbols (see llvm.used)\n+    (accepted, used, \"1.30.0\", Some(40289), None),\n+\n );\n \n // If you change this, please modify src/doc/unstable-book as well. You must\n@@ -1071,10 +1071,7 @@ pub const BUILTIN_ATTRIBUTES: &'static [(&'static str, AttributeType, AttributeG\n                                   \"unwind_attributes\",\n                                   \"#[unwind] is experimental\",\n                                   cfg_fn!(unwind_attributes))),\n-    (\"used\", Whitelisted, Gated(\n-        Stability::Unstable, \"used\",\n-        \"the `#[used]` attribute is an experimental feature\",\n-        cfg_fn!(used))),\n+    (\"used\", Whitelisted, Ungated),\n \n     // used in resolve\n     (\"prelude_import\", Whitelisted, Gated(Stability::Unstable,"}, {"sha": "6992dd94af3bdda82df6fe9b6d3f86496ffe13d5", "filename": "src/test/run-make-fulldeps/used/used.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7ee72070bdb789f58f272fab50d49bd48dd9c11f/src%2Ftest%2Frun-make-fulldeps%2Fused%2Fused.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7ee72070bdb789f58f272fab50d49bd48dd9c11f/src%2Ftest%2Frun-make-fulldeps%2Fused%2Fused.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fused%2Fused.rs?ref=7ee72070bdb789f58f272fab50d49bd48dd9c11f", "patch": "@@ -9,7 +9,6 @@\n // except according to those terms.\n \n #![crate_type = \"lib\"]\n-#![feature(used)]\n \n #[used]\n static FOO: u32 = 0;"}, {"sha": "711159647b76afa7538d8880acd72d55aed88bdb", "filename": "src/test/ui/feature-gates/feature-gate-linker-flavor.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/7ee72070bdb789f58f272fab50d49bd48dd9c11f/src%2Ftest%2Fui%2Ffeature-gates%2Ffeature-gate-linker-flavor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7ee72070bdb789f58f272fab50d49bd48dd9c11f/src%2Ftest%2Fui%2Ffeature-gates%2Ffeature-gate-linker-flavor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffeature-gates%2Ffeature-gate-linker-flavor.rs?ref=7ee72070bdb789f58f272fab50d49bd48dd9c11f", "patch": "@@ -1,4 +1,4 @@\n-// Copyright 2017 The Rust Project Developers. See the COPYRIGHT\n+// Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n // file at the top-level directory of this distribution and at\n // http://rust-lang.org/COPYRIGHT.\n //\n@@ -15,6 +15,5 @@\n \n #[used]\n fn foo() {}\n-//~^^ ERROR the `#[used]` attribute is an experimental feature\n \n fn main() {}"}, {"sha": "7019a66654832d08629ff6dfd5e9409d58ba790c", "filename": "src/test/ui/feature-gates/feature-gate-linker-flavor.stderr", "status": "modified", "additions": 1, "deletions": 4, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/7ee72070bdb789f58f272fab50d49bd48dd9c11f/src%2Ftest%2Fui%2Ffeature-gates%2Ffeature-gate-linker-flavor.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/7ee72070bdb789f58f272fab50d49bd48dd9c11f/src%2Ftest%2Fui%2Ffeature-gates%2Ffeature-gate-linker-flavor.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffeature-gates%2Ffeature-gate-linker-flavor.stderr?ref=7ee72070bdb789f58f272fab50d49bd48dd9c11f", "patch": "@@ -1,11 +1,8 @@\n-error[E0658]: the `#[used]` attribute is an experimental feature (see issue #40289)\n+error: attribute must be applied to a `static` variable\n   --> $DIR/feature-gate-linker-flavor.rs:16:1\n    |\n LL | #[used]\n    | ^^^^^^^\n-   |\n-   = help: add #![feature(used)] to the crate attributes to enable\n \n error: aborting due to previous error\n \n-For more information about this error, try `rustc --explain E0658`."}, {"sha": "68679d7dac896a22a04f855fdc6ca7aea911cf22", "filename": "src/test/ui/feature-gates/feature-gate-used.rs", "status": "removed", "additions": 0, "deletions": 15, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/1f02f23263ff03d7f590f19d31741c5d6b08b44f/src%2Ftest%2Fui%2Ffeature-gates%2Ffeature-gate-used.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1f02f23263ff03d7f590f19d31741c5d6b08b44f/src%2Ftest%2Fui%2Ffeature-gates%2Ffeature-gate-used.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffeature-gates%2Ffeature-gate-used.rs?ref=1f02f23263ff03d7f590f19d31741c5d6b08b44f", "patch": "@@ -1,15 +0,0 @@\n-// Copyright 2017 The Rust Project Developers. See the COPYRIGHT\n-// file at the top-level directory of this distribution and at\n-// http://rust-lang.org/COPYRIGHT.\n-//\n-// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n-// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n-// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n-// option. This file may not be copied, modified, or distributed\n-// except according to those terms.\n-\n-#[used]\n-fn foo() {}\n-//~^^ ERROR the `#[used]` attribute is an experimental feature\n-\n-fn main() {}"}, {"sha": "d650b5ebb3b1942afaacbcfe260366a780848a1f", "filename": "src/test/ui/feature-gates/feature-gate-used.stderr", "status": "removed", "additions": 0, "deletions": 11, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/1f02f23263ff03d7f590f19d31741c5d6b08b44f/src%2Ftest%2Fui%2Ffeature-gates%2Ffeature-gate-used.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/1f02f23263ff03d7f590f19d31741c5d6b08b44f/src%2Ftest%2Fui%2Ffeature-gates%2Ffeature-gate-used.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffeature-gates%2Ffeature-gate-used.stderr?ref=1f02f23263ff03d7f590f19d31741c5d6b08b44f", "patch": "@@ -1,11 +0,0 @@\n-error[E0658]: the `#[used]` attribute is an experimental feature (see issue #40289)\n-  --> $DIR/feature-gate-used.rs:11:1\n-   |\n-LL | #[used]\n-   | ^^^^^^^\n-   |\n-   = help: add #![feature(used)] to the crate attributes to enable\n-\n-error: aborting due to previous error\n-\n-For more information about this error, try `rustc --explain E0658`."}, {"sha": "f4b9588ff0567b8fdbfd9129a0865c440eb60d3b", "filename": "src/test/ui/run-pass/issues/issue-41628.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7ee72070bdb789f58f272fab50d49bd48dd9c11f/src%2Ftest%2Fui%2Frun-pass%2Fissues%2Fissue-41628.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7ee72070bdb789f58f272fab50d49bd48dd9c11f/src%2Ftest%2Fui%2Frun-pass%2Fissues%2Fissue-41628.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frun-pass%2Fissues%2Fissue-41628.rs?ref=7ee72070bdb789f58f272fab50d49bd48dd9c11f", "patch": "@@ -10,7 +10,6 @@\n \n // run-pass\n #![deny(dead_code)]\n-#![feature(used)]\n \n #[used]\n static FOO: u32 = 0;"}, {"sha": "b3ed8601988d18eec128e447a8aab97c527f7bf7", "filename": "src/test/ui/used.rs", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/7ee72070bdb789f58f272fab50d49bd48dd9c11f/src%2Ftest%2Fui%2Fused.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7ee72070bdb789f58f272fab50d49bd48dd9c11f/src%2Ftest%2Fui%2Fused.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fused.rs?ref=7ee72070bdb789f58f272fab50d49bd48dd9c11f", "patch": "@@ -8,8 +8,6 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n-#![feature(used)]\n-\n #[used]\n static FOO: u32 = 0; // OK\n "}, {"sha": "351fb9404268e2148798981273fe9426d817fcfa", "filename": "src/test/ui/used.stderr", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/7ee72070bdb789f58f272fab50d49bd48dd9c11f/src%2Ftest%2Fui%2Fused.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/7ee72070bdb789f58f272fab50d49bd48dd9c11f/src%2Ftest%2Fui%2Fused.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fused.stderr?ref=7ee72070bdb789f58f272fab50d49bd48dd9c11f", "patch": "@@ -1,23 +1,23 @@\n error: attribute must be applied to a `static` variable\n-  --> $DIR/used.rs:16:1\n+  --> $DIR/used.rs:14:1\n    |\n LL | #[used] //~ ERROR attribute must be applied to a `static` variable\n    | ^^^^^^^\n \n error: attribute must be applied to a `static` variable\n-  --> $DIR/used.rs:19:1\n+  --> $DIR/used.rs:17:1\n    |\n LL | #[used] //~ ERROR attribute must be applied to a `static` variable\n    | ^^^^^^^\n \n error: attribute must be applied to a `static` variable\n-  --> $DIR/used.rs:22:1\n+  --> $DIR/used.rs:20:1\n    |\n LL | #[used] //~ ERROR attribute must be applied to a `static` variable\n    | ^^^^^^^\n \n error: attribute must be applied to a `static` variable\n-  --> $DIR/used.rs:25:1\n+  --> $DIR/used.rs:23:1\n    |\n LL | #[used] //~ ERROR attribute must be applied to a `static` variable\n    | ^^^^^^^"}]}