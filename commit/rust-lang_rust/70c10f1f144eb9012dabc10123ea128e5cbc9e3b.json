{"sha": "70c10f1f144eb9012dabc10123ea128e5cbc9e3b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjcwYzEwZjFmMTQ0ZWI5MDEyZGFiYzEwMTIzZWExMjhlNWNiYzllM2I=", "commit": {"author": {"name": "Oliver Schneider", "email": "git-no-reply-9879165716479413131@oli-obk.de", "date": "2018-03-30T10:31:48Z"}, "committer": {"name": "Oliver Schneider", "email": "git-no-reply-9879165716479413131@oli-obk.de", "date": "2018-03-30T10:31:48Z"}, "message": "Introduce an edge from a const eval to the MIR of all statics it depends on", "tree": {"sha": "a74913e14b49f248129aa13dc35066b27c7f40f4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a74913e14b49f248129aa13dc35066b27c7f40f4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/70c10f1f144eb9012dabc10123ea128e5cbc9e3b", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQJgBAABCgBKFiEEvpMjxK4/cnPNfesJHVy0/Fl8MAQFAlq+EhQsHGdpdC1uby1y\nZXBseS05ODc5MTY1NzE2NDc5NDEzMTMxQG9saS1vYmsuZGUACgkQHVy0/Fl8MATf\nmRAAv1n5aNrUywB3MWIADK7HWQiS4hVucz4a53oJvDLjFcCtcFy9koTHmaxbxpbg\nZBOJpSsyu0DczW6ujfJSY1XoBs9zX47HKuRq4vSbj1QhkA5Pnqs+PyQcHMJqdA1I\nXAZJvixZfF5n7CxyukieLg/XDmzceKslCA7Om4ibMbvcoTIGAq2diYVrfyHJGnn5\nKHpAYTJjjcra62yn0h26gQq1Q86UPep0X7yr/jqeWLA+fC20/6JMcUuBi7mlLOOS\njE41YwuO3sjYzkIfPt3fuVjnypImp8epKJ9C+DsqqzaCOvNvXSW+SMciXl1fMPCW\n95ipC51i1ax9UXUJucgwMxRn0DATDuAdmFwM4HlLrXoEijrbDn1WbtPLcYQvNUfO\na5HprIvCq7BCfqTK5xJezG88cZEosaHZq4GhIbPeuJmOWm1ERlh9MbyFHsleQs5Z\ngOSj2i7e8AQBsoueTxlDfZxcRMX+sNKMGVz1ETDtHcB2RYp2JvaCV4MUBFVTRhd/\nPz3074/f3pEFfXfLGrwOxvQAE5zedcMr3Rd+nzmYOiKr8lxJZDDrgAVPNLjW16zV\ngn+WV5svAfnaxRRzzY/u+ZFxctMxOgZXVZtPaxs4sgHMNwVLZ8TQL/aDnAJSQFJ2\n6VjvmbgkLdD+dg0O7OtrAeksQ4bEr0CTq338PX1zy/iU4DY=\n=/8X8\n-----END PGP SIGNATURE-----", "payload": "tree a74913e14b49f248129aa13dc35066b27c7f40f4\nparent 361509320c882ee76f0d1359f842dec4637e6b08\nauthor Oliver Schneider <git-no-reply-9879165716479413131@oli-obk.de> 1522405908 +0200\ncommitter Oliver Schneider <git-no-reply-9879165716479413131@oli-obk.de> 1522405908 +0200\n\nIntroduce an edge from a const eval to the MIR of all statics it depends on\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/70c10f1f144eb9012dabc10123ea128e5cbc9e3b", "html_url": "https://github.com/rust-lang/rust/commit/70c10f1f144eb9012dabc10123ea128e5cbc9e3b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/70c10f1f144eb9012dabc10123ea128e5cbc9e3b/comments", "author": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "committer": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "361509320c882ee76f0d1359f842dec4637e6b08", "url": "https://api.github.com/repos/rust-lang/rust/commits/361509320c882ee76f0d1359f842dec4637e6b08", "html_url": "https://github.com/rust-lang/rust/commit/361509320c882ee76f0d1359f842dec4637e6b08"}], "stats": {"total": 50, "additions": 49, "deletions": 1}, "files": [{"sha": "4a7e2ba1146ef42dbb03bf218b8cda5e351b04b9", "filename": "src/librustc_mir/interpret/const_eval.rs", "status": "modified", "additions": 29, "deletions": 1, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/70c10f1f144eb9012dabc10123ea128e5cbc9e3b/src%2Flibrustc_mir%2Finterpret%2Fconst_eval.rs", "raw_url": "https://github.com/rust-lang/rust/raw/70c10f1f144eb9012dabc10123ea128e5cbc9e3b/src%2Flibrustc_mir%2Finterpret%2Fconst_eval.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Finterpret%2Fconst_eval.rs?ref=70c10f1f144eb9012dabc10123ea128e5cbc9e3b", "patch": "@@ -5,6 +5,7 @@ use rustc::mir;\n use rustc::ty::{self, TyCtxt, Ty, Instance};\n use rustc::ty::layout::{self, LayoutOf};\n use rustc::ty::subst::Subst;\n+use rustc::util::nodemap::FxHashSet;\n \n use syntax::ast::Mutability;\n use syntax::codemap::Span;\n@@ -504,7 +505,13 @@ pub fn const_eval_provider<'a, 'tcx>(\n     };\n \n     let (res, ecx) = eval_body_and_ecx(tcx, cid, None, key.param_env);\n-    res.map(|(miri_value, _, miri_ty)| {\n+    res.map(|(miri_value, ptr, miri_ty)| {\n+        if tcx.is_static(def_id).is_some() {\n+            if let Ok(ptr) = ptr.primval.to_ptr() {\n+                let mut seen = FxHashSet::default();\n+                create_depgraph_edges(tcx, ptr.alloc_id, &mut seen);\n+            }\n+        }\n         tcx.mk_const(ty::Const {\n             val: ConstVal::Value(miri_value),\n             ty: miri_ty,\n@@ -521,3 +528,24 @@ pub fn const_eval_provider<'a, 'tcx>(\n         }\n     })\n }\n+\n+fn create_depgraph_edges<'a, 'tcx>(\n+    tcx: TyCtxt<'a, 'tcx, 'tcx>,\n+    alloc_id: AllocId,\n+    seen: &mut FxHashSet<AllocId>,\n+) {\n+    trace!(\"create_depgraph_edges: {:?}, {:?}\", alloc_id, seen);\n+    if seen.insert(alloc_id) {\n+        trace!(\"seen: {:?}, {:?}\", alloc_id, seen);\n+        if let Some(alloc) = tcx.interpret_interner.get_alloc(alloc_id) {\n+            trace!(\"get_alloc: {:?}, {:?}, {:?}\", alloc_id, seen, alloc);\n+            for (_, &reloc) in &alloc.relocations {\n+                if let Some(did) = tcx.interpret_interner.get_corresponding_static_def_id(reloc) {\n+                    trace!(\"get_corresponding: {:?}, {:?}, {:?}, {:?}, {:?}\", alloc_id, seen, alloc, did, reloc);\n+                    let _ = tcx.maybe_optimized_mir(did);\n+                }\n+                create_depgraph_edges(tcx, reloc, seen);\n+            }\n+        }\n+    }\n+}\n\\ No newline at end of file"}, {"sha": "558478668951852ccc5067a4e659179101263c7f", "filename": "src/test/incremental/static_refering_to_other_static2/issue.rs", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/70c10f1f144eb9012dabc10123ea128e5cbc9e3b/src%2Ftest%2Fincremental%2Fstatic_refering_to_other_static2%2Fissue.rs", "raw_url": "https://github.com/rust-lang/rust/raw/70c10f1f144eb9012dabc10123ea128e5cbc9e3b/src%2Ftest%2Fincremental%2Fstatic_refering_to_other_static2%2Fissue.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fincremental%2Fstatic_refering_to_other_static2%2Fissue.rs?ref=70c10f1f144eb9012dabc10123ea128e5cbc9e3b", "patch": "@@ -0,0 +1,20 @@\n+// Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// revisions:rpass1 rpass2\n+\n+#[cfg(rpass1)]\n+pub static A: i32 = 42;\n+#[cfg(rpass2)]\n+pub static A: i32 = 43;\n+\n+pub static B: &i32 = &A;\n+\n+fn main() {}"}]}