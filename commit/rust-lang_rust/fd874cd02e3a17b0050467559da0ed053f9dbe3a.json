{"sha": "fd874cd02e3a17b0050467559da0ed053f9dbe3a", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZkODc0Y2QwMmUzYTE3YjAwNTA0Njc1NTlkYTBlZDA1M2Y5ZGJlM2E=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2015-06-21T20:14:45Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2015-06-21T20:14:45Z"}, "message": "Auto merge of #26463 - sfackler:stdout-panic-fix, r=alexcrichton\n\nIf a local stderr is present but the normal stderr is missing, we still\r\nwant to print.\r\n\r\nr? @alexcrichton", "tree": {"sha": "a48bc816b4a8d4e1feb1104905ffc15c28534b04", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a48bc816b4a8d4e1feb1104905ffc15c28534b04"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fd874cd02e3a17b0050467559da0ed053f9dbe3a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fd874cd02e3a17b0050467559da0ed053f9dbe3a", "html_url": "https://github.com/rust-lang/rust/commit/fd874cd02e3a17b0050467559da0ed053f9dbe3a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fd874cd02e3a17b0050467559da0ed053f9dbe3a/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "dedd4302d190f5a232e75e2b808a4b86ae323678", "url": "https://api.github.com/repos/rust-lang/rust/commits/dedd4302d190f5a232e75e2b808a4b86ae323678", "html_url": "https://github.com/rust-lang/rust/commit/dedd4302d190f5a232e75e2b808a4b86ae323678"}, {"sha": "8193133f3548390559936fdaf377f5ef951ffd29", "url": "https://api.github.com/repos/rust-lang/rust/commits/8193133f3548390559936fdaf377f5ef951ffd29", "html_url": "https://github.com/rust-lang/rust/commit/8193133f3548390559936fdaf377f5ef951ffd29"}], "stats": {"total": 23, "additions": 12, "deletions": 11}, "files": [{"sha": "bb4375c1b8826203aa47b35677bacf248c8a500b", "filename": "src/libstd/panicking.rs", "status": "modified", "additions": 12, "deletions": 11, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/fd874cd02e3a17b0050467559da0ed053f9dbe3a/src%2Flibstd%2Fpanicking.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd874cd02e3a17b0050467559da0ed053f9dbe3a/src%2Flibstd%2Fpanicking.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fpanicking.rs?ref=fd874cd02e3a17b0050467559da0ed053f9dbe3a", "patch": "@@ -31,15 +31,12 @@ pub fn on_panic(obj: &(Any+Send), file: &'static str, line: u32) {\n             None => \"Box<Any>\",\n         }\n     };\n-    let mut err = match Stderr::new() {\n-        Ok(err) => err,\n-        _ => return,\n-    };\n+    let mut err = Stderr::new().ok();\n     let thread = thread_info::current_thread();\n     let name = thread.as_ref().and_then(|t| t.name()).unwrap_or(\"<unnamed>\");\n     let prev = LOCAL_STDERR.with(|s| s.borrow_mut().take());\n-    match prev {\n-        Some(mut stderr) => {\n+    match (prev, err.as_mut()) {\n+        (Some(mut stderr), _) => {\n             // FIXME: what to do when the thread printing panics?\n             let _ = writeln!(stderr,\n                              \"thread '{}' panicked at '{}', {}:{}\\n\",\n@@ -52,18 +49,22 @@ pub fn on_panic(obj: &(Any+Send), file: &'static str, line: u32) {\n                 *slot.borrow_mut() = s.take();\n             });\n         }\n-        None => {\n-            let _ = writeln!(&mut err, \"thread '{}' panicked at '{}', {}:{}\",\n+        (None, Some(ref mut err)) => {\n+            let _ = writeln!(err, \"thread '{}' panicked at '{}', {}:{}\",\n                              name, msg, file, line);\n             if backtrace::log_enabled() {\n-                let _ = backtrace::write(&mut err);\n+                let _ = backtrace::write(err);\n             }\n         }\n+        _ => {}\n     }\n \n     // If this is a double panic, make sure that we printed a backtrace\n     // for this panic.\n-    if unwind::panicking() && !backtrace::log_enabled() {\n-        let _ = backtrace::write(&mut err);\n+    match err {\n+        Some(ref mut err) if unwind::panicking() && !backtrace::log_enabled() => {\n+            let _ = backtrace::write(err);\n+        }\n+        _ => {}\n     }\n }"}]}