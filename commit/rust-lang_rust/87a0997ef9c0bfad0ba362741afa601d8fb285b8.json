{"sha": "87a0997ef9c0bfad0ba362741afa601d8fb285b8", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg3YTA5OTdlZjljMGJmYWQwYmEzNjI3NDFhZmE2MDFkOGZiMjg1Yjg=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-11-08T11:27:06Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-11-08T11:27:06Z"}, "message": "Auto merge of #78410 - lcnr:revert75443, r=nikomatsakis\n\nrevert #75443, update mir validator\n\nThis PR reverts rust-lang#75443 to fix rust-lang#75992 and instead uses rust-lang#75419 to fix rust-lang#75313.\n\nAdapts rust-lang#75419 to correctly deal with unevaluated constants as otherwise some `feature(const_evaluatable_checked)` tests would ICE.\n\nNote that rust-lang#72793 was also fixed by rust-lang#75443, but as that issue only concerns `feature(type_alias_impl_trait)` I deleted that test case for now and would reopen that issue.\n\nrust-lang#75443 may have also allowed some other code to now successfully compile which would make this revert a breaking change after 2 stable versions, but I hope that this is a purely theoretical concern.\n\nSee https://rust-lang.zulipchat.com/#narrow/stream/182449-t-compiler.2Fhelp/topic/generator.20upvars/near/214617274 for more reasoning about this.\n\nr? `@nikomatsakis` `@eddyb` `@RalfJung`", "tree": {"sha": "dcde719c8ced8d5cc54b328e6fdb596683992f97", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/dcde719c8ced8d5cc54b328e6fdb596683992f97"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/87a0997ef9c0bfad0ba362741afa601d8fb285b8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/87a0997ef9c0bfad0ba362741afa601d8fb285b8", "html_url": "https://github.com/rust-lang/rust/commit/87a0997ef9c0bfad0ba362741afa601d8fb285b8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/87a0997ef9c0bfad0ba362741afa601d8fb285b8/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f2ea2f648e117013b0217f001088ae89e0f163ca", "url": "https://api.github.com/repos/rust-lang/rust/commits/f2ea2f648e117013b0217f001088ae89e0f163ca", "html_url": "https://github.com/rust-lang/rust/commit/f2ea2f648e117013b0217f001088ae89e0f163ca"}, {"sha": "e06785b676bb639fef071feca302432c61fbddcc", "url": "https://api.github.com/repos/rust-lang/rust/commits/e06785b676bb639fef071feca302432c61fbddcc", "html_url": "https://github.com/rust-lang/rust/commit/e06785b676bb639fef071feca302432c61fbddcc"}], "stats": {"total": 130, "additions": 26, "deletions": 104}, "files": [{"sha": "e1e6e71acb5a8f80b02e3cde4f33a6b3251603d9", "filename": "compiler/rustc_mir/src/transform/validate.rs", "status": "modified", "additions": 24, "deletions": 75, "changes": 99, "blob_url": "https://github.com/rust-lang/rust/blob/87a0997ef9c0bfad0ba362741afa601d8fb285b8/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fvalidate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/87a0997ef9c0bfad0ba362741afa601d8fb285b8/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fvalidate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fvalidate.rs?ref=87a0997ef9c0bfad0ba362741afa601d8fb285b8", "patch": "@@ -6,15 +6,16 @@ use crate::util::storage::AlwaysLiveLocals;\n \n use super::MirPass;\n use rustc_index::bit_set::BitSet;\n+use rustc_infer::infer::TyCtxtInferExt;\n use rustc_middle::mir::interpret::Scalar;\n use rustc_middle::mir::traversal;\n use rustc_middle::mir::visit::{PlaceContext, Visitor};\n use rustc_middle::mir::{\n     AggregateKind, BasicBlock, Body, BorrowKind, Local, Location, MirPhase, Operand, PlaceRef,\n     Rvalue, SourceScope, Statement, StatementKind, Terminator, TerminatorKind, VarDebugInfo,\n };\n-use rustc_middle::ty::relate::{Relate, RelateResult, TypeRelation};\n-use rustc_middle::ty::{self, ParamEnv, Ty, TyCtxt};\n+use rustc_middle::ty::fold::BottomUpFolder;\n+use rustc_middle::ty::{self, ParamEnv, Ty, TyCtxt, TypeFoldable};\n use rustc_target::abi::Size;\n \n #[derive(Copy, Clone, Debug)]\n@@ -77,79 +78,27 @@ pub fn equal_up_to_regions(\n         return true;\n     }\n \n-    struct LifetimeIgnoreRelation<'tcx> {\n-        tcx: TyCtxt<'tcx>,\n-        param_env: ty::ParamEnv<'tcx>,\n-    }\n-\n-    impl TypeRelation<'tcx> for LifetimeIgnoreRelation<'tcx> {\n-        fn tcx(&self) -> TyCtxt<'tcx> {\n-            self.tcx\n-        }\n-\n-        fn param_env(&self) -> ty::ParamEnv<'tcx> {\n-            self.param_env\n-        }\n-\n-        fn tag(&self) -> &'static str {\n-            \"librustc_mir::transform::validate\"\n-        }\n-\n-        fn a_is_expected(&self) -> bool {\n-            true\n-        }\n-\n-        fn relate_with_variance<T: Relate<'tcx>>(\n-            &mut self,\n-            _: ty::Variance,\n-            a: T,\n-            b: T,\n-        ) -> RelateResult<'tcx, T> {\n-            // Ignore variance, require types to be exactly the same.\n-            self.relate(a, b)\n-        }\n-\n-        fn tys(&mut self, a: Ty<'tcx>, b: Ty<'tcx>) -> RelateResult<'tcx, Ty<'tcx>> {\n-            if a == b {\n-                // Short-circuit.\n-                return Ok(a);\n-            }\n-            ty::relate::super_relate_tys(self, a, b)\n-        }\n-\n-        fn regions(\n-            &mut self,\n-            a: ty::Region<'tcx>,\n-            _b: ty::Region<'tcx>,\n-        ) -> RelateResult<'tcx, ty::Region<'tcx>> {\n-            // Ignore regions.\n-            Ok(a)\n-        }\n-\n-        fn consts(\n-            &mut self,\n-            a: &'tcx ty::Const<'tcx>,\n-            b: &'tcx ty::Const<'tcx>,\n-        ) -> RelateResult<'tcx, &'tcx ty::Const<'tcx>> {\n-            ty::relate::super_relate_consts(self, a, b)\n-        }\n-\n-        fn binders<T>(\n-            &mut self,\n-            a: ty::Binder<T>,\n-            b: ty::Binder<T>,\n-        ) -> RelateResult<'tcx, ty::Binder<T>>\n-        where\n-            T: Relate<'tcx>,\n-        {\n-            self.relate(a.skip_binder(), b.skip_binder())?;\n-            Ok(a)\n-        }\n-    }\n-\n-    // Instantiate and run relation.\n-    let mut relator: LifetimeIgnoreRelation<'tcx> = LifetimeIgnoreRelation { tcx: tcx, param_env };\n-    relator.relate(src, dest).is_ok()\n+    // Normalize lifetimes away on both sides, then compare.\n+    let param_env = param_env.with_reveal_all_normalized(tcx);\n+    let normalize = |ty: Ty<'tcx>| {\n+        tcx.normalize_erasing_regions(\n+            param_env,\n+            ty.fold_with(&mut BottomUpFolder {\n+                tcx,\n+                // FIXME: We erase all late-bound lifetimes, but this is not fully correct.\n+                // If you have a type like `<for<'a> fn(&'a u32) as SomeTrait>::Assoc`,\n+                // this is not necessarily equivalent to `<fn(&'static u32) as SomeTrait>::Assoc`,\n+                // since one may have an `impl SomeTrait for fn(&32)` and\n+                // `impl SomeTrait for fn(&'static u32)` at the same time which\n+                // specify distinct values for Assoc. (See also #56105)\n+                lt_op: |_| tcx.lifetimes.re_erased,\n+                // Leave consts and types unchanged.\n+                ct_op: |ct| ct,\n+                ty_op: |ty| ty,\n+            }),\n+        )\n+    };\n+    tcx.infer_ctxt().enter(|infcx| infcx.can_eq(param_env, normalize(src), normalize(dest)).is_ok())\n }\n \n struct TypeChecker<'a, 'tcx> {"}, {"sha": "a85ffd3c961b7e5d872c2a87ec3e2b192eb267c9", "filename": "compiler/rustc_trait_selection/src/traits/project.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/87a0997ef9c0bfad0ba362741afa601d8fb285b8/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fproject.rs", "raw_url": "https://github.com/rust-lang/rust/raw/87a0997ef9c0bfad0ba362741afa601d8fb285b8/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fproject.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fproject.rs?ref=87a0997ef9c0bfad0ba362741afa601d8fb285b8", "patch": "@@ -338,7 +338,7 @@ impl<'a, 'b, 'tcx> TypeFolder<'tcx> for AssocTypeNormalizer<'a, 'b, 'tcx> {\n \n         let ty = ty.super_fold_with(self);\n         match *ty.kind() {\n-            ty::Opaque(def_id, substs) => {\n+            ty::Opaque(def_id, substs) if !substs.has_escaping_bound_vars() => {\n                 // Only normalize `impl Trait` after type-checking, usually in codegen.\n                 match self.param_env.reveal() {\n                     Reveal::UserFacing => ty,"}, {"sha": "42a598ce3a00845a002ef27b0bca1d2c8d3ffd5a", "filename": "compiler/rustc_trait_selection/src/traits/query/normalize.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/87a0997ef9c0bfad0ba362741afa601d8fb285b8/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Fnormalize.rs", "raw_url": "https://github.com/rust-lang/rust/raw/87a0997ef9c0bfad0ba362741afa601d8fb285b8/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Fnormalize.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fquery%2Fnormalize.rs?ref=87a0997ef9c0bfad0ba362741afa601d8fb285b8", "patch": "@@ -108,7 +108,7 @@ impl<'cx, 'tcx> TypeFolder<'tcx> for QueryNormalizer<'cx, 'tcx> {\n \n         let ty = ty.super_fold_with(self);\n         let res = (|| match *ty.kind() {\n-            ty::Opaque(def_id, substs) => {\n+            ty::Opaque(def_id, substs) if !substs.has_escaping_bound_vars() => {\n                 // Only normalize `impl Trait` after type-checking, usually in codegen.\n                 match self.param_env.reveal() {\n                     Reveal::UserFacing => ty,"}, {"sha": "e643a8cab5b027c19e20b131063706f55945a60a", "filename": "src/test/ui/type-alias-impl-trait/issue-72793.rs", "status": "removed", "additions": 0, "deletions": 27, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/f2ea2f648e117013b0217f001088ae89e0f163ca/src%2Ftest%2Fui%2Ftype-alias-impl-trait%2Fissue-72793.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f2ea2f648e117013b0217f001088ae89e0f163ca/src%2Ftest%2Fui%2Ftype-alias-impl-trait%2Fissue-72793.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftype-alias-impl-trait%2Fissue-72793.rs?ref=f2ea2f648e117013b0217f001088ae89e0f163ca", "patch": "@@ -1,27 +0,0 @@\n-// build-pass\n-\n-// Regression test for #72793.\n-// FIXME: This still shows ICE with `-Zmir-opt-level=2`.\n-\n-#![feature(type_alias_impl_trait)]\n-\n-trait T { type Item; }\n-\n-type Alias<'a> = impl T<Item = &'a ()>;\n-\n-struct S;\n-impl<'a> T for &'a S {\n-    type Item = &'a ();\n-}\n-\n-fn filter_positive<'a>() -> Alias<'a> {\n-    &S\n-}\n-\n-fn with_positive(fun: impl Fn(Alias<'_>)) {\n-    fun(filter_positive());\n-}\n-\n-fn main() {\n-    with_positive(|_| ());\n-}"}]}