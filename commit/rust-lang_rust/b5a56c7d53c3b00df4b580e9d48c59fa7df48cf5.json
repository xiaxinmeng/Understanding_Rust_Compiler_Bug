{"sha": "b5a56c7d53c3b00df4b580e9d48c59fa7df48cf5", "node_id": "C_kwDOAAsO6NoAKGI1YTU2YzdkNTNjM2IwMGRmNGI1ODBlOWQ0OGM1OWZhN2RmNDhjZjU", "commit": {"author": {"name": "Jonas Schievink", "email": "jonas.schievink@ferrous-systems.com", "date": "2022-04-22T15:30:18Z"}, "committer": {"name": "Jonas Schievink", "email": "jonas.schievink@ferrous-systems.com", "date": "2022-04-22T15:35:03Z"}, "message": "Spawn a new thread with a larger stack for the server", "tree": {"sha": "f644dfb133969ca54c0edfe3cf2233d1c9b28ad8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f644dfb133969ca54c0edfe3cf2233d1c9b28ad8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b5a56c7d53c3b00df4b580e9d48c59fa7df48cf5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b5a56c7d53c3b00df4b580e9d48c59fa7df48cf5", "html_url": "https://github.com/rust-lang/rust/commit/b5a56c7d53c3b00df4b580e9d48c59fa7df48cf5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b5a56c7d53c3b00df4b580e9d48c59fa7df48cf5/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b6b5214c666b64cf9125bebc39d6a8ad08262870", "url": "https://api.github.com/repos/rust-lang/rust/commits/b6b5214c666b64cf9125bebc39d6a8ad08262870", "html_url": "https://github.com/rust-lang/rust/commit/b6b5214c666b64cf9125bebc39d6a8ad08262870"}], "stats": {"total": 25, "additions": 23, "deletions": 2}, "files": [{"sha": "df61ba8eec8466c8365b02c9157862836a1cfe40", "filename": "crates/rust-analyzer/src/bin/main.rs", "status": "modified", "additions": 23, "deletions": 2, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/b5a56c7d53c3b00df4b580e9d48c59fa7df48cf5/crates%2Frust-analyzer%2Fsrc%2Fbin%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b5a56c7d53c3b00df4b580e9d48c59fa7df48cf5/crates%2Frust-analyzer%2Fsrc%2Fbin%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fbin%2Fmain.rs?ref=b5a56c7d53c3b00df4b580e9d48c59fa7df48cf5", "patch": "@@ -77,9 +77,13 @@ fn try_main() -> Result<()> {\n                 println!(\"{}\", flags::RustAnalyzer::HELP);\n                 return Ok(());\n             }\n-            run_server()?\n+            with_extra_thread(\"rust-analyzer server thread\", run_server)?;\n+        }\n+        flags::RustAnalyzerCmd::ProcMacro(flags::ProcMacro) => {\n+            with_extra_thread(\"rust-analyzer proc-macro expander\", || {\n+                proc_macro_srv::cli::run().map_err(Into::into)\n+            })?;\n         }\n-        flags::RustAnalyzerCmd::ProcMacro(flags::ProcMacro) => proc_macro_srv::cli::run()?,\n         flags::RustAnalyzerCmd::Parse(cmd) => cmd.run()?,\n         flags::RustAnalyzerCmd::Symbols(cmd) => cmd.run()?,\n         flags::RustAnalyzerCmd::Highlight(cmd) => cmd.run()?,\n@@ -128,6 +132,23 @@ fn setup_logging(log_file: Option<&Path>) -> Result<()> {\n     Ok(())\n }\n \n+const STACK_SIZE: usize = 1024 * 1024 * 8;\n+\n+/// Parts of rust-analyzer can use a lot of stack space, and some operating systems only give us\n+/// 1 MB by default (eg. Windows), so this spawns a new thread with hopefully sufficient stack\n+/// space.\n+fn with_extra_thread(\n+    thread_name: impl Into<String>,\n+    f: impl FnOnce() -> Result<()> + Send + 'static,\n+) -> Result<()> {\n+    let handle =\n+        std::thread::Builder::new().name(thread_name.into()).stack_size(STACK_SIZE).spawn(f)?;\n+    match handle.join() {\n+        Ok(res) => res,\n+        Err(panic) => std::panic::resume_unwind(panic),\n+    }\n+}\n+\n fn run_server() -> Result<()> {\n     tracing::info!(\"server version {} will start\", env!(\"REV\"));\n "}]}