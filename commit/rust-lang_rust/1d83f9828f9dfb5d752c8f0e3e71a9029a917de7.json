{"sha": "1d83f9828f9dfb5d752c8f0e3e71a9029a917de7", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFkODNmOTgyOGY5ZGZiNWQ3NTJjOGYwZTNlNzFhOTAyOWE5MTdkZTc=", "commit": {"author": {"name": "Yuki Okushi", "email": "huyuumi.dev@gmail.com", "date": "2021-01-11T22:58:59Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-01-11T22:58:59Z"}, "message": "Rollup merge of #79997 - coolreader18:wasm-reactor, r=alexcrichton\n\nEmit a reactor for cdylib target on wasi\n\nFixes #79199, and relevant to #73432\n\nImplements wasi reactors, as described in WebAssembly/WASI#13 and [`design/application-abi.md`](https://github.com/WebAssembly/WASI/blob/master/design/application-abi.md)\n\nEmpty `lib.rs`, `lib.crate-type = [\"cdylib\"]`:\n\n```shell\n$ cargo +reactor build --release --target wasm32-wasi\n   Compiling wasm-reactor v0.1.0 (/home/coolreader18/wasm-reactor)\n    Finished release [optimized] target(s) in 0.08s\n$ wasm-dis target/wasm32-wasi/release/wasm_reactor.wasm >reactor.wat\n```\n`reactor.wat`:\n```wat\n(module\n (type $none_=>_none (func))\n (type $i32_=>_none (func (param i32)))\n (type $i32_i32_=>_i32 (func (param i32 i32) (result i32)))\n (type $i32_=>_i32 (func (param i32) (result i32)))\n (type $i32_i32_i32_=>_i32 (func (param i32 i32 i32) (result i32)))\n (import \"wasi_snapshot_preview1\" \"fd_prestat_get\" (func $__wasi_fd_prestat_get (param i32 i32) (result i32)))\n (import \"wasi_snapshot_preview1\" \"fd_prestat_dir_name\" (func $__wasi_fd_prestat_dir_name (param i32 i32 i32) (result i32)))\n (import \"wasi_snapshot_preview1\" \"proc_exit\" (func $__wasi_proc_exit (param i32)))\n (import \"wasi_snapshot_preview1\" \"environ_sizes_get\" (func $__wasi_environ_sizes_get (param i32 i32) (result i32)))\n (import \"wasi_snapshot_preview1\" \"environ_get\" (func $__wasi_environ_get (param i32 i32) (result i32)))\n (memory $0 17)\n (table $0 1 1 funcref)\n (global $global$0 (mut i32) (i32.const 1048576))\n (global $global$1 i32 (i32.const 1049096))\n (global $global$2 i32 (i32.const 1049096))\n (export \"memory\" (memory $0))\n (export \"_initialize\" (func $_initialize))\n (export \"__data_end\" (global $global$1))\n (export \"__heap_base\" (global $global$2))\n (func $__wasm_call_ctors\n  (call $__wasilibc_initialize_environ_eagerly)\n  (call $__wasilibc_populate_preopens)\n )\n (func $_initialize\n  (call $__wasm_call_ctors)\n )\n (func $malloc (param $0 i32) (result i32)\n  (call $dlmalloc\n   (local.get $0)\n  )\n )\n ;; lots of dlmalloc, memset/memcpy, & libpreopen code\n)\n```\n\nI went with repurposing cdylib because I figured that it doesn't make much sense to have a wasi shared library that can't be initialized, and even if someone was using it adding an `_initialize` export is a very small change.", "tree": {"sha": "fe001e6737d3153db982a4e298faeddf99c74676", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fe001e6737d3153db982a4e298faeddf99c74676"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1d83f9828f9dfb5d752c8f0e3e71a9029a917de7", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJf/Ng0CRBK7hj4Ov3rIwAAdHIIABCHlfR+/swCAKVgGJOAAIYO\nA7pVAm6zvK27NBC88hym0Lv892wU3+LmsGsFR983ER0QCQns4/HKIDbhWaWcmMqe\nPTvvEvRZ+dRNJI9bbpOP5sX87jUPtZVBsdAZA+sHfYKA6Jvg/PytfDtl++lUpdvN\n050YJ+HdYMx6vvKce2kiyyHCtMQnOAo0q6HDXIz+ecqSaZm3NhGZ48IAyXjQBCFI\nVpt1FxlPgBo/7/SfbMzR/Gqqx+Htu3YeM68EIjTOKnIDsxtGW1eyExFsW8u3zGb2\np900iIqSU75YfTemgBfki8zQZ8EBVPqkdefxFjz1MBfZrwIp/DPzVVUgDqLN62E=\n=iI66\n-----END PGP SIGNATURE-----\n", "payload": "tree fe001e6737d3153db982a4e298faeddf99c74676\nparent c5eae562935922f712edec56a45591bc2f8ded1c\nparent 92d3537abb36a1c8c269fc96b9a962be40745a99\nauthor Yuki Okushi <huyuumi.dev@gmail.com> 1610405939 +0900\ncommitter GitHub <noreply@github.com> 1610405939 +0900\n\nRollup merge of #79997 - coolreader18:wasm-reactor, r=alexcrichton\n\nEmit a reactor for cdylib target on wasi\n\nFixes #79199, and relevant to #73432\n\nImplements wasi reactors, as described in WebAssembly/WASI#13 and [`design/application-abi.md`](https://github.com/WebAssembly/WASI/blob/master/design/application-abi.md)\n\nEmpty `lib.rs`, `lib.crate-type = [\"cdylib\"]`:\n\n```shell\n$ cargo +reactor build --release --target wasm32-wasi\n   Compiling wasm-reactor v0.1.0 (/home/coolreader18/wasm-reactor)\n    Finished release [optimized] target(s) in 0.08s\n$ wasm-dis target/wasm32-wasi/release/wasm_reactor.wasm >reactor.wat\n```\n`reactor.wat`:\n```wat\n(module\n (type $none_=>_none (func))\n (type $i32_=>_none (func (param i32)))\n (type $i32_i32_=>_i32 (func (param i32 i32) (result i32)))\n (type $i32_=>_i32 (func (param i32) (result i32)))\n (type $i32_i32_i32_=>_i32 (func (param i32 i32 i32) (result i32)))\n (import \"wasi_snapshot_preview1\" \"fd_prestat_get\" (func $__wasi_fd_prestat_get (param i32 i32) (result i32)))\n (import \"wasi_snapshot_preview1\" \"fd_prestat_dir_name\" (func $__wasi_fd_prestat_dir_name (param i32 i32 i32) (result i32)))\n (import \"wasi_snapshot_preview1\" \"proc_exit\" (func $__wasi_proc_exit (param i32)))\n (import \"wasi_snapshot_preview1\" \"environ_sizes_get\" (func $__wasi_environ_sizes_get (param i32 i32) (result i32)))\n (import \"wasi_snapshot_preview1\" \"environ_get\" (func $__wasi_environ_get (param i32 i32) (result i32)))\n (memory $0 17)\n (table $0 1 1 funcref)\n (global $global$0 (mut i32) (i32.const 1048576))\n (global $global$1 i32 (i32.const 1049096))\n (global $global$2 i32 (i32.const 1049096))\n (export \"memory\" (memory $0))\n (export \"_initialize\" (func $_initialize))\n (export \"__data_end\" (global $global$1))\n (export \"__heap_base\" (global $global$2))\n (func $__wasm_call_ctors\n  (call $__wasilibc_initialize_environ_eagerly)\n  (call $__wasilibc_populate_preopens)\n )\n (func $_initialize\n  (call $__wasm_call_ctors)\n )\n (func $malloc (param $0 i32) (result i32)\n  (call $dlmalloc\n   (local.get $0)\n  )\n )\n ;; lots of dlmalloc, memset/memcpy, & libpreopen code\n)\n```\n\nI went with repurposing cdylib because I figured that it doesn't make much sense to have a wasi shared library that can't be initialized, and even if someone was using it adding an `_initialize` export is a very small change.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1d83f9828f9dfb5d752c8f0e3e71a9029a917de7", "html_url": "https://github.com/rust-lang/rust/commit/1d83f9828f9dfb5d752c8f0e3e71a9029a917de7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1d83f9828f9dfb5d752c8f0e3e71a9029a917de7/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c5eae562935922f712edec56a45591bc2f8ded1c", "url": "https://api.github.com/repos/rust-lang/rust/commits/c5eae562935922f712edec56a45591bc2f8ded1c", "html_url": "https://github.com/rust-lang/rust/commit/c5eae562935922f712edec56a45591bc2f8ded1c"}, {"sha": "92d3537abb36a1c8c269fc96b9a962be40745a99", "url": "https://api.github.com/repos/rust-lang/rust/commits/92d3537abb36a1c8c269fc96b9a962be40745a99", "html_url": "https://github.com/rust-lang/rust/commit/92d3537abb36a1c8c269fc96b9a962be40745a99"}], "stats": {"total": 89, "additions": 69, "deletions": 20}, "files": [{"sha": "728795cf50b8597ddc716cedf03a7b62b0448929", "filename": "compiler/rustc_codegen_ssa/src/back/link.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/1d83f9828f9dfb5d752c8f0e3e71a9029a917de7/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d83f9828f9dfb5d752c8f0e3e71a9029a917de7/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs?ref=1d83f9828f9dfb5d752c8f0e3e71a9029a917de7", "patch": "@@ -1276,6 +1276,7 @@ fn exec_linker(\n \n fn link_output_kind(sess: &Session, crate_type: CrateType) -> LinkOutputKind {\n     let kind = match (crate_type, sess.crt_static(Some(crate_type)), sess.relocation_model()) {\n+        (CrateType::Executable, _, _) if sess.is_wasi_reactor() => LinkOutputKind::WasiReactorExe,\n         (CrateType::Executable, false, RelocModel::Pic) => LinkOutputKind::DynamicPicExe,\n         (CrateType::Executable, false, _) => LinkOutputKind::DynamicNoPicExe,\n         (CrateType::Executable, true, RelocModel::Pic) => LinkOutputKind::StaticPicExe,"}, {"sha": "bb35e7ec8943955f45f67c955f9989ea735e1083", "filename": "compiler/rustc_codegen_ssa/src/back/linker.rs", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/1d83f9828f9dfb5d752c8f0e3e71a9029a917de7/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flinker.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d83f9828f9dfb5d752c8f0e3e71a9029a917de7/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flinker.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flinker.rs?ref=1d83f9828f9dfb5d752c8f0e3e71a9029a917de7", "patch": "@@ -314,6 +314,10 @@ impl<'a> Linker for GccLinker<'a> {\n                 self.cmd.arg(\"-static\");\n                 self.build_dylib(out_filename);\n             }\n+            LinkOutputKind::WasiReactorExe => {\n+                self.linker_arg(\"--entry\");\n+                self.linker_arg(\"_initialize\");\n+            }\n         }\n         // VxWorks compiler driver introduced `--static-crt` flag specifically for rustc,\n         // it switches linking for libc and similar system libraries to static without using\n@@ -662,6 +666,9 @@ impl<'a> Linker for MsvcLinker<'a> {\n                 arg.push(out_filename.with_extension(\"dll.lib\"));\n                 self.cmd.arg(arg);\n             }\n+            LinkOutputKind::WasiReactorExe => {\n+                panic!(\"can't link as reactor on non-wasi target\");\n+            }\n         }\n     }\n \n@@ -1085,6 +1092,10 @@ impl<'a> Linker for WasmLd<'a> {\n             LinkOutputKind::DynamicDylib | LinkOutputKind::StaticDylib => {\n                 self.cmd.arg(\"--no-entry\");\n             }\n+            LinkOutputKind::WasiReactorExe => {\n+                self.cmd.arg(\"--entry\");\n+                self.cmd.arg(\"_initialize\");\n+            }\n         }\n     }\n "}, {"sha": "55d521a9b5ff50434ca5a6b31f196c449c354210", "filename": "compiler/rustc_interface/src/tests.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/1d83f9828f9dfb5d752c8f0e3e71a9029a917de7/compiler%2Frustc_interface%2Fsrc%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d83f9828f9dfb5d752c8f0e3e71a9029a917de7/compiler%2Frustc_interface%2Fsrc%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_interface%2Fsrc%2Ftests.rs?ref=1d83f9828f9dfb5d752c8f0e3e71a9029a917de7", "patch": "@@ -7,7 +7,7 @@ use rustc_session::config::{build_configuration, build_session_options, to_crate\n use rustc_session::config::{rustc_optgroups, ErrorOutputType, ExternLocation, Options, Passes};\n use rustc_session::config::{CFGuard, ExternEntry, LinkerPluginLto, LtoCli, SwitchWithOptPath};\n use rustc_session::config::{\n-    Externs, OutputType, OutputTypes, SanitizerSet, SymbolManglingVersion,\n+    Externs, OutputType, OutputTypes, SanitizerSet, SymbolManglingVersion, WasiExecModel,\n };\n use rustc_session::lint::Level;\n use rustc_session::search_paths::SearchPath;\n@@ -597,6 +597,7 @@ fn test_debugging_options_tracking_hash() {\n     tracked!(unleash_the_miri_inside_of_you, true);\n     tracked!(use_ctors_section, Some(true));\n     tracked!(verify_llvm_ir, true);\n+    tracked!(wasi_exec_model, Some(WasiExecModel::Reactor));\n }\n \n #[test]"}, {"sha": "0cafdec1495bb4e309322dc65080c56ce98ded5c", "filename": "compiler/rustc_session/src/config.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1d83f9828f9dfb5d752c8f0e3e71a9029a917de7/compiler%2Frustc_session%2Fsrc%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d83f9828f9dfb5d752c8f0e3e71a9029a917de7/compiler%2Frustc_session%2Fsrc%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Fconfig.rs?ref=1d83f9828f9dfb5d752c8f0e3e71a9029a917de7", "patch": "@@ -2172,6 +2172,7 @@ crate mod dep_tracking {\n         SymbolManglingVersion, TrimmedDefPaths,\n     };\n     use crate::lint;\n+    use crate::options::WasiExecModel;\n     use crate::utils::NativeLibKind;\n     use rustc_feature::UnstableFeatures;\n     use rustc_span::edition::Edition;\n@@ -2227,6 +2228,7 @@ crate mod dep_tracking {\n     impl_dep_tracking_hash_via_hash!(Option<RelocModel>);\n     impl_dep_tracking_hash_via_hash!(Option<CodeModel>);\n     impl_dep_tracking_hash_via_hash!(Option<TlsModel>);\n+    impl_dep_tracking_hash_via_hash!(Option<WasiExecModel>);\n     impl_dep_tracking_hash_via_hash!(Option<PanicStrategy>);\n     impl_dep_tracking_hash_via_hash!(Option<RelroLevel>);\n     impl_dep_tracking_hash_via_hash!(Option<lint::Level>);"}, {"sha": "30af65e49a075fd73e8cc929b1433620a863e399", "filename": "compiler/rustc_session/src/options.rs", "status": "modified", "additions": 19, "deletions": 1, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/1d83f9828f9dfb5d752c8f0e3e71a9029a917de7/compiler%2Frustc_session%2Fsrc%2Foptions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d83f9828f9dfb5d752c8f0e3e71a9029a917de7/compiler%2Frustc_session%2Fsrc%2Foptions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Foptions.rs?ref=1d83f9828f9dfb5d752c8f0e3e71a9029a917de7", "patch": "@@ -279,6 +279,7 @@ macro_rules! options {\n         pub const parse_tls_model: &str =\n             \"one of supported TLS models (`rustc --print tls-models`)\";\n         pub const parse_target_feature: &str = parse_string;\n+        pub const parse_wasi_exec_model: &str = \"either `command` or `reactor`\";\n     }\n \n     #[allow(dead_code)]\n@@ -722,6 +723,15 @@ macro_rules! options {\n                 None => false,\n             }\n         }\n+\n+        fn parse_wasi_exec_model(slot: &mut Option<WasiExecModel>, v: Option<&str>) -> bool {\n+            match v {\n+                Some(\"command\")  => *slot = Some(WasiExecModel::Command),\n+                Some(\"reactor\") => *slot = Some(WasiExecModel::Reactor),\n+                _ => return false,\n+            }\n+            true\n+        }\n     }\n ) }\n \n@@ -1166,9 +1176,17 @@ options! {DebuggingOptions, DebuggingSetter, basic_debugging_options,\n         \"in general, enable more debug printouts (default: no)\"),\n     verify_llvm_ir: bool = (false, parse_bool, [TRACKED],\n         \"verify LLVM IR (default: no)\"),\n+    wasi_exec_model: Option<WasiExecModel> = (None, parse_wasi_exec_model, [TRACKED],\n+        \"whether to build a wasi command or reactor\"),\n \n     // This list is in alphabetical order.\n     //\n     // If you add a new option, please update:\n-    // - src/librustc_interface/tests.rs\n+    // - compiler/rustc_interface/src/tests.rs\n+}\n+\n+#[derive(Clone, Hash)]\n+pub enum WasiExecModel {\n+    Command,\n+    Reactor,\n }"}, {"sha": "1f9a1af0f687224ccf85e83a80494358e3e53de9", "filename": "compiler/rustc_session/src/session.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/1d83f9828f9dfb5d752c8f0e3e71a9029a917de7/compiler%2Frustc_session%2Fsrc%2Fsession.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d83f9828f9dfb5d752c8f0e3e71a9029a917de7/compiler%2Frustc_session%2Fsrc%2Fsession.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Fsession.rs?ref=1d83f9828f9dfb5d752c8f0e3e71a9029a917de7", "patch": "@@ -796,6 +796,14 @@ impl Session {\n         self.opts.debugging_opts.tls_model.unwrap_or(self.target.tls_model)\n     }\n \n+    pub fn is_wasi_reactor(&self) -> bool {\n+        self.target.options.os == \"wasi\"\n+            && matches!(\n+                self.opts.debugging_opts.wasi_exec_model,\n+                Some(config::WasiExecModel::Reactor)\n+            )\n+    }\n+\n     pub fn must_not_eliminate_frame_pointers(&self) -> bool {\n         // \"mcount\" function relies on stack pointer.\n         // See <https://sourceware.org/binutils/docs/gprof/Implementation.html>."}, {"sha": "32da16a2d8ca83381034d3e0d3ebdd2025a97721", "filename": "compiler/rustc_target/src/spec/crt_objects.rs", "status": "modified", "additions": 11, "deletions": 9, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/1d83f9828f9dfb5d752c8f0e3e71a9029a917de7/compiler%2Frustc_target%2Fsrc%2Fspec%2Fcrt_objects.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d83f9828f9dfb5d752c8f0e3e71a9029a917de7/compiler%2Frustc_target%2Fsrc%2Fspec%2Fcrt_objects.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Fcrt_objects.rs?ref=1d83f9828f9dfb5d752c8f0e3e71a9029a917de7", "patch": "@@ -5,15 +5,16 @@\n //! The `crtx` ones are generally distributed with libc and the `begin/end` ones with gcc.\n //! See <https://dev.gentoo.org/~vapier/crt.txt> for some more details.\n //!\n-//! | Pre-link CRT objects | glibc                  | musl                   | bionic           | mingw             | wasi |\n-//! |----------------------|------------------------|------------------------|------------------|-------------------|------|\n-//! | dynamic-nopic-exe    | crt1, crti, crtbegin   | crt1, crti, crtbegin   | crtbegin_dynamic | crt2, crtbegin    | crt1 |\n-//! | dynamic-pic-exe      | Scrt1, crti, crtbeginS | Scrt1, crti, crtbeginS | crtbegin_dynamic | crt2, crtbegin    | crt1 |\n-//! | static-nopic-exe     | crt1, crti, crtbeginT  | crt1, crti, crtbegin   | crtbegin_static  | crt2, crtbegin    | crt1 |\n-//! | static-pic-exe       | rcrt1, crti, crtbeginS | rcrt1, crti, crtbeginS | crtbegin_dynamic | crt2, crtbegin    | crt1 |\n-//! | dynamic-dylib        | crti, crtbeginS        | crti, crtbeginS        | crtbegin_so      | dllcrt2, crtbegin | -    |\n-//! | static-dylib (gcc)   | crti, crtbeginT        | crti, crtbeginS        | crtbegin_so      | dllcrt2, crtbegin | -    |\n-//! | static-dylib (clang) | crti, crtbeginT        | N/A                    | crtbegin_static  | dllcrt2, crtbegin | -    |\n+//! | Pre-link CRT objects | glibc                  | musl                   | bionic           | mingw             | wasi         |\n+//! |----------------------|------------------------|------------------------|------------------|-------------------|--------------|\n+//! | dynamic-nopic-exe    | crt1, crti, crtbegin   | crt1, crti, crtbegin   | crtbegin_dynamic | crt2, crtbegin    | crt1         |\n+//! | dynamic-pic-exe      | Scrt1, crti, crtbeginS | Scrt1, crti, crtbeginS | crtbegin_dynamic | crt2, crtbegin    | crt1         |\n+//! | static-nopic-exe     | crt1, crti, crtbeginT  | crt1, crti, crtbegin   | crtbegin_static  | crt2, crtbegin    | crt1         |\n+//! | static-pic-exe       | rcrt1, crti, crtbeginS | rcrt1, crti, crtbeginS | crtbegin_dynamic | crt2, crtbegin    | crt1         |\n+//! | dynamic-dylib        | crti, crtbeginS        | crti, crtbeginS        | crtbegin_so      | dllcrt2, crtbegin | -            |\n+//! | static-dylib (gcc)   | crti, crtbeginT        | crti, crtbeginS        | crtbegin_so      | dllcrt2, crtbegin | -            |\n+//! | static-dylib (clang) | crti, crtbeginT        | N/A                    | crtbegin_static  | dllcrt2, crtbegin | -            |\n+//! | wasi-reactor-exe     | N/A                    | N/A                    | N/A              | N/A               | crt1-reactor |\n //!\n //! | Post-link CRT objects | glibc         | musl          | bionic         | mingw  | wasi |\n //! |-----------------------|---------------|---------------|----------------|--------|------|\n@@ -105,6 +106,7 @@ pub(super) fn pre_wasi_fallback() -> CrtObjects {\n         (LinkOutputKind::DynamicPicExe, &[\"crt1.o\"]),\n         (LinkOutputKind::StaticNoPicExe, &[\"crt1.o\"]),\n         (LinkOutputKind::StaticPicExe, &[\"crt1.o\"]),\n+        (LinkOutputKind::WasiReactorExe, &[\"crt1-reactor.o\"]),\n     ])\n }\n "}, {"sha": "d283c2548864f995b0841bc31fed75f2c0c0e7af", "filename": "compiler/rustc_target/src/spec/mod.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/1d83f9828f9dfb5d752c8f0e3e71a9029a917de7/compiler%2Frustc_target%2Fsrc%2Fspec%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d83f9828f9dfb5d752c8f0e3e71a9029a917de7/compiler%2Frustc_target%2Fsrc%2Fspec%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Fmod.rs?ref=1d83f9828f9dfb5d752c8f0e3e71a9029a917de7", "patch": "@@ -408,6 +408,8 @@ pub enum LinkOutputKind {\n     DynamicDylib,\n     /// Dynamic library with bundled libc (\"statically linked\").\n     StaticDylib,\n+    /// WASI module with a lifetime past the _initialize entry point\n+    WasiReactorExe,\n }\n \n impl LinkOutputKind {\n@@ -419,6 +421,7 @@ impl LinkOutputKind {\n             LinkOutputKind::StaticPicExe => \"static-pic-exe\",\n             LinkOutputKind::DynamicDylib => \"dynamic-dylib\",\n             LinkOutputKind::StaticDylib => \"static-dylib\",\n+            LinkOutputKind::WasiReactorExe => \"wasi-reactor-exe\",\n         }\n     }\n \n@@ -430,6 +433,7 @@ impl LinkOutputKind {\n             \"static-pic-exe\" => LinkOutputKind::StaticPicExe,\n             \"dynamic-dylib\" => LinkOutputKind::DynamicDylib,\n             \"static-dylib\" => LinkOutputKind::StaticDylib,\n+            \"wasi-reactor-exe\" => LinkOutputKind::WasiReactorExe,\n             _ => return None,\n         })\n     }\n@@ -1378,7 +1382,7 @@ impl Target {\n                         let kind = LinkOutputKind::from_str(&k).ok_or_else(|| {\n                             format!(\"{}: '{}' is not a valid value for CRT object kind. \\\n                                      Use '(dynamic,static)-(nopic,pic)-exe' or \\\n-                                     '(dynamic,static)-dylib'\", name, k)\n+                                     '(dynamic,static)-dylib' or 'wasi-reactor-exe'\", name, k)\n                         })?;\n \n                         let v = v.as_array().ok_or_else(||"}, {"sha": "39700c087a20d55ed333abd80cff85729e24fea9", "filename": "src/bootstrap/compile.rs", "status": "modified", "additions": 10, "deletions": 8, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/1d83f9828f9dfb5d752c8f0e3e71a9029a917de7/src%2Fbootstrap%2Fcompile.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d83f9828f9dfb5d752c8f0e3e71a9029a917de7/src%2Fbootstrap%2Fcompile.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcompile.rs?ref=1d83f9828f9dfb5d752c8f0e3e71a9029a917de7", "patch": "@@ -188,14 +188,16 @@ fn copy_self_contained_objects(\n         }\n     } else if target.ends_with(\"-wasi\") {\n         let srcdir = builder.wasi_root(target).unwrap().join(\"lib/wasm32-wasi\");\n-        copy_and_stamp(\n-            builder,\n-            &libdir_self_contained,\n-            &srcdir,\n-            \"crt1.o\",\n-            &mut target_deps,\n-            DependencyType::TargetSelfContained,\n-        );\n+        for &obj in &[\"crt1.o\", \"crt1-reactor.o\"] {\n+            copy_and_stamp(\n+                builder,\n+                &libdir_self_contained,\n+                &srcdir,\n+                obj,\n+                &mut target_deps,\n+                DependencyType::TargetSelfContained,\n+            );\n+        }\n     } else if target.contains(\"windows-gnu\") {\n         for obj in [\"crt2.o\", \"dllcrt2.o\"].iter() {\n             let src = compiler_file(builder, builder.cc(target), target, obj);"}]}