{"sha": "b69724f37cca68249340e7245e5ac2832d8b2c30", "node_id": "MDY6Q29tbWl0NzI0NzEyOmI2OTcyNGYzN2NjYTY4MjQ5MzQwZTcyNDVlNWFjMjgzMmQ4YjJjMzA=", "commit": {"author": {"name": "Amanieu d'Antras", "email": "amanieu@gmail.com", "date": "2018-06-04T08:22:07Z"}, "committer": {"name": "Amanieu d'Antras", "email": "amanieu@gmail.com", "date": "2018-06-04T15:00:08Z"}, "message": "Optimize layout calculations in HashMap\n\nThis now produces the same assembly code as the previous implementation.", "tree": {"sha": "1a6e4d9167c773bc6944e1bf3ba0591737bdfa43", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1a6e4d9167c773bc6944e1bf3ba0591737bdfa43"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b69724f37cca68249340e7245e5ac2832d8b2c30", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b69724f37cca68249340e7245e5ac2832d8b2c30", "html_url": "https://github.com/rust-lang/rust/commit/b69724f37cca68249340e7245e5ac2832d8b2c30", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b69724f37cca68249340e7245e5ac2832d8b2c30/comments", "author": {"login": "Amanieu", "id": 278509, "node_id": "MDQ6VXNlcjI3ODUwOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/278509?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Amanieu", "html_url": "https://github.com/Amanieu", "followers_url": "https://api.github.com/users/Amanieu/followers", "following_url": "https://api.github.com/users/Amanieu/following{/other_user}", "gists_url": "https://api.github.com/users/Amanieu/gists{/gist_id}", "starred_url": "https://api.github.com/users/Amanieu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Amanieu/subscriptions", "organizations_url": "https://api.github.com/users/Amanieu/orgs", "repos_url": "https://api.github.com/users/Amanieu/repos", "events_url": "https://api.github.com/users/Amanieu/events{/privacy}", "received_events_url": "https://api.github.com/users/Amanieu/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Amanieu", "id": 278509, "node_id": "MDQ6VXNlcjI3ODUwOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/278509?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Amanieu", "html_url": "https://github.com/Amanieu", "followers_url": "https://api.github.com/users/Amanieu/followers", "following_url": "https://api.github.com/users/Amanieu/following{/other_user}", "gists_url": "https://api.github.com/users/Amanieu/gists{/gist_id}", "starred_url": "https://api.github.com/users/Amanieu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Amanieu/subscriptions", "organizations_url": "https://api.github.com/users/Amanieu/orgs", "repos_url": "https://api.github.com/users/Amanieu/repos", "events_url": "https://api.github.com/users/Amanieu/events{/privacy}", "received_events_url": "https://api.github.com/users/Amanieu/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6232478d26b0feca02fd6660edbf78a5c6327ec5", "url": "https://api.github.com/repos/rust-lang/rust/commits/6232478d26b0feca02fd6660edbf78a5c6327ec5", "html_url": "https://github.com/rust-lang/rust/commit/6232478d26b0feca02fd6660edbf78a5c6327ec5"}], "stats": {"total": 19, "additions": 16, "deletions": 3}, "files": [{"sha": "d997fb28d4286595d5c313b669e9dbfbc7582827", "filename": "src/libstd/collections/hash/table.rs", "status": "modified", "additions": 16, "deletions": 3, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/b69724f37cca68249340e7245e5ac2832d8b2c30/src%2Flibstd%2Fcollections%2Fhash%2Ftable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b69724f37cca68249340e7245e5ac2832d8b2c30/src%2Flibstd%2Fcollections%2Fhash%2Ftable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fcollections%2Fhash%2Ftable.rs?ref=b69724f37cca68249340e7245e5ac2832d8b2c30", "patch": "@@ -15,6 +15,7 @@ use mem::{size_of, needs_drop};\n use mem;\n use ops::{Deref, DerefMut};\n use ptr::{self, Unique, NonNull};\n+use hint;\n \n use self::BucketState::*;\n \n@@ -655,7 +656,17 @@ impl<K, V, M> GapThenFull<K, V, M>\n fn calculate_layout<K, V>(capacity: usize) -> Result<(Layout, usize), LayoutErr> {\n     let hashes = Layout::array::<HashUint>(capacity)?;\n     let pairs = Layout::array::<(K, V)>(capacity)?;\n-    hashes.extend(pairs)\n+    hashes.extend(pairs).map(|(layout, _)| {\n+        // LLVM seems to have trouble properly const-propagating pairs.align(),\n+        // possibly due to the use of NonZeroUsize. This little hack allows it\n+        // to generate optimal code.\n+        //\n+        // See https://github.com/rust-lang/rust/issues/51346 for more details.\n+        (\n+            layout,\n+            hashes.size() + hashes.padding_needed_for(mem::align_of::<(K, V)>()),\n+        )\n+    })\n }\n \n pub(crate) enum Fallibility {\n@@ -711,7 +722,8 @@ impl<K, V> RawTable<K, V> {\n     }\n \n     fn raw_bucket_at(&self, index: usize) -> RawBucket<K, V> {\n-        let (_, pairs_offset) = calculate_layout::<K, V>(self.capacity()).unwrap();\n+        let (_, pairs_offset) = calculate_layout::<K, V>(self.capacity())\n+            .unwrap_or_else(|_| unsafe { hint::unreachable_unchecked() });\n         let buffer = self.hashes.ptr() as *mut u8;\n         unsafe {\n             RawBucket {\n@@ -1109,7 +1121,8 @@ unsafe impl<#[may_dangle] K, #[may_dangle] V> Drop for RawTable<K, V> {\n             }\n         }\n \n-        let (layout, _) = calculate_layout::<K, V>(self.capacity()).unwrap();\n+        let (layout, _) = calculate_layout::<K, V>(self.capacity())\n+            .unwrap_or_else(|_| unsafe { hint::unreachable_unchecked() });\n         unsafe {\n             Global.dealloc(NonNull::new_unchecked(self.hashes.ptr()).as_opaque(), layout);\n             // Remember how everything was allocated out of one buffer"}]}