{"sha": "07aee1df4427bcc2be5e9f6be5c853a0f6987b40", "node_id": "MDY6Q29tbWl0NzI0NzEyOjA3YWVlMWRmNDQyN2JjYzJiZTVlOWY2YmU1Yzg1M2EwZjY5ODdiNDA=", "commit": {"author": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2019-03-17T11:39:00Z"}, "committer": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2019-03-17T15:19:17Z"}, "message": "Calculate Docker cache hash precisely from Dockerfile's dependencies\n\n`src/ci/docker`, so that when files under `dist-x86_64-linux` is changed,\nits dependent image `dist-i686-linux` will also be rebuilt.\n\nHowever, this ultraconservative solution caused the `dist-i686-linux` to\nbe rebuilt every time an irrelevant Dockerfile (e.g. the PowerPC ones) is\nchanged, which increases the building time beyond 3 hours and forcing\na spurious but expected failure.\n\nThis commit instead parses the Dockerfile itself and look for the actual\ndependencies. The scripts needs to be copied into the Docker image, which\nmust be done with the COPY command, so we just need to find all lines with\na COPY command and add the source file into the hash calculator.\n\nNote: this script only handles single-lined COPY command in the form\n`COPY src1 src2 src3 dst`, since these are the only variant used inside\nthis repository.", "tree": {"sha": "05ddc405f6076d3d6192ea81de0042fc65e893c9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/05ddc405f6076d3d6192ea81de0042fc65e893c9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/07aee1df4427bcc2be5e9f6be5c853a0f6987b40", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEZ1R8CLMp8f2GxWoQ/vbIBR0OATwFAlyOZXgACgkQ/vbIBR0O\nATy/UA/+MuInoXTznsUrQ9b/SAGaunJuUvOI6aAv3Z3BjetaBvjyiOcSTNOeqayv\ngcvHv4rPQo83uei1d8QlthJVTPw/AzSzky6JArZ82v0vaEq+BwNeOYP7QbDhYbCt\nFn5tTCjok2GrbNXSjm3RlHnRalHi4PJ/txueVOcnokjBQU03ThbtUPIkMUQ6N2hj\nOiOdS7avrpidcDYTsuc1RPJPS+oK3RFdCrB4qr99+NhSMxVW7HgvusPppP6DKjcs\nGGUoxeBAvYQpC/uOs98lvo/DtVzBQU7WV8eprXXMZMnclvkHcfxbZ5kxYWAe1ZJD\nklaqSxxLi61h0ChOsYJHsMU1ix1XJkArbJKnnPR3x4Xctm5OLSR9TAk5tq9YFuiR\nkjwV5d7UQB6ld5Nnbw2nj5whP8/DJsea/7/U88selOLFt5mFFIuvH0+vn6s2wgN7\nLxu4VnZHkmhthvxVeLlDWTQrhlHnCBaal4wfyaykUS44Ih7UqvKaIHGKeTqrGpL/\nyBlQrqBl8UM94TrldZw7M/A0/tJcmffUfCPF0acrL3pd2ZAl/vADzBiZF+/93ldr\nJsYAhjO/R4ybjai1HnACIWlU2B4dHBQ1qVKIh8RcGtSq1Wdobx3876VGT4xvWHsr\noi+lqBfjZCQLxYoC9ZclfrqsrlyxWrr7A77VC/iy7O1Lx0V5MbY=\n=YQZU\n-----END PGP SIGNATURE-----", "payload": "tree 05ddc405f6076d3d6192ea81de0042fc65e893c9\nparent 7cf074a1e655ac07d04d045667278fa1a9970b93\nauthor kennytm <kennytm@gmail.com> 1552822740 +0800\ncommitter kennytm <kennytm@gmail.com> 1552835957 +0800\n\nCalculate Docker cache hash precisely from Dockerfile's dependencies\n\n`src/ci/docker`, so that when files under `dist-x86_64-linux` is changed,\nits dependent image `dist-i686-linux` will also be rebuilt.\n\nHowever, this ultraconservative solution caused the `dist-i686-linux` to\nbe rebuilt every time an irrelevant Dockerfile (e.g. the PowerPC ones) is\nchanged, which increases the building time beyond 3 hours and forcing\na spurious but expected failure.\n\nThis commit instead parses the Dockerfile itself and look for the actual\ndependencies. The scripts needs to be copied into the Docker image, which\nmust be done with the COPY command, so we just need to find all lines with\na COPY command and add the source file into the hash calculator.\n\nNote: this script only handles single-lined COPY command in the form\n`COPY src1 src2 src3 dst`, since these are the only variant used inside\nthis repository.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/07aee1df4427bcc2be5e9f6be5c853a0f6987b40", "html_url": "https://github.com/rust-lang/rust/commit/07aee1df4427bcc2be5e9f6be5c853a0f6987b40", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/07aee1df4427bcc2be5e9f6be5c853a0f6987b40/comments", "author": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7cf074a1e655ac07d04d045667278fa1a9970b93", "url": "https://api.github.com/repos/rust-lang/rust/commits/7cf074a1e655ac07d04d045667278fa1a9970b93", "html_url": "https://github.com/rust-lang/rust/commit/7cf074a1e655ac07d04d045667278fa1a9970b93"}], "stats": {"total": 13, "additions": 12, "deletions": 1}, "files": [{"sha": "ef151750af9bfcb7962760c07f4de7675a0fa73c", "filename": "src/ci/docker/run.sh", "status": "modified", "additions": 12, "deletions": 1, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/07aee1df4427bcc2be5e9f6be5c853a0f6987b40/src%2Fci%2Fdocker%2Frun.sh", "raw_url": "https://github.com/rust-lang/rust/raw/07aee1df4427bcc2be5e9f6be5c853a0f6987b40/src%2Fci%2Fdocker%2Frun.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Frun.sh?ref=07aee1df4427bcc2be5e9f6be5c853a0f6987b40", "patch": "@@ -22,7 +22,18 @@ if [ -f \"$docker_dir/$image/Dockerfile\" ]; then\n       hash_key=/tmp/.docker-hash-key.txt\n       rm -f \"${hash_key}\"\n       echo $image >> $hash_key\n-      find $docker_dir -type f | sort | xargs cat >> $hash_key\n+\n+      cat \"$docker_dir/$image/Dockerfile\" >> $hash_key\n+      # Look for all source files involves in the COPY command\n+      copied_files=/tmp/.docker-copied-files.txt\n+      rm -f \"$copied_files\"\n+      for i in $(sed -n -e 's/^COPY \\(.*\\) .*$/\\1/p' \"$docker_dir/$image/Dockerfile\"); do\n+        # List the file names\n+        find \"$docker_dir/$i\" -type f >> $copied_files\n+      done\n+      # Sort the file names and cat the content into the hash key\n+      sort $copied_files | xargs cat >> $hash_key\n+\n       docker --version >> $hash_key\n       cksum=$(sha512sum $hash_key | \\\n         awk '{print $1}')"}]}