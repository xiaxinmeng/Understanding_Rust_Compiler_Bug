{"sha": "695b708311df451739b759b652a17c9e8c94b6c8", "node_id": "C_kwDOAAsO6NoAKDY5NWI3MDgzMTFkZjQ1MTczOWI3NTliNjUyYTE3YzllOGM5NGI2Yzg", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-09-23T02:29:16Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-09-23T02:29:16Z"}, "message": "Rollup merge of #101815 - diegooliveira:master, r=davidtwco\n\nMigrated the rustc_passes annotation without effect diagnostic infrastructure\n\nSmall change to move the validation for annotations to the new diagnostic infrastructure.", "tree": {"sha": "43b0ca041bdcc9e79f35942e8410027b5c392e83", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/43b0ca041bdcc9e79f35942e8410027b5c392e83"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/695b708311df451739b759b652a17c9e8c94b6c8", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjLRn8CRBK7hj4Ov3rIwAAgcMIADTMAbqKjs3oW/JMO76WQAZc\nWGABqdmzbN5X1JQUTPTO6NOBcuEkSkyHRamkvkw+FbuE/E3dKqjSoEVAgPcO48ht\npfoLf44O2KHuUZNwzVrzCXxFp9e+jrBPuy5Y02N434T1SxT8LZ1kJE1QrLFA3DEA\nKkZVKKRDxjx+RkEnM74dwHmctsunGeUdpl8HMmc2raLc1/7GlQ4/e6M0cEip0edi\ncP9J5B78y+dSsEFUJI2+AX2b+sNEh18ILgVvumOxsm8ItEqhckn17l+ntTra+AaW\nt30n22pom1dzeYHG1/asvKE+l5jW0keHvddWQ3Gm39AFHI+rZZaU6DVJJ0uVy74=\n=bkAX\n-----END PGP SIGNATURE-----\n", "payload": "tree 43b0ca041bdcc9e79f35942e8410027b5c392e83\nparent c2d2535b8427845634d503cc8f75595d296f1268\nparent 6a47326a0452cc8d5cb57676508b5469d648c67f\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1663900156 +0200\ncommitter GitHub <noreply@github.com> 1663900156 +0200\n\nRollup merge of #101815 - diegooliveira:master, r=davidtwco\n\nMigrated the rustc_passes annotation without effect diagnostic infrastructure\n\nSmall change to move the validation for annotations to the new diagnostic infrastructure.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/695b708311df451739b759b652a17c9e8c94b6c8", "html_url": "https://github.com/rust-lang/rust/commit/695b708311df451739b759b652a17c9e8c94b6c8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/695b708311df451739b759b652a17c9e8c94b6c8/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c2d2535b8427845634d503cc8f75595d296f1268", "url": "https://api.github.com/repos/rust-lang/rust/commits/c2d2535b8427845634d503cc8f75595d296f1268", "html_url": "https://github.com/rust-lang/rust/commit/c2d2535b8427845634d503cc8f75595d296f1268"}, {"sha": "6a47326a0452cc8d5cb57676508b5469d648c67f", "url": "https://api.github.com/repos/rust-lang/rust/commits/6a47326a0452cc8d5cb57676508b5469d648c67f", "html_url": "https://github.com/rust-lang/rust/commit/6a47326a0452cc8d5cb57676508b5469d648c67f"}], "stats": {"total": 27, "additions": 17, "deletions": 10}, "files": [{"sha": "995ad4fe2585986a8b28a91fe92ea59050c61817", "filename": "compiler/rustc_error_messages/locales/en-US/passes.ftl", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/695b708311df451739b759b652a17c9e8c94b6c8/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fpasses.ftl", "raw_url": "https://github.com/rust-lang/rust/raw/695b708311df451739b759b652a17c9e8c94b6c8/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fpasses.ftl", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fpasses.ftl?ref=695b708311df451739b759b652a17c9e8c94b6c8", "patch": "@@ -268,3 +268,6 @@ passes_link_ordinal = attribute should be applied to a foreign function or stati\n \n passes_collapse_debuginfo = `collapse_debuginfo` attribute should be applied to macro definitions\n     .label = not a macro definition\n+\n+passes_deprecated_annotation_has_no_effect = this `#[deprecated]` annotation has no effect\n+    .suggestion = remove the unnecessary deprecation attribute"}, {"sha": "cdfa7cf7f93c27613392e6dc45d599a8c5016167", "filename": "compiler/rustc_passes/src/errors.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/695b708311df451739b759b652a17c9e8c94b6c8/compiler%2Frustc_passes%2Fsrc%2Ferrors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/695b708311df451739b759b652a17c9e8c94b6c8/compiler%2Frustc_passes%2Fsrc%2Ferrors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Ferrors.rs?ref=695b708311df451739b759b652a17c9e8c94b6c8", "patch": "@@ -658,3 +658,10 @@ pub struct CollapseDebuginfo {\n     #[label]\n     pub defn_span: Span,\n }\n+\n+#[derive(LintDiagnostic)]\n+#[diag(passes::deprecated_annotation_has_no_effect)]\n+pub struct DeprecatedAnnotationHasNoEffect {\n+    #[suggestion(applicability = \"machine-applicable\", code = \"\")]\n+    pub span: Span,\n+}"}, {"sha": "3f23b027aef28490b229b7501311f5bf1fcd2691", "filename": "compiler/rustc_passes/src/stability.rs", "status": "modified", "additions": 7, "deletions": 10, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/695b708311df451739b759b652a17c9e8c94b6c8/compiler%2Frustc_passes%2Fsrc%2Fstability.rs", "raw_url": "https://github.com/rust-lang/rust/raw/695b708311df451739b759b652a17c9e8c94b6c8/compiler%2Frustc_passes%2Fsrc%2Fstability.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fstability.rs?ref=695b708311df451739b759b652a17c9e8c94b6c8", "patch": "@@ -1,6 +1,7 @@\n //! A pass that annotates every item and method with its stability level,\n //! propagating default levels lexically from parent to children ast nodes.\n \n+use crate::errors;\n use rustc_attr::{\n     self as attr, rust_version_symbol, ConstStability, Stability, StabilityLevel, Unstable,\n     UnstableReason, VERSION_PLACEHOLDER,\n@@ -122,16 +123,12 @@ impl<'a, 'tcx> Annotator<'a, 'tcx> {\n \n             if kind == AnnotationKind::Prohibited || kind == AnnotationKind::DeprecationProhibited {\n                 let hir_id = self.tcx.hir().local_def_id_to_hir_id(def_id);\n-                self.tcx.struct_span_lint_hir(USELESS_DEPRECATED, hir_id, *span, |lint| {\n-                    lint.build(\"this `#[deprecated]` annotation has no effect\")\n-                        .span_suggestion_short(\n-                            *span,\n-                            \"remove the unnecessary deprecation attribute\",\n-                            \"\",\n-                            rustc_errors::Applicability::MachineApplicable,\n-                        )\n-                        .emit();\n-                });\n+                self.tcx.emit_spanned_lint(\n+                    USELESS_DEPRECATED,\n+                    hir_id,\n+                    *span,\n+                    errors::DeprecatedAnnotationHasNoEffect { span: *span },\n+                );\n             }\n \n             // `Deprecation` is just two pointers, no need to intern it"}]}