{"sha": "4af50de0abc81fff51caa2fbadfc31915e63e6a4", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRhZjUwZGUwYWJjODFmZmY1MWNhYTJmYmFkZmMzMTkxNWU2M2U2YTQ=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-04-27T08:31:35Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-04-27T08:31:35Z"}, "message": "Merge #8617\n\n8617: Add option to opt out of smaller font size for inlay hints. r=SomeoneToIgnore a=jmederosalvarado\n\nAs requested on issue #6883 this PR provides an option for users to opt out of the smaller font size for inlay hints. Part of #6883.\n\nCo-authored-by: Jorge Mederos Alvarado <jmederosalvarado@gmail.com>", "tree": {"sha": "64a9e0b4102aa1dbec4ea890d200479709352bf5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/64a9e0b4102aa1dbec4ea890d200479709352bf5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4af50de0abc81fff51caa2fbadfc31915e63e6a4", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgh8vnCRBK7hj4Ov3rIwAAWDMIAIjxvWnl0yVvozhrbk0WpGrO\n8yOZJcOApVbyiiSREo9VX3qxNtl0gE8V5Wo+rqYdLi5A8QGSO+RxQimti6hIkOrV\nP8qCMfd5g9u7j88RrU0Mhu+8tTEhZJ+mHB1CM4J8qees93kOz0cW4ma8rJoYuFPY\nUftA7udhporacwXJ/1KK0feVEs6KGDLDcQKIzW/Ix1eo3HgFiWSC3WD4F9+FTj4S\nMVXwF/EttrcdmfwlM07IpFa6PxymS/LXtqlP+WYpmj+C8lWfzqDAPpY3t7l+WP49\nYT8W9FwO94d6YVwp+MgoXMa16oQBOmI0npWId3LbvO5mDnYenCGUA+n76D17A1Q=\n=kVWA\n-----END PGP SIGNATURE-----\n", "payload": "tree 64a9e0b4102aa1dbec4ea890d200479709352bf5\nparent c5364ffde14eed2738b4a45cd004af07819967c5\nparent 0230f22d2a86ad7720b4a39e41a13111aa4b4789\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1619512295 +0000\ncommitter GitHub <noreply@github.com> 1619512295 +0000\n\nMerge #8617\n\n8617: Add option to opt out of smaller font size for inlay hints. r=SomeoneToIgnore a=jmederosalvarado\n\nAs requested on issue #6883 this PR provides an option for users to opt out of the smaller font size for inlay hints. Part of #6883.\n\nCo-authored-by: Jorge Mederos Alvarado <jmederosalvarado@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4af50de0abc81fff51caa2fbadfc31915e63e6a4", "html_url": "https://github.com/rust-lang/rust/commit/4af50de0abc81fff51caa2fbadfc31915e63e6a4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4af50de0abc81fff51caa2fbadfc31915e63e6a4/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c5364ffde14eed2738b4a45cd004af07819967c5", "url": "https://api.github.com/repos/rust-lang/rust/commits/c5364ffde14eed2738b4a45cd004af07819967c5", "html_url": "https://github.com/rust-lang/rust/commit/c5364ffde14eed2738b4a45cd004af07819967c5"}, {"sha": "0230f22d2a86ad7720b4a39e41a13111aa4b4789", "url": "https://api.github.com/repos/rust-lang/rust/commits/0230f22d2a86ad7720b4a39e41a13111aa4b4789", "html_url": "https://github.com/rust-lang/rust/commit/0230f22d2a86ad7720b4a39e41a13111aa4b4789"}], "stats": {"total": 69, "additions": 59, "deletions": 10}, "files": [{"sha": "28bbbce197ba12149f0a3266d65eb894b930d9d3", "filename": "crates/rust-analyzer/src/config.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/4af50de0abc81fff51caa2fbadfc31915e63e6a4/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4af50de0abc81fff51caa2fbadfc31915e63e6a4/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs?ref=4af50de0abc81fff51caa2fbadfc31915e63e6a4", "patch": "@@ -145,6 +145,8 @@ config_data! {\n         inlayHints_parameterHints: bool     = \"true\",\n         /// Whether to show inlay type hints for variables.\n         inlayHints_typeHints: bool          = \"true\",\n+        /// Whether inlay hints font size should be smaller than editor's font size.\n+        inlayHints_smallerHints: bool       = \"true\",\n \n         /// Whether to show `Debug` lens. Only applies when\n         /// `#rust-analyzer.lens.enable#` is set."}, {"sha": "db3c5f7bbb12481471c0f8305357e0d63a1c8f78", "filename": "docs/user/generated_config.adoc", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/4af50de0abc81fff51caa2fbadfc31915e63e6a4/docs%2Fuser%2Fgenerated_config.adoc", "raw_url": "https://github.com/rust-lang/rust/raw/4af50de0abc81fff51caa2fbadfc31915e63e6a4/docs%2Fuser%2Fgenerated_config.adoc", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/docs%2Fuser%2Fgenerated_config.adoc?ref=4af50de0abc81fff51caa2fbadfc31915e63e6a4", "patch": "@@ -234,6 +234,11 @@ site.\n --\n Whether to show inlay type hints for variables.\n --\n+[[rust-analyzer.inlayHints.smallerHints]]rust-analyzer.inlayHints.smallerHints (default: `true`)::\n++\n+--\n+Whether inlay hints font size should be smaller than editor's font size.\n+--\n [[rust-analyzer.lens.debug]]rust-analyzer.lens.debug (default: `true`)::\n +\n --"}, {"sha": "4c2d168817489e02d9425efc215abc6aae50e140", "filename": "editors/code/package-lock.json", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/4af50de0abc81fff51caa2fbadfc31915e63e6a4/editors%2Fcode%2Fpackage-lock.json", "raw_url": "https://github.com/rust-lang/rust/raw/4af50de0abc81fff51caa2fbadfc31915e63e6a4/editors%2Fcode%2Fpackage-lock.json", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fpackage-lock.json?ref=4af50de0abc81fff51caa2fbadfc31915e63e6a4", "patch": "@@ -830,7 +830,6 @@\n             \"dependencies\": {\n                 \"anymatch\": \"~3.1.1\",\n                 \"braces\": \"~3.0.2\",\n-                \"fsevents\": \"~2.3.1\",\n                 \"glob-parent\": \"~5.1.0\",\n                 \"is-binary-path\": \"~2.1.0\",\n                 \"is-glob\": \"~4.0.1\",\n@@ -2680,9 +2679,6 @@\n             \"resolved\": \"https://registry.npmjs.org/rollup/-/rollup-2.39.1.tgz\",\n             \"integrity\": \"sha512-9rfr0Z6j+vE+eayfNVFr1KZ+k+jiUl2+0e4quZafy1x6SFCjzFspfRSO2ZZQeWeX9noeDTUDgg6eCENiEPFvQg==\",\n             \"dev\": true,\n-            \"dependencies\": {\n-                \"fsevents\": \"~2.3.1\"\n-            },\n             \"bin\": {\n                 \"rollup\": \"dist/bin/rollup\"\n             },"}, {"sha": "97d92e43c827528ce54e3a33edbc1208ca1b55b8", "filename": "editors/code/package.json", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/4af50de0abc81fff51caa2fbadfc31915e63e6a4/editors%2Fcode%2Fpackage.json", "raw_url": "https://github.com/rust-lang/rust/raw/4af50de0abc81fff51caa2fbadfc31915e63e6a4/editors%2Fcode%2Fpackage.json", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fpackage.json?ref=4af50de0abc81fff51caa2fbadfc31915e63e6a4", "patch": "@@ -653,6 +653,11 @@\n                     \"default\": true,\n                     \"type\": \"boolean\"\n                 },\n+                \"rust-analyzer.inlayHints.smallerHints\": {\n+                    \"markdownDescription\": \"Whether inlay hints font size should be smaller than editor's font size.\",\n+                    \"default\": true,\n+                    \"type\": \"boolean\"\n+                },\n                 \"rust-analyzer.lens.debug\": {\n                     \"markdownDescription\": \"Whether to show `Debug` lens. Only applies when\\n`#rust-analyzer.lens.enable#` is set.\",\n                     \"default\": true,"}, {"sha": "03f7d7cc3489011431e277013968bce12b7017e1", "filename": "editors/code/src/config.ts", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/4af50de0abc81fff51caa2fbadfc31915e63e6a4/editors%2Fcode%2Fsrc%2Fconfig.ts", "raw_url": "https://github.com/rust-lang/rust/raw/4af50de0abc81fff51caa2fbadfc31915e63e6a4/editors%2Fcode%2Fsrc%2Fconfig.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fconfig.ts?ref=4af50de0abc81fff51caa2fbadfc31915e63e6a4", "patch": "@@ -115,6 +115,7 @@ export class Config {\n             typeHints: this.get<boolean>(\"inlayHints.typeHints\"),\n             parameterHints: this.get<boolean>(\"inlayHints.parameterHints\"),\n             chainingHints: this.get<boolean>(\"inlayHints.chainingHints\"),\n+            smallerHints: this.get<boolean>(\"inlayHints.smallerHints\"),\n             maxLength: this.get<null | number>(\"inlayHints.maxLength\"),\n         };\n     }"}, {"sha": "c23d6f7384b99e93268b3b91d9266efc1bb491f2", "filename": "editors/code/src/inlay_hints.ts", "status": "modified", "additions": 46, "deletions": 6, "changes": 52, "blob_url": "https://github.com/rust-lang/rust/blob/4af50de0abc81fff51caa2fbadfc31915e63e6a4/editors%2Fcode%2Fsrc%2Finlay_hints.ts", "raw_url": "https://github.com/rust-lang/rust/raw/4af50de0abc81fff51caa2fbadfc31915e63e6a4/editors%2Fcode%2Fsrc%2Finlay_hints.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Finlay_hints.ts?ref=4af50de0abc81fff51caa2fbadfc31915e63e6a4", "patch": "@@ -5,6 +5,17 @@ import * as ra from './lsp_ext';\n import { Ctx, Disposable } from './ctx';\n import { sendRequestWithRetry, isRustDocument, RustDocument, RustEditor, sleep } from './util';\n \n+interface InlayHintStyle {\n+    decorationType: vscode.TextEditorDecorationType;\n+    toDecoration(hint: ra.InlayHint, conv: lc.Protocol2CodeConverter): vscode.DecorationOptions;\n+};\n+\n+interface InlayHintsStyles {\n+    typeHints: InlayHintStyle;\n+    paramHints: InlayHintStyle;\n+    chainingHints: InlayHintStyle;\n+}\n+\n \n export function activateInlayHints(ctx: Ctx) {\n     const maybeUpdater = {\n@@ -19,6 +30,7 @@ export function activateInlayHints(ctx: Ctx) {\n \n             await sleep(100);\n             if (this.updater) {\n+                this.updater.updateInlayHintsStyles();\n                 this.updater.syncCacheAndRenderHints();\n             } else {\n                 this.updater = new HintsUpdater(ctx);\n@@ -39,11 +51,7 @@ export function activateInlayHints(ctx: Ctx) {\n     maybeUpdater.onConfigChange().catch(console.error);\n }\n \n-const typeHints = createHintStyle(\"type\");\n-const paramHints = createHintStyle(\"parameter\");\n-const chainingHints = createHintStyle(\"chaining\");\n-\n-function createHintStyle(hintKind: \"type\" | \"parameter\" | \"chaining\") {\n+function createHintStyle(hintKind: \"type\" | \"parameter\" | \"chaining\", smallerHints: boolean): InlayHintStyle {\n     // U+200C is a zero-width non-joiner to prevent the editor from forming a ligature\n     // between code and type hints\n     const [pos, render] = ({\n@@ -61,7 +69,7 @@ function createHintStyle(hintKind: \"type\" | \"parameter\" | \"chaining\") {\n                 backgroundColor: bg,\n                 fontStyle: \"normal\",\n                 fontWeight: \"normal\",\n-                textDecoration: \";font-size:smaller\",\n+                textDecoration: smallerHints ? \";font-size:smaller\" : \"none\",\n             },\n         }),\n         toDecoration(hint: ra.InlayHint, conv: lc.Protocol2CodeConverter): vscode.DecorationOptions {\n@@ -73,9 +81,23 @@ function createHintStyle(hintKind: \"type\" | \"parameter\" | \"chaining\") {\n     };\n }\n \n+const smallHintsStyles = {\n+    typeHints: createHintStyle(\"type\", true),\n+    paramHints: createHintStyle(\"parameter\", true),\n+    chainingHints: createHintStyle(\"chaining\", true),\n+};\n+\n+const biggerHintsStyles = {\n+    typeHints: createHintStyle(\"type\", false),\n+    paramHints: createHintStyle(\"parameter\", false),\n+    chainingHints: createHintStyle(\"chaining\", false),\n+};\n+\n class HintsUpdater implements Disposable {\n     private sourceFiles = new Map<string, RustSourceFile>(); // map Uri -> RustSourceFile\n     private readonly disposables: Disposable[] = [];\n+    private pendingDisposeDecorations: undefined | InlayHintsStyles = undefined;\n+    private inlayHintsStyles!: InlayHintsStyles;\n \n     constructor(private readonly ctx: Ctx) {\n         vscode.window.onDidChangeVisibleTextEditors(\n@@ -100,6 +122,7 @@ class HintsUpdater implements Disposable {\n             }\n         ));\n \n+        this.updateInlayHintsStyles();\n         this.syncCacheAndRenderHints();\n     }\n \n@@ -114,6 +137,15 @@ class HintsUpdater implements Disposable {\n         this.syncCacheAndRenderHints();\n     }\n \n+    updateInlayHintsStyles() {\n+        const inlayHintsStyles = this.ctx.config.inlayHints.smallerHints ? smallHintsStyles : biggerHintsStyles;\n+\n+        if (inlayHintsStyles !== this.inlayHintsStyles) {\n+            this.pendingDisposeDecorations = this.inlayHintsStyles;\n+            this.inlayHintsStyles = inlayHintsStyles;\n+        }\n+    }\n+\n     syncCacheAndRenderHints() {\n         this.sourceFiles.forEach((file, uri) => this.fetchHints(file).then(hints => {\n             if (!hints) return;\n@@ -161,12 +193,20 @@ class HintsUpdater implements Disposable {\n     }\n \n     private renderDecorations(editor: RustEditor, decorations: InlaysDecorations) {\n+        const { typeHints, paramHints, chainingHints } = this.inlayHintsStyles;\n+        if (this.pendingDisposeDecorations !== undefined) {\n+            const { typeHints, paramHints, chainingHints } = this.pendingDisposeDecorations;\n+            editor.setDecorations(typeHints.decorationType, []);\n+            editor.setDecorations(paramHints.decorationType, []);\n+            editor.setDecorations(chainingHints.decorationType, []);\n+        }\n         editor.setDecorations(typeHints.decorationType, decorations.type);\n         editor.setDecorations(paramHints.decorationType, decorations.param);\n         editor.setDecorations(chainingHints.decorationType, decorations.chaining);\n     }\n \n     private hintsToDecorations(hints: ra.InlayHint[]): InlaysDecorations {\n+        const { typeHints, paramHints, chainingHints } = this.inlayHintsStyles;\n         const decorations: InlaysDecorations = { type: [], param: [], chaining: [] };\n         const conv = this.ctx.client.protocol2CodeConverter;\n "}]}