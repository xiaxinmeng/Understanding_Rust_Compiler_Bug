{"sha": "6fed0132f314622700da9cd9f5746cfc4f4bb87f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZmZWQwMTMyZjMxNDYyMjcwMGRhOWNkOWY1NzQ2Y2ZjNGY0YmI4N2Y=", "commit": {"author": {"name": "Georg Brandl", "email": "georg@python.org", "date": "2016-05-02T14:47:07Z"}, "committer": {"name": "Georg Brandl", "email": "georg@python.org", "date": "2016-05-02T14:48:36Z"}, "message": "middle: reset loop labels while visiting closure\n\nThis should fix #31754 and follow-up #25343.  Before the latter, the\nclosure was visited twice in the context of the enclosing fn, which\nmade even a single closure with a loop label emit a warning.\n\nWith this change, the closure is still visited within the context\nof the main fn (which is intended, since it is not a separate item)\nbut resets the found loop labels while being visited.\n\nFixes: #31754", "tree": {"sha": "d37b7028de650d0b71281be802235d67ee0c2782", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d37b7028de650d0b71281be802235d67ee0c2782"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6fed0132f314622700da9cd9f5746cfc4f4bb87f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6fed0132f314622700da9cd9f5746cfc4f4bb87f", "html_url": "https://github.com/rust-lang/rust/commit/6fed0132f314622700da9cd9f5746cfc4f4bb87f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6fed0132f314622700da9cd9f5746cfc4f4bb87f/comments", "author": {"login": "birkenfeld", "id": 144359, "node_id": "MDQ6VXNlcjE0NDM1OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/144359?v=4", "gravatar_id": "", "url": "https://api.github.com/users/birkenfeld", "html_url": "https://github.com/birkenfeld", "followers_url": "https://api.github.com/users/birkenfeld/followers", "following_url": "https://api.github.com/users/birkenfeld/following{/other_user}", "gists_url": "https://api.github.com/users/birkenfeld/gists{/gist_id}", "starred_url": "https://api.github.com/users/birkenfeld/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/birkenfeld/subscriptions", "organizations_url": "https://api.github.com/users/birkenfeld/orgs", "repos_url": "https://api.github.com/users/birkenfeld/repos", "events_url": "https://api.github.com/users/birkenfeld/events{/privacy}", "received_events_url": "https://api.github.com/users/birkenfeld/received_events", "type": "User", "site_admin": false}, "committer": {"login": "birkenfeld", "id": 144359, "node_id": "MDQ6VXNlcjE0NDM1OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/144359?v=4", "gravatar_id": "", "url": "https://api.github.com/users/birkenfeld", "html_url": "https://github.com/birkenfeld", "followers_url": "https://api.github.com/users/birkenfeld/followers", "following_url": "https://api.github.com/users/birkenfeld/following{/other_user}", "gists_url": "https://api.github.com/users/birkenfeld/gists{/gist_id}", "starred_url": "https://api.github.com/users/birkenfeld/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/birkenfeld/subscriptions", "organizations_url": "https://api.github.com/users/birkenfeld/orgs", "repos_url": "https://api.github.com/users/birkenfeld/repos", "events_url": "https://api.github.com/users/birkenfeld/events{/privacy}", "received_events_url": "https://api.github.com/users/birkenfeld/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "855fb6192263a5c059325bb4b4e10b55e4e8ddbb", "url": "https://api.github.com/repos/rust-lang/rust/commits/855fb6192263a5c059325bb4b4e10b55e4e8ddbb", "html_url": "https://github.com/rust-lang/rust/commit/855fb6192263a5c059325bb4b4e10b55e4e8ddbb"}], "stats": {"total": 22, "additions": 21, "deletions": 1}, "files": [{"sha": "5c062316310101a35478092e4d5d3418fd5a250d", "filename": "src/librustc/middle/resolve_lifetime.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/6fed0132f314622700da9cd9f5746cfc4f4bb87f/src%2Flibrustc%2Fmiddle%2Fresolve_lifetime.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6fed0132f314622700da9cd9f5746cfc4f4bb87f/src%2Flibrustc%2Fmiddle%2Fresolve_lifetime.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fresolve_lifetime.rs?ref=6fed0132f314622700da9cd9f5746cfc4f4bb87f", "patch": "@@ -193,7 +193,12 @@ impl<'a, 'v> Visitor<'v> for LifetimeContext<'a> {\n                 })\n             }\n             FnKind::Closure(_) => {\n-                self.add_scope_and_walk_fn(fk, fd, b, s, fn_id)\n+                // Closures have their own set of labels, save labels just\n+                // like for foreign items above.\n+                let saved = replace(&mut self.labels_in_fn, vec![]);\n+                let result = self.add_scope_and_walk_fn(fk, fd, b, s, fn_id);\n+                replace(&mut self.labels_in_fn, saved);\n+                result\n             }\n         }\n     }"}, {"sha": "64e7350fb824471fc39a716efd39822b7c7a619f", "filename": "src/test/run-pass/issue-25343.rs", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/6fed0132f314622700da9cd9f5746cfc4f4bb87f/src%2Ftest%2Frun-pass%2Fissue-25343.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6fed0132f314622700da9cd9f5746cfc4f4bb87f/src%2Ftest%2Frun-pass%2Fissue-25343.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fissue-25343.rs?ref=6fed0132f314622700da9cd9f5746cfc4f4bb87f", "patch": "@@ -8,9 +8,24 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n+#[allow(unused)]\n fn main() {\n     || {\n         'label: loop {\n         }\n     };\n+\n+    // More cases added from issue 31754\n+\n+    'label2: loop {\n+        break;\n+    }\n+\n+    let closure = || {\n+        'label2: loop {}\n+    };\n+\n+    fn inner_fn() {\n+        'label2: loop {}\n+    }\n }"}]}