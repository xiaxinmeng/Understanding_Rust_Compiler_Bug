{"sha": "006bb3cd268a12499eea2534c428975d1134a540", "node_id": "C_kwDOAAsO6NoAKDAwNmJiM2NkMjY4YTEyNDk5ZWVhMjUzNGM0Mjg5NzVkMTEzNGE1NDA", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-07-17T11:00:55Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-07-17T11:00:55Z"}, "message": "Auto merge of #2377 - rust-lang:only-on-host, r=oli-obk\n\nAdd test flag for running a test only on the host", "tree": {"sha": "60867da02b475273058fac2c914c14361a83f0a3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/60867da02b475273058fac2c914c14361a83f0a3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/006bb3cd268a12499eea2534c428975d1134a540", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/006bb3cd268a12499eea2534c428975d1134a540", "html_url": "https://github.com/rust-lang/rust/commit/006bb3cd268a12499eea2534c428975d1134a540", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/006bb3cd268a12499eea2534c428975d1134a540/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "86911fd8f610eb59e0f90909323f48229965c06c", "url": "https://api.github.com/repos/rust-lang/rust/commits/86911fd8f610eb59e0f90909323f48229965c06c", "html_url": "https://github.com/rust-lang/rust/commit/86911fd8f610eb59e0f90909323f48229965c06c"}, {"sha": "8527bfc63b8c6eb9451e1adb08c39cc4d54c1bc5", "url": "https://api.github.com/repos/rust-lang/rust/commits/8527bfc63b8c6eb9451e1adb08c39cc4d54c1bc5", "html_url": "https://github.com/rust-lang/rust/commit/8527bfc63b8c6eb9451e1adb08c39cc4d54c1bc5"}], "stats": {"total": 26, "additions": 16, "deletions": 10}, "files": [{"sha": "bb2fc5b12318d8a55cc936f2359ae2de221b55e7", "filename": "miri", "status": "modified", "additions": 3, "deletions": 4, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/006bb3cd268a12499eea2534c428975d1134a540/miri", "raw_url": "https://github.com/rust-lang/rust/raw/006bb3cd268a12499eea2534c428975d1134a540/miri", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/miri?ref=006bb3cd268a12499eea2534c428975d1134a540", "patch": "@@ -133,10 +133,9 @@ find_sysroot() {\n # Run command.\n case \"$COMMAND\" in\n install)\n-    # \"--locked\" to respect the Cargo.lock file if it exists,\n-    # \"--offline\" to avoid querying the registry (for yanked packages).\n-    $CARGO install $CARGO_EXTRA_FLAGS --path \"$MIRIDIR\" --force --locked --offline \"$@\"\n-    $CARGO install $CARGO_EXTRA_FLAGS --path \"$MIRIDIR\"/cargo-miri --force --locked --offline \"$@\"\n+    # \"--locked\" to respect the Cargo.lock file if it exists.\n+    $CARGO install $CARGO_EXTRA_FLAGS --path \"$MIRIDIR\" --force --locked \"$@\"\n+    $CARGO install $CARGO_EXTRA_FLAGS --path \"$MIRIDIR\"/cargo-miri --force --locked \"$@\"\n     ;;\n check)\n     # Check, and let caller control flags."}, {"sha": "4ecebcc8ddb24ed56f391a244d6cb159e6469d53", "filename": "ui_test/README.md", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/006bb3cd268a12499eea2534c428975d1134a540/ui_test%2FREADME.md", "raw_url": "https://github.com/rust-lang/rust/raw/006bb3cd268a12499eea2534c428975d1134a540/ui_test%2FREADME.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/ui_test%2FREADME.md?ref=006bb3cd268a12499eea2534c428975d1134a540", "patch": "@@ -25,8 +25,10 @@ their command specifies, or the test will fail without even being run.\n \n * `//@ignore-XXX` avoids running the test on targets whose triple contains `XXX`\n     * `XXX` can also be one of `64bit`, `32bit` or `16bit`\n+    * `XXX` can also be `on-host`, which will only run the test during cross compilation testing.\n * `//@only-XXX` avoids running the test on targets whose triple **does not** contain `XXX`\n     * `XXX` can also be one of `64bit`, `32bit` or `16bit`\n+    * `XXX` can also be `on-host`, which will not run the test during cross compilation testing\n * `//@stderr-per-bitwidth` produces one stderr file per bitwidth, as they may differ significantly sometimes\n * `//@error-pattern: XXX` make sure the stderr output contains `XXX`\n * `//@revisions: XXX YYY` runs the test once for each space separated name in the list"}, {"sha": "16f7be30f8b2e6a65d920629e3929d2540819433", "filename": "ui_test/src/lib.rs", "status": "modified", "additions": 6, "deletions": 5, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/006bb3cd268a12499eea2534c428975d1134a540/ui_test%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/006bb3cd268a12499eea2534c428975d1134a540/ui_test%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/ui_test%2Fsrc%2Flib.rs?ref=006bb3cd268a12499eea2534c428975d1134a540", "patch": "@@ -109,7 +109,7 @@ pub fn run_tests(config: Config) -> Result<()> {\n                     }\n                     let comments = Comments::parse_file(&path)?;\n                     // Ignore file if only/ignore rules do (not) apply\n-                    if !test_file_conditions(&comments, &target) {\n+                    if !test_file_conditions(&comments, &target, &config) {\n                         ignored.fetch_add(1, Ordering::Relaxed);\n                         eprintln!(\n                             \"{} ... {}\",\n@@ -499,19 +499,20 @@ fn output_path(path: &Path, comments: &Comments, kind: String, target: &str) ->\n     path.with_extension(kind)\n }\n \n-fn test_condition(condition: &Condition, target: &str) -> bool {\n+fn test_condition(condition: &Condition, target: &str, config: &Config) -> bool {\n     match condition {\n         Condition::Bitwidth(bits) => get_pointer_width(target) == *bits,\n         Condition::Target(t) => target.contains(t),\n+        Condition::OnHost => config.target.is_none(),\n     }\n }\n \n /// Returns whether according to the in-file conditions, this file should be run.\n-fn test_file_conditions(comments: &Comments, target: &str) -> bool {\n-    if comments.ignore.iter().any(|c| test_condition(c, target)) {\n+fn test_file_conditions(comments: &Comments, target: &str, config: &Config) -> bool {\n+    if comments.ignore.iter().any(|c| test_condition(c, target, config)) {\n         return false;\n     }\n-    comments.only.iter().all(|c| test_condition(c, target))\n+    comments.only.iter().all(|c| test_condition(c, target, config))\n }\n \n // Taken 1:1 from compiletest-rs"}, {"sha": "e7fb484434d79facea2f61c459c9dd0be0483239", "filename": "ui_test/src/parser.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/006bb3cd268a12499eea2534c428975d1134a540/ui_test%2Fsrc%2Fparser.rs", "raw_url": "https://github.com/rust-lang/rust/raw/006bb3cd268a12499eea2534c428975d1134a540/ui_test%2Fsrc%2Fparser.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/ui_test%2Fsrc%2Fparser.rs?ref=006bb3cd268a12499eea2534c428975d1134a540", "patch": "@@ -43,6 +43,8 @@ pub(crate) enum Condition {\n     Target(String),\n     /// Tests that the bitwidth is the given one.\n     Bitwidth(u8),\n+    /// Tests that the target is the host.\n+    OnHost,\n }\n \n #[derive(Debug, Clone)]\n@@ -64,7 +66,9 @@ pub(crate) struct ErrorMatch {\n \n impl Condition {\n     fn parse(c: &str) -> Self {\n-        if let Some(bits) = c.strip_suffix(\"bit\") {\n+        if c == \"on-host\" {\n+            Condition::OnHost\n+        } else if let Some(bits) = c.strip_suffix(\"bit\") {\n             let bits: u8 = bits.parse().expect(\n                 \"ignore/only filter ending in 'bit' must be of the form 'Nbit' for some integer N\",\n             );"}]}