{"sha": "d9bc16cf368f1a8701295ed83f0337461acd6963", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQ5YmMxNmNmMzY4ZjFhODcwMTI5NWVkODNmMDMzNzQ2MWFjZDY5NjM=", "commit": {"author": {"name": "Dylan DPC", "email": "dylan.dpc@gmail.com", "date": "2021-02-19T01:49:12Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-02-19T01:49:12Z"}, "message": "Rollup merge of #82261 - ojeda:rustdoc-argfile, r=jyn514\n\nrustdoc: Support argument files\n\nFactors out the `rustc_driver` logic that handles argument files so that rustdoc supports them as well, e.g.:\n\n    rustdoc `@argfile`\n\nThis is needed to be able to generate docs for projects that already use argument files when compiling them, e.g. projects that pass a huge number of `--cfg` arguments.\n\nThe feature was stabilized for `rustc` in #66172.", "tree": {"sha": "f488908a9af717c89d066768b94c05feb42df380", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f488908a9af717c89d066768b94c05feb42df380"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d9bc16cf368f1a8701295ed83f0337461acd6963", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgLxkYCRBK7hj4Ov3rIwAAdHIIAHDc3+FIrtpJCMbtLeNKp/sx\n2hz+mzg2pvJzTcHtfqMAjle+uwFcqBmtRVksUR4k6hYzepdlPRh9E69E2m9RqZoe\nRWfIid4zMRZ49JqjaKoZo39ibS0hBltVLIHsmkvF5gqA21ig4dWhGBQNaA9+QNe3\n8dBmJ3UwVpYWI84dq6YeEFNhyoBiWO5YN4uSwiPDJgJIaVB1uKpxiB26cNeSK9us\nAJj86+V2X6woXLjYMYIqBBE+Wx/R/rm+ZqiFXH9m0gyEYLfZeReRRsK0pqJ4EFBz\nbkL2mGDFkd8RTehQcLFtUSovf1ZZfZaWGt2hIeKnHuh8+9p5igSOAIfYZR5TmOM=\n=Nxl1\n-----END PGP SIGNATURE-----\n", "payload": "tree f488908a9af717c89d066768b94c05feb42df380\nparent cc01bbe8f0cf7b19053c5f0578992cb7d2f4bba8\nparent 755b3fc722c36d9761bf49c246b5f7c85a62380d\nauthor Dylan DPC <dylan.dpc@gmail.com> 1613699352 +0100\ncommitter GitHub <noreply@github.com> 1613699352 +0100\n\nRollup merge of #82261 - ojeda:rustdoc-argfile, r=jyn514\n\nrustdoc: Support argument files\n\nFactors out the `rustc_driver` logic that handles argument files so that rustdoc supports them as well, e.g.:\n\n    rustdoc `@argfile`\n\nThis is needed to be able to generate docs for projects that already use argument files when compiling them, e.g. projects that pass a huge number of `--cfg` arguments.\n\nThe feature was stabilized for `rustc` in #66172.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d9bc16cf368f1a8701295ed83f0337461acd6963", "html_url": "https://github.com/rust-lang/rust/commit/d9bc16cf368f1a8701295ed83f0337461acd6963", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d9bc16cf368f1a8701295ed83f0337461acd6963/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cc01bbe8f0cf7b19053c5f0578992cb7d2f4bba8", "url": "https://api.github.com/repos/rust-lang/rust/commits/cc01bbe8f0cf7b19053c5f0578992cb7d2f4bba8", "html_url": "https://github.com/rust-lang/rust/commit/cc01bbe8f0cf7b19053c5f0578992cb7d2f4bba8"}, {"sha": "755b3fc722c36d9761bf49c246b5f7c85a62380d", "url": "https://api.github.com/repos/rust-lang/rust/commits/755b3fc722c36d9761bf49c246b5f7c85a62380d", "html_url": "https://github.com/rust-lang/rust/commit/755b3fc722c36d9761bf49c246b5f7c85a62380d"}], "stats": {"total": 90, "additions": 77, "deletions": 13}, "files": [{"sha": "01338359f1af1d063ddc3d16130fc221a31657f4", "filename": "compiler/rustc_driver/src/args.rs", "status": "modified", "additions": 15, "deletions": 1, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/d9bc16cf368f1a8701295ed83f0337461acd6963/compiler%2Frustc_driver%2Fsrc%2Fargs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9bc16cf368f1a8701295ed83f0337461acd6963/compiler%2Frustc_driver%2Fsrc%2Fargs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_driver%2Fsrc%2Fargs.rs?ref=d9bc16cf368f1a8701295ed83f0337461acd6963", "patch": "@@ -3,7 +3,7 @@ use std::fmt;\n use std::fs;\n use std::io;\n \n-pub fn arg_expand(arg: String) -> Result<Vec<String>, Error> {\n+fn arg_expand(arg: String) -> Result<Vec<String>, Error> {\n     if let Some(path) = arg.strip_prefix('@') {\n         let file = match fs::read_to_string(path) {\n             Ok(file) => file,\n@@ -18,6 +18,20 @@ pub fn arg_expand(arg: String) -> Result<Vec<String>, Error> {\n     }\n }\n \n+pub fn arg_expand_all(at_args: &[String]) -> Vec<String> {\n+    let mut args = Vec::new();\n+    for arg in at_args {\n+        match arg_expand(arg.clone()) {\n+            Ok(arg) => args.extend(arg),\n+            Err(err) => rustc_session::early_error(\n+                rustc_session::config::ErrorOutputType::default(),\n+                &format!(\"Failed to load argument file: {}\", err),\n+            ),\n+        }\n+    }\n+    args\n+}\n+\n #[derive(Debug)]\n pub enum Error {\n     Utf8Error(Option<String>),"}, {"sha": "cad5a87bb134663ad329c360df5a442709356ecb", "filename": "compiler/rustc_driver/src/lib.rs", "status": "modified", "additions": 3, "deletions": 11, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/d9bc16cf368f1a8701295ed83f0337461acd6963/compiler%2Frustc_driver%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9bc16cf368f1a8701295ed83f0337461acd6963/compiler%2Frustc_driver%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_driver%2Fsrc%2Flib.rs?ref=d9bc16cf368f1a8701295ed83f0337461acd6963", "patch": "@@ -55,7 +55,7 @@ use std::process::{self, Command, Stdio};\n use std::str;\n use std::time::Instant;\n \n-mod args;\n+pub mod args;\n pub mod pretty;\n \n /// Exit status code used for successful compilation and help output.\n@@ -188,16 +188,8 @@ fn run_compiler(\n         Box<dyn FnOnce(&config::Options) -> Box<dyn CodegenBackend> + Send>,\n     >,\n ) -> interface::Result<()> {\n-    let mut args = Vec::new();\n-    for arg in at_args {\n-        match args::arg_expand(arg.clone()) {\n-            Ok(arg) => args.extend(arg),\n-            Err(err) => early_error(\n-                ErrorOutputType::default(),\n-                &format!(\"Failed to load argument file: {}\", err),\n-            ),\n-        }\n-    }\n+    let args = args::arg_expand_all(at_args);\n+\n     let diagnostic_output = emitter.map_or(DiagnosticOutput::Default, DiagnosticOutput::Raw);\n     let matches = match handle_options(&args) {\n         Some(matches) => matches,"}, {"sha": "0302fbecb6ed09ca0ba63a2771cad70715c16a6d", "filename": "src/doc/rustdoc/src/command-line-arguments.md", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/d9bc16cf368f1a8701295ed83f0337461acd6963/src%2Fdoc%2Frustdoc%2Fsrc%2Fcommand-line-arguments.md", "raw_url": "https://github.com/rust-lang/rust/raw/d9bc16cf368f1a8701295ed83f0337461acd6963/src%2Fdoc%2Frustdoc%2Fsrc%2Fcommand-line-arguments.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Frustdoc%2Fsrc%2Fcommand-line-arguments.md?ref=d9bc16cf368f1a8701295ed83f0337461acd6963", "patch": "@@ -422,3 +422,10 @@ $ rustdoc src/lib.rs --crate-version 1.3.37\n When `rustdoc` receives this flag, it will print an extra \"Version (version)\" into the sidebar of\n the crate root's docs. You can use this flag to differentiate between different versions of your\n library's documentation.\n+\n+## `@path`: load command-line flags from a path\n+\n+If you specify `@path` on the command-line, then it will open `path` and read\n+command line options from it. These options are one per line; a blank line indicates\n+an empty option. The file can use Unix or Windows style line endings, and must be\n+encoded as UTF-8."}, {"sha": "d7978c4a0228db64f252037a25106accf8d50a1f", "filename": "src/librustdoc/lib.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/d9bc16cf368f1a8701295ed83f0337461acd6963/src%2Flibrustdoc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9bc16cf368f1a8701295ed83f0337461acd6963/src%2Flibrustdoc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Flib.rs?ref=d9bc16cf368f1a8701295ed83f0337461acd6963", "patch": "@@ -432,13 +432,16 @@ fn usage(argv0: &str) {\n         (option.apply)(&mut options);\n     }\n     println!(\"{}\", options.usage(&format!(\"{} [options] <input>\", argv0)));\n+    println!(\"    @path               Read newline separated options from `path`\\n\");\n     println!(\"More information available at https://doc.rust-lang.org/rustdoc/what-is-rustdoc.html\")\n }\n \n /// A result type used by several functions under `main()`.\n type MainResult = Result<(), ErrorReported>;\n \n-fn main_args(args: &[String]) -> MainResult {\n+fn main_args(at_args: &[String]) -> MainResult {\n+    let args = rustc_driver::args::arg_expand_all(at_args);\n+\n     let mut options = getopts::Options::new();\n     for option in opts() {\n         (option.apply)(&mut options);"}, {"sha": "c070b0c2400d84bf703e9c647d2b988c60fca366", "filename": "src/test/rustdoc-ui/commandline-argfile-badutf8.args", "status": "added", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d9bc16cf368f1a8701295ed83f0337461acd6963/src%2Ftest%2Frustdoc-ui%2Fcommandline-argfile-badutf8.args", "raw_url": "https://github.com/rust-lang/rust/raw/d9bc16cf368f1a8701295ed83f0337461acd6963/src%2Ftest%2Frustdoc-ui%2Fcommandline-argfile-badutf8.args", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fcommandline-argfile-badutf8.args?ref=d9bc16cf368f1a8701295ed83f0337461acd6963", "patch": "@@ -0,0 +1,2 @@\n+--cfg\n+unbroken\ufffd\n\\ No newline at end of file"}, {"sha": "e2984e3ca97acb9ce9a5a665d2a1995ef8d42269", "filename": "src/test/rustdoc-ui/commandline-argfile-badutf8.rs", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/d9bc16cf368f1a8701295ed83f0337461acd6963/src%2Ftest%2Frustdoc-ui%2Fcommandline-argfile-badutf8.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9bc16cf368f1a8701295ed83f0337461acd6963/src%2Ftest%2Frustdoc-ui%2Fcommandline-argfile-badutf8.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fcommandline-argfile-badutf8.rs?ref=d9bc16cf368f1a8701295ed83f0337461acd6963", "patch": "@@ -0,0 +1,12 @@\n+// Check to see if we can get parameters from an @argsfile file\n+//\n+// compile-flags: --cfg cmdline_set @{{src-base}}/commandline-argfile-badutf8.args\n+\n+#[cfg(not(cmdline_set))]\n+compile_error!(\"cmdline_set not set\");\n+\n+#[cfg(not(unbroken))]\n+compile_error!(\"unbroken not set\");\n+\n+fn main() {\n+}"}, {"sha": "9af6fc0a518dfd05e76c56920bbd17ff3359e18e", "filename": "src/test/rustdoc-ui/commandline-argfile-badutf8.stderr", "status": "added", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d9bc16cf368f1a8701295ed83f0337461acd6963/src%2Ftest%2Frustdoc-ui%2Fcommandline-argfile-badutf8.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/d9bc16cf368f1a8701295ed83f0337461acd6963/src%2Ftest%2Frustdoc-ui%2Fcommandline-argfile-badutf8.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fcommandline-argfile-badutf8.stderr?ref=d9bc16cf368f1a8701295ed83f0337461acd6963", "patch": "@@ -0,0 +1,2 @@\n+error: Failed to load argument file: Utf8 error in $DIR/commandline-argfile-badutf8.args\n+"}, {"sha": "020c3ff3c7e6346fe6770170d8a68314323f3caa", "filename": "src/test/rustdoc-ui/commandline-argfile-missing.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/d9bc16cf368f1a8701295ed83f0337461acd6963/src%2Ftest%2Frustdoc-ui%2Fcommandline-argfile-missing.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9bc16cf368f1a8701295ed83f0337461acd6963/src%2Ftest%2Frustdoc-ui%2Fcommandline-argfile-missing.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fcommandline-argfile-missing.rs?ref=d9bc16cf368f1a8701295ed83f0337461acd6963", "patch": "@@ -0,0 +1,15 @@\n+// Check to see if we can get parameters from an @argsfile file\n+//\n+// ignore-tidy-linelength\n+// normalize-stderr-test: \"os error \\d+\" -> \"os error $$ERR\"\n+// normalize-stderr-test: \"commandline-argfile-missing.args:[^(]*\" -> \"commandline-argfile-missing.args: $$FILE_MISSING \"\n+// compile-flags: --cfg cmdline_set @{{src-base}}/commandline-argfile-missing.args\n+\n+#[cfg(not(cmdline_set))]\n+compile_error!(\"cmdline_set not set\");\n+\n+#[cfg(not(unbroken))]\n+compile_error!(\"unbroken not set\");\n+\n+fn main() {\n+}"}, {"sha": "179ad83100419591c92ae7f948be2255c2fcd193", "filename": "src/test/rustdoc-ui/commandline-argfile-missing.stderr", "status": "added", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d9bc16cf368f1a8701295ed83f0337461acd6963/src%2Ftest%2Frustdoc-ui%2Fcommandline-argfile-missing.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/d9bc16cf368f1a8701295ed83f0337461acd6963/src%2Ftest%2Frustdoc-ui%2Fcommandline-argfile-missing.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fcommandline-argfile-missing.stderr?ref=d9bc16cf368f1a8701295ed83f0337461acd6963", "patch": "@@ -0,0 +1,2 @@\n+error: Failed to load argument file: IO Error: $DIR/commandline-argfile-missing.args: $FILE_MISSING (os error $ERR)\n+"}, {"sha": "972938bf6c8dddf9a1a3a24d94e3fdc20f07fc29", "filename": "src/test/rustdoc-ui/commandline-argfile.args", "status": "added", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d9bc16cf368f1a8701295ed83f0337461acd6963/src%2Ftest%2Frustdoc-ui%2Fcommandline-argfile.args", "raw_url": "https://github.com/rust-lang/rust/raw/d9bc16cf368f1a8701295ed83f0337461acd6963/src%2Ftest%2Frustdoc-ui%2Fcommandline-argfile.args", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fcommandline-argfile.args?ref=d9bc16cf368f1a8701295ed83f0337461acd6963", "patch": "@@ -0,0 +1,2 @@\n+--cfg\n+unbroken\n\\ No newline at end of file"}, {"sha": "cc8c8722c1c3599cc76bdb13e6b90880f0241241", "filename": "src/test/rustdoc-ui/commandline-argfile.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/d9bc16cf368f1a8701295ed83f0337461acd6963/src%2Ftest%2Frustdoc-ui%2Fcommandline-argfile.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9bc16cf368f1a8701295ed83f0337461acd6963/src%2Ftest%2Frustdoc-ui%2Fcommandline-argfile.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fcommandline-argfile.rs?ref=d9bc16cf368f1a8701295ed83f0337461acd6963", "patch": "@@ -0,0 +1,13 @@\n+// Check to see if we can get parameters from an @argsfile file\n+//\n+// check-pass\n+// compile-flags: --cfg cmdline_set @{{src-base}}/commandline-argfile.args\n+\n+#[cfg(not(cmdline_set))]\n+compile_error!(\"cmdline_set not set\");\n+\n+#[cfg(not(unbroken))]\n+compile_error!(\"unbroken not set\");\n+\n+fn main() {\n+}"}]}