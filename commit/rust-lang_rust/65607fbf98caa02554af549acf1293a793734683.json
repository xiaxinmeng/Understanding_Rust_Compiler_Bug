{"sha": "65607fbf98caa02554af549acf1293a793734683", "node_id": "MDY6Q29tbWl0NzI0NzEyOjY1NjA3ZmJmOThjYWEwMjU1NGFmNTQ5YWNmMTI5M2E3OTM3MzQ2ODM=", "commit": {"author": {"name": "Dylan DPC", "email": "dylan.dpc@gmail.com", "date": "2020-05-25T16:07:44Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-05-25T16:07:44Z"}, "message": "Rollup merge of #72308 - Aaron1011:fix/hygiene-error-message, r=matthewjasper\n\nEmit a better diagnostic when function actually has a 'self' parameter\n\nFixes #66898\n\nWhen we are unable to resolve a reference to `self`, we current assume\nthat the containing function doesn't have a `self` parameter, and\nemit an error message accordingly.\n\nHowever, if the reference to `self` was created by a macro invocation,\nthen resolution will correctly fail, due to hygiene. In this case, we\ndon't want to tell the user that the containing fuction doesn't have a\n'self' paramter if it actually has one.\n\nThis PR checks for the precense of a 'self' parameter, and adjusts the\nerror message we emit accordingly.\n\nTODO: The exact error message we emit could probably be improved. Should\nwe explicitly mention hygiene?", "tree": {"sha": "dcc90454098628c9ece5b64f1d155817d347f17d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/dcc90454098628c9ece5b64f1d155817d347f17d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/65607fbf98caa02554af549acf1293a793734683", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJey+1QCRBK7hj4Ov3rIwAAdHIIAJXHKDx6ypZ6e4bx0+XsW8gU\ngI2JjvXuewIwJY772TBTUnwOHKv0YFs60lhPjrLBfb6lBJlVLfQYTsZoMPh0UR7S\n7/ifHe+8QCE/jE3r4FSEr2f0zuNPRrm8N6XPyUCzYckPGeG+dLXygWiYfVpTS5mm\nanYT3j1FhyT+b5NPGru0U2mmg70+oj6NZCb4PAqhIr/uoV94UIoDQLxvHCqWHF8Z\n+id8NEGmCCMfmqiBOBMr3tgIQP4QUscY3xohL8sUOEFM2ckh/mHldcXFPPKALZb8\nn9LKOTJ+NiawDoCi4UWUSDQmS+GRw16W/dVwSJcaOZ5oGeX3v8WdTR2AqMQMIB0=\n=/EdX\n-----END PGP SIGNATURE-----\n", "payload": "tree dcc90454098628c9ece5b64f1d155817d347f17d\nparent d5250c160a9bb463d08a0073962fdd68e33391b4\nparent b6844489f9dc3ca7aa23c3111a4576099919d65f\nauthor Dylan DPC <dylan.dpc@gmail.com> 1590422864 +0200\ncommitter GitHub <noreply@github.com> 1590422864 +0200\n\nRollup merge of #72308 - Aaron1011:fix/hygiene-error-message, r=matthewjasper\n\nEmit a better diagnostic when function actually has a 'self' parameter\n\nFixes #66898\n\nWhen we are unable to resolve a reference to `self`, we current assume\nthat the containing function doesn't have a `self` parameter, and\nemit an error message accordingly.\n\nHowever, if the reference to `self` was created by a macro invocation,\nthen resolution will correctly fail, due to hygiene. In this case, we\ndon't want to tell the user that the containing fuction doesn't have a\n'self' paramter if it actually has one.\n\nThis PR checks for the precense of a 'self' parameter, and adjusts the\nerror message we emit accordingly.\n\nTODO: The exact error message we emit could probably be improved. Should\nwe explicitly mention hygiene?\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/65607fbf98caa02554af549acf1293a793734683", "html_url": "https://github.com/rust-lang/rust/commit/65607fbf98caa02554af549acf1293a793734683", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/65607fbf98caa02554af549acf1293a793734683/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d5250c160a9bb463d08a0073962fdd68e33391b4", "url": "https://api.github.com/repos/rust-lang/rust/commits/d5250c160a9bb463d08a0073962fdd68e33391b4", "html_url": "https://github.com/rust-lang/rust/commit/d5250c160a9bb463d08a0073962fdd68e33391b4"}, {"sha": "b6844489f9dc3ca7aa23c3111a4576099919d65f", "url": "https://api.github.com/repos/rust-lang/rust/commits/b6844489f9dc3ca7aa23c3111a4576099919d65f", "html_url": "https://github.com/rust-lang/rust/commit/b6844489f9dc3ca7aa23c3111a4576099919d65f"}], "stats": {"total": 56, "additions": 52, "deletions": 4}, "files": [{"sha": "477e3be5cc2f89df6b8cc39cef04a1436da592df", "filename": "src/librustc_resolve/late.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/65607fbf98caa02554af549acf1293a793734683/src%2Flibrustc_resolve%2Flate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/65607fbf98caa02554af549acf1293a793734683/src%2Flibrustc_resolve%2Flate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_resolve%2Flate.rs?ref=65607fbf98caa02554af549acf1293a793734683", "patch": "@@ -347,7 +347,7 @@ struct DiagnosticMetadata<'ast> {\n     currently_processing_generics: bool,\n \n     /// The current enclosing function (used for better errors).\n-    current_function: Option<Span>,\n+    current_function: Option<(FnKind<'ast>, Span)>,\n \n     /// A list of labels as of yet unused. Labels will be removed from this map when\n     /// they are used (in a `break` or `continue` statement)\n@@ -466,7 +466,8 @@ impl<'a, 'ast> Visitor<'ast> for LateResolutionVisitor<'a, '_, 'ast> {\n             FnKind::Fn(FnCtxt::Free | FnCtxt::Foreign, ..) => FnItemRibKind,\n             FnKind::Fn(FnCtxt::Assoc(_), ..) | FnKind::Closure(..) => NormalRibKind,\n         };\n-        let previous_value = replace(&mut self.diagnostic_metadata.current_function, Some(sp));\n+        let previous_value =\n+            replace(&mut self.diagnostic_metadata.current_function, Some((fn_kind, sp)));\n         debug!(\"(resolving function) entering function\");\n         let declaration = fn_kind.decl();\n "}, {"sha": "b1a1f8725a1801024674d10a4c247696b226a1be", "filename": "src/librustc_resolve/late/diagnostics.rs", "status": "modified", "additions": 9, "deletions": 2, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/65607fbf98caa02554af549acf1293a793734683/src%2Flibrustc_resolve%2Flate%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/65607fbf98caa02554af549acf1293a793734683/src%2Flibrustc_resolve%2Flate%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_resolve%2Flate%2Fdiagnostics.rs?ref=65607fbf98caa02554af549acf1293a793734683", "patch": "@@ -195,8 +195,15 @@ impl<'a> LateResolutionVisitor<'a, '_, '_> {\n                 _ => \"`self` value is a keyword only available in methods with a `self` parameter\"\n                      .to_string(),\n             });\n-            if let Some(span) = &self.diagnostic_metadata.current_function {\n-                err.span_label(*span, \"this function doesn't have a `self` parameter\");\n+            if let Some((fn_kind, span)) = &self.diagnostic_metadata.current_function {\n+                // The current function has a `self' parameter, but we were unable to resolve\n+                // a reference to `self`. This can only happen if the `self` identifier we\n+                // are resolving came from a different hygiene context.\n+                if fn_kind.decl().inputs.get(0).map(|p| p.is_self()).unwrap_or(false) {\n+                    err.span_label(*span, \"this function has a `self` parameter, but a macro invocation can only access identifiers it receives from parameters\");\n+                } else {\n+                    err.span_label(*span, \"this function doesn't have a `self` parameter\");\n+                }\n             }\n             return (err, Vec::new());\n         }"}, {"sha": "f934f793c7f2707b70a0a0fbad20682302a71f76", "filename": "src/test/ui/hygiene/missing-self-diag.rs", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/65607fbf98caa02554af549acf1293a793734683/src%2Ftest%2Fui%2Fhygiene%2Fmissing-self-diag.rs", "raw_url": "https://github.com/rust-lang/rust/raw/65607fbf98caa02554af549acf1293a793734683/src%2Ftest%2Fui%2Fhygiene%2Fmissing-self-diag.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fhygiene%2Fmissing-self-diag.rs?ref=65607fbf98caa02554af549acf1293a793734683", "patch": "@@ -0,0 +1,23 @@\n+// Regression test for issue #66898\n+// Tests that we don't emit a nonsensical error message\n+// when a macro invocation tries to access `self` from a function\n+// that has a 'self' parameter\n+\n+pub struct Foo;\n+\n+macro_rules! call_bar {\n+    () => {\n+        self.bar(); //~ ERROR expected value\n+    }\n+}\n+\n+impl Foo {\n+    pub fn foo(&self) {\n+        call_bar!();\n+    }\n+\n+    pub fn bar(&self) {\n+    }\n+}\n+\n+fn main() {}"}, {"sha": "075d6b76bb7b2bf017af7ed88353ed3e7dfc3ce9", "filename": "src/test/ui/hygiene/missing-self-diag.stderr", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/65607fbf98caa02554af549acf1293a793734683/src%2Ftest%2Fui%2Fhygiene%2Fmissing-self-diag.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/65607fbf98caa02554af549acf1293a793734683/src%2Ftest%2Fui%2Fhygiene%2Fmissing-self-diag.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fhygiene%2Fmissing-self-diag.stderr?ref=65607fbf98caa02554af549acf1293a793734683", "patch": "@@ -0,0 +1,17 @@\n+error[E0424]: expected value, found module `self`\n+  --> $DIR/missing-self-diag.rs:10:9\n+   |\n+LL |           self.bar();\n+   |           ^^^^ `self` value is a keyword only available in methods with a `self` parameter\n+...\n+LL | /     pub fn foo(&self) {\n+LL | |         call_bar!();\n+   | |         ------------ in this macro invocation\n+LL | |     }\n+   | |_____- this function has a `self` parameter, but a macro invocation can only access identifiers it receives from parameters\n+   |\n+   = note: this error originates in a macro (in Nightly builds, run with -Z macro-backtrace for more info)\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0424`."}]}