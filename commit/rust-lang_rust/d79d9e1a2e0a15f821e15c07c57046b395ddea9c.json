{"sha": "d79d9e1a2e0a15f821e15c07c57046b395ddea9c", "node_id": "C_kwDOAAsO6NoAKGQ3OWQ5ZTFhMmUwYTE1ZjgyMWUxNWMwN2M1NzA0NmIzOTVkZGVhOWM", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-08-10T09:29:19Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-08-10T09:29:19Z"}, "message": "Auto merge of #12990 - edwin0cheng:improve-ws, r=Veykril\n\nfix: Improve whitespace insertion in mbe\n\nRelated:  https://github.com/rust-lang/rust-analyzer/issues/12260#issuecomment-1126957162", "tree": {"sha": "e48b777ceb72a7d9d8d87738dce7017034880e4a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e48b777ceb72a7d9d8d87738dce7017034880e4a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d79d9e1a2e0a15f821e15c07c57046b395ddea9c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d79d9e1a2e0a15f821e15c07c57046b395ddea9c", "html_url": "https://github.com/rust-lang/rust/commit/d79d9e1a2e0a15f821e15c07c57046b395ddea9c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d79d9e1a2e0a15f821e15c07c57046b395ddea9c/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5366009fe47ab06e53b68811873448de52c5cd8f", "url": "https://api.github.com/repos/rust-lang/rust/commits/5366009fe47ab06e53b68811873448de52c5cd8f", "html_url": "https://github.com/rust-lang/rust/commit/5366009fe47ab06e53b68811873448de52c5cd8f"}, {"sha": "c47914c6cfbce6e99bdeb5b8183b9655673b1110", "url": "https://api.github.com/repos/rust-lang/rust/commits/c47914c6cfbce6e99bdeb5b8183b9655673b1110", "html_url": "https://github.com/rust-lang/rust/commit/c47914c6cfbce6e99bdeb5b8183b9655673b1110"}], "stats": {"total": 61, "additions": 28, "deletions": 33}, "files": [{"sha": "457e43925c635367f615391ffc04cb06e99df9d9", "filename": "crates/hir-def/src/macro_expansion_tests/mbe.rs", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/d79d9e1a2e0a15f821e15c07c57046b395ddea9c/crates%2Fhir-def%2Fsrc%2Fmacro_expansion_tests%2Fmbe.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d79d9e1a2e0a15f821e15c07c57046b395ddea9c/crates%2Fhir-def%2Fsrc%2Fmacro_expansion_tests%2Fmbe.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-def%2Fsrc%2Fmacro_expansion_tests%2Fmbe.rs?ref=d79d9e1a2e0a15f821e15c07c57046b395ddea9c", "patch": "@@ -885,7 +885,7 @@ macro_rules! m {\n     ($t:ty) => ( fn bar() -> $ t {} )\n }\n \n-fn bar() -> & 'a Baz<u8> {}\n+fn bar() -> &'a Baz<u8> {}\n \n fn bar() -> extern \"Rust\"fn() -> Ret {}\n \"#]],\n@@ -1578,7 +1578,7 @@ macro_rules !register_methods {\n             ($$($val: expr), *) = > {\n                 struct Foo;\n                 impl Foo {\n-                    $(fn $method()-> & 'static[u32] {\n+                    $(fn $method()-> &'static[u32] {\n                         &[$$($$val), *]\n                     }\n                     )*\n@@ -1591,21 +1591,21 @@ macro_rules !implement_methods {\n     ($($val: expr), *) = > {\n         struct Foo;\n         impl Foo {\n-            fn alpha()-> & 'static[u32] {\n+            fn alpha()-> &'static[u32] {\n                 &[$($val), *]\n             }\n-            fn beta()-> & 'static[u32] {\n+            fn beta()-> &'static[u32] {\n                 &[$($val), *]\n             }\n         }\n     }\n }\n struct Foo;\n impl Foo {\n-    fn alpha() -> & 'static[u32] {\n+    fn alpha() -> &'static[u32] {\n         &[1, 2, 3]\n     }\n-    fn beta() -> & 'static[u32] {\n+    fn beta() -> &'static[u32] {\n         &[1, 2, 3]\n     }\n }"}, {"sha": "d2505e7cafe53657ba29f6d0c140d442ee0f9799", "filename": "crates/hir-def/src/macro_expansion_tests/mbe/regression.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/d79d9e1a2e0a15f821e15c07c57046b395ddea9c/crates%2Fhir-def%2Fsrc%2Fmacro_expansion_tests%2Fmbe%2Fregression.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d79d9e1a2e0a15f821e15c07c57046b395ddea9c/crates%2Fhir-def%2Fsrc%2Fmacro_expansion_tests%2Fmbe%2Fregression.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-def%2Fsrc%2Fmacro_expansion_tests%2Fmbe%2Fregression.rs?ref=d79d9e1a2e0a15f821e15c07c57046b395ddea9c", "patch": "@@ -166,7 +166,7 @@ macro_rules! int_base {\n     }\n }\n #[stable(feature = \"rust1\", since = \"1.0.0\")] impl fmt::Binary for isize {\n-    fn fmt(&self , f: &mut fmt::Formatter< '_>) -> fmt::Result {\n+    fn fmt(&self , f: &mut fmt::Formatter<'_>) -> fmt::Result {\n         Binary.fmt_int(*self as usize, f)\n     }\n }\n@@ -724,7 +724,7 @@ macro_rules! delegate_impl {\n         }\n     }\n }\n-impl <> Data for & 'amut G where G: Data {}\n+impl <> Data for &'amut G where G: Data {}\n \"##]],\n     );\n }"}, {"sha": "b8d2ca687c9e0ef201948ae804217ee01306472b", "filename": "crates/hir-def/src/macro_expansion_tests/mbe/tt_conversion.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d79d9e1a2e0a15f821e15c07c57046b395ddea9c/crates%2Fhir-def%2Fsrc%2Fmacro_expansion_tests%2Fmbe%2Ftt_conversion.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d79d9e1a2e0a15f821e15c07c57046b395ddea9c/crates%2Fhir-def%2Fsrc%2Fmacro_expansion_tests%2Fmbe%2Ftt_conversion.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-def%2Fsrc%2Fmacro_expansion_tests%2Fmbe%2Ftt_conversion.rs?ref=d79d9e1a2e0a15f821e15c07c57046b395ddea9c", "patch": "@@ -78,7 +78,7 @@ m!(static bar: &'static str = \"hello\";);\n macro_rules! m {\n     ($($t:tt)*) => { $($t)*}\n }\n-static bar: & 'static str = \"hello\";\n+static bar: &'static str = \"hello\";\n \"#]],\n     );\n }"}, {"sha": "029821e5e87f696ab6e57430dc497327c010a7d6", "filename": "crates/hir-def/src/macro_expansion_tests/proc_macros.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d79d9e1a2e0a15f821e15c07c57046b395ddea9c/crates%2Fhir-def%2Fsrc%2Fmacro_expansion_tests%2Fproc_macros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d79d9e1a2e0a15f821e15c07c57046b395ddea9c/crates%2Fhir-def%2Fsrc%2Fmacro_expansion_tests%2Fproc_macros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-def%2Fsrc%2Fmacro_expansion_tests%2Fproc_macros.rs?ref=d79d9e1a2e0a15f821e15c07c57046b395ddea9c", "patch": "@@ -87,7 +87,7 @@ fn foo() { bar.; blub }\n fn foo() { bar.; blub }\n \n fn foo() {\n-    bar. ;\n+    bar.;\n     blub\n }\"##]],\n     );"}, {"sha": "8befa7f7da7279e112671a53a47b95716a50a76a", "filename": "crates/hir-expand/src/builtin_fn_macro.rs", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/d79d9e1a2e0a15f821e15c07c57046b395ddea9c/crates%2Fhir-expand%2Fsrc%2Fbuiltin_fn_macro.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d79d9e1a2e0a15f821e15c07c57046b395ddea9c/crates%2Fhir-expand%2Fsrc%2Fbuiltin_fn_macro.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-expand%2Fsrc%2Fbuiltin_fn_macro.rs?ref=d79d9e1a2e0a15f821e15c07c57046b395ddea9c", "patch": "@@ -251,9 +251,13 @@ fn format_args_expand(\n     }\n     for arg in &mut args {\n         // Remove `key =`.\n-        if matches!(arg.token_trees.get(1), Some(tt::TokenTree::Leaf(tt::Leaf::Punct(p))) if p.char == '=' && p.spacing != tt::Spacing::Joint)\n+        if matches!(arg.token_trees.get(1), Some(tt::TokenTree::Leaf(tt::Leaf::Punct(p))) if p.char == '=')\n         {\n-            arg.token_trees.drain(..2);\n+            // but not with `==`\n+            if !matches!(arg.token_trees.get(2), Some(tt::TokenTree::Leaf(tt::Leaf::Punct(p))) if p.char == '=' )\n+            {\n+                arg.token_trees.drain(..2);\n+            }\n         }\n     }\n     let _format_string = args.remove(0);"}, {"sha": "893e6fe4b82408da9ef765eabfc3b90c9bca641e", "filename": "crates/hir-expand/src/fixup.rs", "status": "modified", "additions": 7, "deletions": 7, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/d79d9e1a2e0a15f821e15c07c57046b395ddea9c/crates%2Fhir-expand%2Fsrc%2Ffixup.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d79d9e1a2e0a15f821e15c07c57046b395ddea9c/crates%2Fhir-expand%2Fsrc%2Ffixup.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-expand%2Fsrc%2Ffixup.rs?ref=d79d9e1a2e0a15f821e15c07c57046b395ddea9c", "patch": "@@ -468,7 +468,7 @@ fn foo() {\n }\n \"#,\n             expect![[r#\"\n-fn foo () {a . __ra_fixup}\n+fn foo () {a .__ra_fixup}\n \"#]],\n         )\n     }\n@@ -478,11 +478,11 @@ fn foo () {a . __ra_fixup}\n         check(\n             r#\"\n fn foo() {\n-    a. ;\n+    a.;\n }\n \"#,\n             expect![[r#\"\n-fn foo () {a . __ra_fixup ;}\n+fn foo () {a .__ra_fixup ;}\n \"#]],\n         )\n     }\n@@ -492,12 +492,12 @@ fn foo () {a . __ra_fixup ;}\n         check(\n             r#\"\n fn foo() {\n-    a. ;\n+    a.;\n     bar();\n }\n \"#,\n             expect![[r#\"\n-fn foo () {a . __ra_fixup ; bar () ;}\n+fn foo () {a .__ra_fixup ; bar () ;}\n \"#]],\n         )\n     }\n@@ -525,7 +525,7 @@ fn foo() {\n }\n \"#,\n             expect![[r#\"\n-fn foo () {let x = a . __ra_fixup ;}\n+fn foo () {let x = a .__ra_fixup ;}\n \"#]],\n         )\n     }\n@@ -541,7 +541,7 @@ fn foo() {\n }\n \"#,\n             expect![[r#\"\n-fn foo () {a . b ; bar () ;}\n+fn foo () {a .b ; bar () ;}\n \"#]],\n         )\n     }"}, {"sha": "62cf5ab4f37a187546e5359ffc71d7e0a9e09713", "filename": "crates/ide-assists/src/handlers/add_missing_impl_members.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d79d9e1a2e0a15f821e15c07c57046b395ddea9c/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fadd_missing_impl_members.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d79d9e1a2e0a15f821e15c07c57046b395ddea9c/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fadd_missing_impl_members.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fadd_missing_impl_members.rs?ref=d79d9e1a2e0a15f821e15c07c57046b395ddea9c", "patch": "@@ -944,7 +944,7 @@ foo!();\n struct Foo(usize);\n \n impl FooB for Foo {\n-    $0fn foo< 'lt>(& 'lt self){}\n+    $0fn foo<'lt>(&'lt self){}\n }\n \"#,\n         )"}, {"sha": "e4c56565b92d4c6627406b0f762321aa7c89a898", "filename": "crates/mbe/src/syntax_bridge.rs", "status": "modified", "additions": 1, "deletions": 10, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/d79d9e1a2e0a15f821e15c07c57046b395ddea9c/crates%2Fmbe%2Fsrc%2Fsyntax_bridge.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d79d9e1a2e0a15f821e15c07c57046b395ddea9c/crates%2Fmbe%2Fsrc%2Fsyntax_bridge.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fmbe%2Fsrc%2Fsyntax_bridge.rs?ref=d79d9e1a2e0a15f821e15c07c57046b395ddea9c", "patch": "@@ -228,16 +228,7 @@ fn convert_tokens<C: TokenConvertor>(conv: &mut C) -> tt::Subtree {\n             }\n \n             let spacing = match conv.peek().map(|next| next.kind(conv)) {\n-                Some(kind)\n-                    if !kind.is_trivia()\n-                        && kind.is_punct()\n-                        && kind != T!['[']\n-                        && kind != T!['{']\n-                        && kind != T!['(']\n-                        && kind != UNDERSCORE =>\n-                {\n-                    tt::Spacing::Joint\n-                }\n+                Some(kind) if !kind.is_trivia() => tt::Spacing::Joint,\n                 _ => tt::Spacing::Alone,\n             };\n             let char = match token.to_char(conv) {"}, {"sha": "6339d56d01791dcfc359bd53f74a0dccad8fb59b", "filename": "crates/proc-macro-srv/src/tests/mod.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/d79d9e1a2e0a15f821e15c07c57046b395ddea9c/crates%2Fproc-macro-srv%2Fsrc%2Ftests%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d79d9e1a2e0a15f821e15c07c57046b395ddea9c/crates%2Fproc-macro-srv%2Fsrc%2Ftests%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproc-macro-srv%2Fsrc%2Ftests%2Fmod.rs?ref=d79d9e1a2e0a15f821e15c07c57046b395ddea9c", "patch": "@@ -19,7 +19,7 @@ fn test_derive_error() {\n         expect![[r##\"\n             SUBTREE $\n               IDENT   compile_error 4294967295\n-              PUNCH   ! [alone] 4294967295\n+              PUNCH   ! [joint] 4294967295\n               SUBTREE () 4294967295\n                 LITERAL \"#[derive(DeriveError)] struct S ;\" 4294967295\n               PUNCH   ; [alone] 4294967295\"##]],\n@@ -109,7 +109,7 @@ fn test_fn_like_macro_clone_literals() {\n               PUNCH   , [alone] 4294967295\n               LITERAL 2_u32 4294967295\n               PUNCH   , [alone] 4294967295\n-              PUNCH   - [alone] 4294967295\n+              PUNCH   - [joint] 4294967295\n               LITERAL 4i64 4294967295\n               PUNCH   , [alone] 4294967295\n               LITERAL 3.14f32 4294967295\n@@ -130,7 +130,7 @@ fn test_attr_macro() {\n         expect![[r##\"\n             SUBTREE $\n               IDENT   compile_error 4294967295\n-              PUNCH   ! [alone] 4294967295\n+              PUNCH   ! [joint] 4294967295\n               SUBTREE () 4294967295\n                 LITERAL \"#[attr_error(some arguments)] mod m {}\" 4294967295\n               PUNCH   ; [alone] 4294967295\"##]],"}]}