{"sha": "4fbc4b935679c142a6b45d9ebaf27e05254e8081", "node_id": "C_kwDOAAsO6NoAKDRmYmM0YjkzNTY3OWMxNDJhNmI0NWQ5ZWJhZjI3ZTA1MjU0ZTgwODE", "commit": {"author": {"name": "Jake Heinz", "email": "jh@discordapp.com", "date": "2021-11-17T05:49:27Z"}, "committer": {"name": "Jake Heinz", "email": "jh@discordapp.com", "date": "2021-11-17T05:49:27Z"}, "message": "hir: show const value in hover", "tree": {"sha": "512ff290010e501494ddb29163e6f5520cdeff1d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/512ff290010e501494ddb29163e6f5520cdeff1d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4fbc4b935679c142a6b45d9ebaf27e05254e8081", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4fbc4b935679c142a6b45d9ebaf27e05254e8081", "html_url": "https://github.com/rust-lang/rust/commit/4fbc4b935679c142a6b45d9ebaf27e05254e8081", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4fbc4b935679c142a6b45d9ebaf27e05254e8081/comments", "author": {"login": "jhgg", "id": 5489149, "node_id": "MDQ6VXNlcjU0ODkxNDk=", "avatar_url": "https://avatars.githubusercontent.com/u/5489149?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jhgg", "html_url": "https://github.com/jhgg", "followers_url": "https://api.github.com/users/jhgg/followers", "following_url": "https://api.github.com/users/jhgg/following{/other_user}", "gists_url": "https://api.github.com/users/jhgg/gists{/gist_id}", "starred_url": "https://api.github.com/users/jhgg/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jhgg/subscriptions", "organizations_url": "https://api.github.com/users/jhgg/orgs", "repos_url": "https://api.github.com/users/jhgg/repos", "events_url": "https://api.github.com/users/jhgg/events{/privacy}", "received_events_url": "https://api.github.com/users/jhgg/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jhgg", "id": 5489149, "node_id": "MDQ6VXNlcjU0ODkxNDk=", "avatar_url": "https://avatars.githubusercontent.com/u/5489149?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jhgg", "html_url": "https://github.com/jhgg", "followers_url": "https://api.github.com/users/jhgg/followers", "following_url": "https://api.github.com/users/jhgg/following{/other_user}", "gists_url": "https://api.github.com/users/jhgg/gists{/gist_id}", "starred_url": "https://api.github.com/users/jhgg/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jhgg/subscriptions", "organizations_url": "https://api.github.com/users/jhgg/orgs", "repos_url": "https://api.github.com/users/jhgg/repos", "events_url": "https://api.github.com/users/jhgg/events{/privacy}", "received_events_url": "https://api.github.com/users/jhgg/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "add6cccd4c923fbb5c83cc27b06aa84b2cbc9557", "url": "https://api.github.com/repos/rust-lang/rust/commits/add6cccd4c923fbb5c83cc27b06aa84b2cbc9557", "html_url": "https://github.com/rust-lang/rust/commit/add6cccd4c923fbb5c83cc27b06aa84b2cbc9557"}], "stats": {"total": 70, "additions": 42, "deletions": 28}, "files": [{"sha": "4c37d17aa4d208b1f26fb4cd85da56ea25b11e47", "filename": "crates/hir/src/display.rs", "status": "modified", "additions": 11, "deletions": 1, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/4fbc4b935679c142a6b45d9ebaf27e05254e8081/crates%2Fhir%2Fsrc%2Fdisplay.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4fbc4b935679c142a6b45d9ebaf27e05254e8081/crates%2Fhir%2Fsrc%2Fdisplay.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir%2Fsrc%2Fdisplay.rs?ref=4fbc4b935679c142a6b45d9ebaf27e05254e8081", "patch": "@@ -401,14 +401,24 @@ fn write_where_clause(def: GenericDefId, f: &mut HirFormatter) -> Result<(), Hir\n \n impl HirDisplay for Const {\n     fn hir_fmt(&self, f: &mut HirFormatter) -> Result<(), HirDisplayError> {\n-        write_visibility(self.module(f.db).id, self.visibility(f.db), f)?;\n+        let module_id = self.module(f.db).id;\n+        write_visibility(module_id, self.visibility(f.db), f)?;\n         let data = f.db.const_data(self.id);\n         write!(f, \"const \")?;\n         match &data.name {\n             Some(name) => write!(f, \"{}: \", name)?,\n             None => write!(f, \"_: \")?,\n         }\n         data.type_ref.hir_fmt(f)?;\n+        let ast_id_map = f.db.ast_id_map(data.file_id);\n+        let ast_node = ast_id_map.get(data.ast_id);\n+        if let Some(syntax_node) = f.db.parse_or_expand(data.file_id) {\n+            let ast_node = ast_node.to_node(&syntax_node);\n+            if let Some(body) = ast_node.body() {\n+                write!(f, \" = {}\", body)?;\n+            }\n+        }\n+\n         Ok(())\n     }\n }"}, {"sha": "6f071164989b4c3a47578b833b81151f1a6b4cd0", "filename": "crates/hir_def/src/data.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/4fbc4b935679c142a6b45d9ebaf27e05254e8081/crates%2Fhir_def%2Fsrc%2Fdata.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4fbc4b935679c142a6b45d9ebaf27e05254e8081/crates%2Fhir_def%2Fsrc%2Fdata.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fdata.rs?ref=4fbc4b935679c142a6b45d9ebaf27e05254e8081", "patch": "@@ -2,7 +2,7 @@\n \n use std::sync::Arc;\n \n-use hir_expand::{name::Name, InFile};\n+use hir_expand::{ast_id_map::FileAstId, name::Name, HirFileId, InFile};\n use syntax::ast;\n \n use crate::{\n@@ -255,6 +255,8 @@ pub struct ConstData {\n     pub name: Option<Name>,\n     pub type_ref: Interned<TypeRef>,\n     pub visibility: RawVisibility,\n+    pub ast_id: FileAstId<ast::Const>,\n+    pub file_id: HirFileId,\n }\n \n impl ConstData {\n@@ -267,6 +269,8 @@ impl ConstData {\n             name: konst.name.clone(),\n             type_ref: konst.type_ref.clone(),\n             visibility: item_tree[konst.visibility].clone(),\n+            ast_id: konst.ast_id.clone(),\n+            file_id: loc.id.file_id(),\n         })\n     }\n }"}, {"sha": "329e6b177f40b5db3718bc35313190cfcfd8fa92", "filename": "crates/ide/src/hover/tests.rs", "status": "modified", "additions": 26, "deletions": 26, "changes": 52, "blob_url": "https://github.com/rust-lang/rust/blob/4fbc4b935679c142a6b45d9ebaf27e05254e8081/crates%2Fide%2Fsrc%2Fhover%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4fbc4b935679c142a6b45d9ebaf27e05254e8081/crates%2Fide%2Fsrc%2Fhover%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fhover%2Ftests.rs?ref=4fbc4b935679c142a6b45d9ebaf27e05254e8081", "patch": "@@ -503,16 +503,16 @@ fn hover_const_static() {\n     check(\n         r#\"const foo$0: u32 = 123;\"#,\n         expect![[r#\"\n-                *foo*\n+            *foo*\n \n-                ```rust\n-                test\n-                ```\n+            ```rust\n+            test\n+            ```\n \n-                ```rust\n-                const foo: u32\n-                ```\n-            \"#]],\n+            ```rust\n+            const foo: u32 = 123\n+            ```\n+        \"#]],\n     );\n     check(\n         r#\"static foo$0: u32 = 456;\"#,\n@@ -788,16 +788,16 @@ fn main() {\n }\n \"#,\n         expect![[r#\"\n-                *C*\n+            *C*\n \n-                ```rust\n-                test\n-                ```\n+            ```rust\n+            test\n+            ```\n \n-                ```rust\n-                const C: u32\n-                ```\n-            \"#]],\n+            ```rust\n+            const C: u32 = 1\n+            ```\n+        \"#]],\n     )\n }\n \n@@ -3176,20 +3176,20 @@ fn foo() {\n }\n \"#,\n         expect![[r#\"\n-                *FOO*\n+            *FOO*\n \n-                ```rust\n-                test\n-                ```\n+            ```rust\n+            test\n+            ```\n \n-                ```rust\n-                const FOO: usize\n-                ```\n+            ```rust\n+            const FOO: usize = 3\n+            ```\n \n-                ---\n+            ---\n \n-                This is a doc\n-            \"#]],\n+            This is a doc\n+        \"#]],\n     );\n }\n "}]}