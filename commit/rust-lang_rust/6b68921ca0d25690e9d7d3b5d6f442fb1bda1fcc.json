{"sha": "6b68921ca0d25690e9d7d3b5d6f442fb1bda1fcc", "node_id": "C_kwDOAAsO6NoAKDZiNjg5MjFjYTBkMjU2OTBlOWQ3ZDNiNWQ2ZjQ0MmZiMWJkYTFmY2M", "commit": {"author": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2022-08-06T15:04:52Z"}, "committer": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2022-08-06T17:05:38Z"}, "message": "Change implementation of `-Z gcc-ld` and `lld-wrapper` again", "tree": {"sha": "21fc0ac01b870ebcbdff092f7ae7cc34c1a5d076", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/21fc0ac01b870ebcbdff092f7ae7cc34c1a5d076"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6b68921ca0d25690e9d7d3b5d6f442fb1bda1fcc", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6b68921ca0d25690e9d7d3b5d6f442fb1bda1fcc", "html_url": "https://github.com/rust-lang/rust/commit/6b68921ca0d25690e9d7d3b5d6f442fb1bda1fcc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6b68921ca0d25690e9d7d3b5d6f442fb1bda1fcc/comments", "author": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "committer": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "76b04847400effd127ced322d5627c0c1aec2998", "url": "https://api.github.com/repos/rust-lang/rust/commits/76b04847400effd127ced322d5627c0c1aec2998", "html_url": "https://github.com/rust-lang/rust/commit/76b04847400effd127ced322d5627c0c1aec2998"}], "stats": {"total": 81, "additions": 48, "deletions": 33}, "files": [{"sha": "085057c3bf3fa0b0b38bd95ccace05236551f45c", "filename": "compiler/rustc_codegen_ssa/src/back/link.rs", "status": "modified", "additions": 18, "deletions": 14, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/6b68921ca0d25690e9d7d3b5d6f442fb1bda1fcc/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6b68921ca0d25690e9d7d3b5d6f442fb1bda1fcc/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs?ref=6b68921ca0d25690e9d7d3b5d6f442fb1bda1fcc", "patch": "@@ -2777,20 +2777,24 @@ fn add_gcc_ld_path(cmd: &mut dyn Linker, sess: &Session, flavor: LinkerFlavor) {\n         if let LinkerFlavor::Gcc = flavor {\n             match ld_impl {\n                 LdImpl::Lld => {\n-                    let tools_path = sess.get_tools_search_paths(false);\n-                    let gcc_ld_dir = tools_path\n-                        .into_iter()\n-                        .map(|p| p.join(\"gcc-ld\"))\n-                        .find(|p| {\n-                            p.join(if sess.host.is_like_windows { \"ld.exe\" } else { \"ld\" }).exists()\n-                        })\n-                        .unwrap_or_else(|| sess.fatal(\"rust-lld (as ld) not found\"));\n-                    cmd.arg({\n-                        let mut arg = OsString::from(\"-B\");\n-                        arg.push(gcc_ld_dir);\n-                        arg\n-                    });\n-                    cmd.arg(format!(\"-Wl,-rustc-lld-flavor={}\", sess.target.lld_flavor.as_str()));\n+                    // Implement the \"self-contained\" part of -Zgcc-ld\n+                    // by adding rustc distribution directories to the tool search path.\n+                    for path in sess.get_tools_search_paths(false) {\n+                        cmd.arg({\n+                            let mut arg = OsString::from(\"-B\");\n+                            arg.push(path.join(\"gcc-ld\"));\n+                            arg\n+                        });\n+                    }\n+                    // Implement the \"linker flavor\" part of -Zgcc-ld\n+                    // by asking cc to use some kind of lld.\n+                    cmd.arg(\"-fuse-ld=lld\");\n+                    if sess.target.lld_flavor != LldFlavor::Ld {\n+                        // Tell clang to use a non-default LLD flavor.\n+                        // Gcc doesn't understand the target option, but we currently assume\n+                        // that gcc is not used for Apple and Wasm targets (#97402).\n+                        cmd.arg(format!(\"--target={}\", sess.target.llvm_target));\n+                    }\n                 }\n             }\n         } else {"}, {"sha": "0d89e0a4f25c9036df7f3ed44eb30b8deb1118fe", "filename": "src/bootstrap/compile.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/6b68921ca0d25690e9d7d3b5d6f442fb1bda1fcc/src%2Fbootstrap%2Fcompile.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6b68921ca0d25690e9d7d3b5d6f442fb1bda1fcc/src%2Fbootstrap%2Fcompile.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcompile.rs?ref=6b68921ca0d25690e9d7d3b5d6f442fb1bda1fcc", "patch": "@@ -1276,7 +1276,9 @@ impl Step for Assemble {\n                 compiler: build_compiler,\n                 target: target_compiler.host,\n             });\n-            builder.copy(&lld_wrapper_exe, &gcc_ld_dir.join(exe(\"ld\", target_compiler.host)));\n+            for name in crate::LLD_FILE_NAMES {\n+                builder.copy(&lld_wrapper_exe, &gcc_ld_dir.join(exe(name, target_compiler.host)));\n+            }\n         }\n \n         if builder.config.rust_codegen_backends.contains(&INTERNER.intern_str(\"llvm\")) {"}, {"sha": "31f71759e249e7bb5d2e17e65abf7dbdba39cfbe", "filename": "src/bootstrap/dist.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/6b68921ca0d25690e9d7d3b5d6f442fb1bda1fcc/src%2Fbootstrap%2Fdist.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6b68921ca0d25690e9d7d3b5d6f442fb1bda1fcc/src%2Fbootstrap%2Fdist.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fdist.rs?ref=6b68921ca0d25690e9d7d3b5d6f442fb1bda1fcc", "patch": "@@ -423,8 +423,11 @@ impl Step for Rustc {\n                 let gcc_lld_src_dir = src_dir.join(\"gcc-ld\");\n                 let gcc_lld_dst_dir = dst_dir.join(\"gcc-ld\");\n                 t!(fs::create_dir(&gcc_lld_dst_dir));\n-                let exe_name = exe(\"ld\", compiler.host);\n-                builder.copy(&gcc_lld_src_dir.join(&exe_name), &gcc_lld_dst_dir.join(&exe_name));\n+                for name in crate::LLD_FILE_NAMES {\n+                    let exe_name = exe(name, compiler.host);\n+                    builder\n+                        .copy(&gcc_lld_src_dir.join(&exe_name), &gcc_lld_dst_dir.join(&exe_name));\n+                }\n             }\n \n             // Man pages"}, {"sha": "797e84673317612ba7015cf041ad265d0ffe73b8", "filename": "src/bootstrap/lib.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/6b68921ca0d25690e9d7d3b5d6f442fb1bda1fcc/src%2Fbootstrap%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6b68921ca0d25690e9d7d3b5d6f442fb1bda1fcc/src%2Fbootstrap%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Flib.rs?ref=6b68921ca0d25690e9d7d3b5d6f442fb1bda1fcc", "patch": "@@ -186,6 +186,9 @@ const LLVM_TOOLS: &[&str] = &[\n     \"opt\",           // used to optimize LLVM bytecode\n ];\n \n+/// LLD file names for all flavors.\n+const LLD_FILE_NAMES: &[&str] = &[\"ld.lld\", \"ld64.lld\", \"lld-link\", \"wasm-ld\"];\n+\n pub const VERSION: usize = 2;\n \n /// Extra --check-cfg to add when building"}, {"sha": "1795f3d7fe5bc5a3a0a9b908f333681274971dbb", "filename": "src/tools/lld-wrapper/src/main.rs", "status": "modified", "additions": 19, "deletions": 16, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/6b68921ca0d25690e9d7d3b5d6f442fb1bda1fcc/src%2Ftools%2Flld-wrapper%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6b68921ca0d25690e9d7d3b5d6f442fb1bda1fcc/src%2Ftools%2Flld-wrapper%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Flld-wrapper%2Fsrc%2Fmain.rs?ref=6b68921ca0d25690e9d7d3b5d6f442fb1bda1fcc", "patch": "@@ -8,8 +8,8 @@\n //! make gcc/clang pass `-flavor <flavor>` as the first two arguments in the linker invocation\n //! and since Windows does not support symbolic links for files this wrapper is used in place of a\n //! symbolic link. It execs `../rust-lld -flavor <flavor>` by propagating the flavor argument\n-//! passed to the wrapper as the first two arguments. On Windows it spawns a `..\\rust-lld.exe`\n-//! child process.\n+//! obtained from the wrapper's name as the first two arguments.\n+//! On Windows it spawns a `..\\rust-lld.exe` child process.\n \n use std::fmt::Display;\n use std::path::{Path, PathBuf};\n@@ -53,29 +53,32 @@ fn get_rust_lld_path(current_exe_path: &Path) -> PathBuf {\n     rust_lld_path\n }\n \n+/// Extract LLD flavor name from the lld-wrapper executable name.\n+fn get_lld_flavor(current_exe_path: &Path) -> Result<&'static str, String> {\n+    let stem = current_exe_path.file_stem();\n+    Ok(match stem.and_then(|s| s.to_str()) {\n+        Some(\"ld.lld\") => \"gnu\",\n+        Some(\"ld64.lld\") => \"darwin\",\n+        Some(\"lld-link\") => \"link\",\n+        Some(\"wasm-ld\") => \"wasm\",\n+        _ => return Err(format!(\"{:?}\", stem)),\n+    })\n+}\n+\n /// Returns the command for invoking rust-lld with the correct flavor.\n-/// LLD only accepts the flavor argument at the first two arguments, so move it there.\n+/// LLD only accepts the flavor argument at the first two arguments, so pass it there.\n ///\n /// Exits on error.\n fn get_rust_lld_command(current_exe_path: &Path) -> process::Command {\n     let rust_lld_path = get_rust_lld_path(current_exe_path);\n     let mut command = process::Command::new(rust_lld_path);\n \n-    let mut flavor = None;\n-    let args = env::args_os()\n-        .skip(1)\n-        .filter(|arg| match arg.to_str().and_then(|s| s.strip_prefix(\"-rustc-lld-flavor=\")) {\n-            Some(suffix) => {\n-                flavor = Some(suffix.to_string());\n-                false\n-            }\n-            None => true,\n-        })\n-        .collect::<Vec<_>>();\n+    let flavor =\n+        get_lld_flavor(current_exe_path).unwrap_or_exit_with(\"executable has unexpected name\");\n \n     command.arg(\"-flavor\");\n-    command.arg(flavor.unwrap_or_exit_with(\"-rustc-lld-flavor=<flavor> is not passed\"));\n-    command.args(args);\n+    command.arg(flavor);\n+    command.args(env::args_os().skip(1));\n     command\n }\n "}]}