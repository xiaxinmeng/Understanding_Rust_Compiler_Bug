{"sha": "8e93a48c32852b09f4270348883b61edba5bb068", "node_id": "C_kwDOAAsO6NoAKDhlOTNhNDhjMzI4NTJiMDlmNDI3MDM0ODg4M2I2MWVkYmE1YmIwNjg", "commit": {"author": {"name": "Eric Holk", "email": "ericholk@microsoft.com", "date": "2022-02-11T03:23:43Z"}, "committer": {"name": "Eric Holk", "email": "ericholk@microsoft.com", "date": "2022-03-07T16:47:18Z"}, "message": "Update and fix clippy tests", "tree": {"sha": "a597253d272083695b5a0721da3fd408eae210fd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a597253d272083695b5a0721da3fd408eae210fd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8e93a48c32852b09f4270348883b61edba5bb068", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8e93a48c32852b09f4270348883b61edba5bb068", "html_url": "https://github.com/rust-lang/rust/commit/8e93a48c32852b09f4270348883b61edba5bb068", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8e93a48c32852b09f4270348883b61edba5bb068/comments", "author": {"login": "eholk", "id": 105766, "node_id": "MDQ6VXNlcjEwNTc2Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/105766?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eholk", "html_url": "https://github.com/eholk", "followers_url": "https://api.github.com/users/eholk/followers", "following_url": "https://api.github.com/users/eholk/following{/other_user}", "gists_url": "https://api.github.com/users/eholk/gists{/gist_id}", "starred_url": "https://api.github.com/users/eholk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eholk/subscriptions", "organizations_url": "https://api.github.com/users/eholk/orgs", "repos_url": "https://api.github.com/users/eholk/repos", "events_url": "https://api.github.com/users/eholk/events{/privacy}", "received_events_url": "https://api.github.com/users/eholk/received_events", "type": "User", "site_admin": false}, "committer": {"login": "eholk", "id": 105766, "node_id": "MDQ6VXNlcjEwNTc2Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/105766?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eholk", "html_url": "https://github.com/eholk", "followers_url": "https://api.github.com/users/eholk/followers", "following_url": "https://api.github.com/users/eholk/following{/other_user}", "gists_url": "https://api.github.com/users/eholk/gists{/gist_id}", "starred_url": "https://api.github.com/users/eholk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eholk/subscriptions", "organizations_url": "https://api.github.com/users/eholk/orgs", "repos_url": "https://api.github.com/users/eholk/repos", "events_url": "https://api.github.com/users/eholk/events{/privacy}", "received_events_url": "https://api.github.com/users/eholk/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8fc835831c1a84ba27d8bbafec480f02b2e29663", "url": "https://api.github.com/repos/rust-lang/rust/commits/8fc835831c1a84ba27d8bbafec480f02b2e29663", "html_url": "https://github.com/rust-lang/rust/commit/8fc835831c1a84ba27d8bbafec480f02b2e29663"}], "stats": {"total": 29, "additions": 24, "deletions": 5}, "files": [{"sha": "ecc9acf4445d03681bfc1a0e28ce1257abf99974", "filename": "src/tools/clippy/clippy_lints/src/missing_const_for_fn.rs", "status": "modified", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/8e93a48c32852b09f4270348883b61edba5bb068/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmissing_const_for_fn.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8e93a48c32852b09f4270348883b61edba5bb068/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmissing_const_for_fn.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmissing_const_for_fn.rs?ref=8e93a48c32852b09f4270348883b61edba5bb068", "patch": "@@ -3,6 +3,7 @@ use clippy_utils::qualify_min_const_fn::is_min_const_fn;\n use clippy_utils::ty::has_drop;\n use clippy_utils::{fn_has_unsatisfiable_preds, is_entrypoint_fn, meets_msrv, msrvs, trait_ref_of_method};\n use rustc_hir as hir;\n+use rustc_hir::def_id::CRATE_DEF_ID;\n use rustc_hir::intravisit::FnKind;\n use rustc_hir::{Body, Constness, FnDecl, GenericParamKind, HirId};\n use rustc_lint::{LateContext, LateLintPass};\n@@ -131,6 +132,18 @@ impl<'tcx> LateLintPass<'tcx> for MissingConstForFn {\n             FnKind::Closure => return,\n         }\n \n+        // Const fns are not allowed as methods in a trait.\n+        {\n+            let parent = cx.tcx.hir().get_parent_item(hir_id);\n+            if parent != CRATE_DEF_ID {\n+                if let hir::Node::Item(item) = cx.tcx.hir().get_by_def_id(parent) {\n+                    if let hir::ItemKind::Trait(..) = &item.kind {\n+                        return;\n+                    }\n+                }\n+            }\n+        }\n+\n         let mir = cx.tcx.optimized_mir(def_id);\n \n         if let Err((span, err)) = is_min_const_fn(cx.tcx, mir, self.msrv.as_ref()) {"}, {"sha": "88f6935d224aec502122cc5ebf5e06d8b70a0a7f", "filename": "src/tools/clippy/tests/ui/missing_const_for_fn/could_be_const.rs", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/8e93a48c32852b09f4270348883b61edba5bb068/src%2Ftools%2Fclippy%2Ftests%2Fui%2Fmissing_const_for_fn%2Fcould_be_const.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8e93a48c32852b09f4270348883b61edba5bb068/src%2Ftools%2Fclippy%2Ftests%2Fui%2Fmissing_const_for_fn%2Fcould_be_const.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Ftests%2Fui%2Fmissing_const_for_fn%2Fcould_be_const.rs?ref=8e93a48c32852b09f4270348883b61edba5bb068", "patch": "@@ -49,8 +49,6 @@ fn sub(x: u32) -> usize {\n     unsafe { transmute(&x) }\n }\n \n-// NOTE: This is currently not yet allowed to be const\n-// Once implemented, Clippy should be able to suggest this as const, too.\n fn generic_arr<T: Copy>(t: [T; 1]) -> T {\n     t[0]\n }"}, {"sha": "3eb52b6827475d1b52f189cb0f876c68e6dc8191", "filename": "src/tools/clippy/tests/ui/missing_const_for_fn/could_be_const.stderr", "status": "modified", "additions": 11, "deletions": 3, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/8e93a48c32852b09f4270348883b61edba5bb068/src%2Ftools%2Fclippy%2Ftests%2Fui%2Fmissing_const_for_fn%2Fcould_be_const.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/8e93a48c32852b09f4270348883b61edba5bb068/src%2Ftools%2Fclippy%2Ftests%2Fui%2Fmissing_const_for_fn%2Fcould_be_const.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Ftests%2Fui%2Fmissing_const_for_fn%2Fcould_be_const.stderr?ref=8e93a48c32852b09f4270348883b61edba5bb068", "patch": "@@ -58,20 +58,28 @@ LL | | }\n    | |_^\n \n error: this could be a `const fn`\n-  --> $DIR/could_be_const.rs:67:9\n+  --> $DIR/could_be_const.rs:52:1\n+   |\n+LL | / fn generic_arr<T: Copy>(t: [T; 1]) -> T {\n+LL | |     t[0]\n+LL | | }\n+   | |_^\n+\n+error: this could be a `const fn`\n+  --> $DIR/could_be_const.rs:65:9\n    |\n LL | /         pub fn b(self, a: &A) -> B {\n LL | |             B\n LL | |         }\n    | |_________^\n \n error: this could be a `const fn`\n-  --> $DIR/could_be_const.rs:77:5\n+  --> $DIR/could_be_const.rs:75:5\n    |\n LL | /     fn const_fn_stabilized_before_msrv(byte: u8) {\n LL | |         byte.is_ascii_digit();\n LL | |     }\n    | |_____^\n \n-error: aborting due to 9 previous errors\n+error: aborting due to 10 previous errors\n "}]}