{"sha": "a1fd944eb83d23c3e7484850a1e7db275d38a58c", "node_id": "MDY6Q29tbWl0NzI0NzEyOmExZmQ5NDRlYjgzZDIzYzNlNzQ4NDg1MGExZTdkYjI3NWQzOGE1OGM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2015-11-02T21:56:47Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2015-11-02T21:56:47Z"}, "message": "Auto merge of #29456 - alexcrichton:path-hash, r=aturon\n\nAlmost all operations on Path are based on the components iterator in one form\r\nor another to handle equivalent paths. The `Hash` implementations, however,\r\nmistakenly just went straight to the underlying `OsStr`, causing these\r\nequivalent paths to not get merged together.\r\n\r\nThis commit updates the `Hash` implementation to also be based on the iterator\r\nwhich should ensure that if two paths are equal they hash to the same thing.\r\n\r\ncc #29008, but doesn't close it", "tree": {"sha": "da243dc0643a232337ddf8d9fe7f88b46d01969b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/da243dc0643a232337ddf8d9fe7f88b46d01969b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a1fd944eb83d23c3e7484850a1e7db275d38a58c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a1fd944eb83d23c3e7484850a1e7db275d38a58c", "html_url": "https://github.com/rust-lang/rust/commit/a1fd944eb83d23c3e7484850a1e7db275d38a58c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a1fd944eb83d23c3e7484850a1e7db275d38a58c/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2249b07ae988534a541be390d90396ed99b32955", "url": "https://api.github.com/repos/rust-lang/rust/commits/2249b07ae988534a541be390d90396ed99b32955", "html_url": "https://github.com/rust-lang/rust/commit/2249b07ae988534a541be390d90396ed99b32955"}, {"sha": "d2dd700891f25e71884276d47288f66e4745c5f9", "url": "https://api.github.com/repos/rust-lang/rust/commits/d2dd700891f25e71884276d47288f66e4745c5f9", "html_url": "https://github.com/rust-lang/rust/commit/d2dd700891f25e71884276d47288f66e4745c5f9"}], "stats": {"total": 40, "additions": 37, "deletions": 3}, "files": [{"sha": "f1422bb501aede54c87c0cab739042f4cf996410", "filename": "src/libstd/path.rs", "status": "modified", "additions": 37, "deletions": 3, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/a1fd944eb83d23c3e7484850a1e7db275d38a58c/src%2Flibstd%2Fpath.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a1fd944eb83d23c3e7484850a1e7db275d38a58c/src%2Flibstd%2Fpath.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fpath.rs?ref=a1fd944eb83d23c3e7484850a1e7db275d38a58c", "patch": "@@ -103,6 +103,7 @@ use borrow::{Borrow, IntoCow, ToOwned, Cow};\n use cmp;\n use fmt;\n use fs;\n+use hash::{Hash, Hasher};\n use io;\n use iter;\n use mem;\n@@ -446,7 +447,7 @@ enum State {\n ///\n /// Does not occur on Unix.\n #[stable(feature = \"rust1\", since = \"1.0.0\")]\n-#[derive(Copy, Clone, Eq, Hash, Debug)]\n+#[derive(Copy, Clone, Eq, Debug)]\n pub struct PrefixComponent<'a> {\n     /// The prefix as an unparsed `OsStr` slice.\n     raw: &'a OsStr,\n@@ -490,6 +491,13 @@ impl<'a> cmp::Ord for PrefixComponent<'a> {\n     }\n }\n \n+#[stable(feature = \"rust1\", since = \"1.0.0\")]\n+impl<'a> Hash for PrefixComponent<'a> {\n+    fn hash<H: Hasher>(&self, h: &mut H) {\n+        self.parsed.hash(h);\n+    }\n+}\n+\n /// A single component of a path.\n ///\n /// See the module documentation for an in-depth explanation of components and\n@@ -932,7 +940,7 @@ impl<'a> cmp::Ord for Components<'a> {\n /// path.push(\"system32\");\n /// path.set_extension(\"dll\");\n /// ```\n-#[derive(Clone, Hash)]\n+#[derive(Clone)]\n #[stable(feature = \"rust1\", since = \"1.0.0\")]\n pub struct PathBuf {\n     inner: OsString\n@@ -1171,6 +1179,13 @@ impl cmp::PartialEq for PathBuf {\n     }\n }\n \n+#[stable(feature = \"rust1\", since = \"1.0.0\")]\n+impl Hash for PathBuf {\n+    fn hash<H: Hasher>(&self, h: &mut H) {\n+        self.as_path().hash(h)\n+    }\n+}\n+\n #[stable(feature = \"rust1\", since = \"1.0.0\")]\n impl cmp::Eq for PathBuf {}\n \n@@ -1224,7 +1239,6 @@ impl Into<OsString> for PathBuf {\n /// let parent_dir = path.parent();\n /// ```\n ///\n-#[derive(Hash)]\n #[stable(feature = \"rust1\", since = \"1.0.0\")]\n pub struct Path {\n     inner: OsStr\n@@ -1809,6 +1823,15 @@ impl cmp::PartialEq for Path {\n     }\n }\n \n+#[stable(feature = \"rust1\", since = \"1.0.0\")]\n+impl Hash for Path {\n+    fn hash<H: Hasher>(&self, h: &mut H) {\n+        for component in self.components() {\n+            component.hash(h);\n+        }\n+    }\n+}\n+\n #[stable(feature = \"rust1\", since = \"1.0.0\")]\n impl cmp::Eq for Path {}\n \n@@ -3035,6 +3058,14 @@ mod tests {\n \n     #[test]\n     pub fn test_compare() {\n+        use hash::{Hash, Hasher, SipHasher};\n+\n+        fn hash<T: Hash>(t: T) -> u64 {\n+            let mut s = SipHasher::new_with_keys(0, 0);\n+            t.hash(&mut s);\n+            s.finish()\n+        }\n+\n         macro_rules! tc(\n             ($path1:expr, $path2:expr, eq: $eq:expr,\n              starts_with: $starts_with:expr, ends_with: $ends_with:expr,\n@@ -3045,6 +3076,9 @@ mod tests {\n                  let eq = path1 == path2;\n                  assert!(eq == $eq, \"{:?} == {:?}, expected {:?}, got {:?}\",\n                          $path1, $path2, $eq, eq);\n+                 assert!($eq == (hash(path1) == hash(path2)),\n+                         \"{:?} == {:?}, expected {:?}, got {} and {}\",\n+                         $path1, $path2, $eq, hash(path1), hash(path2));\n \n                  let starts_with = path1.starts_with(path2);\n                  assert!(starts_with == $starts_with,"}]}