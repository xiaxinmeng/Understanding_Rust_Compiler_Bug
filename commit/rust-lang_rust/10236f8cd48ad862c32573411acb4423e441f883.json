{"sha": "10236f8cd48ad862c32573411acb4423e441f883", "node_id": "MDY6Q29tbWl0NzI0NzEyOjEwMjM2ZjhjZDQ4YWQ4NjJjMzI1NzM0MTFhY2I0NDIzZTQ0MWY4ODM=", "commit": {"author": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2012-04-10T01:56:24Z"}, "committer": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2012-04-10T01:57:21Z"}, "message": "core: Make str::as_bytes handle failure. Closes #2156", "tree": {"sha": "e7854cb9daba48b19255e8198cc60191179db30a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e7854cb9daba48b19255e8198cc60191179db30a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/10236f8cd48ad862c32573411acb4423e441f883", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/10236f8cd48ad862c32573411acb4423e441f883", "html_url": "https://github.com/rust-lang/rust/commit/10236f8cd48ad862c32573411acb4423e441f883", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/10236f8cd48ad862c32573411acb4423e441f883/comments", "author": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "committer": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "59abf93b799a588e07060c7e4efd5f20cdce4293", "url": "https://api.github.com/repos/rust-lang/rust/commits/59abf93b799a588e07060c7e4efd5f20cdce4293", "html_url": "https://github.com/rust-lang/rust/commit/59abf93b799a588e07060c7e4efd5f20cdce4293"}], "stats": {"total": 24, "additions": 20, "deletions": 4}, "files": [{"sha": "8f9e2ab0f646d6ce4f3b3489a506aeae291a60c6", "filename": "src/libcore/str.rs", "status": "modified", "additions": 10, "deletions": 4, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/10236f8cd48ad862c32573411acb4423e441f883/src%2Flibcore%2Fstr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/10236f8cd48ad862c32573411acb4423e441f883/src%2Flibcore%2Fstr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fstr.rs?ref=10236f8cd48ad862c32573411acb4423e441f883", "patch": "@@ -1509,10 +1509,8 @@ let i = str::as_bytes(\\\"Hello World\\\") { |bytes| vec::len(bytes) };\n ~~~\n \"]\n fn as_bytes<T>(s: str, f: fn([u8]) -> T) -> T unsafe {\n-    let mut v: [u8] = ::unsafe::reinterpret_cast(s);\n-    let r = f(v);\n-    ::unsafe::forget(v);\n-    r\n+    let v: *[u8] = ::unsafe::reinterpret_cast(ptr::addr_of(s));\n+    f(*v)\n }\n \n #[doc = \"\n@@ -2449,6 +2447,14 @@ mod tests {\n         assert (c == \"AAA\");\n     }\n \n+    #[test]\n+    #[ignore(cfg(target_os = \"win32\"))]\n+    #[should_fail]\n+    fn test_as_bytes_fail() {\n+        // Don't double free\n+        as_bytes(\"\") {|_bytes| fail }\n+    }\n+\n     #[test]\n     fn test_as_buf() unsafe {\n         let a = \"Abcdefg\";"}, {"sha": "90ed994ee8f3c313a1adbbcd25f313df86ef1b90", "filename": "src/test/run-fail/issue-2156.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/10236f8cd48ad862c32573411acb4423e441f883/src%2Ftest%2Frun-fail%2Fissue-2156.rs", "raw_url": "https://github.com/rust-lang/rust/raw/10236f8cd48ad862c32573411acb4423e441f883/src%2Ftest%2Frun-fail%2Fissue-2156.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-fail%2Fissue-2156.rs?ref=10236f8cd48ad862c32573411acb4423e441f883", "patch": "@@ -0,0 +1,10 @@\n+// error-pattern:explicit failure\n+// Don't double free the string\n+use std;\n+import io::{reader, reader_util};\n+\n+fn main() {\n+    io::with_str_reader(\"\") { |rdr|\n+        alt rdr.read_char() { '=' { } _ { fail } }\n+    }\n+}"}]}