{"sha": "bec4fc175aaab3a9b633b99642aa8e96375d3e89", "node_id": "MDY6Q29tbWl0NzI0NzEyOmJlYzRmYzE3NWFhYWIzYTliNjMzYjk5NjQyYWE4ZTk2Mzc1ZDNlODk=", "commit": {"author": {"name": "Wesley Wiser", "email": "wwiser@gmail.com", "date": "2019-12-15T19:07:30Z"}, "committer": {"name": "Wesley Wiser", "email": "wwiser@gmail.com", "date": "2019-12-21T01:39:47Z"}, "message": "[mir-opt] Fix `Inline` pass to handle inlining into `box` expressions", "tree": {"sha": "448f3bfe3c2ad6eec1a0862b6b395aa7dc4a25a6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/448f3bfe3c2ad6eec1a0862b6b395aa7dc4a25a6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bec4fc175aaab3a9b633b99642aa8e96375d3e89", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bec4fc175aaab3a9b633b99642aa8e96375d3e89", "html_url": "https://github.com/rust-lang/rust/commit/bec4fc175aaab3a9b633b99642aa8e96375d3e89", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bec4fc175aaab3a9b633b99642aa8e96375d3e89/comments", "author": {"login": "wesleywiser", "id": 831192, "node_id": "MDQ6VXNlcjgzMTE5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/831192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wesleywiser", "html_url": "https://github.com/wesleywiser", "followers_url": "https://api.github.com/users/wesleywiser/followers", "following_url": "https://api.github.com/users/wesleywiser/following{/other_user}", "gists_url": "https://api.github.com/users/wesleywiser/gists{/gist_id}", "starred_url": "https://api.github.com/users/wesleywiser/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wesleywiser/subscriptions", "organizations_url": "https://api.github.com/users/wesleywiser/orgs", "repos_url": "https://api.github.com/users/wesleywiser/repos", "events_url": "https://api.github.com/users/wesleywiser/events{/privacy}", "received_events_url": "https://api.github.com/users/wesleywiser/received_events", "type": "User", "site_admin": false}, "committer": {"login": "wesleywiser", "id": 831192, "node_id": "MDQ6VXNlcjgzMTE5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/831192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wesleywiser", "html_url": "https://github.com/wesleywiser", "followers_url": "https://api.github.com/users/wesleywiser/followers", "following_url": "https://api.github.com/users/wesleywiser/following{/other_user}", "gists_url": "https://api.github.com/users/wesleywiser/gists{/gist_id}", "starred_url": "https://api.github.com/users/wesleywiser/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wesleywiser/subscriptions", "organizations_url": "https://api.github.com/users/wesleywiser/orgs", "repos_url": "https://api.github.com/users/wesleywiser/repos", "events_url": "https://api.github.com/users/wesleywiser/events{/privacy}", "received_events_url": "https://api.github.com/users/wesleywiser/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ccd238309f9dce92a05a23c2959e2819668c69a4", "url": "https://api.github.com/repos/rust-lang/rust/commits/ccd238309f9dce92a05a23c2959e2819668c69a4", "html_url": "https://github.com/rust-lang/rust/commit/ccd238309f9dce92a05a23c2959e2819668c69a4"}], "stats": {"total": 101, "additions": 91, "deletions": 10}, "files": [{"sha": "dca142279463c74f6500ea4663a06bb7bc01f43b", "filename": "src/librustc_mir/transform/inline.rs", "status": "modified", "additions": 20, "deletions": 10, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/bec4fc175aaab3a9b633b99642aa8e96375d3e89/src%2Flibrustc_mir%2Ftransform%2Finline.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bec4fc175aaab3a9b633b99642aa8e96375d3e89/src%2Flibrustc_mir%2Ftransform%2Finline.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Finline.rs?ref=bec4fc175aaab3a9b633b99642aa8e96375d3e89", "patch": "@@ -663,9 +663,9 @@ impl<'a, 'tcx> Integrator<'a, 'tcx> {\n \n     fn make_integrate_local(&self, local: &Local) -> Local {\n         if *local == RETURN_PLACE {\n-            match self.destination.as_local() {\n-                Some(l) => return l,\n-                ref place => bug!(\"Return place is {:?}, not local\", place),\n+            match self.destination.base {\n+                PlaceBase::Local(l) => return l,\n+                PlaceBase::Static(ref s) => bug!(\"Return place is {:?}, not local\", s),\n             }\n         }\n \n@@ -695,14 +695,24 @@ impl<'a, 'tcx> MutVisitor<'tcx> for Integrator<'a, 'tcx> {\n     fn visit_place(\n         &mut self,\n         place: &mut Place<'tcx>,\n-        context: PlaceContext,\n-        location: Location,\n+        _context: PlaceContext,\n+        _location: Location,\n     ) {\n-        if let Some(RETURN_PLACE) = place.as_local() {\n-            // Return pointer; update the place itself\n-            *place = self.destination.clone();\n-        } else {\n-            self.super_place(place, context, location);\n+        match &mut place.base {\n+            PlaceBase::Static(_) => {},\n+            PlaceBase::Local(l) => {\n+                // If this is the `RETURN_PLACE`, we need to rebase any projections onto it.\n+                let dest_proj_len = self.destination.projection.len();\n+                if *l == RETURN_PLACE && dest_proj_len > 0 {\n+                    let mut projs = Vec::with_capacity(dest_proj_len + place.projection.len());\n+                    projs.extend(self.destination.projection);\n+                    projs.extend(place.projection);\n+\n+                    place.projection = self.tcx.intern_place_elems(&*projs);\n+                }\n+\n+                *l = self.make_integrate_local(l);\n+            }\n         }\n     }\n "}, {"sha": "0bb9dfa403d582285b6da6ad20857e619993fe99", "filename": "src/test/mir-opt/inline/inline-into-box-place.rs", "status": "added", "additions": 71, "deletions": 0, "changes": 71, "blob_url": "https://github.com/rust-lang/rust/blob/bec4fc175aaab3a9b633b99642aa8e96375d3e89/src%2Ftest%2Fmir-opt%2Finline%2Finline-into-box-place.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bec4fc175aaab3a9b633b99642aa8e96375d3e89/src%2Ftest%2Fmir-opt%2Finline%2Finline-into-box-place.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Finline%2Finline-into-box-place.rs?ref=bec4fc175aaab3a9b633b99642aa8e96375d3e89", "patch": "@@ -0,0 +1,71 @@\n+// ignore-tidy-linelength\n+// ignore-wasm32-bare compiled with panic=abort by default\n+#![feature(box_syntax)]\n+\n+fn main() {\n+    let _x: Box<Vec<u32>> = box Vec::new();\n+}\n+\n+// END RUST SOURCE\n+// START rustc.main.Inline.before.mir\n+// let mut _0: ();\n+// let _1: std::boxed::Box<std::vec::Vec<u32>> as UserTypeProjection { base: UserType(0), projs: [] };\n+// let mut _2: std::boxed::Box<std::vec::Vec<u32>>;\n+// let mut _3: ();\n+// scope 1 {\n+//   debug _x => _1;\n+// }\n+// bb0: {\n+//   StorageLive(_1);\n+//   StorageLive(_2);\n+//   _2 = Box(std::vec::Vec<u32>);\n+//   (*_2) = const std::vec::Vec::<u32>::new() -> [return: bb2, unwind: bb4];\n+// }\n+// bb1 (cleanup): {\n+//   resume;\n+// }\n+// bb2: {\n+//   _1 = move _2;\n+//   StorageDead(_2);\n+//   _0 = ();\n+//   drop(_1) -> [return: bb3, unwind: bb1];\n+// }\n+// bb3: {\n+//   StorageDead(_1);\n+//   return;\n+// }\n+// bb4 (cleanup): {\n+//   _3 = const alloc::alloc::box_free::<std::vec::Vec<u32>>(move (_2.0: std::ptr::Unique<std::vec::Vec<u32>>)) -> bb1;\n+// }\n+// END rustc.main.Inline.before.mir\n+// START rustc.main.Inline.after.mir\n+// let mut _0: ();\n+// let _1: std::boxed::Box<std::vec::Vec<u32>> as UserTypeProjection { base: UserType(0), projs: [] };\n+// let mut _2: std::boxed::Box<std::vec::Vec<u32>>;\n+// let mut _3: ();\n+// let mut _4: &mut std::vec::Vec<u32>;\n+// scope 1 {\n+//   debug _x => _1;\n+// }\n+// scope 2 {\n+// }\n+// bb0: {\n+//   StorageLive(_1);\n+//   StorageLive(_2);\n+//   _2 = Box(std::vec::Vec<u32>);\n+//   _4 = &mut (*_2);\n+//   ((*_4).0: alloc::raw_vec::RawVec<u32>) = const alloc::raw_vec::RawVec::<u32>::NEW;\n+//   ((*_4).1: usize) = const 0usize;\n+//   _1 = move _2;\n+//   StorageDead(_2);\n+//   _0 = ();\n+//   drop(_1) -> [return: bb2, unwind: bb1];\n+// }\n+// bb1 (cleanup): {\n+//   resume;\n+// }\n+// bb2: {\n+//   StorageDead(_1);\n+//   return;\n+// }\n+// END rustc.main.Inline.after.mir"}]}