{"sha": "ba7cf7cc5daefb9f28371b8be87dc262fb55937c", "node_id": "MDY6Q29tbWl0NzI0NzEyOmJhN2NmN2NjNWRhZWZiOWYyODM3MWI4YmU4N2RjMjYyZmI1NTkzN2M=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-02-11T22:10:53Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-02-11T22:10:53Z"}, "message": "Auto merge of #39747 - mattico:fix-llvm4-createcompileunit, r=alexcrichton\n\n[LLVM 4.0] Fix CreateCompileUnit\n\nThis is largely identical to @dylanmckay's [patch](https://github.com/dylanmckay), except that it doesn't try to use `file_metadata()`. I don't think that is necessary because we don't want the compile unit to be added to  `debug_context.created_files`, though I'd like confirmation from someone who knows for sure. If that is needed, I can modify `file_metadata_()` so that it can be used from `compile_unit_metadata()`.", "tree": {"sha": "f926f6bb79e28a612a579ae62a234139536a5f08", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f926f6bb79e28a612a579ae62a234139536a5f08"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ba7cf7cc5daefb9f28371b8be87dc262fb55937c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ba7cf7cc5daefb9f28371b8be87dc262fb55937c", "html_url": "https://github.com/rust-lang/rust/commit/ba7cf7cc5daefb9f28371b8be87dc262fb55937c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ba7cf7cc5daefb9f28371b8be87dc262fb55937c/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "bae454edc5e18e81b831baf4a7647bf2dda620a8", "url": "https://api.github.com/repos/rust-lang/rust/commits/bae454edc5e18e81b831baf4a7647bf2dda620a8", "html_url": "https://github.com/rust-lang/rust/commit/bae454edc5e18e81b831baf4a7647bf2dda620a8"}, {"sha": "aebce5bd2aa9f75b09fc30638736e14761989fce", "url": "https://api.github.com/repos/rust-lang/rust/commits/aebce5bd2aa9f75b09fc30638736e14761989fce", "html_url": "https://github.com/rust-lang/rust/commit/aebce5bd2aa9f75b09fc30638736e14761989fce"}], "stats": {"total": 28, "additions": 19, "deletions": 9}, "files": [{"sha": "8a958cf1ac105b6493d19fc56ecb7741960189f0", "filename": "src/librustc_llvm/ffi.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/ba7cf7cc5daefb9f28371b8be87dc262fb55937c/src%2Flibrustc_llvm%2Fffi.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ba7cf7cc5daefb9f28371b8be87dc262fb55937c/src%2Flibrustc_llvm%2Fffi.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_llvm%2Fffi.rs?ref=ba7cf7cc5daefb9f28371b8be87dc262fb55937c", "patch": "@@ -1334,8 +1334,7 @@ extern \"C\" {\n \n     pub fn LLVMRustDIBuilderCreateCompileUnit(Builder: DIBuilderRef,\n                                               Lang: c_uint,\n-                                              File: *const c_char,\n-                                              Dir: *const c_char,\n+                                              File: DIFile,\n                                               Producer: *const c_char,\n                                               isOptimized: bool,\n                                               Flags: *const c_char,"}, {"sha": "c453d9bbd051f5e4c4c1beee7d7c5f2da51b136e", "filename": "src/librustc_trans/debuginfo/metadata.rs", "status": "modified", "additions": 7, "deletions": 4, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/ba7cf7cc5daefb9f28371b8be87dc262fb55937c/src%2Flibrustc_trans%2Fdebuginfo%2Fmetadata.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ba7cf7cc5daefb9f28371b8be87dc262fb55937c/src%2Flibrustc_trans%2Fdebuginfo%2Fmetadata.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Fdebuginfo%2Fmetadata.rs?ref=ba7cf7cc5daefb9f28371b8be87dc262fb55937c", "patch": "@@ -791,12 +791,15 @@ pub fn compile_unit_metadata(scc: &SharedCrateContext,\n     let producer = CString::new(producer).unwrap();\n     let flags = \"\\0\";\n     let split_name = \"\\0\";\n-    return unsafe {\n-        llvm::LLVMRustDIBuilderCreateCompileUnit(\n+\n+    unsafe {\n+        let file_metadata = llvm::LLVMRustDIBuilderCreateFile(\n+            debug_context.builder, compile_unit_name, work_dir.as_ptr());\n+\n+        return llvm::LLVMRustDIBuilderCreateCompileUnit(\n             debug_context.builder,\n             DW_LANG_RUST,\n-            compile_unit_name,\n-            work_dir.as_ptr(),\n+            file_metadata,\n             producer.as_ptr(),\n             sess.opts.optimize != config::OptLevel::No,\n             flags.as_ptr() as *const _,"}, {"sha": "40432735911893a94ef09e3db2615fa8720b7a1d", "filename": "src/rustllvm/RustWrapper.cpp", "status": "modified", "additions": 11, "deletions": 3, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/ba7cf7cc5daefb9f28371b8be87dc262fb55937c/src%2Frustllvm%2FRustWrapper.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/ba7cf7cc5daefb9f28371b8be87dc262fb55937c/src%2Frustllvm%2FRustWrapper.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustllvm%2FRustWrapper.cpp?ref=ba7cf7cc5daefb9f28371b8be87dc262fb55937c", "patch": "@@ -474,11 +474,19 @@ extern \"C\" void LLVMRustDIBuilderFinalize(LLVMRustDIBuilderRef Builder) {\n }\n \n extern \"C\" LLVMRustMetadataRef LLVMRustDIBuilderCreateCompileUnit(\n-    LLVMRustDIBuilderRef Builder, unsigned Lang, const char *File,\n-    const char *Dir, const char *Producer, bool isOptimized, const char *Flags,\n+    LLVMRustDIBuilderRef Builder, unsigned Lang, LLVMRustMetadataRef FileRef,\n+    const char *Producer, bool isOptimized, const char *Flags,\n     unsigned RuntimeVer, const char *SplitName) {\n-  return wrap(Builder->createCompileUnit(Lang, File, Dir, Producer, isOptimized,\n+  auto *File = unwrapDI<DIFile>(FileRef);\n+\n+#if LLVM_VERSION_GE(4, 0)\n+  return wrap(Builder->createCompileUnit(Lang, File, Producer, isOptimized,\n                                          Flags, RuntimeVer, SplitName));\n+#else\n+  return wrap(Builder->createCompileUnit(Lang, File->getFilename(),\n+      File->getDirectory(), Producer, isOptimized,\n+      Flags, RuntimeVer, SplitName));\n+#endif\n }\n \n extern \"C\" LLVMRustMetadataRef"}]}