{"sha": "dce3947110a73efebb756242d5c775a3ddad32a9", "node_id": "C_kwDOAAsO6NoAKGRjZTM5NDcxMTBhNzNlZmViYjc1NjI0MmQ1Yzc3NWEzZGRhZDMyYTk", "commit": {"author": {"name": "Rune Tynan", "email": "runetynan@gmail.com", "date": "2023-02-13T17:50:45Z"}, "committer": {"name": "Rune Tynan", "email": "runetynan@gmail.com", "date": "2023-02-20T18:38:16Z"}, "message": "Try adding metadata length prefix, and obey it while decoding", "tree": {"sha": "2de9fe1d7f5276f3f8d174e7b370a168510ccd80", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2de9fe1d7f5276f3f8d174e7b370a168510ccd80"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/dce3947110a73efebb756242d5c775a3ddad32a9", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEETdpCnQmiF6hBYUqdfsyTL4sscx4FAmPzviIACgkQfsyTL4ss\ncx7aiQ/+OUQg9kcr1IkLe9ZUEkc7CxuNA/c8W8BiwBnS2iZm/cgnoNbA4iMv+eAo\nY7q5Vxunm/F2WxPY0L887snPGl8x+12U3nILHHBf/A/is6LsevQWr1xr6E4b1Y/Q\neLG/2AGqSNIbyqHTdIL2CSiYZXojBqgl456P147Z1R40ykMKTEVqjb2I37z8wJPw\nClovk54ujAfts7cmmiZjB34IqJRYUTn/FEMtbAWyfGArxiNClpZfLKR2XyVdhhVy\n7nE21YCANx2ohlcIajMHYJaaWeu4PwQNQmyv+3OBmDd4sWfHsunef17VSGfhLluG\nC+0UM69FoIRlxo9C4j4kC0m3nmeEAqj76P43NbxfSSWY9CPHC0fVzS3F+WuzqUyQ\nxVggI/VVbE35wI1STzyUzVdEZdudDOx/YsqxeM8BGw4Adxnm2fysMo5YmoORysk3\nOkSeg2OsMcTiNN53YTsi21vn9mZ/1sCSIyhS0u+BMsdFIiq9/5b6Va/l4B5aNyP9\n8T69rL4zyNo+iqY+Y/XpS2HOBs8ToCobay1rMO0m0VaHRDhQ2Sz4oXr3enm0MP23\n25kogTIMdBE2l0OJSO8yZnH3FmF8zFTkEIijYpN7iuttnEYKTnCYsXti+61oCuCL\nJXC9SH8Yw4fRRrW2dhz64304w77LPdI35n37W+TwUUtoHJBVbU0=\n=tJ2C\n-----END PGP SIGNATURE-----", "payload": "tree 2de9fe1d7f5276f3f8d174e7b370a168510ccd80\nparent 267cd1d2c5abf5f0d825822a4179ba807b69ffb4\nauthor Rune Tynan <runetynan@gmail.com> 1676310645 -0500\ncommitter Rune Tynan <runetynan@gmail.com> 1676918296 -0500\n\nTry adding metadata length prefix, and obey it while decoding\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/dce3947110a73efebb756242d5c775a3ddad32a9", "html_url": "https://github.com/rust-lang/rust/commit/dce3947110a73efebb756242d5c775a3ddad32a9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/dce3947110a73efebb756242d5c775a3ddad32a9/comments", "author": {"login": "CraftSpider", "id": 13342132, "node_id": "MDQ6VXNlcjEzMzQyMTMy", "avatar_url": "https://avatars.githubusercontent.com/u/13342132?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CraftSpider", "html_url": "https://github.com/CraftSpider", "followers_url": "https://api.github.com/users/CraftSpider/followers", "following_url": "https://api.github.com/users/CraftSpider/following{/other_user}", "gists_url": "https://api.github.com/users/CraftSpider/gists{/gist_id}", "starred_url": "https://api.github.com/users/CraftSpider/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CraftSpider/subscriptions", "organizations_url": "https://api.github.com/users/CraftSpider/orgs", "repos_url": "https://api.github.com/users/CraftSpider/repos", "events_url": "https://api.github.com/users/CraftSpider/events{/privacy}", "received_events_url": "https://api.github.com/users/CraftSpider/received_events", "type": "User", "site_admin": false}, "committer": {"login": "CraftSpider", "id": 13342132, "node_id": "MDQ6VXNlcjEzMzQyMTMy", "avatar_url": "https://avatars.githubusercontent.com/u/13342132?v=4", "gravatar_id": "", "url": "https://api.github.com/users/CraftSpider", "html_url": "https://github.com/CraftSpider", "followers_url": "https://api.github.com/users/CraftSpider/followers", "following_url": "https://api.github.com/users/CraftSpider/following{/other_user}", "gists_url": "https://api.github.com/users/CraftSpider/gists{/gist_id}", "starred_url": "https://api.github.com/users/CraftSpider/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/CraftSpider/subscriptions", "organizations_url": "https://api.github.com/users/CraftSpider/orgs", "repos_url": "https://api.github.com/users/CraftSpider/repos", "events_url": "https://api.github.com/users/CraftSpider/events{/privacy}", "received_events_url": "https://api.github.com/users/CraftSpider/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "267cd1d2c5abf5f0d825822a4179ba807b69ffb4", "url": "https://api.github.com/repos/rust-lang/rust/commits/267cd1d2c5abf5f0d825822a4179ba807b69ffb4", "html_url": "https://github.com/rust-lang/rust/commit/267cd1d2c5abf5f0d825822a4179ba807b69ffb4"}], "stats": {"total": 12, "additions": 10, "deletions": 2}, "files": [{"sha": "190cd69a0e9cf0dc8126f0ebab328ec542a14008", "filename": "compiler/rustc_codegen_ssa/src/back/metadata.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/dce3947110a73efebb756242d5c775a3ddad32a9/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Fmetadata.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dce3947110a73efebb756242d5c775a3ddad32a9/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Fmetadata.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Fmetadata.rs?ref=dce3947110a73efebb756242d5c775a3ddad32a9", "patch": "@@ -305,6 +305,7 @@ pub fn create_compressed_metadata_file(\n     symbol_name: &str,\n ) -> Vec<u8> {\n     let mut compressed = rustc_metadata::METADATA_HEADER.to_vec();\n+    compressed.write_all(&(metadata.raw_data().len() as u32).to_be_bytes()).unwrap();\n     FrameEncoder::new(&mut compressed).write_all(metadata.raw_data()).unwrap();\n     let Some(mut file) = create_object_file(sess) else {\n         return compressed.to_vec();"}, {"sha": "285d6e22d47d6e24d1bb9cf9b288a40c967177f4", "filename": "compiler/rustc_metadata/src/locator.rs", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/dce3947110a73efebb756242d5c775a3ddad32a9/compiler%2Frustc_metadata%2Fsrc%2Flocator.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dce3947110a73efebb756242d5c775a3ddad32a9/compiler%2Frustc_metadata%2Fsrc%2Flocator.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_metadata%2Fsrc%2Flocator.rs?ref=dce3947110a73efebb756242d5c775a3ddad32a9", "patch": "@@ -798,8 +798,15 @@ fn get_metadata_section<'p>(\n                 )));\n             }\n \n+            // Length of the compressed stream - this allows linkers to pad the section if they want\n+            let usize_len = core::mem::size_of::<u32>();\n+            let Ok(len_bytes) = <[u8; 4]>::try_from(&buf[header_len..cmp::min(header_len + usize_len, buf.len())]) else {\n+                return Err(MetadataError::LoadFailure(\"invalid metadata length found\".to_string()));\n+            };\n+            let compressed_len = u32::from_be_bytes(len_bytes) as usize;\n+\n             // Header is okay -> inflate the actual metadata\n-            let compressed_bytes = &buf[header_len..];\n+            let compressed_bytes = &buf[header_len..compressed_len + header_len];\n             debug!(\"inflating {} bytes of compressed metadata\", compressed_bytes.len());\n             // Assume the decompressed data will be at least the size of the compressed data, so we\n             // don't have to grow the buffer as much."}, {"sha": "9ed4d241bd0371a93a1781132fd4b60f4a071cd7", "filename": "compiler/rustc_metadata/src/rmeta/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/dce3947110a73efebb756242d5c775a3ddad32a9/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dce3947110a73efebb756242d5c775a3ddad32a9/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fmod.rs?ref=dce3947110a73efebb756242d5c775a3ddad32a9", "patch": "@@ -55,7 +55,7 @@ pub(crate) fn rustc_version() -> String {\n /// Metadata encoding version.\n /// N.B., increment this if you change the format of metadata such that\n /// the rustc version can't be found to compare with `rustc_version()`.\n-const METADATA_VERSION: u8 = 6;\n+const METADATA_VERSION: u8 = 7;\n \n /// Metadata header which includes `METADATA_VERSION`.\n ///"}]}