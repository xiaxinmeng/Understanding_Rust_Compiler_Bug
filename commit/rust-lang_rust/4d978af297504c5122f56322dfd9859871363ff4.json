{"sha": "4d978af297504c5122f56322dfd9859871363ff4", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRkOTc4YWYyOTc1MDRjNTEyMmY1NjMyMmRmZDk4NTk4NzEzNjNmZjQ=", "commit": {"author": {"name": "bjorn3", "email": "bjorn3@users.noreply.github.com", "date": "2020-06-28T09:43:10Z"}, "committer": {"name": "bjorn3", "email": "bjorn3@users.noreply.github.com", "date": "2020-06-28T09:43:10Z"}, "message": "Remove GlobalCtxt::enter_local", "tree": {"sha": "27f9a55ab4145fd207eb5caf951769554b453ab2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/27f9a55ab4145fd207eb5caf951769554b453ab2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4d978af297504c5122f56322dfd9859871363ff4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4d978af297504c5122f56322dfd9859871363ff4", "html_url": "https://github.com/rust-lang/rust/commit/4d978af297504c5122f56322dfd9859871363ff4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4d978af297504c5122f56322dfd9859871363ff4/comments", "author": {"login": "bjorn3", "id": 17426603, "node_id": "MDQ6VXNlcjE3NDI2NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/17426603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bjorn3", "html_url": "https://github.com/bjorn3", "followers_url": "https://api.github.com/users/bjorn3/followers", "following_url": "https://api.github.com/users/bjorn3/following{/other_user}", "gists_url": "https://api.github.com/users/bjorn3/gists{/gist_id}", "starred_url": "https://api.github.com/users/bjorn3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bjorn3/subscriptions", "organizations_url": "https://api.github.com/users/bjorn3/orgs", "repos_url": "https://api.github.com/users/bjorn3/repos", "events_url": "https://api.github.com/users/bjorn3/events{/privacy}", "received_events_url": "https://api.github.com/users/bjorn3/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bjorn3", "id": 17426603, "node_id": "MDQ6VXNlcjE3NDI2NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/17426603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bjorn3", "html_url": "https://github.com/bjorn3", "followers_url": "https://api.github.com/users/bjorn3/followers", "following_url": "https://api.github.com/users/bjorn3/following{/other_user}", "gists_url": "https://api.github.com/users/bjorn3/gists{/gist_id}", "starred_url": "https://api.github.com/users/bjorn3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bjorn3/subscriptions", "organizations_url": "https://api.github.com/users/bjorn3/orgs", "repos_url": "https://api.github.com/users/bjorn3/repos", "events_url": "https://api.github.com/users/bjorn3/events{/privacy}", "received_events_url": "https://api.github.com/users/bjorn3/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3b4a3d68b5d3026bab9d41fcc004439207ecff90", "url": "https://api.github.com/repos/rust-lang/rust/commits/3b4a3d68b5d3026bab9d41fcc004439207ecff90", "html_url": "https://github.com/rust-lang/rust/commit/3b4a3d68b5d3026bab9d41fcc004439207ecff90"}], "stats": {"total": 68, "additions": 22, "deletions": 46}, "files": [{"sha": "76ac61c067280a901b03133513c871ab57f063f5", "filename": "src/librustc_infer/infer/mod.rs", "status": "modified", "additions": 17, "deletions": 19, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/4d978af297504c5122f56322dfd9859871363ff4/src%2Flibrustc_infer%2Finfer%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4d978af297504c5122f56322dfd9859871363ff4/src%2Flibrustc_infer%2Finfer%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_infer%2Finfer%2Fmod.rs?ref=4d978af297504c5122f56322dfd9859871363ff4", "patch": "@@ -570,7 +570,7 @@ impl<'tcx> fmt::Display for FixupError<'tcx> {\n /// Necessary because we can't write the following bound:\n /// `F: for<'b, 'tcx> where 'tcx FnOnce(InferCtxt<'b, 'tcx>)`.\n pub struct InferCtxtBuilder<'tcx> {\n-    global_tcx: TyCtxt<'tcx>,\n+    tcx: TyCtxt<'tcx>,\n     fresh_tables: Option<RefCell<ty::TypeckTables<'tcx>>>,\n }\n \n@@ -580,7 +580,7 @@ pub trait TyCtxtInferExt<'tcx> {\n \n impl TyCtxtInferExt<'tcx> for TyCtxt<'tcx> {\n     fn infer_ctxt(self) -> InferCtxtBuilder<'tcx> {\n-        InferCtxtBuilder { global_tcx: self, fresh_tables: None }\n+        InferCtxtBuilder { tcx: self, fresh_tables: None }\n     }\n }\n \n@@ -616,24 +616,22 @@ impl<'tcx> InferCtxtBuilder<'tcx> {\n     }\n \n     pub fn enter<R>(&mut self, f: impl for<'a> FnOnce(InferCtxt<'a, 'tcx>) -> R) -> R {\n-        let InferCtxtBuilder { global_tcx, ref fresh_tables } = *self;\n+        let InferCtxtBuilder { tcx, ref fresh_tables } = *self;\n         let in_progress_tables = fresh_tables.as_ref();\n-        global_tcx.enter_local(|tcx| {\n-            f(InferCtxt {\n-                tcx,\n-                in_progress_tables,\n-                inner: RefCell::new(InferCtxtInner::new()),\n-                lexical_region_resolutions: RefCell::new(None),\n-                selection_cache: Default::default(),\n-                evaluation_cache: Default::default(),\n-                reported_trait_errors: Default::default(),\n-                reported_closure_mismatch: Default::default(),\n-                tainted_by_errors_flag: Cell::new(false),\n-                err_count_on_creation: tcx.sess.err_count(),\n-                in_snapshot: Cell::new(false),\n-                skip_leak_check: Cell::new(false),\n-                universe: Cell::new(ty::UniverseIndex::ROOT),\n-            })\n+        f(InferCtxt {\n+            tcx,\n+            in_progress_tables,\n+            inner: RefCell::new(InferCtxtInner::new()),\n+            lexical_region_resolutions: RefCell::new(None),\n+            selection_cache: Default::default(),\n+            evaluation_cache: Default::default(),\n+            reported_trait_errors: Default::default(),\n+            reported_closure_mismatch: Default::default(),\n+            tainted_by_errors_flag: Cell::new(false),\n+            err_count_on_creation: tcx.sess.err_count(),\n+            in_snapshot: Cell::new(false),\n+            skip_leak_check: Cell::new(false),\n+            universe: Cell::new(ty::UniverseIndex::ROOT),\n         })\n     }\n }"}, {"sha": "8095bd3f6c2caf2aa46207b9f9d32af35cbd9e4c", "filename": "src/librustc_middle/ty/context.rs", "status": "modified", "additions": 5, "deletions": 27, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/4d978af297504c5122f56322dfd9859871363ff4/src%2Flibrustc_middle%2Fty%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4d978af297504c5122f56322dfd9859871363ff4/src%2Flibrustc_middle%2Fty%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_middle%2Fty%2Fcontext.rs?ref=4d978af297504c5122f56322dfd9859871363ff4", "patch": "@@ -1553,28 +1553,6 @@ impl<'tcx> TyCtxt<'tcx> {\n     }\n }\n \n-impl<'tcx> GlobalCtxt<'tcx> {\n-    /// Calls the closure with a local `TyCtxt` using the given arena.\n-    /// `interners` is a slot passed so we can create a CtxtInterners\n-    /// with the same lifetime as `arena`.\n-    pub fn enter_local<F, R>(&'tcx self, f: F) -> R\n-    where\n-        F: FnOnce(TyCtxt<'tcx>) -> R,\n-    {\n-        let tcx = TyCtxt { gcx: self };\n-        ty::tls::with_related_context(tcx, |icx| {\n-            let new_icx = ty::tls::ImplicitCtxt {\n-                tcx,\n-                query: icx.query,\n-                diagnostics: icx.diagnostics,\n-                layout_depth: icx.layout_depth,\n-                task_deps: icx.task_deps,\n-            };\n-            ty::tls::enter_context(&new_icx, |_| f(tcx))\n-        })\n-    }\n-}\n-\n /// A trait implemented for all `X<'a>` types that can be safely and\n /// efficiently converted to `X<'tcx>` as long as they are part of the\n /// provided `TyCtxt<'tcx>`.\n@@ -1811,11 +1789,11 @@ pub mod tls {\n         with_context_opt(|opt_context| f(opt_context.expect(\"no ImplicitCtxt stored in tls\")))\n     }\n \n-    /// Allows access to the current `ImplicitCtxt` whose tcx field has the same global\n-    /// interner as the tcx argument passed in. This means the closure is given an `ImplicitCtxt`\n-    /// with the same `'tcx` lifetime as the `TyCtxt` passed in.\n-    /// This will panic if you pass it a `TyCtxt` which has a different global interner from\n-    /// the current `ImplicitCtxt`'s `tcx` field.\n+    /// Allows access to the current `ImplicitCtxt` whose tcx field is the same as the tcx argument\n+    /// passed in. This means the closure is given an `ImplicitCtxt` with the same `'tcx` lifetime\n+    /// as the `TyCtxt` passed in.\n+    /// This will panic if you pass it a `TyCtxt` which is different from the current\n+    /// `ImplicitCtxt`'s `tcx` field.\n     #[inline]\n     pub fn with_related_context<'tcx, F, R>(tcx: TyCtxt<'tcx>, f: F) -> R\n     where"}]}