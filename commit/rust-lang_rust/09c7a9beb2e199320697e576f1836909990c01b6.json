{"sha": "09c7a9beb2e199320697e576f1836909990c01b6", "node_id": "MDY6Q29tbWl0NzI0NzEyOjA5YzdhOWJlYjJlMTk5MzIwNjk3ZTU3NmYxODM2OTA5OTkwYzAxYjY=", "commit": {"author": {"name": "Yuki Okushi", "email": "huyuumi.dev@gmail.com", "date": "2020-01-03T08:56:29Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-01-03T08:56:29Z"}, "message": "Rollup merge of #67796 - Aaron1011:fix/mir-inline-proj, r=wesleywiser\n\nEnsure that we process projections during MIR inlining\n\nFixes #67710\n\nPreviously, we were not calling `super_place`, which resulted in us\nfailing to update any local references that occur in\nProjectionElem::Index. This caused the post-inlining MIR to contain a\nreference to a local ID from the inlined callee, leading to an ICE\ndue to a type mismatch.", "tree": {"sha": "e147726a4f7d57e15ed36adf83036480c8e09414", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e147726a4f7d57e15ed36adf83036480c8e09414"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/09c7a9beb2e199320697e576f1836909990c01b6", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJeDwG9CRBK7hj4Ov3rIwAAdHIIADE2DkVQJVmIQQEa/3DbxKp6\ncyro/IjDYUyngy2d6Bv5FvQMpTa4Ee5uPUYY1ZQ25ME3XSEvKck5b5ORGgvXDP5O\nDGpK6Q2nRxgXtYNjuUHrXS78mLui47OePZv/p5ybUaJIC470YTrYMk9u4cdUyVj+\nCAddoYutCAr5TM7x+wlS6YY4rGTB0w8uSUg9flAdQu8Au+Z1gjYhWrfY24ubJMQ7\nWByKlrXUXgOUFpg48F76rka5fxev3HCypxVFyYs2e0deRTYXxTfW1OIjzyMf4fHE\nKXi0hiTsK9RE5qnYA2O57aoMcwp4/RZWtxMnmiutEPLBjUu8sSC0INBRygt9scs=\n=Xj59\n-----END PGP SIGNATURE-----\n", "payload": "tree e147726a4f7d57e15ed36adf83036480c8e09414\nparent 7affcd5394b5c85b5dbdf13b388785998a772a26\nparent e8e53b56dff3cd1f9e6d65ee30d5e0bfc55d9607\nauthor Yuki Okushi <huyuumi.dev@gmail.com> 1578041789 +0900\ncommitter GitHub <noreply@github.com> 1578041789 +0900\n\nRollup merge of #67796 - Aaron1011:fix/mir-inline-proj, r=wesleywiser\n\nEnsure that we process projections during MIR inlining\n\nFixes #67710\n\nPreviously, we were not calling `super_place`, which resulted in us\nfailing to update any local references that occur in\nProjectionElem::Index. This caused the post-inlining MIR to contain a\nreference to a local ID from the inlined callee, leading to an ICE\ndue to a type mismatch.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/09c7a9beb2e199320697e576f1836909990c01b6", "html_url": "https://github.com/rust-lang/rust/commit/09c7a9beb2e199320697e576f1836909990c01b6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/09c7a9beb2e199320697e576f1836909990c01b6/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7affcd5394b5c85b5dbdf13b388785998a772a26", "url": "https://api.github.com/repos/rust-lang/rust/commits/7affcd5394b5c85b5dbdf13b388785998a772a26", "html_url": "https://github.com/rust-lang/rust/commit/7affcd5394b5c85b5dbdf13b388785998a772a26"}, {"sha": "e8e53b56dff3cd1f9e6d65ee30d5e0bfc55d9607", "url": "https://api.github.com/repos/rust-lang/rust/commits/e8e53b56dff3cd1f9e6d65ee30d5e0bfc55d9607", "html_url": "https://github.com/rust-lang/rust/commit/e8e53b56dff3cd1f9e6d65ee30d5e0bfc55d9607"}], "stats": {"total": 29, "additions": 21, "deletions": 8}, "files": [{"sha": "3c9f8542e51d02a727d4aea997ce67b8b8b9b5e3", "filename": "src/librustc_mir/transform/inline.rs", "status": "modified", "additions": 4, "deletions": 8, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/09c7a9beb2e199320697e576f1836909990c01b6/src%2Flibrustc_mir%2Ftransform%2Finline.rs", "raw_url": "https://github.com/rust-lang/rust/raw/09c7a9beb2e199320697e576f1836909990c01b6/src%2Flibrustc_mir%2Ftransform%2Finline.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Finline.rs?ref=09c7a9beb2e199320697e576f1836909990c01b6", "patch": "@@ -671,12 +671,7 @@ impl<'a, 'tcx> MutVisitor<'tcx> for Integrator<'a, 'tcx> {\n         *local = self.make_integrate_local(local);\n     }\n \n-    fn visit_place(\n-        &mut self,\n-        place: &mut Place<'tcx>,\n-        _context: PlaceContext,\n-        _location: Location,\n-    ) {\n+    fn visit_place(&mut self, place: &mut Place<'tcx>, context: PlaceContext, location: Location) {\n         match &mut place.base {\n             PlaceBase::Static(_) => {}\n             PlaceBase::Local(l) => {\n@@ -689,10 +684,11 @@ impl<'a, 'tcx> MutVisitor<'tcx> for Integrator<'a, 'tcx> {\n \n                     place.projection = self.tcx.intern_place_elems(&*projs);\n                 }\n-\n-                *l = self.make_integrate_local(l);\n             }\n         }\n+        // Handles integrating any locals that occur in the base\n+        // or projections\n+        self.super_place(place, context, location)\n     }\n \n     fn process_projection_elem(&mut self, elem: &PlaceElem<'tcx>) -> Option<PlaceElem<'tcx>> {"}, {"sha": "37d8f2eac9be1d718a51e956f3e904102fc72133", "filename": "src/test/ui/mir/issue-67710-inline-projection.rs", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/09c7a9beb2e199320697e576f1836909990c01b6/src%2Ftest%2Fui%2Fmir%2Fissue-67710-inline-projection.rs", "raw_url": "https://github.com/rust-lang/rust/raw/09c7a9beb2e199320697e576f1836909990c01b6/src%2Ftest%2Fui%2Fmir%2Fissue-67710-inline-projection.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmir%2Fissue-67710-inline-projection.rs?ref=09c7a9beb2e199320697e576f1836909990c01b6", "patch": "@@ -0,0 +1,17 @@\n+// compile-flags: -Z mir-opt-level=2\n+// build-pass\n+\n+// This used to ICE due to the inling pass not examining projections\n+// for references to locals\n+\n+pub fn parse(version: ()) {\n+    p(&b'.', b\"0\");\n+}\n+#[inline(always)]\n+fn p(byte: &u8, s: &[u8]) {\n+    !(s[0] == *byte);\n+}\n+\n+fn main() {\n+    parse(());\n+}"}]}