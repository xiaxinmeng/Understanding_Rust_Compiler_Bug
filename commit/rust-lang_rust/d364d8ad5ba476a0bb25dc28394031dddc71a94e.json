{"sha": "d364d8ad5ba476a0bb25dc28394031dddc71a94e", "node_id": "C_kwDOAAsO6NoAKGQzNjRkOGFkNWJhNDc2YTBiYjI1ZGMyODM5NDAzMWRkZGM3MWE5NGU", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-01-17T07:04:06Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-01-17T07:04:06Z"}, "message": "Auto merge of #8299 - marekdownar:8214, r=Manishearth\n\n#8214 cmp_owned suggestion flips the comparison\n\nchangelog: ``[`cmp_owned`]`` fixes #8214 so that the suggestion does not flip the comparison", "tree": {"sha": "7e78f2a48ef9d8c6041af439ec7fc63095c54867", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7e78f2a48ef9d8c6041af439ec7fc63095c54867"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d364d8ad5ba476a0bb25dc28394031dddc71a94e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d364d8ad5ba476a0bb25dc28394031dddc71a94e", "html_url": "https://github.com/rust-lang/rust/commit/d364d8ad5ba476a0bb25dc28394031dddc71a94e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d364d8ad5ba476a0bb25dc28394031dddc71a94e/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "537a7f3e4425c49972143fb6c722f30d46c2cf0e", "url": "https://api.github.com/repos/rust-lang/rust/commits/537a7f3e4425c49972143fb6c722f30d46c2cf0e", "html_url": "https://github.com/rust-lang/rust/commit/537a7f3e4425c49972143fb6c722f30d46c2cf0e"}, {"sha": "5b6ec8c57d82be1697f2be4dffbb8f12cf376ff2", "url": "https://api.github.com/repos/rust-lang/rust/commits/5b6ec8c57d82be1697f2be4dffbb8f12cf376ff2", "html_url": "https://github.com/rust-lang/rust/commit/5b6ec8c57d82be1697f2be4dffbb8f12cf376ff2"}], "stats": {"total": 97, "additions": 95, "deletions": 2}, "files": [{"sha": "8db71d1e967620ca73267880368df8dafc609090", "filename": "clippy_lints/src/misc.rs", "status": "modified", "additions": 19, "deletions": 2, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/d364d8ad5ba476a0bb25dc28394031dddc71a94e/clippy_lints%2Fsrc%2Fmisc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d364d8ad5ba476a0bb25dc28394031dddc71a94e/clippy_lints%2Fsrc%2Fmisc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmisc.rs?ref=d364d8ad5ba476a0bb25dc28394031dddc71a94e", "patch": "@@ -548,6 +548,7 @@ fn is_array(cx: &LateContext<'_>, expr: &Expr<'_>) -> bool {\n     matches!(&cx.typeck_results().expr_ty(expr).peel_refs().kind(), ty::Array(_, _))\n }\n \n+#[allow(clippy::too_many_lines)]\n fn check_to_owned(cx: &LateContext<'_>, expr: &Expr<'_>, other: &Expr<'_>, left: bool) {\n     #[derive(Default)]\n     struct EqImpl {\n@@ -644,10 +645,26 @@ fn check_to_owned(cx: &LateContext<'_>, expr: &Expr<'_>, other: &Expr<'_>, left:\n                 hint = expr_snip;\n             } else {\n                 span = expr.span.to(other.span);\n+\n+                let cmp_span = if other.span < expr.span {\n+                    other.span.between(expr.span)\n+                } else {\n+                    expr.span.between(other.span)\n+                };\n                 if eq_impl.ty_eq_other {\n-                    hint = format!(\"{} == {}\", expr_snip, snippet(cx, other.span, \"..\"));\n+                    hint = format!(\n+                        \"{}{}{}\",\n+                        expr_snip,\n+                        snippet(cx, cmp_span, \"..\"),\n+                        snippet(cx, other.span, \"..\")\n+                    );\n                 } else {\n-                    hint = format!(\"{} == {}\", snippet(cx, other.span, \"..\"), expr_snip);\n+                    hint = format!(\n+                        \"{}{}{}\",\n+                        snippet(cx, other.span, \"..\"),\n+                        snippet(cx, cmp_span, \"..\"),\n+                        expr_snip\n+                    );\n                 }\n             }\n "}, {"sha": "44e41bdd1148711497a4d8a7928b3650a919e557", "filename": "tests/ui/cmp_owned/comparison_flip.fixed", "status": "added", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/d364d8ad5ba476a0bb25dc28394031dddc71a94e/tests%2Fui%2Fcmp_owned%2Fcomparison_flip.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/d364d8ad5ba476a0bb25dc28394031dddc71a94e/tests%2Fui%2Fcmp_owned%2Fcomparison_flip.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcmp_owned%2Fcomparison_flip.fixed?ref=d364d8ad5ba476a0bb25dc28394031dddc71a94e", "patch": "@@ -0,0 +1,29 @@\n+// run-rustfix\n+\n+use std::fmt::{self, Display};\n+\n+fn main() {\n+    let a = Foo;\n+\n+    if a != \"bar\" {\n+        println!(\"foo\");\n+    }\n+\n+    if a != \"bar\" {\n+        println!(\"foo\");\n+    }\n+}\n+\n+struct Foo;\n+\n+impl Display for Foo {\n+    fn fmt(&self, f: &mut fmt::Formatter) -> fmt::Result {\n+        write!(f, \"foo\")\n+    }\n+}\n+\n+impl PartialEq<&str> for Foo {\n+    fn eq(&self, other: &&str) -> bool {\n+        \"foo\" == *other\n+    }\n+}"}, {"sha": "662673abb62d9aee94b58b0e36746021a7c24d77", "filename": "tests/ui/cmp_owned/comparison_flip.rs", "status": "added", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/d364d8ad5ba476a0bb25dc28394031dddc71a94e/tests%2Fui%2Fcmp_owned%2Fcomparison_flip.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d364d8ad5ba476a0bb25dc28394031dddc71a94e/tests%2Fui%2Fcmp_owned%2Fcomparison_flip.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcmp_owned%2Fcomparison_flip.rs?ref=d364d8ad5ba476a0bb25dc28394031dddc71a94e", "patch": "@@ -0,0 +1,29 @@\n+// run-rustfix\n+\n+use std::fmt::{self, Display};\n+\n+fn main() {\n+    let a = Foo;\n+\n+    if a.to_string() != \"bar\" {\n+        println!(\"foo\");\n+    }\n+\n+    if \"bar\" != a.to_string() {\n+        println!(\"foo\");\n+    }\n+}\n+\n+struct Foo;\n+\n+impl Display for Foo {\n+    fn fmt(&self, f: &mut fmt::Formatter) -> fmt::Result {\n+        write!(f, \"foo\")\n+    }\n+}\n+\n+impl PartialEq<&str> for Foo {\n+    fn eq(&self, other: &&str) -> bool {\n+        \"foo\" == *other\n+    }\n+}"}, {"sha": "e4d0d822bb1e341aa8dc0fc9bfbee2e923558b9b", "filename": "tests/ui/cmp_owned/comparison_flip.stderr", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/d364d8ad5ba476a0bb25dc28394031dddc71a94e/tests%2Fui%2Fcmp_owned%2Fcomparison_flip.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/d364d8ad5ba476a0bb25dc28394031dddc71a94e/tests%2Fui%2Fcmp_owned%2Fcomparison_flip.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcmp_owned%2Fcomparison_flip.stderr?ref=d364d8ad5ba476a0bb25dc28394031dddc71a94e", "patch": "@@ -0,0 +1,18 @@\n+error: this creates an owned instance just for comparison\n+  --> $DIR/comparison_flip.rs:8:8\n+   |\n+LL |     if a.to_string() != \"bar\" {\n+   |        ^^^^^^^^^^^^^ help: try: `a`\n+   |\n+   = note: `-D clippy::cmp-owned` implied by `-D warnings`\n+\n+error: this creates an owned instance just for comparison\n+  --> $DIR/comparison_flip.rs:12:17\n+   |\n+LL |     if \"bar\" != a.to_string() {\n+   |        ---------^^^^^^^^^^^^^\n+   |        |\n+   |        help: try: `a != \"bar\"`\n+\n+error: aborting due to 2 previous errors\n+"}]}