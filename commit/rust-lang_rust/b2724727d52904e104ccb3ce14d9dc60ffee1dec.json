{"sha": "b2724727d52904e104ccb3ce14d9dc60ffee1dec", "node_id": "MDY6Q29tbWl0NzI0NzEyOmIyNzI0NzI3ZDUyOTA0ZTEwNGNjYjNjZTE0ZDlkYzYwZmZlZTFkZWM=", "commit": {"author": {"name": "Daniel Micay", "email": "danielmicay@gmail.com", "date": "2014-04-22T23:51:14Z"}, "committer": {"name": "Daniel Micay", "email": "danielmicay@gmail.com", "date": "2014-04-23T00:15:55Z"}, "message": "add volatile copy/copy_nonoverlapping/set\n\nThis exposes volatile versions of the memset/memmove/memcpy intrinsics.\n\nThe volatile parameter must be constant, so this can't simply be a\nparameter to our intrinsics.", "tree": {"sha": "da6ba9ff9646032e01c48494b971b640bf2e16b9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/da6ba9ff9646032e01c48494b971b640bf2e16b9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b2724727d52904e104ccb3ce14d9dc60ffee1dec", "comment_count": 5, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b2724727d52904e104ccb3ce14d9dc60ffee1dec", "html_url": "https://github.com/rust-lang/rust/commit/b2724727d52904e104ccb3ce14d9dc60ffee1dec", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b2724727d52904e104ccb3ce14d9dc60ffee1dec/comments", "author": {"login": "thestinger", "id": 1505226, "node_id": "MDQ6VXNlcjE1MDUyMjY=", "avatar_url": "https://avatars.githubusercontent.com/u/1505226?v=4", "gravatar_id": "", "url": "https://api.github.com/users/thestinger", "html_url": "https://github.com/thestinger", "followers_url": "https://api.github.com/users/thestinger/followers", "following_url": "https://api.github.com/users/thestinger/following{/other_user}", "gists_url": "https://api.github.com/users/thestinger/gists{/gist_id}", "starred_url": "https://api.github.com/users/thestinger/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/thestinger/subscriptions", "organizations_url": "https://api.github.com/users/thestinger/orgs", "repos_url": "https://api.github.com/users/thestinger/repos", "events_url": "https://api.github.com/users/thestinger/events{/privacy}", "received_events_url": "https://api.github.com/users/thestinger/received_events", "type": "User", "site_admin": false}, "committer": {"login": "thestinger", "id": 1505226, "node_id": "MDQ6VXNlcjE1MDUyMjY=", "avatar_url": "https://avatars.githubusercontent.com/u/1505226?v=4", "gravatar_id": "", "url": "https://api.github.com/users/thestinger", "html_url": "https://github.com/thestinger", "followers_url": "https://api.github.com/users/thestinger/followers", "following_url": "https://api.github.com/users/thestinger/following{/other_user}", "gists_url": "https://api.github.com/users/thestinger/gists{/gist_id}", "starred_url": "https://api.github.com/users/thestinger/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/thestinger/subscriptions", "organizations_url": "https://api.github.com/users/thestinger/orgs", "repos_url": "https://api.github.com/users/thestinger/repos", "events_url": "https://api.github.com/users/thestinger/events{/privacy}", "received_events_url": "https://api.github.com/users/thestinger/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "09bfb92fdc3ccff42dfcf91b0af368f88dc3e446", "url": "https://api.github.com/repos/rust-lang/rust/commits/09bfb92fdc3ccff42dfcf91b0af368f88dc3e446", "html_url": "https://github.com/rust-lang/rust/commit/09bfb92fdc3ccff42dfcf91b0af368f88dc3e446"}], "stats": {"total": 75, "additions": 43, "deletions": 32}, "files": [{"sha": "86fde5d821a00b4050c2900a4db5da43e0842eb6", "filename": "src/librustc/middle/trans/intrinsic.rs", "status": "modified", "additions": 13, "deletions": 11, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/b2724727d52904e104ccb3ce14d9dc60ffee1dec/src%2Flibrustc%2Fmiddle%2Ftrans%2Fintrinsic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b2724727d52904e104ccb3ce14d9dc60ffee1dec/src%2Flibrustc%2Fmiddle%2Ftrans%2Fintrinsic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fintrinsic.rs?ref=b2724727d52904e104ccb3ce14d9dc60ffee1dec", "patch": "@@ -129,7 +129,7 @@ pub fn trans_intrinsic(ccx: &CrateContext,\n         RetVoid(bcx);\n     }\n \n-    fn copy_intrinsic(bcx: &Block, allow_overlap: bool, tp_ty: ty::t) {\n+    fn copy_intrinsic(bcx: &Block, allow_overlap: bool, volatile: bool, tp_ty: ty::t) {\n         let ccx = bcx.ccx();\n         let lltp_ty = type_of::type_of(ccx, tp_ty);\n         let align = C_i32(ccx, machine::llalign_of_min(ccx, lltp_ty) as i32);\n@@ -154,13 +154,12 @@ pub fn trans_intrinsic(ccx: &CrateContext,\n         let dst_ptr = PointerCast(bcx, get_param(decl, first_real_arg), Type::i8p(ccx));\n         let src_ptr = PointerCast(bcx, get_param(decl, first_real_arg + 1), Type::i8p(ccx));\n         let count = get_param(decl, first_real_arg + 2);\n-        let volatile = C_i1(ccx, false);\n         let llfn = ccx.get_intrinsic(&name);\n-        Call(bcx, llfn, [dst_ptr, src_ptr, Mul(bcx, size, count), align, volatile], []);\n+        Call(bcx, llfn, [dst_ptr, src_ptr, Mul(bcx, size, count), align, C_i1(ccx, volatile)], []);\n         RetVoid(bcx);\n     }\n \n-    fn memset_intrinsic(bcx: &Block, tp_ty: ty::t) {\n+    fn memset_intrinsic(bcx: &Block, volatile: bool, tp_ty: ty::t) {\n         let ccx = bcx.ccx();\n         let lltp_ty = type_of::type_of(ccx, tp_ty);\n         let align = C_i32(ccx, machine::llalign_of_min(ccx, lltp_ty) as i32);\n@@ -176,9 +175,8 @@ pub fn trans_intrinsic(ccx: &CrateContext,\n         let dst_ptr = PointerCast(bcx, get_param(decl, first_real_arg), Type::i8p(ccx));\n         let val = get_param(decl, first_real_arg + 1);\n         let count = get_param(decl, first_real_arg + 2);\n-        let volatile = C_i1(ccx, false);\n         let llfn = ccx.get_intrinsic(&name);\n-        Call(bcx, llfn, [dst_ptr, val, Mul(bcx, size, count), align, volatile], []);\n+        Call(bcx, llfn, [dst_ptr, val, Mul(bcx, size, count), align, C_i1(ccx, volatile)], []);\n         RetVoid(bcx);\n     }\n \n@@ -466,11 +464,15 @@ pub fn trans_intrinsic(ccx: &CrateContext,\n             let lladdr = InBoundsGEP(bcx, ptr, [offset]);\n             Ret(bcx, lladdr);\n         }\n-        \"copy_nonoverlapping_memory\" => {\n-            copy_intrinsic(bcx, false, *substs.tys.get(0))\n-        }\n-        \"copy_memory\" => copy_intrinsic(bcx, true, *substs.tys.get(0)),\n-        \"set_memory\" => memset_intrinsic(bcx, *substs.tys.get(0)),\n+        \"copy_nonoverlapping_memory\" => copy_intrinsic(bcx, false, false, *substs.tys.get(0)),\n+        \"copy_memory\" => copy_intrinsic(bcx, true, false, *substs.tys.get(0)),\n+        \"set_memory\" => memset_intrinsic(bcx, false, *substs.tys.get(0)),\n+\n+        \"volatile_copy_nonoverlapping_memory\" =>\n+            copy_intrinsic(bcx, false, true, *substs.tys.get(0)),\n+        \"volatile_copy_memory\" => copy_intrinsic(bcx, true, true, *substs.tys.get(0)),\n+        \"volatile_set_memory\" => memset_intrinsic(bcx, true, *substs.tys.get(0)),\n+\n         \"ctlz8\" => count_zeros_intrinsic(bcx, \"llvm.ctlz.i8\"),\n         \"ctlz16\" => count_zeros_intrinsic(bcx, \"llvm.ctlz.i16\"),\n         \"ctlz32\" => count_zeros_intrinsic(bcx, \"llvm.ctlz.i32\"),"}, {"sha": "9664ad9fe55c3e98f30c0b409276fd4355f75806", "filename": "src/librustc/middle/typeck/check/mod.rs", "status": "modified", "additions": 3, "deletions": 17, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/b2724727d52904e104ccb3ce14d9dc60ffee1dec/src%2Flibrustc%2Fmiddle%2Ftypeck%2Fcheck%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b2724727d52904e104ccb3ce14d9dc60ffee1dec/src%2Flibrustc%2Fmiddle%2Ftypeck%2Fcheck%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftypeck%2Fcheck%2Fmod.rs?ref=b2724727d52904e104ccb3ce14d9dc60ffee1dec", "patch": "@@ -4127,7 +4127,8 @@ pub fn check_intrinsic_type(ccx: &CrateCtxt, it: &ast::ForeignItem) {\n                    mutbl: ast::MutImmutable\n                }))\n             }\n-            \"copy_nonoverlapping_memory\" => {\n+            \"copy_memory\" | \"copy_nonoverlapping_memory\" |\n+            \"volatile_copy_memory\" | \"volatile_copy_nonoverlapping_memory\" => {\n               (1,\n                vec!(\n                   ty::mk_ptr(tcx, ty::mt {\n@@ -4142,22 +4143,7 @@ pub fn check_intrinsic_type(ccx: &CrateCtxt, it: &ast::ForeignItem) {\n                ),\n                ty::mk_nil())\n             }\n-            \"copy_memory\" => {\n-              (1,\n-               vec!(\n-                  ty::mk_ptr(tcx, ty::mt {\n-                      ty: param(ccx, 0),\n-                      mutbl: ast::MutMutable\n-                  }),\n-                  ty::mk_ptr(tcx, ty::mt {\n-                      ty: param(ccx, 0),\n-                      mutbl: ast::MutImmutable\n-                  }),\n-                  ty::mk_uint()\n-               ),\n-               ty::mk_nil())\n-            }\n-            \"set_memory\" => {\n+            \"set_memory\" | \"volatile_set_memory\" => {\n               (1,\n                vec!(\n                   ty::mk_ptr(tcx, ty::mt {"}, {"sha": "1b419e59a70e6a3689ceb2aee13d367c0e72fa41", "filename": "src/libstd/intrinsics.rs", "status": "modified", "additions": 27, "deletions": 4, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/b2724727d52904e104ccb3ce14d9dc60ffee1dec/src%2Flibstd%2Fintrinsics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b2724727d52904e104ccb3ce14d9dc60ffee1dec/src%2Flibstd%2Fintrinsics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fintrinsics.rs?ref=b2724727d52904e104ccb3ce14d9dc60ffee1dec", "patch": "@@ -261,10 +261,6 @@ extern \"rust-intrinsic\" {\n     /// Execute a breakpoint trap, for inspection by a debugger.\n     pub fn breakpoint();\n \n-    pub fn volatile_load<T>(src: *T) -> T;\n-    pub fn volatile_store<T>(dst: *mut T, val: T);\n-\n-\n     /// The size of a type in bytes.\n     ///\n     /// This is the exact number of bytes in memory taken up by a\n@@ -338,6 +334,33 @@ extern \"rust-intrinsic\" {\n     /// `min_align_of::<T>()`\n     pub fn set_memory<T>(dst: *mut T, val: u8, count: uint);\n \n+    /// Equivalent to the appropriate `llvm.memcpy.p0i8.0i8.*` intrinsic, with\n+    /// a size of `count` * `size_of::<T>()` and an alignment of\n+    /// `min_align_of::<T>()`\n+    ///\n+    /// The volatile parameter parameter is set to `true`, so it will not be optimized out.\n+    #[cfg(not(stage0))]\n+    pub fn volatile_copy_nonoverlapping_memory<T>(dst: *mut T, src: *T, count: uint);\n+    /// Equivalent to the appropriate `llvm.memmove.p0i8.0i8.*` intrinsic, with\n+    /// a size of `count` * `size_of::<T>()` and an alignment of\n+    /// `min_align_of::<T>()`\n+    ///\n+    /// The volatile parameter parameter is set to `true`, so it will not be optimized out.\n+    #[cfg(not(stage0))]\n+    pub fn volatile_copy_memory<T>(dst: *mut T, src: *T, count: uint);\n+    /// Equivalent to the appropriate `llvm.memset.p0i8.*` intrinsic, with a\n+    /// size of `count` * `size_of::<T>()` and an alignment of\n+    /// `min_align_of::<T>()`.\n+    ///\n+    /// The volatile parameter parameter is set to `true`, so it will not be optimized out.\n+    #[cfg(not(stage0))]\n+    pub fn volatile_set_memory<T>(dst: *mut T, val: u8, count: uint);\n+\n+    /// Perform a volatile load from the `src` pointer.\n+    pub fn volatile_load<T>(src: *T) -> T;\n+    /// Perform a volatile store to the `dst` pointer.\n+    pub fn volatile_store<T>(dst: *mut T, val: T);\n+\n     pub fn sqrtf32(x: f32) -> f32;\n     pub fn sqrtf64(x: f64) -> f64;\n "}]}