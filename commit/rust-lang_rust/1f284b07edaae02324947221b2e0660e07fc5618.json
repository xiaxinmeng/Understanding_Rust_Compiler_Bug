{"sha": "1f284b07edaae02324947221b2e0660e07fc5618", "node_id": "C_kwDOAAsO6NoAKDFmMjg0YjA3ZWRhYWUwMjMyNDk0NzIyMWIyZTA2NjBlMDdmYzU2MTg", "commit": {"author": {"name": "Jakub Ber\u00e1nek", "email": "berykubik@gmail.com", "date": "2021-12-13T20:34:54Z"}, "committer": {"name": "Jakub Ber\u00e1nek", "email": "berykubik@gmail.com", "date": "2021-12-13T20:34:54Z"}, "message": "Add special case for length 1", "tree": {"sha": "fa82a04f1184cb3188f4b26c4bc2468608bd7451", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fa82a04f1184cb3188f4b26c4bc2468608bd7451"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1f284b07edaae02324947221b2e0660e07fc5618", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQGzBAABCgAdFiEEg8FrwI85f934CWFa28VT5UDC9hkFAmG3rm4ACgkQ28VT5UDC\n9hnPEAv/eLkb64/PrSH6LRmlZl4xtIo/TEH5JX0kBZkyi9xyN9vZKcvKLP3MMtED\n0Abfx8FsDTrJ1XpEHfuxCKUgHuE9cOBe1VVe1rEzff2kqzDPNsJo8jqWXipS58Sj\naN+rfxeKaIl/TL323RnGCutrwW7hCjXF7C7wNe3ERuwO6I8skDzBzHGwQVA8+8rd\nwoaaVA18S6XZxTL28gH1lOAKUBNi03WZl+ZbqTtp+ypVp33hg/chvvV8JLYzg7hb\n4LKM2St8xK862jlKZrSCtZO7UPHOAJ8q8lpUcwdvWsfGf+s+TlPRTwOlvNdDAU/h\ntoWf0Qf/oaMN67rZ/bXMEFU2M8Wiox1pjI05Qt/7JystEWYjdYqhN26gZdkE3TaW\nDt3yO3GxOSXzh9EDx0bW5xbfKTCam6K2ehq5X4NP8Wp8gWRCx38vpqblbfVjwkXK\nMZmzvNuq+3NGp6Bysorn+r4ArKm0KxoHfZbZMEZthOLYFKwpA6BLeWgiTouA+X8i\nJfo8Birk\n=GItq\n-----END PGP SIGNATURE-----", "payload": "tree fa82a04f1184cb3188f4b26c4bc2468608bd7451\nparent ac08f13948303491ed4a00f0578bd64f0327769c\nauthor Jakub Ber\u00e1nek <berykubik@gmail.com> 1639427694 +0100\ncommitter Jakub Ber\u00e1nek <berykubik@gmail.com> 1639427694 +0100\n\nAdd special case for length 1\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1f284b07edaae02324947221b2e0660e07fc5618", "html_url": "https://github.com/rust-lang/rust/commit/1f284b07edaae02324947221b2e0660e07fc5618", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1f284b07edaae02324947221b2e0660e07fc5618/comments", "author": {"login": "Kobzol", "id": 4539057, "node_id": "MDQ6VXNlcjQ1MzkwNTc=", "avatar_url": "https://avatars.githubusercontent.com/u/4539057?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Kobzol", "html_url": "https://github.com/Kobzol", "followers_url": "https://api.github.com/users/Kobzol/followers", "following_url": "https://api.github.com/users/Kobzol/following{/other_user}", "gists_url": "https://api.github.com/users/Kobzol/gists{/gist_id}", "starred_url": "https://api.github.com/users/Kobzol/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Kobzol/subscriptions", "organizations_url": "https://api.github.com/users/Kobzol/orgs", "repos_url": "https://api.github.com/users/Kobzol/repos", "events_url": "https://api.github.com/users/Kobzol/events{/privacy}", "received_events_url": "https://api.github.com/users/Kobzol/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Kobzol", "id": 4539057, "node_id": "MDQ6VXNlcjQ1MzkwNTc=", "avatar_url": "https://avatars.githubusercontent.com/u/4539057?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Kobzol", "html_url": "https://github.com/Kobzol", "followers_url": "https://api.github.com/users/Kobzol/followers", "following_url": "https://api.github.com/users/Kobzol/following{/other_user}", "gists_url": "https://api.github.com/users/Kobzol/gists{/gist_id}", "starred_url": "https://api.github.com/users/Kobzol/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Kobzol/subscriptions", "organizations_url": "https://api.github.com/users/Kobzol/orgs", "repos_url": "https://api.github.com/users/Kobzol/repos", "events_url": "https://api.github.com/users/Kobzol/events{/privacy}", "received_events_url": "https://api.github.com/users/Kobzol/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ac08f13948303491ed4a00f0578bd64f0327769c", "url": "https://api.github.com/repos/rust-lang/rust/commits/ac08f13948303491ed4a00f0578bd64f0327769c", "html_url": "https://github.com/rust-lang/rust/commit/ac08f13948303491ed4a00f0578bd64f0327769c"}], "stats": {"total": 26, "additions": 17, "deletions": 9}, "files": [{"sha": "144eaed7e076e7af0363655221c1f7ce08d9f240", "filename": "compiler/rustc_data_structures/src/stable_hasher.rs", "status": "modified", "additions": 17, "deletions": 9, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/1f284b07edaae02324947221b2e0660e07fc5618/compiler%2Frustc_data_structures%2Fsrc%2Fstable_hasher.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1f284b07edaae02324947221b2e0660e07fc5618/compiler%2Frustc_data_structures%2Fsrc%2Fstable_hasher.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_data_structures%2Fsrc%2Fstable_hasher.rs?ref=1f284b07edaae02324947221b2e0660e07fc5618", "patch": "@@ -559,20 +559,28 @@ where\n fn stable_hash_reduce<HCX, I, C, F>(\n     hcx: &mut HCX,\n     hasher: &mut StableHasher,\n-    collection: C,\n+    mut collection: C,\n     length: usize,\n     hash_function: F,\n ) where\n     C: Iterator<Item = I>,\n     F: Fn(&mut StableHasher, &mut HCX, I),\n {\n-    let hash = collection\n-        .map(|value| {\n-            let mut hasher = StableHasher::new();\n-            hash_function(&mut hasher, hcx, value);\n-            hasher.finish::<u128>()\n-        })\n-        .reduce(|accum, value| accum.wrapping_add(value));\n     length.hash_stable(hcx, hasher);\n-    hash.hash_stable(hcx, hasher);\n+\n+    match length {\n+        1 => {\n+            hash_function(hasher, hcx, collection.next().unwrap());\n+        }\n+        _ => {\n+            let hash = collection\n+                .map(|value| {\n+                    let mut hasher = StableHasher::new();\n+                    hash_function(&mut hasher, hcx, value);\n+                    hasher.finish::<u128>()\n+                })\n+                .reduce(|accum, value| accum.wrapping_add(value));\n+            hash.hash_stable(hcx, hasher);\n+        }\n+    }\n }"}]}