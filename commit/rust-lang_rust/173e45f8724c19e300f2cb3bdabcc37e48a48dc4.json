{"sha": "173e45f8724c19e300f2cb3bdabcc37e48a48dc4", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE3M2U0NWY4NzI0YzE5ZTMwMGYyY2IzYmRhYmNjMzdlNDhhNDhkYzQ=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-11-02T17:47:08Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-11-02T17:47:08Z"}, "message": "Merge #6365\n\n6365: Do insertion lookahead in algo::diff r=matklad a=Veykril\n\nThis is the last blocker for #6287 after this I can update that PR to properly fix things through using `SyntaxRewriter`.\r\n\r\nThis PR also shuffles tests around a bit and adds some more.\r\n\r\nIdeally this is just a hack until we implement a \"proper\" diff algorithm that approximates a minimal diff. Maybe something like [gumtree](https://github.com/GumTreeDiff/gumtree)?\n\nCo-authored-by: Lukas Wirth <lukastw97@gmail.com>", "tree": {"sha": "3b2249b97075bdf2d5256db3a22d6410a276c285", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3b2249b97075bdf2d5256db3a22d6410a276c285"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/173e45f8724c19e300f2cb3bdabcc37e48a48dc4", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfoEYcCRBK7hj4Ov3rIwAAdHIIAAgKre994Y00vT8VHYof+LbR\nt/Fdt8cmFJ5ZXUyQ9OL2qiuA+B9fqILZWrmQC7jo5fGpzNlO8byQpvuJt7yHFena\n1Xv+87B0kZcY8Vwaj1ygQGE2ShQlgBV1QsfvJLhM15zFKJVczG4wrbE941Y2ioo8\neLDe9bhPGDfzv/36mbAW6rY5WmV42PR7PkENGR9NpnwZLY7U1Z1ZoyOGU4fE+T/V\n3MnXuM7E3HR5ipFUjSJemipTVNLaaLQbtzXwUUUiClai8T4UNTm/mPyWEBf0QsUy\ngiKxUqxuNqiTJgGJT4XH/5V7/+eJHJKGMnoCjNXvl3hfYwGlAoWyuwyWwPhvWwE=\n=MJm0\n-----END PGP SIGNATURE-----\n", "payload": "tree 3b2249b97075bdf2d5256db3a22d6410a276c285\nparent d021dbeb4fa837aa0a6ec65aa9391499d78897e8\nparent 750ab54573908774d81be82979bc1d328c43c35e\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1604339228 +0000\ncommitter GitHub <noreply@github.com> 1604339228 +0000\n\nMerge #6365\n\n6365: Do insertion lookahead in algo::diff r=matklad a=Veykril\n\nThis is the last blocker for #6287 after this I can update that PR to properly fix things through using `SyntaxRewriter`.\r\n\r\nThis PR also shuffles tests around a bit and adds some more.\r\n\r\nIdeally this is just a hack until we implement a \"proper\" diff algorithm that approximates a minimal diff. Maybe something like [gumtree](https://github.com/GumTreeDiff/gumtree)?\n\nCo-authored-by: Lukas Wirth <lukastw97@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/173e45f8724c19e300f2cb3bdabcc37e48a48dc4", "html_url": "https://github.com/rust-lang/rust/commit/173e45f8724c19e300f2cb3bdabcc37e48a48dc4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/173e45f8724c19e300f2cb3bdabcc37e48a48dc4/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d021dbeb4fa837aa0a6ec65aa9391499d78897e8", "url": "https://api.github.com/repos/rust-lang/rust/commits/d021dbeb4fa837aa0a6ec65aa9391499d78897e8", "html_url": "https://github.com/rust-lang/rust/commit/d021dbeb4fa837aa0a6ec65aa9391499d78897e8"}, {"sha": "750ab54573908774d81be82979bc1d328c43c35e", "url": "https://api.github.com/repos/rust-lang/rust/commits/750ab54573908774d81be82979bc1d328c43c35e", "html_url": "https://github.com/rust-lang/rust/commit/750ab54573908774d81be82979bc1d328c43c35e"}], "stats": {"total": 162, "additions": 121, "deletions": 41}, "files": [{"sha": "1c7f0276321fdc338f100ebe9f1b2639d48e27a7", "filename": "crates/ide/src/diagnostics.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/173e45f8724c19e300f2cb3bdabcc37e48a48dc4/crates%2Fide%2Fsrc%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/173e45f8724c19e300f2cb3bdabcc37e48a48dc4/crates%2Fide%2Fsrc%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fdiagnostics.rs?ref=173e45f8724c19e300f2cb3bdabcc37e48a48dc4", "patch": "@@ -613,7 +613,7 @@ fn main() {\n pub struct Foo { pub a: i32, pub b: i32 }\n \"#,\n             r#\"\n-fn some(, b: ()} {}\n+fn some(, b: ()) {}\n fn items() {}\n fn here() {}\n "}, {"sha": "9dc7182bdb90ac700a18594b0eb53c0aef4e328d", "filename": "crates/syntax/src/algo.rs", "status": "modified", "additions": 120, "deletions": 40, "changes": 160, "blob_url": "https://github.com/rust-lang/rust/blob/173e45f8724c19e300f2cb3bdabcc37e48a48dc4/crates%2Fsyntax%2Fsrc%2Falgo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/173e45f8724c19e300f2cb3bdabcc37e48a48dc4/crates%2Fsyntax%2Fsrc%2Falgo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fsyntax%2Fsrc%2Falgo.rs?ref=173e45f8724c19e300f2cb3bdabcc37e48a48dc4", "patch": "@@ -137,7 +137,7 @@ impl TreeDiff {\n     }\n }\n \n-/// Finds minimal the diff, which, applied to `from`, will result in `to`.\n+/// Finds a (potentially minimal) diff, which, applied to `from`, will result in `to`.\n ///\n /// Specifically, returns a structure that consists of a replacements, insertions and deletions\n /// such that applying this map on `from` will result in `to`.\n@@ -151,7 +151,6 @@ pub fn diff(from: &SyntaxNode, to: &SyntaxNode) -> TreeDiff {\n     };\n     let (from, to) = (from.clone().into(), to.clone().into());\n \n-    // FIXME: this is horrible inefficient. I bet there's a cool algorithm to diff trees properly.\n     if !syntax_element_eq(&from, &to) {\n         go(&mut diff, from, to);\n     }\n@@ -169,6 +168,7 @@ pub fn diff(from: &SyntaxNode, to: &SyntaxNode) -> TreeDiff {\n             }\n     }\n \n+    // FIXME: this is horrible inefficient. I bet there's a cool algorithm to diff trees properly.\n     fn go(diff: &mut TreeDiff, lhs: SyntaxElement, rhs: SyntaxElement) {\n         let (lhs, rhs) = match lhs.as_node().zip(rhs.as_node()) {\n             Some((lhs, rhs)) => (lhs, rhs),\n@@ -179,6 +179,8 @@ pub fn diff(from: &SyntaxNode, to: &SyntaxNode) -> TreeDiff {\n             }\n         };\n \n+        let mut look_ahead_scratch = Vec::default();\n+\n         let mut rhs_children = rhs.children_with_tokens();\n         let mut lhs_children = lhs.children_with_tokens();\n         let mut last_lhs = None;\n@@ -204,7 +206,31 @@ pub fn diff(from: &SyntaxNode, to: &SyntaxNode) -> TreeDiff {\n                     diff.deletions.push(element);\n                 }\n                 (Some(ref lhs_ele), Some(ref rhs_ele)) if syntax_element_eq(lhs_ele, rhs_ele) => {}\n-                (Some(lhs_ele), Some(rhs_ele)) => go(diff, lhs_ele, rhs_ele),\n+                (Some(lhs_ele), Some(rhs_ele)) => {\n+                    // nodes differ, look for lhs_ele in rhs, if its found we can mark everything up\n+                    // until that element as insertions. This is important to keep the diff minimal\n+                    // in regards to insertions that have been actually done, this is important for\n+                    // use insertions as we do not want to replace the entire module node.\n+                    look_ahead_scratch.push(rhs_ele.clone());\n+                    let mut rhs_children_clone = rhs_children.clone();\n+                    let mut insert = false;\n+                    while let Some(rhs_child) = rhs_children_clone.next() {\n+                        if syntax_element_eq(&lhs_ele, &rhs_child) {\n+                            mark::hit!(diff_insertions);\n+                            insert = true;\n+                            break;\n+                        } else {\n+                            look_ahead_scratch.push(rhs_child);\n+                        }\n+                    }\n+                    let drain = look_ahead_scratch.drain(..);\n+                    if let Some(prev) = last_lhs.clone().filter(|_| insert) {\n+                        diff.insertions.entry(prev).or_insert_with(Vec::new).extend(drain);\n+                        rhs_children = rhs_children_clone;\n+                    } else {\n+                        go(diff, lhs_ele, rhs_ele)\n+                    }\n+                }\n             }\n             last_lhs = lhs_child.or(last_lhs);\n         }\n@@ -292,7 +318,6 @@ fn _replace_children(\n #[derive(Debug, PartialEq, Eq, Hash)]\n enum InsertPos {\n     FirstChildOf(SyntaxNode),\n-    // Before(SyntaxElement),\n     After(SyntaxElement),\n }\n \n@@ -603,18 +628,44 @@ mod tests {\n     }\n \n     #[test]\n-    fn insert() {\n+    fn replace_parent() {\n+        mark::check!(diff_replace_parent);\n+        check_diff(\n+            r#\"\"#,\n+            r#\"use foo::bar;\"#,\n+            expect![[r#\"\n+                insertions:\n+\n+\n+\n+                replacements:\n+\n+                Line 0: Node(SOURCE_FILE@0..0) -> use foo::bar;\n+\n+                deletions:\n+\n+\n+            \"#]],\n+        );\n+    }\n+\n+    #[test]\n+    fn insert_last() {\n         mark::check!(diff_insert);\n         check_diff(\n-            r#\"use foo;\"#,\n-            r#\"use foo;\n+            r#\"\n+use foo;\n use bar;\"#,\n+            r#\"\n+use foo;\n+use bar;\n+use baz;\"#,\n             expect![[r#\"\n                 insertions:\n \n-                Line 0: Node(USE@0..8)\n+                Line 2: Node(USE@10..18)\n                 -> \"\\n\"\n-                -> use bar;\n+                -> use baz;\n \n                 replacements:\n \n@@ -628,29 +679,63 @@ use bar;\"#,\n     }\n \n     #[test]\n-    fn replace_parent() {\n-        mark::check!(diff_replace_parent);\n+    fn insert_middle() {\n         check_diff(\n-            r#\"\"#,\n-            r#\"use foo::bar;\"#,\n+            r#\"\n+use foo;\n+use baz;\"#,\n+            r#\"\n+use foo;\n+use bar;\n+use baz;\"#,\n             expect![[r#\"\n                 insertions:\n \n+                Line 2: Token(WHITESPACE@9..10 \"\\n\")\n+                -> use bar;\n+                -> \"\\n\"\n+\n+                replacements:\n+\n+\n+\n+                deletions:\n+\n+\n+            \"#]],\n+        )\n+    }\n+\n+    #[test]\n+    fn insert_first() {\n+        check_diff(\n+            r#\"\n+use bar;\n+use baz;\"#,\n+            r#\"\n+use foo;\n+use bar;\n+use baz;\"#,\n+            expect![[r#\"\n+                insertions:\n \n+                Line 0: Token(WHITESPACE@0..1 \"\\n\")\n+                -> use foo;\n+                -> \"\\n\"\n \n                 replacements:\n \n-                Line 0: Node(SOURCE_FILE@0..0) -> use foo::bar;\n+\n \n                 deletions:\n \n \n             \"#]],\n-        );\n+        )\n     }\n \n     #[test]\n-    fn delete() {\n+    fn delete_last() {\n         mark::check!(diff_delete);\n         check_diff(\n             r#\"use foo;\n@@ -674,52 +759,50 @@ use bar;\"#,\n     }\n \n     #[test]\n-    fn insert_use() {\n+    fn delete_middle() {\n+        mark::check!(diff_insertions);\n         check_diff(\n             r#\"\n use expect_test::{expect, Expect};\n+use text_edit::TextEdit;\n \n use crate::AstNode;\n \"#,\n             r#\"\n use expect_test::{expect, Expect};\n-use text_edit::TextEdit;\n \n use crate::AstNode;\n \"#,\n             expect![[r#\"\n                 insertions:\n \n-                Line 4: Token(WHITESPACE@56..57 \"\\n\")\n+                Line 1: Node(USE@1..35)\n+                -> \"\\n\\n\"\n                 -> use crate::AstNode;\n-                -> \"\\n\"\n \n                 replacements:\n \n-                Line 2: Token(WHITESPACE@35..37 \"\\n\\n\") -> \"\\n\"\n-                Line 4: Token(CRATE_KW@41..46 \"crate\") -> text_edit\n-                Line 4: Token(IDENT@48..55 \"AstNode\") -> TextEdit\n-                Line 4: Token(WHITESPACE@56..57 \"\\n\") -> \"\\n\\n\"\n \n-                deletions:\n \n+                deletions:\n \n+                Line 2: use text_edit::TextEdit;\n+                Line 3: \"\\n\\n\"\n+                Line 4: use crate::AstNode;\n+                Line 5: \"\\n\"\n             \"#]],\n         )\n     }\n \n     #[test]\n-    fn remove_use() {\n+    fn delete_first() {\n         check_diff(\n             r#\"\n-use expect_test::{expect, Expect};\n use text_edit::TextEdit;\n \n use crate::AstNode;\n \"#,\n             r#\"\n-use expect_test::{expect, Expect};\n-\n use crate::AstNode;\n \"#,\n             expect![[r#\"\n@@ -729,15 +812,14 @@ use crate::AstNode;\n \n                 replacements:\n \n-                Line 2: Token(WHITESPACE@35..36 \"\\n\") -> \"\\n\\n\"\n-                Line 3: Node(NAME_REF@40..49) -> crate\n-                Line 3: Token(IDENT@51..59 \"TextEdit\") -> AstNode\n-                Line 3: Token(WHITESPACE@60..62 \"\\n\\n\") -> \"\\n\"\n+                Line 2: Node(NAME_REF@5..14) -> crate\n+                Line 2: Token(IDENT@16..24 \"TextEdit\") -> AstNode\n+                Line 2: Token(WHITESPACE@25..27 \"\\n\\n\") -> \"\\n\"\n \n                 deletions:\n \n-                Line 4: use crate::AstNode;\n-                Line 5: \"\\n\"\n+                Line 3: use crate::AstNode;\n+                Line 4: \"\\n\"\n             \"#]],\n         )\n     }\n@@ -814,17 +896,15 @@ fn main() {\n                         _ => return,\n                     }\n                 -> ;\n-                Line 5: Token(R_CURLY@64..65 \"}\")\n-                -> \"\\n\"\n-                -> }\n+                Line 3: Node(IF_EXPR@17..63)\n+                -> \"\\n    \"\n+                -> foo(x);\n \n                 replacements:\n \n                 Line 3: Token(IF_KW@17..19 \"if\") -> let\n                 Line 3: Token(LET_KW@20..23 \"let\") -> x\n                 Line 3: Node(BLOCK_EXPR@40..63) -> =\n-                Line 5: Token(WHITESPACE@63..64 \"\\n\") -> \"\\n    \"\n-                Line 5: Token(R_CURLY@64..65 \"}\") -> foo(x);\n \n                 deletions:\n "}]}