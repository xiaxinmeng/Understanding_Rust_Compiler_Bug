{"sha": "ea10842d95ff3b080c26a02bf8626d9d0956481b", "node_id": "MDY6Q29tbWl0NzI0NzEyOmVhMTA4NDJkOTVmZjNiMDgwYzI2YTAyYmY4NjI2ZDlkMDk1NjQ4MWI=", "commit": {"author": {"name": "bjorn3", "email": "bjorn3@users.noreply.github.com", "date": "2019-02-18T17:26:59Z"}, "committer": {"name": "bjorn3", "email": "bjorn3@users.noreply.github.com", "date": "2019-02-18T17:26:59Z"}, "message": "Update cranelift", "tree": {"sha": "4bfb344288f3fdb5d800cde9427fe4dab41118f5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4bfb344288f3fdb5d800cde9427fe4dab41118f5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ea10842d95ff3b080c26a02bf8626d9d0956481b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ea10842d95ff3b080c26a02bf8626d9d0956481b", "html_url": "https://github.com/rust-lang/rust/commit/ea10842d95ff3b080c26a02bf8626d9d0956481b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ea10842d95ff3b080c26a02bf8626d9d0956481b/comments", "author": {"login": "bjorn3", "id": 17426603, "node_id": "MDQ6VXNlcjE3NDI2NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/17426603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bjorn3", "html_url": "https://github.com/bjorn3", "followers_url": "https://api.github.com/users/bjorn3/followers", "following_url": "https://api.github.com/users/bjorn3/following{/other_user}", "gists_url": "https://api.github.com/users/bjorn3/gists{/gist_id}", "starred_url": "https://api.github.com/users/bjorn3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bjorn3/subscriptions", "organizations_url": "https://api.github.com/users/bjorn3/orgs", "repos_url": "https://api.github.com/users/bjorn3/repos", "events_url": "https://api.github.com/users/bjorn3/events{/privacy}", "received_events_url": "https://api.github.com/users/bjorn3/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bjorn3", "id": 17426603, "node_id": "MDQ6VXNlcjE3NDI2NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/17426603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bjorn3", "html_url": "https://github.com/bjorn3", "followers_url": "https://api.github.com/users/bjorn3/followers", "following_url": "https://api.github.com/users/bjorn3/following{/other_user}", "gists_url": "https://api.github.com/users/bjorn3/gists{/gist_id}", "starred_url": "https://api.github.com/users/bjorn3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bjorn3/subscriptions", "organizations_url": "https://api.github.com/users/bjorn3/orgs", "repos_url": "https://api.github.com/users/bjorn3/repos", "events_url": "https://api.github.com/users/bjorn3/events{/privacy}", "received_events_url": "https://api.github.com/users/bjorn3/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1b4aad8615700ecd9f001c4f7129a0435ac5a542", "url": "https://api.github.com/repos/rust-lang/rust/commits/1b4aad8615700ecd9f001c4f7129a0435ac5a542", "html_url": "https://github.com/rust-lang/rust/commit/1b4aad8615700ecd9f001c4f7129a0435ac5a542"}], "stats": {"total": 64, "additions": 29, "deletions": 35}, "files": [{"sha": "23bb51844f5bff15bee3f2039128f98733915133", "filename": "Cargo.lock", "status": "modified", "additions": 10, "deletions": 10, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/ea10842d95ff3b080c26a02bf8626d9d0956481b/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/ea10842d95ff3b080c26a02bf8626d9d0956481b/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=ea10842d95ff3b080c26a02bf8626d9d0956481b", "patch": "@@ -114,7 +114,7 @@ dependencies = [\n [[package]]\n name = \"cranelift\"\n version = \"0.28.0\"\n-source = \"git+https://github.com/CraneStation/cranelift.git#2145dd3ffaedaea4db1bc4f238550beae3f0492e\"\n+source = \"git+https://github.com/CraneStation/cranelift.git#50c66ae4788ff9a1715f220d2331df575017fa17\"\n dependencies = [\n  \"cranelift-codegen 0.28.0 (git+https://github.com/CraneStation/cranelift.git)\",\n  \"cranelift-frontend 0.28.0 (git+https://github.com/CraneStation/cranelift.git)\",\n@@ -123,15 +123,15 @@ dependencies = [\n [[package]]\n name = \"cranelift-bforest\"\n version = \"0.28.0\"\n-source = \"git+https://github.com/CraneStation/cranelift.git#2145dd3ffaedaea4db1bc4f238550beae3f0492e\"\n+source = \"git+https://github.com/CraneStation/cranelift.git#50c66ae4788ff9a1715f220d2331df575017fa17\"\n dependencies = [\n  \"cranelift-entity 0.28.0 (git+https://github.com/CraneStation/cranelift.git)\",\n ]\n \n [[package]]\n name = \"cranelift-codegen\"\n version = \"0.28.0\"\n-source = \"git+https://github.com/CraneStation/cranelift.git#2145dd3ffaedaea4db1bc4f238550beae3f0492e\"\n+source = \"git+https://github.com/CraneStation/cranelift.git#50c66ae4788ff9a1715f220d2331df575017fa17\"\n dependencies = [\n  \"cranelift-bforest 0.28.0 (git+https://github.com/CraneStation/cranelift.git)\",\n  \"cranelift-codegen-meta 0.28.0 (git+https://github.com/CraneStation/cranelift.git)\",\n@@ -145,20 +145,20 @@ dependencies = [\n [[package]]\n name = \"cranelift-codegen-meta\"\n version = \"0.28.0\"\n-source = \"git+https://github.com/CraneStation/cranelift.git#2145dd3ffaedaea4db1bc4f238550beae3f0492e\"\n+source = \"git+https://github.com/CraneStation/cranelift.git#50c66ae4788ff9a1715f220d2331df575017fa17\"\n dependencies = [\n  \"cranelift-entity 0.28.0 (git+https://github.com/CraneStation/cranelift.git)\",\n ]\n \n [[package]]\n name = \"cranelift-entity\"\n version = \"0.28.0\"\n-source = \"git+https://github.com/CraneStation/cranelift.git#2145dd3ffaedaea4db1bc4f238550beae3f0492e\"\n+source = \"git+https://github.com/CraneStation/cranelift.git#50c66ae4788ff9a1715f220d2331df575017fa17\"\n \n [[package]]\n name = \"cranelift-faerie\"\n version = \"0.28.0\"\n-source = \"git+https://github.com/CraneStation/cranelift.git#2145dd3ffaedaea4db1bc4f238550beae3f0492e\"\n+source = \"git+https://github.com/CraneStation/cranelift.git#50c66ae4788ff9a1715f220d2331df575017fa17\"\n dependencies = [\n  \"cranelift-codegen 0.28.0 (git+https://github.com/CraneStation/cranelift.git)\",\n  \"cranelift-module 0.28.0 (git+https://github.com/CraneStation/cranelift.git)\",\n@@ -171,7 +171,7 @@ dependencies = [\n [[package]]\n name = \"cranelift-frontend\"\n version = \"0.28.0\"\n-source = \"git+https://github.com/CraneStation/cranelift.git#2145dd3ffaedaea4db1bc4f238550beae3f0492e\"\n+source = \"git+https://github.com/CraneStation/cranelift.git#50c66ae4788ff9a1715f220d2331df575017fa17\"\n dependencies = [\n  \"cranelift-codegen 0.28.0 (git+https://github.com/CraneStation/cranelift.git)\",\n  \"log 0.4.6 (registry+https://github.com/rust-lang/crates.io-index)\",\n@@ -181,7 +181,7 @@ dependencies = [\n [[package]]\n name = \"cranelift-module\"\n version = \"0.28.0\"\n-source = \"git+https://github.com/CraneStation/cranelift.git#2145dd3ffaedaea4db1bc4f238550beae3f0492e\"\n+source = \"git+https://github.com/CraneStation/cranelift.git#50c66ae4788ff9a1715f220d2331df575017fa17\"\n dependencies = [\n  \"cranelift-codegen 0.28.0 (git+https://github.com/CraneStation/cranelift.git)\",\n  \"cranelift-entity 0.28.0 (git+https://github.com/CraneStation/cranelift.git)\",\n@@ -192,7 +192,7 @@ dependencies = [\n [[package]]\n name = \"cranelift-native\"\n version = \"0.28.0\"\n-source = \"git+https://github.com/CraneStation/cranelift.git#2145dd3ffaedaea4db1bc4f238550beae3f0492e\"\n+source = \"git+https://github.com/CraneStation/cranelift.git#50c66ae4788ff9a1715f220d2331df575017fa17\"\n dependencies = [\n  \"cranelift-codegen 0.28.0 (git+https://github.com/CraneStation/cranelift.git)\",\n  \"raw-cpuid 6.1.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n@@ -202,7 +202,7 @@ dependencies = [\n [[package]]\n name = \"cranelift-simplejit\"\n version = \"0.28.0\"\n-source = \"git+https://github.com/CraneStation/cranelift.git#2145dd3ffaedaea4db1bc4f238550beae3f0492e\"\n+source = \"git+https://github.com/CraneStation/cranelift.git#50c66ae4788ff9a1715f220d2331df575017fa17\"\n dependencies = [\n  \"cranelift-codegen 0.28.0 (git+https://github.com/CraneStation/cranelift.git)\",\n  \"cranelift-module 0.28.0 (git+https://github.com/CraneStation/cranelift.git)\","}, {"sha": "f76b3cd8593d0807028fe75f97138d861b50e712", "filename": "src/base.rs", "status": "modified", "additions": 8, "deletions": 7, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/ea10842d95ff3b080c26a02bf8626d9d0956481b/src%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ea10842d95ff3b080c26a02bf8626d9d0956481b/src%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbase.rs?ref=ea10842d95ff3b080c26a02bf8626d9d0956481b", "patch": "@@ -127,13 +127,14 @@ fn trans_fn<'a, 'clif, 'tcx: 'a, B: Backend + 'static>(\n \n     // Step 9. Define function\n     cx.caches.context.func = func;\n-    cx.module\n-        .define_function_peek_compiled(func_id, &mut cx.caches.context, |size, context, isa| {\n-            debug_context.as_mut().map(|x| x.define(tcx, size, context, isa, &source_info_set));\n-        })\n-        .unwrap();\n-    //let module = &mut cx.module;\n-    //let caches = &cx.caches;\n+    cx.module.define_function(func_id, &mut cx.caches.context).unwrap();\n+\n+    // Step 10. Define debuginfo for function\n+    let context = &cx.caches.context;\n+    let isa = cx.module.isa();\n+    debug_context.as_mut().map(|x| x.define(tcx, context, isa, &source_info_set));\n+\n+    // Step 11. Clear context to make it usable for the next function\n     cx.caches.context.clear();\n }\n "}, {"sha": "9fab9c612e1b421e227c6e29d652362f4b198910", "filename": "src/debuginfo.rs", "status": "modified", "additions": 11, "deletions": 18, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/ea10842d95ff3b080c26a02bf8626d9d0956481b/src%2Fdebuginfo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ea10842d95ff3b080c26a02bf8626d9d0956481b/src%2Fdebuginfo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdebuginfo.rs?ref=ea10842d95ff3b080c26a02bf8626d9d0956481b", "patch": "@@ -264,23 +264,10 @@ impl<'a, 'b, 'tcx: 'b> FunctionDebugContext<'a, 'tcx> {\n     pub fn define(\n         &mut self,\n         tcx: TyCtxt,\n-        //module: &mut Module<impl Backend>,\n-        code_size: u32,\n         context: &Context,\n         isa: &cranelift::codegen::isa::TargetIsa,\n         source_info_set: &indexmap::IndexSet<SourceInfo>,\n     ) {\n-        let entry = self.debug_context.dwarf.unit.get_mut(self.entry_id);\n-        entry.set(gimli::DW_AT_high_pc, AttributeValue::Udata(code_size as u64));\n-\n-        self.debug_context.unit_range_list.0.push(Range::StartLength {\n-            begin: Address::Relative {\n-                symbol: self.symbol,\n-                addend: 0,\n-            },\n-            length: code_size as u64,\n-        });\n-\n         let line_program = &mut self.debug_context.dwarf.unit.line_program;\n \n         line_program.begin_sequence(Some(Address::Relative {\n@@ -327,12 +314,18 @@ impl<'a, 'b, 'tcx: 'b> FunctionDebugContext<'a, 'tcx> {\n             }\n         }\n \n-        if code_size != end {\n-            line_program.row().address_offset = end as u64;\n-            create_row_for_span(line_program, self.mir_span);\n-        }\n+        line_program.end_sequence(end as u64);\n+\n+        let entry = self.debug_context.dwarf.unit.get_mut(self.entry_id);\n+        entry.set(gimli::DW_AT_high_pc, AttributeValue::Udata(end as u64));\n \n-        line_program.end_sequence(code_size as u64);\n+        self.debug_context.unit_range_list.0.push(Range::StartLength {\n+            begin: Address::Relative {\n+                symbol: self.symbol,\n+                addend: 0,\n+            },\n+            length: end as u64,\n+        });\n     }\n }\n "}]}