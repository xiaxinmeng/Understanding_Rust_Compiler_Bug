{"sha": "ee12992da955d3ec8132b5c5c4579b3535da05e6", "node_id": "MDY6Q29tbWl0NzI0NzEyOmVlMTI5OTJkYTk1NWQzZWM4MTMyYjVjNWM0NTc5YjM1MzVkYTA1ZTY=", "commit": {"author": {"name": "Pietro Albini", "email": "pietro@pietroalbini.org", "date": "2019-11-18T14:34:07Z"}, "committer": {"name": "Pietro Albini", "email": "pietro@pietroalbini.org", "date": "2019-11-22T14:36:37Z"}, "message": "ci: guess some environment variables based on builder name and os\n\nSome environment variables (like DEPLOY or DEPLOY_ALT for dist builders,\nor IMAGE on Linux builders) are set on a lot of builders, and whether\nthey should be present or not can be detected automatically based on the\nbuilder name and the platform.\n\nThis commit simplifies the CI configuration by automatically setting\nthose environment variables.", "tree": {"sha": "5ddfb43a59bb75d59e20f9c752f0a334a0a442e0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5ddfb43a59bb75d59e20f9c752f0a334a0a442e0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ee12992da955d3ec8132b5c5c4579b3535da05e6", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE1JbYPtLJAsc22U9xPgar6Auq8ZwFAl3X8nYACgkQPgar6Auq\n8Zx5rA/5AcVe2NlveJ7Mim3sZ7zfFOBZZPvsxi3uNRcJLLO5rjtAdmMJzZhRDq3b\nlJGT8+ZpBpOdWiwydsjX0yjdfyJxJ6sKRRJ7/yUSXnQoogDGKJWNiFQRjoWHHICH\nKu+EHsH+9nfcRFtXmmFKQ3hY+ggl+VCC8VAsjySGZHDVn3NXgKMAjCd2Y0YkKATe\nQfGLgACc177U6VIfdCaZG7ldpfHTjf/QNbd+PZQ9oDyjZUC/D3QMymUpkFTsmdzT\nO20fVICvf4Oy9CIr9A9Ibxho51h5xkTItCt5j62Hn9ZwZIQZe/8r/wB0NPzKMARO\nIEZL76c52fPCuqyYKPd+UN9nRrjF+2bt8cco2K4ZDFZtwZ8XDGg/d/6ZGnTNIdcu\nyw+DRTS8lcWxGhOmV5f8QOT0V2S8VRvOuqX7HDr9apsxKcxxK9Oh0aXMZD5RbNDH\n86lCu1o2d/18CHmsVWc0bJvgReYdV4Og0LLUYqVToMI4DqyPt86xykdud1OsdgGG\n3gEaEukRJGJxTSTirFM2jlQnmcFnY4ndXtHKJ6MlZkekO0tVe0pMOllpOeun+U3i\nlkuJWv1YwIpzwYJ3yjfQGhO+7XoboXY8Z1InV9qkNsUNtxdDXsB9iwRlF637PYE2\nYmQpaSc0rDiMjp5d83OKgvnrV60/SLQ9EyeztNdL5Ig05AbUAZM=\n=FWXR\n-----END PGP SIGNATURE-----", "payload": "tree 5ddfb43a59bb75d59e20f9c752f0a334a0a442e0\nparent 262ce313d065a40561e0da9a65ec6b5d35641560\nauthor Pietro Albini <pietro@pietroalbini.org> 1574087647 +0100\ncommitter Pietro Albini <pietro@pietroalbini.org> 1574433397 +0100\n\nci: guess some environment variables based on builder name and os\n\nSome environment variables (like DEPLOY or DEPLOY_ALT for dist builders,\nor IMAGE on Linux builders) are set on a lot of builders, and whether\nthey should be present or not can be detected automatically based on the\nbuilder name and the platform.\n\nThis commit simplifies the CI configuration by automatically setting\nthose environment variables.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ee12992da955d3ec8132b5c5c4579b3535da05e6", "html_url": "https://github.com/rust-lang/rust/commit/ee12992da955d3ec8132b5c5c4579b3535da05e6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ee12992da955d3ec8132b5c5c4579b3535da05e6/comments", "author": {"login": "pietroalbini", "id": 2299951, "node_id": "MDQ6VXNlcjIyOTk5NTE=", "avatar_url": "https://avatars.githubusercontent.com/u/2299951?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pietroalbini", "html_url": "https://github.com/pietroalbini", "followers_url": "https://api.github.com/users/pietroalbini/followers", "following_url": "https://api.github.com/users/pietroalbini/following{/other_user}", "gists_url": "https://api.github.com/users/pietroalbini/gists{/gist_id}", "starred_url": "https://api.github.com/users/pietroalbini/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pietroalbini/subscriptions", "organizations_url": "https://api.github.com/users/pietroalbini/orgs", "repos_url": "https://api.github.com/users/pietroalbini/repos", "events_url": "https://api.github.com/users/pietroalbini/events{/privacy}", "received_events_url": "https://api.github.com/users/pietroalbini/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pietroalbini", "id": 2299951, "node_id": "MDQ6VXNlcjIyOTk5NTE=", "avatar_url": "https://avatars.githubusercontent.com/u/2299951?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pietroalbini", "html_url": "https://github.com/pietroalbini", "followers_url": "https://api.github.com/users/pietroalbini/followers", "following_url": "https://api.github.com/users/pietroalbini/following{/other_user}", "gists_url": "https://api.github.com/users/pietroalbini/gists{/gist_id}", "starred_url": "https://api.github.com/users/pietroalbini/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pietroalbini/subscriptions", "organizations_url": "https://api.github.com/users/pietroalbini/orgs", "repos_url": "https://api.github.com/users/pietroalbini/repos", "events_url": "https://api.github.com/users/pietroalbini/events{/privacy}", "received_events_url": "https://api.github.com/users/pietroalbini/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "262ce313d065a40561e0da9a65ec6b5d35641560", "url": "https://api.github.com/repos/rust-lang/rust/commits/262ce313d065a40561e0da9a65ec6b5d35641560", "html_url": "https://github.com/rust-lang/rust/commit/262ce313d065a40561e0da9a65ec6b5d35641560"}], "stats": {"total": 215, "additions": 72, "deletions": 143}, "files": [{"sha": "bfe5174bf1e5734410950ca6e085e3a97e881b78", "filename": "src/ci/azure-pipelines/auto.yml", "status": "modified", "additions": 35, "deletions": 133, "changes": 168, "blob_url": "https://github.com/rust-lang/rust/blob/ee12992da955d3ec8132b5c5c4579b3535da05e6/src%2Fci%2Fazure-pipelines%2Fauto.yml", "raw_url": "https://github.com/rust-lang/rust/raw/ee12992da955d3ec8132b5c5c4579b3535da05e6/src%2Fci%2Fazure-pipelines%2Fauto.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fazure-pipelines%2Fauto.yml?ref=ee12992da955d3ec8132b5c5c4579b3535da05e6", "patch": "@@ -19,136 +19,46 @@ jobs:\n   strategy:\n     matrix:\n       x86_64-gnu-llvm-6.0:\n-        IMAGE: x86_64-gnu-llvm-6.0\n         RUST_BACKTRACE: 1\n-\n-      dist-x86_64-linux:\n-        IMAGE: dist-x86_64-linux\n-        DEPLOY: 1\n-\n-      # \"alternate\" deployments, these are \"nightlies\" but have LLVM assertions\n-      # turned on, they're deployed to a different location primarily for\n-      # additional testing.\n+      dist-x86_64-linux: {}\n       dist-x86_64-linux-alt:\n         IMAGE: dist-x86_64-linux\n-        DEPLOY_ALT: 1\n-\n-      # Linux builders, remaining docker images\n-      arm-android:\n-        IMAGE: arm-android\n-\n-      armhf-gnu:\n-        IMAGE: armhf-gnu\n-\n-      dist-various-1:\n-        IMAGE: dist-various-1\n-        DEPLOY: 1\n-\n-      dist-various-2:\n-        IMAGE: dist-various-2\n-        DEPLOY: 1\n-\n-      dist-aarch64-linux:\n-        IMAGE: dist-aarch64-linux\n-        DEPLOY: 1\n-\n-      dist-android:\n-        IMAGE: dist-android\n-        DEPLOY: 1\n-\n-      dist-arm-linux:\n-        IMAGE: dist-arm-linux\n-        DEPLOY: 1\n-\n-      dist-armhf-linux:\n-        IMAGE: dist-armhf-linux\n-        DEPLOY: 1\n-\n-      dist-armv7-linux:\n-        IMAGE: dist-armv7-linux\n-        DEPLOY: 1\n-\n-      dist-i586-gnu-i586-i686-musl:\n-        IMAGE: dist-i586-gnu-i586-i686-musl\n-        DEPLOY: 1\n-\n-      dist-i686-freebsd:\n-        IMAGE: dist-i686-freebsd\n-        DEPLOY: 1\n-\n-      dist-i686-linux:\n-        IMAGE: dist-i686-linux\n-        DEPLOY: 1\n-\n-      dist-mips-linux:\n-        IMAGE: dist-mips-linux\n-        DEPLOY: 1\n-\n-      dist-mips64-linux:\n-        IMAGE: dist-mips64-linux\n-        DEPLOY: 1\n-\n-      dist-mips64el-linux:\n-        IMAGE: dist-mips64el-linux\n-        DEPLOY: 1\n-\n-      dist-mipsel-linux:\n-        IMAGE: dist-mipsel-linux\n-        DEPLOY: 1\n-\n-      dist-powerpc-linux:\n-        IMAGE: dist-powerpc-linux\n-        DEPLOY: 1\n-\n-      dist-powerpc64-linux:\n-        IMAGE: dist-powerpc64-linux\n-        DEPLOY: 1\n-\n-      dist-powerpc64le-linux:\n-        IMAGE: dist-powerpc64le-linux\n-        DEPLOY: 1\n-\n-      dist-s390x-linux:\n-        IMAGE: dist-s390x-linux\n-        DEPLOY: 1\n-\n-      dist-x86_64-freebsd:\n-        IMAGE: dist-x86_64-freebsd\n-        DEPLOY: 1\n-\n-      dist-x86_64-musl:\n-        IMAGE: dist-x86_64-musl\n-        DEPLOY: 1\n-\n-      dist-x86_64-netbsd:\n-        IMAGE: dist-x86_64-netbsd\n-        DEPLOY: 1\n-\n-      i686-gnu:\n-        IMAGE: i686-gnu\n-      i686-gnu-nopt:\n-        IMAGE: i686-gnu-nopt\n-      test-various:\n-        IMAGE: test-various\n-      wasm32:\n-        IMAGE: wasm32\n-      x86_64-gnu:\n-        IMAGE: x86_64-gnu\n-      x86_64-gnu-full-bootstrap:\n-        IMAGE: x86_64-gnu-full-bootstrap\n-      x86_64-gnu-aux:\n-        IMAGE: x86_64-gnu-aux\n+      arm-android: {}\n+      armhf-gnu: {}\n+      dist-various-1: {}\n+      dist-various-2: {}\n+      dist-aarch64-linux: {}\n+      dist-android: {}\n+      dist-arm-linux: {}\n+      dist-armhf-linux: {}\n+      dist-armv7-linux: {}\n+      dist-i586-gnu-i586-i686-musl: {}\n+      dist-i686-freebsd: {}\n+      dist-i686-linux: {}\n+      dist-mips-linux: {}\n+      dist-mips64-linux: {}\n+      dist-mips64el-linux: {}\n+      dist-mipsel-linux: {}\n+      dist-powerpc-linux: {}\n+      dist-powerpc64-linux: {}\n+      dist-powerpc64le-linux: {}\n+      dist-s390x-linux: {}\n+      dist-x86_64-freebsd: {}\n+      dist-x86_64-musl: {}\n+      dist-x86_64-netbsd: {}\n+      i686-gnu: {}\n+      i686-gnu-nopt: {}\n+      test-various: {}\n+      wasm32: {}\n+      x86_64-gnu: {}\n+      x86_64-gnu-full-bootstrap: {}\n+      x86_64-gnu-aux: {}\n       x86_64-gnu-tools:\n-        IMAGE: x86_64-gnu-tools\n         DEPLOY_TOOLSTATES_JSON: toolstates-linux.json\n-      x86_64-gnu-debug:\n-        IMAGE: x86_64-gnu-debug\n-      x86_64-gnu-nopt:\n-        IMAGE: x86_64-gnu-nopt\n-      x86_64-gnu-distcheck:\n-        IMAGE: x86_64-gnu-distcheck\n-      mingw-check:\n-        IMAGE: mingw-check\n+      x86_64-gnu-debug: {}\n+      x86_64-gnu-nopt: {}\n+      x86_64-gnu-distcheck: {}\n+      mingw-check: {}\n \n - job: macOS\n   timeoutInMinutes: 600\n@@ -176,7 +86,6 @@ jobs:\n       dist-x86_64-apple:\n         SCRIPT: ./x.py dist\n         RUST_CONFIGURE_ARGS: --target=aarch64-apple-ios,armv7-apple-ios,armv7s-apple-ios,i386-apple-ios,x86_64-apple-ios --enable-full-tools --enable-sanitizers --enable-profiler --set rust.jemalloc\n-        DEPLOY: 1\n         RUSTC_RETRY_LINKER_ON_SEGFAULT: 1\n         MACOSX_DEPLOYMENT_TARGET: 10.7\n         NO_LLVM_ASSERTIONS: 1\n@@ -186,7 +95,6 @@ jobs:\n       dist-x86_64-apple-alt:\n         SCRIPT: ./x.py dist\n         RUST_CONFIGURE_ARGS: --enable-extended --enable-profiler --set rust.jemalloc\n-        DEPLOY_ALT: 1\n         RUSTC_RETRY_LINKER_ON_SEGFAULT: 1\n         MACOSX_DEPLOYMENT_TARGET: 10.7\n         NO_LLVM_ASSERTIONS: 1\n@@ -204,7 +112,6 @@ jobs:\n       dist-i686-apple:\n         SCRIPT: ./x.py dist\n         RUST_CONFIGURE_ARGS: --build=i686-apple-darwin --enable-full-tools --enable-profiler --set rust.jemalloc\n-        DEPLOY: 1\n         RUSTC_RETRY_LINKER_ON_SEGFAULT: 1\n         MACOSX_DEPLOYMENT_TARGET: 10.7\n         NO_LLVM_ASSERTIONS: 1\n@@ -304,7 +211,6 @@ jobs:\n           --enable-profiler\n         SCRIPT: python x.py dist\n         DIST_REQUIRE_ALL_TOOLS: 1\n-        DEPLOY: 1\n       dist-i686-msvc:\n         RUST_CONFIGURE_ARGS: >-\n           --build=i686-pc-windows-msvc\n@@ -313,22 +219,18 @@ jobs:\n           --enable-profiler\n         SCRIPT: python x.py dist\n         DIST_REQUIRE_ALL_TOOLS: 1\n-        DEPLOY: 1\n       dist-i686-mingw:\n         RUST_CONFIGURE_ARGS: --build=i686-pc-windows-gnu --enable-full-tools --enable-profiler\n         SCRIPT: python x.py dist\n         CUSTOM_MINGW: 1\n         DIST_REQUIRE_ALL_TOOLS: 1\n-        DEPLOY: 1\n       dist-x86_64-mingw:\n         SCRIPT: python x.py dist\n         RUST_CONFIGURE_ARGS: --build=x86_64-pc-windows-gnu --enable-full-tools --enable-profiler\n         CUSTOM_MINGW: 1\n         DIST_REQUIRE_ALL_TOOLS: 1\n-        DEPLOY: 1\n \n       # \"alternate\" deployment, see .travis.yml for more info\n       dist-x86_64-msvc-alt:\n         RUST_CONFIGURE_ARGS: --build=x86_64-pc-windows-msvc --enable-extended --enable-profiler\n         SCRIPT: python x.py dist\n-        DEPLOY_ALT: 1"}, {"sha": "aee4d8d5136aa81c1332f6152ea2f6f78af955dd", "filename": "src/ci/azure-pipelines/pr.yml", "status": "modified", "additions": 2, "deletions": 5, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/ee12992da955d3ec8132b5c5c4579b3535da05e6/src%2Fci%2Fazure-pipelines%2Fpr.yml", "raw_url": "https://github.com/rust-lang/rust/raw/ee12992da955d3ec8132b5c5c4579b3535da05e6/src%2Fci%2Fazure-pipelines%2Fpr.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fazure-pipelines%2Fpr.yml?ref=ee12992da955d3ec8132b5c5c4579b3535da05e6", "patch": "@@ -18,10 +18,7 @@ jobs:\n     - template: steps/run.yml\n   strategy:\n     matrix:\n-      x86_64-gnu-llvm-6.0:\n-        IMAGE: x86_64-gnu-llvm-6.0\n-      mingw-check:\n-        IMAGE: mingw-check\n+      x86_64-gnu-llvm-6.0: {}\n+      mingw-check: {}\n       x86_64-gnu-tools:\n-        IMAGE: x86_64-gnu-tools\n         CI_ONLY_WHEN_SUBMODULES_CHANGED: 1"}, {"sha": "f536388b25b966286b216ade8ee12cfbac2bc7ef", "filename": "src/ci/azure-pipelines/steps/run.yml", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/ee12992da955d3ec8132b5c5c4579b3535da05e6/src%2Fci%2Fazure-pipelines%2Fsteps%2Frun.yml", "raw_url": "https://github.com/rust-lang/rust/raw/ee12992da955d3ec8132b5c5c4579b3535da05e6/src%2Fci%2Fazure-pipelines%2Fsteps%2Frun.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fazure-pipelines%2Fsteps%2Frun.yml?ref=ee12992da955d3ec8132b5c5c4579b3535da05e6", "patch": "@@ -28,6 +28,9 @@ steps:\n - checkout: self\n   fetchDepth: 2\n \n+- bash: src/ci/scripts/setup-environment.sh\n+  displayName: Setup environment\n+\n - bash: src/ci/scripts/should-skip-this.sh\n   displayName: Decide whether to run this job\n "}, {"sha": "b6177b2cc9b25c826fb9e47092a4fe4ab1e25853", "filename": "src/ci/azure-pipelines/try.yml", "status": "modified", "additions": 1, "deletions": 5, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/ee12992da955d3ec8132b5c5c4579b3535da05e6/src%2Fci%2Fazure-pipelines%2Ftry.yml", "raw_url": "https://github.com/rust-lang/rust/raw/ee12992da955d3ec8132b5c5c4579b3535da05e6/src%2Fci%2Fazure-pipelines%2Ftry.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fazure-pipelines%2Ftry.yml?ref=ee12992da955d3ec8132b5c5c4579b3535da05e6", "patch": "@@ -14,13 +14,9 @@ jobs:\n   - template: steps/run.yml\n   strategy:\n     matrix:\n-      dist-x86_64-linux:\n-        IMAGE: dist-x86_64-linux\n-        DEPLOY: 1\n-\n+      dist-x86_64-linux: {}\n       dist-x86_64-linux-alt:\n         IMAGE: dist-x86_64-linux\n-        DEPLOY_ALT: 1\n \n # The macOS and Windows builds here are currently disabled due to them not being\n # overly necessary on `try` builds. We also don't actually have anything that"}, {"sha": "e126a06edab7373a12df556e6f81f2f82d409239", "filename": "src/ci/scripts/setup-environment.sh", "status": "added", "additions": 31, "deletions": 0, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/ee12992da955d3ec8132b5c5c4579b3535da05e6/src%2Fci%2Fscripts%2Fsetup-environment.sh", "raw_url": "https://github.com/rust-lang/rust/raw/ee12992da955d3ec8132b5c5c4579b3535da05e6/src%2Fci%2Fscripts%2Fsetup-environment.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fscripts%2Fsetup-environment.sh?ref=ee12992da955d3ec8132b5c5c4579b3535da05e6", "patch": "@@ -0,0 +1,31 @@\n+#!/bin/bash\n+# This script guesses some environment variables based on the builder name and\n+# the current platform, to reduce the amount of variables defined in the CI\n+# configuration.\n+\n+set -euo pipefail\n+IFS=$'\\n\\t'\n+\n+source \"$(cd \"$(dirname \"$0\")\" && pwd)/../shared.sh\"\n+\n+# Builders starting with `dist-` are dist builders, but if they also end with\n+# `-alt` they are alternate dist builders.\n+if [[ \"${CI_JOB_NAME}\" = dist-* ]]; then\n+    if [[ \"${CI_JOB_NAME}\" = *-alt ]]; then\n+        echo \"alternate dist builder detected, setting DEPLOY_ALT=1\"\n+        ciCommandSetEnv DEPLOY_ALT 1\n+    else\n+        echo \"normal dist builder detected, setting DEPLOY=1\"\n+        ciCommandSetEnv DEPLOY 1\n+    fi\n+fi\n+\n+# All the Linux builds happen inside Docker.\n+if isLinux; then\n+    if [[ -z \"${IMAGE+x}\" ]]; then\n+        echo \"linux builder detected, using docker to run the build\"\n+        ciCommandSetEnv IMAGE \"${CI_JOB_NAME}\"\n+    else\n+        echo \"a custom docker image is already set\"\n+    fi\n+fi"}]}