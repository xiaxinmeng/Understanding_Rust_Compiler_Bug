{"sha": "fc9f2b99c7b3b0413e570f12d96450f33d090cb6", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZjOWYyYjk5YzdiM2IwNDEzZTU3MGYxMmQ5NjQ1MGYzM2QwOTBjYjY=", "commit": {"author": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2016-09-19T16:32:47Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2016-09-19T16:32:47Z"}, "message": "Merge pull request #1235 from Manishearth/transmute_ptr_to_ref-suggs\n\nFix wrong suggestion in `TRANSMUTE_PTR_TO_REF` with lts", "tree": {"sha": "cb8337e6e862f05511bffc48430e1c315be25e26", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/cb8337e6e862f05511bffc48430e1c315be25e26"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fc9f2b99c7b3b0413e570f12d96450f33d090cb6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fc9f2b99c7b3b0413e570f12d96450f33d090cb6", "html_url": "https://github.com/rust-lang/rust/commit/fc9f2b99c7b3b0413e570f12d96450f33d090cb6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fc9f2b99c7b3b0413e570f12d96450f33d090cb6/comments", "author": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9963a2c78c9ba6d0b76b2081e866a8f9f2a0fe2c", "url": "https://api.github.com/repos/rust-lang/rust/commits/9963a2c78c9ba6d0b76b2081e866a8f9f2a0fe2c", "html_url": "https://github.com/rust-lang/rust/commit/9963a2c78c9ba6d0b76b2081e866a8f9f2a0fe2c"}, {"sha": "f74dcaac0cf3e5b7375af943adb562e9629e233a", "url": "https://api.github.com/repos/rust-lang/rust/commits/f74dcaac0cf3e5b7375af943adb562e9629e233a", "html_url": "https://github.com/rust-lang/rust/commit/f74dcaac0cf3e5b7375af943adb562e9629e233a"}], "stats": {"total": 55, "additions": 47, "deletions": 8}, "files": [{"sha": "5e9931c3bd2dbc5edb3a484940770c3e4c483ee2", "filename": "clippy_lints/src/transmute.rs", "status": "modified", "additions": 19, "deletions": 4, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/fc9f2b99c7b3b0413e570f12d96450f33d090cb6/clippy_lints%2Fsrc%2Ftransmute.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fc9f2b99c7b3b0413e570f12d96450f33d090cb6/clippy_lints%2Fsrc%2Ftransmute.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Ftransmute.rs?ref=fc9f2b99c7b3b0413e570f12d96450f33d090cb6", "patch": "@@ -2,7 +2,7 @@ use rustc::lint::*;\n use rustc::ty::TypeVariants::{TyRawPtr, TyRef};\n use rustc::ty;\n use rustc::hir::*;\n-use utils::{match_def_path, paths, span_lint, span_lint_and_then};\n+use utils::{match_def_path, paths, span_lint, span_lint_and_then, snippet};\n use utils::sugg;\n \n /// **What it does:** Checks for transmutes that can't ever be correct on any\n@@ -87,7 +87,7 @@ impl LintPass for Transmute {\n impl LateLintPass for Transmute {\n     fn check_expr(&mut self, cx: &LateContext, e: &Expr) {\n         if let ExprCall(ref path_expr, ref args) = e.node {\n-            if let ExprPath(None, _) = path_expr.node {\n+            if let ExprPath(None, ref path) = path_expr.node {\n                 let def_id = cx.tcx.expect_def(path_expr.id).def_id();\n \n                 if match_def_path(cx, def_id, &paths::TRANSMUTE) {\n@@ -170,11 +170,10 @@ impl LateLintPass for Transmute {\n                                     (\"&*\", \"*const\")\n                                 };\n \n-\n                                 let arg = if from_pty.ty == to_rty.ty {\n                                     arg\n                                 } else {\n-                                    arg.as_ty(&format!(\"{} {}\", cast, to_rty.ty))\n+                                    arg.as_ty(&format!(\"{} {}\", cast, get_type_snippet(cx, path, to_rty.ty)))\n                                 };\n \n                                 db.span_suggestion(e.span, \"try\", sugg::make_unop(deref, arg).to_string());\n@@ -187,3 +186,19 @@ impl LateLintPass for Transmute {\n         }\n     }\n }\n+\n+/// Get the snippet of `Bar` in `\u2026::transmute<Foo, &Bar>`. If that snippet is not available , use\n+/// the type's `ToString` implementation. In weird cases it could lead to types with invalid `'_`\n+/// lifetime, but it should be rare.\n+fn get_type_snippet(cx: &LateContext, path: &Path, to_rty: ty::Ty) -> String {\n+    if_let_chain!{[\n+        let Some(seg) = path.segments.last(),\n+        let PathParameters::AngleBracketedParameters(ref ang) = seg.parameters,\n+        let Some(to_ty) = ang.types.get(1),\n+        let TyRptr(_, ref to_ty) = to_ty.node,\n+    ], {\n+        return snippet(cx, to_ty.ty.span, &to_rty.to_string()).to_string();\n+    }}\n+\n+    to_rty.to_string()\n+}"}, {"sha": "c5ab854b05ae6c28ad6dd890341a48258993cd38", "filename": "tests/compile-fail/transmute.rs", "status": "modified", "additions": 28, "deletions": 4, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/fc9f2b99c7b3b0413e570f12d96450f33d090cb6/tests%2Fcompile-fail%2Ftransmute.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fc9f2b99c7b3b0413e570f12d96450f33d090cb6/tests%2Fcompile-fail%2Ftransmute.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Ftransmute.rs?ref=fc9f2b99c7b3b0413e570f12d96450f33d090cb6", "patch": "@@ -1,6 +1,8 @@\n #![feature(plugin)]\n #![plugin(clippy)]\n \n+#![allow(dead_code)]\n+\n extern crate core;\n \n use std::mem::transmute as my_transmute;\n@@ -83,6 +85,31 @@ unsafe fn _ptr_to_ref<T, U>(p: *const T, m: *mut T, o: *const U, om: *mut U) {\n     let _: &T = &*(om as *const T);\n }\n \n+#[deny(transmute_ptr_to_ref)]\n+fn issue1231() {\n+    struct Foo<'a, T: 'a> {\n+        bar: &'a T,\n+    }\n+\n+    let raw = 0 as *const i32;\n+    let _: &Foo<u8> = unsafe { std::mem::transmute::<_, &Foo<_>>(raw) };\n+    //~^ ERROR transmute from a pointer type\n+    //~| HELP try\n+    //~| SUGGESTION unsafe { &*(raw as *const Foo<_>) };\n+\n+    let _: &Foo<&u8> = unsafe { std::mem::transmute::<_, &Foo<&_>>(raw) };\n+    //~^ ERROR transmute from a pointer type\n+    //~| HELP try\n+    //~| SUGGESTION unsafe { &*(raw as *const Foo<&_>) };\n+\n+    type Bar<'a> = &'a u8;\n+    let raw = 0 as *const i32;\n+    unsafe { std::mem::transmute::<_, Bar>(raw) };\n+    //~^ ERROR transmute from a pointer type\n+    //~| HELP try\n+    //~| SUGGESTION unsafe { &*(raw as *const u8) };\n+}\n+\n #[deny(useless_transmute)]\n fn useless() {\n     unsafe {\n@@ -144,7 +171,4 @@ fn crosspointer() {\n     }\n }\n \n-fn main() {\n-    useless();\n-    crosspointer();\n-}\n+fn main() { }"}]}