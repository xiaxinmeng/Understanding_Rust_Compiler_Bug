{"sha": "756771d54c28c4543d620891e971bf5a95c3ea3e", "node_id": "MDY6Q29tbWl0NzI0NzEyOjc1Njc3MWQ1NGMyOGM0NTQzZDYyMDg5MWU5NzFiZjVhOTVjM2VhM2U=", "commit": {"author": {"name": "Ian Jackson", "email": "ijackson@chiark.greenend.org.uk", "date": "2021-04-22T14:06:53Z"}, "committer": {"name": "Ian Jackson", "email": "ijackson@chiark.greenend.org.uk", "date": "2021-05-07T10:17:44Z"}, "message": "panic ui test: Test always_abort on one thread, panic on another\n\nThis test failed on an earlier version of this branch, where this did\nnot work properly, so I know the test works.\n\nSigned-off-by: Ian Jackson <ijackson@chiark.greenend.org.uk>", "tree": {"sha": "704310250fa50dde3d992099b789a023cb756f3e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/704310250fa50dde3d992099b789a023cb756f3e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/756771d54c28c4543d620891e971bf5a95c3ea3e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/756771d54c28c4543d620891e971bf5a95c3ea3e", "html_url": "https://github.com/rust-lang/rust/commit/756771d54c28c4543d620891e971bf5a95c3ea3e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/756771d54c28c4543d620891e971bf5a95c3ea3e/comments", "author": {"login": "ijackson", "id": 2090772, "node_id": "MDQ6VXNlcjIwOTA3NzI=", "avatar_url": "https://avatars.githubusercontent.com/u/2090772?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ijackson", "html_url": "https://github.com/ijackson", "followers_url": "https://api.github.com/users/ijackson/followers", "following_url": "https://api.github.com/users/ijackson/following{/other_user}", "gists_url": "https://api.github.com/users/ijackson/gists{/gist_id}", "starred_url": "https://api.github.com/users/ijackson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ijackson/subscriptions", "organizations_url": "https://api.github.com/users/ijackson/orgs", "repos_url": "https://api.github.com/users/ijackson/repos", "events_url": "https://api.github.com/users/ijackson/events{/privacy}", "received_events_url": "https://api.github.com/users/ijackson/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ijackson", "id": 2090772, "node_id": "MDQ6VXNlcjIwOTA3NzI=", "avatar_url": "https://avatars.githubusercontent.com/u/2090772?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ijackson", "html_url": "https://github.com/ijackson", "followers_url": "https://api.github.com/users/ijackson/followers", "following_url": "https://api.github.com/users/ijackson/following{/other_user}", "gists_url": "https://api.github.com/users/ijackson/gists{/gist_id}", "starred_url": "https://api.github.com/users/ijackson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ijackson/subscriptions", "organizations_url": "https://api.github.com/users/ijackson/orgs", "repos_url": "https://api.github.com/users/ijackson/repos", "events_url": "https://api.github.com/users/ijackson/events{/privacy}", "received_events_url": "https://api.github.com/users/ijackson/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "12fe50010da70abfca84ae9c0d6e798e987fa882", "url": "https://api.github.com/repos/rust-lang/rust/commits/12fe50010da70abfca84ae9c0d6e798e987fa882", "html_url": "https://github.com/rust-lang/rust/commit/12fe50010da70abfca84ae9c0d6e798e987fa882"}], "stats": {"total": 21, "additions": 20, "deletions": 1}, "files": [{"sha": "2aea607e95489d9a6a9e2b46783e7623d0f134ba", "filename": "src/test/ui/panics/abort-on-panic.rs", "status": "modified", "additions": 20, "deletions": 1, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/756771d54c28c4543d620891e971bf5a95c3ea3e/src%2Ftest%2Fui%2Fpanics%2Fabort-on-panic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/756771d54c28c4543d620891e971bf5a95c3ea3e/src%2Ftest%2Fui%2Fpanics%2Fabort-on-panic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fpanics%2Fabort-on-panic.rs?ref=756771d54c28c4543d620891e971bf5a95c3ea3e", "patch": "@@ -2,6 +2,7 @@\n \n #![allow(unused_must_use)]\n #![feature(unwind_attributes)]\n+#![feature(panic_always_abort)]\n // Since we mark some ABIs as \"nounwind\" to LLVM, we must make sure that\n // we never unwind through them.\n \n@@ -11,7 +12,9 @@\n use std::{env, panic};\n use std::io::prelude::*;\n use std::io;\n-use std::process::{Command, Stdio};\n+use std::process::{exit, Command, Stdio};\n+use std::sync::{Arc, Barrier};\n+use std::thread;\n \n #[unwind(aborts)] // FIXME(#58794) should work even without the attribute\n extern \"C\" fn panic_in_ffi() {\n@@ -49,11 +52,27 @@ fn test_always_abort() {\n     should_have_aborted();\n }\n \n+fn test_always_abort_thread() {\n+    let barrier = Arc::new(Barrier::new(2));\n+    let thr = {\n+        let barrier = barrier.clone();\n+        thread::spawn(move ||{\n+            barrier.wait();\n+            panic!(\"in thread\");\n+        })\n+    };\n+    panic::always_abort();\n+    barrier.wait();\n+    let _ = thr.join();\n+    bomb_out_but_not_abort(\"joined - but we were supposed to panic!\");\n+}\n+\n fn main() {\n     let tests: &[(_, fn())] = &[\n         (\"test\", test),\n         (\"testrust\", testrust),\n         (\"test_always_abort\", test_always_abort),\n+        (\"test_always_abort_thread\", test_always_abort_thread),\n     ];\n \n     let args: Vec<String> = env::args().collect();"}]}