{"sha": "6f297b9076f1d432fb60904c6f3c54e184ed153b", "node_id": "C_kwDOAAsO6NoAKDZmMjk3YjkwNzZmMWQ0MzJmYjYwOTA0YzZmM2M1NGUxODRlZDE1M2I", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-03-14T10:34:23Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-03-14T10:34:23Z"}, "message": "Auto merge of #14348 - Veykril:rustc-proc, r=Veykril\n\nfix: Fix rustc proc-macro handling being broken on the rustc workspace itself\n\nAlso addresses https://github.com/rust-lang/rust-analyzer/issues/13591#issuecomment-1466966952", "tree": {"sha": "20a35fd5ad3788f9b1b9adb8e2c6161623095c8b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/20a35fd5ad3788f9b1b9adb8e2c6161623095c8b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6f297b9076f1d432fb60904c6f3c54e184ed153b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6f297b9076f1d432fb60904c6f3c54e184ed153b", "html_url": "https://github.com/rust-lang/rust/commit/6f297b9076f1d432fb60904c6f3c54e184ed153b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6f297b9076f1d432fb60904c6f3c54e184ed153b/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6a98e961f84b2b0fccda3c7931b6cdc417471112", "url": "https://api.github.com/repos/rust-lang/rust/commits/6a98e961f84b2b0fccda3c7931b6cdc417471112", "html_url": "https://github.com/rust-lang/rust/commit/6a98e961f84b2b0fccda3c7931b6cdc417471112"}, {"sha": "88f0fe784f0db871272acd989c4322d3db185683", "url": "https://api.github.com/repos/rust-lang/rust/commits/88f0fe784f0db871272acd989c4322d3db185683", "html_url": "https://github.com/rust-lang/rust/commit/88f0fe784f0db871272acd989c4322d3db185683"}], "stats": {"total": 15, "additions": 11, "deletions": 4}, "files": [{"sha": "4e5d640f175e461c8971ce023d99641da8dab02b", "filename": "crates/project-model/src/build_scripts.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/6f297b9076f1d432fb60904c6f3c54e184ed153b/crates%2Fproject-model%2Fsrc%2Fbuild_scripts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6f297b9076f1d432fb60904c6f3c54e184ed153b/crates%2Fproject-model%2Fsrc%2Fbuild_scripts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproject-model%2Fsrc%2Fbuild_scripts.rs?ref=6f297b9076f1d432fb60904c6f3c54e184ed153b", "patch": "@@ -429,8 +429,9 @@ impl WorkspaceBuildScripts {\n             for p in rustc.packages() {\n                 let package = &rustc[p];\n                 if package.targets.iter().any(|&it| rustc[it].is_proc_macro) {\n-                    if let Some((_, path)) =\n-                        proc_macro_dylibs.iter().find(|(name, _)| *name == package.name)\n+                    if let Some((_, path)) = proc_macro_dylibs\n+                        .iter()\n+                        .find(|(name, _)| *name.trim_start_matches(\"lib\") == package.name)\n                     {\n                         bs.outputs[p].proc_macro_dylib_path = Some(path.clone());\n                     }"}, {"sha": "55aec1a67740644c3df43011ca3e0c9bb6ea2872", "filename": "crates/project-model/src/workspace.rs", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/6f297b9076f1d432fb60904c6f3c54e184ed153b/crates%2Fproject-model%2Fsrc%2Fworkspace.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6f297b9076f1d432fb60904c6f3c54e184ed153b/crates%2Fproject-model%2Fsrc%2Fworkspace.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproject-model%2Fsrc%2Fworkspace.rs?ref=6f297b9076f1d432fb60904c6f3c54e184ed153b", "patch": "@@ -940,7 +940,7 @@ fn cargo_to_crate_graph(\n     if has_private {\n         // If the user provided a path to rustc sources, we add all the rustc_private crates\n         // and create dependencies on them for the crates which opt-in to that\n-        if let Some((rustc_workspace, build_scripts)) = rustc {\n+        if let Some((rustc_workspace, rustc_build_scripts)) = rustc {\n             handle_rustc_crates(\n                 &mut crate_graph,\n                 &mut pkg_to_lib_crate,\n@@ -953,7 +953,13 @@ fn cargo_to_crate_graph(\n                 &pkg_crates,\n                 &cfg_options,\n                 override_cfg,\n-                build_scripts,\n+                if rustc_workspace.workspace_root() == cargo.workspace_root() {\n+                    // the rustc workspace does not use the installed toolchain's proc-macro server\n+                    // so we need to make sure we don't use the pre compiled proc-macros there either\n+                    build_scripts\n+                } else {\n+                    rustc_build_scripts\n+                },\n                 target_layout,\n             );\n         }"}]}