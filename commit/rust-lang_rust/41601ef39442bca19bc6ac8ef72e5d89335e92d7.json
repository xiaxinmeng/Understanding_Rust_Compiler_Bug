{"sha": "41601ef39442bca19bc6ac8ef72e5d89335e92d7", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQxNjAxZWYzOTQ0MmJjYTE5YmM2YWM4ZWY3MmU1ZDg5MzM1ZTkyZDc=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-01-06T00:36:14Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-01-06T00:36:14Z"}, "message": "Auto merge of #80415 - cjgillot:issue-77828, r=petrochenkov\n\nCompute parent module when collecting hir::MacroDef.\n\nFixes #77828.\n\nr? `@jyn514`", "tree": {"sha": "bc7c7592eefe2122dd3c76c28446fbfa3eaa654a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bc7c7592eefe2122dd3c76c28446fbfa3eaa654a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/41601ef39442bca19bc6ac8ef72e5d89335e92d7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/41601ef39442bca19bc6ac8ef72e5d89335e92d7", "html_url": "https://github.com/rust-lang/rust/commit/41601ef39442bca19bc6ac8ef72e5d89335e92d7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/41601ef39442bca19bc6ac8ef72e5d89335e92d7/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "da305a2b00530aa34dea4e48389204c26fa35dbb", "url": "https://api.github.com/repos/rust-lang/rust/commits/da305a2b00530aa34dea4e48389204c26fa35dbb", "html_url": "https://github.com/rust-lang/rust/commit/da305a2b00530aa34dea4e48389204c26fa35dbb"}, {"sha": "4fb12369b336565dc553290a20c31fb7594d29d5", "url": "https://api.github.com/repos/rust-lang/rust/commits/4fb12369b336565dc553290a20c31fb7594d29d5", "html_url": "https://github.com/rust-lang/rust/commit/4fb12369b336565dc553290a20c31fb7594d29d5"}], "stats": {"total": 39, "additions": 31, "deletions": 8}, "files": [{"sha": "872fcb0f581d0fd0e7405af4b4580783289fbcf6", "filename": "compiler/rustc_middle/src/hir/map/collector.rs", "status": "modified", "additions": 16, "deletions": 7, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/41601ef39442bca19bc6ac8ef72e5d89335e92d7/compiler%2Frustc_middle%2Fsrc%2Fhir%2Fmap%2Fcollector.rs", "raw_url": "https://github.com/rust-lang/rust/raw/41601ef39442bca19bc6ac8ef72e5d89335e92d7/compiler%2Frustc_middle%2Fsrc%2Fhir%2Fmap%2Fcollector.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fhir%2Fmap%2Fcollector.rs?ref=41601ef39442bca19bc6ac8ef72e5d89335e92d7", "patch": "@@ -529,13 +529,22 @@ impl<'a, 'hir> Visitor<'hir> for NodeCollector<'a, 'hir> {\n     }\n \n     fn visit_macro_def(&mut self, macro_def: &'hir MacroDef<'hir>) {\n-        self.with_dep_node_owner(macro_def.hir_id.owner, macro_def, |this, hash| {\n-            this.insert_with_hash(\n-                macro_def.span,\n-                macro_def.hir_id,\n-                Node::MacroDef(macro_def),\n-                hash,\n-            );\n+        // Exported macros are visited directly from the crate root,\n+        // so they do not have `parent_node` set.\n+        // Find the correct enclosing module from their DefKey.\n+        let def_key = self.definitions.def_key(macro_def.hir_id.owner);\n+        let parent = def_key.parent.map_or(hir::CRATE_HIR_ID, |local_def_index| {\n+            self.definitions.local_def_id_to_hir_id(LocalDefId { local_def_index })\n+        });\n+        self.with_parent(parent, |this| {\n+            this.with_dep_node_owner(macro_def.hir_id.owner, macro_def, |this, hash| {\n+                this.insert_with_hash(\n+                    macro_def.span,\n+                    macro_def.hir_id,\n+                    Node::MacroDef(macro_def),\n+                    hash,\n+                );\n+            })\n         });\n     }\n "}, {"sha": "c2e99224d8b368ab6a6751bfc144b9daf207358f", "filename": "compiler/rustc_middle/src/hir/map/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/41601ef39442bca19bc6ac8ef72e5d89335e92d7/compiler%2Frustc_middle%2Fsrc%2Fhir%2Fmap%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/41601ef39442bca19bc6ac8ef72e5d89335e92d7/compiler%2Frustc_middle%2Fsrc%2Fhir%2Fmap%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fhir%2Fmap%2Fmod.rs?ref=41601ef39442bca19bc6ac8ef72e5d89335e92d7", "patch": "@@ -31,7 +31,7 @@ pub struct Entry<'hir> {\n impl<'hir> Entry<'hir> {\n     fn parent_node(self) -> Option<HirId> {\n         match self.node {\n-            Node::Crate(_) | Node::MacroDef(_) => None,\n+            Node::Crate(_) => None,\n             _ => Some(self.parent),\n         }\n     }"}, {"sha": "ae0cf7a14789d78103c6cb4585ea36ab650153f7", "filename": "src/test/rustdoc/macros.rs", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/41601ef39442bca19bc6ac8ef72e5d89335e92d7/src%2Ftest%2Frustdoc%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/41601ef39442bca19bc6ac8ef72e5d89335e92d7/src%2Ftest%2Frustdoc%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fmacros.rs?ref=41601ef39442bca19bc6ac8ef72e5d89335e92d7", "patch": "@@ -8,3 +8,17 @@ macro_rules! my_macro {\n     ($a:tt) => ();\n     ($e:expr) => {};\n }\n+\n+// Check that exported macro defined in a module are shown at crate root.\n+// @has macros/macro.my_sub_macro.html //pre 'macro_rules! my_sub_macro {'\n+// @has - //pre '() => { ... };'\n+// @has - //pre '($a:tt) => { ... };'\n+// @has - //pre '($e:expr) => { ... };'\n+mod sub {\n+    #[macro_export]\n+    macro_rules! my_sub_macro {\n+        () => {};\n+        ($a:tt) => {};\n+        ($e:expr) => {};\n+    }\n+}"}]}