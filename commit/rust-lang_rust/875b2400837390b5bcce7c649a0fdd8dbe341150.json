{"sha": "875b2400837390b5bcce7c649a0fdd8dbe341150", "node_id": "C_kwDOAAsO6NoAKDg3NWIyNDAwODM3MzkwYjViY2NlN2M2NDlhMGZkZDhkYmUzNDExNTA", "commit": {"author": {"name": "SeeSpring", "email": "30735327+SeeSpring@users.noreply.github.com", "date": "2022-01-13T14:27:08Z"}, "committer": {"name": "SeeSpring", "email": "30735327+SeeSpring@users.noreply.github.com", "date": "2022-01-13T14:47:56Z"}, "message": "Apply `not_unsafe_ptr_arg_deref` to type aliases", "tree": {"sha": "03dc64d129e6785673f469de5b03bd5f227760ed", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/03dc64d129e6785673f469de5b03bd5f227760ed"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/875b2400837390b5bcce7c649a0fdd8dbe341150", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/875b2400837390b5bcce7c649a0fdd8dbe341150", "html_url": "https://github.com/rust-lang/rust/commit/875b2400837390b5bcce7c649a0fdd8dbe341150", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/875b2400837390b5bcce7c649a0fdd8dbe341150/comments", "author": {"login": "SeeSpring", "id": 30735327, "node_id": "MDQ6VXNlcjMwNzM1MzI3", "avatar_url": "https://avatars.githubusercontent.com/u/30735327?v=4", "gravatar_id": "", "url": "https://api.github.com/users/SeeSpring", "html_url": "https://github.com/SeeSpring", "followers_url": "https://api.github.com/users/SeeSpring/followers", "following_url": "https://api.github.com/users/SeeSpring/following{/other_user}", "gists_url": "https://api.github.com/users/SeeSpring/gists{/gist_id}", "starred_url": "https://api.github.com/users/SeeSpring/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/SeeSpring/subscriptions", "organizations_url": "https://api.github.com/users/SeeSpring/orgs", "repos_url": "https://api.github.com/users/SeeSpring/repos", "events_url": "https://api.github.com/users/SeeSpring/events{/privacy}", "received_events_url": "https://api.github.com/users/SeeSpring/received_events", "type": "User", "site_admin": false}, "committer": {"login": "SeeSpring", "id": 30735327, "node_id": "MDQ6VXNlcjMwNzM1MzI3", "avatar_url": "https://avatars.githubusercontent.com/u/30735327?v=4", "gravatar_id": "", "url": "https://api.github.com/users/SeeSpring", "html_url": "https://github.com/SeeSpring", "followers_url": "https://api.github.com/users/SeeSpring/followers", "following_url": "https://api.github.com/users/SeeSpring/following{/other_user}", "gists_url": "https://api.github.com/users/SeeSpring/gists{/gist_id}", "starred_url": "https://api.github.com/users/SeeSpring/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/SeeSpring/subscriptions", "organizations_url": "https://api.github.com/users/SeeSpring/orgs", "repos_url": "https://api.github.com/users/SeeSpring/repos", "events_url": "https://api.github.com/users/SeeSpring/events{/privacy}", "received_events_url": "https://api.github.com/users/SeeSpring/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "97a5daa65908e59744e2bc625b14849352231c75", "url": "https://api.github.com/repos/rust-lang/rust/commits/97a5daa65908e59744e2bc625b14849352231c75", "html_url": "https://github.com/rust-lang/rust/commit/97a5daa65908e59744e2bc625b14849352231c75"}], "stats": {"total": 45, "additions": 37, "deletions": 8}, "files": [{"sha": "834f6d2425e93895114bd6e29fbc4cebb11120d6", "filename": "clippy_lints/src/functions/not_unsafe_ptr_arg_deref.rs", "status": "modified", "additions": 7, "deletions": 4, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/875b2400837390b5bcce7c649a0fdd8dbe341150/clippy_lints%2Fsrc%2Ffunctions%2Fnot_unsafe_ptr_arg_deref.rs", "raw_url": "https://github.com/rust-lang/rust/raw/875b2400837390b5bcce7c649a0fdd8dbe341150/clippy_lints%2Fsrc%2Ffunctions%2Fnot_unsafe_ptr_arg_deref.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Ffunctions%2Fnot_unsafe_ptr_arg_deref.rs?ref=875b2400837390b5bcce7c649a0fdd8dbe341150", "patch": "@@ -42,8 +42,7 @@ fn check_raw_ptr<'tcx>(\n     let expr = &body.value;\n     if unsafety == hir::Unsafety::Normal && cx.access_levels.is_exported(def_id) {\n         let raw_ptrs = iter_input_pats(decl, body)\n-            .zip(decl.inputs.iter())\n-            .filter_map(|(arg, ty)| raw_ptr_arg(arg, ty))\n+            .filter_map(|arg| raw_ptr_arg(cx, arg))\n             .collect::<HirIdSet>();\n \n         if !raw_ptrs.is_empty() {\n@@ -59,8 +58,12 @@ fn check_raw_ptr<'tcx>(\n     }\n }\n \n-fn raw_ptr_arg(arg: &hir::Param<'_>, ty: &hir::Ty<'_>) -> Option<hir::HirId> {\n-    if let (&hir::PatKind::Binding(_, id, _, _), &hir::TyKind::Ptr(_)) = (&arg.pat.kind, &ty.kind) {\n+fn raw_ptr_arg(cx: &LateContext<'_>, arg: &hir::Param<'_>) -> Option<hir::HirId> {\n+    if let (&hir::PatKind::Binding(_, id, _, _), Some(&ty::RawPtr(_))) = (\n+        &arg.pat.kind,\n+        cx.maybe_typeck_results()\n+            .map(|typeck_results| typeck_results.pat_ty(arg.pat).kind()),\n+    ) {\n         Some(id)\n     } else {\n         None"}, {"sha": "5521870eaecf761af9b0f50bdbdd941d63aaa551", "filename": "tests/ui/functions.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/875b2400837390b5bcce7c649a0fdd8dbe341150/tests%2Fui%2Ffunctions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/875b2400837390b5bcce7c649a0fdd8dbe341150/tests%2Fui%2Ffunctions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ffunctions.rs?ref=875b2400837390b5bcce7c649a0fdd8dbe341150", "patch": "@@ -78,6 +78,14 @@ pub fn public(p: *const u8) {\n     unsafe { std::ptr::read(p) };\n }\n \n+type Alias = *const u8;\n+\n+pub fn type_alias(p: Alias) {\n+    println!(\"{}\", unsafe { *p });\n+    println!(\"{:?}\", unsafe { p.as_ref() });\n+    unsafe { std::ptr::read(p) };\n+}\n+\n impl Bar {\n     fn private(self, p: *const u8) {\n         println!(\"{}\", unsafe { *p });"}, {"sha": "8ebd4997f4f6e836983c92a66191a793429dc3ee", "filename": "tests/ui/functions.stderr", "status": "modified", "additions": 22, "deletions": 4, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/875b2400837390b5bcce7c649a0fdd8dbe341150/tests%2Fui%2Ffunctions.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/875b2400837390b5bcce7c649a0fdd8dbe341150/tests%2Fui%2Ffunctions.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ffunctions.stderr?ref=875b2400837390b5bcce7c649a0fdd8dbe341150", "patch": "@@ -69,22 +69,40 @@ LL |     unsafe { std::ptr::read(p) };\n    |                             ^\n \n error: this public function might dereference a raw pointer but is not marked `unsafe`\n-  --> $DIR/functions.rs:87:34\n+  --> $DIR/functions.rs:84:30\n+   |\n+LL |     println!(\"{}\", unsafe { *p });\n+   |                              ^\n+\n+error: this public function might dereference a raw pointer but is not marked `unsafe`\n+  --> $DIR/functions.rs:85:31\n+   |\n+LL |     println!(\"{:?}\", unsafe { p.as_ref() });\n+   |                               ^\n+\n+error: this public function might dereference a raw pointer but is not marked `unsafe`\n+  --> $DIR/functions.rs:86:29\n+   |\n+LL |     unsafe { std::ptr::read(p) };\n+   |                             ^\n+\n+error: this public function might dereference a raw pointer but is not marked `unsafe`\n+  --> $DIR/functions.rs:95:34\n    |\n LL |         println!(\"{}\", unsafe { *p });\n    |                                  ^\n \n error: this public function might dereference a raw pointer but is not marked `unsafe`\n-  --> $DIR/functions.rs:88:35\n+  --> $DIR/functions.rs:96:35\n    |\n LL |         println!(\"{:?}\", unsafe { p.as_ref() });\n    |                                   ^\n \n error: this public function might dereference a raw pointer but is not marked `unsafe`\n-  --> $DIR/functions.rs:89:33\n+  --> $DIR/functions.rs:97:33\n    |\n LL |         unsafe { std::ptr::read(p) };\n    |                                 ^\n \n-error: aborting due to 13 previous errors\n+error: aborting due to 16 previous errors\n "}]}