{"sha": "1512ce5925eeafc01f011c46216c157e4e5644cb", "node_id": "C_kwDOAAsO6NoAKDE1MTJjZTU5MjVlZWFmYzAxZjAxMWM0NjIxNmMxNTdlNGU1NjQ0Y2I", "commit": {"author": {"name": "Joshua Nelson", "email": "jnelson@cloudflare.com", "date": "2022-09-20T01:45:00Z"}, "committer": {"name": "Joshua Nelson", "email": "jnelson@cloudflare.com", "date": "2022-09-20T03:14:40Z"}, "message": "Make cycle errors recoverable\n\nIn particular, this allows rustdoc to recover from cycle errors when normalizing associated types for documentation.\n\nIn the past, `@jackh726` has said we need to be careful about overflow errors:\n\n> Off the top of my head, we definitely should be careful about treating overflow errors the same as\n\"not implemented for some reason\" errors. Otherwise, you could end up with behavior that is\ndifferent depending on recursion depth. But, that might be context-dependent.\n\nBut cycle errors should be safe to unconditionally report; they don't depend on the recursion depth, they will always be an error whenever they're encountered.", "tree": {"sha": "60e16916a82a26a1635edc0db527588a5c76d286", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/60e16916a82a26a1635edc0db527588a5c76d286"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1512ce5925eeafc01f011c46216c157e4e5644cb", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1512ce5925eeafc01f011c46216c157e4e5644cb", "html_url": "https://github.com/rust-lang/rust/commit/1512ce5925eeafc01f011c46216c157e4e5644cb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1512ce5925eeafc01f011c46216c157e4e5644cb/comments", "author": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "749dec64519b5bdfe688cb945eeee5afd6ab68d0", "url": "https://api.github.com/repos/rust-lang/rust/commits/749dec64519b5bdfe688cb945eeee5afd6ab68d0", "html_url": "https://github.com/rust-lang/rust/commit/749dec64519b5bdfe688cb945eeee5afd6ab68d0"}], "stats": {"total": 66, "additions": 50, "deletions": 16}, "files": [{"sha": "10e673cd9297bda67fddcec349af9f5657a7eaf5", "filename": "compiler/rustc_data_structures/src/obligation_forest/mod.rs", "status": "modified", "additions": 22, "deletions": 11, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/1512ce5925eeafc01f011c46216c157e4e5644cb/compiler%2Frustc_data_structures%2Fsrc%2Fobligation_forest%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1512ce5925eeafc01f011c46216c157e4e5644cb/compiler%2Frustc_data_structures%2Fsrc%2Fobligation_forest%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_data_structures%2Fsrc%2Fobligation_forest%2Fmod.rs?ref=1512ce5925eeafc01f011c46216c157e4e5644cb", "patch": "@@ -115,7 +115,11 @@ pub trait ObligationProcessor {\n     /// In other words, if we had O1 which required O2 which required\n     /// O3 which required O1, we would give an iterator yielding O1,\n     /// O2, O3 (O1 is not yielded twice).\n-    fn process_backedge<'c, I>(&mut self, cycle: I, _marker: PhantomData<&'c Self::Obligation>)\n+    fn process_backedge<'c, I>(\n+        &mut self,\n+        cycle: I,\n+        _marker: PhantomData<&'c Self::Obligation>,\n+    ) -> Result<(), Self::Error>\n     where\n         I: Clone + Iterator<Item = &'c Self::Obligation>;\n }\n@@ -406,12 +410,11 @@ impl<O: ForestObligation> ObligationForest<O> {\n \n     /// Performs a fixpoint computation over the obligation list.\n     #[inline(never)]\n-    pub fn process_obligations<P, OUT>(&mut self, processor: &mut P) -> OUT\n+    pub fn process_obligations<P>(&mut self, processor: &mut P) -> P::OUT\n     where\n         P: ObligationProcessor<Obligation = O>,\n-        OUT: OutcomeTrait<Obligation = O, Error = Error<O, P::Error>>,\n     {\n-        let mut outcome = OUT::new();\n+        let mut outcome = P::OUT::new();\n \n         // Fixpoint computation: we repeat until the inner loop stalls.\n         loop {\n@@ -477,7 +480,7 @@ impl<O: ForestObligation> ObligationForest<O> {\n             }\n \n             self.mark_successes();\n-            self.process_cycles(processor);\n+            self.process_cycles(processor, &mut outcome);\n             self.compress(|obl| outcome.record_completed(obl));\n         }\n \n@@ -562,7 +565,7 @@ impl<O: ForestObligation> ObligationForest<O> {\n \n     /// Report cycles between all `Success` nodes, and convert all `Success`\n     /// nodes to `Done`. This must be called after `mark_successes`.\n-    fn process_cycles<P>(&mut self, processor: &mut P)\n+    fn process_cycles<P>(&mut self, processor: &mut P, outcome: &mut P::OUT)\n     where\n         P: ObligationProcessor<Obligation = O>,\n     {\n@@ -572,16 +575,21 @@ impl<O: ForestObligation> ObligationForest<O> {\n             // to handle the no-op cases immediately to avoid the cost of the\n             // function call.\n             if node.state.get() == NodeState::Success {\n-                self.find_cycles_from_node(&mut stack, processor, index);\n+                self.find_cycles_from_node(&mut stack, processor, index, outcome);\n             }\n         }\n \n         debug_assert!(stack.is_empty());\n         self.reused_node_vec = stack;\n     }\n \n-    fn find_cycles_from_node<P>(&self, stack: &mut Vec<usize>, processor: &mut P, index: usize)\n-    where\n+    fn find_cycles_from_node<P>(\n+        &self,\n+        stack: &mut Vec<usize>,\n+        processor: &mut P,\n+        index: usize,\n+        outcome: &mut P::OUT,\n+    ) where\n         P: ObligationProcessor<Obligation = O>,\n     {\n         let node = &self.nodes[index];\n@@ -590,17 +598,20 @@ impl<O: ForestObligation> ObligationForest<O> {\n                 None => {\n                     stack.push(index);\n                     for &dep_index in node.dependents.iter() {\n-                        self.find_cycles_from_node(stack, processor, dep_index);\n+                        self.find_cycles_from_node(stack, processor, dep_index, outcome);\n                     }\n                     stack.pop();\n                     node.state.set(NodeState::Done);\n                 }\n                 Some(rpos) => {\n                     // Cycle detected.\n-                    processor.process_backedge(\n+                    let result = processor.process_backedge(\n                         stack[rpos..].iter().map(|&i| &self.nodes[i].obligation),\n                         PhantomData,\n                     );\n+                    if let Err(err) = result {\n+                        outcome.record_error(Error { error: err, backtrace: self.error_at(index) });\n+                    }\n                 }\n             }\n         }"}, {"sha": "bc252f772a1683afe5df1a9a7febe086623727b6", "filename": "compiler/rustc_data_structures/src/obligation_forest/tests.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/1512ce5925eeafc01f011c46216c157e4e5644cb/compiler%2Frustc_data_structures%2Fsrc%2Fobligation_forest%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1512ce5925eeafc01f011c46216c157e4e5644cb/compiler%2Frustc_data_structures%2Fsrc%2Fobligation_forest%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_data_structures%2Fsrc%2Fobligation_forest%2Ftests.rs?ref=1512ce5925eeafc01f011c46216c157e4e5644cb", "patch": "@@ -77,10 +77,15 @@ where\n         (self.process_obligation)(obligation)\n     }\n \n-    fn process_backedge<'c, I>(&mut self, _cycle: I, _marker: PhantomData<&'c Self::Obligation>)\n+    fn process_backedge<'c, I>(\n+        &mut self,\n+        _cycle: I,\n+        _marker: PhantomData<&'c Self::Obligation>,\n+    ) -> Result<(), Self::Error>\n     where\n         I: Clone + Iterator<Item = &'c Self::Obligation>,\n     {\n+        Ok(())\n     }\n }\n "}, {"sha": "ed2beefc6e77322d71436c0876b0af1a6e53899f", "filename": "compiler/rustc_infer/src/traits/mod.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1512ce5925eeafc01f011c46216c157e4e5644cb/compiler%2Frustc_infer%2Fsrc%2Ftraits%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1512ce5925eeafc01f011c46216c157e4e5644cb/compiler%2Frustc_infer%2Fsrc%2Ftraits%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_infer%2Fsrc%2Ftraits%2Fmod.rs?ref=1512ce5925eeafc01f011c46216c157e4e5644cb", "patch": "@@ -105,6 +105,8 @@ pub struct FulfillmentError<'tcx> {\n \n #[derive(Clone)]\n pub enum FulfillmentErrorCode<'tcx> {\n+    /// Inherently impossible to fulfill; this trait is implemented if and only if it is already implemented.\n+    CodeCycle(Vec<Obligation<'tcx, ty::Predicate<'tcx>>>),\n     CodeSelectionError(SelectionError<'tcx>),\n     CodeProjectionError(MismatchedProjectionTypes<'tcx>),\n     CodeSubtypeError(ExpectedFound<Ty<'tcx>>, TypeError<'tcx>), // always comes from a SubtypePredicate"}, {"sha": "1c6ab6a082b99ce7279d425bedb0fc04f984a2c5", "filename": "compiler/rustc_infer/src/traits/structural_impls.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/1512ce5925eeafc01f011c46216c157e4e5644cb/compiler%2Frustc_infer%2Fsrc%2Ftraits%2Fstructural_impls.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1512ce5925eeafc01f011c46216c157e4e5644cb/compiler%2Frustc_infer%2Fsrc%2Ftraits%2Fstructural_impls.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_infer%2Fsrc%2Ftraits%2Fstructural_impls.rs?ref=1512ce5925eeafc01f011c46216c157e4e5644cb", "patch": "@@ -47,6 +47,7 @@ impl<'tcx> fmt::Debug for traits::FulfillmentErrorCode<'tcx> {\n                 write!(f, \"CodeConstEquateError({:?}, {:?})\", a, b)\n             }\n             super::CodeAmbiguity => write!(f, \"Ambiguity\"),\n+            super::CodeCycle(ref cycle) => write!(f, \"Cycle({:?})\", cycle),\n         }\n     }\n }"}, {"sha": "0155798c8b6d70c61b8319ad59814f5a2499dc8b", "filename": "compiler/rustc_trait_selection/src/traits/codegen.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/1512ce5925eeafc01f011c46216c157e4e5644cb/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fcodegen.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1512ce5925eeafc01f011c46216c157e4e5644cb/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fcodegen.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fcodegen.rs?ref=1512ce5925eeafc01f011c46216c157e4e5644cb", "patch": "@@ -4,10 +4,12 @@\n // general routines.\n \n use crate::infer::{DefiningAnchor, TyCtxtInferExt};\n+use crate::traits::error_reporting::InferCtxtExt;\n use crate::traits::{\n     ImplSource, Obligation, ObligationCause, SelectionContext, TraitEngine, TraitEngineExt,\n     Unimplemented,\n };\n+use rustc_infer::traits::FulfillmentErrorCode;\n use rustc_middle::traits::CodegenObligationError;\n use rustc_middle::ty::{self, TyCtxt};\n \n@@ -62,6 +64,14 @@ pub fn codegen_select_candidate<'tcx>(\n         // optimization to stop iterating early.\n         let errors = fulfill_cx.select_all_or_error(&infcx);\n         if !errors.is_empty() {\n+            // `rustc_monomorphize::collector` assumes there are no type errors.\n+            // Cycle errors are the only post-monomorphization errors possible; emit them now so\n+            // `rustc_ty_utils::resolve_associated_item` doesn't return `None` post-monomorphization.\n+            for err in errors {\n+                if let FulfillmentErrorCode::CodeCycle(cycle) = err.code {\n+                    infcx.report_overflow_error_cycle(&cycle);\n+                }\n+            }\n             return Err(CodegenObligationError::FulfillmentError);\n         }\n "}, {"sha": "d62b399c1b5624f0f350ab9957f6c5f3af3202fa", "filename": "compiler/rustc_trait_selection/src/traits/error_reporting/mod.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/1512ce5925eeafc01f011c46216c157e4e5644cb/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1512ce5925eeafc01f011c46216c157e4e5644cb/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fmod.rs?ref=1512ce5925eeafc01f011c46216c157e4e5644cb", "patch": "@@ -1540,6 +1540,9 @@ impl<'a, 'tcx> InferCtxtPrivExt<'a, 'tcx> for InferCtxt<'a, 'tcx> {\n                 }\n                 diag.emit();\n             }\n+            FulfillmentErrorCode::CodeCycle(ref cycle) => {\n+                self.report_overflow_error_cycle(cycle);\n+            }\n         }\n     }\n "}, {"sha": "1cd8e1c21236f1dede8159f273da7912d78f9c80", "filename": "compiler/rustc_trait_selection/src/traits/fulfill.rs", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/1512ce5925eeafc01f011c46216c157e4e5644cb/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ffulfill.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1512ce5925eeafc01f011c46216c157e4e5644cb/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ffulfill.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ffulfill.rs?ref=1512ce5925eeafc01f011c46216c157e4e5644cb", "patch": "@@ -25,10 +25,9 @@ use super::Unimplemented;\n use super::{FulfillmentError, FulfillmentErrorCode};\n use super::{ObligationCause, PredicateObligation};\n \n-use crate::traits::error_reporting::InferCtxtExt as _;\n use crate::traits::project::PolyProjectionObligation;\n use crate::traits::project::ProjectionCacheKeyExt as _;\n-use crate::traits::query::evaluate_obligation::InferCtxtExt as _;\n+use crate::traits::query::evaluate_obligation::InferCtxtExt;\n \n impl<'tcx> ForestObligation for PendingPredicateObligation<'tcx> {\n     /// Note that we include both the `ParamEnv` and the `Predicate`,\n@@ -603,14 +602,16 @@ impl<'a, 'b, 'tcx> ObligationProcessor for FulfillProcessor<'a, 'b, 'tcx> {\n         &mut self,\n         cycle: I,\n         _marker: PhantomData<&'c PendingPredicateObligation<'tcx>>,\n-    ) where\n+    ) -> Result<(), FulfillmentErrorCode<'tcx>>\n+    where\n         I: Clone + Iterator<Item = &'c PendingPredicateObligation<'tcx>>,\n     {\n         if self.selcx.coinductive_match(cycle.clone().map(|s| s.obligation.predicate)) {\n             debug!(\"process_child_obligations: coinductive match\");\n+            Ok(())\n         } else {\n             let cycle: Vec<_> = cycle.map(|c| c.obligation.clone()).collect();\n-            self.selcx.infcx().report_overflow_error_cycle(&cycle);\n+            Err(FulfillmentErrorCode::CodeCycle(cycle))\n         }\n     }\n }"}, {"sha": "1ed9ac6bc34ac06878d8970806a3878e341f7d5c", "filename": "src/test/rustdoc-ui/normalize-cycle.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/1512ce5925eeafc01f011c46216c157e4e5644cb/src%2Ftest%2Frustdoc-ui%2Fnormalize-cycle.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1512ce5925eeafc01f011c46216c157e4e5644cb/src%2Ftest%2Frustdoc-ui%2Fnormalize-cycle.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fnormalize-cycle.rs?ref=1512ce5925eeafc01f011c46216c157e4e5644cb", "patch": "@@ -1,4 +1,5 @@\n // check-pass\n+// compile-flags: -Znormalize-docs\n // Regression test for <https://github.com/rust-lang/rust/issues/79459>.\n pub trait Query {}\n "}]}