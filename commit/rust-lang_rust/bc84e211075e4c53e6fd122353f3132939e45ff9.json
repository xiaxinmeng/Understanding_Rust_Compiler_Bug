{"sha": "bc84e211075e4c53e6fd122353f3132939e45ff9", "node_id": "MDY6Q29tbWl0NzI0NzEyOmJjODRlMjExMDc1ZTRjNTNlNmZkMTIyMzUzZjMxMzI5MzllNDVmZjk=", "commit": {"author": {"name": "Aaron Hill", "email": "aa1ronham@gmail.com", "date": "2021-02-03T17:33:27Z"}, "committer": {"name": "Aaron Hill", "email": "aa1ronham@gmail.com", "date": "2021-02-03T17:36:24Z"}, "message": "Fix panic when emitting diagnostic for closure mutable binding error\n\nFixes #81700\n\nThe upvar borrow kind may be `ty::BorrowKind::UniqueImmBorrow`, which is\nstill a mutable borrow for the purposes of this diagnostic code.", "tree": {"sha": "ac4c6ded68d81f3a01ac9fa84f4d6b4858614b12", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ac4c6ded68d81f3a01ac9fa84f4d6b4858614b12"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bc84e211075e4c53e6fd122353f3132939e45ff9", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE7J9Gc3TfBwj2K399tAh+UQ6YsWQFAmAa30wACgkQtAh+UQ6Y\nsWSPJA/+NjZpqhAMiIljUbYtnAyrwlIe7Y3Y9cWX5Mn4NKrOv6bEOASAB4U8iuJN\nPb+mGwYgalqYnz9QXjhLrP+epNIifGo1XZKOXW/+ExdUNeForP8Yn7as3KyBjRqu\nJR4g8bwDNSFMRjigJSNw1H05b5Mm+KgN/N6Jpk2d0TLiyL8TdNkDCUWngLNpaMxS\nvoanI9Ds5K39ayO8Vte8TKT5J01FAvNu+pKua/VWnFKuCWwb1kJthyLhKqnsJ/lP\nTMn2Gy612uPmnnncNXes94gn2jBvtnTPqrUbPg9PMv8kA/HeeTvcM/C3L3nco2e1\nWH6k4XUuK4qhfIM+aKIK6l41FtEb/EghvHfInu94qn3rp97Ki3qLwNbn1CSLiVHl\nnF7bVdXhWGDmJmO7CI7zS/K8pFcSzkKXC8F48kMArNY8l8LG2fu0rEjDj4ifYJA7\nef1Fqfob90zJtGtUgHjGbTOQPxI2sovAjVX5WZ3hULSrfFpOWA1jNnyJ1oHDUc8u\nGlTRw8m8PGLQDPBz9VNIx7eOc2YLuLXwtajhGb5wOIgO23MqF5f/2jwqQ4q7gMHc\nbBAMnfNfST87ZejldAXHkmasufIov6mP3GLkozv0Z3rkJ4QfRL91z2h+xrSuBBO1\nP5+vv0UIS+uBXhhoVxrAVXmyFqyu/oVVmQNTsXFPP7YTZ9mnISo=\n=StpG\n-----END PGP SIGNATURE-----", "payload": "tree ac4c6ded68d81f3a01ac9fa84f4d6b4858614b12\nparent 6ad11e2e25919b75ebbc36d7910f2a1126a7e873\nauthor Aaron Hill <aa1ronham@gmail.com> 1612373607 -0500\ncommitter Aaron Hill <aa1ronham@gmail.com> 1612373784 -0500\n\nFix panic when emitting diagnostic for closure mutable binding error\n\nFixes #81700\n\nThe upvar borrow kind may be `ty::BorrowKind::UniqueImmBorrow`, which is\nstill a mutable borrow for the purposes of this diagnostic code.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bc84e211075e4c53e6fd122353f3132939e45ff9", "html_url": "https://github.com/rust-lang/rust/commit/bc84e211075e4c53e6fd122353f3132939e45ff9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bc84e211075e4c53e6fd122353f3132939e45ff9/comments", "author": {"login": "Aaron1011", "id": 1408859, "node_id": "MDQ6VXNlcjE0MDg4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1408859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Aaron1011", "html_url": "https://github.com/Aaron1011", "followers_url": "https://api.github.com/users/Aaron1011/followers", "following_url": "https://api.github.com/users/Aaron1011/following{/other_user}", "gists_url": "https://api.github.com/users/Aaron1011/gists{/gist_id}", "starred_url": "https://api.github.com/users/Aaron1011/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Aaron1011/subscriptions", "organizations_url": "https://api.github.com/users/Aaron1011/orgs", "repos_url": "https://api.github.com/users/Aaron1011/repos", "events_url": "https://api.github.com/users/Aaron1011/events{/privacy}", "received_events_url": "https://api.github.com/users/Aaron1011/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Aaron1011", "id": 1408859, "node_id": "MDQ6VXNlcjE0MDg4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1408859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Aaron1011", "html_url": "https://github.com/Aaron1011", "followers_url": "https://api.github.com/users/Aaron1011/followers", "following_url": "https://api.github.com/users/Aaron1011/following{/other_user}", "gists_url": "https://api.github.com/users/Aaron1011/gists{/gist_id}", "starred_url": "https://api.github.com/users/Aaron1011/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Aaron1011/subscriptions", "organizations_url": "https://api.github.com/users/Aaron1011/orgs", "repos_url": "https://api.github.com/users/Aaron1011/repos", "events_url": "https://api.github.com/users/Aaron1011/events{/privacy}", "received_events_url": "https://api.github.com/users/Aaron1011/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6ad11e2e25919b75ebbc36d7910f2a1126a7e873", "url": "https://api.github.com/repos/rust-lang/rust/commits/6ad11e2e25919b75ebbc36d7910f2a1126a7e873", "html_url": "https://github.com/rust-lang/rust/commit/6ad11e2e25919b75ebbc36d7910f2a1126a7e873"}], "stats": {"total": 22, "additions": 20, "deletions": 2}, "files": [{"sha": "333ac0738d45be1fba045d2aba44fef7007abb58", "filename": "compiler/rustc_mir/src/borrow_check/diagnostics/mutability_errors.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/bc84e211075e4c53e6fd122353f3132939e45ff9/compiler%2Frustc_mir%2Fsrc%2Fborrow_check%2Fdiagnostics%2Fmutability_errors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bc84e211075e4c53e6fd122353f3132939e45ff9/compiler%2Frustc_mir%2Fsrc%2Fborrow_check%2Fdiagnostics%2Fmutability_errors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Fborrow_check%2Fdiagnostics%2Fmutability_errors.rs?ref=bc84e211075e4c53e6fd122353f3132939e45ff9", "patch": "@@ -514,15 +514,15 @@ impl<'a, 'tcx> MirBorrowckCtxt<'a, 'tcx> {\n             let upvar = ty::place_to_string_for_capture(tcx, place);\n             match tables.upvar_capture(upvar_id) {\n                 ty::UpvarCapture::ByRef(ty::UpvarBorrow {\n-                    kind: ty::BorrowKind::MutBorrow,\n+                    kind: ty::BorrowKind::MutBorrow | ty::BorrowKind::UniqueImmBorrow,\n                     ..\n                 }) => {\n                     format!(\"mutable borrow of `{}`\", upvar)\n                 }\n                 ty::UpvarCapture::ByValue(_) => {\n                     format!(\"possible mutation of `{}`\", upvar)\n                 }\n-                _ => bug!(\"upvar `{}` borrowed, but not mutably\", upvar),\n+                val => bug!(\"upvar `{}` borrowed, but not mutably: {:?}\", upvar, val),\n             }\n         } else {\n             bug!(\"not an upvar\")"}, {"sha": "a27a6160142adc34f041e8565d3163bcd63d7c4e", "filename": "src/test/ui/closures/issue-81700-mut-borrow.rs", "status": "added", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/bc84e211075e4c53e6fd122353f3132939e45ff9/src%2Ftest%2Fui%2Fclosures%2Fissue-81700-mut-borrow.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bc84e211075e4c53e6fd122353f3132939e45ff9/src%2Ftest%2Fui%2Fclosures%2Fissue-81700-mut-borrow.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fclosures%2Fissue-81700-mut-borrow.rs?ref=bc84e211075e4c53e6fd122353f3132939e45ff9", "patch": "@@ -0,0 +1,5 @@\n+fn foo(x: &mut u32) {\n+    let bar = || { foo(x); };\n+    bar(); //~ ERROR cannot borrow\n+}\n+fn main() {}"}, {"sha": "3f564afff58e2df73a1424e327fc0bc8551c7ed2", "filename": "src/test/ui/closures/issue-81700-mut-borrow.stderr", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/bc84e211075e4c53e6fd122353f3132939e45ff9/src%2Ftest%2Fui%2Fclosures%2Fissue-81700-mut-borrow.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/bc84e211075e4c53e6fd122353f3132939e45ff9/src%2Ftest%2Fui%2Fclosures%2Fissue-81700-mut-borrow.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fclosures%2Fissue-81700-mut-borrow.stderr?ref=bc84e211075e4c53e6fd122353f3132939e45ff9", "patch": "@@ -0,0 +1,13 @@\n+error[E0596]: cannot borrow `bar` as mutable, as it is not declared as mutable\n+  --> $DIR/issue-81700-mut-borrow.rs:3:5\n+   |\n+LL |     let bar = || { foo(x); };\n+   |         ---            - calling `bar` requires mutable binding due to mutable borrow of `x`\n+   |         |\n+   |         help: consider changing this to be mutable: `mut bar`\n+LL |     bar();\n+   |     ^^^ cannot borrow as mutable\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0596`."}]}