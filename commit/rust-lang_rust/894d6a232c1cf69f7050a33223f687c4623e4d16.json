{"sha": "894d6a232c1cf69f7050a33223f687c4623e4d16", "node_id": "C_kwDOAAsO6NoAKDg5NGQ2YTIzMmMxY2Y2OWY3MDUwYTMzMjIzZjY4N2M0NjIzZTRkMTY", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-07-24T12:46:08Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-07-24T12:46:08Z"}, "message": "Auto merge of #12832 - lowr:fix/impl-default-members-no-codegen, r=Veykril\n\nfix: don't replace default members' body\n\ncc #12779, #12821\naddresses https://github.com/rust-lang/rust-analyzer/pull/12821#issuecomment-1190157506\n\n`gen_trait_fn_body()` only attempts to implement required trait member functions, so we shouldn't call it for `Implement default members` assist.\n\nThis patch also documents the precondition of `gen_trait_fn_body()` and inserts `debug_assert!`, but I'm not entirely sure if the assertions are appropriate.", "tree": {"sha": "147a43e3e764c162139c42bd4935ad819754165c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/147a43e3e764c162139c42bd4935ad819754165c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/894d6a232c1cf69f7050a33223f687c4623e4d16", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/894d6a232c1cf69f7050a33223f687c4623e4d16", "html_url": "https://github.com/rust-lang/rust/commit/894d6a232c1cf69f7050a33223f687c4623e4d16", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/894d6a232c1cf69f7050a33223f687c4623e4d16/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "977e12a0bdc3e329af179ef3a9d466af9eb613bb", "url": "https://api.github.com/repos/rust-lang/rust/commits/977e12a0bdc3e329af179ef3a9d466af9eb613bb", "html_url": "https://github.com/rust-lang/rust/commit/977e12a0bdc3e329af179ef3a9d466af9eb613bb"}, {"sha": "7e0bd377c2ffe55a1f014ce932a7218a9b4dc639", "url": "https://api.github.com/repos/rust-lang/rust/commits/7e0bd377c2ffe55a1f014ce932a7218a9b4dc639", "html_url": "https://github.com/rust-lang/rust/commit/7e0bd377c2ffe55a1f014ce932a7218a9b4dc639"}], "stats": {"total": 28, "additions": 16, "deletions": 12}, "files": [{"sha": "c808c010c672eac67d9d397eaf20fa5332d7fee7", "filename": "crates/ide-assists/src/handlers/add_missing_impl_members.rs", "status": "modified", "additions": 10, "deletions": 7, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/894d6a232c1cf69f7050a33223f687c4623e4d16/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fadd_missing_impl_members.rs", "raw_url": "https://github.com/rust-lang/rust/raw/894d6a232c1cf69f7050a33223f687c4623e4d16/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fadd_missing_impl_members.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fadd_missing_impl_members.rs?ref=894d6a232c1cf69f7050a33223f687c4623e4d16", "patch": "@@ -145,13 +145,16 @@ fn add_missing_impl_members_inner(\n             Some(cap) => {\n                 let mut cursor = Cursor::Before(first_new_item.syntax());\n                 let placeholder;\n-                if let ast::AssocItem::Fn(func) = &first_new_item {\n-                    if try_gen_trait_body(ctx, func, &trait_, &impl_def).is_none() {\n-                        if let Some(m) = func.syntax().descendants().find_map(ast::MacroCall::cast)\n-                        {\n-                            if m.syntax().text() == \"todo!()\" {\n-                                placeholder = m;\n-                                cursor = Cursor::Replace(placeholder.syntax());\n+                if let DefaultMethods::No = mode {\n+                    if let ast::AssocItem::Fn(func) = &first_new_item {\n+                        if try_gen_trait_body(ctx, func, &trait_, &impl_def).is_none() {\n+                            if let Some(m) =\n+                                func.syntax().descendants().find_map(ast::MacroCall::cast)\n+                            {\n+                                if m.syntax().text() == \"todo!()\" {\n+                                    placeholder = m;\n+                                    cursor = Cursor::Replace(placeholder.syntax());\n+                                }\n                             }\n                         }\n                     }"}, {"sha": "43aaad3150ced60ad542cf97e20f59145c461e1b", "filename": "crates/ide-assists/src/utils/gen_trait_fn_body.rs", "status": "modified", "additions": 6, "deletions": 5, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/894d6a232c1cf69f7050a33223f687c4623e4d16/crates%2Fide-assists%2Fsrc%2Futils%2Fgen_trait_fn_body.rs", "raw_url": "https://github.com/rust-lang/rust/raw/894d6a232c1cf69f7050a33223f687c4623e4d16/crates%2Fide-assists%2Fsrc%2Futils%2Fgen_trait_fn_body.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-assists%2Fsrc%2Futils%2Fgen_trait_fn_body.rs?ref=894d6a232c1cf69f7050a33223f687c4623e4d16", "patch": "@@ -5,7 +5,7 @@ use syntax::{\n     ted,\n };\n \n-/// Generate custom trait bodies where possible.\n+/// Generate custom trait bodies without default implementation where possible.\n ///\n /// Returns `Option` so that we can use `?` rather than `if let Some`. Returning\n /// `None` means that generating a custom trait body failed, and the body will remain\n@@ -28,6 +28,7 @@ pub(crate) fn gen_trait_fn_body(\n \n /// Generate a `Clone` impl based on the fields and members of the target type.\n fn gen_clone_impl(adt: &ast::Adt, func: &ast::Fn) -> Option<()> {\n+    debug_assert!(func.name().map_or(false, |name| name.text() == \"clone\"));\n     fn gen_clone_call(target: ast::Expr) -> ast::Expr {\n         let method = make::name_ref(\"clone\");\n         make::expr_method_call(target, method, make::arg_list(None))\n@@ -339,6 +340,7 @@ fn gen_default_impl(adt: &ast::Adt, func: &ast::Fn) -> Option<()> {\n \n /// Generate a `Hash` impl based on the fields and members of the target type.\n fn gen_hash_impl(adt: &ast::Adt, func: &ast::Fn) -> Option<()> {\n+    debug_assert!(func.name().map_or(false, |name| name.text() == \"hash\"));\n     fn gen_hash_call(target: ast::Expr) -> ast::Stmt {\n         let method = make::name_ref(\"hash\");\n         let arg = make::expr_path(make::ext::ident_path(\"state\"));\n@@ -394,9 +396,7 @@ fn gen_hash_impl(adt: &ast::Adt, func: &ast::Fn) -> Option<()> {\n \n /// Generate a `PartialEq` impl based on the fields and members of the target type.\n fn gen_partial_eq(adt: &ast::Adt, func: &ast::Fn) -> Option<()> {\n-    if func.name().map_or(false, |name| name.text() == \"ne\") {\n-        return None;\n-    }\n+    debug_assert!(func.name().map_or(false, |name| name.text() == \"eq\"));\n     fn gen_eq_chain(expr: Option<ast::Expr>, cmp: ast::Expr) -> Option<ast::Expr> {\n         match expr {\n             Some(expr) => Some(make::expr_bin_op(expr, BinaryOp::LogicOp(LogicOp::And), cmp)),\n@@ -573,6 +573,7 @@ fn gen_partial_eq(adt: &ast::Adt, func: &ast::Fn) -> Option<()> {\n }\n \n fn gen_partial_ord(adt: &ast::Adt, func: &ast::Fn) -> Option<()> {\n+    debug_assert!(func.name().map_or(false, |name| name.text() == \"partial_cmp\"));\n     fn gen_partial_eq_match(match_target: ast::Expr) -> Option<ast::Stmt> {\n         let mut arms = vec![];\n \n@@ -643,7 +644,7 @@ fn gen_partial_ord(adt: &ast::Adt, func: &ast::Fn) -> Option<()> {\n                 make::block_expr(stmts.into_iter(), tail).indent(ast::edit::IndentLevel(1))\n             }\n \n-            // No fields in the body means there's nothing to hash.\n+            // No fields in the body means there's nothing to compare.\n             None => {\n                 let expr = make::expr_literal(\"true\").into();\n                 make::block_expr(None, Some(expr)).indent(ast::edit::IndentLevel(1))"}]}