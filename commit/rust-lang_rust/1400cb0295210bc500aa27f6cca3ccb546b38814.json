{"sha": "1400cb0295210bc500aa27f6cca3ccb546b38814", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE0MDBjYjAyOTUyMTBiYzUwMGFhMjdmNmNjYTNjY2I1NDZiMzg4MTQ=", "commit": {"author": {"name": "Eric Huss", "email": "eric@huss.org", "date": "2021-05-18T03:39:28Z"}, "committer": {"name": "Eric Huss", "email": "eric@huss.org", "date": "2021-05-18T14:37:14Z"}, "message": "Fix use placement for suggestions near main.", "tree": {"sha": "ce20ed1cdf2c9cb966ffc42755eee2332579044e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ce20ed1cdf2c9cb966ffc42755eee2332579044e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1400cb0295210bc500aa27f6cca3ccb546b38814", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1400cb0295210bc500aa27f6cca3ccb546b38814", "html_url": "https://github.com/rust-lang/rust/commit/1400cb0295210bc500aa27f6cca3ccb546b38814", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1400cb0295210bc500aa27f6cca3ccb546b38814/comments", "author": {"login": "ehuss", "id": 43198, "node_id": "MDQ6VXNlcjQzMTk4", "avatar_url": "https://avatars.githubusercontent.com/u/43198?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ehuss", "html_url": "https://github.com/ehuss", "followers_url": "https://api.github.com/users/ehuss/followers", "following_url": "https://api.github.com/users/ehuss/following{/other_user}", "gists_url": "https://api.github.com/users/ehuss/gists{/gist_id}", "starred_url": "https://api.github.com/users/ehuss/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ehuss/subscriptions", "organizations_url": "https://api.github.com/users/ehuss/orgs", "repos_url": "https://api.github.com/users/ehuss/repos", "events_url": "https://api.github.com/users/ehuss/events{/privacy}", "received_events_url": "https://api.github.com/users/ehuss/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ehuss", "id": 43198, "node_id": "MDQ6VXNlcjQzMTk4", "avatar_url": "https://avatars.githubusercontent.com/u/43198?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ehuss", "html_url": "https://github.com/ehuss", "followers_url": "https://api.github.com/users/ehuss/followers", "following_url": "https://api.github.com/users/ehuss/following{/other_user}", "gists_url": "https://api.github.com/users/ehuss/gists{/gist_id}", "starred_url": "https://api.github.com/users/ehuss/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ehuss/subscriptions", "organizations_url": "https://api.github.com/users/ehuss/orgs", "repos_url": "https://api.github.com/users/ehuss/repos", "events_url": "https://api.github.com/users/ehuss/events{/privacy}", "received_events_url": "https://api.github.com/users/ehuss/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5f10d310f475b3ba583b9c590b8d19f6c2fde28f", "url": "https://api.github.com/repos/rust-lang/rust/commits/5f10d310f475b3ba583b9c590b8d19f6c2fde28f", "html_url": "https://github.com/rust-lang/rust/commit/5f10d310f475b3ba583b9c590b8d19f6c2fde28f"}], "stats": {"total": 187, "additions": 167, "deletions": 20}, "files": [{"sha": "c36aa91a5e8f515fa2844a3a4ba9cd2e0fdba5f4", "filename": "compiler/rustc_resolve/src/lib.rs", "status": "modified", "additions": 8, "deletions": 8, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/1400cb0295210bc500aa27f6cca3ccb546b38814/compiler%2Frustc_resolve%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1400cb0295210bc500aa27f6cca3ccb546b38814/compiler%2Frustc_resolve%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Flib.rs?ref=1400cb0295210bc500aa27f6cca3ccb546b38814", "patch": "@@ -330,15 +330,15 @@ impl UsePlacementFinder {\n                     if self.span.map_or(true, |span| item.span < span)\n                         && !item.span.from_expansion()\n                     {\n+                        self.span = Some(item.span.shrink_to_lo());\n                         // don't insert between attributes and an item\n-                        if item.attrs.is_empty() {\n-                            self.span = Some(item.span.shrink_to_lo());\n-                        } else {\n-                            // find the first attribute on the item\n-                            for attr in &item.attrs {\n-                                if self.span.map_or(true, |span| attr.span < span) {\n-                                    self.span = Some(attr.span.shrink_to_lo());\n-                                }\n+                        // find the first attribute on the item\n+                        // FIXME: This is broken for active attributes.\n+                        for attr in &item.attrs {\n+                            if !attr.span.is_dummy()\n+                                && self.span.map_or(true, |span| attr.span < span)\n+                            {\n+                                self.span = Some(attr.span.shrink_to_lo());\n                             }\n                         }\n                     }"}, {"sha": "2aab29d3f7c5b0783c471dc42cb1550a254a1ce6", "filename": "compiler/rustc_typeck/src/check/method/suggest.rs", "status": "modified", "additions": 8, "deletions": 8, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/1400cb0295210bc500aa27f6cca3ccb546b38814/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fmethod%2Fsuggest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1400cb0295210bc500aa27f6cca3ccb546b38814/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fmethod%2Fsuggest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fmethod%2Fsuggest.rs?ref=1400cb0295210bc500aa27f6cca3ccb546b38814", "patch": "@@ -1557,16 +1557,16 @@ impl intravisit::Visitor<'tcx> for UsePlacementFinder<'tcx> {\n                 _ => {\n                     if self.span.map_or(true, |span| item.span < span) {\n                         if !item.span.from_expansion() {\n+                            self.span = Some(item.span.shrink_to_lo());\n                             // Don't insert between attributes and an item.\n                             let attrs = self.tcx.hir().attrs(item.hir_id());\n-                            if attrs.is_empty() {\n-                                self.span = Some(item.span.shrink_to_lo());\n-                            } else {\n-                                // Find the first attribute on the item.\n-                                for attr in attrs {\n-                                    if self.span.map_or(true, |span| attr.span < span) {\n-                                        self.span = Some(attr.span.shrink_to_lo());\n-                                    }\n+                            // Find the first attribute on the item.\n+                            // FIXME: This is broken for active attributes.\n+                            for attr in attrs {\n+                                if !attr.span.is_dummy()\n+                                    && self.span.map_or(true, |span| attr.span < span)\n+                                {\n+                                    self.span = Some(attr.span.shrink_to_lo());\n                                 }\n                             }\n                         }"}, {"sha": "63676327aa041992e249f219cb639294e0b4f222", "filename": "src/test/ui/resolve/use_suggestion_placement.fixed", "status": "added", "additions": 39, "deletions": 0, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/1400cb0295210bc500aa27f6cca3ccb546b38814/src%2Ftest%2Fui%2Fresolve%2Fuse_suggestion_placement.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/1400cb0295210bc500aa27f6cca3ccb546b38814/src%2Ftest%2Fui%2Fresolve%2Fuse_suggestion_placement.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fresolve%2Fuse_suggestion_placement.fixed?ref=1400cb0295210bc500aa27f6cca3ccb546b38814", "patch": "@@ -0,0 +1,39 @@\n+// run-rustfix\n+#![allow(dead_code)]\n+\n+use m::A;\n+\n+use std::collections::HashMap;\n+\n+macro_rules! y {\n+    () => {}\n+}\n+\n+mod m {\n+    pub const A: i32 = 0;\n+}\n+\n+mod foo {\n+    // FIXME: UsePlacementFinder is broken because active attributes are\n+    // removed, and thus the `derive` attribute here is not in the AST.\n+    // An inert attribute should work, though.\n+    // #[derive(Debug)]\n+    use std::path::Path;\n+\n+#[allow(warnings)]\n+    pub struct Foo;\n+\n+    // test whether the use suggestion isn't\n+    // placed into the expansion of `#[derive(Debug)]\n+    type Bar = Path; //~ ERROR cannot find\n+}\n+\n+fn main() {\n+    y!();\n+    let _ = A; //~ ERROR cannot find\n+    foo();\n+}\n+\n+fn foo() {\n+    type Dict<K, V> = HashMap<K, V>; //~ ERROR cannot find\n+}"}, {"sha": "ecc74d781679d5702ae193fb39b96d3bf274f678", "filename": "src/test/ui/resolve/use_suggestion_placement.rs", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/1400cb0295210bc500aa27f6cca3ccb546b38814/src%2Ftest%2Fui%2Fresolve%2Fuse_suggestion_placement.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1400cb0295210bc500aa27f6cca3ccb546b38814/src%2Ftest%2Fui%2Fresolve%2Fuse_suggestion_placement.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fresolve%2Fuse_suggestion_placement.rs?ref=1400cb0295210bc500aa27f6cca3ccb546b38814", "patch": "@@ -1,3 +1,6 @@\n+// run-rustfix\n+#![allow(dead_code)]\n+\n macro_rules! y {\n     () => {}\n }\n@@ -7,7 +10,11 @@ mod m {\n }\n \n mod foo {\n-    #[derive(Debug)]\n+    // FIXME: UsePlacementFinder is broken because active attributes are\n+    // removed, and thus the `derive` attribute here is not in the AST.\n+    // An inert attribute should work, though.\n+    // #[derive(Debug)]\n+    #[allow(warnings)]\n     pub struct Foo;\n \n     // test whether the use suggestion isn't"}, {"sha": "217c08a560b77f7b1f754bef703097233e96beba", "filename": "src/test/ui/resolve/use_suggestion_placement.stderr", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/1400cb0295210bc500aa27f6cca3ccb546b38814/src%2Ftest%2Fui%2Fresolve%2Fuse_suggestion_placement.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/1400cb0295210bc500aa27f6cca3ccb546b38814/src%2Ftest%2Fui%2Fresolve%2Fuse_suggestion_placement.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fresolve%2Fuse_suggestion_placement.stderr?ref=1400cb0295210bc500aa27f6cca3ccb546b38814", "patch": "@@ -1,5 +1,5 @@\n error[E0412]: cannot find type `Path` in this scope\n-  --> $DIR/use_suggestion_placement.rs:15:16\n+  --> $DIR/use_suggestion_placement.rs:22:16\n    |\n LL |     type Bar = Path;\n    |                ^^^^ not found in this scope\n@@ -10,7 +10,7 @@ LL |     use std::path::Path;\n    |\n \n error[E0425]: cannot find value `A` in this scope\n-  --> $DIR/use_suggestion_placement.rs:20:13\n+  --> $DIR/use_suggestion_placement.rs:27:13\n    |\n LL |     let _ = A;\n    |             ^ not found in this scope\n@@ -21,7 +21,7 @@ LL | use m::A;\n    |\n \n error[E0412]: cannot find type `HashMap` in this scope\n-  --> $DIR/use_suggestion_placement.rs:25:23\n+  --> $DIR/use_suggestion_placement.rs:32:23\n    |\n LL |     type Dict<K, V> = HashMap<K, V>;\n    |                       ^^^^^^^ not found in this scope"}, {"sha": "afe74cff2e92d75ef3a7990df41f880796f5eac0", "filename": "src/test/ui/suggestions/use-placement-resolve.fixed", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/1400cb0295210bc500aa27f6cca3ccb546b38814/src%2Ftest%2Fui%2Fsuggestions%2Fuse-placement-resolve.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/1400cb0295210bc500aa27f6cca3ccb546b38814/src%2Ftest%2Fui%2Fsuggestions%2Fuse-placement-resolve.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsuggestions%2Fuse-placement-resolve.fixed?ref=1400cb0295210bc500aa27f6cca3ccb546b38814", "patch": "@@ -0,0 +1,13 @@\n+// compile-flags: --test\n+// run-rustfix\n+// Checks that the `use` suggestion appears *below* this inner attribute.\n+// There was an issue where the test synthetic #[allow(dead)] attribute on\n+// main which has a dummy span caused the suggestion to be placed at the top\n+// of the file.\n+#![allow(unused)]\n+\n+use std::fmt::Debug;\n+\n+fn main() {}\n+\n+fn foobar<T: Debug>(x: T) {} //~ ERROR expected trait, found derive macro"}, {"sha": "b30ddb3af07b4f528f75899d09a7449c7546537e", "filename": "src/test/ui/suggestions/use-placement-resolve.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/1400cb0295210bc500aa27f6cca3ccb546b38814/src%2Ftest%2Fui%2Fsuggestions%2Fuse-placement-resolve.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1400cb0295210bc500aa27f6cca3ccb546b38814/src%2Ftest%2Fui%2Fsuggestions%2Fuse-placement-resolve.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsuggestions%2Fuse-placement-resolve.rs?ref=1400cb0295210bc500aa27f6cca3ccb546b38814", "patch": "@@ -0,0 +1,11 @@\n+// compile-flags: --test\n+// run-rustfix\n+// Checks that the `use` suggestion appears *below* this inner attribute.\n+// There was an issue where the test synthetic #[allow(dead)] attribute on\n+// main which has a dummy span caused the suggestion to be placed at the top\n+// of the file.\n+#![allow(unused)]\n+\n+fn main() {}\n+\n+fn foobar<T: Debug>(x: T) {} //~ ERROR expected trait, found derive macro"}, {"sha": "9da9e8e27021df40b0aa88bd6a88ceb6d849a26c", "filename": "src/test/ui/suggestions/use-placement-resolve.stderr", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/1400cb0295210bc500aa27f6cca3ccb546b38814/src%2Ftest%2Fui%2Fsuggestions%2Fuse-placement-resolve.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/1400cb0295210bc500aa27f6cca3ccb546b38814/src%2Ftest%2Fui%2Fsuggestions%2Fuse-placement-resolve.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsuggestions%2Fuse-placement-resolve.stderr?ref=1400cb0295210bc500aa27f6cca3ccb546b38814", "patch": "@@ -0,0 +1,14 @@\n+error[E0404]: expected trait, found derive macro `Debug`\n+  --> $DIR/use-placement-resolve.rs:11:14\n+   |\n+LL | fn foobar<T: Debug>(x: T) {}\n+   |              ^^^^^ not a trait\n+   |\n+help: consider importing this trait instead\n+   |\n+LL | use std::fmt::Debug;\n+   |\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0404`."}, {"sha": "40c55d1dd06bc700221bae02f8660e78e5ffe7b0", "filename": "src/test/ui/suggestions/use-placement-typeck.fixed", "status": "added", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/1400cb0295210bc500aa27f6cca3ccb546b38814/src%2Ftest%2Fui%2Fsuggestions%2Fuse-placement-typeck.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/1400cb0295210bc500aa27f6cca3ccb546b38814/src%2Ftest%2Fui%2Fsuggestions%2Fuse-placement-typeck.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsuggestions%2Fuse-placement-typeck.fixed?ref=1400cb0295210bc500aa27f6cca3ccb546b38814", "patch": "@@ -0,0 +1,22 @@\n+// compile-flags: --test\n+// run-rustfix\n+// Checks that the `use` suggestion appears *below* this inner attribute.\n+// There was an issue where the test synthetic #[allow(dead)] attribute on\n+// main which has a dummy span caused the suggestion to be placed at the top\n+// of the file.\n+#![allow(unused)]\n+\n+use m::Foo;\n+\n+fn main() {\n+    let s = m::S;\n+    s.abc(); //~ ERROR no method named `abc`\n+}\n+\n+mod m {\n+    pub trait Foo {\n+        fn abc(&self) {}\n+    }\n+    pub struct S;\n+    impl Foo for S{}\n+}"}, {"sha": "aab20d2e90a3853aabefd1bef647072faf372565", "filename": "src/test/ui/suggestions/use-placement-typeck.rs", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/1400cb0295210bc500aa27f6cca3ccb546b38814/src%2Ftest%2Fui%2Fsuggestions%2Fuse-placement-typeck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1400cb0295210bc500aa27f6cca3ccb546b38814/src%2Ftest%2Fui%2Fsuggestions%2Fuse-placement-typeck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsuggestions%2Fuse-placement-typeck.rs?ref=1400cb0295210bc500aa27f6cca3ccb546b38814", "patch": "@@ -0,0 +1,20 @@\n+// compile-flags: --test\n+// run-rustfix\n+// Checks that the `use` suggestion appears *below* this inner attribute.\n+// There was an issue where the test synthetic #[allow(dead)] attribute on\n+// main which has a dummy span caused the suggestion to be placed at the top\n+// of the file.\n+#![allow(unused)]\n+\n+fn main() {\n+    let s = m::S;\n+    s.abc(); //~ ERROR no method named `abc`\n+}\n+\n+mod m {\n+    pub trait Foo {\n+        fn abc(&self) {}\n+    }\n+    pub struct S;\n+    impl Foo for S{}\n+}"}, {"sha": "21f22dade2c224891b33e4833de39ae8945097a2", "filename": "src/test/ui/suggestions/use-placement-typeck.stderr", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/1400cb0295210bc500aa27f6cca3ccb546b38814/src%2Ftest%2Fui%2Fsuggestions%2Fuse-placement-typeck.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/1400cb0295210bc500aa27f6cca3ccb546b38814/src%2Ftest%2Fui%2Fsuggestions%2Fuse-placement-typeck.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsuggestions%2Fuse-placement-typeck.stderr?ref=1400cb0295210bc500aa27f6cca3ccb546b38814", "patch": "@@ -0,0 +1,21 @@\n+error[E0599]: no method named `abc` found for struct `S` in the current scope\n+  --> $DIR/use-placement-typeck.rs:11:7\n+   |\n+LL |     s.abc();\n+   |       ^^^ method not found in `S`\n+...\n+LL |         fn abc(&self) {}\n+   |            --- the method is available for `S` here\n+LL |     }\n+LL |     pub struct S;\n+   |     ------------- method `abc` not found for this\n+   |\n+   = help: items from traits can only be used if the trait is in scope\n+help: the following trait is implemented but not in scope; perhaps add a `use` for it:\n+   |\n+LL | use m::Foo;\n+   |\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0599`."}]}