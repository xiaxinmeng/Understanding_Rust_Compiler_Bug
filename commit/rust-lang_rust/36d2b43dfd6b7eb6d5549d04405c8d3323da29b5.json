{"sha": "36d2b43dfd6b7eb6d5549d04405c8d3323da29b5", "node_id": "C_kwDOAAsO6NoAKDM2ZDJiNDNkZmQ2YjdlYjZkNTU0OWQwNDQwNWM4ZDMzMjNkYTI5YjU", "commit": {"author": {"name": "Ryo Yoshida", "email": "low.ryoshida@gmail.com", "date": "2022-06-28T11:40:22Z"}, "committer": {"name": "Ryo Yoshida", "email": "low.ryoshida@gmail.com", "date": "2022-06-28T11:44:55Z"}, "message": "fix: improve whitespace insertion in pretty printer", "tree": {"sha": "7aaec78b55461ca35eac48dacfd5233537b2ee70", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7aaec78b55461ca35eac48dacfd5233537b2ee70"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/36d2b43dfd6b7eb6d5549d04405c8d3323da29b5", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEkSbsQIURluxz4rzf4laYqTBYYXEFAmK66bcACgkQ4laYqTBY\nYXHBzg/+JKVNiRcKNNBtTTD91ohNMp+DgQrbAc8OcDFrHQLD7c0rCCU0JHL6iPm9\nPSzIg4HHX7znfRdtDhdnt1UXqu9D1ivg9YMjVrBmjM8e8pGRSHb0KCsH+ndq8Y8y\nvDRHZFUg83ai0b+DIekadw1lLWmFtO30N4xBzAsqb6iE+eRmwsdRCBE7b1ZAt9Eb\nfcnq5119RorCKj+IW1UBX0IVsU/QMVV/Stk1gczV/ok8d3gkBTeRsbZrPprL9vDc\nAFv14QBuqL0mTJzTEWSL+c/EFU43Zu/3i2ZosmI0eYohszqoONP5aSIAnvVwj49J\n2BkfREIK317c4EIr19HLgKBdyJRqkXZS+0nh6XqQKdwcNfsXGUKFY9/go0XwBLpF\n2pLQ3MknOMCG5M7BG99Y9BDsgH88/7JgSlIbEHvoa2EwELqW3d5RzQJvePtdooIM\nbbCTc9F/lGY2HMA/4K2Fg176CIEm2PsINXTGK2BD18ghjLbBcvu8HJpmeHIYsnh4\nqgspSWp+Uz0iNhphmwYNqz8tUs/Jrc0RDid+hx9tnQrB9ihfg4R0JvSbm/s6Q2gT\nO2fv9GFnjsS4k983KImFxHWYSoofh0bnT/00IrBQNESANvl+R+sk+w6murnaDwzp\npaGb3LbXFMYZyTOsvpZSRgmbppZwpVkVNSPuebmxqlGztrXhDhs=\n=oDhc\n-----END PGP SIGNATURE-----", "payload": "tree 7aaec78b55461ca35eac48dacfd5233537b2ee70\nparent 9eaf96c9ead87703d96558e9b9923a0baea27981\nauthor Ryo Yoshida <low.ryoshida@gmail.com> 1656416422 +0900\ncommitter Ryo Yoshida <low.ryoshida@gmail.com> 1656416695 +0900\n\nfix: improve whitespace insertion in pretty printer\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/36d2b43dfd6b7eb6d5549d04405c8d3323da29b5", "html_url": "https://github.com/rust-lang/rust/commit/36d2b43dfd6b7eb6d5549d04405c8d3323da29b5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/36d2b43dfd6b7eb6d5549d04405c8d3323da29b5/comments", "author": {"login": "lowr", "id": 24381114, "node_id": "MDQ6VXNlcjI0MzgxMTE0", "avatar_url": "https://avatars.githubusercontent.com/u/24381114?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lowr", "html_url": "https://github.com/lowr", "followers_url": "https://api.github.com/users/lowr/followers", "following_url": "https://api.github.com/users/lowr/following{/other_user}", "gists_url": "https://api.github.com/users/lowr/gists{/gist_id}", "starred_url": "https://api.github.com/users/lowr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lowr/subscriptions", "organizations_url": "https://api.github.com/users/lowr/orgs", "repos_url": "https://api.github.com/users/lowr/repos", "events_url": "https://api.github.com/users/lowr/events{/privacy}", "received_events_url": "https://api.github.com/users/lowr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lowr", "id": 24381114, "node_id": "MDQ6VXNlcjI0MzgxMTE0", "avatar_url": "https://avatars.githubusercontent.com/u/24381114?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lowr", "html_url": "https://github.com/lowr", "followers_url": "https://api.github.com/users/lowr/followers", "following_url": "https://api.github.com/users/lowr/following{/other_user}", "gists_url": "https://api.github.com/users/lowr/gists{/gist_id}", "starred_url": "https://api.github.com/users/lowr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lowr/subscriptions", "organizations_url": "https://api.github.com/users/lowr/orgs", "repos_url": "https://api.github.com/users/lowr/repos", "events_url": "https://api.github.com/users/lowr/events{/privacy}", "received_events_url": "https://api.github.com/users/lowr/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9eaf96c9ead87703d96558e9b9923a0baea27981", "url": "https://api.github.com/repos/rust-lang/rust/commits/9eaf96c9ead87703d96558e9b9923a0baea27981", "html_url": "https://github.com/rust-lang/rust/commit/9eaf96c9ead87703d96558e9b9923a0baea27981"}], "stats": {"total": 50, "additions": 46, "deletions": 4}, "files": [{"sha": "f54ae6c9202294fa9a4a93aabccb1faecbbc1f11", "filename": "crates/ide-db/src/syntax_helpers/insert_whitespace_into_node.rs", "status": "modified", "additions": 14, "deletions": 4, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/36d2b43dfd6b7eb6d5549d04405c8d3323da29b5/crates%2Fide-db%2Fsrc%2Fsyntax_helpers%2Finsert_whitespace_into_node.rs", "raw_url": "https://github.com/rust-lang/rust/raw/36d2b43dfd6b7eb6d5549d04405c8d3323da29b5/crates%2Fide-db%2Fsrc%2Fsyntax_helpers%2Finsert_whitespace_into_node.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-db%2Fsrc%2Fsyntax_helpers%2Finsert_whitespace_into_node.rs?ref=36d2b43dfd6b7eb6d5549d04405c8d3323da29b5", "patch": "@@ -33,7 +33,10 @@ pub fn insert_ws_into(syn: SyntaxNode) -> SyntaxNode {\n         let token = match event {\n             WalkEvent::Enter(NodeOrToken::Token(token)) => token,\n             WalkEvent::Leave(NodeOrToken::Node(node))\n-                if matches!(node.kind(), ATTR | MATCH_ARM | STRUCT | ENUM | UNION | FN | IMPL) =>\n+                if matches!(\n+                    node.kind(),\n+                    ATTR | MATCH_ARM | STRUCT | ENUM | UNION | FN | IMPL | MACRO_RULES\n+                ) =>\n             {\n                 if indent > 0 {\n                     mods.push((\n@@ -66,9 +69,7 @@ pub fn insert_ws_into(syn: SyntaxNode) -> SyntaxNode {\n                     mods.push(do_ws(before, tok));\n                 }\n \n-                if indent > 0 {\n-                    mods.push(do_indent(after, tok, indent));\n-                }\n+                mods.push(do_indent(after, tok, indent));\n                 mods.push(do_nl(after, tok));\n             }\n             R_CURLY if is_last(|it| it != L_CURLY, true) => {\n@@ -100,10 +101,19 @@ pub fn insert_ws_into(syn: SyntaxNode) -> SyntaxNode {\n                 }\n                 mods.push(do_nl(after, tok));\n             }\n+            T![=] if is_next(|it| it == T![>], false) => {\n+                // FIXME: this branch is for `=>` in macro_rules!, which is currently parsed as\n+                // two separate symbols.\n+                mods.push(do_ws(before, tok));\n+                mods.push(do_ws(after, &tok.next_token().unwrap()));\n+            }\n             T![->] | T![=] | T![=>] => {\n                 mods.push(do_ws(before, tok));\n                 mods.push(do_ws(after, tok));\n             }\n+            T![!] if is_last(|it| it == MACRO_RULES_KW, false) && is_next(is_text, false) => {\n+                mods.push(do_ws(after, tok));\n+            }\n             _ => (),\n         }\n "}, {"sha": "fd0a29f64f67cc3ffa3e17b7c414767029556342", "filename": "crates/ide/src/expand_macro.rs", "status": "modified", "additions": 32, "deletions": 0, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/36d2b43dfd6b7eb6d5549d04405c8d3323da29b5/crates%2Fide%2Fsrc%2Fexpand_macro.rs", "raw_url": "https://github.com/rust-lang/rust/raw/36d2b43dfd6b7eb6d5549d04405c8d3323da29b5/crates%2Fide%2Fsrc%2Fexpand_macro.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fexpand_macro.rs?ref=36d2b43dfd6b7eb6d5549d04405c8d3323da29b5", "patch": "@@ -360,6 +360,38 @@ fn main() {\n         );\n     }\n \n+    #[test]\n+    fn macro_expand_inner_macro_rules() {\n+        check(\n+            r#\"\n+macro_rules! foo {\n+    ($t:tt) => {{\n+        macro_rules! bar {\n+            () => {\n+                $t\n+            }\n+        }\n+        bar!()\n+    }};\n+}\n+\n+fn main() {\n+    foo$0!(42);\n+}\n+            \"#,\n+            expect![[r#\"\n+                foo\n+                {\n+                  macro_rules! bar {\n+                    () => {\n+                      42\n+                    }\n+                  }\n+                  42\n+                }\"#]],\n+        );\n+    }\n+\n     #[test]\n     fn macro_expand_inner_macro_fail_to_expand() {\n         check("}]}