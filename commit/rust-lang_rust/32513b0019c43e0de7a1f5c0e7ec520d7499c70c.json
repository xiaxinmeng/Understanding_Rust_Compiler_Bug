{"sha": "32513b0019c43e0de7a1f5c0e7ec520d7499c70c", "node_id": "MDY6Q29tbWl0NzI0NzEyOjMyNTEzYjAwMTljNDNlMGRlN2ExZjVjMGU3ZWM1MjBkNzQ5OWM3MGM=", "commit": {"author": {"name": "Huon Wilson", "email": "dbau.pp+github@gmail.com", "date": "2014-10-14T11:20:59Z"}, "committer": {"name": "Huon Wilson", "email": "dbau.pp+github@gmail.com", "date": "2014-10-14T11:20:59Z"}, "message": "test: make the sort failure-safety test unsafeless and more obvious.\n\nPreviously it had some uninituitive conditionals due to the interaction\nwith the Rand construction and Clone reinitialisation to create\nsequential identifying numbers. This replaces all that with just\nconstructing the DropCounters with the appropriate identifiers.", "tree": {"sha": "3304f04c4f51b33e07db351772ef53e9427c0089", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3304f04c4f51b33e07db351772ef53e9427c0089"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/32513b0019c43e0de7a1f5c0e7ec520d7499c70c", "comment_count": 5, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/32513b0019c43e0de7a1f5c0e7ec520d7499c70c", "html_url": "https://github.com/rust-lang/rust/commit/32513b0019c43e0de7a1f5c0e7ec520d7499c70c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/32513b0019c43e0de7a1f5c0e7ec520d7499c70c/comments", "author": {"login": "huonw", "id": 1203825, "node_id": "MDQ6VXNlcjEyMDM4MjU=", "avatar_url": "https://avatars.githubusercontent.com/u/1203825?v=4", "gravatar_id": "", "url": "https://api.github.com/users/huonw", "html_url": "https://github.com/huonw", "followers_url": "https://api.github.com/users/huonw/followers", "following_url": "https://api.github.com/users/huonw/following{/other_user}", "gists_url": "https://api.github.com/users/huonw/gists{/gist_id}", "starred_url": "https://api.github.com/users/huonw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/huonw/subscriptions", "organizations_url": "https://api.github.com/users/huonw/orgs", "repos_url": "https://api.github.com/users/huonw/repos", "events_url": "https://api.github.com/users/huonw/events{/privacy}", "received_events_url": "https://api.github.com/users/huonw/received_events", "type": "User", "site_admin": false}, "committer": {"login": "huonw", "id": 1203825, "node_id": "MDQ6VXNlcjEyMDM4MjU=", "avatar_url": "https://avatars.githubusercontent.com/u/1203825?v=4", "gravatar_id": "", "url": "https://api.github.com/users/huonw", "html_url": "https://github.com/huonw", "followers_url": "https://api.github.com/users/huonw/followers", "following_url": "https://api.github.com/users/huonw/following{/other_user}", "gists_url": "https://api.github.com/users/huonw/gists{/gist_id}", "starred_url": "https://api.github.com/users/huonw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/huonw/subscriptions", "organizations_url": "https://api.github.com/users/huonw/orgs", "repos_url": "https://api.github.com/users/huonw/repos", "events_url": "https://api.github.com/users/huonw/events{/privacy}", "received_events_url": "https://api.github.com/users/huonw/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1c3ddd297128a96f72be09bddf138e4e603a7aa1", "url": "https://api.github.com/repos/rust-lang/rust/commits/1c3ddd297128a96f72be09bddf138e4e603a7aa1", "html_url": "https://github.com/rust-lang/rust/commit/1c3ddd297128a96f72be09bddf138e4e603a7aa1"}], "stats": {"total": 74, "additions": 43, "deletions": 31}, "files": [{"sha": "46f760722a6052a7ab6ee6d77a052a2774f0680b", "filename": "src/test/run-pass/vector-sort-failure-safe.rs", "status": "modified", "additions": 43, "deletions": 31, "changes": 74, "blob_url": "https://github.com/rust-lang/rust/blob/32513b0019c43e0de7a1f5c0e7ec520d7499c70c/src%2Ftest%2Frun-pass%2Fvector-sort-failure-safe.rs", "raw_url": "https://github.com/rust-lang/rust/raw/32513b0019c43e0de7a1f5c0e7ec520d7499c70c/src%2Ftest%2Frun-pass%2Fvector-sort-failure-safe.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fvector-sort-failure-safe.rs?ref=32513b0019c43e0de7a1f5c0e7ec520d7499c70c", "patch": "@@ -9,41 +9,56 @@\n // except according to those terms.\n \n use std::task;\n-use std::rand::{task_rng, Rng};\n+use std::sync::atomics::{AtomicUint, INIT_ATOMIC_UINT, Relaxed};\n+use std::rand::{task_rng, Rng, Rand};\n \n-const MAX_LEN: uint = 20;\n-static mut drop_counts: [uint, .. MAX_LEN] = [0, .. MAX_LEN];\n-static mut clone_count: uint = 0;\n+const REPEATS: uint = 5;\n+const MAX_LEN: uint = 32;\n+static drop_counts: [AtomicUint, .. MAX_LEN] =\n+    // FIXME #5244: AtomicUint is not Copy.\n+    [\n+        INIT_ATOMIC_UINT, INIT_ATOMIC_UINT, INIT_ATOMIC_UINT, INIT_ATOMIC_UINT,\n+        INIT_ATOMIC_UINT, INIT_ATOMIC_UINT, INIT_ATOMIC_UINT, INIT_ATOMIC_UINT,\n+        INIT_ATOMIC_UINT, INIT_ATOMIC_UINT, INIT_ATOMIC_UINT, INIT_ATOMIC_UINT,\n+        INIT_ATOMIC_UINT, INIT_ATOMIC_UINT, INIT_ATOMIC_UINT, INIT_ATOMIC_UINT,\n \n-#[deriving(Rand, PartialEq, PartialOrd, Eq, Ord)]\n-struct DropCounter { x: uint, clone_num: uint }\n+        INIT_ATOMIC_UINT, INIT_ATOMIC_UINT, INIT_ATOMIC_UINT, INIT_ATOMIC_UINT,\n+        INIT_ATOMIC_UINT, INIT_ATOMIC_UINT, INIT_ATOMIC_UINT, INIT_ATOMIC_UINT,\n+        INIT_ATOMIC_UINT, INIT_ATOMIC_UINT, INIT_ATOMIC_UINT, INIT_ATOMIC_UINT,\n+        INIT_ATOMIC_UINT, INIT_ATOMIC_UINT, INIT_ATOMIC_UINT, INIT_ATOMIC_UINT,\n+     ];\n \n-impl Clone for DropCounter {\n-    fn clone(&self) -> DropCounter {\n-        let num = unsafe { clone_count };\n-        unsafe { clone_count += 1; }\n+static creation_count: AtomicUint = INIT_ATOMIC_UINT;\n+\n+#[deriving(Clone, PartialEq, PartialOrd, Eq, Ord)]\n+struct DropCounter { x: uint, creation_id: uint }\n+\n+impl Rand for DropCounter {\n+    fn rand<R: Rng>(rng: &mut R) -> DropCounter {\n+        // (we're not using this concurrently, so Relaxed is fine.)\n+        let num = creation_count.fetch_add(1, Relaxed);\n         DropCounter {\n-            x: self.x,\n-            clone_num: num\n+            x: rng.gen(),\n+            creation_id: num\n         }\n     }\n }\n \n impl Drop for DropCounter {\n     fn drop(&mut self) {\n-        unsafe {\n-            // Rand creates some with arbitrary clone_nums\n-            if self.clone_num < MAX_LEN {\n-                drop_counts[self.clone_num] += 1;\n-            }\n-        }\n+        drop_counts[self.creation_id].fetch_add(1, Relaxed);\n     }\n }\n \n pub fn main() {\n+    assert!(MAX_LEN <= std::uint::BITS);\n     // len can't go above 64.\n-    for len in range(2u, MAX_LEN) {\n-        for _ in range(0i, 10) {\n+    for len in range(2, MAX_LEN) {\n+        for _ in range(0, REPEATS) {\n+            // reset the count for these new DropCounters, so their\n+            // IDs start from 0.\n+            creation_count.store(0, Relaxed);\n+\n             let main = task_rng().gen_iter::<DropCounter>()\n                                  .take(len)\n                                  .collect::<Vec<DropCounter>>();\n@@ -56,14 +71,13 @@ pub fn main() {\n             // ... and then fail on each and every single one.\n             for fail_countdown in range(0i, count) {\n                 // refresh the counters.\n-                unsafe {\n-                    drop_counts = [0, .. MAX_LEN];\n-                    clone_count = 0;\n+                for c in drop_counts.iter() {\n+                    c.store(0, Relaxed);\n                 }\n \n                 let v = main.clone();\n \n-                task::try(proc() {\n+                let _ = task::try(proc() {\n                         let mut v = v;\n                         let mut fail_countdown = fail_countdown;\n                         v.as_mut_slice().sort_by(|a, b| {\n@@ -77,13 +91,11 @@ pub fn main() {\n \n                 // check that the number of things dropped is exactly\n                 // what we expect (i.e. the contents of `v`).\n-                unsafe {\n-                    for (i, &c) in drop_counts.iter().enumerate() {\n-                        let expected = if i < len {1} else {0};\n-                        assert!(c == expected,\n-                                \"found drop count == {} for i == {}, len == {}\",\n-                                c, i, len);\n-                    }\n+                for (i, c) in drop_counts.iter().enumerate().take(len) {\n+                    let count = c.load(Relaxed);\n+                    assert!(count == 1,\n+                            \"found drop count == {} for i == {}, len == {}\",\n+                            count, i, len);\n                 }\n             }\n         }"}]}