{"sha": "ee35ed3e1a828b47478d70b569dc979d9119aabb", "node_id": "C_kwDOAAsO6NoAKGVlMzVlZDNlMWE4MjhiNDc0NzhkNzBiNTY5ZGM5NzlkOTExOWFhYmI", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-01-24T11:29:57Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-01-24T11:29:57Z"}, "message": "Rollup merge of #93253 - jsha:theme-on-show, r=GuillaumeGomez\n\nUpdate theme on pageshow event\n\nWhen a user goes forward or back, the page may be rendered from the back/forward cache (https://web.dev/bfcache/) rather than from scratch. If they have changed theme in the meantime, that means seeing an incorrect theme on the page they went forward or back to. The `pageshow` event fires on such navigations, so we can update the theme based on that event.\n\nDemo: https://rustdoc.crud.net/jsha/theme-on-show/std/string/trait.ToString.html\n\nr? `@GuillaumeGomez`", "tree": {"sha": "803ed2ddd148edebde6594ce72a6e809a1bf7b8c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/803ed2ddd148edebde6594ce72a6e809a1bf7b8c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ee35ed3e1a828b47478d70b569dc979d9119aabb", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJh7o21CRBK7hj4Ov3rIwAAlDYIADviiLeavJYhSO5+YPOyQYFH\nboxaVL5di1sIFYKBOVgzEx8aJXVyd8W3WbbzhVLnaK21e6dwmRKecEqoPR707R3k\nuEpLfT3zb10WePJz5vFZ3FdUnySNL2mSUDucN7mpObqYG9IRK1vJIz92VGf5eQ2m\nF/qGry+/mVfLDlo0sEhJ4JOf4EpqySDMdRVmGP1EHg+mwYi247/OjtN1DcnumvRi\nFjirjiW2ru/kdNmU/iYJWxREnxXLUuOzktWqnkZSPpRqWS2kreiTxUqENT7kOnHz\nzLOojNY3Yq6UaMH578AI/vVOhVjCHXrHf55fI0FRnyD17vDZnQh4k/pQx8JliVQ=\n=KZn5\n-----END PGP SIGNATURE-----\n", "payload": "tree 803ed2ddd148edebde6594ce72a6e809a1bf7b8c\nparent d1aa2f7b0b652026b404788a4e7af557753d662f\nparent b30725eab7cbc898dbdb851d5977a352d1dd2187\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1643023797 +0100\ncommitter GitHub <noreply@github.com> 1643023797 +0100\n\nRollup merge of #93253 - jsha:theme-on-show, r=GuillaumeGomez\n\nUpdate theme on pageshow event\n\nWhen a user goes forward or back, the page may be rendered from the back/forward cache (https://web.dev/bfcache/) rather than from scratch. If they have changed theme in the meantime, that means seeing an incorrect theme on the page they went forward or back to. The `pageshow` event fires on such navigations, so we can update the theme based on that event.\n\nDemo: https://rustdoc.crud.net/jsha/theme-on-show/std/string/trait.ToString.html\n\nr? `@GuillaumeGomez`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ee35ed3e1a828b47478d70b569dc979d9119aabb", "html_url": "https://github.com/rust-lang/rust/commit/ee35ed3e1a828b47478d70b569dc979d9119aabb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ee35ed3e1a828b47478d70b569dc979d9119aabb/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d1aa2f7b0b652026b404788a4e7af557753d662f", "url": "https://api.github.com/repos/rust-lang/rust/commits/d1aa2f7b0b652026b404788a4e7af557753d662f", "html_url": "https://github.com/rust-lang/rust/commit/d1aa2f7b0b652026b404788a4e7af557753d662f"}, {"sha": "b30725eab7cbc898dbdb851d5977a352d1dd2187", "url": "https://api.github.com/repos/rust-lang/rust/commits/b30725eab7cbc898dbdb851d5977a352d1dd2187", "html_url": "https://github.com/rust-lang/rust/commit/b30725eab7cbc898dbdb851d5977a352d1dd2187"}], "stats": {"total": 31, "additions": 25, "deletions": 6}, "files": [{"sha": "06bb34eb11573c70165dcd4f8a8a8584e7154377", "filename": "src/librustdoc/html/static/js/storage.js", "status": "modified", "additions": 25, "deletions": 6, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/ee35ed3e1a828b47478d70b569dc979d9119aabb/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fstorage.js", "raw_url": "https://github.com/rust-lang/rust/raw/ee35ed3e1a828b47478d70b569dc979d9119aabb/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fstorage.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fstorage.js?ref=ee35ed3e1a828b47478d70b569dc979d9119aabb", "patch": "@@ -216,6 +216,15 @@ var updateSystemTheme = (function() {\n     };\n })();\n \n+function switchToSavedTheme() {\n+    switchTheme(\n+        window.currentTheme,\n+        window.mainTheme,\n+        getSettingValue(\"theme\") || \"light\",\n+        false\n+    );\n+}\n+\n if (getSettingValue(\"use-system-theme\") !== \"false\" && window.matchMedia) {\n     // update the preferred dark theme if the user is already using a dark theme\n     // See https://github.com/rust-lang/rust/pull/77809#issuecomment-707875732\n@@ -228,10 +237,20 @@ if (getSettingValue(\"use-system-theme\") !== \"false\" && window.matchMedia) {\n     // call the function to initialize the theme at least once!\n     updateSystemTheme();\n } else {\n-    switchTheme(\n-        window.currentTheme,\n-        window.mainTheme,\n-        getSettingValue(\"theme\") || \"light\",\n-        false\n-    );\n+    switchToSavedTheme();\n }\n+\n+// If we navigate away (for example to a settings page), and then use the back or\n+// forward button to get back to a page, the theme may have changed in the meantime.\n+// But scripts may not be re-loaded in such a case due to the bfcache\n+// (https://web.dev/bfcache/). The \"pageshow\" event triggers on such navigations.\n+// Use that opportunity to update the theme.\n+// We use a setTimeout with a 0 timeout here to put the change on the event queue.\n+// For some reason, if we try to change the theme while the `pageshow` event is\n+// running, it sometimes fails to take effect. The problem manifests on Chrome,\n+// specifically when talking to a remote website with no caching.\n+window.addEventListener(\"pageshow\", function(ev) {\n+    if (ev.persisted) {\n+        setTimeout(switchToSavedTheme, 0);\n+    }\n+});"}]}