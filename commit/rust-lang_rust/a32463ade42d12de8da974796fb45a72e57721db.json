{"sha": "a32463ade42d12de8da974796fb45a72e57721db", "node_id": "MDY6Q29tbWl0NzI0NzEyOmEzMjQ2M2FkZTQyZDEyZGU4ZGE5NzQ3OTZmYjQ1YTcyZTU3NzIxZGI=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2020-05-11T00:10:25Z"}, "committer": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2020-05-11T00:19:34Z"}, "message": "Make MIR typeck use `LocalDefId` and fix docs", "tree": {"sha": "7f6483c6c6a1fef2ef318e6c38583022927ba126", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7f6483c6c6a1fef2ef318e6c38583022927ba126"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a32463ade42d12de8da974796fb45a72e57721db", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a32463ade42d12de8da974796fb45a72e57721db", "html_url": "https://github.com/rust-lang/rust/commit/a32463ade42d12de8da974796fb45a72e57721db", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a32463ade42d12de8da974796fb45a72e57721db/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9912925c254589f58338cb2993163e618475ff75", "url": "https://api.github.com/repos/rust-lang/rust/commits/9912925c254589f58338cb2993163e618475ff75", "html_url": "https://github.com/rust-lang/rust/commit/9912925c254589f58338cb2993163e618475ff75"}], "stats": {"total": 104, "additions": 50, "deletions": 54}, "files": [{"sha": "a3ee49651ba7b9a0de492f705a5bb20edfe45f73", "filename": "src/librustc_mir/borrow_check/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a32463ade42d12de8da974796fb45a72e57721db/src%2Flibrustc_mir%2Fborrow_check%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a32463ade42d12de8da974796fb45a72e57721db/src%2Flibrustc_mir%2Fborrow_check%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fborrow_check%2Fmod.rs?ref=a32463ade42d12de8da974796fb45a72e57721db", "patch": "@@ -209,7 +209,7 @@ fn do_mir_borrowck<'a, 'tcx>(\n         nll_errors,\n     } = nll::compute_regions(\n         infcx,\n-        def_id.to_def_id(),\n+        def_id,\n         free_regions,\n         body,\n         &promoted,"}, {"sha": "b820b79c47fe8c547298925afff63a5abf04845c", "filename": "src/librustc_mir/borrow_check/nll.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/a32463ade42d12de8da974796fb45a72e57721db/src%2Flibrustc_mir%2Fborrow_check%2Fnll.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a32463ade42d12de8da974796fb45a72e57721db/src%2Flibrustc_mir%2Fborrow_check%2Fnll.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fborrow_check%2Fnll.rs?ref=a32463ade42d12de8da974796fb45a72e57721db", "patch": "@@ -2,7 +2,7 @@\n \n use rustc_data_structures::fx::FxHashMap;\n use rustc_errors::Diagnostic;\n-use rustc_hir::def_id::DefId;\n+use rustc_hir::def_id::{DefId, LocalDefId};\n use rustc_index::vec::IndexVec;\n use rustc_infer::infer::InferCtxt;\n use rustc_middle::mir::{\n@@ -157,7 +157,7 @@ fn populate_polonius_move_facts(\n /// This may result in errors being reported.\n pub(in crate::borrow_check) fn compute_regions<'cx, 'tcx>(\n     infcx: &InferCtxt<'cx, 'tcx>,\n-    def_id: DefId,\n+    def_id: LocalDefId,\n     universal_regions: UniversalRegions<'tcx>,\n     body: &Body<'tcx>,\n     promoted: &IndexVec<Promoted, Body<'tcx>>,\n@@ -272,7 +272,7 @@ pub(in crate::borrow_check) fn compute_regions<'cx, 'tcx>(\n     // Dump facts if requested.\n     let polonius_output = all_facts.and_then(|all_facts| {\n         if infcx.tcx.sess.opts.debugging_opts.nll_facts {\n-            let def_path = infcx.tcx.def_path(def_id);\n+            let def_path = infcx.tcx.def_path(def_id.to_def_id());\n             let dir_path =\n                 PathBuf::from(\"nll-facts\").join(def_path.to_filename_friendly_no_crate());\n             all_facts.write_to_dir(dir_path, location_table).unwrap();\n@@ -292,7 +292,7 @@ pub(in crate::borrow_check) fn compute_regions<'cx, 'tcx>(\n \n     // Solve the region constraints.\n     let (closure_region_requirements, nll_errors) =\n-        regioncx.solve(infcx, &body, def_id, polonius_output.clone());\n+        regioncx.solve(infcx, &body, def_id.to_def_id(), polonius_output.clone());\n \n     if !nll_errors.is_empty() {\n         // Suppress unhelpful extra errors in `infer_opaque_types`."}, {"sha": "edd2dc3c2de55acf0e0424511e9b329b8dcfb412", "filename": "src/librustc_mir/borrow_check/type_check/input_output.rs", "status": "modified", "additions": 29, "deletions": 27, "changes": 56, "blob_url": "https://github.com/rust-lang/rust/blob/a32463ade42d12de8da974796fb45a72e57721db/src%2Flibrustc_mir%2Fborrow_check%2Ftype_check%2Finput_output.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a32463ade42d12de8da974796fb45a72e57721db/src%2Flibrustc_mir%2Fborrow_check%2Ftype_check%2Finput_output.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fborrow_check%2Ftype_check%2Finput_output.rs?ref=a32463ade42d12de8da974796fb45a72e57721db", "patch": "@@ -33,35 +33,37 @@ impl<'a, 'tcx> TypeChecker<'a, 'tcx> {\n         //\n         // e.g., `|x: FxHashMap<_, &'static u32>| ...`\n         let user_provided_sig;\n-        if !self.tcx().is_closure(self.mir_def_id) {\n+        if !self.tcx().is_closure(self.mir_def_id.to_def_id()) {\n             user_provided_sig = None;\n         } else {\n-            let typeck_tables = self.tcx().typeck_tables_of(self.mir_def_id.expect_local());\n-            user_provided_sig = match typeck_tables.user_provided_sigs.get(&self.mir_def_id) {\n-                None => None,\n-                Some(user_provided_poly_sig) => {\n-                    // Instantiate the canonicalized variables from\n-                    // user-provided signature (e.g., the `_` in the code\n-                    // above) with fresh variables.\n-                    let (poly_sig, _) = self.infcx.instantiate_canonical_with_fresh_inference_vars(\n-                        body.span,\n-                        &user_provided_poly_sig,\n-                    );\n-\n-                    // Replace the bound items in the fn sig with fresh\n-                    // variables, so that they represent the view from\n-                    // \"inside\" the closure.\n-                    Some(\n-                        self.infcx\n-                            .replace_bound_vars_with_fresh_vars(\n+            let typeck_tables = self.tcx().typeck_tables_of(self.mir_def_id);\n+            user_provided_sig =\n+                match typeck_tables.user_provided_sigs.get(&self.mir_def_id.to_def_id()) {\n+                    None => None,\n+                    Some(user_provided_poly_sig) => {\n+                        // Instantiate the canonicalized variables from\n+                        // user-provided signature (e.g., the `_` in the code\n+                        // above) with fresh variables.\n+                        let (poly_sig, _) =\n+                            self.infcx.instantiate_canonical_with_fresh_inference_vars(\n                                 body.span,\n-                                LateBoundRegionConversionTime::FnCall,\n-                                &poly_sig,\n-                            )\n-                            .0,\n-                    )\n+                                &user_provided_poly_sig,\n+                            );\n+\n+                        // Replace the bound items in the fn sig with fresh\n+                        // variables, so that they represent the view from\n+                        // \"inside\" the closure.\n+                        Some(\n+                            self.infcx\n+                                .replace_bound_vars_with_fresh_vars(\n+                                    body.span,\n+                                    LateBoundRegionConversionTime::FnCall,\n+                                    &poly_sig,\n+                                )\n+                                .0,\n+                        )\n+                    }\n                 }\n-            }\n         };\n \n         debug!(\n@@ -120,7 +122,7 @@ impl<'a, 'tcx> TypeChecker<'a, 'tcx> {\n         if let Err(terr) = self.eq_opaque_type_and_type(\n             mir_output_ty,\n             normalized_output_ty,\n-            self.mir_def_id,\n+            self.mir_def_id.to_def_id(),\n             Locations::All(output_span),\n             ConstraintCategory::BoringNoLocation,\n         ) {\n@@ -143,7 +145,7 @@ impl<'a, 'tcx> TypeChecker<'a, 'tcx> {\n             if let Err(err) = self.eq_opaque_type_and_type(\n                 mir_output_ty,\n                 user_provided_output_ty,\n-                self.mir_def_id,\n+                self.mir_def_id.to_def_id(),\n                 Locations::All(output_span),\n                 ConstraintCategory::BoringNoLocation,\n             ) {"}, {"sha": "9282a0a06b480e3381022ea97b9c87bc8c07c2a0", "filename": "src/librustc_mir/borrow_check/type_check/mod.rs", "status": "modified", "additions": 16, "deletions": 22, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/a32463ade42d12de8da974796fb45a72e57721db/src%2Flibrustc_mir%2Fborrow_check%2Ftype_check%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a32463ade42d12de8da974796fb45a72e57721db/src%2Flibrustc_mir%2Fborrow_check%2Ftype_check%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fborrow_check%2Ftype_check%2Fmod.rs?ref=a32463ade42d12de8da974796fb45a72e57721db", "patch": "@@ -108,26 +108,22 @@ mod relate_tys;\n ///\n /// - `infcx` -- inference context to use\n /// - `param_env` -- parameter environment to use for trait solving\n-/// - `mir` -- MIR to type-check\n-/// - `mir_def_id` -- DefId from which the MIR is derived (must be local)\n-/// - `region_bound_pairs` -- the implied outlives obligations between type parameters\n-///   and lifetimes (e.g., `&'a T` implies `T: 'a`)\n-/// - `implicit_region_bound` -- a region which all generic parameters are assumed\n-///   to outlive; should represent the fn body\n-/// - `input_tys` -- fully liberated, but **not** normalized, expected types of the arguments;\n-///   the types of the input parameters found in the MIR itself will be equated with these\n-/// - `output_ty` -- fully liberated, but **not** normalized, expected return type;\n-///   the type for the RETURN_PLACE will be equated with this\n-/// - `liveness` -- results of a liveness computation on the MIR; used to create liveness\n-///   constraints for the regions in the types of variables\n+/// - `body` -- MIR body to type-check\n+/// - `promoted` -- map of promoted constants within `body`\n+/// - `mir_def_id` -- `LocalDefId` from which the MIR is derived\n+/// - `universal_regions` -- the universal regions from `body`s function signature\n+/// - `location_table` -- MIR location map of `body`\n+/// - `borrow_set` -- information about borrows occurring in `body`\n+/// - `all_facts` -- when using Polonius, this is the generated set of Polonius facts\n /// - `flow_inits` -- results of a maybe-init dataflow analysis\n /// - `move_data` -- move-data constructed when performing the maybe-init dataflow analysis\n+/// - `elements` -- MIR region map\n pub(crate) fn type_check<'mir, 'tcx>(\n     infcx: &InferCtxt<'_, 'tcx>,\n     param_env: ty::ParamEnv<'tcx>,\n     body: &Body<'tcx>,\n     promoted: &IndexVec<Promoted, Body<'tcx>>,\n-    mir_def_id: DefId,\n+    mir_def_id: LocalDefId,\n     universal_regions: &Rc<UniversalRegions<'tcx>>,\n     location_table: &LocationTable,\n     borrow_set: &BorrowSet<'tcx>,\n@@ -191,7 +187,7 @@ pub(crate) fn type_check<'mir, 'tcx>(\n \n fn type_check_internal<'a, 'tcx, R>(\n     infcx: &'a InferCtxt<'a, 'tcx>,\n-    mir_def_id: DefId,\n+    mir_def_id: LocalDefId,\n     param_env: ty::ParamEnv<'tcx>,\n     body: &'a Body<'tcx>,\n     promoted: &'a IndexVec<Promoted, Body<'tcx>>,\n@@ -271,7 +267,7 @@ struct TypeVerifier<'a, 'b, 'tcx> {\n     body: &'b Body<'tcx>,\n     promoted: &'b IndexVec<Promoted, Body<'tcx>>,\n     last_span: Span,\n-    mir_def_id: DefId,\n+    mir_def_id: LocalDefId,\n     errors_reported: bool,\n }\n \n@@ -815,7 +811,7 @@ struct TypeChecker<'a, 'tcx> {\n     /// User type annotations are shared between the main MIR and the MIR of\n     /// all of the promoted items.\n     user_type_annotations: &'a CanonicalUserTypeAnnotations<'tcx>,\n-    mir_def_id: DefId,\n+    mir_def_id: LocalDefId,\n     region_bound_pairs: &'a RegionBoundPairs<'tcx>,\n     implicit_region_bound: ty::Region<'tcx>,\n     reported_errors: FxHashSet<(Ty<'tcx>, Span)>,\n@@ -963,7 +959,7 @@ impl<'a, 'tcx> TypeChecker<'a, 'tcx> {\n     fn new(\n         infcx: &'a InferCtxt<'a, 'tcx>,\n         body: &'a Body<'tcx>,\n-        mir_def_id: DefId,\n+        mir_def_id: LocalDefId,\n         param_env: ty::ParamEnv<'tcx>,\n         region_bound_pairs: &'a RegionBoundPairs<'tcx>,\n         implicit_region_bound: ty::Region<'tcx>,\n@@ -1142,7 +1138,7 @@ impl<'a, 'tcx> TypeChecker<'a, 'tcx> {\n                 // When you have `let x: impl Foo = ...` in a closure,\n                 // the resulting inferend values are stored with the\n                 // def-id of the base function.\n-                let parent_def_id = self.tcx().closure_base_def_id(self.mir_def_id);\n+                let parent_def_id = self.tcx().closure_base_def_id(self.mir_def_id.to_def_id());\n                 return self.eq_opaque_type_and_type(sub, sup, parent_def_id, locations, category);\n             } else {\n                 return Err(terr);\n@@ -1994,7 +1990,7 @@ impl<'a, 'tcx> TypeChecker<'a, 'tcx> {\n                         if !self.infcx.type_is_copy_modulo_regions(self.param_env, ty, span) {\n                             let ccx = ConstCx::new_with_param_env(\n                                 tcx,\n-                                self.mir_def_id.expect_local(),\n+                                self.mir_def_id,\n                                 body,\n                                 self.param_env,\n                             );\n@@ -2010,9 +2006,7 @@ impl<'a, 'tcx> TypeChecker<'a, 'tcx> {\n                                 &traits::Obligation::new(\n                                     ObligationCause::new(\n                                         span,\n-                                        self.tcx()\n-                                            .hir()\n-                                            .local_def_id_to_hir_id(self.mir_def_id.expect_local()),\n+                                        self.tcx().hir().local_def_id_to_hir_id(self.mir_def_id),\n                                         traits::ObligationCauseCode::RepeatVec(should_suggest),\n                                     ),\n                                     self.param_env,"}]}