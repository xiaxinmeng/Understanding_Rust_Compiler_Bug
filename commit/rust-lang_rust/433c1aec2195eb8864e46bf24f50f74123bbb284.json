{"sha": "433c1aec2195eb8864e46bf24f50f74123bbb284", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQzM2MxYWVjMjE5NWViODg2NGU0NmJmMjRmNTBmNzQxMjNiYmIyODQ=", "commit": {"author": {"name": "Fabian Wolff", "email": "fabian.wolff@alumni.ethz.ch", "date": "2021-06-08T15:19:16Z"}, "committer": {"name": "Fabian Wolff", "email": "fabian.wolff@alumni.ethz.ch", "date": "2021-06-08T20:09:35Z"}, "message": "Check whether the closure's owner has a body before deferring to it in thir-unsafeck", "tree": {"sha": "bb6cc5b3cf0a26f0e20d37e501bb66c1e3ae9daf", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bb6cc5b3cf0a26f0e20d37e501bb66c1e3ae9daf"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/433c1aec2195eb8864e46bf24f50f74123bbb284", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/433c1aec2195eb8864e46bf24f50f74123bbb284", "html_url": "https://github.com/rust-lang/rust/commit/433c1aec2195eb8864e46bf24f50f74123bbb284", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/433c1aec2195eb8864e46bf24f50f74123bbb284/comments", "author": {"login": "FabianWolff", "id": 16052130, "node_id": "MDQ6VXNlcjE2MDUyMTMw", "avatar_url": "https://avatars.githubusercontent.com/u/16052130?v=4", "gravatar_id": "", "url": "https://api.github.com/users/FabianWolff", "html_url": "https://github.com/FabianWolff", "followers_url": "https://api.github.com/users/FabianWolff/followers", "following_url": "https://api.github.com/users/FabianWolff/following{/other_user}", "gists_url": "https://api.github.com/users/FabianWolff/gists{/gist_id}", "starred_url": "https://api.github.com/users/FabianWolff/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/FabianWolff/subscriptions", "organizations_url": "https://api.github.com/users/FabianWolff/orgs", "repos_url": "https://api.github.com/users/FabianWolff/repos", "events_url": "https://api.github.com/users/FabianWolff/events{/privacy}", "received_events_url": "https://api.github.com/users/FabianWolff/received_events", "type": "User", "site_admin": false}, "committer": {"login": "FabianWolff", "id": 16052130, "node_id": "MDQ6VXNlcjE2MDUyMTMw", "avatar_url": "https://avatars.githubusercontent.com/u/16052130?v=4", "gravatar_id": "", "url": "https://api.github.com/users/FabianWolff", "html_url": "https://github.com/FabianWolff", "followers_url": "https://api.github.com/users/FabianWolff/followers", "following_url": "https://api.github.com/users/FabianWolff/following{/other_user}", "gists_url": "https://api.github.com/users/FabianWolff/gists{/gist_id}", "starred_url": "https://api.github.com/users/FabianWolff/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/FabianWolff/subscriptions", "organizations_url": "https://api.github.com/users/FabianWolff/orgs", "repos_url": "https://api.github.com/users/FabianWolff/repos", "events_url": "https://api.github.com/users/FabianWolff/events{/privacy}", "received_events_url": "https://api.github.com/users/FabianWolff/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a50d72158e08e02cfc051b863017bdbd2c45b637", "url": "https://api.github.com/repos/rust-lang/rust/commits/a50d72158e08e02cfc051b863017bdbd2c45b637", "html_url": "https://github.com/rust-lang/rust/commit/a50d72158e08e02cfc051b863017bdbd2c45b637"}], "stats": {"total": 31, "additions": 28, "deletions": 3}, "files": [{"sha": "72a55909e155221a10ee8ce01078c0713300963e", "filename": "compiler/rustc_mir_build/src/check_unsafety.rs", "status": "modified", "additions": 8, "deletions": 3, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/433c1aec2195eb8864e46bf24f50f74123bbb284/compiler%2Frustc_mir_build%2Fsrc%2Fcheck_unsafety.rs", "raw_url": "https://github.com/rust-lang/rust/raw/433c1aec2195eb8864e46bf24f50f74123bbb284/compiler%2Frustc_mir_build%2Fsrc%2Fcheck_unsafety.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fcheck_unsafety.rs?ref=433c1aec2195eb8864e46bf24f50f74123bbb284", "patch": "@@ -368,10 +368,15 @@ pub fn check_unsafety<'tcx>(tcx: TyCtxt<'tcx>, def: ty::WithOptConstParam<LocalD\n         return;\n     }\n \n-    // Closures are handled by their parent function\n+    // Closures are handled by their owner, if it has a body\n     if tcx.is_closure(def.did.to_def_id()) {\n-        tcx.ensure().thir_check_unsafety(tcx.hir().local_def_id_to_hir_id(def.did).owner);\n-        return;\n+        let owner = tcx.hir().local_def_id_to_hir_id(def.did).owner;\n+        let owner_hir_id = tcx.hir().local_def_id_to_hir_id(owner);\n+\n+        if tcx.hir().maybe_body_owned_by(owner_hir_id).is_some() {\n+            tcx.ensure().thir_check_unsafety(owner);\n+            return;\n+        }\n     }\n \n     let (thir, expr) = tcx.thir_body(def);"}, {"sha": "aea539b74dffcb514336f3d28f3e0bae2debd335", "filename": "src/test/ui/thir-unsafeck-issue-85871.rs", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/433c1aec2195eb8864e46bf24f50f74123bbb284/src%2Ftest%2Fui%2Fthir-unsafeck-issue-85871.rs", "raw_url": "https://github.com/rust-lang/rust/raw/433c1aec2195eb8864e46bf24f50f74123bbb284/src%2Ftest%2Fui%2Fthir-unsafeck-issue-85871.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fthir-unsafeck-issue-85871.rs?ref=433c1aec2195eb8864e46bf24f50f74123bbb284", "patch": "@@ -0,0 +1,20 @@\n+// Tests that no ICE occurs when a closure appears inside a node\n+// that does not have a body when compiling with\n+// compile-flags: -Zthir-unsafeck=yes\n+// check-pass\n+\n+#![allow(dead_code)]\n+\n+struct Bug {\n+    inner: [(); match || 1 {\n+        _n => 42, // we may not call the closure here (E0015)\n+    }],\n+}\n+\n+enum E {\n+    V([(); { let _ = || 1; 42 }]),\n+}\n+\n+type Ty = [(); { let _ = || 1; 42 }];\n+\n+fn main() {}"}]}