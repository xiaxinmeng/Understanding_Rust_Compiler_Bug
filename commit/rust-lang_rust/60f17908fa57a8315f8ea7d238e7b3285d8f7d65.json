{"sha": "60f17908fa57a8315f8ea7d238e7b3285d8f7d65", "node_id": "C_kwDOAAsO6NoAKDYwZjE3OTA4ZmE1N2E4MzE1ZjhlYTdkMjM4ZTdiMzI4NWQ4ZjdkNjU", "commit": {"author": {"name": "Weihang Lo", "email": "me@weihanglo.tw", "date": "2023-04-19T20:31:43Z"}, "committer": {"name": "Weihang Lo", "email": "me@weihanglo.tw", "date": "2023-04-20T08:27:52Z"}, "message": "linkchecker: running from a directory separate from the book\n\nSince rust-lang/cargo#11851, Cargo became a Cargo workspace of\nitself. However, since `src/tools/linkchecker` cannot run inside\na workspace, Cargo needs a workaround that excludes `src/doc`\nfrom workspace member probing.\n\nTo remove this hack, this PR adds a new optional argument `--path`\nfor `linkchecker.sh`. With this new argument, `linkchecker.sh` can\nbe run from a directory separate from the book. This also benefits\nother projects using linkchecker, as they can run it under target\ndirectory or any other directory, reducing leftover.", "tree": {"sha": "2a24533e89b03f4b6f606ceb0485bdc4a674c166", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2a24533e89b03f4b6f606ceb0485bdc4a674c166"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/60f17908fa57a8315f8ea7d238e7b3285d8f7d65", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEfYTqB0fBJAwqFtKm19vxiYJegucFAmRA97QACgkQ19vxiYJe\ngueurA/9GApliEZhh3SUVe9mXgC2VJzH4IkekSh/5JatjSD9d83Z5axqgdc+xDKo\naiE5RgDwy0BJPMgFQ5B3ky00w6MuSXfYi1WC3CJL261osCRO73sY8gYyn4Xn1rwE\nO6w3Bp6mcUvIn0JcGLtw0Gr6ITENTB+wrQ8g4CL2nQue6UOX8jCFqpy9E/zk+WvU\noECWKJ5NAcd11MQwFhcVkbUkm/uqVl6q/fnfRDy6yHMKjNeGHCi+B7bPNgDavwHu\n6jpwhl4swOVYOdZ3JRPHsqjrVGwpkUiw1GqutQjYnLYJ9ThxmwmoK8laYaOW4QrF\nGx0UMHBZQpLi35rX7nD+ULEIGy/osfU9Bo4dpsnw2MMsDyOLIgzb0GU4SQl/fbmD\nQlhzpHzXKdMGvkcpznEXvpWR2zTF8KqJJpelFIkdiUh1LhERDWFkp4ahSR2NUwhE\nzFEAt0wSGIx5vFdYKnPLVZ0CO4gFL6bzwHsgn3wVnKm7gMeVMLU6V461LkwVV/So\nYiAyDW9H4CvsfsZSf4AO8sKBbIg+aasuHUnQvMrZplNwb++WG38nbU6Gxj8wvcN5\nz/6xR6FhJuM95VWnsud55PkBL/EZW29qU05/Xb3wyMgcBHmU7AONSDPbtQpc2GFx\n3HlQnqeJjfmT8VtxMl9qedE2FyhZEpphlRLCe3XUGRec18nuErw=\n=tRy9\n-----END PGP SIGNATURE-----", "payload": "tree 2a24533e89b03f4b6f606ceb0485bdc4a674c166\nparent 4e463012580415a932ae4fc255aff45982c70369\nauthor Weihang Lo <me@weihanglo.tw> 1681936303 +0100\ncommitter Weihang Lo <me@weihanglo.tw> 1681979272 +0100\n\nlinkchecker: running from a directory separate from the book\n\nSince rust-lang/cargo#11851, Cargo became a Cargo workspace of\nitself. However, since `src/tools/linkchecker` cannot run inside\na workspace, Cargo needs a workaround that excludes `src/doc`\nfrom workspace member probing.\n\nTo remove this hack, this PR adds a new optional argument `--path`\nfor `linkchecker.sh`. With this new argument, `linkchecker.sh` can\nbe run from a directory separate from the book. This also benefits\nother projects using linkchecker, as they can run it under target\ndirectory or any other directory, reducing leftover.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/60f17908fa57a8315f8ea7d238e7b3285d8f7d65", "html_url": "https://github.com/rust-lang/rust/commit/60f17908fa57a8315f8ea7d238e7b3285d8f7d65", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/60f17908fa57a8315f8ea7d238e7b3285d8f7d65/comments", "author": {"login": "weihanglo", "id": 14314532, "node_id": "MDQ6VXNlcjE0MzE0NTMy", "avatar_url": "https://avatars.githubusercontent.com/u/14314532?v=4", "gravatar_id": "", "url": "https://api.github.com/users/weihanglo", "html_url": "https://github.com/weihanglo", "followers_url": "https://api.github.com/users/weihanglo/followers", "following_url": "https://api.github.com/users/weihanglo/following{/other_user}", "gists_url": "https://api.github.com/users/weihanglo/gists{/gist_id}", "starred_url": "https://api.github.com/users/weihanglo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/weihanglo/subscriptions", "organizations_url": "https://api.github.com/users/weihanglo/orgs", "repos_url": "https://api.github.com/users/weihanglo/repos", "events_url": "https://api.github.com/users/weihanglo/events{/privacy}", "received_events_url": "https://api.github.com/users/weihanglo/received_events", "type": "User", "site_admin": false}, "committer": {"login": "weihanglo", "id": 14314532, "node_id": "MDQ6VXNlcjE0MzE0NTMy", "avatar_url": "https://avatars.githubusercontent.com/u/14314532?v=4", "gravatar_id": "", "url": "https://api.github.com/users/weihanglo", "html_url": "https://github.com/weihanglo", "followers_url": "https://api.github.com/users/weihanglo/followers", "following_url": "https://api.github.com/users/weihanglo/following{/other_user}", "gists_url": "https://api.github.com/users/weihanglo/gists{/gist_id}", "starred_url": "https://api.github.com/users/weihanglo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/weihanglo/subscriptions", "organizations_url": "https://api.github.com/users/weihanglo/orgs", "repos_url": "https://api.github.com/users/weihanglo/repos", "events_url": "https://api.github.com/users/weihanglo/events{/privacy}", "received_events_url": "https://api.github.com/users/weihanglo/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4e463012580415a932ae4fc255aff45982c70369", "url": "https://api.github.com/repos/rust-lang/rust/commits/4e463012580415a932ae4fc255aff45982c70369", "html_url": "https://github.com/rust-lang/rust/commit/4e463012580415a932ae4fc255aff45982c70369"}], "stats": {"total": 26, "additions": 18, "deletions": 8}, "files": [{"sha": "6c1e668a7f0d01772a91ddc961b1f1923c78982b", "filename": "src/tools/linkchecker/linkcheck.sh", "status": "modified", "additions": 18, "deletions": 8, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/60f17908fa57a8315f8ea7d238e7b3285d8f7d65/src%2Ftools%2Flinkchecker%2Flinkcheck.sh", "raw_url": "https://github.com/rust-lang/rust/raw/60f17908fa57a8315f8ea7d238e7b3285d8f7d65/src%2Ftools%2Flinkchecker%2Flinkcheck.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Flinkchecker%2Flinkcheck.sh?ref=60f17908fa57a8315f8ea7d238e7b3285d8f7d65", "patch": "@@ -16,15 +16,13 @@\n #\n # --all     Check all books. This can help make sure you don't break links\n #           from other books into your book.\n+#\n+# --path <book-path>\n+#           Path to the root directory for the book. Default to the current\n+#           working directory if omitted.\n \n set -e\n \n-if [ ! -f book.toml ] && [ ! -f src/SUMMARY.md ]\n-then\n-    echo \"Run command in root directory of the book.\"\n-    exit 1\n-fi\n-\n html_dir=\"$(rustc +nightly --print sysroot)/share/doc/rust/html\"\n \n if [ ! -d \"$html_dir\" ]\n@@ -38,6 +36,8 @@ fi\n export MDBOOK_OUTPUT__HTML__INPUT_404=\"\"\n \n book_name=\"\"\n+# Default to the current directory\n+book_path=\".\"\n # Iterative will avoid cleaning up, so you can quickly run it repeatedly.\n iterative=0\n # If \"1\", test all books, else only this book.\n@@ -52,6 +52,10 @@ do\n         --all)\n             all_books=1\n             ;;\n+        --path)\n+            book_path=\"${2:-.}\"\n+            shift\n+            ;;\n         *)\n             if [ -n \"$book_name\" ]\n             then\n@@ -70,6 +74,12 @@ then\n     exit 1\n fi\n \n+if [ ! -f \"$book_path/book.toml\" ] && [ ! -f \"$book_path/src/SUMMARY.md\" ]\n+then\n+    echo \"Run command in root directory of the book or provide a path to the book\"\n+    exit 1\n+fi\n+\n if [ ! -d \"$html_dir/$book_name\" ]\n then\n     echo \"book name \\\"$book_name\\\" not found in sysroot \\\"$html_dir\\\"\"\n@@ -93,11 +103,11 @@ then\n fi\n \n echo \"Building book \\\"$book_name\\\"...\"\n-mdbook build\n+mdbook build \"$book_path\"\n \n cp -R \"$html_dir\" linkcheck\n rm -rf \"linkcheck/$book_name\"\n-cp -R book \"linkcheck/$book_name\"\n+cp -R \"$book_path/book\" \"linkcheck/$book_name\"\n \n if [ \"$all_books\" = \"1\" ]\n then"}]}