{"sha": "c30425dc96895117b644f29b758cee9dac36839b", "node_id": "MDY6Q29tbWl0NzI0NzEyOmMzMDQyNWRjOTY4OTUxMTdiNjQ0ZjI5Yjc1OGNlZTlkYWMzNjgzOWI=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-03-28T11:28:31Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-03-28T11:28:31Z"}, "message": "Merge #3753\n\n3753: Introduce stdx crate r=matklad a=matklad\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>", "tree": {"sha": "d3ccef4aa8f681cc9de29f0435ad20e87911a6ba", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d3ccef4aa8f681cc9de29f0435ad20e87911a6ba"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c30425dc96895117b644f29b758cee9dac36839b", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJefzTfCRBK7hj4Ov3rIwAAdHIIAAbDCjoUDN8bw7vJ7aZq5kdN\nQsxtHeD1ypNQql5IwsdC91+RQmX4jjjSC4MBgI9D8y4QWkPTQJypOWMToH5HAHa1\nxdYJLjN3YQmlwfbnYWfj4q3qo+ql/MGABvZ3Mu9pTH9cYl5c8DzhcAVeG6nJYEzs\nxZZl5+qsQ007LsTSq62/f/s6iYfiORNGjB8rURBHgIT+hxIqGjukCTVqnNeNNUwc\nVPPei+p1W3C8Ie+NBr8AeGklVSUdGZXyama4GFSkESdqn9T5FG3iBx7oRsS66jxK\ntqooTpY8U2NnwSBVIfjvqcpsw4QwF4hzxaGVYBYBomKz/Bn8Y4R8QxESRVp4RzQ=\n=XIad\n-----END PGP SIGNATURE-----\n", "payload": "tree d3ccef4aa8f681cc9de29f0435ad20e87911a6ba\nparent a1fea0d34ee8f3436aefd87d4c133a7ff50ffbb0\nparent 311cbbdad599d51c6f08f7dd72c299f7c0128bb2\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1585394911 +0000\ncommitter GitHub <noreply@github.com> 1585394911 +0000\n\nMerge #3753\n\n3753: Introduce stdx crate r=matklad a=matklad\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c30425dc96895117b644f29b758cee9dac36839b", "html_url": "https://github.com/rust-lang/rust/commit/c30425dc96895117b644f29b758cee9dac36839b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c30425dc96895117b644f29b758cee9dac36839b/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a1fea0d34ee8f3436aefd87d4c133a7ff50ffbb0", "url": "https://api.github.com/repos/rust-lang/rust/commits/a1fea0d34ee8f3436aefd87d4c133a7ff50ffbb0", "html_url": "https://github.com/rust-lang/rust/commit/a1fea0d34ee8f3436aefd87d4c133a7ff50ffbb0"}, {"sha": "311cbbdad599d51c6f08f7dd72c299f7c0128bb2", "url": "https://api.github.com/repos/rust-lang/rust/commits/311cbbdad599d51c6f08f7dd72c299f7c0128bb2", "html_url": "https://github.com/rust-lang/rust/commit/311cbbdad599d51c6f08f7dd72c299f7c0128bb2"}], "stats": {"total": 382, "additions": 229, "deletions": 153}, "files": [{"sha": "8d81c48398a3a0cb20b3ab4213d027d2957ff365", "filename": "Cargo.lock", "status": "modified", "additions": 10, "deletions": 16, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/c30425dc96895117b644f29b758cee9dac36839b/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/c30425dc96895117b644f29b758cee9dac36839b/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=c30425dc96895117b644f29b758cee9dac36839b", "patch": "@@ -353,12 +353,6 @@ version = \"1.0.6\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"2fad85553e09a6f881f739c29f0b00b0f01357c743266d478b68951ce23285f3\"\n \n-[[package]]\n-name = \"format-buf\"\n-version = \"1.0.0\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"f7aea5a5909a74969507051a3b17adc84737e31a5f910559892aedce026f4d53\"\n-\n [[package]]\n name = \"fs_extra\"\n version = \"1.1.0\"\n@@ -573,12 +567,6 @@ version = \"0.1.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"2f52a11f73b88fab829a0e4d9e13ea5982c7ac457c72eb3541d82a4afdfce4ff\"\n \n-[[package]]\n-name = \"join_to_string\"\n-version = \"0.1.3\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"4dc7a5290e8c2606ce2be49f456d50f69173cb96d1541e4f66e34ac8b331a98f\"\n-\n [[package]]\n name = \"kernel32-sys\"\n version = \"0.2.2\"\n@@ -885,9 +873,7 @@ name = \"ra_assists\"\n version = \"0.1.0\"\n dependencies = [\n  \"either\",\n- \"format-buf\",\n  \"itertools 0.9.0\",\n- \"join_to_string\",\n  \"ra_db\",\n  \"ra_fmt\",\n  \"ra_hir\",\n@@ -896,6 +882,7 @@ dependencies = [\n  \"ra_syntax\",\n  \"ra_text_edit\",\n  \"rustc-hash\",\n+ \"stdx\",\n  \"test_utils\",\n ]\n \n@@ -979,6 +966,7 @@ dependencies = [\n  \"ra_syntax\",\n  \"ra_tt\",\n  \"rustc-hash\",\n+ \"stdx\",\n  \"test_utils\",\n ]\n \n@@ -1015,6 +1003,7 @@ dependencies = [\n  \"ra_prof\",\n  \"ra_syntax\",\n  \"rustc-hash\",\n+ \"stdx\",\n  \"test_utils\",\n ]\n \n@@ -1023,11 +1012,9 @@ name = \"ra_ide\"\n version = \"0.1.0\"\n dependencies = [\n  \"either\",\n- \"format-buf\",\n  \"indexmap\",\n  \"insta\",\n  \"itertools 0.9.0\",\n- \"join_to_string\",\n  \"log\",\n  \"ra_assists\",\n  \"ra_cfg\",\n@@ -1040,6 +1027,7 @@ dependencies = [\n  \"ra_text_edit\",\n  \"rand\",\n  \"rustc-hash\",\n+ \"stdx\",\n  \"test_utils\",\n ]\n \n@@ -1130,6 +1118,7 @@ dependencies = [\n  \"rustc_lexer\",\n  \"serde\",\n  \"smol_str\",\n+ \"stdx\",\n  \"test_utils\",\n  \"walkdir\",\n ]\n@@ -1321,6 +1310,7 @@ dependencies = [\n  \"rustc-hash\",\n  \"serde\",\n  \"serde_json\",\n+ \"stdx\",\n  \"tempfile\",\n  \"test_utils\",\n  \"threadpool\",\n@@ -1488,6 +1478,10 @@ dependencies = [\n  \"serde\",\n ]\n \n+[[package]]\n+name = \"stdx\"\n+version = \"0.1.0\"\n+\n [[package]]\n name = \"superslice\"\n version = \"1.0.0\""}, {"sha": "3bcf58ba4b0962a2219d22b3d5d04168a9666bf2", "filename": "crates/ra_assists/Cargo.toml", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fra_assists%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fra_assists%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_assists%2FCargo.toml?ref=c30425dc96895117b644f29b758cee9dac36839b", "patch": "@@ -8,12 +8,12 @@ authors = [\"rust-analyzer developers\"]\n doctest = false\n \n [dependencies]\n-format-buf = \"1.0.0\"\n-join_to_string = \"0.1.3\"\n rustc-hash = \"1.1.0\"\n itertools = \"0.9.0\"\n either = \"1.5.3\"\n \n+stdx = { path = \"../stdx\" }\n+\n ra_syntax = { path = \"../ra_syntax\" }\n ra_text_edit = { path = \"../ra_text_edit\" }\n ra_fmt = { path = \"../ra_fmt\" }"}, {"sha": "15f9b216b647f02bb084be113c2a11849acb75f3", "filename": "crates/ra_assists/src/handlers/add_custom_impl.rs", "status": "modified", "additions": 5, "deletions": 9, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fra_assists%2Fsrc%2Fhandlers%2Fadd_custom_impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fra_assists%2Fsrc%2Fhandlers%2Fadd_custom_impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_assists%2Fsrc%2Fhandlers%2Fadd_custom_impl.rs?ref=c30425dc96895117b644f29b758cee9dac36839b", "patch": "@@ -1,17 +1,13 @@\n-//! FIXME: write short doc here\n-\n-use join_to_string::join;\n use ra_syntax::{\n     ast::{self, AstNode},\n     Direction, SmolStr,\n     SyntaxKind::{IDENT, WHITESPACE},\n     TextRange, TextUnit,\n };\n+use stdx::SepBy;\n \n use crate::{Assist, AssistCtx, AssistId};\n \n-const DERIVE_TRAIT: &str = \"derive\";\n-\n // Assist: add_custom_impl\n //\n // Adds impl block for derived trait.\n@@ -38,7 +34,7 @@ pub(crate) fn add_custom_impl(ctx: AssistCtx) -> Option<Assist> {\n         .descendants_with_tokens()\n         .filter(|t| t.kind() == IDENT)\n         .find_map(|i| i.into_token())\n-        .filter(|t| *t.text() == DERIVE_TRAIT)?\n+        .filter(|t| *t.text() == \"derive\")?\n         .text()\n         .clone();\n \n@@ -63,8 +59,7 @@ pub(crate) fn add_custom_impl(ctx: AssistCtx) -> Option<Assist> {\n             .filter(|t| t != trait_token.text())\n             .collect::<Vec<SmolStr>>();\n         let has_more_derives = !new_attr_input.is_empty();\n-        let new_attr_input =\n-            join(new_attr_input.iter()).separator(\", \").surround_with(\"(\", \")\").to_string();\n+        let new_attr_input = new_attr_input.iter().sep_by(\", \").surround_with(\"(\", \")\").to_string();\n         let new_attr_input_len = new_attr_input.len();\n \n         let mut buf = String::new();\n@@ -100,9 +95,10 @@ pub(crate) fn add_custom_impl(ctx: AssistCtx) -> Option<Assist> {\n \n #[cfg(test)]\n mod tests {\n-    use super::*;\n     use crate::helpers::{check_assist, check_assist_not_applicable};\n \n+    use super::*;\n+\n     #[test]\n     fn add_custom_impl_for_unique_input() {\n         check_assist("}, {"sha": "6622eadb2da1fd9bf2275a57634306306cfbc35c", "filename": "crates/ra_assists/src/handlers/add_impl.rs", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fra_assists%2Fsrc%2Fhandlers%2Fadd_impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fra_assists%2Fsrc%2Fhandlers%2Fadd_impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_assists%2Fsrc%2Fhandlers%2Fadd_impl.rs?ref=c30425dc96895117b644f29b758cee9dac36839b", "patch": "@@ -1,9 +1,8 @@\n-use format_buf::format;\n-use join_to_string::join;\n use ra_syntax::{\n     ast::{self, AstNode, NameOwner, TypeParamsOwner},\n     TextUnit,\n };\n+use stdx::{format_to, SepBy};\n \n use crate::{Assist, AssistCtx, AssistId};\n \n@@ -36,7 +35,7 @@ pub(crate) fn add_impl(ctx: AssistCtx) -> Option<Assist> {\n         let mut buf = String::new();\n         buf.push_str(\"\\n\\nimpl\");\n         if let Some(type_params) = &type_params {\n-            format!(buf, \"{}\", type_params.syntax());\n+            format_to!(buf, \"{}\", type_params.syntax());\n         }\n         buf.push_str(\" \");\n         buf.push_str(name.text().as_str());\n@@ -47,7 +46,9 @@ pub(crate) fn add_impl(ctx: AssistCtx) -> Option<Assist> {\n                 .map(|it| it.text().clone());\n             let type_params =\n                 type_params.type_params().filter_map(|it| it.name()).map(|it| it.text().clone());\n-            join(lifetime_params.chain(type_params)).surround_with(\"<\", \">\").to_buf(&mut buf);\n+\n+            let generic_params = lifetime_params.chain(type_params).sep_by(\", \");\n+            format_to!(buf, \"<{}>\", generic_params)\n         }\n         buf.push_str(\" {\\n\");\n         edit.set_cursor(start_offset + TextUnit::of_str(&buf));"}, {"sha": "240b19fa378c5432c4d2023ddf5e083072f1a863", "filename": "crates/ra_assists/src/handlers/add_new.rs", "status": "modified", "additions": 17, "deletions": 22, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fra_assists%2Fsrc%2Fhandlers%2Fadd_new.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fra_assists%2Fsrc%2Fhandlers%2Fadd_new.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_assists%2Fsrc%2Fhandlers%2Fadd_new.rs?ref=c30425dc96895117b644f29b758cee9dac36839b", "patch": "@@ -1,14 +1,11 @@\n-use std::fmt::Write;\n-\n-use format_buf::format;\n use hir::Adt;\n-use join_to_string::join;\n use ra_syntax::{\n     ast::{\n         self, AstNode, NameOwner, StructKind, TypeAscriptionOwner, TypeParamsOwner, VisibilityOwner,\n     },\n     TextUnit, T,\n };\n+use stdx::{format_to, SepBy};\n \n use crate::{Assist, AssistCtx, AssistId};\n \n@@ -53,24 +50,22 @@ pub(crate) fn add_new(ctx: AssistCtx) -> Option<Assist> {\n             buf.push('\\n');\n         }\n \n-        let vis = strukt.visibility().map(|v| format!(\"{} \", v.syntax()));\n+        let vis = strukt.visibility().map(|v| format!(\"{} \", v));\n         let vis = vis.as_deref().unwrap_or(\"\");\n-        write!(&mut buf, \"    {}fn new(\", vis).unwrap();\n-\n-        join(field_list.fields().filter_map(|f| {\n-            Some(format!(\"{}: {}\", f.name()?.syntax().text(), f.ascribed_type()?.syntax().text()))\n-        }))\n-        .separator(\", \")\n-        .to_buf(&mut buf);\n \n-        buf.push_str(\") -> Self { Self {\");\n-\n-        join(field_list.fields().filter_map(|f| Some(f.name()?.syntax().text())))\n-            .separator(\", \")\n-            .surround_with(\" \", \" \")\n-            .to_buf(&mut buf);\n+        let params = field_list\n+            .fields()\n+            .filter_map(|f| {\n+                Some(format!(\n+                    \"{}: {}\",\n+                    f.name()?.syntax().text(),\n+                    f.ascribed_type()?.syntax().text()\n+                ))\n+            })\n+            .sep_by(\", \");\n+        let fields = field_list.fields().filter_map(|f| f.name()).sep_by(\", \");\n \n-        buf.push_str(\"} }\");\n+        format_to!(buf, \"    {}fn new({}) -> Self {{ Self {{ {} }} }}\", vis, params, fields);\n \n         let (start_offset, end_offset) = impl_def\n             .and_then(|impl_def| {\n@@ -103,7 +98,7 @@ fn generate_impl_text(strukt: &ast::StructDef, code: &str) -> String {\n     let mut buf = String::with_capacity(code.len());\n     buf.push_str(\"\\n\\nimpl\");\n     if let Some(type_params) = &type_params {\n-        format!(buf, \"{}\", type_params.syntax());\n+        format_to!(buf, \"{}\", type_params.syntax());\n     }\n     buf.push_str(\" \");\n     buf.push_str(strukt.name().unwrap().text().as_str());\n@@ -114,10 +109,10 @@ fn generate_impl_text(strukt: &ast::StructDef, code: &str) -> String {\n             .map(|it| it.text().clone());\n         let type_params =\n             type_params.type_params().filter_map(|it| it.name()).map(|it| it.text().clone());\n-        join(lifetime_params.chain(type_params)).surround_with(\"<\", \">\").to_buf(&mut buf);\n+        format_to!(buf, \"<{}>\", lifetime_params.chain(type_params).sep_by(\", \"))\n     }\n \n-    format!(&mut buf, \" {{\\n{}\\n}}\\n\", code);\n+    format_to!(buf, \" {{\\n{}\\n}}\\n\", code);\n \n     buf\n }"}, {"sha": "1edbdc14c74dea5d4a7323876deba3dcd36c90a7", "filename": "crates/ra_assists/src/handlers/introduce_variable.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fra_assists%2Fsrc%2Fhandlers%2Fintroduce_variable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fra_assists%2Fsrc%2Fhandlers%2Fintroduce_variable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_assists%2Fsrc%2Fhandlers%2Fintroduce_variable.rs?ref=c30425dc96895117b644f29b758cee9dac36839b", "patch": "@@ -1,4 +1,3 @@\n-use format_buf::format;\n use ra_syntax::{\n     ast::{self, AstNode},\n     SyntaxKind::{\n@@ -7,6 +6,7 @@ use ra_syntax::{\n     },\n     SyntaxNode, TextUnit,\n };\n+use stdx::format_to;\n use test_utils::tested_by;\n \n use crate::{Assist, AssistCtx, AssistId};\n@@ -52,7 +52,7 @@ pub(crate) fn introduce_variable(ctx: AssistCtx) -> Option<Assist> {\n             buf.push_str(\"let var_name = \");\n             TextUnit::of_str(\"let \")\n         };\n-        format!(buf, \"{}\", expr.syntax());\n+        format_to!(buf, \"{}\", expr.syntax());\n         let full_stmt = ast::ExprStmt::cast(anchor_stmt.clone());\n         let is_full_stmt = if let Some(expr_stmt) = &full_stmt {\n             Some(expr.syntax().clone()) == expr_stmt.expr().map(|e| e.syntax().clone())"}, {"sha": "56e791e3e3ea15e88176ced0a83e680866e6c2de", "filename": "crates/ra_hir_def/Cargo.toml", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fra_hir_def%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fra_hir_def%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_def%2FCargo.toml?ref=c30425dc96895117b644f29b758cee9dac36839b", "patch": "@@ -15,6 +15,8 @@ either = \"1.5.3\"\n anymap = \"0.12.1\"\n drop_bomb = \"0.1.4\"\n \n+stdx = { path = \"../stdx\" }\n+\n ra_arena = { path = \"../ra_arena\" }\n ra_db = { path = \"../ra_db\" }\n ra_syntax = { path = \"../ra_syntax\" }"}, {"sha": "f279c2ad4a9d3b3342d9cf75156f9cabe2f03702", "filename": "crates/ra_hir_def/src/nameres.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fra_hir_def%2Fsrc%2Fnameres.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fra_hir_def%2Fsrc%2Fnameres.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_def%2Fsrc%2Fnameres.rs?ref=c30425dc96895117b644f29b758cee9dac36839b", "patch": "@@ -63,6 +63,7 @@ use ra_db::{CrateId, Edition, FileId};\n use ra_prof::profile;\n use ra_syntax::ast;\n use rustc_hash::FxHashMap;\n+use stdx::format_to;\n \n use crate::{\n     db::DefDatabase,\n@@ -246,7 +247,7 @@ impl CrateDefMap {\n             entries.sort_by_key(|(name, _)| name.clone());\n \n             for (name, def) in entries {\n-                *buf += &format!(\"{}:\", name);\n+                format_to!(buf, \"{}:\", name);\n \n                 if def.types.is_some() {\n                     *buf += \" t\";\n@@ -265,7 +266,7 @@ impl CrateDefMap {\n             }\n \n             for (name, child) in map.modules[module].children.iter() {\n-                let path = path.to_string() + &format!(\"::{}\", name);\n+                let path = &format!(\"{}::{}\", path, name);\n                 go(buf, map, &path, *child);\n             }\n         }"}, {"sha": "5a58d70cf09fda9d44b6286085b6be17a607e8cd", "filename": "crates/ra_hir_ty/Cargo.toml", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fra_hir_ty%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fra_hir_ty%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_ty%2FCargo.toml?ref=c30425dc96895117b644f29b758cee9dac36839b", "patch": "@@ -13,6 +13,8 @@ ena = \"0.13.1\"\n log = \"0.4.8\"\n rustc-hash = \"1.1.0\"\n \n+stdx = { path = \"../stdx\" }\n+\n hir_def = { path = \"../ra_hir_def\", package = \"ra_hir_def\" }\n hir_expand = { path = \"../ra_hir_expand\", package = \"ra_hir_expand\" }\n ra_arena = { path = \"../ra_arena\" }"}, {"sha": "0f8522021e0fabd393b99b1f36427d00f1135fa5", "filename": "crates/ra_hir_ty/src/diagnostics.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fra_hir_ty%2Fsrc%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fra_hir_ty%2Fsrc%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_ty%2Fsrc%2Fdiagnostics.rs?ref=c30425dc96895117b644f29b758cee9dac36839b", "patch": "@@ -4,6 +4,7 @@ use std::any::Any;\n \n use hir_expand::{db::AstDatabase, name::Name, HirFileId, InFile};\n use ra_syntax::{ast, AstNode, AstPtr, SyntaxNodePtr};\n+use stdx::format_to;\n \n pub use hir_def::diagnostics::UnresolvedModule;\n pub use hir_expand::diagnostics::{AstDiagnostic, Diagnostic, DiagnosticSink};\n@@ -37,12 +38,11 @@ pub struct MissingFields {\n \n impl Diagnostic for MissingFields {\n     fn message(&self) -> String {\n-        use std::fmt::Write;\n-        let mut message = String::from(\"Missing structure fields:\\n\");\n+        let mut buf = String::from(\"Missing structure fields:\\n\");\n         for field in &self.missed_fields {\n-            writeln!(message, \"- {}\", field).unwrap();\n+            format_to!(buf, \"- {}\", field);\n         }\n-        message\n+        buf\n     }\n     fn source(&self) -> InFile<SyntaxNodePtr> {\n         InFile { file_id: self.file, value: self.field_list.into() }"}, {"sha": "208096aab6d1df153a8b3e7c50a029cc147eb467", "filename": "crates/ra_hir_ty/src/test_db.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fra_hir_ty%2Fsrc%2Ftest_db.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fra_hir_ty%2Fsrc%2Ftest_db.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_ty%2Fsrc%2Ftest_db.rs?ref=c30425dc96895117b644f29b758cee9dac36839b", "patch": "@@ -10,6 +10,7 @@ use hir_expand::{db::AstDatabase, diagnostics::DiagnosticSink};\n use ra_db::{\n     salsa, CrateId, FileId, FileLoader, FileLoaderDelegate, RelativePath, SourceDatabase, Upcast,\n };\n+use stdx::format_to;\n \n use crate::{db::HirDatabase, expr::ExprValidator};\n \n@@ -131,7 +132,7 @@ impl TestDB {\n             for f in fns {\n                 let infer = self.infer(f.into());\n                 let mut sink = DiagnosticSink::new(|d| {\n-                    buf += &format!(\"{:?}: {}\\n\", d.syntax_node(self).text(), d.message());\n+                    format_to!(buf, \"{:?}: {}\\n\", d.syntax_node(self).text(), d.message());\n                 });\n                 infer.add_diagnostics(self, f, &mut sink);\n                 let mut validator = ExprValidator::new(f, infer, &mut sink);"}, {"sha": "027e5a8f88a09b9ff60deaf413d25a317da1edc7", "filename": "crates/ra_hir_ty/src/tests.rs", "status": "modified", "additions": 12, "deletions": 14, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fra_hir_ty%2Fsrc%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fra_hir_ty%2Fsrc%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_ty%2Fsrc%2Ftests.rs?ref=c30425dc96895117b644f29b758cee9dac36839b", "patch": "@@ -7,7 +7,6 @@ mod traits;\n mod method_resolution;\n mod macros;\n \n-use std::fmt::Write;\n use std::sync::Arc;\n \n use hir_def::{\n@@ -26,6 +25,7 @@ use ra_syntax::{\n     algo,\n     ast::{self, AstNode},\n };\n+use stdx::format_to;\n \n use crate::{db::HirDatabase, display::HirDisplay, test_db::TestDB, InferenceResult};\n \n@@ -63,7 +63,7 @@ fn infer(ra_fixture: &str) -> String {\n fn infer_with_mismatches(content: &str, include_mismatches: bool) -> String {\n     let (db, file_id) = TestDB::with_single_file(content);\n \n-    let mut acc = String::new();\n+    let mut buf = String::new();\n \n     let mut infer_def = |inference_result: Arc<InferenceResult>,\n                          body_source_map: Arc<BodySourceMap>| {\n@@ -106,15 +106,14 @@ fn infer_with_mismatches(content: &str, include_mismatches: bool) -> String {\n                 (src_ptr.value.range(), node.text().to_string().replace(\"\\n\", \" \"))\n             };\n             let macro_prefix = if src_ptr.file_id != file_id.into() { \"!\" } else { \"\" };\n-            writeln!(\n-                acc,\n-                \"{}{} '{}': {}\",\n+            format_to!(\n+                buf,\n+                \"{}{} '{}': {}\\n\",\n                 macro_prefix,\n                 range,\n                 ellipsize(text, 15),\n                 ty.display(&db)\n-            )\n-            .unwrap();\n+            );\n         }\n         if include_mismatches {\n             mismatches.sort_by_key(|(src_ptr, _)| {\n@@ -123,15 +122,14 @@ fn infer_with_mismatches(content: &str, include_mismatches: bool) -> String {\n             for (src_ptr, mismatch) in &mismatches {\n                 let range = src_ptr.value.range();\n                 let macro_prefix = if src_ptr.file_id != file_id.into() { \"!\" } else { \"\" };\n-                writeln!(\n-                    acc,\n-                    \"{}{}: expected {}, got {}\",\n+                format_to!(\n+                    buf,\n+                    \"{}{}: expected {}, got {}\\n\",\n                     macro_prefix,\n                     range,\n                     mismatch.expected.display(&db),\n                     mismatch.actual.display(&db),\n-                )\n-                .unwrap();\n+                );\n             }\n         }\n     };\n@@ -158,8 +156,8 @@ fn infer_with_mismatches(content: &str, include_mismatches: bool) -> String {\n         infer_def(infer, source_map);\n     }\n \n-    acc.truncate(acc.trim_end().len());\n-    acc\n+    buf.truncate(buf.trim_end().len());\n+    buf\n }\n \n fn visit_module("}, {"sha": "b4a29b81b320d554b584ca29452264a50ffb0b65", "filename": "crates/ra_ide/Cargo.toml", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fra_ide%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fra_ide%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2FCargo.toml?ref=c30425dc96895117b644f29b758cee9dac36839b", "patch": "@@ -12,14 +12,14 @@ wasm = []\n \n [dependencies]\n either = \"1.5.3\"\n-format-buf = \"1.0.0\"\n indexmap = \"1.3.2\"\n itertools = \"0.9.0\"\n-join_to_string = \"0.1.3\"\n log = \"0.4.8\"\n rustc-hash = \"1.1.0\"\n rand = { version = \"0.7.3\", features = [\"small_rng\"] }\n \n+stdx = { path = \"../stdx\" }\n+\n ra_syntax = { path = \"../ra_syntax\" }\n ra_text_edit = { path = \"../ra_text_edit\" }\n ra_db = { path = \"../ra_db\" }"}, {"sha": "60f1b83f33e69713da48b23f756c3afbea6dbe0d", "filename": "crates/ra_ide/src/completion/presentation.rs", "status": "modified", "additions": 21, "deletions": 24, "changes": 45, "blob_url": "https://github.com/rust-lang/rust/blob/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fpresentation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fpresentation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fpresentation.rs?ref=c30425dc96895117b644f29b758cee9dac36839b", "patch": "@@ -1,15 +1,14 @@\n //! This modules takes care of rendering various definitions as completion items.\n \n use hir::{Docs, HasAttrs, HasSource, HirDisplay, ScopeDef, StructKind, Type};\n-use join_to_string::join;\n use ra_syntax::ast::NameOwner;\n+use stdx::SepBy;\n use test_utils::tested_by;\n \n-use crate::completion::{\n-    CompletionContext, CompletionItem, CompletionItemKind, CompletionKind, Completions,\n-};\n-\n use crate::{\n+    completion::{\n+        CompletionContext, CompletionItem, CompletionItemKind, CompletionKind, Completions,\n+    },\n     display::{const_label, macro_label, type_label, FunctionSignature},\n     RootDatabase,\n };\n@@ -221,13 +220,13 @@ impl Completions {\n                 builder = builder.trigger_call_info();\n                 let snippet = if ctx.options.add_call_argument_snippets {\n                     let to_skip = if has_self_param { 1 } else { 0 };\n-                    let function_params_snippet = join(\n-                        function_signature.parameter_names.iter().skip(to_skip).enumerate().map(\n-                            |(index, param_name)| format!(\"${{{}:{}}}\", index + 1, param_name),\n-                        ),\n-                    )\n-                    .separator(\", \")\n-                    .to_string();\n+                    let function_params_snippet = function_signature\n+                        .parameter_names\n+                        .iter()\n+                        .skip(to_skip)\n+                        .enumerate()\n+                        .map(|(index, param_name)| format!(\"${{{}:{}}}\", index + 1, param_name))\n+                        .sep_by(\", \");\n                     format!(\"{}({})$0\", name, function_params_snippet)\n                 } else {\n                     format!(\"{}($0)\", name)\n@@ -281,18 +280,16 @@ impl Completions {\n             .into_iter()\n             .map(|field| (field.name(ctx.db), field.signature_ty(ctx.db)));\n         let detail = match variant.kind(ctx.db) {\n-            StructKind::Tuple | StructKind::Unit => {\n-                join(detail_types.map(|(_, t)| t.display(ctx.db).to_string()))\n-                    .separator(\", \")\n-                    .surround_with(\"(\", \")\")\n-                    .to_string()\n-            }\n-            StructKind::Record => {\n-                join(detail_types.map(|(n, t)| format!(\"{}: {}\", n, t.display(ctx.db).to_string())))\n-                    .separator(\", \")\n-                    .surround_with(\"{ \", \" }\")\n-                    .to_string()\n-            }\n+            StructKind::Tuple | StructKind::Unit => detail_types\n+                .map(|(_, t)| t.display(ctx.db).to_string())\n+                .sep_by(\", \")\n+                .surround_with(\"(\", \")\")\n+                .to_string(),\n+            StructKind::Record => detail_types\n+                .map(|(n, t)| format!(\"{}: {}\", n, t.display(ctx.db).to_string()))\n+                .sep_by(\", \")\n+                .surround_with(\"{ \", \" }\")\n+                .to_string(),\n         };\n         CompletionItem::new(CompletionKind::Reference, ctx.source_range(), name.to_string())\n             .kind(CompletionItemKind::EnumVariant)"}, {"sha": "c1d7ddaf2343c4da1ca4def1df7d3b3f87814a29", "filename": "crates/ra_ide/src/diagnostics.rs", "status": "modified", "additions": 7, "deletions": 11, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fra_ide%2Fsrc%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fra_ide%2Fsrc%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fdiagnostics.rs?ref=c30425dc96895117b644f29b758cee9dac36839b", "patch": "@@ -200,8 +200,8 @@ fn check_struct_shorthand_initialization(\n #[cfg(test)]\n mod tests {\n     use insta::assert_debug_snapshot;\n-    use join_to_string::join;\n     use ra_syntax::SourceFile;\n+    use stdx::SepBy;\n     use test_utils::assert_eq_text;\n \n     use crate::mock_analysis::{analysis_and_position, single_file};\n@@ -254,16 +254,12 @@ mod tests {\n             .map(|it| it.len() - it.trim_start().len())\n             .next()\n             .expect(\"empty fixture\");\n-        let after = join(after.lines().filter_map(|line| {\n-            if line.len() > margin {\n-                Some(&line[margin..])\n-            } else {\n-                None\n-            }\n-        }))\n-        .separator(\"\\n\")\n-        .suffix(\"\\n\")\n-        .to_string();\n+        let after = after\n+            .lines()\n+            .filter_map(|line| if line.len() > margin { Some(&line[margin..]) } else { None })\n+            .sep_by(\"\\n\")\n+            .suffix(\"\\n\")\n+            .to_string();\n \n         assert_eq_text!(&after, &actual);\n         assert!("}, {"sha": "722092de97d8380aaa1101d3359649fcbb87280f", "filename": "crates/ra_ide/src/display.rs", "status": "modified", "additions": 7, "deletions": 6, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fra_ide%2Fsrc%2Fdisplay.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fra_ide%2Fsrc%2Fdisplay.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fdisplay.rs?ref=c30425dc96895117b644f29b758cee9dac36839b", "patch": "@@ -6,12 +6,13 @@ mod navigation_target;\n mod structure;\n mod short_label;\n \n-use std::fmt::{Display, Write};\n+use std::fmt::Display;\n \n use ra_syntax::{\n     ast::{self, AstNode, AttrsOwner, NameOwner, TypeParamsOwner},\n     SyntaxKind::{ATTR, COMMENT},\n };\n+use stdx::format_to;\n \n pub use function_signature::FunctionSignature;\n pub use navigation_target::NavigationTarget;\n@@ -78,18 +79,18 @@ pub(crate) fn rust_code_markup_with_doc(\n     doc: Option<&str>,\n     mod_path: Option<&str>,\n ) -> String {\n-    let mut markup = \"```rust\\n\".to_owned();\n+    let mut buf = \"```rust\\n\".to_owned();\n \n     if let Some(mod_path) = mod_path {\n         if !mod_path.is_empty() {\n-            write!(markup, \"{}\\n\", mod_path).unwrap();\n+            format_to!(buf, \"{}\\n\", mod_path);\n         }\n     }\n-    write!(markup, \"{}\\n```\", code).unwrap();\n+    format_to!(buf, \"{}\\n```\", code);\n \n     if let Some(doc) = doc {\n-        write!(markup, \"\\n\\n{}\", doc).unwrap();\n+        format_to!(buf, \"\\n\\n{}\", doc);\n     }\n \n-    markup\n+    buf\n }"}, {"sha": "b967a6816804101037d8b45e98075156f8bf5bc4", "filename": "crates/ra_ide/src/display/function_signature.rs", "status": "modified", "additions": 8, "deletions": 10, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fra_ide%2Fsrc%2Fdisplay%2Ffunction_signature.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fra_ide%2Fsrc%2Fdisplay%2Ffunction_signature.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fdisplay%2Ffunction_signature.rs?ref=c30425dc96895117b644f29b758cee9dac36839b", "patch": "@@ -1,12 +1,14 @@\n //! FIXME: write short doc here\n \n-use std::fmt::{self, Display};\n+use std::{\n+    convert::From,\n+    fmt::{self, Display},\n+};\n \n use hir::{Docs, Documentation, HasSource, HirDisplay};\n-use join_to_string::join;\n use ra_ide_db::RootDatabase;\n use ra_syntax::ast::{self, AstNode, NameOwner, VisibilityOwner};\n-use std::convert::From;\n+use stdx::SepBy;\n \n use crate::display::{generic_parameters, where_predicates};\n \n@@ -227,21 +229,17 @@ impl Display for FunctionSignature {\n         }\n \n         if !self.generic_parameters.is_empty() {\n-            join(self.generic_parameters.iter())\n-                .separator(\", \")\n-                .surround_with(\"<\", \">\")\n-                .to_fmt(f)?;\n+            write!(f, \"{}\", self.generic_parameters.iter().sep_by(\", \").surround_with(\"<\", \">\"))?;\n         }\n \n-        join(self.parameters.iter()).separator(\", \").surround_with(\"(\", \")\").to_fmt(f)?;\n+        write!(f, \"{}\", self.parameters.iter().sep_by(\", \").surround_with(\"(\", \")\"))?;\n \n         if let Some(t) = &self.ret_type {\n             write!(f, \" -> {}\", t)?;\n         }\n \n         if !self.where_predicates.is_empty() {\n-            write!(f, \"\\nwhere \")?;\n-            join(self.where_predicates.iter()).separator(\",\\n      \").to_fmt(f)?;\n+            write!(f, \"\\nwhere {}\", self.where_predicates.iter().sep_by(\",\\n      \"))?;\n         }\n \n         Ok(())"}, {"sha": "4b081bf6c60634cde74f46ddf01060471ae6eb08", "filename": "crates/ra_ide/src/display/short_label.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fra_ide%2Fsrc%2Fdisplay%2Fshort_label.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fra_ide%2Fsrc%2Fdisplay%2Fshort_label.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fdisplay%2Fshort_label.rs?ref=c30425dc96895117b644f29b758cee9dac36839b", "patch": "@@ -1,7 +1,7 @@\n //! FIXME: write short doc here\n \n-use format_buf::format;\n use ra_syntax::ast::{self, AstNode, NameOwner, TypeAscriptionOwner, VisibilityOwner};\n+use stdx::format_to;\n \n pub(crate) trait ShortLabel {\n     fn short_label(&self) -> Option<String>;\n@@ -80,7 +80,7 @@ where\n     let mut buf = short_label_from_node(node, prefix)?;\n \n     if let Some(type_ref) = node.ascribed_type() {\n-        format!(buf, \": {}\", type_ref.syntax());\n+        format_to!(buf, \": {}\", type_ref.syntax());\n     }\n \n     Some(buf)"}, {"sha": "3c6ae77e462e58a7a0ebb7ce812af2e8513f2507", "filename": "crates/ra_syntax/Cargo.toml", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fra_syntax%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fra_syntax%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_syntax%2FCargo.toml?ref=c30425dc96895117b644f29b758cee9dac36839b", "patch": "@@ -18,6 +18,8 @@ rustc-hash = \"1.1.0\"\n arrayvec = \"0.5.1\"\n once_cell = \"1.3.1\"\n \n+stdx = { path = \"../stdx\" }\n+\n ra_text_edit = { path = \"../ra_text_edit\" }\n ra_parser = { path = \"../ra_parser\" }\n "}, {"sha": "0c908573d90a54b497a09c49d08ffffe2b7e01fd", "filename": "crates/ra_syntax/src/ast/make.rs", "status": "modified", "additions": 8, "deletions": 7, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fra_syntax%2Fsrc%2Fast%2Fmake.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fra_syntax%2Fsrc%2Fast%2Fmake.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_syntax%2Fsrc%2Fast%2Fmake.rs?ref=c30425dc96895117b644f29b758cee9dac36839b", "patch": "@@ -1,6 +1,7 @@\n //! This module contains free-standing functions for creating AST fragments out\n //! of smaller pieces.\n use itertools::Itertools;\n+use stdx::format_to;\n \n use crate::{ast, AstNode, SourceFile, SyntaxKind, SyntaxNode, SyntaxToken};\n \n@@ -34,14 +35,14 @@ pub fn use_tree(\n     let mut buf = \"use \".to_string();\n     buf += &path.syntax().to_string();\n     if let Some(use_tree_list) = use_tree_list {\n-        buf += &format!(\"::{}\", use_tree_list);\n+        format_to!(buf, \"::{}\", use_tree_list);\n     }\n     if add_star {\n         buf += \"::*\";\n     }\n \n     if let Some(alias) = alias {\n-        buf += &format!(\" {}\", alias);\n+        format_to!(buf, \" {}\", alias);\n     }\n     ast_from_text(&buf)\n }\n@@ -70,15 +71,15 @@ pub fn block_expr(\n     stmts: impl IntoIterator<Item = ast::Stmt>,\n     tail_expr: Option<ast::Expr>,\n ) -> ast::BlockExpr {\n-    let mut text = \"{\\n\".to_string();\n+    let mut buf = \"{\\n\".to_string();\n     for stmt in stmts.into_iter() {\n-        text += &format!(\"    {}\\n\", stmt);\n+        format_to!(buf, \"    {}\\n\", stmt);\n     }\n     if let Some(tail_expr) = tail_expr {\n-        text += &format!(\"    {}\\n\", tail_expr)\n+        format_to!(buf, \"    {}\\n\", tail_expr)\n     }\n-    text += \"}\";\n-    ast_from_text(&format!(\"fn f() {}\", text))\n+    buf += \"}\";\n+    ast_from_text(&format!(\"fn f() {}\", buf))\n }\n \n pub fn block_from_expr(e: ast::Expr) -> ast::Block {"}, {"sha": "f0e16dc2bff010e524db43e4316a18a2b8d39b25", "filename": "crates/ra_syntax/src/lib.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fra_syntax%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fra_syntax%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_syntax%2Fsrc%2Flib.rs?ref=c30425dc96895117b644f29b758cee9dac36839b", "patch": "@@ -32,9 +32,10 @@ pub mod ast;\n #[doc(hidden)]\n pub mod fuzz;\n \n-use std::{fmt::Write, marker::PhantomData, sync::Arc};\n+use std::{marker::PhantomData, sync::Arc};\n \n use ra_text_edit::AtomTextEdit;\n+use stdx::format_to;\n \n use crate::syntax_node::GreenNode;\n \n@@ -115,7 +116,7 @@ impl Parse<SourceFile> {\n     pub fn debug_dump(&self) -> String {\n         let mut buf = format!(\"{:#?}\", self.tree().syntax());\n         for err in self.errors.iter() {\n-            writeln!(buf, \"error {:?}: {}\", err.range(), err).unwrap();\n+            format_to!(buf, \"error {:?}: {}\\n\", err.range(), err);\n         }\n         buf\n     }\n@@ -296,7 +297,7 @@ fn api_walkthrough() {\n                     NodeOrToken::Node(it) => it.text().to_string(),\n                     NodeOrToken::Token(it) => it.text().to_string(),\n                 };\n-                buf += &format!(\"{:indent$}{:?} {:?}\\n\", \" \", text, node.kind(), indent = indent);\n+                format_to!(buf, \"{:indent$}{:?} {:?}\\n\", \" \", text, node.kind(), indent = indent);\n                 indent += 2;\n             }\n             WalkEvent::Leave(_) => indent -= 2,"}, {"sha": "8fe6799d23a9dae042044e7829f61c4d8c589cf0", "filename": "crates/rust-analyzer/Cargo.toml", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/c30425dc96895117b644f29b758cee9dac36839b/crates%2Frust-analyzer%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/c30425dc96895117b644f29b758cee9dac36839b/crates%2Frust-analyzer%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2FCargo.toml?ref=c30425dc96895117b644f29b758cee9dac36839b", "patch": "@@ -30,6 +30,8 @@ serde = { version = \"1.0.104\", features = [\"derive\"] }\n serde_json = \"1.0.48\"\n threadpool = \"1.7.1\"\n \n+stdx = { path = \"../stdx\" }\n+\n lsp-server = \"0.3.1\"\n ra_cargo_watch = { path = \"../ra_cargo_watch\" }\n ra_ide = { path = \"../ra_ide\" }"}, {"sha": "75cf2dae50d6049e8da0089f59a501fc73169ca6", "filename": "crates/rust-analyzer/src/cli/analysis_stats.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/c30425dc96895117b644f29b758cee9dac36839b/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fanalysis_stats.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c30425dc96895117b644f29b758cee9dac36839b/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fanalysis_stats.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fanalysis_stats.rs?ref=c30425dc96895117b644f29b758cee9dac36839b", "patch": "@@ -1,7 +1,7 @@\n //! Fully type-check project and print various stats, like the number of type\n //! errors.\n \n-use std::{collections::HashSet, fmt::Write, path::Path, time::Instant};\n+use std::{collections::HashSet, path::Path, time::Instant};\n \n use hir::{\n     db::{AstDatabase, DefDatabase, HirDatabase},\n@@ -13,6 +13,7 @@ use itertools::Itertools;\n use ra_db::SourceDatabaseExt;\n use ra_syntax::AstNode;\n use rand::{seq::SliceRandom, thread_rng};\n+use stdx::format_to;\n \n use crate::cli::{load_cargo::load_cargo, progress_report::ProgressReport, Result, Verbosity};\n \n@@ -128,7 +129,7 @@ pub fn analysis_stats(\n             let original_file = src.file_id.original_file(db);\n             let path = db.file_relative_path(original_file);\n             let syntax_range = src.value.syntax().text_range();\n-            write!(msg, \" ({:?} {})\", path, syntax_range).unwrap();\n+            format_to!(msg, \" ({:?} {})\", path, syntax_range);\n         }\n         if verbosity.is_spammy() {\n             bar.println(msg.to_string());"}, {"sha": "12f8ca2976d82eec0a43480ce24da87f745debef", "filename": "crates/rust-analyzer/src/main_loop/handlers.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/c30425dc96895117b644f29b758cee9dac36839b/crates%2Frust-analyzer%2Fsrc%2Fmain_loop%2Fhandlers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c30425dc96895117b644f29b758cee9dac36839b/crates%2Frust-analyzer%2Fsrc%2Fmain_loop%2Fhandlers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fmain_loop%2Fhandlers.rs?ref=c30425dc96895117b644f29b758cee9dac36839b", "patch": "@@ -3,7 +3,6 @@\n //! `ra_ide` crate.\n \n use std::{\n-    fmt::Write as _,\n     io::Write as _,\n     process::{self, Stdio},\n };\n@@ -28,6 +27,7 @@ use ra_syntax::{AstNode, SyntaxKind, TextRange, TextUnit};\n use rustc_hash::FxHashMap;\n use serde::{Deserialize, Serialize};\n use serde_json::to_value;\n+use stdx::format_to;\n \n use crate::{\n     cargo_target_spec::CargoTargetSpec,\n@@ -46,11 +46,11 @@ use crate::{\n pub fn handle_analyzer_status(world: WorldSnapshot, _: ()) -> Result<String> {\n     let _p = profile(\"handle_analyzer_status\");\n     let mut buf = world.status();\n-    writeln!(buf, \"\\n\\nrequests:\").unwrap();\n+    format_to!(buf, \"\\n\\nrequests:\");\n     let requests = world.latest_requests.read();\n     for (is_last, r) in requests.iter() {\n         let mark = if is_last { \"*\" } else { \" \" };\n-        writeln!(buf, \"{}{:4} {:<36}{}ms\", mark, r.id, r.method, r.duration.as_millis()).unwrap();\n+        format_to!(buf, \"{}{:4} {:<36}{}ms\", mark, r.id, r.method, r.duration.as_millis());\n     }\n     Ok(buf)\n }"}, {"sha": "64a7b907edc55a62d34f04b648c204599aa1cd50", "filename": "crates/rust-analyzer/src/world.rs", "status": "modified", "additions": 8, "deletions": 7, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/c30425dc96895117b644f29b758cee9dac36839b/crates%2Frust-analyzer%2Fsrc%2Fworld.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c30425dc96895117b644f29b758cee9dac36839b/crates%2Frust-analyzer%2Fsrc%2Fworld.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fworld.rs?ref=c30425dc96895117b644f29b758cee9dac36839b", "patch": "@@ -19,6 +19,7 @@ use ra_ide::{\n use ra_project_model::{get_rustc_cfg_options, ProcMacroClient, ProjectWorkspace};\n use ra_vfs::{LineEndings, RootEntry, Vfs, VfsChange, VfsFile, VfsRoot, VfsTask, Watch};\n use relative_path::RelativePathBuf;\n+use stdx::format_to;\n \n use crate::{\n     diagnostics::{CheckFixes, DiagnosticCollection},\n@@ -319,23 +320,23 @@ impl WorldSnapshot {\n     }\n \n     pub fn status(&self) -> String {\n-        let mut res = String::new();\n+        let mut buf = String::new();\n         if self.workspaces.is_empty() {\n-            res.push_str(\"no workspaces\\n\")\n+            buf.push_str(\"no workspaces\\n\")\n         } else {\n-            res.push_str(\"workspaces:\\n\");\n+            buf.push_str(\"workspaces:\\n\");\n             for w in self.workspaces.iter() {\n-                res += &format!(\"{} packages loaded\\n\", w.n_packages());\n+                format_to!(buf, \"{} packages loaded\\n\", w.n_packages());\n             }\n         }\n-        res.push_str(\"\\nanalysis:\\n\");\n-        res.push_str(\n+        buf.push_str(\"\\nanalysis:\\n\");\n+        buf.push_str(\n             &self\n                 .analysis\n                 .status()\n                 .unwrap_or_else(|_| \"Analysis retrieval was cancelled\".to_owned()),\n         );\n-        res\n+        buf\n     }\n \n     pub fn workspace_root_for(&self, file_id: FileId) -> Option<&Path> {"}, {"sha": "f9e380c105dccf13b42282721c75a2b8c98b49fa", "filename": "crates/stdx/Cargo.toml", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fstdx%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fstdx%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fstdx%2FCargo.toml?ref=c30425dc96895117b644f29b758cee9dac36839b", "patch": "@@ -0,0 +1,11 @@\n+[package]\n+name = \"stdx\"\n+version = \"0.1.0\"\n+authors = [\"rust-analyzer developers\"]\n+edition = \"2018\"\n+\n+[lib]\n+doctest = false\n+\n+[dependencies]\n+# Think twice before adding anything here"}, {"sha": "8492c17af2f2f93b9bfcd9c6118002878cd1f9f5", "filename": "crates/stdx/src/lib.rs", "status": "added", "additions": 75, "deletions": 0, "changes": 75, "blob_url": "https://github.com/rust-lang/rust/blob/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fstdx%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c30425dc96895117b644f29b758cee9dac36839b/crates%2Fstdx%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fstdx%2Fsrc%2Flib.rs?ref=c30425dc96895117b644f29b758cee9dac36839b", "patch": "@@ -0,0 +1,75 @@\n+//! Missing batteries for standard libraries.\n+\n+use std::{cell::Cell, fmt};\n+\n+/// Appends formatted string to a `String`.\n+#[macro_export]\n+macro_rules! format_to {\n+    (&buf:expr) => ();\n+    ($buf:expr, $lit:literal $($arg:tt)*) => {\n+        { use ::std::fmt::Write as _; let _ = ::std::write!($buf, $lit $($arg)*); }\n+    };\n+}\n+\n+pub trait SepBy: Sized {\n+    /// Returns an `impl fmt::Display`, which joins elements via a separator.\n+    fn sep_by<'a>(self, sep: &'a str) -> SepByBuilder<'a, Self>;\n+}\n+\n+impl<I> SepBy for I\n+where\n+    I: Iterator,\n+    I::Item: fmt::Display,\n+{\n+    fn sep_by<'a>(self, sep: &'a str) -> SepByBuilder<'a, Self> {\n+        SepByBuilder::new(sep, self)\n+    }\n+}\n+\n+pub struct SepByBuilder<'a, I> {\n+    sep: &'a str,\n+    prefix: &'a str,\n+    suffix: &'a str,\n+    iter: Cell<Option<I>>,\n+}\n+\n+impl<'a, I> SepByBuilder<'a, I> {\n+    fn new(sep: &'a str, iter: I) -> SepByBuilder<'a, I> {\n+        SepByBuilder { sep, prefix: \"\", suffix: \"\", iter: Cell::new(Some(iter)) }\n+    }\n+\n+    pub fn prefix(mut self, prefix: &'a str) -> Self {\n+        self.prefix = prefix;\n+        self\n+    }\n+\n+    pub fn suffix(mut self, suffix: &'a str) -> Self {\n+        self.suffix = suffix;\n+        self\n+    }\n+\n+    /// Set both suffix and prefix.\n+    pub fn surround_with(self, prefix: &'a str, suffix: &'a str) -> Self {\n+        self.prefix(prefix).suffix(suffix)\n+    }\n+}\n+\n+impl<I> fmt::Display for SepByBuilder<'_, I>\n+where\n+    I: Iterator,\n+    I::Item: fmt::Display,\n+{\n+    fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {\n+        f.write_str(self.prefix)?;\n+        let mut first = true;\n+        for item in self.iter.take().unwrap() {\n+            if !first {\n+                f.write_str(self.sep)?;\n+            }\n+            first = false;\n+            fmt::Display::fmt(&item, f)?;\n+        }\n+        f.write_str(self.suffix)?;\n+        Ok(())\n+    }\n+}"}]}