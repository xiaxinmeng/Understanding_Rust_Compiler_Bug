{"sha": "2b6e38cb71c8c60c314e042f4d8ee367c82a6fae", "node_id": "C_kwDOAAsO6NoAKDJiNmUzOGNiNzFjOGM2MGMzMTRlMDQyZjRkOGVlMzY3YzgyYTZmYWU", "commit": {"author": {"name": "Dylan DPC", "email": "99973273+Dylan-DPC@users.noreply.github.com", "date": "2023-01-06T06:08:56Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-01-06T06:08:56Z"}, "message": "Rollup merge of #106491 - ehuss:error-index-redirect, r=GuillaumeGomez,notriddle\n\nFix error-index redirect to work with the back button.\n\nThis fixes the redirect page at https://doc.rust-lang.org/error-index.html so that it works with the browser's back-button. The solution is to use `window.location.replace()`, which avoids adding the page to the browser history stack.\n\nThis also cleans up the code a little bit, since it looks like it was written with different assumptions (maybe before f5857d5c5e1d2fde302f330d11c5cdea8005eb2a).  I don't think there is a need to have a redirect at https://doc.rust-lang.org/error_codes/error-index.html since I don't think fragment-based links were ever used there.\n\nI have tested with Firefox, Chrome, and Safari. Going to `/error-index.html` redirects without adding to the stack, and can use the back button. Additionally, `/error-index.html#E0005` redirects correctly to the error page.\n\nFinally, there is an unrelated commit to remove the 404 hack. There is an official way of avoiding the generation of the 404 page with setting input-404 to an empty value.\n\nFixes #106485", "tree": {"sha": "2a6eda220a87ff1ffce784bda625af9f1db1d15d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2a6eda220a87ff1ffce784bda625af9f1db1d15d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2b6e38cb71c8c60c314e042f4d8ee367c82a6fae", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjt7r4CRBK7hj4Ov3rIwAAxJwIABd9QGNFXUnwMJMoUGj+CtYf\nItunTTj0vcxqLRiNNnOUu+KzNo4kqg8SdJ8rBOk2B+qinScR+UtnzFfu4c6RUcIQ\nSp+Kbp6j2iRaIuOng5MyNpHVbfaUtSFdAJArpE5KEzfwvXM1aircVANEy1+s/zbs\nkM8pc7JPX7WyN8e/bF/frIYg29EN+fiHlZHM7I4r4dxN1V09hl+qoxTDZJ1PRJwp\nz/r6oTf2XTXE/zWk1FhATE8uSzCaHHJcibMx08Rt38CG9kySkZyLPYViAKxPdpn7\nhWiNRywFEVpuWDg+okTNYfhSHTQtA6ixytNw1KZb2TF1k8rgKQZLnKGoYa7BQN8=\n=V1p6\n-----END PGP SIGNATURE-----\n", "payload": "tree 2a6eda220a87ff1ffce784bda625af9f1db1d15d\nparent 6ae0f08c193d67bfe6336796e0c54da35d330504\nparent 72c3082aab3e2df801deeefcc65c7469d93274ca\nauthor Dylan DPC <99973273+Dylan-DPC@users.noreply.github.com> 1672985336 +0530\ncommitter GitHub <noreply@github.com> 1672985336 +0530\n\nRollup merge of #106491 - ehuss:error-index-redirect, r=GuillaumeGomez,notriddle\n\nFix error-index redirect to work with the back button.\n\nThis fixes the redirect page at https://doc.rust-lang.org/error-index.html so that it works with the browser's back-button. The solution is to use `window.location.replace()`, which avoids adding the page to the browser history stack.\n\nThis also cleans up the code a little bit, since it looks like it was written with different assumptions (maybe before f5857d5c5e1d2fde302f330d11c5cdea8005eb2a).  I don't think there is a need to have a redirect at https://doc.rust-lang.org/error_codes/error-index.html since I don't think fragment-based links were ever used there.\n\nI have tested with Firefox, Chrome, and Safari. Going to `/error-index.html` redirects without adding to the stack, and can use the back button. Additionally, `/error-index.html#E0005` redirects correctly to the error page.\n\nFinally, there is an unrelated commit to remove the 404 hack. There is an official way of avoiding the generation of the 404 page with setting input-404 to an empty value.\n\nFixes #106485\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2b6e38cb71c8c60c314e042f4d8ee367c82a6fae", "html_url": "https://github.com/rust-lang/rust/commit/2b6e38cb71c8c60c314e042f4d8ee367c82a6fae", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2b6e38cb71c8c60c314e042f4d8ee367c82a6fae/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6ae0f08c193d67bfe6336796e0c54da35d330504", "url": "https://api.github.com/repos/rust-lang/rust/commits/6ae0f08c193d67bfe6336796e0c54da35d330504", "html_url": "https://github.com/rust-lang/rust/commit/6ae0f08c193d67bfe6336796e0c54da35d330504"}, {"sha": "72c3082aab3e2df801deeefcc65c7469d93274ca", "url": "https://api.github.com/repos/rust-lang/rust/commits/72c3082aab3e2df801deeefcc65c7469d93274ca", "html_url": "https://github.com/rust-lang/rust/commit/72c3082aab3e2df801deeefcc65c7469d93274ca"}], "stats": {"total": 25, "additions": 11, "deletions": 14}, "files": [{"sha": "2701ad917bb0954febe9554c1a0db24d85663a47", "filename": "src/tools/error_index_generator/book_config.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/2b6e38cb71c8c60c314e042f4d8ee367c82a6fae/src%2Ftools%2Ferror_index_generator%2Fbook_config.toml", "raw_url": "https://github.com/rust-lang/rust/raw/2b6e38cb71c8c60c314e042f4d8ee367c82a6fae/src%2Ftools%2Ferror_index_generator%2Fbook_config.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ferror_index_generator%2Fbook_config.toml?ref=2b6e38cb71c8c60c314e042f4d8ee367c82a6fae", "patch": "@@ -7,6 +7,7 @@ src = \"\"\n git-repository-url = \"https://github.com/rust-lang/rust/\"\n additional-css = [\"error-index.css\"]\n additional-js = [\"error-index.js\"]\n+input-404 = \"\"\n \n [output.html.search]\n enable = true"}, {"sha": "98eda97e236cbf3642a85da5551e79ef1cd980d4", "filename": "src/tools/error_index_generator/main.rs", "status": "modified", "additions": 7, "deletions": 7, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/2b6e38cb71c8c60c314e042f4d8ee367c82a6fae/src%2Ftools%2Ferror_index_generator%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2b6e38cb71c8c60c314e042f4d8ee367c82a6fae/src%2Ftools%2Ferror_index_generator%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ferror_index_generator%2Fmain.rs?ref=2b6e38cb71c8c60c314e042f4d8ee367c82a6fae", "patch": "@@ -98,8 +98,7 @@ fn add_rust_attribute_on_codeblock(explanation: &str) -> String {\n \n fn render_html(output_path: &Path) -> Result<(), Box<dyn Error>> {\n     let mut introduction = format!(\n-        \"<script src='redirect.js'></script>\n-# Rust error codes index\n+        \"# Rust error codes index\n \n This page lists all the error codes emitted by the Rust compiler.\n \n@@ -149,7 +148,12 @@ This page lists all the error codes emitted by the Rust compiler.\n     book.book.sections.push(BookItem::Chapter(chapter));\n     book.build()?;\n \n-    // We can't put this content into another file, otherwise `mbdbook` will also put it into the\n+    // The error-index used to be generated manually (without mdbook), and the\n+    // index was located at the top level. Now that it is generated with\n+    // mdbook, error-index.html has moved to error_codes/error-index.html.\n+    // This adds a redirect so that old links go to the new location.\n+    //\n+    // We can't put this content into another file, otherwise `mdbook` will also put it into the\n     // output directory, making a duplicate.\n     fs::write(\n         output_path.join(\"error-index.html\"),\n@@ -163,14 +167,10 @@ This page lists all the error codes emitted by the Rust compiler.\n     </head>\n     <body>\n         <div>If you are not automatically redirected to the error code index, please <a id=\"index-link\" href=\"./error_codes/error-index.html\">here</a>.\n-        <script>document.getElementById(\"index-link\").click()</script>\n     </body>\n </html>\"#,\n     )?;\n \n-    // No need for a 404 file, it's already handled by the server.\n-    fs::remove_file(output_path.join(\"error_codes/404.html\"))?;\n-\n     Ok(())\n }\n "}, {"sha": "c80cbf297afffeab665939ebfd2491e21ceace1c", "filename": "src/tools/error_index_generator/redirect.js", "status": "modified", "additions": 3, "deletions": 7, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/2b6e38cb71c8c60c314e042f4d8ee367c82a6fae/src%2Ftools%2Ferror_index_generator%2Fredirect.js", "raw_url": "https://github.com/rust-lang/rust/raw/2b6e38cb71c8c60c314e042f4d8ee367c82a6fae/src%2Ftools%2Ferror_index_generator%2Fredirect.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ferror_index_generator%2Fredirect.js?ref=2b6e38cb71c8c60c314e042f4d8ee367c82a6fae", "patch": "@@ -3,14 +3,10 @@\n         let code = window.location.hash.replace(/^#/, '');\n         // We have to make sure this pattern matches to avoid inadvertently creating an\n         // open redirect.\n-        if (!/^E[0-9]+$/.test(code)) {\n+        if (/^E[0-9]+$/.test(code)) {\n+            window.location.replace('./error_codes/' + code + '.html');\n             return;\n         }\n-        if (window.location.pathname.indexOf(\"/error_codes/\") !== -1) {\n-            // We're not at the top level, so we don't prepend with \"./error_codes/\".\n-            window.location = './' + code + '.html';\n-        } else {\n-            window.location = './error_codes/' + code + '.html';\n-        }\n     }\n+    window.location.replace('./error_codes/error-index.html');\n })()"}]}