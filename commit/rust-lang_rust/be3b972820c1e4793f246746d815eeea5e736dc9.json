{"sha": "be3b972820c1e4793f246746d815eeea5e736dc9", "node_id": "MDY6Q29tbWl0NzI0NzEyOmJlM2I5NzI4MjBjMWU0NzkzZjI0Njc0NmQ4MTVlZWVhNWU3MzZkYzk=", "commit": {"author": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2020-07-17T21:09:04Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-07-17T21:09:04Z"}, "message": "Rollup merge of #74009 - mati865:mingw-tests-implib, r=nikomatsakis\n\nFix MinGW `run-make-fulldeps` tests\n\n`compiler-rt-works-on-mingw` and `libs-search-path` were not ran because `only-mingw` doesn't match any target.\nEnabled and verified few ignored tests with `windows-gnu` toolchain. They are still ignored on MSVC since I'm not experienced with this target.", "tree": {"sha": "288d22262d838e7f5506bab27ecef9d0f29dbd57", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/288d22262d838e7f5506bab27ecef9d0f29dbd57"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/be3b972820c1e4793f246746d815eeea5e736dc9", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfEhNwCRBK7hj4Ov3rIwAAdHIIAKMasTRvYjoKiFYsDYjpcy+X\n17/LWypo7fTENmOuia2891z9sDnsrvx+ane/ZO732jBeLU5ZfSlRoQyfAMgCgbHY\nLYud8iI/o8W/VpmGBECPZLlOAI2cPpdEMC8udkiieVqCz2H1gMc2fzoghwqjgqAX\nxj2GlOSl6eMh39tXjCxUc8v/Xi24IQNBrXVQEaK522AwNbbJO/ob4qNJa25YKD8J\nCNBR2Mm5rzfiM4vM4N7nXFlcxg4sRaL9Yr6w3OUUYgSBzFb2vpfTvvIV7SBgdm43\ni9Q6lgiEmK7IuYO+avzOsFO3mWU77oCs5wuXsNM3EUglV7PhfIuR/noj69OepSA=\n=CfMx\n-----END PGP SIGNATURE-----\n", "payload": "tree 288d22262d838e7f5506bab27ecef9d0f29dbd57\nparent f6cd31c3b71139a301b23ad6107a5e0560bc3fe7\nparent af1d01ebb3ad442aabeaaba7dc77912f539e0555\nauthor Manish Goregaokar <manishsmail@gmail.com> 1595020144 -0700\ncommitter GitHub <noreply@github.com> 1595020144 -0700\n\nRollup merge of #74009 - mati865:mingw-tests-implib, r=nikomatsakis\n\nFix MinGW `run-make-fulldeps` tests\n\n`compiler-rt-works-on-mingw` and `libs-search-path` were not ran because `only-mingw` doesn't match any target.\nEnabled and verified few ignored tests with `windows-gnu` toolchain. They are still ignored on MSVC since I'm not experienced with this target.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/be3b972820c1e4793f246746d815eeea5e736dc9", "html_url": "https://github.com/rust-lang/rust/commit/be3b972820c1e4793f246746d815eeea5e736dc9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/be3b972820c1e4793f246746d815eeea5e736dc9/comments", "author": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f6cd31c3b71139a301b23ad6107a5e0560bc3fe7", "url": "https://api.github.com/repos/rust-lang/rust/commits/f6cd31c3b71139a301b23ad6107a5e0560bc3fe7", "html_url": "https://github.com/rust-lang/rust/commit/f6cd31c3b71139a301b23ad6107a5e0560bc3fe7"}, {"sha": "af1d01ebb3ad442aabeaaba7dc77912f539e0555", "url": "https://api.github.com/repos/rust-lang/rust/commits/af1d01ebb3ad442aabeaaba7dc77912f539e0555", "html_url": "https://github.com/rust-lang/rust/commit/af1d01ebb3ad442aabeaaba7dc77912f539e0555"}], "stats": {"total": 95, "additions": 41, "deletions": 54}, "files": [{"sha": "0cf5d1855212d6ea064661ba22a0ba21168b188d", "filename": "src/test/run-make-fulldeps/compiler-rt-works-on-mingw/Makefile", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/be3b972820c1e4793f246746d815eeea5e736dc9/src%2Ftest%2Frun-make-fulldeps%2Fcompiler-rt-works-on-mingw%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/be3b972820c1e4793f246746d815eeea5e736dc9/src%2Ftest%2Frun-make-fulldeps%2Fcompiler-rt-works-on-mingw%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fcompiler-rt-works-on-mingw%2FMakefile?ref=be3b972820c1e4793f246746d815eeea5e736dc9", "patch": "@@ -1,6 +1,6 @@\n -include ../tools.mk\n \n-# only-mingw\n+# only-windows-gnu\n \n all:\n \t$(CXX) foo.cpp -c -o $(TMPDIR)/foo.o"}, {"sha": "f91af88efe1b715a3dc9fdc183de419de76b90e5", "filename": "src/test/run-make-fulldeps/include_bytes_deps/Makefile", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/be3b972820c1e4793f246746d815eeea5e736dc9/src%2Ftest%2Frun-make-fulldeps%2Finclude_bytes_deps%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/be3b972820c1e4793f246746d815eeea5e736dc9/src%2Ftest%2Frun-make-fulldeps%2Finclude_bytes_deps%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Finclude_bytes_deps%2FMakefile?ref=be3b972820c1e4793f246746d815eeea5e736dc9", "patch": "@@ -1,10 +1,6 @@\n -include ../tools.mk\n \n-# ignore-windows\n # ignore-freebsd\n-# FIXME: on windows `rustc --dep-info` produces Makefile dependency with\n-# windows native paths (e.g. `c:\\path\\to\\libfoo.a`)\n-# but msys make seems to fail to recognize such paths, so test fails.\n \n all:\n \t$(RUSTC) --emit dep-info main.rs"}, {"sha": "2037728568e2409493a3cea9ef7bc2dfc232fe7e", "filename": "src/test/run-make-fulldeps/intrinsic-unreachable/Makefile", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/be3b972820c1e4793f246746d815eeea5e736dc9/src%2Ftest%2Frun-make-fulldeps%2Fintrinsic-unreachable%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/be3b972820c1e4793f246746d815eeea5e736dc9/src%2Ftest%2Frun-make-fulldeps%2Fintrinsic-unreachable%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fintrinsic-unreachable%2FMakefile?ref=be3b972820c1e4793f246746d815eeea5e736dc9", "patch": "@@ -1,6 +1,6 @@\n -include ../tools.mk\n \n-# ignore-windows\n+# ignore-windows-msvc\n #\n # Because of Windows exception handling, the code is not necessarily any shorter.\n # https://github.com/llvm-mirror/llvm/commit/64b2297786f7fd6f5fa24cdd4db0298fbf211466"}, {"sha": "ba3d3b7100745e0debe024ac76d776f86f7e868a", "filename": "src/test/run-make-fulldeps/issue-51671/Makefile", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/be3b972820c1e4793f246746d815eeea5e736dc9/src%2Ftest%2Frun-make-fulldeps%2Fissue-51671%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/be3b972820c1e4793f246746d815eeea5e736dc9/src%2Ftest%2Frun-make-fulldeps%2Fissue-51671%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fissue-51671%2FMakefile?ref=be3b972820c1e4793f246746d815eeea5e736dc9", "patch": "@@ -1,6 +1,6 @@\n -include ../tools.mk\n \n-# ignore-windows\n+# ignore-windows-msvc\n \n all:\n \t$(RUSTC) --emit=obj app.rs"}, {"sha": "f31036ffa19591cea06c7bcb087ce9d8fc3b9292", "filename": "src/test/run-make-fulldeps/libs-search-path/Makefile", "status": "removed", "additions": 0, "deletions": 10, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/f6cd31c3b71139a301b23ad6107a5e0560bc3fe7/src%2Ftest%2Frun-make-fulldeps%2Flibs-search-path%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/f6cd31c3b71139a301b23ad6107a5e0560bc3fe7/src%2Ftest%2Frun-make-fulldeps%2Flibs-search-path%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Flibs-search-path%2FMakefile?ref=f6cd31c3b71139a301b23ad6107a5e0560bc3fe7", "patch": "@@ -1,10 +0,0 @@\n--include ../tools.mk\n-\n-# only-mingw\n-\n-all: empty.rs\n-\tcp -r $(shell cygpath -u $(shell $(RUSTC) --print sysroot)) $(TMPDIR)/sysroot\n-\t$(RUSTC) --target $(TARGET) --sysroot $(TMPDIR)/sysroot -L$(TMPDIR)/obj -Z print-link-args empty.rs | $(CGREP) 'lib\\\\crt2.o'\n-\tmkdir -p $(TMPDIR)/obj\n-\tmv $(TMPDIR)/sysroot/lib/rustlib/$(TARGET)/lib/crt2.o $(TMPDIR)/obj/crt2.o\n-\t$(RUSTC) --target $(TARGET) --sysroot $(TMPDIR)/sysroot -L$(TMPDIR)/obj -Z print-link-args empty.rs | $(CGREP) 'obj\\\\crt2.o'"}, {"sha": "f328e4d9d04c31d0d70d16d21a07d1613be9d577", "filename": "src/test/run-make-fulldeps/libs-search-path/empty.rs", "status": "removed", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/f6cd31c3b71139a301b23ad6107a5e0560bc3fe7/src%2Ftest%2Frun-make-fulldeps%2Flibs-search-path%2Fempty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f6cd31c3b71139a301b23ad6107a5e0560bc3fe7/src%2Ftest%2Frun-make-fulldeps%2Flibs-search-path%2Fempty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Flibs-search-path%2Fempty.rs?ref=f6cd31c3b71139a301b23ad6107a5e0560bc3fe7", "patch": "@@ -1 +0,0 @@\n-fn main() {}"}, {"sha": "8468d102bec8312a276df6de130368ef4d492891", "filename": "src/test/run-make-fulldeps/redundant-libs/Makefile", "status": "modified", "additions": 1, "deletions": 5, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/be3b972820c1e4793f246746d815eeea5e736dc9/src%2Ftest%2Frun-make-fulldeps%2Fredundant-libs%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/be3b972820c1e4793f246746d815eeea5e736dc9/src%2Ftest%2Frun-make-fulldeps%2Fredundant-libs%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fredundant-libs%2FMakefile?ref=be3b972820c1e4793f246746d815eeea5e736dc9", "patch": "@@ -1,8 +1,6 @@\n -include ../tools.mk\n \n-ifdef IS_WINDOWS\n-all:\n-else\n+# ignore-windows-msvc\n \n # rustc will remove one of the two redundant references to foo below.  Depending\n # on which one gets removed, we'll get a linker error on SOME platforms (like\n@@ -23,5 +21,3 @@ RUSTC_FLAGS = \\\n all: $(call DYLIB,foo) $(call STATICLIB,bar) $(call STATICLIB,baz)\n \t$(RUSTC) $(RUSTC_FLAGS) main.rs\n \t$(call RUN,main)\n-\n-endif"}, {"sha": "dc55c947d89a2fef1017bee007cc63dbb2735e6a", "filename": "src/test/run-make-fulldeps/symbol-visibility/Makefile", "status": "modified", "additions": 34, "deletions": 29, "changes": 63, "blob_url": "https://github.com/rust-lang/rust/blob/be3b972820c1e4793f246746d815eeea5e736dc9/src%2Ftest%2Frun-make-fulldeps%2Fsymbol-visibility%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/be3b972820c1e4793f246746d815eeea5e736dc9/src%2Ftest%2Frun-make-fulldeps%2Fsymbol-visibility%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fsymbol-visibility%2FMakefile?ref=be3b972820c1e4793f246746d815eeea5e736dc9", "patch": "@@ -1,9 +1,6 @@\n include ../tools.mk\n \n-# ignore-windows\n-#\n-# On MINGW the --version-script, --dynamic-list, and --retain-symbol args don't\n-# seem to work reliably.\n+# ignore-windows-msvc\n \n NM=nm -D\n CDYLIB_NAME=liba_cdylib.so\n@@ -19,6 +16,14 @@ EXE_NAME=an_executable\n COMBINED_CDYLIB_NAME=libcombined_rlib_dylib.dylib\n endif\n \n+ifdef IS_WINDOWS\n+NM=nm -g\n+CDYLIB_NAME=liba_cdylib.dll.a\n+RDYLIB_NAME=liba_rust_dylib.dll.a\n+EXE_NAME=an_executable.exe\n+COMBINED_CDYLIB_NAME=libcombined_rlib_dylib.dll.a\n+endif\n+\n # `grep` regex for symbols produced by either `legacy` or `v0` mangling\n RE_ANY_RUST_SYMBOL=\"_ZN.*h.*E\\|_R[a-zA-Z0-9_]+\"\n \n@@ -30,38 +35,38 @@ all:\n \t$(RUSTC) -Zshare-generics=no a_cdylib.rs --crate-name combined_rlib_dylib --crate-type=rlib,cdylib\n \n \t# Check that a cdylib exports its public #[no_mangle] functions\n-\t[ \"$$($(NM) $(TMPDIR)/$(CDYLIB_NAME) | grep -c public_c_function_from_cdylib)\" -eq \"1\" ]\n+\t[ \"$$($(NM) $(TMPDIR)/$(CDYLIB_NAME) | grep -v __imp_ | grep -c public_c_function_from_cdylib)\" -eq \"1\" ]\n \t# Check that a cdylib exports the public #[no_mangle] functions of dependencies\n-\t[ \"$$($(NM) $(TMPDIR)/$(CDYLIB_NAME) | grep -c public_c_function_from_rlib)\" -eq \"1\" ]\n+\t[ \"$$($(NM) $(TMPDIR)/$(CDYLIB_NAME) | grep -v __imp_ | grep -c public_c_function_from_rlib)\" -eq \"1\" ]\n \t# Check that a cdylib DOES NOT export any public Rust functions\n-\t[ \"$$($(NM) $(TMPDIR)/$(CDYLIB_NAME) | grep -c $(RE_ANY_RUST_SYMBOL))\" -eq \"0\" ]\n+\t[ \"$$($(NM) $(TMPDIR)/$(CDYLIB_NAME) | grep -v __imp_ | grep -c $(RE_ANY_RUST_SYMBOL))\" -eq \"0\" ]\n \n \t# Check that a Rust dylib exports its monomorphic functions\n-\t[ \"$$($(NM) $(TMPDIR)/$(RDYLIB_NAME) | grep -c public_c_function_from_rust_dylib)\" -eq \"1\" ]\n-\t[ \"$$($(NM) $(TMPDIR)/$(RDYLIB_NAME) | grep -c public_rust_function_from_rust_dylib)\" -eq \"1\" ]\n+\t[ \"$$($(NM) $(TMPDIR)/$(RDYLIB_NAME) | grep -v __imp_ | grep -c public_c_function_from_rust_dylib)\" -eq \"1\" ]\n+\t[ \"$$($(NM) $(TMPDIR)/$(RDYLIB_NAME) | grep -v __imp_ | grep -c public_rust_function_from_rust_dylib)\" -eq \"1\" ]\n \t# Check that a Rust dylib does not export generics if -Zshare-generics=no\n-\t[ \"$$($(NM) $(TMPDIR)/$(RDYLIB_NAME) | grep -c public_generic_function_from_rust_dylib)\" -eq \"0\" ]\n+\t[ \"$$($(NM) $(TMPDIR)/$(RDYLIB_NAME) | grep -v __imp_ | grep -c public_generic_function_from_rust_dylib)\" -eq \"0\" ]\n \n \n \t# Check that a Rust dylib exports the monomorphic functions from its dependencies\n-\t[ \"$$($(NM) $(TMPDIR)/$(RDYLIB_NAME) | grep -c public_c_function_from_rlib)\" -eq \"1\" ]\n-\t[ \"$$($(NM) $(TMPDIR)/$(RDYLIB_NAME) | grep -c public_rust_function_from_rlib)\" -eq \"1\" ]\n+\t[ \"$$($(NM) $(TMPDIR)/$(RDYLIB_NAME) | grep -v __imp_ | grep -c public_c_function_from_rlib)\" -eq \"1\" ]\n+\t[ \"$$($(NM) $(TMPDIR)/$(RDYLIB_NAME) | grep -v __imp_ | grep -c public_rust_function_from_rlib)\" -eq \"1\" ]\n \t# Check that a Rust dylib does not export generics if -Zshare-generics=no\n-\t[ \"$$($(NM) $(TMPDIR)/$(RDYLIB_NAME) | grep -c public_generic_function_from_rlib)\" -eq \"0\" ]\n+\t[ \"$$($(NM) $(TMPDIR)/$(RDYLIB_NAME) | grep -v __imp_ | grep -c public_generic_function_from_rlib)\" -eq \"0\" ]\n \n \t# Check that an executable does not export any dynamic symbols\n-\t[ \"$$($(NM) $(TMPDIR)/$(EXE_NAME) | grep -c public_c_function_from_rlib)\" -eq \"0\" ]\n-\t[ \"$$($(NM) $(TMPDIR)/$(EXE_NAME) | grep -c public_rust_function_from_exe)\" -eq \"0\" ]\n+\t[ \"$$($(NM) $(TMPDIR)/$(EXE_NAME) | grep -v __imp_ | grep -c public_c_function_from_rlib)\" -eq \"0\" ]\n+\t[ \"$$($(NM) $(TMPDIR)/$(EXE_NAME) | grep -v __imp_ | grep -c public_rust_function_from_exe)\" -eq \"0\" ]\n \n \n \t# Check the combined case, where we generate a cdylib and an rlib in the same\n \t# compilation session:\n \t# Check that a cdylib exports its public #[no_mangle] functions\n-\t[ \"$$($(NM) $(TMPDIR)/$(COMBINED_CDYLIB_NAME) | grep -c public_c_function_from_cdylib)\" -eq \"1\" ]\n+\t[ \"$$($(NM) $(TMPDIR)/$(COMBINED_CDYLIB_NAME) | grep -v __imp_ | grep -c public_c_function_from_cdylib)\" -eq \"1\" ]\n \t# Check that a cdylib exports the public #[no_mangle] functions of dependencies\n-\t[ \"$$($(NM) $(TMPDIR)/$(COMBINED_CDYLIB_NAME) | grep -c public_c_function_from_rlib)\" -eq \"1\" ]\n+\t[ \"$$($(NM) $(TMPDIR)/$(COMBINED_CDYLIB_NAME) | grep -v __imp_ | grep -c public_c_function_from_rlib)\" -eq \"1\" ]\n \t# Check that a cdylib DOES NOT export any public Rust functions\n-\t[ \"$$($(NM) $(TMPDIR)/$(COMBINED_CDYLIB_NAME) | grep -c $(RE_ANY_RUST_SYMBOL))\" -eq \"0\" ]\n+\t[ \"$$($(NM) $(TMPDIR)/$(COMBINED_CDYLIB_NAME) | grep -v __imp_ | grep -c $(RE_ANY_RUST_SYMBOL))\" -eq \"0\" ]\n \n \n \t$(RUSTC) -Zshare-generics=yes an_rlib.rs\n@@ -70,22 +75,22 @@ all:\n \t$(RUSTC) -Zshare-generics=yes an_executable.rs\n \n \t# Check that a cdylib exports its public #[no_mangle] functions\n-\t[ \"$$($(NM) $(TMPDIR)/$(CDYLIB_NAME) | grep -c public_c_function_from_cdylib)\" -eq \"1\" ]\n+\t[ \"$$($(NM) $(TMPDIR)/$(CDYLIB_NAME) | grep -v __imp_ | grep -c public_c_function_from_cdylib)\" -eq \"1\" ]\n \t# Check that a cdylib exports the public #[no_mangle] functions of dependencies\n-\t[ \"$$($(NM) $(TMPDIR)/$(CDYLIB_NAME) | grep -c public_c_function_from_rlib)\" -eq \"1\" ]\n+\t[ \"$$($(NM) $(TMPDIR)/$(CDYLIB_NAME) | grep -v __imp_ | grep -c public_c_function_from_rlib)\" -eq \"1\" ]\n \t# Check that a cdylib DOES NOT export any public Rust functions\n-\t[ \"$$($(NM) $(TMPDIR)/$(CDYLIB_NAME) | grep -c $(RE_ANY_RUST_SYMBOL))\" -eq \"0\" ]\n+\t[ \"$$($(NM) $(TMPDIR)/$(CDYLIB_NAME) | grep -v __imp_ | grep -c $(RE_ANY_RUST_SYMBOL))\" -eq \"0\" ]\n \n \t# Check that a Rust dylib exports its monomorphic functions, including generics this time\n-\t[ \"$$($(NM) $(TMPDIR)/$(RDYLIB_NAME) | grep -c public_c_function_from_rust_dylib)\" -eq \"1\" ]\n-\t[ \"$$($(NM) $(TMPDIR)/$(RDYLIB_NAME) | grep -c public_rust_function_from_rust_dylib)\" -eq \"1\" ]\n-\t[ \"$$($(NM) $(TMPDIR)/$(RDYLIB_NAME) | grep -c public_generic_function_from_rust_dylib)\" -eq \"1\" ]\n+\t[ \"$$($(NM) $(TMPDIR)/$(RDYLIB_NAME) | grep -v __imp_ | grep -c public_c_function_from_rust_dylib)\" -eq \"1\" ]\n+\t[ \"$$($(NM) $(TMPDIR)/$(RDYLIB_NAME) | grep -v __imp_ | grep -c public_rust_function_from_rust_dylib)\" -eq \"1\" ]\n+\t[ \"$$($(NM) $(TMPDIR)/$(RDYLIB_NAME) | grep -v __imp_ | grep -c public_generic_function_from_rust_dylib)\" -eq \"1\" ]\n \n \t# Check that a Rust dylib exports the monomorphic functions from its dependencies\n-\t[ \"$$($(NM) $(TMPDIR)/$(RDYLIB_NAME) | grep -c public_c_function_from_rlib)\" -eq \"1\" ]\n-\t[ \"$$($(NM) $(TMPDIR)/$(RDYLIB_NAME) | grep -c public_rust_function_from_rlib)\" -eq \"1\" ]\n-\t[ \"$$($(NM) $(TMPDIR)/$(RDYLIB_NAME) | grep -c public_generic_function_from_rlib)\" -eq \"1\" ]\n+\t[ \"$$($(NM) $(TMPDIR)/$(RDYLIB_NAME) | grep -v __imp_ | grep -c public_c_function_from_rlib)\" -eq \"1\" ]\n+\t[ \"$$($(NM) $(TMPDIR)/$(RDYLIB_NAME) | grep -v __imp_ | grep -c public_rust_function_from_rlib)\" -eq \"1\" ]\n+\t[ \"$$($(NM) $(TMPDIR)/$(RDYLIB_NAME) | grep -v __imp_ | grep -c public_generic_function_from_rlib)\" -eq \"1\" ]\n \n \t# Check that an executable does not export any dynamic symbols\n-\t[ \"$$($(NM) $(TMPDIR)/$(EXE_NAME) | grep -c public_c_function_from_rlib)\" -eq \"0\" ]\n-\t[ \"$$($(NM) $(TMPDIR)/$(EXE_NAME) | grep -c public_rust_function_from_exe)\" -eq \"0\" ]\n+\t[ \"$$($(NM) $(TMPDIR)/$(EXE_NAME) | grep -v __imp_ | grep -c public_c_function_from_rlib)\" -eq \"0\" ]\n+\t[ \"$$($(NM) $(TMPDIR)/$(EXE_NAME) | grep -v __imp_ | grep -c public_rust_function_from_exe)\" -eq \"0\" ]"}, {"sha": "1effa46e101eba906e392f2dd535ce3a1cf8353d", "filename": "src/test/run-make-fulldeps/tools.mk", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/be3b972820c1e4793f246746d815eeea5e736dc9/src%2Ftest%2Frun-make-fulldeps%2Ftools.mk", "raw_url": "https://github.com/rust-lang/rust/raw/be3b972820c1e4793f246746d815eeea5e736dc9/src%2Ftest%2Frun-make-fulldeps%2Ftools.mk", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Ftools.mk?ref=be3b972820c1e4793f246746d815eeea5e736dc9", "patch": "@@ -150,7 +150,7 @@ ifdef IS_MSVC\n \t$(CC) $< -link -dll -out:`cygpath -w $@`\n else\n %.dll: lib%.o\n-\t$(CC) -o $@ $< -shared\n+\t$(CC) -o $@ $< -shared -Wl,--out-implib=$@.a\n endif\n \n $(TMPDIR)/lib%.o: %.c"}, {"sha": "4d904472931ece12732a5a3e31b4684dbb0e6d0a", "filename": "src/test/run-make-fulldeps/used/Makefile", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/be3b972820c1e4793f246746d815eeea5e736dc9/src%2Ftest%2Frun-make-fulldeps%2Fused%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/be3b972820c1e4793f246746d815eeea5e736dc9/src%2Ftest%2Frun-make-fulldeps%2Fused%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fused%2FMakefile?ref=be3b972820c1e4793f246746d815eeea5e736dc9", "patch": "@@ -1,6 +1,6 @@\n -include ../tools.mk\n \n-# ignore-windows\n+# ignore-windows-msvc\n \n all:\n \t$(RUSTC) -C opt-level=3 --emit=obj used.rs"}, {"sha": "d6e28e93c96676aaf5ba632d17916e40d06c4b2f", "filename": "src/tools/compiletest/src/header.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/be3b972820c1e4793f246746d815eeea5e736dc9/src%2Ftools%2Fcompiletest%2Fsrc%2Fheader.rs", "raw_url": "https://github.com/rust-lang/rust/raw/be3b972820c1e4793f246746d815eeea5e736dc9/src%2Ftools%2Fcompiletest%2Fsrc%2Fheader.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fheader.rs?ref=be3b972820c1e4793f246746d815eeea5e736dc9", "patch": "@@ -867,6 +867,7 @@ impl Config {\n             &self.target == name ||                             // triple\n             util::matches_os(&self.target, name) ||             // target\n             util::matches_env(&self.target, name) ||            // env\n+            self.target.ends_with(name) ||                      // target and env\n             name == util::get_arch(&self.target) ||             // architecture\n             name == util::get_pointer_width(&self.target) ||    // pointer width\n             name == self.stage_id.split('-').next().unwrap() || // stage"}]}