{"sha": "87294c23baacaee17a13d2f7316fffc76239cff5", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg3Mjk0YzIzYmFhY2FlZTE3YTEzZDJmNzMxNmZmZmM3NjIzOWNmZjU=", "commit": {"author": {"name": "blake2-ppc", "email": "blake2-ppc", "date": "2013-10-04T23:10:27Z"}, "committer": {"name": "blake2-ppc", "email": "blake2-ppc", "date": "2013-10-04T23:10:27Z"}, "message": "Avoid cloning the stack on every `push_ctxt` call in trans\n\nRewrite the use of TLS variable for `push_ctxt` so that it uses a ~[]\ninstead of a @~[]. Before it cloned the whole vector on each push and\npop, which is unnecessary.", "tree": {"sha": "42c04a0b0f5ddd1e48e10059c099d2e383cc81bd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/42c04a0b0f5ddd1e48e10059c099d2e383cc81bd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/87294c23baacaee17a13d2f7316fffc76239cff5", "comment_count": 5, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/87294c23baacaee17a13d2f7316fffc76239cff5", "html_url": "https://github.com/rust-lang/rust/commit/87294c23baacaee17a13d2f7316fffc76239cff5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/87294c23baacaee17a13d2f7316fffc76239cff5/comments", "author": null, "committer": null, "parents": [{"sha": "9344e2a8665ccd8010bd903aab450115de80bf46", "url": "https://api.github.com/repos/rust-lang/rust/commits/9344e2a8665ccd8010bd903aab450115de80bf46", "html_url": "https://github.com/rust-lang/rust/commit/9344e2a8665ccd8010bd903aab450115de80bf46"}], "stats": {"total": 22, "additions": 11, "deletions": 11}, "files": [{"sha": "2c0497283c19c04a56224baf64ae77e45cc4e410", "filename": "src/librustc/middle/trans/base.rs", "status": "modified", "additions": 11, "deletions": 11, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/87294c23baacaee17a13d2f7316fffc76239cff5/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/87294c23baacaee17a13d2f7316fffc76239cff5/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs?ref=87294c23baacaee17a13d2f7316fffc76239cff5", "patch": "@@ -92,17 +92,19 @@ use syntax::visit::Visitor;\n \n pub use middle::trans::context::task_llcx;\n \n-local_data_key!(task_local_insn_key: @~[&'static str])\n+local_data_key!(task_local_insn_key: ~[&'static str])\n \n pub fn with_insn_ctxt(blk: &fn(&[&'static str])) {\n-    let opt = local_data::get(task_local_insn_key, |k| k.map_move(|k| *k));\n-    if opt.is_some() {\n-        blk(*opt.unwrap());\n+    do local_data::get(task_local_insn_key) |c| {\n+        match c {\n+            Some(ctx) => blk(*ctx),\n+            None => ()\n+        }\n     }\n }\n \n pub fn init_insn_ctxt() {\n-    local_data::set(task_local_insn_key, @~[]);\n+    local_data::set(task_local_insn_key, ~[]);\n }\n \n pub struct _InsnCtxt { _x: () }\n@@ -111,10 +113,9 @@ pub struct _InsnCtxt { _x: () }\n impl Drop for _InsnCtxt {\n     fn drop(&mut self) {\n         do local_data::modify(task_local_insn_key) |c| {\n-            do c.map_move |ctx| {\n-                let mut ctx = (*ctx).clone();\n+            do c.map_move |mut ctx| {\n                 ctx.pop();\n-                @ctx\n+                ctx\n             }\n         }\n     }\n@@ -123,10 +124,9 @@ impl Drop for _InsnCtxt {\n pub fn push_ctxt(s: &'static str) -> _InsnCtxt {\n     debug2!(\"new InsnCtxt: {}\", s);\n     do local_data::modify(task_local_insn_key) |c| {\n-        do c.map_move |ctx| {\n-            let mut ctx = (*ctx).clone();\n+        do c.map_move |mut ctx| {\n             ctx.push(s);\n-            @ctx\n+            ctx\n         }\n     }\n     _InsnCtxt { _x: () }"}]}