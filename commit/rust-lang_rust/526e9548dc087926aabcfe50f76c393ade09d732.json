{"sha": "526e9548dc087926aabcfe50f76c393ade09d732", "node_id": "MDY6Q29tbWl0NzI0NzEyOjUyNmU5NTQ4ZGMwODc5MjZhYWJjZmU1MGY3NmMzOTNhZGUwOWQ3MzI=", "commit": {"author": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2018-02-14T08:14:46Z"}, "committer": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2018-02-14T10:25:26Z"}, "message": "Rollup merge of #48165 - alexcrichton:update-read2, r=Mark-Simulacrum\n\nUpdate compiletest's `read2` function\n\nThis was originally copied over from Cargo and Cargo has since [been\nupdated][update] so let's pull in the fixes here too!\n\n[update]: https://github.com/rust-lang/cargo/pull/5030", "tree": {"sha": "526dbe1ee33900ad8621f02d19ab42aff5653bc0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/526dbe1ee33900ad8621f02d19ab42aff5653bc0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/526e9548dc087926aabcfe50f76c393ade09d732", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEZ1R8CLMp8f2GxWoQ/vbIBR0OATwFAlqEDpYACgkQ/vbIBR0O\nATzk+hAAqLLz+MefgWldkunKRHsWmKl7TCJ3m1cQ4ZGcna4XEOCjHz8cvBmV8XFM\n6HejyRHcdNff5RGae2xXFvsbUJ1xTIU/7M9n4ZO/5FRXqt58+HzhZ0UpWZ/J6Ico\n4MrRrFx8LMq8+53B0sSNtHE+Wkh+tRsjhuuZduEBeE119XUnsOlYL6YFvXnXFKAF\n4eM9PfAFF3SAPxyOLKVDUC5aU/Lzt8kpIwqoK3g1Dk5BURbrzJHK3tXA+e7Z9AO8\nsxi4bqfwh27yUyNojmIIKl3k1uJc3zoiYlbpaUAlapIWqA5FWwQB6lqEj1RvW7uS\nEeWCTQm+SbcHOIfkKbFteSD16Vv2eHvndX2X+tZgBk8uoeZc0qNzFALTFVi/hEId\nRPhCa/Jju2m7JRbuI5OB0FEpfrYozrfH4nE3sP/ZGX7g5Qncnw7h+Sm2pSEEJdmP\noRRWwHdjn8g0YvclVqcPlfRBnyQKn5fzN/TQhCWqMVMZdDjZIENJW+EoMyb/A7kG\n9hfG+pTOUDiRBcEICETFefovoktWqU/YiO5i8i1QkkQTamyXOP+Zv2nleNZzjN/b\nScQxpSVrlYruYCcu9RZo/9Vs/iQfTmHk/bCq0fD4y9pMuMVxKrT2Ogf4FSghfisi\nkcphW7vAag2Y2bQYuDbZ8V+pP1qUbuslD5RJrGK33AYlPL8k8Uk=\n=KmPr\n-----END PGP SIGNATURE-----", "payload": "tree 526dbe1ee33900ad8621f02d19ab42aff5653bc0\nparent 92c66b78c829afe1c0958c5e96ec3b18b67a4667\nparent 4c658f76c1b51ced4f6c30ea37441c4141659b93\nauthor kennytm <kennytm@gmail.com> 1518596086 +0800\ncommitter kennytm <kennytm@gmail.com> 1518603926 +0800\n\nRollup merge of #48165 - alexcrichton:update-read2, r=Mark-Simulacrum\n\nUpdate compiletest's `read2` function\n\nThis was originally copied over from Cargo and Cargo has since [been\nupdated][update] so let's pull in the fixes here too!\n\n[update]: https://github.com/rust-lang/cargo/pull/5030\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/526e9548dc087926aabcfe50f76c393ade09d732", "html_url": "https://github.com/rust-lang/rust/commit/526e9548dc087926aabcfe50f76c393ade09d732", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/526e9548dc087926aabcfe50f76c393ade09d732/comments", "author": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "92c66b78c829afe1c0958c5e96ec3b18b67a4667", "url": "https://api.github.com/repos/rust-lang/rust/commits/92c66b78c829afe1c0958c5e96ec3b18b67a4667", "html_url": "https://github.com/rust-lang/rust/commit/92c66b78c829afe1c0958c5e96ec3b18b67a4667"}, {"sha": "4c658f76c1b51ced4f6c30ea37441c4141659b93", "url": "https://api.github.com/repos/rust-lang/rust/commits/4c658f76c1b51ced4f6c30ea37441c4141659b93", "html_url": "https://github.com/rust-lang/rust/commit/4c658f76c1b51ced4f6c30ea37441c4141659b93"}], "stats": {"total": 24, "additions": 14, "deletions": 10}, "files": [{"sha": "486c0d81e3f407d0c3424cd049f3ea21df3e025a", "filename": "src/tools/compiletest/src/read2.rs", "status": "modified", "additions": 14, "deletions": 10, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/526e9548dc087926aabcfe50f76c393ade09d732/src%2Ftools%2Fcompiletest%2Fsrc%2Fread2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/526e9548dc087926aabcfe50f76c393ade09d732/src%2Ftools%2Fcompiletest%2Fsrc%2Fread2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fread2.rs?ref=526e9548dc087926aabcfe50f76c393ade09d732", "patch": "@@ -58,9 +58,12 @@ mod imp {\n         fds[0].events = libc::POLLIN;\n         fds[1].fd = err_pipe.as_raw_fd();\n         fds[1].events = libc::POLLIN;\n-        loop {\n+        let mut nfds = 2;\n+        let mut errfd = 1;\n+\n+        while nfds > 0 {\n             // wait for either pipe to become readable using `select`\n-            let r = unsafe { libc::poll(fds.as_mut_ptr(), 2, -1) };\n+            let r = unsafe { libc::poll(fds.as_mut_ptr(), nfds, -1) };\n             if r == -1 {\n                 let err = io::Error::last_os_error();\n                 if err.kind() == io::ErrorKind::Interrupted {\n@@ -86,19 +89,20 @@ mod imp {\n                     }\n                 }\n             };\n-            if !out_done && fds[0].revents != 0 && handle(out_pipe.read_to_end(&mut out))? {\n-                out_done = true;\n-            }\n-            data(true, &mut out, out_done);\n-            if !err_done && fds[1].revents != 0 && handle(err_pipe.read_to_end(&mut err))? {\n+            if !err_done && fds[errfd].revents != 0 && handle(err_pipe.read_to_end(&mut err))? {\n                 err_done = true;\n+                nfds -= 1;\n             }\n             data(false, &mut err, err_done);\n-\n-            if out_done && err_done {\n-                return Ok(())\n+            if !out_done && fds[0].revents != 0 && handle(out_pipe.read_to_end(&mut out))? {\n+                out_done = true;\n+                fds[0].fd = err_pipe.as_raw_fd();\n+                errfd = 0;\n+                nfds -= 1;\n             }\n+            data(true, &mut out, out_done);\n         }\n+        Ok(())\n     }\n }\n "}]}