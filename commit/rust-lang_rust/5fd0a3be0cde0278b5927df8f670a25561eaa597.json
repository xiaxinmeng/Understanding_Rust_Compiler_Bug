{"sha": "5fd0a3be0cde0278b5927df8f670a25561eaa597", "node_id": "MDY6Q29tbWl0NzI0NzEyOjVmZDBhM2JlMGNkZTAyNzhiNTkyN2RmOGY2NzBhMjU1NjFlYWE1OTc=", "commit": {"author": {"name": "Graydon Hoare", "email": "graydon@mozilla.com", "date": "2011-12-29T19:49:29Z"}, "committer": {"name": "Graydon Hoare", "email": "graydon@mozilla.com", "date": "2011-12-29T19:49:29Z"}, "message": "Save and restore xmm regs across the call to UPCALL_NEW_STACK during __morestack, close #1388.", "tree": {"sha": "a9d006266de43e424aa000139d4a5811cd182d38", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a9d006266de43e424aa000139d4a5811cd182d38"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5fd0a3be0cde0278b5927df8f670a25561eaa597", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5fd0a3be0cde0278b5927df8f670a25561eaa597", "html_url": "https://github.com/rust-lang/rust/commit/5fd0a3be0cde0278b5927df8f670a25561eaa597", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5fd0a3be0cde0278b5927df8f670a25561eaa597/comments", "author": {"login": "graydon", "id": 14097, "node_id": "MDQ6VXNlcjE0MDk3", "avatar_url": "https://avatars.githubusercontent.com/u/14097?v=4", "gravatar_id": "", "url": "https://api.github.com/users/graydon", "html_url": "https://github.com/graydon", "followers_url": "https://api.github.com/users/graydon/followers", "following_url": "https://api.github.com/users/graydon/following{/other_user}", "gists_url": "https://api.github.com/users/graydon/gists{/gist_id}", "starred_url": "https://api.github.com/users/graydon/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/graydon/subscriptions", "organizations_url": "https://api.github.com/users/graydon/orgs", "repos_url": "https://api.github.com/users/graydon/repos", "events_url": "https://api.github.com/users/graydon/events{/privacy}", "received_events_url": "https://api.github.com/users/graydon/received_events", "type": "User", "site_admin": false}, "committer": {"login": "graydon", "id": 14097, "node_id": "MDQ6VXNlcjE0MDk3", "avatar_url": "https://avatars.githubusercontent.com/u/14097?v=4", "gravatar_id": "", "url": "https://api.github.com/users/graydon", "html_url": "https://github.com/graydon", "followers_url": "https://api.github.com/users/graydon/followers", "following_url": "https://api.github.com/users/graydon/following{/other_user}", "gists_url": "https://api.github.com/users/graydon/gists{/gist_id}", "starred_url": "https://api.github.com/users/graydon/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/graydon/subscriptions", "organizations_url": "https://api.github.com/users/graydon/orgs", "repos_url": "https://api.github.com/users/graydon/repos", "events_url": "https://api.github.com/users/graydon/events{/privacy}", "received_events_url": "https://api.github.com/users/graydon/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "884adf38a12abf45afe8f9b33b21d062223fc089", "url": "https://api.github.com/repos/rust-lang/rust/commits/884adf38a12abf45afe8f9b33b21d062223fc089", "html_url": "https://github.com/rust-lang/rust/commit/884adf38a12abf45afe8f9b33b21d062223fc089"}], "stats": {"total": 31, "additions": 30, "deletions": 1}, "files": [{"sha": "6b2e55022c6268e3a7470eb7e7bca300d1e1ed27", "filename": "src/rt/arch/i386/morestack.S", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/5fd0a3be0cde0278b5927df8f670a25561eaa597/src%2Frt%2Farch%2Fi386%2Fmorestack.S", "raw_url": "https://github.com/rust-lang/rust/raw/5fd0a3be0cde0278b5927df8f670a25561eaa597/src%2Frt%2Farch%2Fi386%2Fmorestack.S", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Farch%2Fi386%2Fmorestack.S?ref=5fd0a3be0cde0278b5927df8f670a25561eaa597", "patch": "@@ -150,6 +150,9 @@ MORESTACK:\n \tmovl %ecx, 16(%esp)\n \tmovl %edx, 12(%esp)\n \n+\t// FIXME (1388): it's possible we also need to save/restore some\n+\t// SSE2 registers here, if floats-go-in-regs on x86+SSE2. Unclear.\n+\n \t// FIXME (1226): main is compiled with the split-stack prologue,\n \t// causing it to call __morestack, so we have to jump back out\n \tcalll RUST_GET_TASK"}, {"sha": "3f25f786b6caa5e93470e2e518dfc09acfad42f3", "filename": "src/rt/arch/x86_64/morestack.S", "status": "modified", "additions": 27, "deletions": 1, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/5fd0a3be0cde0278b5927df8f670a25561eaa597/src%2Frt%2Farch%2Fx86_64%2Fmorestack.S", "raw_url": "https://github.com/rust-lang/rust/raw/5fd0a3be0cde0278b5927df8f670a25561eaa597/src%2Frt%2Farch%2Fx86_64%2Fmorestack.S", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Farch%2Fx86_64%2Fmorestack.S?ref=5fd0a3be0cde0278b5927df8f670a25561eaa597", "patch": "@@ -61,6 +61,19 @@ MORESTACK:\n \tpushq\t%r8\n \tpushq\t%r9\n \n+\tpushq $0 // Alignment\n+\tpushq $0 // Alignment\n+\n+\tsubq $128, %rsp\n+\tmovdqa %xmm0,\t (%rsp)\n+\tmovdqa %xmm1,  16(%rsp)\n+\tmovdqa %xmm2,  32(%rsp)\n+\tmovdqa %xmm3,  48(%rsp)\n+\tmovdqa %xmm4,  64(%rsp)\n+\tmovdqa %xmm5,  80(%rsp)\n+\tmovdqa %xmm6,  96(%rsp)\n+\tmovdqa %xmm7, 112(%rsp)\n+\n \t// Calculate the address of the stack arguments.\n \t// We have the base pointer, __morestack's return address,\n \t// and __morestack's caller's return address to skip\n@@ -72,7 +85,7 @@ MORESTACK:\n \tmovq %r11, %rdx // Size of stack arguments\n \tmovq %rax, %rsi // Address of stack arguments\n \tmovq %r10, %rdi // The amount of stack needed\n-\n+        \n #ifdef __APPLE__\n \tcall UPCALL_NEW_STACK\n #endif\n@@ -81,6 +94,19 @@ MORESTACK:\n #endif\n \n \t// Pop the saved arguments\n+\tmovdqa    (%rsp), %xmm0\n+\tmovdqa  16(%rsp), %xmm1\n+\tmovdqa  32(%rsp), %xmm2\n+\tmovdqa  48(%rsp), %xmm3\n+\tmovdqa  64(%rsp), %xmm4\n+\tmovdqa  80(%rsp), %xmm5\n+\tmovdqa  96(%rsp), %xmm6\n+\tmovdqa 112(%rsp), %xmm7\n+\taddq $128, %rsp\n+\n+\tpopq %r9 // Alignment\n+\tpopq %r9 // Alignment\n+\n \tpopq %r9\n \tpopq %r8\n \tpopq %rcx"}]}