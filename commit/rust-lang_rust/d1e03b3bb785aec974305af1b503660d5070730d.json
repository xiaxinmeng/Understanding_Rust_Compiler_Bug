{"sha": "d1e03b3bb785aec974305af1b503660d5070730d", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQxZTAzYjNiYjc4NWFlYzk3NDMwNWFmMWI1MDM2NjBkNTA3MDczMGQ=", "commit": {"author": {"name": "Vadim Chugunov", "email": "vadimcn@gmail.com", "date": "2014-08-08T06:10:48Z"}, "committer": {"name": "Vadim Chugunov", "email": "vadimcn@gmail.com", "date": "2014-08-08T06:11:55Z"}, "message": "Implement Win64 system ABI.", "tree": {"sha": "8e30946928b93439b1cd05bf61d7056fecab566d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8e30946928b93439b1cd05bf61d7056fecab566d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d1e03b3bb785aec974305af1b503660d5070730d", "comment_count": 5, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d1e03b3bb785aec974305af1b503660d5070730d", "html_url": "https://github.com/rust-lang/rust/commit/d1e03b3bb785aec974305af1b503660d5070730d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d1e03b3bb785aec974305af1b503660d5070730d/comments", "author": {"login": "vadimcn", "id": 3203809, "node_id": "MDQ6VXNlcjMyMDM4MDk=", "avatar_url": "https://avatars.githubusercontent.com/u/3203809?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vadimcn", "html_url": "https://github.com/vadimcn", "followers_url": "https://api.github.com/users/vadimcn/followers", "following_url": "https://api.github.com/users/vadimcn/following{/other_user}", "gists_url": "https://api.github.com/users/vadimcn/gists{/gist_id}", "starred_url": "https://api.github.com/users/vadimcn/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vadimcn/subscriptions", "organizations_url": "https://api.github.com/users/vadimcn/orgs", "repos_url": "https://api.github.com/users/vadimcn/repos", "events_url": "https://api.github.com/users/vadimcn/events{/privacy}", "received_events_url": "https://api.github.com/users/vadimcn/received_events", "type": "User", "site_admin": false}, "committer": {"login": "vadimcn", "id": 3203809, "node_id": "MDQ6VXNlcjMyMDM4MDk=", "avatar_url": "https://avatars.githubusercontent.com/u/3203809?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vadimcn", "html_url": "https://github.com/vadimcn", "followers_url": "https://api.github.com/users/vadimcn/followers", "following_url": "https://api.github.com/users/vadimcn/following{/other_user}", "gists_url": "https://api.github.com/users/vadimcn/gists{/gist_id}", "starred_url": "https://api.github.com/users/vadimcn/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vadimcn/subscriptions", "organizations_url": "https://api.github.com/users/vadimcn/orgs", "repos_url": "https://api.github.com/users/vadimcn/repos", "events_url": "https://api.github.com/users/vadimcn/events{/privacy}", "received_events_url": "https://api.github.com/users/vadimcn/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4879ca79240387d18723a324d92c603c5057d342", "url": "https://api.github.com/repos/rust-lang/rust/commits/4879ca79240387d18723a324d92c603c5057d342", "html_url": "https://github.com/rust-lang/rust/commit/4879ca79240387d18723a324d92c603c5057d342"}], "stats": {"total": 74, "additions": 73, "deletions": 1}, "files": [{"sha": "52461e3fdcb23d10fc23daf311e5dea74aa69b4f", "filename": "src/librustc/middle/trans/cabi.rs", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/d1e03b3bb785aec974305af1b503660d5070730d/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcabi.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d1e03b3bb785aec974305af1b503660d5070730d/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcabi.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcabi.rs?ref=d1e03b3bb785aec974305af1b503660d5070730d", "patch": "@@ -13,10 +13,12 @@ use std::option;\n use middle::trans::context::CrateContext;\n use middle::trans::cabi_x86;\n use middle::trans::cabi_x86_64;\n+use middle::trans::cabi_x86_win64;\n use middle::trans::cabi_arm;\n use middle::trans::cabi_mips;\n use middle::trans::type_::Type;\n use syntax::abi::{X86, X86_64, Arm, Mips, Mipsel};\n+use syntax::abi::{OsWin32};\n \n #[deriving(Clone, PartialEq)]\n pub enum ArgKind {\n@@ -107,7 +109,12 @@ pub fn compute_abi_info(ccx: &CrateContext,\n                         ret_def: bool) -> FnType {\n     match ccx.sess().targ_cfg.arch {\n         X86 => cabi_x86::compute_abi_info(ccx, atys, rty, ret_def),\n-        X86_64 => cabi_x86_64::compute_abi_info(ccx, atys, rty, ret_def),\n+        X86_64 =>\n+            if ccx.sess().targ_cfg.os == OsWin32 {\n+                cabi_x86_win64::compute_abi_info(ccx, atys, rty, ret_def)\n+            } else {\n+                cabi_x86_64::compute_abi_info(ccx, atys, rty, ret_def)\n+            },\n         Arm => cabi_arm::compute_abi_info(ccx, atys, rty, ret_def),\n         Mips => cabi_mips::compute_abi_info(ccx, atys, rty, ret_def),\n         Mipsel => cabi_mips::compute_abi_info(ccx, atys, rty, ret_def),"}, {"sha": "e036ab6675d60a860cad92eb23c54bf126036a97", "filename": "src/librustc/middle/trans/cabi_x86_win64.rs", "status": "added", "additions": 64, "deletions": 0, "changes": 64, "blob_url": "https://github.com/rust-lang/rust/blob/d1e03b3bb785aec974305af1b503660d5070730d/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcabi_x86_win64.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d1e03b3bb785aec974305af1b503660d5070730d/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcabi_x86_win64.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcabi_x86_win64.rs?ref=d1e03b3bb785aec974305af1b503660d5070730d", "patch": "@@ -0,0 +1,64 @@\n+// Copyright 2013 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+use llvm::*;\n+use super::cabi::*;\n+use super::common::*;\n+use super::machine::*;\n+use middle::trans::type_::Type;\n+\n+// Win64 ABI: http://msdn.microsoft.com/en-us/library/zthk2dkh.aspx\n+\n+pub fn compute_abi_info(ccx: &CrateContext,\n+                          atys: &[Type],\n+                          rty: Type,\n+                          ret_def: bool) -> FnType {\n+    let mut arg_tys = Vec::new();\n+\n+    let ret_ty;\n+    if !ret_def {\n+        ret_ty = ArgType::direct(Type::void(ccx), None, None, None);\n+    } else if rty.kind() == Struct {\n+        ret_ty = match llsize_of_alloc(ccx, rty) {\n+            1 => ArgType::direct(rty, Some(Type::i8(ccx)), None, None),\n+            2 => ArgType::direct(rty, Some(Type::i16(ccx)), None, None),\n+            4 => ArgType::direct(rty, Some(Type::i32(ccx)), None, None),\n+            8 => ArgType::direct(rty, Some(Type::i64(ccx)), None, None),\n+            _ => ArgType::indirect(rty, Some(StructRetAttribute))\n+        };\n+    } else {\n+        let attr = if rty == Type::i1(ccx) { Some(ZExtAttribute) } else { None };\n+        ret_ty = ArgType::direct(rty, None, None, attr);\n+    }\n+\n+    for &t in atys.iter() {\n+        let ty = match t.kind() {\n+            Struct => {\n+                match llsize_of_alloc(ccx, t) {\n+                    1 => ArgType::direct(rty, Some(Type::i8(ccx)), None, None),\n+                    2 => ArgType::direct(rty, Some(Type::i16(ccx)), None, None),\n+                    4 => ArgType::direct(rty, Some(Type::i32(ccx)), None, None),\n+                    8 => ArgType::direct(rty, Some(Type::i64(ccx)), None, None),\n+                    _ => ArgType::indirect(t, Some(ByValAttribute))\n+                }\n+            }\n+            _ => {\n+                let attr = if t == Type::i1(ccx) { Some(ZExtAttribute) } else { None };\n+                ArgType::direct(t, None, None, attr)\n+            }\n+        };\n+        arg_tys.push(ty);\n+    }\n+\n+    return FnType {\n+        arg_tys: arg_tys,\n+        ret_ty: ret_ty,\n+    };\n+}"}, {"sha": "f95825c96db5192479f8a84e4d34c3a4a652d8e7", "filename": "src/librustc/middle/trans/mod.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d1e03b3bb785aec974305af1b503660d5070730d/src%2Flibrustc%2Fmiddle%2Ftrans%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d1e03b3bb785aec974305af1b503660d5070730d/src%2Flibrustc%2Fmiddle%2Ftrans%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fmod.rs?ref=d1e03b3bb785aec974305af1b503660d5070730d", "patch": "@@ -31,6 +31,7 @@ pub mod meth;\n pub mod cabi;\n pub mod cabi_x86;\n pub mod cabi_x86_64;\n+pub mod cabi_x86_win64;\n pub mod cabi_arm;\n pub mod cabi_mips;\n pub mod foreign;"}]}