{"sha": "3f916bd3029262e2270dfbafb9ab045927499abd", "node_id": "MDY6Q29tbWl0NzI0NzEyOjNmOTE2YmQzMDI5MjYyZTIyNzBkZmJhZmI5YWIwNDU5Mjc0OTlhYmQ=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-12-30T19:38:24Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-12-30T19:38:24Z"}, "message": "Auto merge of #47063 - kennytm:gate-tools-on-update, r=alexcrichton\n\nRequires tools to test-pass if the corresponding submodule is updated.\n\nFollow up of #46554. Breaking a tool would not stop bors from accepting a merge, but this also means when we intend to *fix* a tool but failed, bors will *still* accept the PR. This behavior is not helpful to the tool maintainers.\n\nThis PR attempts to fix this by rejecting the tool-update merge when a tool failed. It recognizes a PR as \"tool-updating\" when the corresponding submodule is changed, compared with the previous commit.", "tree": {"sha": "ddaa1b31316d7be18a21a87dc804d0ffd15cf174", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ddaa1b31316d7be18a21a87dc804d0ffd15cf174"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3f916bd3029262e2270dfbafb9ab045927499abd", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3f916bd3029262e2270dfbafb9ab045927499abd", "html_url": "https://github.com/rust-lang/rust/commit/3f916bd3029262e2270dfbafb9ab045927499abd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3f916bd3029262e2270dfbafb9ab045927499abd/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0296b7165bfa633b06a3af6e690c4ccd33d0ea28", "url": "https://api.github.com/repos/rust-lang/rust/commits/0296b7165bfa633b06a3af6e690c4ccd33d0ea28", "html_url": "https://github.com/rust-lang/rust/commit/0296b7165bfa633b06a3af6e690c4ccd33d0ea28"}, {"sha": "8ed16fe47a421781752272f4bd1e11eb5d3c9839", "url": "https://api.github.com/repos/rust-lang/rust/commits/8ed16fe47a421781752272f4bd1e11eb5d3c9839", "html_url": "https://github.com/rust-lang/rust/commit/8ed16fe47a421781752272f4bd1e11eb5d3c9839"}], "stats": {"total": 28, "additions": 25, "deletions": 3}, "files": [{"sha": "d955c3ac3c3976aebc1e69c2adaa9ae545296432", "filename": ".travis.yml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/3f916bd3029262e2270dfbafb9ab045927499abd/.travis.yml", "raw_url": "https://github.com/rust-lang/rust/raw/3f916bd3029262e2270dfbafb9ab045927499abd/.travis.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.travis.yml?ref=3f916bd3029262e2270dfbafb9ab045927499abd", "patch": "@@ -5,7 +5,7 @@ services:\n   - docker\n \n git:\n-  depth: 1\n+  depth: 2\n   submodules: false\n \n matrix:"}, {"sha": "1a186c080ce0d7a9aa74ae2090e1a8a46b327e95", "filename": "appveyor.yml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/3f916bd3029262e2270dfbafb9ab045927499abd/appveyor.yml", "raw_url": "https://github.com/rust-lang/rust/raw/3f916bd3029262e2270dfbafb9ab045927499abd/appveyor.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/appveyor.yml?ref=3f916bd3029262e2270dfbafb9ab045927499abd", "patch": "@@ -96,7 +96,7 @@ environment:\n matrix:\n   fast_finish: true\n \n-clone_depth: 1\n+clone_depth: 2\n build: false\n \n install:"}, {"sha": "b9268fe62ed06b44825711aa1f6742fcb2f4fa51", "filename": "src/ci/docker/x86_64-gnu-tools/checktools.sh", "status": "modified", "additions": 23, "deletions": 1, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/3f916bd3029262e2270dfbafb9ab045927499abd/src%2Fci%2Fdocker%2Fx86_64-gnu-tools%2Fchecktools.sh", "raw_url": "https://github.com/rust-lang/rust/raw/3f916bd3029262e2270dfbafb9ab045927499abd/src%2Fci%2Fdocker%2Fx86_64-gnu-tools%2Fchecktools.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fx86_64-gnu-tools%2Fchecktools.sh?ref=3f916bd3029262e2270dfbafb9ab045927499abd", "patch": "@@ -16,6 +16,7 @@ X_PY=\"$1\"\n TOOLSTATE_FILE=\"$(realpath $2)\"\n OS=\"$3\"\n COMMIT=\"$(git rev-parse HEAD)\"\n+CHANGED_FILES=\"$(git diff --name-status HEAD HEAD^)\"\n \n touch \"$TOOLSTATE_FILE\"\n \n@@ -29,7 +30,28 @@ set -e\n \n cat \"$TOOLSTATE_FILE\"\n \n-if [ \"$RUST_RELEASE_CHANNEL\" = nightly ]; then\n+# If this PR is intended to update one of these tools, do not let the build pass\n+# when they do not test-pass.\n+for TOOL in rls rustfmt miri clippy; do\n+    echo \"Verifying status of $TOOL...\"\n+    if echo \"$CHANGED_FILES\" | grep -q \"^M[[:blank:]]src/tools/$TOOL$\"; then\n+        echo \"This PR updated 'src/tools/$TOOL', verifying if status is 'test-pass'...\"\n+        if grep -vq '\"'\"$TOOL\"'[^\"]*\":\"test-pass\"' \"$TOOLSTATE_FILE\"; then\n+            echo\n+            echo \"\u26a0\ufe0f We detected that this PR updated '$TOOL', but its tests failed.\"\n+            echo\n+            echo \"If you do intend to update '$TOOL', please check the error messages above and\"\n+            echo \"commit another update.\"\n+            echo\n+            echo \"If you do NOT intend to update '$TOOL', please ensure you did not accidentally\"\n+            echo \"change the submodule at 'src/tools/$TOOL'. You may ask your reviewer for the\"\n+            echo \"proper steps.\"\n+            exit 3\n+        fi\n+    fi\n+done\n+\n+if [ \"$RUST_RELEASE_CHANNEL\" = nightly -a -n \"${TOOLSTATE_REPO_ACCESS_TOKEN+is_set}\" ]; then\n     . \"$(dirname $0)/repo.sh\"\n     MESSAGE_FILE=$(mktemp -t msg.XXXXXX)\n     echo \"($OS CI update)\" > \"$MESSAGE_FILE\""}]}