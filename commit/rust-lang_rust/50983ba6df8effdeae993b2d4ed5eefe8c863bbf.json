{"sha": "50983ba6df8effdeae993b2d4ed5eefe8c863bbf", "node_id": "MDY6Q29tbWl0NzI0NzEyOjUwOTgzYmE2ZGY4ZWZmZGVhZTk5M2IyZDRlZDVlZWZlOGM4NjNiYmY=", "commit": {"author": {"name": "Noah Lev", "email": "camelidcamel@gmail.com", "date": "2021-09-01T21:59:07Z"}, "committer": {"name": "Noah Lev", "email": "camelidcamel@gmail.com", "date": "2021-09-01T22:04:50Z"}, "message": "rustdoc: Don't panic on ambiguous inherent associated types\n\nInstead, return `Type::Infer` since compilation should fail anyway.\nThat's how rustdoc handles `hir::TyKind::Err`s, so this just extends\nthat behavior to `ty::Err`s when analyzing associated types.\n\nFor some reason, the error is printed twice with rustdoc (though only\nonce with rustc). I'm not sure why that is, but it's better than\npanicking.\n\nThis commit also makes rustdoc fail early in the non-projection,\nnon-error case, instead of returning a `Res::Err` that would likely\ncause rustdoc to panic later on. This change is originally from #88379.", "tree": {"sha": "effe17167cf4f518654b7febf43ac757d69a8b37", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/effe17167cf4f518654b7febf43ac757d69a8b37"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/50983ba6df8effdeae993b2d4ed5eefe8c863bbf", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/50983ba6df8effdeae993b2d4ed5eefe8c863bbf", "html_url": "https://github.com/rust-lang/rust/commit/50983ba6df8effdeae993b2d4ed5eefe8c863bbf", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/50983ba6df8effdeae993b2d4ed5eefe8c863bbf/comments", "author": {"login": "camelid", "id": 37223377, "node_id": "MDQ6VXNlcjM3MjIzMzc3", "avatar_url": "https://avatars.githubusercontent.com/u/37223377?v=4", "gravatar_id": "", "url": "https://api.github.com/users/camelid", "html_url": "https://github.com/camelid", "followers_url": "https://api.github.com/users/camelid/followers", "following_url": "https://api.github.com/users/camelid/following{/other_user}", "gists_url": "https://api.github.com/users/camelid/gists{/gist_id}", "starred_url": "https://api.github.com/users/camelid/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/camelid/subscriptions", "organizations_url": "https://api.github.com/users/camelid/orgs", "repos_url": "https://api.github.com/users/camelid/repos", "events_url": "https://api.github.com/users/camelid/events{/privacy}", "received_events_url": "https://api.github.com/users/camelid/received_events", "type": "User", "site_admin": false}, "committer": {"login": "camelid", "id": 37223377, "node_id": "MDQ6VXNlcjM3MjIzMzc3", "avatar_url": "https://avatars.githubusercontent.com/u/37223377?v=4", "gravatar_id": "", "url": "https://api.github.com/users/camelid", "html_url": "https://github.com/camelid", "followers_url": "https://api.github.com/users/camelid/followers", "following_url": "https://api.github.com/users/camelid/following{/other_user}", "gists_url": "https://api.github.com/users/camelid/gists{/gist_id}", "starred_url": "https://api.github.com/users/camelid/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/camelid/subscriptions", "organizations_url": "https://api.github.com/users/camelid/orgs", "repos_url": "https://api.github.com/users/camelid/repos", "events_url": "https://api.github.com/users/camelid/events{/privacy}", "received_events_url": "https://api.github.com/users/camelid/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "50171c310cd15e1b2d3723766ce64e2e4d6696fc", "url": "https://api.github.com/repos/rust-lang/rust/commits/50171c310cd15e1b2d3723766ce64e2e4d6696fc", "html_url": "https://github.com/rust-lang/rust/commit/50171c310cd15e1b2d3723766ce64e2e4d6696fc"}], "stats": {"total": 42, "additions": 38, "deletions": 4}, "files": [{"sha": "d59c6bfdd36fa4d0ce8787c750e319bccc3f71f5", "filename": "src/librustdoc/clean/mod.rs", "status": "modified", "additions": 6, "deletions": 4, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/50983ba6df8effdeae993b2d4ed5eefe8c863bbf/src%2Flibrustdoc%2Fclean%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/50983ba6df8effdeae993b2d4ed5eefe8c863bbf/src%2Flibrustdoc%2Fclean%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Fmod.rs?ref=50983ba6df8effdeae993b2d4ed5eefe8c863bbf", "patch": "@@ -1311,10 +1311,11 @@ fn clean_qpath(hir_ty: &hir::Ty<'_>, cx: &mut DocContext<'_>) -> Type {\n         }\n         hir::QPath::TypeRelative(ref qself, ref segment) => {\n             let ty = hir_ty_to_ty(cx.tcx, hir_ty);\n-            let res = if let ty::Projection(proj) = ty.kind() {\n-                Res::Def(DefKind::Trait, proj.trait_ref(cx.tcx).def_id)\n-            } else {\n-                Res::Err\n+            let res = match ty.kind() {\n+                ty::Projection(proj) => Res::Def(DefKind::Trait, proj.trait_ref(cx.tcx).def_id),\n+                // Rustdoc handles `ty::Error`s by turning them into `Type::Infer`s.\n+                ty::Error(_) => return Type::Infer,\n+                _ => bug!(\"clean: expected associated type, found `{:?}`\", ty),\n             };\n             let trait_path = hir::Path { span, res, segments: &[] }.clean(cx);\n             Type::QPath {\n@@ -1379,6 +1380,7 @@ impl Clean<Type> for hir::Ty<'_> {\n                 DynTrait(bounds, lifetime)\n             }\n             TyKind::BareFn(ref barefn) => BareFunction(Box::new(barefn.clean(cx))),\n+            // Rustdoc handles `TyKind::Err`s by turning them into `Type::Infer`s.\n             TyKind::Infer | TyKind::Err => Infer,\n             TyKind::Typeof(..) => panic!(\"unimplemented type {:?}\", self.kind),\n         }"}, {"sha": "3ad56aebc21c580b28a4638d53dde913c289fa43", "filename": "src/test/rustdoc-ui/ambiguous-inherent-assoc-ty.rs", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/50983ba6df8effdeae993b2d4ed5eefe8c863bbf/src%2Ftest%2Frustdoc-ui%2Fambiguous-inherent-assoc-ty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/50983ba6df8effdeae993b2d4ed5eefe8c863bbf/src%2Ftest%2Frustdoc-ui%2Fambiguous-inherent-assoc-ty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fambiguous-inherent-assoc-ty.rs?ref=50983ba6df8effdeae993b2d4ed5eefe8c863bbf", "patch": "@@ -0,0 +1,17 @@\n+// This test ensures that rustdoc does not panic on inherented associated types\n+// that are referred to without fully-qualified syntax.\n+\n+#![feature(inherent_associated_types)]\n+#![allow(incomplete_features)]\n+\n+pub struct Struct;\n+\n+impl Struct {\n+    pub type AssocTy = usize;\n+    pub const AssocConst: Self::AssocTy = 42;\n+    //~^ ERROR ambiguous associated type\n+    //~| HELP use fully-qualified syntax\n+    // FIXME: for some reason, the error is shown twice with rustdoc but only once with rustc\n+    //~| ERROR ambiguous associated type\n+    //~| HELP use fully-qualified syntax\n+}"}, {"sha": "b963b722f66201708db4650dba2ad194c31b2597", "filename": "src/test/rustdoc-ui/ambiguous-inherent-assoc-ty.stderr", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/50983ba6df8effdeae993b2d4ed5eefe8c863bbf/src%2Ftest%2Frustdoc-ui%2Fambiguous-inherent-assoc-ty.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/50983ba6df8effdeae993b2d4ed5eefe8c863bbf/src%2Ftest%2Frustdoc-ui%2Fambiguous-inherent-assoc-ty.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fambiguous-inherent-assoc-ty.stderr?ref=50983ba6df8effdeae993b2d4ed5eefe8c863bbf", "patch": "@@ -0,0 +1,15 @@\n+error[E0223]: ambiguous associated type\n+  --> $DIR/ambiguous-inherent-assoc-ty.rs:11:27\n+   |\n+LL |     pub const AssocConst: Self::AssocTy = 42;\n+   |                           ^^^^^^^^^^^^^ help: use fully-qualified syntax: `<Struct as Trait>::AssocTy`\n+\n+error[E0223]: ambiguous associated type\n+  --> $DIR/ambiguous-inherent-assoc-ty.rs:11:27\n+   |\n+LL |     pub const AssocConst: Self::AssocTy = 42;\n+   |                           ^^^^^^^^^^^^^ help: use fully-qualified syntax: `<Struct as Trait>::AssocTy`\n+\n+error: aborting due to 2 previous errors\n+\n+For more information about this error, try `rustc --explain E0223`."}]}