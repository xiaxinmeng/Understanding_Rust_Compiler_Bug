{"sha": "de4ada22d484950a6f416f25c85566ea9d1830a9", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRlNGFkYTIyZDQ4NDk1MGE2ZjQxNmYyNWM4NTU2NmVhOWQxODMwYTk=", "commit": {"author": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2020-11-28T21:55:34Z"}, "committer": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2020-11-29T19:54:17Z"}, "message": "Support self in reference search", "tree": {"sha": "1cdc2df44c2cece831bff7f0fd3a500ce5880e41", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1cdc2df44c2cece831bff7f0fd3a500ce5880e41"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/de4ada22d484950a6f416f25c85566ea9d1830a9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/de4ada22d484950a6f416f25c85566ea9d1830a9", "html_url": "https://github.com/rust-lang/rust/commit/de4ada22d484950a6f416f25c85566ea9d1830a9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/de4ada22d484950a6f416f25c85566ea9d1830a9/comments", "author": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a6f26ded0037a3efb5625ac3482a2f4ec9eb01a3", "url": "https://api.github.com/repos/rust-lang/rust/commits/a6f26ded0037a3efb5625ac3482a2f4ec9eb01a3", "html_url": "https://github.com/rust-lang/rust/commit/a6f26ded0037a3efb5625ac3482a2f4ec9eb01a3"}], "stats": {"total": 104, "additions": 103, "deletions": 1}, "files": [{"sha": "7395b81bd291f802a0c7ce2afcf2d3f462792e24", "filename": "crates/ide/src/references.rs", "status": "modified", "additions": 102, "deletions": 1, "changes": 103, "blob_url": "https://github.com/rust-lang/rust/blob/de4ada22d484950a6f416f25c85566ea9d1830a9/crates%2Fide%2Fsrc%2Freferences.rs", "raw_url": "https://github.com/rust-lang/rust/raw/de4ada22d484950a6f416f25c85566ea9d1830a9/crates%2Fide%2Fsrc%2Freferences.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Freferences.rs?ref=de4ada22d484950a6f416f25c85566ea9d1830a9", "patch": "@@ -21,7 +21,7 @@ use ide_db::{\n use syntax::{\n     algo::find_node_at_offset,\n     ast::{self, NameOwner},\n-    AstNode, SyntaxKind, SyntaxNode, TextRange, TokenAtOffset,\n+    match_ast, AstNode, SyntaxKind, SyntaxNode, TextRange, TokenAtOffset,\n };\n \n use crate::{display::TryToNav, FilePosition, FileRange, NavigationTarget, RangeInfo};\n@@ -89,6 +89,10 @@ pub(crate) fn find_all_refs(\n     let _p = profile::span(\"find_all_refs\");\n     let syntax = sema.parse(position.file_id).syntax().clone();\n \n+    if let Some(res) = try_find_self_references(&syntax, position) {\n+        return Some(res);\n+    }\n+\n     let (opt_name, search_kind) = if let Some(name) =\n         get_struct_def_name_for_struct_literal_search(&sema, &syntax, position)\n     {\n@@ -194,6 +198,77 @@ fn get_struct_def_name_for_struct_literal_search(\n     None\n }\n \n+fn try_find_self_references(\n+    syntax: &SyntaxNode,\n+    position: FilePosition,\n+) -> Option<RangeInfo<ReferenceSearchResult>> {\n+    let self_token =\n+        syntax.token_at_offset(position.offset).find(|t| t.kind() == SyntaxKind::SELF_KW)?;\n+    let parent = self_token.parent();\n+    match_ast! {\n+        match parent {\n+            ast::SelfParam(it) => (),\n+            ast::PathSegment(segment) => {\n+                segment.self_token()?;\n+                let path = segment.parent_path();\n+                if path.qualifier().is_some() && !ast::PathExpr::can_cast(path.syntax().parent()?.kind()) {\n+                    return None;\n+                }\n+            },\n+            _ => return None,\n+        }\n+    };\n+    let function = parent.ancestors().find_map(ast::Fn::cast)?;\n+    let self_param = function.param_list()?.self_param()?;\n+    let param_self_token = self_param.self_token()?;\n+\n+    let declaration = Declaration {\n+        nav: NavigationTarget {\n+            file_id: position.file_id,\n+            full_range: self_param.syntax().text_range(),\n+            focus_range: Some(param_self_token.text_range()),\n+            name: param_self_token.text().clone(),\n+            kind: param_self_token.kind(),\n+            container_name: None,\n+            description: None,\n+            docs: None,\n+        },\n+        kind: ReferenceKind::SelfKw,\n+        access: Some(if self_param.mut_token().is_some() {\n+            ReferenceAccess::Write\n+        } else {\n+            ReferenceAccess::Read\n+        }),\n+    };\n+    let references = function\n+        .body()\n+        .map(|body| {\n+            body.syntax()\n+                .descendants()\n+                .filter_map(ast::PathExpr::cast)\n+                .filter_map(|expr| {\n+                    let path = expr.path()?;\n+                    if path.qualifier().is_none() {\n+                        path.segment()?.self_token()\n+                    } else {\n+                        None\n+                    }\n+                })\n+                .map(|token| Reference {\n+                    file_range: FileRange { file_id: position.file_id, range: token.text_range() },\n+                    kind: ReferenceKind::SelfKw,\n+                    access: declaration.access, // FIXME: properly check access kind here instead of copying it from the declaration\n+                })\n+                .collect()\n+        })\n+        .unwrap_or_default();\n+\n+    Some(RangeInfo::new(\n+        param_self_token.text_range(),\n+        ReferenceSearchResult { declaration, references },\n+    ))\n+}\n+\n #[cfg(test)]\n mod tests {\n     use expect_test::{expect, Expect};\n@@ -762,6 +837,32 @@ fn f() -> m::En {\n         );\n     }\n \n+    #[test]\n+    fn test_find_self_refs() {\n+        check(\n+            r#\"\n+struct Foo { bar: i32 }\n+\n+impl Foo {\n+    fn foo(self) {\n+        let x = self<|>.bar;\n+        if true {\n+            let _ = match () {\n+                () => self,\n+            };\n+        }\n+    }\n+}\n+\"#,\n+            expect![[r#\"\n+                self SELF_KW FileId(0) 47..51 47..51 SelfKw Read\n+\n+                FileId(0) 71..75 SelfKw Read\n+                FileId(0) 152..156 SelfKw Read\n+            \"#]],\n+        );\n+    }\n+\n     fn check(ra_fixture: &str, expect: Expect) {\n         check_with_scope(ra_fixture, None, expect)\n     }"}, {"sha": "607185ca97f4a1dcbfda06308cec886bb611fc62", "filename": "crates/ide_db/src/search.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/de4ada22d484950a6f416f25c85566ea9d1830a9/crates%2Fide_db%2Fsrc%2Fsearch.rs", "raw_url": "https://github.com/rust-lang/rust/raw/de4ada22d484950a6f416f25c85566ea9d1830a9/crates%2Fide_db%2Fsrc%2Fsearch.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_db%2Fsrc%2Fsearch.rs?ref=de4ada22d484950a6f416f25c85566ea9d1830a9", "patch": "@@ -31,6 +31,7 @@ pub enum ReferenceKind {\n     FieldShorthandForLocal,\n     StructLiteral,\n     RecordFieldExprOrPat,\n+    SelfKw,\n     Other,\n }\n "}]}