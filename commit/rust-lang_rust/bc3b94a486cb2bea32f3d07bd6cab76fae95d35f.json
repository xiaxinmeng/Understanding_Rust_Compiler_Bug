{"sha": "bc3b94a486cb2bea32f3d07bd6cab76fae95d35f", "node_id": "C_kwDOAAsO6NoAKGJjM2I5NGE0ODZjYjJiZWEzMmYzZDA3YmQ2Y2FiNzZmYWU5NWQzNWY", "commit": {"author": {"name": "Dylan DPC", "email": "99973273+Dylan-DPC@users.noreply.github.com", "date": "2023-05-17T05:43:57Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-05-17T05:43:57Z"}, "message": "Rollup merge of #111649 - Nilstrieb:derive-const-param-ty, r=BoxyUwU\n\nAdd derive for `core::marker::ConstParamTy`\n\nThis makes it easier to implement it for a type, just like `Copy`.\n\n`@BoxyUwU` half asked me to add it", "tree": {"sha": "3bd0d8a5ebe2f3544defd6e2417b51aea49b9b70", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3bd0d8a5ebe2f3544defd6e2417b51aea49b9b70"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bc3b94a486cb2bea32f3d07bd6cab76fae95d35f", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkZGmdCRBK7hj4Ov3rIwAAirsIAC2EmDYuAQSEet8DjtLdT5gz\nwcVzOKHSQiyIpm02Y5ip4t8bNqgZ+HF/3o55+f8fu/rRIIuI1wXZPuFLP2weRGuw\ng2nYEXyakzjsv3L65EZgYjrMIUBbrvj5CgZSj6B0NZKJ1CPo7RlAbOQdMIt3x5Ej\n4E31CbCMJ1uULTX3X2E2XiB6wJU+z2FKoeJbZCB3X0aZ+nGj+55cYEeASn3SNc04\nsRrbNUnjf/zz/HQP/7rFNrpEk1Z7bwEWZFXvfWyp+hdzUu0yODWmq3mK5wKDgxwq\nx30NWPoFsZiVfb4/dGA0ytLeMOyrZhpbfaEV7BBMTXGa8jGYTCwixvW/Hy1a/Ck=\n=KX/+\n-----END PGP SIGNATURE-----\n", "payload": "tree 3bd0d8a5ebe2f3544defd6e2417b51aea49b9b70\nparent e7176dbfd846a6f54407d85f328882ed6ff598f5\nparent 0336dd132b50af57389aa222793aff3c38b88daf\nauthor Dylan DPC <99973273+Dylan-DPC@users.noreply.github.com> 1684302237 +0530\ncommitter GitHub <noreply@github.com> 1684302237 +0530\n\nRollup merge of #111649 - Nilstrieb:derive-const-param-ty, r=BoxyUwU\n\nAdd derive for `core::marker::ConstParamTy`\n\nThis makes it easier to implement it for a type, just like `Copy`.\n\n`@BoxyUwU` half asked me to add it\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bc3b94a486cb2bea32f3d07bd6cab76fae95d35f", "html_url": "https://github.com/rust-lang/rust/commit/bc3b94a486cb2bea32f3d07bd6cab76fae95d35f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bc3b94a486cb2bea32f3d07bd6cab76fae95d35f/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e7176dbfd846a6f54407d85f328882ed6ff598f5", "url": "https://api.github.com/repos/rust-lang/rust/commits/e7176dbfd846a6f54407d85f328882ed6ff598f5", "html_url": "https://github.com/rust-lang/rust/commit/e7176dbfd846a6f54407d85f328882ed6ff598f5"}, {"sha": "0336dd132b50af57389aa222793aff3c38b88daf", "url": "https://api.github.com/repos/rust-lang/rust/commits/0336dd132b50af57389aa222793aff3c38b88daf", "html_url": "https://github.com/rust-lang/rust/commit/0336dd132b50af57389aa222793aff3c38b88daf"}], "stats": {"total": 117, "additions": 115, "deletions": 2}, "files": [{"sha": "2c8e6f99c6739a1787ecc43d6527b7c215852fff", "filename": "compiler/rustc_builtin_macros/src/deriving/bounds.rs", "status": "modified", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/bc3b94a486cb2bea32f3d07bd6cab76fae95d35f/compiler%2Frustc_builtin_macros%2Fsrc%2Fderiving%2Fbounds.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bc3b94a486cb2bea32f3d07bd6cab76fae95d35f/compiler%2Frustc_builtin_macros%2Fsrc%2Fderiving%2Fbounds.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_builtin_macros%2Fsrc%2Fderiving%2Fbounds.rs?ref=bc3b94a486cb2bea32f3d07bd6cab76fae95d35f", "patch": "@@ -27,3 +27,26 @@ pub fn expand_deriving_copy(\n \n     trait_def.expand(cx, mitem, item, push);\n }\n+\n+pub fn expand_deriving_const_param_ty(\n+    cx: &mut ExtCtxt<'_>,\n+    span: Span,\n+    mitem: &MetaItem,\n+    item: &Annotatable,\n+    push: &mut dyn FnMut(Annotatable),\n+    is_const: bool,\n+) {\n+    let trait_def = TraitDef {\n+        span,\n+        path: path_std!(marker::ConstParamTy),\n+        skip_path_as_bound: false,\n+        needs_copy_as_bound_if_packed: false,\n+        additional_bounds: Vec::new(),\n+        supports_unions: false,\n+        methods: Vec::new(),\n+        associated_types: Vec::new(),\n+        is_const,\n+    };\n+\n+    trait_def.expand(cx, mitem, item, push);\n+}"}, {"sha": "ebf1448f55c9985818089ee8dd9e71a31d7781dd", "filename": "compiler/rustc_builtin_macros/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/bc3b94a486cb2bea32f3d07bd6cab76fae95d35f/compiler%2Frustc_builtin_macros%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bc3b94a486cb2bea32f3d07bd6cab76fae95d35f/compiler%2Frustc_builtin_macros%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_builtin_macros%2Fsrc%2Flib.rs?ref=bc3b94a486cb2bea32f3d07bd6cab76fae95d35f", "patch": "@@ -115,6 +115,7 @@ pub fn register_builtin_macros(resolver: &mut dyn ResolverExpand) {\n     register_derive! {\n         Clone: clone::expand_deriving_clone,\n         Copy: bounds::expand_deriving_copy,\n+        ConstParamTy: bounds::expand_deriving_const_param_ty,\n         Debug: debug::expand_deriving_debug,\n         Default: default::expand_deriving_default,\n         Eq: eq::expand_deriving_eq,"}, {"sha": "e43eddd8e6b16fbaf6294c5e4dcee316748cf84d", "filename": "compiler/rustc_span/src/symbol.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/bc3b94a486cb2bea32f3d07bd6cab76fae95d35f/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bc3b94a486cb2bea32f3d07bd6cab76fae95d35f/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs?ref=bc3b94a486cb2bea32f3d07bd6cab76fae95d35f", "patch": "@@ -164,6 +164,7 @@ symbols! {\n         Capture,\n         Center,\n         Clone,\n+        ConstParamTy,\n         Context,\n         Continue,\n         Copy,"}, {"sha": "ca45683d3d6b5c8a0b1c4f484be7829ebc2792ec", "filename": "library/core/src/marker.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/bc3b94a486cb2bea32f3d07bd6cab76fae95d35f/library%2Fcore%2Fsrc%2Fmarker.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bc3b94a486cb2bea32f3d07bd6cab76fae95d35f/library%2Fcore%2Fsrc%2Fmarker.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fmarker.rs?ref=bc3b94a486cb2bea32f3d07bd6cab76fae95d35f", "patch": "@@ -986,6 +986,14 @@ pub trait PointerLike {}\n #[rustc_on_unimplemented(message = \"`{Self}` can't be used as a const parameter type\")]\n pub trait ConstParamTy: StructuralEq {}\n \n+/// Derive macro generating an impl of the trait `Copy`.\n+#[rustc_builtin_macro]\n+#[unstable(feature = \"adt_const_params\", issue = \"95174\")]\n+#[cfg(not(bootstrap))]\n+pub macro ConstParamTy($item:item) {\n+    /* compiler built-in */\n+}\n+\n // FIXME(generic_const_parameter_types): handle `ty::FnDef`/`ty::Closure`\n // FIXME(generic_const_parameter_types): handle `ty::Tuple`\n marker_impls! {"}, {"sha": "87ae83dd9660364cc6e58b1267a026caa6c8521f", "filename": "tests/ui/const-generics/adt_const_params/const_param_ty_good.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/bc3b94a486cb2bea32f3d07bd6cab76fae95d35f/tests%2Fui%2Fconst-generics%2Fadt_const_params%2Fconst_param_ty_good.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bc3b94a486cb2bea32f3d07bd6cab76fae95d35f/tests%2Fui%2Fconst-generics%2Fadt_const_params%2Fconst_param_ty_good.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fconst-generics%2Fadt_const_params%2Fconst_param_ty_good.rs?ref=bc3b94a486cb2bea32f3d07bd6cab76fae95d35f", "patch": "@@ -11,6 +11,13 @@ struct S<T> {\n \n impl<T: ConstParamTy> ConstParamTy for S<T> {}\n \n+#[derive(PartialEq, Eq, ConstParamTy)]\n+struct D<T> {\n+    field: u8,\n+    gen: T,\n+}\n+\n+\n fn check<T: ConstParamTy + ?Sized>() {}\n \n fn main() {\n@@ -39,5 +46,8 @@ fn main() {\n     check::<S<u8>>();\n     check::<S<[&[bool]; 8]>>();\n \n+    check::<D<u8>>();\n+    check::<D<[&[bool]; 8]>>();\n+\n     // FIXME: test tuples\n }"}, {"sha": "74283a37afcaf071d33dbefdf770e789a9be39c1", "filename": "tests/ui/const-generics/adt_const_params/const_param_ty_impl_bad_field.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/bc3b94a486cb2bea32f3d07bd6cab76fae95d35f/tests%2Fui%2Fconst-generics%2Fadt_const_params%2Fconst_param_ty_impl_bad_field.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bc3b94a486cb2bea32f3d07bd6cab76fae95d35f/tests%2Fui%2Fconst-generics%2Fadt_const_params%2Fconst_param_ty_impl_bad_field.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fconst-generics%2Fadt_const_params%2Fconst_param_ty_impl_bad_field.rs?ref=bc3b94a486cb2bea32f3d07bd6cab76fae95d35f", "patch": "@@ -10,4 +10,8 @@ struct CantParam(NotParam);\n impl std::marker::ConstParamTy for CantParam {}\n //~^ error: the trait `ConstParamTy` cannot be implemented for this type\n \n+#[derive(std::marker::ConstParamTy, Eq, PartialEq)]\n+//~^ error: the trait `ConstParamTy` cannot be implemented for this type\n+struct CantParamDerive(NotParam);\n+\n fn main() {}"}, {"sha": "52b65d6061ab502515953f3018fe78baa3ac99fc", "filename": "tests/ui/const-generics/adt_const_params/const_param_ty_impl_bad_field.stderr", "status": "modified", "additions": 12, "deletions": 1, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/bc3b94a486cb2bea32f3d07bd6cab76fae95d35f/tests%2Fui%2Fconst-generics%2Fadt_const_params%2Fconst_param_ty_impl_bad_field.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/bc3b94a486cb2bea32f3d07bd6cab76fae95d35f/tests%2Fui%2Fconst-generics%2Fadt_const_params%2Fconst_param_ty_impl_bad_field.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fconst-generics%2Fadt_const_params%2Fconst_param_ty_impl_bad_field.stderr?ref=bc3b94a486cb2bea32f3d07bd6cab76fae95d35f", "patch": "@@ -7,6 +7,17 @@ LL |\n LL | impl std::marker::ConstParamTy for CantParam {}\n    |                                    ^^^^^^^^^\n \n-error: aborting due to previous error\n+error[E0204]: the trait `ConstParamTy` cannot be implemented for this type\n+  --> $DIR/const_param_ty_impl_bad_field.rs:13:10\n+   |\n+LL | #[derive(std::marker::ConstParamTy, Eq, PartialEq)]\n+   |          ^^^^^^^^^^^^^^^^^^^^^^^^^\n+LL |\n+LL | struct CantParamDerive(NotParam);\n+   |                        -------- this field does not implement `ConstParamTy`\n+   |\n+   = note: this error originates in the derive macro `std::marker::ConstParamTy` (in Nightly builds, run with -Z macro-backtrace for more info)\n+\n+error: aborting due to 2 previous errors\n \n For more information about this error, try `rustc --explain E0204`."}, {"sha": "37986de481f111a9662557202aa2268bc9b979d3", "filename": "tests/ui/const-generics/adt_const_params/const_param_ty_impl_no_structural_eq.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/bc3b94a486cb2bea32f3d07bd6cab76fae95d35f/tests%2Fui%2Fconst-generics%2Fadt_const_params%2Fconst_param_ty_impl_no_structural_eq.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bc3b94a486cb2bea32f3d07bd6cab76fae95d35f/tests%2Fui%2Fconst-generics%2Fadt_const_params%2Fconst_param_ty_impl_no_structural_eq.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fconst-generics%2Fadt_const_params%2Fconst_param_ty_impl_no_structural_eq.rs?ref=bc3b94a486cb2bea32f3d07bd6cab76fae95d35f", "patch": "@@ -10,6 +10,10 @@ struct CantParam(ImplementsConstParamTy);\n impl std::marker::ConstParamTy for CantParam {}\n //~^ error: the type `CantParam` does not `#[derive(Eq)]`\n \n+#[derive(std::marker::ConstParamTy)]\n+//~^ error: the type `CantParamDerive` does not `#[derive(Eq)]`\n+struct CantParamDerive(ImplementsConstParamTy);\n+\n fn check<T: std::marker::ConstParamTy>() {}\n \n fn main() {"}, {"sha": "52701d55914420d03e6910ecedac7a780012f414", "filename": "tests/ui/const-generics/adt_const_params/const_param_ty_impl_no_structural_eq.stderr", "status": "modified", "additions": 11, "deletions": 1, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/bc3b94a486cb2bea32f3d07bd6cab76fae95d35f/tests%2Fui%2Fconst-generics%2Fadt_const_params%2Fconst_param_ty_impl_no_structural_eq.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/bc3b94a486cb2bea32f3d07bd6cab76fae95d35f/tests%2Fui%2Fconst-generics%2Fadt_const_params%2Fconst_param_ty_impl_no_structural_eq.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fconst-generics%2Fadt_const_params%2Fconst_param_ty_impl_no_structural_eq.stderr?ref=bc3b94a486cb2bea32f3d07bd6cab76fae95d35f", "patch": "@@ -7,6 +7,16 @@ LL | impl std::marker::ConstParamTy for CantParam {}\n note: required by a bound in `ConstParamTy`\n   --> $SRC_DIR/core/src/marker.rs:LL:COL\n \n-error: aborting due to previous error\n+error[E0277]: the type `CantParamDerive` does not `#[derive(Eq)]`\n+  --> $DIR/const_param_ty_impl_no_structural_eq.rs:13:10\n+   |\n+LL | #[derive(std::marker::ConstParamTy)]\n+   |          ^^^^^^^^^^^^^^^^^^^^^^^^^ the trait `StructuralEq` is not implemented for `CantParamDerive`\n+   |\n+note: required by a bound in `ConstParamTy`\n+  --> $SRC_DIR/core/src/marker.rs:LL:COL\n+   = note: this error originates in the derive macro `std::marker::ConstParamTy` (in Nightly builds, run with -Z macro-backtrace for more info)\n+\n+error: aborting due to 2 previous errors\n \n For more information about this error, try `rustc --explain E0277`."}, {"sha": "d70377a20c170054ce49dbabbe04afb5f0973282", "filename": "tests/ui/const-generics/adt_const_params/const_param_ty_impl_union.rs", "status": "added", "additions": 33, "deletions": 0, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/bc3b94a486cb2bea32f3d07bd6cab76fae95d35f/tests%2Fui%2Fconst-generics%2Fadt_const_params%2Fconst_param_ty_impl_union.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bc3b94a486cb2bea32f3d07bd6cab76fae95d35f/tests%2Fui%2Fconst-generics%2Fadt_const_params%2Fconst_param_ty_impl_union.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fconst-generics%2Fadt_const_params%2Fconst_param_ty_impl_union.rs?ref=bc3b94a486cb2bea32f3d07bd6cab76fae95d35f", "patch": "@@ -0,0 +1,33 @@\n+#![allow(incomplete_features)]\n+#![feature(adt_const_params, structural_match)]\n+\n+union Union {\n+    a: u8,\n+}\n+\n+impl PartialEq for Union {\n+    fn eq(&self, other: &Union) -> bool {\n+        true\n+    }\n+}\n+impl Eq for Union {}\n+impl std::marker::StructuralEq for Union {}\n+\n+impl std::marker::ConstParamTy for Union {}\n+\n+#[derive(std::marker::ConstParamTy)]\n+//~^ ERROR this trait cannot be derived for unions\n+union UnionDerive {\n+    a: u8,\n+}\n+\n+impl PartialEq for UnionDerive {\n+    fn eq(&self, other: &UnionDerive) -> bool {\n+        true\n+    }\n+}\n+impl Eq for UnionDerive {}\n+impl std::marker::StructuralEq for UnionDerive {}\n+\n+\n+fn main() {}"}, {"sha": "293703046050357d0a9c04c52fd3e8ca68ed97d4", "filename": "tests/ui/const-generics/adt_const_params/const_param_ty_impl_union.stderr", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/bc3b94a486cb2bea32f3d07bd6cab76fae95d35f/tests%2Fui%2Fconst-generics%2Fadt_const_params%2Fconst_param_ty_impl_union.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/bc3b94a486cb2bea32f3d07bd6cab76fae95d35f/tests%2Fui%2Fconst-generics%2Fadt_const_params%2Fconst_param_ty_impl_union.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fconst-generics%2Fadt_const_params%2Fconst_param_ty_impl_union.stderr?ref=bc3b94a486cb2bea32f3d07bd6cab76fae95d35f", "patch": "@@ -0,0 +1,8 @@\n+error: this trait cannot be derived for unions\n+  --> $DIR/const_param_ty_impl_union.rs:18:10\n+   |\n+LL | #[derive(std::marker::ConstParamTy)]\n+   |          ^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: aborting due to previous error\n+"}]}