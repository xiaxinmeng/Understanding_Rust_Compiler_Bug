{"sha": "8427efaab377346c0c4be73664422897a4072330", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg0MjdlZmFhYjM3NzM0NmMwYzRiZTczNjY0NDIyODk3YTQwNzIzMzA=", "commit": {"author": {"name": "Oliver Middleton", "email": "olliemail27@gmail.com", "date": "2016-03-10T19:09:02Z"}, "committer": {"name": "Oliver Middleton", "email": "olliemail27@gmail.com", "date": "2016-03-10T21:15:23Z"}, "message": "Fixup stout/stderr on Windows\n\nWriteConsoleW can fail if called with a large buffer so we need to slice\nany stdout/stderr output.\nHowever the current slicing has a few problems:\n 1. It slices by byte but still expects valid UTF-8.\n 2. The slicing happens even when not outputting to a console.\n 3. panic! output is not sliced.\n\nThis fixes these issues by moving the slice to right before\nWriteConsoleW and slicing on a char boundary.", "tree": {"sha": "69723a049b19d200f1eb35ff9778750f894282d6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/69723a049b19d200f1eb35ff9778750f894282d6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8427efaab377346c0c4be73664422897a4072330", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8427efaab377346c0c4be73664422897a4072330", "html_url": "https://github.com/rust-lang/rust/commit/8427efaab377346c0c4be73664422897a4072330", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8427efaab377346c0c4be73664422897a4072330/comments", "author": {"login": "ollie27", "id": 7189418, "node_id": "MDQ6VXNlcjcxODk0MTg=", "avatar_url": "https://avatars.githubusercontent.com/u/7189418?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ollie27", "html_url": "https://github.com/ollie27", "followers_url": "https://api.github.com/users/ollie27/followers", "following_url": "https://api.github.com/users/ollie27/following{/other_user}", "gists_url": "https://api.github.com/users/ollie27/gists{/gist_id}", "starred_url": "https://api.github.com/users/ollie27/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ollie27/subscriptions", "organizations_url": "https://api.github.com/users/ollie27/orgs", "repos_url": "https://api.github.com/users/ollie27/repos", "events_url": "https://api.github.com/users/ollie27/events{/privacy}", "received_events_url": "https://api.github.com/users/ollie27/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ollie27", "id": 7189418, "node_id": "MDQ6VXNlcjcxODk0MTg=", "avatar_url": "https://avatars.githubusercontent.com/u/7189418?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ollie27", "html_url": "https://github.com/ollie27", "followers_url": "https://api.github.com/users/ollie27/followers", "following_url": "https://api.github.com/users/ollie27/following{/other_user}", "gists_url": "https://api.github.com/users/ollie27/gists{/gist_id}", "starred_url": "https://api.github.com/users/ollie27/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ollie27/subscriptions", "organizations_url": "https://api.github.com/users/ollie27/orgs", "repos_url": "https://api.github.com/users/ollie27/repos", "events_url": "https://api.github.com/users/ollie27/events{/privacy}", "received_events_url": "https://api.github.com/users/ollie27/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4b87655e69a6d07f03b104caaec80a042ad40bf1", "url": "https://api.github.com/repos/rust-lang/rust/commits/4b87655e69a6d07f03b104caaec80a042ad40bf1", "html_url": "https://github.com/rust-lang/rust/commit/4b87655e69a6d07f03b104caaec80a042ad40bf1"}], "stats": {"total": 47, "additions": 26, "deletions": 21}, "files": [{"sha": "e1a388c38c45334272b1bbdfbfc61f422ef37af2", "filename": "src/libstd/io/stdio.rs", "status": "modified", "additions": 2, "deletions": 19, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/8427efaab377346c0c4be73664422897a4072330/src%2Flibstd%2Fio%2Fstdio.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8427efaab377346c0c4be73664422897a4072330/src%2Flibstd%2Fio%2Fstdio.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fio%2Fstdio.rs?ref=8427efaab377346c0c4be73664422897a4072330", "patch": "@@ -12,7 +12,6 @@ use prelude::v1::*;\n use io::prelude::*;\n \n use cell::{RefCell, BorrowState};\n-use cmp;\n use fmt;\n use io::lazy::Lazy;\n use io::{self, BufReader, LineWriter};\n@@ -312,22 +311,6 @@ impl<'a> BufRead for StdinLock<'a> {\n     fn consume(&mut self, n: usize) { self.inner.consume(n) }\n }\n \n-// As with stdin on windows, stdout often can't handle writes of large\n-// sizes. For an example, see #14940. For this reason, don't try to\n-// write the entire output buffer on windows. On unix we can just\n-// write the whole buffer all at once.\n-//\n-// For some other references, it appears that this problem has been\n-// encountered by others [1] [2]. We choose the number 8KB just because\n-// libuv does the same.\n-//\n-// [1]: https://tahoe-lafs.org/trac/tahoe-lafs/ticket/1232\n-// [2]: http://www.mail-archive.com/log4net-dev@logging.apache.org/msg00661.html\n-#[cfg(windows)]\n-const OUT_MAX: usize = 8192;\n-#[cfg(unix)]\n-const OUT_MAX: usize = ::usize::MAX;\n-\n /// A handle to the global standard output stream of the current process.\n ///\n /// Each handle shares a global buffer of data to be written to the standard\n@@ -440,7 +423,7 @@ impl Write for Stdout {\n #[stable(feature = \"rust1\", since = \"1.0.0\")]\n impl<'a> Write for StdoutLock<'a> {\n     fn write(&mut self, buf: &[u8]) -> io::Result<usize> {\n-        self.inner.borrow_mut().write(&buf[..cmp::min(buf.len(), OUT_MAX)])\n+        self.inner.borrow_mut().write(buf)\n     }\n     fn flush(&mut self) -> io::Result<()> {\n         self.inner.borrow_mut().flush()\n@@ -546,7 +529,7 @@ impl Write for Stderr {\n #[stable(feature = \"rust1\", since = \"1.0.0\")]\n impl<'a> Write for StderrLock<'a> {\n     fn write(&mut self, buf: &[u8]) -> io::Result<usize> {\n-        self.inner.borrow_mut().write(&buf[..cmp::min(buf.len(), OUT_MAX)])\n+        self.inner.borrow_mut().write(buf)\n     }\n     fn flush(&mut self) -> io::Result<()> {\n         self.inner.borrow_mut().flush()"}, {"sha": "190c257162822272f95cd4eb1e13db955644d5de", "filename": "src/libstd/sys/windows/stdio.rs", "status": "modified", "additions": 24, "deletions": 2, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/8427efaab377346c0c4be73664422897a4072330/src%2Flibstd%2Fsys%2Fwindows%2Fstdio.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8427efaab377346c0c4be73664422897a4072330/src%2Flibstd%2Fsys%2Fwindows%2Fstdio.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Fwindows%2Fstdio.rs?ref=8427efaab377346c0c4be73664422897a4072330", "patch": "@@ -58,8 +58,30 @@ fn write(out: &Output, data: &[u8]) -> io::Result<usize> {\n         Output::Console(ref c) => c.get().raw(),\n         Output::Pipe(ref p) => return p.get().write(data),\n     };\n+    // As with stdin on windows, stdout often can't handle writes of large\n+    // sizes. For an example, see #14940. For this reason, don't try to\n+    // write the entire output buffer on windows.\n+    //\n+    // For some other references, it appears that this problem has been\n+    // encountered by others [1] [2]. We choose the number 8K just because\n+    // libuv does the same.\n+    //\n+    // [1]: https://tahoe-lafs.org/trac/tahoe-lafs/ticket/1232\n+    // [2]: http://www.mail-archive.com/log4net-dev@logging.apache.org/msg00661.html\n+    const OUT_MAX: usize = 8192;\n+    let data_len;\n     let utf16 = match str::from_utf8(data).ok() {\n-        Some(utf8) => utf8.encode_utf16().collect::<Vec<u16>>(),\n+        Some(mut utf8) => {\n+            if utf8.len() > OUT_MAX {\n+                let mut new_len = OUT_MAX;\n+                while !utf8.is_char_boundary(new_len) {\n+                    new_len -= 1;\n+                }\n+                utf8 = &utf8[..new_len];\n+            }\n+            data_len = utf8.len();\n+            utf8.encode_utf16().collect::<Vec<u16>>()\n+        }\n         None => return Err(invalid_encoding()),\n     };\n     let mut written = 0;\n@@ -74,7 +96,7 @@ fn write(out: &Output, data: &[u8]) -> io::Result<usize> {\n     // FIXME if this only partially writes the utf16 buffer then we need to\n     //       figure out how many bytes of `data` were actually written\n     assert_eq!(written as usize, utf16.len());\n-    Ok(data.len())\n+    Ok(data_len)\n }\n \n impl Stdin {"}]}