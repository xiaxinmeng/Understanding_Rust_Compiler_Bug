{"sha": "654a4e81a5fcb399ca0a51100e7e6ba27169a3a8", "node_id": "C_kwDOAAsO6NoAKDY1NGE0ZTgxYTVmY2IzOTljYTBhNTExMDBlN2U2YmEyNzE2OWEzYTg", "commit": {"author": {"name": "ozkanonur", "email": "work@onurozkan.dev", "date": "2022-11-12T13:34:43Z"}, "committer": {"name": "ozkanonur", "email": "work@onurozkan.dev", "date": "2022-11-12T22:10:22Z"}, "message": "check if current stage is target build stage r=ozkanonur\n\nSigned-off-by: ozkanonur <work@onurozkan.dev>", "tree": {"sha": "ade1521532ec4dbba587608bd3e8ce4885b8f3d1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ade1521532ec4dbba587608bd3e8ce4885b8f3d1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/654a4e81a5fcb399ca0a51100e7e6ba27169a3a8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/654a4e81a5fcb399ca0a51100e7e6ba27169a3a8", "html_url": "https://github.com/rust-lang/rust/commit/654a4e81a5fcb399ca0a51100e7e6ba27169a3a8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/654a4e81a5fcb399ca0a51100e7e6ba27169a3a8/comments", "author": {"login": "ozkanonur", "id": 39852038, "node_id": "MDQ6VXNlcjM5ODUyMDM4", "avatar_url": "https://avatars.githubusercontent.com/u/39852038?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ozkanonur", "html_url": "https://github.com/ozkanonur", "followers_url": "https://api.github.com/users/ozkanonur/followers", "following_url": "https://api.github.com/users/ozkanonur/following{/other_user}", "gists_url": "https://api.github.com/users/ozkanonur/gists{/gist_id}", "starred_url": "https://api.github.com/users/ozkanonur/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ozkanonur/subscriptions", "organizations_url": "https://api.github.com/users/ozkanonur/orgs", "repos_url": "https://api.github.com/users/ozkanonur/repos", "events_url": "https://api.github.com/users/ozkanonur/events{/privacy}", "received_events_url": "https://api.github.com/users/ozkanonur/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ozkanonur", "id": 39852038, "node_id": "MDQ6VXNlcjM5ODUyMDM4", "avatar_url": "https://avatars.githubusercontent.com/u/39852038?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ozkanonur", "html_url": "https://github.com/ozkanonur", "followers_url": "https://api.github.com/users/ozkanonur/followers", "following_url": "https://api.github.com/users/ozkanonur/following{/other_user}", "gists_url": "https://api.github.com/users/ozkanonur/gists{/gist_id}", "starred_url": "https://api.github.com/users/ozkanonur/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ozkanonur/subscriptions", "organizations_url": "https://api.github.com/users/ozkanonur/orgs", "repos_url": "https://api.github.com/users/ozkanonur/repos", "events_url": "https://api.github.com/users/ozkanonur/events{/privacy}", "received_events_url": "https://api.github.com/users/ozkanonur/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b0c6527912cee113b29a33d7db0e801a58a94de5", "url": "https://api.github.com/repos/rust-lang/rust/commits/b0c6527912cee113b29a33d7db0e801a58a94de5", "html_url": "https://github.com/rust-lang/rust/commit/b0c6527912cee113b29a33d7db0e801a58a94de5"}], "stats": {"total": 29, "additions": 20, "deletions": 9}, "files": [{"sha": "61630518c197b7c6d916d87502469004ad5b9ba6", "filename": "src/bootstrap/compile.rs", "status": "modified", "additions": 20, "deletions": 9, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/654a4e81a5fcb399ca0a51100e7e6ba27169a3a8/src%2Fbootstrap%2Fcompile.rs", "raw_url": "https://github.com/rust-lang/rust/raw/654a4e81a5fcb399ca0a51100e7e6ba27169a3a8/src%2Fbootstrap%2Fcompile.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcompile.rs?ref=654a4e81a5fcb399ca0a51100e7e6ba27169a3a8", "patch": "@@ -1122,13 +1122,18 @@ impl Step for Sysroot {\n     fn run(self, builder: &Builder<'_>) -> Interned<PathBuf> {\n         let compiler = self.compiler;\n         let host_dir = builder.out.join(&compiler.host.triple);\n-        let sysroot = if compiler.stage == 0 {\n-            host_dir.join(\"stage0-sysroot\")\n-        } else if builder.download_rustc() {\n-            host_dir.join(\"ci-rustc-sysroot\")\n-        } else {\n-            host_dir.join(format!(\"stage{}\", compiler.stage))\n+\n+        let sysroot_dir = |stage| {\n+            if stage == 0 {\n+                host_dir.join(\"stage0-sysroot\")\n+            } else if builder.download_rustc() && compiler.stage != builder.top_stage {\n+                host_dir.join(\"ci-rustc-sysroot\")\n+            } else {\n+                host_dir.join(format!(\"stage{}\", stage))\n+            }\n         };\n+        let sysroot = sysroot_dir(compiler.stage);\n+\n         let _ = fs::remove_dir_all(&sysroot);\n         t!(fs::create_dir_all(&sysroot));\n \n@@ -1139,9 +1144,15 @@ impl Step for Sysroot {\n                 \"Cross-compiling is not yet supported with `download-rustc`\",\n             );\n \n-            // #102002, cleanup stage1 and stage0-sysroot folders when using download-rustc so people don't use old versions of the toolchain by accident.\n-            let _ = fs::remove_dir_all(host_dir.join(\"stage1\"));\n-            let _ = fs::remove_dir_all(host_dir.join(\"stage0-sysroot\"));\n+            // #102002, cleanup old toolchain folders when using download-rustc so people don't use them by accident.\n+            for stage in 0..=2 {\n+                if stage != compiler.stage {\n+                    let dir = sysroot_dir(stage);\n+                    if !dir.ends_with(\"ci-rustc-sysroot\") {\n+                        let _ = fs::remove_dir_all(dir);\n+                    }\n+                }\n+            }\n \n             // Copy the compiler into the correct sysroot.\n             let ci_rustc_dir ="}]}