{"sha": "519d7484f3b1beb25dec9f2249adeaaa21033433", "node_id": "C_kwDOAAsO6NoAKDUxOWQ3NDg0ZjNiMWJlYjI1ZGVjOWYyMjQ5YWRlYWFhMjEwMzM0MzM", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-06-15T20:01:37Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-06-15T20:01:37Z"}, "message": "Auto merge of #12545 - jeremyBanks:shebangs, r=Veykril\n\nfix: inserted imports must come after a shebang if present\n\nThe current `insert_use` logic adds the first `use` item near the beginning of the file, only skipping past comments and whitespace. However, it does not skip leading [shebang lines](https://en.wikipedia.org/wiki/Shebang_\\(Unix\\)). This can produce a syntax error, as shebangs are only accepted (ignored) on the first line of the file.\n\n### Before Insertion (valid syntax)\n\n```rust\n#!/usr/bin/env rust\n\nfn main() {}\n```\n\n### After Insertion (invalid syntax)\n\n```rust\nuse foo::bar::Baz;\n\n#!/usr/bin/env rust\n\nfn main() {}\n```\n\nRust analyzer's grammar is already shebang-aware, so this PR just adds that to the array of SyntaxKinds that are skipped past when looking for an insertion location, and adds a corresponding test case.", "tree": {"sha": "1ef3bfd60915f0c75a4889283ddde41da7050f17", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1ef3bfd60915f0c75a4889283ddde41da7050f17"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/519d7484f3b1beb25dec9f2249adeaaa21033433", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/519d7484f3b1beb25dec9f2249adeaaa21033433", "html_url": "https://github.com/rust-lang/rust/commit/519d7484f3b1beb25dec9f2249adeaaa21033433", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/519d7484f3b1beb25dec9f2249adeaaa21033433/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d39d520a210e5d92c7c5d7ad5b6e9ecd0a0a4f07", "url": "https://api.github.com/repos/rust-lang/rust/commits/d39d520a210e5d92c7c5d7ad5b6e9ecd0a0a4f07", "html_url": "https://github.com/rust-lang/rust/commit/d39d520a210e5d92c7c5d7ad5b6e9ecd0a0a4f07"}, {"sha": "c32f1332363fd719cade4b4b2a7ba885a3ded4e7", "url": "https://api.github.com/repos/rust-lang/rust/commits/c32f1332363fd719cade4b4b2a7ba885a3ded4e7", "html_url": "https://github.com/rust-lang/rust/commit/c32f1332363fd719cade4b4b2a7ba885a3ded4e7"}], "stats": {"total": 14, "additions": 13, "deletions": 1}, "files": [{"sha": "d1cd347819703f8ec64f0372800e4b3a24c9f775", "filename": "crates/ide-db/src/imports/insert_use.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/519d7484f3b1beb25dec9f2249adeaaa21033433/crates%2Fide-db%2Fsrc%2Fimports%2Finsert_use.rs", "raw_url": "https://github.com/rust-lang/rust/raw/519d7484f3b1beb25dec9f2249adeaaa21033433/crates%2Fide-db%2Fsrc%2Fimports%2Finsert_use.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-db%2Fsrc%2Fimports%2Finsert_use.rs?ref=519d7484f3b1beb25dec9f2249adeaaa21033433", "patch": "@@ -403,7 +403,8 @@ fn insert_use_(\n         .take_while(|child| match child {\n             NodeOrToken::Node(node) => is_inner_attribute(node.clone()),\n             NodeOrToken::Token(token) => {\n-                [SyntaxKind::WHITESPACE, SyntaxKind::COMMENT].contains(&token.kind())\n+                [SyntaxKind::WHITESPACE, SyntaxKind::COMMENT, SyntaxKind::SHEBANG]\n+                    .contains(&token.kind())\n             }\n         })\n         .filter(|child| child.as_token().map_or(true, |t| t.kind() != SyntaxKind::WHITESPACE))"}, {"sha": "70a7a1523212cff8b3adfd481028808623d2b669", "filename": "crates/ide-db/src/imports/insert_use/tests.rs", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/519d7484f3b1beb25dec9f2249adeaaa21033433/crates%2Fide-db%2Fsrc%2Fimports%2Finsert_use%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/519d7484f3b1beb25dec9f2249adeaaa21033433/crates%2Fide-db%2Fsrc%2Fimports%2Finsert_use%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-db%2Fsrc%2Fimports%2Finsert_use%2Ftests.rs?ref=519d7484f3b1beb25dec9f2249adeaaa21033433", "patch": "@@ -454,6 +454,17 @@ use foo::bar::Baz;\"#,\n     );\n }\n \n+#[test]\n+fn inserts_after_shebang() {\n+    check_none(\n+        \"foo::bar::Baz\",\n+        \"#!/usr/bin/env rust\",\n+        r#\"#!/usr/bin/env rust\n+\n+use foo::bar::Baz;\"#,\n+    );\n+}\n+\n #[test]\n fn inserts_after_multiple_single_line_comments() {\n     check_none("}]}