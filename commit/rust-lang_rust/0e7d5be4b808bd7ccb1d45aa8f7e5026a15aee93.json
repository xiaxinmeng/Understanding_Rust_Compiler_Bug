{"sha": "0e7d5be4b808bd7ccb1d45aa8f7e5026a15aee93", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBlN2Q1YmU0YjgwOGJkN2NjYjFkNDVhYThmN2U1MDI2YTE1YWVlOTM=", "commit": {"author": {"name": "Matthew Maurer", "email": "matthew.r.maurer@gmail.com", "date": "2020-04-17T02:40:11Z"}, "committer": {"name": "Matthew Maurer", "email": "matthew.r.maurer@gmail.com", "date": "2020-04-29T20:38:59Z"}, "message": "Use .init_array rather than .ctors\n\nLLVM TargetMachines default to using the (now-legacy) .ctors\nrepresentation of init functions. Mixing .ctors and .init_array\nrepresentations can cause issues when linking with lld.\n\nThis happens in practice for:\n\n* Our profiling runtime which is currently implicitly built with\n  .init_array since it is built by clang, which sets this field.\n* External C/C++ code that may be linked into the same process.\n\nTo support legacy systems which may use .ctors, targets may now specify\nthat they use .ctors via the use_ctors attribute which defaults to\nfalse.\n\nFor debugging and manual control, -Z use-ctors-section=yes/no will allow\nmanual override.\n\nFixes: #71233", "tree": {"sha": "f96a66037263baa82b0267d9f450eb09c1799a4f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f96a66037263baa82b0267d9f450eb09c1799a4f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0e7d5be4b808bd7ccb1d45aa8f7e5026a15aee93", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0e7d5be4b808bd7ccb1d45aa8f7e5026a15aee93", "html_url": "https://github.com/rust-lang/rust/commit/0e7d5be4b808bd7ccb1d45aa8f7e5026a15aee93", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0e7d5be4b808bd7ccb1d45aa8f7e5026a15aee93/comments", "author": {"login": "maurer", "id": 136037, "node_id": "MDQ6VXNlcjEzNjAzNw==", "avatar_url": "https://avatars.githubusercontent.com/u/136037?v=4", "gravatar_id": "", "url": "https://api.github.com/users/maurer", "html_url": "https://github.com/maurer", "followers_url": "https://api.github.com/users/maurer/followers", "following_url": "https://api.github.com/users/maurer/following{/other_user}", "gists_url": "https://api.github.com/users/maurer/gists{/gist_id}", "starred_url": "https://api.github.com/users/maurer/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/maurer/subscriptions", "organizations_url": "https://api.github.com/users/maurer/orgs", "repos_url": "https://api.github.com/users/maurer/repos", "events_url": "https://api.github.com/users/maurer/events{/privacy}", "received_events_url": "https://api.github.com/users/maurer/received_events", "type": "User", "site_admin": false}, "committer": {"login": "maurer", "id": 136037, "node_id": "MDQ6VXNlcjEzNjAzNw==", "avatar_url": "https://avatars.githubusercontent.com/u/136037?v=4", "gravatar_id": "", "url": "https://api.github.com/users/maurer", "html_url": "https://github.com/maurer", "followers_url": "https://api.github.com/users/maurer/followers", "following_url": "https://api.github.com/users/maurer/following{/other_user}", "gists_url": "https://api.github.com/users/maurer/gists{/gist_id}", "starred_url": "https://api.github.com/users/maurer/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/maurer/subscriptions", "organizations_url": "https://api.github.com/users/maurer/orgs", "repos_url": "https://api.github.com/users/maurer/repos", "events_url": "https://api.github.com/users/maurer/events{/privacy}", "received_events_url": "https://api.github.com/users/maurer/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "825cf51ad7d2578fcd60a0b7b107d7b0ab3017ff", "url": "https://api.github.com/repos/rust-lang/rust/commits/825cf51ad7d2578fcd60a0b7b107d7b0ab3017ff", "html_url": "https://github.com/rust-lang/rust/commit/825cf51ad7d2578fcd60a0b7b107d7b0ab3017ff"}], "stats": {"total": 24, "additions": 23, "deletions": 1}, "files": [{"sha": "6196993310e6eafcfadb8be9ceb213a1106475da", "filename": "src/librustc_codegen_llvm/back/write.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/0e7d5be4b808bd7ccb1d45aa8f7e5026a15aee93/src%2Flibrustc_codegen_llvm%2Fback%2Fwrite.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0e7d5be4b808bd7ccb1d45aa8f7e5026a15aee93/src%2Flibrustc_codegen_llvm%2Fback%2Fwrite.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fback%2Fwrite.rs?ref=0e7d5be4b808bd7ccb1d45aa8f7e5026a15aee93", "patch": "@@ -166,6 +166,13 @@ pub fn target_machine_factory(\n \n     let asm_comments = sess.asm_comments();\n     let relax_elf_relocations = sess.target.target.options.relax_elf_relocations;\n+\n+    let use_init_array = !sess\n+        .opts\n+        .debugging_opts\n+        .use_ctors_section\n+        .unwrap_or(sess.target.target.options.use_ctors_section);\n+\n     Arc::new(move || {\n         let tm = unsafe {\n             llvm::LLVMRustCreateTargetMachine(\n@@ -185,6 +192,7 @@ pub fn target_machine_factory(\n                 asm_comments,\n                 emit_stack_size_section,\n                 relax_elf_relocations,\n+                use_init_array,\n             )\n         };\n "}, {"sha": "53a7f718197879bbc1cac164ad2b31c34304ca0d", "filename": "src/librustc_codegen_llvm/llvm/ffi.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/0e7d5be4b808bd7ccb1d45aa8f7e5026a15aee93/src%2Flibrustc_codegen_llvm%2Fllvm%2Fffi.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0e7d5be4b808bd7ccb1d45aa8f7e5026a15aee93/src%2Flibrustc_codegen_llvm%2Fllvm%2Fffi.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fllvm%2Fffi.rs?ref=0e7d5be4b808bd7ccb1d45aa8f7e5026a15aee93", "patch": "@@ -1956,6 +1956,7 @@ extern \"C\" {\n         AsmComments: bool,\n         EmitStackSizeSection: bool,\n         RelaxELFRelocations: bool,\n+        UseInitArray: bool,\n     ) -> Option<&'static mut TargetMachine>;\n     pub fn LLVMRustDisposeTargetMachine(T: &'static mut TargetMachine);\n     pub fn LLVMRustAddBuilderLibraryInfo("}, {"sha": "d041a05e25f30b364f5a1492c67cb34fd043f5ab", "filename": "src/librustc_interface/tests.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/0e7d5be4b808bd7ccb1d45aa8f7e5026a15aee93/src%2Flibrustc_interface%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0e7d5be4b808bd7ccb1d45aa8f7e5026a15aee93/src%2Flibrustc_interface%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_interface%2Ftests.rs?ref=0e7d5be4b808bd7ccb1d45aa8f7e5026a15aee93", "patch": "@@ -571,6 +571,7 @@ fn test_debugging_options_tracking_hash() {\n     tracked!(tls_model, Some(TlsModel::GeneralDynamic));\n     tracked!(treat_err_as_bug, Some(1));\n     tracked!(unleash_the_miri_inside_of_you, true);\n+    tracked!(use_ctors_section, Some(true));\n     tracked!(verify_llvm_ir, true);\n }\n "}, {"sha": "943f0cde0100fd2b26328b23878b30a50301fc54", "filename": "src/librustc_session/options.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0e7d5be4b808bd7ccb1d45aa8f7e5026a15aee93/src%2Flibrustc_session%2Foptions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0e7d5be4b808bd7ccb1d45aa8f7e5026a15aee93/src%2Flibrustc_session%2Foptions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_session%2Foptions.rs?ref=0e7d5be4b808bd7ccb1d45aa8f7e5026a15aee93", "patch": "@@ -1010,6 +1010,8 @@ options! {DebuggingOptions, DebuggingSetter, basic_debugging_options,\n         `mir` (the MIR), or `mir-cfg` (graphviz formatted MIR)\"),\n     unstable_options: bool = (false, parse_bool, [UNTRACKED],\n         \"adds unstable command line options to rustc interface (default: no)\"),\n+    use_ctors_section: Option<bool> = (None, parse_opt_bool, [TRACKED],\n+        \"use legacy .ctors section for initializers rather than .init_array\"),\n     verbose: bool = (false, parse_bool, [UNTRACKED],\n         \"in general, enable more debug printouts (default: no)\"),\n     verify_llvm_ir: bool = (false, parse_bool, [TRACKED],"}, {"sha": "579453cd7f87f311f935157cdfeb047956524772", "filename": "src/librustc_target/spec/mod.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/0e7d5be4b808bd7ccb1d45aa8f7e5026a15aee93/src%2Flibrustc_target%2Fspec%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0e7d5be4b808bd7ccb1d45aa8f7e5026a15aee93/src%2Flibrustc_target%2Fspec%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_target%2Fspec%2Fmod.rs?ref=0e7d5be4b808bd7ccb1d45aa8f7e5026a15aee93", "patch": "@@ -878,6 +878,10 @@ pub struct TargetOptions {\n \n     /// Additional arguments to pass to LLVM, similar to the `-C llvm-args` codegen option.\n     pub llvm_args: Vec<String>,\n+\n+    /// Whether to use legacy .ctors initialization hooks rather than .init_array. Defaults\n+    /// to false (uses .init_array).\n+    pub use_ctors_section: bool,\n }\n \n impl Default for TargetOptions {\n@@ -966,6 +970,7 @@ impl Default for TargetOptions {\n             llvm_abiname: \"\".to_string(),\n             relax_elf_relocations: false,\n             llvm_args: vec![],\n+            use_ctors_section: false,\n         }\n     }\n }\n@@ -1304,6 +1309,7 @@ impl Target {\n         key!(llvm_abiname);\n         key!(relax_elf_relocations, bool);\n         key!(llvm_args, list);\n+        key!(use_ctors_section, bool);\n \n         if let Some(array) = obj.find(\"abi-blacklist\").and_then(Json::as_array) {\n             for name in array.iter().filter_map(|abi| abi.as_string()) {\n@@ -1531,6 +1537,7 @@ impl ToJson for Target {\n         target_option_val!(llvm_abiname);\n         target_option_val!(relax_elf_relocations);\n         target_option_val!(llvm_args);\n+        target_option_val!(use_ctors_section);\n \n         if default.abi_blacklist != self.options.abi_blacklist {\n             d.insert("}, {"sha": "988346af2d72c8f9068fe63a511002b932ecc6db", "filename": "src/librustc_target/spec/netbsd_base.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/0e7d5be4b808bd7ccb1d45aa8f7e5026a15aee93/src%2Flibrustc_target%2Fspec%2Fnetbsd_base.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0e7d5be4b808bd7ccb1d45aa8f7e5026a15aee93/src%2Flibrustc_target%2Fspec%2Fnetbsd_base.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_target%2Fspec%2Fnetbsd_base.rs?ref=0e7d5be4b808bd7ccb1d45aa8f7e5026a15aee93", "patch": "@@ -23,6 +23,7 @@ pub fn opts() -> TargetOptions {\n         pre_link_args: args,\n         position_independent_executables: true,\n         relro_level: RelroLevel::Full,\n+        use_ctors_section: true,\n         ..Default::default()\n     }\n }"}, {"sha": "0acedc25db89aa3ef77534f6667e470d39c2f8e3", "filename": "src/rustllvm/PassWrapper.cpp", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/0e7d5be4b808bd7ccb1d45aa8f7e5026a15aee93/src%2Frustllvm%2FPassWrapper.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/0e7d5be4b808bd7ccb1d45aa8f7e5026a15aee93/src%2Frustllvm%2FPassWrapper.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustllvm%2FPassWrapper.cpp?ref=0e7d5be4b808bd7ccb1d45aa8f7e5026a15aee93", "patch": "@@ -445,7 +445,8 @@ extern \"C\" LLVMTargetMachineRef LLVMRustCreateTargetMachine(\n     bool Singlethread,\n     bool AsmComments,\n     bool EmitStackSizeSection,\n-    bool RelaxELFRelocations) {\n+    bool RelaxELFRelocations,\n+    bool UseInitArray) {\n \n   auto OptLevel = fromRust(RustOptLevel);\n   auto RM = fromRust(RustReloc);\n@@ -471,6 +472,7 @@ extern \"C\" LLVMTargetMachineRef LLVMRustCreateTargetMachine(\n   Options.MCOptions.PreserveAsmComments = AsmComments;\n   Options.MCOptions.ABIName = ABIStr;\n   Options.RelaxELFRelocations = RelaxELFRelocations;\n+  Options.UseInitArray = UseInitArray;\n \n   if (TrapUnreachable) {\n     // Tell LLVM to codegen `unreachable` into an explicit trap instruction."}]}