{"sha": "3cbf5864a6b7088eb28da30b9ccf61ba8d90054f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjNjYmY1ODY0YTZiNzA4OGViMjhkYTMwYjljY2Y2MWJhOGQ5MDA1NGY=", "commit": {"author": {"name": "Andy Russell", "email": "arussell123@gmail.com", "date": "2019-05-22T20:56:51Z"}, "committer": {"name": "Andy Russell", "email": "arussell123@gmail.com", "date": "2019-05-23T15:13:48Z"}, "message": "tweak discriminant on non-nullary enum diagnostic\n\nAdds notes pointing at the non-nullary variants, and uses \"custom\ndiscriminant\" language to be consistent with the Reference.", "tree": {"sha": "7afa8409d7057cf1b860df2ead27eb85cda61fab", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7afa8409d7057cf1b860df2ead27eb85cda61fab"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3cbf5864a6b7088eb28da30b9ccf61ba8d90054f", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQFKBAABCAA0FiEELriChyEaiMu0yCg7viIhAz7bw3QFAlzmuLQWHGFydXNzZWxs\nMTIzQGdtYWlsLmNvbQAKCRC+IiEDPtvDdKKKB/0ZG0sdCRGAq8+4dB5JyJqMxHd3\nKRy+lginMvrILCUM6Xcrz73+C3ETBZPra2i5exf7rSv+t+/KsA2tJzmWtvfShH0W\nnjLgT5PukKQeX9/QjuyuMhz/k7q/+Q0uTyzCma0x2Rs3tpv8nouabKeJqIFIgc9H\nuaJKNm7/UDj3nTlI/PvdcjsDouqJaE2zCnNEvBzWuc6U0yFVcYhRVYbc519mGQmh\nM9RXouDi5NDAlTaJYDhAqQOU0tTBJY+UEdSw7D3dvuT8zimESBRwtsfrcCDVdez9\nuKsX0YhNl9aWIGKblluVIQBVN03UNxPXTDdMN07WXXFMtgAfIKfqDkrP23dg\n=UN9E\n-----END PGP SIGNATURE-----", "payload": "tree 7afa8409d7057cf1b860df2ead27eb85cda61fab\nparent f688ba608923bdbf6b46ec65af2f6464b6233a75\nauthor Andy Russell <arussell123@gmail.com> 1558558611 -0400\ncommitter Andy Russell <arussell123@gmail.com> 1558624428 -0400\n\ntweak discriminant on non-nullary enum diagnostic\n\nAdds notes pointing at the non-nullary variants, and uses \"custom\ndiscriminant\" language to be consistent with the Reference.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3cbf5864a6b7088eb28da30b9ccf61ba8d90054f", "html_url": "https://github.com/rust-lang/rust/commit/3cbf5864a6b7088eb28da30b9ccf61ba8d90054f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3cbf5864a6b7088eb28da30b9ccf61ba8d90054f/comments", "author": {"login": "euclio", "id": 1372438, "node_id": "MDQ6VXNlcjEzNzI0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1372438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/euclio", "html_url": "https://github.com/euclio", "followers_url": "https://api.github.com/users/euclio/followers", "following_url": "https://api.github.com/users/euclio/following{/other_user}", "gists_url": "https://api.github.com/users/euclio/gists{/gist_id}", "starred_url": "https://api.github.com/users/euclio/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/euclio/subscriptions", "organizations_url": "https://api.github.com/users/euclio/orgs", "repos_url": "https://api.github.com/users/euclio/repos", "events_url": "https://api.github.com/users/euclio/events{/privacy}", "received_events_url": "https://api.github.com/users/euclio/received_events", "type": "User", "site_admin": false}, "committer": {"login": "euclio", "id": 1372438, "node_id": "MDQ6VXNlcjEzNzI0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1372438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/euclio", "html_url": "https://github.com/euclio", "followers_url": "https://api.github.com/users/euclio/followers", "following_url": "https://api.github.com/users/euclio/following{/other_user}", "gists_url": "https://api.github.com/users/euclio/gists{/gist_id}", "starred_url": "https://api.github.com/users/euclio/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/euclio/subscriptions", "organizations_url": "https://api.github.com/users/euclio/orgs", "repos_url": "https://api.github.com/users/euclio/repos", "events_url": "https://api.github.com/users/euclio/events{/privacy}", "received_events_url": "https://api.github.com/users/euclio/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f688ba608923bdbf6b46ec65af2f6464b6233a75", "url": "https://api.github.com/repos/rust-lang/rust/commits/f688ba608923bdbf6b46ec65af2f6464b6233a75", "html_url": "https://github.com/rust-lang/rust/commit/f688ba608923bdbf6b46ec65af2f6464b6233a75"}], "stats": {"total": 89, "additions": 63, "deletions": 26}, "files": [{"sha": "8ac5beb21b5308405f13fba01b6a67725a07846f", "filename": "src/libsyntax/parse/diagnostics.rs", "status": "modified", "additions": 44, "deletions": 3, "changes": 47, "blob_url": "https://github.com/rust-lang/rust/blob/3cbf5864a6b7088eb28da30b9ccf61ba8d90054f/src%2Flibsyntax%2Fparse%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3cbf5864a6b7088eb28da30b9ccf61ba8d90054f/src%2Flibsyntax%2Fparse%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fparse%2Fdiagnostics.rs?ref=3cbf5864a6b7088eb28da30b9ccf61ba8d90054f", "patch": "@@ -1,16 +1,19 @@\n use crate::ast;\n-use crate::ast::{BlockCheckMode, Expr, ExprKind, Item, ItemKind, Pat, PatKind, QSelf, Ty, TyKind};\n-use crate::parse::parser::{BlockMode, PathStyle, TokenType, SemiColonMode};\n+use crate::ast::{\n+    BlockCheckMode, Expr, ExprKind, Item, ItemKind, Pat, PatKind, QSelf, Ty, TyKind, VariantData,\n+};\n+use crate::parse::parser::{BlockMode, PathStyle, SemiColonMode, TokenType};\n use crate::parse::token;\n use crate::parse::PResult;\n use crate::parse::Parser;\n use crate::print::pprust;\n use crate::ptr::P;\n+use crate::source_map::Spanned;\n use crate::symbol::kw;\n use crate::ThinVec;\n use errors::{Applicability, DiagnosticBuilder};\n-use syntax_pos::Span;\n use log::debug;\n+use syntax_pos::Span;\n \n pub trait RecoverQPath: Sized + 'static {\n     const PATH_STYLE: PathStyle = PathStyle::Expr;\n@@ -79,6 +82,44 @@ impl<'a> Parser<'a> {\n         }\n     }\n \n+    crate fn maybe_report_invalid_custom_discriminants(\n+        &mut self,\n+        discriminant_spans: Vec<Span>,\n+        variants: &[Spanned<ast::Variant_>],\n+    ) {\n+        let has_fields = variants.iter().any(|variant| match variant.node.data {\n+            VariantData::Tuple(..) | VariantData::Struct(..) => true,\n+            VariantData::Unit(..) => false,\n+        });\n+\n+        if !discriminant_spans.is_empty() && has_fields {\n+            let mut err = self.struct_span_err(\n+                discriminant_spans.clone(),\n+                \"custom discriminant values are not allowed in enums with fields\",\n+            );\n+            for sp in discriminant_spans {\n+                err.span_label(sp, \"invalid custom discriminant\");\n+            }\n+            for variant in variants.iter() {\n+                if let VariantData::Struct(fields, ..) | VariantData::Tuple(fields, ..) =\n+                    &variant.node.data\n+                {\n+                    let fields = if fields.len() > 1 {\n+                        \"fields\"\n+                    } else {\n+                        \"a field\"\n+                    };\n+                    err.span_label(\n+                        variant.span,\n+                        &format!(\"variant with {fields} defined here\", fields = fields),\n+                    );\n+\n+                }\n+            }\n+            err.emit();\n+        }\n+    }\n+\n     crate fn maybe_recover_from_bad_type_plus(\n         &mut self,\n         allow_plus: bool,"}, {"sha": "8f8473c483de5a4a54d489f0d1f01be19c0d0832", "filename": "src/libsyntax/parse/parser.rs", "status": "modified", "additions": 1, "deletions": 13, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/3cbf5864a6b7088eb28da30b9ccf61ba8d90054f/src%2Flibsyntax%2Fparse%2Fparser.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3cbf5864a6b7088eb28da30b9ccf61ba8d90054f/src%2Flibsyntax%2Fparse%2Fparser.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fparse%2Fparser.rs?ref=3cbf5864a6b7088eb28da30b9ccf61ba8d90054f", "patch": "@@ -7464,7 +7464,6 @@ impl<'a> Parser<'a> {\n     /// Parses the part of an enum declaration following the `{`.\n     fn parse_enum_def(&mut self, _generics: &ast::Generics) -> PResult<'a, EnumDef> {\n         let mut variants = Vec::new();\n-        let mut all_nullary = true;\n         let mut any_disr = vec![];\n         while self.token != token::CloseDelim(token::Brace) {\n             let variant_attrs = self.parse_outer_attributes()?;\n@@ -7476,11 +7475,9 @@ impl<'a> Parser<'a> {\n             let ident = self.parse_ident()?;\n             if self.check(&token::OpenDelim(token::Brace)) {\n                 // Parse a struct variant.\n-                all_nullary = false;\n                 let (fields, recovered) = self.parse_record_struct_body()?;\n                 struct_def = VariantData::Struct(fields, recovered);\n             } else if self.check(&token::OpenDelim(token::Paren)) {\n-                all_nullary = false;\n                 struct_def = VariantData::Tuple(\n                     self.parse_tuple_struct_body()?,\n                     ast::DUMMY_NODE_ID,\n@@ -7524,16 +7521,7 @@ impl<'a> Parser<'a> {\n             }\n         }\n         self.expect(&token::CloseDelim(token::Brace))?;\n-        if !any_disr.is_empty() && !all_nullary {\n-            let mut err = self.struct_span_err(\n-                any_disr.clone(),\n-                \"discriminator values can only be used with a field-less enum\",\n-            );\n-            for sp in any_disr {\n-                err.span_label(sp, \"only valid in field-less enums\");\n-            }\n-            err.emit();\n-        }\n+        self.maybe_report_invalid_custom_discriminants(any_disr, &variants);\n \n         Ok(ast::EnumDef { variants })\n     }"}, {"sha": "f95005cd914838605d401bc8ff71edb7c4f1f2ee", "filename": "src/test/ui/parser/issue-17383.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/3cbf5864a6b7088eb28da30b9ccf61ba8d90054f/src%2Ftest%2Fui%2Fparser%2Fissue-17383.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3cbf5864a6b7088eb28da30b9ccf61ba8d90054f/src%2Ftest%2Fui%2Fparser%2Fissue-17383.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fissue-17383.rs?ref=3cbf5864a6b7088eb28da30b9ccf61ba8d90054f", "patch": "@@ -1,6 +1,6 @@\n enum X {\n     A = 3,\n-    //~^ ERROR discriminator values can only be used with a field-less enum\n+    //~^ ERROR custom discriminant values are not allowed in enums with fields\n     B(usize)\n }\n "}, {"sha": "37abd0ff5e1f49cb8248347aae0f20f7d6bfb6d2", "filename": "src/test/ui/parser/issue-17383.stderr", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/3cbf5864a6b7088eb28da30b9ccf61ba8d90054f/src%2Ftest%2Fui%2Fparser%2Fissue-17383.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/3cbf5864a6b7088eb28da30b9ccf61ba8d90054f/src%2Ftest%2Fui%2Fparser%2Fissue-17383.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fissue-17383.stderr?ref=3cbf5864a6b7088eb28da30b9ccf61ba8d90054f", "patch": "@@ -1,8 +1,11 @@\n-error: discriminator values can only be used with a field-less enum\n+error: custom discriminant values are not allowed in enums with fields\n   --> $DIR/issue-17383.rs:2:9\n    |\n LL |     A = 3,\n-   |         ^ only valid in field-less enums\n+   |         ^ invalid custom discriminant\n+LL |\n+LL |     B(usize)\n+   |     -------- variant with a field defined here\n \n error: aborting due to previous error\n "}, {"sha": "305edc4ad5a0489d3e178abfad86a064ba651ec2", "filename": "src/test/ui/parser/tag-variant-disr-non-nullary.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/3cbf5864a6b7088eb28da30b9ccf61ba8d90054f/src%2Ftest%2Fui%2Fparser%2Ftag-variant-disr-non-nullary.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3cbf5864a6b7088eb28da30b9ccf61ba8d90054f/src%2Ftest%2Fui%2Fparser%2Ftag-variant-disr-non-nullary.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Ftag-variant-disr-non-nullary.rs?ref=3cbf5864a6b7088eb28da30b9ccf61ba8d90054f", "patch": "@@ -1,11 +1,12 @@\n enum Color {\n     Red = 0xff0000,\n-    //~^ ERROR discriminator values can only be used with a field-less enum\n+    //~^ ERROR custom discriminant values are not allowed in enums with fields\n     Green = 0x00ff00,\n     Blue = 0x0000ff,\n     Black = 0x000000,\n     White = 0xffffff,\n     Other(usize),\n+    Other2(usize, usize),\n }\n \n fn main() {}"}, {"sha": "2d3b28395312438439814cdf3067eb0c6a8aab5c", "filename": "src/test/ui/parser/tag-variant-disr-non-nullary.stderr", "status": "modified", "additions": 10, "deletions": 6, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/3cbf5864a6b7088eb28da30b9ccf61ba8d90054f/src%2Ftest%2Fui%2Fparser%2Ftag-variant-disr-non-nullary.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/3cbf5864a6b7088eb28da30b9ccf61ba8d90054f/src%2Ftest%2Fui%2Fparser%2Ftag-variant-disr-non-nullary.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Ftag-variant-disr-non-nullary.stderr?ref=3cbf5864a6b7088eb28da30b9ccf61ba8d90054f", "patch": "@@ -1,17 +1,21 @@\n-error: discriminator values can only be used with a field-less enum\n+error: custom discriminant values are not allowed in enums with fields\n   --> $DIR/tag-variant-disr-non-nullary.rs:2:11\n    |\n LL |     Red = 0xff0000,\n-   |           ^^^^^^^^ only valid in field-less enums\n+   |           ^^^^^^^^ invalid custom discriminant\n LL |\n LL |     Green = 0x00ff00,\n-   |             ^^^^^^^^ only valid in field-less enums\n+   |             ^^^^^^^^ invalid custom discriminant\n LL |     Blue = 0x0000ff,\n-   |            ^^^^^^^^ only valid in field-less enums\n+   |            ^^^^^^^^ invalid custom discriminant\n LL |     Black = 0x000000,\n-   |             ^^^^^^^^ only valid in field-less enums\n+   |             ^^^^^^^^ invalid custom discriminant\n LL |     White = 0xffffff,\n-   |             ^^^^^^^^ only valid in field-less enums\n+   |             ^^^^^^^^ invalid custom discriminant\n+LL |     Other(usize),\n+   |     ------------ variant with a field defined here\n+LL |     Other2(usize, usize),\n+   |     -------------------- variant with fields defined here\n \n error: aborting due to previous error\n "}]}