{"sha": "a2da4af33c5e6a22fff0a223f99d53cba4a5aa52", "node_id": "C_kwDOAAsO6NoAKGEyZGE0YWYzM2M1ZTZhMjJmZmYwYTIyM2Y5OWQ1M2NiYTRhNWFhNTI", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-06-05T07:03:50Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-06-05T07:03:50Z"}, "message": "Auto merge of #97577 - betrusted-io:add-xous-target, r=nagisa\n\nriscv32imac-unknown-xous-elf: add target\n\nThis PR starts the process of upstreaming support for our operating system, thanks to a suggestion from `@yaahc` [on Twitter](https://twitter.com/yaahc_/status/1530558574706839567?s=20&t=Mgkn1LEYvGU6FEi5SpZRsA). We have maintained a fork of Rust and have made changes to improve support for our platform since Rust 1.51. Now we would like to upstream these changes.\n\nXous is a microkernel operating system designed to run on small systems. The kernel contains a wide range of userspace processes that provide common services such as console output, networking, and time access.\n\nThe kernel and its services are completely written in Rust using a custom build of libstd. This adds support for this target to upstream Rust so that we can drop support for our out-of-tree `target.json` file.\n\nThis first patch adds a Tier 3 target for Xous running on RISC-V. Future patches will add libstd support, but those patches require changes to `dlmalloc` and `compiler_builtins`.\n\n> Tier 3 policy:\n>\n> A tier 3 target must have a designated developer or developers (the \"target maintainers\") on record to be CCed when issues arise regarding the target. (The mechanism to track and CC such developers may evolve over time.)\n\nI will be the target maintainer for this target on matters that pertain to the `xous` part of the triple. For matters pertaining to the `riscv32imac` part of the triple, there should be no difference from all other `riscv` targets. If there are issues, I will address issues regarding the target.\n\n> Targets must use naming consistent with any existing targets; for instance, a target for the same CPU or OS as an existing Rust target should use the same name for that CPU or OS. Targets should normally use the same names and naming conventions as used elsewhere in the broader ecosystem beyond Rust (such as in other toolchains), unless they have a very good reason to diverge. Changing the name of a target can be highly disruptive, especially once the target reaches a higher tier, so getting the name right is important even for a tier 3 target.\n\nThis is a new OS, so I have taken the `riscv32imac-unknown-none-elf` target and changed the `os` section of the triple. This follows convention on targets such as `riscv32gc-unknown-linux-gnu` and `mipsel-unknown-linux-uclibc`. An argument could be made for omitting the `-elf` section of the triple, such as `riscv32imc-esp-espidf`, however I'm not certain what benefit that has.\n\n> Target names should not introduce undue confusion or ambiguity unless absolutely necessary to maintain ecosystem compatibility. For example, if the name of the target makes people extremely likely to form incorrect beliefs about what it targets, the name should be changed or augmented to disambiguate it.\n\nI feel that the target name does not introduce any ambiguity.\n\n> Tier 3 targets may have unusual requirements to build or use, but must not create legal issues or impose onerous legal terms for the Rust project or for Rust developers or users.\n\nThe only unusual requirement for building the `compiler-builtins` crate is a standard RISC-V C compiler supported by `cc-rs`, and using this target does not require any additional software beyond what is shipped by `rustup`.\n\n> The target must not introduce license incompatibilities.\n\nAll of the additional code will use Apache-2.0.\n\n> Anything added to the Rust repository must be under the standard Rust license (MIT OR Apache-2.0).\n\nAgreed, and there is no problem here.\n\n> The target must not cause the Rust tools or libraries built for any other host (even when supporting cross-compilation to the target) to depend on any new dependency less permissive than the Rust licensing policy. This applies whether the dependency is a Rust crate that would require adding new license exceptions (as specified by the tidy tool in the rust-lang/rust repository), or whether the dependency is a native library or binary. In other words, the introduction of the target must not cause a user installing or running a version of Rust or the Rust tools to be subject to any new license requirements.\n\nThe only new dependency will be the `xous` crate, which is licensed `MIT OR Apache-2.0`\n\n> Compiling, linking, and emitting functional binaries, libraries, or other code for the target (whether hosted on the target itself or cross-compiling from another target) must not depend on proprietary (non-FOSS) libraries. Host tools built for the target itself may depend on the ordinary runtime libraries supplied by the platform and commonly used by other applications built for the target, but those libraries must not be required for code generation for the target; cross-compilation to the target must not require such libraries at all. For instance, rustc built for the target may depend on a common proprietary C runtime library or console output library, but must not depend on a proprietary code generation library or code optimization library. Rust's license permits such combinations, but the Rust project has no interest in maintaining such combinations within the scope of Rust itself, even at tier 3.\n\nLinking is performed by `rust-lld`\n\n> \"onerous\" here is an intentionally subjective term. At a minimum, \"onerous\" legal/licensing terms include but are not limited to: non-disclosure requirements, non-compete requirements, contributor license agreements (CLAs) or equivalent, \"non-commercial\"/\"research-only\"/etc terms, requirements conditional on the employer or employment of any particular Rust developers, revocable terms, any requirements that create liability for the Rust project or its developers or users, or any requirements that adversely affect the livelihood or prospects of the Rust project or its developers or users.\n\nThere are no terms. Xous is completely open. It runs on open hardware. We even provide the source to the CPU.\n\n> Neither this policy nor any decisions made regarding targets shall create any binding agreement or estoppel by any party. If any member of an approving Rust team serves as one of the maintainers of a target, or has any legal or employment requirement (explicit or implicit) that might affect their decisions regarding a target, they must recuse themselves from any approval decisions regarding the target's tier status, though they may otherwise participate in discussions.\n\nThis paragraph makes sense, but I don't think it's directed at me.\n\n> This requirement does not prevent part or all of this policy from being cited in an explicit contract or work agreement (e.g. to implement or maintain support for a target). This requirement exists to ensure that a developer or team responsible for reviewing and approving a target does not face any legal threats or obligations that would prevent them from freely exercising their judgment in such approval, even if such judgment involves subjective matters or goes beyond the letter of these requirements.\n\nThis paragraph also does not appear to be directed at me.\n\n> Tier 3 targets should attempt to implement as much of the standard libraries as possible and appropriate (core for most targets, alloc for targets that can support dynamic memory allocation, std for targets with an operating system or equivalent layer of system-provided functionality), but may leave some code unimplemented (either unavailable or stubbed out as appropriate), whether because the target makes it impossible to implement or challenging to implement. The authors of pull requests are not obligated to avoid calling any portions of the standard library on the basis of a tier 3 target not implementing those portions.\n\nSo far we have:\n\n * Thread\n * Mutexex\n * Condvar\n * TcpStream\n * TcpListener\n * UdpSocket\n * DateTime\n * alloc\n\nThese will be merged as part of libstd in a future patch once I submit support for Xous in `dlmalloc` and `compiler-builtins`.\n\n> The target must provide documentation for the Rust community explaining how to build for the target, using cross-compilation if possible. If the target supports running binaries, or running tests (even if they do not pass), the documentation must explain how to run such binaries or tests for the target, using emulation if possible or dedicated hardware if necessary.\n\nTesting is currently done on real hardware or in a Renode emulator. I can add documentation on how to do this in a future patch, and I would need instructions on where to add said documentation.\n\n> Tier 3 targets must not impose burden on the authors of pull requests, or other developers in the community, to maintain the target. In particular, do not post comments (automated or manual) on a PR that derail or suggest a block on the PR based on a tier 3 target. Do not send automated messages or notifications (via any medium, including via `@)` to a PR author or others involved with a PR regarding a tier 3 target, unless they have opted into such messages.\n\nAlright.\n\n> Backlinks such as those generated by the issue/PR tracker when linking to an issue or PR are not considered a violation of this policy, within reason. However, such messages (even on a separate repository) must not generate notifications to anyone involved with a PR who has not requested such notifications.\n\nSounds good.\n\n> Patches adding or updating tier 3 targets must not break any existing tier 2 or tier 1 target, and must not knowingly break another tier 3 target without approval of either the compiler team or the maintainers of the other tier 3 target.\n\nThis shouldn't affect any other targets, so this is understood.\n\n> In particular, this may come up when working on closely related targets, such as variations of the same architecture with different features. Avoid introducing unconditional uses of features that another variation of the target may not have; use conditional compilation or runtime detection, as appropriate, to let each target run code supported by that target.\n\nThis shouldn't come up right away. `xous` is a new operating system, and most features are keyed off of `target(os = \"xous\")` rather than a given architecture.", "tree": {"sha": "54f0d3c42d307fa5715bf835ba9c00610f46dda6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/54f0d3c42d307fa5715bf835ba9c00610f46dda6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a2da4af33c5e6a22fff0a223f99d53cba4a5aa52", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a2da4af33c5e6a22fff0a223f99d53cba4a5aa52", "html_url": "https://github.com/rust-lang/rust/commit/a2da4af33c5e6a22fff0a223f99d53cba4a5aa52", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a2da4af33c5e6a22fff0a223f99d53cba4a5aa52/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "656eec8785e25a7fba568dba83190df2b0981daa", "url": "https://api.github.com/repos/rust-lang/rust/commits/656eec8785e25a7fba568dba83190df2b0981daa", "html_url": "https://github.com/rust-lang/rust/commit/656eec8785e25a7fba568dba83190df2b0981daa"}, {"sha": "dc789701a022e7ef305a825b26744b26a9b6a248", "url": "https://api.github.com/repos/rust-lang/rust/commits/dc789701a022e7ef305a825b26744b26a9b6a248", "html_url": "https://github.com/rust-lang/rust/commit/dc789701a022e7ef305a825b26744b26a9b6a248"}], "stats": {"total": 79, "additions": 78, "deletions": 1}, "files": [{"sha": "0f5db8982e84365582108381ef5bc315f769058f", "filename": "compiler/rustc_target/src/spec/mod.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/a2da4af33c5e6a22fff0a223f99d53cba4a5aa52/compiler%2Frustc_target%2Fsrc%2Fspec%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a2da4af33c5e6a22fff0a223f99d53cba4a5aa52/compiler%2Frustc_target%2Fsrc%2Fspec%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Fmod.rs?ref=a2da4af33c5e6a22fff0a223f99d53cba4a5aa52", "patch": "@@ -984,6 +984,7 @@ supported_targets! {\n     (\"riscv32imc-unknown-none-elf\", riscv32imc_unknown_none_elf),\n     (\"riscv32imc-esp-espidf\", riscv32imc_esp_espidf),\n     (\"riscv32imac-unknown-none-elf\", riscv32imac_unknown_none_elf),\n+    (\"riscv32imac-unknown-xous-elf\", riscv32imac_unknown_xous_elf),\n     (\"riscv32gc-unknown-linux-gnu\", riscv32gc_unknown_linux_gnu),\n     (\"riscv32gc-unknown-linux-musl\", riscv32gc_unknown_linux_musl),\n     (\"riscv64imac-unknown-none-elf\", riscv64imac_unknown_none_elf),"}, {"sha": "b46ca159370d01517f897bb9b62a258387f05eed", "filename": "compiler/rustc_target/src/spec/riscv32imac_unknown_xous_elf.rs", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/a2da4af33c5e6a22fff0a223f99d53cba4a5aa52/compiler%2Frustc_target%2Fsrc%2Fspec%2Friscv32imac_unknown_xous_elf.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a2da4af33c5e6a22fff0a223f99d53cba4a5aa52/compiler%2Frustc_target%2Fsrc%2Fspec%2Friscv32imac_unknown_xous_elf.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Friscv32imac_unknown_xous_elf.rs?ref=a2da4af33c5e6a22fff0a223f99d53cba4a5aa52", "patch": "@@ -0,0 +1,24 @@\n+use crate::spec::{LinkerFlavor, LldFlavor, PanicStrategy, RelocModel};\n+use crate::spec::{Target, TargetOptions};\n+\n+pub fn target() -> Target {\n+    Target {\n+        data_layout: \"e-m:e-p:32:32-i64:64-n32-S128\".into(),\n+        llvm_target: \"riscv32\".into(),\n+        pointer_width: 32,\n+        arch: \"riscv32\".into(),\n+\n+        options: TargetOptions {\n+            os: \"xous\".into(),\n+            linker_flavor: LinkerFlavor::Lld(LldFlavor::Ld),\n+            linker: Some(\"rust-lld\".into()),\n+            cpu: \"generic-rv32\".into(),\n+            max_atomic_width: Some(32),\n+            features: \"+m,+a,+c\".into(),\n+            executables: true,\n+            panic_strategy: PanicStrategy::Abort,\n+            relocation_model: RelocModel::Static,\n+            ..Default::default()\n+        },\n+    }\n+}"}, {"sha": "8e2d44c1812150c5defee80e0e4c403357411a77", "filename": "src/doc/rustc/src/SUMMARY.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/a2da4af33c5e6a22fff0a223f99d53cba4a5aa52/src%2Fdoc%2Frustc%2Fsrc%2FSUMMARY.md", "raw_url": "https://github.com/rust-lang/rust/raw/a2da4af33c5e6a22fff0a223f99d53cba4a5aa52/src%2Fdoc%2Frustc%2Fsrc%2FSUMMARY.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Frustc%2Fsrc%2FSUMMARY.md?ref=a2da4af33c5e6a22fff0a223f99d53cba4a5aa52", "patch": "@@ -22,6 +22,7 @@\n     - [m68k-unknown-linux-gnu](platform-support/m68k-unknown-linux-gnu.md)\n     - [mips64-openwrt-linux-musl](platform-support/mips64-openwrt-linux-musl.md)\n     - [nvptx64-nvidia-cuda](platform-support/nvptx64-nvidia-cuda.md)\n+    - [riscv32imac-unknown-xous-elf](platform-support/riscv32imac-unknown-xous-elf.md)\n     - [*-pc-windows-gnullvm](platform-support/pc-windows-gnullvm.md)\n     - [*-unknown-openbsd](platform-support/openbsd.md)\n     - [wasm64-unknown-unknown](platform-support/wasm64-unknown-unknown.md)"}, {"sha": "4ac09711b0a09e8872dd4eeaee5d6d05478a1149", "filename": "src/doc/rustc/src/platform-support.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/a2da4af33c5e6a22fff0a223f99d53cba4a5aa52/src%2Fdoc%2Frustc%2Fsrc%2Fplatform-support.md", "raw_url": "https://github.com/rust-lang/rust/raw/a2da4af33c5e6a22fff0a223f99d53cba4a5aa52/src%2Fdoc%2Frustc%2Fsrc%2Fplatform-support.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Frustc%2Fsrc%2Fplatform-support.md?ref=a2da4af33c5e6a22fff0a223f99d53cba4a5aa52", "patch": "@@ -275,6 +275,7 @@ target | std | host | notes\n `riscv32gc-unknown-linux-gnu` |   |   | RISC-V Linux (kernel 5.4, glibc 2.33)\n `riscv32gc-unknown-linux-musl` |   |   | RISC-V Linux (kernel 5.4, musl + RISCV32 support patches)\n `riscv32im-unknown-none-elf` | * |  | Bare RISC-V (RV32IM ISA)\n+[`riscv32imac-unknown-xous-elf`](platform-support/riscv32imac-unknown-xous-elf.md) | ? |  | RISC-V Xous (RV32IMAC ISA)\n `riscv32imc-esp-espidf` | \u2713 |  | RISC-V ESP-IDF\n `riscv64gc-unknown-freebsd` |   |   | RISC-V FreeBSD\n `riscv64gc-unknown-linux-musl` |   |   | RISC-V Linux (kernel 4.20, musl 1.2.0)"}, {"sha": "f024cd25bf7e1c7531eed61a78465517530c4de8", "filename": "src/doc/rustc/src/platform-support/riscv32imac-unknown-xous-elf.md", "status": "added", "additions": 50, "deletions": 0, "changes": 50, "blob_url": "https://github.com/rust-lang/rust/blob/a2da4af33c5e6a22fff0a223f99d53cba4a5aa52/src%2Fdoc%2Frustc%2Fsrc%2Fplatform-support%2Friscv32imac-unknown-xous-elf.md", "raw_url": "https://github.com/rust-lang/rust/raw/a2da4af33c5e6a22fff0a223f99d53cba4a5aa52/src%2Fdoc%2Frustc%2Fsrc%2Fplatform-support%2Friscv32imac-unknown-xous-elf.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Frustc%2Fsrc%2Fplatform-support%2Friscv32imac-unknown-xous-elf.md?ref=a2da4af33c5e6a22fff0a223f99d53cba4a5aa52", "patch": "@@ -0,0 +1,50 @@\n+# riscv32imac-unknown-xous-elf\n+\n+**Tier: 3**\n+\n+Xous microkernel, message-based operating system that powers devices such as Precursor and Betrusted. The operating system is written entirely in Rust, so no additional software is required to compile programs for Xous.\n+\n+## Target maintainers\n+\n+- [@xobs](https://github.com/xobs)\n+\n+## Requirements\n+\n+\n+Building the target itself requires a RISC-V compiler that is supported by `cc-rs`. For example, you can use the prebuilt [xPack](https://github.com/xpack-dev-tools/riscv-none-elf-gcc-xpack/releases/latest) toolchain.\n+\n+Cross-compiling programs does not require any additional software beyond the toolchain. Prebuilt versions of the toolchain are available [from Betrusted](https://github.com/betrusted-io/rust/releases).\n+\n+## Building the target\n+\n+The target can be built by enabling it for a `rustc` build.\n+\n+```toml\n+[build]\n+target = [\"riscv32imac-unknown-xous-elf\"]\n+```\n+\n+Make sure your C compiler is included in `$PATH`, then add it to the `config.toml`:\n+\n+```toml\n+[target.riscv32imac-unknown-xous-elf]\n+cc = \"riscv-none-elf-gcc\"\n+ar = \"riscv-none-elf-ar\"\n+```\n+\n+## Building Rust programs\n+\n+Rust does not yet ship pre-compiled artifacts for this target. To compile for\n+this target, you will need to do one of the following:\n+\n+* Build Rust with the target enabled (see \"Building the target\" above)\n+* Build your own copy of `core` by using `build-std` or similar\n+* Download a prebuilt toolchain [from Betrusted](https://github.com/betrusted-io/rust/releases)\n+\n+## Cross-compilation\n+\n+This target can be cross-compiled from any host.\n+\n+## Testing\n+\n+Currently there is no support to run the rustc test suite for this target."}, {"sha": "a1f7e17d778c50cb8202c172945d8224ba13d4ec", "filename": "src/test/ui/check-cfg/well-known-values.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a2da4af33c5e6a22fff0a223f99d53cba4a5aa52/src%2Ftest%2Fui%2Fcheck-cfg%2Fwell-known-values.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/a2da4af33c5e6a22fff0a223f99d53cba4a5aa52/src%2Ftest%2Fui%2Fcheck-cfg%2Fwell-known-values.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcheck-cfg%2Fwell-known-values.stderr?ref=a2da4af33c5e6a22fff0a223f99d53cba4a5aa52", "patch": "@@ -7,7 +7,7 @@ LL | #[cfg(target_os = \"linuz\")]\n    |                   help: did you mean: `\"linux\"`\n    |\n    = note: `#[warn(unexpected_cfgs)]` on by default\n-   = note: expected values for `target_os` are: android, cuda, dragonfly, emscripten, espidf, freebsd, fuchsia, haiku, hermit, horizon, illumos, ios, l4re, linux, macos, netbsd, none, openbsd, psp, redox, solaris, solid_asp3, tvos, uefi, unknown, vxworks, wasi, windows\n+   = note: expected values for `target_os` are: android, cuda, dragonfly, emscripten, espidf, freebsd, fuchsia, haiku, hermit, horizon, illumos, ios, l4re, linux, macos, netbsd, none, openbsd, psp, redox, solaris, solid_asp3, tvos, uefi, unknown, vxworks, wasi, windows, xous\n \n warning: unexpected `cfg` condition value\n   --> $DIR/well-known-values.rs:14:7"}]}