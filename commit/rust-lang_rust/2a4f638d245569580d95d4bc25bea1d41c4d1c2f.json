{"sha": "2a4f638d245569580d95d4bc25bea1d41c4d1c2f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjJhNGY2MzhkMjQ1NTY5NTgwZDk1ZDRiYzI1YmVhMWQ0MWM0ZDFjMmY=", "commit": {"author": {"name": "Yuki Okushi", "email": "huyuumi.dev@gmail.com", "date": "2019-12-06T15:09:52Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-12-06T15:09:52Z"}, "message": "Rollup merge of #66846 - gizmondo:master, r=michaelwoerister\n\nMake try_mark_previous_green aware of cycles.\n\nFixes #61323\n\nr? @michaelwoerister", "tree": {"sha": "74845018d9b360a864894399636cdee0e98cd632", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/74845018d9b360a864894399636cdee0e98cd632"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2a4f638d245569580d95d4bc25bea1d41c4d1c2f", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJd6m9ACRBK7hj4Ov3rIwAAdHIIAFDVHhcNw2UhDmnFOJ73VgNb\n1/Es+ryCE4HZcOJKRpouajRKg8zDp+2sB/IPX8VW/h13ONbA3fYAmDTJ6YxsV2hQ\nuqzbK1IymKy28KDkGxgyHvYLc6oEhtPR7iUdXUgKgxHdYBDOEqi9a+RKht6CC2wq\nBPfvD0cyB7oCEPJaPbL6VprzVhp1TL//3lMQGlXQAYSU6qd0HurRZkw1uKHlOrK8\nTEu/YMkwKnMUukdu9ZqQ5DVTMB25Qjw74YJEJZ8U68hN/J88Riyzo/4i1C9q7HQ4\naAy8Fe0RqZNDDBWQ7ThEKckdsOp+6P71Z48P18J3VsVMFId2AUB7m26LVOEMWLE=\n=YFOn\n-----END PGP SIGNATURE-----\n", "payload": "tree 74845018d9b360a864894399636cdee0e98cd632\nparent d0126e8ed3cc0d6fcb9dd44c36a46f9ce65010a0\nparent de255a9163963e62a06c981b71041f071058ec5b\nauthor Yuki Okushi <huyuumi.dev@gmail.com> 1575644992 +0900\ncommitter GitHub <noreply@github.com> 1575644992 +0900\n\nRollup merge of #66846 - gizmondo:master, r=michaelwoerister\n\nMake try_mark_previous_green aware of cycles.\n\nFixes #61323\n\nr? @michaelwoerister\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2a4f638d245569580d95d4bc25bea1d41c4d1c2f", "html_url": "https://github.com/rust-lang/rust/commit/2a4f638d245569580d95d4bc25bea1d41c4d1c2f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2a4f638d245569580d95d4bc25bea1d41c4d1c2f/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d0126e8ed3cc0d6fcb9dd44c36a46f9ce65010a0", "url": "https://api.github.com/repos/rust-lang/rust/commits/d0126e8ed3cc0d6fcb9dd44c36a46f9ce65010a0", "html_url": "https://github.com/rust-lang/rust/commit/d0126e8ed3cc0d6fcb9dd44c36a46f9ce65010a0"}, {"sha": "de255a9163963e62a06c981b71041f071058ec5b", "url": "https://api.github.com/repos/rust-lang/rust/commits/de255a9163963e62a06c981b71041f071058ec5b", "html_url": "https://github.com/rust-lang/rust/commit/de255a9163963e62a06c981b71041f071058ec5b"}], "stats": {"total": 36, "additions": 31, "deletions": 5}, "files": [{"sha": "d952bf7ab9e2541ee18f8d4c62e4c8a3ea14a494", "filename": "src/librustc/dep_graph/graph.rs", "status": "modified", "additions": 16, "deletions": 5, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/2a4f638d245569580d95d4bc25bea1d41c4d1c2f/src%2Flibrustc%2Fdep_graph%2Fgraph.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2a4f638d245569580d95d4bc25bea1d41c4d1c2f/src%2Flibrustc%2Fdep_graph%2Fgraph.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fdep_graph%2Fgraph.rs?ref=2a4f638d245569580d95d4bc25bea1d41c4d1c2f", "patch": "@@ -710,14 +710,25 @@ impl DepGraph {\n                                 return None\n                             }\n                             None => {\n-                                if !tcx.sess.has_errors() {\n+                                if !tcx.sess.has_errors_or_delayed_span_bugs() {\n                                     bug!(\"try_mark_previous_green() - Forcing the DepNode \\\n                                           should have set its color\")\n                                 } else {\n-                                    // If the query we just forced has resulted\n-                                    // in some kind of compilation error, we\n-                                    // don't expect that the corresponding\n-                                    // dep-node color has been updated.\n+                                    // If the query we just forced has resulted in\n+                                    // some kind of compilation error, we cannot rely on\n+                                    // the dep-node color having been properly updated.\n+                                    // This means that the query system has reached an\n+                                    // invalid state. We let the compiler continue (by\n+                                    // returning `None`) so it can emit error messages\n+                                    // and wind down, but rely on the fact that this\n+                                    // invalid state will not be persisted to the\n+                                    // incremental compilation cache because of\n+                                    // compilation errors being present.\n+                                    debug!(\"try_mark_previous_green({:?}) - END - \\\n+                                            dependency {:?} resulted in compilation error\",\n+                                           dep_node,\n+                                           dep_dep_node);\n+                                    return None\n                                 }\n                             }\n                         }"}, {"sha": "448ce367b8c6b5b3216635c4f1f9a42ed807477f", "filename": "src/test/incremental/issue-61323.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/2a4f638d245569580d95d4bc25bea1d41c4d1c2f/src%2Ftest%2Fincremental%2Fissue-61323.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2a4f638d245569580d95d4bc25bea1d41c4d1c2f/src%2Ftest%2Fincremental%2Fissue-61323.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fincremental%2Fissue-61323.rs?ref=2a4f638d245569580d95d4bc25bea1d41c4d1c2f", "patch": "@@ -0,0 +1,15 @@\n+// revisions: rpass cfail\n+\n+enum A {\n+    //[cfail]~^ ERROR 3:1: 3:7: recursive type `A` has infinite size [E0072]\n+    B(C),\n+}\n+\n+#[cfg(rpass)]\n+struct C(Box<A>);\n+\n+#[cfg(cfail)]\n+struct C(A);\n+//[cfail]~^ ERROR 12:1: 12:13: recursive type `C` has infinite size [E0072]\n+\n+fn main() {}"}]}