{"sha": "5ab0548500a30134496ba28eb2291b0523b7346a", "node_id": "C_kwDOAAsO6NoAKDVhYjA1NDg1MDBhMzAxMzQ0OTZiYTI4ZWIyMjkxYjA1MjNiNzM0NmE", "commit": {"author": {"name": "Le\u00f3n Orell Valerian Liehr", "email": "liehr.exchange@gmx.net", "date": "2022-03-21T23:36:47Z"}, "committer": {"name": "Le\u00f3n Orell Valerian Liehr", "email": "liehr.exchange@gmx.net", "date": "2022-04-06T17:54:05Z"}, "message": "Stop flagging certain inner attrs as outer ones", "tree": {"sha": "91e1e599b70d72172ba6998a252f81ef0cccd83c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/91e1e599b70d72172ba6998a252f81ef0cccd83c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5ab0548500a30134496ba28eb2291b0523b7346a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5ab0548500a30134496ba28eb2291b0523b7346a", "html_url": "https://github.com/rust-lang/rust/commit/5ab0548500a30134496ba28eb2291b0523b7346a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5ab0548500a30134496ba28eb2291b0523b7346a/comments", "author": {"login": "fmease", "id": 14913065, "node_id": "MDQ6VXNlcjE0OTEzMDY1", "avatar_url": "https://avatars.githubusercontent.com/u/14913065?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fmease", "html_url": "https://github.com/fmease", "followers_url": "https://api.github.com/users/fmease/followers", "following_url": "https://api.github.com/users/fmease/following{/other_user}", "gists_url": "https://api.github.com/users/fmease/gists{/gist_id}", "starred_url": "https://api.github.com/users/fmease/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fmease/subscriptions", "organizations_url": "https://api.github.com/users/fmease/orgs", "repos_url": "https://api.github.com/users/fmease/repos", "events_url": "https://api.github.com/users/fmease/events{/privacy}", "received_events_url": "https://api.github.com/users/fmease/received_events", "type": "User", "site_admin": false}, "committer": {"login": "fmease", "id": 14913065, "node_id": "MDQ6VXNlcjE0OTEzMDY1", "avatar_url": "https://avatars.githubusercontent.com/u/14913065?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fmease", "html_url": "https://github.com/fmease", "followers_url": "https://api.github.com/users/fmease/followers", "following_url": "https://api.github.com/users/fmease/following{/other_user}", "gists_url": "https://api.github.com/users/fmease/gists{/gist_id}", "starred_url": "https://api.github.com/users/fmease/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fmease/subscriptions", "organizations_url": "https://api.github.com/users/fmease/orgs", "repos_url": "https://api.github.com/users/fmease/repos", "events_url": "https://api.github.com/users/fmease/events{/privacy}", "received_events_url": "https://api.github.com/users/fmease/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "201cf3dba302cec9b62e9b988858dcad47a88a4f", "url": "https://api.github.com/repos/rust-lang/rust/commits/201cf3dba302cec9b62e9b988858dcad47a88a4f", "html_url": "https://github.com/rust-lang/rust/commit/201cf3dba302cec9b62e9b988858dcad47a88a4f"}], "stats": {"total": 79, "additions": 54, "deletions": 25}, "files": [{"sha": "ece250f61d54f4b710edb29e3f57d6fa99235cbf", "filename": "compiler/rustc_builtin_macros/src/source_util.rs", "status": "modified", "additions": 7, "deletions": 4, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/5ab0548500a30134496ba28eb2291b0523b7346a/compiler%2Frustc_builtin_macros%2Fsrc%2Fsource_util.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5ab0548500a30134496ba28eb2291b0523b7346a/compiler%2Frustc_builtin_macros%2Fsrc%2Fsource_util.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_builtin_macros%2Fsrc%2Fsource_util.rs?ref=5ab0548500a30134496ba28eb2291b0523b7346a", "patch": "@@ -141,17 +141,20 @@ pub fn expand_include<'cx>(\n \n         fn make_items(mut self: Box<ExpandResult<'a>>) -> Option<SmallVec<[P<ast::Item>; 1]>> {\n             let mut ret = SmallVec::new();\n-            while self.p.token != token::Eof {\n+            loop {\n                 match self.p.parse_item(ForceCollect::No) {\n                     Err(mut err) => {\n                         err.emit();\n                         break;\n                     }\n                     Ok(Some(item)) => ret.push(item),\n                     Ok(None) => {\n-                        let token = pprust::token_to_string(&self.p.token);\n-                        let msg = format!(\"expected item, found `{}`\", token);\n-                        self.p.struct_span_err(self.p.token.span, &msg).emit();\n+                        if self.p.token != token::Eof {\n+                            let token = pprust::token_to_string(&self.p.token);\n+                            let msg = format!(\"expected item, found `{}`\", token);\n+                            self.p.struct_span_err(self.p.token.span, &msg).emit();\n+                        }\n+\n                         break;\n                     }\n                 }"}, {"sha": "1724bab5caa430f7d64a34ccecf0190d2260c1bb", "filename": "compiler/rustc_parse/src/parser/attr.rs", "status": "modified", "additions": 15, "deletions": 11, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/5ab0548500a30134496ba28eb2291b0523b7346a/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fattr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5ab0548500a30134496ba28eb2291b0523b7346a/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fattr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fattr.rs?ref=5ab0548500a30134496ba28eb2291b0523b7346a", "patch": "@@ -13,7 +13,7 @@ use tracing::debug;\n #[derive(Debug)]\n pub enum InnerAttrPolicy<'a> {\n     Permitted,\n-    Forbidden { reason: &'a str, saw_doc_comment: bool, prev_attr_sp: Option<Span> },\n+    Forbidden { reason: &'a str, saw_doc_comment: bool, prev_outer_attr_sp: Option<Span> },\n }\n \n const DEFAULT_UNEXPECTED_INNER_ATTR_ERR_MSG: &str = \"an inner attribute is not \\\n@@ -22,7 +22,7 @@ const DEFAULT_UNEXPECTED_INNER_ATTR_ERR_MSG: &str = \"an inner attribute is not \\\n pub(super) const DEFAULT_INNER_ATTR_FORBIDDEN: InnerAttrPolicy<'_> = InnerAttrPolicy::Forbidden {\n     reason: DEFAULT_UNEXPECTED_INNER_ATTR_ERR_MSG,\n     saw_doc_comment: false,\n-    prev_attr_sp: None,\n+    prev_outer_attr_sp: None,\n };\n \n enum OuterAttributeType {\n@@ -34,22 +34,24 @@ enum OuterAttributeType {\n impl<'a> Parser<'a> {\n     /// Parses attributes that appear before an item.\n     pub(super) fn parse_outer_attributes(&mut self) -> PResult<'a, AttrWrapper> {\n-        let mut attrs: Vec<ast::Attribute> = Vec::new();\n+        let mut outer_attrs: Vec<ast::Attribute> = Vec::new();\n         let mut just_parsed_doc_comment = false;\n         let start_pos = self.token_cursor.num_next_calls;\n         loop {\n             let attr = if self.check(&token::Pound) {\n+                let prev_outer_attr_sp = outer_attrs.last().map(|attr| attr.span);\n+\n                 let inner_error_reason = if just_parsed_doc_comment {\n                     \"an inner attribute is not permitted following an outer doc comment\"\n-                } else if !attrs.is_empty() {\n+                } else if prev_outer_attr_sp.is_some() {\n                     \"an inner attribute is not permitted following an outer attribute\"\n                 } else {\n                     DEFAULT_UNEXPECTED_INNER_ATTR_ERR_MSG\n                 };\n                 let inner_parse_policy = InnerAttrPolicy::Forbidden {\n                     reason: inner_error_reason,\n                     saw_doc_comment: just_parsed_doc_comment,\n-                    prev_attr_sp: attrs.last().map(|a| a.span),\n+                    prev_outer_attr_sp,\n                 };\n                 just_parsed_doc_comment = false;\n                 Some(self.parse_attribute(inner_parse_policy)?)\n@@ -97,12 +99,14 @@ impl<'a> Parser<'a> {\n             };\n \n             if let Some(attr) = attr {\n-                attrs.push(attr);\n+                if attr.style == ast::AttrStyle::Outer {\n+                    outer_attrs.push(attr);\n+                }\n             } else {\n                 break;\n             }\n         }\n-        Ok(AttrWrapper::new(attrs.into(), start_pos))\n+        Ok(AttrWrapper::new(outer_attrs.into(), start_pos))\n     }\n \n     /// Matches `attribute = # ! [ meta_item ]`.\n@@ -215,15 +219,15 @@ impl<'a> Parser<'a> {\n     }\n \n     pub(super) fn error_on_forbidden_inner_attr(&self, attr_sp: Span, policy: InnerAttrPolicy<'_>) {\n-        if let InnerAttrPolicy::Forbidden { reason, saw_doc_comment, prev_attr_sp } = policy {\n-            let prev_attr_note =\n+        if let InnerAttrPolicy::Forbidden { reason, saw_doc_comment, prev_outer_attr_sp } = policy {\n+            let prev_outer_attr_note =\n                 if saw_doc_comment { \"previous doc comment\" } else { \"previous outer attribute\" };\n \n             let mut diag = self.struct_span_err(attr_sp, reason);\n \n-            if let Some(prev_attr_sp) = prev_attr_sp {\n+            if let Some(prev_outer_attr_sp) = prev_outer_attr_sp {\n                 diag.span_label(attr_sp, \"not permitted following an outer attribute\")\n-                    .span_label(prev_attr_sp, prev_attr_note);\n+                    .span_label(prev_outer_attr_sp, prev_outer_attr_note);\n             }\n \n             diag.note("}, {"sha": "42b2dfde85577e4beacf75be3b8ddf2887a129b1", "filename": "src/test/ui/parser/attr.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/5ab0548500a30134496ba28eb2291b0523b7346a/src%2Ftest%2Fui%2Fparser%2Fattr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5ab0548500a30134496ba28eb2291b0523b7346a/src%2Ftest%2Fui%2Fparser%2Fattr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fattr.rs?ref=5ab0548500a30134496ba28eb2291b0523b7346a", "patch": "@@ -3,5 +3,4 @@\n fn main() {}\n \n #![lang = \"foo\"] //~ ERROR an inner attribute is not permitted in this context\n-                 //~| ERROR definition of an unknown language item: `foo`\n fn foo() {}"}, {"sha": "3527274bd0f8c954f79f05de405f4bb6059cdda1", "filename": "src/test/ui/parser/attr.stderr", "status": "modified", "additions": 1, "deletions": 9, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/5ab0548500a30134496ba28eb2291b0523b7346a/src%2Ftest%2Fui%2Fparser%2Fattr.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/5ab0548500a30134496ba28eb2291b0523b7346a/src%2Ftest%2Fui%2Fparser%2Fattr.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fattr.stderr?ref=5ab0548500a30134496ba28eb2291b0523b7346a", "patch": "@@ -3,7 +3,6 @@ error: an inner attribute is not permitted in this context\n    |\n LL | #![lang = \"foo\"]\n    | ^^^^^^^^^^^^^^^^\n-LL |\n LL | fn foo() {}\n    | ----------- the inner attribute doesn't annotate this function\n    |\n@@ -14,12 +13,5 @@ LL - #![lang = \"foo\"]\n LL + #[lang = \"foo\"]\n    | \n \n-error[E0522]: definition of an unknown language item: `foo`\n-  --> $DIR/attr.rs:5:1\n-   |\n-LL | #![lang = \"foo\"]\n-   | ^^^^^^^^^^^^^^^^ definition of unknown language item `foo`\n-\n-error: aborting due to 2 previous errors\n+error: aborting due to previous error\n \n-For more information about this error, try `rustc --explain E0522`."}, {"sha": "9429e514339cf5deb38393ca14d549e70978eb2f", "filename": "src/test/ui/parser/issues/auxiliary/issue-94340-inc.rs", "status": "added", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/5ab0548500a30134496ba28eb2291b0523b7346a/src%2Ftest%2Fui%2Fparser%2Fissues%2Fauxiliary%2Fissue-94340-inc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5ab0548500a30134496ba28eb2291b0523b7346a/src%2Ftest%2Fui%2Fparser%2Fissues%2Fauxiliary%2Fissue-94340-inc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fissues%2Fauxiliary%2Fissue-94340-inc.rs?ref=5ab0548500a30134496ba28eb2291b0523b7346a", "patch": "@@ -0,0 +1,3 @@\n+// include file for issue-94340.rs\n+#![deny(rust_2018_idioms)]\n+#![deny(unused_must_use)]"}, {"sha": "d0fb84a689a33a6449c8dc7f7d5f1870bfeee3ad", "filename": "src/test/ui/parser/issues/issue-94340.rs", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/5ab0548500a30134496ba28eb2291b0523b7346a/src%2Ftest%2Fui%2Fparser%2Fissues%2Fissue-94340.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5ab0548500a30134496ba28eb2291b0523b7346a/src%2Ftest%2Fui%2Fparser%2Fissues%2Fissue-94340.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fissues%2Fissue-94340.rs?ref=5ab0548500a30134496ba28eb2291b0523b7346a", "patch": "@@ -0,0 +1,8 @@\n+// Make sure that unexpected inner attributes are not labeled as outer ones in diagnostics when\n+// trying to parse an item and that they are subsequently ignored not triggering confusing extra\n+// diagnostics like \"expected item after attributes\" which is not true for `include!` which can\n+// include empty files.\n+\n+include!(\"auxiliary/issue-94340-inc.rs\");\n+\n+fn main() {}"}, {"sha": "9fd7c38a80b77baa627f95375613d5c3d879207c", "filename": "src/test/ui/parser/issues/issue-94340.stderr", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/5ab0548500a30134496ba28eb2291b0523b7346a/src%2Ftest%2Fui%2Fparser%2Fissues%2Fissue-94340.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/5ab0548500a30134496ba28eb2291b0523b7346a/src%2Ftest%2Fui%2Fparser%2Fissues%2Fissue-94340.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fissues%2Fissue-94340.stderr?ref=5ab0548500a30134496ba28eb2291b0523b7346a", "patch": "@@ -0,0 +1,20 @@\n+error: an inner attribute is not permitted in this context\n+  --> $DIR/auxiliary/issue-94340-inc.rs:2:1\n+   |\n+LL | #![deny(rust_2018_idioms)]\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+   = note: inner attributes, like `#![no_std]`, annotate the item enclosing them, and are usually found at the beginning of source files\n+   = note: outer attributes, like `#[test]`, annotate the item following them\n+\n+error: an inner attribute is not permitted in this context\n+  --> $DIR/auxiliary/issue-94340-inc.rs:3:1\n+   |\n+LL | #![deny(unused_must_use)]\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+   = note: inner attributes, like `#![no_std]`, annotate the item enclosing them, and are usually found at the beginning of source files\n+   = note: outer attributes, like `#[test]`, annotate the item following them\n+\n+error: aborting due to 2 previous errors\n+"}]}