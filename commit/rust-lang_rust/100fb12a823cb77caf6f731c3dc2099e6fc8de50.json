{"sha": "100fb12a823cb77caf6f731c3dc2099e6fc8de50", "node_id": "MDY6Q29tbWl0NzI0NzEyOjEwMGZiMTJhODIzY2I3N2NhZjZmNzMxYzNkYzIwOTllNmZjOGRlNTA=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-07-15T23:39:28Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-07-15T23:39:28Z"}, "message": "Auto merge of #52401 - semarie:tidy-extdeps, r=alexcrichton\n\ntidy: add a new test for external dependencies\n\nensure all packages in Cargo.lock will be vendored, and fail if the\nsource packages isn't whitelisted.\n\nthe purpose is to avoid such kind of issues:\n- #52029 Rustfmt isn't vendored correctly\n- #42719 building beta with vendor=true fail due to network dependencies\n\nas Rust comes with several external dependencies (clippy, miri, rustfmt, rls), it is important to have a way to catch some errors in the update of this submodules.\n\nThe new check in tidy quickly reads `Cargo.lock` to search for the `source` of all packages. This attribute is present when the package comes from external source (like `crates.io-index` or some `git` repository). Some sources are whitelisted (like `crates.io-index`) as the crates are vendored.\n\n`Cargo.lock` extract with several cases (git, crates.io, and local).\n```\n[[package]]\nname = \"rustfmt-nightly\"\nversion = \"0.8.2\"\nsource = \"git+https://github.com/rust-lang-nursery/rustfmt?rev=5e5992517d3591e2708d4ca6b155dfcbdf3344b9#5e5992517d3591e2708d4ca6b155dfcbdf3344b9\"\ndependencies = [\n...\n]\n\n[[package]]\nname = \"same-file\"\nversion = \"1.0.2\"\nsource = \"registry+https://github.com/rust-lang/crates.io-index\"\ndependencies = [\n...\n]\n\n[[package]]\nname = \"rustdoc-themes\"\nversion = \"0.1.0\"\n```\n\nr? @alexcrichton", "tree": {"sha": "21b16b0d588c389bf0524886487712634c48911b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/21b16b0d588c389bf0524886487712634c48911b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/100fb12a823cb77caf6f731c3dc2099e6fc8de50", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/100fb12a823cb77caf6f731c3dc2099e6fc8de50", "html_url": "https://github.com/rust-lang/rust/commit/100fb12a823cb77caf6f731c3dc2099e6fc8de50", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/100fb12a823cb77caf6f731c3dc2099e6fc8de50/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "31f1bc7b40469b9319f1ba610ad8760ebd11c3da", "url": "https://api.github.com/repos/rust-lang/rust/commits/31f1bc7b40469b9319f1ba610ad8760ebd11c3da", "html_url": "https://github.com/rust-lang/rust/commit/31f1bc7b40469b9319f1ba610ad8760ebd11c3da"}, {"sha": "a4ddda31e95184a443fd237744479557c09cc76b", "url": "https://api.github.com/repos/rust-lang/rust/commits/a4ddda31e95184a443fd237744479557c09cc76b", "html_url": "https://github.com/rust-lang/rust/commit/a4ddda31e95184a443fd237744479557c09cc76b"}], "stats": {"total": 52, "additions": 52, "deletions": 0}, "files": [{"sha": "761803a45b8b35ecf99b8b6e899305393c76d466", "filename": "src/tools/tidy/src/extdeps.rs", "status": "added", "additions": 50, "deletions": 0, "changes": 50, "blob_url": "https://github.com/rust-lang/rust/blob/100fb12a823cb77caf6f731c3dc2099e6fc8de50/src%2Ftools%2Ftidy%2Fsrc%2Fextdeps.rs", "raw_url": "https://github.com/rust-lang/rust/raw/100fb12a823cb77caf6f731c3dc2099e6fc8de50/src%2Ftools%2Ftidy%2Fsrc%2Fextdeps.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Fextdeps.rs?ref=100fb12a823cb77caf6f731c3dc2099e6fc8de50", "patch": "@@ -0,0 +1,50 @@\n+// Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// ! Check for external package sources. Allow only vendorable packages.\n+\n+use std::fs::File;\n+use std::io::Read;\n+use std::path::Path;\n+\n+/// List of whitelisted sources for packages\n+static WHITELISTED_SOURCES: &'static [&'static str] = &[\n+    \"\\\"registry+https://github.com/rust-lang/crates.io-index\\\"\",\n+];\n+\n+/// check for external package sources\n+pub fn check(path: &Path, bad: &mut bool) {\n+    // Cargo.lock of rust: src/Cargo.lock\n+    let path = path.join(\"Cargo.lock\");\n+\n+    // open and read the whole file\n+    let mut cargo_lock = String::new();\n+    t!(t!(File::open(path)).read_to_string(&mut cargo_lock));\n+\n+    // process each line\n+    let mut lines = cargo_lock.lines();\n+    while let Some(line) = lines.next() {\n+\n+        // consider only source entries\n+        if ! line.starts_with(\"source = \") {\n+            continue;\n+        }\n+\n+        // extract source value\n+        let parts: Vec<&str> = line.splitn(2, \"=\").collect();\n+        let source = parts[1].trim();\n+\n+        // ensure source is whitelisted\n+        if !WHITELISTED_SOURCES.contains(&&*source) {\n+            println!(\"invalid source: {}\", source);\n+            *bad = true;\n+        }\n+    }\n+}"}, {"sha": "46217a4200967c90330a7670670c676b852d0b8f", "filename": "src/tools/tidy/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/100fb12a823cb77caf6f731c3dc2099e6fc8de50/src%2Ftools%2Ftidy%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/100fb12a823cb77caf6f731c3dc2099e6fc8de50/src%2Ftools%2Ftidy%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Flib.rs?ref=100fb12a823cb77caf6f731c3dc2099e6fc8de50", "patch": "@@ -49,6 +49,7 @@ pub mod features;\n pub mod cargo;\n pub mod pal;\n pub mod deps;\n+pub mod extdeps;\n pub mod ui_tests;\n pub mod unstable_book;\n pub mod libcoretest;"}, {"sha": "4fe77f8b58feb39778c49f4480a24f8f111e0a8f", "filename": "src/tools/tidy/src/main.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/100fb12a823cb77caf6f731c3dc2099e6fc8de50/src%2Ftools%2Ftidy%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/100fb12a823cb77caf6f731c3dc2099e6fc8de50/src%2Ftools%2Ftidy%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Fmain.rs?ref=100fb12a823cb77caf6f731c3dc2099e6fc8de50", "patch": "@@ -46,6 +46,7 @@ fn main() {\n         deps::check(&path, &mut bad);\n     }\n     deps::check_whitelist(&path, &cargo, &mut bad);\n+    extdeps::check(&path, &mut bad);\n     ui_tests::check(&path, &mut bad);\n \n     if bad {"}]}