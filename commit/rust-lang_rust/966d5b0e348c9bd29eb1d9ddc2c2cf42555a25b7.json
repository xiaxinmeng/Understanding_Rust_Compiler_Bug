{"sha": "966d5b0e348c9bd29eb1d9ddc2c2cf42555a25b7", "node_id": "C_kwDOAAsO6NoAKDk2NmQ1YjBlMzQ4YzliZDI5ZWIxZDlkZGMyYzJjZjQyNTU1YTI1Yjc", "commit": {"author": {"name": "Nilstrieb", "email": "48135649+Nilstrieb@users.noreply.github.com", "date": "2023-03-22T21:12:19Z"}, "committer": {"name": "Nilstrieb", "email": "48135649+Nilstrieb@users.noreply.github.com", "date": "2023-03-22T21:22:16Z"}, "message": "Cache `has_sig_drop_attr` for `significant_drop_tightening`\n\nThe lint is very slow as it doesn't cache the deeply nested check for\nthe attribute. If we cache it, we can reduce the time spent on checking\n`rustc_borrowck` from 28s to 9s, which is a nice improvement. In the\nprofile, the time inside `has_sig_drop_attr` goes from 66% to 0.2%,\nwhich is a lot more reasonable.\n\nSee the PR for nice graphs.", "tree": {"sha": "f2574770b5b17899ac2e0eb4ba5995d82b78a82f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f2574770b5b17899ac2e0eb4ba5995d82b78a82f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/966d5b0e348c9bd29eb1d9ddc2c2cf42555a25b7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/966d5b0e348c9bd29eb1d9ddc2c2cf42555a25b7", "html_url": "https://github.com/rust-lang/rust/commit/966d5b0e348c9bd29eb1d9ddc2c2cf42555a25b7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/966d5b0e348c9bd29eb1d9ddc2c2cf42555a25b7/comments", "author": {"login": "Nilstrieb", "id": 48135649, "node_id": "MDQ6VXNlcjQ4MTM1NjQ5", "avatar_url": "https://avatars.githubusercontent.com/u/48135649?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Nilstrieb", "html_url": "https://github.com/Nilstrieb", "followers_url": "https://api.github.com/users/Nilstrieb/followers", "following_url": "https://api.github.com/users/Nilstrieb/following{/other_user}", "gists_url": "https://api.github.com/users/Nilstrieb/gists{/gist_id}", "starred_url": "https://api.github.com/users/Nilstrieb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Nilstrieb/subscriptions", "organizations_url": "https://api.github.com/users/Nilstrieb/orgs", "repos_url": "https://api.github.com/users/Nilstrieb/repos", "events_url": "https://api.github.com/users/Nilstrieb/events{/privacy}", "received_events_url": "https://api.github.com/users/Nilstrieb/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Nilstrieb", "id": 48135649, "node_id": "MDQ6VXNlcjQ4MTM1NjQ5", "avatar_url": "https://avatars.githubusercontent.com/u/48135649?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Nilstrieb", "html_url": "https://github.com/Nilstrieb", "followers_url": "https://api.github.com/users/Nilstrieb/followers", "following_url": "https://api.github.com/users/Nilstrieb/following{/other_user}", "gists_url": "https://api.github.com/users/Nilstrieb/gists{/gist_id}", "starred_url": "https://api.github.com/users/Nilstrieb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Nilstrieb/subscriptions", "organizations_url": "https://api.github.com/users/Nilstrieb/orgs", "repos_url": "https://api.github.com/users/Nilstrieb/repos", "events_url": "https://api.github.com/users/Nilstrieb/events{/privacy}", "received_events_url": "https://api.github.com/users/Nilstrieb/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e64c5961dc7640b4d5529608e0f321d586c027a0", "url": "https://api.github.com/repos/rust-lang/rust/commits/e64c5961dc7640b4d5529608e0f321d586c027a0", "html_url": "https://github.com/rust-lang/rust/commit/e64c5961dc7640b4d5529608e0f321d586c027a0"}], "stats": {"total": 38, "additions": 31, "deletions": 7}, "files": [{"sha": "c3e99aa0055ab4d747113d3242854bc64544d7e9", "filename": "clippy_lints/src/significant_drop_tightening.rs", "status": "modified", "additions": 31, "deletions": 7, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/966d5b0e348c9bd29eb1d9ddc2c2cf42555a25b7/clippy_lints%2Fsrc%2Fsignificant_drop_tightening.rs", "raw_url": "https://github.com/rust-lang/rust/raw/966d5b0e348c9bd29eb1d9ddc2c2cf42555a25b7/clippy_lints%2Fsrc%2Fsignificant_drop_tightening.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fsignificant_drop_tightening.rs?ref=966d5b0e348c9bd29eb1d9ddc2c2cf42555a25b7", "patch": "@@ -1,9 +1,9 @@\n-use crate::FxHashSet;\n use clippy_utils::{\n     diagnostics::span_lint_and_then,\n     get_attr,\n     source::{indent_of, snippet},\n };\n+use rustc_data_structures::fx::{FxHashMap, FxHashSet};\n use rustc_errors::{Applicability, Diagnostic};\n use rustc_hir::{\n     self as hir,\n@@ -58,6 +58,7 @@ impl_lint_pass!(SignificantDropTightening<'_> => [SIGNIFICANT_DROP_TIGHTENING]);\n pub struct SignificantDropTightening<'tcx> {\n     /// Auxiliary structure used to avoid having to verify the same type multiple times.\n     seen_types: FxHashSet<Ty<'tcx>>,\n+    type_cache: FxHashMap<Ty<'tcx>, bool>,\n }\n \n impl<'tcx> SignificantDropTightening<'tcx> {\n@@ -118,7 +119,7 @@ impl<'tcx> SignificantDropTightening<'tcx> {\n         stmt: &hir::Stmt<'_>,\n         cb: impl Fn(&mut SigDropAuxParams),\n     ) {\n-        let mut sig_drop_finder = SigDropFinder::new(cx, &mut self.seen_types);\n+        let mut sig_drop_finder = SigDropFinder::new(cx, &mut self.seen_types, &mut self.type_cache);\n         sig_drop_finder.visit_expr(expr);\n         if sig_drop_finder.has_sig_drop {\n             cb(sdap);\n@@ -296,15 +297,24 @@ impl Default for SigDropAuxParams {\n struct SigDropChecker<'cx, 'sdt, 'tcx> {\n     cx: &'cx LateContext<'tcx>,\n     seen_types: &'sdt mut FxHashSet<Ty<'tcx>>,\n+    type_cache: &'sdt mut FxHashMap<Ty<'tcx>, bool>,\n }\n \n impl<'cx, 'sdt, 'tcx> SigDropChecker<'cx, 'sdt, 'tcx> {\n-    pub(crate) fn new(cx: &'cx LateContext<'tcx>, seen_types: &'sdt mut FxHashSet<Ty<'tcx>>) -> Self {\n+    pub(crate) fn new(\n+        cx: &'cx LateContext<'tcx>,\n+        seen_types: &'sdt mut FxHashSet<Ty<'tcx>>,\n+        type_cache: &'sdt mut FxHashMap<Ty<'tcx>, bool>,\n+    ) -> Self {\n         seen_types.clear();\n-        Self { cx, seen_types }\n+        Self {\n+            cx,\n+            seen_types,\n+            type_cache,\n+        }\n     }\n \n-    pub(crate) fn has_sig_drop_attr(&mut self, ty: Ty<'tcx>) -> bool {\n+    pub(crate) fn has_sig_drop_attr_uncached(&mut self, ty: Ty<'tcx>) -> bool {\n         if let Some(adt) = ty.ty_adt_def() {\n             let mut iter = get_attr(\n                 self.cx.sess(),\n@@ -340,6 +350,16 @@ impl<'cx, 'sdt, 'tcx> SigDropChecker<'cx, 'sdt, 'tcx> {\n         }\n     }\n \n+    pub(crate) fn has_sig_drop_attr(&mut self, ty: Ty<'tcx>) -> bool {\n+        // The borrow checker prevents us from using something fancier like or_insert_with.\n+        if let Some(ty) = self.type_cache.get(&ty) {\n+            return *ty;\n+        }\n+        let value = self.has_sig_drop_attr_uncached(ty);\n+        self.type_cache.insert(ty, value);\n+        value\n+    }\n+\n     fn has_seen_ty(&mut self, ty: Ty<'tcx>) -> bool {\n         !self.seen_types.insert(ty)\n     }\n@@ -353,11 +373,15 @@ struct SigDropFinder<'cx, 'sdt, 'tcx> {\n }\n \n impl<'cx, 'sdt, 'tcx> SigDropFinder<'cx, 'sdt, 'tcx> {\n-    fn new(cx: &'cx LateContext<'tcx>, seen_types: &'sdt mut FxHashSet<Ty<'tcx>>) -> Self {\n+    fn new(\n+        cx: &'cx LateContext<'tcx>,\n+        seen_types: &'sdt mut FxHashSet<Ty<'tcx>>,\n+        type_cache: &'sdt mut FxHashMap<Ty<'tcx>, bool>,\n+    ) -> Self {\n         Self {\n             cx,\n             has_sig_drop: false,\n-            sig_drop_checker: SigDropChecker::new(cx, seen_types),\n+            sig_drop_checker: SigDropChecker::new(cx, seen_types, type_cache),\n         }\n     }\n }"}]}