{"sha": "bf6bfcddf6bf9774022001d5a5d1f859d39a0a8a", "node_id": "C_kwDOAAsO6NoAKGJmNmJmY2RkZjZiZjk3NzQwMjIwMDFkNWE1ZDFmODU5ZDM5YTBhOGE", "commit": {"author": {"name": "Dylan DPC", "email": "99973273+Dylan-DPC@users.noreply.github.com", "date": "2022-10-26T05:59:53Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-10-26T05:59:53Z"}, "message": "Rollup merge of #102951 - SparrowLii:type_annotation, r=estebank\n\nsuggest type annotation for local statement initialed by ref expression\n\nIn a local statement with a type declaration, if a ref expression is used on the right side and not used on the left side, in addition to removing the `&` and `&mut` on the right side, we can add them on the left side alternatively\nFixes #102892", "tree": {"sha": "bedf6f9780b35856a9360b8f1bff783cbffb3357", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bedf6f9780b35856a9360b8f1bff783cbffb3357"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bf6bfcddf6bf9774022001d5a5d1f859d39a0a8a", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjWMzZCRBK7hj4Ov3rIwAAbygIAHUVtWYiERLw5fsyLlx06Pug\nv+ymmvUHlUuwOfsjRt0kNJZfY1J6ywrHK29ZcnZfnyNn05UegnSGBMX2PWDf/iri\nAlRDo+vJ22RUafXmYrSpRIkWFuzBdnYvEtEBzEvRijJ3Pw/vguwKzQaof5G47qZj\ntZnrMUZYImz6OsGfSFmd5QlsKjadlMjL3svFWJQ0VB5RPYXhKXCtGTVrdUxRvq0F\nudVosRM2j1DfedroCcePeusjBUUm9cWt6Ks4KHl5oqMf5ROFeFOh9pcfhUOVfe7D\nlI5zs0JZCeZqyeNMSg4s0UmZJinsEYEGeJvnTJ+cCv3Jzgjl+SyQUcIpVK02RMs=\n=K5RW\n-----END PGP SIGNATURE-----\n", "payload": "tree bedf6f9780b35856a9360b8f1bff783cbffb3357\nparent a5406feb1cf1a9f2479b72917cf4225e5f6aa240\nparent 0fca075ce8a2247b6d59cd8eaf2fd1d6b89855d8\nauthor Dylan DPC <99973273+Dylan-DPC@users.noreply.github.com> 1666763993 +0530\ncommitter GitHub <noreply@github.com> 1666763993 +0530\n\nRollup merge of #102951 - SparrowLii:type_annotation, r=estebank\n\nsuggest type annotation for local statement initialed by ref expression\n\nIn a local statement with a type declaration, if a ref expression is used on the right side and not used on the left side, in addition to removing the `&` and `&mut` on the right side, we can add them on the left side alternatively\nFixes #102892\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bf6bfcddf6bf9774022001d5a5d1f859d39a0a8a", "html_url": "https://github.com/rust-lang/rust/commit/bf6bfcddf6bf9774022001d5a5d1f859d39a0a8a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bf6bfcddf6bf9774022001d5a5d1f859d39a0a8a/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a5406feb1cf1a9f2479b72917cf4225e5f6aa240", "url": "https://api.github.com/repos/rust-lang/rust/commits/a5406feb1cf1a9f2479b72917cf4225e5f6aa240", "html_url": "https://github.com/rust-lang/rust/commit/a5406feb1cf1a9f2479b72917cf4225e5f6aa240"}, {"sha": "0fca075ce8a2247b6d59cd8eaf2fd1d6b89855d8", "url": "https://api.github.com/repos/rust-lang/rust/commits/0fca075ce8a2247b6d59cd8eaf2fd1d6b89855d8", "html_url": "https://github.com/rust-lang/rust/commit/0fca075ce8a2247b6d59cd8eaf2fd1d6b89855d8"}], "stats": {"total": 164, "additions": 160, "deletions": 4}, "files": [{"sha": "be14234afe28d37d0aaa434fe553c6b0617a6937", "filename": "compiler/rustc_hir_typeck/src/demand.rs", "status": "modified", "additions": 18, "deletions": 1, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/bf6bfcddf6bf9774022001d5a5d1f859d39a0a8a/compiler%2Frustc_hir_typeck%2Fsrc%2Fdemand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bf6bfcddf6bf9774022001d5a5d1f859d39a0a8a/compiler%2Frustc_hir_typeck%2Fsrc%2Fdemand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_typeck%2Fsrc%2Fdemand.rs?ref=bf6bfcddf6bf9774022001d5a5d1f859d39a0a8a", "patch": "@@ -714,7 +714,14 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         expr: &hir::Expr<'tcx>,\n         checked_ty: Ty<'tcx>,\n         expected: Ty<'tcx>,\n-    ) -> Option<(Span, String, String, Applicability, bool /* verbose */)> {\n+    ) -> Option<(\n+        Span,\n+        String,\n+        String,\n+        Applicability,\n+        bool, /* verbose */\n+        bool, /* suggest `&` or `&mut` type annotation */\n+    )> {\n         let sess = self.sess();\n         let sp = expr.span;\n \n@@ -746,6 +753,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                                     String::new(),\n                                     Applicability::MachineApplicable,\n                                     true,\n+                                    false,\n                                 ));\n                             }\n                         }\n@@ -760,6 +768,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                                     \"b\".to_string(),\n                                     Applicability::MachineApplicable,\n                                     true,\n+                                    false,\n                                 ));\n                     }\n                 }\n@@ -817,6 +826,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                                 sugg.2,\n                                 Applicability::MachineApplicable,\n                                 false,\n+                                false,\n                             ));\n                         }\n \n@@ -844,13 +854,15 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                                 format!(\"{prefix}&mut {sugg_expr}\"),\n                                 Applicability::MachineApplicable,\n                                 false,\n+                                false,\n                             ),\n                             hir::Mutability::Not => (\n                                 sp,\n                                 \"consider borrowing here\".to_string(),\n                                 format!(\"{prefix}&{sugg_expr}\"),\n                                 Applicability::MachineApplicable,\n                                 false,\n+                                false,\n                             ),\n                         });\n                     }\n@@ -880,6 +892,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                             String::new(),\n                             Applicability::MachineApplicable,\n                             true,\n+                            true\n                         ));\n                     }\n                     return None;\n@@ -893,6 +906,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                         String::new(),\n                         Applicability::MachineApplicable,\n                         true,\n+                        true,\n                     ));\n                 }\n             }\n@@ -959,6 +973,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                             src,\n                             applicability,\n                             true,\n+                            false,\n                         ));\n                     }\n                 }\n@@ -999,6 +1014,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                                 Applicability::MachineApplicable\n                             },\n                             true,\n+                            false,\n                         ));\n                     }\n \n@@ -1050,6 +1066,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                             suggestion,\n                             Applicability::MachineApplicable,\n                             true,\n+                            false,\n                         ));\n                     }\n                 }"}, {"sha": "4db9c56f98fee3440daa27e6aafa5e4002c283bf", "filename": "compiler/rustc_hir_typeck/src/fn_ctxt/suggestions.rs", "status": "modified", "additions": 44, "deletions": 3, "changes": 47, "blob_url": "https://github.com/rust-lang/rust/blob/bf6bfcddf6bf9774022001d5a5d1f859d39a0a8a/compiler%2Frustc_hir_typeck%2Fsrc%2Ffn_ctxt%2Fsuggestions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bf6bfcddf6bf9774022001d5a5d1f859d39a0a8a/compiler%2Frustc_hir_typeck%2Fsrc%2Ffn_ctxt%2Fsuggestions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_typeck%2Fsrc%2Ffn_ctxt%2Fsuggestions.rs?ref=bf6bfcddf6bf9774022001d5a5d1f859d39a0a8a", "patch": "@@ -327,17 +327,58 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         expected_ty_expr: Option<&'tcx hir::Expr<'tcx>>,\n     ) -> bool {\n         let expr = expr.peel_blocks();\n-        if let Some((sp, msg, suggestion, applicability, verbose)) =\n+        if let Some((sp, msg, suggestion, applicability, verbose, annotation)) =\n             self.check_ref(expr, found, expected)\n         {\n             if verbose {\n                 err.span_suggestion_verbose(sp, &msg, suggestion, applicability);\n             } else {\n                 err.span_suggestion(sp, &msg, suggestion, applicability);\n             }\n+            if annotation {\n+                let suggest_annotation = match expr.peel_drop_temps().kind {\n+                    hir::ExprKind::AddrOf(hir::BorrowKind::Ref, hir::Mutability::Not, _) => \"&\",\n+                    hir::ExprKind::AddrOf(hir::BorrowKind::Ref, hir::Mutability::Mut, _) => \"&mut \",\n+                    _ => return true,\n+                };\n+                let mut tuple_indexes = Vec::new();\n+                let mut expr_id = expr.hir_id;\n+                for (parent_id, node) in self.tcx.hir().parent_iter(expr.hir_id) {\n+                    match node {\n+                        Node::Expr(&Expr { kind: ExprKind::Tup(subs), .. }) => {\n+                            tuple_indexes.push(\n+                                subs.iter()\n+                                    .enumerate()\n+                                    .find(|(_, sub_expr)| sub_expr.hir_id == expr_id)\n+                                    .unwrap()\n+                                    .0,\n+                            );\n+                            expr_id = parent_id;\n+                        }\n+                        Node::Local(local) => {\n+                            if let Some(mut ty) = local.ty {\n+                                while let Some(index) = tuple_indexes.pop() {\n+                                    match ty.kind {\n+                                        TyKind::Tup(tys) => ty = &tys[index],\n+                                        _ => return true,\n+                                    }\n+                                }\n+                                let annotation_span = ty.span;\n+                                err.span_suggestion(\n+                                    annotation_span.with_hi(annotation_span.lo()),\n+                                    format!(\"alternatively, consider changing the type annotation\"),\n+                                    suggest_annotation,\n+                                    Applicability::MaybeIncorrect,\n+                                );\n+                            }\n+                            break;\n+                        }\n+                        _ => break,\n+                    }\n+                }\n+            }\n             return true;\n-        } else if self.suggest_else_fn_with_closure(err, expr, found, expected)\n-        {\n+        } else if self.suggest_else_fn_with_closure(err, expr, found, expected) {\n             return true;\n         } else if self.suggest_fn_call(err, expr, found, |output| self.can_coerce(output, expected))\n             && let ty::FnDef(def_id, ..) = &found.kind()"}, {"sha": "8ed2b9c9a6330d4107496d00f2f191b233db98ac", "filename": "src/test/ui/suggestions/format-borrow.stderr", "status": "modified", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/bf6bfcddf6bf9774022001d5a5d1f859d39a0a8a/src%2Ftest%2Fui%2Fsuggestions%2Fformat-borrow.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/bf6bfcddf6bf9774022001d5a5d1f859d39a0a8a/src%2Ftest%2Fui%2Fsuggestions%2Fformat-borrow.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsuggestions%2Fformat-borrow.stderr?ref=bf6bfcddf6bf9774022001d5a5d1f859d39a0a8a", "patch": "@@ -11,6 +11,10 @@ help: consider removing the borrow\n LL -     let a: String = &String::from(\"a\");\n LL +     let a: String = String::from(\"a\");\n    |\n+help: alternatively, consider changing the type annotation\n+   |\n+LL |     let a: &String = &String::from(\"a\");\n+   |            +\n \n error[E0308]: mismatched types\n   --> $DIR/format-borrow.rs:4:21\n@@ -25,6 +29,10 @@ help: consider removing the borrow\n LL -     let b: String = &format!(\"b\");\n LL +     let b: String = format!(\"b\");\n    |\n+help: alternatively, consider changing the type annotation\n+   |\n+LL |     let b: &String = &format!(\"b\");\n+   |            +\n \n error[E0308]: mismatched types\n   --> $DIR/format-borrow.rs:6:21\n@@ -39,6 +47,10 @@ help: consider removing the borrow\n LL -     let c: String = &mut format!(\"c\");\n LL +     let c: String = format!(\"c\");\n    |\n+help: alternatively, consider changing the type annotation\n+   |\n+LL |     let c: &mut String = &mut format!(\"c\");\n+   |            ++++\n \n error[E0308]: mismatched types\n   --> $DIR/format-borrow.rs:8:21\n@@ -53,6 +65,10 @@ help: consider removing the borrow\n LL -     let d: String = &mut (format!(\"d\"));\n LL +     let d: String = format!(\"d\"));\n    |\n+help: alternatively, consider changing the type annotation\n+   |\n+LL |     let d: &mut String = &mut (format!(\"d\"));\n+   |            ++++\n \n error: aborting due to 4 previous errors\n "}, {"sha": "c1a791d8d857a9c3f4c385cdff5aa7908eb202ff", "filename": "src/test/ui/suggestions/issue-102892.rs", "status": "added", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/bf6bfcddf6bf9774022001d5a5d1f859d39a0a8a/src%2Ftest%2Fui%2Fsuggestions%2Fissue-102892.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bf6bfcddf6bf9774022001d5a5d1f859d39a0a8a/src%2Ftest%2Fui%2Fsuggestions%2Fissue-102892.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsuggestions%2Fissue-102892.rs?ref=bf6bfcddf6bf9774022001d5a5d1f859d39a0a8a", "patch": "@@ -0,0 +1,25 @@\n+#![allow(dead_code, unused_variables)]\n+\n+use std::sync::Arc;\n+\n+#[derive(Debug)]\n+struct A;\n+#[derive(Debug)]\n+struct B;\n+\n+fn process_without_annot(arc: &Arc<(A, B)>) {\n+    let (a, b) = **arc; // suggests putting `&**arc` here; with that, fixed!\n+}\n+\n+fn process_with_annot(arc: &Arc<(A, B)>) {\n+    let (a, b): (A, B) = &**arc; // suggests putting `&**arc` here too\n+    //~^ ERROR mismatched types\n+}\n+\n+fn process_with_tuple_annot(mutation: &mut (A, B), arc: &Arc<(A, B)>) {\n+    let (a, b): ((A, B), A) = (&mut *mutation, &(**arc).0); // suggests putting `&**arc` here too\n+    //~^ ERROR mismatched types\n+    //~| ERROR mismatched types\n+}\n+\n+fn main() {}"}, {"sha": "a3dbc7cb861ffe6331c9f024399570ddc1a1a538", "filename": "src/test/ui/suggestions/issue-102892.stderr", "status": "added", "additions": 57, "deletions": 0, "changes": 57, "blob_url": "https://github.com/rust-lang/rust/blob/bf6bfcddf6bf9774022001d5a5d1f859d39a0a8a/src%2Ftest%2Fui%2Fsuggestions%2Fissue-102892.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/bf6bfcddf6bf9774022001d5a5d1f859d39a0a8a/src%2Ftest%2Fui%2Fsuggestions%2Fissue-102892.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsuggestions%2Fissue-102892.stderr?ref=bf6bfcddf6bf9774022001d5a5d1f859d39a0a8a", "patch": "@@ -0,0 +1,57 @@\n+error[E0308]: mismatched types\n+  --> $DIR/issue-102892.rs:15:26\n+   |\n+LL |     let (a, b): (A, B) = &**arc; // suggests putting `&**arc` here too\n+   |                 ------   ^^^^^^ expected tuple, found `&(A, B)`\n+   |                 |\n+   |                 expected due to this\n+   |\n+   = note:  expected tuple `(A, B)`\n+           found reference `&(A, B)`\n+help: consider removing the borrow\n+   |\n+LL -     let (a, b): (A, B) = &**arc; // suggests putting `&**arc` here too\n+LL +     let (a, b): (A, B) = **arc; // suggests putting `&**arc` here too\n+   |\n+help: alternatively, consider changing the type annotation\n+   |\n+LL |     let (a, b): &(A, B) = &**arc; // suggests putting `&**arc` here too\n+   |                 +\n+\n+error[E0308]: mismatched types\n+  --> $DIR/issue-102892.rs:20:32\n+   |\n+LL |     let (a, b): ((A, B), A) = (&mut *mutation, &(**arc).0); // suggests putting `&**arc` here too\n+   |                                ^^^^^^^^^^^^^^ expected tuple, found `&mut (A, B)`\n+   |\n+   = note:          expected tuple `(A, B)`\n+           found mutable reference `&mut (A, B)`\n+help: consider removing the borrow\n+   |\n+LL -     let (a, b): ((A, B), A) = (&mut *mutation, &(**arc).0); // suggests putting `&**arc` here too\n+LL +     let (a, b): ((A, B), A) = (*mutation, &(**arc).0); // suggests putting `&**arc` here too\n+   |\n+help: alternatively, consider changing the type annotation\n+   |\n+LL |     let (a, b): (&mut (A, B), A) = (&mut *mutation, &(**arc).0); // suggests putting `&**arc` here too\n+   |                  ++++\n+\n+error[E0308]: mismatched types\n+  --> $DIR/issue-102892.rs:20:48\n+   |\n+LL |     let (a, b): ((A, B), A) = (&mut *mutation, &(**arc).0); // suggests putting `&**arc` here too\n+   |                                                ^^^^^^^^^^ expected struct `A`, found `&A`\n+   |\n+help: consider removing the borrow\n+   |\n+LL -     let (a, b): ((A, B), A) = (&mut *mutation, &(**arc).0); // suggests putting `&**arc` here too\n+LL +     let (a, b): ((A, B), A) = (&mut *mutation, (**arc).0); // suggests putting `&**arc` here too\n+   |\n+help: alternatively, consider changing the type annotation\n+   |\n+LL |     let (a, b): ((A, B), &A) = (&mut *mutation, &(**arc).0); // suggests putting `&**arc` here too\n+   |                          +\n+\n+error: aborting due to 3 previous errors\n+\n+For more information about this error, try `rustc --explain E0308`."}]}