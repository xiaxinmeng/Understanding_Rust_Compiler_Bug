{"sha": "e6830c1ac1ccf0d8ead6c9b04dcf87b2b0890d1e", "node_id": "MDY6Q29tbWl0NzI0NzEyOmU2ODMwYzFhYzFjY2YwZDhlYWQ2YzliMDRkY2Y4N2IyYjA4OTBkMWU=", "commit": {"author": {"name": "Pietro Albini", "email": "pietro@pietroalbini.org", "date": "2019-05-21T08:20:36Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-05-21T08:20:36Z"}, "message": "Merge pull request #2 from alexcrichton/azure-pipelines\n\nSome review feedback and other misc tweaks", "tree": {"sha": "fe172131c646aca29a84690b0a40c15281840a4f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fe172131c646aca29a84690b0a40c15281840a4f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e6830c1ac1ccf0d8ead6c9b04dcf87b2b0890d1e", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJc47TUCRBK7hj4Ov3rIwAAdHIIAEFRkQ4diSgBNqHXtJNOOpKm\nY5JzuGcfmgCfz6WUzU/aZDEBc+v/S93ZBoFRZlrBtoINg8PLX5C07nIoZ0niyVvV\ncnwSPfuqCtl+uUNu3UciPxFQEeIUT5bvuh+8rnN8uicw3EBU7vJuZdRqz104hFiZ\n1stoSFtfiX60Xlcv9qTfL5DFlpn09xurMnYFYjzmnqjc2n+1ofhUKTjMkQieT/wb\np0kn2nSo/L+wNTBQZfwOYzrbldD1YJ6uOsfh6RN0kO8uRyO2kMWoB+1anb/Z1og5\nCVuJQk++h3gWAoByQI/ELNUhW8PcuK7TqJo9kIKi6Ehh8nL8iEnOAHjG+EN9fXU=\n=DT97\n-----END PGP SIGNATURE-----\n", "payload": "tree fe172131c646aca29a84690b0a40c15281840a4f\nparent 9f37b3a4c251d7caaa2870952e217be369e8e9c1\nparent 9843a79496a4943b882d8046abfbff52caf51c3d\nauthor Pietro Albini <pietro@pietroalbini.org> 1558426836 +0200\ncommitter GitHub <noreply@github.com> 1558426836 +0200\n\nMerge pull request #2 from alexcrichton/azure-pipelines\n\nSome review feedback and other misc tweaks"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e6830c1ac1ccf0d8ead6c9b04dcf87b2b0890d1e", "html_url": "https://github.com/rust-lang/rust/commit/e6830c1ac1ccf0d8ead6c9b04dcf87b2b0890d1e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e6830c1ac1ccf0d8ead6c9b04dcf87b2b0890d1e/comments", "author": {"login": "pietroalbini", "id": 2299951, "node_id": "MDQ6VXNlcjIyOTk5NTE=", "avatar_url": "https://avatars.githubusercontent.com/u/2299951?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pietroalbini", "html_url": "https://github.com/pietroalbini", "followers_url": "https://api.github.com/users/pietroalbini/followers", "following_url": "https://api.github.com/users/pietroalbini/following{/other_user}", "gists_url": "https://api.github.com/users/pietroalbini/gists{/gist_id}", "starred_url": "https://api.github.com/users/pietroalbini/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pietroalbini/subscriptions", "organizations_url": "https://api.github.com/users/pietroalbini/orgs", "repos_url": "https://api.github.com/users/pietroalbini/repos", "events_url": "https://api.github.com/users/pietroalbini/events{/privacy}", "received_events_url": "https://api.github.com/users/pietroalbini/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9f37b3a4c251d7caaa2870952e217be369e8e9c1", "url": "https://api.github.com/repos/rust-lang/rust/commits/9f37b3a4c251d7caaa2870952e217be369e8e9c1", "html_url": "https://github.com/rust-lang/rust/commit/9f37b3a4c251d7caaa2870952e217be369e8e9c1"}, {"sha": "9843a79496a4943b882d8046abfbff52caf51c3d", "url": "https://api.github.com/repos/rust-lang/rust/commits/9843a79496a4943b882d8046abfbff52caf51c3d", "html_url": "https://github.com/rust-lang/rust/commit/9843a79496a4943b882d8046abfbff52caf51c3d"}], "stats": {"total": 483, "additions": 249, "deletions": 234}, "files": [{"sha": "3b6cfed70719a85d1bf7178a354ba39a08e4e58f", "filename": ".azure-pipelines/auto.yml", "status": "modified", "additions": 3, "deletions": 6, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/e6830c1ac1ccf0d8ead6c9b04dcf87b2b0890d1e/.azure-pipelines%2Fauto.yml", "raw_url": "https://github.com/rust-lang/rust/raw/e6830c1ac1ccf0d8ead6c9b04dcf87b2b0890d1e/.azure-pipelines%2Fauto.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.azure-pipelines%2Fauto.yml?ref=e6830c1ac1ccf0d8ead6c9b04dcf87b2b0890d1e", "patch": "@@ -11,11 +11,10 @@ variables:\n \n jobs:\n - job: Linux\n-  timeoutInMinutes: 180\n   pool:\n     vmImage: ubuntu-16.04\n   steps:\n-  - template: steps/linux.yml\n+  - template: steps/run.yml\n   strategy:\n     matrix:\n       x86_64-gnu-llvm-6.0:\n@@ -151,13 +150,12 @@ jobs:\n         IMAGE: mingw-check\n \n - job: macOS\n-  timeoutInMinutes: 180\n   pool:\n     vmImage: macos-10.13\n   steps:\n   - checkout: self\n     fetchDepth: 2\n-  - template: steps/macos.yml\n+  - template: steps/run.yml\n   strategy:\n     matrix:\n       # OSX builders running tests, these run the full test suite.\n@@ -216,11 +214,10 @@ jobs:\n \n \n - job: Windows\n-  timeoutInMinutes: 180\n   pool:\n     vmImage: 'vs2017-win2016'\n   steps:\n-  - template: steps/windows.yml\n+  - template: steps/run.yml\n   strategy:\n     matrix:\n #      # 32/64 bit MSVC tests"}, {"sha": "84c9454fee57f7c2a23037c5a89f37130be3ea56", "filename": ".azure-pipelines/pr.yml", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/e6830c1ac1ccf0d8ead6c9b04dcf87b2b0890d1e/.azure-pipelines%2Fpr.yml", "raw_url": "https://github.com/rust-lang/rust/raw/e6830c1ac1ccf0d8ead6c9b04dcf87b2b0890d1e/.azure-pipelines%2Fpr.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.azure-pipelines%2Fpr.yml?ref=e6830c1ac1ccf0d8ead6c9b04dcf87b2b0890d1e", "patch": "@@ -8,11 +8,10 @@ pr:\n \n jobs:\n - job: Linux\n-  timeoutInMinutes: 180\n   pool:\n     vmImage: ubuntu-16.04\n   steps:\n-    - template: steps/linux.yml\n+    - template: steps/run.yml\n   strategy:\n     matrix:\n       x86_64-gnu-llvm-6.0:"}, {"sha": "26a223282cd87a8666ee5f4ccb8472675242d135", "filename": ".azure-pipelines/steps/install-clang.yml", "status": "added", "additions": 40, "deletions": 0, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/e6830c1ac1ccf0d8ead6c9b04dcf87b2b0890d1e/.azure-pipelines%2Fsteps%2Finstall-clang.yml", "raw_url": "https://github.com/rust-lang/rust/raw/e6830c1ac1ccf0d8ead6c9b04dcf87b2b0890d1e/.azure-pipelines%2Fsteps%2Finstall-clang.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.azure-pipelines%2Fsteps%2Finstall-clang.yml?ref=e6830c1ac1ccf0d8ead6c9b04dcf87b2b0890d1e", "patch": "@@ -0,0 +1,40 @@\n+steps:\n+\n+- bash: |\n+    set -e\n+    curl -f http://releases.llvm.org/7.0.0/clang+llvm-7.0.0-x86_64-apple-darwin.tar.xz | tar xJf -\n+\n+    export CC=`pwd`/clang+llvm-7.0.0-x86_64-apple-darwin/bin/clang\n+    echo \"##vso[task.setvariable variable=CC]$CC\"\n+\n+    export CXX=`pwd`/clang+llvm-7.0.0-x86_64-apple-darwin/bin/clang++\n+    echo \"##vso[task.setvariable variable=CXX]$CXX\"\n+\n+    # Configure `AR` specifically so rustbuild doesn't try to infer it as\n+    # `clang-ar` by accident.\n+    echo \"##vso[task.setvariable variable=AR]ar\"\n+  displayName: Install clang (OSX)\n+  condition: and(succeeded(), eq(variables['Agent.OS'], 'Darwin'))\n+\n+# If we're compiling for MSVC then we, like most other distribution builders,\n+# switch to clang as the compiler. This'll allow us eventually to enable LTO\n+# amongst LLVM and rustc. Note that we only do this on MSVC as I don't think\n+# clang has an output mode compatible with MinGW that we need. If it does we\n+# should switch to clang for MinGW as well!\n+#\n+# Note that the LLVM installer is an NSIS installer\n+#\n+# Original downloaded here came from\n+# http://releases.llvm.org/7.0.0/LLVM-7.0.0-win64.exe\n+- script: |\n+    powershell -Command \"iwr -outf %TEMP%\\LLVM-7.0.0-win64.exe https://s3-us-west-1.amazonaws.com/rust-lang-ci2/rust-ci-mirror/LLVM-7.0.0-win64.exe\"\n+    set CLANG_DIR=%CD%\\citools\\clang-rust\n+    %TEMP%\\LLVM-7.0.0-win64.exe /S /NCRC /D=%CLANG_DIR%\n+    set RUST_CONFIGURE_ARGS=%RUST_CONFIGURE_ARGS% --set llvm.clang-cl=%CLANG_DIR%\\bin\\clang-cl.exe\n+    echo ##vso[task.setvariable variable=RUST_CONFIGURE_ARGS]%RUST_CONFIGURE_ARGS%\n+  condition: and(succeeded(), eq(variables['Agent.OS'], 'Windows_NT'), eq(variables['MINGW_URL'],''))\n+  displayName: Install clang (Windows)\n+\n+# Note that we don't install clang on Linux since its compiler story is just so\n+# different. Each container has its own toolchain configured appropriately\n+# already."}, {"sha": "39f58002a7358d18b90aea4ba504d726b524ac07", "filename": ".azure-pipelines/steps/install-sccache.yml", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/e6830c1ac1ccf0d8ead6c9b04dcf87b2b0890d1e/.azure-pipelines%2Fsteps%2Finstall-sccache.yml", "raw_url": "https://github.com/rust-lang/rust/raw/e6830c1ac1ccf0d8ead6c9b04dcf87b2b0890d1e/.azure-pipelines%2Fsteps%2Finstall-sccache.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.azure-pipelines%2Fsteps%2Finstall-sccache.yml?ref=e6830c1ac1ccf0d8ead6c9b04dcf87b2b0890d1e", "patch": "@@ -0,0 +1,21 @@\n+steps:\n+\n+- bash: |\n+    set -e\n+    curl -fo /usr/local/bin/sccache https://s3-us-west-1.amazonaws.com/rust-lang-ci2/rust-ci-mirror/2018-04-02-sccache-x86_64-apple-darwin\n+    chmod +x /usr/local/bin/sccache\n+  displayName: Install sccache (OSX)\n+  condition: and(succeeded(), eq(variables['Agent.OS'], 'Darwin'))\n+\n+- script: |\n+    md sccache\n+    powershell -Command \"iwr -outf sccache\\sccache.exe https://s3-us-west-1.amazonaws.com/rust-lang-ci2/rust-ci-mirror/2018-04-26-sccache-x86_64-pc-windows-msvc\"\n+    echo ##vso[task.prependpath]%CD%\\sccache\n+  displayName: Install sccache (Windows)\n+  condition: and(succeeded(), eq(variables['Agent.OS'], 'Windows_NT'))\n+\n+# Note that we don't install sccache on Linux since it's installed elsewhere\n+# through all the containers.\n+#\n+# FIXME: we should probably install sccache outside the containers and then\n+# mount it inside the containers so we can centralize all installation here."}, {"sha": "45ce01fee758e8191ebd4862c0b1230915535efa", "filename": ".azure-pipelines/steps/install-windows-build-deps.yml", "status": "renamed", "additions": 19, "deletions": 84, "changes": 103, "blob_url": "https://github.com/rust-lang/rust/blob/e6830c1ac1ccf0d8ead6c9b04dcf87b2b0890d1e/.azure-pipelines%2Fsteps%2Finstall-windows-build-deps.yml", "raw_url": "https://github.com/rust-lang/rust/raw/e6830c1ac1ccf0d8ead6c9b04dcf87b2b0890d1e/.azure-pipelines%2Fsteps%2Finstall-windows-build-deps.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.azure-pipelines%2Fsteps%2Finstall-windows-build-deps.yml?ref=e6830c1ac1ccf0d8ead6c9b04dcf87b2b0890d1e", "patch": "@@ -1,19 +1,17 @@\n steps:\n-- checkout: self\n-  fetchDepth: 2\n-\n-- bash: |\n-    set -x\n-    git submodule\n-    export SUBMODULES_EXCLUDES=$(git submodule | grep -Eow 'src/[^ ]+' | sed 's/\\(.*\\)/--exclude=\\1\\/\\.git/')\n-    echo \"##vso[task.setvariable variable=SUBMODULES_EXCLUDES;]$SUBMODULES_EXCLUDES\"\n-\n-- script: |\n-    REM echo hack as drive D is too small\n-    IF NOT \"%DISABLE_DISK_SPACE_HACK%\"==\"1\" (\n-      mkdir c:\\MORE_SPACE\n-      mklink /J build c:\\MORE_SPACE\n-    )\n+# FIXME: are these still needed?\n+# - bash: |\n+#     set -x\n+#     git submodule\n+#     export SUBMODULES_EXCLUDES=$(git submodule | grep -Eow 'src/[^ ]+' | sed 's/\\(.*\\)/--exclude=\\1\\/\\.git/')\n+#     echo \"##vso[task.setvariable variable=SUBMODULES_EXCLUDES;]$SUBMODULES_EXCLUDES\"\n+#\n+# - script: |\n+#     REM echo hack as drive D is too small\n+#     IF NOT \"%DISABLE_DISK_SPACE_HACK%\"==\"1\" (\n+#       mkdir c:\\MORE_SPACE\n+#       mklink /J build c:\\MORE_SPACE\n+#     )\n \n - script: |\n     set MSYS_PATH=%CD%\\citools\\msys64\n@@ -31,6 +29,7 @@ steps:\n     echo ##vso[task.setvariable variable=MSYS_PATH]%MSYS_PATH%\n     echo ##vso[task.prependpath]%MSYS_PATH%\\usr\\bin\n   displayName: Install msys2\n+  condition: and(succeeded(), eq(variables['Agent.OS'], 'Windows_NT'))\n \n # If we need to download a custom MinGW, do so here and set the path\n # appropriately.\n@@ -44,28 +43,9 @@ steps:\n     powershell -Command \"iwr -outf %MINGW_ARCHIVE% %MINGW_URL%/%MINGW_ARCHIVE%\"\n     7z x -y %MINGW_ARCHIVE% > nul\n     echo ##vso[task.prependpath]%CD%\\%MINGW_DIR%\\bin\n-  condition: and(succeeded(), ne(variables['MINGW_URL'],''))\n+  condition: and(succeeded(), eq(variables['Agent.OS'], 'Windows_NT'), ne(variables['MINGW_URL'],''))\n   displayName: Download custom MinGW\n \n-# If we're compiling for MSVC then we, like most other distribution builders,\n-# switch to clang as the compiler. This'll allow us eventually to enable LTO\n-# amongst LLVM and rustc. Note that we only do this on MSVC as I don't think\n-# clang has an output mode compatible with MinGW that we need. If it does we\n-# should switch to clang for MinGW as well!\n-#\n-# Note that the LLVM installer is an NSIS installer\n-#\n-# Original downloaded here came from\n-# http://releases.llvm.org/7.0.0/LLVM-7.0.0-win64.exe\n-- script: |\n-    powershell -Command \"iwr -outf %TEMP%\\LLVM-7.0.0-win64.exe https://s3-us-west-1.amazonaws.com/rust-lang-ci2/rust-ci-mirror/LLVM-7.0.0-win64.exe\"\n-    set CLANG_DIR=%CD%\\citools\\clang-rust\n-    %TEMP%\\LLVM-7.0.0-win64.exe /S /NCRC /D=%CLANG_DIR%\n-    set RUST_CONFIGURE_ARGS=%RUST_CONFIGURE_ARGS% --set llvm.clang-cl=%CLANG_DIR%\\bin\\clang-cl.exe\n-    echo ##vso[task.setvariable variable=RUST_CONFIGURE_ARGS]%RUST_CONFIGURE_ARGS%\n-  condition: and(succeeded(), eq(variables['MINGW_URL'],''))\n-  displayName: Download clang\n-\n # Here we do a pretty heinous thing which is to mangle the MinGW installation\n # we just had above. Currently, as of this writing, we're using MinGW-w64\n # builds of gcc, and that's currently at 6.3.0. We use 6.3.0 as it appears to\n@@ -87,28 +67,20 @@ steps:\n     echo ON\n     powershell -Command \"iwr -outf 2017-04-20-%MSYS_BITS%bit-gdborig.exe %MINGW_URL%/2017-04-20-%MSYS_BITS%bit-gdborig.exe\"\n     mv 2017-04-20-%MSYS_BITS%bit-gdborig.exe %MINGW_DIR%\\bin\\gdborig.exe\n-  condition: and(succeeded(), ne(variables['MINGW_URL'],''))\n+  condition: and(succeeded(), eq(variables['Agent.OS'], 'Windows_NT'), ne(variables['MINGW_URL'],''))\n   displayName: Override with 6.3.0 gdb with 6.2.0 gdb\n \n # Otherwise pull in the MinGW installed on appveyor\n - script: |\n-    echo Find mingw\n-    set PATH | findstr /i msys\n-    set PATH | findstr /i mingw\n     echo ##vso[task.prependpath]%MSYS_PATH%\\mingw%MSYS_BITS%\\bin\n-  condition: and(succeeded(), eq(variables['MINGW_URL'],''))\n+  condition: and(succeeded(), eq(variables['Agent.OS'], 'Windows_NT'), eq(variables['MINGW_URL'],''))\n   displayName: Add MinGW to path\n \n - script: |\n     copy C:\\Python27amd64\\python.exe C:\\Python27amd64\\python2.7.exe\n     echo ##vso[task.prependpath]C:\\Python27amd64\n   displayName: Prefer the \"native\" Python as LLVM has trouble building with MSYS sometimes\n-\n-- script: |\n-    md sccache\n-    powershell -Command \"iwr -outf sccache\\sccache.exe https://s3-us-west-1.amazonaws.com/rust-lang-ci2/rust-ci-mirror/2018-04-26-sccache-x86_64-pc-windows-msvc\"\n-    echo ##vso[task.prependpath]%CD%\\sccache\n-  displayName: Download and install sccache\n+  condition: and(succeeded(), eq(variables['Agent.OS'], 'Windows_NT'))\n \n # Note that this is originally from the github releases patch of Ninja\n - script: |\n@@ -120,41 +92,4 @@ steps:\n     echo ##vso[task.setvariable variable=RUST_CONFIGURE_ARGS]%RUST_CONFIGURE_ARGS%\n     echo ##vso[task.prependpath]%CD%\\ninja\n   displayName: Download and install ninja\n-\n-- script: |\n-    mkdir handle\n-    powershell -Command \"iwr -outf 2017-05-15-Handle.zip https://s3-us-west-1.amazonaws.com/rust-lang-ci2/rust-ci-mirror/2017-05-15-Handle.zip\"\n-    7z x -ohandle 2017-05-15-Handle.zip\n-    del 2017-05-15-Handle.zip\n-    set PATH=%PATH%;%CD%\\handle\n-    handle.exe -accepteula -help\n-    echo ##vso[task.setvariable variable=PATH]%PATH%\n-  displayName: Help debug handle issues\n-\n-- template: show-environment-variables.yml\n-\n-- script: |\n-    REM echo force the specific VS version\n-    IF \"%VCVARS_BAT%\" NEQ \"\" (\n-      CALL \"C:\\Program Files (x86)\\Microsoft Visual Studio\\2017\\Enterprise\\VC\\Auxiliary\\Build\\%VCVARS_BAT%\"\n-    )\n-\n-    where sccache\n-    where rev\n-    set | findstr /v SCCACHE_AZURE_CONNECTION_STRING\n-\n-    if not exist D:\\cache\\rustsrc\\NUL mkdir D:\\cache\\rustsrc\n-\n-    sh src/ci/init_repo.sh . /d/cache/rustsrc\n-    sh src/ci/run.sh\n-  env:\n-    CI: true\n-    CI_JOB_NAME: $(System.JobDisplayName)\n-    SRC: .\n-    NO_CCACHE: 1\n-\n-    # explicitly decrypt secret variables\n-    # see https://docs.microsoft.com/en-us/azure/devops/pipelines/process/variables?view=azure-devops&tabs=yaml%2Cbatch\n-    AWS_ACCESS_KEY_ID: $(SCCACHE_AWS_ACCESS_KEY_ID)\n-    AWS_SECRET_ACCESS_KEY: $(SCCACHE_AWS_SECRET_ACCESS_KEY)\n-  displayName: Run script\n+  condition: and(succeeded(), eq(variables['Agent.OS'], 'Windows_NT'))", "previous_filename": ".azure-pipelines/steps/windows.yml"}, {"sha": "36f980cf992db614293c777e73350ea16ad50d7a", "filename": ".azure-pipelines/steps/linux.yml", "status": "removed", "additions": 0, "deletions": 35, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/9f37b3a4c251d7caaa2870952e217be369e8e9c1/.azure-pipelines%2Fsteps%2Flinux.yml", "raw_url": "https://github.com/rust-lang/rust/raw/9f37b3a4c251d7caaa2870952e217be369e8e9c1/.azure-pipelines%2Fsteps%2Flinux.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.azure-pipelines%2Fsteps%2Flinux.yml?ref=9f37b3a4c251d7caaa2870952e217be369e8e9c1", "patch": "@@ -1,35 +0,0 @@\n-steps:\n-- checkout: self\n-  fetchDepth: 2\n-\n-- template: show-environment-variables.yml\n-- template: show-disk-usage.yml\n-\n-- bash: |\n-    sudo apt install gdb\n-\n-    curl -fo $HOME/stamp https://s3-us-west-1.amazonaws.com/rust-lang-ci2/rust-ci-mirror/2017-03-17-stamp-x86_64-unknown-linux-musl\n-    chmod +x $HOME/stamp\n-\n-    export PATH=$PATH:$HOME/.local/bin:$HOME/Library/Python/2.7/bin/:$HOME\n-    echo \"##vso[task.prependpath]$HOME/.local/bin\"\n-    echo \"##vso[task.prependpath]$HOME/Library/Python/2.7/bin\"\n-    echo \"##vso[task.prependpath]$HOME\"\n-\n-    mkdir -p $HOME/rustsrc\n-  displayName:  Prep\n-\n-- bash: |\n-    export RUN_SCRIPT=\"$BUILD_SOURCESDIRECTORY/src/ci/init_repo.sh . $HOME/rustsrc && src/ci/docker/run.sh $IMAGE\"\n-    echo \"##vso[task.setvariable variable=IMAGE]$IMAGE\"\n-    echo \"##vso[task.setvariable variable=RUN_SCRIPT]$RUN_SCRIPT\"\n-  displayName: Prepare run script\n-\n-- template: show-environment-variables.yml\n-\n-- bash: sudo sh -c 'echo \"/checkout/obj/cores/core.%p.%E\" > /proc/sys/kernel/core_pattern'\n-  displayName: Enable core dump\n-\n-- template: verify-publish-toolstate.yml\n-\n-- template: run-script.yml"}, {"sha": "d1adc3403921262348a3b26ff7f3ae62865c867a", "filename": ".azure-pipelines/steps/macos.yml", "status": "removed", "additions": 0, "deletions": 47, "changes": 47, "blob_url": "https://github.com/rust-lang/rust/blob/9f37b3a4c251d7caaa2870952e217be369e8e9c1/.azure-pipelines%2Fsteps%2Fmacos.yml", "raw_url": "https://github.com/rust-lang/rust/raw/9f37b3a4c251d7caaa2870952e217be369e8e9c1/.azure-pipelines%2Fsteps%2Fmacos.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.azure-pipelines%2Fsteps%2Fmacos.yml?ref=9f37b3a4c251d7caaa2870952e217be369e8e9c1", "patch": "@@ -1,47 +0,0 @@\n-steps:\n-- template: show-disk-usage.yml\n-\n-- bash: |\n-    export PATH=$PATH:$HOME/.local/bin:$HOME/Library/Python/2.7/bin/\n-    mkdir -p $HOME/rustsrc\n-    echo \"##vso[task.setvariable variable=PATH;]$PATH\"\n-\n-    curl -fo /usr/local/bin/sccache https://s3-us-west-1.amazonaws.com/rust-lang-ci2/rust-ci-mirror/2018-04-02-sccache-x86_64-apple-darwin\n-    chmod +x /usr/local/bin/sccache\n-\n-    curl -fo /usr/local/bin/stamp https://s3-us-west-1.amazonaws.com/rust-lang-ci2/rust-ci-mirror/2017-03-17-stamp-x86_64-apple-darwin\n-    chmod +x /usr/local/bin/stamp\n-\n-    export CC=`pwd`/clang+llvm-7.0.0-x86_64-apple-darwin/bin/clang\n-    echo \"##vso[task.setvariable variable=CC]$CC\"\n-\n-    export CXX=`pwd`/clang+llvm-7.0.0-x86_64-apple-darwin/bin/clang++\n-    echo \"##vso[task.setvariable variable=CXX]$CXX\"\n-\n-    echo \"##vso[task.setvariable variable=AR]ar\"\n-  displayName: Prep\n-\n-- bash: brew install gnu-tar\n-  displayName: install a tar that works well\n-\n-- bash: |\n-    curl -f http://releases.llvm.org/7.0.0/clang+llvm-7.0.0-x86_64-apple-darwin.tar.xz | tar xJf -\n-  displayName: Download clang\n-\n-- bash: |\n-    brew update\n-    brew install xz\n-    brew install swig\n-  condition: and(succeeded(), eq(variables['RUST_CHECK_TARGET'],'dist'))\n-  displayName: Install xz and swigw\n-\n-- bash: |\n-    export RUN_SCRIPT=\"$BUILD_SOURCESDIRECTORY/src/ci/init_repo.sh . $HOME/rustsrc && src/ci/run.sh\"\n-    echo \"##vso[task.setvariable variable=RUN_SCRIPT]$RUN_SCRIPT\"\n-  displayName: Prepare run script (init and run)\n-\n-- template: show-environment-variables.yml\n-\n-- template: verify-publish-toolstate.yml\n-\n-- template: run-script.yml"}, {"sha": "bf18518e6b1ca54516227f5271a8811b424fff18", "filename": ".azure-pipelines/steps/run-script.yml", "status": "removed", "additions": 0, "deletions": 35, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/9f37b3a4c251d7caaa2870952e217be369e8e9c1/.azure-pipelines%2Fsteps%2Frun-script.yml", "raw_url": "https://github.com/rust-lang/rust/raw/9f37b3a4c251d7caaa2870952e217be369e8e9c1/.azure-pipelines%2Fsteps%2Frun-script.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.azure-pipelines%2Fsteps%2Frun-script.yml?ref=9f37b3a4c251d7caaa2870952e217be369e8e9c1", "patch": "@@ -1,35 +0,0 @@\n-steps:\n-\n-- bash: |\n-    # Log time information from this machine and an external machine for insight into possible\n-    # clock drift. Timezones don't matter since relative deltas give all the necessary info.\n-    date && (curl -fs --head https://google.com | grep ^Date: | sed 's/Date: //g' || true)\n-\n-    which sccache\n-    stamp sh -x -c \"$RUN_SCRIPT\"\n-\n-    date && (curl -fs --head https://google.com | grep ^Date: | sed 's/Date: //g' || true)\n-  env:\n-    CI: true\n-    CI_JOB_NAME: $(IMAGE)\n-    SRC: .\n-\n-    # Explicitly decrypt secret variables\n-    # See https://docs.microsoft.com/azure/devops/pipelines/process/variables?view=azure-devops&tabs=yaml%2Cbatch#secret-variables\n-    AWS_ACCESS_KEY_ID: $(SCCACHE_AWS_ACCESS_KEY_ID)\n-    AWS_SECRET_ACCESS_KEY: $(SCCACHE_AWS_SECRET_ACCESS_KEY)\n-  displayName: Run script\n-\n-- bash: |\n-    deploy_dir=rustc-builds\n-    if [ \"$DEPLOY_ALT\" == \"1\" ]; then\n-        deploy_dir=rustc-builds-alt\n-    fi\n-    aws s3 cp --no-progress --recursive --acl public-read ./deploy s3://$DEPLOY_BUCKET/$deploy_dir\n-  env:\n-    # Explicitly decrypt secret variables\n-    # See https://docs.microsoft.com/azure/devops/pipelines/process/variables?view=azure-devops&tabs=yaml%2Cbatch#secret-variables\n-    AWS_ACCESS_KEY_ID: $(SCCACHE_AWS_ACCESS_KEY_ID)\n-    AWS_SECRET_ACCESS_KEY: $(SCCACHE_AWS_SECRET_ACCESS_KEY)\n-  condition: and(succeeded(), or(eq(variables.DEPLOY, '1'), eq(variables.DEPLOY_ALT, '1')))\n-  displayName: Upload artifacts"}, {"sha": "dfe54e65e4ecc90637f107c65435a696389d1285", "filename": ".azure-pipelines/steps/run.yml", "status": "added", "additions": 108, "deletions": 0, "changes": 108, "blob_url": "https://github.com/rust-lang/rust/blob/e6830c1ac1ccf0d8ead6c9b04dcf87b2b0890d1e/.azure-pipelines%2Fsteps%2Frun.yml", "raw_url": "https://github.com/rust-lang/rust/raw/e6830c1ac1ccf0d8ead6c9b04dcf87b2b0890d1e/.azure-pipelines%2Fsteps%2Frun.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.azure-pipelines%2Fsteps%2Frun.yml?ref=e6830c1ac1ccf0d8ead6c9b04dcf87b2b0890d1e", "patch": "@@ -0,0 +1,108 @@\n+# FIXME(linux): need to configure core dumps, enable them, and then dump\n+# backtraces on failure from all core dumps:\n+#\n+# - bash: sudo apt install gdb\n+# - bash: sudo sh -c 'echo \"/checkout/obj/cores/core.%p.%E\" > /proc/sys/kernel/core_pattern'\n+#\n+# Check travis config for `gdb --batch` command to print all crash logs\n+\n+steps:\n+\n+- checkout: self\n+  fetchDepth: 2\n+\n+- bash: printenv | sort\n+  displayName: Show environment variables\n+\n+- bash: |\n+    set -e\n+    df -h\n+    du . | sort -nr | head -n100\n+  displayName: Show disk usage\n+  # FIXME: this hasn't been tested, but maybe it works on Windows? Should test!\n+  condition: and(succeeded(), ne(variables['Agent.OS'], 'Windows_NT'))\n+\n+- template: install-sccache.yml\n+- template: install-clang.yml\n+\n+# Install some dependencies needed to build LLDB/Clang, currently only needed\n+# during the `dist` target\n+- bash: |\n+    set -e\n+    brew update\n+    brew install xz\n+    brew install swig\n+  displayName: Install build dependencies (OSX)\n+  condition: and(succeeded(), eq(variables['Agent.OS'], 'Darwin'), eq(variables['RUST_CHECK_TARGET'],'dist'))\n+\n+- template: install-windows-build-deps.yml\n+\n+# Check out all our submodules, but more quickly than using git by using one of\n+# our custom scripts\n+- bash: |\n+    set -e\n+    mkdir -p $HOME/rustsrc\n+    $BUILD_SOURCESDIRECTORY/src/ci/init_repo.sh . $HOME/rustsrc\n+  condition: and(succeeded(), ne(variables['Agent.OS'], 'Windows_NT'))\n+  displayName: Check out submodules (Unix)\n+- script: |\n+    if not exist D:\\cache\\rustsrc\\NUL mkdir D:\\cache\\rustsrc\n+    sh src/ci/init_repo.sh . /d/cache/rustsrc\n+  condition: and(succeeded(), eq(variables['Agent.OS'], 'Windows_NT'))\n+  displayName: Check out submodules (Windows)\n+\n+# Ensure the `aws` CLI is installed so we can deploy later on, cache docker\n+# images, etc.\n+- bash: |\n+    set -e\n+    sudo apt-get install -y python3-setuptools\n+    pip3 install awscli --upgrade --user\n+    echo \"##vso[task.prependpath]$HOME/.local/bin\"\n+  displayName: Install awscli (Linux)\n+  condition: and(succeeded(), eq(variables['Agent.OS'], 'Linux'))\n+- script: pip install awscli\n+  displayName: Install awscli (non-Linux)\n+  condition: and(succeeded(), ne(variables['Agent.OS'], 'Linux'))\n+\n+# Configure our CI_JOB_NAME variable which log analyzers can use for the main\n+# step to see what's going on.\n+- bash: echo \"##vso[task.setvariable variable=CI_JOB_NAME]$SYSTEM_JOBNAME\"\n+  displayName: Configure Job Name\n+\n+# As a quick smoke check on the otherwise very fast mingw-check linux builder\n+# check our own internal scripts.\n+- bash: |\n+    set -e\n+    git clone --depth=1 https://github.com/rust-lang-nursery/rust-toolstate.git\n+    cd rust-toolstate\n+    python2.7 \"$BUILD_SOURCESDIRECTORY/src/tools/publish_toolstate.py\" \"$(git rev-parse HEAD)\" \"$(git log --format=%s -n1 HEAD)\" \"\" \"\"\n+    cd ..\n+    rm -rf rust-toolstate\n+  condition: and(succeeded(), eq(variables['IMAGE'], 'mingw-check'))\n+  displayName: Verify the publish_toolstate script works\n+\n+- bash: |\n+    set -e\n+    if [ \"$IMAGE\" = \"\" ]; then\n+      src/ci/run.sh\n+    else\n+      src/ci/docker/run.sh $IMAGE\n+    fi\n+  timeoutInMinutes: 180\n+  env:\n+    CI: true\n+    SRC: .\n+    AWS_SECRET_ACCESS_KEY: $(SCCACHE_AWS_SECRET_ACCESS_KEY)\n+  displayName: Run build\n+\n+- bash: |\n+    set -e\n+    deploy_dir=rustc-builds\n+    if [ \"$DEPLOY_ALT\" == \"1\" ]; then\n+        deploy_dir=rustc-builds-alt\n+    fi\n+    aws s3 cp --no-progress --recursive --acl public-read ./deploy s3://$DEPLOY_BUCKET/$deploy_dir\n+  env:\n+    AWS_SECRET_ACCESS_KEY: $(SCCACHE_AWS_SECRET_ACCESS_KEY)\n+  condition: and(succeeded(), or(eq(variables.DEPLOY, '1'), eq(variables.DEPLOY_ALT, '1')))\n+  displayName: Upload artifacts"}, {"sha": "902d8036471742a8e2a26efc9ccbeb36ec4b04d3", "filename": ".azure-pipelines/steps/show-disk-usage.yml", "status": "removed", "additions": 0, "deletions": 5, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/9f37b3a4c251d7caaa2870952e217be369e8e9c1/.azure-pipelines%2Fsteps%2Fshow-disk-usage.yml", "raw_url": "https://github.com/rust-lang/rust/raw/9f37b3a4c251d7caaa2870952e217be369e8e9c1/.azure-pipelines%2Fsteps%2Fshow-disk-usage.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.azure-pipelines%2Fsteps%2Fshow-disk-usage.yml?ref=9f37b3a4c251d7caaa2870952e217be369e8e9c1", "patch": "@@ -1,5 +0,0 @@\n-steps:\n-- bash: |\n-    df -h\n-    du . | sort -nr | head -n100\n-  displayName: Show disk usage"}, {"sha": "f6ed063ec6be5d872e6c0def8289bb8f34f35070", "filename": ".azure-pipelines/steps/show-environment-variables.yml", "status": "removed", "additions": 0, "deletions": 3, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/9f37b3a4c251d7caaa2870952e217be369e8e9c1/.azure-pipelines%2Fsteps%2Fshow-environment-variables.yml", "raw_url": "https://github.com/rust-lang/rust/raw/9f37b3a4c251d7caaa2870952e217be369e8e9c1/.azure-pipelines%2Fsteps%2Fshow-environment-variables.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.azure-pipelines%2Fsteps%2Fshow-environment-variables.yml?ref=9f37b3a4c251d7caaa2870952e217be369e8e9c1", "patch": "@@ -1,3 +0,0 @@\n-steps:\n-- bash: printenv | sort\n-  displayName: Show environment variables\n\\ No newline at end of file"}, {"sha": "5531c90e090a781ea99f66356f3d1e3507536e47", "filename": ".azure-pipelines/steps/verify-publish-toolstate.yml", "status": "removed", "additions": 0, "deletions": 9, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/9f37b3a4c251d7caaa2870952e217be369e8e9c1/.azure-pipelines%2Fsteps%2Fverify-publish-toolstate.yml", "raw_url": "https://github.com/rust-lang/rust/raw/9f37b3a4c251d7caaa2870952e217be369e8e9c1/.azure-pipelines%2Fsteps%2Fverify-publish-toolstate.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.azure-pipelines%2Fsteps%2Fverify-publish-toolstate.yml?ref=9f37b3a4c251d7caaa2870952e217be369e8e9c1", "patch": "@@ -1,9 +0,0 @@\n-steps:\n-- bash: |\n-    git clone --depth=1 https://github.com/rust-lang-nursery/rust-toolstate.git\n-    cd rust-toolstate\n-    python2.7 \"$BUILD_SOURCESDIRECTORY/src/tools/publish_toolstate.py\" \"$(git rev-parse HEAD)\" \"$(git log --format=%s -n1 HEAD)\" \"\" \"\"\n-    cd ..\n-    rm -rf rust-toolstate\n-  condition: and(succeeded(), eq(variables['IMAGE'], 'mingw-check'))\n-  displayName: Verify the publish_toolstate script works"}, {"sha": "47470a2aa348a51b751b24a481aefd2a4a7291ea", "filename": ".azure-pipelines/try.yml", "status": "modified", "additions": 55, "deletions": 6, "changes": 61, "blob_url": "https://github.com/rust-lang/rust/blob/e6830c1ac1ccf0d8ead6c9b04dcf87b2b0890d1e/.azure-pipelines%2Ftry.yml", "raw_url": "https://github.com/rust-lang/rust/raw/e6830c1ac1ccf0d8ead6c9b04dcf87b2b0890d1e/.azure-pipelines%2Ftry.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.azure-pipelines%2Ftry.yml?ref=e6830c1ac1ccf0d8ead6c9b04dcf87b2b0890d1e", "patch": "@@ -11,20 +11,69 @@ variables:\n \n jobs:\n - job: Linux\n-  timeoutInMinutes: 180\n   pool:\n     vmImage: ubuntu-16.04\n   strategy:\n     matrix:\n       dist-x86_64-linux:\n         IMAGE: dist-x86_64-linux\n         DEPLOY: 1\n-\n-      # \"alternate\" deployments, these are \"nightlies\" but have LLVM assertions\n-      # turned on, they're deployed to a different location primarily for\n-      # additional testing.\n       dist-x86_64-linux-alt:\n         IMAGE: dist-x86_64-linux\n         DEPLOY_ALT: 1\n+      test-various:\n+        IMAGE: test-various\n+  steps:\n+  - template: steps/run.yml\n+\n+- job: macOS\n+  pool:\n+    vmImage: macos-10.13\n+  strategy:\n+    matrix:\n+      x86_64-apple:\n+        RUST_CHECK_TARGET: check\n+        RUST_CONFIGURE_ARGS: --build=x86_64-apple-darwin --enable-sanitizers --enable-profiler --set rust.jemalloc\n+        RUSTC_RETRY_LINKER_ON_SEGFAULT: 1\n+        MACOSX_DEPLOYMENT_TARGET: 10.8\n+        MACOSX_STD_DEPLOYMENT_TARGET: 10.7\n+        NO_LLVM_ASSERTIONS: 1\n+        NO_DEBUG_ASSERTIONS: 1\n+\n+      dist-x86_64-apple:\n+        RUST_CHECK_TARGET: dist\n+        RUST_CONFIGURE_ARGS: --target=aarch64-apple-ios,armv7-apple-ios,armv7s-apple-ios,i386-apple-ios,x86_64-apple-ios --enable-full-tools --enable-sanitizers --enable-profiler --enable-lldb --set rust.jemalloc\n+        DEPLOY: 1\n+        RUSTC_RETRY_LINKER_ON_SEGFAULT: 1\n+        MACOSX_DEPLOYMENT_TARGET: 10.7\n+        NO_LLVM_ASSERTIONS: 1\n+        NO_DEBUG_ASSERTIONS: 1\n+        DIST_REQUIRE_ALL_TOOLS: 1\n+  steps:\n+  - template: steps/run.yml\n+\n+- job: Windows\n+  pool:\n+    vmImage: 'vs2017-win2016'\n+  strategy:\n+    matrix:\n+     x86_64-msvc-1:\n+       RUST_CONFIGURE_ARGS: --build=x86_64-pc-windows-msvc --enable-profiler\n+       SCRIPT: make ci-subset-1\n+       NO_DEBUG_ASSERTIONS: 1\n+       NO_LLVM_ASSERTIONS: 1\n+     x86_64-msvc-2:\n+       RUST_CONFIGURE_ARGS: --build=x86_64-pc-windows-msvc --enable-profiler\n+       SCRIPT: make ci-subset-2\n+\n+     dist-x86_64-msvc:\n+       RUST_CONFIGURE_ARGS: >\n+         --build=x86_64-pc-windows-msvc\n+         --target=x86_64-pc-windows-msvc,aarch64-pc-windows-msvc\n+         --enable-full-tools\n+         --enable-profiler\n+       SCRIPT: python x.py dist\n+       DIST_REQUIRE_ALL_TOOLS: 1\n+       DEPLOY: 1\n   steps:\n-  - template: steps/linux.yml\n+  - template: steps/run.yml"}, {"sha": "b1e4f931c4413a3da88bac1d469b66469afa5b67", "filename": "src/ci/init_repo.sh", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e6830c1ac1ccf0d8ead6c9b04dcf87b2b0890d1e/src%2Fci%2Finit_repo.sh", "raw_url": "https://github.com/rust-lang/rust/raw/e6830c1ac1ccf0d8ead6c9b04dcf87b2b0890d1e/src%2Fci%2Finit_repo.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Finit_repo.sh?ref=e6830c1ac1ccf0d8ead6c9b04dcf87b2b0890d1e", "patch": "@@ -46,7 +46,7 @@ function fetch_github_commit_archive {\n     rm $cached\n }\n \n-included=\"src/llvm-project src/llvm-emscripten src/doc/book src/doc/rust-by-example\"\n+included=\"src/llvm-project src/llvm-emscripten src/doc/book src/doc/rust-by-example src/tools/rustfmt\"\n modules=\"$(git config --file .gitmodules --get-regexp '\\.path$' | cut -d' ' -f2)\"\n modules=($modules)\n use_git=\"\""}, {"sha": "c996dcb14af38c0566e02039f05ec0cfc16c9303", "filename": "src/ci/run.sh", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e6830c1ac1ccf0d8ead6c9b04dcf87b2b0890d1e/src%2Fci%2Frun.sh", "raw_url": "https://github.com/rust-lang/rust/raw/e6830c1ac1ccf0d8ead6c9b04dcf87b2b0890d1e/src%2Fci%2Frun.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Frun.sh?ref=e6830c1ac1ccf0d8ead6c9b04dcf87b2b0890d1e", "patch": "@@ -141,4 +141,4 @@ else\n   do_make \"$RUST_CHECK_TARGET\"\n fi\n \n-sccache --show-stats\n+sccache --show-stats || true"}]}