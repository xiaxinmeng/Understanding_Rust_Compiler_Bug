{"sha": "3c1eef2e91dda0b97aa604e519ebb5fc98fbdbb2", "node_id": "C_kwDOAAsO6NoAKDNjMWVlZjJlOTFkZGEwYjk3YWE2MDRlNTE5ZWJiNWZjOThmYmRiYjI", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2022-07-26T04:12:22Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-07-26T04:12:22Z"}, "message": "Rollup merge of #99711 - tmiasko:coverage, r=wesleywiser\n\nRemove reachable coverage without counters\n\nRemove reachable coverage without counters to maintain invariant that\neither there is no coverage at all or there is a live coverage counter\nleft that provides the function source hash.\n\nThe motivating example would be a following closure:\n\n```rust\n    let f = |x: bool| {\n        debug_assert!(x);\n    };\n```\n\nWhich, with span changes from #93967, with disabled debug assertions,\nafter the final CFG simplifications but before removal of dead blocks,\ngives rise to MIR:\n\n```rust\nfn main::{closure#0}(_1: &[closure@a.rs:2:13: 2:22], _2: bool) -> () {\n    debug x => _2;\n    let mut _0: ();\n\n    bb0: {\n        Coverage::Expression(4294967295) = 1 - 2;\n        return;\n    }\n\n    ...\n}\n```\n\nWhich also makes the initial instrumentation quite suspect, although\nthis pull request doesn't attempt to address that aspect directly.\n\nFixes #98833.\n\nr? ``@wesleywiser`` ``@richkadel``", "tree": {"sha": "0e9d01eeb36b94a2a8536d070480336b63c8ac89", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0e9d01eeb36b94a2a8536d070480336b63c8ac89"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3c1eef2e91dda0b97aa604e519ebb5fc98fbdbb2", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJi32mmCRBK7hj4Ov3rIwAAhfsIABl0o/Hly6P3mJ4PKX+g5tFU\n2ZCU5/0UsdzFpqwRQ6efLB/vmmwyMtSBQKRbJ+InD6RStxTzE/qAcYhjMoj3px9+\nwpmHxt9AU/Uu4pWrxfBFPsqMbXyki048h8BuA5sT7yl8ELbSCvg6YNmLf4lNp3Q4\n/M2Eb8t9Gx0jS+DGP22rZmseWiOApoRaxg6KhHG2v6ZEa0G8/bp3jW4XmCIMJZuj\nzYKRCUeqU5E4HCv4zctD2wr2L6+atzdM3HutqDlAkyLb5vEs2kRV/L9BOtZ2Aaej\nvyUZJD5oUbSETh3Hf6kzsvYvhp34Chbo8Sv/XXgvkMrGBrE0awDtqcIy6yRGflQ=\n=5iTP\n-----END PGP SIGNATURE-----\n", "payload": "tree 0e9d01eeb36b94a2a8536d070480336b63c8ac89\nparent 2744c0ef182c5ba9320c62f2e5f01c076e4fd323\nparent 5f40a4f7a0aa6552e615fe89a6018e36c93f672e\nauthor Yuki Okushi <jtitor@2k36.org> 1658808742 +0900\ncommitter GitHub <noreply@github.com> 1658808742 +0900\n\nRollup merge of #99711 - tmiasko:coverage, r=wesleywiser\n\nRemove reachable coverage without counters\n\nRemove reachable coverage without counters to maintain invariant that\neither there is no coverage at all or there is a live coverage counter\nleft that provides the function source hash.\n\nThe motivating example would be a following closure:\n\n```rust\n    let f = |x: bool| {\n        debug_assert!(x);\n    };\n```\n\nWhich, with span changes from #93967, with disabled debug assertions,\nafter the final CFG simplifications but before removal of dead blocks,\ngives rise to MIR:\n\n```rust\nfn main::{closure#0}(_1: &[closure@a.rs:2:13: 2:22], _2: bool) -> () {\n    debug x => _2;\n    let mut _0: ();\n\n    bb0: {\n        Coverage::Expression(4294967295) = 1 - 2;\n        return;\n    }\n\n    ...\n}\n```\n\nWhich also makes the initial instrumentation quite suspect, although\nthis pull request doesn't attempt to address that aspect directly.\n\nFixes #98833.\n\nr? ``@wesleywiser`` ``@richkadel``\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3c1eef2e91dda0b97aa604e519ebb5fc98fbdbb2", "html_url": "https://github.com/rust-lang/rust/commit/3c1eef2e91dda0b97aa604e519ebb5fc98fbdbb2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3c1eef2e91dda0b97aa604e519ebb5fc98fbdbb2/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2744c0ef182c5ba9320c62f2e5f01c076e4fd323", "url": "https://api.github.com/repos/rust-lang/rust/commits/2744c0ef182c5ba9320c62f2e5f01c076e4fd323", "html_url": "https://github.com/rust-lang/rust/commit/2744c0ef182c5ba9320c62f2e5f01c076e4fd323"}, {"sha": "5f40a4f7a0aa6552e615fe89a6018e36c93f672e", "url": "https://api.github.com/repos/rust-lang/rust/commits/5f40a4f7a0aa6552e615fe89a6018e36c93f672e", "html_url": "https://github.com/rust-lang/rust/commit/5f40a4f7a0aa6552e615fe89a6018e36c93f672e"}], "stats": {"total": 60, "additions": 42, "deletions": 18}, "files": [{"sha": "180f4c7dcd6e80d1a1dac8e1c0f7c0623147ebff", "filename": "compiler/rustc_mir_transform/src/simplify.rs", "status": "modified", "additions": 11, "deletions": 1, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/3c1eef2e91dda0b97aa604e519ebb5fc98fbdbb2/compiler%2Frustc_mir_transform%2Fsrc%2Fsimplify.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3c1eef2e91dda0b97aa604e519ebb5fc98fbdbb2/compiler%2Frustc_mir_transform%2Fsrc%2Fsimplify.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_transform%2Fsrc%2Fsimplify.rs?ref=3c1eef2e91dda0b97aa604e519ebb5fc98fbdbb2", "patch": "@@ -315,7 +315,7 @@ pub fn remove_dead_blocks<'tcx>(tcx: TyCtxt<'tcx>, body: &mut Body<'tcx>) {\n /// with `0` executions.\n ///\n /// If there are no live `Counter` `Coverage` statements remaining, we remove\n-/// dead `Coverage` statements along with the dead blocks. Since at least one\n+/// `Coverage` statements along with the dead blocks. Since at least one\n /// counter per function is required by LLVM (and necessary, to add the\n /// `function_hash` to the counter's call to the LLVM intrinsic\n /// `instrprof.increment()`).\n@@ -342,6 +342,16 @@ fn save_unreachable_coverage(\n         }\n     }\n \n+    for block in &mut basic_blocks.raw[..first_dead_block] {\n+        for statement in &mut block.statements {\n+            let StatementKind::Coverage(_) = &statement.kind else { continue };\n+            let instance = statement.source_info.scope.inlined_instance(source_scopes);\n+            if !live.contains(&instance) {\n+                statement.make_nop();\n+            }\n+        }\n+    }\n+\n     if live.is_empty() {\n         return;\n     }"}, {"sha": "effdef80e8eb65628a784f09a9865d4c86d4f77c", "filename": "src/test/run-make-fulldeps/coverage-reports/expected_show_coverage.inline-dead.txt", "status": "modified", "additions": 23, "deletions": 16, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/3c1eef2e91dda0b97aa604e519ebb5fc98fbdbb2/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2Fexpected_show_coverage.inline-dead.txt", "raw_url": "https://github.com/rust-lang/rust/raw/3c1eef2e91dda0b97aa604e519ebb5fc98fbdbb2/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2Fexpected_show_coverage.inline-dead.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2Fexpected_show_coverage.inline-dead.txt?ref=3c1eef2e91dda0b97aa604e519ebb5fc98fbdbb2", "patch": "@@ -1,21 +1,28 @@\n     1|       |// Regression test for issue #98833.\n-    2|       |// compile-flags: -Zinline-mir\n+    2|       |// compile-flags: -Zinline-mir -Cdebug-assertions=off\n     3|       |\n     4|      1|fn main() {\n     5|      1|    println!(\"{}\", live::<false>());\n-    6|      1|}\n-    7|       |\n-    8|       |#[inline]\n-    9|      1|fn live<const B: bool>() -> u32 {\n-   10|      1|    if B {\n-   11|      0|        dead()\n-   12|       |    } else {\n-   13|      1|        0\n-   14|       |    }\n-   15|      1|}\n-   16|       |\n-   17|       |#[inline]\n-   18|      0|fn dead() -> u32 {\n-   19|      0|    42\n-   20|      0|}\n+    6|      1|\n+    7|      1|    let f = |x: bool| {\n+    8|       |        debug_assert!(\n+    9|       |            x\n+   10|       |        );\n+   11|      1|    };\n+   12|      1|    f(false);\n+   13|      1|}\n+   14|       |\n+   15|       |#[inline]\n+   16|      1|fn live<const B: bool>() -> u32 {\n+   17|      1|    if B {\n+   18|      0|        dead()\n+   19|       |    } else {\n+   20|      1|        0\n+   21|       |    }\n+   22|      1|}\n+   23|       |\n+   24|       |#[inline]\n+   25|      0|fn dead() -> u32 {\n+   26|      0|    42\n+   27|      0|}\n "}, {"sha": "854fa062967526a5b530b4f68ca7883c1907f73a", "filename": "src/test/run-make-fulldeps/coverage/inline-dead.rs", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/3c1eef2e91dda0b97aa604e519ebb5fc98fbdbb2/src%2Ftest%2Frun-make-fulldeps%2Fcoverage%2Finline-dead.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3c1eef2e91dda0b97aa604e519ebb5fc98fbdbb2/src%2Ftest%2Frun-make-fulldeps%2Fcoverage%2Finline-dead.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fcoverage%2Finline-dead.rs?ref=3c1eef2e91dda0b97aa604e519ebb5fc98fbdbb2", "patch": "@@ -1,8 +1,15 @@\n // Regression test for issue #98833.\n-// compile-flags: -Zinline-mir\n+// compile-flags: -Zinline-mir -Cdebug-assertions=off\n \n fn main() {\n     println!(\"{}\", live::<false>());\n+\n+    let f = |x: bool| {\n+        debug_assert!(\n+            x\n+        );\n+    };\n+    f(false);\n }\n \n #[inline]"}]}