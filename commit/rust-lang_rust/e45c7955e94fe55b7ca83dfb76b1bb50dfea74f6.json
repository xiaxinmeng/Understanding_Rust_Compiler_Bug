{"sha": "e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6", "node_id": "MDY6Q29tbWl0NzI0NzEyOmU0NWM3OTU1ZTk0ZmU1NWI3Y2E4M2RmYjc2YjFiYjUwZGZlYTc0ZjY=", "commit": {"author": {"name": "Masood Malekghassemi", "email": "atash@google.com", "date": "2016-04-06T07:20:59Z"}, "committer": {"name": "Masood Malekghassemi", "email": "atash@google.com", "date": "2016-04-06T20:57:18Z"}, "message": "Replace consider_unification_despite_ambiguity with obligation variant", "tree": {"sha": "6b7f4a94e6084f3eb6d2a0c58868a52ed33a55da", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6b7f4a94e6084f3eb6d2a0c58868a52ed33a55da"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6", "html_url": "https://github.com/rust-lang/rust/commit/e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6/comments", "author": {"login": "soltanmm-google", "id": 21180148, "node_id": "MDQ6VXNlcjIxMTgwMTQ4", "avatar_url": "https://avatars.githubusercontent.com/u/21180148?v=4", "gravatar_id": "", "url": "https://api.github.com/users/soltanmm-google", "html_url": "https://github.com/soltanmm-google", "followers_url": "https://api.github.com/users/soltanmm-google/followers", "following_url": "https://api.github.com/users/soltanmm-google/following{/other_user}", "gists_url": "https://api.github.com/users/soltanmm-google/gists{/gist_id}", "starred_url": "https://api.github.com/users/soltanmm-google/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/soltanmm-google/subscriptions", "organizations_url": "https://api.github.com/users/soltanmm-google/orgs", "repos_url": "https://api.github.com/users/soltanmm-google/repos", "events_url": "https://api.github.com/users/soltanmm-google/events{/privacy}", "received_events_url": "https://api.github.com/users/soltanmm-google/received_events", "type": "User", "site_admin": false}, "committer": {"login": "soltanmm-google", "id": 21180148, "node_id": "MDQ6VXNlcjIxMTgwMTQ4", "avatar_url": "https://avatars.githubusercontent.com/u/21180148?v=4", "gravatar_id": "", "url": "https://api.github.com/users/soltanmm-google", "html_url": "https://github.com/soltanmm-google", "followers_url": "https://api.github.com/users/soltanmm-google/followers", "following_url": "https://api.github.com/users/soltanmm-google/following{/other_user}", "gists_url": "https://api.github.com/users/soltanmm-google/gists{/gist_id}", "starred_url": "https://api.github.com/users/soltanmm-google/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/soltanmm-google/subscriptions", "organizations_url": "https://api.github.com/users/soltanmm-google/orgs", "repos_url": "https://api.github.com/users/soltanmm-google/repos", "events_url": "https://api.github.com/users/soltanmm-google/events{/privacy}", "received_events_url": "https://api.github.com/users/soltanmm-google/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "57e5d43c770201d837298175a2d55818867bdb33", "url": "https://api.github.com/repos/rust-lang/rust/commits/57e5d43c770201d837298175a2d55818867bdb33", "html_url": "https://github.com/rust-lang/rust/commit/57e5d43c770201d837298175a2d55818867bdb33"}], "stats": {"total": 231, "additions": 156, "deletions": 75}, "files": [{"sha": "ccba2df22eb48a6d5a887961a8a8059b976747ae", "filename": "src/librustc/diagnostics.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6/src%2Flibrustc%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6/src%2Flibrustc%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fdiagnostics.rs?ref=e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6", "patch": "@@ -1544,4 +1544,5 @@ register_diagnostics! {\n     E0490, // a value of type `..` is borrowed for too long\n     E0491, // in type `..`, reference has a longer lifetime than the data it...\n     E0495, // cannot infer an appropriate lifetime due to conflicting requirements\n+    E0524, // the closure implements `..` but not `..`\n }"}, {"sha": "51eebd43731136f21bfa65746e0881a9387a3cc5", "filename": "src/librustc/middle/free_region.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6/src%2Flibrustc%2Fmiddle%2Ffree_region.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6/src%2Flibrustc%2Fmiddle%2Ffree_region.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ffree_region.rs?ref=e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6", "patch": "@@ -59,6 +59,7 @@ impl FreeRegionMap {\n                 ty::Predicate::Equate(..) |\n                 ty::Predicate::WellFormed(..) |\n                 ty::Predicate::ObjectSafe(..) |\n+                ty::Predicate::ClosureKind(..) |\n                 ty::Predicate::TypeOutlives(..) => {\n                     // No region bounds here\n                 }"}, {"sha": "cb618af88f6e5bbef82e55138f0286dc8a153a39", "filename": "src/librustc/traits/error_reporting.rs", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6/src%2Flibrustc%2Ftraits%2Ferror_reporting.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6/src%2Flibrustc%2Ftraits%2Ferror_reporting.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Ftraits%2Ferror_reporting.rs?ref=e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6", "patch": "@@ -466,6 +466,20 @@ pub fn report_selection_error<'a, 'tcx>(infcx: &InferCtxt<'a, 'tcx>,\n                         err.emit();\n                     }\n \n+                    ty::Predicate::ClosureKind(closure_def_id, kind) => {\n+                        let found_kind = infcx.closure_kind(closure_def_id).unwrap();\n+                        let closure_span = infcx.tcx.map.span_if_local(closure_def_id).unwrap();\n+                        let mut err = struct_span_err!(\n+                            infcx.tcx.sess, closure_span, E0524,\n+                            \"the closure implements `{}` but not `{}`\",\n+                            found_kind,\n+                            kind);\n+                        err.span_note(\n+                            obligation.cause.span,\n+                            &format!(\"the requirement to implement `{}` derives from here\", kind));\n+                        err.emit();\n+                    }\n+\n                     ty::Predicate::WellFormed(ty) => {\n                         // WF predicates cannot themselves make\n                         // errors. They can only block due to"}, {"sha": "662adf98007684edfcbf365e0a8bd301b2857366", "filename": "src/librustc/traits/fulfill.rs", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6/src%2Flibrustc%2Ftraits%2Ffulfill.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6/src%2Flibrustc%2Ftraits%2Ffulfill.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Ftraits%2Ffulfill.rs?ref=e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6", "patch": "@@ -652,6 +652,21 @@ fn process_predicate1<'a,'tcx>(selcx: &mut SelectionContext<'a,'tcx>,\n             }\n         }\n \n+        ty::Predicate::ClosureKind(closure_def_id, kind) => {\n+            match selcx.infcx().closure_kind(closure_def_id) {\n+                Some(closure_kind) => {\n+                    if closure_kind.extends(kind) {\n+                        Ok(Some(vec![]))\n+                    } else {\n+                        Err(CodeSelectionError(Unimplemented))\n+                    }\n+                }\n+                None => {\n+                    Ok(None)\n+                }\n+            }\n+        }\n+\n         ty::Predicate::WellFormed(ty) => {\n             match ty::wf::obligations(selcx.infcx(), obligation.cause.body_id,\n                                       ty, obligation.cause.span) {"}, {"sha": "90a54d8263b4c9eae4eec266966700aab836f644", "filename": "src/librustc/traits/object_safety.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6/src%2Flibrustc%2Ftraits%2Fobject_safety.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6/src%2Flibrustc%2Ftraits%2Fobject_safety.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Ftraits%2Fobject_safety.rs?ref=e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6", "patch": "@@ -165,6 +165,7 @@ pub fn supertraits_reference_self<'tcx>(tcx: &TyCtxt<'tcx>,\n                 ty::Predicate::ObjectSafe(..) |\n                 ty::Predicate::TypeOutlives(..) |\n                 ty::Predicate::RegionOutlives(..) |\n+                ty::Predicate::ClosureKind(..) |\n                 ty::Predicate::Equate(..) => {\n                     false\n                 }\n@@ -207,6 +208,7 @@ fn generics_require_sized_self<'tcx>(tcx: &TyCtxt<'tcx>,\n                 ty::Predicate::RegionOutlives(..) |\n                 ty::Predicate::WellFormed(..) |\n                 ty::Predicate::ObjectSafe(..) |\n+                ty::Predicate::ClosureKind(..) |\n                 ty::Predicate::TypeOutlives(..) => {\n                     false\n                 }"}, {"sha": "17dbe90c1e19c5d68fb456b9b6bb6829ec852e9a", "filename": "src/librustc/traits/select.rs", "status": "modified", "additions": 31, "deletions": 74, "changes": 105, "blob_url": "https://github.com/rust-lang/rust/blob/e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6/src%2Flibrustc%2Ftraits%2Fselect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6/src%2Flibrustc%2Ftraits%2Fselect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Ftraits%2Fselect.rs?ref=e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6", "patch": "@@ -198,9 +198,10 @@ enum SelectionCandidate<'tcx> {\n     /// we found an applicable bound in the trait definition.\n     ProjectionCandidate,\n \n-    /// Implementation of a `Fn`-family trait by one of the\n-    /// anonymous types generated for a `||` expression.\n-    ClosureCandidate(/* closure */ DefId, &'tcx ty::ClosureSubsts<'tcx>),\n+    /// Implementation of a `Fn`-family trait by one of the anonymous types\n+    /// generated for a `||` expression. The ty::ClosureKind informs the\n+    /// confirmation step what ClosureKind obligation to emit.\n+    ClosureCandidate(/* closure */ DefId, &'tcx ty::ClosureSubsts<'tcx>, ty::ClosureKind),\n \n     /// Implementation of a `Fn`-family trait by one of the anonymous\n     /// types generated for a fn pointer type (e.g., `fn(int)->int`)\n@@ -321,75 +322,11 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n \n         let stack = self.push_stack(TraitObligationStackList::empty(), obligation);\n         match self.candidate_from_obligation(&stack)? {\n-            None => {\n-                self.consider_unification_despite_ambiguity(obligation);\n-                Ok(None)\n-            }\n+            None => Ok(None),\n             Some(candidate) => Ok(Some(self.confirm_candidate(obligation, candidate)?)),\n         }\n     }\n \n-    /// In the particular case of unboxed closure obligations, we can\n-    /// sometimes do some amount of unification for the\n-    /// argument/return types even though we can't yet fully match obligation.\n-    /// The particular case we are interesting in is an obligation of the form:\n-    ///\n-    ///    C : FnFoo<A>\n-    ///\n-    /// where `C` is an unboxed closure type and `FnFoo` is one of the\n-    /// `Fn` traits. Because we know that users cannot write impls for closure types\n-    /// themselves, the only way that `C : FnFoo` can fail to match is under two\n-    /// conditions:\n-    ///\n-    /// 1. The closure kind for `C` is not yet known, because inference isn't complete.\n-    /// 2. The closure kind for `C` *is* known, but doesn't match what is needed.\n-    ///    For example, `C` may be a `FnOnce` closure, but a `Fn` closure is needed.\n-    ///\n-    /// In either case, we always know what argument types are\n-    /// expected by `C`, no matter what kind of `Fn` trait it\n-    /// eventually matches. So we can go ahead and unify the argument\n-    /// types, even though the end result is ambiguous.\n-    ///\n-    /// Note that this is safe *even if* the trait would never be\n-    /// matched (case 2 above). After all, in that case, an error will\n-    /// result, so it kind of doesn't matter what we do --- unifying\n-    /// the argument types can only be helpful to the user, because\n-    /// once they patch up the kind of closure that is expected, the\n-    /// argment types won't really change.\n-    fn consider_unification_despite_ambiguity(&mut self, obligation: &TraitObligation<'tcx>) {\n-        // Is this a `C : FnFoo(...)` trait reference for some trait binding `FnFoo`?\n-        match self.tcx().lang_items.fn_trait_kind(obligation.predicate.0.def_id()) {\n-            Some(_) => { }\n-            None => { return; }\n-        }\n-\n-        // Is the self-type a closure type? We ignore bindings here\n-        // because if it is a closure type, it must be a closure type from\n-        // within this current fn, and hence none of the higher-ranked\n-        // lifetimes can appear inside the self-type.\n-        let self_ty = self.infcx.shallow_resolve(*obligation.self_ty().skip_binder());\n-        let (closure_def_id, substs) = match self_ty.sty {\n-            ty::TyClosure(id, ref substs) => (id, substs),\n-            _ => { return; }\n-        };\n-        assert!(!substs.has_escaping_regions());\n-\n-        // It is OK to call the unnormalized variant here - this is only\n-        // reached for TyClosure: Fn inputs where the closure kind is\n-        // still unknown, which should only occur in typeck where the\n-        // closure type is already normalized.\n-        let closure_trait_ref = self.closure_trait_ref_unnormalized(obligation,\n-                                                                    closure_def_id,\n-                                                                    substs);\n-\n-        match self.confirm_poly_trait_refs(obligation.cause.clone(),\n-                                           obligation.predicate.to_poly_trait_ref(),\n-                                           closure_trait_ref) {\n-            Ok(()) => { }\n-            Err(_) => { /* Silently ignore errors. */ }\n-        }\n-    }\n-\n     ///////////////////////////////////////////////////////////////////////////\n     // EVALUATION\n     //\n@@ -532,6 +469,21 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n                     }\n                 }\n             }\n+\n+            ty::Predicate::ClosureKind(closure_def_id, kind) => {\n+                match self.infcx.closure_kind(closure_def_id) {\n+                    Some(closure_kind) => {\n+                        if closure_kind.extends(kind) {\n+                            EvaluatedToOk\n+                        } else {\n+                            EvaluatedToErr\n+                        }\n+                    }\n+                    None => {\n+                        EvaluatedToAmbig\n+                    }\n+                }\n+            }\n         }\n     }\n \n@@ -1282,12 +1234,12 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n             Some(closure_kind) => {\n                 debug!(\"assemble_unboxed_candidates: closure_kind = {:?}\", closure_kind);\n                 if closure_kind.extends(kind) {\n-                    candidates.vec.push(ClosureCandidate(closure_def_id, substs));\n+                    candidates.vec.push(ClosureCandidate(closure_def_id, substs, kind));\n                 }\n             }\n             None => {\n                 debug!(\"assemble_unboxed_candidates: closure_kind not yet known\");\n-                candidates.ambiguous = true;\n+                candidates.vec.push(ClosureCandidate(closure_def_id, substs, kind));\n             }\n         }\n \n@@ -2071,9 +2023,9 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n                 Ok(VtableImpl(vtable_impl))\n             }\n \n-            ClosureCandidate(closure_def_id, substs) => {\n+            ClosureCandidate(closure_def_id, substs, kind) => {\n                 let vtable_closure =\n-                    self.confirm_closure_candidate(obligation, closure_def_id, substs)?;\n+                    self.confirm_closure_candidate(obligation, closure_def_id, substs, kind)?;\n                 Ok(VtableClosure(vtable_closure))\n             }\n \n@@ -2430,7 +2382,8 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n     fn confirm_closure_candidate(&mut self,\n                                  obligation: &TraitObligation<'tcx>,\n                                  closure_def_id: DefId,\n-                                 substs: &ty::ClosureSubsts<'tcx>)\n+                                 substs: &ty::ClosureSubsts<'tcx>,\n+                                 kind: ty::ClosureKind)\n                                  -> Result<VtableClosureData<'tcx, PredicateObligation<'tcx>>,\n                                            SelectionError<'tcx>>\n     {\n@@ -2441,7 +2394,7 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n \n         let Normalized {\n             value: trait_ref,\n-            obligations\n+            mut obligations\n         } = self.closure_trait_ref(obligation, closure_def_id, substs);\n \n         debug!(\"confirm_closure_candidate(closure_def_id={:?}, trait_ref={:?}, obligations={:?})\",\n@@ -2453,6 +2406,10 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n                                      obligation.predicate.to_poly_trait_ref(),\n                                      trait_ref)?;\n \n+        obligations.push(Obligation::new(\n+                obligation.cause.clone(),\n+                ty::Predicate::ClosureKind(closure_def_id, kind)));\n+\n         Ok(VtableClosureData {\n             closure_def_id: closure_def_id,\n             substs: substs.clone(),"}, {"sha": "f01f2e1954b261c79298e97ab7b3c1e922f70112", "filename": "src/librustc/traits/util.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6/src%2Flibrustc%2Ftraits%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6/src%2Flibrustc%2Ftraits%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Ftraits%2Futil.rs?ref=e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6", "patch": "@@ -60,6 +60,9 @@ impl<'a,'tcx> PredicateSet<'a,'tcx> {\n \n             ty::Predicate::ObjectSafe(data) =>\n                 ty::Predicate::ObjectSafe(data),\n+\n+            ty::Predicate::ClosureKind(closure_def_id, kind) =>\n+                ty::Predicate::ClosureKind(closure_def_id, kind)\n         };\n         self.set.insert(normalized_pred)\n     }\n@@ -156,6 +159,9 @@ impl<'cx, 'tcx> Elaborator<'cx, 'tcx> {\n             ty::Predicate::Projection(..) => {\n                 // Nothing to elaborate in a projection predicate.\n             }\n+            ty::Predicate::ClosureKind(..) => {\n+                // Nothing to elaborate when waiting for a closure's kind to be inferred.\n+            }\n             ty::Predicate::RegionOutlives(..) |\n             ty::Predicate::TypeOutlives(..) => {\n                 // Currently, we do not \"elaborate\" predicates like"}, {"sha": "971f62ffdc5a6156154b88a7abae6c724275136a", "filename": "src/librustc/ty/mod.rs", "status": "modified", "additions": 12, "deletions": 1, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6/src%2Flibrustc%2Fty%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6/src%2Flibrustc%2Fty%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fmod.rs?ref=e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6", "patch": "@@ -784,6 +784,11 @@ pub enum Predicate<'tcx> {\n \n     /// trait must be object-safe\n     ObjectSafe(DefId),\n+\n+    /// No direct syntax. May be thought of as `where T : FnFoo<...>` for some 'TypeSpace'\n+    /// substitutions `...` and T being a closure type.  Satisfied (or refuted) once we know the\n+    /// closure's kind.\n+    ClosureKind(DefId, ClosureKind),\n }\n \n impl<'tcx> Predicate<'tcx> {\n@@ -873,6 +878,8 @@ impl<'tcx> Predicate<'tcx> {\n                 Predicate::WellFormed(data.subst(tcx, substs)),\n             Predicate::ObjectSafe(trait_def_id) =>\n                 Predicate::ObjectSafe(trait_def_id),\n+            Predicate::ClosureKind(closure_def_id, kind) =>\n+                Predicate::ClosureKind(closure_def_id, kind),\n         }\n     }\n }\n@@ -1060,6 +1067,9 @@ impl<'tcx> Predicate<'tcx> {\n             ty::Predicate::ObjectSafe(_trait_def_id) => {\n                 vec![]\n             }\n+            ty::Predicate::ClosureKind(_closure_def_id, _kind) => {\n+                vec![]\n+            }\n         };\n \n         // The only reason to collect into a vector here is that I was\n@@ -1080,6 +1090,7 @@ impl<'tcx> Predicate<'tcx> {\n             Predicate::RegionOutlives(..) |\n             Predicate::WellFormed(..) |\n             Predicate::ObjectSafe(..) |\n+            Predicate::ClosureKind(..) |\n             Predicate::TypeOutlives(..) => {\n                 None\n             }\n@@ -1735,7 +1746,7 @@ pub struct ItemSubsts<'tcx> {\n     pub substs: Substs<'tcx>,\n }\n \n-#[derive(Clone, Copy, PartialOrd, Ord, PartialEq, Eq, Debug, RustcEncodable, RustcDecodable)]\n+#[derive(Clone, Copy, PartialOrd, Ord, PartialEq, Eq, Hash, Debug, RustcEncodable, RustcDecodable)]\n pub enum ClosureKind {\n     // Warning: Ordering is significant here! The ordering is chosen\n     // because the trait Fn is a subtrait of FnMut and so in turn, and"}, {"sha": "9a432fb628e15dcd5adbfdced10cdb49bb4ec654", "filename": "src/librustc/ty/structural_impls.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6/src%2Flibrustc%2Fty%2Fstructural_impls.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6/src%2Flibrustc%2Fty%2Fstructural_impls.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fstructural_impls.rs?ref=e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6", "patch": "@@ -644,6 +644,8 @@ impl<'tcx> TypeFoldable<'tcx> for ty::Predicate<'tcx> {\n                 ty::Predicate::Projection(binder.fold_with(folder)),\n             ty::Predicate::WellFormed(data) =>\n                 ty::Predicate::WellFormed(data.fold_with(folder)),\n+            ty::Predicate::ClosureKind(closure_def_id, kind) =>\n+                ty::Predicate::ClosureKind(closure_def_id, kind),\n             ty::Predicate::ObjectSafe(trait_def_id) =>\n                 ty::Predicate::ObjectSafe(trait_def_id),\n         }\n@@ -657,6 +659,7 @@ impl<'tcx> TypeFoldable<'tcx> for ty::Predicate<'tcx> {\n             ty::Predicate::TypeOutlives(ref binder) => binder.visit_with(visitor),\n             ty::Predicate::Projection(ref binder) => binder.visit_with(visitor),\n             ty::Predicate::WellFormed(data) => data.visit_with(visitor),\n+            ty::Predicate::ClosureKind(_closure_def_id, _kind) => false,\n             ty::Predicate::ObjectSafe(_trait_def_id) => false,\n         }\n     }"}, {"sha": "253dfb8110bd3de19dda6d532b0f4ce3f69de075", "filename": "src/librustc/ty/util.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6/src%2Flibrustc%2Fty%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6/src%2Flibrustc%2Fty%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Futil.rs?ref=e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6", "patch": "@@ -301,6 +301,7 @@ impl<'tcx> TyCtxt<'tcx> {\n                     ty::Predicate::Equate(..) |\n                     ty::Predicate::WellFormed(..) |\n                     ty::Predicate::ObjectSafe(..) |\n+                    ty::Predicate::ClosureKind(..) |\n                     ty::Predicate::RegionOutlives(..) => {\n                         None\n                     }"}, {"sha": "d50e0091e554a20d380ed86ce5f6c15fc3e3dcf2", "filename": "src/librustc/ty/wf.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6/src%2Flibrustc%2Fty%2Fwf.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6/src%2Flibrustc%2Fty%2Fwf.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fwf.rs?ref=e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6", "patch": "@@ -92,6 +92,8 @@ pub fn predicate_obligations<'a,'tcx>(infcx: &InferCtxt<'a, 'tcx>,\n         }\n         ty::Predicate::ObjectSafe(_) => {\n         }\n+        ty::Predicate::ClosureKind(..) => {\n+        }\n     }\n \n     wf.normalize()\n@@ -155,6 +157,7 @@ pub fn implied_bounds<'a,'tcx>(\n                     ty::Predicate::Trait(..) |\n                     ty::Predicate::Equate(..) |\n                     ty::Predicate::Projection(..) |\n+                    ty::Predicate::ClosureKind(..) |\n                     ty::Predicate::ObjectSafe(..) =>\n                         vec![],\n "}, {"sha": "1c68e0177a13712474a8131a3503c33045b8f378", "filename": "src/librustc/util/ppaux.rs", "status": "modified", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6/src%2Flibrustc%2Futil%2Fppaux.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6/src%2Flibrustc%2Futil%2Fppaux.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Futil%2Fppaux.rs?ref=e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6", "patch": "@@ -453,6 +453,9 @@ impl<'tcx> fmt::Debug for ty::Predicate<'tcx> {\n             ty::Predicate::ObjectSafe(trait_def_id) => {\n                 write!(f, \"ObjectSafe({:?})\", trait_def_id)\n             }\n+            ty::Predicate::ClosureKind(closure_def_id, kind) => {\n+                write!(f, \"ClosureKind({:?}, {:?})\", closure_def_id, kind)\n+            }\n         }\n     }\n }\n@@ -1027,6 +1030,16 @@ impl<'tcx> fmt::Display for ty::ProjectionTy<'tcx> {\n     }\n }\n \n+impl fmt::Display for ty::ClosureKind {\n+    fn fmt(&self, f: &mut fmt::Formatter) -> fmt::Result {\n+        match *self {\n+            ty::ClosureKind::Fn => write!(f, \"Fn\"),\n+            ty::ClosureKind::FnMut => write!(f, \"FnMut\"),\n+            ty::ClosureKind::FnOnce => write!(f, \"FnOnce\"),\n+        }\n+    }\n+}\n+\n impl<'tcx> fmt::Display for ty::Predicate<'tcx> {\n     fn fmt(&self, f: &mut fmt::Formatter) -> fmt::Result {\n         match *self {\n@@ -1040,6 +1053,11 @@ impl<'tcx> fmt::Display for ty::Predicate<'tcx> {\n                 ty::tls::with(|tcx| {\n                     write!(f, \"the trait `{}` is object-safe\", tcx.item_path_str(trait_def_id))\n                 }),\n+            ty::Predicate::ClosureKind(closure_def_id, kind) =>\n+                ty::tls::with(|tcx| {\n+                    write!(f, \"the closure `{}` implements the trait `{}`\",\n+                           tcx.item_path_str(closure_def_id), kind)\n+                }),\n         }\n     }\n }"}, {"sha": "49dea39283496a7fc4d21237d07fa7eb363cfe9e", "filename": "src/librustc_metadata/tydecode.rs", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6/src%2Flibrustc_metadata%2Ftydecode.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6/src%2Flibrustc_metadata%2Ftydecode.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Ftydecode.rs?ref=e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6", "patch": "@@ -553,6 +553,18 @@ impl<'a,'tcx> TyDecoder<'a,'tcx> {\n                 assert_eq!(self.next(), '|');\n                 ty::Predicate::ObjectSafe(def_id)\n             }\n+            'c' => {\n+                let def_id = self.parse_def();\n+                assert_eq!(self.next(), '|');\n+                let kind = match self.next() {\n+                    'f' => ty::ClosureKind::Fn,\n+                    'm' => ty::ClosureKind::FnMut,\n+                    'o' => ty::ClosureKind::FnOnce,\n+                    c => bug!(\"Encountered invalid character in metadata: {}\", c)\n+                };\n+                assert_eq!(self.next(), '|');\n+                ty::Predicate::ClosureKind(def_id, kind)\n+            }\n             c => bug!(\"Encountered invalid character in metadata: {}\", c)\n         }\n     }"}, {"sha": "298d7d47ab991a28d5c4e8b42381da9bfd5413d0", "filename": "src/librustc_metadata/tyencode.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6/src%2Flibrustc_metadata%2Ftyencode.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6/src%2Flibrustc_metadata%2Ftyencode.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Ftyencode.rs?ref=e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6", "patch": "@@ -479,6 +479,14 @@ pub fn enc_predicate<'a, 'tcx>(w: &mut Cursor<Vec<u8>>,\n         ty::Predicate::ObjectSafe(trait_def_id) => {\n             write!(w, \"O{}|\", (cx.ds)(cx.tcx, trait_def_id));\n         }\n+        ty::Predicate::ClosureKind(closure_def_id, kind) => {\n+            let kind_char = match kind {\n+                ty::ClosureKind::Fn => 'f',\n+                ty::ClosureKind::FnMut => 'm',\n+                ty::ClosureKind::FnOnce => 'o',\n+            };\n+            write!(w, \"c{}|{}|\", (cx.ds)(cx.tcx, closure_def_id), kind_char);\n+        }\n     }\n }\n "}, {"sha": "84c277a8a880f0c2810978d010dfc566385dc95c", "filename": "src/librustc_typeck/check/closure.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6/src%2Flibrustc_typeck%2Fcheck%2Fclosure.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6/src%2Flibrustc_typeck%2Fcheck%2Fclosure.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fclosure.rs?ref=e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6", "patch": "@@ -179,6 +179,9 @@ fn deduce_expectations_from_obligations<'a,'tcx>(\n                 ty::Predicate::TypeOutlives(..) => None,\n                 ty::Predicate::WellFormed(..) => None,\n                 ty::Predicate::ObjectSafe(..) => None,\n+                ty::Predicate::ClosureKind(_closure_def_id, kind) => {\n+                    return Some(kind);\n+                }\n             };\n             opt_trait_ref\n                 .and_then(|trait_ref| self_type_matches_expected_vid(fcx, trait_ref, expected_vid))"}, {"sha": "5eb486181a5c2021f0379196a9a7bcd0b1d89873", "filename": "src/librustc_typeck/check/method/probe.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6/src%2Flibrustc_typeck%2Fcheck%2Fmethod%2Fprobe.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6/src%2Flibrustc_typeck%2Fcheck%2Fmethod%2Fprobe.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fmethod%2Fprobe.rs?ref=e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6", "patch": "@@ -491,6 +491,7 @@ impl<'a,'tcx> ProbeContext<'a,'tcx> {\n                     ty::Predicate::RegionOutlives(..) |\n                     ty::Predicate::WellFormed(..) |\n                     ty::Predicate::ObjectSafe(..) |\n+                    ty::Predicate::ClosureKind(..) |\n                     ty::Predicate::TypeOutlives(..) => {\n                         None\n                     }"}, {"sha": "80eda54ad6224d6b721658b928f9889900f3e67e", "filename": "src/librustc_typeck/collect.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6/src%2Flibrustc_typeck%2Fcollect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6/src%2Flibrustc_typeck%2Fcollect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcollect.rs?ref=e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6", "patch": "@@ -449,6 +449,7 @@ impl<'tcx> GetTypeParameterBounds<'tcx> for ty::GenericPredicates<'tcx> {\n                     ty::Predicate::RegionOutlives(..) |\n                     ty::Predicate::WellFormed(..) |\n                     ty::Predicate::ObjectSafe(..) |\n+                    ty::Predicate::ClosureKind(..) |\n                     ty::Predicate::Projection(..) => {\n                         false\n                     }"}, {"sha": "b621460c65902d45be7c1f72d6d26937b1f4894d", "filename": "src/librustdoc/clean/mod.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6/src%2Flibrustdoc%2Fclean%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6/src%2Flibrustdoc%2Fclean%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Fmod.rs?ref=e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6", "patch": "@@ -853,6 +853,7 @@ impl<'a> Clean<WherePredicate> for ty::Predicate<'a> {\n             Predicate::Projection(ref pred) => pred.clean(cx),\n             Predicate::WellFormed(_) => panic!(\"not user writable\"),\n             Predicate::ObjectSafe(_) => panic!(\"not user writable\"),\n+            Predicate::ClosureKind(..) => panic!(\"not user writable\"),\n         }\n     }\n }"}, {"sha": "4f06f56706bd539c81ab3ba7e364d8d687807f1d", "filename": "src/test/compile-fail/closure-wrong-kind.rs", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6/src%2Ftest%2Fcompile-fail%2Fclosure-wrong-kind.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6/src%2Ftest%2Fcompile-fail%2Fclosure-wrong-kind.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fclosure-wrong-kind.rs?ref=e45c7955e94fe55b7ca83dfb76b1bb50dfea74f6", "patch": "@@ -0,0 +1,23 @@\n+// Copyright 2016 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+/* Any copyright is dedicated to the Public Domain.\n+ * http://creativecommons.org/publicdomain/zero/1.0/ */\n+\n+struct X;\n+fn foo<T>(_: T) {}\n+fn bar<T: Fn(u32)>(_: T) {}\n+\n+fn main() {\n+    let x = X;\n+    let closure = |_| foo(x);\n+    //~^ ERROR the closure implements `FnOnce` but not `Fn`\n+    bar(closure);\n+}"}]}