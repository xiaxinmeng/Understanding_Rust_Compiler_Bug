{"sha": "1edf6d2d4fe613b43796554d9765056183efe21a", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFlZGY2ZDJkNGZlNjEzYjQzNzk2NTU0ZDk3NjUwNTYxODNlZmUyMWE=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-06-03T13:18:12Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-06-03T13:18:12Z"}, "message": "Merge #4730\n\n4730: Document rust-project.json r=matklad a=matklad\n\n\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>", "tree": {"sha": "712899e3c9d4745e49cef3dfae4f75c346f6efbb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/712899e3c9d4745e49cef3dfae4f75c346f6efbb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1edf6d2d4fe613b43796554d9765056183efe21a", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJe16MUCRBK7hj4Ov3rIwAAdHIIAGs/QNo1Eh8nhHnYsEAbsIQS\nZH2UWf8RZTaixPJ/Us7B3LMzxjpEdoWSrq1+5d9VPWCKKqSZfOjl4mWg4hnfhOO/\nxmLVqTeA2x3esNwT9OrQK9H5So3xaACH8iLlPkHrM8d3bHPI6tLfGFU1m56NXPOz\ntkyotQOmmLVtcNpEVi7/b52lqASQKyQE5dPxLTZvreGJfvPRSbaZKTCfX15uupal\nTryvn9QVetXq/PSK78/z5DfWNuQHvX17+2pmHtvc984ynVzDYr8I5L0G/eUmjKBo\nto4kK2g9VN7xKayxM/CbgsYQAAxqd7cy1oRyNufomBowQNvZ18aN79WPZs94PMc=\n=9KSV\n-----END PGP SIGNATURE-----\n", "payload": "tree 712899e3c9d4745e49cef3dfae4f75c346f6efbb\nparent e644f64f2a68a14a841adb3f3e897d1fcb35f23f\nparent fa019c8f562326a720d2ef9165626c4c5703f67b\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1591190292 +0000\ncommitter GitHub <noreply@github.com> 1591190292 +0000\n\nMerge #4730\n\n4730: Document rust-project.json r=matklad a=matklad\n\n\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1edf6d2d4fe613b43796554d9765056183efe21a", "html_url": "https://github.com/rust-lang/rust/commit/1edf6d2d4fe613b43796554d9765056183efe21a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1edf6d2d4fe613b43796554d9765056183efe21a/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e644f64f2a68a14a841adb3f3e897d1fcb35f23f", "url": "https://api.github.com/repos/rust-lang/rust/commits/e644f64f2a68a14a841adb3f3e897d1fcb35f23f", "html_url": "https://github.com/rust-lang/rust/commit/e644f64f2a68a14a841adb3f3e897d1fcb35f23f"}, {"sha": "fa019c8f562326a720d2ef9165626c4c5703f67b", "url": "https://api.github.com/repos/rust-lang/rust/commits/fa019c8f562326a720d2ef9165626c4c5703f67b", "html_url": "https://github.com/rust-lang/rust/commit/fa019c8f562326a720d2ef9165626c4c5703f67b"}], "stats": {"total": 138, "additions": 118, "deletions": 20}, "files": [{"sha": "7ad941279506fc8d30ddc5196121019afb4b41ae", "filename": "crates/ra_project_model/src/lib.rs", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/1edf6d2d4fe613b43796554d9765056183efe21a/crates%2Fra_project_model%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1edf6d2d4fe613b43796554d9765056183efe21a/crates%2Fra_project_model%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_project_model%2Fsrc%2Flib.rs?ref=1edf6d2d4fe613b43796554d9765056183efe21a", "patch": "@@ -32,6 +32,12 @@ pub enum ProjectWorkspace {\n     Json { project: JsonProject },\n }\n \n+impl From<JsonProject> for ProjectWorkspace {\n+    fn from(project: JsonProject) -> ProjectWorkspace {\n+        ProjectWorkspace::Json { project }\n+    }\n+}\n+\n /// `PackageRoot` describes a package root folder.\n /// Which may be an external dependency, or a member of\n /// the current workspace.\n@@ -144,11 +150,11 @@ impl ProjectManifest {\n \n impl ProjectWorkspace {\n     pub fn load(\n-        root: ProjectManifest,\n+        manifest: ProjectManifest,\n         cargo_features: &CargoConfig,\n         with_sysroot: bool,\n     ) -> Result<ProjectWorkspace> {\n-        let res = match root {\n+        let res = match manifest {\n             ProjectManifest::ProjectJson(project_json) => {\n                 let file = File::open(&project_json).with_context(|| {\n                     format!(\"Failed to open json file {}\", project_json.display())"}, {"sha": "0e5dc56fd744b57b2fa5af29ea953f0fa60034ec", "filename": "crates/rust-analyzer/src/config.rs", "status": "modified", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/1edf6d2d4fe613b43796554d9765056183efe21a/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1edf6d2d4fe613b43796554d9765056183efe21a/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs?ref=1edf6d2d4fe613b43796554d9765056183efe21a", "patch": "@@ -261,6 +261,22 @@ impl Config {\n             self.lens = LensConfig::NO_LENS;\n         }\n \n+        if let Some(linked_projects) = get::<Vec<ManifestOrJsonProject>>(value, \"/linkedProjects\") {\n+            if !linked_projects.is_empty() {\n+                self.linked_projects.clear();\n+                for linked_project in linked_projects {\n+                    let linked_project = match linked_project {\n+                        ManifestOrJsonProject::Manifest(it) => match ProjectManifest::from_manifest_file(it) {\n+                            Ok(it) => it.into(),\n+                            Err(_) => continue,\n+                        }\n+                        ManifestOrJsonProject::JsonProject(it) => it.into(),\n+                    };\n+                    self.linked_projects.push(linked_project);\n+                }\n+            }\n+        }\n+\n         log::info!(\"Config::update() = {:#?}\", self);\n \n         fn get<'a, T: Deserialize<'a>>(value: &'a serde_json::Value, pointer: &str) -> Option<T> {\n@@ -324,3 +340,10 @@ impl Config {\n         }\n     }\n }\n+\n+#[derive(Deserialize)]\n+#[serde(untagged)]\n+enum ManifestOrJsonProject {\n+    Manifest(PathBuf),\n+    JsonProject(JsonProject),\n+}"}, {"sha": "1f8f6b978616babdf06dbfcc88f582143e9b69e0", "filename": "crates/rust-analyzer/src/main_loop.rs", "status": "modified", "additions": 17, "deletions": 18, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/1edf6d2d4fe613b43796554d9765056183efe21a/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1edf6d2d4fe613b43796554d9765056183efe21a/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs?ref=1edf6d2d4fe613b43796554d9765056183efe21a", "patch": "@@ -105,24 +105,23 @@ pub fn main_loop(config: Config, connection: Connection) -> Result<()> {\n                 .linked_projects\n                 .iter()\n                 .filter_map(|project| match project {\n-                    LinkedProject::ProjectManifest(it) => Some(it),\n-                    LinkedProject::JsonProject(_) => None,\n-                })\n-                .filter_map(|root| {\n-                    ra_project_model::ProjectWorkspace::load(\n-                        root.clone(),\n-                        &config.cargo,\n-                        config.with_sysroot,\n-                    )\n-                    .map_err(|err| {\n-                        log::error!(\"failed to load workspace: {:#}\", err);\n-                        show_message(\n-                            lsp_types::MessageType::Error,\n-                            format!(\"rust-analyzer failed to load workspace: {:#}\", err),\n-                            &connection.sender,\n-                        );\n-                    })\n-                    .ok()\n+                    LinkedProject::ProjectManifest(manifest) => {\n+                        ra_project_model::ProjectWorkspace::load(\n+                            manifest.clone(),\n+                            &config.cargo,\n+                            config.with_sysroot,\n+                        )\n+                        .map_err(|err| {\n+                            log::error!(\"failed to load workspace: {:#}\", err);\n+                            show_message(\n+                                lsp_types::MessageType::Error,\n+                                format!(\"rust-analyzer failed to load workspace: {:#}\", err),\n+                                &connection.sender,\n+                            );\n+                        })\n+                        .ok()\n+                    }\n+                    LinkedProject::JsonProject(it) => Some(it.clone().into()),\n                 })\n                 .collect::<Vec<_>>()\n         };"}, {"sha": "ea714f49addf05145defc3a20bfe303c66f1fd5c", "filename": "docs/user/manual.adoc", "status": "modified", "additions": 51, "deletions": 0, "changes": 51, "blob_url": "https://github.com/rust-lang/rust/blob/1edf6d2d4fe613b43796554d9765056183efe21a/docs%2Fuser%2Fmanual.adoc", "raw_url": "https://github.com/rust-lang/rust/raw/1edf6d2d4fe613b43796554d9765056183efe21a/docs%2Fuser%2Fmanual.adoc", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/docs%2Fuser%2Fmanual.adoc?ref=1edf6d2d4fe613b43796554d9765056183efe21a", "patch": "@@ -269,6 +269,57 @@ Gnome Builder currently has support for RLS, and there's no way to configure the\n 1. Rename, symlink or copy the `rust-analyzer` binary to `rls` and place it somewhere Builder can find (in `PATH`, or under `~/.cargo/bin`).\n 2. Enable the Rust Builder plugin.\n \n+== Non-Cargo Based Projects\n+\n+rust-analyzer does not require Cargo.\n+However, if you use some other build system, you'll have to describe the structure of your project for rust-analyzer in the `rust-project.json` format:\n+\n+[source,TypeScript]\n+----\n+interface JsonProject {\n+   /// The set of paths containing the crates for this project.\n+   /// Any `Crate` must be nested inside some `root`.\n+   roots: string[];\n+   /// The set of crates comprising the current project.\n+   /// Must include all transitive dependencies as well as sysroot crate (libstd, libcore and such).\n+   crates: Crate[];\n+}\n+\n+interface Crate {\n+    /// Path to the root module of the crate.\n+    root_module: string;\n+    /// Edition of the crate.\n+    edition: \"2015\" | \"2018\";\n+    /// Dependencies\n+    deps: Dep[];\n+    /// The set of cfgs activated for a given crate, like `[\"unix\", \"feature=foo\", \"feature=bar\"]`.\n+    cfg: string[];\n+\n+    /// value of the OUT_DIR env variable.\n+    out_dir?: string;\n+    /// For proc-macro crates, path to compiles proc-macro (.so file).\n+    proc_macro_dylib_path?: string;\n+}\n+\n+interface Dep {\n+    /// Index of a crate in the `crates` array.\n+    crate: number,\n+    /// Name as should appear in the (implicit) `extern crate name` declaration.\n+    name: string,\n+}\n+----\n+\n+This format is provisional and subject to change.\n+Specifically, the `roots` setup will be different eventually.\n+\n+There are tree ways to feed `rust-project.json` to rust-analyzer:\n+\n+* Place `rust-project.json` file at the root of the project, and rust-anlayzer will discover it.\n+* Specify `\"rust-analyzer.linkedProjects\": [ \"path/to/rust-project.json\" ]` in the settings (and make sure that your LSP client sends settings as a part of initialize request).\n+* Specify `\"rust-analyzer.linkedProjects\": [ { \"roots\": [...], \"crates\": [...] }]` inline.\n+\n+See https://github.com/rust-analyzer/rust-project.json-example for a small example.\n+\n == Features\n \n include::./generated_features.adoc[]"}, {"sha": "30ab7ba4a9f831fcd78b80cd0cae68047eb25b71", "filename": "editors/code/package.json", "status": "modified", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/1edf6d2d4fe613b43796554d9765056183efe21a/editors%2Fcode%2Fpackage.json", "raw_url": "https://github.com/rust-lang/rust/raw/1edf6d2d4fe613b43796554d9765056183efe21a/editors%2Fcode%2Fpackage.json", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fpackage.json?ref=1edf6d2d4fe613b43796554d9765056183efe21a", "patch": "@@ -475,6 +475,25 @@\n                     \"markdownDescription\": \"Whether to show Implementations lens. Only applies when `#rust-analyzer.lens.enable#` is set.\",\n                     \"type\": \"boolean\",\n                     \"default\": true\n+                },\n+                \"rust-analyzer.linkedProjects\": {\n+                    \"markdownDescription\": [\n+                        \"Disable project auto-discovery in favor of explicitly specified set of projects.\",\n+                        \"Elements must be paths pointing to Cargo.toml, rust-project.json, or JSON objects in rust-project.json format\"\n+                    ],\n+                    \"type\": \"array\",\n+                    \"items\": {\n+                        \"type\": [\n+                            \"string\",\n+                            \"object\"\n+                        ]\n+                    },\n+                    \"default\": null\n+                },\n+                \"rust-analyzer.withSysroot\": {\n+                    \"markdownDescription\": \"Internal config for debugging, disables loading of sysroot crates\",\n+                    \"type\": \"boolean\",\n+                    \"default\": true\n                 }\n             }\n         },"}]}