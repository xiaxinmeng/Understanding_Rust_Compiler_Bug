{"sha": "abae61257c4d866bb321bfb80ad16b7531736f7e", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFiYWU2MTI1N2M0ZDg2NmJiMzIxYmZiODBhZDE2Yjc1MzE3MzZmN2U=", "commit": {"author": {"name": "Jed Davis", "email": "jld@panix.com", "date": "2012-12-31T04:39:15Z"}, "committer": {"name": "Jed Davis", "email": "jld@panix.com", "date": "2013-01-12T07:42:51Z"}, "message": "Allow consts to be non-nullary enum constructors", "tree": {"sha": "5d79540c5bdbd0eb116e0d132e5b5851b166ce27", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5d79540c5bdbd0eb116e0d132e5b5851b166ce27"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/abae61257c4d866bb321bfb80ad16b7531736f7e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/abae61257c4d866bb321bfb80ad16b7531736f7e", "html_url": "https://github.com/rust-lang/rust/commit/abae61257c4d866bb321bfb80ad16b7531736f7e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/abae61257c4d866bb321bfb80ad16b7531736f7e/comments", "author": {"login": "jld", "id": 254973, "node_id": "MDQ6VXNlcjI1NDk3Mw==", "avatar_url": "https://avatars.githubusercontent.com/u/254973?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jld", "html_url": "https://github.com/jld", "followers_url": "https://api.github.com/users/jld/followers", "following_url": "https://api.github.com/users/jld/following{/other_user}", "gists_url": "https://api.github.com/users/jld/gists{/gist_id}", "starred_url": "https://api.github.com/users/jld/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jld/subscriptions", "organizations_url": "https://api.github.com/users/jld/orgs", "repos_url": "https://api.github.com/users/jld/repos", "events_url": "https://api.github.com/users/jld/events{/privacy}", "received_events_url": "https://api.github.com/users/jld/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jld", "id": 254973, "node_id": "MDQ6VXNlcjI1NDk3Mw==", "avatar_url": "https://avatars.githubusercontent.com/u/254973?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jld", "html_url": "https://github.com/jld", "followers_url": "https://api.github.com/users/jld/followers", "following_url": "https://api.github.com/users/jld/following{/other_user}", "gists_url": "https://api.github.com/users/jld/gists{/gist_id}", "starred_url": "https://api.github.com/users/jld/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jld/subscriptions", "organizations_url": "https://api.github.com/users/jld/orgs", "repos_url": "https://api.github.com/users/jld/repos", "events_url": "https://api.github.com/users/jld/events{/privacy}", "received_events_url": "https://api.github.com/users/jld/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f76e28aa1c093c59671749006e1a7ae203d66b7c", "url": "https://api.github.com/repos/rust-lang/rust/commits/f76e28aa1c093c59671749006e1a7ae203d66b7c", "html_url": "https://github.com/rust-lang/rust/commit/f76e28aa1c093c59671749006e1a7ae203d66b7c"}], "stats": {"total": 21, "additions": 20, "deletions": 1}, "files": [{"sha": "df937c92d95dbce31af85b56ab6caec9eb0fe49f", "filename": "src/librustc/middle/check_const.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/abae61257c4d866bb321bfb80ad16b7531736f7e/src%2Flibrustc%2Fmiddle%2Fcheck_const.rs", "raw_url": "https://github.com/rust-lang/rust/raw/abae61257c4d866bb321bfb80ad16b7531736f7e/src%2Flibrustc%2Fmiddle%2Fcheck_const.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fcheck_const.rs?ref=abae61257c4d866bb321bfb80ad16b7531736f7e", "patch": "@@ -138,11 +138,12 @@ fn check_expr(sess: Session, def_map: resolve::DefMap,\n           expr_call(callee, _, false) => {\n             match def_map.find(callee.id) {\n                 Some(def_struct(*)) => {}    // OK.\n+                Some(def_variant(*)) => {}    // OK.\n                 _ => {\n                     sess.span_err(\n                         e.span,\n                         ~\"function calls in constants are limited to \\\n-                          structure constructors\");\n+                          struct and enum constructors\");\n                 }\n             }\n           }"}, {"sha": "23b4bb32eeaac9f576e9d05e094e3341eea227d5", "filename": "src/librustc/middle/trans/consts.rs", "status": "modified", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/abae61257c4d866bb321bfb80ad16b7531736f7e/src%2Flibrustc%2Fmiddle%2Ftrans%2Fconsts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/abae61257c4d866bb321bfb80ad16b7531736f7e/src%2Flibrustc%2Fmiddle%2Ftrans%2Fconsts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fconsts.rs?ref=abae61257c4d866bb321bfb80ad16b7531736f7e", "patch": "@@ -454,6 +454,24 @@ fn const_expr(cx: @crate_ctxt, e: @ast::expr) -> ValueRef {\n                         C_named_struct(llty, ~[ llstructbody ])\n                     }\n                 }\n+            Some(ast::def_variant(tid, vid)) => {\n+                let ety = ty::expr_ty(cx.tcx, e);\n+                let degen = ty::enum_is_univariant(cx.tcx, tid);\n+                let size = shape::static_size_of_enum(cx, ety);\n+\n+                let discrim = base::get_discrim_val(cx, e.span, tid, vid);\n+                let c_args = C_struct(args.map(|a| const_expr(cx, *a)));\n+\n+                let fields = if !degen {\n+                    ~[discrim, c_args]\n+                } else if size == 0 {\n+                    ~[discrim]\n+                } else {\n+                    ~[c_args]\n+                };\n+\n+                C_struct(fields)\n+            }\n                 _ => cx.sess.span_bug(e.span, ~\"expected a struct def\")\n             }\n           }"}]}