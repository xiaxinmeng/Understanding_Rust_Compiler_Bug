{"sha": "378300a63d1951e2718a6b0a077439fc1b14742b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjM3ODMwMGE2M2QxOTUxZTI3MThhNmIwYTA3NzQzOWZjMWIxNDc0MmI=", "commit": {"author": {"name": "Yuki Okushi", "email": "yuki.okushi@huawei.com", "date": "2021-06-16T21:35:42Z"}, "committer": {"name": "Yuki Okushi", "email": "yuki.okushi@huawei.com", "date": "2021-09-17T04:13:28Z"}, "message": "Make diagnostics clearer for `?` operators", "tree": {"sha": "8a982f7ef97c997308268d9de13532a72e313104", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8a982f7ef97c997308268d9de13532a72e313104"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/378300a63d1951e2718a6b0a077439fc1b14742b", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEx6scKn6IIf/+FpBu2rpbBylhwYoFAmFEFegACgkQ2rpbBylh\nwYpAPxAAnwV8pUIGt29M90Ky66Zt5x4PjC1NyeEUN9Kghd7mjoJ4C62Sqo5SxpM/\nfUVJ/iZO9WZXvhCTE8ED2pIutoXvBdIKsj+UlqoAw8GFo7X1rtvzD1i9HF8vciFa\n7CiKkumBUB4R5a/dne/+6K5/TcOyC2ECaOlM7oRUXU7u2jbvgApXkkWFBJbX/s28\nUSNC5T7GynhJBpjnktdJA2xuOzpK+rPP1vNBBhII4Lu6p9O0Nr7UQ6xGe040TEbx\n6V0SmlnowH94rS4kYIi6Sf/oWrIWgxAi060xTq3ty+/vj32mbn5b010z3jGWHkoD\nfmYx15b3R+MKKXaTw8StuvyBWkLluXMadc4cIpVyEfGVDr5Z0yyydy/Sc+2Imn7x\nmVV8cwTULaxs0lX+tKpuD+VzTBQmiLUOoU8NuhDYJh2EypgqGZSwoHy3kOhSOom2\nCQPNbA5ULfJoehC1fXLCS2NGtQtS9H7ixsz231Y3GmuNAchGo6d3u5GHcoiFcRvn\nSLL1Ovvl76oHSkK9rVM5cG7OtGV33AUdVNJffrphJnYbLMXiQk4C71oS8AVblZGW\nkgR+7M7zISEirmDwx86puhTDOd+6hMqKDUgW0fGB6nt7W16uf+iDxoezrzPVQ0Ym\n/vM8NGHKjOIPNi4aYmami7VcIHqwTus/BCWQS+cPBThFZbhgOn0=\n=AOci\n-----END PGP SIGNATURE-----", "payload": "tree 8a982f7ef97c997308268d9de13532a72e313104\nparent 78a46efff06558674b51c10d8d81758285746ab5\nauthor Yuki Okushi <yuki.okushi@huawei.com> 1623879342 +0900\ncommitter Yuki Okushi <yuki.okushi@huawei.com> 1631852008 +0900\n\nMake diagnostics clearer for `?` operators\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/378300a63d1951e2718a6b0a077439fc1b14742b", "html_url": "https://github.com/rust-lang/rust/commit/378300a63d1951e2718a6b0a077439fc1b14742b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/378300a63d1951e2718a6b0a077439fc1b14742b/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "78a46efff06558674b51c10d8d81758285746ab5", "url": "https://api.github.com/repos/rust-lang/rust/commits/78a46efff06558674b51c10d8d81758285746ab5", "html_url": "https://github.com/rust-lang/rust/commit/78a46efff06558674b51c10d8d81758285746ab5"}], "stats": {"total": 58, "additions": 53, "deletions": 5}, "files": [{"sha": "41a73268f467345df99ff6b6e57fb967fd2aada6", "filename": "compiler/rustc_errors/src/diagnostic.rs", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/378300a63d1951e2718a6b0a077439fc1b14742b/compiler%2Frustc_errors%2Fsrc%2Fdiagnostic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/378300a63d1951e2718a6b0a077439fc1b14742b/compiler%2Frustc_errors%2Fsrc%2Fdiagnostic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_errors%2Fsrc%2Fdiagnostic.rs?ref=378300a63d1951e2718a6b0a077439fc1b14742b", "patch": "@@ -74,6 +74,10 @@ impl DiagnosticStyledString {\n     pub fn highlighted<S: Into<String>>(t: S) -> DiagnosticStyledString {\n         DiagnosticStyledString(vec![StringPart::Highlighted(t.into())])\n     }\n+\n+    pub fn content(&self) -> String {\n+        self.0.iter().map(|x| x.content()).collect::<String>()\n+    }\n }\n \n #[derive(Debug, PartialEq, Eq)]\n@@ -82,6 +86,14 @@ pub enum StringPart {\n     Highlighted(String),\n }\n \n+impl StringPart {\n+    pub fn content(&self) -> &str {\n+        match self {\n+            &StringPart::Normal(ref s) | &StringPart::Highlighted(ref s) => s,\n+        }\n+    }\n+}\n+\n impl Diagnostic {\n     pub fn new(level: Level, message: &str) -> Self {\n         Diagnostic::new_with_code(level, None, message)"}, {"sha": "b8089b2499b66524bef2f6ef2da45291c4e6af9c", "filename": "compiler/rustc_infer/src/infer/error_reporting/mod.rs", "status": "modified", "additions": 16, "deletions": 3, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/378300a63d1951e2718a6b0a077439fc1b14742b/compiler%2Frustc_infer%2Fsrc%2Finfer%2Ferror_reporting%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/378300a63d1951e2718a6b0a077439fc1b14742b/compiler%2Frustc_infer%2Fsrc%2Finfer%2Ferror_reporting%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_infer%2Fsrc%2Finfer%2Ferror_reporting%2Fmod.rs?ref=378300a63d1951e2718a6b0a077439fc1b14742b", "patch": "@@ -1971,6 +1971,8 @@ impl<'a, 'tcx> InferCtxt<'a, 'tcx> {\n         trace: TypeTrace<'tcx>,\n         terr: &TypeError<'tcx>,\n     ) -> DiagnosticBuilder<'tcx> {\n+        use crate::traits::ObligationCauseCode::MatchExpressionArm;\n+\n         debug!(\"report_and_explain_type_error(trace={:?}, terr={:?})\", trace, terr);\n \n         let span = trace.cause.span(self.tcx);\n@@ -2013,6 +2015,19 @@ impl<'a, 'tcx> InferCtxt<'a, 'tcx> {\n                         _ => {}\n                     }\n                 }\n+                if let MatchExpressionArm(box MatchExpressionArmCause { source, .. }) =\n+                    trace.cause.code\n+                {\n+                    if let hir::MatchSource::TryDesugar = source {\n+                        if let Some((expected_ty, found_ty)) = self.values_str(trace.values) {\n+                            err.note(&format!(\n+                                \"`?` operator cannot convert from `{}` to `{}`\",\n+                                found_ty.content(),\n+                                expected_ty.content(),\n+                            ));\n+                        }\n+                    }\n+                }\n                 err\n             }\n             FailureCode::Error0644(failure_str) => {\n@@ -2585,9 +2600,7 @@ impl<'tcx> ObligationCauseExt<'tcx> for ObligationCause<'tcx> {\n             CompareImplTypeObligation { .. } => Error0308(\"type not compatible with trait\"),\n             MatchExpressionArm(box MatchExpressionArmCause { source, .. }) => {\n                 Error0308(match source {\n-                    hir::MatchSource::TryDesugar => {\n-                        \"try expression alternatives have incompatible types\"\n-                    }\n+                    hir::MatchSource::TryDesugar => \"`?` operator has incompatible types\",\n                     _ => \"`match` arms have incompatible types\",\n                 })\n             }"}, {"sha": "c31107d8fed0525e45d6e81445a0528a9f290692", "filename": "src/test/ui/inference/issue-71309.rs", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/378300a63d1951e2718a6b0a077439fc1b14742b/src%2Ftest%2Fui%2Finference%2Fissue-71309.rs", "raw_url": "https://github.com/rust-lang/rust/raw/378300a63d1951e2718a6b0a077439fc1b14742b/src%2Ftest%2Fui%2Finference%2Fissue-71309.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Finference%2Fissue-71309.rs?ref=378300a63d1951e2718a6b0a077439fc1b14742b", "patch": "@@ -0,0 +1,7 @@\n+fn foo(x: Result<i32, ()>) -> Result<(), ()> {\n+    let y: u32 = x?;\n+    //~^ ERROR: `?` operator has incompatible types\n+    Ok(())\n+}\n+\n+fn main() {}"}, {"sha": "af8714f1c808303ac02d10194a669c3fd3851f62", "filename": "src/test/ui/inference/issue-71309.stderr", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/378300a63d1951e2718a6b0a077439fc1b14742b/src%2Ftest%2Fui%2Finference%2Fissue-71309.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/378300a63d1951e2718a6b0a077439fc1b14742b/src%2Ftest%2Fui%2Finference%2Fissue-71309.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Finference%2Fissue-71309.stderr?ref=378300a63d1951e2718a6b0a077439fc1b14742b", "patch": "@@ -0,0 +1,15 @@\n+error[E0308]: `?` operator has incompatible types\n+  --> $DIR/issue-71309.rs:2:18\n+   |\n+LL |     let y: u32 = x?;\n+   |                  ^^ expected `u32`, found `i32`\n+   |\n+   = note: `?` operator cannot convert from `i32` to `u32`\n+help: you can convert an `i32` to a `u32` and panic if the converted value doesn't fit\n+   |\n+LL |     let y: u32 = x?.try_into().unwrap();\n+   |                    ++++++++++++++++++++\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0308`."}, {"sha": "35402dff675534f769bfe47a343d58b254ce7fb1", "filename": "src/test/ui/issues/issue-51632-try-desugar-incompatible-types.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/378300a63d1951e2718a6b0a077439fc1b14742b/src%2Ftest%2Fui%2Fissues%2Fissue-51632-try-desugar-incompatible-types.rs", "raw_url": "https://github.com/rust-lang/rust/raw/378300a63d1951e2718a6b0a077439fc1b14742b/src%2Ftest%2Fui%2Fissues%2Fissue-51632-try-desugar-incompatible-types.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-51632-try-desugar-incompatible-types.rs?ref=378300a63d1951e2718a6b0a077439fc1b14742b", "patch": "@@ -6,7 +6,7 @@ fn missing_discourses() -> Result<isize, ()> {\n \n fn forbidden_narratives() -> Result<isize, ()> {\n     missing_discourses()?\n-    //~^ ERROR try expression alternatives have incompatible types\n+    //~^ ERROR: `?` operator has incompatible types\n }\n \n fn main() {}"}, {"sha": "0f61e03c3b58fb522d4d34d44407b74703719a54", "filename": "src/test/ui/issues/issue-51632-try-desugar-incompatible-types.stderr", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/378300a63d1951e2718a6b0a077439fc1b14742b/src%2Ftest%2Fui%2Fissues%2Fissue-51632-try-desugar-incompatible-types.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/378300a63d1951e2718a6b0a077439fc1b14742b/src%2Ftest%2Fui%2Fissues%2Fissue-51632-try-desugar-incompatible-types.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-51632-try-desugar-incompatible-types.stderr?ref=378300a63d1951e2718a6b0a077439fc1b14742b", "patch": "@@ -1,9 +1,10 @@\n-error[E0308]: try expression alternatives have incompatible types\n+error[E0308]: `?` operator has incompatible types\n   --> $DIR/issue-51632-try-desugar-incompatible-types.rs:8:5\n    |\n LL |     missing_discourses()?\n    |     ^^^^^^^^^^^^^^^^^^^^^ expected enum `Result`, found `isize`\n    |\n+   = note: `?` operator cannot convert from `isize` to `Result<isize, ()>`\n    = note: expected enum `Result<isize, ()>`\n               found type `isize`\n help: try removing this `?`"}]}