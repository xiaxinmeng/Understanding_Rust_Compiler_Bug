{"sha": "45a7012fd969ad97fcbcdd4af2530875e37663b7", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQ1YTcwMTJmZDk2OWFkOTdmY2JjZGQ0YWYyNTMwODc1ZTM3NjYzYjc=", "commit": {"author": {"name": "Owen Sanchez", "email": "pengowen816@gmail.com", "date": "2017-02-06T19:25:38Z"}, "committer": {"name": "Owen Sanchez", "email": "pengowen816@gmail.com", "date": "2017-02-11T01:12:32Z"}, "message": "Search directly for the largest and smallest variants instead of sorting", "tree": {"sha": "fb0216177dcdf19ce2411353919dfea606285531", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fb0216177dcdf19ce2411353919dfea606285531"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/45a7012fd969ad97fcbcdd4af2530875e37663b7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/45a7012fd969ad97fcbcdd4af2530875e37663b7", "html_url": "https://github.com/rust-lang/rust/commit/45a7012fd969ad97fcbcdd4af2530875e37663b7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/45a7012fd969ad97fcbcdd4af2530875e37663b7/comments", "author": {"login": "pengowen123", "id": 12902948, "node_id": "MDQ6VXNlcjEyOTAyOTQ4", "avatar_url": "https://avatars.githubusercontent.com/u/12902948?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pengowen123", "html_url": "https://github.com/pengowen123", "followers_url": "https://api.github.com/users/pengowen123/followers", "following_url": "https://api.github.com/users/pengowen123/following{/other_user}", "gists_url": "https://api.github.com/users/pengowen123/gists{/gist_id}", "starred_url": "https://api.github.com/users/pengowen123/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pengowen123/subscriptions", "organizations_url": "https://api.github.com/users/pengowen123/orgs", "repos_url": "https://api.github.com/users/pengowen123/repos", "events_url": "https://api.github.com/users/pengowen123/events{/privacy}", "received_events_url": "https://api.github.com/users/pengowen123/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pengowen123", "id": 12902948, "node_id": "MDQ6VXNlcjEyOTAyOTQ4", "avatar_url": "https://avatars.githubusercontent.com/u/12902948?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pengowen123", "html_url": "https://github.com/pengowen123", "followers_url": "https://api.github.com/users/pengowen123/followers", "following_url": "https://api.github.com/users/pengowen123/following{/other_user}", "gists_url": "https://api.github.com/users/pengowen123/gists{/gist_id}", "starred_url": "https://api.github.com/users/pengowen123/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pengowen123/subscriptions", "organizations_url": "https://api.github.com/users/pengowen123/orgs", "repos_url": "https://api.github.com/users/pengowen123/repos", "events_url": "https://api.github.com/users/pengowen123/events{/privacy}", "received_events_url": "https://api.github.com/users/pengowen123/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "96ae7da9b60e05bf16c376be73facd444f99446e", "url": "https://api.github.com/repos/rust-lang/rust/commits/96ae7da9b60e05bf16c376be73facd444f99446e", "html_url": "https://github.com/rust-lang/rust/commit/96ae7da9b60e05bf16c376be73facd444f99446e"}], "stats": {"total": 29, "additions": 17, "deletions": 12}, "files": [{"sha": "050362dede04ba3e2471c0b086ecb8f19c962e29", "filename": "clippy_lints/src/large_enum_variant.rs", "status": "modified", "additions": 17, "deletions": 12, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/45a7012fd969ad97fcbcdd4af2530875e37663b7/clippy_lints%2Fsrc%2Flarge_enum_variant.rs", "raw_url": "https://github.com/rust-lang/rust/raw/45a7012fd969ad97fcbcdd4af2530875e37663b7/clippy_lints%2Fsrc%2Flarge_enum_variant.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flarge_enum_variant.rs?ref=45a7012fd969ad97fcbcdd4af2530875e37663b7", "patch": "@@ -51,10 +51,10 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for LargeEnumVariant {\n             let ty = cx.tcx.item_type(did);\n             let adt = ty.ty_adt_def().expect(\"already checked whether this is an enum\");\n \n-            let mut sizes = Vec::new();\n-            let mut variants = Vec::new();\n+            let mut smallest_variant: Option<(_, _)> = None;\n+            let mut largest_variant: Option<(_, _)> = None;\n \n-            for variant in &adt.variants {\n+            for (i, variant) in adt.variants.iter().enumerate() {\n                 let data_layout = TargetDataLayout::parse(cx.sess());\n                 cx.tcx.infer_ctxt((), Reveal::All).enter(|infcx| {\n                     let size: u64 = variant.fields\n@@ -72,18 +72,13 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for LargeEnumVariant {\n                         })\n                         .sum();\n \n-                    sizes.push(size);\n-                    variants.push(variant);\n+                    let grouped = (size, (i, variant));\n+\n+                    update_if(&mut smallest_variant, grouped, |a, b| b.0 <= a.0);\n+                    update_if(&mut largest_variant, grouped, |a, b| b.0 >= a.0);\n                 });\n             }\n \n-            let mut grouped = sizes.into_iter().zip(variants.into_iter().enumerate()).collect::<Vec<_>>();\n-\n-            grouped.sort_by_key(|g| g.0);\n-\n-            let smallest_variant = grouped.first();\n-            let largest_variant = grouped.last();\n-\n             if let (Some(smallest), Some(largest)) = (smallest_variant, largest_variant) {\n                 let difference = largest.0 - smallest.0;\n \n@@ -118,3 +113,13 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for LargeEnumVariant {\n         }\n     }\n }\n+\n+fn update_if<T, F>(old: &mut Option<T>, new: T, f: F) where F: Fn(&T, &T) -> bool {\n+    if let Some(ref mut val) = *old {\n+        if f(val, &new) {\n+            *val = new;\n+        }\n+    } else {\n+        *old = Some(new);\n+    }\n+}"}]}