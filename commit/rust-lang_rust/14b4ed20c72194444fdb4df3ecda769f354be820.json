{"sha": "14b4ed20c72194444fdb4df3ecda769f354be820", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE0YjRlZDIwYzcyMTk0NDQ0ZmRiNGRmM2VjZGE3NjlmMzU0YmU4MjA=", "commit": {"author": {"name": "Dylan DPC", "email": "dylan.dpc@gmail.com", "date": "2020-10-28T00:21:34Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-10-28T00:21:34Z"}, "message": "Rollup merge of #78408 - Aaron1011:fix/remove-foreign-tokens, r=oli-obk\n\nRemove tokens from foreign items in `TokenStripper`\n\nFixes #78398\n\nI forgot to handle this case in #77255", "tree": {"sha": "deea2381ba0a6c794ac921d0c0f2dd52c59e5c0c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/deea2381ba0a6c794ac921d0c0f2dd52c59e5c0c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/14b4ed20c72194444fdb4df3ecda769f354be820", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfmLmPCRBK7hj4Ov3rIwAAdHIIADDjkjYi3PmpPh7t155MWlFW\nylf7BrUtsTQmDWRnKCyGzmBmpDsy+Y18OXwMBMKVm5Ue2mjsmpHqeQzq4p005xXh\nJnS8oK8cV8SJs8DJtR7VAP0B1CXkBJJFhVJXAmX+3pP+xZ/eayL3Id0GTqeL2bcG\njBRiCiBvNw6YCze4TvyFWJp4/4DT6CY4gl2alClMbhDH0tvc+imN+bNDi+Rs4jlS\nAt0hPYFJQ9nftesMdA4uYIM3VknmEsRNbkSh7eoQlF+yqxI8jRK3vcL1fdQUvbd+\ncZsUp/FOcH7CJfOg/O/TOEV6Uv775aFEsrLsVchTqDHB0Siq4KqsVdCGHf2iwPk=\n=DWWG\n-----END PGP SIGNATURE-----\n", "payload": "tree deea2381ba0a6c794ac921d0c0f2dd52c59e5c0c\nparent c9279c845d58db9b78e41d07de8436ab22839679\nparent 174ed0c23ddbc04a82ad4e71856252c73d88fe5a\nauthor Dylan DPC <dylan.dpc@gmail.com> 1603844494 +0100\ncommitter GitHub <noreply@github.com> 1603844494 +0100\n\nRollup merge of #78408 - Aaron1011:fix/remove-foreign-tokens, r=oli-obk\n\nRemove tokens from foreign items in `TokenStripper`\n\nFixes #78398\n\nI forgot to handle this case in #77255\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/14b4ed20c72194444fdb4df3ecda769f354be820", "html_url": "https://github.com/rust-lang/rust/commit/14b4ed20c72194444fdb4df3ecda769f354be820", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/14b4ed20c72194444fdb4df3ecda769f354be820/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c9279c845d58db9b78e41d07de8436ab22839679", "url": "https://api.github.com/repos/rust-lang/rust/commits/c9279c845d58db9b78e41d07de8436ab22839679", "html_url": "https://github.com/rust-lang/rust/commit/c9279c845d58db9b78e41d07de8436ab22839679"}, {"sha": "174ed0c23ddbc04a82ad4e71856252c73d88fe5a", "url": "https://api.github.com/repos/rust-lang/rust/commits/174ed0c23ddbc04a82ad4e71856252c73d88fe5a", "html_url": "https://github.com/rust-lang/rust/commit/174ed0c23ddbc04a82ad4e71856252c73d88fe5a"}], "stats": {"total": 26, "additions": 26, "deletions": 0}, "files": [{"sha": "9dbd59506b1883cdbf28066a96bb020eccfd10b0", "filename": "compiler/rustc_interface/src/passes.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/14b4ed20c72194444fdb4df3ecda769f354be820/compiler%2Frustc_interface%2Fsrc%2Fpasses.rs", "raw_url": "https://github.com/rust-lang/rust/raw/14b4ed20c72194444fdb4df3ecda769f354be820/compiler%2Frustc_interface%2Fsrc%2Fpasses.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_interface%2Fsrc%2Fpasses.rs?ref=14b4ed20c72194444fdb4df3ecda769f354be820", "patch": "@@ -63,6 +63,13 @@ impl mut_visit::MutVisitor for TokenStripper {\n         i.tokens = None;\n         mut_visit::noop_flat_map_item(i, self)\n     }\n+    fn flat_map_foreign_item(\n+        &mut self,\n+        mut i: P<ast::ForeignItem>,\n+    ) -> SmallVec<[P<ast::ForeignItem>; 1]> {\n+        i.tokens = None;\n+        mut_visit::noop_flat_map_foreign_item(i, self)\n+    }\n     fn visit_block(&mut self, b: &mut P<ast::Block>) {\n         b.tokens = None;\n         mut_visit::noop_visit_block(b, self);"}, {"sha": "a1a20f9568178f968799ebfc0c2936bf0f6b86fb", "filename": "src/test/ui/ast-json/issue-78398-foreign-ice.rs", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/14b4ed20c72194444fdb4df3ecda769f354be820/src%2Ftest%2Fui%2Fast-json%2Fissue-78398-foreign-ice.rs", "raw_url": "https://github.com/rust-lang/rust/raw/14b4ed20c72194444fdb4df3ecda769f354be820/src%2Ftest%2Fui%2Fast-json%2Fissue-78398-foreign-ice.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fast-json%2Fissue-78398-foreign-ice.rs?ref=14b4ed20c72194444fdb4df3ecda769f354be820", "patch": "@@ -0,0 +1,18 @@\n+// Regression test for issue #78398\n+// Tests that we don't ICE when trying to print the AST json\n+// when we have capturd tokens for a foreign item\n+\n+// check-pass\n+// compile-flags: -Zast-json\n+\n+fn main() {}\n+\n+macro_rules! mac_extern {\n+    ($i:item) => {\n+        extern \"C\" { $i }\n+    }\n+}\n+\n+mac_extern! {\n+    fn foo();\n+}"}, {"sha": "f1d0e44e9fc8c784254510e2ad3c72924a4f29b3", "filename": "src/test/ui/ast-json/issue-78398-foreign-ice.stdout", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/14b4ed20c72194444fdb4df3ecda769f354be820/src%2Ftest%2Fui%2Fast-json%2Fissue-78398-foreign-ice.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/14b4ed20c72194444fdb4df3ecda769f354be820/src%2Ftest%2Fui%2Fast-json%2Fissue-78398-foreign-ice.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fast-json%2Fissue-78398-foreign-ice.stdout?ref=14b4ed20c72194444fdb4df3ecda769f354be820", "patch": "@@ -0,0 +1 @@\n+{\"module\":{\"inner\":{\"lo\":192,\"hi\":315},\"unsafety\":\"No\",\"items\":[{\"attrs\":[{\"kind\":{\"variant\":\"Normal\",\"fields\":[{\"path\":{\"span\":{\"lo\":0,\"hi\":0},\"segments\":[{\"ident\":{\"name\":\"prelude_import\",\"span\":{\"lo\":0,\"hi\":0}},\"id\":3,\"args\":null}],\"tokens\":null},\"args\":\"Empty\",\"tokens\":null}]},\"id\":null,\"style\":\"Outer\",\"span\":{\"lo\":0,\"hi\":0},\"tokens\":null}],\"id\":4,\"span\":{\"lo\":0,\"hi\":0},\"vis\":{\"kind\":\"Inherited\",\"span\":{\"lo\":0,\"hi\":0},\"tokens\":null},\"ident\":{\"name\":\"\",\"span\":{\"lo\":0,\"hi\":0}},\"kind\":{\"variant\":\"Use\",\"fields\":[{\"prefix\":{\"span\":{\"lo\":0,\"hi\":0},\"segments\":[{\"ident\":{\"name\":\"{{root}}\",\"span\":{\"lo\":0,\"hi\":0}},\"id\":5,\"args\":null},{\"ident\":{\"name\":\"std\",\"span\":{\"lo\":0,\"hi\":0}},\"id\":6,\"args\":null},{\"ident\":{\"name\":\"prelude\",\"span\":{\"lo\":0,\"hi\":0}},\"id\":7,\"args\":null},{\"ident\":{\"name\":\"v1\",\"span\":{\"lo\":0,\"hi\":0}},\"id\":8,\"args\":null}],\"tokens\":null},\"kind\":\"Glob\",\"span\":{\"lo\":0,\"hi\":0}}]},\"tokens\":null},{\"attrs\":[{\"kind\":{\"variant\":\"Normal\",\"fields\":[{\"path\":{\"span\":{\"lo\":0,\"hi\":0},\"segments\":[{\"ident\":{\"name\":\"macro_use\",\"span\":{\"lo\":0,\"hi\":0}},\"id\":9,\"args\":null}],\"tokens\":null},\"args\":\"Empty\",\"tokens\":null}]},\"id\":null,\"style\":\"Outer\",\"span\":{\"lo\":0,\"hi\":0},\"tokens\":null}],\"id\":10,\"span\":{\"lo\":0,\"hi\":0},\"vis\":{\"kind\":\"Inherited\",\"span\":{\"lo\":0,\"hi\":0},\"tokens\":null},\"ident\":{\"name\":\"std\",\"span\":{\"lo\":0,\"hi\":0}},\"kind\":{\"variant\":\"ExternCrate\",\"fields\":[null]},\"tokens\":null},{\"attrs\":[],\"id\":11,\"span\":{\"lo\":192,\"hi\":204},\"vis\":{\"kind\":\"Inherited\",\"span\":{\"lo\":192,\"hi\":192},\"tokens\":null},\"ident\":{\"name\":\"main\",\"span\":{\"lo\":195,\"hi\":199}},\"kind\":{\"variant\":\"Fn\",\"fields\":[\"Final\",{\"header\":{\"unsafety\":\"No\",\"asyncness\":\"No\",\"constness\":\"No\",\"ext\":\"None\"},\"decl\":{\"inputs\":[],\"output\":{\"variant\":\"Default\",\"fields\":[{\"lo\":202,\"hi\":202}]}},\"span\":{\"lo\":192,\"hi\":201}},{\"params\":[],\"where_clause\":{\"has_where_token\":false,\"predicates\":[],\"span\":{\"lo\":201,\"hi\":201}},\"span\":{\"lo\":199,\"hi\":199}},{\"stmts\":[],\"id\":12,\"rules\":\"Default\",\"span\":{\"lo\":202,\"hi\":204},\"tokens\":null}]},\"tokens\":null},{\"attrs\":[],\"id\":13,\"span\":{\"lo\":206,\"hi\":284},\"vis\":{\"kind\":\"Inherited\",\"span\":{\"lo\":206,\"hi\":206},\"tokens\":null},\"ident\":{\"name\":\"mac_extern\",\"span\":{\"lo\":219,\"hi\":229}},\"kind\":{\"variant\":\"MacroDef\",\"fields\":[{\"body\":{\"variant\":\"Delimited\",\"fields\":[{\"open\":{\"lo\":230,\"hi\":231},\"close\":{\"lo\":283,\"hi\":284}},\"Brace\",{\"0\":[[{\"variant\":\"Delimited\",\"fields\":[{\"open\":{\"lo\":236,\"hi\":237},\"close\":{\"lo\":244,\"hi\":245}},\"Paren\",{\"0\":[[{\"variant\":\"Token\",\"fields\":[{\"kind\":\"Dollar\",\"span\":{\"lo\":237,\"hi\":238}}]},\"Alone\"],[{\"variant\":\"Token\",\"fields\":[{\"kind\":{\"variant\":\"Ident\",\"fields\":[\"i\",false]},\"span\":{\"lo\":238,\"hi\":239}}]},\"Joint\"],[{\"variant\":\"Token\",\"fields\":[{\"kind\":\"Colon\",\"span\":{\"lo\":239,\"hi\":240}}]},\"Alone\"],[{\"variant\":\"Token\",\"fields\":[{\"kind\":{\"variant\":\"Ident\",\"fields\":[\"item\",false]},\"span\":{\"lo\":240,\"hi\":244}}]},\"Alone\"]]}]},\"Alone\"],[{\"variant\":\"Token\",\"fields\":[{\"kind\":\"FatArrow\",\"span\":{\"lo\":246,\"hi\":248}}]},\"Alone\"],[{\"variant\":\"Delimited\",\"fields\":[{\"open\":{\"lo\":249,\"hi\":250},\"close\":{\"lo\":281,\"hi\":282}},\"Brace\",{\"0\":[[{\"variant\":\"Token\",\"fields\":[{\"kind\":{\"variant\":\"Ident\",\"fields\":[\"extern\",false]},\"span\":{\"lo\":259,\"hi\":265}}]},\"Alone\"],[{\"variant\":\"Token\",\"fields\":[{\"kind\":{\"variant\":\"Literal\",\"fields\":[{\"kind\":\"Str\",\"symbol\":\"C\",\"suffix\":null}]},\"span\":{\"lo\":266,\"hi\":269}}]},\"Alone\"],[{\"variant\":\"Delimited\",\"fields\":[{\"open\":{\"lo\":270,\"hi\":271},\"close\":{\"lo\":275,\"hi\":276}},\"Brace\",{\"0\":[[{\"variant\":\"Token\",\"fields\":[{\"kind\":\"Dollar\",\"span\":{\"lo\":272,\"hi\":273}}]},\"Alone\"],[{\"variant\":\"Token\",\"fields\":[{\"kind\":{\"variant\":\"Ident\",\"fields\":[\"i\",false]},\"span\":{\"lo\":273,\"hi\":274}}]},\"Alone\"]]}]},\"Alone\"]]}]},\"Alone\"]]}]},\"macro_rules\":true}]},\"tokens\":null},{\"attrs\":[],\"id\":14,\"span\":{\"lo\":259,\"hi\":276},\"vis\":{\"kind\":\"Inherited\",\"span\":{\"lo\":259,\"hi\":259},\"tokens\":null},\"ident\":{\"name\":\"\",\"span\":{\"lo\":0,\"hi\":0}},\"kind\":{\"variant\":\"ForeignMod\",\"fields\":[{\"unsafety\":\"No\",\"abi\":{\"style\":\"Cooked\",\"symbol\":\"C\",\"suffix\":null,\"span\":{\"lo\":266,\"hi\":269},\"symbol_unescaped\":\"C\"},\"items\":[{\"attrs\":[],\"id\":15,\"span\":{\"lo\":304,\"hi\":313},\"vis\":{\"kind\":\"Inherited\",\"span\":{\"lo\":304,\"hi\":304},\"tokens\":null},\"ident\":{\"name\":\"foo\",\"span\":{\"lo\":307,\"hi\":310}},\"kind\":{\"variant\":\"Fn\",\"fields\":[\"Final\",{\"header\":{\"unsafety\":\"No\",\"asyncness\":\"No\",\"constness\":\"No\",\"ext\":\"None\"},\"decl\":{\"inputs\":[],\"output\":{\"variant\":\"Default\",\"fields\":[{\"lo\":312,\"hi\":312}]}},\"span\":{\"lo\":304,\"hi\":313}},{\"params\":[],\"where_clause\":{\"has_where_token\":false,\"predicates\":[],\"span\":{\"lo\":312,\"hi\":312}},\"span\":{\"lo\":310,\"hi\":310}},null]},\"tokens\":null}]}]},\"tokens\":null}],\"inline\":true},\"attrs\":[],\"span\":{\"lo\":192,\"hi\":315},\"proc_macros\":[]}"}]}