{"sha": "43406d26812bc41a19f6412350dcfe6574556b48", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQzNDA2ZDI2ODEyYmM0MWExOWY2NDEyMzUwZGNmZTY1NzQ1NTZiNDg=", "commit": {"author": {"name": "Felix S. Klock II", "email": "pnkfelix@pnkfx.org", "date": "2017-12-13T01:05:12Z"}, "committer": {"name": "Felix S. Klock II", "email": "pnkfelix@pnkfx.org", "date": "2017-12-13T01:06:19Z"}, "message": "Fix #46112: visible_parent_map construction needs a BFS over whole crate forest.", "tree": {"sha": "a01d8e352d14a8d74b0bafeae6dac543123dc151", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a01d8e352d14a8d74b0bafeae6dac543123dc151"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/43406d26812bc41a19f6412350dcfe6574556b48", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/43406d26812bc41a19f6412350dcfe6574556b48", "html_url": "https://github.com/rust-lang/rust/commit/43406d26812bc41a19f6412350dcfe6574556b48", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/43406d26812bc41a19f6412350dcfe6574556b48/comments", "author": {"login": "pnkfelix", "id": 173127, "node_id": "MDQ6VXNlcjE3MzEyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pnkfelix", "html_url": "https://github.com/pnkfelix", "followers_url": "https://api.github.com/users/pnkfelix/followers", "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}", "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}", "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions", "organizations_url": "https://api.github.com/users/pnkfelix/orgs", "repos_url": "https://api.github.com/users/pnkfelix/repos", "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}", "received_events_url": "https://api.github.com/users/pnkfelix/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pnkfelix", "id": 173127, "node_id": "MDQ6VXNlcjE3MzEyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pnkfelix", "html_url": "https://github.com/pnkfelix", "followers_url": "https://api.github.com/users/pnkfelix/followers", "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}", "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}", "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions", "organizations_url": "https://api.github.com/users/pnkfelix/orgs", "repos_url": "https://api.github.com/users/pnkfelix/repos", "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}", "received_events_url": "https://api.github.com/users/pnkfelix/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6a360194404c07e09b548626efa4b7c7777510e9", "url": "https://api.github.com/repos/rust-lang/rust/commits/6a360194404c07e09b548626efa4b7c7777510e9", "html_url": "https://github.com/rust-lang/rust/commit/6a360194404c07e09b548626efa4b7c7777510e9"}], "stats": {"total": 24, "additions": 19, "deletions": 5}, "files": [{"sha": "4206f4b7897d325a920d765325980640ad34312f", "filename": "src/librustc_metadata/cstore_impl.rs", "status": "modified", "additions": 19, "deletions": 5, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/43406d26812bc41a19f6412350dcfe6574556b48/src%2Flibrustc_metadata%2Fcstore_impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/43406d26812bc41a19f6412350dcfe6574556b48/src%2Flibrustc_metadata%2Fcstore_impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Fcstore_impl.rs?ref=43406d26812bc41a19f6412350dcfe6574556b48", "patch": "@@ -294,13 +294,31 @@ pub fn provide<'tcx>(providers: &mut Providers<'tcx>) {\n             assert_eq!(cnum, LOCAL_CRATE);\n             let mut visible_parent_map: DefIdMap<DefId> = DefIdMap();\n \n+            // Issue 46112: We want the map to prefer the shortest\n+            // paths when reporting the path to an item. Therefore we\n+            // build up the map via a breadth-first search (BFS),\n+            // which naturally yields minimal-length paths.\n+            //\n+            // Note that it needs to be a BFS over the whole forest of\n+            // crates, not just each individual crate; otherwise you\n+            // only get paths that are locally minimal with respect to\n+            // whatever crate we happened to encounter first in this\n+            // traversal, but not globally minimal across all crates.\n+            let bfs_queue = &mut VecDeque::new();\n             for &cnum in tcx.crates().iter() {\n                 // Ignore crates without a corresponding local `extern crate` item.\n                 if tcx.missing_extern_crate_item(cnum) {\n                     continue\n                 }\n \n-                let bfs_queue = &mut VecDeque::new();\n+                bfs_queue.push_back(DefId {\n+                    krate: cnum,\n+                    index: CRATE_DEF_INDEX\n+                });\n+            }\n+\n+            // (restrict scope of mutable-borrow of `visible_parent_map`)\n+            {\n                 let visible_parent_map = &mut visible_parent_map;\n                 let mut add_child = |bfs_queue: &mut VecDeque<_>,\n                                      child: &def::Export,\n@@ -326,10 +344,6 @@ pub fn provide<'tcx>(providers: &mut Providers<'tcx>) {\n                     }\n                 };\n \n-                bfs_queue.push_back(DefId {\n-                    krate: cnum,\n-                    index: CRATE_DEF_INDEX\n-                });\n                 while let Some(def) = bfs_queue.pop_front() {\n                     for child in tcx.item_children(def).iter() {\n                         add_child(bfs_queue, child, def);"}]}