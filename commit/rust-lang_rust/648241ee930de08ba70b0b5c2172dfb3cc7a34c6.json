{"sha": "648241ee930de08ba70b0b5c2172dfb3cc7a34c6", "node_id": "MDY6Q29tbWl0NzI0NzEyOjY0ODI0MWVlOTMwZGUwOGJhNzBiMGI1YzIxNzJkZmIzY2M3YTM0YzY=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-01-19T17:51:06Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-01-19T17:51:06Z"}, "message": "Merge #2878\n\n2878: Fix a corner case when printing unaccounted time r=matklad a=michalt\n\nPreviously `ra_prof` wouldn't actually print the unaccounted time in\r\nsome cases.\r\n\r\nWe would print, for instance, this:\r\n```\r\n    5ms - foo\r\n        2ms - bar\r\n```\r\ninstead of:\r\n```\r\n    5ms - foo\r\n        2ms - bar\r\n        3ms - ???\r\n```\r\n\r\nThe fix is to properly handle the case when an entry has 0 children\r\ninstead of using the `last` variable.\r\n\r\nSigned-off-by: Michal Terepeta <michal.terepeta@gmail.com>\n\nCo-authored-by: Michal Terepeta <michal.terepeta@gmail.com>", "tree": {"sha": "c88da3a3b0aa95f16c5a82c7c43f75c72792ab78", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c88da3a3b0aa95f16c5a82c7c43f75c72792ab78"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/648241ee930de08ba70b0b5c2172dfb3cc7a34c6", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJeJJcKCRBK7hj4Ov3rIwAAdHIIAEkOEHIwiu9QoJWE0W3oiqUZ\n9tc9kxafcZAcpCIkjzOhDI3pTEmmrK8i12MxRVHo4S9Je7Ss7SQNcMdmGAJCp5BK\npvo9bEc0pEUdXWIBknExNgQsCJwewd+6ciypPOLd3LNsgCVXVidnQhev+KnKICaw\nYGnDt0fgtEq6lK/zYUsOydpyr+y+J8UNZ4XeJdWgoBzKHfLfTmoHU9eTG2EXchUM\niCkiHbBT8zsHxoLAzzCtNbesqTPVuJDbAjsCLj7SdL54YYs2GntEgqoQYvJVmqxL\njCQJe55Yc1i1lMCGByFJWUIDYzzpA0bxLKcD7hJSP/wzhLnOzGq+1vyT4Q08kn8=\n=j2p8\n-----END PGP SIGNATURE-----\n", "payload": "tree c88da3a3b0aa95f16c5a82c7c43f75c72792ab78\nparent 3a7724e44181ccd5c248589538bd82458b5a9407\nparent e8acf49088f90d8d4439c4034696bc4e5f8b4ed9\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1579456266 +0000\ncommitter GitHub <noreply@github.com> 1579456266 +0000\n\nMerge #2878\n\n2878: Fix a corner case when printing unaccounted time r=matklad a=michalt\n\nPreviously `ra_prof` wouldn't actually print the unaccounted time in\r\nsome cases.\r\n\r\nWe would print, for instance, this:\r\n```\r\n    5ms - foo\r\n        2ms - bar\r\n```\r\ninstead of:\r\n```\r\n    5ms - foo\r\n        2ms - bar\r\n        3ms - ???\r\n```\r\n\r\nThe fix is to properly handle the case when an entry has 0 children\r\ninstead of using the `last` variable.\r\n\r\nSigned-off-by: Michal Terepeta <michal.terepeta@gmail.com>\n\nCo-authored-by: Michal Terepeta <michal.terepeta@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/648241ee930de08ba70b0b5c2172dfb3cc7a34c6", "html_url": "https://github.com/rust-lang/rust/commit/648241ee930de08ba70b0b5c2172dfb3cc7a34c6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/648241ee930de08ba70b0b5c2172dfb3cc7a34c6/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3a7724e44181ccd5c248589538bd82458b5a9407", "url": "https://api.github.com/repos/rust-lang/rust/commits/3a7724e44181ccd5c248589538bd82458b5a9407", "html_url": "https://github.com/rust-lang/rust/commit/3a7724e44181ccd5c248589538bd82458b5a9407"}, {"sha": "e8acf49088f90d8d4439c4034696bc4e5f8b4ed9", "url": "https://api.github.com/repos/rust-lang/rust/commits/e8acf49088f90d8d4439c4034696bc4e5f8b4ed9", "html_url": "https://github.com/rust-lang/rust/commit/e8acf49088f90d8d4439c4034696bc4e5f8b4ed9"}], "stats": {"total": 56, "additions": 52, "deletions": 4}, "files": [{"sha": "da541005a1bb2dc0567d2a35fd320bebbe1a72ba", "filename": "crates/ra_prof/src/lib.rs", "status": "modified", "additions": 52, "deletions": 4, "changes": 56, "blob_url": "https://github.com/rust-lang/rust/blob/648241ee930de08ba70b0b5c2172dfb3cc7a34c6/crates%2Fra_prof%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/648241ee930de08ba70b0b5c2172dfb3cc7a34c6/crates%2Fra_prof%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_prof%2Fsrc%2Flib.rs?ref=648241ee930de08ba70b0b5c2172dfb3cc7a34c6", "patch": "@@ -219,7 +219,11 @@ fn print(\n     longer_than: Duration,\n     total: Option<Duration>,\n ) {\n-    let mut last = 0;\n+    if msgs.is_empty() {\n+        return;\n+    }\n+    // The index of the first element that will be included in the slice when we recurse.\n+    let mut next_start = 0;\n     let indent = repeat(\"    \").take(lvl).collect::<String>();\n     // We output hierarchy for long calls, but sum up all short calls\n     let mut short = Vec::new();\n@@ -233,12 +237,12 @@ fn print(\n             writeln!(out, \"{}{:5}ms - {}\", indent, duration.as_millis(), msg)\n                 .expect(\"printing profiling info to stdout\");\n \n-            print(lvl + 1, &msgs[last..i], out, longer_than, Some(duration));\n+            print(lvl + 1, &msgs[next_start..i], out, longer_than, Some(duration));\n         } else {\n             short.push((msg, duration))\n         }\n \n-        last = i;\n+        next_start = i + 1;\n     }\n     short.sort_by_key(|(msg, _time)| *msg);\n     for (msg, entires) in short.iter().group_by(|(msg, _time)| msg).into_iter() {\n@@ -255,7 +259,7 @@ fn print(\n     if let Some(total) = total {\n         if let Some(unaccounted) = total.checked_sub(accounted_for) {\n             let unaccounted_millis = unaccounted.as_millis();\n-            if unaccounted_millis > longer_than.as_millis() && unaccounted_millis > 0 && last > 0 {\n+            if unaccounted_millis > longer_than.as_millis() && unaccounted_millis > 0 {\n                 writeln!(out, \"{}{:5}ms - ???\", indent, unaccounted_millis)\n                     .expect(\"printing profiling info to stdout\");\n             }\n@@ -377,4 +381,48 @@ mod tests {\n             \"    1ms - foo\\n        0ms - bar (2 calls)\\n\"\n         );\n     }\n+\n+    #[test]\n+    fn test_unaccounted_for_topmost() {\n+        let mut result = vec![];\n+        let msgs = vec![\n+            Message { level: 1, duration: Duration::from_millis(2), message: \"bar\".to_owned() },\n+            Message { level: 0, duration: Duration::from_millis(5), message: \"foo\".to_owned() },\n+        ];\n+        print(0, &msgs, &mut result, Duration::from_millis(0), Some(Duration::from_millis(1)));\n+        assert_eq!(\n+            std::str::from_utf8(&result).unwrap().lines().collect::<Vec<_>>(),\n+            vec![\n+                \"    5ms - foo\",\n+                \"        2ms - bar\",\n+                \"        3ms - ???\",\n+                // Dummy comment to improve formatting\n+            ]\n+        );\n+    }\n+\n+    #[test]\n+    fn test_unaccounted_for_multiple_levels() {\n+        let mut result = vec![];\n+        let msgs = vec![\n+            Message { level: 2, duration: Duration::from_millis(3), message: \"baz\".to_owned() },\n+            Message { level: 1, duration: Duration::from_millis(5), message: \"bar\".to_owned() },\n+            Message { level: 2, duration: Duration::from_millis(2), message: \"baz\".to_owned() },\n+            Message { level: 1, duration: Duration::from_millis(4), message: \"bar\".to_owned() },\n+            Message { level: 0, duration: Duration::from_millis(9), message: \"foo\".to_owned() },\n+        ];\n+        print(0, &msgs, &mut result, Duration::from_millis(0), None);\n+        assert_eq!(\n+            std::str::from_utf8(&result).unwrap().lines().collect::<Vec<_>>(),\n+            vec![\n+                \"    9ms - foo\",\n+                \"        5ms - bar\",\n+                \"            3ms - baz\",\n+                \"            2ms - ???\",\n+                \"        4ms - bar\",\n+                \"            2ms - baz\",\n+                \"            2ms - ???\",\n+            ]\n+        );\n+    }\n }"}]}