{"sha": "558cd1e393188a07bda413931aa88e82996d31c2", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU1OGNkMWUzOTMxODhhMDdiZGE0MTM5MzFhYTg4ZTgyOTk2ZDMxYzI=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-06-02T07:51:20Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-06-02T07:51:20Z"}, "message": "Auto merge of #41670 - scottmcm:slice-rotate, r=alexcrichton\n\nAdd an in-place rotate method for slices to libcore\n\nA helpful primitive for moving chunks of data around inside a slice.\n\nFor example, if you have a range selected and are drag-and-dropping it somewhere else (Example from [Sean Parent's talk](https://youtu.be/qH6sSOr-yk8?t=560)).\n\n(If this should be an RFC instead of a PR, please let me know.)\n\nEdit: changed example", "tree": {"sha": "df39e7df3d1c99a395fe7b1d90751853da09d0c0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/df39e7df3d1c99a395fe7b1d90751853da09d0c0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/558cd1e393188a07bda413931aa88e82996d31c2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/558cd1e393188a07bda413931aa88e82996d31c2", "html_url": "https://github.com/rust-lang/rust/commit/558cd1e393188a07bda413931aa88e82996d31c2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/558cd1e393188a07bda413931aa88e82996d31c2/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "668e698bbaacfeacb712512a58db1bd5e78ee371", "url": "https://api.github.com/repos/rust-lang/rust/commits/668e698bbaacfeacb712512a58db1bd5e78ee371", "html_url": "https://github.com/rust-lang/rust/commit/668e698bbaacfeacb712512a58db1bd5e78ee371"}, {"sha": "094d61f079e5f06930e002da18f92dde5827154f", "url": "https://api.github.com/repos/rust-lang/rust/commits/094d61f079e5f06930e002da18f92dde5827154f", "html_url": "https://github.com/rust-lang/rust/commit/094d61f079e5f06930e002da18f92dde5827154f"}], "stats": {"total": 285, "additions": 285, "deletions": 0}, "files": [{"sha": "2b3ef338fad5860605a9b04b64a9e607e242136b", "filename": "src/doc/unstable-book/src/SUMMARY.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/558cd1e393188a07bda413931aa88e82996d31c2/src%2Fdoc%2Funstable-book%2Fsrc%2FSUMMARY.md", "raw_url": "https://github.com/rust-lang/rust/raw/558cd1e393188a07bda413931aa88e82996d31c2/src%2Fdoc%2Funstable-book%2Fsrc%2FSUMMARY.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Funstable-book%2Fsrc%2FSUMMARY.md?ref=558cd1e393188a07bda413931aa88e82996d31c2", "patch": "@@ -190,6 +190,7 @@\n     - [sip_hash_13](library-features/sip-hash-13.md)\n     - [slice_concat_ext](library-features/slice-concat-ext.md)\n     - [slice_get_slice](library-features/slice-get-slice.md)\n+    - [slice_rotate](library-features/slice-rotate.md)\n     - [slice_rsplit](library-features/slice-rsplit.md)\n     - [sort_internals](library-features/sort-internals.md)\n     - [sort_unstable](library-features/sort-unstable.md)"}, {"sha": "77fd598f1ea922537eed146ec4286a267a1ef1d7", "filename": "src/doc/unstable-book/src/library-features/slice-rotate.md", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/558cd1e393188a07bda413931aa88e82996d31c2/src%2Fdoc%2Funstable-book%2Fsrc%2Flibrary-features%2Fslice-rotate.md", "raw_url": "https://github.com/rust-lang/rust/raw/558cd1e393188a07bda413931aa88e82996d31c2/src%2Fdoc%2Funstable-book%2Fsrc%2Flibrary-features%2Fslice-rotate.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Funstable-book%2Fsrc%2Flibrary-features%2Fslice-rotate.md?ref=558cd1e393188a07bda413931aa88e82996d31c2", "patch": "@@ -0,0 +1,7 @@\n+# `slice_rotate`\n+\n+The tracking issue for this feature is: [#41891]\n+\n+[#41891]: https://github.com/rust-lang/rust/issues/41891\n+\n+------------------------"}, {"sha": "958020d0b0e0c33e3b70b803f187fc204c0f84bb", "filename": "src/libcollections/benches/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/558cd1e393188a07bda413931aa88e82996d31c2/src%2Flibcollections%2Fbenches%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/558cd1e393188a07bda413931aa88e82996d31c2/src%2Flibcollections%2Fbenches%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcollections%2Fbenches%2Flib.rs?ref=558cd1e393188a07bda413931aa88e82996d31c2", "patch": "@@ -13,6 +13,7 @@\n #![feature(i128_type)]\n #![feature(rand)]\n #![feature(repr_simd)]\n+#![feature(slice_rotate)]\n #![feature(sort_unstable)]\n #![feature(test)]\n "}, {"sha": "aa5a438b35e62341e5611755f233b1b12c7c830e", "filename": "src/libcollections/benches/slice.rs", "status": "modified", "additions": 41, "deletions": 0, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/558cd1e393188a07bda413931aa88e82996d31c2/src%2Flibcollections%2Fbenches%2Fslice.rs", "raw_url": "https://github.com/rust-lang/rust/raw/558cd1e393188a07bda413931aa88e82996d31c2/src%2Flibcollections%2Fbenches%2Fslice.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcollections%2Fbenches%2Fslice.rs?ref=558cd1e393188a07bda413931aa88e82996d31c2", "patch": "@@ -195,6 +195,11 @@ fn gen_random(len: usize) -> Vec<u64> {\n     rng.gen_iter::<u64>().take(len).collect()\n }\n \n+fn gen_random_bytes(len: usize) -> Vec<u8> {\n+    let mut rng = thread_rng();\n+    rng.gen_iter::<u8>().take(len).collect()\n+}\n+\n fn gen_mostly_ascending(len: usize) -> Vec<u64> {\n     let mut rng = thread_rng();\n     let mut v = gen_ascending(len);\n@@ -315,3 +320,39 @@ reverse!(reverse_u64, u64, |x| x as u64);\n reverse!(reverse_u128, u128, |x| x as u128);\n #[repr(simd)] struct F64x4(f64, f64, f64, f64);\n reverse!(reverse_simd_f64x4, F64x4, |x| { let x = x as f64; F64x4(x,x,x,x) });\n+\n+macro_rules! rotate {\n+    ($name:ident, $gen:expr, $len:expr, $mid:expr) => {\n+        #[bench]\n+        fn $name(b: &mut Bencher) {\n+            let size = mem::size_of_val(&$gen(1)[0]);\n+            let mut v = $gen($len * 8 / size);\n+            b.iter(|| black_box(&mut v).rotate(($mid*8+size-1)/size));\n+            b.bytes = (v.len() * size) as u64;\n+        }\n+    }\n+}\n+\n+rotate!(rotate_tiny_by1, gen_random, 16, 1);\n+rotate!(rotate_tiny_half, gen_random, 16, 16/2);\n+rotate!(rotate_tiny_half_plus_one, gen_random, 16, 16/2+1);\n+\n+rotate!(rotate_medium_by1, gen_random, 9158, 1);\n+rotate!(rotate_medium_by727_u64, gen_random, 9158, 727);\n+rotate!(rotate_medium_by727_bytes, gen_random_bytes, 9158, 727);\n+rotate!(rotate_medium_by727_strings, gen_strings, 9158, 727);\n+rotate!(rotate_medium_half, gen_random, 9158, 9158/2);\n+rotate!(rotate_medium_half_plus_one, gen_random, 9158, 9158/2+1);\n+\n+// Intended to use more RAM than the machine has cache\n+rotate!(rotate_huge_by1, gen_random, 5*1024*1024, 1);\n+rotate!(rotate_huge_by9199_u64, gen_random, 5*1024*1024, 9199);\n+rotate!(rotate_huge_by9199_bytes, gen_random_bytes, 5*1024*1024, 9199);\n+rotate!(rotate_huge_by9199_strings, gen_strings, 5*1024*1024, 9199);\n+rotate!(rotate_huge_by9199_big, gen_big_random, 5*1024*1024, 9199);\n+rotate!(rotate_huge_by1234577_u64, gen_random, 5*1024*1024, 1234577);\n+rotate!(rotate_huge_by1234577_bytes, gen_random_bytes, 5*1024*1024, 1234577);\n+rotate!(rotate_huge_by1234577_strings, gen_strings, 5*1024*1024, 1234577);\n+rotate!(rotate_huge_by1234577_big, gen_big_random, 5*1024*1024, 1234577);\n+rotate!(rotate_huge_half, gen_random, 5*1024*1024, 5*1024*1024/2);\n+rotate!(rotate_huge_half_plus_one, gen_random, 5*1024*1024, 5*1024*1024/2+1);"}, {"sha": "34626326c221ce533c452920960f12f1604dec5d", "filename": "src/libcollections/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/558cd1e393188a07bda413931aa88e82996d31c2/src%2Flibcollections%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/558cd1e393188a07bda413931aa88e82996d31c2/src%2Flibcollections%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcollections%2Flib.rs?ref=558cd1e393188a07bda413931aa88e82996d31c2", "patch": "@@ -55,6 +55,7 @@\n #![feature(shared)]\n #![feature(slice_get_slice)]\n #![feature(slice_patterns)]\n+#![cfg_attr(not(test), feature(slice_rotate))]\n #![feature(slice_rsplit)]\n #![cfg_attr(not(test), feature(sort_unstable))]\n #![feature(specialization)]"}, {"sha": "3b493f5e068d5fac2b0eec83ccd24a91870bc019", "filename": "src/libcollections/slice.rs", "status": "modified", "additions": 55, "deletions": 0, "changes": 55, "blob_url": "https://github.com/rust-lang/rust/blob/558cd1e393188a07bda413931aa88e82996d31c2/src%2Flibcollections%2Fslice.rs", "raw_url": "https://github.com/rust-lang/rust/raw/558cd1e393188a07bda413931aa88e82996d31c2/src%2Flibcollections%2Fslice.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcollections%2Fslice.rs?ref=558cd1e393188a07bda413931aa88e82996d31c2", "patch": "@@ -1347,6 +1347,61 @@ impl<T> [T] {\n         core_slice::SliceExt::sort_unstable_by_key(self, f);\n     }\n \n+    /// Permutes the slice in-place such that `self[mid..]` moves to the\n+    /// beginning of the slice while `self[..mid]` moves to the end of the\n+    /// slice.  Equivalently, rotates the slice `mid` places to the left\n+    /// or `k = self.len() - mid` places to the right.\n+    ///\n+    /// This is a \"k-rotation\", a permutation in which item `i` moves to\n+    /// position `i + k`, modulo the length of the slice.  See _Elements\n+    /// of Programming_ [\u00a710.4][eop].\n+    ///\n+    /// Rotation by `mid` and rotation by `k` are inverse operations.\n+    ///\n+    /// [eop]: https://books.google.com/books?id=CO9ULZGINlsC&pg=PA178&q=k-rotation\n+    ///\n+    /// # Panics\n+    ///\n+    /// This function will panic if `mid` is greater than the length of the\n+    /// slice.  (Note that `mid == self.len()` does _not_ panic; it's a nop\n+    /// rotation with `k == 0`, the inverse of a rotation with `mid == 0`.)\n+    ///\n+    /// # Complexity\n+    ///\n+    /// Takes linear (in `self.len()`) time.\n+    ///\n+    /// # Examples\n+    ///\n+    /// ```\n+    /// #![feature(slice_rotate)]\n+    ///\n+    /// let mut a = [1, 2, 3, 4, 5, 6, 7];\n+    /// let mid = 2;\n+    /// a.rotate(mid);\n+    /// assert_eq!(&a, &[3, 4, 5, 6, 7, 1, 2]);\n+    /// let k = a.len() - mid;\n+    /// a.rotate(k);\n+    /// assert_eq!(&a, &[1, 2, 3, 4, 5, 6, 7]);\n+    ///\n+    /// use std::ops::Range;\n+    /// fn slide<T>(slice: &mut [T], range: Range<usize>, to: usize) {\n+    ///     if to < range.start {\n+    ///         slice[to..range.end].rotate(range.start-to);\n+    ///     } else if to > range.end {\n+    ///         slice[range.start..to].rotate(range.end-range.start);\n+    ///     }\n+    /// }\n+    /// let mut v: Vec<_> = (0..10).collect();\n+    /// slide(&mut v, 1..4, 7);\n+    /// assert_eq!(&v, &[0, 4, 5, 6, 1, 2, 3, 7, 8, 9]);\n+    /// slide(&mut v, 6..8, 1);\n+    /// assert_eq!(&v, &[0, 3, 7, 4, 5, 6, 1, 2, 8, 9]);\n+    /// ```\n+    #[unstable(feature = \"slice_rotate\", issue = \"41891\")]\n+    pub fn rotate(&mut self, mid: usize) {\n+        core_slice::SliceExt::rotate(self, mid);\n+    }\n+\n     /// Copies the elements from `src` into `self`.\n     ///\n     /// The length of `src` must be the same as `self`."}, {"sha": "6ad5781c5d5fdf1984aee0dc5824bb46164d3d80", "filename": "src/libcollections/tests/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/558cd1e393188a07bda413931aa88e82996d31c2/src%2Flibcollections%2Ftests%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/558cd1e393188a07bda413931aa88e82996d31c2/src%2Flibcollections%2Ftests%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcollections%2Ftests%2Flib.rs?ref=558cd1e393188a07bda413931aa88e82996d31c2", "patch": "@@ -19,6 +19,7 @@\n #![feature(pattern)]\n #![feature(placement_in_syntax)]\n #![feature(rand)]\n+#![feature(slice_rotate)]\n #![feature(splice)]\n #![feature(step_by)]\n #![feature(str_escape)]"}, {"sha": "7fa65a2144e9b47d1f3f093c04fa980bc6bf5596", "filename": "src/libcollections/tests/slice.rs", "status": "modified", "additions": 35, "deletions": 0, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/558cd1e393188a07bda413931aa88e82996d31c2/src%2Flibcollections%2Ftests%2Fslice.rs", "raw_url": "https://github.com/rust-lang/rust/raw/558cd1e393188a07bda413931aa88e82996d31c2/src%2Flibcollections%2Ftests%2Fslice.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcollections%2Ftests%2Fslice.rs?ref=558cd1e393188a07bda413931aa88e82996d31c2", "patch": "@@ -466,6 +466,41 @@ fn test_sort_stability() {\n     }\n }\n \n+#[test]\n+fn test_rotate() {\n+    let expected: Vec<_> = (0..13).collect();\n+    let mut v = Vec::new();\n+\n+    // no-ops\n+    v.clone_from(&expected);\n+    v.rotate(0);\n+    assert_eq!(v, expected);\n+    v.rotate(expected.len());\n+    assert_eq!(v, expected);\n+    let mut zst_array = [(), (), ()];\n+    zst_array.rotate(2);\n+\n+    // happy path\n+    v = (5..13).chain(0..5).collect();\n+    v.rotate(8);\n+    assert_eq!(v, expected);\n+\n+    let expected: Vec<_> = (0..1000).collect();\n+\n+    // small rotations in large slice, uses ptr::copy\n+    v = (2..1000).chain(0..2).collect();\n+    v.rotate(998);\n+    assert_eq!(v, expected);\n+    v = (998..1000).chain(0..998).collect();\n+    v.rotate(2);\n+    assert_eq!(v, expected);\n+\n+    // non-small prime rotation, has a few rounds of swapping\n+    v = (389..1000).chain(0..389).collect();\n+    v.rotate(1000-389);\n+    assert_eq!(v, expected);\n+}\n+\n #[test]\n fn test_concat() {\n     let v: [Vec<i32>; 0] = [];"}, {"sha": "b13e19c0306947e2c893d77adc066d838dc83950", "filename": "src/libcore/slice/mod.rs", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/558cd1e393188a07bda413931aa88e82996d31c2/src%2Flibcore%2Fslice%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/558cd1e393188a07bda413931aa88e82996d31c2/src%2Flibcore%2Fslice%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fslice%2Fmod.rs?ref=558cd1e393188a07bda413931aa88e82996d31c2", "patch": "@@ -51,6 +51,7 @@ use mem;\n use marker::{Copy, Send, Sync, Sized, self};\n use iter_private::TrustedRandomAccess;\n \n+mod rotate;\n mod sort;\n \n #[repr(C)]\n@@ -202,6 +203,9 @@ pub trait SliceExt {\n     #[stable(feature = \"core\", since = \"1.6.0\")]\n     fn ends_with(&self, needle: &[Self::Item]) -> bool where Self::Item: PartialEq;\n \n+    #[unstable(feature = \"slice_rotate\", issue = \"41891\")]\n+    fn rotate(&mut self, mid: usize);\n+\n     #[stable(feature = \"clone_from_slice\", since = \"1.7.0\")]\n     fn clone_from_slice(&mut self, src: &[Self::Item]) where Self::Item: Clone;\n \n@@ -635,6 +639,16 @@ impl<T> SliceExt for [T] {\n         self.binary_search_by(|p| p.borrow().cmp(x))\n     }\n \n+    fn rotate(&mut self, mid: usize) {\n+        assert!(mid <= self.len());\n+        let k = self.len() - mid;\n+\n+        unsafe {\n+            let p = self.as_mut_ptr();\n+            rotate::ptr_rotate(mid, p.offset(mid as isize), k);\n+        }\n+    }\n+\n     #[inline]\n     fn clone_from_slice(&mut self, src: &[T]) where T: Clone {\n         assert!(self.len() == src.len(),"}, {"sha": "3b9ae5652c5d1cf05005fe788a24af41f9bffdd7", "filename": "src/libcore/slice/rotate.rs", "status": "added", "additions": 112, "deletions": 0, "changes": 112, "blob_url": "https://github.com/rust-lang/rust/blob/558cd1e393188a07bda413931aa88e82996d31c2/src%2Flibcore%2Fslice%2Frotate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/558cd1e393188a07bda413931aa88e82996d31c2/src%2Flibcore%2Fslice%2Frotate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fslice%2Frotate.rs?ref=558cd1e393188a07bda413931aa88e82996d31c2", "patch": "@@ -0,0 +1,112 @@\n+// Copyright 2012-2017 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+use cmp;\n+use mem;\n+use ptr;\n+\n+/// Rotation is much faster if it has access to a little bit of memory. This\n+/// union provides a RawVec-like interface, but to a fixed-size stack buffer.\n+#[allow(unions_with_drop_fields)]\n+union RawArray<T> {\n+    /// Ensure this is appropriately aligned for T, and is big\n+    /// enough for two elements even if T is enormous.\n+    typed: [T; 2],\n+    /// For normally-sized types, especially things like u8, having more\n+    /// than 2 in the buffer is necessary for usefulness, so pad it out\n+    /// enough to be helpful, but not so big as to risk overflow.\n+    _extra: [usize; 32],\n+}\n+\n+impl<T> RawArray<T> {\n+    fn new() -> Self {\n+        unsafe { mem::uninitialized() }\n+    }\n+    fn ptr(&self) -> *mut T {\n+        unsafe { &self.typed as *const T as *mut T }\n+    }\n+    fn cap() -> usize {\n+        if mem::size_of::<T>() == 0 {\n+            usize::max_value()\n+        } else {\n+            mem::size_of::<Self>() / mem::size_of::<T>()\n+        }\n+    }\n+}\n+\n+/// Rotates the range `[mid-left, mid+right)` such that the element at `mid`\n+/// becomes the first element.  Equivalently, rotates the range `left`\n+/// elements to the left or `right` elements to the right.\n+///\n+/// # Safety\n+///\n+/// The specified range must be valid for reading and writing.\n+/// The type `T` must have non-zero size.\n+///\n+/// # Algorithm\n+///\n+/// For longer rotations, swap the left-most `delta = min(left, right)`\n+/// elements with the right-most `delta` elements.  LLVM vectorizes this,\n+/// which is profitable as we only reach this step for a \"large enough\"\n+/// rotation.  Doing this puts `delta` elements on the larger side into the\n+/// correct position, leaving a smaller rotate problem.  Demonstration:\n+///\n+/// ```text\n+/// [ 6 7 8 9 10 11 12 13 . 1 2 3 4 5 ]\n+/// 1 2 3 4 5 [ 11 12 13 . 6 7 8 9 10 ]\n+/// 1 2 3 4 5 [ 8 9 10 . 6 7 ] 11 12 13\n+/// 1 2 3 4 5 6 7 [ 10 . 8 9 ] 11 12 13\n+/// 1 2 3 4 5 6 7 [ 9 . 8 ] 10 11 12 13\n+/// 1 2 3 4 5 6 7 8 [ . ] 9 10 11 12 13\n+/// ```\n+///\n+/// Once the rotation is small enough, copy some elements into a stack\n+/// buffer, `memmove` the others, and move the ones back from the buffer.\n+pub unsafe fn ptr_rotate<T>(mut left: usize, mid: *mut T, mut right: usize) {\n+    loop {\n+        let delta = cmp::min(left, right);\n+        if delta <= RawArray::<T>::cap() {\n+            break;\n+        }\n+\n+        ptr_swap_n(\n+            mid.offset(-(left as isize)),\n+            mid.offset((right-delta) as isize),\n+            delta);\n+\n+        if left <= right {\n+            right -= delta;\n+        } else {\n+            left -= delta;\n+        }\n+    }\n+\n+    let rawarray = RawArray::new();\n+    let buf = rawarray.ptr();\n+\n+    let dim = mid.offset(-(left as isize)).offset(right as isize);\n+    if left <= right {\n+        ptr::copy_nonoverlapping(mid.offset(-(left as isize)), buf, left);\n+        ptr::copy(mid, mid.offset(-(left as isize)), right);\n+        ptr::copy_nonoverlapping(buf, dim, left);\n+    }\n+    else {\n+        ptr::copy_nonoverlapping(mid, buf, right);\n+        ptr::copy(mid.offset(-(left as isize)), dim, left);\n+        ptr::copy_nonoverlapping(buf, mid.offset(-(left as isize)), right);\n+    }\n+}\n+\n+unsafe fn ptr_swap_n<T>(a: *mut T, b: *mut T, n: usize) {\n+    for i in 0..n {\n+        // These are nonoverlapping, so use mem::swap instead of ptr::swap\n+        mem::swap(&mut *a.offset(i as isize), &mut *b.offset(i as isize));\n+    }\n+}"}, {"sha": "505e51fa80b333b651eb10c089b1378272620dc0", "filename": "src/libcore/tests/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/558cd1e393188a07bda413931aa88e82996d31c2/src%2Flibcore%2Ftests%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/558cd1e393188a07bda413931aa88e82996d31c2/src%2Flibcore%2Ftests%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Ftests%2Flib.rs?ref=558cd1e393188a07bda413931aa88e82996d31c2", "patch": "@@ -30,6 +30,7 @@\n #![feature(raw)]\n #![feature(sip_hash_13)]\n #![feature(slice_patterns)]\n+#![feature(slice_rotate)]\n #![feature(sort_internals)]\n #![feature(sort_unstable)]\n #![feature(specialization)]"}, {"sha": "e5d6b53b570628b688e8e623a0b6052f5dab1f0d", "filename": "src/libcore/tests/slice.rs", "status": "modified", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/558cd1e393188a07bda413931aa88e82996d31c2/src%2Flibcore%2Ftests%2Fslice.rs", "raw_url": "https://github.com/rust-lang/rust/raw/558cd1e393188a07bda413931aa88e82996d31c2/src%2Flibcore%2Ftests%2Fslice.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Ftests%2Fslice.rs?ref=558cd1e393188a07bda413931aa88e82996d31c2", "patch": "@@ -238,6 +238,22 @@ fn test_find_rfind() {\n     assert_eq!(v.iter().rfind(|&&x| x <= 3), Some(&3));\n }\n \n+#[test]\n+fn test_rotate() {\n+    const N: usize = 600;\n+    let a: &mut [_] = &mut [0; N];\n+    for i in 0..N {\n+        a[i] = i;\n+    }\n+\n+    a.rotate(42);\n+    let k = N - 42;\n+\n+    for i in 0..N {\n+        assert_eq!(a[(i+k)%N], i);\n+    }\n+}\n+\n #[test]\n fn sort_unstable() {\n     let mut v = [0; 600];"}]}