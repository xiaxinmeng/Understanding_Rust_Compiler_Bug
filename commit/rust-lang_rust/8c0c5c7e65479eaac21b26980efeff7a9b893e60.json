{"sha": "8c0c5c7e65479eaac21b26980efeff7a9b893e60", "node_id": "MDY6Q29tbWl0NzI0NzEyOjhjMGM1YzdlNjU0NzllYWFjMjFiMjY5ODBlZmVmZjdhOWI4OTNlNjA=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2020-01-11T03:02:24Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-01-11T03:02:24Z"}, "message": "Rollup merge of #68043 - Zoxc:missing-timers, r=wesleywiser\n\nAdd some missing timers\n\nBased on https://github.com/rust-lang/rust/pull/67988\n\nr? @wesleywiser", "tree": {"sha": "4e3152f5dcd1e6054277b8e5490417146d8a9a99", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4e3152f5dcd1e6054277b8e5490417146d8a9a99"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8c0c5c7e65479eaac21b26980efeff7a9b893e60", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJeGTrACRBK7hj4Ov3rIwAAdHIIAHhTX/qHaEhD7GPJvHb3LX9t\n91B3FhplNvtbe+pKGW4aSeBZfbq/Oy7YbFOqIrlg73VEeQmwHdC3tkodxGYI+CH0\nJIRP0fMJPCihsnuFboE0hxv7gEbD6EafENfa5CweGv743heDgholUAjkAWyjuXcl\nx6y12ZwvX0uaWdYuM+0uZJzQpdwIJB+kpzKGBtz6xvTlt9eEcflU48OW7KXeL172\nQTCUF81JIKW8Svhz7zdYAvw47tJ91DYZpB4Df5k3+IJGlTlElrmp9Tgj2yyg3Ml5\nMwPxmdyT+ZU3mkYoFIoFdsF7MGOWkpLi48F+9OwX7gj9S9+KS25x9LrAa5lcqd4=\n=2cG8\n-----END PGP SIGNATURE-----\n", "payload": "tree 4e3152f5dcd1e6054277b8e5490417146d8a9a99\nparent 9634e1f7d972e6122890c6c6866127bb3ba61c9a\nparent 5918c187854e14a9b9c626753a70530a0e6222db\nauthor Mazdak Farrokhzad <twingoow@gmail.com> 1578711744 +0100\ncommitter GitHub <noreply@github.com> 1578711744 +0100\n\nRollup merge of #68043 - Zoxc:missing-timers, r=wesleywiser\n\nAdd some missing timers\n\nBased on https://github.com/rust-lang/rust/pull/67988\n\nr? @wesleywiser\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8c0c5c7e65479eaac21b26980efeff7a9b893e60", "html_url": "https://github.com/rust-lang/rust/commit/8c0c5c7e65479eaac21b26980efeff7a9b893e60", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8c0c5c7e65479eaac21b26980efeff7a9b893e60/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9634e1f7d972e6122890c6c6866127bb3ba61c9a", "url": "https://api.github.com/repos/rust-lang/rust/commits/9634e1f7d972e6122890c6c6866127bb3ba61c9a", "html_url": "https://github.com/rust-lang/rust/commit/9634e1f7d972e6122890c6c6866127bb3ba61c9a"}, {"sha": "5918c187854e14a9b9c626753a70530a0e6222db", "url": "https://api.github.com/repos/rust-lang/rust/commits/5918c187854e14a9b9c626753a70530a0e6222db", "html_url": "https://github.com/rust-lang/rust/commit/5918c187854e14a9b9c626753a70530a0e6222db"}], "stats": {"total": 134, "additions": 91, "deletions": 43}, "files": [{"sha": "58b8e8a089ad31137380c1584b39b01c875b3174", "filename": "src/librustc_ast_lowering/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/8c0c5c7e65479eaac21b26980efeff7a9b893e60/src%2Flibrustc_ast_lowering%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8c0c5c7e65479eaac21b26980efeff7a9b893e60/src%2Flibrustc_ast_lowering%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_ast_lowering%2Flib.rs?ref=8c0c5c7e65479eaac21b26980efeff7a9b893e60", "patch": "@@ -268,7 +268,7 @@ pub fn lower_crate<'a, 'hir>(\n     // incr. comp. yet.\n     dep_graph.assert_ignored();\n \n-    let _prof_timer = sess.prof.generic_activity(\"hir_lowering\");\n+    let _prof_timer = sess.prof.verbose_generic_activity(\"hir_lowering\");\n \n     LoweringContext {\n         crate_root: sess.parse_sess.injected_crate_name.try_get().copied(),"}, {"sha": "53ee5996432ceb4aec7cf7b0d0732a7fae9f0337", "filename": "src/librustc_codegen_ssa/back/link.rs", "status": "modified", "additions": 29, "deletions": 20, "changes": 49, "blob_url": "https://github.com/rust-lang/rust/blob/8c0c5c7e65479eaac21b26980efeff7a9b893e60/src%2Flibrustc_codegen_ssa%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8c0c5c7e65479eaac21b26980efeff7a9b893e60/src%2Flibrustc_codegen_ssa%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_ssa%2Fback%2Flink.rs?ref=8c0c5c7e65479eaac21b26980efeff7a9b893e60", "patch": "@@ -53,6 +53,7 @@ pub fn link_binary<'a, B: ArchiveBuilder<'a>>(\n     crate_name: &str,\n     target_cpu: &str,\n ) {\n+    let _timer = sess.timer(\"link_binary\");\n     let output_metadata = sess.opts.output_types.contains_key(&OutputType::Metadata);\n     for &crate_type in sess.crate_types.borrow().iter() {\n         // Ignore executable crates if we have -Z no-codegen, as they will error.\n@@ -71,9 +72,11 @@ pub fn link_binary<'a, B: ArchiveBuilder<'a>>(\n             );\n         }\n \n-        for obj in codegen_results.modules.iter().filter_map(|m| m.object.as_ref()) {\n-            check_file_is_writeable(obj, sess);\n-        }\n+        sess.time(\"link_binary_check_files_are_writeable\", || {\n+            for obj in codegen_results.modules.iter().filter_map(|m| m.object.as_ref()) {\n+                check_file_is_writeable(obj, sess);\n+            }\n+        });\n \n         let tmpdir = TempFileBuilder::new()\n             .prefix(\"rustc\")\n@@ -84,6 +87,7 @@ pub fn link_binary<'a, B: ArchiveBuilder<'a>>(\n             let out_filename = out_filename(sess, crate_type, outputs, crate_name);\n             match crate_type {\n                 config::CrateType::Rlib => {\n+                    let _timer = sess.timer(\"link_rlib\");\n                     link_rlib::<B>(\n                         sess,\n                         codegen_results,\n@@ -118,29 +122,34 @@ pub fn link_binary<'a, B: ArchiveBuilder<'a>>(\n     }\n \n     // Remove the temporary object file and metadata if we aren't saving temps\n-    if !sess.opts.cg.save_temps {\n-        if sess.opts.output_types.should_codegen() && !preserve_objects_for_their_debuginfo(sess) {\n-            for obj in codegen_results.modules.iter().filter_map(|m| m.object.as_ref()) {\n-                remove(sess, obj);\n+    sess.time(\"link_binary_remove_temps\", || {\n+        if !sess.opts.cg.save_temps {\n+            if sess.opts.output_types.should_codegen()\n+                && !preserve_objects_for_their_debuginfo(sess)\n+            {\n+                for obj in codegen_results.modules.iter().filter_map(|m| m.object.as_ref()) {\n+                    remove(sess, obj);\n+                }\n             }\n-        }\n-        for obj in codegen_results.modules.iter().filter_map(|m| m.bytecode_compressed.as_ref()) {\n-            remove(sess, obj);\n-        }\n-        if let Some(ref metadata_module) = codegen_results.metadata_module {\n-            if let Some(ref obj) = metadata_module.object {\n+            for obj in codegen_results.modules.iter().filter_map(|m| m.bytecode_compressed.as_ref())\n+            {\n                 remove(sess, obj);\n             }\n-        }\n-        if let Some(ref allocator_module) = codegen_results.allocator_module {\n-            if let Some(ref obj) = allocator_module.object {\n-                remove(sess, obj);\n+            if let Some(ref metadata_module) = codegen_results.metadata_module {\n+                if let Some(ref obj) = metadata_module.object {\n+                    remove(sess, obj);\n+                }\n             }\n-            if let Some(ref bc) = allocator_module.bytecode_compressed {\n-                remove(sess, bc);\n+            if let Some(ref allocator_module) = codegen_results.allocator_module {\n+                if let Some(ref obj) = allocator_module.object {\n+                    remove(sess, obj);\n+                }\n+                if let Some(ref bc) = allocator_module.bytecode_compressed {\n+                    remove(sess, bc);\n+                }\n             }\n         }\n-    }\n+    });\n }\n \n // The third parameter is for env vars, used on windows to set up the"}, {"sha": "4d09e23ee7f7a498e51c06240e6f4c6b02c49d4d", "filename": "src/librustc_codegen_ssa/back/write.rs", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/8c0c5c7e65479eaac21b26980efeff7a9b893e60/src%2Flibrustc_codegen_ssa%2Fback%2Fwrite.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8c0c5c7e65479eaac21b26980efeff7a9b893e60/src%2Flibrustc_codegen_ssa%2Fback%2Fwrite.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_ssa%2Fback%2Fwrite.rs?ref=8c0c5c7e65479eaac21b26980efeff7a9b893e60", "patch": "@@ -479,6 +479,8 @@ fn copy_all_cgu_workproducts_to_incr_comp_cache_dir(\n         return work_products;\n     }\n \n+    let _timer = sess.timer(\"incr_comp_copy_cgu_workproducts\");\n+\n     for module in compiled_modules.modules.iter().filter(|m| m.kind == ModuleKind::Regular) {\n         let mut files = vec![];\n \n@@ -1714,8 +1716,11 @@ pub struct OngoingCodegen<B: ExtraBackendMethods> {\n \n impl<B: ExtraBackendMethods> OngoingCodegen<B> {\n     pub fn join(self, sess: &Session) -> (CodegenResults, FxHashMap<WorkProductId, WorkProduct>) {\n+        let _timer = sess.timer(\"finish_ongoing_codegen\");\n+\n         self.shared_emitter_main.check(sess, true);\n-        let compiled_modules = match self.future.join() {\n+        let future = self.future;\n+        let compiled_modules = sess.time(\"join_worker_thread\", || match future.join() {\n             Ok(Ok(compiled_modules)) => compiled_modules,\n             Ok(Err(())) => {\n                 sess.abort_if_errors();\n@@ -1724,7 +1729,7 @@ impl<B: ExtraBackendMethods> OngoingCodegen<B> {\n             Err(_) => {\n                 bug!(\"panic during codegen/LLVM phase\");\n             }\n-        };\n+        });\n \n         sess.cgu_reuse_tracker.check_expected_reuse(sess.diagnostic());\n "}, {"sha": "8deb43d50f93874641512387261eeaf2ddbde0b1", "filename": "src/librustc_data_structures/profiling.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/8c0c5c7e65479eaac21b26980efeff7a9b893e60/src%2Flibrustc_data_structures%2Fprofiling.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8c0c5c7e65479eaac21b26980efeff7a9b893e60/src%2Flibrustc_data_structures%2Fprofiling.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_data_structures%2Fprofiling.rs?ref=8c0c5c7e65479eaac21b26980efeff7a9b893e60", "patch": "@@ -495,6 +495,12 @@ impl<'a> TimingGuard<'a> {\n     pub fn none() -> TimingGuard<'a> {\n         TimingGuard(None)\n     }\n+\n+    #[inline(always)]\n+    pub fn run<R>(self, f: impl FnOnce() -> R) -> R {\n+        let _timer = self;\n+        f()\n+    }\n }\n \n #[must_use]"}, {"sha": "3d31f240a34e04132312456f3f0fdd5d9e09d290", "filename": "src/librustc_driver/lib.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/8c0c5c7e65479eaac21b26980efeff7a9b893e60/src%2Flibrustc_driver%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8c0c5c7e65479eaac21b26980efeff7a9b893e60/src%2Flibrustc_driver%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_driver%2Flib.rs?ref=8c0c5c7e65479eaac21b26980efeff7a9b893e60", "patch": "@@ -389,6 +389,7 @@ pub fn run_compiler(\n                 })?;\n             } else {\n                 // Drop AST after creating GlobalCtxt to free memory\n+                let _timer = sess.prof.generic_activity(\"drop_ast\");\n                 mem::drop(queries.expansion()?.take());\n             }\n \n@@ -413,6 +414,7 @@ pub fn run_compiler(\n         })?;\n \n         if let Some(linker) = linker {\n+            let _timer = sess.timer(\"link\");\n             linker.link()?\n         }\n "}, {"sha": "ba20006d73cccf0f4866140bc8dd52379bf0a5de", "filename": "src/librustc_incremental/persist/fs.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/8c0c5c7e65479eaac21b26980efeff7a9b893e60/src%2Flibrustc_incremental%2Fpersist%2Ffs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8c0c5c7e65479eaac21b26980efeff7a9b893e60/src%2Flibrustc_incremental%2Fpersist%2Ffs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_incremental%2Fpersist%2Ffs.rs?ref=8c0c5c7e65479eaac21b26980efeff7a9b893e60", "patch": "@@ -190,6 +190,8 @@ pub fn prepare_session_directory(\n         return;\n     }\n \n+    let _timer = sess.timer(\"incr_comp_prepare_session_directory\");\n+\n     debug!(\"prepare_session_directory\");\n \n     // {incr-comp-dir}/{crate-name-and-disambiguator}\n@@ -306,6 +308,8 @@ pub fn finalize_session_directory(sess: &Session, svh: Svh) {\n         return;\n     }\n \n+    let _timer = sess.timer(\"incr_comp_finalize_session_directory\");\n+\n     let incr_comp_session_dir: PathBuf = sess.incr_comp_session_dir().clone();\n \n     if sess.has_errors_or_delayed_span_bugs() {"}, {"sha": "6c57f79e1a7fb911e03edc5ce52a1ce7a249a2e4", "filename": "src/librustc_incremental/persist/load.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/8c0c5c7e65479eaac21b26980efeff7a9b893e60/src%2Flibrustc_incremental%2Fpersist%2Fload.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8c0c5c7e65479eaac21b26980efeff7a9b893e60/src%2Flibrustc_incremental%2Fpersist%2Fload.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_incremental%2Fpersist%2Fload.rs?ref=8c0c5c7e65479eaac21b26980efeff7a9b893e60", "patch": "@@ -102,6 +102,8 @@ pub fn load_dep_graph(sess: &Session) -> DepGraphFuture {\n         return MaybeAsync::Sync(LoadResult::Ok { data: Default::default() });\n     }\n \n+    let _timer = sess.prof.generic_activity(\"incr_comp_prepare_load_dep_graph\");\n+\n     // Calling `sess.incr_comp_session_dir()` will panic if `sess.opts.incremental.is_none()`.\n     // Fortunately, we just checked that this isn't the case.\n     let path = dep_graph_path_from(&sess.incr_comp_session_dir());"}, {"sha": "d00875f6fee88f50f03d119205e8bdda4233a53f", "filename": "src/librustc_interface/interface.rs", "status": "modified", "additions": 10, "deletions": 4, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/8c0c5c7e65479eaac21b26980efeff7a9b893e60/src%2Flibrustc_interface%2Finterface.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8c0c5c7e65479eaac21b26980efeff7a9b893e60/src%2Flibrustc_interface%2Finterface.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_interface%2Finterface.rs?ref=8c0c5c7e65479eaac21b26980efeff7a9b893e60", "patch": "@@ -177,11 +177,17 @@ pub fn run_compiler_in_existing_thread_pool<R>(\n         override_queries: config.override_queries,\n     };\n \n-    let _sess_abort_error = OnDrop(|| {\n-        compiler.sess.diagnostic().print_error_count(registry);\n-    });\n+    let r = {\n+        let _sess_abort_error = OnDrop(|| {\n+            compiler.sess.diagnostic().print_error_count(registry);\n+        });\n \n-    f(&compiler)\n+        f(&compiler)\n+    };\n+\n+    let prof = compiler.sess.prof.clone();\n+    prof.generic_activity(\"drop_compiler\").run(move || drop(compiler));\n+    r\n }\n \n pub fn run_compiler<R: Send>(mut config: Config, f: impl FnOnce(&Compiler) -> R + Send) -> R {"}, {"sha": "9119466cbc048fb9684be1893a8325d8761f9234", "filename": "src/librustc_interface/passes.rs", "status": "modified", "additions": 18, "deletions": 14, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/8c0c5c7e65479eaac21b26980efeff7a9b893e60/src%2Flibrustc_interface%2Fpasses.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8c0c5c7e65479eaac21b26980efeff7a9b893e60/src%2Flibrustc_interface%2Fpasses.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_interface%2Fpasses.rs?ref=8c0c5c7e65479eaac21b26980efeff7a9b893e60", "patch": "@@ -610,6 +610,8 @@ pub fn prepare_outputs(\n     boxed_resolver: &Steal<Rc<RefCell<BoxedResolver>>>,\n     crate_name: &str,\n ) -> Result<OutputFilenames> {\n+    let _timer = sess.timer(\"prepare_outputs\");\n+\n     // FIXME: rustdoc passes &[] instead of &krate.attrs here\n     let outputs = util::build_output_filenames(\n         &compiler.input,\n@@ -733,20 +735,22 @@ pub fn create_global_ctxt<'tcx>(\n         callback(sess, &mut local_providers, &mut extern_providers);\n     }\n \n-    let gcx = global_ctxt.init_locking(|| {\n-        TyCtxt::create_global_ctxt(\n-            sess,\n-            lint_store,\n-            local_providers,\n-            extern_providers,\n-            &all_arenas,\n-            arena,\n-            resolver_outputs,\n-            hir_map,\n-            query_result_on_disk_cache,\n-            &crate_name,\n-            &outputs,\n-        )\n+    let gcx = sess.time(\"setup_global_ctxt\", || {\n+        global_ctxt.init_locking(|| {\n+            TyCtxt::create_global_ctxt(\n+                sess,\n+                lint_store,\n+                local_providers,\n+                extern_providers,\n+                &all_arenas,\n+                arena,\n+                resolver_outputs,\n+                hir_map,\n+                query_result_on_disk_cache,\n+                &crate_name,\n+                &outputs,\n+            )\n+        })\n     });\n \n     // Do some initialization of the DepGraph that can only be done with the tcx available."}, {"sha": "7de1c36ce4b2e838fc8d1bd9d376f9bc38a340b2", "filename": "src/librustc_interface/queries.rs", "status": "modified", "additions": 12, "deletions": 2, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/8c0c5c7e65479eaac21b26980efeff7a9b893e60/src%2Flibrustc_interface%2Fqueries.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8c0c5c7e65479eaac21b26980efeff7a9b893e60/src%2Flibrustc_interface%2Fqueries.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_interface%2Fqueries.rs?ref=8c0c5c7e65479eaac21b26980efeff7a9b893e60", "patch": "@@ -176,6 +176,7 @@ impl<'tcx> Queries<'tcx> {\n         self.expansion.compute(|| {\n             let crate_name = self.crate_name()?.peek().clone();\n             let (krate, lint_store) = self.register_plugins()?.take();\n+            let _timer = self.session().timer(\"configure_and_expand\");\n             passes::configure_and_expand(\n                 self.session().clone(),\n                 lint_store.clone(),\n@@ -256,6 +257,7 @@ impl<'tcx> Queries<'tcx> {\n             let lint_store = self.expansion()?.peek().2.clone();\n             let hir = self.lower_to_hir()?.peek();\n             let (ref hir_forest, ref resolver_outputs) = &*hir;\n+            let _timer = self.session().timer(\"create_global_ctxt\");\n             Ok(passes::create_global_ctxt(\n                 self.compiler,\n                 lint_store,\n@@ -312,14 +314,19 @@ pub struct Linker {\n \n impl Linker {\n     pub fn link(self) -> Result<()> {\n-        self.codegen_backend\n+        let r = self\n+            .codegen_backend\n             .join_codegen_and_link(\n                 self.ongoing_codegen,\n                 &self.sess,\n                 &self.dep_graph,\n                 &self.prepare_outputs,\n             )\n-            .map_err(|_| ErrorReported)\n+            .map_err(|_| ErrorReported);\n+        let prof = self.sess.prof.clone();\n+        let dep_graph = self.dep_graph;\n+        prof.generic_activity(\"drop_dep_graph\").run(move || drop(dep_graph));\n+        r\n     }\n }\n \n@@ -328,6 +335,7 @@ impl Compiler {\n     where\n         F: for<'tcx> FnOnce(&'tcx Queries<'tcx>) -> T,\n     {\n+        let mut _timer = None;\n         let queries = Queries::new(&self);\n         let ret = f(&queries);\n \n@@ -337,6 +345,8 @@ impl Compiler {\n             }\n         }\n \n+        _timer = Some(self.session().timer(\"free_global_ctxt\"));\n+\n         ret\n     }\n "}]}