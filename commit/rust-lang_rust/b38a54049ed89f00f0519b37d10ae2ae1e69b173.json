{"sha": "b38a54049ed89f00f0519b37d10ae2ae1e69b173", "node_id": "C_kwDOAAsO6NoAKGIzOGE1NDA0OWVkODlmMDBmMDUxOWIzN2QxMGFlMmFlMWU2OWIxNzM", "commit": {"author": {"name": "Fabian Wolff", "email": "fabian.wolff@alumni.ethz.ch", "date": "2021-11-26T22:10:46Z"}, "committer": {"name": "Fabian Wolff", "email": "fabian.wolff@alumni.ethz.ch", "date": "2021-11-26T22:10:46Z"}, "message": "Print a suggestion when comparing references to primitive types in constant functions", "tree": {"sha": "46a868e17d203e9756431ed0867862c7c768dd50", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/46a868e17d203e9756431ed0867862c7c768dd50"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b38a54049ed89f00f0519b37d10ae2ae1e69b173", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b38a54049ed89f00f0519b37d10ae2ae1e69b173", "html_url": "https://github.com/rust-lang/rust/commit/b38a54049ed89f00f0519b37d10ae2ae1e69b173", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b38a54049ed89f00f0519b37d10ae2ae1e69b173/comments", "author": {"login": "FabianWolff", "id": 16052130, "node_id": "MDQ6VXNlcjE2MDUyMTMw", "avatar_url": "https://avatars.githubusercontent.com/u/16052130?v=4", "gravatar_id": "", "url": "https://api.github.com/users/FabianWolff", "html_url": "https://github.com/FabianWolff", "followers_url": "https://api.github.com/users/FabianWolff/followers", "following_url": "https://api.github.com/users/FabianWolff/following{/other_user}", "gists_url": "https://api.github.com/users/FabianWolff/gists{/gist_id}", "starred_url": "https://api.github.com/users/FabianWolff/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/FabianWolff/subscriptions", "organizations_url": "https://api.github.com/users/FabianWolff/orgs", "repos_url": "https://api.github.com/users/FabianWolff/repos", "events_url": "https://api.github.com/users/FabianWolff/events{/privacy}", "received_events_url": "https://api.github.com/users/FabianWolff/received_events", "type": "User", "site_admin": false}, "committer": {"login": "FabianWolff", "id": 16052130, "node_id": "MDQ6VXNlcjE2MDUyMTMw", "avatar_url": "https://avatars.githubusercontent.com/u/16052130?v=4", "gravatar_id": "", "url": "https://api.github.com/users/FabianWolff", "html_url": "https://github.com/FabianWolff", "followers_url": "https://api.github.com/users/FabianWolff/followers", "following_url": "https://api.github.com/users/FabianWolff/following{/other_user}", "gists_url": "https://api.github.com/users/FabianWolff/gists{/gist_id}", "starred_url": "https://api.github.com/users/FabianWolff/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/FabianWolff/subscriptions", "organizations_url": "https://api.github.com/users/FabianWolff/orgs", "repos_url": "https://api.github.com/users/FabianWolff/repos", "events_url": "https://api.github.com/users/FabianWolff/events{/privacy}", "received_events_url": "https://api.github.com/users/FabianWolff/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "dd549dcab404ec4c7d07b5a83aca5bdd7171138f", "url": "https://api.github.com/repos/rust-lang/rust/commits/dd549dcab404ec4c7d07b5a83aca5bdd7171138f", "html_url": "https://github.com/rust-lang/rust/commit/dd549dcab404ec4c7d07b5a83aca5bdd7171138f"}], "stats": {"total": 180, "additions": 170, "deletions": 10}, "files": [{"sha": "e7313201c0302b547d275542630ae21876a18481", "filename": "compiler/rustc_const_eval/src/transform/check_consts/check.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/b38a54049ed89f00f0519b37d10ae2ae1e69b173/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fcheck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b38a54049ed89f00f0519b37d10ae2ae1e69b173/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fcheck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fcheck.rs?ref=b38a54049ed89f00f0519b37d10ae2ae1e69b173", "patch": "@@ -812,7 +812,7 @@ impl Visitor<'tcx> for Checker<'mir, 'tcx> {\n                 if let Some(trait_id) = tcx.trait_of_item(callee) {\n                     trace!(\"attempting to call a trait method\");\n                     if !self.tcx.features().const_trait_impl {\n-                        self.check_op(ops::FnCallNonConst);\n+                        self.check_op(ops::FnCallNonConst(Some((callee, substs))));\n                         return;\n                     }\n \n@@ -868,7 +868,7 @@ impl Visitor<'tcx> for Checker<'mir, 'tcx> {\n                             }\n \n                             if !nonconst_call_permission {\n-                                self.check_op(ops::FnCallNonConst);\n+                                self.check_op(ops::FnCallNonConst(None));\n                                 return;\n                             }\n                         }\n@@ -937,7 +937,7 @@ impl Visitor<'tcx> for Checker<'mir, 'tcx> {\n                     }\n \n                     if !nonconst_call_permission {\n-                        self.check_op(ops::FnCallNonConst);\n+                        self.check_op(ops::FnCallNonConst(None));\n                         return;\n                     }\n                 }"}, {"sha": "421c559474a97d642b1720367355187aa556d5cd", "filename": "compiler/rustc_const_eval/src/transform/check_consts/ops.rs", "status": "modified", "additions": 63, "deletions": 7, "changes": 70, "blob_url": "https://github.com/rust-lang/rust/blob/b38a54049ed89f00f0519b37d10ae2ae1e69b173/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fops.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b38a54049ed89f00f0519b37d10ae2ae1e69b173/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fops.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fops.rs?ref=b38a54049ed89f00f0519b37d10ae2ae1e69b173", "patch": "@@ -1,12 +1,14 @@\n //! Concrete error types for all operations which may be invalid in a certain const context.\n \n-use rustc_errors::{struct_span_err, DiagnosticBuilder};\n+use rustc_errors::{struct_span_err, Applicability, DiagnosticBuilder};\n use rustc_hir as hir;\n use rustc_hir::def_id::DefId;\n-use rustc_middle::mir;\n+use rustc_middle::ty::subst::{GenericArgKind, SubstsRef};\n+use rustc_middle::{mir, ty::AssocKind};\n use rustc_session::parse::feature_err;\n use rustc_span::symbol::sym;\n-use rustc_span::{Span, Symbol};\n+use rustc_span::{symbol::Ident, Span, Symbol};\n+use rustc_span::{BytePos, Pos};\n \n use super::ConstCx;\n \n@@ -72,17 +74,71 @@ impl NonConstOp for FnCallIndirect {\n \n /// A function call where the callee is not marked as `const`.\n #[derive(Debug)]\n-pub struct FnCallNonConst;\n-impl NonConstOp for FnCallNonConst {\n+pub struct FnCallNonConst<'tcx>(pub Option<(DefId, SubstsRef<'tcx>)>);\n+impl<'a> NonConstOp for FnCallNonConst<'a> {\n     fn build_error(&self, ccx: &ConstCx<'_, 'tcx>, span: Span) -> DiagnosticBuilder<'tcx> {\n-        struct_span_err!(\n+        let mut err = struct_span_err!(\n             ccx.tcx.sess,\n             span,\n             E0015,\n             \"calls in {}s are limited to constant functions, \\\n              tuple structs and tuple variants\",\n             ccx.const_kind(),\n-        )\n+        );\n+\n+        if let FnCallNonConst(Some((callee, substs))) = *self {\n+            if let Some(trait_def_id) = ccx.tcx.lang_items().eq_trait() {\n+                if let Some(eq_item) = ccx.tcx.associated_items(trait_def_id).find_by_name_and_kind(\n+                    ccx.tcx,\n+                    Ident::with_dummy_span(sym::eq),\n+                    AssocKind::Fn,\n+                    trait_def_id,\n+                ) {\n+                    if callee == eq_item.def_id && substs.len() == 2 {\n+                        match (substs[0].unpack(), substs[1].unpack()) {\n+                            (GenericArgKind::Type(self_ty), GenericArgKind::Type(rhs_ty))\n+                                if self_ty == rhs_ty\n+                                    && self_ty.is_ref()\n+                                    && self_ty.peel_refs().is_primitive() =>\n+                            {\n+                                let mut num_refs = 0;\n+                                let mut tmp_ty = self_ty;\n+                                while let rustc_middle::ty::Ref(_, inner_ty, _) = tmp_ty.kind() {\n+                                    num_refs += 1;\n+                                    tmp_ty = inner_ty;\n+                                }\n+                                let deref = \"*\".repeat(num_refs);\n+\n+                                if let Ok(call_str) =\n+                                    ccx.tcx.sess.source_map().span_to_snippet(span)\n+                                {\n+                                    if let Some(eq_idx) = call_str.find(\"==\") {\n+                                        if let Some(rhs_idx) = call_str[(eq_idx + 2)..]\n+                                            .find(|c: char| !c.is_whitespace())\n+                                        {\n+                                            let rhs_pos = span.lo()\n+                                                + BytePos::from_usize(eq_idx + 2 + rhs_idx);\n+                                            let rhs_span = span.with_lo(rhs_pos).with_hi(rhs_pos);\n+                                            err.multipart_suggestion(\n+                                                \"consider dereferencing here\",\n+                                                vec![\n+                                                    (span.shrink_to_lo(), deref.clone()),\n+                                                    (rhs_span, deref),\n+                                                ],\n+                                                Applicability::MachineApplicable,\n+                                            );\n+                                        }\n+                                    }\n+                                }\n+                            }\n+                            _ => {}\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+\n+        err\n     }\n }\n "}, {"sha": "e767effcdd06f459d971aa143c0ba0f52d15d96e", "filename": "src/test/ui/consts/issue-90870.fixed", "status": "added", "additions": 34, "deletions": 0, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/b38a54049ed89f00f0519b37d10ae2ae1e69b173/src%2Ftest%2Fui%2Fconsts%2Fissue-90870.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/b38a54049ed89f00f0519b37d10ae2ae1e69b173/src%2Ftest%2Fui%2Fconsts%2Fissue-90870.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fissue-90870.fixed?ref=b38a54049ed89f00f0519b37d10ae2ae1e69b173", "patch": "@@ -0,0 +1,34 @@\n+// Regression test for issue #90870.\n+\n+// run-rustfix\n+\n+#![allow(dead_code)]\n+\n+const fn f(a: &u8, b: &u8) -> bool {\n+    *a == *b\n+    //~^ ERROR: calls in constant functions are limited to constant functions, tuple structs and tuple variants [E0015]\n+    //~| HELP: consider dereferencing here\n+}\n+\n+const fn g(a: &&&&i64, b: &&&&i64) -> bool {\n+    ****a == ****b\n+    //~^ ERROR: calls in constant functions are limited to constant functions, tuple structs and tuple variants [E0015]\n+    //~| HELP: consider dereferencing here\n+}\n+\n+const fn h(mut a: &[u8], mut b: &[u8]) -> bool {\n+    while let ([l, at @ ..], [r, bt @ ..]) = (a, b) {\n+        if *l == *r {\n+        //~^ ERROR: calls in constant functions are limited to constant functions, tuple structs and tuple variants [E0015]\n+        //~| HELP: consider dereferencing here\n+            a = at;\n+            b = bt;\n+        } else {\n+            return false;\n+        }\n+    }\n+\n+    a.is_empty() && b.is_empty()\n+}\n+\n+fn main() {}"}, {"sha": "35b3c8242aa0c7ff5011b93b07946b5094dee049", "filename": "src/test/ui/consts/issue-90870.rs", "status": "added", "additions": 34, "deletions": 0, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/b38a54049ed89f00f0519b37d10ae2ae1e69b173/src%2Ftest%2Fui%2Fconsts%2Fissue-90870.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b38a54049ed89f00f0519b37d10ae2ae1e69b173/src%2Ftest%2Fui%2Fconsts%2Fissue-90870.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fissue-90870.rs?ref=b38a54049ed89f00f0519b37d10ae2ae1e69b173", "patch": "@@ -0,0 +1,34 @@\n+// Regression test for issue #90870.\n+\n+// run-rustfix\n+\n+#![allow(dead_code)]\n+\n+const fn f(a: &u8, b: &u8) -> bool {\n+    a == b\n+    //~^ ERROR: calls in constant functions are limited to constant functions, tuple structs and tuple variants [E0015]\n+    //~| HELP: consider dereferencing here\n+}\n+\n+const fn g(a: &&&&i64, b: &&&&i64) -> bool {\n+    a == b\n+    //~^ ERROR: calls in constant functions are limited to constant functions, tuple structs and tuple variants [E0015]\n+    //~| HELP: consider dereferencing here\n+}\n+\n+const fn h(mut a: &[u8], mut b: &[u8]) -> bool {\n+    while let ([l, at @ ..], [r, bt @ ..]) = (a, b) {\n+        if l == r {\n+        //~^ ERROR: calls in constant functions are limited to constant functions, tuple structs and tuple variants [E0015]\n+        //~| HELP: consider dereferencing here\n+            a = at;\n+            b = bt;\n+        } else {\n+            return false;\n+        }\n+    }\n+\n+    a.is_empty() && b.is_empty()\n+}\n+\n+fn main() {}"}, {"sha": "0e33e6ebe5a5963adfccd3322ad6847ad4e89431", "filename": "src/test/ui/consts/issue-90870.stderr", "status": "added", "additions": 36, "deletions": 0, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/b38a54049ed89f00f0519b37d10ae2ae1e69b173/src%2Ftest%2Fui%2Fconsts%2Fissue-90870.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/b38a54049ed89f00f0519b37d10ae2ae1e69b173/src%2Ftest%2Fui%2Fconsts%2Fissue-90870.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fissue-90870.stderr?ref=b38a54049ed89f00f0519b37d10ae2ae1e69b173", "patch": "@@ -0,0 +1,36 @@\n+error[E0015]: calls in constant functions are limited to constant functions, tuple structs and tuple variants\n+  --> $DIR/issue-90870.rs:8:5\n+   |\n+LL |     a == b\n+   |     ^^^^^^\n+   |\n+help: consider dereferencing here\n+   |\n+LL |     *a == *b\n+   |     +     +\n+\n+error[E0015]: calls in constant functions are limited to constant functions, tuple structs and tuple variants\n+  --> $DIR/issue-90870.rs:14:5\n+   |\n+LL |     a == b\n+   |     ^^^^^^\n+   |\n+help: consider dereferencing here\n+   |\n+LL |     ****a == ****b\n+   |     ++++     ++++\n+\n+error[E0015]: calls in constant functions are limited to constant functions, tuple structs and tuple variants\n+  --> $DIR/issue-90870.rs:21:12\n+   |\n+LL |         if l == r {\n+   |            ^^^^^^\n+   |\n+help: consider dereferencing here\n+   |\n+LL |         if *l == *r {\n+   |            +     +\n+\n+error: aborting due to 3 previous errors\n+\n+For more information about this error, try `rustc --explain E0015`."}]}