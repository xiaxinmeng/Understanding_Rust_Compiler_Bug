{"sha": "02274a8430f3d4ff7cf4b2391aaf4b3138f1b061", "node_id": "MDY6Q29tbWl0NzI0NzEyOjAyMjc0YTg0MzBmM2Q0ZmY3Y2Y0YjIzOTFhYWY0YjMxMzhmMWIwNjE=", "commit": {"author": {"name": "Corey Farwell", "email": "coreyf@rwell.org", "date": "2017-05-03T01:21:20Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2017-05-03T01:21:20Z"}, "message": "Rollup merge of #41653 - achernyak:master, r=nikomatsakis\n\nQueries for Crate Metadata\n\nThis resolves following parts of #41417:\n* `fn stability(&self, def: DefId) -> Option<attr::Stability>;`\n* `fn deprecation(&self, def: DefId) -> Option<attr::Deprecation>;`\n\nr? @nikomatsakis", "tree": {"sha": "15d1079a2a71e03568ea00d6dbb7c2fc8434aa33", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/15d1079a2a71e03568ea00d6dbb7c2fc8434aa33"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/02274a8430f3d4ff7cf4b2391aaf4b3138f1b061", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/02274a8430f3d4ff7cf4b2391aaf4b3138f1b061", "html_url": "https://github.com/rust-lang/rust/commit/02274a8430f3d4ff7cf4b2391aaf4b3138f1b061", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/02274a8430f3d4ff7cf4b2391aaf4b3138f1b061/comments", "author": {"login": "frewsxcv", "id": 416575, "node_id": "MDQ6VXNlcjQxNjU3NQ==", "avatar_url": "https://avatars.githubusercontent.com/u/416575?v=4", "gravatar_id": "", "url": "https://api.github.com/users/frewsxcv", "html_url": "https://github.com/frewsxcv", "followers_url": "https://api.github.com/users/frewsxcv/followers", "following_url": "https://api.github.com/users/frewsxcv/following{/other_user}", "gists_url": "https://api.github.com/users/frewsxcv/gists{/gist_id}", "starred_url": "https://api.github.com/users/frewsxcv/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/frewsxcv/subscriptions", "organizations_url": "https://api.github.com/users/frewsxcv/orgs", "repos_url": "https://api.github.com/users/frewsxcv/repos", "events_url": "https://api.github.com/users/frewsxcv/events{/privacy}", "received_events_url": "https://api.github.com/users/frewsxcv/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9e621c2da8b96b4cfdca208dea21a2888f00d9e0", "url": "https://api.github.com/repos/rust-lang/rust/commits/9e621c2da8b96b4cfdca208dea21a2888f00d9e0", "html_url": "https://github.com/rust-lang/rust/commit/9e621c2da8b96b4cfdca208dea21a2888f00d9e0"}, {"sha": "c1d97c7d5acf1a6250744a56dfd125cf534b61a4", "url": "https://api.github.com/repos/rust-lang/rust/commits/c1d97c7d5acf1a6250744a56dfd125cf534b61a4", "html_url": "https://github.com/rust-lang/rust/commit/c1d97c7d5acf1a6250744a56dfd125cf534b61a4"}], "stats": {"total": 42, "additions": 24, "deletions": 18}, "files": [{"sha": "37b8a56d9166b5c690b7ff968a3c43963ce592db", "filename": "src/librustc/dep_graph/dep_node.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/02274a8430f3d4ff7cf4b2391aaf4b3138f1b061/src%2Flibrustc%2Fdep_graph%2Fdep_node.rs", "raw_url": "https://github.com/rust-lang/rust/raw/02274a8430f3d4ff7cf4b2391aaf4b3138f1b061/src%2Flibrustc%2Fdep_graph%2Fdep_node.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fdep_graph%2Fdep_node.rs?ref=02274a8430f3d4ff7cf4b2391aaf4b3138f1b061", "patch": "@@ -152,6 +152,8 @@ pub enum DepNode<D: Clone + Debug> {\n \n     DescribeDef(D),\n     DefSpan(D),\n+    Stability(D),\n+    Deprecation(D),\n }\n \n impl<D: Clone + Debug> DepNode<D> {\n@@ -260,6 +262,8 @@ impl<D: Clone + Debug> DepNode<D> {\n             }\n             DescribeDef(ref d) => op(d).map(DescribeDef),\n             DefSpan(ref d) => op(d).map(DefSpan),\n+            Stability(ref d) => op(d).map(Stability),\n+            Deprecation(ref d) => op(d).map(Deprecation),\n         }\n     }\n }"}, {"sha": "303c5059e7cf3d6136445d2a076dbe601243aeb4", "filename": "src/librustc/middle/cstore.rs", "status": "modified", "additions": 0, "deletions": 5, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/02274a8430f3d4ff7cf4b2391aaf4b3138f1b061/src%2Flibrustc%2Fmiddle%2Fcstore.rs", "raw_url": "https://github.com/rust-lang/rust/raw/02274a8430f3d4ff7cf4b2391aaf4b3138f1b061/src%2Flibrustc%2Fmiddle%2Fcstore.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fcstore.rs?ref=02274a8430f3d4ff7cf4b2391aaf4b3138f1b061", "patch": "@@ -38,7 +38,6 @@ use std::any::Any;\n use std::path::PathBuf;\n use std::rc::Rc;\n use syntax::ast;\n-use syntax::attr;\n use syntax::ext::base::SyntaxExtension;\n use syntax::symbol::Symbol;\n use syntax_pos::Span;\n@@ -180,8 +179,6 @@ pub trait CrateStore {\n     fn crate_data_as_rc_any(&self, krate: CrateNum) -> Rc<Any>;\n \n     // item info\n-    fn stability(&self, def: DefId) -> Option<attr::Stability>;\n-    fn deprecation(&self, def: DefId) -> Option<attr::Deprecation>;\n     fn visibility(&self, def: DefId) -> ty::Visibility;\n     fn visible_parent_map<'a>(&'a self) -> ::std::cell::Ref<'a, DefIdMap<DefId>>;\n     fn item_generics_cloned(&self, def: DefId) -> ty::Generics;\n@@ -306,8 +303,6 @@ impl CrateStore for DummyCrateStore {\n     fn crate_data_as_rc_any(&self, krate: CrateNum) -> Rc<Any>\n         { bug!(\"crate_data_as_rc_any\") }\n     // item info\n-    fn stability(&self, def: DefId) -> Option<attr::Stability> { bug!(\"stability\") }\n-    fn deprecation(&self, def: DefId) -> Option<attr::Deprecation> { bug!(\"deprecation\") }\n     fn visibility(&self, def: DefId) -> ty::Visibility { bug!(\"visibility\") }\n     fn visible_parent_map<'a>(&'a self) -> ::std::cell::Ref<'a, DefIdMap<DefId>> {\n         bug!(\"visible_parent_map\")"}, {"sha": "198f7420f5d2b7af19a79a06ccb481ff2e5c1522", "filename": "src/librustc/middle/stability.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/02274a8430f3d4ff7cf4b2391aaf4b3138f1b061/src%2Flibrustc%2Fmiddle%2Fstability.rs", "raw_url": "https://github.com/rust-lang/rust/raw/02274a8430f3d4ff7cf4b2391aaf4b3138f1b061/src%2Flibrustc%2Fmiddle%2Fstability.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fstability.rs?ref=02274a8430f3d4ff7cf4b2391aaf4b3138f1b061", "patch": "@@ -636,7 +636,7 @@ impl<'a, 'gcx, 'tcx> TyCtxt<'a, 'gcx, 'tcx> {\n         if id.is_local() {\n             None // The stability cache is filled partially lazily\n         } else {\n-            self.sess.cstore.stability(id).map(|st| self.intern_stability(st))\n+            self.stability(id).map(|st| self.intern_stability(st))\n         }\n     }\n \n@@ -645,7 +645,7 @@ impl<'a, 'gcx, 'tcx> TyCtxt<'a, 'gcx, 'tcx> {\n         if id.is_local() {\n             None // The stability cache is filled partially lazily\n         } else {\n-            self.sess.cstore.deprecation(id).map(DeprecationEntry::external)\n+            self.deprecation(id).map(DeprecationEntry::external)\n         }\n     }\n }"}, {"sha": "66df8dc050a245f5ee85081060dae82612821b0d", "filename": "src/librustc/ty/maps.rs", "status": "modified", "additions": 16, "deletions": 1, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/02274a8430f3d4ff7cf4b2391aaf4b3138f1b061/src%2Flibrustc%2Fty%2Fmaps.rs", "raw_url": "https://github.com/rust-lang/rust/raw/02274a8430f3d4ff7cf4b2391aaf4b3138f1b061/src%2Flibrustc%2Fty%2Fmaps.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fmaps.rs?ref=02274a8430f3d4ff7cf4b2391aaf4b3138f1b061", "patch": "@@ -33,6 +33,7 @@ use std::collections::BTreeMap;\n use std::ops::Deref;\n use std::rc::Rc;\n use syntax_pos::{Span, DUMMY_SP};\n+use syntax::attr;\n use syntax::symbol::Symbol;\n \n pub trait Key: Clone + Hash + Eq + Debug {\n@@ -320,6 +321,19 @@ impl<'tcx> QueryDescription for queries::def_span<'tcx> {\n     }\n }\n \n+\n+impl<'tcx> QueryDescription for queries::stability<'tcx> {\n+    fn describe(_: TyCtxt, _: DefId) -> String {\n+        bug!(\"stability\")\n+    }\n+}\n+\n+impl<'tcx> QueryDescription for queries::deprecation<'tcx> {\n+    fn describe(_: TyCtxt, _: DefId) -> String {\n+        bug!(\"deprecation\")\n+    }\n+}\n+\n impl<'tcx> QueryDescription for queries::item_body_nested_bodies<'tcx> {\n     fn describe(tcx: TyCtxt, def_id: DefId) -> String {\n         format!(\"nested item bodies of `{}`\", tcx.item_path_str(def_id))\n@@ -767,7 +781,8 @@ define_maps! { <'tcx>\n \n     [] describe_def: DescribeDef(DefId) -> Option<Def>,\n     [] def_span: DefSpan(DefId) -> Span,\n-\n+    [] stability: Stability(DefId) -> Option<attr::Stability>,\n+    [] deprecation: Deprecation(DefId) -> Option<attr::Deprecation>,\n     [] item_body_nested_bodies: metadata_dep_node(DefId) -> Rc<BTreeMap<hir::BodyId, hir::Body>>,\n     [] const_is_rvalue_promotable_to_static: metadata_dep_node(DefId) -> bool,\n     [] is_mir_available: metadata_dep_node(DefId) -> bool,"}, {"sha": "a1794ec2d82cace665364da1860a24d09c90c9bb", "filename": "src/librustc_metadata/cstore_impl.rs", "status": "modified", "additions": 2, "deletions": 10, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/02274a8430f3d4ff7cf4b2391aaf4b3138f1b061/src%2Flibrustc_metadata%2Fcstore_impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/02274a8430f3d4ff7cf4b2391aaf4b3138f1b061/src%2Flibrustc_metadata%2Fcstore_impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Fcstore_impl.rs?ref=02274a8430f3d4ff7cf4b2391aaf4b3138f1b061", "patch": "@@ -111,6 +111,8 @@ provide! { <'tcx> tcx, def_id, cdata\n     is_foreign_item => { cdata.is_foreign_item(def_id.index) }\n     describe_def => { cdata.get_def(def_id.index) }\n     def_span => { cdata.get_span(def_id.index, &tcx.sess) }\n+    stability => { cdata.get_stability(def_id.index) }\n+    deprecation => { cdata.get_deprecation(def_id.index) }\n     item_body_nested_bodies => {\n         let map: BTreeMap<_, _> = cdata.entry(def_id.index).ast.into_iter().flat_map(|ast| {\n             ast.decode(cdata).nested_bodies.decode(cdata).map(|body| (body.id(), body))\n@@ -133,16 +135,6 @@ impl CrateStore for cstore::CStore {\n         self.get_crate_data(krate)\n     }\n \n-    fn stability(&self, def: DefId) -> Option<attr::Stability> {\n-        self.dep_graph.read(DepNode::MetaData(def));\n-        self.get_crate_data(def.krate).get_stability(def.index)\n-    }\n-\n-    fn deprecation(&self, def: DefId) -> Option<attr::Deprecation> {\n-        self.dep_graph.read(DepNode::MetaData(def));\n-        self.get_crate_data(def.krate).get_deprecation(def.index)\n-    }\n-\n     fn visibility(&self, def: DefId) -> ty::Visibility {\n         self.dep_graph.read(DepNode::MetaData(def));\n         self.get_crate_data(def.krate).get_visibility(def.index)"}]}