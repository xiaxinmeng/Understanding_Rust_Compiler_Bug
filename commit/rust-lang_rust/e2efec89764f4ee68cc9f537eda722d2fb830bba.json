{"sha": "e2efec89764f4ee68cc9f537eda722d2fb830bba", "node_id": "MDY6Q29tbWl0NzI0NzEyOmUyZWZlYzg5NzY0ZjRlZTY4Y2M5ZjUzN2VkYTcyMmQyZmI4MzBiYmE=", "commit": {"author": {"name": "Mark Rousskov", "email": "mark.simulacrum@gmail.com", "date": "2020-10-15T13:28:27Z"}, "committer": {"name": "Mark Rousskov", "email": "mark.simulacrum@gmail.com", "date": "2020-10-15T13:42:06Z"}, "message": "Prevent miscompilation in trivial loop {}\n\nIdeally, we would want to handle a broader set of cases to fully fix the\nunderlying bug here. That is currently relatively expensive at compile and\nruntime, so we don't do that for now.", "tree": {"sha": "6a7b35e9f9fc556bef1b19acb8e36440b474d3cb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6a7b35e9f9fc556bef1b19acb8e36440b474d3cb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e2efec89764f4ee68cc9f537eda722d2fb830bba", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e2efec89764f4ee68cc9f537eda722d2fb830bba", "html_url": "https://github.com/rust-lang/rust/commit/e2efec89764f4ee68cc9f537eda722d2fb830bba", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e2efec89764f4ee68cc9f537eda722d2fb830bba/comments", "author": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7f587168102498a488abf608a86c7fdfa62fb7bb", "url": "https://api.github.com/repos/rust-lang/rust/commits/7f587168102498a488abf608a86c7fdfa62fb7bb", "html_url": "https://github.com/rust-lang/rust/commit/7f587168102498a488abf608a86c7fdfa62fb7bb"}], "stats": {"total": 51, "additions": 42, "deletions": 9}, "files": [{"sha": "368aba6eae0d74cf2ccb9199b5d7143f5176dc51", "filename": "compiler/rustc_codegen_llvm/src/intrinsic.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/e2efec89764f4ee68cc9f537eda722d2fb830bba/compiler%2Frustc_codegen_llvm%2Fsrc%2Fintrinsic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e2efec89764f4ee68cc9f537eda722d2fb830bba/compiler%2Frustc_codegen_llvm%2Fsrc%2Fintrinsic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fintrinsic.rs?ref=e2efec89764f4ee68cc9f537eda722d2fb830bba", "patch": "@@ -334,8 +334,8 @@ impl IntrinsicCallMethods<'tcx> for Builder<'a, 'll, 'tcx> {\n         self.call(expect, &[cond, self.const_bool(expected)], None)\n     }\n \n-    fn sideeffect(&mut self) {\n-        if self.tcx.sess.opts.debugging_opts.insert_sideeffect {\n+    fn sideeffect(&mut self, unconditional: bool) {\n+        if unconditional || self.tcx.sess.opts.debugging_opts.insert_sideeffect {\n             let fnname = self.get_intrinsic(&(\"llvm.sideeffect\"));\n             self.call(fnname, &[], None);\n         }\n@@ -390,7 +390,7 @@ fn codegen_msvc_try(\n ) {\n     let llfn = get_rust_try_fn(bx, &mut |mut bx| {\n         bx.set_personality_fn(bx.eh_personality());\n-        bx.sideeffect();\n+        bx.sideeffect(false);\n \n         let mut normal = bx.build_sibling_block(\"normal\");\n         let mut catchswitch = bx.build_sibling_block(\"catchswitch\");\n@@ -553,7 +553,7 @@ fn codegen_gnu_try(\n         //      call %catch_func(%data, %ptr)\n         //      ret 1\n \n-        bx.sideeffect();\n+        bx.sideeffect(false);\n \n         let mut then = bx.build_sibling_block(\"then\");\n         let mut catch = bx.build_sibling_block(\"catch\");\n@@ -615,7 +615,7 @@ fn codegen_emcc_try(\n         //      call %catch_func(%data, %catch_data)\n         //      ret 1\n \n-        bx.sideeffect();\n+        bx.sideeffect(false);\n \n         let mut then = bx.build_sibling_block(\"then\");\n         let mut catch = bx.build_sibling_block(\"catch\");"}, {"sha": "1e61f3ba2df07d642070e6a7317d06da6dd81a85", "filename": "compiler/rustc_codegen_ssa/src/mir/block.rs", "status": "modified", "additions": 18, "deletions": 2, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/e2efec89764f4ee68cc9f537eda722d2fb830bba/compiler%2Frustc_codegen_ssa%2Fsrc%2Fmir%2Fblock.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e2efec89764f4ee68cc9f537eda722d2fb830bba/compiler%2Frustc_codegen_ssa%2Fsrc%2Fmir%2Fblock.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fmir%2Fblock.rs?ref=e2efec89764f4ee68cc9f537eda722d2fb830bba", "patch": "@@ -163,7 +163,7 @@ impl<'a, 'tcx> TerminatorCodegenHelper<'tcx> {\n                 target <= self.bb\n                     && target.start_location().is_predecessor_of(self.bb.start_location(), mir)\n             }) {\n-                bx.sideeffect();\n+                bx.sideeffect(false);\n             }\n         }\n     }\n@@ -964,7 +964,23 @@ impl<'a, 'tcx, Bx: BuilderMethods<'a, 'tcx>> FunctionCx<'a, 'tcx, Bx> {\n             }\n \n             mir::TerminatorKind::Goto { target } => {\n-                helper.maybe_sideeffect(self.mir, &mut bx, &[target]);\n+                if bb == target {\n+                    // This is an unconditional branch back to this same basic\n+                    // block. That means we have something like a `loop {}`\n+                    // statement. Currently LLVM miscompiles this because it\n+                    // assumes forward progress. We want to prevent this in all\n+                    // cases, but that has a fairly high cost to compile times\n+                    // currently. Instead, try to handle this specific case\n+                    // which comes up commonly in practice (e.g., in embedded\n+                    // code).\n+                    //\n+                    // The `true` here means we insert side effects regardless\n+                    // of -Zinsert-sideeffect being passed on unconditional\n+                    // branching to the same basic block.\n+                    bx.sideeffect(true);\n+                } else {\n+                    helper.maybe_sideeffect(self.mir, &mut bx, &[target]);\n+                }\n                 helper.funclet_br(self, &mut bx, target);\n             }\n "}, {"sha": "bff263567bf6b1d8212a434dcffcd87b43097493", "filename": "compiler/rustc_codegen_ssa/src/mir/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e2efec89764f4ee68cc9f537eda722d2fb830bba/compiler%2Frustc_codegen_ssa%2Fsrc%2Fmir%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e2efec89764f4ee68cc9f537eda722d2fb830bba/compiler%2Frustc_codegen_ssa%2Fsrc%2Fmir%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fmir%2Fmod.rs?ref=e2efec89764f4ee68cc9f537eda722d2fb830bba", "patch": "@@ -153,7 +153,7 @@ pub fn codegen_mir<'a, 'tcx, Bx: BuilderMethods<'a, 'tcx>>(\n         bx.set_personality_fn(cx.eh_personality());\n     }\n \n-    bx.sideeffect();\n+    bx.sideeffect(false);\n \n     let cleanup_kinds = analyze::cleanup_kinds(&mir);\n     // Allocate a `Block` for every basic block, except"}, {"sha": "ac3c99f9c908db253b3dcd71bc462321848c93fb", "filename": "compiler/rustc_codegen_ssa/src/traits/intrinsic.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/e2efec89764f4ee68cc9f537eda722d2fb830bba/compiler%2Frustc_codegen_ssa%2Fsrc%2Ftraits%2Fintrinsic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e2efec89764f4ee68cc9f537eda722d2fb830bba/compiler%2Frustc_codegen_ssa%2Fsrc%2Ftraits%2Fintrinsic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Ftraits%2Fintrinsic.rs?ref=e2efec89764f4ee68cc9f537eda722d2fb830bba", "patch": "@@ -20,7 +20,9 @@ pub trait IntrinsicCallMethods<'tcx>: BackendTypes {\n     fn abort(&mut self);\n     fn assume(&mut self, val: Self::Value);\n     fn expect(&mut self, cond: Self::Value, expected: bool) -> Self::Value;\n-    fn sideeffect(&mut self);\n+    /// Normally, sideeffect is only emitted if -Zinsert-sideeffect is passed;\n+    /// in some cases though we want to emit it regardless.\n+    fn sideeffect(&mut self, unconditional: bool);\n     /// Trait method used to inject `va_start` on the \"spoofed\" `VaListImpl` in\n     /// Rust defined C-variadic functions.\n     fn va_start(&mut self, val: Self::Value) -> Self::Value;"}, {"sha": "e54298eed059ed69370296d1c37a6e603d291234", "filename": "src/test/codegen/loop.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/e2efec89764f4ee68cc9f537eda722d2fb830bba/src%2Ftest%2Fcodegen%2Floop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e2efec89764f4ee68cc9f537eda722d2fb830bba/src%2Ftest%2Fcodegen%2Floop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Floop.rs?ref=e2efec89764f4ee68cc9f537eda722d2fb830bba", "patch": "@@ -0,0 +1,15 @@\n+// compile-flags: -C opt-level=3\n+\n+#![crate_type = \"lib\"]\n+\n+// CHECK-LABEL: @check_loop\n+#[no_mangle]\n+pub fn check_loop() -> u8 {\n+    // CHECK-NOT: unreachable\n+    call_looper()\n+}\n+\n+#[no_mangle]\n+fn call_looper() -> ! {\n+    loop {}\n+}"}]}