{"sha": "84c28041b486f229431b8c88fa24cb03e05fb70c", "node_id": "C_kwDOAAsO6NoAKDg0YzI4MDQxYjQ4NmYyMjk0MzFiOGM4OGZhMjRjYjAzZTA1ZmI3MGM", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-02-09T22:29:57Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-02-09T22:29:57Z"}, "message": "Rollup merge of #93753 - jeremyBanks:main-conflict, r=petrochenkov\n\nComplete removal of #[main] attribute from compiler\n\nresolves #93786\n\n---\n\nThe `#[main]` attribute was mostly removed from the language in #84217, but not completely. It is still recognized as a builtin attribute by the compiler, but it has no effect. However, this no-op attribute is no longer gated by `#[feature(main)]` (which no longer exists), so it's possible to include it in code *on stable* without any errors, which seems unintentional. For example, the following code is accepted ([playground link](https://play.rust-lang.org/?version=stable&mode=debug&edition=2021&code=%23%5Bmain%5D%0Afn%20main()%20%7B%0A%20%20%20%20println!(%22hello%20world%22)%3B%0A%7D%0A)).\n\n```rust\n#[main]\nfn main() {\n    println!(\"hello world\");\n}\n```\n\nAside from that oddity, the existence of this attribute causes code like the following to fail ([playground link](https://play.rust-lang.org/?version=stable&mode=debug&edition=2021&code=use%20tokio%3A%3Amain%3B%0A%0A%23%5Bmain%5D%0Afn%20main()%20%7B%0A%20%20%20%20println!(%22hello%20world%22)%3B%0A%7D%0A)). According https://github.com/rust-lang/rust/pull/84062#issuecomment-825038275, the removal of `#[main]` was expected to eliminate this conflict (previously reported as #62127).\n\n```rust\nuse tokio::main;\n\n#[main]\nfn main() {\n    println!(\"hello world\");\n}\n```\n\n```\nerror[E0659]: `main` is ambiguous\n --> src/main.rs:3:3\n  |\n3 | #[main]\n  |   ^^^^ ambiguous name\n  |\n  = note: ambiguous because of a name conflict with a builtin attribute\n  = note: `main` could refer to a built-in attribute\n```\n\n[This error message can be confusing](https://stackoverflow.com/q/71024443/1114), as the mostly-removed `#[main]` attribute is not mentioned in any documentation.\n\nSince the current availability of `#[main]` on stable seems unintentional, and to needlessly block use of the `main` identifier in the attribute namespace, this PR finishes removing the `#[main]` attribute as described in https://github.com/rust-lang/rust/issues/29634#issuecomment-274951753 by deleting it from `builtin_attrs.rs`, and adds two test cases to ensure that the attribute is no longer accepted and no longer conflicts with other attributes imported as `main`.", "tree": {"sha": "d7b64ee9a30c1f4f15003ab24268105b123a7e42", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d7b64ee9a30c1f4f15003ab24268105b123a7e42"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/84c28041b486f229431b8c88fa24cb03e05fb70c", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJiBEBlCRBK7hj4Ov3rIwAA1mAIAB+fFCmBcSbfRFAu6naNS60x\nP5L46na4DVIzt0XgoCeUqFYBYJqKpA9IYE58eyl1eFoCZ+cJg/xfl24+JCOKerZ1\nyesS2Wf3pcIqI9XZw0SoIiSZYbmWC8SgYcCKJ7UXehWlXbdI2J3KEYhLBz3iAM1Y\nEjZty0BbLamYfl5JtRiITHLWN7fOZzWfVXOud4rAqoBwX+o27Ua1f3eqkrA3eVd8\niBReGdofUL78Icb+yk8ZJNitb6hT6RSdMHgp5ezeb6RdyMLyBXJBp5NQEg74aT68\ngOCS8NR9cc36M/lQmFQnbe5EhRhunPH6wsvpfX3jZArn7van9BsA6HACdoCMjz4=\n=hfVC\n-----END PGP SIGNATURE-----\n", "payload": "tree d7b64ee9a30c1f4f15003ab24268105b123a7e42\nparent 6d40850e09966644d7c47742638fa53e4da7af1c\nparent 475e4eeb6557af820ee2b48f213f178eca5e11ce\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1644445797 +0100\ncommitter GitHub <noreply@github.com> 1644445797 +0100\n\nRollup merge of #93753 - jeremyBanks:main-conflict, r=petrochenkov\n\nComplete removal of #[main] attribute from compiler\n\nresolves #93786\n\n---\n\nThe `#[main]` attribute was mostly removed from the language in #84217, but not completely. It is still recognized as a builtin attribute by the compiler, but it has no effect. However, this no-op attribute is no longer gated by `#[feature(main)]` (which no longer exists), so it's possible to include it in code *on stable* without any errors, which seems unintentional. For example, the following code is accepted ([playground link](https://play.rust-lang.org/?version=stable&mode=debug&edition=2021&code=%23%5Bmain%5D%0Afn%20main()%20%7B%0A%20%20%20%20println!(%22hello%20world%22)%3B%0A%7D%0A)).\n\n```rust\n#[main]\nfn main() {\n    println!(\"hello world\");\n}\n```\n\nAside from that oddity, the existence of this attribute causes code like the following to fail ([playground link](https://play.rust-lang.org/?version=stable&mode=debug&edition=2021&code=use%20tokio%3A%3Amain%3B%0A%0A%23%5Bmain%5D%0Afn%20main()%20%7B%0A%20%20%20%20println!(%22hello%20world%22)%3B%0A%7D%0A)). According https://github.com/rust-lang/rust/pull/84062#issuecomment-825038275, the removal of `#[main]` was expected to eliminate this conflict (previously reported as #62127).\n\n```rust\nuse tokio::main;\n\n#[main]\nfn main() {\n    println!(\"hello world\");\n}\n```\n\n```\nerror[E0659]: `main` is ambiguous\n --> src/main.rs:3:3\n  |\n3 | #[main]\n  |   ^^^^ ambiguous name\n  |\n  = note: ambiguous because of a name conflict with a builtin attribute\n  = note: `main` could refer to a built-in attribute\n```\n\n[This error message can be confusing](https://stackoverflow.com/q/71024443/1114), as the mostly-removed `#[main]` attribute is not mentioned in any documentation.\n\nSince the current availability of `#[main]` on stable seems unintentional, and to needlessly block use of the `main` identifier in the attribute namespace, this PR finishes removing the `#[main]` attribute as described in https://github.com/rust-lang/rust/issues/29634#issuecomment-274951753 by deleting it from `builtin_attrs.rs`, and adds two test cases to ensure that the attribute is no longer accepted and no longer conflicts with other attributes imported as `main`.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/84c28041b486f229431b8c88fa24cb03e05fb70c", "html_url": "https://github.com/rust-lang/rust/commit/84c28041b486f229431b8c88fa24cb03e05fb70c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/84c28041b486f229431b8c88fa24cb03e05fb70c/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6d40850e09966644d7c47742638fa53e4da7af1c", "url": "https://api.github.com/repos/rust-lang/rust/commits/6d40850e09966644d7c47742638fa53e4da7af1c", "html_url": "https://github.com/rust-lang/rust/commit/6d40850e09966644d7c47742638fa53e4da7af1c"}, {"sha": "475e4eeb6557af820ee2b48f213f178eca5e11ce", "url": "https://api.github.com/repos/rust-lang/rust/commits/475e4eeb6557af820ee2b48f213f178eca5e11ce", "html_url": "https://github.com/rust-lang/rust/commit/475e4eeb6557af820ee2b48f213f178eca5e11ce"}], "stats": {"total": 36, "additions": 35, "deletions": 1}, "files": [{"sha": "599ac7f33104c308c1e239f9ff11510acaebd9eb", "filename": "compiler/rustc_feature/src/builtin_attrs.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/84c28041b486f229431b8c88fa24cb03e05fb70c/compiler%2Frustc_feature%2Fsrc%2Fbuiltin_attrs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84c28041b486f229431b8c88fa24cb03e05fb70c/compiler%2Frustc_feature%2Fsrc%2Fbuiltin_attrs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_feature%2Fsrc%2Fbuiltin_attrs.rs?ref=84c28041b486f229431b8c88fa24cb03e05fb70c", "patch": "@@ -339,7 +339,6 @@ pub const BUILTIN_ATTRIBUTES: &[BuiltinAttribute] = &[\n     ),\n \n     // Entry point:\n-    ungated!(main, Normal, template!(Word), WarnFollowing),\n     ungated!(start, Normal, template!(Word), WarnFollowing),\n     ungated!(no_start, CrateLevel, template!(Word), WarnFollowing),\n     ungated!(no_main, CrateLevel, template!(Word), WarnFollowing),"}, {"sha": "0e887469d4466ddb49104bd472b20f089841163e", "filename": "src/test/ui/attributes/main-removed-1.rs", "status": "added", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/84c28041b486f229431b8c88fa24cb03e05fb70c/src%2Ftest%2Fui%2Fattributes%2Fmain-removed-1.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84c28041b486f229431b8c88fa24cb03e05fb70c/src%2Ftest%2Fui%2Fattributes%2Fmain-removed-1.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fattributes%2Fmain-removed-1.rs?ref=84c28041b486f229431b8c88fa24cb03e05fb70c", "patch": "@@ -0,0 +1,2 @@\n+#[main]  //~ ERROR cannot find attribute `main` in this scope\n+fn main() {}"}, {"sha": "2422c5c3b623946e7e43c92769c97218552138eb", "filename": "src/test/ui/attributes/main-removed-1.stderr", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/84c28041b486f229431b8c88fa24cb03e05fb70c/src%2Ftest%2Fui%2Fattributes%2Fmain-removed-1.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/84c28041b486f229431b8c88fa24cb03e05fb70c/src%2Ftest%2Fui%2Fattributes%2Fmain-removed-1.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fattributes%2Fmain-removed-1.stderr?ref=84c28041b486f229431b8c88fa24cb03e05fb70c", "patch": "@@ -0,0 +1,10 @@\n+error: cannot find attribute `main` in this scope\n+  --> $DIR/main-removed-1.rs:1:3\n+   |\n+LL | #[main]\n+   |   ^^^^\n+   |\n+   = note: `main` is in scope, but it is a function, not an attribute\n+\n+error: aborting due to previous error\n+"}, {"sha": "196b5be2dd0864164b3257147904ffa570bb202c", "filename": "src/test/ui/attributes/main-removed-2/auxiliary/tokyo.rs", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/84c28041b486f229431b8c88fa24cb03e05fb70c/src%2Ftest%2Fui%2Fattributes%2Fmain-removed-2%2Fauxiliary%2Ftokyo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84c28041b486f229431b8c88fa24cb03e05fb70c/src%2Ftest%2Fui%2Fattributes%2Fmain-removed-2%2Fauxiliary%2Ftokyo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fattributes%2Fmain-removed-2%2Fauxiliary%2Ftokyo.rs?ref=84c28041b486f229431b8c88fa24cb03e05fb70c", "patch": "@@ -0,0 +1,12 @@\n+// force-host\n+// no-prefer-dynamic\n+\n+#![crate_type = \"proc-macro\"]\n+\n+extern crate proc_macro;\n+use proc_macro::TokenStream;\n+\n+#[proc_macro_attribute]\n+pub fn main(_: TokenStream, input: TokenStream) -> TokenStream {\n+    \"fn main() { println!(\\\"Hello Tokyo!\\\"); }\".parse().unwrap()\n+}"}, {"sha": "e8fecf825fa83b6f7e4e08162a2c6d1814e1cd16", "filename": "src/test/ui/attributes/main-removed-2/main.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/84c28041b486f229431b8c88fa24cb03e05fb70c/src%2Ftest%2Fui%2Fattributes%2Fmain-removed-2%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84c28041b486f229431b8c88fa24cb03e05fb70c/src%2Ftest%2Fui%2Fattributes%2Fmain-removed-2%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fattributes%2Fmain-removed-2%2Fmain.rs?ref=84c28041b486f229431b8c88fa24cb03e05fb70c", "patch": "@@ -0,0 +1,11 @@\n+// run-pass\n+// aux-build:tokyo.rs\n+// compile-flags:--extern tokyo\n+// edition:2021\n+\n+use tokyo::main;\n+\n+#[main]\n+fn main() {\n+    panic!(\"the #[main] macro should replace this with non-panicking code\")\n+}"}]}