{"sha": "fea10c435d70ce1b04885f88b8abc776f22aa2af", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZlYTEwYzQzNWQ3MGNlMWIwNDg4NWY4OGI4YWJjNzc2ZjIyYWEyYWY=", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2019-06-08T09:32:25Z"}, "committer": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2019-06-08T09:32:25Z"}, "message": "checktools: unify grepping the TOOLSTATE file", "tree": {"sha": "6cf78ee6dbc2218230c0fc1694a19ede4acf80ed", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6cf78ee6dbc2218230c0fc1694a19ede4acf80ed"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fea10c435d70ce1b04885f88b8abc776f22aa2af", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fea10c435d70ce1b04885f88b8abc776f22aa2af", "html_url": "https://github.com/rust-lang/rust/commit/fea10c435d70ce1b04885f88b8abc776f22aa2af", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fea10c435d70ce1b04885f88b8abc776f22aa2af/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ca1bcfdde3f19afd68ef808cecf2ce56d08d5df4", "url": "https://api.github.com/repos/rust-lang/rust/commits/ca1bcfdde3f19afd68ef808cecf2ce56d08d5df4", "html_url": "https://github.com/rust-lang/rust/commit/ca1bcfdde3f19afd68ef808cecf2ce56d08d5df4"}], "stats": {"total": 13, "additions": 10, "deletions": 3}, "files": [{"sha": "978732e3c089f2b5b19eed0cc8794edc5e45f478", "filename": "src/ci/docker/x86_64-gnu-tools/checktools.sh", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/fea10c435d70ce1b04885f88b8abc776f22aa2af/src%2Fci%2Fdocker%2Fx86_64-gnu-tools%2Fchecktools.sh", "raw_url": "https://github.com/rust-lang/rust/raw/fea10c435d70ce1b04885f88b8abc776f22aa2af/src%2Fci%2Fdocker%2Fx86_64-gnu-tools%2Fchecktools.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fx86_64-gnu-tools%2Fchecktools.sh?ref=fea10c435d70ce1b04885f88b8abc776f22aa2af", "patch": "@@ -35,12 +35,17 @@ set -e\n cat \"$TOOLSTATE_FILE\"\n echo\n \n+# This function checks if a particular tool is *not* in status \"test-pass\".\n+check_tool_failed() {\n+    grep -vq '\"'\"$1\"'\":\"test-pass\"' \"$TOOLSTATE_FILE\"\n+}\n+\n # This function checks that if a tool's submodule changed, the tool's state must improve\n verify_status() {\n     echo \"Verifying status of $1...\"\n     if echo \"$CHANGED_FILES\" | grep -q \"^M[[:blank:]]$2$\"; then\n         echo \"This PR updated '$2', verifying if status is 'test-pass'...\"\n-        if grep -vq '\"'\"$1\"'\":\"test-pass\"' \"$TOOLSTATE_FILE\"; then\n+        if check_tool_failed \"$1\"; then\n             echo\n             echo \"\u26a0\ufe0f We detected that this PR updated '$1', but its tests failed.\"\n             echo\n@@ -55,14 +60,16 @@ verify_status() {\n     fi\n }\n \n-# deduplicates the submodule check and the assertion that on beta some tools MUST be passing\n+# deduplicates the submodule check and the assertion that on beta some tools MUST be passing.\n+# $1 should be \"submodule_changed\" to only check tools that got changed by this PR,\n+# or \"beta_required\" to check all tools that have $2 set to \"beta\".\n check_dispatch() {\n     if [ \"$1\" = submodule_changed ]; then\n         # ignore $2 (branch id)\n         verify_status $3 $4\n     elif [ \"$2\" = beta ]; then\n         echo \"Requiring test passing for $3...\"\n-        if grep -q '\"'\"$3\"'\":\"\\(test\\|build\\)-fail\"' \"$TOOLSTATE_FILE\"; then\n+        if check_tool_failed \"$3\"; then\n             exit 4\n         fi\n     fi"}]}