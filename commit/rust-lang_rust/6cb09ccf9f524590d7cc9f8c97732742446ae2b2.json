{"sha": "6cb09ccf9f524590d7cc9f8c97732742446ae2b2", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZjYjA5Y2NmOWY1MjQ1OTBkN2NjOWY4Yzk3NzMyNzQyNDQ2YWUyYjI=", "commit": {"author": {"name": "mark", "email": "markm@cs.wisc.edu", "date": "2018-07-14T04:40:29Z"}, "committer": {"name": "mark", "email": "markm@cs.wisc.edu", "date": "2018-07-24T02:55:51Z"}, "message": "dump lints _after_ parsing macros", "tree": {"sha": "be8a3be455c2faa6f3923ce43132823dacfb51dd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/be8a3be455c2faa6f3923ce43132823dacfb51dd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6cb09ccf9f524590d7cc9f8c97732742446ae2b2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6cb09ccf9f524590d7cc9f8c97732742446ae2b2", "html_url": "https://github.com/rust-lang/rust/commit/6cb09ccf9f524590d7cc9f8c97732742446ae2b2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6cb09ccf9f524590d7cc9f8c97732742446ae2b2/comments", "author": {"login": "mark-i-m", "id": 8827840, "node_id": "MDQ6VXNlcjg4Mjc4NDA=", "avatar_url": "https://avatars.githubusercontent.com/u/8827840?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mark-i-m", "html_url": "https://github.com/mark-i-m", "followers_url": "https://api.github.com/users/mark-i-m/followers", "following_url": "https://api.github.com/users/mark-i-m/following{/other_user}", "gists_url": "https://api.github.com/users/mark-i-m/gists{/gist_id}", "starred_url": "https://api.github.com/users/mark-i-m/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mark-i-m/subscriptions", "organizations_url": "https://api.github.com/users/mark-i-m/orgs", "repos_url": "https://api.github.com/users/mark-i-m/repos", "events_url": "https://api.github.com/users/mark-i-m/events{/privacy}", "received_events_url": "https://api.github.com/users/mark-i-m/received_events", "type": "User", "site_admin": false}, "committer": {"login": "mark-i-m", "id": 8827840, "node_id": "MDQ6VXNlcjg4Mjc4NDA=", "avatar_url": "https://avatars.githubusercontent.com/u/8827840?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mark-i-m", "html_url": "https://github.com/mark-i-m", "followers_url": "https://api.github.com/users/mark-i-m/followers", "following_url": "https://api.github.com/users/mark-i-m/following{/other_user}", "gists_url": "https://api.github.com/users/mark-i-m/gists{/gist_id}", "starred_url": "https://api.github.com/users/mark-i-m/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mark-i-m/subscriptions", "organizations_url": "https://api.github.com/users/mark-i-m/orgs", "repos_url": "https://api.github.com/users/mark-i-m/repos", "events_url": "https://api.github.com/users/mark-i-m/events{/privacy}", "received_events_url": "https://api.github.com/users/mark-i-m/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b206aedb1bbdd45578668afd7f5589b1b812fd22", "url": "https://api.github.com/repos/rust-lang/rust/commits/b206aedb1bbdd45578668afd7f5589b1b812fd22", "html_url": "https://github.com/rust-lang/rust/commit/b206aedb1bbdd45578668afd7f5589b1b812fd22"}], "stats": {"total": 22, "additions": 12, "deletions": 10}, "files": [{"sha": "91392ab013d6c2234cad016a3536d9ceee7b2d07", "filename": "src/librustc_driver/driver.rs", "status": "modified", "additions": 9, "deletions": 7, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/6cb09ccf9f524590d7cc9f8c97732742446ae2b2/src%2Flibrustc_driver%2Fdriver.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6cb09ccf9f524590d7cc9f8c97732742446ae2b2/src%2Flibrustc_driver%2Fdriver.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_driver%2Fdriver.rs?ref=6cb09ccf9f524590d7cc9f8c97732742446ae2b2", "patch": "@@ -697,13 +697,6 @@ pub fn phase_1_parse_input<'a>(\n         hir_stats::print_ast_stats(&krate, \"PRE EXPANSION AST STATS\");\n     }\n \n-    // Add all buffered lints from the `ParseSess` to the `Session`.\n-    let mut parse_sess_buffered = sess.parse_sess.buffered_lints.borrow_mut();\n-    for BufferedEarlyLint{id, span, msg, lint_id} in parse_sess_buffered.drain(..) {\n-        let lint = lint::Lint::from_parser_lint_id(lint_id);\n-        sess.buffer_lint(lint, id, span, &msg);\n-    }\n-\n     Ok(krate)\n }\n \n@@ -1074,6 +1067,15 @@ where\n         )\n     });\n \n+    // Add all buffered lints from the `ParseSess` to the `Session`.\n+    sess.parse_sess.buffered_lints.with_lock(|buffered_lints| {\n+        info!(\"{} parse sess buffered_lints\", buffered_lints.len());\n+        for BufferedEarlyLint{id, span, msg, lint_id} in buffered_lints.drain(..) {\n+            let lint = lint::Lint::from_parser_lint_id(lint_id);\n+            sess.buffer_lint(lint, id, span, &msg);\n+        }\n+    });\n+\n     // Done with macro expansion!\n \n     after_expand(&krate)?;"}, {"sha": "d029509f0c12d1bac578c6b918ebbebbc424b379", "filename": "src/libsyntax/parse/mod.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/6cb09ccf9f524590d7cc9f8c97732742446ae2b2/src%2Flibsyntax%2Fparse%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6cb09ccf9f524590d7cc9f8c97732742446ae2b2/src%2Flibsyntax%2Fparse%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fparse%2Fmod.rs?ref=6cb09ccf9f524590d7cc9f8c97732742446ae2b2", "patch": "@@ -96,14 +96,14 @@ impl ParseSess {\n         id: NodeId,\n         msg: &str,\n     ) {\n-        self.buffered_lints\n-            .borrow_mut()\n-            .push(BufferedEarlyLint{\n+        self.buffered_lints.with_lock(|buffered_lints| {\n+            buffered_lints.push(BufferedEarlyLint{\n                 span: span.into(),\n                 id,\n                 msg: msg.into(),\n                 lint_id,\n             });\n+        });\n     }\n }\n "}]}