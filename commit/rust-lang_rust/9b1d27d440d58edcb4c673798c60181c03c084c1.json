{"sha": "9b1d27d440d58edcb4c673798c60181c03c084c1", "node_id": "MDY6Q29tbWl0NzI0NzEyOjliMWQyN2Q0NDBkNThlZGNiNGM2NzM3OThjNjAxODFjMDNjMDg0YzE=", "commit": {"author": {"name": "Arpad Borsos", "email": "arpad.borsos@googlemail.com", "date": "2021-01-22T09:54:53Z"}, "committer": {"name": "Arpad Borsos", "email": "arpad.borsos@googlemail.com", "date": "2021-01-23T17:52:51Z"}, "message": "Add option to control doctest run directory\n\nThis option will allow splitting the compile-time from the run-time\ndirectory of doctest invocations and is one step to solve\nhttps://github.com/rust-lang/cargo/issues/8993#issuecomment-760088944", "tree": {"sha": "717a0c077949be677e6f8921dcce4274f3cae643", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/717a0c077949be677e6f8921dcce4274f3cae643"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9b1d27d440d58edcb4c673798c60181c03c084c1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9b1d27d440d58edcb4c673798c60181c03c084c1", "html_url": "https://github.com/rust-lang/rust/commit/9b1d27d440d58edcb4c673798c60181c03c084c1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9b1d27d440d58edcb4c673798c60181c03c084c1/comments", "author": {"login": "Swatinem", "id": 580492, "node_id": "MDQ6VXNlcjU4MDQ5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/580492?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Swatinem", "html_url": "https://github.com/Swatinem", "followers_url": "https://api.github.com/users/Swatinem/followers", "following_url": "https://api.github.com/users/Swatinem/following{/other_user}", "gists_url": "https://api.github.com/users/Swatinem/gists{/gist_id}", "starred_url": "https://api.github.com/users/Swatinem/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Swatinem/subscriptions", "organizations_url": "https://api.github.com/users/Swatinem/orgs", "repos_url": "https://api.github.com/users/Swatinem/repos", "events_url": "https://api.github.com/users/Swatinem/events{/privacy}", "received_events_url": "https://api.github.com/users/Swatinem/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Swatinem", "id": 580492, "node_id": "MDQ6VXNlcjU4MDQ5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/580492?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Swatinem", "html_url": "https://github.com/Swatinem", "followers_url": "https://api.github.com/users/Swatinem/followers", "following_url": "https://api.github.com/users/Swatinem/following{/other_user}", "gists_url": "https://api.github.com/users/Swatinem/gists{/gist_id}", "starred_url": "https://api.github.com/users/Swatinem/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Swatinem/subscriptions", "organizations_url": "https://api.github.com/users/Swatinem/orgs", "repos_url": "https://api.github.com/users/Swatinem/repos", "events_url": "https://api.github.com/users/Swatinem/events{/privacy}", "received_events_url": "https://api.github.com/users/Swatinem/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "25f39fe80293f77bd86f64a1261a3e2c0ca23847", "url": "https://api.github.com/repos/rust-lang/rust/commits/25f39fe80293f77bd86f64a1261a3e2c0ca23847", "html_url": "https://github.com/rust-lang/rust/commit/25f39fe80293f77bd86f64a1261a3e2c0ca23847"}], "stats": {"total": 51, "additions": 51, "deletions": 0}, "files": [{"sha": "508bed072e61de47695cd7b64fa9f6a853d3498f", "filename": "src/librustdoc/config.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/9b1d27d440d58edcb4c673798c60181c03c084c1/src%2Flibrustdoc%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b1d27d440d58edcb4c673798c60181c03c084c1/src%2Flibrustdoc%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fconfig.rs?ref=9b1d27d440d58edcb4c673798c60181c03c084c1", "patch": "@@ -103,6 +103,8 @@ crate struct Options {\n     crate should_test: bool,\n     /// List of arguments to pass to the test harness, if running tests.\n     crate test_args: Vec<String>,\n+    /// The working directory in which to run tests.\n+    crate test_run_directory: Option<PathBuf>,\n     /// Optional path to persist the doctest executables to, defaults to a\n     /// temporary directory if not set.\n     crate persist_doctests: Option<PathBuf>,\n@@ -175,6 +177,7 @@ impl fmt::Debug for Options {\n             .field(\"lint_cap\", &self.lint_cap)\n             .field(\"should_test\", &self.should_test)\n             .field(\"test_args\", &self.test_args)\n+            .field(\"test_run_directory\", &self.test_run_directory)\n             .field(\"persist_doctests\", &self.persist_doctests)\n             .field(\"default_passes\", &self.default_passes)\n             .field(\"manual_passes\", &self.manual_passes)\n@@ -572,6 +575,7 @@ impl Options {\n         let enable_index_page = matches.opt_present(\"enable-index-page\") || index_page.is_some();\n         let static_root_path = matches.opt_str(\"static-root-path\");\n         let generate_search_filter = !matches.opt_present(\"disable-per-crate-search\");\n+        let test_run_directory = matches.opt_str(\"test-run-directory\").map(PathBuf::from);\n         let persist_doctests = matches.opt_str(\"persist-doctests\").map(PathBuf::from);\n         let test_builder = matches.opt_str(\"test-builder\").map(PathBuf::from);\n         let codegen_options_strs = matches.opt_strs(\"C\");\n@@ -613,6 +617,7 @@ impl Options {\n             display_warnings,\n             show_coverage,\n             crate_version,\n+            test_run_directory,\n             persist_doctests,\n             runtool,\n             runtool_args,"}, {"sha": "09cbd94e4ac3f10ba5871b52cb75189e25f1c654", "filename": "src/librustdoc/doctest.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/9b1d27d440d58edcb4c673798c60181c03c084c1/src%2Flibrustdoc%2Fdoctest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b1d27d440d58edcb4c673798c60181c03c084c1/src%2Flibrustdoc%2Fdoctest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fdoctest.rs?ref=9b1d27d440d58edcb4c673798c60181c03c084c1", "patch": "@@ -365,6 +365,9 @@ fn run_test(\n     } else {\n         cmd = Command::new(output_file);\n     }\n+    if let Some(run_directory) = options.test_run_directory {\n+        cmd.current_dir(run_directory);\n+    }\n \n     match cmd.output() {\n         Err(e) => return Err(TestFailure::ExecutionError(e)),"}, {"sha": "d823f789013ffbd14d81d133b398e1ead6ee9dc0", "filename": "src/librustdoc/lib.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/9b1d27d440d58edcb4c673798c60181c03c084c1/src%2Flibrustdoc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b1d27d440d58edcb4c673798c60181c03c084c1/src%2Flibrustdoc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Flib.rs?ref=9b1d27d440d58edcb4c673798c60181c03c084c1", "patch": "@@ -167,6 +167,14 @@ fn opts() -> Vec<RustcOptGroup> {\n         stable(\"test-args\", |o| {\n             o.optmulti(\"\", \"test-args\", \"arguments to pass to the test runner\", \"ARGS\")\n         }),\n+        unstable(\"test-run-directory\", |o| {\n+            o.optopt(\n+                \"\",\n+                \"test-run-directory\",\n+                \"The working directory in which to run tests\",\n+                \"PATH\",\n+            )\n+        }),\n         stable(\"target\", |o| o.optopt(\"\", \"target\", \"target triple to document\", \"TRIPLE\")),\n         stable(\"markdown-css\", |o| {\n             o.optmulti("}, {"sha": "e9b2754794a78c10ebb0536c2bc8db28c0f42858", "filename": "src/test/rustdoc-ui/run-directory.correct.stdout", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/9b1d27d440d58edcb4c673798c60181c03c084c1/src%2Ftest%2Frustdoc-ui%2Frun-directory.correct.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/9b1d27d440d58edcb4c673798c60181c03c084c1/src%2Ftest%2Frustdoc-ui%2Frun-directory.correct.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Frun-directory.correct.stdout?ref=9b1d27d440d58edcb4c673798c60181c03c084c1", "patch": "@@ -0,0 +1,6 @@\n+\n+running 1 test\n+test $DIR/run-directory.rs - foo (line 10) ... ok\n+\n+test result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in $TIME\n+"}, {"sha": "97a5dbc5c0cd19112a8b6c02652880f568ca197f", "filename": "src/test/rustdoc-ui/run-directory.incorrect.stdout", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/9b1d27d440d58edcb4c673798c60181c03c084c1/src%2Ftest%2Frustdoc-ui%2Frun-directory.incorrect.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/9b1d27d440d58edcb4c673798c60181c03c084c1/src%2Ftest%2Frustdoc-ui%2Frun-directory.incorrect.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Frun-directory.incorrect.stdout?ref=9b1d27d440d58edcb4c673798c60181c03c084c1", "patch": "@@ -0,0 +1,6 @@\n+\n+running 1 test\n+test $DIR/run-directory.rs - foo (line 19) ... ok\n+\n+test result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in $TIME\n+"}, {"sha": "78431c0e80b59137fe389d68a1454f367f865459", "filename": "src/test/rustdoc-ui/run-directory.rs", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/9b1d27d440d58edcb4c673798c60181c03c084c1/src%2Ftest%2Frustdoc-ui%2Frun-directory.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b1d27d440d58edcb4c673798c60181c03c084c1/src%2Ftest%2Frustdoc-ui%2Frun-directory.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Frun-directory.rs?ref=9b1d27d440d58edcb4c673798c60181c03c084c1", "patch": "@@ -0,0 +1,23 @@\n+// this test asserts that the cwd of doctest invocations is set correctly.\n+\n+// revisions: correct incorrect\n+// check-pass\n+// [correct]compile-flags:--test --test-run-directory={{src-base}}\n+// [incorrect]compile-flags:--test --test-run-directory={{src-base}}/coverage\n+// normalize-stdout-test: \"src/test/rustdoc-ui\" -> \"$$DIR\"\n+// normalize-stdout-test \"finished in \\d+\\.\\d+s\" -> \"finished in $$TIME\"\n+\n+/// ```\n+/// assert_eq!(\n+///     std::fs::read_to_string(\"run-directory.rs\").unwrap(),\n+///     include_str!(\"run-directory.rs\"),\n+/// );\n+/// ```\n+#[cfg(correct)]\n+pub fn foo() {}\n+\n+/// ```\n+/// assert!(std::fs::read_to_string(\"run-directory.rs\").is_err());\n+/// ```\n+#[cfg(incorrect)]\n+pub fn foo() {}"}]}