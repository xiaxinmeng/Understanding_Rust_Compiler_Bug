{"sha": "68c15be8b5a28297ae58ea030adf49f265e41127", "node_id": "MDY6Q29tbWl0NzI0NzEyOjY4YzE1YmU4YjVhMjgyOTdhZTU4ZWEwMzBhZGY0OWYyNjVlNDExMjc=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2015-12-04T17:47:18Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2015-12-04T17:47:18Z"}, "message": "Auto merge of #30084 - oli-obk:const_fn, r=pnkfelix", "tree": {"sha": "688d095629d15a30c03b1d47fd6a03b59aec5fae", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/688d095629d15a30c03b1d47fd6a03b59aec5fae"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/68c15be8b5a28297ae58ea030adf49f265e41127", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/68c15be8b5a28297ae58ea030adf49f265e41127", "html_url": "https://github.com/rust-lang/rust/commit/68c15be8b5a28297ae58ea030adf49f265e41127", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/68c15be8b5a28297ae58ea030adf49f265e41127/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ac0e84522437331f9a06d04a5842acf0234cc86e", "url": "https://api.github.com/repos/rust-lang/rust/commits/ac0e84522437331f9a06d04a5842acf0234cc86e", "html_url": "https://github.com/rust-lang/rust/commit/ac0e84522437331f9a06d04a5842acf0234cc86e"}, {"sha": "8e64e22ef764b2e06b79f16d2587e5f7aa98c7e2", "url": "https://api.github.com/repos/rust-lang/rust/commits/8e64e22ef764b2e06b79f16d2587e5f7aa98c7e2", "html_url": "https://github.com/rust-lang/rust/commit/8e64e22ef764b2e06b79f16d2587e5f7aa98c7e2"}], "stats": {"total": 85, "additions": 56, "deletions": 29}, "files": [{"sha": "7b1c38d86d2d2a8b0d9f3ed11a23866c3fc95700", "filename": "src/librustc/middle/const_eval.rs", "status": "modified", "additions": 51, "deletions": 27, "changes": 78, "blob_url": "https://github.com/rust-lang/rust/blob/68c15be8b5a28297ae58ea030adf49f265e41127/src%2Flibrustc%2Fmiddle%2Fconst_eval.rs", "raw_url": "https://github.com/rust-lang/rust/raw/68c15be8b5a28297ae58ea030adf49f265e41127/src%2Flibrustc%2Fmiddle%2Fconst_eval.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fconst_eval.rs?ref=68c15be8b5a28297ae58ea030adf49f265e41127", "patch": "@@ -403,6 +403,7 @@ pub enum ErrKind {\n     InvalidOpForUintInt(hir::BinOp_),\n     NegateOn(ConstVal),\n     NotOn(ConstVal),\n+    CallOn(ConstVal),\n \n     NegateWithOverflow(i64),\n     AddiWithOverflow(i64, i64),\n@@ -419,6 +420,7 @@ pub enum ErrKind {\n     ShiftRightWithOverflow,\n     MissingStructField,\n     NonConstPath,\n+    UnimplementedConstVal(&'static str),\n     UnresolvedPath,\n     ExpectedConstTuple,\n     ExpectedConstStruct,\n@@ -449,6 +451,7 @@ impl ConstEvalErr {\n             InvalidOpForUintInt(..) => \"can't do this op on a usize and isize\".into_cow(),\n             NegateOn(ref const_val) => format!(\"negate on {}\", const_val.description()).into_cow(),\n             NotOn(ref const_val) => format!(\"not on {}\", const_val.description()).into_cow(),\n+            CallOn(ref const_val) => format!(\"call on {}\", const_val.description()).into_cow(),\n \n             NegateWithOverflow(..) => \"attempted to negate with overflow\".into_cow(),\n             AddiWithOverflow(..) => \"attempted to add with overflow\".into_cow(),\n@@ -465,6 +468,8 @@ impl ConstEvalErr {\n             ShiftRightWithOverflow => \"attempted right shift with overflow\".into_cow(),\n             MissingStructField  => \"nonexistent struct field\".into_cow(),\n             NonConstPath        => \"non-constant path in constant expression\".into_cow(),\n+            UnimplementedConstVal(what) =>\n+                format!(\"unimplemented constant expression: {}\", what).into_cow(),\n             UnresolvedPath => \"unresolved path in constant expression\".into_cow(),\n             ExpectedConstTuple => \"expected constant tuple\".into_cow(),\n             ExpectedConstStruct => \"expected constant struct\".into_cow(),\n@@ -1043,8 +1048,7 @@ pub fn eval_const_expr_partial<'tcx>(tcx: &ty::ctxt<'tcx>,\n                       (None, None)\n                   }\n               },\n-              Some(def::DefFn(id, _)) => return Ok(Function(id)),\n-              // FIXME: implement const methods?\n+              Some(def::DefMethod(id)) | Some(def::DefFn(id, _)) => return Ok(Function(id)),\n               _ => (None, None)\n           };\n           let const_expr = match const_expr {\n@@ -1070,31 +1074,8 @@ pub fn eval_const_expr_partial<'tcx>(tcx: &ty::ctxt<'tcx>,\n           } else {\n               UncheckedExprNoHint // we cannot reason about UncheckedExprHint here\n           };\n-          let (\n-              decl,\n-              block,\n-              constness,\n-          ) = match try!(eval_const_expr_partial(tcx, callee, sub_ty_hint, fn_args)) {\n-              Function(did) => if did.is_local() {\n-                  match tcx.map.find(did.index.as_u32()) {\n-                      Some(ast_map::NodeItem(it)) => match it.node {\n-                          hir::ItemFn(\n-                              ref decl,\n-                              hir::Unsafety::Normal,\n-                              constness,\n-                              abi::Abi::Rust,\n-                              _, // ducktype generics? types are funky in const_eval\n-                              ref block,\n-                          ) => (decl, block, constness),\n-                          _ => signal!(e, NonConstPath),\n-                      },\n-                      _ => signal!(e, NonConstPath),\n-                  }\n-              } else {\n-                  signal!(e, NonConstPath)\n-              },\n-              _ => signal!(e, NonConstPath),\n-          };\n+          let callee_val = try!(eval_const_expr_partial(tcx, callee, sub_ty_hint, fn_args));\n+          let (decl, block, constness) = try!(get_fn_def(tcx, e, callee_val));\n           match (ty_hint, constness) {\n               (ExprTypeChecked, _) => {\n                   // no need to check for constness... either check_const\n@@ -1441,3 +1422,46 @@ pub fn compare_lit_exprs<'tcx>(tcx: &ty::ctxt<'tcx>,\n     };\n     compare_const_vals(&a, &b)\n }\n+\n+\n+// returns Err if callee is not `Function`\n+// `e` is only used for error reporting/spans\n+fn get_fn_def<'a>(tcx: &'a ty::ctxt,\n+                  e: &hir::Expr,\n+                  callee: ConstVal)\n+                  -> Result<(&'a hir::FnDecl, &'a hir::Block, hir::Constness), ConstEvalErr> {\n+    let did = match callee {\n+        Function(did) => did,\n+        callee => signal!(e, CallOn(callee)),\n+    };\n+    debug!(\"fn call: {:?}\", tcx.map.get_if_local(did));\n+    match tcx.map.get_if_local(did) {\n+        None => signal!(e, UnimplementedConstVal(\"calling non-local const fn\")), // non-local\n+        Some(ast_map::NodeItem(it)) => match it.node {\n+            hir::ItemFn(\n+                ref decl,\n+                hir::Unsafety::Normal,\n+                constness,\n+                abi::Abi::Rust,\n+                _, // ducktype generics? types are funky in const_eval\n+                ref block,\n+            ) => Ok((&**decl, &**block, constness)),\n+            _ => signal!(e, NonConstPath),\n+        },\n+        Some(ast_map::NodeImplItem(it)) => match it.node {\n+            hir::ImplItemKind::Method(\n+                hir::MethodSig {\n+                    ref decl,\n+                    unsafety: hir::Unsafety::Normal,\n+                    constness,\n+                    abi: abi::Abi::Rust,\n+                    .. // ducktype generics? types are funky in const_eval\n+                },\n+                ref block,\n+            ) => Ok((decl, block, constness)),\n+            _ => signal!(e, NonConstPath),\n+        },\n+        Some(ast_map::NodeTraitItem(..)) => signal!(e, NonConstPath),\n+        Some(_) => unimplemented!(),\n+    }\n+}"}, {"sha": "44ab798f4911b4a17c9cef11952aa577f6f27ced", "filename": "src/test/compile-fail/const-eval-span.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/68c15be8b5a28297ae58ea030adf49f265e41127/src%2Ftest%2Fcompile-fail%2Fconst-eval-span.rs", "raw_url": "https://github.com/rust-lang/rust/raw/68c15be8b5a28297ae58ea030adf49f265e41127/src%2Ftest%2Fcompile-fail%2Fconst-eval-span.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fconst-eval-span.rs?ref=68c15be8b5a28297ae58ea030adf49f265e41127", "patch": "@@ -14,7 +14,7 @@\n struct S(i32);\n \n const CONSTANT: S = S(0);\n-//~^ ERROR: constant evaluation error: non-constant path in constant expression [E0080]\n+//~^ ERROR: constant evaluation error: call on struct [E0080]\n \n enum E {\n     V = CONSTANT,"}, {"sha": "592a312d80048a32f2cfb0d5520250c976ef9d58", "filename": "src/test/compile-fail/const-fn-stability-calls-2.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/68c15be8b5a28297ae58ea030adf49f265e41127/src%2Ftest%2Fcompile-fail%2Fconst-fn-stability-calls-2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/68c15be8b5a28297ae58ea030adf49f265e41127/src%2Ftest%2Fcompile-fail%2Fconst-fn-stability-calls-2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fconst-fn-stability-calls-2.rs?ref=68c15be8b5a28297ae58ea030adf49f265e41127", "patch": "@@ -17,5 +17,6 @@ extern crate const_fn_lib;\n use const_fn_lib::foo;\n \n fn main() {\n-    let x: [usize; foo()] = []; //~ ERROR non-constant path in constant expr\n+    let x: [usize; foo()] = [];\n+    //~^ ERROR unimplemented constant expression: calling non-local const fn [E0250]\n }"}, {"sha": "7d8d941439cf8c953848bdcd29267c6083cc0c71", "filename": "src/test/run-pass/const-fn-method.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/68c15be8b5a28297ae58ea030adf49f265e41127/src%2Ftest%2Frun-pass%2Fconst-fn-method.rs", "raw_url": "https://github.com/rust-lang/rust/raw/68c15be8b5a28297ae58ea030adf49f265e41127/src%2Ftest%2Frun-pass%2Fconst-fn-method.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fconst-fn-method.rs?ref=68c15be8b5a28297ae58ea030adf49f265e41127", "patch": "@@ -22,4 +22,5 @@ const FOO: Foo = Foo::new();\n \n pub fn main() {\n     assert_eq!(FOO.value, 22);\n+    let _: [&'static str; Foo::new().value as usize] = [\"hey\"; 22];\n }"}, {"sha": "38c73febc310843de85447d67ff64ad311e53c21", "filename": "src/test/run-pass/const-fn.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/68c15be8b5a28297ae58ea030adf49f265e41127/src%2Ftest%2Frun-pass%2Fconst-fn.rs", "raw_url": "https://github.com/rust-lang/rust/raw/68c15be8b5a28297ae58ea030adf49f265e41127/src%2Ftest%2Frun-pass%2Fconst-fn.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fconst-fn.rs?ref=68c15be8b5a28297ae58ea030adf49f265e41127", "patch": "@@ -29,4 +29,5 @@ fn main() {\n \n     assert_eq!(DIFF, 22);\n \n+    let _: [&'static str; sub(100, 99) as usize] = [\"hi\"];\n }"}]}