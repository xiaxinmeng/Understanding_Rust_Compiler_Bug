{"sha": "01d64f5e3eb309a41a40fbbaf5d6bd9d20f86bee", "node_id": "C_kwDOAAsO6NoAKDAxZDY0ZjVlM2ViMzA5YTQxYTQwZmJiYWY1ZDZiZDlkMjBmODZiZWU", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume.gomez@huawei.com", "date": "2022-08-25T14:42:17Z"}, "committer": {"name": "Guillaume Gomez", "email": "guillaume.gomez@huawei.com", "date": "2022-08-25T18:12:53Z"}, "message": "Fix missing cfg propagation for reexports", "tree": {"sha": "c74b775a806ccdc56551e7b2763d5b668a4bde78", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c74b775a806ccdc56551e7b2763d5b668a4bde78"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/01d64f5e3eb309a41a40fbbaf5d6bd9d20f86bee", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/01d64f5e3eb309a41a40fbbaf5d6bd9d20f86bee", "html_url": "https://github.com/rust-lang/rust/commit/01d64f5e3eb309a41a40fbbaf5d6bd9d20f86bee", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/01d64f5e3eb309a41a40fbbaf5d6bd9d20f86bee/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4a24f08ba43166cfee86d868b3fe8612aec6faca", "url": "https://api.github.com/repos/rust-lang/rust/commits/4a24f08ba43166cfee86d868b3fe8612aec6faca", "html_url": "https://github.com/rust-lang/rust/commit/4a24f08ba43166cfee86d868b3fe8612aec6faca"}], "stats": {"total": 79, "additions": 71, "deletions": 8}, "files": [{"sha": "f367edcbf5a81eed12d6f1437586f9d73f4befac", "filename": "src/librustdoc/clean/inline.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/01d64f5e3eb309a41a40fbbaf5d6bd9d20f86bee/src%2Flibrustdoc%2Fclean%2Finline.rs", "raw_url": "https://github.com/rust-lang/rust/raw/01d64f5e3eb309a41a40fbbaf5d6bd9d20f86bee/src%2Flibrustdoc%2Fclean%2Finline.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Finline.rs?ref=01d64f5e3eb309a41a40fbbaf5d6bd9d20f86bee", "patch": "@@ -300,7 +300,7 @@ pub(crate) fn build_impls(\n }\n \n /// `parent_module` refers to the parent of the re-export, not the original item\n-fn merge_attrs(\n+pub(crate) fn merge_attrs(\n     cx: &mut DocContext<'_>,\n     parent_module: Option<DefId>,\n     old_attrs: Attrs<'_>,"}, {"sha": "909a47d07b1666f92ecf4f44e7478066b3655b09", "filename": "src/librustdoc/clean/types.rs", "status": "modified", "additions": 26, "deletions": 1, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/01d64f5e3eb309a41a40fbbaf5d6bd9d20f86bee/src%2Flibrustdoc%2Fclean%2Ftypes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/01d64f5e3eb309a41a40fbbaf5d6bd9d20f86bee/src%2Flibrustdoc%2Fclean%2Ftypes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Ftypes.rs?ref=01d64f5e3eb309a41a40fbbaf5d6bd9d20f86bee", "patch": "@@ -482,7 +482,7 @@ impl Item {\n         cx: &mut DocContext<'_>,\n         cfg: Option<Arc<Cfg>>,\n     ) -> Item {\n-        trace!(\"name={:?}, def_id={:?}\", name, def_id);\n+        trace!(\"name={:?}, def_id={:?} cfg={:?}\", name, def_id, cfg);\n \n         // Primitives and Keywords are written in the source code as private modules.\n         // The modules need to be private so that nobody actually uses them, but the\n@@ -801,6 +801,31 @@ impl ItemKind {\n             | KeywordItem => [].iter(),\n         }\n     }\n+\n+    /// Returns `true` if this item does not appear inside an impl block.\n+    pub(crate) fn is_non_assoc(&self) -> bool {\n+        matches!(\n+            self,\n+            StructItem(_)\n+                | UnionItem(_)\n+                | EnumItem(_)\n+                | TraitItem(_)\n+                | ModuleItem(_)\n+                | ExternCrateItem { .. }\n+                | FunctionItem(_)\n+                | TypedefItem(_)\n+                | OpaqueTyItem(_)\n+                | StaticItem(_)\n+                | ConstantItem(_)\n+                | TraitAliasItem(_)\n+                | ForeignFunctionItem(_)\n+                | ForeignStaticItem(_)\n+                | ForeignTypeItem\n+                | MacroItem(_)\n+                | ProcMacroItem(_)\n+                | PrimitiveItem(_)\n+        )\n+    }\n }\n \n #[derive(Clone, Debug)]"}, {"sha": "020f6a74d697f76d88eaa3fd7ba1c6c33f59b992", "filename": "src/librustdoc/html/render/mod.rs", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/01d64f5e3eb309a41a40fbbaf5d6bd9d20f86bee/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/01d64f5e3eb309a41a40fbbaf5d6bd9d20f86bee/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs?ref=01d64f5e3eb309a41a40fbbaf5d6bd9d20f86bee", "patch": "@@ -522,7 +522,14 @@ fn portability(item: &clean::Item, parent: Option<&clean::Item>) -> Option<Strin\n         (cfg, _) => cfg.as_deref().cloned(),\n     };\n \n-    debug!(\"Portability {:?} - {:?} = {:?}\", item.cfg, parent.and_then(|p| p.cfg.as_ref()), cfg);\n+    debug!(\n+        \"Portability {:?} {:?} (parent: {:?}) - {:?} = {:?}\",\n+        item.name,\n+        item.cfg,\n+        parent,\n+        parent.and_then(|p| p.cfg.as_ref()),\n+        cfg\n+    );\n \n     Some(format!(\"<div class=\\\"stab portability\\\">{}</div>\", cfg?.render_long_html()))\n }"}, {"sha": "a313b896e841993c9e8a7b8cdc8108b5c5085c23", "filename": "src/librustdoc/html/render/print_item.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/01d64f5e3eb309a41a40fbbaf5d6bd9d20f86bee/src%2Flibrustdoc%2Fhtml%2Frender%2Fprint_item.rs", "raw_url": "https://github.com/rust-lang/rust/raw/01d64f5e3eb309a41a40fbbaf5d6bd9d20f86bee/src%2Flibrustdoc%2Fhtml%2Frender%2Fprint_item.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fprint_item.rs?ref=01d64f5e3eb309a41a40fbbaf5d6bd9d20f86bee", "patch": "@@ -477,7 +477,7 @@ fn extra_info_tags(item: &clean::Item, parent: &clean::Item, tcx: TyCtxt<'_>) ->\n         (cfg, _) => cfg.as_deref().cloned(),\n     };\n \n-    debug!(\"Portability {:?} - {:?} = {:?}\", item.cfg, parent.cfg, cfg);\n+    debug!(\"Portability name={:?} {:?} - {:?} = {:?}\", item.name, item.cfg, parent.cfg, cfg);\n     if let Some(ref cfg) = cfg {\n         tags += &tag_html(\"portability\", &cfg.render_long_plain(), &cfg.render_short_html());\n     }"}, {"sha": "21d295bb1f88e9fa761e661023f8b2d9c73b5824", "filename": "src/librustdoc/passes/propagate_doc_cfg.rs", "status": "modified", "additions": 35, "deletions": 4, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/01d64f5e3eb309a41a40fbbaf5d6bd9d20f86bee/src%2Flibrustdoc%2Fpasses%2Fpropagate_doc_cfg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/01d64f5e3eb309a41a40fbbaf5d6bd9d20f86bee/src%2Flibrustdoc%2Fpasses%2Fpropagate_doc_cfg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fpropagate_doc_cfg.rs?ref=01d64f5e3eb309a41a40fbbaf5d6bd9d20f86bee", "patch": "@@ -2,29 +2,53 @@\n use std::sync::Arc;\n \n use crate::clean::cfg::Cfg;\n+use crate::clean::inline::{load_attrs, merge_attrs};\n use crate::clean::{Crate, Item};\n use crate::core::DocContext;\n use crate::fold::DocFolder;\n use crate::passes::Pass;\n \n+use rustc_hir::def_id::LocalDefId;\n+\n pub(crate) const PROPAGATE_DOC_CFG: Pass = Pass {\n     name: \"propagate-doc-cfg\",\n     run: propagate_doc_cfg,\n     description: \"propagates `#[doc(cfg(...))]` to child items\",\n };\n \n-pub(crate) fn propagate_doc_cfg(cr: Crate, _: &mut DocContext<'_>) -> Crate {\n-    CfgPropagator { parent_cfg: None }.fold_crate(cr)\n+pub(crate) fn propagate_doc_cfg(cr: Crate, cx: &mut DocContext<'_>) -> Crate {\n+    CfgPropagator { parent_cfg: None, parent: None, cx }.fold_crate(cr)\n }\n \n-struct CfgPropagator {\n+struct CfgPropagator<'a, 'tcx> {\n     parent_cfg: Option<Arc<Cfg>>,\n+    parent: Option<LocalDefId>,\n+    cx: &'a mut DocContext<'tcx>,\n }\n \n-impl DocFolder for CfgPropagator {\n+impl<'a, 'tcx> DocFolder for CfgPropagator<'a, 'tcx> {\n     fn fold_item(&mut self, mut item: Item) -> Option<Item> {\n         let old_parent_cfg = self.parent_cfg.clone();\n \n+        if item.kind.is_non_assoc() &&\n+            let Some(def_id) = item.item_id.as_def_id().and_then(|def_id| def_id.as_local()) {\n+            let hir = self.cx.tcx.hir();\n+            let hir_id = hir.local_def_id_to_hir_id(def_id);\n+            let expected_parent = hir.get_parent_item(hir_id);\n+\n+            // If parents are different, it means that `item` is a reexport and we need to compute\n+            // the actual `cfg` by iterating through its \"real\" parents.\n+            if self.parent != Some(expected_parent) {\n+                let mut attrs = Vec::new();\n+                for (parent_hir_id, _) in hir.parent_iter(hir_id) {\n+                    let def_id = hir.local_def_id(parent_hir_id).to_def_id();\n+                    attrs.extend_from_slice(load_attrs(self.cx, def_id));\n+                }\n+                let (_, cfg) =\n+                    merge_attrs(self.cx, None, item.attrs.other_attrs.as_slice(), Some(&attrs));\n+                item.cfg = cfg;\n+            }\n+        }\n         let new_cfg = match (self.parent_cfg.take(), item.cfg.take()) {\n             (None, None) => None,\n             (Some(rc), None) | (None, Some(rc)) => Some(rc),\n@@ -37,8 +61,15 @@ impl DocFolder for CfgPropagator {\n         self.parent_cfg = new_cfg.clone();\n         item.cfg = new_cfg;\n \n+        let old_parent =\n+            if let Some(def_id) = item.item_id.as_def_id().and_then(|def_id| def_id.as_local()) {\n+                self.parent.replace(def_id)\n+            } else {\n+                self.parent.take()\n+            };\n         let result = self.fold_item_recur(item);\n         self.parent_cfg = old_parent_cfg;\n+        self.parent = old_parent;\n \n         Some(result)\n     }"}]}