{"sha": "f30a8186f7469d464e46e3451e2b2e41609225dd", "node_id": "MDY6Q29tbWl0NzI0NzEyOmYzMGE4MTg2Zjc0NjlkNDY0ZTQ2ZTM0NTFlMmIyZTQxNjA5MjI1ZGQ=", "commit": {"author": {"name": "Matthew Jasper", "email": "mjjasper1@gmail.com", "date": "2020-01-23T20:34:11Z"}, "committer": {"name": "Matthew Jasper", "email": "mjjasper1@gmail.com", "date": "2020-01-23T21:38:15Z"}, "message": "Make pointers to statics internal", "tree": {"sha": "809b7562bd73faaf610e6f3a2f273065740a1582", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/809b7562bd73faaf610e6f3a2f273065740a1582"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f30a8186f7469d464e46e3451e2b2e41609225dd", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f30a8186f7469d464e46e3451e2b2e41609225dd", "html_url": "https://github.com/rust-lang/rust/commit/f30a8186f7469d464e46e3451e2b2e41609225dd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f30a8186f7469d464e46e3451e2b2e41609225dd/comments", "author": {"login": "matthewjasper", "id": 20113453, "node_id": "MDQ6VXNlcjIwMTEzNDUz", "avatar_url": "https://avatars.githubusercontent.com/u/20113453?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthewjasper", "html_url": "https://github.com/matthewjasper", "followers_url": "https://api.github.com/users/matthewjasper/followers", "following_url": "https://api.github.com/users/matthewjasper/following{/other_user}", "gists_url": "https://api.github.com/users/matthewjasper/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthewjasper/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthewjasper/subscriptions", "organizations_url": "https://api.github.com/users/matthewjasper/orgs", "repos_url": "https://api.github.com/users/matthewjasper/repos", "events_url": "https://api.github.com/users/matthewjasper/events{/privacy}", "received_events_url": "https://api.github.com/users/matthewjasper/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matthewjasper", "id": 20113453, "node_id": "MDQ6VXNlcjIwMTEzNDUz", "avatar_url": "https://avatars.githubusercontent.com/u/20113453?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthewjasper", "html_url": "https://github.com/matthewjasper", "followers_url": "https://api.github.com/users/matthewjasper/followers", "following_url": "https://api.github.com/users/matthewjasper/following{/other_user}", "gists_url": "https://api.github.com/users/matthewjasper/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthewjasper/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthewjasper/subscriptions", "organizations_url": "https://api.github.com/users/matthewjasper/orgs", "repos_url": "https://api.github.com/users/matthewjasper/repos", "events_url": "https://api.github.com/users/matthewjasper/events{/privacy}", "received_events_url": "https://api.github.com/users/matthewjasper/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e0bbe7915e2b663ac84244918d6d06e0747ed33e", "url": "https://api.github.com/repos/rust-lang/rust/commits/e0bbe7915e2b663ac84244918d6d06e0747ed33e", "html_url": "https://github.com/rust-lang/rust/commit/e0bbe7915e2b663ac84244918d6d06e0747ed33e"}], "stats": {"total": 122, "additions": 89, "deletions": 33}, "files": [{"sha": "59d370abc71c5fb117beae7808844cafcba45554", "filename": "src/librustc_mir/transform/check_unsafety.rs", "status": "modified", "additions": 24, "deletions": 22, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/f30a8186f7469d464e46e3451e2b2e41609225dd/src%2Flibrustc_mir%2Ftransform%2Fcheck_unsafety.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f30a8186f7469d464e46e3451e2b2e41609225dd/src%2Flibrustc_mir%2Ftransform%2Fcheck_unsafety.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fcheck_unsafety.rs?ref=f30a8186f7469d464e46e3451e2b2e41609225dd", "patch": "@@ -233,28 +233,30 @@ impl<'a, 'tcx> Visitor<'tcx> for UnsafetyChecker<'a, 'tcx> {\n             if let (local, []) = (&place.local, proj_base) {\n                 let decl = &self.body.local_decls[*local];\n                 if decl.internal {\n-                    // Internal locals are used in the `move_val_init` desugaring.\n-                    // We want to check unsafety against the source info of the\n-                    // desugaring, rather than the source info of the RHS.\n-                    self.source_info = self.body.local_decls[*local].source_info;\n-                } else if let LocalInfo::StaticRef { def_id, .. } = decl.local_info {\n-                    if self.tcx.is_mutable_static(def_id) {\n-                        self.require_unsafe(\n-                            \"use of mutable static\",\n-                            \"mutable statics can be mutated by multiple threads: aliasing \\\n-                        violations or data races will cause undefined behavior\",\n-                            UnsafetyViolationKind::General,\n-                        );\n-                        return;\n-                    } else if self.tcx.is_foreign_item(def_id) {\n-                        self.require_unsafe(\n-                            \"use of extern static\",\n-                            \"extern statics are not controlled by the Rust type system: \\\n-                        invalid data, aliasing violations or data races will cause \\\n-                        undefined behavior\",\n-                            UnsafetyViolationKind::General,\n-                        );\n-                        return;\n+                    if let LocalInfo::StaticRef { def_id, .. } = decl.local_info {\n+                        if self.tcx.is_mutable_static(def_id) {\n+                            self.require_unsafe(\n+                                \"use of mutable static\",\n+                                \"mutable statics can be mutated by multiple threads: aliasing \\\n+                            violations or data races will cause undefined behavior\",\n+                                UnsafetyViolationKind::General,\n+                            );\n+                            return;\n+                        } else if self.tcx.is_foreign_item(def_id) {\n+                            self.require_unsafe(\n+                                \"use of extern static\",\n+                                \"extern statics are not controlled by the Rust type system: \\\n+                            invalid data, aliasing violations or data races will cause \\\n+                            undefined behavior\",\n+                                UnsafetyViolationKind::General,\n+                            );\n+                            return;\n+                        }\n+                    } else {\n+                        // Internal locals are used in the `move_val_init` desugaring.\n+                        // We want to check unsafety against the source info of the\n+                        // desugaring, rather than the source info of the RHS.\n+                        self.source_info = self.body.local_decls[*local].source_info;\n                     }\n                 }\n             }"}, {"sha": "34dd10cbc0fc87fd9273bf6cb77c15152a318948", "filename": "src/librustc_mir_build/build/expr/as_temp.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/f30a8186f7469d464e46e3451e2b2e41609225dd/src%2Flibrustc_mir_build%2Fbuild%2Fexpr%2Fas_temp.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f30a8186f7469d464e46e3451e2b2e41609225dd/src%2Flibrustc_mir_build%2Fbuild%2Fexpr%2Fas_temp.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir_build%2Fbuild%2Fexpr%2Fas_temp.rs?ref=f30a8186f7469d464e46e3451e2b2e41609225dd", "patch": "@@ -61,6 +61,7 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n             }\n             if let ExprKind::StaticRef { def_id, .. } = expr.kind {\n                 let is_thread_local = this.hir.tcx().has_attr(def_id, sym::thread_local);\n+                local_decl.internal = true;\n                 local_decl.local_info = LocalInfo::StaticRef { def_id, is_thread_local };\n             }\n             this.local_decls.push(local_decl)"}, {"sha": "75cc2c132f8a81215317def055f10185a1a8069d", "filename": "src/librustc_typeck/check/generator_interior.rs", "status": "modified", "additions": 2, "deletions": 11, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/f30a8186f7469d464e46e3451e2b2e41609225dd/src%2Flibrustc_typeck%2Fcheck%2Fgenerator_interior.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f30a8186f7469d464e46e3451e2b2e41609225dd/src%2Flibrustc_typeck%2Fcheck%2Fgenerator_interior.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fgenerator_interior.rs?ref=f30a8186f7469d464e46e3451e2b2e41609225dd", "patch": "@@ -222,8 +222,6 @@ impl<'a, 'tcx> Visitor<'tcx> for InteriorVisitor<'a, 'tcx> {\n     }\n \n     fn visit_expr(&mut self, expr: &'tcx Expr<'tcx>) {\n-        let scope = self.region_scope_tree.temporary_scope(expr.hir_id.local_id);\n-\n         match &expr.kind {\n             ExprKind::Call(callee, args) => match &callee.kind {\n                 ExprKind::Path(qpath) => {\n@@ -249,20 +247,13 @@ impl<'a, 'tcx> Visitor<'tcx> for InteriorVisitor<'a, 'tcx> {\n                 }\n                 _ => intravisit::walk_expr(self, expr),\n             },\n-            ExprKind::Path(qpath) => {\n-                let res = self.fcx.tables.borrow().qpath_res(qpath, expr.hir_id);\n-                if let Res::Def(DefKind::Static, def_id) = res {\n-                    // Statics are lowered to temporary references or\n-                    // pointers in MIR, so record that type.\n-                    let ptr_ty = self.fcx.tcx.static_ptr_ty(def_id);\n-                    self.record(ptr_ty, scope, Some(expr), expr.span);\n-                }\n-            }\n             _ => intravisit::walk_expr(self, expr),\n         }\n \n         self.expr_count += 1;\n \n+        let scope = self.region_scope_tree.temporary_scope(expr.hir_id.local_id);\n+\n         // If there are adjustments, then record the final type --\n         // this is the actual value that is being produced.\n         if let Some(adjusted_ty) = self.fcx.tables.borrow().expr_ty_adjusted_opt(expr) {"}, {"sha": "dda4a151dd2d60fccf0c9f035628be0016263cbe", "filename": "src/test/ui/async-await/issues/issue-67611-static-mut-refs.rs", "status": "added", "additions": 33, "deletions": 0, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/f30a8186f7469d464e46e3451e2b2e41609225dd/src%2Ftest%2Fui%2Fasync-await%2Fissues%2Fissue-67611-static-mut-refs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f30a8186f7469d464e46e3451e2b2e41609225dd/src%2Ftest%2Fui%2Fasync-await%2Fissues%2Fissue-67611-static-mut-refs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasync-await%2Fissues%2Fissue-67611-static-mut-refs.rs?ref=f30a8186f7469d464e46e3451e2b2e41609225dd", "patch": "@@ -0,0 +1,33 @@\n+// build-pass\n+// edition:2018\n+\n+static mut A: [i32; 5] = [1, 2, 3, 4, 5];\n+\n+fn is_send_sync<T: Send + Sync>(_: T) {}\n+\n+async fn fun() {\n+    let u = unsafe { A[async { 1 }.await] };\n+    unsafe {\n+        match A {\n+            i if async { true }.await => (),\n+            _ => (),\n+        }\n+    }\n+}\n+\n+fn main() {\n+    let index_block = async {\n+        let u = unsafe { A[async { 1 }.await] };\n+    };\n+    let match_block = async {\n+        unsafe {\n+            match A {\n+                i if async { true }.await => (),\n+                _ => (),\n+            }\n+        }\n+    };\n+    is_send_sync(index_block);\n+    is_send_sync(match_block);\n+    is_send_sync(fun());\n+}"}, {"sha": "2926bba997803a9405454378e8c7b88b987900b4", "filename": "src/test/ui/generator/static-mut-reference-across-yield.rs", "status": "added", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/f30a8186f7469d464e46e3451e2b2e41609225dd/src%2Ftest%2Fui%2Fgenerator%2Fstatic-mut-reference-across-yield.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f30a8186f7469d464e46e3451e2b2e41609225dd/src%2Ftest%2Fui%2Fgenerator%2Fstatic-mut-reference-across-yield.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fgenerator%2Fstatic-mut-reference-across-yield.rs?ref=f30a8186f7469d464e46e3451e2b2e41609225dd", "patch": "@@ -0,0 +1,29 @@\n+// build-pass\n+#![feature(generators)]\n+\n+static mut A: [i32; 5] = [1, 2, 3, 4, 5];\n+\n+fn is_send_sync<T: Send + Sync>(_: T) {}\n+\n+fn main() {\n+    unsafe {\n+        let gen_index = static || {\n+            let u = A[{\n+                yield;\n+                1\n+            }];\n+        };\n+        let gen_match = static || match A {\n+            i if {\n+                yield;\n+                true\n+            } =>\n+            {\n+                ()\n+            }\n+            _ => (),\n+        };\n+        is_send_sync(gen_index);\n+        is_send_sync(gen_match);\n+    }\n+}"}]}