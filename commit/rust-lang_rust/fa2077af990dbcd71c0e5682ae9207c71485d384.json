{"sha": "fa2077af990dbcd71c0e5682ae9207c71485d384", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZhMjA3N2FmOTkwZGJjZDcxYzBlNTY4MmFlOTIwN2M3MTQ4NWQzODQ=", "commit": {"author": {"name": "klutzy", "email": "klutzytheklutzy@gmail.com", "date": "2013-11-25T15:22:40Z"}, "committer": {"name": "klutzy", "email": "klutzytheklutzy@gmail.com", "date": "2013-11-26T05:07:48Z"}, "message": "rustc: Add crate-level attribute lint", "tree": {"sha": "dedcca6c9904bb735a53bc5ecb1eb2d5203ac7e6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/dedcca6c9904bb735a53bc5ecb1eb2d5203ac7e6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fa2077af990dbcd71c0e5682ae9207c71485d384", "comment_count": 5, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fa2077af990dbcd71c0e5682ae9207c71485d384", "html_url": "https://github.com/rust-lang/rust/commit/fa2077af990dbcd71c0e5682ae9207c71485d384", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fa2077af990dbcd71c0e5682ae9207c71485d384/comments", "author": {"login": "klutzy", "id": 1589355, "node_id": "MDQ6VXNlcjE1ODkzNTU=", "avatar_url": "https://avatars.githubusercontent.com/u/1589355?v=4", "gravatar_id": "", "url": "https://api.github.com/users/klutzy", "html_url": "https://github.com/klutzy", "followers_url": "https://api.github.com/users/klutzy/followers", "following_url": "https://api.github.com/users/klutzy/following{/other_user}", "gists_url": "https://api.github.com/users/klutzy/gists{/gist_id}", "starred_url": "https://api.github.com/users/klutzy/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/klutzy/subscriptions", "organizations_url": "https://api.github.com/users/klutzy/orgs", "repos_url": "https://api.github.com/users/klutzy/repos", "events_url": "https://api.github.com/users/klutzy/events{/privacy}", "received_events_url": "https://api.github.com/users/klutzy/received_events", "type": "User", "site_admin": false}, "committer": {"login": "klutzy", "id": 1589355, "node_id": "MDQ6VXNlcjE1ODkzNTU=", "avatar_url": "https://avatars.githubusercontent.com/u/1589355?v=4", "gravatar_id": "", "url": "https://api.github.com/users/klutzy", "html_url": "https://github.com/klutzy", "followers_url": "https://api.github.com/users/klutzy/followers", "following_url": "https://api.github.com/users/klutzy/following{/other_user}", "gists_url": "https://api.github.com/users/klutzy/gists{/gist_id}", "starred_url": "https://api.github.com/users/klutzy/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/klutzy/subscriptions", "organizations_url": "https://api.github.com/users/klutzy/orgs", "repos_url": "https://api.github.com/users/klutzy/repos", "events_url": "https://api.github.com/users/klutzy/events{/privacy}", "received_events_url": "https://api.github.com/users/klutzy/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9432e2a25dc5f3a71aa4f95a9dd6ba17198c79bd", "url": "https://api.github.com/repos/rust-lang/rust/commits/9432e2a25dc5f3a71aa4f95a9dd6ba17198c79bd", "html_url": "https://github.com/rust-lang/rust/commit/9432e2a25dc5f3a71aa4f95a9dd6ba17198c79bd"}], "stats": {"total": 85, "additions": 51, "deletions": 34}, "files": [{"sha": "d67677f07835b9fb6f25d61036b85df0eccd8911", "filename": "src/librustc/middle/lint.rs", "status": "modified", "additions": 49, "deletions": 34, "changes": 83, "blob_url": "https://github.com/rust-lang/rust/blob/fa2077af990dbcd71c0e5682ae9207c71485d384/src%2Flibrustc%2Fmiddle%2Flint.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fa2077af990dbcd71c0e5682ae9207c71485d384/src%2Flibrustc%2Fmiddle%2Flint.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Flint.rs?ref=fa2077af990dbcd71c0e5682ae9207c71485d384", "patch": "@@ -798,43 +798,55 @@ fn check_heap_item(cx: &Context, it: &ast::item) {\n     }\n }\n \n+static crate_attrs: &'static [&'static str] = &[\n+    \"crate_type\", \"link\", \"feature\", \"no_uv\", \"no_main\", \"no_std\",\n+    \"desc\", \"comment\", \"license\", \"copyright\", // not used in rustc now\n+];\n+\n+\n+static obsolete_attrs: &'static [(&'static str, &'static str)] = &[\n+    (\"abi\", \"Use `extern \\\"abi\\\" fn` instead\"),\n+    (\"auto_encode\", \"Use `#[deriving(Encodable)]` instead\"),\n+    (\"auto_decode\", \"Use `#[deriving(Decodable)]` instead\"),\n+    (\"fast_ffi\", \"Remove it\"),\n+    (\"fixed_stack_segment\", \"Remove it\"),\n+    (\"rust_stack\", \"Remove it\"),\n+];\n+\n+static other_attrs: &'static [&'static str] = &[\n+    // item-level\n+    \"address_insignificant\", // can be crate-level too\n+    \"allow\", \"deny\", \"forbid\", \"warn\", // lint options\n+    \"deprecated\", \"experimental\", \"unstable\", \"stable\", \"locked\", \"frozen\", //item stability\n+    \"crate_map\", \"cfg\", \"doc\", \"export_name\", \"link_section\", \"no_freeze\",\n+    \"no_mangle\", \"no_send\", \"static_assert\", \"unsafe_no_drop_flag\",\n+    \"packed\", \"simd\", \"repr\", \"deriving\", \"unsafe_destructor\",\n+\n+    //mod-level\n+    \"path\", \"link_name\", \"link_args\", \"nolink\", \"macro_escape\", \"no_implicit_prelude\",\n+\n+    // fn-level\n+    \"test\", \"bench\", \"should_fail\", \"ignore\", \"inline\", \"lang\", \"main\", \"start\",\n+    \"no_split_stack\", \"cold\",\n+\n+    // internal attribute: bypass privacy inside items\n+    \"!resolve_unexported\",\n+];\n+\n+fn check_crate_attrs_usage(cx: &Context, attrs: &[ast::Attribute]) {\n+\n+    for attr in attrs.iter() {\n+        let name = attr.node.value.name();\n+        let mut iter = crate_attrs.iter().chain(other_attrs.iter());\n+        if !iter.any(|other_attr| { name.equiv(other_attr) }) {\n+            cx.span_lint(attribute_usage, attr.span, \"unknown crate attribute\");\n+        }\n+    }\n+}\n+\n fn check_attrs_usage(cx: &Context, attrs: &[ast::Attribute]) {\n     // check if element has crate-level, obsolete, or any unknown attributes.\n \n-    let crate_attrs = [\n-        \"crate_type\", \"link\", \"feature\", \"no_uv\", \"no_main\", \"no_std\",\n-        \"comment\", \"license\", \"copyright\", // not used in rustc now\n-    ];\n-\n-    let obsolete_attrs = [\n-        (\"abi\", \"Use `extern \\\"abi\\\" fn` instead\"),\n-        (\"auto_encode\", \"Use `#[deriving(Encodable)]` instead\"),\n-        (\"auto_decode\", \"Use `#[deriving(Decodable)]` instead\"),\n-        (\"fast_ffi\", \"Remove it\"),\n-        (\"fixed_stack_segment\", \"Remove it\"),\n-        (\"rust_stack\", \"Remove it\"),\n-    ];\n-\n-    let other_attrs = [\n-        // item-level\n-        \"address_insignificant\", // can be crate-level too\n-        \"allow\", \"deny\", \"forbid\", \"warn\", // lint options\n-        \"deprecated\", \"experimental\", \"unstable\", \"stable\", \"locked\", \"frozen\", //item stability\n-        \"crate_map\", \"cfg\", \"doc\", \"export_name\", \"link_section\", \"no_freeze\",\n-        \"no_mangle\", \"no_send\", \"static_assert\", \"unsafe_no_drop_flag\",\n-        \"packed\", \"simd\", \"repr\", \"deriving\", \"unsafe_destructor\",\n-\n-        // mod-level\n-        \"path\", \"link_name\", \"link_args\", \"nolink\", \"macro_escape\", \"no_implicit_prelude\",\n-\n-        // fn-level\n-        \"test\", \"bench\", \"should_fail\", \"ignore\", \"inline\", \"lang\", \"main\", \"start\",\n-        \"no_split_stack\", \"cold\",\n-\n-        // internal attribute: bypass privacy inside items\n-        \"!resolve_unexported\",\n-    ];\n-\n     for attr in attrs.iter() {\n         let name = attr.node.value.name();\n         for crate_attr in crate_attrs.iter() {\n@@ -1349,6 +1361,9 @@ pub fn check_crate(tcx: ty::ctxt,\n             v.visited_outermost = true;\n             visit::walk_crate(v, crate, ());\n         }\n+\n+        check_crate_attrs_usage(cx, crate.attrs);\n+\n         visit::walk_crate(cx, crate, ());\n     }\n "}, {"sha": "ce83ba464c06eb3773da3faa2afb618867335f6f", "filename": "src/test/compile-fail/lint-unknown-attr.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/fa2077af990dbcd71c0e5682ae9207c71485d384/src%2Ftest%2Fcompile-fail%2Flint-unknown-attr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fa2077af990dbcd71c0e5682ae9207c71485d384/src%2Ftest%2Fcompile-fail%2Flint-unknown-attr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Flint-unknown-attr.rs?ref=fa2077af990dbcd71c0e5682ae9207c71485d384", "patch": "@@ -13,6 +13,8 @@\n \n #[deny(attribute_usage)];\n \n+#[mutable_doc]; //~ ERROR: unknown crate attribute\n+\n #[dance] mod a {} //~ ERROR: unknown attribute\n \n #[dance] fn main() {} //~ ERROR: unknown attribute"}]}