{"sha": "f6b0f4707bcda7b57279f9534a999dc4419f60d1", "node_id": "C_kwDOAAsO6NoAKGY2YjBmNDcwN2JjZGE3YjU3Mjc5Zjk1MzRhOTk5ZGM0NDE5ZjYwZDE", "commit": {"author": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2023-01-04T01:19:26Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-01-04T01:19:26Z"}, "message": "Rollup merge of #106045 - RalfJung:oom-nounwind-panic, r=Amanieu\n\ndefault OOM handler: use non-unwinding panic, to match std handler\n\nThe OOM handler in std will by default abort. This adjusts the default in liballoc to do the same, using the `can_unwind` flag on the panic info to indicate a non-unwinding panic.\n\nIn practice this probably makes little difference since the liballoc default will only come into play in no-std situations where people write a custom panic handler, which most likely will not implement unwinding. But still, this seems more consistent.\n\nCc `@rust-lang/wg-allocators,` https://github.com/rust-lang/rust/issues/66741", "tree": {"sha": "3ad1434cd797eb890aceec044b321a93d3246ffe", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3ad1434cd797eb890aceec044b321a93d3246ffe"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f6b0f4707bcda7b57279f9534a999dc4419f60d1", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjtNQeCRBK7hj4Ov3rIwAA+nAIAAaGiCbKolvHLHQ+JPZMIo6h\n+gQ3hfquCHK/6u9vGLJkS+j8QyseuQ1TkPczVxf71FLFaxc2ICu8gnnmdD1bNTrh\n8tIS4TI+ceu8YfeUDY5XEIaEkhgDrFzQsVKxMhPJrvVSRFBaXA42XLVDgqpONYDG\npKPk9G90pR8974nQqnCqW6HFIpUehLaEpxNKW01WQNZjdZf2FjYsEa2Me2mlC8fL\nT6pfKrDuA/cbf2LQh1gwp+Jq0ioyheB7PXighY6cp2vXIxXa0135+UcxKXn4256v\nUwKd9X7DfNAIaO5MhqFdHfEttMaflZuOQ3NboR0h/S3B6mii1oeBl0H4LJSCtQ8=\n=m+Pl\n-----END PGP SIGNATURE-----\n", "payload": "tree 3ad1434cd797eb890aceec044b321a93d3246ffe\nparent c56d8eda4677c89c1a5e2771dbe637312a6f630f\nparent 5974f6f0a53614e82df9430b95bcb6e9473265fa\nauthor Michael Goulet <michael@errs.io> 1672795166 -0800\ncommitter GitHub <noreply@github.com> 1672795166 -0800\n\nRollup merge of #106045 - RalfJung:oom-nounwind-panic, r=Amanieu\n\ndefault OOM handler: use non-unwinding panic, to match std handler\n\nThe OOM handler in std will by default abort. This adjusts the default in liballoc to do the same, using the `can_unwind` flag on the panic info to indicate a non-unwinding panic.\n\nIn practice this probably makes little difference since the liballoc default will only come into play in no-std situations where people write a custom panic handler, which most likely will not implement unwinding. But still, this seems more consistent.\n\nCc `@rust-lang/wg-allocators,` https://github.com/rust-lang/rust/issues/66741\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f6b0f4707bcda7b57279f9534a999dc4419f60d1", "html_url": "https://github.com/rust-lang/rust/commit/f6b0f4707bcda7b57279f9534a999dc4419f60d1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f6b0f4707bcda7b57279f9534a999dc4419f60d1/comments", "author": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c56d8eda4677c89c1a5e2771dbe637312a6f630f", "url": "https://api.github.com/repos/rust-lang/rust/commits/c56d8eda4677c89c1a5e2771dbe637312a6f630f", "html_url": "https://github.com/rust-lang/rust/commit/c56d8eda4677c89c1a5e2771dbe637312a6f630f"}, {"sha": "5974f6f0a53614e82df9430b95bcb6e9473265fa", "url": "https://api.github.com/repos/rust-lang/rust/commits/5974f6f0a53614e82df9430b95bcb6e9473265fa", "html_url": "https://github.com/rust-lang/rust/commit/5974f6f0a53614e82df9430b95bcb6e9473265fa"}], "stats": {"total": 41, "additions": 33, "deletions": 8}, "files": [{"sha": "fe6de1cf879b2e2395173f1d4e5d3c80ea2a1fe9", "filename": "library/alloc/src/alloc.rs", "status": "modified", "additions": 14, "deletions": 1, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/f6b0f4707bcda7b57279f9534a999dc4419f60d1/library%2Falloc%2Fsrc%2Falloc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f6b0f4707bcda7b57279f9534a999dc4419f60d1/library%2Falloc%2Fsrc%2Falloc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Falloc%2Fsrc%2Falloc.rs?ref=f6b0f4707bcda7b57279f9534a999dc4419f60d1", "patch": "@@ -402,7 +402,20 @@ pub mod __alloc_error_handler {\n     // `#[alloc_error_handler]`.\n     #[rustc_std_internal_symbol]\n     pub unsafe fn __rdl_oom(size: usize, _align: usize) -> ! {\n-        panic!(\"memory allocation of {size} bytes failed\")\n+        extern \"Rust\" {\n+            // This symbol is emitted by rustc next to __rust_alloc_error_handler.\n+            // Its value depends on the -Zoom={panic,abort} compiler option.\n+            static __rust_alloc_error_handler_should_panic: u8;\n+        }\n+\n+        #[allow(unused_unsafe)]\n+        if unsafe { __rust_alloc_error_handler_should_panic != 0 } {\n+            panic!(\"memory allocation of {size} bytes failed\")\n+        } else {\n+            core::panicking::panic_nounwind_fmt(format_args!(\n+                \"memory allocation of {size} bytes failed\"\n+            ))\n+        }\n     }\n }\n "}, {"sha": "bb1a85eb2203bee7266dd89e51339106cca94299", "filename": "library/alloc/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/f6b0f4707bcda7b57279f9534a999dc4419f60d1/library%2Falloc%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f6b0f4707bcda7b57279f9534a999dc4419f60d1/library%2Falloc%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Falloc%2Fsrc%2Flib.rs?ref=f6b0f4707bcda7b57279f9534a999dc4419f60d1", "patch": "@@ -110,6 +110,7 @@\n #![feature(const_maybe_uninit_as_mut_ptr)]\n #![feature(const_refs_to_cell)]\n #![feature(core_intrinsics)]\n+#![feature(core_panic)]\n #![feature(const_eval_select)]\n #![feature(const_pin)]\n #![feature(const_waker)]"}, {"sha": "48e90e6d794005e7b9bde41b4ac440a93ade37f5", "filename": "library/core/src/panicking.rs", "status": "modified", "additions": 17, "deletions": 6, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/f6b0f4707bcda7b57279f9534a999dc4419f60d1/library%2Fcore%2Fsrc%2Fpanicking.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f6b0f4707bcda7b57279f9534a999dc4419f60d1/library%2Fcore%2Fsrc%2Fpanicking.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fpanicking.rs?ref=f6b0f4707bcda7b57279f9534a999dc4419f60d1", "patch": "@@ -64,13 +64,17 @@ pub const fn panic_fmt(fmt: fmt::Arguments<'_>) -> ! {\n     unsafe { panic_impl(&pi) }\n }\n \n-/// Like `panic`, but without unwinding and track_caller to reduce the impact on codesize.\n-/// (No `fmt` variant as a `fmt::Arguments` needs more space to be passed.)\n+/// Like `panic_fmt`, but for non-unwinding panics.\n+///\n+/// Has to be a separate function so that it can carry the `rustc_nounwind` attribute.\n #[cfg_attr(not(feature = \"panic_immediate_abort\"), inline(never), cold)]\n #[cfg_attr(feature = \"panic_immediate_abort\", inline)]\n-#[cfg_attr(not(bootstrap), lang = \"panic_nounwind\")] // needed by codegen for non-unwinding panics\n+#[track_caller]\n+// This attribute has the key side-effect that if the panic handler ignores `can_unwind`\n+// and unwinds anyway, we will hit the \"unwinding out of nounwind function\" guard,\n+// which causes a \"panic in a function that cannot unwind\".\n #[rustc_nounwind]\n-pub fn panic_nounwind(msg: &'static str) -> ! {\n+pub fn panic_nounwind_fmt(fmt: fmt::Arguments<'_>) -> ! {\n     if cfg!(feature = \"panic_immediate_abort\") {\n         super::intrinsics::abort()\n     }\n@@ -83,8 +87,6 @@ pub fn panic_nounwind(msg: &'static str) -> ! {\n     }\n \n     // PanicInfo with the `can_unwind` flag set to false forces an abort.\n-    let pieces = [msg];\n-    let fmt = fmt::Arguments::new_v1(&pieces, &[]);\n     let pi = PanicInfo::internal_constructor(Some(&fmt), Location::caller(), false);\n \n     // SAFETY: `panic_impl` is defined in safe Rust code and thus is safe to call.\n@@ -112,6 +114,15 @@ pub const fn panic(expr: &'static str) -> ! {\n     panic_fmt(fmt::Arguments::new_v1(&[expr], &[]));\n }\n \n+/// Like `panic`, but without unwinding and track_caller to reduce the impact on codesize.\n+#[cfg_attr(not(feature = \"panic_immediate_abort\"), inline(never), cold)]\n+#[cfg_attr(feature = \"panic_immediate_abort\", inline)]\n+#[cfg_attr(not(bootstrap), lang = \"panic_nounwind\")] // needed by codegen for non-unwinding panics\n+#[rustc_nounwind]\n+pub fn panic_nounwind(expr: &'static str) -> ! {\n+    panic_nounwind_fmt(fmt::Arguments::new_v1(&[expr], &[]));\n+}\n+\n #[inline]\n #[track_caller]\n #[rustc_diagnostic_item = \"panic_str\"]"}, {"sha": "c5a5991cc81c47d340a3b7b113c56339671acd7e", "filename": "library/std/src/alloc.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f6b0f4707bcda7b57279f9534a999dc4419f60d1/library%2Fstd%2Fsrc%2Falloc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f6b0f4707bcda7b57279f9534a999dc4419f60d1/library%2Fstd%2Fsrc%2Falloc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Falloc.rs?ref=f6b0f4707bcda7b57279f9534a999dc4419f60d1", "patch": "@@ -338,7 +338,7 @@ fn default_alloc_error_hook(layout: Layout) {\n \n     #[allow(unused_unsafe)]\n     if unsafe { __rust_alloc_error_handler_should_panic != 0 } {\n-        panic!(\"memory allocation of {} bytes failed\\n\", layout.size());\n+        panic!(\"memory allocation of {} bytes failed\", layout.size());\n     } else {\n         rtprintpanic!(\"memory allocation of {} bytes failed\\n\", layout.size());\n     }"}]}