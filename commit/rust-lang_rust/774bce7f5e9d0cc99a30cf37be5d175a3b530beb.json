{"sha": "774bce7f5e9d0cc99a30cf37be5d175a3b530beb", "node_id": "MDY6Q29tbWl0NzI0NzEyOjc3NGJjZTdmNWU5ZDBjYzk5YTMwY2YzN2JlNWQxNzVhM2I1MzBiZWI=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-11-27T15:58:26Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-11-27T15:58:26Z"}, "message": "Auto merge of #77484 - terhechte:support-ios-catalyst-macabi-arm64-target-triple, r=nikomatsakis\n\nAdd support for Arm64 Catalyst on ARM Macs\n\nThis is an iteration on https://github.com/rust-lang/rust/pull/63467 which was merged a while ago. In the aforementioned PR, I added support for the `X86_64-apple-ios-macabi` target triple, which is Catalyst, iOS apps running on macOS.\n\nVery soon, Apple will launch ARM64 based Macs which will introduce `aarch64_apple_darwin.rs`, macOS apps using the Darwin ABI running on ARM. This PR adds support for Catalyst apps on ARM Macs: iOS apps compiled for the darwin ABI.\n\nI don't have access to a Apple Developer Transition Kit (DTK), so I can't really test if the generated binaries work correctly. I'm vaguely hopeful that somebody with access to a DTK could give this a spin.", "tree": {"sha": "edee0890983dbb9bfbb2e092b18e1c78bf1569ba", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/edee0890983dbb9bfbb2e092b18e1c78bf1569ba"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/774bce7f5e9d0cc99a30cf37be5d175a3b530beb", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/774bce7f5e9d0cc99a30cf37be5d175a3b530beb", "html_url": "https://github.com/rust-lang/rust/commit/774bce7f5e9d0cc99a30cf37be5d175a3b530beb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/774bce7f5e9d0cc99a30cf37be5d175a3b530beb/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c9228570668803e3e6402770d55f23a12c9ae686", "url": "https://api.github.com/repos/rust-lang/rust/commits/c9228570668803e3e6402770d55f23a12c9ae686", "html_url": "https://github.com/rust-lang/rust/commit/c9228570668803e3e6402770d55f23a12c9ae686"}, {"sha": "836d43933dedde8a4c100fc3802f6832d42fb48d", "url": "https://api.github.com/repos/rust-lang/rust/commits/836d43933dedde8a4c100fc3802f6832d42fb48d", "html_url": "https://github.com/rust-lang/rust/commit/836d43933dedde8a4c100fc3802f6832d42fb48d"}], "stats": {"total": 42, "additions": 39, "deletions": 3}, "files": [{"sha": "22e2aa3b5c8b426284db04eb0c8a3502c3da1781", "filename": "compiler/rustc_codegen_ssa/src/back/link.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/774bce7f5e9d0cc99a30cf37be5d175a3b530beb/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/774bce7f5e9d0cc99a30cf37be5d175a3b530beb/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs?ref=774bce7f5e9d0cc99a30cf37be5d175a3b530beb", "patch": "@@ -2090,9 +2090,10 @@ fn add_apple_sdk(cmd: &mut dyn Linker, sess: &Session, flavor: LinkerFlavor) {\n         (\"aarch64\", \"tvos\") => \"appletvos\",\n         (\"x86_64\", \"tvos\") => \"appletvsimulator\",\n         (\"arm\", \"ios\") => \"iphoneos\",\n+        (\"aarch64\", \"ios\") if llvm_target.contains(\"macabi\") => \"macosx\",\n         (\"aarch64\", \"ios\") => \"iphoneos\",\n         (\"x86\", \"ios\") => \"iphonesimulator\",\n-        (\"x86_64\", \"ios\") if llvm_target.contains(\"macabi\") => \"macosx10.15\",\n+        (\"x86_64\", \"ios\") if llvm_target.contains(\"macabi\") => \"macosx\",\n         (\"x86_64\", \"ios\") => \"iphonesimulator\",\n         _ => {\n             sess.err(&format!(\"unsupported arch `{}` for os `{}`\", arch, os));"}, {"sha": "3a881975236f0b1b7e06d56049f94841a544476b", "filename": "compiler/rustc_target/src/spec/aarch64_apple_ios_macabi.rs", "status": "added", "additions": 31, "deletions": 0, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/774bce7f5e9d0cc99a30cf37be5d175a3b530beb/compiler%2Frustc_target%2Fsrc%2Fspec%2Faarch64_apple_ios_macabi.rs", "raw_url": "https://github.com/rust-lang/rust/raw/774bce7f5e9d0cc99a30cf37be5d175a3b530beb/compiler%2Frustc_target%2Fsrc%2Fspec%2Faarch64_apple_ios_macabi.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Faarch64_apple_ios_macabi.rs?ref=774bce7f5e9d0cc99a30cf37be5d175a3b530beb", "patch": "@@ -0,0 +1,31 @@\n+use super::apple_sdk_base::{opts, Arch};\n+use crate::spec::{Target, TargetOptions};\n+\n+pub fn target() -> Target {\n+    let base = opts(\"ios\", Arch::Arm64_macabi);\n+    Target {\n+        llvm_target: \"arm64-apple-ios-macabi\".to_string(),\n+        pointer_width: 64,\n+        data_layout: \"e-m:o-i64:64-i128:128-n32:64-S128\".to_string(),\n+        arch: \"aarch64\".to_string(),\n+        options: TargetOptions {\n+            features: \"+neon,+fp-armv8,+apple-a7\".to_string(),\n+            eliminate_frame_pointer: false,\n+            max_atomic_width: Some(128),\n+            unsupported_abis: super::arm_base::unsupported_abis(),\n+            forces_embed_bitcode: true,\n+            // Taken from a clang build on Xcode 11.4.1.\n+            // These arguments are not actually invoked - they just have\n+            // to look right to pass App Store validation.\n+            bitcode_llvm_cmdline: \"-triple\\0\\\n+                arm64-apple-ios-macabi\\0\\\n+                -emit-obj\\0\\\n+                -disable-llvm-passes\\0\\\n+                -target-abi\\0\\\n+                darwinpcs\\0\\\n+                -Os\\0\"\n+                .to_string(),\n+            ..base\n+        },\n+    }\n+}"}, {"sha": "d894f7599377e55d5414280c420eb51c3b74ca40", "filename": "compiler/rustc_target/src/spec/apple_sdk_base.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/774bce7f5e9d0cc99a30cf37be5d175a3b530beb/compiler%2Frustc_target%2Fsrc%2Fspec%2Fapple_sdk_base.rs", "raw_url": "https://github.com/rust-lang/rust/raw/774bce7f5e9d0cc99a30cf37be5d175a3b530beb/compiler%2Frustc_target%2Fsrc%2Fspec%2Fapple_sdk_base.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Fapple_sdk_base.rs?ref=774bce7f5e9d0cc99a30cf37be5d175a3b530beb", "patch": "@@ -10,6 +10,7 @@ pub enum Arch {\n     I386,\n     X86_64,\n     X86_64_macabi,\n+    Arm64_macabi,\n }\n \n fn target_cpu(arch: Arch) -> String {\n@@ -20,14 +21,15 @@ fn target_cpu(arch: Arch) -> String {\n         I386 => \"yonah\",\n         X86_64 => \"core2\",\n         X86_64_macabi => \"core2\",\n+        Arm64_macabi => \"apple-a12\",\n     }\n     .to_string()\n }\n \n fn link_env_remove(arch: Arch) -> Vec<String> {\n     match arch {\n         Armv7 | Armv7s | Arm64 | I386 | X86_64 => vec![\"MACOSX_DEPLOYMENT_TARGET\".to_string()],\n-        X86_64_macabi => vec![\"IPHONEOS_DEPLOYMENT_TARGET\".to_string()],\n+        X86_64_macabi | Arm64_macabi => vec![\"IPHONEOS_DEPLOYMENT_TARGET\".to_string()],\n     }\n }\n "}, {"sha": "b4414e53331955decd7476f5eaccaa7ea9681ecd", "filename": "compiler/rustc_target/src/spec/mod.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/774bce7f5e9d0cc99a30cf37be5d175a3b530beb/compiler%2Frustc_target%2Fsrc%2Fspec%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/774bce7f5e9d0cc99a30cf37be5d175a3b530beb/compiler%2Frustc_target%2Fsrc%2Fspec%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Fmod.rs?ref=774bce7f5e9d0cc99a30cf37be5d175a3b530beb", "patch": "@@ -579,6 +579,7 @@ supported_targets! {\n     (\"armv7-apple-ios\", armv7_apple_ios),\n     (\"armv7s-apple-ios\", armv7s_apple_ios),\n     (\"x86_64-apple-ios-macabi\", x86_64_apple_ios_macabi),\n+    (\"aarch64-apple-ios-macabi\", aarch64_apple_ios_macabi),\n     (\"aarch64-apple-tvos\", aarch64_apple_tvos),\n     (\"x86_64-apple-tvos\", x86_64_apple_tvos),\n "}, {"sha": "99e0a2b177fc08a60b072ae78af4cce7fb928b4c", "filename": "src/doc/rustc/src/platform-support.md", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/774bce7f5e9d0cc99a30cf37be5d175a3b530beb/src%2Fdoc%2Frustc%2Fsrc%2Fplatform-support.md", "raw_url": "https://github.com/rust-lang/rust/raw/774bce7f5e9d0cc99a30cf37be5d175a3b530beb/src%2Fdoc%2Frustc%2Fsrc%2Fplatform-support.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Frustc%2Fsrc%2Fplatform-support.md?ref=774bce7f5e9d0cc99a30cf37be5d175a3b530beb", "patch": "@@ -152,6 +152,7 @@ not available.\n \n target | std | host | notes\n -------|-----|------|-------\n+`aarch64-apple-ios-macabi` | ? |  | Apple Catalyst on ARM64\n `aarch64-apple-tvos` | * |  | ARM64 tvOS\n `aarch64-unknown-freebsd` | \u2713 | \u2713 | ARM64 FreeBSD\n `aarch64-unknown-hermit` | ? |  |\n@@ -207,7 +208,7 @@ target | std | host | notes\n `thumbv7a-uwp-windows-msvc` | \u2713 |  |\n `thumbv7neon-unknown-linux-musleabihf` | ? |  | Thumb2-mode ARMv7a Linux with NEON, MUSL\n `thumbv4t-none-eabi` | * |  | ARMv4T T32\n-`x86_64-apple-ios-macabi` | \u2713 |  | Apple Catalyst\n+`x86_64-apple-ios-macabi` | \u2713 |  | Apple Catalyst on x86_64\n `x86_64-apple-tvos` | * | | x86 64-bit tvOS\n `x86_64-linux-kernel` | * |  | Linux kernel modules\n `x86_64-pc-solaris` | ? |  |"}]}