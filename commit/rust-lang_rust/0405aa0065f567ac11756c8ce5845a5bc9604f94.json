{"sha": "0405aa0065f567ac11756c8ce5845a5bc9604f94", "node_id": "C_kwDOAAsO6NoAKDA0MDVhYTAwNjVmNTY3YWMxMTc1NmM4Y2U1ODQ1YTViYzk2MDRmOTQ", "commit": {"author": {"name": "antoyo", "email": "antoyo@users.noreply.github.com", "date": "2022-04-30T14:30:20Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-04-30T14:30:20Z"}, "message": "Merge pull request #163 from yvt/fix-asm-sym\n\nAdd inline assembly `sym` operands as GCC input operands", "tree": {"sha": "85a782399e7fd57682615c76382bf07b7d55e650", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/85a782399e7fd57682615c76382bf07b7d55e650"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0405aa0065f567ac11756c8ce5845a5bc9604f94", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJibUf8CRBK7hj4Ov3rIwAAXk8IAB/6hoA7nGGDv1y1fYf4HUQa\nKn6QcbSJHdR1Npb+BBmzz57TZxgFMz/lynyLBksilK00bK9JUntY1yN5bKXutWe7\nqD0PSzS/toFh6Ys1riVluC9F9EGFn/cKUB3t/MhXPGlOw22eYrF4Ulcuu8CCuwKV\n4d5wwdaMbL66Swwt6jNovcJKEfd4DHuCAAt2vPAS/TILK6Wvxf5U7j5lbKT8WWmh\nMMuEa3dlHS1oHdVZRA6ugCgnzo+aC6BdSZCgC0RsjV+dBplN83oQn15m9yZpLL3Y\n8JmHTg1Z68yBFPuCz9OvxTmxBbe/8OSE2S8tklZQCOwkifZ0na2av/AG21Ulc3g=\n=Mldc\n-----END PGP SIGNATURE-----\n", "payload": "tree 85a782399e7fd57682615c76382bf07b7d55e650\nparent 248c1c5e45ff15dd4b63348afe74b99885c75d1f\nparent 63ffdfdd1776afa2e82bbd3d2ff8ff7b7f0d5b67\nauthor antoyo <antoyo@users.noreply.github.com> 1651329020 -0400\ncommitter GitHub <noreply@github.com> 1651329020 -0400\n\nMerge pull request #163 from yvt/fix-asm-sym\n\nAdd inline assembly `sym` operands as GCC input operands"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0405aa0065f567ac11756c8ce5845a5bc9604f94", "html_url": "https://github.com/rust-lang/rust/commit/0405aa0065f567ac11756c8ce5845a5bc9604f94", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0405aa0065f567ac11756c8ce5845a5bc9604f94/comments", "author": {"login": "antoyo", "id": 584972, "node_id": "MDQ6VXNlcjU4NDk3Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/584972?v=4", "gravatar_id": "", "url": "https://api.github.com/users/antoyo", "html_url": "https://github.com/antoyo", "followers_url": "https://api.github.com/users/antoyo/followers", "following_url": "https://api.github.com/users/antoyo/following{/other_user}", "gists_url": "https://api.github.com/users/antoyo/gists{/gist_id}", "starred_url": "https://api.github.com/users/antoyo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/antoyo/subscriptions", "organizations_url": "https://api.github.com/users/antoyo/orgs", "repos_url": "https://api.github.com/users/antoyo/repos", "events_url": "https://api.github.com/users/antoyo/events{/privacy}", "received_events_url": "https://api.github.com/users/antoyo/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "248c1c5e45ff15dd4b63348afe74b99885c75d1f", "url": "https://api.github.com/repos/rust-lang/rust/commits/248c1c5e45ff15dd4b63348afe74b99885c75d1f", "html_url": "https://github.com/rust-lang/rust/commit/248c1c5e45ff15dd4b63348afe74b99885c75d1f"}, {"sha": "63ffdfdd1776afa2e82bbd3d2ff8ff7b7f0d5b67", "url": "https://api.github.com/repos/rust-lang/rust/commits/63ffdfdd1776afa2e82bbd3d2ff8ff7b7f0d5b67", "html_url": "https://github.com/rust-lang/rust/commit/63ffdfdd1776afa2e82bbd3d2ff8ff7b7f0d5b67"}], "stats": {"total": 77, "additions": 68, "deletions": 9}, "files": [{"sha": "211d19a8dc8909546bac8558553d2f8ca5c9959c", "filename": "Cargo.toml", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/0405aa0065f567ac11756c8ce5845a5bc9604f94/Cargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/0405aa0065f567ac11756c8ce5845a5bc9604f94/Cargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.toml?ref=0405aa0065f567ac11756c8ce5845a5bc9604f94", "patch": "@@ -9,8 +9,12 @@ license = \"MIT OR Apache-2.0\"\n crate-type = [\"dylib\"]\n \n [[test]]\n-name = \"lang_tests\"\n-path = \"tests/lib.rs\"\n+name = \"lang_tests_debug\"\n+path = \"tests/lang_tests_debug.rs\"\n+harness = false\n+[[test]]\n+name = \"lang_tests_release\"\n+path = \"tests/lang_tests_release.rs\"\n harness = false\n \n [features]"}, {"sha": "1cae78114c9d3bff6d25bbeffe42f8cf740ce95b", "filename": "src/asm.rs", "status": "modified", "additions": 19, "deletions": 3, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/0405aa0065f567ac11756c8ce5845a5bc9604f94/src%2Fasm.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0405aa0065f567ac11756c8ce5845a5bc9604f94/src%2Fasm.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fasm.rs?ref=0405aa0065f567ac11756c8ce5845a5bc9604f94", "patch": "@@ -13,6 +13,7 @@ use std::borrow::Cow;\n use crate::builder::Builder;\n use crate::context::CodegenCx;\n use crate::type_of::LayoutGccExt;\n+use crate::callee::get_fn;\n \n \n // Rust asm! and GCC Extended Asm semantics differ substantially.\n@@ -342,9 +343,24 @@ impl<'a, 'gcc, 'tcx> AsmBuilderMethods<'tcx> for Builder<'a, 'gcc, 'tcx> {\n                     // processed in the previous pass\n                 }\n \n-                InlineAsmOperandRef::Const { .. }\n-                | InlineAsmOperandRef::SymFn { .. }\n-                | InlineAsmOperandRef::SymStatic { .. } => {\n+                InlineAsmOperandRef::SymFn { instance } => {\n+                    inputs.push(AsmInOperand {\n+                        constraint: \"X\".into(),\n+                        rust_idx,\n+                        val: self.cx.rvalue_as_function(get_fn(self.cx, instance))\n+                            .get_address(None),\n+                    });\n+                }\n+\n+                InlineAsmOperandRef::SymStatic { def_id } => {\n+                    inputs.push(AsmInOperand {\n+                        constraint: \"X\".into(),\n+                        rust_idx,\n+                        val: self.cx.get_static(def_id).get_address(None),\n+                    });\n+                }\n+\n+                InlineAsmOperandRef::Const { .. } => {\n                     // processed in the previous pass\n                 }\n             }"}, {"sha": "8e378177e24572b1f5f199dd0550a13d72ecc096", "filename": "tests/lang_tests_common.rs", "status": "renamed", "additions": 19, "deletions": 1, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/0405aa0065f567ac11756c8ce5845a5bc9604f94/tests%2Flang_tests_common.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0405aa0065f567ac11756c8ce5845a5bc9604f94/tests%2Flang_tests_common.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Flang_tests_common.rs?ref=0405aa0065f567ac11756c8ce5845a5bc9604f94", "patch": "@@ -1,3 +1,4 @@\n+//! The common code for `tests/lang_tests_*.rs`\n use std::{\n     env::{self, current_dir},\n     path::PathBuf,\n@@ -7,7 +8,15 @@ use std::{\n use lang_tester::LangTester;\n use tempfile::TempDir;\n \n-fn main() {\n+/// Controls the compile options (e.g., optimization level) used to compile\n+/// test code.\n+#[allow(dead_code)] // Each test crate picks one variant\n+pub enum Profile {\n+    Debug,\n+    Release,\n+}\n+\n+pub fn main_inner(profile: Profile) {\n     let tempdir = TempDir::new().expect(\"temp dir\");\n     let current_dir = current_dir().expect(\"current dir\");\n     let current_dir = current_dir.to_str().expect(\"current dir\").to_string();\n@@ -42,6 +51,15 @@ fn main() {\n                 \"-o\", exe.to_str().expect(\"to_str\"),\n                 path.to_str().expect(\"to_str\"),\n             ]);\n+            match profile {\n+                Profile::Debug => {}\n+                Profile::Release => {\n+                    compiler.args(&[\n+                        \"-C\", \"opt-level=3\",\n+                        \"-C\", \"lto=no\",\n+                    ]);\n+                }\n+            }\n             // Test command 2: run `tempdir/x`.\n             let runtime = Command::new(exe);\n             vec![(\"Compiler\", compiler), (\"Run-time\", runtime)]", "previous_filename": "tests/lib.rs"}, {"sha": "96bd74883ff0ab50c184b51687f929a40358a947", "filename": "tests/lang_tests_debug.rs", "status": "added", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/0405aa0065f567ac11756c8ce5845a5bc9604f94/tests%2Flang_tests_debug.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0405aa0065f567ac11756c8ce5845a5bc9604f94/tests%2Flang_tests_debug.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Flang_tests_debug.rs?ref=0405aa0065f567ac11756c8ce5845a5bc9604f94", "patch": "@@ -0,0 +1,5 @@\n+mod lang_tests_common;\n+\n+fn main() {\n+    lang_tests_common::main_inner(lang_tests_common::Profile::Debug);\n+}"}, {"sha": "35d5d60c33ee3b10d4ab3dea57bfa83bd01218c8", "filename": "tests/lang_tests_release.rs", "status": "added", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/0405aa0065f567ac11756c8ce5845a5bc9604f94/tests%2Flang_tests_release.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0405aa0065f567ac11756c8ce5845a5bc9604f94/tests%2Flang_tests_release.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Flang_tests_release.rs?ref=0405aa0065f567ac11756c8ce5845a5bc9604f94", "patch": "@@ -0,0 +1,5 @@\n+mod lang_tests_common;\n+\n+fn main() {\n+    lang_tests_common::main_inner(lang_tests_common::Profile::Release);\n+}"}, {"sha": "ea2c5add962ae3d871cc0a1a298d9e7b8f54da98", "filename": "tests/run/int_overflow.rs", "status": "modified", "additions": 14, "deletions": 3, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/0405aa0065f567ac11756c8ce5845a5bc9604f94/tests%2Frun%2Fint_overflow.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0405aa0065f567ac11756c8ce5845a5bc9604f94/tests%2Frun%2Fint_overflow.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun%2Fint_overflow.rs?ref=0405aa0065f567ac11756c8ce5845a5bc9604f94", "patch": "@@ -1,7 +1,7 @@\n // Compiler:\n //\n // Run-time:\n-//   stdout: Panicking\n+//   stdout: Success\n //   status: signal\n \n #![allow(unused_attributes)]\n@@ -64,7 +64,9 @@ mod intrinsics {\n #[no_mangle]\n pub fn panic(_msg: &str) -> ! {\n     unsafe {\n-        libc::puts(\"Panicking\\0\" as *const str as *const u8);\n+        // Panicking is expected iff overflow checking is enabled.\n+        #[cfg(debug_assertions)]\n+        libc::puts(\"Success\\0\" as *const str as *const u8);\n         libc::fflush(libc::stdout);\n         intrinsics::abort();\n     }\n@@ -124,6 +126,15 @@ impl Add for isize {\n #[start]\n fn main(mut argc: isize, _argv: *const *const u8) -> isize {\n     let int = 9223372036854775807isize;\n-    let int = int + argc;\n+    let int = int + argc;  // overflow\n+\n+    // If overflow checking is disabled, we should reach here.\n+    #[cfg(not(debug_assertions))]\n+    unsafe {\n+        libc::puts(\"Success\\0\" as *const str as *const u8);\n+        libc::fflush(libc::stdout);\n+        intrinsics::abort();\n+    }\n+\n     int\n }"}]}