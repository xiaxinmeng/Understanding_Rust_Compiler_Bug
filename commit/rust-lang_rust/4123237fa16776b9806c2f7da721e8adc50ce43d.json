{"sha": "4123237fa16776b9806c2f7da721e8adc50ce43d", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQxMjMyMzdmYTE2Nzc2Yjk4MDZjMmY3ZGE3MjFlOGFkYzUwY2U0M2Q=", "commit": {"author": {"name": "Tyler Mandry", "email": "tmandry@gmail.com", "date": "2020-08-19T18:12:20Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-08-19T18:12:20Z"}, "message": "Rollup merge of #75648 - matklad:lazy-dropck, r=KodrAus\n\nMake OnceCell<T> transparent to dropck\n\nSee the failed build in\n\nhttps://github.com/rust-lang/rust/pull/75555#issuecomment-675016718\n\nfor an example where we need this in real life\n\nr? @ghost", "tree": {"sha": "9e1f92184d3271d04b8528eeac840c6755366a35", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9e1f92184d3271d04b8528eeac840c6755366a35"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4123237fa16776b9806c2f7da721e8adc50ce43d", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfPWuFCRBK7hj4Ov3rIwAAdHIIADVxulre84ka89BBOa6xDtc/\ngMb+cGEpt8VHZJsfuBgxR50RjWA/dt7Moya2E0LZfLjG6FWpcsdKCuprMj4uoFpt\noKRDiTmdjNgM/90qKir5yl7/1/i4G6SORKanzuPh3Vt9SmhgRf4ozzWacroe57ik\nKxfuZWZHxreGqo2J4m/uCsNWKdjTGjLbV/tJzlO57EwmAGb0tFjckwZDbxb3azhk\nkClNHtqhS60LdexEtFqdYZFi/AvE8OHK9P+EIsgmpAkqEjJQ9fhr6cNL/+YCYqOt\nanAhXL/6EZXdppGT1yMZ1+8i2Qu7RwX8ojeQYt0bBQ+eyc0/5ofx3ugRlpnwzP8=\n=RFqh\n-----END PGP SIGNATURE-----\n", "payload": "tree 9e1f92184d3271d04b8528eeac840c6755366a35\nparent 0e7e939788c3799136d77e07f387042d1c5c9636\nparent 695d86f584bf2fb1fd49d34b83166b6b28d99d10\nauthor Tyler Mandry <tmandry@gmail.com> 1597860740 -0700\ncommitter GitHub <noreply@github.com> 1597860740 -0700\n\nRollup merge of #75648 - matklad:lazy-dropck, r=KodrAus\n\nMake OnceCell<T> transparent to dropck\n\nSee the failed build in\n\nhttps://github.com/rust-lang/rust/pull/75555#issuecomment-675016718\n\nfor an example where we need this in real life\n\nr? @ghost\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4123237fa16776b9806c2f7da721e8adc50ce43d", "html_url": "https://github.com/rust-lang/rust/commit/4123237fa16776b9806c2f7da721e8adc50ce43d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4123237fa16776b9806c2f7da721e8adc50ce43d/comments", "author": {"login": "tmandry", "id": 2280544, "node_id": "MDQ6VXNlcjIyODA1NDQ=", "avatar_url": "https://avatars.githubusercontent.com/u/2280544?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmandry", "html_url": "https://github.com/tmandry", "followers_url": "https://api.github.com/users/tmandry/followers", "following_url": "https://api.github.com/users/tmandry/following{/other_user}", "gists_url": "https://api.github.com/users/tmandry/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmandry/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmandry/subscriptions", "organizations_url": "https://api.github.com/users/tmandry/orgs", "repos_url": "https://api.github.com/users/tmandry/repos", "events_url": "https://api.github.com/users/tmandry/events{/privacy}", "received_events_url": "https://api.github.com/users/tmandry/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0e7e939788c3799136d77e07f387042d1c5c9636", "url": "https://api.github.com/repos/rust-lang/rust/commits/0e7e939788c3799136d77e07f387042d1c5c9636", "html_url": "https://github.com/rust-lang/rust/commit/0e7e939788c3799136d77e07f387042d1c5c9636"}, {"sha": "695d86f584bf2fb1fd49d34b83166b6b28d99d10", "url": "https://api.github.com/repos/rust-lang/rust/commits/695d86f584bf2fb1fd49d34b83166b6b28d99d10", "html_url": "https://github.com/rust-lang/rust/commit/695d86f584bf2fb1fd49d34b83166b6b28d99d10"}], "stats": {"total": 23, "additions": 21, "deletions": 2}, "files": [{"sha": "24f921ca7e4dc7a277d30c737577197cb8f72d06", "filename": "library/core/tests/lazy.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/4123237fa16776b9806c2f7da721e8adc50ce43d/library%2Fcore%2Ftests%2Flazy.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4123237fa16776b9806c2f7da721e8adc50ce43d/library%2Fcore%2Ftests%2Flazy.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Ftests%2Flazy.rs?ref=4123237fa16776b9806c2f7da721e8adc50ce43d", "patch": "@@ -122,3 +122,12 @@ fn reentrant_init() {\n     });\n     eprintln!(\"use after free: {:?}\", dangling_ref.get().unwrap());\n }\n+\n+#[test]\n+fn dropck() {\n+    let cell = OnceCell::new();\n+    {\n+        let s = String::new();\n+        cell.set(&s).unwrap();\n+    }\n+}"}, {"sha": "c1d05213e1147d6640bb59710f2d86944124b191", "filename": "library/std/src/lazy.rs", "status": "modified", "additions": 12, "deletions": 2, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/4123237fa16776b9806c2f7da721e8adc50ce43d/library%2Fstd%2Fsrc%2Flazy.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4123237fa16776b9806c2f7da721e8adc50ce43d/library%2Fstd%2Fsrc%2Flazy.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Flazy.rs?ref=4123237fa16776b9806c2f7da721e8adc50ce43d", "patch": "@@ -386,9 +386,10 @@ impl<T> SyncOnceCell<T> {\n     }\n }\n \n-impl<T> Drop for SyncOnceCell<T> {\n+unsafe impl<#[may_dangle] T> Drop for SyncOnceCell<T> {\n     fn drop(&mut self) {\n-        // Safety: The cell is being dropped, so it can't be accessed again\n+        // Safety: The cell is being dropped, so it can't be accessed again.\n+        // We also don't touch the `T`, which validates our usage of #[may_dangle].\n         unsafe { self.take_inner() };\n     }\n }\n@@ -845,4 +846,13 @@ mod tests {\n             assert_eq!(msg, MSG);\n         }\n     }\n+\n+    #[test]\n+    fn dropck() {\n+        let cell = SyncOnceCell::new();\n+        {\n+            let s = String::new();\n+            cell.set(&s).unwrap();\n+        }\n+    }\n }"}]}