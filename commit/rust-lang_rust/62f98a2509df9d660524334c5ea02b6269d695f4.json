{"sha": "62f98a2509df9d660524334c5ea02b6269d695f4", "node_id": "MDY6Q29tbWl0NzI0NzEyOjYyZjk4YTI1MDlkZjlkNjYwNTI0MzM0YzVlYTAyYjYyNjlkNjk1ZjQ=", "commit": {"author": {"name": "Miguel Ojeda", "email": "ojeda@kernel.org", "date": "2021-01-29T15:21:12Z"}, "committer": {"name": "Miguel Ojeda", "email": "ojeda@kernel.org", "date": "2021-01-29T18:10:58Z"}, "message": "btree: use Option's unwrap_unchecked()\n\nNow that https://github.com/rust-lang/rust/issues/81383 is available,\nstart using it.\n\nSigned-off-by: Miguel Ojeda <ojeda@kernel.org>", "tree": {"sha": "7388a443cfcad2296927489b8605c61bd6ec36c7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7388a443cfcad2296927489b8605c61bd6ec36c7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/62f98a2509df9d660524334c5ea02b6269d695f4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/62f98a2509df9d660524334c5ea02b6269d695f4", "html_url": "https://github.com/rust-lang/rust/commit/62f98a2509df9d660524334c5ea02b6269d695f4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/62f98a2509df9d660524334c5ea02b6269d695f4/comments", "author": {"login": "ojeda", "id": 1054456, "node_id": "MDQ6VXNlcjEwNTQ0NTY=", "avatar_url": "https://avatars.githubusercontent.com/u/1054456?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ojeda", "html_url": "https://github.com/ojeda", "followers_url": "https://api.github.com/users/ojeda/followers", "following_url": "https://api.github.com/users/ojeda/following{/other_user}", "gists_url": "https://api.github.com/users/ojeda/gists{/gist_id}", "starred_url": "https://api.github.com/users/ojeda/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ojeda/subscriptions", "organizations_url": "https://api.github.com/users/ojeda/orgs", "repos_url": "https://api.github.com/users/ojeda/repos", "events_url": "https://api.github.com/users/ojeda/events{/privacy}", "received_events_url": "https://api.github.com/users/ojeda/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ojeda", "id": 1054456, "node_id": "MDQ6VXNlcjEwNTQ0NTY=", "avatar_url": "https://avatars.githubusercontent.com/u/1054456?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ojeda", "html_url": "https://github.com/ojeda", "followers_url": "https://api.github.com/users/ojeda/followers", "following_url": "https://api.github.com/users/ojeda/following{/other_user}", "gists_url": "https://api.github.com/users/ojeda/gists{/gist_id}", "starred_url": "https://api.github.com/users/ojeda/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ojeda/subscriptions", "organizations_url": "https://api.github.com/users/ojeda/orgs", "repos_url": "https://api.github.com/users/ojeda/repos", "events_url": "https://api.github.com/users/ojeda/events{/privacy}", "received_events_url": "https://api.github.com/users/ojeda/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c4e33b51c1a2d5e599b949fa3006467b88df253a", "url": "https://api.github.com/repos/rust-lang/rust/commits/c4e33b51c1a2d5e599b949fa3006467b88df253a", "html_url": "https://github.com/rust-lang/rust/commit/c4e33b51c1a2d5e599b949fa3006467b88df253a"}], "stats": {"total": 44, "additions": 13, "deletions": 31}, "files": [{"sha": "bd5ed985404f51b0d659f08788b054765a95dd47", "filename": "library/alloc/src/collections/btree/map.rs", "status": "modified", "additions": 5, "deletions": 6, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/62f98a2509df9d660524334c5ea02b6269d695f4/library%2Falloc%2Fsrc%2Fcollections%2Fbtree%2Fmap.rs", "raw_url": "https://github.com/rust-lang/rust/raw/62f98a2509df9d660524334c5ea02b6269d695f4/library%2Falloc%2Fsrc%2Fcollections%2Fbtree%2Fmap.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Falloc%2Fsrc%2Fcollections%2Fbtree%2Fmap.rs?ref=62f98a2509df9d660524334c5ea02b6269d695f4", "patch": "@@ -11,7 +11,6 @@ use core::ptr;\n use super::borrow::DormantMutRef;\n use super::node::{self, marker, ForceResult::*, Handle, NodeRef, Root};\n use super::search::SearchResult::*;\n-use super::unwrap_unchecked;\n \n mod entry;\n pub use entry::{Entry, OccupiedEntry, VacantEntry};\n@@ -1386,7 +1385,7 @@ impl<K, V> Drop for IntoIter<K, V> {\n \n                 unsafe {\n                     let mut node =\n-                        unwrap_unchecked(ptr::read(&self.0.front)).into_node().forget_type();\n+                        ptr::read(&self.0.front).unwrap_unchecked().into_node().forget_type();\n                     while let Some(parent) = node.deallocate_and_ascend() {\n                         node = parent.into_node().forget_type();\n                     }\n@@ -1711,7 +1710,7 @@ impl<'a, K, V> Range<'a, K, V> {\n     }\n \n     unsafe fn next_unchecked(&mut self) -> (&'a K, &'a V) {\n-        unsafe { unwrap_unchecked(self.front.as_mut()).next_unchecked() }\n+        unsafe { self.front.as_mut().unwrap_unchecked().next_unchecked() }\n     }\n }\n \n@@ -1800,7 +1799,7 @@ impl<'a, K, V> DoubleEndedIterator for Range<'a, K, V> {\n \n impl<'a, K, V> Range<'a, K, V> {\n     unsafe fn next_back_unchecked(&mut self) -> (&'a K, &'a V) {\n-        unsafe { unwrap_unchecked(self.back.as_mut()).next_back_unchecked() }\n+        unsafe { self.back.as_mut().unwrap_unchecked().next_back_unchecked() }\n     }\n }\n \n@@ -1846,7 +1845,7 @@ impl<'a, K, V> RangeMut<'a, K, V> {\n     }\n \n     unsafe fn next_unchecked(&mut self) -> (&'a K, &'a mut V) {\n-        unsafe { unwrap_unchecked(self.front.as_mut()).next_unchecked() }\n+        unsafe { self.front.as_mut().unwrap_unchecked().next_unchecked() }\n     }\n \n     /// Returns an iterator of references over the remaining items.\n@@ -1876,7 +1875,7 @@ impl<K, V> FusedIterator for RangeMut<'_, K, V> {}\n \n impl<'a, K, V> RangeMut<'a, K, V> {\n     unsafe fn next_back_unchecked(&mut self) -> (&'a K, &'a mut V) {\n-        unsafe { unwrap_unchecked(self.back.as_mut()).next_back_unchecked() }\n+        unsafe { self.back.as_mut().unwrap_unchecked().next_back_unchecked() }\n     }\n }\n "}, {"sha": "cf91c17b511ccc350951cff510908ec4b7315195", "filename": "library/alloc/src/collections/btree/mod.rs", "status": "modified", "additions": 0, "deletions": 16, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/62f98a2509df9d660524334c5ea02b6269d695f4/library%2Falloc%2Fsrc%2Fcollections%2Fbtree%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/62f98a2509df9d660524334c5ea02b6269d695f4/library%2Falloc%2Fsrc%2Fcollections%2Fbtree%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Falloc%2Fsrc%2Fcollections%2Fbtree%2Fmod.rs?ref=62f98a2509df9d660524334c5ea02b6269d695f4", "patch": "@@ -19,22 +19,6 @@ trait Recover<Q: ?Sized> {\n     fn replace(&mut self, key: Self::Key) -> Option<Self::Key>;\n }\n \n-/// Same purpose as `Option::unwrap` but doesn't always guarantee a panic\n-/// if the option contains no value.\n-/// SAFETY: the caller must ensure that the option contains a value.\n-#[inline(always)]\n-pub unsafe fn unwrap_unchecked<T>(val: Option<T>) -> T {\n-    val.unwrap_or_else(|| {\n-        if cfg!(debug_assertions) {\n-            panic!(\"'unchecked' unwrap on None in BTreeMap\");\n-        } else {\n-            unsafe {\n-                core::intrinsics::unreachable();\n-            }\n-        }\n-    })\n-}\n-\n #[cfg(test)]\n /// XorShiftRng\n struct DeterministicRng {"}, {"sha": "1ef2a572ddd91e40d85004681da877c12c09b5cf", "filename": "library/alloc/src/collections/btree/navigate.rs", "status": "modified", "additions": 5, "deletions": 6, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/62f98a2509df9d660524334c5ea02b6269d695f4/library%2Falloc%2Fsrc%2Fcollections%2Fbtree%2Fnavigate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/62f98a2509df9d660524334c5ea02b6269d695f4/library%2Falloc%2Fsrc%2Fcollections%2Fbtree%2Fnavigate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Falloc%2Fsrc%2Fcollections%2Fbtree%2Fnavigate.rs?ref=62f98a2509df9d660524334c5ea02b6269d695f4", "patch": "@@ -6,7 +6,6 @@ use core::ptr;\n \n use super::node::{marker, ForceResult::*, Handle, NodeRef};\n use super::search::SearchResult;\n-use super::unwrap_unchecked;\n \n /// Finds the leaf edges delimiting a specified range in or underneath a node.\n ///\n@@ -310,7 +309,7 @@ macro_rules! def_next_kv_uncheched_dealloc {\n                     Err(last_edge) => {\n                         unsafe {\n                             let parent_edge = last_edge.into_node().deallocate_and_ascend();\n-                            unwrap_unchecked(parent_edge).forget_node_type()\n+                            parent_edge.unwrap_unchecked().forget_node_type()\n                         }\n                     }\n                 }\n@@ -331,7 +330,7 @@ impl<'a, K, V> Handle<NodeRef<marker::Immut<'a>, K, V, marker::Leaf>, marker::Ed\n     pub unsafe fn next_unchecked(&mut self) -> (&'a K, &'a V) {\n         super::mem::replace(self, |leaf_edge| {\n             let kv = leaf_edge.next_kv();\n-            let kv = unsafe { unwrap_unchecked(kv.ok()) };\n+            let kv = unsafe { kv.ok().unwrap_unchecked() };\n             (kv.next_leaf_edge(), kv.into_kv())\n         })\n     }\n@@ -344,7 +343,7 @@ impl<'a, K, V> Handle<NodeRef<marker::Immut<'a>, K, V, marker::Leaf>, marker::Ed\n     pub unsafe fn next_back_unchecked(&mut self) -> (&'a K, &'a V) {\n         super::mem::replace(self, |leaf_edge| {\n             let kv = leaf_edge.next_back_kv();\n-            let kv = unsafe { unwrap_unchecked(kv.ok()) };\n+            let kv = unsafe { kv.ok().unwrap_unchecked() };\n             (kv.next_back_leaf_edge(), kv.into_kv())\n         })\n     }\n@@ -359,7 +358,7 @@ impl<'a, K, V> Handle<NodeRef<marker::ValMut<'a>, K, V, marker::Leaf>, marker::E\n     pub unsafe fn next_unchecked(&mut self) -> (&'a K, &'a mut V) {\n         let kv = super::mem::replace(self, |leaf_edge| {\n             let kv = leaf_edge.next_kv();\n-            let kv = unsafe { unwrap_unchecked(kv.ok()) };\n+            let kv = unsafe { kv.ok().unwrap_unchecked() };\n             (unsafe { ptr::read(&kv) }.next_leaf_edge(), kv)\n         });\n         // Doing this last is faster, according to benchmarks.\n@@ -374,7 +373,7 @@ impl<'a, K, V> Handle<NodeRef<marker::ValMut<'a>, K, V, marker::Leaf>, marker::E\n     pub unsafe fn next_back_unchecked(&mut self) -> (&'a K, &'a mut V) {\n         let kv = super::mem::replace(self, |leaf_edge| {\n             let kv = leaf_edge.next_back_kv();\n-            let kv = unsafe { unwrap_unchecked(kv.ok()) };\n+            let kv = unsafe { kv.ok().unwrap_unchecked() };\n             (unsafe { ptr::read(&kv) }.next_back_leaf_edge(), kv)\n         });\n         // Doing this last is faster, according to benchmarks."}, {"sha": "9cd016fa62f0ecc8a6791c17fa67694f73919a93", "filename": "library/alloc/src/collections/btree/remove.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/62f98a2509df9d660524334c5ea02b6269d695f4/library%2Falloc%2Fsrc%2Fcollections%2Fbtree%2Fremove.rs", "raw_url": "https://github.com/rust-lang/rust/raw/62f98a2509df9d660524334c5ea02b6269d695f4/library%2Falloc%2Fsrc%2Fcollections%2Fbtree%2Fremove.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Falloc%2Fsrc%2Fcollections%2Fbtree%2Fremove.rs?ref=62f98a2509df9d660524334c5ea02b6269d695f4", "patch": "@@ -1,6 +1,5 @@\n use super::map::MIN_LEN;\n use super::node::{marker, ForceResult::*, Handle, LeftOrRight::*, NodeRef};\n-use super::unwrap_unchecked;\n \n impl<'a, K: 'a, V: 'a> Handle<NodeRef<marker::Mut<'a>, K, V, marker::LeafOrInternal>, marker::KV> {\n     /// Removes a key-value pair from the tree, and returns that pair, as well as\n@@ -77,12 +76,12 @@ impl<'a, K: 'a, V: 'a> Handle<NodeRef<marker::Mut<'a>, K, V, marker::Internal>,\n         // the element we were asked to remove. Prefer the left adjacent KV,\n         // for the reasons listed in `choose_parent_kv`.\n         let left_leaf_kv = self.left_edge().descend().last_leaf_edge().left_kv();\n-        let left_leaf_kv = unsafe { unwrap_unchecked(left_leaf_kv.ok()) };\n+        let left_leaf_kv = unsafe { left_leaf_kv.ok().unwrap_unchecked() };\n         let (left_kv, left_hole) = left_leaf_kv.remove_leaf_kv(handle_emptied_internal_root);\n \n         // The internal node may have been stolen from or merged. Go back right\n         // to find where the original KV ended up.\n-        let mut internal = unsafe { unwrap_unchecked(left_hole.next_kv().ok()) };\n+        let mut internal = unsafe { left_hole.next_kv().ok().unwrap_unchecked() };\n         let old_kv = internal.replace_kv(left_kv.0, left_kv.1);\n         let pos = internal.next_leaf_edge();\n         (old_kv, pos)"}, {"sha": "afbf6aad5d0a7cfc54e5c77d6b9403c4290964c7", "filename": "library/alloc/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/62f98a2509df9d660524334c5ea02b6269d695f4/library%2Falloc%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/62f98a2509df9d660524334c5ea02b6269d695f4/library%2Falloc%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Falloc%2Fsrc%2Flib.rs?ref=62f98a2509df9d660524334c5ea02b6269d695f4", "patch": "@@ -111,6 +111,7 @@\n #![feature(nll)]\n #![feature(nonnull_slice_from_raw_parts)]\n #![feature(auto_traits)]\n+#![feature(option_result_unwrap_unchecked)]\n #![feature(or_patterns)]\n #![feature(pattern)]\n #![feature(ptr_internals)]"}]}