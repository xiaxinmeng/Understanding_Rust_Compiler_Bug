{"sha": "14e92d71160348d22ece30624b0843178cee23f1", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE0ZTkyZDcxMTYwMzQ4ZDIyZWNlMzA2MjRiMDg0MzE3OGNlZTIzZjE=", "commit": {"author": {"name": "Yuki Okushi", "email": "yuki.okushi@huawei.com", "date": "2021-06-15T21:32:22Z"}, "committer": {"name": "Yuki Okushi", "email": "yuki.okushi@huawei.com", "date": "2021-08-03T11:05:50Z"}, "message": "Do not suggest impl traits as type arguments", "tree": {"sha": "0ccc1daf7e794c2192351ede39236d642557c900", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0ccc1daf7e794c2192351ede39236d642557c900"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/14e92d71160348d22ece30624b0843178cee23f1", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEx6scKn6IIf/+FpBu2rpbBylhwYoFAmEJIw8ACgkQ2rpbBylh\nwYoqvg//bL09VdjTUHy/3qPeqaWAi34LF2t6isSpImEBrsujlVPv/FpslxSBKDgZ\nDHkWt8rSmWx5RwzZDtB4EYLdEv6jyQqP3Q+HyLTqMJL+ruQ0AOmNIyEQCIso/reZ\n9JZIbom4JpHud1WuJiPzv0MJxPavfiGabUrNVoWA9+OX2h1lvk50GUMyepBY9ANU\nU48ARBuwUJ/lX5eGRPgzmWLYfBexnwQCMMQDg7gHR2amE3RZh2ZdTanDUCseibtK\nMPrzYmxSk5IQfxtHCAzn9YzJ5nZ+DHQxki3HYAVRJ7DfcEgUwJnVfrU5Byh/q9hm\njnLgO3a2QwsoKiS5GoO8CSh1FeBk7FCxYvdChnxeop3EDUUkaVt0MO3ViwVsope8\njEOwYiZtOGPoS1tmYtzFIfmbuwVwezlFNUetAaozJrL13yxMlEJi0DqIJs+UqtTr\nm3IY6iQdYoOuKrvMlzj05u8HMOyx+2EpCdqwtqNF3PAMsdtXW887dYnuTzNeNbaA\npvzXHYGF0+9uG38UfZ+A1HRRfA7ZSkx8CJYtp2WRbRPpszRbLUjvfTpYqrjlXVh4\nAYtmBw0oSMjBcI3UVYswTp9js88aal8xti3s6+lK7FEMRFjW0Nnvl6Tbu2klewUZ\nDnU2A6xrWuoaynN6NyOZY1feCyQ0m9fIbBHm0/DUtglbe6ji1bU=\n=PmHX\n-----END PGP SIGNATURE-----", "payload": "tree 0ccc1daf7e794c2192351ede39236d642557c900\nparent 3354a44d2fa8d5ba6b8d6b40d2596de2c8292ec1\nauthor Yuki Okushi <yuki.okushi@huawei.com> 1623792742 +0900\ncommitter Yuki Okushi <yuki.okushi@huawei.com> 1627988750 +0900\n\nDo not suggest impl traits as type arguments\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/14e92d71160348d22ece30624b0843178cee23f1", "html_url": "https://github.com/rust-lang/rust/commit/14e92d71160348d22ece30624b0843178cee23f1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/14e92d71160348d22ece30624b0843178cee23f1/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3354a44d2fa8d5ba6b8d6b40d2596de2c8292ec1", "url": "https://api.github.com/repos/rust-lang/rust/commits/3354a44d2fa8d5ba6b8d6b40d2596de2c8292ec1", "html_url": "https://github.com/rust-lang/rust/commit/3354a44d2fa8d5ba6b8d6b40d2596de2c8292ec1"}], "stats": {"total": 87, "additions": 71, "deletions": 16}, "files": [{"sha": "c2025f3fe4da27498f64b7bef5c8fbf12b7a2f1b", "filename": "compiler/rustc_infer/src/infer/error_reporting/need_type_info.rs", "status": "modified", "additions": 4, "deletions": 16, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/14e92d71160348d22ece30624b0843178cee23f1/compiler%2Frustc_infer%2Fsrc%2Finfer%2Ferror_reporting%2Fneed_type_info.rs", "raw_url": "https://github.com/rust-lang/rust/raw/14e92d71160348d22ece30624b0843178cee23f1/compiler%2Frustc_infer%2Fsrc%2Finfer%2Ferror_reporting%2Fneed_type_info.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_infer%2Fsrc%2Finfer%2Ferror_reporting%2Fneed_type_info.rs?ref=14e92d71160348d22ece30624b0843178cee23f1", "patch": "@@ -753,23 +753,11 @@ impl<'a, 'tcx> InferCtxt<'a, 'tcx> {\n             if let (UnderspecifiedArgKind::Const { .. }, Some(parent_data)) =\n                 (&arg_data.kind, &arg_data.parent)\n             {\n-                let has_impl_trait =\n-                    self.tcx.generics_of(parent_data.def_id).params.iter().any(|param| {\n-                        matches!(\n-                            param.kind,\n-                            ty::GenericParamDefKind::Type {\n-                                synthetic: Some(\n-                                    hir::SyntheticTyParamKind::ImplTrait\n-                                        | hir::SyntheticTyParamKind::FromAttr,\n-                                ),\n-                                ..\n-                            }\n-                        )\n-                    });\n-\n                 // (#83606): Do not emit a suggestion if the parent has an `impl Trait`\n                 // as an argument otherwise it will cause the E0282 error.\n-                if !has_impl_trait || self.tcx.features().explicit_generic_args_with_impl_trait {\n+                if !self.tcx.generics_of(parent_data.def_id).has_impl_trait()\n+                    || self.tcx.features().explicit_generic_args_with_impl_trait\n+                {\n                     err.span_suggestion_verbose(\n                         span,\n                         \"consider specifying the const argument\",\n@@ -814,7 +802,7 @@ impl<'a, 'tcx> InferCtxt<'a, 'tcx> {\n             let borrow = typeck_results.borrow();\n             if let Some((DefKind::AssocFn, did)) = borrow.type_dependent_def(e.hir_id) {\n                 let generics = self.tcx.generics_of(did);\n-                if !generics.params.is_empty() {\n+                if !generics.params.is_empty() && !generics.has_impl_trait() {\n                     err.span_suggestion_verbose(\n                         segment.ident.span.shrink_to_hi(),\n                         &format!("}, {"sha": "0f89581ae669c43f031343ed0ac4b30f7ed8bf8f", "filename": "compiler/rustc_middle/src/ty/generics.rs", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/14e92d71160348d22ece30624b0843178cee23f1/compiler%2Frustc_middle%2Fsrc%2Fty%2Fgenerics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/14e92d71160348d22ece30624b0843178cee23f1/compiler%2Frustc_middle%2Fsrc%2Fty%2Fgenerics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fgenerics.rs?ref=14e92d71160348d22ece30624b0843178cee23f1", "patch": "@@ -198,6 +198,21 @@ impl<'tcx> Generics {\n             _ => bug!(\"expected const parameter, but found another generic parameter\"),\n         }\n     }\n+\n+    /// Returns `true` if `params` has `impl Trait`.\n+    pub fn has_impl_trait(&'tcx self) -> bool {\n+        self.params.iter().any(|param| {\n+            matches!(\n+                param.kind,\n+                ty::GenericParamDefKind::Type {\n+                    synthetic: Some(\n+                        hir::SyntheticTyParamKind::ImplTrait | hir::SyntheticTyParamKind::FromAttr,\n+                    ),\n+                    ..\n+                }\n+            )\n+        })\n+    }\n }\n \n /// Bounds on generics."}, {"sha": "f46fae1326c8fc27ece8a5ad7c7bc26f38eedc04", "filename": "compiler/rustc_trait_selection/src/traits/error_reporting/mod.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/14e92d71160348d22ece30624b0843178cee23f1/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/14e92d71160348d22ece30624b0843178cee23f1/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fmod.rs?ref=14e92d71160348d22ece30624b0843178cee23f1", "patch": "@@ -1603,6 +1603,7 @@ impl<'a, 'tcx> InferCtxtPrivExt<'tcx> for InferCtxt<'a, 'tcx> {\n                     let generics = self.tcx.generics_of(*def_id);\n                     if generics.params.iter().any(|p| p.name != kw::SelfUpper)\n                         && !snippet.ends_with('>')\n+                        && !generics.has_impl_trait()\n                     {\n                         // FIXME: To avoid spurious suggestions in functions where type arguments\n                         // where already supplied, we check the snippet to make sure it doesn't"}, {"sha": "5a547eb38d1f9f2e683207265a70d59f100cfb39", "filename": "src/test/ui/inference/issue-86162-1.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/14e92d71160348d22ece30624b0843178cee23f1/src%2Ftest%2Fui%2Finference%2Fissue-86162-1.rs", "raw_url": "https://github.com/rust-lang/rust/raw/14e92d71160348d22ece30624b0843178cee23f1/src%2Ftest%2Fui%2Finference%2Fissue-86162-1.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Finference%2Fissue-86162-1.rs?ref=14e92d71160348d22ece30624b0843178cee23f1", "patch": "@@ -0,0 +1,9 @@\n+// Regression test of #86162.\n+\n+fn foo(x: impl Clone) {}\n+fn gen<T>() -> T { todo!() }\n+\n+fn main() {\n+    foo(gen()); //<- Do not suggest `foo::<impl Clone>()`!\n+    //~^ ERROR: type annotations needed\n+}"}, {"sha": "f4e2161d7b86e87ba3fbb29730e72a0040e709c9", "filename": "src/test/ui/inference/issue-86162-1.stderr", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/14e92d71160348d22ece30624b0843178cee23f1/src%2Ftest%2Fui%2Finference%2Fissue-86162-1.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/14e92d71160348d22ece30624b0843178cee23f1/src%2Ftest%2Fui%2Finference%2Fissue-86162-1.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Finference%2Fissue-86162-1.stderr?ref=14e92d71160348d22ece30624b0843178cee23f1", "patch": "@@ -0,0 +1,14 @@\n+error[E0283]: type annotations needed\n+  --> $DIR/issue-86162-1.rs:7:5\n+   |\n+LL | fn foo(x: impl Clone) {}\n+   |                ----- required by this bound in `foo`\n+...\n+LL |     foo(gen()); //<- Do not suggest `foo::<impl Clone>()`!\n+   |     ^^^ cannot infer type for type parameter `impl Clone` declared on the function `foo`\n+   |\n+   = note: cannot satisfy `_: Clone`\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0283`."}, {"sha": "b8c75dd7728d282b12a367239d80bc94d771ec4d", "filename": "src/test/ui/inference/issue-86162-2.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/14e92d71160348d22ece30624b0843178cee23f1/src%2Ftest%2Fui%2Finference%2Fissue-86162-2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/14e92d71160348d22ece30624b0843178cee23f1/src%2Ftest%2Fui%2Finference%2Fissue-86162-2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Finference%2Fissue-86162-2.rs?ref=14e92d71160348d22ece30624b0843178cee23f1", "patch": "@@ -0,0 +1,14 @@\n+// Regression test of #86162.\n+\n+fn gen<T>() -> T { todo!() }\n+\n+struct Foo;\n+\n+impl Foo {\n+    fn bar(x: impl Clone) {}\n+}\n+\n+fn main() {\n+    Foo::bar(gen()); //<- Do not suggest `Foo::bar::<impl Clone>()`!\n+    //~^ ERROR: type annotations needed\n+}"}, {"sha": "19f741e1cf6f6f22a327d6d6b2205136b61c49ae", "filename": "src/test/ui/inference/issue-86162-2.stderr", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/14e92d71160348d22ece30624b0843178cee23f1/src%2Ftest%2Fui%2Finference%2Fissue-86162-2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/14e92d71160348d22ece30624b0843178cee23f1/src%2Ftest%2Fui%2Finference%2Fissue-86162-2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Finference%2Fissue-86162-2.stderr?ref=14e92d71160348d22ece30624b0843178cee23f1", "patch": "@@ -0,0 +1,14 @@\n+error[E0283]: type annotations needed\n+  --> $DIR/issue-86162-2.rs:12:5\n+   |\n+LL |     fn bar(x: impl Clone) {}\n+   |                    ----- required by this bound in `Foo::bar`\n+...\n+LL |     Foo::bar(gen()); //<- Do not suggest `Foo::bar::<impl Clone>()`!\n+   |     ^^^^^^^^ cannot infer type for type parameter `impl Clone` declared on the associated function `bar`\n+   |\n+   = note: cannot satisfy `_: Clone`\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0283`."}]}