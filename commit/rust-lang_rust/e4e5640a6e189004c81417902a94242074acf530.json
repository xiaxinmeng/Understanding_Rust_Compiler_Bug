{"sha": "e4e5640a6e189004c81417902a94242074acf530", "node_id": "MDY6Q29tbWl0NzI0NzEyOmU0ZTU2NDBhNmUxODkwMDRjODE0MTc5MDJhOTQyNDIwNzRhY2Y1MzA=", "commit": {"author": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2015-03-12T03:44:38Z"}, "committer": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2015-03-12T03:44:38Z"}, "message": "Rollup merge of #23274 - rprichard:fix-21715, r=pnkfelix\n\n  * Consumers of handle_options assume the unstable options are defined in\n   the getopts::Matches value if -Z unstable-options is set, but that's not\n   the case if there weren't any actual unstable options. Fix this by\n   always reparsing options when -Z unstable-options is set.\n\n * If both argument parsing attempts fail, print the error from the second\n   attempt rather than the first. The error from the first is very poor\n   whenever unstable options are present. e.g.:\n\n       $ rustc hello.rs -Z unstable-options --show-span\n       error: Unrecognized option: 'show-span'.\n       $ rustc hello.rs -Z unstable-options --pretty --pretty\n       error: Unrecognized option: 'pretty'.\n       $ rustc hello.rs -Z unstable-options --pretty --bad-option\n       error: Unrecognized option: 'pretty'.\n\n * On the second parse, add a separate pass to reject unstable options if\n   -Z unstable-options wasn't specified.\n\nFixes #21715.\nr? @pnkfelix", "tree": {"sha": "90c10b5f0e06db313088573503592150afa5ee04", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/90c10b5f0e06db313088573503592150afa5ee04"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e4e5640a6e189004c81417902a94242074acf530", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e4e5640a6e189004c81417902a94242074acf530", "html_url": "https://github.com/rust-lang/rust/commit/e4e5640a6e189004c81417902a94242074acf530", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e4e5640a6e189004c81417902a94242074acf530/comments", "author": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "99dc60dc249eca7a8ff4411aaafa49204403b38f", "url": "https://api.github.com/repos/rust-lang/rust/commits/99dc60dc249eca7a8ff4411aaafa49204403b38f", "html_url": "https://github.com/rust-lang/rust/commit/99dc60dc249eca7a8ff4411aaafa49204403b38f"}, {"sha": "61004f88d1a250d2086c0ad28f005380a6a64f9f", "url": "https://api.github.com/repos/rust-lang/rust/commits/61004f88d1a250d2086c0ad28f005380a6a64f9f", "html_url": "https://github.com/rust-lang/rust/commit/61004f88d1a250d2086c0ad28f005380a6a64f9f"}], "stats": {"total": 68, "additions": 43, "deletions": 25}, "files": [{"sha": "4ff3c1f0075e95ee47811bb6d48831179d7d9058", "filename": "src/librustc_driver/lib.rs", "status": "modified", "additions": 43, "deletions": 25, "changes": 68, "blob_url": "https://github.com/rust-lang/rust/blob/e4e5640a6e189004c81417902a94242074acf530/src%2Flibrustc_driver%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e4e5640a6e189004c81417902a94242074acf530/src%2Flibrustc_driver%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_driver%2Flib.rs?ref=e4e5640a6e189004c81417902a94242074acf530", "patch": "@@ -686,39 +686,57 @@ pub fn handle_options(mut args: Vec<String>) -> Option<getopts::Matches> {\n         return None;\n     }\n \n-    let matches =\n-        match getopts::getopts(&args[..], &config::optgroups()) {\n-            Ok(m) => m,\n-            Err(f_stable_attempt) => {\n-                // redo option parsing, including unstable options this time,\n-                // in anticipation that the mishandled option was one of the\n-                // unstable ones.\n-                let all_groups : Vec<getopts::OptGroup>\n-                    = config::rustc_optgroups().into_iter().map(|x|x.opt_group).collect();\n-                match getopts::getopts(&args, &all_groups) {\n-                    Ok(m_unstable) => {\n-                        let r = m_unstable.opt_strs(\"Z\");\n-                        let include_unstable_options = r.iter().any(|x| *x == \"unstable-options\");\n-                        if include_unstable_options {\n-                            m_unstable\n+    fn allows_unstable_options(matches: &getopts::Matches) -> bool {\n+        let r = matches.opt_strs(\"Z\");\n+        r.iter().any(|x| *x == \"unstable-options\")\n+    }\n+\n+    fn parse_all_options(args: &Vec<String>) -> getopts::Matches {\n+        let all_groups : Vec<getopts::OptGroup>\n+            = config::rustc_optgroups().into_iter().map(|x|x.opt_group).collect();\n+        match getopts::getopts(&args[..], &all_groups) {\n+            Ok(m) => {\n+                if !allows_unstable_options(&m) {\n+                    // If -Z unstable-options was not specified, verify that\n+                    // no unstable options were present.\n+                    for opt in config::rustc_optgroups().into_iter().filter(|x| !x.is_stable()) {\n+                        let opt_name = if !opt.opt_group.long_name.is_empty() {\n+                            &opt.opt_group.long_name\n                         } else {\n-                            early_error(&f_stable_attempt.to_string());\n+                            &opt.opt_group.short_name\n+                        };\n+                        if m.opt_present(opt_name) {\n+                            early_error(&format!(\"use of unstable option '{}' requires \\\n+                                                  -Z unstable-options\", opt_name));\n                         }\n                     }\n-                    Err(_) => {\n-                        // ignore the error from the unstable attempt; just\n-                        // pass the error we got from the first try.\n-                        early_error(&f_stable_attempt.to_string());\n-                    }\n                 }\n+                m\n             }\n-        };\n+            Err(f) => early_error(&f.to_string())\n+        }\n+    }\n \n-    let r = matches.opt_strs(\"Z\");\n-    let include_unstable_options = r.iter().any(|x| *x == \"unstable-options\");\n+    // As a speed optimization, first try to parse the command-line using just\n+    // the stable options.\n+    let matches = match getopts::getopts(&args[..], &config::optgroups()) {\n+        Ok(ref m) if allows_unstable_options(m) => {\n+            // If -Z unstable-options was specified, redo parsing with the\n+            // unstable options to ensure that unstable options are defined\n+            // in the returned getopts::Matches.\n+            parse_all_options(&args)\n+        }\n+        Ok(m) => m,\n+        Err(_) => {\n+            // redo option parsing, including unstable options this time,\n+            // in anticipation that the mishandled option was one of the\n+            // unstable ones.\n+            parse_all_options(&args)\n+        }\n+    };\n \n     if matches.opt_present(\"h\") || matches.opt_present(\"help\") {\n-        usage(matches.opt_present(\"verbose\"), include_unstable_options);\n+        usage(matches.opt_present(\"verbose\"), allows_unstable_options(&matches));\n         return None;\n     }\n "}]}