{"sha": "49a98f1508054556d1301ded432821f1bc4e1c98", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQ5YTk4ZjE1MDgwNTQ1NTZkMTMwMWRlZDQzMjgyMWYxYmM0ZTFjOTg=", "commit": {"author": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2011-07-26T00:50:08Z"}, "committer": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2011-07-26T18:12:20Z"}, "message": "Base scheduler threads on number of cores. Closes #739", "tree": {"sha": "bf32dc4593b6bbfd91ada4c900972851848ff281", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bf32dc4593b6bbfd91ada4c900972851848ff281"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/49a98f1508054556d1301ded432821f1bc4e1c98", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/49a98f1508054556d1301ded432821f1bc4e1c98", "html_url": "https://github.com/rust-lang/rust/commit/49a98f1508054556d1301ded432821f1bc4e1c98", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/49a98f1508054556d1301ded432821f1bc4e1c98/comments", "author": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "committer": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e37dd2646a4808fff5647bc8d1a45914cd157c53", "url": "https://api.github.com/repos/rust-lang/rust/commits/e37dd2646a4808fff5647bc8d1a45914cd157c53", "html_url": "https://github.com/rust-lang/rust/commit/e37dd2646a4808fff5647bc8d1a45914cd157c53"}], "stats": {"total": 44, "additions": 41, "deletions": 3}, "files": [{"sha": "029532363c8eff41118f267bf9842213f39940e7", "filename": "src/rt/rust.cpp", "status": "modified", "additions": 41, "deletions": 3, "changes": 44, "blob_url": "https://github.com/rust-lang/rust/blob/49a98f1508054556d1301ded432821f1bc4e1c98/src%2Frt%2Frust.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/49a98f1508054556d1301ded432821f1bc4e1c98/src%2Frt%2Frust.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust.cpp?ref=49a98f1508054556d1301ded432821f1bc4e1c98", "patch": "@@ -75,6 +75,46 @@ command_line_args : public kernel_owned<command_line_args>\n     }\n };\n \n+\n+#if defined(__WIN32__)\n+int get_num_cpus() {\n+    SYSTEM_INFO sysinfo;\n+    GetSystemInfo(&sysinfo);\n+\n+    return (int) sysinfo.dwNumberOfProcessors;\n+}\n+#elif defined(__BSD__)\n+int get_num_cpus() {\n+    /* swiped from http://stackoverflow.com/questions/150355/\n+       programmatically-find-the-number-of-cores-on-a-machine */\n+\n+    unsigned int numCPU;\n+    int mib[4];\n+    size_t len = sizeof(numCPU);\n+\n+    /* set the mib for hw.ncpu */\n+    mib[0] = CTL_HW;\n+    mib[1] = HW_AVAILCPU;  // alternatively, try HW_NCPU;\n+\n+    /* get the number of CPUs from the system */\n+    sysctl(mib, 2, &numCPU, &len, NULL, 0);\n+\n+    if( numCPU < 1 ) {\n+        mib[1] = HW_NCPU;\n+        sysctl( mib, 2, &numCPU, &len, NULL, 0 );\n+\n+        if( numCPU < 1 ) {\n+            numCPU = 1;\n+        }\n+    }\n+    return numCPU;\n+}\n+#elif defined(__GNUC__)\n+int get_num_cpus() {\n+    return sysconf(_SC_NPROCESSORS_ONLN);\n+}\n+#endif\n+\n int get_num_threads()\n {\n     char *env = getenv(\"RUST_THREADS\");\n@@ -83,9 +123,7 @@ int get_num_threads()\n         if(num > 0)\n             return num;\n     }\n-    // FIXME: in this case, determine the number of CPUs present on the\n-    // machine.\n-    return 1;\n+    return get_num_cpus();\n }\n \n /**"}]}