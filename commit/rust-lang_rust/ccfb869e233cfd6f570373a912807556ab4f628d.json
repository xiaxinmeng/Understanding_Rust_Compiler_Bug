{"sha": "ccfb869e233cfd6f570373a912807556ab4f628d", "node_id": "C_kwDOAAsO6NoAKGNjZmI4NjllMjMzY2ZkNmY1NzAzNzNhOTEyODA3NTU2YWI0ZjYyOGQ", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-06-29T22:21:30Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-06-29T22:21:30Z"}, "message": "Auto merge of #2288 - RalfJung:clippy, r=RalfJung\n\nadd ./miri clippy\n\nalso make ui_test comply with clippy", "tree": {"sha": "57ded320d2a3cf7e4b105c3b75d3f5dff716fc67", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/57ded320d2a3cf7e4b105c3b75d3f5dff716fc67"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ccfb869e233cfd6f570373a912807556ab4f628d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ccfb869e233cfd6f570373a912807556ab4f628d", "html_url": "https://github.com/rust-lang/rust/commit/ccfb869e233cfd6f570373a912807556ab4f628d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ccfb869e233cfd6f570373a912807556ab4f628d/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "328a8c7a1e9dbf3b86e867982f26ad3df5d38436", "url": "https://api.github.com/repos/rust-lang/rust/commits/328a8c7a1e9dbf3b86e867982f26ad3df5d38436", "html_url": "https://github.com/rust-lang/rust/commit/328a8c7a1e9dbf3b86e867982f26ad3df5d38436"}, {"sha": "e33efc75171ca48dfcd30984dfc356cdbfc5c1e4", "url": "https://api.github.com/repos/rust-lang/rust/commits/e33efc75171ca48dfcd30984dfc356cdbfc5c1e4", "html_url": "https://github.com/rust-lang/rust/commit/e33efc75171ca48dfcd30984dfc356cdbfc5c1e4"}], "stats": {"total": 36, "additions": 21, "deletions": 15}, "files": [{"sha": "7d6e39dc31b26efbe87d8b046998ddcfb7aad5b1", "filename": ".github/workflows/ci.yml", "status": "modified", "additions": 2, "deletions": 6, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ccfb869e233cfd6f570373a912807556ab4f628d/.github%2Fworkflows%2Fci.yml", "raw_url": "https://github.com/rust-lang/rust/raw/ccfb869e233cfd6f570373a912807556ab4f628d/.github%2Fworkflows%2Fci.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.github%2Fworkflows%2Fci.yml?ref=ccfb869e233cfd6f570373a912807556ab4f628d", "patch": "@@ -98,12 +98,8 @@ jobs:\n           ./rustup-toolchain \"\" -c clippy\n       - name: rustfmt\n         run: ./miri fmt --check\n-      - name: clippy (miri)\n-        run: cargo clippy --all-targets -- -D warnings\n-      #- name: Clippy (ui_test)\n-      #  run: cargo clippy --manifest-path ui_test/Cargo.toml --all-targets -- -D warnings\n-      - name: clippy (cargo-miri)\n-        run: cargo clippy --manifest-path cargo-miri/Cargo.toml --all-targets -- -D warnings\n+      - name: clippy\n+        run: ./miri clippy -- -D warnings\n       - name: rustdoc\n         run: RUSTDOCFLAGS=\"-Dwarnings\" cargo doc --document-private-items\n "}, {"sha": "6b7e9dbf03f897c45d1d5902cfa298540cd9bb1b", "filename": "miri", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ccfb869e233cfd6f570373a912807556ab4f628d/miri", "raw_url": "https://github.com/rust-lang/rust/raw/ccfb869e233cfd6f570373a912807556ab4f628d/miri", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/miri?ref=ccfb869e233cfd6f570373a912807556ab4f628d", "patch": "@@ -28,6 +28,9 @@ times and slower execution times.\n ./miri fmt <flags>:\n Format all sources and tests.  <flags> are passed to `rustfmt`.\n \n+./miri clippy <flags>:\n+Format all sources and tests.  <flags> are passed to `cargo clippy`.\n+\n   ENVIRONMENT VARIABLES\n \n MIRI_SYSROOT:\n@@ -163,6 +166,11 @@ fmt)\n     find \"$MIRIDIR\" -not \\( -name target -prune \\) -name '*.rs' \\\n         | xargs rustfmt --edition=2021 --config-path \"$MIRIDIR/rustfmt.toml\" \"$@\"\n     ;;\n+clippy)\n+    cargo clippy $CARGO_BUILD_FLAGS --manifest-path \"$MIRIDIR\"/Cargo.toml --all-targets \"$@\"\n+    cargo clippy $CARGO_BUILD_FLAGS --manifest-path \"$MIRIDIR\"/ui_test/Cargo.toml --all-targets \"$@\"\n+    cargo clippy $CARGO_BUILD_FLAGS --manifest-path \"$MIRIDIR\"/cargo-miri/Cargo.toml \"$@\"\n+    ;;\n *)\n     if [ -n \"$COMMAND\" ]; then\n       echo \"Unknown command: $COMMAND\""}, {"sha": "7b9a17145d055d5a1261beb4aabcf9d89c976b46", "filename": "rustup-toolchain", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ccfb869e233cfd6f570373a912807556ab4f628d/rustup-toolchain", "raw_url": "https://github.com/rust-lang/rust/raw/ccfb869e233cfd6f570373a912807556ab4f628d/rustup-toolchain", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/rustup-toolchain?ref=ccfb869e233cfd6f570373a912807556ab4f628d", "patch": "@@ -42,7 +42,7 @@ fi\n \n # Install and setup new toolchain.\n rustup toolchain uninstall miri\n-rustup-toolchain-install-master -n miri -c cargo -c rust-src -c rustc-dev -c llvm-tools -c rustfmt \"$@\" -- \"$NEW_COMMIT\"\n+rustup-toolchain-install-master -n miri -c cargo -c rust-src -c rustc-dev -c llvm-tools -c rustfmt -c clippy \"$@\" -- \"$NEW_COMMIT\"\n rustup override set miri\n \n # Cleanup."}, {"sha": "e7b4968a9ca6239f113c083b3d28950657707ee0", "filename": "ui_test/src/comments.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ccfb869e233cfd6f570373a912807556ab4f628d/ui_test%2Fsrc%2Fcomments.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ccfb869e233cfd6f570373a912807556ab4f628d/ui_test%2Fsrc%2Fcomments.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/ui_test%2Fsrc%2Fcomments.rs?ref=ccfb869e233cfd6f570373a912807556ab4f628d", "patch": "@@ -90,7 +90,7 @@ impl Comments {\n                     path.display()\n                 );\n                 this.revisions =\n-                    Some(revisions.trim().split_whitespace().map(|s| s.to_string()).collect());\n+                    Some(revisions.split_whitespace().map(|s| s.to_string()).collect());\n             }\n             if let Some(s) = line.strip_prefix(\"// ignore-\") {\n                 let s = s"}, {"sha": "ff0c4e1c8996b7bfc93cec289323abbce2760faa", "filename": "ui_test/src/lib.rs", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ccfb869e233cfd6f570373a912807556ab4f628d/ui_test%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ccfb869e233cfd6f570373a912807556ab4f628d/ui_test%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/ui_test%2Fsrc%2Flib.rs?ref=ccfb869e233cfd6f570373a912807556ab4f628d", "patch": "@@ -1,3 +1,5 @@\n+#![allow(clippy::enum_variant_names, clippy::useless_format, clippy::too_many_arguments)]\n+\n use std::collections::VecDeque;\n use std::fmt::Write;\n use std::path::{Path, PathBuf};\n@@ -338,17 +340,17 @@ fn check_test_result(\n         revised(\"stderr\"),\n         target,\n         &config.stderr_filters,\n-        &config,\n+        config,\n         comments,\n     );\n     check_output(\n-        &stdout,\n+        stdout,\n         path,\n         errors,\n         revised(\"stdout\"),\n         target,\n         &config.stdout_filters,\n-        &config,\n+        config,\n         comments,\n     );\n     // Check error annotations in the source against output"}, {"sha": "ea32ce4bd293466b54ffe02ff4aa56ef86dbe371", "filename": "ui_test/src/rustc_stderr.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/ccfb869e233cfd6f570373a912807556ab4f628d/ui_test%2Fsrc%2Frustc_stderr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ccfb869e233cfd6f570373a912807556ab4f628d/ui_test%2Fsrc%2Frustc_stderr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/ui_test%2Fsrc%2Frustc_stderr.rs?ref=ccfb869e233cfd6f570373a912807556ab4f628d", "patch": "@@ -117,16 +117,16 @@ impl Span {\n \n pub(crate) fn filter_annotations_from_rendered(rendered: &str) -> std::borrow::Cow<'_, str> {\n     let annotations = Regex::new(r\"\\s*//(\\[[^\\]]\\])?~.*\").unwrap();\n-    annotations.replace_all(&rendered, \"\")\n+    annotations.replace_all(rendered, \"\")\n }\n \n pub(crate) fn process(file: &Path, stderr: &[u8]) -> Diagnostics {\n-    let stderr = std::str::from_utf8(&stderr).unwrap();\n+    let stderr = std::str::from_utf8(stderr).unwrap();\n     let mut rendered = String::new();\n     let mut messages = vec![];\n     let mut messages_from_unknown_file_or_line = vec![];\n     for line in stderr.lines() {\n-        if line.starts_with(\"{\") {\n+        if line.starts_with('{') {\n             match serde_json::from_str::<RustcMessage>(line) {\n                 Ok(msg) => {\n                     write!("}, {"sha": "a45f8f8933c909890310caca0b9022e20c7409c2", "filename": "ui_test/src/tests.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ccfb869e233cfd6f570373a912807556ab4f628d/ui_test%2Fsrc%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ccfb869e233cfd6f570373a912807556ab4f628d/ui_test%2Fsrc%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/ui_test%2Fsrc%2Ftests.rs?ref=ccfb869e233cfd6f570373a912807556ab4f628d", "patch": "@@ -29,7 +29,7 @@ fn main() {\n }\n     \";\n     let path = Path::new(\"$DIR/<dummy>\");\n-    let comments = Comments::parse(&path, s);\n+    let comments = Comments::parse(path, s);\n     let mut errors = vec![];\n     let config = config();\n     let messages = vec!["}]}