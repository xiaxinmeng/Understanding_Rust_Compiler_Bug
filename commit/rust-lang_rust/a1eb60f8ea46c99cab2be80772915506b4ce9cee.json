{"sha": "a1eb60f8ea46c99cab2be80772915506b4ce9cee", "node_id": "MDY6Q29tbWl0NzI0NzEyOmExZWI2MGY4ZWE0NmM5OWNhYjJiZTgwNzcyOTE1NTA2YjRjZTljZWU=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-06-12T13:19:26Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-06-12T13:19:26Z"}, "message": "Auto merge of #4195 - thiagoarrais:division-of-integer-literals, r=flip1995\n\nAdds lint for integer division\n\nHi, folks! This is my first contribution to clippy and my first real piece of Rust code.\n\nThis is supposed to add a lint that warns for division of integers (#109). Please let me know if you need any changes.\n\nFixes #109\n\nchangelog: Add lint for integer division", "tree": {"sha": "120dc98d6d53d1353c75349ea5c4581d68077a23", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/120dc98d6d53d1353c75349ea5c4581d68077a23"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a1eb60f8ea46c99cab2be80772915506b4ce9cee", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a1eb60f8ea46c99cab2be80772915506b4ce9cee", "html_url": "https://github.com/rust-lang/rust/commit/a1eb60f8ea46c99cab2be80772915506b4ce9cee", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a1eb60f8ea46c99cab2be80772915506b4ce9cee/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cefddf784373392768b84ebec7be4c697d0b029a", "url": "https://api.github.com/repos/rust-lang/rust/commits/cefddf784373392768b84ebec7be4c697d0b029a", "html_url": "https://github.com/rust-lang/rust/commit/cefddf784373392768b84ebec7be4c697d0b029a"}, {"sha": "b364eb7b54b67a4a582a67648a51363bc9407904", "url": "https://api.github.com/repos/rust-lang/rust/commits/b364eb7b54b67a4a582a67648a51363bc9407904", "html_url": "https://github.com/rust-lang/rust/commit/b364eb7b54b67a4a582a67648a51363bc9407904"}], "stats": {"total": 101, "additions": 99, "deletions": 2}, "files": [{"sha": "5f34d24cd4704b209dcc24019eb33dffbccadfc2", "filename": "CHANGELOG.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/a1eb60f8ea46c99cab2be80772915506b4ce9cee/CHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/a1eb60f8ea46c99cab2be80772915506b4ce9cee/CHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/CHANGELOG.md?ref=a1eb60f8ea46c99cab2be80772915506b4ce9cee", "patch": "@@ -956,6 +956,7 @@ All notable changes to this project will be documented in this file.\n [`inline_fn_without_body`]: https://rust-lang.github.io/rust-clippy/master/index.html#inline_fn_without_body\n [`int_plus_one`]: https://rust-lang.github.io/rust-clippy/master/index.html#int_plus_one\n [`integer_arithmetic`]: https://rust-lang.github.io/rust-clippy/master/index.html#integer_arithmetic\n+[`integer_division`]: https://rust-lang.github.io/rust-clippy/master/index.html#integer_division\n [`into_iter_on_array`]: https://rust-lang.github.io/rust-clippy/master/index.html#into_iter_on_array\n [`into_iter_on_ref`]: https://rust-lang.github.io/rust-clippy/master/index.html#into_iter_on_ref\n [`invalid_ref`]: https://rust-lang.github.io/rust-clippy/master/index.html#invalid_ref"}, {"sha": "4c2e65300a67d86eaaac92cb2124595b3efdd4a9", "filename": "README.md", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a1eb60f8ea46c99cab2be80772915506b4ce9cee/README.md", "raw_url": "https://github.com/rust-lang/rust/raw/a1eb60f8ea46c99cab2be80772915506b4ce9cee/README.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/README.md?ref=a1eb60f8ea46c99cab2be80772915506b4ce9cee", "patch": "@@ -7,7 +7,7 @@\n \n A collection of lints to catch common mistakes and improve your [Rust](https://github.com/rust-lang/rust) code.\n \n-[There are 304 lints included in this crate!](https://rust-lang.github.io/rust-clippy/master/index.html)\n+[There are 305 lints included in this crate!](https://rust-lang.github.io/rust-clippy/master/index.html)\n \n We have a bunch of lint categories to allow you to choose how much Clippy is supposed to ~~annoy~~ help you:\n "}, {"sha": "f01322768fa007ebab4736957422c5ec5d6f6592", "filename": "clippy_lints/src/cognitive_complexity.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/a1eb60f8ea46c99cab2be80772915506b4ce9cee/clippy_lints%2Fsrc%2Fcognitive_complexity.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a1eb60f8ea46c99cab2be80772915506b4ce9cee/clippy_lints%2Fsrc%2Fcognitive_complexity.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fcognitive_complexity.rs?ref=a1eb60f8ea46c99cab2be80772915506b4ce9cee", "patch": "@@ -74,7 +74,8 @@ impl CognitiveComplexity {\n         let ret_adjust = if match_type(cx, ret_ty, &paths::RESULT) {\n             returns\n         } else {\n-            returns / 2\n+            #[allow(clippy::integer_division)]\n+            (returns / 2)\n         };\n \n         if cc + divergence < match_arms + short_circuits {"}, {"sha": "12dcfa6f661aa8016de536831525bac6de58af5e", "filename": "clippy_lints/src/integer_division.rs", "status": "added", "additions": 55, "deletions": 0, "changes": 55, "blob_url": "https://github.com/rust-lang/rust/blob/a1eb60f8ea46c99cab2be80772915506b4ce9cee/clippy_lints%2Fsrc%2Finteger_division.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a1eb60f8ea46c99cab2be80772915506b4ce9cee/clippy_lints%2Fsrc%2Finteger_division.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Finteger_division.rs?ref=a1eb60f8ea46c99cab2be80772915506b4ce9cee", "patch": "@@ -0,0 +1,55 @@\n+use crate::utils::span_help_and_lint;\n+use if_chain::if_chain;\n+use rustc::hir;\n+use rustc::lint::{LateContext, LateLintPass, LintArray, LintPass};\n+use rustc::{declare_lint_pass, declare_tool_lint};\n+\n+declare_clippy_lint! {\n+    /// **What it does:** Checks for division of integers\n+    ///\n+    /// **Why is this bad?** When outside of some very specific algorithms,\n+    /// integer division is very often a mistake because it discards the\n+    /// remainder.\n+    ///\n+    /// **Known problems:** None.\n+    ///\n+    /// **Example:**\n+    /// ```rust\n+    /// fn main() {\n+    ///     let x = 3 / 2;\n+    ///     println!(\"{}\", x);\n+    /// }\n+    /// ```\n+    pub INTEGER_DIVISION,\n+    pedantic,\n+    \"integer division may cause loss of precision\"\n+}\n+\n+declare_lint_pass!(IntegerDivision => [INTEGER_DIVISION]);\n+\n+impl<'a, 'tcx> LateLintPass<'a, 'tcx> for IntegerDivision {\n+    fn check_expr(&mut self, cx: &LateContext<'a, 'tcx>, expr: &'tcx hir::Expr) {\n+        if is_integer_division(cx, expr) {\n+            span_help_and_lint(\n+                cx,\n+                INTEGER_DIVISION,\n+                expr.span,\n+                \"integer division\",\n+                \"division of integers may cause loss of precision. consider using floats.\",\n+            );\n+        }\n+    }\n+}\n+\n+fn is_integer_division<'a, 'tcx>(cx: &LateContext<'a, 'tcx>, expr: &'tcx hir::Expr) -> bool {\n+    if_chain! {\n+        if let hir::ExprKind::Binary(binop, left, right) = &expr.node;\n+        if let hir::BinOpKind::Div = &binop.node;\n+        then {\n+            let (left_ty, right_ty) = (cx.tables.expr_ty(left), cx.tables.expr_ty(right));\n+            return left_ty.is_integral() && right_ty.is_integral();\n+        }\n+    }\n+\n+    false\n+}"}, {"sha": "2bec5cb2d0159ea0cb767f4adf3fd74849b5552c", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/a1eb60f8ea46c99cab2be80772915506b4ce9cee/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a1eb60f8ea46c99cab2be80772915506b4ce9cee/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=a1eb60f8ea46c99cab2be80772915506b4ce9cee", "patch": "@@ -197,6 +197,7 @@ pub mod infinite_iter;\n pub mod inherent_impl;\n pub mod inline_fn_without_body;\n pub mod int_plus_one;\n+pub mod integer_division;\n pub mod invalid_ref;\n pub mod items_after_statements;\n pub mod large_enum_variant;\n@@ -580,6 +581,7 @@ pub fn register_plugins(reg: &mut rustc_plugin::Registry<'_>, conf: &Conf) {\n     reg.register_late_lint_pass(box transmuting_null::TransmutingNull);\n     reg.register_late_lint_pass(box path_buf_push_overwrite::PathBufPushOverwrite);\n     reg.register_late_lint_pass(box checked_conversions::CheckedConversions);\n+    reg.register_late_lint_pass(box integer_division::IntegerDivision);\n \n     reg.register_lint_group(\"clippy::restriction\", Some(\"clippy_restriction\"), vec![\n         arithmetic::FLOAT_ARITHMETIC,\n@@ -624,6 +626,7 @@ pub fn register_plugins(reg: &mut rustc_plugin::Registry<'_>, conf: &Conf) {\n         functions::TOO_MANY_LINES,\n         if_not_else::IF_NOT_ELSE,\n         infinite_iter::MAYBE_INFINITE_ITER,\n+        integer_division::INTEGER_DIVISION,\n         items_after_statements::ITEMS_AFTER_STATEMENTS,\n         literal_representation::LARGE_DIGIT_GROUPS,\n         loops::EXPLICIT_INTO_ITER_LOOP,"}, {"sha": "e4c4000c1262653e328c150752ac12b07000267c", "filename": "clippy_lints/src/trivially_copy_pass_by_ref.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/a1eb60f8ea46c99cab2be80772915506b4ce9cee/clippy_lints%2Fsrc%2Ftrivially_copy_pass_by_ref.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a1eb60f8ea46c99cab2be80772915506b4ce9cee/clippy_lints%2Fsrc%2Ftrivially_copy_pass_by_ref.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Ftrivially_copy_pass_by_ref.rs?ref=a1eb60f8ea46c99cab2be80772915506b4ce9cee", "patch": "@@ -64,6 +64,7 @@ impl<'a, 'tcx> TriviallyCopyPassByRef {\n             // Cap the calculated bit width at 32-bits to reduce\n             // portability problems between 32 and 64-bit targets\n             let bit_width = cmp::min(bit_width, 32);\n+            #[allow(clippy::integer_division)]\n             let byte_width = bit_width / 8;\n             // Use a limit of 2 times the register byte width\n             byte_width * 2"}, {"sha": "800c75257524a542d014192b94c74496cea4f322", "filename": "tests/ui/integer_division.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/a1eb60f8ea46c99cab2be80772915506b4ce9cee/tests%2Fui%2Finteger_division.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a1eb60f8ea46c99cab2be80772915506b4ce9cee/tests%2Fui%2Finteger_division.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Finteger_division.rs?ref=a1eb60f8ea46c99cab2be80772915506b4ce9cee", "patch": "@@ -0,0 +1,9 @@\n+#![warn(clippy::integer_division)]\n+\n+fn main() {\n+    let two = 2;\n+    let n = 1 / 2;\n+    let o = 1 / two;\n+    let p = two / 4;\n+    let x = 1. / 2.0;\n+}"}, {"sha": "72a232ef3d75085ecddb056be72f645f21d67d3f", "filename": "tests/ui/integer_division.stderr", "status": "added", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/a1eb60f8ea46c99cab2be80772915506b4ce9cee/tests%2Fui%2Finteger_division.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/a1eb60f8ea46c99cab2be80772915506b4ce9cee/tests%2Fui%2Finteger_division.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Finteger_division.stderr?ref=a1eb60f8ea46c99cab2be80772915506b4ce9cee", "patch": "@@ -0,0 +1,27 @@\n+error: integer division\n+  --> $DIR/integer_division.rs:5:13\n+   |\n+LL |     let n = 1 / 2;\n+   |             ^^^^^\n+   |\n+   = note: `-D clippy::integer-division` implied by `-D warnings`\n+   = help: division of integers may cause loss of precision. consider using floats.\n+\n+error: integer division\n+  --> $DIR/integer_division.rs:6:13\n+   |\n+LL |     let o = 1 / two;\n+   |             ^^^^^^^\n+   |\n+   = help: division of integers may cause loss of precision. consider using floats.\n+\n+error: integer division\n+  --> $DIR/integer_division.rs:7:13\n+   |\n+LL |     let p = two / 4;\n+   |             ^^^^^^^\n+   |\n+   = help: division of integers may cause loss of precision. consider using floats.\n+\n+error: aborting due to 3 previous errors\n+"}]}