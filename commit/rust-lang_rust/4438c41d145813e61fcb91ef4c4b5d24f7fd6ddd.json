{"sha": "4438c41d145813e61fcb91ef4c4b5d24f7fd6ddd", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQ0MzhjNDFkMTQ1ODEzZTYxZmNiOTFlZjRjNGI1ZDI0ZjdmZDZkZGQ=", "commit": {"author": {"name": "Lukas Stevens", "email": "mail@lukas-stevens.de", "date": "2017-10-10T13:35:24Z"}, "committer": {"name": "Lukas Stevens", "email": "mail@lukas-stevens.de", "date": "2017-10-10T13:35:24Z"}, "message": "Make suggested changes\n\n- Fix copy-paste error\n- Check for opt.map_or argument after ensuring that opt is an Option\n- Use span_lint_and_then and span_suggestion\n- Update reference", "tree": {"sha": "a9bb699388d07516135613b8355bf35c861beea9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a9bb699388d07516135613b8355bf35c861beea9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4438c41d145813e61fcb91ef4c4b5d24f7fd6ddd", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4438c41d145813e61fcb91ef4c4b5d24f7fd6ddd", "html_url": "https://github.com/rust-lang/rust/commit/4438c41d145813e61fcb91ef4c4b5d24f7fd6ddd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4438c41d145813e61fcb91ef4c4b5d24f7fd6ddd/comments", "author": {"login": "lukasstevens", "id": 11629114, "node_id": "MDQ6VXNlcjExNjI5MTE0", "avatar_url": "https://avatars.githubusercontent.com/u/11629114?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lukasstevens", "html_url": "https://github.com/lukasstevens", "followers_url": "https://api.github.com/users/lukasstevens/followers", "following_url": "https://api.github.com/users/lukasstevens/following{/other_user}", "gists_url": "https://api.github.com/users/lukasstevens/gists{/gist_id}", "starred_url": "https://api.github.com/users/lukasstevens/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lukasstevens/subscriptions", "organizations_url": "https://api.github.com/users/lukasstevens/orgs", "repos_url": "https://api.github.com/users/lukasstevens/repos", "events_url": "https://api.github.com/users/lukasstevens/events{/privacy}", "received_events_url": "https://api.github.com/users/lukasstevens/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lukasstevens", "id": 11629114, "node_id": "MDQ6VXNlcjExNjI5MTE0", "avatar_url": "https://avatars.githubusercontent.com/u/11629114?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lukasstevens", "html_url": "https://github.com/lukasstevens", "followers_url": "https://api.github.com/users/lukasstevens/followers", "following_url": "https://api.github.com/users/lukasstevens/following{/other_user}", "gists_url": "https://api.github.com/users/lukasstevens/gists{/gist_id}", "starred_url": "https://api.github.com/users/lukasstevens/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lukasstevens/subscriptions", "organizations_url": "https://api.github.com/users/lukasstevens/orgs", "repos_url": "https://api.github.com/users/lukasstevens/repos", "events_url": "https://api.github.com/users/lukasstevens/events{/privacy}", "received_events_url": "https://api.github.com/users/lukasstevens/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c0fac7cf5624e19adb618477b98078d6e31f5e56", "url": "https://api.github.com/repos/rust-lang/rust/commits/c0fac7cf5624e19adb618477b98078d6e31f5e56", "html_url": "https://github.com/rust-lang/rust/commit/c0fac7cf5624e19adb618477b98078d6e31f5e56"}], "stats": {"total": 46, "additions": 25, "deletions": 21}, "files": [{"sha": "d986a548576b572c1eabac80bd171fc4b9c3f065", "filename": "clippy_lints/src/methods.rs", "status": "modified", "additions": 17, "deletions": 19, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/4438c41d145813e61fcb91ef4c4b5d24f7fd6ddd/clippy_lints%2Fsrc%2Fmethods.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4438c41d145813e61fcb91ef4c4b5d24f7fd6ddd/clippy_lints%2Fsrc%2Fmethods.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmethods.rs?ref=4438c41d145813e61fcb91ef4c4b5d24f7fd6ddd", "patch": "@@ -208,7 +208,7 @@ declare_lint! {\n     pub OPTION_MAP_OR_NONE,\n     Warn,\n     \"using `Option.map_or(None, f)`, which is more succinctly expressed as \\\n-     `map_or_else(g, f)`\"\n+     `and_then(f)`\"\n }\n \n /// **What it does:** Checks for usage of `_.filter(_).next()`.\n@@ -1243,30 +1243,28 @@ fn lint_map_unwrap_or_else<'a, 'tcx>(cx: &LateContext<'a, 'tcx>, expr: &'tcx hir\n \n /// lint use of `_.map_or(None, _)` for `Option`s\n fn lint_map_or_none<'a, 'tcx>(cx: &LateContext<'a, 'tcx>, expr: &'tcx hir::Expr, map_or_args: &'tcx [hir::Expr]) {\n-    // check if the first non-self argument to map_or() is None\n-    let map_or_arg_is_none = if let hir::Expr_::ExprPath(ref qpath) = map_or_args[1].node {\n-        match_qpath(qpath, &paths::OPTION_NONE)\n-    } else {\n-        false\n-    };\n \n-    if match_type(cx, cx.tables.expr_ty(&map_or_args[0]), &paths::OPTION) && map_or_arg_is_none {\n-        // lint message\n-        let msg = \"called `map_or(None, f)` on an Option value. This can be done more directly by calling \\\n-                   `and_then(f)` instead\";\n-        let map_or_none_snippet = snippet(cx, map_or_args[1].span, \"..\");\n-        let map_or_func_snippet = snippet(cx, map_or_args[2].span, \"..\");\n-        let multiline = map_or_func_snippet.lines().count() > 1 || map_or_none_snippet.lines().count() > 1;\n-        if multiline {\n-            span_lint(cx, OPTION_MAP_OR_NONE, expr.span, msg);\n+    if match_type(cx, cx.tables.expr_ty(&map_or_args[0]), &paths::OPTION) {\n+        // check if the first non-self argument to map_or() is None\n+        let map_or_arg_is_none = if let hir::Expr_::ExprPath(ref qpath) = map_or_args[1].node {\n+            match_qpath(qpath, &paths::OPTION_NONE)\n         } else {\n-            span_note_and_lint(\n+            false\n+        };\n+\n+        if map_or_arg_is_none {\n+            // lint message\n+            let msg = \"called `map_or(None, f)` on an Option value. This can be done more directly by calling \\\n+                       `and_then(f)` instead\";\n+            let map_or_self_snippet = snippet(cx, map_or_args[0].span, \"..\");\n+            let map_or_func_snippet = snippet(cx, map_or_args[2].span, \"..\");\n+            let hint = format!(\"{0}.and_then({1})\", map_or_self_snippet, map_or_func_snippet);\n+            span_lint_and_then(\n                 cx,\n                 OPTION_MAP_OR_NONE,\n                 expr.span,\n                 msg,\n-                expr.span,\n-                &format!(\"replace `map_or({0}, {1})` with `and_then({1})`\", map_or_none_snippet, map_or_func_snippet)\n+                |db| { db.span_suggestion(expr.span, \"try using and_then instead\", hint); },\n             );\n         }\n     }"}, {"sha": "97e8c25ad75876f19c39441d8be64aa1aa595199", "filename": "tests/ui/methods.stderr", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/4438c41d145813e61fcb91ef4c4b5d24f7fd6ddd/tests%2Fui%2Fmethods.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/4438c41d145813e61fcb91ef4c4b5d24f7fd6ddd/tests%2Fui%2Fmethods.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmethods.stderr?ref=4438c41d145813e61fcb91ef4c4b5d24f7fd6ddd", "patch": "@@ -199,10 +199,9 @@ error: called `map_or(None, f)` on an Option value. This can be done more direct\n    --> $DIR/methods.rs:144:13\n     |\n 144 |     let _ = opt.map_or(None, |x| Some(x + 1));\n-    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: try using and_then instead: `opt.and_then(|x| Some(x + 1))`\n     |\n     = note: `-D option-map-or-none` implied by `-D warnings`\n-    = note: replace `map_or(None, |x| Some(x + 1))` with `and_then(|x| Some(x + 1))`\n \n error: called `map_or(None, f)` on an Option value. This can be done more directly by calling `and_then(f)` instead\n    --> $DIR/methods.rs:146:13\n@@ -213,6 +212,13 @@ error: called `map_or(None, f)` on an Option value. This can be done more direct\n 148 | |                        }\n 149 | |                 );\n     | |_________________^\n+    |\n+help: try using and_then instead\n+    |\n+146 |     let _ = opt.and_then(|x| {\n+147 |                         Some(x + 1)\n+148 |                        });\n+    |\n \n error: unnecessary structure name repetition\n    --> $DIR/methods.rs:173:24"}]}