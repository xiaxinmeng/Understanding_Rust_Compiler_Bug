{"sha": "b450c0c86ccdc836272feeac6e1312c1a168b343", "node_id": "MDY6Q29tbWl0NzI0NzEyOmI0NTBjMGM4NmNjZGM4MzYyNzJmZWVhYzZlMTMxMmMxYTE2OGIzNDM=", "commit": {"author": {"name": "Josh Stone", "email": "jistone@redhat.com", "date": "2020-08-21T19:07:52Z"}, "committer": {"name": "Josh Stone", "email": "jistone@redhat.com", "date": "2020-08-22T20:44:54Z"}, "message": "Write coverage filenames in Version3 format", "tree": {"sha": "d0293a89ac971b5af0d0317f35f0a27bc6d749bc", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d0293a89ac971b5af0d0317f35f0a27bc6d749bc"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b450c0c86ccdc836272feeac6e1312c1a168b343", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b450c0c86ccdc836272feeac6e1312c1a168b343", "html_url": "https://github.com/rust-lang/rust/commit/b450c0c86ccdc836272feeac6e1312c1a168b343", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b450c0c86ccdc836272feeac6e1312c1a168b343/comments", "author": {"login": "cuviper", "id": 36186, "node_id": "MDQ6VXNlcjM2MTg2", "avatar_url": "https://avatars.githubusercontent.com/u/36186?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cuviper", "html_url": "https://github.com/cuviper", "followers_url": "https://api.github.com/users/cuviper/followers", "following_url": "https://api.github.com/users/cuviper/following{/other_user}", "gists_url": "https://api.github.com/users/cuviper/gists{/gist_id}", "starred_url": "https://api.github.com/users/cuviper/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cuviper/subscriptions", "organizations_url": "https://api.github.com/users/cuviper/orgs", "repos_url": "https://api.github.com/users/cuviper/repos", "events_url": "https://api.github.com/users/cuviper/events{/privacy}", "received_events_url": "https://api.github.com/users/cuviper/received_events", "type": "User", "site_admin": false}, "committer": {"login": "cuviper", "id": 36186, "node_id": "MDQ6VXNlcjM2MTg2", "avatar_url": "https://avatars.githubusercontent.com/u/36186?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cuviper", "html_url": "https://github.com/cuviper", "followers_url": "https://api.github.com/users/cuviper/followers", "following_url": "https://api.github.com/users/cuviper/following{/other_user}", "gists_url": "https://api.github.com/users/cuviper/gists{/gist_id}", "starred_url": "https://api.github.com/users/cuviper/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cuviper/subscriptions", "organizations_url": "https://api.github.com/users/cuviper/orgs", "repos_url": "https://api.github.com/users/cuviper/repos", "events_url": "https://api.github.com/users/cuviper/events{/privacy}", "received_events_url": "https://api.github.com/users/cuviper/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "fb05be00df385ed216fcb9f6712206ec64fed72e", "url": "https://api.github.com/repos/rust-lang/rust/commits/fb05be00df385ed216fcb9f6712206ec64fed72e", "html_url": "https://github.com/rust-lang/rust/commit/fb05be00df385ed216fcb9f6712206ec64fed72e"}], "stats": {"total": 18, "additions": 10, "deletions": 8}, "files": [{"sha": "81aba0cbf7d42a8a0da5f41f3855f9c42a329522", "filename": "src/rustllvm/CoverageMappingWrapper.cpp", "status": "modified", "additions": 9, "deletions": 7, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/b450c0c86ccdc836272feeac6e1312c1a168b343/src%2Frustllvm%2FCoverageMappingWrapper.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/b450c0c86ccdc836272feeac6e1312c1a168b343/src%2Frustllvm%2FCoverageMappingWrapper.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustllvm%2FCoverageMappingWrapper.cpp?ref=b450c0c86ccdc836272feeac6e1312c1a168b343", "patch": "@@ -3,6 +3,7 @@\n #include \"llvm/ProfileData/Coverage/CoverageMappingWriter.h\"\n #include \"llvm/ProfileData/InstrProf.h\"\n #include \"llvm/ADT/ArrayRef.h\"\n+#include \"llvm/Support/LEB128.h\"\n \n #include <iostream>\n \n@@ -12,14 +13,15 @@ extern \"C\" void LLVMRustCoverageWriteFilenamesSectionToBuffer(\n     const char* const Filenames[],\n     size_t FilenamesLen,\n     RustStringRef BufferOut) {\n-  SmallVector<StringRef,32> FilenameRefs;\n+  // LLVM 11's CoverageFilenamesSectionWriter uses its new `Version4` format,\n+  // so we're manually writing the `Version3` format ourselves.\n+  RawRustStringOstream OS(BufferOut);\n+  encodeULEB128(FilenamesLen, OS);\n   for (size_t i = 0; i < FilenamesLen; i++) {\n-    FilenameRefs.push_back(StringRef(Filenames[i]));\n+    StringRef Filename(Filenames[i]);\n+    encodeULEB128(Filename.size(), OS);\n+    OS << Filename;\n   }\n-  auto FilenamesWriter = coverage::CoverageFilenamesSectionWriter(\n-    makeArrayRef(FilenameRefs));\n-  RawRustStringOstream OS(BufferOut);\n-  FilenamesWriter.write(OS);\n }\n \n extern \"C\" void LLVMRustCoverageWriteMappingToBuffer(\n@@ -64,5 +66,5 @@ extern \"C\" void LLVMRustCoverageWriteMappingVarNameToString(RustStringRef Str) {\n }\n \n extern \"C\" uint32_t LLVMRustCoverageMappingVersion() {\n-  return coverage::CovMapVersion::CurrentVersion;\n+  return coverage::CovMapVersion::Version3;\n }"}, {"sha": "75bec80bdf8864a12540aaa863cbbec986302ce6", "filename": "src/test/run-make-fulldeps/instrument-coverage/expected_export_coverage.json", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b450c0c86ccdc836272feeac6e1312c1a168b343/src%2Ftest%2Frun-make-fulldeps%2Finstrument-coverage%2Fexpected_export_coverage.json", "raw_url": "https://github.com/rust-lang/rust/raw/b450c0c86ccdc836272feeac6e1312c1a168b343/src%2Ftest%2Frun-make-fulldeps%2Finstrument-coverage%2Fexpected_export_coverage.json", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Finstrument-coverage%2Fexpected_export_coverage.json?ref=b450c0c86ccdc836272feeac6e1312c1a168b343", "patch": "@@ -55,5 +55,5 @@\n     }\n   ],\n   \"type\": \"llvm.coverage.json.export\",\n-  \"version\": \"2.0.0\"\n+  \"version\": \"2.0.1\"\n }"}]}