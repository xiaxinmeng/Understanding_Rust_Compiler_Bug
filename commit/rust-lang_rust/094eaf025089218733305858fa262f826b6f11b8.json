{"sha": "094eaf025089218733305858fa262f826b6f11b8", "node_id": "MDY6Q29tbWl0NzI0NzEyOjA5NGVhZjAyNTA4OTIxODczMzMwNTg1OGZhMjYyZjgyNmI2ZjExYjg=", "commit": {"author": {"name": "Eduard-Mihai Burtescu", "email": "edy.burt@gmail.com", "date": "2016-10-19T05:00:01Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2016-10-19T05:00:01Z"}, "message": "Rollup merge of #37208 - jseyfried:fix_partially_consumed_tokens_in_macros, r=nrc\n\nmacros: fix partially consumed tokens in macro matchers\n\nFixes #37175.\n\nThis PR also avoids re-transcribing the tokens consumed by a matcher (and cloning the `TtReader` once per matcher), which improves expansion performance of the test case from #34630 by ~8%.\n\nr? @nrc", "tree": {"sha": "46370228599af762a75c9b05f8d66353d6be1139", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/46370228599af762a75c9b05f8d66353d6be1139"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/094eaf025089218733305858fa262f826b6f11b8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/094eaf025089218733305858fa262f826b6f11b8", "html_url": "https://github.com/rust-lang/rust/commit/094eaf025089218733305858fa262f826b6f11b8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/094eaf025089218733305858fa262f826b6f11b8/comments", "author": {"login": "eddyb", "id": 77424, "node_id": "MDQ6VXNlcjc3NDI0", "avatar_url": "https://avatars.githubusercontent.com/u/77424?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eddyb", "html_url": "https://github.com/eddyb", "followers_url": "https://api.github.com/users/eddyb/followers", "following_url": "https://api.github.com/users/eddyb/following{/other_user}", "gists_url": "https://api.github.com/users/eddyb/gists{/gist_id}", "starred_url": "https://api.github.com/users/eddyb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eddyb/subscriptions", "organizations_url": "https://api.github.com/users/eddyb/orgs", "repos_url": "https://api.github.com/users/eddyb/repos", "events_url": "https://api.github.com/users/eddyb/events{/privacy}", "received_events_url": "https://api.github.com/users/eddyb/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "45683187ea6887fd5ceab631b4534ed79e7f8397", "url": "https://api.github.com/repos/rust-lang/rust/commits/45683187ea6887fd5ceab631b4534ed79e7f8397", "html_url": "https://github.com/rust-lang/rust/commit/45683187ea6887fd5ceab631b4534ed79e7f8397"}, {"sha": "95a9e2a724019c11c9b69a45e7953f8ba1225df9", "url": "https://api.github.com/repos/rust-lang/rust/commits/95a9e2a724019c11c9b69a45e7953f8ba1225df9", "html_url": "https://github.com/rust-lang/rust/commit/95a9e2a724019c11c9b69a45e7953f8ba1225df9"}], "stats": {"total": 67, "additions": 52, "deletions": 15}, "files": [{"sha": "ef2e466a04398ae6f47751738f7d9a5b97940394", "filename": "src/libsyntax/ext/tt/macro_parser.rs", "status": "modified", "additions": 9, "deletions": 12, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/094eaf025089218733305858fa262f826b6f11b8/src%2Flibsyntax%2Fext%2Ftt%2Fmacro_parser.rs", "raw_url": "https://github.com/rust-lang/rust/raw/094eaf025089218733305858fa262f826b6f11b8/src%2Flibsyntax%2Fext%2Ftt%2Fmacro_parser.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Ftt%2Fmacro_parser.rs?ref=094eaf025089218733305858fa262f826b6f11b8", "patch": "@@ -476,24 +476,21 @@ pub fn parse(sess: &ParseSess,\n                 }\n                 rdr.next_token();\n             } else /* bb_eis.len() == 1 */ {\n-                let mut rust_parser = Parser::new(sess, cfg.clone(), Box::new(rdr.clone()));\n-\n-                let mut ei = bb_eis.pop().unwrap();\n-                match ei.top_elts.get_tt(ei.idx) {\n-                    TokenTree::Token(span, MatchNt(_, ident)) => {\n+                rdr.next_tok = {\n+                    let mut rust_parser = Parser::new(sess, cfg.clone(), Box::new(&mut rdr));\n+                    let mut ei = bb_eis.pop().unwrap();\n+                    if let TokenTree::Token(span, MatchNt(_, ident)) = ei.top_elts.get_tt(ei.idx) {\n                         let match_cur = ei.match_cur;\n                         (&mut ei.matches[match_cur]).push(Rc::new(MatchedNonterminal(\n                             parse_nt(&mut rust_parser, span, &ident.name.as_str()))));\n                         ei.idx += 1;\n                         ei.match_cur += 1;\n+                    } else {\n+                        unreachable!()\n                     }\n-                    _ => panic!()\n-                }\n-                cur_eis.push(ei);\n-\n-                for _ in 0..rust_parser.tokens_consumed {\n-                    let _ = rdr.next_token();\n-                }\n+                    cur_eis.push(ei);\n+                    Some(TokenAndSpan { tok: rust_parser.token, sp: rust_parser.span })\n+                };\n             }\n         }\n "}, {"sha": "205c709d6cb40deb67134614e56d47a901e215fa", "filename": "src/libsyntax/ext/tt/transcribe.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/094eaf025089218733305858fa262f826b6f11b8/src%2Flibsyntax%2Fext%2Ftt%2Ftranscribe.rs", "raw_url": "https://github.com/rust-lang/rust/raw/094eaf025089218733305858fa262f826b6f11b8/src%2Flibsyntax%2Fext%2Ftt%2Ftranscribe.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Ftt%2Ftranscribe.rs?ref=094eaf025089218733305858fa262f826b6f11b8", "patch": "@@ -48,6 +48,7 @@ pub struct TtReader<'a> {\n     /* cached: */\n     pub cur_tok: Token,\n     pub cur_span: Span,\n+    pub next_tok: Option<TokenAndSpan>,\n     /// Transform doc comments. Only useful in macro invocations\n     pub desugar_doc_comments: bool,\n     pub fatal_errs: Vec<DiagnosticBuilder<'a>>,\n@@ -100,6 +101,7 @@ pub fn new_tt_reader_with_doc_flag(sp_diag: &Handler,\n         /* dummy values, never read: */\n         cur_tok: token::Eof,\n         cur_span: DUMMY_SP,\n+        next_tok: None,\n         fatal_errs: Vec::new(),\n     };\n     tt_next_token(&mut r); /* get cur_tok and cur_span set up */\n@@ -178,6 +180,9 @@ fn lockstep_iter_size(t: &TokenTree, r: &TtReader) -> LockstepIterSize {\n /// Return the next token from the TtReader.\n /// EFFECT: advances the reader's token field\n pub fn tt_next_token(r: &mut TtReader) -> TokenAndSpan {\n+    if let Some(tok) = r.next_tok.take() {\n+        return tok;\n+    }\n     // FIXME(pcwalton): Bad copy?\n     let ret_val = TokenAndSpan {\n         tok: r.cur_tok.clone(),"}, {"sha": "e62d0d925cd4fa715b5e09e3d4edb979c50cc9aa", "filename": "src/libsyntax/parse/lexer/mod.rs", "status": "modified", "additions": 24, "deletions": 3, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/094eaf025089218733305858fa262f826b6f11b8/src%2Flibsyntax%2Fparse%2Flexer%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/094eaf025089218733305858fa262f826b6f11b8/src%2Flibsyntax%2Fparse%2Flexer%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fparse%2Flexer%2Fmod.rs?ref=094eaf025089218733305858fa262f826b6f11b8", "patch": "@@ -144,7 +144,7 @@ impl<'a> Reader for StringReader<'a> {\n \n impl<'a> Reader for TtReader<'a> {\n     fn is_eof(&self) -> bool {\n-        self.cur_tok == token::Eof\n+        self.peek().tok == token::Eof\n     }\n     fn try_next_token(&mut self) -> Result<TokenAndSpan, ()> {\n         assert!(self.fatal_errs.is_empty());\n@@ -165,10 +165,31 @@ impl<'a> Reader for TtReader<'a> {\n         self.fatal_errs.clear();\n     }\n     fn peek(&self) -> TokenAndSpan {\n-        TokenAndSpan {\n+        self.next_tok.clone().unwrap_or(TokenAndSpan {\n             tok: self.cur_tok.clone(),\n             sp: self.cur_span,\n-        }\n+        })\n+    }\n+}\n+\n+impl<'a, 'b> Reader for &'b mut TtReader<'a> {\n+    fn is_eof(&self) -> bool {\n+        (**self).is_eof()\n+    }\n+    fn try_next_token(&mut self) -> Result<TokenAndSpan, ()> {\n+        (**self).try_next_token()\n+    }\n+    fn fatal(&self, m: &str) -> FatalError {\n+        (**self).fatal(m)\n+    }\n+    fn err(&self, m: &str) {\n+        (**self).err(m)\n+    }\n+    fn emit_fatal_errors(&mut self) {\n+        (**self).emit_fatal_errors()\n+    }\n+    fn peek(&self) -> TokenAndSpan {\n+        (**self).peek()\n     }\n }\n "}, {"sha": "0d3613b573e12925c51da29f56ee662e875c1779", "filename": "src/test/run-pass/issue-37175.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/094eaf025089218733305858fa262f826b6f11b8/src%2Ftest%2Frun-pass%2Fissue-37175.rs", "raw_url": "https://github.com/rust-lang/rust/raw/094eaf025089218733305858fa262f826b6f11b8/src%2Ftest%2Frun-pass%2Fissue-37175.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fissue-37175.rs?ref=094eaf025089218733305858fa262f826b6f11b8", "patch": "@@ -0,0 +1,14 @@\n+// Copyright 2016 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+macro_rules! m { (<$t:ty>) => { stringify!($t) } }\n+fn main() {\n+    println!(\"{}\", m!(<Vec<i32>>));\n+}"}]}