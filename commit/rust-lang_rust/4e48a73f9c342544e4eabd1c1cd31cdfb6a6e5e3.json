{"sha": "4e48a73f9c342544e4eabd1c1cd31cdfb6a6e5e3", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRlNDhhNzNmOWMzNDI1NDRlNGVhYmQxYzFjZDMxY2RmYjZhNmU1ZTM=", "commit": {"author": {"name": "Edwin Cheng", "email": "edwin0cheng@gmail.com", "date": "2020-02-21T02:04:03Z"}, "committer": {"name": "Edwin Cheng", "email": "edwin0cheng@gmail.com", "date": "2020-02-21T10:33:45Z"}, "message": "Improve server version info", "tree": {"sha": "209de25b4853a596750d2963b2adec705db4efc0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/209de25b4853a596750d2963b2adec705db4efc0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4e48a73f9c342544e4eabd1c1cd31cdfb6a6e5e3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4e48a73f9c342544e4eabd1c1cd31cdfb6a6e5e3", "html_url": "https://github.com/rust-lang/rust/commit/4e48a73f9c342544e4eabd1c1cd31cdfb6a6e5e3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4e48a73f9c342544e4eabd1c1cd31cdfb6a6e5e3/comments", "author": {"login": "edwin0cheng", "id": 11014119, "node_id": "MDQ6VXNlcjExMDE0MTE5", "avatar_url": "https://avatars.githubusercontent.com/u/11014119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/edwin0cheng", "html_url": "https://github.com/edwin0cheng", "followers_url": "https://api.github.com/users/edwin0cheng/followers", "following_url": "https://api.github.com/users/edwin0cheng/following{/other_user}", "gists_url": "https://api.github.com/users/edwin0cheng/gists{/gist_id}", "starred_url": "https://api.github.com/users/edwin0cheng/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/edwin0cheng/subscriptions", "organizations_url": "https://api.github.com/users/edwin0cheng/orgs", "repos_url": "https://api.github.com/users/edwin0cheng/repos", "events_url": "https://api.github.com/users/edwin0cheng/events{/privacy}", "received_events_url": "https://api.github.com/users/edwin0cheng/received_events", "type": "User", "site_admin": false}, "committer": {"login": "edwin0cheng", "id": 11014119, "node_id": "MDQ6VXNlcjExMDE0MTE5", "avatar_url": "https://avatars.githubusercontent.com/u/11014119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/edwin0cheng", "html_url": "https://github.com/edwin0cheng", "followers_url": "https://api.github.com/users/edwin0cheng/followers", "following_url": "https://api.github.com/users/edwin0cheng/following{/other_user}", "gists_url": "https://api.github.com/users/edwin0cheng/gists{/gist_id}", "starred_url": "https://api.github.com/users/edwin0cheng/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/edwin0cheng/subscriptions", "organizations_url": "https://api.github.com/users/edwin0cheng/orgs", "repos_url": "https://api.github.com/users/edwin0cheng/repos", "events_url": "https://api.github.com/users/edwin0cheng/events{/privacy}", "received_events_url": "https://api.github.com/users/edwin0cheng/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "88014fcec04721350abc156efb1e18889fca5255", "url": "https://api.github.com/repos/rust-lang/rust/commits/88014fcec04721350abc156efb1e18889fca5255", "html_url": "https://github.com/rust-lang/rust/commit/88014fcec04721350abc156efb1e18889fca5255"}], "stats": {"total": 46, "additions": 45, "deletions": 1}, "files": [{"sha": "cda8833d14dfe953f66583120ceb679ba3c7338b", "filename": "crates/rust-analyzer/build.rs", "status": "modified", "additions": 29, "deletions": 1, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/4e48a73f9c342544e4eabd1c1cd31cdfb6a6e5e3/crates%2Frust-analyzer%2Fbuild.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4e48a73f9c342544e4eabd1c1cd31cdfb6a6e5e3/crates%2Frust-analyzer%2Fbuild.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fbuild.rs?ref=4e48a73f9c342544e4eabd1c1cd31cdfb6a6e5e3", "patch": "@@ -1,12 +1,40 @@\n //! Just embed git-hash to `--version`\n \n-use std::process::Command;\n+use std::{env, path::PathBuf, process::Command};\n \n fn main() {\n+    let _ = set_rerun();\n+\n     let rev = rev().unwrap_or_else(|| \"???????\".to_string());\n     println!(\"cargo:rustc-env=REV={}\", rev)\n }\n \n+fn set_rerun() {\n+    let mut manifest_dir = PathBuf::from(\n+        env::var(\"CARGO_MANIFEST_DIR\").expect(\"`CARGO_MANIFEST_DIR` is always set by cargo.\"),\n+    );\n+\n+    while manifest_dir.parent().is_some() {\n+        if manifest_dir.join(\".git/HEAD\").exists() {\n+            let git_dir = manifest_dir.join(\".git\");\n+\n+            println!(\"cargo:rerun-if-changed={}\", git_dir.join(\"HEAD\").display());\n+            // current branch ref\n+            if let Ok(output) =\n+                Command::new(\"git\").args(&[\"rev-parse\", \"--symbolic-full-name\", \"HEAD\"]).output()\n+            {\n+                if let Ok(ref_link) = String::from_utf8(output.stdout) {\n+                    println!(\"cargo:rerun-if-changed={}\", git_dir.join(ref_link).display());\n+                }\n+            }\n+            return;\n+        }\n+\n+        manifest_dir.pop();\n+    }\n+    println!(\"cargo:warning=Could not find `.git/HEAD` from manifest dir!\");\n+}\n+\n fn rev() -> Option<String> {\n     let output = Command::new(\"git\").args(&[\"rev-parse\", \"HEAD\"]).output().ok()?;\n     let stdout = String::from_utf8(output.stdout).ok()?;"}, {"sha": "72befe2b63a3431c7e0272a8b27a15a53d2762d9", "filename": "editors/code/package.json", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/4e48a73f9c342544e4eabd1c1cd31cdfb6a6e5e3/editors%2Fcode%2Fpackage.json", "raw_url": "https://github.com/rust-lang/rust/raw/4e48a73f9c342544e4eabd1c1cd31cdfb6a6e5e3/editors%2Fcode%2Fpackage.json", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fpackage.json?ref=4e48a73f9c342544e4eabd1c1cd31cdfb6a6e5e3", "patch": "@@ -131,6 +131,11 @@\n                 \"command\": \"rust-analyzer.ssr\",\n                 \"title\": \"Structural Search Replace\",\n                 \"category\": \"Rust Analyzer\"\n+            },\n+            {\n+                \"command\": \"rust-analyzer.serverVersion\",\n+                \"title\": \"Show RA Version\",\n+                \"category\": \"Rust Analyzer\"\n             }\n         ],\n         \"keybindings\": ["}, {"sha": "839245f48756462063e5d07004dd1950805f695b", "filename": "editors/code/src/commands/index.ts", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/4e48a73f9c342544e4eabd1c1cd31cdfb6a6e5e3/editors%2Fcode%2Fsrc%2Fcommands%2Findex.ts", "raw_url": "https://github.com/rust-lang/rust/raw/4e48a73f9c342544e4eabd1c1cd31cdfb6a6e5e3/editors%2Fcode%2Fsrc%2Fcommands%2Findex.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fcommands%2Findex.ts?ref=4e48a73f9c342544e4eabd1c1cd31cdfb6a6e5e3", "patch": "@@ -13,6 +13,7 @@ export * from './syntax_tree';\n export * from './expand_macro';\n export * from './runnables';\n export * from './ssr';\n+export * from './server_version';\n \n export function collectGarbage(ctx: Ctx): Cmd {\n     return async () => {"}, {"sha": "3a982a418a5e3dd39e4cb85aca85d601eac1524e", "filename": "editors/code/src/commands/server_version.ts", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/4e48a73f9c342544e4eabd1c1cd31cdfb6a6e5e3/editors%2Fcode%2Fsrc%2Fcommands%2Fserver_version.ts", "raw_url": "https://github.com/rust-lang/rust/raw/4e48a73f9c342544e4eabd1c1cd31cdfb6a6e5e3/editors%2Fcode%2Fsrc%2Fcommands%2Fserver_version.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fcommands%2Fserver_version.ts?ref=4e48a73f9c342544e4eabd1c1cd31cdfb6a6e5e3", "patch": "@@ -0,0 +1,9 @@\n+import * as vscode from 'vscode';\n+import { ServerVersion } from '../installation/server';\n+import { Cmd } from '../ctx';\n+\n+export function serverVersion(): Cmd {\n+    return () => {\n+        vscode.window.showInformationMessage('rust-analyzer version : ' + ServerVersion);\n+    };\n+}\n\\ No newline at end of file"}, {"sha": "de19a44e517d6127321a050887d55b23660e35a5", "filename": "editors/code/src/main.ts", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/4e48a73f9c342544e4eabd1c1cd31cdfb6a6e5e3/editors%2Fcode%2Fsrc%2Fmain.ts", "raw_url": "https://github.com/rust-lang/rust/raw/4e48a73f9c342544e4eabd1c1cd31cdfb6a6e5e3/editors%2Fcode%2Fsrc%2Fmain.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fmain.ts?ref=4e48a73f9c342544e4eabd1c1cd31cdfb6a6e5e3", "patch": "@@ -55,6 +55,7 @@ export async function activate(context: vscode.ExtensionContext) {\n     ctx.registerCommand('run', commands.run);\n     ctx.registerCommand('onEnter', commands.onEnter);\n     ctx.registerCommand('ssr', commands.ssr);\n+    ctx.registerCommand('serverVersion', commands.serverVersion);\n \n     // Internal commands which are invoked by the server.\n     ctx.registerCommand('runSingle', commands.runSingle);"}]}