{"sha": "cf1d3d03700069d6a31fc142a1808a7f3dcde429", "node_id": "C_kwDOAAsO6NoAKGNmMWQzZDAzNzAwMDY5ZDZhMzFmYzE0MmExODA4YTdmM2RjZGU0Mjk", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-01-07T11:53:45Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-01-07T11:53:45Z"}, "message": "Auto merge of #10162 - tamaroning:fix10018, r=xFrednet\n\nFix FP of single-element-loop\n\ncloses #10018\n\n---\n\nchangelog: [`single_element_loop`]: No longer lints, if the loop contains a `break` or `continue`\n[#10162](https://github.com/rust-lang/rust-clippy/pull/10162)\n<!-- changelog_checked -->", "tree": {"sha": "8f7dc6233b1f205d09ba1da3d38f76cf9a5c0980", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8f7dc6233b1f205d09ba1da3d38f76cf9a5c0980"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cf1d3d03700069d6a31fc142a1808a7f3dcde429", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cf1d3d03700069d6a31fc142a1808a7f3dcde429", "html_url": "https://github.com/rust-lang/rust/commit/cf1d3d03700069d6a31fc142a1808a7f3dcde429", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cf1d3d03700069d6a31fc142a1808a7f3dcde429/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ef5a545f9860fbbea3f6c94bad60ab87f384d458", "url": "https://api.github.com/repos/rust-lang/rust/commits/ef5a545f9860fbbea3f6c94bad60ab87f384d458", "html_url": "https://github.com/rust-lang/rust/commit/ef5a545f9860fbbea3f6c94bad60ab87f384d458"}, {"sha": "ce56cf71d956ea78c319ff510651473ca8dce47c", "url": "https://api.github.com/repos/rust-lang/rust/commits/ce56cf71d956ea78c319ff510651473ca8dce47c", "html_url": "https://github.com/rust-lang/rust/commit/ce56cf71d956ea78c319ff510651473ca8dce47c"}], "stats": {"total": 95, "additions": 94, "deletions": 1}, "files": [{"sha": "744fd61bd135c62c70efb6586f6f4e82e40ac397", "filename": "clippy_lints/src/loops/single_element_loop.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/cf1d3d03700069d6a31fc142a1808a7f3dcde429/clippy_lints%2Fsrc%2Floops%2Fsingle_element_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf1d3d03700069d6a31fc142a1808a7f3dcde429/clippy_lints%2Fsrc%2Floops%2Fsingle_element_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Floops%2Fsingle_element_loop.rs?ref=cf1d3d03700069d6a31fc142a1808a7f3dcde429", "patch": "@@ -1,6 +1,7 @@\n use super::SINGLE_ELEMENT_LOOP;\n use clippy_utils::diagnostics::span_lint_and_sugg;\n use clippy_utils::source::{indent_of, snippet_with_applicability};\n+use clippy_utils::visitors::contains_break_or_continue;\n use if_chain::if_chain;\n use rustc_ast::util::parser::PREC_PREFIX;\n use rustc_ast::Mutability;\n@@ -67,6 +68,7 @@ pub(super) fn check<'tcx>(\n     if_chain! {\n         if let ExprKind::Block(block, _) = body.kind;\n         if !block.stmts.is_empty();\n+        if !contains_break_or_continue(body);\n         then {\n             let mut applicability = Applicability::MachineApplicable;\n             let pat_snip = snippet_with_applicability(cx, pat.span, \"..\", &mut applicability);"}, {"sha": "14c01a60b4c32b775e7aa5cce1ce9a242b363fd7", "filename": "clippy_utils/src/visitors.rs", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/cf1d3d03700069d6a31fc142a1808a7f3dcde429/clippy_utils%2Fsrc%2Fvisitors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf1d3d03700069d6a31fc142a1808a7f3dcde429/clippy_utils%2Fsrc%2Fvisitors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_utils%2Fsrc%2Fvisitors.rs?ref=cf1d3d03700069d6a31fc142a1808a7f3dcde429", "patch": "@@ -724,3 +724,14 @@ pub fn for_each_local_assignment<'tcx, B>(\n         ControlFlow::Continue(())\n     }\n }\n+\n+pub fn contains_break_or_continue(expr: &Expr<'_>) -> bool {\n+    for_each_expr(expr, |e| {\n+        if matches!(e.kind, ExprKind::Break(..) | ExprKind::Continue(..)) {\n+            ControlFlow::Break(())\n+        } else {\n+            ControlFlow::Continue(())\n+        }\n+    })\n+    .is_some()\n+}"}, {"sha": "a0dcc0172e8b0ba5cba4f7952aad8c521f9023aa", "filename": "tests/ui/single_element_loop.fixed", "status": "modified", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/cf1d3d03700069d6a31fc142a1808a7f3dcde429/tests%2Fui%2Fsingle_element_loop.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/cf1d3d03700069d6a31fc142a1808a7f3dcde429/tests%2Fui%2Fsingle_element_loop.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fsingle_element_loop.fixed?ref=cf1d3d03700069d6a31fc142a1808a7f3dcde429", "patch": "@@ -33,4 +33,31 @@ fn main() {\n         let item = 0..5;\n         dbg!(item);\n     }\n+\n+    // should not lint (issue #10018)\n+    for e in [42] {\n+        if e > 0 {\n+            continue;\n+        }\n+    }\n+\n+    // should not lint (issue #10018)\n+    for e in [42] {\n+        if e > 0 {\n+            break;\n+        }\n+    }\n+\n+    // should lint (issue #10018)\n+    {\n+        let _ = 42;\n+        let _f = |n: u32| {\n+            for i in 0..n {\n+                if i > 10 {\n+                    dbg!(i);\n+                    break;\n+                }\n+            }\n+        };\n+    }\n }"}, {"sha": "bc014035c98a5671c8ccc59c9b96ebff077c646e", "filename": "tests/ui/single_element_loop.rs", "status": "modified", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/cf1d3d03700069d6a31fc142a1808a7f3dcde429/tests%2Fui%2Fsingle_element_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf1d3d03700069d6a31fc142a1808a7f3dcde429/tests%2Fui%2Fsingle_element_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fsingle_element_loop.rs?ref=cf1d3d03700069d6a31fc142a1808a7f3dcde429", "patch": "@@ -27,4 +27,30 @@ fn main() {\n     for item in [0..5].into_iter() {\n         dbg!(item);\n     }\n+\n+    // should not lint (issue #10018)\n+    for e in [42] {\n+        if e > 0 {\n+            continue;\n+        }\n+    }\n+\n+    // should not lint (issue #10018)\n+    for e in [42] {\n+        if e > 0 {\n+            break;\n+        }\n+    }\n+\n+    // should lint (issue #10018)\n+    for _ in [42] {\n+        let _f = |n: u32| {\n+            for i in 0..n {\n+                if i > 10 {\n+                    dbg!(i);\n+                    break;\n+                }\n+            }\n+        };\n+    }\n }"}, {"sha": "14437a59745e04896bb17e386eefb04cb505f7a8", "filename": "tests/ui/single_element_loop.stderr", "status": "modified", "additions": 28, "deletions": 1, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/cf1d3d03700069d6a31fc142a1808a7f3dcde429/tests%2Fui%2Fsingle_element_loop.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/cf1d3d03700069d6a31fc142a1808a7f3dcde429/tests%2Fui%2Fsingle_element_loop.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fsingle_element_loop.stderr?ref=cf1d3d03700069d6a31fc142a1808a7f3dcde429", "patch": "@@ -95,5 +95,32 @@ LL +         dbg!(item);\n LL +     }\n    |\n \n-error: aborting due to 6 previous errors\n+error: for loop over a single element\n+  --> $DIR/single_element_loop.rs:46:5\n+   |\n+LL | /     for _ in [42] {\n+LL | |         let _f = |n: u32| {\n+LL | |             for i in 0..n {\n+LL | |                 if i > 10 {\n+...  |\n+LL | |         };\n+LL | |     }\n+   | |_____^\n+   |\n+help: try\n+   |\n+LL ~     {\n+LL +         let _ = 42;\n+LL +         let _f = |n: u32| {\n+LL +             for i in 0..n {\n+LL +                 if i > 10 {\n+LL +                     dbg!(i);\n+LL +                     break;\n+LL +                 }\n+LL +             }\n+LL +         };\n+LL +     }\n+   |\n+\n+error: aborting due to 7 previous errors\n "}]}