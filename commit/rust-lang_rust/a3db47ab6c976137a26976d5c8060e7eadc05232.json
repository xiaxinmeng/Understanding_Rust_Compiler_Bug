{"sha": "a3db47ab6c976137a26976d5c8060e7eadc05232", "node_id": "MDY6Q29tbWl0NzI0NzEyOmEzZGI0N2FiNmM5NzYxMzdhMjY5NzZkNWM4MDYwZTdlYWRjMDUyMzI=", "commit": {"author": {"name": "Kevin Per", "email": "kevin.per@protonmail.com", "date": "2021-02-09T17:18:28Z"}, "committer": {"name": "Kevin Per", "email": "kevin.per@protonmail.com", "date": "2021-02-24T07:07:53Z"}, "message": "Add suggestion for iterators in iterators", "tree": {"sha": "a15d4c1a3093ce2434a3b64169e92067d863955f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a15d4c1a3093ce2434a3b64169e92067d863955f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a3db47ab6c976137a26976d5c8060e7eadc05232", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a3db47ab6c976137a26976d5c8060e7eadc05232", "html_url": "https://github.com/rust-lang/rust/commit/a3db47ab6c976137a26976d5c8060e7eadc05232", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a3db47ab6c976137a26976d5c8060e7eadc05232/comments", "author": {"login": "kper", "id": 10795807, "node_id": "MDQ6VXNlcjEwNzk1ODA3", "avatar_url": "https://avatars.githubusercontent.com/u/10795807?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kper", "html_url": "https://github.com/kper", "followers_url": "https://api.github.com/users/kper/followers", "following_url": "https://api.github.com/users/kper/following{/other_user}", "gists_url": "https://api.github.com/users/kper/gists{/gist_id}", "starred_url": "https://api.github.com/users/kper/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kper/subscriptions", "organizations_url": "https://api.github.com/users/kper/orgs", "repos_url": "https://api.github.com/users/kper/repos", "events_url": "https://api.github.com/users/kper/events{/privacy}", "received_events_url": "https://api.github.com/users/kper/received_events", "type": "User", "site_admin": false}, "committer": {"login": "kper", "id": 10795807, "node_id": "MDQ6VXNlcjEwNzk1ODA3", "avatar_url": "https://avatars.githubusercontent.com/u/10795807?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kper", "html_url": "https://github.com/kper", "followers_url": "https://api.github.com/users/kper/followers", "following_url": "https://api.github.com/users/kper/following{/other_user}", "gists_url": "https://api.github.com/users/kper/gists{/gist_id}", "starred_url": "https://api.github.com/users/kper/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kper/subscriptions", "organizations_url": "https://api.github.com/users/kper/orgs", "repos_url": "https://api.github.com/users/kper/repos", "events_url": "https://api.github.com/users/kper/events{/privacy}", "received_events_url": "https://api.github.com/users/kper/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "fe1bf8e05c39bdcc73fc09e246b7209444e389bc", "url": "https://api.github.com/repos/rust-lang/rust/commits/fe1bf8e05c39bdcc73fc09e246b7209444e389bc", "html_url": "https://github.com/rust-lang/rust/commit/fe1bf8e05c39bdcc73fc09e246b7209444e389bc"}], "stats": {"total": 66, "additions": 62, "deletions": 4}, "files": [{"sha": "24b9408ffb657d758bcd1aec9157918818be1dcf", "filename": "compiler/rustc_mir/src/borrow_check/diagnostics/conflict_errors.rs", "status": "modified", "additions": 29, "deletions": 4, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/a3db47ab6c976137a26976d5c8060e7eadc05232/compiler%2Frustc_mir%2Fsrc%2Fborrow_check%2Fdiagnostics%2Fconflict_errors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a3db47ab6c976137a26976d5c8060e7eadc05232/compiler%2Frustc_mir%2Fsrc%2Fborrow_check%2Fdiagnostics%2Fconflict_errors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Fborrow_check%2Fdiagnostics%2Fconflict_errors.rs?ref=a3db47ab6c976137a26976d5c8060e7eadc05232", "patch": "@@ -10,16 +10,18 @@ use rustc_middle::mir::{\n     FakeReadCause, Local, LocalDecl, LocalInfo, LocalKind, Location, Operand, Place, PlaceRef,\n     ProjectionElem, Rvalue, Statement, StatementKind, Terminator, TerminatorKind, VarBindingForm,\n };\n-use rustc_middle::ty::{self, suggest_constraining_type_param, Instance, Ty};\n-use rustc_span::{source_map::DesugaringKind, symbol::sym, Span};\n+use rustc_middle::ty::{self, suggest_constraining_type_param, Ty, TypeFoldable};\n+use rustc_span::source_map::DesugaringKind;\n+use rustc_span::symbol::sym;\n+use rustc_span::Span;\n \n use crate::dataflow::drop_flag_effects;\n use crate::dataflow::indexes::{MoveOutIndex, MovePathIndex};\n use crate::util::borrowck_errors;\n \n use crate::borrow_check::{\n-    borrow_set::BorrowData, prefixes::IsPrefixOf, InitializationRequiringAction, MirBorrowckCtxt,\n-    PrefixSet, WriteKind,\n+    borrow_set::BorrowData, diagnostics::Instance, prefixes::IsPrefixOf,\n+    InitializationRequiringAction, MirBorrowckCtxt, PrefixSet, WriteKind,\n };\n \n use super::{\n@@ -1267,6 +1269,29 @@ impl<'cx, 'tcx> MirBorrowckCtxt<'cx, 'tcx> {\n \n         if return_span != borrow_span {\n             err.span_label(borrow_span, note);\n+\n+            let tcx = self.infcx.tcx;\n+            let ty_params = ty::List::empty();\n+\n+            let return_ty = self.regioncx.universal_regions().unnormalized_output_ty;\n+            let return_ty = tcx.erase_regions(return_ty);\n+\n+            // to avoid panics\n+            if !return_ty.has_infer_types() {\n+                if let Some(iter_trait) = tcx.get_diagnostic_item(sym::Iterator) {\n+                    if tcx.type_implements_trait((iter_trait, return_ty, ty_params, self.param_env))\n+                    {\n+                        if let Ok(snippet) = tcx.sess.source_map().span_to_snippet(return_span) {\n+                            err.span_suggestion_hidden(\n+                                return_span,\n+                                \"use `.collect()` to allocate the iterator\",\n+                                format!(\"{}{}\", snippet, \".collect::<Vec<_>>()\"),\n+                                Applicability::MaybeIncorrect,\n+                            );\n+                        }\n+                    }\n+                }\n+            }\n         }\n \n         Some(err)"}, {"sha": "e179ce01c417a601f6c69814eeb7bc062609fd1b", "filename": "library/core/src/iter/traits/iterator.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/a3db47ab6c976137a26976d5c8060e7eadc05232/library%2Fcore%2Fsrc%2Fiter%2Ftraits%2Fiterator.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a3db47ab6c976137a26976d5c8060e7eadc05232/library%2Fcore%2Fsrc%2Fiter%2Ftraits%2Fiterator.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fiter%2Ftraits%2Fiterator.rs?ref=a3db47ab6c976137a26976d5c8060e7eadc05232", "patch": "@@ -93,6 +93,7 @@ fn _assert_is_object_safe(_: &dyn Iterator<Item = ()>) {}\n     message = \"`{Self}` is not an iterator\"\n )]\n #[doc(spotlight)]\n+#[rustc_diagnostic_item = \"Iterator\"]\n #[must_use = \"iterators are lazy and do nothing unless consumed\"]\n pub trait Iterator {\n     /// The type of the elements being iterated over."}, {"sha": "1cad59f1062c6cf8f01e6593bfebcd5b8d6c6a3b", "filename": "src/test/ui/issues/issue-81584.fixed", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/a3db47ab6c976137a26976d5c8060e7eadc05232/src%2Ftest%2Fui%2Fissues%2Fissue-81584.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/a3db47ab6c976137a26976d5c8060e7eadc05232/src%2Ftest%2Fui%2Fissues%2Fissue-81584.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-81584.fixed?ref=a3db47ab6c976137a26976d5c8060e7eadc05232", "patch": "@@ -0,0 +1,8 @@\n+// run-rustfix\n+fn main() {\n+        let _ = vec![vec![0, 1], vec![2]]\n+            .into_iter()\n+            .map(|y| y.iter().map(|x| x + 1).collect::<Vec<_>>())\n+                  //~^ ERROR cannot return value referencing function parameter `y`\n+            .collect::<Vec<_>>();\n+}"}, {"sha": "452288db08bd8981f096c24e808184ff6b2a0173", "filename": "src/test/ui/issues/issue-81584.rs", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/a3db47ab6c976137a26976d5c8060e7eadc05232/src%2Ftest%2Fui%2Fissues%2Fissue-81584.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a3db47ab6c976137a26976d5c8060e7eadc05232/src%2Ftest%2Fui%2Fissues%2Fissue-81584.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-81584.rs?ref=a3db47ab6c976137a26976d5c8060e7eadc05232", "patch": "@@ -0,0 +1,8 @@\n+// run-rustfix\n+fn main() {\n+        let _ = vec![vec![0, 1], vec![2]]\n+            .into_iter()\n+            .map(|y| y.iter().map(|x| x + 1))\n+                  //~^ ERROR cannot return value referencing function parameter `y`\n+            .collect::<Vec<_>>();\n+}"}, {"sha": "d57f1b778df176db34d013dea24b35af61b12d18", "filename": "src/test/ui/issues/issue-81584.stderr", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/a3db47ab6c976137a26976d5c8060e7eadc05232/src%2Ftest%2Fui%2Fissues%2Fissue-81584.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/a3db47ab6c976137a26976d5c8060e7eadc05232/src%2Ftest%2Fui%2Fissues%2Fissue-81584.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-81584.stderr?ref=a3db47ab6c976137a26976d5c8060e7eadc05232", "patch": "@@ -0,0 +1,14 @@\n+error[E0515]: cannot return value referencing function parameter `y`\n+  --> $DIR/issue-81584.rs:5:22\n+   |\n+LL |             .map(|y| y.iter().map(|x| x + 1))\n+   |                      -^^^^^^^^^^^^^^^^^^^^^^\n+   |                      |\n+   |                      returns a value referencing data owned by the current function\n+   |                      `y` is borrowed here\n+   |\n+   = help: use `.collect()` to allocate the iterator\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0515`."}, {"sha": "ff15884bd445d1ca3ace54e8f2348db6f0d5314a", "filename": "src/test/ui/static/static-reference-to-fn-2.stderr", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a3db47ab6c976137a26976d5c8060e7eadc05232/src%2Ftest%2Fui%2Fstatic%2Fstatic-reference-to-fn-2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/a3db47ab6c976137a26976d5c8060e7eadc05232/src%2Ftest%2Fui%2Fstatic%2Fstatic-reference-to-fn-2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fstatic%2Fstatic-reference-to-fn-2.stderr?ref=a3db47ab6c976137a26976d5c8060e7eadc05232", "patch": "@@ -40,6 +40,8 @@ LL | |         statefn: &id(state1 as StateMachineFunc)\n    | |                   ------------------------------ temporary value created here\n LL | |     }\n    | |_____^ returns a value referencing data owned by the current function\n+   |\n+   = help: use `.collect()` to allocate the iterator\n \n error: aborting due to 4 previous errors\n "}]}