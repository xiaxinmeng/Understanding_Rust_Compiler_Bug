{"sha": "a43f08363e0983812fbbe68e8d91accf9496a1dd", "node_id": "C_kwDOAAsO6NoAKGE0M2YwODM2M2UwOTgzODEyZmJiZTY4ZThkOTFhY2NmOTQ5NmExZGQ", "commit": {"author": {"name": "bjorn3", "email": "17426603+bjorn3@users.noreply.github.com", "date": "2023-02-12T13:10:24Z"}, "committer": {"name": "bjorn3", "email": "17426603+bjorn3@users.noreply.github.com", "date": "2023-05-14T12:19:11Z"}, "message": "Benchmark clif release builds with ./y.rs bench", "tree": {"sha": "24dd4f959951e138621b94ea5b220b005db44b57", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/24dd4f959951e138621b94ea5b220b005db44b57"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a43f08363e0983812fbbe68e8d91accf9496a1dd", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a43f08363e0983812fbbe68e8d91accf9496a1dd", "html_url": "https://github.com/rust-lang/rust/commit/a43f08363e0983812fbbe68e8d91accf9496a1dd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a43f08363e0983812fbbe68e8d91accf9496a1dd/comments", "author": {"login": "bjorn3", "id": 17426603, "node_id": "MDQ6VXNlcjE3NDI2NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/17426603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bjorn3", "html_url": "https://github.com/bjorn3", "followers_url": "https://api.github.com/users/bjorn3/followers", "following_url": "https://api.github.com/users/bjorn3/following{/other_user}", "gists_url": "https://api.github.com/users/bjorn3/gists{/gist_id}", "starred_url": "https://api.github.com/users/bjorn3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bjorn3/subscriptions", "organizations_url": "https://api.github.com/users/bjorn3/orgs", "repos_url": "https://api.github.com/users/bjorn3/repos", "events_url": "https://api.github.com/users/bjorn3/events{/privacy}", "received_events_url": "https://api.github.com/users/bjorn3/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bjorn3", "id": 17426603, "node_id": "MDQ6VXNlcjE3NDI2NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/17426603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bjorn3", "html_url": "https://github.com/bjorn3", "followers_url": "https://api.github.com/users/bjorn3/followers", "following_url": "https://api.github.com/users/bjorn3/following{/other_user}", "gists_url": "https://api.github.com/users/bjorn3/gists{/gist_id}", "starred_url": "https://api.github.com/users/bjorn3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bjorn3/subscriptions", "organizations_url": "https://api.github.com/users/bjorn3/orgs", "repos_url": "https://api.github.com/users/bjorn3/repos", "events_url": "https://api.github.com/users/bjorn3/events{/privacy}", "received_events_url": "https://api.github.com/users/bjorn3/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "88ae8fc9c84a87d260157de72fe399d7e7e4a917", "url": "https://api.github.com/repos/rust-lang/rust/commits/88ae8fc9c84a87d260157de72fe399d7e7e4a917", "html_url": "https://github.com/rust-lang/rust/commit/88ae8fc9c84a87d260157de72fe399d7e7e4a917"}], "stats": {"total": 64, "additions": 22, "deletions": 42}, "files": [{"sha": "49f2954d57f46b28adc106807cc9e2c4f4bc1f1c", "filename": "build_system/bench.rs", "status": "modified", "additions": 21, "deletions": 41, "changes": 62, "blob_url": "https://github.com/rust-lang/rust/blob/a43f08363e0983812fbbe68e8d91accf9496a1dd/build_system%2Fbench.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a43f08363e0983812fbbe68e8d91accf9496a1dd/build_system%2Fbench.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/build_system%2Fbench.rs?ref=a43f08363e0983812fbbe68e8d91accf9496a1dd", "patch": "@@ -1,11 +1,10 @@\n use std::env;\n-use std::fs;\n use std::path::Path;\n \n use super::path::{Dirs, RelPath};\n use super::prepare::GitRepo;\n use super::rustc_info::get_file_name;\n-use super::utils::{hyperfine_command, spawn_and_wait, CargoProject, Compiler};\n+use super::utils::{hyperfine_command, spawn_and_wait};\n \n static SIMPLE_RAYTRACER_REPO: GitRepo = GitRepo::github(\n     \"ebobby\",\n@@ -14,18 +13,11 @@ static SIMPLE_RAYTRACER_REPO: GitRepo = GitRepo::github(\n     \"<none>\",\n );\n \n-// Use a separate target dir for the initial LLVM build to reduce unnecessary recompiles\n-static SIMPLE_RAYTRACER_LLVM: CargoProject =\n-    CargoProject::new(&SIMPLE_RAYTRACER_REPO.source_dir(), \"simple_raytracer_llvm\");\n-\n-static SIMPLE_RAYTRACER: CargoProject =\n-    CargoProject::new(&SIMPLE_RAYTRACER_REPO.source_dir(), \"simple_raytracer\");\n-\n-pub(crate) fn benchmark(dirs: &Dirs, bootstrap_host_compiler: &Compiler) {\n-    benchmark_simple_raytracer(dirs, bootstrap_host_compiler);\n+pub(crate) fn benchmark(dirs: &Dirs) {\n+    benchmark_simple_raytracer(dirs);\n }\n \n-fn benchmark_simple_raytracer(dirs: &Dirs, bootstrap_host_compiler: &Compiler) {\n+fn benchmark_simple_raytracer(dirs: &Dirs) {\n     if std::process::Command::new(\"hyperfine\").output().is_err() {\n         eprintln!(\"Hyperfine not installed\");\n         eprintln!(\"Hint: Try `cargo install hyperfine` to install hyperfine\");\n@@ -34,62 +26,49 @@ fn benchmark_simple_raytracer(dirs: &Dirs, bootstrap_host_compiler: &Compiler) {\n \n     if !SIMPLE_RAYTRACER_REPO.source_dir().to_path(dirs).exists() {\n         SIMPLE_RAYTRACER_REPO.fetch(dirs);\n-        spawn_and_wait(SIMPLE_RAYTRACER.fetch(\n-            &bootstrap_host_compiler.cargo,\n-            &bootstrap_host_compiler.rustc,\n-            dirs,\n-        ));\n     }\n \n-    eprintln!(\"[LLVM BUILD] simple-raytracer\");\n-    let build_cmd = SIMPLE_RAYTRACER_LLVM.build(bootstrap_host_compiler, dirs);\n-    spawn_and_wait(build_cmd);\n-    fs::copy(\n-        SIMPLE_RAYTRACER_LLVM\n-            .target_dir(dirs)\n-            .join(&bootstrap_host_compiler.triple)\n-            .join(\"debug\")\n-            .join(get_file_name(\"main\", \"bin\")),\n-        RelPath::BUILD.to_path(dirs).join(get_file_name(\"raytracer_cg_llvm\", \"bin\")),\n-    )\n-    .unwrap();\n-\n     let bench_runs = env::var(\"BENCH_RUNS\").unwrap_or_else(|_| \"10\".to_string()).parse().unwrap();\n \n     eprintln!(\"[BENCH COMPILE] ebobby/simple-raytracer\");\n     let cargo_clif =\n         RelPath::DIST.to_path(dirs).join(get_file_name(\"cargo_clif\", \"bin\").replace('_', \"-\"));\n-    let manifest_path = SIMPLE_RAYTRACER.manifest_path(dirs);\n-    let target_dir = SIMPLE_RAYTRACER.target_dir(dirs);\n+    let manifest_path = SIMPLE_RAYTRACER_REPO.source_dir().to_path(dirs).join(\"Cargo.toml\");\n+    let target_dir = RelPath::BUILD.join(\"simple_raytracer\").to_path(dirs);\n \n     let clean_cmd = format!(\n         \"RUSTC=rustc cargo clean --manifest-path {manifest_path} --target-dir {target_dir}\",\n         manifest_path = manifest_path.display(),\n         target_dir = target_dir.display(),\n     );\n     let llvm_build_cmd = format!(\n-        \"RUSTC=rustc cargo build --manifest-path {manifest_path} --target-dir {target_dir}\",\n+        \"RUSTC=rustc cargo build --manifest-path {manifest_path} --target-dir {target_dir} && (rm build/raytracer_cg_llvm || true) && ln build/simple_raytracer/debug/main build/raytracer_cg_llvm\",\n         manifest_path = manifest_path.display(),\n         target_dir = target_dir.display(),\n     );\n     let clif_build_cmd = format!(\n-        \"RUSTC=rustc {cargo_clif} build --manifest-path {manifest_path} --target-dir {target_dir}\",\n+        \"RUSTC=rustc {cargo_clif} build --manifest-path {manifest_path} --target-dir {target_dir} && (rm build/raytracer_cg_clif || true) && ln build/simple_raytracer/debug/main build/raytracer_cg_clif\",\n+        cargo_clif = cargo_clif.display(),\n+        manifest_path = manifest_path.display(),\n+        target_dir = target_dir.display(),\n+    );\n+    let clif_build_opt_cmd = format!(\n+        \"RUSTC=rustc {cargo_clif} build --manifest-path {manifest_path} --target-dir {target_dir} --release && (rm build/raytracer_cg_clif_opt || true) && ln build/simple_raytracer/release/main build/raytracer_cg_clif_opt\",\n         cargo_clif = cargo_clif.display(),\n         manifest_path = manifest_path.display(),\n         target_dir = target_dir.display(),\n     );\n \n-    let bench_compile =\n-        hyperfine_command(1, bench_runs, Some(&clean_cmd), &[&llvm_build_cmd, &clif_build_cmd]);\n+    let bench_compile = hyperfine_command(\n+        1,\n+        bench_runs,\n+        Some(&clean_cmd),\n+        &[&llvm_build_cmd, &clif_build_cmd, &clif_build_opt_cmd],\n+    );\n \n     spawn_and_wait(bench_compile);\n \n     eprintln!(\"[BENCH RUN] ebobby/simple-raytracer\");\n-    fs::copy(\n-        target_dir.join(\"debug\").join(get_file_name(\"main\", \"bin\")),\n-        RelPath::BUILD.to_path(dirs).join(get_file_name(\"raytracer_cg_clif\", \"bin\")),\n-    )\n-    .unwrap();\n \n     let mut bench_run = hyperfine_command(\n         0,\n@@ -98,6 +77,7 @@ fn benchmark_simple_raytracer(dirs: &Dirs, bootstrap_host_compiler: &Compiler) {\n         &[\n             Path::new(\".\").join(get_file_name(\"raytracer_cg_llvm\", \"bin\")).to_str().unwrap(),\n             Path::new(\".\").join(get_file_name(\"raytracer_cg_clif\", \"bin\")).to_str().unwrap(),\n+            Path::new(\".\").join(get_file_name(\"raytracer_cg_clif_opt\", \"bin\")).to_str().unwrap(),\n         ],\n     );\n     bench_run.current_dir(RelPath::BUILD.to_path(dirs));"}, {"sha": "b3293486c131c012017ce60b599e5f957a3b9fef", "filename": "build_system/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a43f08363e0983812fbbe68e8d91accf9496a1dd/build_system%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a43f08363e0983812fbbe68e8d91accf9496a1dd/build_system%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/build_system%2Fmod.rs?ref=a43f08363e0983812fbbe68e8d91accf9496a1dd", "patch": "@@ -187,7 +187,7 @@ pub(crate) fn main() {\n                 &bootstrap_host_compiler,\n                 target_triple,\n             );\n-            bench::benchmark(&dirs, &bootstrap_host_compiler);\n+            bench::benchmark(&dirs);\n         }\n     }\n }"}]}