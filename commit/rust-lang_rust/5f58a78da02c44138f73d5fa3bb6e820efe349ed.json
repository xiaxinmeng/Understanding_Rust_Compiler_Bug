{"sha": "5f58a78da02c44138f73d5fa3bb6e820efe349ed", "node_id": "C_kwDOAAsO6NoAKDVmNThhNzhkYTAyYzQ0MTM4ZjczZDVmYTNiYjZlODIwZWZlMzQ5ZWQ", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-01-18T18:40:59Z"}, "committer": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-01-19T03:43:52Z"}, "message": "build: dist: defer PlainSourceTarball\n\nApparently it changes some tool sources and invalidates their fingerprints, forcing us to build them several times (before and after vendoring sources).\nI have not dug into why vendoring actually invalidates the figreprints, but the moving the vendoring lower in the pipeline seems to avoid the issue.\nI could imagine that we somehow write a .cargo/config somewhere which somehow makes subsequent builds use the vendored deps but I was not able to find anything.\n\nI checked the sizes of generated archives pre and post patch and their are the same, so I hope there is not functional change.\n\nFixes #93033", "tree": {"sha": "e8fac6e1b29cfb6d994b3489cd1ea69ac0ec2475", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e8fac6e1b29cfb6d994b3489cd1ea69ac0ec2475"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5f58a78da02c44138f73d5fa3bb6e820efe349ed", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5f58a78da02c44138f73d5fa3bb6e820efe349ed", "html_url": "https://github.com/rust-lang/rust/commit/5f58a78da02c44138f73d5fa3bb6e820efe349ed", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5f58a78da02c44138f73d5fa3bb6e820efe349ed/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7531d2fdd49966d83830a7b4596c95587b1e9573", "url": "https://api.github.com/repos/rust-lang/rust/commits/7531d2fdd49966d83830a7b4596c95587b1e9573", "html_url": "https://github.com/rust-lang/rust/commit/7531d2fdd49966d83830a7b4596c95587b1e9573"}], "stats": {"total": 6, "additions": 5, "deletions": 1}, "files": [{"sha": "d4dc61ea5a39b7c83780d6a3eb24221114e89c37", "filename": "src/bootstrap/builder.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/5f58a78da02c44138f73d5fa3bb6e820efe349ed/src%2Fbootstrap%2Fbuilder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5f58a78da02c44138f73d5fa3bb6e820efe349ed/src%2Fbootstrap%2Fbuilder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuilder.rs?ref=5f58a78da02c44138f73d5fa3bb6e820efe349ed", "patch": "@@ -495,7 +495,6 @@ impl<'a> Builder<'a> {\n                 dist::RustcDev,\n                 dist::Analysis,\n                 dist::Src,\n-                dist::PlainSourceTarball,\n                 dist::Cargo,\n                 dist::Rls,\n                 dist::RustAnalyzer,\n@@ -506,6 +505,11 @@ impl<'a> Builder<'a> {\n                 dist::LlvmTools,\n                 dist::RustDev,\n                 dist::Extended,\n+                // It seems that PlainSourceTarball somehow changes how some of the tools\n+                // perceive their dependencies (see #93033) which would invaliate fingerprints\n+                // and force us to rebuild tools after vendoring dependencies.\n+                // To work around this, create the Tarball after building all the tools.\n+                dist::PlainSourceTarball,\n                 dist::BuildManifest,\n                 dist::ReproducibleArtifacts,\n             ),"}]}