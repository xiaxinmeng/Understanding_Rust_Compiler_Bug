{"sha": "900607f49a60e76ca5ca793048723b9ccc2bcd63", "node_id": "C_kwDOAAsO6NoAKDkwMDYwN2Y0OWE2MGU3NmNhNWNhNzkzMDQ4NzIzYjljY2MyYmNkNjM", "commit": {"author": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2022-04-30T13:26:36Z"}, "committer": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2022-05-01T14:42:22Z"}, "message": "resolve: Turn `enum Finalize` into an optional struct", "tree": {"sha": "4c3dc8025e604c9ae1bcab02034f7cb3a3845ef2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4c3dc8025e604c9ae1bcab02034f7cb3a3845ef2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/900607f49a60e76ca5ca793048723b9ccc2bcd63", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/900607f49a60e76ca5ca793048723b9ccc2bcd63", "html_url": "https://github.com/rust-lang/rust/commit/900607f49a60e76ca5ca793048723b9ccc2bcd63", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/900607f49a60e76ca5ca793048723b9ccc2bcd63/comments", "author": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "committer": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "637b3f68079fc81db9bfd2c0f8f306c892680d25", "url": "https://api.github.com/repos/rust-lang/rust/commits/637b3f68079fc81db9bfd2c0f8f306c892680d25", "html_url": "https://github.com/rust-lang/rust/commit/637b3f68079fc81db9bfd2c0f8f306c892680d25"}], "stats": {"total": 151, "additions": 59, "deletions": 92}, "files": [{"sha": "7485dd51863b712998b1bc8faae0b7af3846a7ef", "filename": "compiler/rustc_resolve/src/build_reduced_graph.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/900607f49a60e76ca5ca793048723b9ccc2bcd63/compiler%2Frustc_resolve%2Fsrc%2Fbuild_reduced_graph.rs", "raw_url": "https://github.com/rust-lang/rust/raw/900607f49a60e76ca5ca793048723b9ccc2bcd63/compiler%2Frustc_resolve%2Fsrc%2Fbuild_reduced_graph.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Fbuild_reduced_graph.rs?ref=900607f49a60e76ca5ca793048723b9ccc2bcd63", "patch": "@@ -298,7 +298,7 @@ impl<'a, 'b> BuildReducedGraphVisitor<'a, 'b> {\n                     &segments,\n                     Some(TypeNS),\n                     parent_scope,\n-                    if finalize { Finalize::SimplePath(id, path.span) } else { Finalize::No },\n+                    finalize.then(|| Finalize::new(id, path.span)),\n                     None,\n                 ) {\n                     PathResult::Module(ModuleOrUniformRoot::Module(module)) => {"}, {"sha": "981d60db2f381acab2959af237b3a0f5532eb956", "filename": "compiler/rustc_resolve/src/diagnostics.rs", "status": "modified", "additions": 8, "deletions": 11, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/900607f49a60e76ca5ca793048723b9ccc2bcd63/compiler%2Frustc_resolve%2Fsrc%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/900607f49a60e76ca5ca793048723b9ccc2bcd63/compiler%2Frustc_resolve%2Fsrc%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Fdiagnostics.rs?ref=900607f49a60e76ca5ca793048723b9ccc2bcd63", "patch": "@@ -417,15 +417,12 @@ impl<'a> Resolver<'a> {\n \n     crate fn lint_if_path_starts_with_module(\n         &mut self,\n-        finalize: Finalize,\n+        finalize: Option<Finalize>,\n         path: &[Segment],\n         second_binding: Option<&NameBinding<'_>>,\n     ) {\n-        let (diag_id, diag_span) = match finalize {\n-            Finalize::No => return,\n-            Finalize::SimplePath(id, path_span) => (id, path_span),\n-            Finalize::UsePath { root_id, root_span, .. } => (root_id, root_span),\n-            Finalize::QPathTrait { qpath_id, qpath_span, .. } => (qpath_id, qpath_span),\n+        let Some(Finalize { node_id, root_span, .. }) = finalize else {\n+            return;\n         };\n \n         let first_name = match path.get(0) {\n@@ -463,11 +460,11 @@ impl<'a> Resolver<'a> {\n             }\n         }\n \n-        let diag = BuiltinLintDiagnostics::AbsPathWithModule(diag_span);\n+        let diag = BuiltinLintDiagnostics::AbsPathWithModule(root_span);\n         self.lint_buffer.buffer_lint_with_diagnostic(\n             ABSOLUTE_PATHS_NOT_STARTING_WITH_CRATE,\n-            diag_id,\n-            diag_span,\n+            node_id,\n+            root_span,\n             \"absolute paths must start with `self`, `super`, \\\n              `crate`, or an external crate name in the 2018 edition\",\n             diag,\n@@ -1873,7 +1870,7 @@ impl<'a> Resolver<'a> {\n                         ident,\n                         ns_to_try,\n                         parent_scope,\n-                        Finalize::No,\n+                        None,\n                         &ribs[ns_to_try],\n                         unusable_binding,\n                     ) {\n@@ -1921,7 +1918,7 @@ impl<'a> Resolver<'a> {\n                     ident,\n                     ValueNS,\n                     parent_scope,\n-                    Finalize::No,\n+                    None,\n                     &ribs[ValueNS],\n                     unusable_binding,\n                 )"}, {"sha": "48a052dd2f07d03c131d1bd81ca4f965335727fc", "filename": "compiler/rustc_resolve/src/ident.rs", "status": "modified", "additions": 7, "deletions": 7, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/900607f49a60e76ca5ca793048723b9ccc2bcd63/compiler%2Frustc_resolve%2Fsrc%2Fident.rs", "raw_url": "https://github.com/rust-lang/rust/raw/900607f49a60e76ca5ca793048723b9ccc2bcd63/compiler%2Frustc_resolve%2Fsrc%2Fident.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Fident.rs?ref=900607f49a60e76ca5ca793048723b9ccc2bcd63", "patch": "@@ -279,7 +279,7 @@ impl<'a> Resolver<'a> {\n         mut ident: Ident,\n         ns: Namespace,\n         parent_scope: &ParentScope<'a>,\n-        finalize_full: Finalize,\n+        finalize_full: Option<Finalize>,\n         ribs: &[Rib<'a>],\n         unusable_binding: Option<&'a NameBinding<'a>>,\n     ) -> Option<LexicalScopeBinding<'a>> {\n@@ -302,7 +302,7 @@ impl<'a> Resolver<'a> {\n         let normalized_ident = Ident { span: normalized_span, ..ident };\n \n         // Walk backwards up the ribs in scope.\n-        let finalize = finalize_full.path_span();\n+        let finalize = finalize_full.map(|finalize| finalize.path_span);\n         let mut module = self.graph_root;\n         for i in (0..ribs.len()).rev() {\n             debug!(\"walk rib\\n{:?}\", ribs[i].bindings);\n@@ -354,7 +354,7 @@ impl<'a> Resolver<'a> {\n         }\n         self.early_resolve_ident_in_lexical_scope(\n             orig_ident,\n-            ScopeSet::Late(ns, module, finalize_full.node_id()),\n+            ScopeSet::Late(ns, module, finalize_full.map(|finalize| finalize.node_id)),\n             parent_scope,\n             finalize,\n             finalize.is_some(),\n@@ -1371,7 +1371,7 @@ impl<'a> Resolver<'a> {\n         opt_ns: Option<Namespace>, // `None` indicates a module path in import\n         parent_scope: &ParentScope<'a>,\n     ) -> PathResult<'a> {\n-        self.resolve_path_with_ribs(path, opt_ns, parent_scope, Finalize::No, None, None)\n+        self.resolve_path_with_ribs(path, opt_ns, parent_scope, None, None, None)\n     }\n \n     #[tracing::instrument(level = \"debug\", skip(self))]\n@@ -1380,7 +1380,7 @@ impl<'a> Resolver<'a> {\n         path: &[Segment],\n         opt_ns: Option<Namespace>, // `None` indicates a module path in import\n         parent_scope: &ParentScope<'a>,\n-        finalize: Finalize,\n+        finalize: Option<Finalize>,\n         unusable_binding: Option<&'a NameBinding<'a>>,\n     ) -> PathResult<'a> {\n         self.resolve_path_with_ribs(path, opt_ns, parent_scope, finalize, None, unusable_binding)\n@@ -1391,13 +1391,13 @@ impl<'a> Resolver<'a> {\n         path: &[Segment],\n         opt_ns: Option<Namespace>, // `None` indicates a module path in import\n         parent_scope: &ParentScope<'a>,\n-        finalize_full: Finalize,\n+        finalize_full: Option<Finalize>,\n         ribs: Option<&PerNS<Vec<Rib<'a>>>>,\n         unusable_binding: Option<&'a NameBinding<'a>>,\n     ) -> PathResult<'a> {\n         debug!(\"resolve_path(path={:?}, opt_ns={:?}, finalize={:?})\", path, opt_ns, finalize_full);\n \n-        let finalize = finalize_full.path_span();\n+        let finalize = finalize_full.map(|finalize| finalize.path_span);\n         let mut module = None;\n         let mut allow_super = true;\n         let mut second_binding = None;"}, {"sha": "3d6ad8a42b899b9cd49e23b3edf2bd61779d0901", "filename": "compiler/rustc_resolve/src/imports.rs", "status": "modified", "additions": 2, "deletions": 5, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/900607f49a60e76ca5ca793048723b9ccc2bcd63/compiler%2Frustc_resolve%2Fsrc%2Fimports.rs", "raw_url": "https://github.com/rust-lang/rust/raw/900607f49a60e76ca5ca793048723b9ccc2bcd63/compiler%2Frustc_resolve%2Fsrc%2Fimports.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Fimports.rs?ref=900607f49a60e76ca5ca793048723b9ccc2bcd63", "patch": "@@ -594,11 +594,8 @@ impl<'a, 'b> ImportResolver<'a, 'b> {\n             _ => None,\n         };\n         let prev_ambiguity_errors_len = self.r.ambiguity_errors.len();\n-        let finalize = Finalize::UsePath {\n-            root_id: import.root_id,\n-            root_span: import.root_span,\n-            path_span: import.span,\n-        };\n+        let finalize =\n+            Some(Finalize::with_root_span(import.root_id, import.span, import.root_span));\n         let path_res = self.r.resolve_path(\n             &import.module_path,\n             None,"}, {"sha": "106c6a2d4ec3eb15eae6645aea871920d3f17045", "filename": "compiler/rustc_resolve/src/late.rs", "status": "modified", "additions": 23, "deletions": 32, "changes": 55, "blob_url": "https://github.com/rust-lang/rust/blob/900607f49a60e76ca5ca793048723b9ccc2bcd63/compiler%2Frustc_resolve%2Fsrc%2Flate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/900607f49a60e76ca5ca793048723b9ccc2bcd63/compiler%2Frustc_resolve%2Fsrc%2Flate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Flate.rs?ref=900607f49a60e76ca5ca793048723b9ccc2bcd63", "patch": "@@ -578,7 +578,7 @@ impl<'a: 'ast, 'ast> Visitor<'ast> for LateResolutionVisitor<'a, '_, 'ast> {\n                     .resolve_ident_in_lexical_scope(\n                         self_ty,\n                         TypeNS,\n-                        Finalize::SimplePath(ty.id, ty.span),\n+                        Some(Finalize::new(ty.id, ty.span)),\n                         None,\n                     )\n                     .map_or(Res::Err, |d| d.res());\n@@ -958,7 +958,7 @@ impl<'a: 'ast, 'b, 'ast> LateResolutionVisitor<'a, 'b, 'ast> {\n             ident,\n             ns,\n             &self.parent_scope,\n-            Finalize::No,\n+            None,\n             &self.ribs[ns],\n             None,\n         )\n@@ -968,7 +968,7 @@ impl<'a: 'ast, 'b, 'ast> LateResolutionVisitor<'a, 'b, 'ast> {\n         &mut self,\n         ident: Ident,\n         ns: Namespace,\n-        finalize: Finalize,\n+        finalize: Option<Finalize>,\n         unusable_binding: Option<&'a NameBinding<'a>>,\n     ) -> Option<LexicalScopeBinding<'a>> {\n         self.r.resolve_ident_in_lexical_scope(\n@@ -985,7 +985,7 @@ impl<'a: 'ast, 'b, 'ast> LateResolutionVisitor<'a, 'b, 'ast> {\n         &mut self,\n         path: &[Segment],\n         opt_ns: Option<Namespace>, // `None` indicates a module path in import\n-        finalize: Finalize,\n+        finalize: Option<Finalize>,\n     ) -> PathResult<'a> {\n         self.r.resolve_path_with_ribs(\n             path,\n@@ -1299,11 +1299,8 @@ impl<'a: 'ast, 'b, 'ast> LateResolutionVisitor<'a, 'b, 'ast> {\n         partial_res: PartialRes,\n         path: &[Segment],\n         source: PathSource<'_>,\n-        finalize: Finalize,\n+        path_span: Span,\n     ) {\n-        let Some(path_span) = finalize.path_span() else {\n-            return;\n-        };\n         let proj_start = path.len() - partial_res.unresolved_segments();\n         for (i, segment) in path.iter().enumerate() {\n             if segment.has_lifetime_args {\n@@ -1576,8 +1573,8 @@ impl<'a: 'ast, 'b, 'ast> LateResolutionVisitor<'a, 'b, 'ast> {\n                         report_error(self, ns);\n                     }\n                     Some(LexicalScopeBinding::Item(binding)) => {\n-                        if let Some(LexicalScopeBinding::Res(..)) = self\n-                            .resolve_ident_in_lexical_scope(ident, ns, Finalize::No, Some(binding))\n+                        if let Some(LexicalScopeBinding::Res(..)) =\n+                            self.resolve_ident_in_lexical_scope(ident, ns, None, Some(binding))\n                         {\n                             report_error(self, ns);\n                         }\n@@ -1979,7 +1976,7 @@ impl<'a: 'ast, 'b, 'ast> LateResolutionVisitor<'a, 'b, 'ast> {\n                 None,\n                 &path,\n                 PathSource::Trait(AliasPossibility::No),\n-                Finalize::SimplePath(trait_ref.ref_id, trait_ref.path.span),\n+                Finalize::new(trait_ref.ref_id, trait_ref.path.span),\n             );\n             if let Some(def_id) = res.base_res().opt_def_id() {\n                 new_id = Some(def_id);\n@@ -2653,7 +2650,7 @@ impl<'a: 'ast, 'b, 'ast> LateResolutionVisitor<'a, 'b, 'ast> {\n             qself,\n             &Segment::from_path(path),\n             source,\n-            Finalize::SimplePath(id, path.span),\n+            Finalize::new(id, path.span),\n         );\n     }\n \n@@ -2672,8 +2669,7 @@ impl<'a: 'ast, 'b, 'ast> LateResolutionVisitor<'a, 'b, 'ast> {\n         );\n         let ns = source.namespace();\n \n-        let (id, path_span) =\n-            finalize.node_id_and_path_span().expect(\"unexpected speculative resolution\");\n+        let Finalize { node_id, path_span, .. } = finalize;\n         let report_errors = |this: &mut Self, res: Option<Res>| {\n             if this.should_report_errs() {\n                 let (err, candidates) =\n@@ -2787,7 +2783,7 @@ impl<'a: 'ast, 'b, 'ast> LateResolutionVisitor<'a, 'b, 'ast> {\n                 if ns == ValueNS {\n                     let item_name = path.last().unwrap().ident;\n                     let traits = self.traits_in_scope(item_name, ns);\n-                    self.r.trait_map.insert(id, traits);\n+                    self.r.trait_map.insert(node_id, traits);\n                 }\n \n                 if PrimTy::from_name(path[0].ident.name).is_some() {\n@@ -2796,7 +2792,7 @@ impl<'a: 'ast, 'b, 'ast> LateResolutionVisitor<'a, 'b, 'ast> {\n                     std_path.push(Segment::from_ident(Ident::with_dummy_span(sym::std)));\n                     std_path.extend(path);\n                     if let PathResult::Module(_) | PathResult::NonModule(_) =\n-                        self.resolve_path(&std_path, Some(ns), Finalize::No)\n+                        self.resolve_path(&std_path, Some(ns), None)\n                     {\n                         // Check if we wrote `str::from_utf8` instead of `std::str::from_utf8`\n                         let item_span =\n@@ -2823,8 +2819,8 @@ impl<'a: 'ast, 'b, 'ast> LateResolutionVisitor<'a, 'b, 'ast> {\n \n         if !matches!(source, PathSource::TraitItem(..)) {\n             // Avoid recording definition of `A::B` in `<T as A>::B::C`.\n-            self.r.record_partial_res(id, partial_res);\n-            self.resolve_elided_lifetimes_in_path(id, partial_res, path, source, finalize);\n+            self.r.record_partial_res(node_id, partial_res);\n+            self.resolve_elided_lifetimes_in_path(node_id, partial_res, path, source, path_span);\n         }\n \n         partial_res\n@@ -2932,21 +2928,12 @@ impl<'a: 'ast, 'b, 'ast> LateResolutionVisitor<'a, 'b, 'ast> {\n             // the trait (the slice upto and including\n             // `qself.position`). And then we recursively resolve that,\n             // but with `qself` set to `None`.\n-            //\n-            // However, setting `qself` to none (but not changing the\n-            // span) loses the information about where this path\n-            // *actually* appears, so for the purposes of the crate\n-            // lint we pass along information that this is the trait\n-            // name from a fully qualified path, and this also\n-            // contains the full span (the `Finalize::QPathTrait`).\n             let ns = if qself.position + 1 == path.len() { ns } else { TypeNS };\n             let partial_res = self.smart_resolve_path_fragment(\n                 None,\n                 &path[..=qself.position],\n                 PathSource::TraitItem(ns),\n-                finalize.node_id_and_path_span().map_or(Finalize::No, |(qpath_id, path_span)| {\n-                    Finalize::QPathTrait { qpath_id, qpath_span: qself.path_span, path_span }\n-                }),\n+                Finalize::with_root_span(finalize.node_id, finalize.path_span, qself.path_span),\n             );\n \n             // The remaining segments (the `C` in our example) will\n@@ -2958,7 +2945,7 @@ impl<'a: 'ast, 'b, 'ast> LateResolutionVisitor<'a, 'b, 'ast> {\n             )));\n         }\n \n-        let result = match self.resolve_path(&path, Some(ns), finalize) {\n+        let result = match self.resolve_path(&path, Some(ns), Some(finalize)) {\n             PathResult::NonModule(path_res) => path_res,\n             PathResult::Module(ModuleOrUniformRoot::Module(module)) if !module.is_normal() => {\n                 PartialRes::new(module.res().unwrap())\n@@ -2996,10 +2983,9 @@ impl<'a: 'ast, 'b, 'ast> LateResolutionVisitor<'a, 'b, 'ast> {\n             && result.base_res() != Res::Err\n             && path[0].ident.name != kw::PathRoot\n             && path[0].ident.name != kw::DollarCrate\n-            && let Some((id, path_span)) = finalize.node_id_and_path_span()\n         {\n             let unqualified_result = {\n-                match self.resolve_path(&[*path.last().unwrap()], Some(ns), Finalize::No) {\n+                match self.resolve_path(&[*path.last().unwrap()], Some(ns), None) {\n                     PathResult::NonModule(path_res) => path_res.base_res(),\n                     PathResult::Module(ModuleOrUniformRoot::Module(module)) => {\n                         module.res().unwrap()\n@@ -3009,7 +2995,12 @@ impl<'a: 'ast, 'b, 'ast> LateResolutionVisitor<'a, 'b, 'ast> {\n             };\n             if result.base_res() == unqualified_result {\n                 let lint = lint::builtin::UNUSED_QUALIFICATIONS;\n-                self.r.lint_buffer.buffer_lint(lint, id, path_span, \"unnecessary qualification\")\n+                self.r.lint_buffer.buffer_lint(\n+                    lint,\n+                    finalize.node_id,\n+                    finalize.path_span,\n+                    \"unnecessary qualification\",\n+                )\n             }\n         }\n "}, {"sha": "3076cc1131700d8df6f0f4707f37023d54fffe95", "filename": "compiler/rustc_resolve/src/late/diagnostics.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/900607f49a60e76ca5ca793048723b9ccc2bcd63/compiler%2Frustc_resolve%2Fsrc%2Flate%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/900607f49a60e76ca5ca793048723b9ccc2bcd63/compiler%2Frustc_resolve%2Fsrc%2Flate%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Flate%2Fdiagnostics.rs?ref=900607f49a60e76ca5ca793048723b9ccc2bcd63", "patch": "@@ -3,7 +3,7 @@ use crate::late::lifetimes::{ElisionFailureInfo, LifetimeContext};\n use crate::late::{AliasPossibility, LateResolutionVisitor, RibKind};\n use crate::late::{LifetimeBinderKind, LifetimeRibKind};\n use crate::path_names_to_string;\n-use crate::{Finalize, Module, ModuleKind, ModuleOrUniformRoot};\n+use crate::{Module, ModuleKind, ModuleOrUniformRoot};\n use crate::{PathResult, PathSource, Segment};\n \n use rustc_ast::visit::FnKind;\n@@ -189,7 +189,7 @@ impl<'a: 'ast, 'ast> LateResolutionVisitor<'a, '_, 'ast> {\n                 (String::new(), \"the crate root\".to_string())\n             } else {\n                 let mod_path = &path[..path.len() - 1];\n-                let mod_prefix = match self.resolve_path(mod_path, Some(TypeNS), Finalize::No) {\n+                let mod_prefix = match self.resolve_path(mod_path, Some(TypeNS), None) {\n                     PathResult::Module(ModuleOrUniformRoot::Module(module)) => module.res(),\n                     _ => None,\n                 }\n@@ -648,7 +648,7 @@ impl<'a: 'ast, 'ast> LateResolutionVisitor<'a, '_, 'ast> {\n         if let crate::PathSource::TraitItem(_) = source {\n             let mod_path = &path[..path.len() - 1];\n             if let PathResult::Module(ModuleOrUniformRoot::Module(module)) =\n-                self.resolve_path(mod_path, None, Finalize::No)\n+                self.resolve_path(mod_path, None, None)\n             {\n                 let resolutions = self.r.resolutions(module).borrow();\n                 let targets: Vec<_> =\n@@ -1362,7 +1362,7 @@ impl<'a: 'ast, 'ast> LateResolutionVisitor<'a, '_, 'ast> {\n             // Search in module.\n             let mod_path = &path[..path.len() - 1];\n             if let PathResult::Module(ModuleOrUniformRoot::Module(module)) =\n-                self.resolve_path(mod_path, Some(TypeNS), Finalize::No)\n+                self.resolve_path(mod_path, Some(TypeNS), None)\n             {\n                 self.r.add_module_candidates(module, &mut names, &filter_fn);\n             }"}, {"sha": "330636fe543262de8513e4c19d936576b7f005a0", "filename": "compiler/rustc_resolve/src/lib.rs", "status": "modified", "additions": 13, "deletions": 31, "changes": 44, "blob_url": "https://github.com/rust-lang/rust/blob/900607f49a60e76ca5ca793048723b9ccc2bcd63/compiler%2Frustc_resolve%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/900607f49a60e76ca5ca793048723b9ccc2bcd63/compiler%2Frustc_resolve%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Flib.rs?ref=900607f49a60e76ca5ca793048723b9ccc2bcd63", "patch": "@@ -2044,42 +2044,24 @@ fn module_to_string(module: Module<'_>) -> Option<String> {\n }\n \n #[derive(Copy, Clone, Debug)]\n-enum Finalize {\n-    /// Do not issue the lint.\n-    No,\n-\n-    /// This lint applies to some arbitrary path; e.g., `impl ::foo::Bar`.\n-    /// In this case, we can take the span of that path.\n-    SimplePath(NodeId, Span),\n-\n-    /// This lint comes from a `use` statement. In this case, what we\n-    /// care about really is the *root* `use` statement; e.g., if we\n-    /// have nested things like `use a::{b, c}`, we care about the\n-    /// `use a` part.\n-    UsePath { root_id: NodeId, root_span: Span, path_span: Span },\n-\n-    /// This is the \"trait item\" from a fully qualified path. For example,\n-    /// we might be resolving  `X::Y::Z` from a path like `<T as X::Y>::Z`.\n-    /// The `path_span` is the span of the to the trait itself (`X::Y`).\n-    QPathTrait { qpath_id: NodeId, qpath_span: Span, path_span: Span },\n+struct Finalize {\n+    /// Node ID for linting.\n+    node_id: NodeId,\n+    /// Span of the whole path or some its characteristic fragment.\n+    /// E.g. span of `b` in `foo::{a, b, c}`, or full span for regular paths.\n+    path_span: Span,\n+    /// Span of the path start, suitable for prepending something to to it.\n+    /// E.g. span of `foo` in `foo::{a, b, c}`, or full span for regular paths.\n+    root_span: Span,\n }\n \n impl Finalize {\n-    fn node_id_and_path_span(&self) -> Option<(NodeId, Span)> {\n-        match *self {\n-            Finalize::No => None,\n-            Finalize::SimplePath(id, path_span)\n-            | Finalize::UsePath { root_id: id, path_span, .. }\n-            | Finalize::QPathTrait { qpath_id: id, path_span, .. } => Some((id, path_span)),\n-        }\n-    }\n-\n-    fn node_id(&self) -> Option<NodeId> {\n-        self.node_id_and_path_span().map(|(id, _)| id)\n+    fn new(node_id: NodeId, path_span: Span) -> Finalize {\n+        Finalize { node_id, path_span, root_span: path_span }\n     }\n \n-    fn path_span(&self) -> Option<Span> {\n-        self.node_id_and_path_span().map(|(_, path_span)| path_span)\n+    fn with_root_span(node_id: NodeId, path_span: Span, root_span: Span) -> Finalize {\n+        Finalize { node_id, path_span, root_span }\n     }\n }\n "}, {"sha": "e1aa2276566953f311c9898821f14079ad1263da", "filename": "compiler/rustc_resolve/src/macros.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/900607f49a60e76ca5ca793048723b9ccc2bcd63/compiler%2Frustc_resolve%2Fsrc%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/900607f49a60e76ca5ca793048723b9ccc2bcd63/compiler%2Frustc_resolve%2Fsrc%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Fmacros.rs?ref=900607f49a60e76ca5ca793048723b9ccc2bcd63", "patch": "@@ -673,7 +673,7 @@ impl<'a> Resolver<'a> {\n                 &path,\n                 Some(MacroNS),\n                 &parent_scope,\n-                Finalize::SimplePath(ast::CRATE_NODE_ID, path_span),\n+                Some(Finalize::new(ast::CRATE_NODE_ID, path_span)),\n                 None,\n             ) {\n                 PathResult::NonModule(path_res) if path_res.unresolved_segments() == 0 => {"}]}