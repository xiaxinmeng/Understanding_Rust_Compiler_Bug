{"sha": "a57b1fbd84543880e4cba99013c81b7b82292c31", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE1N2IxZmJkODQ1NDM4ODBlNGNiYTk5MDEzYzgxYjdiODIyOTJjMzE=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2018-04-04T21:27:53Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2018-04-04T21:34:54Z"}, "message": "Tweak doc comment expansion\n\n* Expand `!` tokens for inner doc comments\n* Trim leading doc comment decoration in the string literal\n\nBoth of these should help bring the expansion inline with what `macro_rules!`\nalready does.\n\nCloses #49655\nCloses #49656", "tree": {"sha": "f015bb544020e4ce9e59d1315955ed372b58b918", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f015bb544020e4ce9e59d1315955ed372b58b918"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a57b1fbd84543880e4cba99013c81b7b82292c31", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a57b1fbd84543880e4cba99013c81b7b82292c31", "html_url": "https://github.com/rust-lang/rust/commit/a57b1fbd84543880e4cba99013c81b7b82292c31", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a57b1fbd84543880e4cba99013c81b7b82292c31/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "553c04d9eb311189cbd01d1af7f6c2c26578342c", "url": "https://api.github.com/repos/rust-lang/rust/commits/553c04d9eb311189cbd01d1af7f6c2c26578342c", "html_url": "https://github.com/rust-lang/rust/commit/553c04d9eb311189cbd01d1af7f6c2c26578342c"}], "stats": {"total": 8, "additions": 7, "deletions": 1}, "files": [{"sha": "ebd5c834fd0364cd0918048500d197d7e66b4573", "filename": "src/libproc_macro/lib.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/a57b1fbd84543880e4cba99013c81b7b82292c31/src%2Flibproc_macro%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a57b1fbd84543880e4cba99013c81b7b82292c31/src%2Flibproc_macro%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibproc_macro%2Flib.rs?ref=a57b1fbd84543880e4cba99013c81b7b82292c31", "patch": "@@ -59,6 +59,7 @@ use syntax::errors::DiagnosticBuilder;\n use syntax::parse::{self, token};\n use syntax::symbol::Symbol;\n use syntax::tokenstream;\n+use syntax::parse::lexer::comments;\n use syntax_pos::{FileMap, Pos, SyntaxContext, FileName};\n use syntax_pos::hygiene::Mark;\n \n@@ -1056,12 +1057,17 @@ impl TokenTree {\n             }\n             Literal(..) => tt!(self::Literal { token, span: Span(span) }),\n             DocComment(c) => {\n+                let style = comments::doc_comment_style(&c.as_str());\n+                let stripped = comments::strip_doc_comment_decoration(&c.as_str());\n                 let stream = vec![\n                     tt!(Term::new(\"doc\", Span(span))),\n                     tt!(Op::new('=', Spacing::Alone)),\n-                    tt!(self::Literal::string(&c.as_str())),\n+                    tt!(self::Literal::string(&stripped)),\n                 ].into_iter().collect();\n                 stack.push(tt!(Group::new(Delimiter::Bracket, stream)));\n+                if style == ast::AttrStyle::Inner {\n+                    stack.push(tt!(Op::new('!', Spacing::Alone)));\n+                }\n                 tt!(Op::new('#', Spacing::Alone))\n             }\n "}]}