{"sha": "beedf4e7d88cdb803c4ba73511c871273402ebb0", "node_id": "MDY6Q29tbWl0NzI0NzEyOmJlZWRmNGU3ZDg4Y2RiODAzYzRiYTczNTExYzg3MTI3MzQwMmViYjA=", "commit": {"author": {"name": "Sebastian Humenda", "email": "shumenda@gmx.de", "date": "2017-08-21T07:50:13Z"}, "committer": {"name": "Tobias Schaffner", "email": "tschaff@genua.de", "date": "2017-08-22T11:54:32Z"}, "message": "L4Re Target: Add the needed Libraries and locate them\n\nAdd the libraries and objects that have to be linked to a get working L4Re\nBinary using pre- and post-link-args. Additionaly some ld commands had to\nbe passed.\n\n* L4Re libraries and objects will be located by an environment variable.\n* gcc libraries and objects will be located using a gcc call.\n\nGCC is mandatory for this target, that might need documentation somewhere.\nAs soon as something mandatory cannot be found, the compiler will panic.\nThis is intended, because the functions involved don't allow the usage of\na Result type. libgcc_eh is now passed using `-l` and crtbeginT.o and\ncrtend.o are now located using `gcc -print-filename`.\n\nCo-authored-by: TobiasSchaffner <tobiasschaffner@outlook.com>", "tree": {"sha": "10e5824a1fbadb053ff9bb8f582ccdc12b51a6d5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/10e5824a1fbadb053ff9bb8f582ccdc12b51a6d5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/beedf4e7d88cdb803c4ba73511c871273402ebb0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/beedf4e7d88cdb803c4ba73511c871273402ebb0", "html_url": "https://github.com/rust-lang/rust/commit/beedf4e7d88cdb803c4ba73511c871273402ebb0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/beedf4e7d88cdb803c4ba73511c871273402ebb0/comments", "author": {"login": "humenda", "id": 4473821, "node_id": "MDQ6VXNlcjQ0NzM4MjE=", "avatar_url": "https://avatars.githubusercontent.com/u/4473821?v=4", "gravatar_id": "", "url": "https://api.github.com/users/humenda", "html_url": "https://github.com/humenda", "followers_url": "https://api.github.com/users/humenda/followers", "following_url": "https://api.github.com/users/humenda/following{/other_user}", "gists_url": "https://api.github.com/users/humenda/gists{/gist_id}", "starred_url": "https://api.github.com/users/humenda/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/humenda/subscriptions", "organizations_url": "https://api.github.com/users/humenda/orgs", "repos_url": "https://api.github.com/users/humenda/repos", "events_url": "https://api.github.com/users/humenda/events{/privacy}", "received_events_url": "https://api.github.com/users/humenda/received_events", "type": "User", "site_admin": false}, "committer": null, "parents": [{"sha": "7e5578da8c76fafcb1d7ca9f0643127da76f0879", "url": "https://api.github.com/repos/rust-lang/rust/commits/7e5578da8c76fafcb1d7ca9f0643127da76f0879", "html_url": "https://github.com/rust-lang/rust/commit/7e5578da8c76fafcb1d7ca9f0643127da76f0879"}], "stats": {"total": 54, "additions": 52, "deletions": 2}, "files": [{"sha": "b776c4bb56888db7e0ff894ec8e8371290855ae4", "filename": "src/librustc_back/target/l4re_base.rs", "status": "modified", "additions": 52, "deletions": 2, "changes": 54, "blob_url": "https://github.com/rust-lang/rust/blob/beedf4e7d88cdb803c4ba73511c871273402ebb0/src%2Flibrustc_back%2Ftarget%2Fl4re_base.rs", "raw_url": "https://github.com/rust-lang/rust/raw/beedf4e7d88cdb803c4ba73511c871273402ebb0/src%2Flibrustc_back%2Ftarget%2Fl4re_base.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_back%2Ftarget%2Fl4re_base.rs?ref=beedf4e7d88cdb803c4ba73511c871273402ebb0", "patch": "@@ -12,20 +12,70 @@ use PanicStrategy;\n use LinkerFlavor;\n use target::{LinkArgs, TargetOptions};\n use std::default::Default;\n+use std::env;\n+use std::process::Command;\n+\n+// Use GCC to locate code for crt* libraries from the host, not from L4Re. Note\n+// that a few files also come from L4Re, for these, the function shouldn't be\n+// used. This uses GCC for the location of the file, but GCC is required for L4Re anyway.\n+fn get_path_or(filename: &str) -> String {\n+    let child = Command::new(\"gcc\")\n+        .arg(format!(\"-print-file-name={}\", filename)).output()\n+        .expect(\"Failed to execute GCC\");\n+    String::from_utf8(child.stdout)\n+        .expect(\"Couldn't read path from GCC\").trim().into()\n+}\n \n pub fn opts() -> TargetOptions {\n+    let l4re_lib_path = env::var_os(\"L4RE_LIBDIR\").expect(\"Unable to find L4Re \\\n+        library directory: L4RE_LIBDIR not set.\").into_string().unwrap();\n     let mut pre_link_args = LinkArgs::new();\n     pre_link_args.insert(LinkerFlavor::Ld, vec![\n-            \"-nostdlib\".to_string(),\n+        format!(\"-T{}/main_stat.ld\", l4re_lib_path),\n+        \"--defsym=__executable_start=0x01000000\".to_string(),\n+        \"--defsym=__L4_KIP_ADDR__=0x6ffff000\".to_string(),\n+        format!(\"{}/crt1.o\", l4re_lib_path),\n+        format!(\"{}/crti.o\", l4re_lib_path),\n+        get_path_or(\"crtbeginT.o\"),\n+    ]);\n+    let mut post_link_args = LinkArgs::new();\n+    post_link_args.insert(LinkerFlavor::Ld, vec![\n+        format!(\"{}/l4f/libpthread.a\", l4re_lib_path),\n+        format!(\"{}/l4f/libc_be_sig.a\", l4re_lib_path),\n+        format!(\"{}/l4f/libc_be_sig_noop.a\", l4re_lib_path),\n+        format!(\"{}/l4f/libc_be_socket_noop.a\", l4re_lib_path),\n+        format!(\"{}/l4f/libc_be_fs_noop.a\", l4re_lib_path),\n+        format!(\"{}/l4f/libc_be_sem_noop.a\", l4re_lib_path),\n+        format!(\"{}/l4f/libl4re-vfs.o.a\", l4re_lib_path),\n+        format!(\"{}/l4f/lib4re.a\", l4re_lib_path),\n+        format!(\"{}/l4f/lib4re-util.a\", l4re_lib_path),\n+        format!(\"{}/l4f/libc_support_misc.a\", l4re_lib_path),\n+        format!(\"{}/l4f/libsupc++.a\", l4re_lib_path),\n+        format!(\"{}/l4f/lib4shmc.a\", l4re_lib_path),\n+        format!(\"{}/l4f/lib4re-c.a\", l4re_lib_path),\n+        format!(\"{}/l4f/lib4re-c-util.a\", l4re_lib_path),\n+        get_path_or(\"libgcc_eh.a\"),\n+        format!(\"{}/l4f/libdl.a\", l4re_lib_path),\n+        \"--start-group\".to_string(),\n+        format!(\"{}/l4f/libl4util.a\", l4re_lib_path),\n+        format!(\"{}/l4f/libc_be_l4re.a\", l4re_lib_path),\n+        format!(\"{}/l4f/libuc_c.a\", l4re_lib_path),\n+        format!(\"{}/l4f/libc_be_l4refile.a\", l4re_lib_path),\n+        \"--end-group\".to_string(),\n+        format!(\"{}/l4f/libl4sys.a\", l4re_lib_path),\n+        \"-gc-sections\".to_string(),\n+        get_path_or(\"crtend.o\"),\n+        format!(\"{}/crtn.o\", l4re_lib_path),\n     ]);\n \n     TargetOptions {\n         executables: true,\n         has_elf_tls: false,\n-        exe_allocation_crate: Some(\"alloc_system\".to_string()),\n+        exe_allocation_crate: None,\n         panic_strategy: PanicStrategy::Abort,\n         linker: \"ld\".to_string(),\n         pre_link_args,\n+        post_link_args,\n         target_family: Some(\"unix\".to_string()),\n         .. Default::default()\n     }"}]}