{"sha": "300e13808e679e6224f51705794b234dfd8bf73a", "node_id": "MDY6Q29tbWl0NzI0NzEyOjMwMGUxMzgwOGU2NzllNjIyNGY1MTcwNTc5NGIyMzRkZmQ4YmY3M2E=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2016-09-26T12:22:22Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2016-09-26T17:50:32Z"}, "message": "Remove CString drop test.\n\nThe test relies on the undefined behavior, and so may fail in some\ncircumstances. This can be worked around by stubbing a memory allocator\nin the test, but it is a bit of work, and LLVM could still theoretically\neliminate the write of the zero byte in release mode (which is\nintended).\n\nSo let's just remove the test and mark the function as inline. It\nshouldn't be optimized away when inlined into the debug build of user's\ncode.", "tree": {"sha": "f9315cf93ecaceb0307b6cbc76afacf198b9eb6c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f9315cf93ecaceb0307b6cbc76afacf198b9eb6c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/300e13808e679e6224f51705794b234dfd8bf73a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/300e13808e679e6224f51705794b234dfd8bf73a", "html_url": "https://github.com/rust-lang/rust/commit/300e13808e679e6224f51705794b234dfd8bf73a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/300e13808e679e6224f51705794b234dfd8bf73a/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b786976a158e79196254f489bb3a6f87e4d16a5a", "url": "https://api.github.com/repos/rust-lang/rust/commits/b786976a158e79196254f489bb3a6f87e4d16a5a", "html_url": "https://github.com/rust-lang/rust/commit/b786976a158e79196254f489bb3a6f87e4d16a5a"}], "stats": {"total": 53, "additions": 3, "deletions": 50}, "files": [{"sha": "6f5ce350e6cb376092275f63cf7bd9c124a8a862", "filename": "src/libstd/ffi/c_str.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/300e13808e679e6224f51705794b234dfd8bf73a/src%2Flibstd%2Fffi%2Fc_str.rs", "raw_url": "https://github.com/rust-lang/rust/raw/300e13808e679e6224f51705794b234dfd8bf73a/src%2Flibstd%2Fffi%2Fc_str.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fffi%2Fc_str.rs?ref=300e13808e679e6224f51705794b234dfd8bf73a", "patch": "@@ -314,9 +314,11 @@ impl CString {\n }\n \n // Turns this `CString` into an empty string to prevent\n-// memory unsafe code from working by accident.\n+// memory unsafe code from working by accident. Inline\n+// to prevent LLVM from optimizing it away in debug builds.\n #[stable(feature = \"cstring_drop\", since = \"1.13.0\")]\n impl Drop for CString {\n+    #[inline]\n     fn drop(&mut self) {\n         unsafe { *self.inner.get_unchecked_mut(0) = 0; }\n     }"}, {"sha": "960391bb8deac7a788692d89de0325b9f6538b64", "filename": "src/test/run-pass/cstring-drop.rs", "status": "removed", "additions": 0, "deletions": 49, "changes": 49, "blob_url": "https://github.com/rust-lang/rust/blob/b786976a158e79196254f489bb3a6f87e4d16a5a/src%2Ftest%2Frun-pass%2Fcstring-drop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b786976a158e79196254f489bb3a6f87e4d16a5a/src%2Ftest%2Frun-pass%2Fcstring-drop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fcstring-drop.rs?ref=b786976a158e79196254f489bb3a6f87e4d16a5a", "patch": "@@ -1,49 +0,0 @@\n-// Copyright 2016 The Rust Project Developers. See the COPYRIGHT\n-// file at the top-level directory of this distribution and at\n-// http://rust-lang.org/COPYRIGHT.\n-//\n-// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n-// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n-// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n-// option. This file may not be copied, modified, or distributed\n-// except according to those terms.\n-\n-// ignore-emscripten\n-\n-// Test that `CString::new(\"hello\").unwrap().as_ptr()` pattern\n-// leads to failure.\n-\n-use std::env;\n-use std::ffi::{CString, CStr};\n-use std::os::raw::c_char;\n-use std::process::{Command, Stdio};\n-\n-fn main() {\n-    let args: Vec<String> = env::args().collect();\n-    if args.len() > 1 && args[1] == \"child\" {\n-        // Repeat several times to be more confident that\n-        // it is `Drop` for `CString` that does the cleanup,\n-        // and not just some lucky UB.\n-        let xs = vec![CString::new(\"Hello\").unwrap(); 10];\n-        let ys = xs.iter().map(|s| s.as_ptr()).collect::<Vec<_>>();\n-        drop(xs);\n-        assert!(ys.into_iter().any(is_hello));\n-        return;\n-    }\n-\n-    let output = Command::new(&args[0]).arg(\"child\").output().unwrap();\n-    assert!(!output.status.success());\n-}\n-\n-fn is_hello(s: *const c_char) -> bool {\n-    // `s` is a dangling pointer and reading it is technically\n-    // undefined behavior. But we want to prevent the most diabolical\n-    // kind of UB (apart from nasal demons): reading a value that was\n-    // previously written.\n-    //\n-    // Segfaulting or reading an empty string is Ok,\n-    // reading \"Hello\" is bad.\n-    let s = unsafe { CStr::from_ptr(s) };\n-    let hello = CString::new(\"Hello\").unwrap();\n-    s == hello.as_ref()\n-}"}]}