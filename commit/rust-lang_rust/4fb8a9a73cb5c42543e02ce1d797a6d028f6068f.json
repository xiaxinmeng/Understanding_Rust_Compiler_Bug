{"sha": "4fb8a9a73cb5c42543e02ce1d797a6d028f6068f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRmYjhhOWE3M2NiNWM0MjU0M2UwMmNlMWQ3OTdhNmQwMjhmNjA2OGY=", "commit": {"author": {"name": "Pietro Albini", "email": "pietro@pietroalbini.org", "date": "2019-10-23T14:07:13Z"}, "committer": {"name": "Pietro Albini", "email": "pietro@pietroalbini.org", "date": "2019-10-29T09:01:43Z"}, "message": "ci: extract job skipping logic into a script", "tree": {"sha": "c805eb6d4acdafd07dfa5c1b211bba3e86cdf4b8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c805eb6d4acdafd07dfa5c1b211bba3e86cdf4b8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4fb8a9a73cb5c42543e02ce1d797a6d028f6068f", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE1JbYPtLJAsc22U9xPgar6Auq8ZwFAl23//cACgkQPgar6Auq\n8ZxnKxAAune6fG1pqjhPxifxYtVTdPV7Bz0AOJQWxiqLdog0YCWmKu3sQYV90ytB\ncBIE03sg4XjgYOwH0tUrbgok4HI0yCphqIpyrYxfJ+tpr/nljRoqfNG780FlGw4U\nMe+eXP8f+oFRyA3Gdn5I8fC0iatRhsn46YKYm3k4vrV65O08/BC+NWDtEJsMpt+j\niVLYumo6KeHSnDrujOgHWrCOn8iBNMJ7sVBbYjHQKxyG0Z4nRt5JXzZooCbaUSYl\nMXyaVXFTi3WCSvoQ0NZZ0FXpig0VWYaHkcmgxo7NJqWtHeLzvu/qqCP8GmsV9sts\n6IqfmsmLBGCeYxqVggPMTPB863XoLHSZAe9pc0aOC9phPfcyHOumFYlFGfek2unP\niR1h7tvYBKufn6P6KfYxeXAs0c9y85bZud36R50SRp43C9NlFS9IqFvBg+QxIOES\nJnMx+5Sn80G0U0/fuiSiW67BJvgbhGgQ+jZCfus7ZbMF8Tq6+qKn3vjYEBG/+onO\ne6X+i7MeoU9yrVlqMLZfPHlUteJLX0dfO+N31HrSqtpDYza9HkMCjMVRIKOg8M1m\n9LZaCEp/MdDAJJSPnJsv4w/uhxfOLFn1/9XtbNd5n+YffmSpAQk6zQEoRR3FI22C\nRiL7NZJUXaP+710HN84c9Ms1bwSYi2+z6JGXskIomLwH6H7M3I8=\n=91rz\n-----END PGP SIGNATURE-----", "payload": "tree c805eb6d4acdafd07dfa5c1b211bba3e86cdf4b8\nparent 53be2724157ca6fe9412e52dea56d4b29759ac11\nauthor Pietro Albini <pietro@pietroalbini.org> 1571839633 +0200\ncommitter Pietro Albini <pietro@pietroalbini.org> 1572339703 +0100\n\nci: extract job skipping logic into a script\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4fb8a9a73cb5c42543e02ce1d797a6d028f6068f", "html_url": "https://github.com/rust-lang/rust/commit/4fb8a9a73cb5c42543e02ce1d797a6d028f6068f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4fb8a9a73cb5c42543e02ce1d797a6d028f6068f/comments", "author": {"login": "pietroalbini", "id": 2299951, "node_id": "MDQ6VXNlcjIyOTk5NTE=", "avatar_url": "https://avatars.githubusercontent.com/u/2299951?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pietroalbini", "html_url": "https://github.com/pietroalbini", "followers_url": "https://api.github.com/users/pietroalbini/followers", "following_url": "https://api.github.com/users/pietroalbini/following{/other_user}", "gists_url": "https://api.github.com/users/pietroalbini/gists{/gist_id}", "starred_url": "https://api.github.com/users/pietroalbini/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pietroalbini/subscriptions", "organizations_url": "https://api.github.com/users/pietroalbini/orgs", "repos_url": "https://api.github.com/users/pietroalbini/repos", "events_url": "https://api.github.com/users/pietroalbini/events{/privacy}", "received_events_url": "https://api.github.com/users/pietroalbini/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pietroalbini", "id": 2299951, "node_id": "MDQ6VXNlcjIyOTk5NTE=", "avatar_url": "https://avatars.githubusercontent.com/u/2299951?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pietroalbini", "html_url": "https://github.com/pietroalbini", "followers_url": "https://api.github.com/users/pietroalbini/followers", "following_url": "https://api.github.com/users/pietroalbini/following{/other_user}", "gists_url": "https://api.github.com/users/pietroalbini/gists{/gist_id}", "starred_url": "https://api.github.com/users/pietroalbini/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pietroalbini/subscriptions", "organizations_url": "https://api.github.com/users/pietroalbini/orgs", "repos_url": "https://api.github.com/users/pietroalbini/repos", "events_url": "https://api.github.com/users/pietroalbini/events{/privacy}", "received_events_url": "https://api.github.com/users/pietroalbini/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "53be2724157ca6fe9412e52dea56d4b29759ac11", "url": "https://api.github.com/repos/rust-lang/rust/commits/53be2724157ca6fe9412e52dea56d4b29759ac11", "html_url": "https://github.com/rust-lang/rust/commit/53be2724157ca6fe9412e52dea56d4b29759ac11"}], "stats": {"total": 35, "additions": 21, "deletions": 14}, "files": [{"sha": "b8e32cf2cdfe317617cbe642e7106ea6f0dfeba0", "filename": "src/ci/azure-pipelines/steps/run.yml", "status": "modified", "additions": 1, "deletions": 14, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/4fb8a9a73cb5c42543e02ce1d797a6d028f6068f/src%2Fci%2Fazure-pipelines%2Fsteps%2Frun.yml", "raw_url": "https://github.com/rust-lang/rust/raw/4fb8a9a73cb5c42543e02ce1d797a6d028f6068f/src%2Fci%2Fazure-pipelines%2Fsteps%2Frun.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fazure-pipelines%2Fsteps%2Frun.yml?ref=4fb8a9a73cb5c42543e02ce1d797a6d028f6068f", "patch": "@@ -21,21 +21,8 @@ steps:\n - checkout: self\n   fetchDepth: 2\n \n-# Set the SKIP_JOB environment variable if this job is supposed to only run\n-# when submodules are updated and they were not. The following time consuming\n-# tasks will be skipped when the environment variable is present.\n-- bash: |\n-    set -e\n-    # Submodules pseudo-files inside git have the 160000 permissions, so when\n-    # those files are present in the diff a submodule was updated.\n-    if git diff HEAD^ | grep \"^index .* 160000\" >/dev/null 2>&1; then\n-        echo \"Executing the job since submodules are updated\"\n-    else\n-        echo \"Not executing this job since no submodules were updated\"\n-        echo \"##vso[task.setvariable variable=SKIP_JOB;]1\"\n-    fi\n+- bash: src/ci/scripts/should-skip-this.sh\n   displayName: Decide whether to run this job\n-  condition: and(succeeded(), variables.CI_ONLY_WHEN_SUBMODULES_CHANGED)\n \n # Spawn a background process to collect CPU usage statistics which we'll upload\n # at the end of the build. See the comments in the script here for more"}, {"sha": "a38099a2db7ff7c526212c648fd05269a0ca69a6", "filename": "src/ci/scripts/should-skip-this.sh", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/4fb8a9a73cb5c42543e02ce1d797a6d028f6068f/src%2Fci%2Fscripts%2Fshould-skip-this.sh", "raw_url": "https://github.com/rust-lang/rust/raw/4fb8a9a73cb5c42543e02ce1d797a6d028f6068f/src%2Fci%2Fscripts%2Fshould-skip-this.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fscripts%2Fshould-skip-this.sh?ref=4fb8a9a73cb5c42543e02ce1d797a6d028f6068f", "patch": "@@ -0,0 +1,20 @@\n+#!/bin/bash\n+# Set the SKIP_JOB environment variable if this job is supposed to only run\n+# when submodules are updated and they were not. The following time consuming\n+# tasks will be skipped when the environment variable is present.\n+\n+set -euo pipefail\n+IFS=$'\\n\\t'\n+\n+source \"$(cd \"$(dirname \"$0\")\" && pwd)/../shared.sh\"\n+\n+if [[ -z \"${CI_ONLY_WHEN_SUBMODULES_CHANGED+x}\" ]]; then\n+    echo \"Executing the job since there is no skip rule in effect\"\n+elif git diff HEAD^ | grep \"^index .* 160000\" >/dev/null 2>&1; then\n+    # Submodules pseudo-files inside git have the 160000 permissions, so when\n+    # those files are present in the diff a submodule was updated.\n+    echo \"Executing the job since submodules are updated\"\n+else\n+    echo \"Not executing this job since no submodules were updated\"\n+    ciCommandSetEnv SKIP_JOB 1\n+fi"}]}