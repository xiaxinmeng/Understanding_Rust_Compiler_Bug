{"sha": "3cbe0f1b48dfdb7866f45a1d683b1391ed4d0508", "node_id": "C_kwDOAAsO6NoAKDNjYmUwZjFiNDhkZmRiNzg2NmY0NWExZDY4M2IxMzkxZWQ0ZDA1MDg", "commit": {"author": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2021-12-07T00:00:00Z"}, "committer": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2021-12-07T00:00:00Z"}, "message": "Add test for packed drops in generators", "tree": {"sha": "ee60cd5aec17da1ed14751bae87700e5fadbddf7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ee60cd5aec17da1ed14751bae87700e5fadbddf7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3cbe0f1b48dfdb7866f45a1d683b1391ed4d0508", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3cbe0f1b48dfdb7866f45a1d683b1391ed4d0508", "html_url": "https://github.com/rust-lang/rust/commit/3cbe0f1b48dfdb7866f45a1d683b1391ed4d0508", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3cbe0f1b48dfdb7866f45a1d683b1391ed4d0508/comments", "author": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0b6f079e4987ded15c13a15b734e7cfb8176839f", "url": "https://api.github.com/repos/rust-lang/rust/commits/0b6f079e4987ded15c13a15b734e7cfb8176839f", "html_url": "https://github.com/rust-lang/rust/commit/0b6f079e4987ded15c13a15b734e7cfb8176839f"}], "stats": {"total": 28, "additions": 26, "deletions": 2}, "files": [{"sha": "b95cdbbbaad3b2e857774c69c96df9c64fb76950", "filename": "src/test/ui/packed/packed-struct-drop-aligned.rs", "status": "modified", "additions": 26, "deletions": 2, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/3cbe0f1b48dfdb7866f45a1d683b1391ed4d0508/src%2Ftest%2Fui%2Fpacked%2Fpacked-struct-drop-aligned.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3cbe0f1b48dfdb7866f45a1d683b1391ed4d0508/src%2Ftest%2Fui%2Fpacked%2Fpacked-struct-drop-aligned.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fpacked%2Fpacked-struct-drop-aligned.rs?ref=3cbe0f1b48dfdb7866f45a1d683b1391ed4d0508", "patch": "@@ -1,6 +1,10 @@\n // run-pass\n+#![feature(generators)]\n+#![feature(generator_trait)]\n use std::cell::Cell;\n use std::mem;\n+use std::ops::Generator;\n+use std::pin::Pin;\n \n struct Aligned<'a> {\n     drop_count: &'a Cell<usize>\n@@ -19,15 +23,35 @@ impl<'a> Drop for Aligned<'a> {\n     }\n }\n \n+#[repr(transparent)]\n+struct NotCopy(u8);\n+\n #[repr(packed)]\n-struct Packed<'a>(u8, Aligned<'a>);\n+struct Packed<'a>(NotCopy, Aligned<'a>);\n \n fn main() {\n     let drop_count = &Cell::new(0);\n     {\n-        let mut p = Packed(0, Aligned { drop_count });\n+        let mut p = Packed(NotCopy(0), Aligned { drop_count });\n         p.1 = Aligned { drop_count };\n         assert_eq!(drop_count.get(), 1);\n     }\n     assert_eq!(drop_count.get(), 2);\n+\n+    let drop_count = &Cell::new(0);\n+    let mut g = || {\n+        let mut p = Packed(NotCopy(0), Aligned { drop_count });\n+        let _ = &p;\n+        p.1 = Aligned { drop_count };\n+        assert_eq!(drop_count.get(), 1);\n+        // Test that a generator drop function moves a value from a packed\n+        // struct to a separate local before dropping it. We move out the\n+        // first field to generate and open drop for the second field.\n+        drop(p.0);\n+        yield;\n+    };\n+    Pin::new(&mut g).resume(());\n+    assert_eq!(drop_count.get(), 1);\n+    drop(g);\n+    assert_eq!(drop_count.get(), 2);\n }"}]}