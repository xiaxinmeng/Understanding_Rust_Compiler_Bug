{"sha": "3f0e77f19c16eb3cd46390ab0082ad749cb1c5b5", "node_id": "MDY6Q29tbWl0NzI0NzEyOjNmMGU3N2YxOWMxNmViM2NkNDYzOTBhYjAwODJhZDc0OWNiMWM1YjU=", "commit": {"author": {"name": "Mark Rousskov", "email": "mark.simulacrum@gmail.com", "date": "2019-08-31T16:18:25Z"}, "committer": {"name": "Mark Rousskov", "email": "mark.simulacrum@gmail.com", "date": "2019-09-07T23:31:58Z"}, "message": "layout::render takes Print instead of fmt::Display", "tree": {"sha": "4dc32e0559545fceb86067ce95bfc1b444e41e21", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4dc32e0559545fceb86067ce95bfc1b444e41e21"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3f0e77f19c16eb3cd46390ab0082ad749cb1c5b5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3f0e77f19c16eb3cd46390ab0082ad749cb1c5b5", "html_url": "https://github.com/rust-lang/rust/commit/3f0e77f19c16eb3cd46390ab0082ad749cb1c5b5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3f0e77f19c16eb3cd46390ab0082ad749cb1c5b5/comments", "author": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d5f147086bbc70eb248804d3a16c643979fd1f2b", "url": "https://api.github.com/repos/rust-lang/rust/commits/d5f147086bbc70eb248804d3a16c643979fd1f2b", "html_url": "https://github.com/rust-lang/rust/commit/d5f147086bbc70eb248804d3a16c643979fd1f2b"}], "stats": {"total": 26, "additions": 15, "deletions": 11}, "files": [{"sha": "80f34fb17d2e8385bb1b33e8fcf4b80d88f80679", "filename": "src/librustdoc/html/format.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/3f0e77f19c16eb3cd46390ab0082ad749cb1c5b5/src%2Flibrustdoc%2Fhtml%2Fformat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3f0e77f19c16eb3cd46390ab0082ad749cb1c5b5/src%2Flibrustdoc%2Fhtml%2Fformat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fformat.rs?ref=3f0e77f19c16eb3cd46390ab0082ad749cb1c5b5", "patch": "@@ -99,7 +99,11 @@ impl Buffer {\n         self.into_inner()\n     }\n \n-    crate fn display<T: fmt::Display>(&mut self, t: T) {\n+    crate fn with_formatter<T: FnOnce(&mut fmt::Formatter<'_>) -> fmt::Result>(&mut self, t: T) {\n+        self.from_display(display_fn(move |f| (t)(f)));\n+    }\n+\n+    crate fn from_display<T: std::fmt::Display>(&mut self, t: T) {\n         if self.for_html {\n             write!(self, \"{}\", t);\n         } else {"}, {"sha": "56074f4ab1192de9a88c33be9cae8638a215767b", "filename": "src/librustdoc/html/layout.rs", "status": "modified", "additions": 3, "deletions": 4, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/3f0e77f19c16eb3cd46390ab0082ad749cb1c5b5/src%2Flibrustdoc%2Fhtml%2Flayout.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3f0e77f19c16eb3cd46390ab0082ad749cb1c5b5/src%2Flibrustdoc%2Fhtml%2Flayout.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Flayout.rs?ref=3f0e77f19c16eb3cd46390ab0082ad749cb1c5b5", "patch": "@@ -1,4 +1,3 @@\n-use std::fmt;\n use std::path::PathBuf;\n \n use crate::externalfiles::ExternalHtml;\n@@ -31,11 +30,11 @@ pub struct Page<'a> {\n     pub static_extra_scripts: &'a [&'a str],\n }\n \n-pub fn render<T: fmt::Display, S: Print>(\n+pub fn render<T: Print, S: Print>(\n     layout: &Layout,\n     page: &Page<'_>,\n     sidebar: S,\n-    t: &T,\n+    t: T,\n     themes: &[PathBuf],\n ) -> String {\n     let static_root_path = page.static_root_path.unwrap_or(page.root_path);\n@@ -175,7 +174,7 @@ pub fn render<T: fmt::Display, S: Print>(\n     } else {\n         String::new()\n     },\n-    content   = *t,\n+    content   = Buffer::html().to_display(t),\n     static_root_path = static_root_path,\n     root_path = page.root_path,\n     css_class = page.css_class,"}, {"sha": "4514a540f543ab80d9057fd15c6b160d300371aa", "filename": "src/librustdoc/html/render.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/3f0e77f19c16eb3cd46390ab0082ad749cb1c5b5/src%2Flibrustdoc%2Fhtml%2Frender.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3f0e77f19c16eb3cd46390ab0082ad749cb1c5b5/src%2Flibrustdoc%2Fhtml%2Frender.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender.rs?ref=3f0e77f19c16eb3cd46390ab0082ad749cb1c5b5", "patch": "@@ -65,7 +65,7 @@ use crate::docfs::{DocFS, ErrorStorage, PathError};\n use crate::doctree;\n use crate::fold::DocFolder;\n use crate::html::escape::Escape;\n-use crate::html::format::{Print, Buffer, AsyncSpace, ConstnessSpace};\n+use crate::html::format::{Buffer, AsyncSpace, ConstnessSpace};\n use crate::html::format::{GenericBounds, WhereClause, href, AbiSpace, DefaultSpace};\n use crate::html::format::{VisSpace, Function, UnsafetySpace, MutableSpace};\n use crate::html::format::fmt_impl_for_trait_page;\n@@ -1172,7 +1172,7 @@ themePicker.onblur = handleThemeButtonsBlur;\n                                     })\n                                     .collect::<String>());\n             let v = layout::render(&cx.shared.layout,\n-                           &page, \"\", &content,\n+                           &page, \"\", content,\n                            &cx.shared.themes);\n             cx.shared.fs.write(&dst, v.as_bytes())?;\n         }\n@@ -1919,7 +1919,7 @@ impl Context {\n             String::new()\n         };\n         let v = layout::render(&self.shared.layout,\n-                       &page, sidebar, &all,\n+                       &page, sidebar, |buf: &mut Buffer| buf.from_display(all),\n                        &self.shared.themes);\n         self.shared.fs.write(&final_file, v.as_bytes())?;\n \n@@ -1935,7 +1935,7 @@ impl Context {\n         themes.push(PathBuf::from(\"settings.css\"));\n         let v = layout::render(\n             &self.shared.layout,\n-            &page, sidebar, &settings,\n+            &page, sidebar, |buf: &mut Buffer| buf.from_display(settings),\n             &themes);\n         self.shared.fs.write(&settings_file, v.as_bytes())?;\n \n@@ -1993,7 +1993,7 @@ impl Context {\n         if !self.render_redirect_pages {\n             layout::render(&self.shared.layout, &page,\n                            |buf: &mut _| print_sidebar(self, it, buf),\n-                           &Item{ cx: self, item: it },\n+                           |buf: &mut Buffer| buf.from_display(Item { cx: self, item: it }),\n                            &self.shared.themes)\n         } else {\n             let mut url = self.root_path();"}, {"sha": "e94ae1d968ef5a625a8a5c6eb39ebe8aae781e13", "filename": "src/librustdoc/html/sources.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/3f0e77f19c16eb3cd46390ab0082ad749cb1c5b5/src%2Flibrustdoc%2Fhtml%2Fsources.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3f0e77f19c16eb3cd46390ab0082ad749cb1c5b5/src%2Flibrustdoc%2Fhtml%2Fsources.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fsources.rs?ref=3f0e77f19c16eb3cd46390ab0082ad749cb1c5b5", "patch": "@@ -4,6 +4,7 @@ use crate::fold::DocFolder;\n use crate::html::layout;\n use crate::html::render::{Error, SharedContext, BASIC_KEYWORDS};\n use crate::html::highlight;\n+use crate::html::format::Buffer;\n use std::ffi::OsStr;\n use std::fs;\n use std::path::{Component, Path, PathBuf};\n@@ -120,7 +121,7 @@ impl<'a> SourceCollector<'a> {\n             static_extra_scripts: &[&format!(\"source-script{}\", self.scx.resource_suffix)],\n         };\n         let v = layout::render(&self.scx.layout,\n-                       &page, \"\", &Source(contents),\n+                       &page, \"\", |buf: &mut Buffer| buf.from_display(Source(&contents)),\n                        &self.scx.themes);\n         self.scx.fs.write(&cur, v.as_bytes())?;\n         self.scx.local_sources.insert(p.clone(), href);"}]}