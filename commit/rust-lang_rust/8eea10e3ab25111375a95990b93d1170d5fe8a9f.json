{"sha": "8eea10e3ab25111375a95990b93d1170d5fe8a9f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjhlZWExMGUzYWIyNTExMTM3NWE5NTk5MGI5M2QxMTcwZDVmZThhOWY=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2018-10-20T19:35:55Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2018-10-20T19:35:55Z"}, "message": "actually check for cancelation", "tree": {"sha": "469ec771c1e1d3608518557f05d175703dec85d9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/469ec771c1e1d3608518557f05d175703dec85d9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8eea10e3ab25111375a95990b93d1170d5fe8a9f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8eea10e3ab25111375a95990b93d1170d5fe8a9f", "html_url": "https://github.com/rust-lang/rust/commit/8eea10e3ab25111375a95990b93d1170d5fe8a9f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8eea10e3ab25111375a95990b93d1170d5fe8a9f/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "71cbdddf1c6b6c34c05aea01b92bb8a105b32c71", "url": "https://api.github.com/repos/rust-lang/rust/commits/71cbdddf1c6b6c34c05aea01b92bb8a105b32c71", "html_url": "https://github.com/rust-lang/rust/commit/71cbdddf1c6b6c34c05aea01b92bb8a105b32c71"}], "stats": {"total": 27, "additions": 20, "deletions": 7}, "files": [{"sha": "09d74b9e742f7c7d62758302bfabf99da9ccba23", "filename": "crates/ra_analysis/src/db.rs", "status": "modified", "additions": 11, "deletions": 1, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/8eea10e3ab25111375a95990b93d1170d5fe8a9f/crates%2Fra_analysis%2Fsrc%2Fdb.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8eea10e3ab25111375a95990b93d1170d5fe8a9f/crates%2Fra_analysis%2Fsrc%2Fdb.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_analysis%2Fsrc%2Fdb.rs?ref=8eea10e3ab25111375a95990b93d1170d5fe8a9f", "patch": "@@ -10,7 +10,8 @@ use rustc_hash::FxHashSet;\n use salsa;\n \n use crate::{\n-    Cancelable,\n+    db,\n+    Cancelable, Canceled,\n     module_map::{ModuleDescriptorQuery, ModuleTreeQuery, ModulesDatabase},\n     symbol_index::SymbolIndex,\n     FileId, FileResolverImp,\n@@ -33,6 +34,14 @@ impl salsa::Database for RootDatabase {\n     }\n }\n \n+pub(crate) fn check_canceled(db: &impl salsa::Database) -> Cancelable<()> {\n+    if db.salsa_runtime().is_current_revision_canceled() {\n+        Err(Canceled)\n+    } else {\n+        Ok(())\n+    }\n+}\n+\n impl salsa::ParallelDatabase for RootDatabase {\n     fn fork(&self) -> Self {\n         RootDatabase {\n@@ -115,6 +124,7 @@ fn file_lines(db: &impl SyntaxDatabase, file_id: FileId) -> Arc<LineIndex> {\n     Arc::new(LineIndex::new(&*text))\n }\n fn file_symbols(db: &impl SyntaxDatabase, file_id: FileId) -> Cancelable<Arc<SymbolIndex>> {\n+    db::check_canceled(db)?;\n     let syntax = db.file_syntax(file_id);\n     Ok(Arc::new(SymbolIndex::for_file(file_id, syntax)))\n }"}, {"sha": "03708d450520747ff29e1c9c98d313ed31b4ab97", "filename": "crates/ra_analysis/src/lib.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/8eea10e3ab25111375a95990b93d1170d5fe8a9f/crates%2Fra_analysis%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8eea10e3ab25111375a95990b93d1170d5fe8a9f/crates%2Fra_analysis%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_analysis%2Fsrc%2Flib.rs?ref=8eea10e3ab25111375a95990b93d1170d5fe8a9f", "patch": "@@ -38,17 +38,17 @@ pub use ra_editor::{\n };\n \n #[derive(Clone, Copy, Debug, PartialEq, Eq, Hash, PartialOrd, Ord)]\n-pub struct Cancel;\n+pub struct Canceled;\n \n-pub type Cancelable<T> = Result<T, Cancel>;\n+pub type Cancelable<T> = Result<T, Canceled>;\n \n-impl std::fmt::Display for Cancel {\n+impl std::fmt::Display for Canceled {\n     fn fmt(&self, fmt: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {\n         fmt.write_str(\"Canceled\")\n     }\n }\n \n-impl std::error::Error for Cancel {\n+impl std::error::Error for Canceled {\n }\n \n #[derive(Debug, Clone, Copy, PartialEq, Eq, PartialOrd, Ord, Hash)]"}, {"sha": "3c800265ad3146075fd3ecb57676c8f999629fba", "filename": "crates/ra_analysis/src/module_map.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/8eea10e3ab25111375a95990b93d1170d5fe8a9f/crates%2Fra_analysis%2Fsrc%2Fmodule_map.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8eea10e3ab25111375a95990b93d1170d5fe8a9f/crates%2Fra_analysis%2Fsrc%2Fmodule_map.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_analysis%2Fsrc%2Fmodule_map.rs?ref=8eea10e3ab25111375a95990b93d1170d5fe8a9f", "patch": "@@ -1,12 +1,13 @@\n+use std::sync::Arc;\n+\n use crate::{\n+    db,\n     Cancelable,\n     db::SyntaxDatabase,\n     descriptors::{ModuleDescriptor, ModuleTreeDescriptor},\n     FileId,\n };\n \n-use std::sync::Arc;\n-\n salsa::query_group! {\n     pub(crate) trait ModulesDatabase: SyntaxDatabase {\n         fn module_tree() -> Cancelable<Arc<ModuleTreeDescriptor>> {\n@@ -19,11 +20,13 @@ salsa::query_group! {\n }\n \n fn module_descriptor(db: &impl ModulesDatabase, file_id: FileId) -> Cancelable<Arc<ModuleDescriptor>> {\n+    db::check_canceled(db)?;\n     let file = db.file_syntax(file_id);\n     Ok(Arc::new(ModuleDescriptor::new(file.ast())))\n }\n \n fn module_tree(db: &impl ModulesDatabase) -> Cancelable<Arc<ModuleTreeDescriptor>> {\n+    db::check_canceled(db)?;\n     let file_set = db.file_set();\n     let mut files = Vec::new();\n     for &file_id in file_set.files.iter() {"}]}