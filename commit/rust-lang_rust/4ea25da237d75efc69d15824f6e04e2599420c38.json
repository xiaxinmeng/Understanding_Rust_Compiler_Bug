{"sha": "4ea25da237d75efc69d15824f6e04e2599420c38", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRlYTI1ZGEyMzdkNzVlZmM2OWQxNTgyNGY2ZTA0ZTI1OTk0MjBjMzg=", "commit": {"author": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2020-11-17T00:00:00Z"}, "committer": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2020-11-17T00:00:00Z"}, "message": "Fix setting inline hint based on `InstanceDef::requires_inline`\n\nFor instances where `InstanceDef::requires_inline` is true, an attempt\nis made to set an inline hint though a call to the `inline` function.\nThe attempt is ineffective, since all attributes will be usually removed\nby the second call.\n\nFix the issue by applying the attributes only once, with user provided\nattributes having a priority when provided.", "tree": {"sha": "ae05a0e5a55d9444d6714861caa6db977857c4c0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ae05a0e5a55d9444d6714861caa6db977857c4c0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4ea25da237d75efc69d15824f6e04e2599420c38", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4ea25da237d75efc69d15824f6e04e2599420c38", "html_url": "https://github.com/rust-lang/rust/commit/4ea25da237d75efc69d15824f6e04e2599420c38", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4ea25da237d75efc69d15824f6e04e2599420c38/comments", "author": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f5230fbf76bafd86ee4376a0e26e551df8d17fec", "url": "https://api.github.com/repos/rust-lang/rust/commits/f5230fbf76bafd86ee4376a0e26e551df8d17fec", "html_url": "https://github.com/rust-lang/rust/commit/f5230fbf76bafd86ee4376a0e26e551df8d17fec"}], "stats": {"total": 47, "additions": 35, "deletions": 12}, "files": [{"sha": "9a2fbf359ea127d71d1ae4fd0c761de053dbfb75", "filename": "compiler/rustc_codegen_llvm/src/attributes.rs", "status": "modified", "additions": 4, "deletions": 12, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/4ea25da237d75efc69d15824f6e04e2599420c38/compiler%2Frustc_codegen_llvm%2Fsrc%2Fattributes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4ea25da237d75efc69d15824f6e04e2599420c38/compiler%2Frustc_codegen_llvm%2Fsrc%2Fattributes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fattributes.rs?ref=4ea25da237d75efc69d15824f6e04e2599420c38", "patch": "@@ -25,7 +25,7 @@ use crate::value::Value;\n \n /// Mark LLVM function to use provided inline heuristic.\n #[inline]\n-fn inline(cx: &CodegenCx<'ll, '_>, val: &'ll Value, inline: InlineAttr) {\n+fn inline(cx: &CodegenCx<'ll, '_>, val: &'ll Value, inline: InlineAttr, requires_inline: bool) {\n     use self::InlineAttr::*;\n     match inline {\n         Hint => Attribute::InlineHint.apply_llfn(Function, val),\n@@ -35,11 +35,8 @@ fn inline(cx: &CodegenCx<'ll, '_>, val: &'ll Value, inline: InlineAttr) {\n                 Attribute::NoInline.apply_llfn(Function, val);\n             }\n         }\n-        None => {\n-            Attribute::InlineHint.unapply_llfn(Function, val);\n-            Attribute::AlwaysInline.unapply_llfn(Function, val);\n-            Attribute::NoInline.unapply_llfn(Function, val);\n-        }\n+        None if requires_inline => Attribute::InlineHint.apply_llfn(Function, val),\n+        None => {}\n     };\n }\n \n@@ -229,12 +226,7 @@ pub fn from_fn_attrs(cx: &CodegenCx<'ll, 'tcx>, llfn: &'ll Value, instance: ty::\n         }\n     }\n \n-    // FIXME(eddyb) consolidate these two `inline` calls (and avoid overwrites).\n-    if instance.def.requires_inline(cx.tcx) {\n-        inline(cx, llfn, attributes::InlineAttr::Hint);\n-    }\n-\n-    inline(cx, llfn, codegen_fn_attrs.inline.clone());\n+    inline(cx, llfn, codegen_fn_attrs.inline.clone(), instance.def.requires_inline(cx.tcx));\n \n     // The `uwtable` attribute according to LLVM is:\n     //"}, {"sha": "a2571c2e532a73f80777b2a609546fb3ba4f9d16", "filename": "src/test/codegen/inline-hint.rs", "status": "added", "additions": 31, "deletions": 0, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/4ea25da237d75efc69d15824f6e04e2599420c38/src%2Ftest%2Fcodegen%2Finline-hint.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4ea25da237d75efc69d15824f6e04e2599420c38/src%2Ftest%2Fcodegen%2Finline-hint.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Finline-hint.rs?ref=4ea25da237d75efc69d15824f6e04e2599420c38", "patch": "@@ -0,0 +1,31 @@\n+// Checks that closures, constructors, and shims except\n+// for a drop glue receive inline hint by default.\n+//\n+// compile-flags: -Cno-prepopulate-passes -Zsymbol-mangling-version=v0\n+#![crate_type = \"lib\"]\n+\n+pub fn f() {\n+    let a = A;\n+    let b = (0i32, 1i32, 2i32, 3i32);\n+    let c = || {};\n+\n+    a(String::new(), String::new());\n+    b.clone();\n+    c();\n+}\n+\n+struct A(String, String);\n+\n+// CHECK:      ; core::ptr::drop_in_place::<inline_hint::A>\n+// CHECK-NEXT: ; Function Attrs:\n+// CHECK-NOT:  inlinehint\n+// CHECK-SAME: {{$}}\n+\n+// CHECK:      ; <(i32, i32, i32, i32) as core::clone::Clone>::clone\n+// CHECK-NEXT: ; Function Attrs: inlinehint\n+\n+// CHECK:      ; inline_hint::f::{closure#0}\n+// CHECK-NEXT: ; Function Attrs: inlinehint\n+\n+// CHECK:      ; inline_hint::A\n+// CHECK-NEXT: ; Function Attrs: inlinehint"}]}