{"sha": "f84000d9bc93f7c09243144d1a729448da3d714d", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY4NDAwMGQ5YmM5M2Y3YzA5MjQzMTQ0ZDFhNzI5NDQ4ZGEzZDcxNGQ=", "commit": {"author": {"name": "Waffle", "email": "waffle.lapkin@gmail.com", "date": "2021-09-16T17:57:12Z"}, "committer": {"name": "Waffle", "email": "waffle.lapkin@gmail.com", "date": "2021-09-16T18:32:05Z"}, "message": "Add a separate error for `dyn Trait` in `const fn`\n\nPreviously \"trait bounds other than `Sized` on const fn parameters are unstable\"\nerror was used for both trait bounds (<T: Trait>) and trait objects (dyn Trait).\nThis was pretty confusing.\n\nThis patch adds a separeta error for trait objects: \"trait objects in const fn\nare unstable\". The error for trait bounds is otherwise intact.", "tree": {"sha": "e7362af6b7d5ce074b91397434e08484355e282c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e7362af6b7d5ce074b91397434e08484355e282c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f84000d9bc93f7c09243144d1a729448da3d714d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f84000d9bc93f7c09243144d1a729448da3d714d", "html_url": "https://github.com/rust-lang/rust/commit/f84000d9bc93f7c09243144d1a729448da3d714d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f84000d9bc93f7c09243144d1a729448da3d714d/comments", "author": {"login": "WaffleLapkin", "id": 38225716, "node_id": "MDQ6VXNlcjM4MjI1NzE2", "avatar_url": "https://avatars.githubusercontent.com/u/38225716?v=4", "gravatar_id": "", "url": "https://api.github.com/users/WaffleLapkin", "html_url": "https://github.com/WaffleLapkin", "followers_url": "https://api.github.com/users/WaffleLapkin/followers", "following_url": "https://api.github.com/users/WaffleLapkin/following{/other_user}", "gists_url": "https://api.github.com/users/WaffleLapkin/gists{/gist_id}", "starred_url": "https://api.github.com/users/WaffleLapkin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/WaffleLapkin/subscriptions", "organizations_url": "https://api.github.com/users/WaffleLapkin/orgs", "repos_url": "https://api.github.com/users/WaffleLapkin/repos", "events_url": "https://api.github.com/users/WaffleLapkin/events{/privacy}", "received_events_url": "https://api.github.com/users/WaffleLapkin/received_events", "type": "User", "site_admin": false}, "committer": {"login": "WaffleLapkin", "id": 38225716, "node_id": "MDQ6VXNlcjM4MjI1NzE2", "avatar_url": "https://avatars.githubusercontent.com/u/38225716?v=4", "gravatar_id": "", "url": "https://api.github.com/users/WaffleLapkin", "html_url": "https://github.com/WaffleLapkin", "followers_url": "https://api.github.com/users/WaffleLapkin/followers", "following_url": "https://api.github.com/users/WaffleLapkin/following{/other_user}", "gists_url": "https://api.github.com/users/WaffleLapkin/gists{/gist_id}", "starred_url": "https://api.github.com/users/WaffleLapkin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/WaffleLapkin/subscriptions", "organizations_url": "https://api.github.com/users/WaffleLapkin/orgs", "repos_url": "https://api.github.com/users/WaffleLapkin/repos", "events_url": "https://api.github.com/users/WaffleLapkin/events{/privacy}", "received_events_url": "https://api.github.com/users/WaffleLapkin/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6ec7255d7b9c96c4cc0feafec6f26a2a9db3b7aa", "url": "https://api.github.com/repos/rust-lang/rust/commits/6ec7255d7b9c96c4cc0feafec6f26a2a9db3b7aa", "html_url": "https://github.com/rust-lang/rust/commit/6ec7255d7b9c96c4cc0feafec6f26a2a9db3b7aa"}], "stats": {"total": 85, "additions": 62, "deletions": 23}, "files": [{"sha": "ce957331b4b46ba23d931530192136c56d36af1d", "filename": "compiler/rustc_const_eval/src/transform/check_consts/check.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/f84000d9bc93f7c09243144d1a729448da3d714d/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fcheck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f84000d9bc93f7c09243144d1a729448da3d714d/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fcheck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fcheck.rs?ref=f84000d9bc93f7c09243144d1a729448da3d714d", "patch": "@@ -384,11 +384,11 @@ impl Checker<'mir, 'tcx> {\n                         match pred.skip_binder() {\n                             ty::ExistentialPredicate::AutoTrait(_)\n                             | ty::ExistentialPredicate::Projection(_) => {\n-                                self.check_op(ops::ty::TraitBound(kind))\n+                                self.check_op(ops::ty::DynTrait(kind))\n                             }\n                             ty::ExistentialPredicate::Trait(trait_ref) => {\n                                 if Some(trait_ref.def_id) != self.tcx.lang_items().sized_trait() {\n-                                    self.check_op(ops::ty::TraitBound(kind))\n+                                    self.check_op(ops::ty::DynTrait(kind))\n                                 }\n                             }\n                         }"}, {"sha": "1d0ee949a221b8df1ff9fe29abfb079d6fb066e0", "filename": "compiler/rustc_const_eval/src/transform/check_consts/ops.rs", "status": "modified", "additions": 42, "deletions": 3, "changes": 45, "blob_url": "https://github.com/rust-lang/rust/blob/f84000d9bc93f7c09243144d1a729448da3d714d/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fops.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f84000d9bc93f7c09243144d1a729448da3d714d/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fops.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fops.rs?ref=f84000d9bc93f7c09243144d1a729448da3d714d", "patch": "@@ -599,7 +599,7 @@ pub mod ty {\n         }\n \n         fn build_error(&self, ccx: &ConstCx<'_, 'tcx>, span: Span) -> DiagnosticBuilder<'tcx> {\n-            let mut builder = feature_err(\n+            let mut err = feature_err(\n                 &ccx.tcx.sess.parse_sess,\n                 sym::const_fn_trait_bound,\n                 span,\n@@ -608,12 +608,51 @@ pub mod ty {\n \n             match ccx.fn_sig() {\n                 Some(fn_sig) if !fn_sig.span.contains(span) => {\n-                    builder.span_label(fn_sig.span, \"function declared as const here\");\n+                    err.span_label(fn_sig.span, \"function declared as const here\");\n                 }\n                 _ => {}\n             }\n \n-            builder\n+            err\n+        }\n+    }\n+\n+    #[derive(Debug)]\n+    pub struct DynTrait(pub mir::LocalKind);\n+    impl NonConstOp for DynTrait {\n+        fn importance(&self) -> DiagnosticImportance {\n+            match self.0 {\n+                mir::LocalKind::Var | mir::LocalKind::Temp => DiagnosticImportance::Secondary,\n+                mir::LocalKind::ReturnPointer | mir::LocalKind::Arg => {\n+                    DiagnosticImportance::Primary\n+                }\n+            }\n+        }\n+\n+        fn status_in_item(&self, ccx: &ConstCx<'_, '_>) -> Status {\n+            if ccx.const_kind() != hir::ConstContext::ConstFn {\n+                Status::Allowed\n+            } else {\n+                Status::Unstable(sym::const_fn_trait_bound)\n+            }\n+        }\n+\n+        fn build_error(&self, ccx: &ConstCx<'_, 'tcx>, span: Span) -> DiagnosticBuilder<'tcx> {\n+            let mut err = feature_err(\n+                &ccx.tcx.sess.parse_sess,\n+                sym::const_fn_trait_bound,\n+                span,\n+                \"trait objects in const fn are unstable\",\n+            );\n+\n+            match ccx.fn_sig() {\n+                Some(fn_sig) if !fn_sig.span.contains(span) => {\n+                    err.span_label(fn_sig.span, \"function declared as const here\");\n+                }\n+                _ => {}\n+            }\n+\n+            err\n         }\n     }\n "}, {"sha": "19c08b621442522b7d5ef316655d5476432312f5", "filename": "src/test/ui/consts/const_fn_trait_bound.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/f84000d9bc93f7c09243144d1a729448da3d714d/src%2Ftest%2Fui%2Fconsts%2Fconst_fn_trait_bound.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f84000d9bc93f7c09243144d1a729448da3d714d/src%2Ftest%2Fui%2Fconsts%2Fconst_fn_trait_bound.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fconst_fn_trait_bound.rs?ref=f84000d9bc93f7c09243144d1a729448da3d714d", "patch": "@@ -8,9 +8,9 @@\n const fn test1<T: std::ops::Add>() {}\n //[stock]~^ trait bounds\n const fn test2(_x: &dyn Send) {}\n-//[stock]~^ trait bounds\n+//[stock]~^ trait objects in const fn are unstable\n const fn test3() -> &'static dyn Send { loop {} }\n-//[stock]~^ trait bounds\n+//[stock]~^ trait objects in const fn are unstable\n \n \n #[rustc_error]"}, {"sha": "d652b5268a8bf3594c8743eab58ca184713245d2", "filename": "src/test/ui/consts/const_fn_trait_bound.stock.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/f84000d9bc93f7c09243144d1a729448da3d714d/src%2Ftest%2Fui%2Fconsts%2Fconst_fn_trait_bound.stock.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/f84000d9bc93f7c09243144d1a729448da3d714d/src%2Ftest%2Fui%2Fconsts%2Fconst_fn_trait_bound.stock.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fconst_fn_trait_bound.stock.stderr?ref=f84000d9bc93f7c09243144d1a729448da3d714d", "patch": "@@ -7,7 +7,7 @@ LL | const fn test1<T: std::ops::Add>() {}\n    = note: see issue #57563 <https://github.com/rust-lang/rust/issues/57563> for more information\n    = help: add `#![feature(const_fn_trait_bound)]` to the crate attributes to enable\n \n-error[E0658]: trait bounds other than `Sized` on const fn parameters are unstable\n+error[E0658]: trait objects in const fn are unstable\n   --> $DIR/const_fn_trait_bound.rs:10:16\n    |\n LL | const fn test2(_x: &dyn Send) {}\n@@ -16,7 +16,7 @@ LL | const fn test2(_x: &dyn Send) {}\n    = note: see issue #57563 <https://github.com/rust-lang/rust/issues/57563> for more information\n    = help: add `#![feature(const_fn_trait_bound)]` to the crate attributes to enable\n \n-error[E0658]: trait bounds other than `Sized` on const fn parameters are unstable\n+error[E0658]: trait objects in const fn are unstable\n   --> $DIR/const_fn_trait_bound.rs:12:21\n    |\n LL | const fn test3() -> &'static dyn Send { loop {} }"}, {"sha": "10347a02074ec56221053f5d095b13be2a1aac23", "filename": "src/test/ui/consts/min_const_fn/min_const_fn.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/f84000d9bc93f7c09243144d1a729448da3d714d/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_fn.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f84000d9bc93f7c09243144d1a729448da3d714d/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_fn.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_fn.rs?ref=f84000d9bc93f7c09243144d1a729448da3d714d", "patch": "@@ -130,16 +130,16 @@ const fn no_apit(_x: impl std::fmt::Debug) {}\n //~^ ERROR trait bounds other than `Sized`\n //~| ERROR destructor\n const fn no_dyn_trait(_x: &dyn std::fmt::Debug) {}\n-//~^ ERROR trait bounds other than `Sized`\n+//~^ ERROR trait objects in const fn are unstable\n const fn no_dyn_trait_ret() -> &'static dyn std::fmt::Debug { &() }\n-//~^ ERROR trait bounds other than `Sized`\n+//~^ ERROR trait objects in const fn are unstable\n \n const fn no_unsafe() { unsafe {} }\n \n const fn really_no_traits_i_mean_it() { (&() as &dyn std::fmt::Debug, ()).1 }\n-//~^ ERROR trait bounds other than `Sized`\n-//~| ERROR trait bounds other than `Sized`\n-//~| ERROR trait bounds other than `Sized`\n+//~^ ERROR trait objects in const fn are unstable\n+//~| ERROR trait objects in const fn are unstable\n+//~| ERROR trait objects in const fn are unstable\n \n const fn no_fn_ptrs(_x: fn()) {}\n //~^ ERROR function pointer"}, {"sha": "1e275d77bac672e1820f3fd31d0c66f9fdae589a", "filename": "src/test/ui/consts/min_const_fn/min_const_fn.stderr", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/f84000d9bc93f7c09243144d1a729448da3d714d/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_fn.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/f84000d9bc93f7c09243144d1a729448da3d714d/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_fn.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_fn.stderr?ref=f84000d9bc93f7c09243144d1a729448da3d714d", "patch": "@@ -279,7 +279,7 @@ LL | const fn no_apit(_x: impl std::fmt::Debug) {}\n    |                  |\n    |                  constant functions cannot evaluate destructors\n \n-error[E0658]: trait bounds other than `Sized` on const fn parameters are unstable\n+error[E0658]: trait objects in const fn are unstable\n   --> $DIR/min_const_fn.rs:132:23\n    |\n LL | const fn no_dyn_trait(_x: &dyn std::fmt::Debug) {}\n@@ -288,7 +288,7 @@ LL | const fn no_dyn_trait(_x: &dyn std::fmt::Debug) {}\n    = note: see issue #57563 <https://github.com/rust-lang/rust/issues/57563> for more information\n    = help: add `#![feature(const_fn_trait_bound)]` to the crate attributes to enable\n \n-error[E0658]: trait bounds other than `Sized` on const fn parameters are unstable\n+error[E0658]: trait objects in const fn are unstable\n   --> $DIR/min_const_fn.rs:134:32\n    |\n LL | const fn no_dyn_trait_ret() -> &'static dyn std::fmt::Debug { &() }\n@@ -297,7 +297,7 @@ LL | const fn no_dyn_trait_ret() -> &'static dyn std::fmt::Debug { &() }\n    = note: see issue #57563 <https://github.com/rust-lang/rust/issues/57563> for more information\n    = help: add `#![feature(const_fn_trait_bound)]` to the crate attributes to enable\n \n-error[E0658]: trait bounds other than `Sized` on const fn parameters are unstable\n+error[E0658]: trait objects in const fn are unstable\n   --> $DIR/min_const_fn.rs:139:41\n    |\n LL | const fn really_no_traits_i_mean_it() { (&() as &dyn std::fmt::Debug, ()).1 }\n@@ -308,7 +308,7 @@ LL | const fn really_no_traits_i_mean_it() { (&() as &dyn std::fmt::Debug, ()).1\n    = note: see issue #57563 <https://github.com/rust-lang/rust/issues/57563> for more information\n    = help: add `#![feature(const_fn_trait_bound)]` to the crate attributes to enable\n \n-error[E0658]: trait bounds other than `Sized` on const fn parameters are unstable\n+error[E0658]: trait objects in const fn are unstable\n   --> $DIR/min_const_fn.rs:139:42\n    |\n LL | const fn really_no_traits_i_mean_it() { (&() as &dyn std::fmt::Debug, ()).1 }\n@@ -319,7 +319,7 @@ LL | const fn really_no_traits_i_mean_it() { (&() as &dyn std::fmt::Debug, ()).1\n    = note: see issue #57563 <https://github.com/rust-lang/rust/issues/57563> for more information\n    = help: add `#![feature(const_fn_trait_bound)]` to the crate attributes to enable\n \n-error[E0658]: trait bounds other than `Sized` on const fn parameters are unstable\n+error[E0658]: trait objects in const fn are unstable\n   --> $DIR/min_const_fn.rs:139:42\n    |\n LL | const fn really_no_traits_i_mean_it() { (&() as &dyn std::fmt::Debug, ()).1 }"}, {"sha": "1ab8253b414a3b7333052a6a44d3ff66fbbfceba", "filename": "src/test/ui/consts/min_const_fn/min_const_fn_dyn.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/f84000d9bc93f7c09243144d1a729448da3d714d/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_fn_dyn.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f84000d9bc93f7c09243144d1a729448da3d714d/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_fn_dyn.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_fn_dyn.rs?ref=f84000d9bc93f7c09243144d1a729448da3d714d", "patch": "@@ -7,9 +7,9 @@ struct Hide(HasDyn);\n const fn no_inner_dyn_trait(_x: Hide) {}\n const fn no_inner_dyn_trait2(x: Hide) {\n     x.0.field;\n-//~^ ERROR trait bounds other than `Sized`\n+//~^ ERROR trait objects in const fn are unstable\n }\n const fn no_inner_dyn_trait_ret() -> Hide { Hide(HasDyn { field: &0 }) }\n-//~^ ERROR trait bounds other than `Sized`\n+//~^ ERROR trait objects in const fn are unstable\n \n fn main() {}"}, {"sha": "6eec1df5aeca7ba9fb942827b42f7078ff287237", "filename": "src/test/ui/consts/min_const_fn/min_const_fn_dyn.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/f84000d9bc93f7c09243144d1a729448da3d714d/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_fn_dyn.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/f84000d9bc93f7c09243144d1a729448da3d714d/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_fn_dyn.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fmin_const_fn%2Fmin_const_fn_dyn.stderr?ref=f84000d9bc93f7c09243144d1a729448da3d714d", "patch": "@@ -1,4 +1,4 @@\n-error[E0658]: trait bounds other than `Sized` on const fn parameters are unstable\n+error[E0658]: trait objects in const fn are unstable\n   --> $DIR/min_const_fn_dyn.rs:9:5\n    |\n LL | const fn no_inner_dyn_trait2(x: Hide) {\n@@ -9,7 +9,7 @@ LL |     x.0.field;\n    = note: see issue #57563 <https://github.com/rust-lang/rust/issues/57563> for more information\n    = help: add `#![feature(const_fn_trait_bound)]` to the crate attributes to enable\n \n-error[E0658]: trait bounds other than `Sized` on const fn parameters are unstable\n+error[E0658]: trait objects in const fn are unstable\n   --> $DIR/min_const_fn_dyn.rs:12:66\n    |\n LL | const fn no_inner_dyn_trait_ret() -> Hide { Hide(HasDyn { field: &0 }) }"}]}