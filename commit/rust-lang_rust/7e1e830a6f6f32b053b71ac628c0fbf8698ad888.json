{"sha": "7e1e830a6f6f32b053b71ac628c0fbf8698ad888", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdlMWU4MzBhNmY2ZjMyYjA1M2I3MWFjNjI4YzBmYmY4Njk4YWQ4ODg=", "commit": {"author": {"name": "Niko Matsakis", "email": "niko@alum.mit.edu", "date": "2015-09-29T21:08:05Z"}, "committer": {"name": "Niko Matsakis", "email": "niko@alum.mit.edu", "date": "2015-10-05T01:19:45Z"}, "message": "change PartialEq impl for ConstVal so that two constants are `==`\nif they represent the same constant; otherwise the match algorithm\ngoes into infinite recursion when a pattern contains `NaN`", "tree": {"sha": "b058531f3e2ac045d38bf53d8d1fa021815d3ea9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b058531f3e2ac045d38bf53d8d1fa021815d3ea9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7e1e830a6f6f32b053b71ac628c0fbf8698ad888", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7e1e830a6f6f32b053b71ac628c0fbf8698ad888", "html_url": "https://github.com/rust-lang/rust/commit/7e1e830a6f6f32b053b71ac628c0fbf8698ad888", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7e1e830a6f6f32b053b71ac628c0fbf8698ad888/comments", "author": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0197f982b2c2d4dbf7d95fc28e0e47bce39ea944", "url": "https://api.github.com/repos/rust-lang/rust/commits/0197f982b2c2d4dbf7d95fc28e0e47bce39ea944", "html_url": "https://github.com/rust-lang/rust/commit/0197f982b2c2d4dbf7d95fc28e0e47bce39ea944"}], "stats": {"total": 29, "additions": 28, "deletions": 1}, "files": [{"sha": "acda0fe2f0e3532ffd25fe837616a220e6caa5d5", "filename": "src/librustc/middle/const_eval.rs", "status": "modified", "additions": 23, "deletions": 1, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/7e1e830a6f6f32b053b71ac628c0fbf8698ad888/src%2Flibrustc%2Fmiddle%2Fconst_eval.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7e1e830a6f6f32b053b71ac628c0fbf8698ad888/src%2Flibrustc%2Fmiddle%2Fconst_eval.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fconst_eval.rs?ref=7e1e830a6f6f32b053b71ac628c0fbf8698ad888", "patch": "@@ -38,6 +38,7 @@ use std::borrow::{Cow, IntoCow};\n use std::num::wrapping::OverflowingOps;\n use std::cmp::Ordering;\n use std::collections::hash_map::Entry::Vacant;\n+use std::mem::transmute;\n use std::{i8, i16, i32, i64, u8, u16, u32, u64};\n use std::rc::Rc;\n \n@@ -242,7 +243,7 @@ pub fn lookup_const_fn_by_id<'tcx>(tcx: &ty::ctxt<'tcx>, def_id: DefId)\n     }\n }\n \n-#[derive(Clone, Debug, PartialEq)]\n+#[derive(Clone, Debug)]\n pub enum ConstVal {\n     Float(f64),\n     Int(i64),\n@@ -254,6 +255,27 @@ pub enum ConstVal {\n     Tuple(ast::NodeId),\n }\n \n+/// Note that equality for `ConstVal` means that the it is the same\n+/// constant, not that the rust values are equal. In particular, `NaN\n+/// == NaN` (at least if it's the same NaN; distinct encodings for NaN\n+/// are considering unequal).\n+impl PartialEq for ConstVal {\n+    #[stable(feature = \"rust1\", since = \"1.0.0\")]\n+    fn eq(&self, other: &ConstVal) -> bool {\n+        match (self, other) {\n+            (&Float(a), &Float(b)) => unsafe{transmute::<_,u64>(a) == transmute::<_,u64>(b)},\n+            (&Int(a), &Int(b)) => a == b,\n+            (&Uint(a), &Uint(b)) => a == b,\n+            (&Str(ref a), &Str(ref b)) => a == b,\n+            (&ByteStr(ref a), &ByteStr(ref b)) => a == b,\n+            (&Bool(a), &Bool(b)) => a == b,\n+            (&Struct(a), &Struct(b)) => a == b,\n+            (&Tuple(a), &Tuple(b)) => a == b,\n+            _ => false,\n+        }\n+    }\n+}\n+\n impl ConstVal {\n     pub fn description(&self) -> &'static str {\n         match *self {"}, {"sha": "d522518a3d4afbda1b8ab9d1ef70662fd0b52dd5", "filename": "src/librustc_mir/repr.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/7e1e830a6f6f32b053b71ac628c0fbf8698ad888/src%2Flibrustc_mir%2Frepr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7e1e830a6f6f32b053b71ac628c0fbf8698ad888/src%2Flibrustc_mir%2Frepr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Frepr.rs?ref=7e1e830a6f6f32b053b71ac628c0fbf8698ad888", "patch": "@@ -642,6 +642,10 @@ impl<H:Hair> Debug for Rvalue<H> {\n \n ///////////////////////////////////////////////////////////////////////////\n // Constants\n+//\n+// Two constants are equal if they are the same constant. Note that\n+// this does not necessarily mean that they are \"==\" in Rust -- in\n+// particular one must be wary of `NaN`!\n \n #[derive(Clone, Debug, PartialEq)]\n pub struct Constant<H:Hair> {\n@@ -655,3 +659,4 @@ pub enum Literal<H:Hair> {\n     Item { def_id: H::DefId, substs: H::Substs },\n     Value { value: H::ConstVal },\n }\n+"}]}