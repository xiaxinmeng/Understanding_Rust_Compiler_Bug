{"sha": "c206d024eb31124a5d6536ce1f355c4ac0698cab", "node_id": "MDY6Q29tbWl0NzI0NzEyOmMyMDZkMDI0ZWIzMTEyNGE1ZDY1MzZjZTFmMzU1YzRhYzA2OThjYWI=", "commit": {"author": {"name": "Niko Matsakis", "email": "niko@alum.mit.edu", "date": "2012-07-10T17:37:05Z"}, "committer": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2012-07-31T22:41:26Z"}, "message": "accept naked exprs with commas in pattern arms\n\npretty printing will use them, but indentation is slightly off\nif the expr is long", "tree": {"sha": "4c44017d0ad5a6a6921ea2675058936beb72ade6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4c44017d0ad5a6a6921ea2675058936beb72ade6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c206d024eb31124a5d6536ce1f355c4ac0698cab", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c206d024eb31124a5d6536ce1f355c4ac0698cab", "html_url": "https://github.com/rust-lang/rust/commit/c206d024eb31124a5d6536ce1f355c4ac0698cab", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c206d024eb31124a5d6536ce1f355c4ac0698cab/comments", "author": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "committer": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a89ed49d3d01abbd49889832d87650b6c99ff85c", "url": "https://api.github.com/repos/rust-lang/rust/commits/a89ed49d3d01abbd49889832d87650b6c99ff85c", "html_url": "https://github.com/rust-lang/rust/commit/a89ed49d3d01abbd49889832d87650b6c99ff85c"}], "stats": {"total": 82, "additions": 76, "deletions": 6}, "files": [{"sha": "461d237450c7a018c30cb872b63114abb0650541", "filename": "src/libsyntax/ast_util.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/c206d024eb31124a5d6536ce1f355c4ac0698cab/src%2Flibsyntax%2Fast_util.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c206d024eb31124a5d6536ce1f355c4ac0698cab/src%2Flibsyntax%2Fast_util.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fast_util.rs?ref=c206d024eb31124a5d6536ce1f355c4ac0698cab", "patch": "@@ -588,6 +588,13 @@ fn view_path_id(p: @view_path) -> node_id {\n     }\n }\n \n+fn lone_block_expr(blk: blk) -> option<@ast::expr> {\n+    if blk.node.view_items.len() != 0 { ret none; }\n+    if blk.node.stmts.len() != 0 { ret none; }\n+    if blk.node.rules != default_blk { ret none; }\n+    ret blk.node.expr;\n+}\n+\n // Local Variables:\n // mode: rust\n // fill-column: 78;"}, {"sha": "df8ee01bb3b923216d80fc9613c070e65133d281", "filename": "src/libsyntax/parse/parser.rs", "status": "modified", "additions": 19, "deletions": 2, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/c206d024eb31124a5d6536ce1f355c4ac0698cab/src%2Flibsyntax%2Fparse%2Fparser.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c206d024eb31124a5d6536ce1f355c4ac0698cab/src%2Flibsyntax%2Fparse%2Fparser.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fparse%2Fparser.rs?ref=c206d024eb31124a5d6536ce1f355c4ac0698cab", "patch": "@@ -1511,8 +1511,25 @@ class parser {\n             let pats = self.parse_pats();\n             let mut guard = none;\n             if self.eat_keyword(~\"if\") { guard = some(self.parse_expr()); }\n-            if self.token == token::FAT_ARROW { self.bump(); }\n-            let blk = self.parse_block();\n+            let blk = if self.token != token::FAT_ARROW {\n+                self.parse_block()\n+            } else {\n+                self.bump();\n+                if self.token == token::LBRACE {\n+                    self.parse_block()\n+                } else {\n+                    let expr = self.parse_expr();\n+                    if self.token != token::RBRACE {\n+                        self.expect(token::COMMA);\n+                    }\n+                    {node: {view_items: ~[],\n+                            stmts: ~[],\n+                            expr: some(expr),\n+                            id: self.get_id(),\n+                            rules: default_blk},\n+                     span: expr.span}\n+                }\n+            };\n             vec::push(arms, {pats: pats, guard: guard, body: blk});\n         }\n         let mut hi = self.span.hi;"}, {"sha": "18e3b6c0790ad8b2ba44c466678ce7b77583f744", "filename": "src/libsyntax/print/pprust.rs", "status": "modified", "additions": 16, "deletions": 4, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/c206d024eb31124a5d6536ce1f355c4ac0698cab/src%2Flibsyntax%2Fprint%2Fpprust.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c206d024eb31124a5d6536ce1f355c4ac0698cab/src%2Flibsyntax%2Fprint%2Fpprust.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fprint%2Fpprust.rs?ref=c206d024eb31124a5d6536ce1f355c4ac0698cab", "patch": "@@ -6,7 +6,7 @@ import pp::{break_offset, word, printer,\n             inconsistent, eof};\n import diagnostic;\n import ast::{required, provided};\n-import ast_util::operator_prec;\n+import ast_util::{operator_prec, lone_block_expr};\n import dvec::{dvec, extensions};\n import parse::classify::*;\n import util::interner;\n@@ -1034,7 +1034,8 @@ fn print_expr(s: ps, &&expr: @ast::expr) {\n         print_maybe_parens_discrim(s, expr);\n         space(s.s);\n         bopen(s);\n-        for arms.each |arm| {\n+        let len = arms.len();\n+        for arms.eachi |i, arm| {\n             space(s.s);\n             cbox(s, alt_indent_unit);\n             ibox(s, 0u);\n@@ -1050,8 +1051,19 @@ fn print_expr(s: ps, &&expr: @ast::expr) {\n               some(e) { word_space(s, ~\"if\"); print_expr(s, e); space(s.s); }\n               none { }\n             }\n-            print_possibly_embedded_block(s, arm.body, block_normal,\n-                                          alt_indent_unit);\n+            word_space(s, ~\"=>\");\n+            alt lone_block_expr(arm.body) {\n+              some(expr) => {\n+                end(s); // close the ibox for the pattern\n+                print_expr(s, expr);\n+                if i < len - 1 { word_space(s, ~\",\"); }\n+                end(s); // close enclosing cbox\n+              }\n+              none => {\n+                print_possibly_embedded_block(s, arm.body, block_normal,\n+                                              alt_indent_unit);\n+              }\n+            }\n         }\n         bclose_(s, expr.span, alt_indent_unit);\n       }"}, {"sha": "8504a50d5a14dd2a32a319ba6bd167eeabbf08aa", "filename": "src/test/pretty/alt-naked-expr-long.rs", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/c206d024eb31124a5d6536ce1f355c4ac0698cab/src%2Ftest%2Fpretty%2Falt-naked-expr-long.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c206d024eb31124a5d6536ce1f355c4ac0698cab/src%2Ftest%2Fpretty%2Falt-naked-expr-long.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fpretty%2Falt-naked-expr-long.rs?ref=c206d024eb31124a5d6536ce1f355c4ac0698cab", "patch": "@@ -0,0 +1,17 @@\n+// pretty-exact\n+\n+// actually this doesn't quite look how I want it to, but I can't\n+// get the prettyprinter to indent the long expr\n+\n+fn main() {\n+    let x = some(3);\n+    let y =\n+        alt x {\n+          some(_) =>\n+          \"some\" + \"very\" + \"very\" + \"very\" + \"very\" + \"very\" + \"very\" +\n+              \"very\" + \"very\" + \"long\" + \"string\",\n+\n+          none => \"none\"\n+        };\n+    assert y == \"some(_)\";\n+}"}, {"sha": "70099e46806e92b3f10d92308cf2ffdc3ec5fdb4", "filename": "src/test/pretty/alt-naked-expr-medium.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/c206d024eb31124a5d6536ce1f355c4ac0698cab/src%2Ftest%2Fpretty%2Falt-naked-expr-medium.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c206d024eb31124a5d6536ce1f355c4ac0698cab/src%2Ftest%2Fpretty%2Falt-naked-expr-medium.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fpretty%2Falt-naked-expr-medium.rs?ref=c206d024eb31124a5d6536ce1f355c4ac0698cab", "patch": "@@ -0,0 +1,10 @@\n+// pretty-exact\n+\n+fn main() {\n+    let x = some(3);\n+    let _y =\n+        alt x {\n+          some(_) => ~[~\"some(_)\", ~\"not\", ~\"SO\", ~\"long\", ~\"string\"],\n+          none => ~[~\"none\"]\n+        };\n+}"}, {"sha": "54ed76054e46ca03edb236858b5ff69fe0de25d9", "filename": "src/test/pretty/alt-naked-expr.rs", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/c206d024eb31124a5d6536ce1f355c4ac0698cab/src%2Ftest%2Fpretty%2Falt-naked-expr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c206d024eb31124a5d6536ce1f355c4ac0698cab/src%2Ftest%2Fpretty%2Falt-naked-expr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fpretty%2Falt-naked-expr.rs?ref=c206d024eb31124a5d6536ce1f355c4ac0698cab", "patch": "@@ -0,0 +1,7 @@\n+// pretty-exact\n+\n+fn main() {\n+    let x = some(3);\n+    let y = alt x { some(_) => \"some(_)\",  none => \"none\" };\n+    assert y == \"some(_)\";\n+}"}]}