{"sha": "acd2be46f144e932d207680a7ab1c51b529c20e3", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFjZDJiZTQ2ZjE0NGU5MzJkMjA3NjgwYTdhYjFjNTFiNTI5YzIwZTM=", "commit": {"author": {"name": "Huon Wilson", "email": "dbau.pp+github@gmail.com", "date": "2013-12-19T02:56:53Z"}, "committer": {"name": "Huon Wilson", "email": "dbau.pp+github@gmail.com", "date": "2013-12-19T12:20:20Z"}, "message": "std::vec: use some unsafe code to optimise `remove`.\n\nAlso, add `.remove_opt` and replace `.unshift` with `.remove(0)`. The\ncode size reduction seem to compensate for not having the optimised\nspecial cases.\n\nThis makes the included benchmark more than 3 times faster.", "tree": {"sha": "6ecc18471b1d7696aa69fd73e64bdff9ac9e49e5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6ecc18471b1d7696aa69fd73e64bdff9ac9e49e5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/acd2be46f144e932d207680a7ab1c51b529c20e3", "comment_count": 5, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/acd2be46f144e932d207680a7ab1c51b529c20e3", "html_url": "https://github.com/rust-lang/rust/commit/acd2be46f144e932d207680a7ab1c51b529c20e3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/acd2be46f144e932d207680a7ab1c51b529c20e3/comments", "author": {"login": "huonw", "id": 1203825, "node_id": "MDQ6VXNlcjEyMDM4MjU=", "avatar_url": "https://avatars.githubusercontent.com/u/1203825?v=4", "gravatar_id": "", "url": "https://api.github.com/users/huonw", "html_url": "https://github.com/huonw", "followers_url": "https://api.github.com/users/huonw/followers", "following_url": "https://api.github.com/users/huonw/following{/other_user}", "gists_url": "https://api.github.com/users/huonw/gists{/gist_id}", "starred_url": "https://api.github.com/users/huonw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/huonw/subscriptions", "organizations_url": "https://api.github.com/users/huonw/orgs", "repos_url": "https://api.github.com/users/huonw/repos", "events_url": "https://api.github.com/users/huonw/events{/privacy}", "received_events_url": "https://api.github.com/users/huonw/received_events", "type": "User", "site_admin": false}, "committer": {"login": "huonw", "id": 1203825, "node_id": "MDQ6VXNlcjEyMDM4MjU=", "avatar_url": "https://avatars.githubusercontent.com/u/1203825?v=4", "gravatar_id": "", "url": "https://api.github.com/users/huonw", "html_url": "https://github.com/huonw", "followers_url": "https://api.github.com/users/huonw/followers", "following_url": "https://api.github.com/users/huonw/following{/other_user}", "gists_url": "https://api.github.com/users/huonw/gists{/gist_id}", "starred_url": "https://api.github.com/users/huonw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/huonw/subscriptions", "organizations_url": "https://api.github.com/users/huonw/orgs", "repos_url": "https://api.github.com/users/huonw/repos", "events_url": "https://api.github.com/users/huonw/events{/privacy}", "received_events_url": "https://api.github.com/users/huonw/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "81632513c13495fd269082d35916ebcd91d15658", "url": "https://api.github.com/repos/rust-lang/rust/commits/81632513c13495fd269082d35916ebcd91d15658", "html_url": "https://github.com/rust-lang/rust/commit/81632513c13495fd269082d35916ebcd91d15658"}], "stats": {"total": 113, "additions": 74, "deletions": 39}, "files": [{"sha": "a5c993483574ebff85e1fcb47058ab1fc1299c90", "filename": "src/libstd/vec.rs", "status": "modified", "additions": 74, "deletions": 39, "changes": 113, "blob_url": "https://github.com/rust-lang/rust/blob/acd2be46f144e932d207680a7ab1c51b529c20e3/src%2Flibstd%2Fvec.rs", "raw_url": "https://github.com/rust-lang/rust/raw/acd2be46f144e932d207680a7ab1c51b529c20e3/src%2Flibstd%2Fvec.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fvec.rs?ref=acd2be46f144e932d207680a7ab1c51b529c20e3", "patch": "@@ -1416,6 +1416,22 @@ pub trait OwnedVector<T> {\n     /// elements after position i one position to the right.\n     fn insert(&mut self, i: uint, x:T);\n \n+    /// Remove and return the element at position `i` within `v`,\n+    /// shifting all elements after position `i` one position to the\n+    /// left. Returns `None` if `i` is out of bounds.\n+    ///\n+    /// # Example\n+    /// ```rust\n+    /// let mut v = ~[1, 2, 3];\n+    /// assert_eq!(v.remove_opt(1), Some(2));\n+    /// assert_eq!(v, ~[1, 3]);\n+    ///\n+    /// assert_eq!(v.remove_opt(4), None);\n+    /// // v is unchanged:\n+    /// assert_eq!(v, ~[1, 3]);\n+    /// ```\n+    fn remove_opt(&mut self, i: uint) -> Option<T>;\n+\n     /// Remove and return the element at position i within v, shifting\n     /// all elements after position i one position to the left.\n     fn remove(&mut self, i: uint) -> T;\n@@ -1625,39 +1641,7 @@ impl<T> OwnedVector<T> for ~[T] {\n     }\n \n     fn shift_opt(&mut self) -> Option<T> {\n-        match self.len() {\n-            0 => None,\n-            1 => self.pop_opt(),\n-            2 => {\n-                let last = self.pop();\n-                let first = self.pop_opt();\n-                self.push(last);\n-                first\n-            }\n-            len => {\n-                unsafe {\n-                    let next_len = len - 1;\n-\n-                    let ptr = self.as_ptr();\n-\n-                    // copy out the head element, for the moment it exists\n-                    // unsafely on the stack and as the first element of the\n-                    // vector.\n-                    let head = ptr::read_ptr(ptr);\n-\n-                    // Memcpy everything to the left one element (leaving the\n-                    // last element unsafely in two consecutive memory\n-                    // locations)\n-                    ptr::copy_memory(self.as_mut_ptr(), ptr.offset(1), next_len);\n-\n-                    // set the new length, which means the second instance of\n-                    // the last element is forgotten.\n-                    self.set_len(next_len);\n-\n-                    Some(head)\n-                }\n-            }\n-        }\n+        self.remove_opt(0)\n     }\n \n     fn unshift(&mut self, x: T) {\n@@ -1683,16 +1667,33 @@ impl<T> OwnedVector<T> for ~[T] {\n         }\n     }\n \n+    #[inline]\n     fn remove(&mut self, i: uint) -> T {\n+        match self.remove_opt(i) {\n+            Some(t) => t,\n+            None => fail!(\"remove: the len is {} but the index is {}\", self.len(), i)\n+        }\n+    }\n+\n+    fn remove_opt(&mut self, i: uint) -> Option<T> {\n         let len = self.len();\n-        assert!(i < len);\n+        if i < len {\n+            unsafe { // infallible\n+                // the place we are taking from.\n+                let ptr = self.as_mut_ptr().offset(i as int);\n+                // copy it out, unsafely having a copy of the value on\n+                // the stack and in the vector at the same time.\n+                let ret = Some(ptr::read_ptr(ptr as *T));\n+\n+                // Shift everything down to fill in that spot.\n+                ptr::copy_memory(ptr, ptr.offset(1), len - i - 1);\n+                self.set_len(len - 1);\n \n-        let mut j = i;\n-        while j < len - 1 {\n-            self.swap(j, j + 1);\n-            j += 1;\n+                ret\n+            }\n+        } else {\n+            None\n         }\n-        self.pop()\n     }\n     fn swap_remove(&mut self, index: uint) -> T {\n         let ln = self.len();\n@@ -3422,6 +3423,29 @@ mod tests {\n         a.insert(4, 5);\n     }\n \n+    #[test]\n+    fn test_remove_opt() {\n+        let mut a = ~[1,2,3,4];\n+\n+        assert_eq!(a.remove_opt(2), Some(3));\n+        assert_eq!(a, ~[1,2,4]);\n+\n+        assert_eq!(a.remove_opt(2), Some(4));\n+        assert_eq!(a, ~[1,2]);\n+\n+        assert_eq!(a.remove_opt(2), None);\n+        assert_eq!(a, ~[1,2]);\n+\n+        assert_eq!(a.remove_opt(0), Some(1));\n+        assert_eq!(a, ~[2]);\n+\n+        assert_eq!(a.remove_opt(0), Some(2));\n+        assert_eq!(a, ~[]);\n+\n+        assert_eq!(a.remove_opt(0), None);\n+        assert_eq!(a.remove_opt(10), None);\n+    }\n+\n     #[test]\n     fn test_remove() {\n         let mut a = ~[1, 2, 3, 4];\n@@ -4342,4 +4366,15 @@ mod bench {\n                 }\n             })\n     }\n+    #[bench]\n+    fn random_removes(bh: &mut BenchHarness) {\n+        let mut rng = weak_rng();\n+        bh.iter(|| {\n+                let mut v = vec::from_elem(130, (0u, 0u));\n+                for _ in range(0, 100) {\n+                    let l = v.len();\n+                    v.remove(rng.gen::<uint>() % l);\n+                }\n+            })\n+    }\n }"}]}