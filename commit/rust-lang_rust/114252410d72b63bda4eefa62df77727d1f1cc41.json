{"sha": "114252410d72b63bda4eefa62df77727d1f1cc41", "node_id": "MDY6Q29tbWl0NzI0NzEyOjExNDI1MjQxMGQ3MmI2M2JkYTRlZWZhNjJkZjc3NzI3ZDFmMWNjNDE=", "commit": {"author": {"name": "sinkuu", "email": "sinkuu@sinkuu.xyz", "date": "2017-11-06T03:35:43Z"}, "committer": {"name": "Shotaro Yamada", "email": "sinkuu@sinkuu.xyz", "date": "2017-11-10T12:02:43Z"}, "message": "Separately eliminate self-assignments", "tree": {"sha": "2b1428749a73b8281597926ece9b304d1dba5ae9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2b1428749a73b8281597926ece9b304d1dba5ae9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/114252410d72b63bda4eefa62df77727d1f1cc41", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/114252410d72b63bda4eefa62df77727d1f1cc41", "html_url": "https://github.com/rust-lang/rust/commit/114252410d72b63bda4eefa62df77727d1f1cc41", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/114252410d72b63bda4eefa62df77727d1f1cc41/comments", "author": {"login": "sinkuu", "id": 7091080, "node_id": "MDQ6VXNlcjcwOTEwODA=", "avatar_url": "https://avatars.githubusercontent.com/u/7091080?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sinkuu", "html_url": "https://github.com/sinkuu", "followers_url": "https://api.github.com/users/sinkuu/followers", "following_url": "https://api.github.com/users/sinkuu/following{/other_user}", "gists_url": "https://api.github.com/users/sinkuu/gists{/gist_id}", "starred_url": "https://api.github.com/users/sinkuu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sinkuu/subscriptions", "organizations_url": "https://api.github.com/users/sinkuu/orgs", "repos_url": "https://api.github.com/users/sinkuu/repos", "events_url": "https://api.github.com/users/sinkuu/events{/privacy}", "received_events_url": "https://api.github.com/users/sinkuu/received_events", "type": "User", "site_admin": false}, "committer": {"login": "sinkuu", "id": 7091080, "node_id": "MDQ6VXNlcjcwOTEwODA=", "avatar_url": "https://avatars.githubusercontent.com/u/7091080?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sinkuu", "html_url": "https://github.com/sinkuu", "followers_url": "https://api.github.com/users/sinkuu/followers", "following_url": "https://api.github.com/users/sinkuu/following{/other_user}", "gists_url": "https://api.github.com/users/sinkuu/gists{/gist_id}", "starred_url": "https://api.github.com/users/sinkuu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sinkuu/subscriptions", "organizations_url": "https://api.github.com/users/sinkuu/orgs", "repos_url": "https://api.github.com/users/sinkuu/repos", "events_url": "https://api.github.com/users/sinkuu/events{/privacy}", "received_events_url": "https://api.github.com/users/sinkuu/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ae5553d7b04d8ece340756f378b82d5e0bbb0ea2", "url": "https://api.github.com/repos/rust-lang/rust/commits/ae5553d7b04d8ece340756f378b82d5e0bbb0ea2", "html_url": "https://github.com/rust-lang/rust/commit/ae5553d7b04d8ece340756f378b82d5e0bbb0ea2"}], "stats": {"total": 68, "additions": 62, "deletions": 6}, "files": [{"sha": "a730fc30615b46bc42489581b4d861b9e524a799", "filename": "src/librustc_mir/transform/copy_prop.rs", "status": "modified", "additions": 39, "deletions": 4, "changes": 43, "blob_url": "https://github.com/rust-lang/rust/blob/114252410d72b63bda4eefa62df77727d1f1cc41/src%2Flibrustc_mir%2Ftransform%2Fcopy_prop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/114252410d72b63bda4eefa62df77727d1f1cc41/src%2Flibrustc_mir%2Ftransform%2Fcopy_prop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fcopy_prop.rs?ref=114252410d72b63bda4eefa62df77727d1f1cc41", "patch": "@@ -69,10 +69,14 @@ impl MirPass for CopyPropagation {\n             return;\n         }\n \n+        let mut def_use_analysis = DefUseAnalysis::new(mir);\n         loop {\n-            let mut def_use_analysis = DefUseAnalysis::new(mir);\n             def_use_analysis.analyze(mir);\n \n+            if eliminate_self_assignments(mir, &def_use_analysis) {\n+                def_use_analysis.analyze(mir);\n+            }\n+\n             let mut changed = false;\n             for dest_local in mir.local_decls.indices() {\n                 debug!(\"Considering destination local: {:?}\", dest_local);\n@@ -106,9 +110,7 @@ impl MirPass for CopyPropagation {\n                             dest_local);\n                         continue;\n                     }\n-                    let dest_lvalue_def = dest_use_info.defs_and_uses.iter().filter(|lvalue_def| {\n-                        lvalue_def.context.is_mutating_use() && !lvalue_def.context.is_drop()\n-                    }).next().unwrap();\n+                    let dest_lvalue_def = dest_use_info.defs_not_including_drop().next().unwrap();\n                     location = dest_lvalue_def.location;\n \n                     let basic_block = &mir[location.block];\n@@ -158,6 +160,39 @@ impl MirPass for CopyPropagation {\n     }\n }\n \n+fn eliminate_self_assignments<'tcx>(\n+    mir: &mut Mir<'tcx>,\n+    def_use_analysis: &DefUseAnalysis<'tcx>,\n+) -> bool {\n+    let mut changed = false;\n+\n+    for dest_local in mir.local_decls.indices() {\n+        let dest_use_info = def_use_analysis.local_info(dest_local);\n+\n+        for def in dest_use_info.defs_not_including_drop() {\n+            let location = def.location;\n+            if let Some(stmt) = mir[location.block].statements.get(location.statement_index) {\n+                match stmt.kind {\n+                    StatementKind::Assign(\n+                        Lvalue::Local(local),\n+                        Rvalue::Use(Operand::Consume(Lvalue::Local(src_local))),\n+                    ) if local == dest_local && dest_local == src_local => {}\n+                    _ => {\n+                        continue;\n+                    }\n+                }\n+            } else {\n+                continue;\n+            }\n+            debug!(\"Deleting a self-assignment for {:?}\", dest_local);\n+            mir.make_statement_nop(location);\n+            changed = true;\n+        }\n+    }\n+\n+    changed\n+}\n+\n enum Action<'tcx> {\n     PropagateLocalCopy(Local),\n     PropagateConstant(Constant<'tcx>),"}, {"sha": "9ada8f2bebf706c1c56a65ff0b6e020a0eb178cc", "filename": "src/librustc_mir/util/def_use.rs", "status": "modified", "additions": 21, "deletions": 1, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/114252410d72b63bda4eefa62df77727d1f1cc41/src%2Flibrustc_mir%2Futil%2Fdef_use.rs", "raw_url": "https://github.com/rust-lang/rust/raw/114252410d72b63bda4eefa62df77727d1f1cc41/src%2Flibrustc_mir%2Futil%2Fdef_use.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Futil%2Fdef_use.rs?ref=114252410d72b63bda4eefa62df77727d1f1cc41", "patch": "@@ -15,6 +15,8 @@ use rustc::mir::visit::{LvalueContext, MutVisitor, Visitor};\n use rustc_data_structures::indexed_vec::IndexVec;\n use std::marker::PhantomData;\n use std::mem;\n+use std::slice;\n+use std::iter;\n \n pub struct DefUseAnalysis<'tcx> {\n     info: IndexVec<Local, Info<'tcx>>,\n@@ -39,13 +41,21 @@ impl<'tcx> DefUseAnalysis<'tcx> {\n     }\n \n     pub fn analyze(&mut self, mir: &Mir<'tcx>) {\n+        self.clear();\n+\n         let mut finder = DefUseFinder {\n             info: mem::replace(&mut self.info, IndexVec::new()),\n         };\n         finder.visit_mir(mir);\n         self.info = finder.info\n     }\n \n+    fn clear(&mut self) {\n+        for info in &mut self.info {\n+            info.clear();\n+        }\n+    }\n+\n     pub fn local_info(&self, local: Local) -> &Info<'tcx> {\n         &self.info[local]\n     }\n@@ -93,14 +103,24 @@ impl<'tcx> Info<'tcx> {\n         }\n     }\n \n+    fn clear(&mut self) {\n+        self.defs_and_uses.clear();\n+    }\n+\n     pub fn def_count(&self) -> usize {\n         self.defs_and_uses.iter().filter(|lvalue_use| lvalue_use.context.is_mutating_use()).count()\n     }\n \n     pub fn def_count_not_including_drop(&self) -> usize {\n+        self.defs_not_including_drop().count()\n+    }\n+\n+    pub fn defs_not_including_drop(\n+        &self,\n+    ) -> iter::Filter<slice::Iter<Use<'tcx>>, fn(&&Use<'tcx>) -> bool> {\n         self.defs_and_uses.iter().filter(|lvalue_use| {\n             lvalue_use.context.is_mutating_use() && !lvalue_use.context.is_drop()\n-        }).count()\n+        })\n     }\n \n     pub fn use_count(&self) -> usize {"}, {"sha": "ae30b5fae88f8178ca37e51cb503810f8c6fc19f", "filename": "src/test/mir-opt/copy_propagation_arg.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/114252410d72b63bda4eefa62df77727d1f1cc41/src%2Ftest%2Fmir-opt%2Fcopy_propagation_arg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/114252410d72b63bda4eefa62df77727d1f1cc41/src%2Ftest%2Fmir-opt%2Fcopy_propagation_arg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fcopy_propagation_arg.rs?ref=114252410d72b63bda4eefa62df77727d1f1cc41", "patch": "@@ -34,6 +34,7 @@ fn main() {\n     // Make sure the function actually gets instantiated.\n     foo(0);\n     bar(0);\n+    baz(0);\n }\n \n // END RUST SOURCE\n@@ -112,4 +113,4 @@ fn main() {\n //     _0 = ();\n //     return;\n // }\n-// END rustc.baz.CopyPropagation.after.mir\n\\ No newline at end of file\n+// END rustc.baz.CopyPropagation.after.mir"}]}