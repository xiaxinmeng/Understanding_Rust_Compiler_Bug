{"sha": "bf918046fab665ba4d35db151224f514d41abbb0", "node_id": "MDY6Q29tbWl0NzI0NzEyOmJmOTE4MDQ2ZmFiNjY1YmE0ZDM1ZGIxNTEyMjRmNTE0ZDQxYWJiYjA=", "commit": {"author": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2021-08-14T16:18:18Z"}, "committer": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2021-08-14T16:18:32Z"}, "message": "Only complete type annotations for patterns in function params", "tree": {"sha": "b4b3e01b69243eedb47c44c5d03721f64e930401", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b4b3e01b69243eedb47c44c5d03721f64e930401"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bf918046fab665ba4d35db151224f514d41abbb0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bf918046fab665ba4d35db151224f514d41abbb0", "html_url": "https://github.com/rust-lang/rust/commit/bf918046fab665ba4d35db151224f514d41abbb0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bf918046fab665ba4d35db151224f514d41abbb0/comments", "author": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d07f4e4c35efa6bfa9fb354f1964d81b690ef8e3", "url": "https://api.github.com/repos/rust-lang/rust/commits/d07f4e4c35efa6bfa9fb354f1964d81b690ef8e3", "html_url": "https://github.com/rust-lang/rust/commit/d07f4e4c35efa6bfa9fb354f1964d81b690ef8e3"}], "stats": {"total": 86, "additions": 67, "deletions": 19}, "files": [{"sha": "1488436df3521941fc6cc1ca60fa2057dac4479d", "filename": "crates/ide_completion/src/completions/fn_param.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/bf918046fab665ba4d35db151224f514d41abbb0/crates%2Fide_completion%2Fsrc%2Fcompletions%2Ffn_param.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bf918046fab665ba4d35db151224f514d41abbb0/crates%2Fide_completion%2Fsrc%2Fcompletions%2Ffn_param.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Fcompletions%2Ffn_param.rs?ref=bf918046fab665ba4d35db151224f514d41abbb0", "patch": "@@ -6,14 +6,17 @@ use syntax::{\n     match_ast, AstNode,\n };\n \n-use crate::{CompletionContext, CompletionItem, CompletionItemKind, CompletionKind, Completions};\n+use crate::{\n+    context::ParamKind, CompletionContext, CompletionItem, CompletionItemKind, CompletionKind,\n+    Completions,\n+};\n \n /// Complete repeated parameters, both name and type. For example, if all\n /// functions in a file have a `spam: &mut Spam` parameter, a completion with\n /// `spam: &mut Spam` insert text/label and `spam` lookup string will be\n /// suggested.\n pub(crate) fn complete_fn_param(acc: &mut Completions, ctx: &CompletionContext) -> Option<()> {\n-    if !ctx.is_param {\n+    if ctx.is_param != Some(ParamKind::Function) {\n         return None;\n     }\n "}, {"sha": "f4637c401be8f9ca05331d2ab964691ac6663a7d", "filename": "crates/ide_completion/src/context.rs", "status": "modified", "additions": 19, "deletions": 10, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/bf918046fab665ba4d35db151224f514d41abbb0/crates%2Fide_completion%2Fsrc%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bf918046fab665ba4d35db151224f514d41abbb0/crates%2Fide_completion%2Fsrc%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Fcontext.rs?ref=bf918046fab665ba4d35db151224f514d41abbb0", "patch": "@@ -60,6 +60,12 @@ pub(crate) enum CallKind {\n     Mac,\n     Expr,\n }\n+\n+#[derive(Copy, Clone, Debug, PartialEq, Eq)]\n+pub(crate) enum ParamKind {\n+    Function,\n+    Closure,\n+}\n /// `CompletionContext` is created early during completion to figure out, where\n /// exactly is the cursor, syntax-wise.\n #[derive(Debug)]\n@@ -91,7 +97,7 @@ pub(crate) struct CompletionContext<'a> {\n \n     // potentially set if we are completing a name\n     pub(super) is_pat_or_const: Option<PatternRefutability>,\n-    pub(super) is_param: bool,\n+    pub(super) is_param: Option<ParamKind>,\n \n     pub(super) completion_location: Option<ImmediateLocation>,\n     pub(super) prev_sibling: Option<ImmediatePrevSibling>,\n@@ -158,7 +164,7 @@ impl<'a> CompletionContext<'a> {\n             lifetime_allowed: false,\n             is_label_ref: false,\n             is_pat_or_const: None,\n-            is_param: false,\n+            is_param: None,\n             completion_location: None,\n             prev_sibling: None,\n             attribute_under_caret: None,\n@@ -670,7 +676,17 @@ impl<'a> CompletionContext<'a> {\n             self.fill_impl_def();\n         }\n \n-        self.is_param |= is_node::<ast::Param>(name.syntax());\n+        if let Some(param) = name\n+            .syntax()\n+            .ancestors()\n+            .find_map(ast::Param::cast)\n+            .filter(|it| it.syntax().text_range() == name.syntax().text_range())\n+        {\n+            let is_closure_param =\n+                param.syntax().ancestors().nth(2).and_then(ast::ClosureExpr::cast).is_some();\n+            self.is_param =\n+                Some(if is_closure_param { ParamKind::Closure } else { ParamKind::Function });\n+        }\n     }\n \n     fn classify_name_ref(&mut self, original_file: &SyntaxNode, name_ref: ast::NameRef) {\n@@ -774,13 +790,6 @@ fn find_node_with_range<N: AstNode>(syntax: &SyntaxNode, range: TextRange) -> Op\n     syntax.covering_element(range).ancestors().find_map(N::cast)\n }\n \n-fn is_node<N: AstNode>(node: &SyntaxNode) -> bool {\n-    match node.ancestors().find_map(N::cast) {\n-        None => false,\n-        Some(n) => n.syntax().text_range() == node.text_range(),\n-    }\n-}\n-\n fn path_or_use_tree_qualifier(path: &ast::Path) -> Option<(ast::Path, bool)> {\n     if let Some(qual) = path.qualifier() {\n         return Some((qual, false));"}, {"sha": "67961a602f961ad9dd64f4caed095c85ad2b4ea5", "filename": "crates/ide_completion/src/render/pattern.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/bf918046fab665ba4d35db151224f514d41abbb0/crates%2Fide_completion%2Fsrc%2Frender%2Fpattern.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bf918046fab665ba4d35db151224f514d41abbb0/crates%2Fide_completion%2Fsrc%2Frender%2Fpattern.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Frender%2Fpattern.rs?ref=bf918046fab665ba4d35db151224f514d41abbb0", "patch": "@@ -4,7 +4,10 @@ use hir::{db::HirDatabase, HasAttrs, HasVisibility, Name, StructKind};\n use ide_db::helpers::SnippetCap;\n use itertools::Itertools;\n \n-use crate::{item::CompletionKind, render::RenderContext, CompletionItem, CompletionItemKind};\n+use crate::{\n+    context::ParamKind, item::CompletionKind, render::RenderContext, CompletionItem,\n+    CompletionItemKind,\n+};\n \n pub(crate) fn render_struct_pat(\n     ctx: RenderContext<'_>,\n@@ -83,7 +86,7 @@ fn render_pat(\n         _ => return None,\n     };\n \n-    if ctx.completion.is_param {\n+    if ctx.completion.is_param == Some(ParamKind::Function) {\n         pat.push(':');\n         pat.push(' ');\n         pat.push_str(name);"}, {"sha": "68871a46716b3ab0d9af3ffccecf4c4f7afe0bd8", "filename": "crates/ide_completion/src/render/struct_literal.rs", "status": "modified", "additions": 0, "deletions": 5, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/bf918046fab665ba4d35db151224f514d41abbb0/crates%2Fide_completion%2Fsrc%2Frender%2Fstruct_literal.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bf918046fab665ba4d35db151224f514d41abbb0/crates%2Fide_completion%2Fsrc%2Frender%2Fstruct_literal.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Frender%2Fstruct_literal.rs?ref=bf918046fab665ba4d35db151224f514d41abbb0", "patch": "@@ -58,11 +58,6 @@ fn render_literal(\n         _ => return None,\n     };\n \n-    if ctx.completion.is_param {\n-        literal.push(':');\n-        literal.push(' ');\n-        literal.push_str(name);\n-    }\n     if ctx.snippet_cap().is_some() {\n         literal.push_str(\"$0\");\n     }"}, {"sha": "3e10575b19e00fc10a990ea84877148db2110563", "filename": "crates/ide_completion/src/tests/pattern.rs", "status": "modified", "additions": 38, "deletions": 0, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/bf918046fab665ba4d35db151224f514d41abbb0/crates%2Fide_completion%2Fsrc%2Ftests%2Fpattern.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bf918046fab665ba4d35db151224f514d41abbb0/crates%2Fide_completion%2Fsrc%2Ftests%2Fpattern.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Ftests%2Fpattern.rs?ref=bf918046fab665ba4d35db151224f514d41abbb0", "patch": "@@ -309,3 +309,41 @@ fn outer(Foo { bar$0 }: Foo) {}\n         expect![[r#\"\"#]],\n     )\n }\n+\n+#[test]\n+fn completes_in_fn_param() {\n+    check_empty(\n+        r#\"\n+struct Foo { bar: Bar }\n+struct Bar(u32);\n+fn foo($0) {}\n+\"#,\n+        expect![[r#\"\n+            kw mut\n+            bn Foo Foo { bar$1 }: Foo$0\n+            st Foo\n+            bn Bar Bar($1): Bar$0\n+            st Bar\n+        \"#]],\n+    )\n+}\n+\n+#[test]\n+fn completes_in_closure_param() {\n+    check_empty(\n+        r#\"\n+struct Foo { bar: Bar }\n+struct Bar(u32);\n+fn foo() {\n+    |$0| {};\n+}\n+\"#,\n+        expect![[r#\"\n+            kw mut\n+            bn Foo Foo { bar$1 }$0\n+            st Foo\n+            bn Bar Bar($1)$0\n+            st Bar\n+        \"#]],\n+    )\n+}"}]}