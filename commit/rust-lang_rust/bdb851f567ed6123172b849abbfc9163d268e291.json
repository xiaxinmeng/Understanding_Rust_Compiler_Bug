{"sha": "bdb851f567ed6123172b849abbfc9163d268e291", "node_id": "C_kwDOAAsO6NoAKGJkYjg1MWY1NjdlZDYxMjMxNzJiODQ5YWJiZmM5MTYzZDI2OGUyOTE", "commit": {"author": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2021-10-17T16:32:34Z"}, "committer": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2021-12-04T10:51:16Z"}, "message": "ast: Avoid aborts on fatal errors thrown from mutable AST visitor\n\nSet the node to some dummy value and rethwor the error instead.", "tree": {"sha": "865cd6bcd5a02ebadead6da0bcf3d5b13af830de", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/865cd6bcd5a02ebadead6da0bcf3d5b13af830de"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bdb851f567ed6123172b849abbfc9163d268e291", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bdb851f567ed6123172b849abbfc9163d268e291", "html_url": "https://github.com/rust-lang/rust/commit/bdb851f567ed6123172b849abbfc9163d268e291", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bdb851f567ed6123172b849abbfc9163d268e291/comments", "author": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "committer": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "887999d163bace7e79370b952bdd1f930ff4cdd5", "url": "https://api.github.com/repos/rust-lang/rust/commits/887999d163bace7e79370b952bdd1f930ff4cdd5", "html_url": "https://github.com/rust-lang/rust/commit/887999d163bace7e79370b952bdd1f930ff4cdd5"}], "stats": {"total": 148, "additions": 127, "deletions": 21}, "files": [{"sha": "7fd9d5b20b1c45d66147783b2ca93225eab98abc", "filename": "compiler/rustc_ast/src/mut_visit.rs", "status": "modified", "additions": 116, "deletions": 12, "changes": 128, "blob_url": "https://github.com/rust-lang/rust/blob/bdb851f567ed6123172b849abbfc9163d268e291/compiler%2Frustc_ast%2Fsrc%2Fmut_visit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bdb851f567ed6123172b849abbfc9163d268e291/compiler%2Frustc_ast%2Fsrc%2Fmut_visit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast%2Fsrc%2Fmut_visit.rs?ref=bdb851f567ed6123172b849abbfc9163d268e291", "patch": "@@ -14,13 +14,14 @@ use crate::tokenstream::*;\n \n use rustc_data_structures::map_in_place::MapInPlace;\n use rustc_data_structures::sync::Lrc;\n+use rustc_data_structures::thin_vec::ThinVec;\n use rustc_span::source_map::Spanned;\n use rustc_span::symbol::Ident;\n use rustc_span::Span;\n \n use smallvec::{smallvec, Array, SmallVec};\n use std::ops::DerefMut;\n-use std::{panic, process, ptr};\n+use std::{panic, ptr};\n \n pub trait ExpectOne<A: Array> {\n     fn expect_one(self, err: &'static str) -> A::Item;\n@@ -283,23 +284,21 @@ pub trait MutVisitor: Sized {\n \n /// Use a map-style function (`FnOnce(T) -> T`) to overwrite a `&mut T`. Useful\n /// when using a `flat_map_*` or `filter_map_*` method within a `visit_`\n-/// method. Abort the program if the closure panics.\n-///\n-/// FIXME: Abort on panic means that any fatal error inside `visit_clobber` will abort the compiler.\n-/// Instead of aborting on catching a panic we need to reset the visited node to some valid but\n-/// possibly meaningless value and rethrow the panic.\n+/// method.\n //\n // No `noop_` prefix because there isn't a corresponding method in `MutVisitor`.\n-pub fn visit_clobber<T, F>(t: &mut T, f: F)\n-where\n-    F: FnOnce(T) -> T,\n-{\n+pub fn visit_clobber<T: DummyAstNode>(t: &mut T, f: impl FnOnce(T) -> T) {\n     unsafe {\n         // Safe because `t` is used in a read-only fashion by `read()` before\n         // being overwritten by `write()`.\n         let old_t = ptr::read(t);\n-        let new_t = panic::catch_unwind(panic::AssertUnwindSafe(|| f(old_t)))\n-            .unwrap_or_else(|_| process::abort());\n+        let new_t =\n+            panic::catch_unwind(panic::AssertUnwindSafe(|| f(old_t))).unwrap_or_else(|err| {\n+                // Set `t` to some valid but possible meaningless value,\n+                // and pass the fatal error further.\n+                ptr::write(t, T::dummy());\n+                panic::resume_unwind(err);\n+            });\n         ptr::write(t, new_t);\n     }\n }\n@@ -1454,3 +1453,108 @@ pub fn noop_visit_vis<T: MutVisitor>(visibility: &mut Visibility, vis: &mut T) {\n     }\n     vis.visit_span(&mut visibility.span);\n }\n+\n+/// Some value for the AST node that is valid but possibly meaningless.\n+pub trait DummyAstNode {\n+    fn dummy() -> Self;\n+}\n+\n+impl<T> DummyAstNode for Option<T> {\n+    fn dummy() -> Self {\n+        Default::default()\n+    }\n+}\n+\n+impl<T: DummyAstNode + 'static> DummyAstNode for P<T> {\n+    fn dummy() -> Self {\n+        P(DummyAstNode::dummy())\n+    }\n+}\n+\n+impl<T> DummyAstNode for ThinVec<T> {\n+    fn dummy() -> Self {\n+        Default::default()\n+    }\n+}\n+\n+impl DummyAstNode for Item {\n+    fn dummy() -> Self {\n+        Item {\n+            attrs: Default::default(),\n+            id: DUMMY_NODE_ID,\n+            span: Default::default(),\n+            vis: Visibility {\n+                kind: VisibilityKind::Public,\n+                span: Default::default(),\n+                tokens: Default::default(),\n+            },\n+            ident: Ident::empty(),\n+            kind: ItemKind::ExternCrate(None),\n+            tokens: Default::default(),\n+        }\n+    }\n+}\n+\n+impl DummyAstNode for Expr {\n+    fn dummy() -> Self {\n+        Expr {\n+            id: DUMMY_NODE_ID,\n+            kind: ExprKind::Err,\n+            span: Default::default(),\n+            attrs: Default::default(),\n+            tokens: Default::default(),\n+        }\n+    }\n+}\n+\n+impl DummyAstNode for Ty {\n+    fn dummy() -> Self {\n+        Ty {\n+            id: DUMMY_NODE_ID,\n+            kind: TyKind::Err,\n+            span: Default::default(),\n+            tokens: Default::default(),\n+        }\n+    }\n+}\n+\n+impl DummyAstNode for Pat {\n+    fn dummy() -> Self {\n+        Pat {\n+            id: DUMMY_NODE_ID,\n+            kind: PatKind::Wild,\n+            span: Default::default(),\n+            tokens: Default::default(),\n+        }\n+    }\n+}\n+\n+impl DummyAstNode for Stmt {\n+    fn dummy() -> Self {\n+        Stmt { id: DUMMY_NODE_ID, kind: StmtKind::Empty, span: Default::default() }\n+    }\n+}\n+\n+impl DummyAstNode for Block {\n+    fn dummy() -> Self {\n+        Block {\n+            stmts: Default::default(),\n+            id: DUMMY_NODE_ID,\n+            rules: BlockCheckMode::Default,\n+            span: Default::default(),\n+            tokens: Default::default(),\n+            could_be_bare_literal: Default::default(),\n+        }\n+    }\n+}\n+\n+impl DummyAstNode for Crate {\n+    fn dummy() -> Self {\n+        Crate {\n+            attrs: Default::default(),\n+            items: Default::default(),\n+            span: Default::default(),\n+            is_placeholder: Default::default(),\n+        }\n+    }\n+}"}, {"sha": "f216a66148703d0fee859d4dd7d08b7cb25403dc", "filename": "compiler/rustc_expand/src/expand.rs", "status": "modified", "additions": 11, "deletions": 9, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/bdb851f567ed6123172b849abbfc9163d268e291/compiler%2Frustc_expand%2Fsrc%2Fexpand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bdb851f567ed6123172b849abbfc9163d268e291/compiler%2Frustc_expand%2Fsrc%2Fexpand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_expand%2Fsrc%2Fexpand.rs?ref=bdb851f567ed6123172b849abbfc9163d268e291", "patch": "@@ -1160,13 +1160,18 @@ macro_rules! assign_id {\n \n impl<'a, 'b> MutVisitor for InvocationCollector<'a, 'b> {\n     fn visit_crate(&mut self, krate: &mut ast::Crate) {\n-        let span = krate.span;\n-        let empty_crate =\n-            || ast::Crate { attrs: Vec::new(), items: Vec::new(), span, is_placeholder: None };\n-        let mut fold_crate = |krate: ast::Crate| {\n+        visit_clobber(krate, |krate| {\n+            let span = krate.span;\n             let mut krate = match self.configure(krate) {\n                 Some(krate) => krate,\n-                None => return empty_crate(),\n+                None => {\n+                    return ast::Crate {\n+                        attrs: Vec::new(),\n+                        items: Vec::new(),\n+                        span,\n+                        is_placeholder: None,\n+                    };\n+                }\n             };\n \n             if let Some(attr) = self.take_first_attr(&mut krate) {\n@@ -1177,10 +1182,7 @@ impl<'a, 'b> MutVisitor for InvocationCollector<'a, 'b> {\n \n             noop_visit_crate(&mut krate, self);\n             krate\n-        };\n-\n-        // Cannot use `visit_clobber` here, see the FIXME on it.\n-        *krate = fold_crate(mem::replace(krate, empty_crate()));\n+        })\n     }\n \n     fn visit_expr(&mut self, expr: &mut P<ast::Expr>) {"}]}