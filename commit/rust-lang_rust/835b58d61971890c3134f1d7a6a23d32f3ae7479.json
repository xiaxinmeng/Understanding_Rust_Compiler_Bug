{"sha": "835b58d61971890c3134f1d7a6a23d32f3ae7479", "node_id": "C_kwDOAAsO6NoAKDgzNWI1OGQ2MTk3MTg5MGMzMTM0ZjFkN2E2YTIzZDMyZjNhZTc0Nzk", "commit": {"author": {"name": "R\u00e9my Rakic", "email": "remy.rakic+github@gmail.com", "date": "2022-11-23T18:08:15Z"}, "committer": {"name": "R\u00e9my Rakic", "email": "remy.rakic+github@gmail.com", "date": "2023-01-03T20:06:45Z"}, "message": "make the `native::LLD` step able to use an already built lld\n\nMakes the lld step avoid building it from source when possible: when\ndist has packaged it along the other LLVM binaries for the rust-dev\ncomponent.", "tree": {"sha": "b370bf4115456431c9f2eabdb31d496dd4e76dcd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b370bf4115456431c9f2eabdb31d496dd4e76dcd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/835b58d61971890c3134f1d7a6a23d32f3ae7479", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/835b58d61971890c3134f1d7a6a23d32f3ae7479", "html_url": "https://github.com/rust-lang/rust/commit/835b58d61971890c3134f1d7a6a23d32f3ae7479", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/835b58d61971890c3134f1d7a6a23d32f3ae7479/comments", "author": {"login": "lqd", "id": 247183, "node_id": "MDQ6VXNlcjI0NzE4Mw==", "avatar_url": "https://avatars.githubusercontent.com/u/247183?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lqd", "html_url": "https://github.com/lqd", "followers_url": "https://api.github.com/users/lqd/followers", "following_url": "https://api.github.com/users/lqd/following{/other_user}", "gists_url": "https://api.github.com/users/lqd/gists{/gist_id}", "starred_url": "https://api.github.com/users/lqd/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lqd/subscriptions", "organizations_url": "https://api.github.com/users/lqd/orgs", "repos_url": "https://api.github.com/users/lqd/repos", "events_url": "https://api.github.com/users/lqd/events{/privacy}", "received_events_url": "https://api.github.com/users/lqd/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lqd", "id": 247183, "node_id": "MDQ6VXNlcjI0NzE4Mw==", "avatar_url": "https://avatars.githubusercontent.com/u/247183?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lqd", "html_url": "https://github.com/lqd", "followers_url": "https://api.github.com/users/lqd/followers", "following_url": "https://api.github.com/users/lqd/following{/other_user}", "gists_url": "https://api.github.com/users/lqd/gists{/gist_id}", "starred_url": "https://api.github.com/users/lqd/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lqd/subscriptions", "organizations_url": "https://api.github.com/users/lqd/orgs", "repos_url": "https://api.github.com/users/lqd/repos", "events_url": "https://api.github.com/users/lqd/events{/privacy}", "received_events_url": "https://api.github.com/users/lqd/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6eb205d591863f03e661f79ea3cb993f69eff844", "url": "https://api.github.com/repos/rust-lang/rust/commits/6eb205d591863f03e661f79ea3cb993f69eff844", "html_url": "https://github.com/rust-lang/rust/commit/6eb205d591863f03e661f79ea3cb993f69eff844"}], "stats": {"total": 14, "additions": 14, "deletions": 0}, "files": [{"sha": "0f92c81e4d9702af81daaf0e63278107fb5e6056", "filename": "src/bootstrap/native.rs", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/835b58d61971890c3134f1d7a6a23d32f3ae7479/src%2Fbootstrap%2Fnative.rs", "raw_url": "https://github.com/rust-lang/rust/raw/835b58d61971890c3134f1d7a6a23d32f3ae7479/src%2Fbootstrap%2Fnative.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fnative.rs?ref=835b58d61971890c3134f1d7a6a23d32f3ae7479", "patch": "@@ -826,6 +826,20 @@ impl Step for Lld {\n         let LlvmResult { llvm_config, llvm_cmake_dir } =\n             builder.ensure(Llvm { target: self.target });\n \n+        // The `dist` step packages LLD next to LLVM's binaries for download-ci-llvm. The root path\n+        // we usually expect here is `./build/$triple/ci-llvm/`, with the binaries in its `bin`\n+        // subfolder. We check if that's the case, and if LLD's binary already exists there next to\n+        // `llvm-config`: if so, we can use it instead of building LLVM/LLD from source.\n+        let ci_llvm_bin = llvm_config.parent().unwrap();\n+        if ci_llvm_bin.is_dir() && ci_llvm_bin.file_name().unwrap() == \"bin\" {\n+            let lld_path = ci_llvm_bin.join(exe(\"lld\", target));\n+            if lld_path.exists() {\n+                // The following steps copying `lld` as `rust-lld` to the sysroot, expect it in the\n+                // `bin` subfolder of this step's out dir.\n+                return ci_llvm_bin.parent().unwrap().to_path_buf();\n+            }\n+        }\n+\n         let out_dir = builder.lld_out(target);\n         let done_stamp = out_dir.join(\"lld-finished-building\");\n         if done_stamp.exists() {"}]}