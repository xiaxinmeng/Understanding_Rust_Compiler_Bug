{"sha": "b03d414e3c222a7f29259526fcdf95189e61fd0c", "node_id": "MDY6Q29tbWl0NzI0NzEyOmIwM2Q0MTRlM2MyMjJhN2YyOTI1OTUyNmZjZGY5NTE4OWU2MWZkMGM=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2019-01-14T19:31:58Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-01-14T19:31:58Z"}, "message": "Rollup merge of #57585 - estebank:trailing-semicolon, r=petrochenkov\n\nRecover from item trailing semicolon\n\nCC https://github.com/rust-lang/rfcs/pull/2479\n\nr? @petrochenkov", "tree": {"sha": "be340379624ea08f4c91342ba54a420889cd4cba", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/be340379624ea08f4c91342ba54a420889cd4cba"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b03d414e3c222a7f29259526fcdf95189e61fd0c", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJcPOOuCRBK7hj4Ov3rIwAAdHIIAIWW3GGgXvjE2cXXdkGANLAF\n3jD497O/ewPOwEgyXxSFA8mjcbWGOlSjiJZcgpFQZfyblsKJJKvR+qmpbcPIvRDM\nkjBP4HkpEWMcSNq5W+3eyFY6nnG2VTrDqLdZBI5e9+0Xin6A06LQb00qvr6Jppxn\nSCz76gUEJMLcQ/34R4MuMt6hakVJI8vAzEKZ+gcOVG6LplyHNkWNhxr6OoDEAk+J\nhzFx4GA68sdfNo8bJk5/T3dJOGhTnvWqoVCrF3z47TlNrurwog6FqhHFwGNfgPZ5\nn1BLgLs3FFznBGAwDd98Ccq6fMZq9WkSFR26+O8IRBOleT3IRSiV0d/tS4IBSEA=\n=+VAP\n-----END PGP SIGNATURE-----\n", "payload": "tree be340379624ea08f4c91342ba54a420889cd4cba\nparent feb48f334d29a22f2e3ae3b322af081b42fafc60\nparent 3874c7755f292abc87fa2ce4fe82479ad063367e\nauthor Mazdak Farrokhzad <twingoow@gmail.com> 1547494318 +0100\ncommitter GitHub <noreply@github.com> 1547494318 +0100\n\nRollup merge of #57585 - estebank:trailing-semicolon, r=petrochenkov\n\nRecover from item trailing semicolon\n\nCC https://github.com/rust-lang/rfcs/pull/2479\n\nr? @petrochenkov\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b03d414e3c222a7f29259526fcdf95189e61fd0c", "html_url": "https://github.com/rust-lang/rust/commit/b03d414e3c222a7f29259526fcdf95189e61fd0c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b03d414e3c222a7f29259526fcdf95189e61fd0c/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "feb48f334d29a22f2e3ae3b322af081b42fafc60", "url": "https://api.github.com/repos/rust-lang/rust/commits/feb48f334d29a22f2e3ae3b322af081b42fafc60", "html_url": "https://github.com/rust-lang/rust/commit/feb48f334d29a22f2e3ae3b322af081b42fafc60"}, {"sha": "3874c7755f292abc87fa2ce4fe82479ad063367e", "url": "https://api.github.com/repos/rust-lang/rust/commits/3874c7755f292abc87fa2ce4fe82479ad063367e", "html_url": "https://github.com/rust-lang/rust/commit/3874c7755f292abc87fa2ce4fe82479ad063367e"}], "stats": {"total": 143, "additions": 113, "deletions": 30}, "files": [{"sha": "823c786bded2677964a6719c1d9b53c4741d6736", "filename": "src/libsyntax/parse/parser.rs", "status": "modified", "additions": 35, "deletions": 24, "changes": 59, "blob_url": "https://github.com/rust-lang/rust/blob/b03d414e3c222a7f29259526fcdf95189e61fd0c/src%2Flibsyntax%2Fparse%2Fparser.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b03d414e3c222a7f29259526fcdf95189e61fd0c/src%2Flibsyntax%2Fparse%2Fparser.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fparse%2Fparser.rs?ref=b03d414e3c222a7f29259526fcdf95189e61fd0c", "patch": "@@ -6482,41 +6482,52 @@ impl<'a> Parser<'a> {\n         }\n     }\n \n+    fn maybe_consume_incorrect_semicolon(&mut self, items: &[P<Item>]) -> bool {\n+        if self.eat(&token::Semi) {\n+            let mut err = self.struct_span_err(self.prev_span, \"expected item, found `;`\");\n+            err.span_suggestion_short_with_applicability(\n+                self.prev_span,\n+                \"remove this semicolon\",\n+                String::new(),\n+                Applicability::MachineApplicable,\n+            );\n+            if !items.is_empty() {\n+                let previous_item = &items[items.len()-1];\n+                let previous_item_kind_name = match previous_item.node {\n+                    // say \"braced struct\" because tuple-structs and\n+                    // braceless-empty-struct declarations do take a semicolon\n+                    ItemKind::Struct(..) => Some(\"braced struct\"),\n+                    ItemKind::Enum(..) => Some(\"enum\"),\n+                    ItemKind::Trait(..) => Some(\"trait\"),\n+                    ItemKind::Union(..) => Some(\"union\"),\n+                    _ => None,\n+                };\n+                if let Some(name) = previous_item_kind_name {\n+                    err.help(&format!(\"{} declarations are not followed by a semicolon\", name));\n+                }\n+            }\n+            err.emit();\n+            true\n+        } else {\n+            false\n+        }\n+    }\n+\n     /// Given a termination token, parse all of the items in a module\n     fn parse_mod_items(&mut self, term: &token::Token, inner_lo: Span) -> PResult<'a, Mod> {\n         let mut items = vec![];\n         while let Some(item) = self.parse_item()? {\n             items.push(item);\n+            self.maybe_consume_incorrect_semicolon(&items);\n         }\n \n         if !self.eat(term) {\n             let token_str = self.this_token_descr();\n-            let mut err = self.fatal(&format!(\"expected item, found {}\", token_str));\n-            if self.token == token::Semi {\n-                let msg = \"consider removing this semicolon\";\n-                err.span_suggestion_short_with_applicability(\n-                    self.span, msg, String::new(), Applicability::MachineApplicable\n-                );\n-                if !items.is_empty() {  // Issue #51603\n-                    let previous_item = &items[items.len()-1];\n-                    let previous_item_kind_name = match previous_item.node {\n-                        // say \"braced struct\" because tuple-structs and\n-                        // braceless-empty-struct declarations do take a semicolon\n-                        ItemKind::Struct(..) => Some(\"braced struct\"),\n-                        ItemKind::Enum(..) => Some(\"enum\"),\n-                        ItemKind::Trait(..) => Some(\"trait\"),\n-                        ItemKind::Union(..) => Some(\"union\"),\n-                        _ => None,\n-                    };\n-                    if let Some(name) = previous_item_kind_name {\n-                        err.help(&format!(\"{} declarations are not followed by a semicolon\",\n-                                          name));\n-                    }\n-                }\n-            } else {\n+            if !self.maybe_consume_incorrect_semicolon(&items) {\n+                let mut err = self.fatal(&format!(\"expected item, found {}\", token_str));\n                 err.span_label(self.span, \"expected item\");\n+                return Err(err);\n             }\n-            return Err(err);\n         }\n \n         let hi = if self.span.is_dummy() {"}, {"sha": "9dfd61fdf3f20516ee339a95e0d3a40d4a779bfd", "filename": "src/test/ui/issues/issue-46186.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/b03d414e3c222a7f29259526fcdf95189e61fd0c/src%2Ftest%2Fui%2Fissues%2Fissue-46186.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b03d414e3c222a7f29259526fcdf95189e61fd0c/src%2Ftest%2Fui%2Fissues%2Fissue-46186.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-46186.rs?ref=b03d414e3c222a7f29259526fcdf95189e61fd0c", "patch": "@@ -1,5 +1,6 @@\n struct Struct {\n     a: usize,\n-}; //~ ERROR expected item, found `;`\n+};\n+//~^ ERROR expected item, found `;`\n \n fn main() {}"}, {"sha": "eb0dbb8aa41b8faf464134c1f61acc1ff2d6a3d4", "filename": "src/test/ui/issues/issue-46186.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/b03d414e3c222a7f29259526fcdf95189e61fd0c/src%2Ftest%2Fui%2Fissues%2Fissue-46186.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/b03d414e3c222a7f29259526fcdf95189e61fd0c/src%2Ftest%2Fui%2Fissues%2Fissue-46186.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-46186.stderr?ref=b03d414e3c222a7f29259526fcdf95189e61fd0c", "patch": "@@ -1,8 +1,8 @@\n error: expected item, found `;`\n   --> $DIR/issue-46186.rs:3:2\n    |\n-LL | }; //~ ERROR expected item, found `;`\n-   |  ^ help: consider removing this semicolon\n+LL | };\n+   |  ^ help: remove this semicolon\n    |\n    = help: braced struct declarations are not followed by a semicolon\n "}, {"sha": "a5f05d2824eb88714f9437dabbcc3a455abe1732", "filename": "src/test/ui/issues/issue-49040.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b03d414e3c222a7f29259526fcdf95189e61fd0c/src%2Ftest%2Fui%2Fissues%2Fissue-49040.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b03d414e3c222a7f29259526fcdf95189e61fd0c/src%2Ftest%2Fui%2Fissues%2Fissue-49040.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-49040.rs?ref=b03d414e3c222a7f29259526fcdf95189e61fd0c", "patch": "@@ -1,2 +1,2 @@\n #![allow(unused_variables)]; //~ ERROR expected item, found `;`\n-fn main() {}\n+fn foo() {}"}, {"sha": "12e78e2f3bc958ab12eff530bb140dea42ad66d7", "filename": "src/test/ui/issues/issue-49040.stderr", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/b03d414e3c222a7f29259526fcdf95189e61fd0c/src%2Ftest%2Fui%2Fissues%2Fissue-49040.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/b03d414e3c222a7f29259526fcdf95189e61fd0c/src%2Ftest%2Fui%2Fissues%2Fissue-49040.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-49040.stderr?ref=b03d414e3c222a7f29259526fcdf95189e61fd0c", "patch": "@@ -2,7 +2,12 @@ error: expected item, found `;`\n   --> $DIR/issue-49040.rs:1:28\n    |\n LL | #![allow(unused_variables)]; //~ ERROR expected item, found `;`\n-   |                            ^ help: consider removing this semicolon\n+   |                            ^ help: remove this semicolon\n \n-error: aborting due to previous error\n+error[E0601]: `main` function not found in crate `issue_49040`\n+   |\n+   = note: consider adding a `main` function to `$DIR/issue-49040.rs`\n+\n+error: aborting due to 2 previous errors\n \n+For more information about this error, try `rustc --explain E0601`."}, {"sha": "82935af0a81d221df375c446921d7433cec024a7", "filename": "src/test/ui/suggestions/recover-from-semicolon-trailing-item.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/b03d414e3c222a7f29259526fcdf95189e61fd0c/src%2Ftest%2Fui%2Fsuggestions%2Frecover-from-semicolon-trailing-item.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b03d414e3c222a7f29259526fcdf95189e61fd0c/src%2Ftest%2Fui%2Fsuggestions%2Frecover-from-semicolon-trailing-item.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsuggestions%2Frecover-from-semicolon-trailing-item.rs?ref=b03d414e3c222a7f29259526fcdf95189e61fd0c", "patch": "@@ -0,0 +1,16 @@\n+// verify that after encountering a semicolon after an item the parser recovers\n+mod M {};\n+//~^ ERROR expected item, found `;`\n+struct S {};\n+//~^ ERROR expected item, found `;`\n+fn foo(a: usize) {};\n+//~^ ERROR expected item, found `;`\n+fn main() {\n+    struct X {};  // ok\n+    let _: usize = S {};\n+    //~^ ERROR mismatched types\n+    let _: usize = X {};\n+    //~^ ERROR mismatched types\n+    foo(\"\");\n+    //~^ ERROR mismatched types\n+}"}, {"sha": "9a47a1efb752afe5b4fbe89d27907a84158483e5", "filename": "src/test/ui/suggestions/recover-from-semicolon-trailing-item.stderr", "status": "added", "additions": 50, "deletions": 0, "changes": 50, "blob_url": "https://github.com/rust-lang/rust/blob/b03d414e3c222a7f29259526fcdf95189e61fd0c/src%2Ftest%2Fui%2Fsuggestions%2Frecover-from-semicolon-trailing-item.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/b03d414e3c222a7f29259526fcdf95189e61fd0c/src%2Ftest%2Fui%2Fsuggestions%2Frecover-from-semicolon-trailing-item.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsuggestions%2Frecover-from-semicolon-trailing-item.stderr?ref=b03d414e3c222a7f29259526fcdf95189e61fd0c", "patch": "@@ -0,0 +1,50 @@\n+error: expected item, found `;`\n+  --> $DIR/recover-from-semicolon-trailing-item.rs:2:9\n+   |\n+LL | mod M {};\n+   |         ^ help: remove this semicolon\n+\n+error: expected item, found `;`\n+  --> $DIR/recover-from-semicolon-trailing-item.rs:4:12\n+   |\n+LL | struct S {};\n+   |            ^ help: remove this semicolon\n+   |\n+   = help: braced struct declarations are not followed by a semicolon\n+\n+error: expected item, found `;`\n+  --> $DIR/recover-from-semicolon-trailing-item.rs:6:20\n+   |\n+LL | fn foo(a: usize) {};\n+   |                    ^ help: remove this semicolon\n+\n+error[E0308]: mismatched types\n+  --> $DIR/recover-from-semicolon-trailing-item.rs:10:20\n+   |\n+LL |     let _: usize = S {};\n+   |                    ^^^^ expected usize, found struct `S`\n+   |\n+   = note: expected type `usize`\n+              found type `S`\n+\n+error[E0308]: mismatched types\n+  --> $DIR/recover-from-semicolon-trailing-item.rs:12:20\n+   |\n+LL |     let _: usize = X {};\n+   |                    ^^^^ expected usize, found struct `main::X`\n+   |\n+   = note: expected type `usize`\n+              found type `main::X`\n+\n+error[E0308]: mismatched types\n+  --> $DIR/recover-from-semicolon-trailing-item.rs:14:9\n+   |\n+LL |     foo(\"\");\n+   |         ^^ expected usize, found reference\n+   |\n+   = note: expected type `usize`\n+              found type `&'static str`\n+\n+error: aborting due to 6 previous errors\n+\n+For more information about this error, try `rustc --explain E0308`."}]}