{"sha": "7580534c3a142c79340576c109f3cd73950996c0", "node_id": "MDY6Q29tbWl0NzI0NzEyOjc1ODA1MzRjM2ExNDJjNzkzNDA1NzZjMTA5ZjNjZDczOTUwOTk2YzA=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-07-30T07:08:24Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2016-07-30T07:08:24Z"}, "message": "Auto merge of #35051 - japaric:backtrace, r=alexcrichton\n\nrustbuild: make backtraces (RUST_BACKTRACE) optional\n\nbut keep them enabled by default to maintain the status quo.\n\nWhen disabled shaves ~56KB off every x86_64-unknown-linux-gnu\nbinary.\n\nTo disable backtraces you have to use a config.toml (see\nsrc/bootstrap/config.toml.example for details) when building rustc/std:\n\n$ python bootstrap.py --config=config.toml\n\n---\n\nr? @alexcrichton\ncc rust-lang/rfcs#1417", "tree": {"sha": "9540f76380c558928a9326f2d14149dab1c27433", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9540f76380c558928a9326f2d14149dab1c27433"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7580534c3a142c79340576c109f3cd73950996c0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7580534c3a142c79340576c109f3cd73950996c0", "html_url": "https://github.com/rust-lang/rust/commit/7580534c3a142c79340576c109f3cd73950996c0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7580534c3a142c79340576c109f3cd73950996c0/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2ad98a0b42917dbb0914f458829db7511be168d4", "url": "https://api.github.com/repos/rust-lang/rust/commits/2ad98a0b42917dbb0914f458829db7511be168d4", "html_url": "https://github.com/rust-lang/rust/commit/2ad98a0b42917dbb0914f458829db7511be168d4"}, {"sha": "774fbdf40deb9b257dd6aa166096fed1eeac80c2", "url": "https://api.github.com/repos/rust-lang/rust/commits/774fbdf40deb9b257dd6aa166096fed1eeac80c2", "html_url": "https://github.com/rust-lang/rust/commit/774fbdf40deb9b257dd6aa166096fed1eeac80c2"}], "stats": {"total": 46, "additions": 36, "deletions": 10}, "files": [{"sha": "aafbf68d1b7b60b712fac8ba7a6b091b2266c98d", "filename": "src/bootstrap/config.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/7580534c3a142c79340576c109f3cd73950996c0/src%2Fbootstrap%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7580534c3a142c79340576c109f3cd73950996c0/src%2Fbootstrap%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fconfig.rs?ref=7580534c3a142c79340576c109f3cd73950996c0", "patch": "@@ -72,6 +72,7 @@ pub struct Config {\n     // libstd features\n     pub debug_jemalloc: bool,\n     pub use_jemalloc: bool,\n+    pub backtrace: bool, // support for RUST_BACKTRACE\n \n     // misc\n     pub channel: String,\n@@ -134,6 +135,7 @@ struct Rust {\n     debuginfo: Option<bool>,\n     debug_jemalloc: Option<bool>,\n     use_jemalloc: Option<bool>,\n+    backtrace: Option<bool>,\n     default_linker: Option<String>,\n     default_ar: Option<String>,\n     channel: Option<String>,\n@@ -158,6 +160,7 @@ impl Config {\n         let mut config = Config::default();\n         config.llvm_optimize = true;\n         config.use_jemalloc = true;\n+        config.backtrace = true;\n         config.rust_optimize = true;\n         config.rust_optimize_tests = true;\n         config.submodules = true;\n@@ -230,6 +233,7 @@ impl Config {\n             set(&mut config.rust_rpath, rust.rpath);\n             set(&mut config.debug_jemalloc, rust.debug_jemalloc);\n             set(&mut config.use_jemalloc, rust.use_jemalloc);\n+            set(&mut config.backtrace, rust.backtrace);\n             set(&mut config.channel, rust.channel.clone());\n             config.rustc_default_linker = rust.default_linker.clone();\n             config.rustc_default_ar = rust.default_ar.clone();"}, {"sha": "2894adafef622dab873f3595bd264aaac1cfb004", "filename": "src/bootstrap/config.toml.example", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/7580534c3a142c79340576c109f3cd73950996c0/src%2Fbootstrap%2Fconfig.toml.example", "raw_url": "https://github.com/rust-lang/rust/raw/7580534c3a142c79340576c109f3cd73950996c0/src%2Fbootstrap%2Fconfig.toml.example", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fconfig.toml.example?ref=7580534c3a142c79340576c109f3cd73950996c0", "patch": "@@ -99,6 +99,9 @@\n # Whether or not jemalloc is built with its debug option set\n #debug-jemalloc = false\n \n+# Whether or not `panic!`s generate backtraces (RUST_BACKTRACE)\n+#backtrace = true\n+\n # The default linker that will be used by the generated compiler. Note that this\n # is not the linker used to link said compiler.\n #default-linker = \"cc\""}, {"sha": "25356b86221c1975e4b59ee6d31901611852752c", "filename": "src/bootstrap/lib.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/7580534c3a142c79340576c109f3cd73950996c0/src%2Fbootstrap%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7580534c3a142c79340576c109f3cd73950996c0/src%2Fbootstrap%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Flib.rs?ref=7580534c3a142c79340576c109f3cd73950996c0", "patch": "@@ -652,6 +652,9 @@ impl Build {\n         if self.config.use_jemalloc {\n             features.push_str(\" jemalloc\");\n         }\n+        if self.config.backtrace {\n+            features.push_str(\" backtrace\");\n+        }\n         return features\n     }\n "}, {"sha": "b442d21b72ba94d6a02acd48c91586700dbd127a", "filename": "src/libstd/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7580534c3a142c79340576c109f3cd73950996c0/src%2Flibstd%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/7580534c3a142c79340576c109f3cd73950996c0/src%2Flibstd%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2FCargo.toml?ref=7580534c3a142c79340576c109f3cd73950996c0", "patch": "@@ -27,5 +27,6 @@ build_helper = { path = \"../build_helper\" }\n gcc = \"0.3\"\n \n [features]\n+backtrace = []\n jemalloc = [\"alloc_jemalloc\"]\n debug-jemalloc = [\"alloc_jemalloc/debug\"]"}, {"sha": "9018e48d06bd1a2da7b32bbad80b836643f00497", "filename": "src/libstd/build.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/7580534c3a142c79340576c109f3cd73950996c0/src%2Flibstd%2Fbuild.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7580534c3a142c79340576c109f3cd73950996c0/src%2Flibstd%2Fbuild.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fbuild.rs?ref=7580534c3a142c79340576c109f3cd73950996c0", "patch": "@@ -25,7 +25,8 @@ fn main() {\n \n     let target = env::var(\"TARGET\").unwrap();\n     let host = env::var(\"HOST\").unwrap();\n-    if !target.contains(\"apple\") && !target.contains(\"msvc\") && !target.contains(\"emscripten\"){\n+    if cfg!(feature = \"backtrace\") && !target.contains(\"apple\") && !target.contains(\"msvc\") &&\n+        !target.contains(\"emscripten\") {\n         build_libbacktrace(&host, &target);\n     }\n "}, {"sha": "57a4c3df70a476eeeb680233db6ab390a4c95490", "filename": "src/libstd/panicking.rs", "status": "modified", "additions": 19, "deletions": 9, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/7580534c3a142c79340576c109f3cd73950996c0/src%2Flibstd%2Fpanicking.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7580534c3a142c79340576c109f3cd73950996c0/src%2Flibstd%2Fpanicking.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fpanicking.rs?ref=7580534c3a142c79340576c109f3cd73950996c0", "patch": "@@ -28,9 +28,7 @@ use intrinsics;\n use mem;\n use raw;\n use sys_common::rwlock::RWLock;\n-use sync::atomic::{AtomicBool, Ordering};\n use sys::stdio::Stderr;\n-use sys_common::backtrace;\n use sys_common::thread_info;\n use sys_common::util;\n use thread;\n@@ -71,7 +69,6 @@ enum Hook {\n \n static HOOK_LOCK: RWLock = RWLock::new();\n static mut HOOK: Hook = Hook::Default;\n-static FIRST_PANIC: AtomicBool = AtomicBool::new(true);\n \n /// Registers a custom panic hook, replacing any that was previously registered.\n ///\n@@ -183,11 +180,17 @@ impl<'a> Location<'a> {\n }\n \n fn default_hook(info: &PanicInfo) {\n-    let panics = PANIC_COUNT.with(|c| c.get());\n+    #[cfg(any(not(cargobuild), feature = \"backtrace\"))]\n+    use sys_common::backtrace;\n \n     // If this is a double panic, make sure that we print a backtrace\n     // for this panic. Otherwise only print it if logging is enabled.\n-    let log_backtrace = panics >= 2 || backtrace::log_enabled();\n+    #[cfg(any(not(cargobuild), feature = \"backtrace\"))]\n+    let log_backtrace = {\n+        let panics = PANIC_COUNT.with(|c| c.get());\n+\n+        panics >= 2 || backtrace::log_enabled()\n+    };\n \n     let file = info.location.file;\n     let line = info.location.line;\n@@ -207,10 +210,17 @@ fn default_hook(info: &PanicInfo) {\n         let _ = writeln!(err, \"thread '{}' panicked at '{}', {}:{}\",\n                          name, msg, file, line);\n \n-        if log_backtrace {\n-            let _ = backtrace::write(err);\n-        } else if FIRST_PANIC.compare_and_swap(true, false, Ordering::SeqCst) {\n-            let _ = writeln!(err, \"note: Run with `RUST_BACKTRACE=1` for a backtrace.\");\n+        #[cfg(any(not(cargobuild), feature = \"backtrace\"))]\n+        {\n+            use sync::atomic::{AtomicBool, Ordering};\n+\n+            static FIRST_PANIC: AtomicBool = AtomicBool::new(true);\n+\n+            if log_backtrace {\n+                let _ = backtrace::write(err);\n+            } else if FIRST_PANIC.compare_and_swap(true, false, Ordering::SeqCst) {\n+                let _ = writeln!(err, \"note: Run with `RUST_BACKTRACE=1` for a backtrace.\");\n+            }\n         }\n     };\n "}, {"sha": "a1f3f477b3ab7dfa4f64eadac9847bc8568d4f92", "filename": "src/libstd/sys/common/mod.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/7580534c3a142c79340576c109f3cd73950996c0/src%2Flibstd%2Fsys%2Fcommon%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7580534c3a142c79340576c109f3cd73950996c0/src%2Flibstd%2Fsys%2Fcommon%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Fcommon%2Fmod.rs?ref=7580534c3a142c79340576c109f3cd73950996c0", "patch": "@@ -28,6 +28,7 @@ macro_rules! rtassert {\n \n pub mod args;\n pub mod at_exit_imp;\n+#[cfg(any(not(cargobuild), feature = \"backtrace\"))]\n pub mod backtrace;\n pub mod condvar;\n pub mod io;\n@@ -42,6 +43,7 @@ pub mod thread_local;\n pub mod util;\n pub mod wtf8;\n \n+#[cfg(any(not(cargobuild), feature = \"backtrace\"))]\n #[cfg(any(all(unix, not(any(target_os = \"macos\", target_os = \"ios\", target_os = \"emscripten\"))),\n           all(windows, target_env = \"gnu\")))]\n pub mod gnu;"}, {"sha": "1c25c8f77c196f444489178e37a471c67cdb3947", "filename": "src/libstd/sys/unix/mod.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7580534c3a142c79340576c109f3cd73950996c0/src%2Flibstd%2Fsys%2Funix%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7580534c3a142c79340576c109f3cd73950996c0/src%2Flibstd%2Fsys%2Funix%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Funix%2Fmod.rs?ref=7580534c3a142c79340576c109f3cd73950996c0", "patch": "@@ -30,6 +30,7 @@ use libc;\n pub mod weak;\n \n pub mod android;\n+#[cfg(any(not(cargobuild), feature = \"backtrace\"))]\n pub mod backtrace;\n pub mod condvar;\n pub mod ext;"}, {"sha": "693cbe06ba987bcc4e60d6f1d9071d9bc5f5511c", "filename": "src/rustc/std_shim/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7580534c3a142c79340576c109f3cd73950996c0/src%2Frustc%2Fstd_shim%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/7580534c3a142c79340576c109f3cd73950996c0/src%2Frustc%2Fstd_shim%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustc%2Fstd_shim%2FCargo.toml?ref=7580534c3a142c79340576c109f3cd73950996c0", "patch": "@@ -46,3 +46,4 @@ std = { path = \"../../libstd\" }\n [features]\n jemalloc = [\"std/jemalloc\"]\n debug-jemalloc = [\"std/debug-jemalloc\"]\n+backtrace = [\"std/backtrace\"]"}]}