{"sha": "c2613a5c7fc1e6582eae12ea24da7bf08c16ad43", "node_id": "C_kwDOAAsO6NoAKGMyNjEzYTVjN2ZjMWU2NTgyZWFlMTJlYTI0ZGE3YmYwOGMxNmFkNDM", "commit": {"author": {"name": "Dylan DPC", "email": "99973273+Dylan-DPC@users.noreply.github.com", "date": "2022-07-05T10:34:33Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-07-05T10:34:33Z"}, "message": "Rollup merge of #98776 - notriddle:notriddle/mobile-sidebar-auto-close, r=GuillaumeGomez\n\nrustdoc: improve click behavior of the source code mobile full-screen \"sidebar\"\n\nOn desktop, if you open the source code sidebar, it stays open even when you move from page to page. It used to do the same thing on mobile, but I think that's stupid. Since the file list fills the entire screen on mobile, and you can't really do anything with the currently selected file other than dismiss the \"sidebar\" to look at it, it's safe to assume that anybody who clicks a file in that list probably wants the list to go away so they can see it.\n\nSplit out separately from #98772", "tree": {"sha": "ecef41f267a6a4abe3aabeb2b3fffa1845847295", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ecef41f267a6a4abe3aabeb2b3fffa1845847295"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c2613a5c7fc1e6582eae12ea24da7bf08c16ad43", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJixBO6CRBK7hj4Ov3rIwAAgN8IAJDYKNO3bv9pZ1Z1LuXXRYiF\nIp8WhNiU/kn3brvUHUxXStkc2pdSk3DKoKSJq9Q49qoF0oRGg51935tbqzC9EBy4\ndUhw7srBx59ZD4xhpmqXwDz4RebPcxtl43SHf/l58C+Q6AEfzB9V/weSr3gRk9Y4\nQ/6aIJPlBUHnyK3V24mK4DQ46cV3LmYeaA2u9pP6O09T+tPqBRpj2Vslqzuy2W49\nw1B6A8v4VngP/lcpya9KWFyTgP+ryBm2fe9RkjUkIGkgqFAbJ2PKuWlgC9tjueYc\nfU8PUSZt8RN3rE2ZLQEy1ov9yZ0bxtrUnfxKTqnn/VFrcJZgQTUWx+jB3N/M7ek=\n=ZOsH\n-----END PGP SIGNATURE-----\n", "payload": "tree ecef41f267a6a4abe3aabeb2b3fffa1845847295\nparent 291df97faec6e009a95c658cf6d2840088a85fa0\nparent 6e2c49f7eddb4c09e17653760965b69a3dc97fb0\nauthor Dylan DPC <99973273+Dylan-DPC@users.noreply.github.com> 1657017273 +0530\ncommitter GitHub <noreply@github.com> 1657017273 +0530\n\nRollup merge of #98776 - notriddle:notriddle/mobile-sidebar-auto-close, r=GuillaumeGomez\n\nrustdoc: improve click behavior of the source code mobile full-screen \"sidebar\"\n\nOn desktop, if you open the source code sidebar, it stays open even when you move from page to page. It used to do the same thing on mobile, but I think that's stupid. Since the file list fills the entire screen on mobile, and you can't really do anything with the currently selected file other than dismiss the \"sidebar\" to look at it, it's safe to assume that anybody who clicks a file in that list probably wants the list to go away so they can see it.\n\nSplit out separately from #98772\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c2613a5c7fc1e6582eae12ea24da7bf08c16ad43", "html_url": "https://github.com/rust-lang/rust/commit/c2613a5c7fc1e6582eae12ea24da7bf08c16ad43", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c2613a5c7fc1e6582eae12ea24da7bf08c16ad43/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "291df97faec6e009a95c658cf6d2840088a85fa0", "url": "https://api.github.com/repos/rust-lang/rust/commits/291df97faec6e009a95c658cf6d2840088a85fa0", "html_url": "https://github.com/rust-lang/rust/commit/291df97faec6e009a95c658cf6d2840088a85fa0"}, {"sha": "6e2c49f7eddb4c09e17653760965b69a3dc97fb0", "url": "https://api.github.com/repos/rust-lang/rust/commits/6e2c49f7eddb4c09e17653760965b69a3dc97fb0", "html_url": "https://github.com/rust-lang/rust/commit/6e2c49f7eddb4c09e17653760965b69a3dc97fb0"}], "stats": {"total": 57, "additions": 55, "deletions": 2}, "files": [{"sha": "b3dc60d880bbf4d774f80e95dd790efa84fad92b", "filename": "src/librustdoc/html/static/css/rustdoc.css", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/c2613a5c7fc1e6582eae12ea24da7bf08c16ad43/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Frustdoc.css", "raw_url": "https://github.com/rust-lang/rust/raw/c2613a5c7fc1e6582eae12ea24da7bf08c16ad43/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Frustdoc.css", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Frustdoc.css?ref=c2613a5c7fc1e6582eae12ea24da7bf08c16ad43", "patch": "@@ -1739,6 +1739,11 @@ details.rustdoc-toggle[open] > summary.hideme::after {\n \n /* Media Queries */\n \n+/*\n+WARNING: RUSTDOC_MOBILE_BREAKPOINT MEDIA QUERY;\n+If you update this line, then you also need to update the line with the same warning\n+in storage.js plus the media query with (max-width: 700px)\n+*/\n @media (min-width: 701px) {\n \t/* In case there is no documentation before a code block, we need to add some margin at the top\n \tto prevent an overlay between the \"collapse toggle\" and the information tooltip.\n@@ -1759,6 +1764,11 @@ details.rustdoc-toggle[open] > summary.hideme::after {\n \t}\n }\n \n+/*\n+WARNING: RUSTDOC_MOBILE_BREAKPOINT MEDIA QUERY\n+If you update this line, then you also need to update the line with the same warning\n+in storage.js plus the media query with (min-width: 701px)\n+*/\n @media (max-width: 700px) {\n \t/* When linking to an item with an `id` (for instance, by clicking a link in the sidebar,\n \t   or visiting a URL with a fragment like `#method.new`, we don't want the item to be obscured"}, {"sha": "1e9bfa5cc89594a8a3050c26e6716004c1207927", "filename": "src/librustdoc/html/static/js/source-script.js", "status": "modified", "additions": 9, "deletions": 2, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/c2613a5c7fc1e6582eae12ea24da7bf08c16ad43/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsource-script.js", "raw_url": "https://github.com/rust-lang/rust/raw/c2613a5c7fc1e6582eae12ea24da7bf08c16ad43/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsource-script.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsource-script.js?ref=c2613a5c7fc1e6582eae12ea24da7bf08c16ad43", "patch": "@@ -12,6 +12,12 @@\n const rootPath = document.getElementById(\"rustdoc-vars\").attributes[\"data-root-path\"].value;\n let oldScrollPosition = 0;\n \n+function closeSidebarIfMobile() {\n+    if (window.innerWidth < window.RUSTDOC_MOBILE_BREAKPOINT) {\n+        updateLocalStorage(\"source-sidebar-show\", \"false\");\n+    }\n+}\n+\n function createDirEntry(elem, parent, fullPath, hasFoundFile) {\n     const dirEntry = document.createElement(\"details\");\n     const summary = document.createElement(\"summary\");\n@@ -42,6 +48,7 @@ function createDirEntry(elem, parent, fullPath, hasFoundFile) {\n             const file = document.createElement(\"a\");\n             file.innerText = file_text;\n             file.href = rootPath + \"src/\" + fullPath + file_text + \".html\";\n+            file.addEventListener(\"click\", closeSidebarIfMobile);\n             const w = window.location.href.split(\"#\")[0];\n             if (!hasFoundFile && w === file.href) {\n                 file.className = \"selected\";\n@@ -59,7 +66,7 @@ function createDirEntry(elem, parent, fullPath, hasFoundFile) {\n function toggleSidebar() {\n     const child = this.parentNode.children[0];\n     if (child.innerText === \">\") {\n-        if (window.innerWidth < 701) {\n+        if (window.innerWidth < window.RUSTDOC_MOBILE_BREAKPOINT) {\n             // This is to keep the scroll position on mobile.\n             oldScrollPosition = window.scrollY;\n             document.body.style.position = \"fixed\";\n@@ -69,7 +76,7 @@ function toggleSidebar() {\n         child.innerText = \"<\";\n         updateLocalStorage(\"source-sidebar-show\", \"true\");\n     } else {\n-        if (window.innerWidth < 701) {\n+        if (window.innerWidth < window.RUSTDOC_MOBILE_BREAKPOINT) {\n             // This is to keep the scroll position on mobile.\n             document.body.style.position = \"\";\n             document.body.style.top = \"\";"}, {"sha": "0c5389d45e5b7aa1bca73c66af049a09cd59625a", "filename": "src/librustdoc/html/static/js/storage.js", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/c2613a5c7fc1e6582eae12ea24da7bf08c16ad43/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fstorage.js", "raw_url": "https://github.com/rust-lang/rust/raw/c2613a5c7fc1e6582eae12ea24da7bf08c16ad43/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fstorage.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fstorage.js?ref=c2613a5c7fc1e6582eae12ea24da7bf08c16ad43", "patch": "@@ -9,6 +9,11 @@ const darkThemes = [\"dark\", \"ayu\"];\n window.currentTheme = document.getElementById(\"themeStyle\");\n window.mainTheme = document.getElementById(\"mainThemeStyle\");\n \n+// WARNING: RUSTDOC_MOBILE_BREAKPOINT MEDIA QUERY\n+// If you update this line, then you also need to update the two media queries with the same\n+// warning in rustdoc.css\n+window.RUSTDOC_MOBILE_BREAKPOINT = 701;\n+\n const settingsDataset = (function() {\n     const settingsElement = document.getElementById(\"default-settings\");\n     if (settingsElement === null) {"}, {"sha": "fa322574fdec7bd7140a1c2d32f238d1b565c385", "filename": "src/test/rustdoc-gui/sidebar-source-code-display.goml", "status": "modified", "additions": 31, "deletions": 0, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/c2613a5c7fc1e6582eae12ea24da7bf08c16ad43/src%2Ftest%2Frustdoc-gui%2Fsidebar-source-code-display.goml", "raw_url": "https://github.com/rust-lang/rust/raw/c2613a5c7fc1e6582eae12ea24da7bf08c16ad43/src%2Ftest%2Frustdoc-gui%2Fsidebar-source-code-display.goml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-gui%2Fsidebar-source-code-display.goml?ref=c2613a5c7fc1e6582eae12ea24da7bf08c16ad43", "patch": "@@ -18,6 +18,17 @@ click: \"#sidebar-toggle\"\n // Because of the transition CSS, we check by using `wait-for-css` instead of `assert-css`.\n wait-for-css: (\"#sidebar-toggle\", {\"visibility\": \"visible\", \"opacity\": 1})\n \n+// We now check that opening the sidebar and clicking a link will leave it open.\n+// The behavior here on desktop is different than the behavior on mobile,\n+// but since the sidebar doesn't fill the entire screen here, it makes sense to have the\n+// sidebar stay resident.\n+wait-for-css: (\".sidebar\", {\"width\": \"300px\"})\n+assert-local-storage: {\"rustdoc-source-sidebar-show\": \"true\"}\n+click: \".sidebar a.selected\"\n+goto: file://|DOC_PATH|/src/test_docs/lib.rs.html\n+wait-for-css: (\".sidebar\", {\"width\": \"300px\"})\n+assert-local-storage: {\"rustdoc-source-sidebar-show\": \"true\"}\n+\n // Now we check the display of the sidebar items.\n show-text: true\n \n@@ -221,3 +232,23 @@ click: \"#sidebar-toggle\"\n wait-for-css: (\".sidebar\", {\"width\": \"0px\"})\n // The \"scrollTop\" property should be the same.\n assert-window-property: {\"pageYOffset\": \"2519\"}\n+\n+// We now check that opening the sidebar and clicking a link will close it.\n+// The behavior here on mobile is different than the behavior on desktop,\n+// but common sense dictates that if you have a list of files that fills the entire screen, and\n+// you click one of them, you probably want to actually see the file's contents, and not just\n+// make it the current selection.\n+click: \"#sidebar-toggle\"\n+wait-for-css: (\"#source-sidebar\", {\"visibility\": \"visible\"})\n+assert-local-storage: {\"rustdoc-source-sidebar-show\": \"true\"}\n+click: \".sidebar a.selected\"\n+goto: file://|DOC_PATH|/src/test_docs/lib.rs.html\n+wait-for-css: (\"#source-sidebar\", {\"visibility\": \"hidden\"})\n+assert-local-storage: {\"rustdoc-source-sidebar-show\": \"false\"}\n+// Resize back to desktop size, to check that the sidebar doesn't spontaneously open.\n+size: (1000, 1000)\n+wait-for-css: (\"#source-sidebar\", {\"visibility\": \"hidden\"})\n+assert-local-storage: {\"rustdoc-source-sidebar-show\": \"false\"}\n+click: \"#sidebar-toggle\"\n+wait-for-css: (\"#source-sidebar\", {\"visibility\": \"visible\"})\n+assert-local-storage: {\"rustdoc-source-sidebar-show\": \"true\"}"}]}