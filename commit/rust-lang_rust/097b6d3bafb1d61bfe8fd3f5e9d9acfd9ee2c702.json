{"sha": "097b6d3bafb1d61bfe8fd3f5e9d9acfd9ee2c702", "node_id": "C_kwDOAAsO6NoAKDA5N2I2ZDNiYWZiMWQ2MWJmZThmZDNmNWU5ZDlhY2ZkOWVlMmM3MDI", "commit": {"author": {"name": "Wesley Wiser", "email": "wwiser@gmail.com", "date": "2022-10-13T02:52:31Z"}, "committer": {"name": "Wesley Wiser", "email": "wwiser@gmail.com", "date": "2022-10-13T11:35:36Z"}, "message": "Add suggestion to the \"missing native library\" error\n\nIf we fail to locate a native library that we are linking with, it could\nbe the case the user entered a complete file name like `foo.lib` or\n`libfoo.a` when we expect them to simply provide `foo`.\n\nIn this situation, we now detect that case and suggest the user only\nprovide the library name itself.", "tree": {"sha": "6513d8c3204973d3b7e122680e7f62ac0976ba8b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6513d8c3204973d3b7e122680e7f62ac0976ba8b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/097b6d3bafb1d61bfe8fd3f5e9d9acfd9ee2c702", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/097b6d3bafb1d61bfe8fd3f5e9d9acfd9ee2c702", "html_url": "https://github.com/rust-lang/rust/commit/097b6d3bafb1d61bfe8fd3f5e9d9acfd9ee2c702", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/097b6d3bafb1d61bfe8fd3f5e9d9acfd9ee2c702/comments", "author": {"login": "wesleywiser", "id": 831192, "node_id": "MDQ6VXNlcjgzMTE5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/831192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wesleywiser", "html_url": "https://github.com/wesleywiser", "followers_url": "https://api.github.com/users/wesleywiser/followers", "following_url": "https://api.github.com/users/wesleywiser/following{/other_user}", "gists_url": "https://api.github.com/users/wesleywiser/gists{/gist_id}", "starred_url": "https://api.github.com/users/wesleywiser/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wesleywiser/subscriptions", "organizations_url": "https://api.github.com/users/wesleywiser/orgs", "repos_url": "https://api.github.com/users/wesleywiser/repos", "events_url": "https://api.github.com/users/wesleywiser/events{/privacy}", "received_events_url": "https://api.github.com/users/wesleywiser/received_events", "type": "User", "site_admin": false}, "committer": {"login": "wesleywiser", "id": 831192, "node_id": "MDQ6VXNlcjgzMTE5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/831192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wesleywiser", "html_url": "https://github.com/wesleywiser", "followers_url": "https://api.github.com/users/wesleywiser/followers", "following_url": "https://api.github.com/users/wesleywiser/following{/other_user}", "gists_url": "https://api.github.com/users/wesleywiser/gists{/gist_id}", "starred_url": "https://api.github.com/users/wesleywiser/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wesleywiser/subscriptions", "organizations_url": "https://api.github.com/users/wesleywiser/orgs", "repos_url": "https://api.github.com/users/wesleywiser/repos", "events_url": "https://api.github.com/users/wesleywiser/events{/privacy}", "received_events_url": "https://api.github.com/users/wesleywiser/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0938e1680daf66ca6aad428aedf9a920a0dab5ad", "url": "https://api.github.com/repos/rust-lang/rust/commits/0938e1680daf66ca6aad428aedf9a920a0dab5ad", "html_url": "https://github.com/rust-lang/rust/commit/0938e1680daf66ca6aad428aedf9a920a0dab5ad"}], "stats": {"total": 70, "additions": 68, "deletions": 2}, "files": [{"sha": "08e553d9f15896b7e473e12c26eaef6f9b740976", "filename": "compiler/rustc_error_messages/locales/en-US/metadata.ftl", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/097b6d3bafb1d61bfe8fd3f5e9d9acfd9ee2c702/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fmetadata.ftl", "raw_url": "https://github.com/rust-lang/rust/raw/097b6d3bafb1d61bfe8fd3f5e9d9acfd9ee2c702/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fmetadata.ftl", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fmetadata.ftl?ref=097b6d3bafb1d61bfe8fd3f5e9d9acfd9ee2c702", "patch": "@@ -165,6 +165,8 @@ metadata_failed_write_error =\n metadata_missing_native_library =\n     could not find native static library `{$libname}`, perhaps an -L flag is missing?\n \n+metadata_only_provide_library_name = only provide the library name `{$suggested_name}`, not the full filename\n+\n metadata_failed_create_tempdir =\n     couldn't create a temp dir: {$err}\n "}, {"sha": "dbfa22aaff0749042360bee1a47661d307cb426b", "filename": "compiler/rustc_metadata/src/errors.rs", "status": "modified", "additions": 35, "deletions": 1, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/097b6d3bafb1d61bfe8fd3f5e9d9acfd9ee2c702/compiler%2Frustc_metadata%2Fsrc%2Ferrors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/097b6d3bafb1d61bfe8fd3f5e9d9acfd9ee2c702/compiler%2Frustc_metadata%2Fsrc%2Ferrors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_metadata%2Fsrc%2Ferrors.rs?ref=097b6d3bafb1d61bfe8fd3f5e9d9acfd9ee2c702", "patch": "@@ -372,7 +372,41 @@ pub struct FailedWriteError {\n #[derive(Diagnostic)]\n #[diag(metadata::missing_native_library)]\n pub struct MissingNativeLibrary<'a> {\n-    pub libname: &'a str,\n+    libname: &'a str,\n+    #[subdiagnostic]\n+    suggest_name: Option<SuggestLibraryName<'a>>,\n+}\n+\n+impl<'a> MissingNativeLibrary<'a> {\n+    pub fn new(libname: &'a str, verbatim: bool) -> Self {\n+        // if it looks like the user has provided a complete filename rather just the bare lib name,\n+        // then provide a note that they might want to try trimming the name\n+        let suggested_name = if !verbatim {\n+            if let Some(libname) = libname.strip_prefix(\"lib\") && let Some(libname) = libname.strip_suffix(\".a\") {\n+                // this is a unix style filename so trim prefix & suffix\n+                Some(libname)\n+            } else if let Some(libname) = libname.strip_suffix(\".lib\") {\n+                // this is a Windows style filename so just trim the suffix\n+                Some(libname)\n+            } else {\n+                None\n+            }\n+        } else {\n+            None\n+        };\n+\n+        Self {\n+            libname,\n+            suggest_name: suggested_name\n+                .map(|suggested_name| SuggestLibraryName { suggested_name }),\n+        }\n+    }\n+}\n+\n+#[derive(Subdiagnostic)]\n+#[help(metadata::only_provide_library_name)]\n+pub struct SuggestLibraryName<'a> {\n+    suggested_name: &'a str,\n }\n \n #[derive(Diagnostic)]"}, {"sha": "676c67bad827f79b741532cd1ee2fec9114d069d", "filename": "compiler/rustc_metadata/src/native_libs.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/097b6d3bafb1d61bfe8fd3f5e9d9acfd9ee2c702/compiler%2Frustc_metadata%2Fsrc%2Fnative_libs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/097b6d3bafb1d61bfe8fd3f5e9d9acfd9ee2c702/compiler%2Frustc_metadata%2Fsrc%2Fnative_libs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_metadata%2Fsrc%2Fnative_libs.rs?ref=097b6d3bafb1d61bfe8fd3f5e9d9acfd9ee2c702", "patch": "@@ -52,7 +52,7 @@ pub fn find_native_static_library(\n         }\n     }\n \n-    sess.emit_fatal(MissingNativeLibrary { libname: name });\n+    sess.emit_fatal(MissingNativeLibrary::new(name, verbatim.unwrap_or(false)));\n }\n \n fn find_bundled_library("}, {"sha": "abf988a7c1ed380e23957ec3bd31bd6b00cdfe87", "filename": "src/test/ui/native-library-link-flags/suggest-libname-only-1.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/097b6d3bafb1d61bfe8fd3f5e9d9acfd9ee2c702/src%2Ftest%2Fui%2Fnative-library-link-flags%2Fsuggest-libname-only-1.rs", "raw_url": "https://github.com/rust-lang/rust/raw/097b6d3bafb1d61bfe8fd3f5e9d9acfd9ee2c702/src%2Ftest%2Fui%2Fnative-library-link-flags%2Fsuggest-libname-only-1.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fnative-library-link-flags%2Fsuggest-libname-only-1.rs?ref=097b6d3bafb1d61bfe8fd3f5e9d9acfd9ee2c702", "patch": "@@ -0,0 +1,9 @@\n+// build-fail\n+// compile-flags: --crate-type rlib\n+// error-pattern: could not find native static library `libfoo.a`\n+// error-pattern: only provide the library name `foo`, not the full filename\n+\n+#[link(name = \"libfoo.a\", kind = \"static\")]\n+extern { }\n+\n+pub fn main() { }"}, {"sha": "64d0a9077ed1516e66002aaddc23dfb0ea0942aa", "filename": "src/test/ui/native-library-link-flags/suggest-libname-only-1.stderr", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/097b6d3bafb1d61bfe8fd3f5e9d9acfd9ee2c702/src%2Ftest%2Fui%2Fnative-library-link-flags%2Fsuggest-libname-only-1.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/097b6d3bafb1d61bfe8fd3f5e9d9acfd9ee2c702/src%2Ftest%2Fui%2Fnative-library-link-flags%2Fsuggest-libname-only-1.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fnative-library-link-flags%2Fsuggest-libname-only-1.stderr?ref=097b6d3bafb1d61bfe8fd3f5e9d9acfd9ee2c702", "patch": "@@ -0,0 +1,6 @@\n+error: could not find native static library `libfoo.a`, perhaps an -L flag is missing?\n+   |\n+   = help: only provide the library name `foo`, not the full filename\n+\n+error: aborting due to previous error\n+"}, {"sha": "dfa70e56db73ce8a1145a7adfe7340ec24a1b9ab", "filename": "src/test/ui/native-library-link-flags/suggest-libname-only-2.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/097b6d3bafb1d61bfe8fd3f5e9d9acfd9ee2c702/src%2Ftest%2Fui%2Fnative-library-link-flags%2Fsuggest-libname-only-2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/097b6d3bafb1d61bfe8fd3f5e9d9acfd9ee2c702/src%2Ftest%2Fui%2Fnative-library-link-flags%2Fsuggest-libname-only-2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fnative-library-link-flags%2Fsuggest-libname-only-2.rs?ref=097b6d3bafb1d61bfe8fd3f5e9d9acfd9ee2c702", "patch": "@@ -0,0 +1,9 @@\n+// build-fail\n+// compile-flags: --crate-type rlib\n+// error-pattern: could not find native static library `bar.lib`\n+// error-pattern: only provide the library name `bar`, not the full filename\n+\n+#[link(name = \"bar.lib\", kind = \"static\")]\n+extern { }\n+\n+pub fn main() { }"}, {"sha": "e166af9ed8f0393f1955ec34b81850706a6c1d0e", "filename": "src/test/ui/native-library-link-flags/suggest-libname-only-2.stderr", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/097b6d3bafb1d61bfe8fd3f5e9d9acfd9ee2c702/src%2Ftest%2Fui%2Fnative-library-link-flags%2Fsuggest-libname-only-2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/097b6d3bafb1d61bfe8fd3f5e9d9acfd9ee2c702/src%2Ftest%2Fui%2Fnative-library-link-flags%2Fsuggest-libname-only-2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fnative-library-link-flags%2Fsuggest-libname-only-2.stderr?ref=097b6d3bafb1d61bfe8fd3f5e9d9acfd9ee2c702", "patch": "@@ -0,0 +1,6 @@\n+error: could not find native static library `bar.lib`, perhaps an -L flag is missing?\n+   |\n+   = help: only provide the library name `bar`, not the full filename\n+\n+error: aborting due to previous error\n+"}]}