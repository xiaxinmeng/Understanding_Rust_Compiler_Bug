{"sha": "a1fdc32d99084128e69b5c0dfb507529781a02c2", "node_id": "MDY6Q29tbWl0NzI0NzEyOmExZmRjMzJkOTkwODQxMjhlNjliNWMwZGZiNTA3NTI5NzgxYTAyYzI=", "commit": {"author": {"name": "Nick Cameron", "email": "nrc@ncameron.org", "date": "2017-06-14T22:39:29Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2017-06-14T22:39:29Z"}, "message": "Merge pull request #1673 from topecongiro/get-tests-passing-again\n\nGet tests passing again", "tree": {"sha": "cc420215f8100e3c4a7694a96c84f38a0af4c30c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/cc420215f8100e3c4a7694a96c84f38a0af4c30c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a1fdc32d99084128e69b5c0dfb507529781a02c2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a1fdc32d99084128e69b5c0dfb507529781a02c2", "html_url": "https://github.com/rust-lang/rust/commit/a1fdc32d99084128e69b5c0dfb507529781a02c2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a1fdc32d99084128e69b5c0dfb507529781a02c2/comments", "author": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2dde4547fc7584c40fb9fe93af2ee0fc8ae65dfa", "url": "https://api.github.com/repos/rust-lang/rust/commits/2dde4547fc7584c40fb9fe93af2ee0fc8ae65dfa", "html_url": "https://github.com/rust-lang/rust/commit/2dde4547fc7584c40fb9fe93af2ee0fc8ae65dfa"}, {"sha": "866c2885f7eed4cee1b6831011ad66fcf3b468f0", "url": "https://api.github.com/repos/rust-lang/rust/commits/866c2885f7eed4cee1b6831011ad66fcf3b468f0", "html_url": "https://github.com/rust-lang/rust/commit/866c2885f7eed4cee1b6831011ad66fcf3b468f0"}], "stats": {"total": 325, "additions": 180, "deletions": 145}, "files": [{"sha": "d6bf62e34d224f92d0edb6b9367d5381325cf54a", "filename": ".travis.yml", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/a1fdc32d99084128e69b5c0dfb507529781a02c2/.travis.yml", "raw_url": "https://github.com/rust-lang/rust/raw/a1fdc32d99084128e69b5c0dfb507529781a02c2/.travis.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.travis.yml?ref=a1fdc32d99084128e69b5c0dfb507529781a02c2", "patch": "@@ -1,8 +1,8 @@\n sudo: false\n language: rust\n rust:\n- - stable\n- - beta\n+# - stable\n+# - beta\n  - nightly\n os:\n  - linux"}, {"sha": "71704c494e7e701887cd2bd09922e3b95d06f26a", "filename": "appveyor.yml", "status": "modified", "additions": 16, "deletions": 16, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/a1fdc32d99084128e69b5c0dfb507529781a02c2/appveyor.yml", "raw_url": "https://github.com/rust-lang/rust/raw/a1fdc32d99084128e69b5c0dfb507529781a02c2/appveyor.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/appveyor.yml?ref=a1fdc32d99084128e69b5c0dfb507529781a02c2", "patch": "@@ -6,23 +6,23 @@ environment:\n     PROJECT_NAME: rustfmt\r\n   matrix:\r\n     # Stable channel\r\n-    - TARGET: i686-pc-windows-gnu\r\n-      CHANNEL: stable\r\n-    - TARGET: i686-pc-windows-msvc\r\n-      CHANNEL: stable\r\n-    - TARGET: x86_64-pc-windows-gnu\r\n-      CHANNEL: stable\r\n-    - TARGET: x86_64-pc-windows-msvc\r\n-      CHANNEL: stable\r\n+    # - TARGET: i686-pc-windows-gnu\r\n+    #   CHANNEL: stable\r\n+    # - TARGET: i686-pc-windows-msvc\r\n+    #   CHANNEL: stable\r\n+    # - TARGET: x86_64-pc-windows-gnu\r\n+    #   CHANNEL: stable\r\n+    # - TARGET: x86_64-pc-windows-msvc\r\n+    #   CHANNEL: stable\r\n     # Beta channel\r\n-    - TARGET: i686-pc-windows-gnu\r\n-      CHANNEL: beta\r\n-    - TARGET: i686-pc-windows-msvc\r\n-      CHANNEL: beta\r\n-    - TARGET: x86_64-pc-windows-gnu\r\n-      CHANNEL: beta\r\n-    - TARGET: x86_64-pc-windows-msvc\r\n-      CHANNEL: beta\r\n+    # - TARGET: i686-pc-windows-gnu\r\n+    #   CHANNEL: beta\r\n+    # - TARGET: i686-pc-windows-msvc\r\n+    #   CHANNEL: beta\r\n+    # - TARGET: x86_64-pc-windows-gnu\r\n+    #   CHANNEL: beta\r\n+    # - TARGET: x86_64-pc-windows-msvc\r\n+    #   CHANNEL: beta\r\n     # Nightly channel\r\n     - TARGET: i686-pc-windows-gnu\r\n       CHANNEL: nightly\r"}, {"sha": "e9f84b71e48408b21d7d628cc63fbeef1fc5ec07", "filename": "src/comment.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/a1fdc32d99084128e69b5c0dfb507529781a02c2/src%2Fcomment.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a1fdc32d99084128e69b5c0dfb507529781a02c2/src%2Fcomment.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcomment.rs?ref=a1fdc32d99084128e69b5c0dfb507529781a02c2", "patch": "@@ -319,8 +319,8 @@ fn left_trim_comment_line<'a>(line: &'a str, style: &CommentStyle) -> &'a str {\n         } else {\n             &line[opener.trim_right().len()..]\n         }\n-    } else if line.starts_with(\"/* \") || line.starts_with(\"// \") ||\n-               line.starts_with(\"//!\") || line.starts_with(\"///\") ||\n+    } else if line.starts_with(\"/* \") || line.starts_with(\"// \") || line.starts_with(\"//!\") ||\n+               line.starts_with(\"///\") ||\n                line.starts_with(\"** \") || line.starts_with(\"/*!\") ||\n                (line.starts_with(\"/**\") && !line.starts_with(\"/**/\"))\n     {"}, {"sha": "afa4aa851f30cb2d9f2d02b4a9604618d8789e16", "filename": "src/expr.rs", "status": "modified", "additions": 60, "deletions": 59, "changes": 119, "blob_url": "https://github.com/rust-lang/rust/blob/a1fdc32d99084128e69b5c0dfb507529781a02c2/src%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a1fdc32d99084128e69b5c0dfb507529781a02c2/src%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fexpr.rs?ref=a1fdc32d99084128e69b5c0dfb507529781a02c2", "patch": "@@ -370,7 +370,9 @@ where\n         // This is needed in case of line break not caused by a\n         // shortage of space, but by end-of-line comments, for example.\n         if !rhs_result.contains('\\n') {\n-            let lhs_shape = try_opt!(shape.sub_width(prefix.len() + infix.len()));\n+            let lhs_shape = try_opt!(try_opt!(shape.offset_left(prefix.len())).sub_width(\n+                infix.len(),\n+            ));\n             let lhs_result = lhs.rewrite(context, lhs_shape);\n             if let Some(lhs_result) = lhs_result {\n                 let mut result = format!(\"{}{}{}\", prefix, lhs_result, infix);\n@@ -411,22 +413,23 @@ where\n             try_opt!(shape.sub_width(suffix.len() + prefix.len())).visual_indent(prefix.len())\n         }\n         Style::Rfc => {\n-            shape\n-                .block_indent(context.config.tab_spaces())\n-                .with_max_width(context.config)\n+            // Try to calculate the initial constraint on the right hand side.\n+            let rhs_overhead = context\n+                .config\n+                .max_width()\n+                .checked_sub(shape.used_width() + shape.width)\n+                .unwrap_or(0);\n+            try_opt!(\n+                Shape::indented(shape.indent.block_indent(context.config), context.config)\n+                    .sub_width(rhs_overhead)\n+            )\n         }\n     };\n-\n     let rhs_result = try_opt!(rhs.rewrite(context, rhs_shape));\n-    let lhs_shape = match context.config.control_style() {\n-        Style::Legacy => {\n-            let lhs_overhead = shape.used_width() + prefix.len() + infix.len();\n-            Shape {\n-                width: try_opt!(context.config.max_width().checked_sub(lhs_overhead)),\n-                ..shape\n-            }\n-        }\n-        Style::Rfc => try_opt!(shape.sub_width(prefix.len() + infix.len())),\n+    let lhs_overhead = shape.used_width() + prefix.len() + infix.len();\n+    let lhs_shape = Shape {\n+        width: try_opt!(context.config.max_width().checked_sub(lhs_overhead)),\n+        ..shape\n     };\n     let lhs_result = try_opt!(lhs.rewrite(context, lhs_shape));\n     Some(format!(\n@@ -483,12 +486,9 @@ where\n         }\n     }\n \n-    let has_long_item = try_opt!(\n-        items\n-            .iter()\n-            .map(|li| li.item.as_ref().map(|s| s.len() > 10))\n-            .fold(Some(false), |acc, x| acc.and_then(|y| x.map(|x| x || y)))\n-    );\n+    let has_long_item = items.iter().any(|li| {\n+        li.item.as_ref().map(|s| s.len() > 10).unwrap_or(false)\n+    });\n \n     let tactic = match context.config.array_layout() {\n         IndentStyle::Block => {\n@@ -621,7 +621,7 @@ fn rewrite_closure(\n \n     // 1 = space between `|...|` and body.\n     let extra_offset = extra_offset(&prefix, shape) + 1;\n-    let body_shape = try_opt!(shape.sub_width(extra_offset)).add_offset(extra_offset);\n+    let body_shape = try_opt!(shape.offset_left(extra_offset));\n \n     if let ast::ExprKind::Block(ref block) = body.node {\n         // The body of the closure is an empty block.\n@@ -728,9 +728,10 @@ fn and_one_line(x: Option<String>) -> Option<String> {\n \n fn nop_block_collapse(block_str: Option<String>, budget: usize) -> Option<String> {\n     debug!(\"nop_block_collapse {:?} {}\", block_str, budget);\n-    block_str.map(|block_str| if block_str.starts_with('{') &&\n-        budget >= 2 &&\n-        (block_str[1..].find(|c: char| !c.is_whitespace()).unwrap() == block_str.len() - 2)\n+    block_str.map(|block_str| if block_str.starts_with('{') && budget >= 2 &&\n+        (block_str[1..]\n+             .find(|c: char| !c.is_whitespace())\n+             .unwrap() == block_str.len() - 2)\n     {\n         \"{}\".to_owned()\n     } else {\n@@ -1019,13 +1020,13 @@ impl<'a> Rewrite for ControlFlow<'a> {\n \n         let label_string = rewrite_label(self.label);\n         // 1 = space after keyword.\n-        let add_offset = self.keyword.len() + label_string.len() + 1;\n+        let offset = self.keyword.len() + label_string.len() + 1;\n \n         let pat_expr_string = match self.cond {\n             Some(cond) => {\n                 let mut cond_shape = match context.config.control_style() {\n-                    Style::Legacy => try_opt!(constr_shape.shrink_left(add_offset)),\n-                    Style::Rfc => try_opt!(constr_shape.sub_width(add_offset)),\n+                    Style::Legacy => try_opt!(constr_shape.shrink_left(offset)),\n+                    Style::Rfc => try_opt!(constr_shape.offset_left(offset)),\n                 };\n                 if context.config.control_brace_style() != ControlBraceStyle::AlwaysNextLine {\n                     // 2 = \" {\".len()\n@@ -1345,7 +1346,7 @@ fn rewrite_match(\n     // `match `cond` {`\n     let cond_shape = match context.config.control_style() {\n         Style::Legacy => try_opt!(shape.shrink_left(6).and_then(|s| s.sub_width(2))),\n-        Style::Rfc => try_opt!(shape.sub_width(8)),\n+        Style::Rfc => try_opt!(shape.offset_left(8)),\n     };\n     let cond_str = try_opt!(cond.rewrite(context, cond_shape));\n     let alt_block_sep = String::from(\"\\n\") + &shape.indent.block_only().to_string(context.config);\n@@ -1508,9 +1509,9 @@ impl Rewrite for ast::Arm {\n         let pats_str = format!(\"{}{}\", pats_str, guard_str);\n \n         let (mut extend, body) = match body.node {\n-            ast::ExprKind::Block(ref block) if !is_unsafe_block(block) &&\n-                                                   is_simple_block(block, context.codemap) &&\n-                                                   context.config.wrap_match_arms() => {\n+            ast::ExprKind::Block(ref block)\n+                if !is_unsafe_block(block) && is_simple_block(block, context.codemap) &&\n+                       context.config.wrap_match_arms() => {\n                 if let ast::StmtKind::Expr(ref expr) = block.stmts[0].node {\n                     (false, &**expr)\n                 } else {\n@@ -1571,8 +1572,7 @@ impl Rewrite for ast::Arm {\n \n         // FIXME: we're doing a second rewrite of the expr; This may not be\n         // necessary.\n-        let body_shape = try_opt!(shape.sub_width(context.config.tab_spaces()))\n-            .block_indent(context.config.tab_spaces());\n+        let body_shape = try_opt!(shape.block_left(context.config.tab_spaces()));\n         let next_line_body = try_opt!(nop_block_collapse(\n             body.rewrite(context, body_shape),\n             body_shape.width,\n@@ -1649,7 +1649,9 @@ fn rewrite_guard(\n                 s.rewrite(context, cond_shape)\n             })\n             {\n-                return Some(format!(\" if {}\", cond_str));\n+                if !cond_str.contains('\\n') {\n+                    return Some(format!(\" if {}\", cond_str));\n+                }\n             }\n         }\n \n@@ -1697,7 +1699,7 @@ fn rewrite_pat_expr(\n             } else {\n                 format!(\"{} \", matcher)\n             };\n-            let pat_shape = try_opt!(try_opt!(shape.shrink_left(matcher.len())).sub_width(\n+            let pat_shape = try_opt!(try_opt!(shape.offset_left(matcher.len())).sub_width(\n                 connector.len(),\n             ));\n             pat_string = try_opt!(pat.rewrite(context, pat_shape));\n@@ -2143,19 +2145,29 @@ fn wrap_args_with_parens(\n \n fn rewrite_paren(context: &RewriteContext, subexpr: &ast::Expr, shape: Shape) -> Option<String> {\n     debug!(\"rewrite_paren, shape: {:?}\", shape);\n-    // 1 is for opening paren, 2 is for opening+closing, we want to keep the closing\n-    // paren on the same line as the subexpr.\n-    let sub_shape = try_opt!(shape.sub_width(2)).visual_indent(1);\n-    let subexpr_str = subexpr.rewrite(context, sub_shape);\n-    debug!(\"rewrite_paren, subexpr_str: `{:?}`\", subexpr_str);\n+    let paren_overhead = paren_overhead(context);\n+    let sub_shape = try_opt!(shape.sub_width(paren_overhead / 2)).visual_indent(paren_overhead / 2);\n \n-    subexpr_str.map(|s| if context.config.spaces_within_parens() &&\n-        s.len() > 0\n-    {\n+    let paren_wrapper = |s: &str| if context.config.spaces_within_parens() && s.len() > 0 {\n         format!(\"( {} )\", s)\n     } else {\n         format!(\"({})\", s)\n-    })\n+    };\n+\n+    let subexpr_str = try_opt!(subexpr.rewrite(context, sub_shape));\n+    debug!(\"rewrite_paren, subexpr_str: `{:?}`\", subexpr_str);\n+\n+    if subexpr_str.contains('\\n') {\n+        Some(paren_wrapper(&subexpr_str))\n+    } else {\n+        if subexpr_str.len() + paren_overhead <= shape.width {\n+            Some(paren_wrapper(&subexpr_str))\n+        } else {\n+            let sub_shape = try_opt!(shape.offset_left(2));\n+            let subexpr_str = try_opt!(subexpr.rewrite(context, sub_shape));\n+            Some(paren_wrapper(&subexpr_str))\n+        }\n+    }\n }\n \n fn rewrite_index(\n@@ -2540,21 +2552,10 @@ pub fn rewrite_assign_rhs<S: Into<String>>(\n \n             // FIXME: DRY!\n             match (rhs, new_rhs) {\n-                (Some(ref orig_rhs), Some(ref replacement_rhs)) if count_line_breaks(\n-                    orig_rhs,\n-                ) >\n-                                                                       count_line_breaks(\n-                    replacement_rhs,\n-                ) + 1 ||\n-                                                                       (orig_rhs\n-                                                                            .rewrite(context, shape)\n-                                                                            .is_none() &&\n-                                                                            replacement_rhs\n-                                                                                .rewrite(\n-                    context,\n-                    new_shape,\n-                )\n-                                                                                .is_some()) => {\n+                (Some(ref orig_rhs), Some(ref replacement_rhs))\n+                    if count_line_breaks(orig_rhs) > count_line_breaks(replacement_rhs) + 1 ||\n+                           (orig_rhs.rewrite(context, shape).is_none() &&\n+                                replacement_rhs.rewrite(context, new_shape).is_some()) => {\n                     result.push_str(&format!(\"\\n{}\", new_shape.indent.to_string(context.config)));\n                     result.push_str(replacement_rhs);\n                 }"}, {"sha": "a660f287a5b08e987ca86c027ee22d3a8d223b92", "filename": "src/items.rs", "status": "modified", "additions": 24, "deletions": 13, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/a1fdc32d99084128e69b5c0dfb507529781a02c2/src%2Fitems.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a1fdc32d99084128e69b5c0dfb507529781a02c2/src%2Fitems.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fitems.rs?ref=a1fdc32d99084128e69b5c0dfb507529781a02c2", "patch": "@@ -685,12 +685,12 @@ fn format_impl_ref_and_type(\n     offset: Indent,\n ) -> Option<String> {\n     if let ast::ItemKind::Impl(unsafety,\n-                            polarity,\n-                            _,\n-                            ref generics,\n-                            ref trait_ref,\n-                            ref self_ty,\n-                            _) = item.node\n+                               polarity,\n+                               _,\n+                               ref generics,\n+                               ref trait_ref,\n+                               ref self_ty,\n+                               _) = item.node\n     {\n         let mut result = String::new();\n \n@@ -942,8 +942,8 @@ pub fn format_trait(context: &RewriteContext, item: &ast::Item, offset: Indent)\n         let has_body = !trait_items.is_empty();\n \n         let where_density = if (context.config.where_density() == Density::Compressed &&\n-                                 (!result.contains('\\n') ||\n-                                      context.config.fn_args_layout() == IndentStyle::Block)) ||\n+                                    (!result.contains('\\n') ||\n+                                         context.config.fn_args_layout() == IndentStyle::Block)) ||\n             (context.config.fn_args_layout() == IndentStyle::Block && result.is_empty()) ||\n             (context.config.where_density() == Density::CompressedIfEmpty && !has_body &&\n                  !result.contains('\\n'))\n@@ -1468,9 +1468,9 @@ impl Rewrite for ast::StructField {\n             Some(ref ty) if ty.contains('\\n') => {\n                 let new_ty = rewrite_type_in_next_line();\n                 match new_ty {\n-                    Some(ref new_ty) if !new_ty.contains('\\n') &&\n-                                            new_ty.len() + type_offset.width() <=\n-                                                context.config.max_width() => {\n+                    Some(ref new_ty)\n+                        if !new_ty.contains('\\n') &&\n+                               new_ty.len() + type_offset.width() <= context.config.max_width() => {\n                         Some(format!(\n                             \"{}\\n{}{}\",\n                             result,\n@@ -1831,7 +1831,17 @@ fn rewrite_fn_base(\n     result.push_str(&ident.to_string());\n \n     // Generics.\n-    let shape = Shape::indented(indent + last_line_width(&result), context.config);\n+    let overhead = if has_braces && !newline_brace {\n+        // 4 = `() {`\n+        4\n+    } else {\n+        // 2 = `()`\n+        2\n+    };\n+    let shape = try_opt!(\n+        Shape::indented(indent + last_line_width(&result), context.config)\n+            .sub_width(overhead)\n+    );\n     let g_span = mk_sp(span.lo, span_for_return(&fd.output).lo);\n     let generics_str = try_opt!(rewrite_generics(context, generics, shape, g_span));\n     result.push_str(&generics_str);\n@@ -2678,7 +2688,8 @@ fn format_generics(\n         let same_line_brace = force_same_line_brace ||\n             (generics.where_clause.predicates.is_empty() && trimmed_last_line_width(&result) == 1);\n         if !same_line_brace &&\n-            (brace_style == BraceStyle::SameLineWhere || brace_style == BraceStyle::AlwaysNextLine)\n+            (brace_style == BraceStyle::SameLineWhere ||\n+                brace_style == BraceStyle::AlwaysNextLine)\n         {\n             result.push('\\n');\n             result.push_str(&offset.block_only().to_string(context.config));"}, {"sha": "cfc14b53adb13e7acfa049df7bbb25ad4d52b44c", "filename": "src/macros.rs", "status": "modified", "additions": 23, "deletions": 10, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/a1fdc32d99084128e69b5c0dfb507529781a02c2/src%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a1fdc32d99084128e69b5c0dfb507529781a02c2/src%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fmacros.rs?ref=a1fdc32d99084128e69b5c0dfb507529781a02c2", "patch": "@@ -30,7 +30,7 @@ use syntax::util::ThinVec;\n use Shape;\n use codemap::SpanUtils;\n use rewrite::{Rewrite, RewriteContext};\n-use expr::{rewrite_call, rewrite_array, rewrite_pair};\n+use expr::{rewrite_call, rewrite_array};\n use comment::{FindUncommented, contains_comment};\n use utils::mk_sp;\n \n@@ -192,15 +192,28 @@ pub fn rewrite_macro(\n                 } else {\n                     (\"[\", \"]\")\n                 };\n-                rewrite_pair(\n-                    &*expr_vec[0],\n-                    &*expr_vec[1],\n-                    lbr,\n-                    \"; \",\n-                    rbr,\n-                    context,\n-                    mac_shape,\n-                ).map(|s| format!(\"{}{}\", macro_name, s))\n+                // 6 = `vec!` + `; `\n+                let total_overhead = lbr.len() + rbr.len() + 6;\n+                let lhs = try_opt!(expr_vec[0].rewrite(context, mac_shape));\n+                let rhs = try_opt!(expr_vec[1].rewrite(context, mac_shape));\n+                if !lhs.contains('\\n') && !rhs.contains('\\n') &&\n+                    lhs.len() + rhs.len() + total_overhead <= shape.width\n+                {\n+                    Some(format!(\"{}{}{}; {}{}\", macro_name, lbr, lhs, rhs, rbr))\n+                } else {\n+                    let nested_indent = shape.indent.block_indent(context.config);\n+                    Some(format!(\n+                        \"{}{}\\n{}{};\\n{}{}\\n{}{}\",\n+                        macro_name,\n+                        lbr,\n+                        nested_indent.to_string(context.config),\n+                        lhs,\n+                        nested_indent.to_string(context.config),\n+                        rhs,\n+                        shape.indent.to_string(context.config),\n+                        rbr\n+                    ))\n+                }\n             } else {\n                 // Format macro invocation as array literal.\n                 let rewrite = try_opt!(rewrite_array("}, {"sha": "5ba273ad2725321970228109e954aa29b87935ba", "filename": "src/string.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a1fdc32d99084128e69b5c0dfb507529781a02c2/src%2Fstring.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a1fdc32d99084128e69b5c0dfb507529781a02c2/src%2Fstring.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fstring.rs?ref=a1fdc32d99084128e69b5c0dfb507529781a02c2", "patch": "@@ -81,7 +81,7 @@ pub fn rewrite_string<'a>(orig: &str, fmt: &StringFormat<'a>) -> Option<String>\n                     if cur_end < cur_start + MIN_STRING {\n                         cur_end = cur_start + max_chars;\n                         while !(punctuation.contains(graphemes[cur_end - 1]) ||\n-                              graphemes[cur_end - 1].trim().is_empty())\n+                                    graphemes[cur_end - 1].trim().is_empty())\n                         {\n                             if cur_end >= graphemes.len() {\n                                 let line = &graphemes[cur_start..].join(\"\");"}, {"sha": "665eb2ce35ef4c577b38b4af3c763fe2b503663e", "filename": "src/types.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/a1fdc32d99084128e69b5c0dfb507529781a02c2/src%2Ftypes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a1fdc32d99084128e69b5c0dfb507529781a02c2/src%2Ftypes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftypes.rs?ref=a1fdc32d99084128e69b5c0dfb507529781a02c2", "patch": "@@ -206,9 +206,9 @@ fn rewrite_segment(\n \n     let params = if let Some(ref params) = segment.parameters {\n         match **params {\n-            ast::PathParameters::AngleBracketed(ref data) if !data.lifetimes.is_empty() ||\n-                                                                 !data.types.is_empty() ||\n-                                                                 !data.bindings.is_empty() => {\n+            ast::PathParameters::AngleBracketed(ref data)\n+                if !data.lifetimes.is_empty() || !data.types.is_empty() ||\n+                       !data.bindings.is_empty() => {\n                 let param_list = data.lifetimes\n                     .iter()\n                     .map(SegmentParam::LifeTime)"}, {"sha": "9ed40cc29ee2fece8c1344b612185f5f518eef65", "filename": "src/visitor.rs", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/a1fdc32d99084128e69b5c0dfb507529781a02c2/src%2Fvisitor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a1fdc32d99084128e69b5c0dfb507529781a02c2/src%2Fvisitor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fvisitor.rs?ref=a1fdc32d99084128e69b5c0dfb507529781a02c2", "patch": "@@ -546,10 +546,11 @@ impl<'a> FmtVisitor<'a> {\n     fn push_rewrite(&mut self, span: Span, rewrite: Option<String>) {\n         self.format_missing_with_indent(source!(self, span).lo);\n         self.failed = match rewrite {\n-            Some(ref s) if s.rewrite(\n-                &self.get_context(),\n-                Shape::indented(self.block_indent, self.config),\n-            ).is_none() => true,\n+            Some(ref s)\n+                if s.rewrite(\n+                    &self.get_context(),\n+                    Shape::indented(self.block_indent, self.config),\n+                ).is_none() => true,\n             None => true,\n             _ => self.failed,\n         };"}, {"sha": "20742da2195fb73dfbd508042778478cd24bb501", "filename": "tests/target/configs-control_style-rfc.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a1fdc32d99084128e69b5c0dfb507529781a02c2/tests%2Ftarget%2Fconfigs-control_style-rfc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a1fdc32d99084128e69b5c0dfb507529781a02c2/tests%2Ftarget%2Fconfigs-control_style-rfc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fconfigs-control_style-rfc.rs?ref=a1fdc32d99084128e69b5c0dfb507529781a02c2", "patch": "@@ -5,7 +5,7 @@ fn main() {\n     loop {\n         if foo {\n             if ((right_paddle_speed < 0.) &&\n-                 (right_paddle.position().y - paddle_size.y / 2. > 5.)) ||\n+                    (right_paddle.position().y - paddle_size.y / 2. > 5.)) ||\n                 ((right_paddle_speed > 0.) &&\n                      (right_paddle.position().y + paddle_size.y / 2. < game_height as f32 - 5.))\n             {"}, {"sha": "8f351e8dfc2e0c8c85981f1e651cee2edc32a83f", "filename": "tests/target/configs-trailing_comma-never.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/a1fdc32d99084128e69b5c0dfb507529781a02c2/tests%2Ftarget%2Fconfigs-trailing_comma-never.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a1fdc32d99084128e69b5c0dfb507529781a02c2/tests%2Ftarget%2Fconfigs-trailing_comma-never.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fconfigs-trailing_comma-never.rs?ref=a1fdc32d99084128e69b5c0dfb507529781a02c2", "patch": "@@ -14,10 +14,10 @@ fn main() {\n \n     // #1544\n     if let VrMsg::ClientReply {\n-            request_num: reply_req_num,\n-            value,\n-            ..\n-        } = msg\n+        request_num: reply_req_num,\n+        value,\n+        ..\n+    } = msg\n     {\n         let _ = safe_assert_eq!(reply_req_num, request_num, op);\n         return Ok((request_num, op, value));"}, {"sha": "3b17aee5a787cd00ec7aaddd3cb8cc8d9ae74eb0", "filename": "tests/target/expr.rs", "status": "modified", "additions": 10, "deletions": 8, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/a1fdc32d99084128e69b5c0dfb507529781a02c2/tests%2Ftarget%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a1fdc32d99084128e69b5c0dfb507529781a02c2/tests%2Ftarget%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fexpr.rs?ref=a1fdc32d99084128e69b5c0dfb507529781a02c2", "patch": "@@ -7,8 +7,8 @@ fn foo() -> bool {\n     let referenced = &5;\n \n     let very_long_variable_name = (a + first + simple + test);\n-    let very_long_variable_name =\n-        (a + first + simple + test + AAAAAAAAAAAAA + BBBBBBBBBBBBBBBBB + b + c);\n+    let very_long_variable_name = (a + first + simple + test + AAAAAAAAAAAAA +\n+                                       BBBBBBBBBBBBBBBBB + b + c);\n \n     let is_internalxxxx = self.codemap.span_to_filename(s) ==\n         self.codemap.span_to_filename(m.inner);\n@@ -20,8 +20,10 @@ fn foo() -> bool {\n         10000 * 30000000000 + 40000 / 1002200000000 - 50000 * sqrt(-1),\n         trivial_value,\n     );\n-    (((((((((aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa + a +\n-             aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa + aaaaa)))))))))   ;\n+    (((((((((aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa +\n+                 a +\n+                 aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa +\n+                 aaaaa)))))))));\n \n     {\n         for _ in 0..10 {}\n@@ -47,21 +49,21 @@ fn foo() -> bool {\n     }\n \n     if let Some(x) = (aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa +\n-                       aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa)\n+                          aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa)\n     {}\n \n     if let (some_very_large,\n-         tuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuple) = 1 + 2 + 3\n+            tuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuple) = 1 + 2 + 3\n     {\n     }\n \n     if let (some_very_large,\n-         tuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuple) =\n+            tuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuple) =\n         1111 + 2222\n     {}\n \n     if let (some_very_large,\n-         tuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuple) = 1 + 2 + 3\n+            tuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuple) = 1 + 2 + 3\n     {}\n \n     let test = if true { 5 } else { 3 };"}, {"sha": "d61fc0b9e7b884332f7867fa5940229542322a30", "filename": "tests/target/fn_args_layout-block.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/a1fdc32d99084128e69b5c0dfb507529781a02c2/tests%2Ftarget%2Ffn_args_layout-block.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a1fdc32d99084128e69b5c0dfb507529781a02c2/tests%2Ftarget%2Ffn_args_layout-block.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Ffn_args_layout-block.rs?ref=a1fdc32d99084128e69b5c0dfb507529781a02c2", "patch": "@@ -101,7 +101,12 @@ fn foo<g: G>() {\n     foo();\n }\n \n-fn foo<L: Loooooooooooooooooooooong, G: Geeeeeeeeeeeneric, I: iiiiiiiiis, L: Looooooooooooooooong>() {\n+fn foo<\n+    L: Loooooooooooooooooooooong,\n+    G: Geeeeeeeeeeeneric,\n+    I: iiiiiiiiis,\n+    L: Looooooooooooooooong,\n+>() {\n     foo();\n }\n "}, {"sha": "48c72afd055108a7ec8646280436780fbed578fb", "filename": "tests/target/hard-tabs.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a1fdc32d99084128e69b5c0dfb507529781a02c2/tests%2Ftarget%2Fhard-tabs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a1fdc32d99084128e69b5c0dfb507529781a02c2/tests%2Ftarget%2Fhard-tabs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fhard-tabs.rs?ref=a1fdc32d99084128e69b5c0dfb507529781a02c2", "patch": "@@ -22,7 +22,7 @@ fn main() {\n \tlet str = \"AAAAAAAAAAAAAAaAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAaAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAaAa\";\n \n \tif let (some_very_large,\n-\t     tuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuple) = 1 + 2 + 3\n+\t        tuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuuple) = 1 + 2 + 3\n \t{}\n \n \tif cond() {"}, {"sha": "21c3c9e38de2de7a966d0ae6bdf3c5f9e720d3b0", "filename": "tests/target/issue-1397.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/a1fdc32d99084128e69b5c0dfb507529781a02c2/tests%2Ftarget%2Fissue-1397.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a1fdc32d99084128e69b5c0dfb507529781a02c2/tests%2Ftarget%2Fissue-1397.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fissue-1397.rs?ref=a1fdc32d99084128e69b5c0dfb507529781a02c2", "patch": "@@ -12,8 +12,8 @@ fn baz(p: Packet) {\n             loop {\n                 loop {\n                     if let Packet::Transaction {\n-                            state: TransactionState::Committed(ts, ..), ..\n-                        } = p\n+                        state: TransactionState::Committed(ts, ..), ..\n+                    } = p\n                     {\n                         unreachable!()\n                     }"}, {"sha": "9cc3305ea39ce77ae719af2a98d157fc19239c09", "filename": "tests/target/macros.rs", "status": "modified", "additions": 12, "deletions": 7, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/a1fdc32d99084128e69b5c0dfb507529781a02c2/tests%2Ftarget%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a1fdc32d99084128e69b5c0dfb507529781a02c2/tests%2Ftarget%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fmacros.rs?ref=a1fdc32d99084128e69b5c0dfb507529781a02c2", "patch": "@@ -67,13 +67,18 @@ fn main() {\n     vec![a, b; c];\n     vec![a; b, c];\n \n-    vec![a;\n-            (|x| {\n-                 let y = x + 1;\n-                 let z = y + 1;\n-                 z\n-             })(2)];\n-    vec![a; xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx];\n+    vec![\n+        a;\n+        (|x| {\n+             let y = x + 1;\n+             let z = y + 1;\n+             z\n+         })(2)\n+    ];\n+    vec![\n+        a;\n+        xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n+    ];\n     vec![a; unsafe { x + 1 }];\n \n     unknown_bracket_macro__comma_should_not_be_stripped!["}, {"sha": "040fbf155a48e616ceed9161e37d887e1479eb1c", "filename": "tests/target/match.rs", "status": "modified", "additions": 8, "deletions": 11, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/a1fdc32d99084128e69b5c0dfb507529781a02c2/tests%2Ftarget%2Fmatch.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a1fdc32d99084128e69b5c0dfb507529781a02c2/tests%2Ftarget%2Fmatch.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fmatch.rs?ref=a1fdc32d99084128e69b5c0dfb507529781a02c2", "patch": "@@ -37,10 +37,8 @@ fn foo() {\n         Patternnnnnnnnnnnnnnnnnnnnnnnnn if loooooooooooooooooooooooooooooooooooooooooong_guard => {}\n \n         _ => {}\n-        ast::PathParameters::AngleBracketedParameters(ref data) if data.lifetimes.len() >\n-                                                                       0 ||\n-                                                                       data.types.len() > 0 ||\n-                                                                       data.bindings.len() > 0 => {}\n+        ast::PathParameters::AngleBracketedParameters(ref data)\n+            if data.lifetimes.len() > 0 || data.types.len() > 0 || data.bindings.len() > 0 => {}\n     }\n \n     let whatever = match something {\n@@ -316,16 +314,15 @@ fn issue386() {\n \n fn guards() {\n     match foo {\n-        aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa if foooooooooooooo &&\n-                                                                          barrrrrrrrrrrr => {}\n+        aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\n+            if foooooooooooooo && barrrrrrrrrrrr => {}\n         aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa |\n-        aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa if foooooooooooooo &&\n-                                                                          barrrrrrrrrrrr => {}\n+        aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\n+            if foooooooooooooo && barrrrrrrrrrrr => {}\n         aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\n             if fooooooooooooooooooooo &&\n-                   (bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb || cccccccccccccccccccccccccccccccccccccccc) => {\n-            {}\n-        }\n+                   (bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb ||\n+                        cccccccccccccccccccccccccccccccccccccccc) => {}\n     }\n }\n "}]}