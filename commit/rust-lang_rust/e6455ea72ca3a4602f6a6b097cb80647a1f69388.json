{"sha": "e6455ea72ca3a4602f6a6b097cb80647a1f69388", "node_id": "MDY6Q29tbWl0NzI0NzEyOmU2NDU1ZWE3MmNhM2E0NjAyZjZhNmIwOTdjYjgwNjQ3YTFmNjkzODg=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-09-11T23:35:28Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-09-11T23:35:28Z"}, "message": "Auto merge of #84373 - cjgillot:resolve-span, r=michaelwoerister,petrochenkov\n\nEncode spans relative to the enclosing item\n\nThe aim of this PR is to avoid recomputing queries when code is moved without modification.\n\nMCP at https://github.com/rust-lang/compiler-team/issues/443\n\nThis is achieved by :\n1. storing the HIR owner LocalDefId information inside the span;\n2. encoding and decoding spans relative to the enclosing item in the incremental on-disk cache;\n3. marking a dependency to the `source_span(LocalDefId)` query when we translate a span from the short (`Span`) representation to its explicit (`SpanData`) representation.\n\nSince all client code uses `Span`, step 3 ensures that all manipulations\nof span byte positions actually create the dependency edge between\nthe caller and the `source_span(LocalDefId)`.\nThis query return the actual absolute span of the parent item.\nAs a consequence, any source code motion that changes the absolute byte position of a node will either:\n- modify the distance to the parent's beginning, so change the relative span's hash;\n- dirty `source_span`, and trigger the incremental recomputation of all code that\n  depends on the span's absolute byte position.\n\nWith this scheme, I believe the dependency tracking to be accurate.\n\nFor the moment, the spans are marked during lowering.\nI'd rather do this during def-collection,\nbut the AST MutVisitor is not practical enough just yet.\nThe only difference is that we attach macro-expanded spans\nto their expansion point instead of the macro itself.", "tree": {"sha": "377f5e7bbeae8d9f83c1ac2f839c7f7f4fe1e770", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/377f5e7bbeae8d9f83c1ac2f839c7f7f4fe1e770"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e6455ea72ca3a4602f6a6b097cb80647a1f69388", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e6455ea72ca3a4602f6a6b097cb80647a1f69388", "html_url": "https://github.com/rust-lang/rust/commit/e6455ea72ca3a4602f6a6b097cb80647a1f69388", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e6455ea72ca3a4602f6a6b097cb80647a1f69388/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "eac0b26015ac0e4f8f025e82b3568ab5a85c2746", "url": "https://api.github.com/repos/rust-lang/rust/commits/eac0b26015ac0e4f8f025e82b3568ab5a85c2746", "html_url": "https://github.com/rust-lang/rust/commit/eac0b26015ac0e4f8f025e82b3568ab5a85c2746"}, {"sha": "ce1da849b04bfa3847fbb4130424cac8cd51a227", "url": "https://api.github.com/repos/rust-lang/rust/commits/ce1da849b04bfa3847fbb4130424cac8cd51a227", "html_url": "https://github.com/rust-lang/rust/commit/ce1da849b04bfa3847fbb4130424cac8cd51a227"}], "stats": {"total": 23, "additions": 13, "deletions": 10}, "files": [{"sha": "2ef7dcc1775a6bfe9d6bf2d6784389c7839ff993", "filename": "clippy_lints/src/attrs.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/e6455ea72ca3a4602f6a6b097cb80647a1f69388/clippy_lints%2Fsrc%2Fattrs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e6455ea72ca3a4602f6a6b097cb80647a1f69388/clippy_lints%2Fsrc%2Fattrs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fattrs.rs?ref=e6455ea72ca3a4602f6a6b097cb80647a1f69388", "patch": "@@ -527,8 +527,8 @@ fn check_empty_line_after_outer_attr(cx: &EarlyContext<'_>, item: &rustc_ast::It\n                 return;\n             }\n \n-            let begin_of_attr_to_item = Span::new(attr.span.lo(), item.span.lo(), item.span.ctxt());\n-            let end_of_attr_to_item = Span::new(attr.span.hi(), item.span.lo(), item.span.ctxt());\n+            let begin_of_attr_to_item = Span::new(attr.span.lo(), item.span.lo(), item.span.ctxt(), item.span.parent());\n+            let end_of_attr_to_item = Span::new(attr.span.hi(), item.span.lo(), item.span.ctxt(), item.span.parent());\n \n             if let Some(snippet) = snippet_opt(cx, end_of_attr_to_item) {\n                 let lines = snippet.split('\\n').collect::<Vec<_>>();"}, {"sha": "2203d1c39f1793e6c517b7db92f3baf19c6d691f", "filename": "clippy_lints/src/cognitive_complexity.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e6455ea72ca3a4602f6a6b097cb80647a1f69388/clippy_lints%2Fsrc%2Fcognitive_complexity.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e6455ea72ca3a4602f6a6b097cb80647a1f69388/clippy_lints%2Fsrc%2Fcognitive_complexity.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fcognitive_complexity.rs?ref=e6455ea72ca3a4602f6a6b097cb80647a1f69388", "patch": "@@ -95,7 +95,7 @@ impl CognitiveComplexity {\n                     });\n \n                     if let Some((low, high)) = pos {\n-                        Span::new(low, high, header_span.ctxt())\n+                        Span::new(low, high, header_span.ctxt(), header_span.parent())\n                     } else {\n                         return;\n                     }"}, {"sha": "6ded2f233efea615f800800a41ffd3fda50a563a", "filename": "clippy_lints/src/copies.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e6455ea72ca3a4602f6a6b097cb80647a1f69388/clippy_lints%2Fsrc%2Fcopies.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e6455ea72ca3a4602f6a6b097cb80647a1f69388/clippy_lints%2Fsrc%2Fcopies.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fcopies.rs?ref=e6455ea72ca3a4602f6a6b097cb80647a1f69388", "patch": "@@ -472,7 +472,7 @@ fn emit_branches_sharing_code_lint(\n \n         let mut span = moved_start.to(span_end);\n         // Improve formatting if the inner block has indention (i.e. normal Rust formatting)\n-        let test_span = Span::new(span.lo() - BytePos(4), span.lo(), span.ctxt());\n+        let test_span = Span::new(span.lo() - BytePos(4), span.lo(), span.ctxt(), span.parent());\n         if snippet_opt(cx, test_span)\n             .map(|snip| snip == \"    \")\n             .unwrap_or_default()"}, {"sha": "0b61909ddd82d5f7df7a29342aad3eaeabf2a893", "filename": "clippy_lints/src/doc.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/e6455ea72ca3a4602f6a6b097cb80647a1f69388/clippy_lints%2Fsrc%2Fdoc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e6455ea72ca3a4602f6a6b097cb80647a1f69388/clippy_lints%2Fsrc%2Fdoc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fdoc.rs?ref=e6455ea72ca3a4602f6a6b097cb80647a1f69388", "patch": "@@ -665,6 +665,7 @@ fn check_text(cx: &LateContext<'_>, valid_idents: &FxHashSet<String>, text: &str\n             span.lo() + BytePos::from_usize(offset),\n             span.lo() + BytePos::from_usize(offset + word.len()),\n             span.ctxt(),\n+            span.parent(),\n         );\n \n         check_word(cx, word, span);"}, {"sha": "2fe32fcf6651a8b67420a4fc798d8b2326f9aba4", "filename": "clippy_lints/src/implicit_hasher.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/e6455ea72ca3a4602f6a6b097cb80647a1f69388/clippy_lints%2Fsrc%2Fimplicit_hasher.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e6455ea72ca3a4602f6a6b097cb80647a1f69388/clippy_lints%2Fsrc%2Fimplicit_hasher.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fimplicit_hasher.rs?ref=e6455ea72ca3a4602f6a6b097cb80647a1f69388", "patch": "@@ -130,7 +130,7 @@ impl<'tcx> LateLintPass<'tcx> for ImplicitHasher {\n                         let pos = snippet_opt(cx, item.span.until(target.span()))\n                             .and_then(|snip| Some(item.span.lo() + BytePos(snip.find(\"impl\")? as u32 + 4)));\n                         if let Some(pos) = pos {\n-                            Span::new(pos, pos, item.span.data().ctxt)\n+                            Span::new(pos, pos, item.span.ctxt(), item.span.parent())\n                         } else {\n                             return;\n                         }\n@@ -173,7 +173,7 @@ impl<'tcx> LateLintPass<'tcx> for ImplicitHasher {\n                                     Some(item.span.lo() + BytePos((i + (&snip[i..]).find('(')?) as u32))\n                                 })\n                                 .expect(\"failed to create span for type parameters\");\n-                            Span::new(pos, pos, item.span.data().ctxt)\n+                            Span::new(pos, pos, item.span.ctxt(), item.span.parent())\n                         });\n \n                         let mut ctr_vis = ImplicitHasherConstructorVisitor::new(cx, target);"}, {"sha": "fe6814e35d0ca1da4475f6428eb0c3fcd8186ec9", "filename": "clippy_lints/src/large_const_arrays.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/e6455ea72ca3a4602f6a6b097cb80647a1f69388/clippy_lints%2Fsrc%2Flarge_const_arrays.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e6455ea72ca3a4602f6a6b097cb80647a1f69388/clippy_lints%2Fsrc%2Flarge_const_arrays.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flarge_const_arrays.rs?ref=e6455ea72ca3a4602f6a6b097cb80647a1f69388", "patch": "@@ -63,6 +63,7 @@ impl<'tcx> LateLintPass<'tcx> for LargeConstArrays {\n                     hi_pos - BytePos::from_usize(\"const\".len()),\n                     hi_pos,\n                     item.span.ctxt(),\n+                    item.span.parent(),\n                 );\n                 span_lint_and_then(\n                     cx,"}, {"sha": "001676503242b50b3b7e01b69ebb75896646afac", "filename": "clippy_lints/src/methods/manual_split_once.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e6455ea72ca3a4602f6a6b097cb80647a1f69388/clippy_lints%2Fsrc%2Fmethods%2Fmanual_split_once.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e6455ea72ca3a4602f6a6b097cb80647a1f69388/clippy_lints%2Fsrc%2Fmethods%2Fmanual_split_once.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmethods%2Fmanual_split_once.rs?ref=e6455ea72ca3a4602f6a6b097cb80647a1f69388", "patch": "@@ -182,7 +182,7 @@ fn parse_iter_usage(\n                 },\n                 _,\n             ) => {\n-                let parent_span = e.span.parent().unwrap();\n+                let parent_span = e.span.parent_callsite().unwrap();\n                 if parent_span.ctxt() == ctxt {\n                     (Some(UnwrapKind::QuestionMark), parent_span)\n                 } else {"}, {"sha": "f351d0098b7509cf6abdddfef53c21a29cc7a663", "filename": "clippy_lints/src/module_style.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/e6455ea72ca3a4602f6a6b097cb80647a1f69388/clippy_lints%2Fsrc%2Fmodule_style.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e6455ea72ca3a4602f6a6b097cb80647a1f69388/clippy_lints%2Fsrc%2Fmodule_style.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmodule_style.rs?ref=e6455ea72ca3a4602f6a6b097cb80647a1f69388", "patch": "@@ -120,7 +120,7 @@ impl EarlyLintPass for ModStyle {\n                     correct.push(\"mod.rs\");\n                     cx.struct_span_lint(\n                         SELF_NAMED_MODULE_FILES,\n-                        Span::new(file.start_pos, file.start_pos, SyntaxContext::root()),\n+                        Span::new(file.start_pos, file.start_pos, SyntaxContext::root(), None),\n                         |build| {\n                             let mut lint =\n                                 build.build(&format!(\"`mod.rs` files are required, found `{}`\", path.display()));\n@@ -167,7 +167,7 @@ fn check_self_named_mod_exists(cx: &EarlyContext<'_>, path: &Path, file: &Source\n \n         cx.struct_span_lint(\n             MOD_MODULE_FILES,\n-            Span::new(file.start_pos, file.start_pos, SyntaxContext::root()),\n+            Span::new(file.start_pos, file.start_pos, SyntaxContext::root(), None),\n             |build| {\n                 let mut lint = build.build(&format!(\"`mod.rs` files are not allowed, found `{}`\", path.display()));\n                 lint.help(&format!(\"move `{}` to `{}`\", path.display(), mod_file.display(),));"}, {"sha": "947c25ac880565cb946c4872e40e95641e2e293c", "filename": "clippy_lints/src/regex.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e6455ea72ca3a4602f6a6b097cb80647a1f69388/clippy_lints%2Fsrc%2Fregex.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e6455ea72ca3a4602f6a6b097cb80647a1f69388/clippy_lints%2Fsrc%2Fregex.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fregex.rs?ref=e6455ea72ca3a4602f6a6b097cb80647a1f69388", "patch": "@@ -87,7 +87,7 @@ fn str_span(base: Span, c: regex_syntax::ast::Span, offset: u16) -> Span {\n     let end = base.lo() + BytePos(u32::try_from(c.end.offset).expect(\"offset too large\") + offset);\n     let start = base.lo() + BytePos(u32::try_from(c.start.offset).expect(\"offset too large\") + offset);\n     assert!(start <= end);\n-    Span::new(start, end, base.ctxt())\n+    Span::new(start, end, base.ctxt(), base.parent())\n }\n \n fn const_str<'tcx>(cx: &LateContext<'tcx>, e: &'tcx Expr<'_>) -> Option<String> {"}, {"sha": "4a67cabf323a6a1489f84d485bce350acc98a8cf", "filename": "clippy_lints/src/tabs_in_doc_comments.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/e6455ea72ca3a4602f6a6b097cb80647a1f69388/clippy_lints%2Fsrc%2Ftabs_in_doc_comments.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e6455ea72ca3a4602f6a6b097cb80647a1f69388/clippy_lints%2Fsrc%2Ftabs_in_doc_comments.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Ftabs_in_doc_comments.rs?ref=e6455ea72ca3a4602f6a6b097cb80647a1f69388", "patch": "@@ -69,6 +69,7 @@ impl TabsInDocComments {\n                     attr.span.lo() + BytePos(3 + lo),\n                     attr.span.lo() + BytePos(3 + hi),\n                     attr.span.ctxt(),\n+                    attr.span.parent(),\n                 );\n                 span_lint_and_sugg(\n                     cx,"}]}