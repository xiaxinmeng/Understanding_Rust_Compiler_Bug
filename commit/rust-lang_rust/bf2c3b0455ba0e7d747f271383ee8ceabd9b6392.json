{"sha": "bf2c3b0455ba0e7d747f271383ee8ceabd9b6392", "node_id": "C_kwDOAAsO6NoAKGJmMmMzYjA0NTViYTBlN2Q3NDdmMjcxMzgzZWU4Y2VhYmQ5YjYzOTI", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume.gomez@huawei.com", "date": "2022-04-04T13:17:55Z"}, "committer": {"name": "Guillaume Gomez", "email": "guillaume.gomez@huawei.com", "date": "2022-04-04T15:36:56Z"}, "message": "Fix ICE in rustdoc intra doc links when trying to get traits in scope for a private module", "tree": {"sha": "f1444d4ed3c3cda4283ba625a72bc38efa6af5a9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f1444d4ed3c3cda4283ba625a72bc38efa6af5a9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bf2c3b0455ba0e7d747f271383ee8ceabd9b6392", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bf2c3b0455ba0e7d747f271383ee8ceabd9b6392", "html_url": "https://github.com/rust-lang/rust/commit/bf2c3b0455ba0e7d747f271383ee8ceabd9b6392", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bf2c3b0455ba0e7d747f271383ee8ceabd9b6392/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2ed6786404be276874fbcc7c3540f3237a87e0f3", "url": "https://api.github.com/repos/rust-lang/rust/commits/2ed6786404be276874fbcc7c3540f3237a87e0f3", "html_url": "https://github.com/rust-lang/rust/commit/2ed6786404be276874fbcc7c3540f3237a87e0f3"}], "stats": {"total": 13, "additions": 11, "deletions": 2}, "files": [{"sha": "1d7a790bdb786e5fc30017f4c4bdb21d4661d053", "filename": "src/librustdoc/lib.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/bf2c3b0455ba0e7d747f271383ee8ceabd9b6392/src%2Flibrustdoc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bf2c3b0455ba0e7d747f271383ee8ceabd9b6392/src%2Flibrustdoc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Flib.rs?ref=bf2c3b0455ba0e7d747f271383ee8ceabd9b6392", "patch": "@@ -771,6 +771,7 @@ fn main_options(options: config::Options) -> MainResult {\n     let externs = options.externs.clone();\n     let render_options = options.render_options.clone();\n     let scrape_examples_options = options.scrape_examples_options.clone();\n+    let document_private = options.render_options.document_private;\n     let config = core::create_config(options);\n \n     interface::create_compiler_and_run(config, |compiler| {\n@@ -791,7 +792,12 @@ fn main_options(options: config::Options) -> MainResult {\n             let (resolver, resolver_caches) = {\n                 let (krate, resolver, _) = &*abort_on_err(queries.expansion(), sess).peek();\n                 let resolver_caches = resolver.borrow_mut().access(|resolver| {\n-                    collect_intra_doc_links::early_resolve_intra_doc_links(resolver, krate, externs)\n+                    collect_intra_doc_links::early_resolve_intra_doc_links(\n+                        resolver,\n+                        krate,\n+                        externs,\n+                        document_private,\n+                    )\n                 });\n                 (resolver.clone(), resolver_caches)\n             };"}, {"sha": "d712ec8aa6ab725d7371abda55d13c18a946ab19", "filename": "src/librustdoc/passes/collect_intra_doc_links/early.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/bf2c3b0455ba0e7d747f271383ee8ceabd9b6392/src%2Flibrustdoc%2Fpasses%2Fcollect_intra_doc_links%2Fearly.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bf2c3b0455ba0e7d747f271383ee8ceabd9b6392/src%2Flibrustdoc%2Fpasses%2Fcollect_intra_doc_links%2Fearly.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fcollect_intra_doc_links%2Fearly.rs?ref=bf2c3b0455ba0e7d747f271383ee8ceabd9b6392", "patch": "@@ -22,6 +22,7 @@ crate fn early_resolve_intra_doc_links(\n     resolver: &mut Resolver<'_>,\n     krate: &ast::Crate,\n     externs: Externs,\n+    document_private_items: bool,\n ) -> ResolverCaches {\n     let mut loader = IntraLinkCrateLoader {\n         resolver,\n@@ -30,6 +31,7 @@ crate fn early_resolve_intra_doc_links(\n         traits_in_scope: Default::default(),\n         all_traits: Default::default(),\n         all_trait_impls: Default::default(),\n+        document_private_items,\n     };\n \n     // Because of the `crate::` prefix, any doc comment can reference\n@@ -66,6 +68,7 @@ struct IntraLinkCrateLoader<'r, 'ra> {\n     traits_in_scope: DefIdMap<Vec<TraitCandidate>>,\n     all_traits: Vec<DefId>,\n     all_trait_impls: Vec<DefId>,\n+    document_private_items: bool,\n }\n \n impl IntraLinkCrateLoader<'_, '_> {\n@@ -175,7 +178,7 @@ impl IntraLinkCrateLoader<'_, '_> {\n         }\n \n         for child in self.resolver.module_children_or_reexports(module_id) {\n-            if child.vis == Visibility::Public {\n+            if child.vis == Visibility::Public || self.document_private_items {\n                 if let Some(def_id) = child.res.opt_def_id() {\n                     self.add_traits_in_parent_scope(def_id);\n                 }"}]}