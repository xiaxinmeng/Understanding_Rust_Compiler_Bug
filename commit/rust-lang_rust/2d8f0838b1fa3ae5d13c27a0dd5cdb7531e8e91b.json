{"sha": "2d8f0838b1fa3ae5d13c27a0dd5cdb7531e8e91b", "node_id": "C_kwDOAAsO6NoAKDJkOGYwODM4YjFmYTNhZTVkMTNjMjdhMGRkNWNkYjc1MzFlOGU5MWI", "commit": {"author": {"name": "Dylan DPC", "email": "99973273+Dylan-DPC@users.noreply.github.com", "date": "2022-11-05T06:01:29Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-11-05T06:01:29Z"}, "message": "Rollup merge of #103867 - compiler-errors:no-has-errors, r=cjgillot\n\nRemove `has_errors` from `FnCtxt`\n\nIt doesn't seem like this `has_errors` flag actually suppresses any errors (at least in the UI test suite) --- except for one test (`E0767.rs`), and I think that error really should be considered legitimate, since it has nothing to do with the error code and continues to exist after you fix the first error...\n\nThis flag was added by ```@eddyb``` in 6b3cc0b8c8094407a3b5ea75f946c682d6d0142a, and it's likely that it was made redundant due to subsequent restructuring of the compiler.\n\nIt only affects block type-checking anyways, so its effect does seem limited these days anyway.", "tree": {"sha": "6977cc88894a6759edcf3c6d08600e4326b0202e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6977cc88894a6759edcf3c6d08600e4326b0202e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2d8f0838b1fa3ae5d13c27a0dd5cdb7531e8e91b", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjZfw5CRBK7hj4Ov3rIwAAryAIAGTAmJ6UBeBge/l+FinNTKjE\nrOl4Ye4Zw1POsEcohV0j01g0bisPrtpQMMcagRtfIV6mXRbcvAGj781smgDLIKef\nvZSMeJNna0vHeRdFHX3BqCNCORIcPU94WH95/9vMJN1F2qSbCH6WtzjzZOpBb6Av\ntzuajM9e7+4KYilPCUfYxWS2In7H4JBh4u7luICTJAvqryt42dD6zAYsjDpj84OV\n/tFF4/Flkp2fR0UTAQ+WOSQrrVzczy/k2t0nP6W+FBBm2+Z2k2yINbuZlQI91Ypk\nE77g3GUGUWU0YXDt+durVtHJJ6L/vhVeS7J0vwBZiF83HKYFOXB0fJWrmuwbjYA=\n=uWSt\n-----END PGP SIGNATURE-----\n", "payload": "tree 6977cc88894a6759edcf3c6d08600e4326b0202e\nparent 9e67f6a68d6a46fd40cc277ddf0dd1c98fd56777\nparent 74fec9b95ad308c3dc064bb38778aea4ec51f5ee\nauthor Dylan DPC <99973273+Dylan-DPC@users.noreply.github.com> 1667628089 +0530\ncommitter GitHub <noreply@github.com> 1667628089 +0530\n\nRollup merge of #103867 - compiler-errors:no-has-errors, r=cjgillot\n\nRemove `has_errors` from `FnCtxt`\n\nIt doesn't seem like this `has_errors` flag actually suppresses any errors (at least in the UI test suite) --- except for one test (`E0767.rs`), and I think that error really should be considered legitimate, since it has nothing to do with the error code and continues to exist after you fix the first error...\n\nThis flag was added by ```@eddyb``` in 6b3cc0b8c8094407a3b5ea75f946c682d6d0142a, and it's likely that it was made redundant due to subsequent restructuring of the compiler.\n\nIt only affects block type-checking anyways, so its effect does seem limited these days anyway.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2d8f0838b1fa3ae5d13c27a0dd5cdb7531e8e91b", "html_url": "https://github.com/rust-lang/rust/commit/2d8f0838b1fa3ae5d13c27a0dd5cdb7531e8e91b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2d8f0838b1fa3ae5d13c27a0dd5cdb7531e8e91b/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9e67f6a68d6a46fd40cc277ddf0dd1c98fd56777", "url": "https://api.github.com/repos/rust-lang/rust/commits/9e67f6a68d6a46fd40cc277ddf0dd1c98fd56777", "html_url": "https://github.com/rust-lang/rust/commit/9e67f6a68d6a46fd40cc277ddf0dd1c98fd56777"}, {"sha": "74fec9b95ad308c3dc064bb38778aea4ec51f5ee", "url": "https://api.github.com/repos/rust-lang/rust/commits/74fec9b95ad308c3dc064bb38778aea4ec51f5ee", "html_url": "https://github.com/rust-lang/rust/commit/74fec9b95ad308c3dc064bb38778aea4ec51f5ee"}], "stats": {"total": 39, "additions": 20, "deletions": 19}, "files": [{"sha": "682dbab56bc15b0c63d91c21c415327fdb369308", "filename": "compiler/rustc_hir_typeck/src/expr.rs", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/2d8f0838b1fa3ae5d13c27a0dd5cdb7531e8e91b/compiler%2Frustc_hir_typeck%2Fsrc%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2d8f0838b1fa3ae5d13c27a0dd5cdb7531e8e91b/compiler%2Frustc_hir_typeck%2Fsrc%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_typeck%2Fsrc%2Fexpr.rs?ref=2d8f0838b1fa3ae5d13c27a0dd5cdb7531e8e91b", "patch": "@@ -220,7 +220,6 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n \n         // Hide the outer diverging and has_errors flags.\n         let old_diverges = self.diverges.replace(Diverges::Maybe);\n-        let old_has_errors = self.has_errors.replace(false);\n \n         let ty = ensure_sufficient_stack(|| match &expr.kind {\n             hir::ExprKind::Path(\n@@ -259,7 +258,6 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n \n         // Combine the diverging and has_error flags.\n         self.diverges.set(self.diverges.get() | old_diverges);\n-        self.has_errors.set(self.has_errors.get() | old_has_errors);\n \n         debug!(\"type of {} is...\", self.tcx.hir().node_to_string(expr.hir_id));\n         debug!(\"... {:?}, expected is {:?}\", ty, expected);"}, {"sha": "7563c543d3f19d55adc0e4a417115638ac7a7101", "filename": "compiler/rustc_hir_typeck/src/fn_ctxt/_impl.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/2d8f0838b1fa3ae5d13c27a0dd5cdb7531e8e91b/compiler%2Frustc_hir_typeck%2Fsrc%2Ffn_ctxt%2F_impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2d8f0838b1fa3ae5d13c27a0dd5cdb7531e8e91b/compiler%2Frustc_hir_typeck%2Fsrc%2Ffn_ctxt%2F_impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_typeck%2Fsrc%2Ffn_ctxt%2F_impl.rs?ref=2d8f0838b1fa3ae5d13c27a0dd5cdb7531e8e91b", "patch": "@@ -143,7 +143,6 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         self.typeck_results.borrow_mut().node_types_mut().insert(id, ty);\n \n         if ty.references_error() {\n-            self.has_errors.set(true);\n             self.set_tainted_by_errors();\n         }\n     }"}, {"sha": "e1955d838f253ebb2c524d5bf9c9ab88761a2037", "filename": "compiler/rustc_hir_typeck/src/fn_ctxt/checks.rs", "status": "modified", "additions": 1, "deletions": 7, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/2d8f0838b1fa3ae5d13c27a0dd5cdb7531e8e91b/compiler%2Frustc_hir_typeck%2Fsrc%2Ffn_ctxt%2Fchecks.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2d8f0838b1fa3ae5d13c27a0dd5cdb7531e8e91b/compiler%2Frustc_hir_typeck%2Fsrc%2Ffn_ctxt%2Fchecks.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_typeck%2Fsrc%2Ffn_ctxt%2Fchecks.rs?ref=2d8f0838b1fa3ae5d13c27a0dd5cdb7531e8e91b", "patch": "@@ -1334,7 +1334,6 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n \n         // Hide the outer diverging and `has_errors` flags.\n         let old_diverges = self.diverges.replace(Diverges::Maybe);\n-        let old_has_errors = self.has_errors.replace(false);\n \n         match stmt.kind {\n             hir::StmtKind::Local(l) => {\n@@ -1364,7 +1363,6 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n \n         // Combine the diverging and `has_error` flags.\n         self.diverges.set(self.diverges.get() | old_diverges);\n-        self.has_errors.set(self.has_errors.get() | old_has_errors);\n     }\n \n     pub fn check_block_no_value(&self, blk: &'tcx hir::Block<'tcx>) {\n@@ -1544,11 +1542,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n             self.diverges.set(prev_diverges);\n         }\n \n-        let mut ty = ctxt.coerce.unwrap().complete(self);\n-\n-        if self.has_errors.get() || ty.references_error() {\n-            ty = self.tcx.ty_error()\n-        }\n+        let ty = ctxt.coerce.unwrap().complete(self);\n \n         self.write_ty(blk.hir_id, ty);\n "}, {"sha": "72388baa261eae30def6f8dc8d449343b814c6ad", "filename": "compiler/rustc_hir_typeck/src/fn_ctxt/mod.rs", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/2d8f0838b1fa3ae5d13c27a0dd5cdb7531e8e91b/compiler%2Frustc_hir_typeck%2Fsrc%2Ffn_ctxt%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2d8f0838b1fa3ae5d13c27a0dd5cdb7531e8e91b/compiler%2Frustc_hir_typeck%2Fsrc%2Ffn_ctxt%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_typeck%2Fsrc%2Ffn_ctxt%2Fmod.rs?ref=2d8f0838b1fa3ae5d13c27a0dd5cdb7531e8e91b", "patch": "@@ -112,9 +112,6 @@ pub struct FnCtxt<'a, 'tcx> {\n     /// the diverges flag is set to something other than `Maybe`.\n     pub(super) diverges: Cell<Diverges>,\n \n-    /// Whether any child nodes have any type errors.\n-    pub(super) has_errors: Cell<bool>,\n-\n     pub(super) enclosing_breakables: RefCell<EnclosingBreakables<'tcx>>,\n \n     pub(super) inh: &'a Inherited<'tcx>,\n@@ -136,7 +133,6 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n             resume_yield_tys: None,\n             ps: Cell::new(UnsafetyState::function(hir::Unsafety::Normal, hir::CRATE_HIR_ID)),\n             diverges: Cell::new(Diverges::Maybe),\n-            has_errors: Cell::new(false),\n             enclosing_breakables: RefCell::new(EnclosingBreakables {\n                 stack: Vec::new(),\n                 by_id: Default::default(),"}, {"sha": "14215d36a3833ce8f2874609c3cb5e7c3ed9dae9", "filename": "src/test/ui/error-codes/E0767.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/2d8f0838b1fa3ae5d13c27a0dd5cdb7531e8e91b/src%2Ftest%2Fui%2Ferror-codes%2FE0767.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2d8f0838b1fa3ae5d13c27a0dd5cdb7531e8e91b/src%2Ftest%2Fui%2Ferror-codes%2FE0767.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ferror-codes%2FE0767.rs?ref=2d8f0838b1fa3ae5d13c27a0dd5cdb7531e8e91b", "patch": "@@ -1,6 +1,7 @@\n-fn main () {\n+fn main() {\n     'a: loop {\n         || {\n+            //~^ ERROR mismatched types\n             loop { break 'a; } //~ ERROR E0767\n         }\n     }"}, {"sha": "ee85247301c9ccba15d775daa7d9169d8e3de468", "filename": "src/test/ui/error-codes/E0767.stderr", "status": "modified", "additions": 17, "deletions": 4, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/2d8f0838b1fa3ae5d13c27a0dd5cdb7531e8e91b/src%2Ftest%2Fui%2Ferror-codes%2FE0767.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2d8f0838b1fa3ae5d13c27a0dd5cdb7531e8e91b/src%2Ftest%2Fui%2Ferror-codes%2FE0767.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ferror-codes%2FE0767.stderr?ref=2d8f0838b1fa3ae5d13c27a0dd5cdb7531e8e91b", "patch": "@@ -1,14 +1,27 @@\n error[E0767]: use of unreachable label `'a`\n-  --> $DIR/E0767.rs:4:26\n+  --> $DIR/E0767.rs:5:26\n    |\n LL |     'a: loop {\n    |     -- unreachable label defined here\n-LL |         || {\n+...\n LL |             loop { break 'a; }\n    |                          ^^ unreachable label `'a`\n    |\n    = note: labels are unreachable through functions, closures, async blocks and modules\n \n-error: aborting due to previous error\n+error[E0308]: mismatched types\n+  --> $DIR/E0767.rs:3:9\n+   |\n+LL | /         || {\n+LL | |\n+LL | |             loop { break 'a; }\n+LL | |         }\n+   | |_________^ expected `()`, found closure\n+   |\n+   = note: expected unit type `()`\n+                found closure `[closure@$DIR/E0767.rs:3:9: 3:11]`\n+\n+error: aborting due to 2 previous errors\n \n-For more information about this error, try `rustc --explain E0767`.\n+Some errors have detailed explanations: E0308, E0767.\n+For more information about an error, try `rustc --explain E0308`."}]}