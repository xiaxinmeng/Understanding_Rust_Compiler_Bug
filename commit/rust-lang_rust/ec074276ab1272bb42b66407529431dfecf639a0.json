{"sha": "ec074276ab1272bb42b66407529431dfecf639a0", "node_id": "MDY6Q29tbWl0NzI0NzEyOmVjMDc0Mjc2YWIxMjcyYmI0MmI2NjQwNzUyOTQzMWRmZWNmNjM5YTA=", "commit": {"author": {"name": "Yuki Okushi", "email": "huyuumi.dev@gmail.com", "date": "2021-03-16T14:54:03Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-03-16T14:54:03Z"}, "message": "Rollup merge of #83196 - tmiasko:valid-range-delay-span-bug, r=oli-obk\n\nUse delay_span_bug instead of panic in layout_scalar_valid_range\n\n#83054 introduced validation of scalar range attributes, but panicking\ncode that uses the attribute remained reachable. Use `delay_span_bug`\ninstead to avoid the ICE.\n\nFixes #83180.", "tree": {"sha": "b958b90861f439b1a0009d2cf852fa24afff63f8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b958b90861f439b1a0009d2cf852fa24afff63f8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ec074276ab1272bb42b66407529431dfecf639a0", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgUMaMCRBK7hj4Ov3rIwAAdHIIAD6YA/kwVFW+yGN01SQcMiUx\nZ/Ruqmm8iOVHLk4g6sijLD3HaxjPUqd6tStUt2R/sSeNhbrkD35puFpDCfjq18Fw\nngVmWX84iH8+lUvo5C12bJspCnKbT9GS5kqbPYBhxyJIOXZBcQnmH/K1Z8IgMQau\nLwAkgRgxBVn9rzq+9SqVJkXhiysSyLM3KKOFFpwrZT4Omz4L3hXyr8JyX/MSvSbr\n+KSj7ewPxR6YEX8KdOPxaMJTmnIDa8JFFQQTWivJkelPEildPVqThc1dyohsH8Ui\napRm/SfqFonqRKvTxSz43Z5ZxIDPFWbGCjLJSvhsDNL1/7DqKuJIHDiIFkbaGMs=\n=P6Ff\n-----END PGP SIGNATURE-----\n", "payload": "tree b958b90861f439b1a0009d2cf852fa24afff63f8\nparent b62997fd2478999cdf3439024576052d22a5e983\nparent 335427a3db8fcdbddece8c7257e0ab40c8230d73\nauthor Yuki Okushi <huyuumi.dev@gmail.com> 1615906443 +0900\ncommitter GitHub <noreply@github.com> 1615906443 +0900\n\nRollup merge of #83196 - tmiasko:valid-range-delay-span-bug, r=oli-obk\n\nUse delay_span_bug instead of panic in layout_scalar_valid_range\n\n#83054 introduced validation of scalar range attributes, but panicking\ncode that uses the attribute remained reachable. Use `delay_span_bug`\ninstead to avoid the ICE.\n\nFixes #83180.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ec074276ab1272bb42b66407529431dfecf639a0", "html_url": "https://github.com/rust-lang/rust/commit/ec074276ab1272bb42b66407529431dfecf639a0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ec074276ab1272bb42b66407529431dfecf639a0/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b62997fd2478999cdf3439024576052d22a5e983", "url": "https://api.github.com/repos/rust-lang/rust/commits/b62997fd2478999cdf3439024576052d22a5e983", "html_url": "https://github.com/rust-lang/rust/commit/b62997fd2478999cdf3439024576052d22a5e983"}, {"sha": "335427a3db8fcdbddece8c7257e0ab40c8230d73", "url": "https://api.github.com/repos/rust-lang/rust/commits/335427a3db8fcdbddece8c7257e0ab40c8230d73", "html_url": "https://github.com/rust-lang/rust/commit/335427a3db8fcdbddece8c7257e0ab40c8230d73"}], "stats": {"total": 30, "additions": 23, "deletions": 7}, "files": [{"sha": "d5ad459126070d158bfe47fe053ccd76754dda1d", "filename": "compiler/rustc_middle/src/ty/context.rs", "status": "modified", "additions": 9, "deletions": 6, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/ec074276ab1272bb42b66407529431dfecf639a0/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ec074276ab1272bb42b66407529431dfecf639a0/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs?ref=ec074276ab1272bb42b66407529431dfecf639a0", "patch": "@@ -1091,13 +1091,16 @@ impl<'tcx> TyCtxt<'tcx> {\n                 None => return Bound::Unbounded,\n             };\n             debug!(\"layout_scalar_valid_range: attr={:?}\", attr);\n-            for meta in attr.meta_item_list().expect(\"rustc_layout_scalar_valid_range takes args\") {\n-                match meta.literal().expect(\"attribute takes lit\").kind {\n-                    ast::LitKind::Int(a, _) => return Bound::Included(a),\n-                    _ => span_bug!(attr.span, \"rustc_layout_scalar_valid_range expects int arg\"),\n-                }\n+            if let Some(\n+                &[ast::NestedMetaItem::Literal(ast::Lit { kind: ast::LitKind::Int(a, _), .. })],\n+            ) = attr.meta_item_list().as_deref()\n+            {\n+                Bound::Included(a)\n+            } else {\n+                self.sess\n+                    .delay_span_bug(attr.span, \"invalid rustc_layout_scalar_valid_range attribute\");\n+                Bound::Unbounded\n             }\n-            span_bug!(attr.span, \"no arguments to `rustc_layout_scalar_valid_range` attribute\");\n         };\n         (\n             get(sym::rustc_layout_scalar_valid_range_start),"}, {"sha": "06cf8c0f0f6d51d4ca63ef5b13e90deca07d31ad", "filename": "src/test/ui/invalid/invalid_rustc_layout_scalar_valid_range.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/ec074276ab1272bb42b66407529431dfecf639a0/src%2Ftest%2Fui%2Finvalid%2Finvalid_rustc_layout_scalar_valid_range.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ec074276ab1272bb42b66407529431dfecf639a0/src%2Ftest%2Fui%2Finvalid%2Finvalid_rustc_layout_scalar_valid_range.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Finvalid%2Finvalid_rustc_layout_scalar_valid_range.rs?ref=ec074276ab1272bb42b66407529431dfecf639a0", "patch": "@@ -15,6 +15,13 @@ enum E {\n     Y = 14,\n }\n \n+#[rustc_layout_scalar_valid_range_start(rustc_layout_scalar_valid_range_start)] //~ ERROR\n+struct NonZero<T>(T);\n+\n+fn not_field() -> impl Send {\n+    NonZero(false)\n+}\n+\n fn main() {\n     let _ = A(0);\n     let _ = B(0);"}, {"sha": "7879e7358c00aed5eae37b33067b6d0472c30d93", "filename": "src/test/ui/invalid/invalid_rustc_layout_scalar_valid_range.stderr", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ec074276ab1272bb42b66407529431dfecf639a0/src%2Ftest%2Fui%2Finvalid%2Finvalid_rustc_layout_scalar_valid_range.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/ec074276ab1272bb42b66407529431dfecf639a0/src%2Ftest%2Fui%2Finvalid%2Finvalid_rustc_layout_scalar_valid_range.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Finvalid%2Finvalid_rustc_layout_scalar_valid_range.stderr?ref=ec074276ab1272bb42b66407529431dfecf639a0", "patch": "@@ -27,5 +27,11 @@ LL | |     Y = 14,\n LL | | }\n    | |_- not a struct\n \n-error: aborting due to 4 previous errors\n+error: expected exactly one integer literal argument\n+  --> $DIR/invalid_rustc_layout_scalar_valid_range.rs:18:1\n+   |\n+LL | #[rustc_layout_scalar_valid_range_start(rustc_layout_scalar_valid_range_start)]\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: aborting due to 5 previous errors\n "}]}