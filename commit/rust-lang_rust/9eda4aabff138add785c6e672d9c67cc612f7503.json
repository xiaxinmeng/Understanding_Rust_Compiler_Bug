{"sha": "9eda4aabff138add785c6e672d9c67cc612f7503", "node_id": "MDY6Q29tbWl0NzI0NzEyOjllZGE0YWFiZmYxMzhhZGQ3ODVjNmU2NzJkOWM2N2NjNjEyZjc1MDM=", "commit": {"author": {"name": "Mark Rousskov", "email": "mark.simulacrum@gmail.com", "date": "2018-07-02T22:04:58Z"}, "committer": {"name": "Mark Rousskov", "email": "mark.simulacrum@gmail.com", "date": "2018-07-02T22:12:56Z"}, "message": "Change --keep-stage to apply more\n\nPreviously, the --keep-stage argument would only function for compilers\nthat were depended on by future stages. For example, if trying to build\na stage 1 compiler you could --keep-stage 0 to avoid re-building the\nstage 0 compiler. However, this is often not what users want in\npractice.\n\nThe new implementation essentially skips builds all higher stages of the\ncompiler, so an argument of 1 to keep-stage will skip rebuilds of the\nlibraries, just linking them into the sysroot. This is unlikely to work\nwell in cases where metadata or similar changes have been made, but is\nlikely fine otherwise.\n\nThis change is somewhat untested, but since it shouldn't have any effect\nexcept with --keep-stage, I don't see that as a large problem.", "tree": {"sha": "7b882625ef2ed45384c6629f2569181a30b646e7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7b882625ef2ed45384c6629f2569181a30b646e7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9eda4aabff138add785c6e672d9c67cc612f7503", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9eda4aabff138add785c6e672d9c67cc612f7503", "html_url": "https://github.com/rust-lang/rust/commit/9eda4aabff138add785c6e672d9c67cc612f7503", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9eda4aabff138add785c6e672d9c67cc612f7503/comments", "author": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f5570d0ef66847d6617682058a9fa680cdce392b", "url": "https://api.github.com/repos/rust-lang/rust/commits/f5570d0ef66847d6617682058a9fa680cdce392b", "html_url": "https://github.com/rust-lang/rust/commit/f5570d0ef66847d6617682058a9fa680cdce392b"}], "stats": {"total": 63, "additions": 43, "deletions": 20}, "files": [{"sha": "aef2df3e2780f40e500c68c766b92851accfebdb", "filename": "src/bootstrap/compile.rs", "status": "modified", "additions": 43, "deletions": 20, "changes": 63, "blob_url": "https://github.com/rust-lang/rust/blob/9eda4aabff138add785c6e672d9c67cc612f7503/src%2Fbootstrap%2Fcompile.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9eda4aabff138add785c6e672d9c67cc612f7503/src%2Fbootstrap%2Fcompile.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcompile.rs?ref=9eda4aabff138add785c6e672d9c67cc612f7503", "patch": "@@ -24,7 +24,6 @@ use std::io::prelude::*;\n use std::path::{Path, PathBuf};\n use std::process::{Command, Stdio};\n use std::str;\n-use std::cmp::min;\n \n use build_helper::{output, mtime, up_to_date};\n use filetime::FileTime;\n@@ -68,6 +67,18 @@ impl Step for Std {\n         let target = self.target;\n         let compiler = self.compiler;\n \n+        if let Some(keep_stage) = builder.config.keep_stage {\n+            if keep_stage <= compiler.stage {\n+                println!(\"Warning: Using a potentially old libstd. This may not behave well.\");\n+                builder.ensure(StdLink {\n+                    compiler: compiler,\n+                    target_compiler: compiler,\n+                    target,\n+                });\n+                return;\n+            }\n+        }\n+\n         builder.ensure(StartupObjects { compiler, target });\n \n         if builder.force_use_stage1(compiler, target) {\n@@ -351,6 +362,18 @@ impl Step for Test {\n         let target = self.target;\n         let compiler = self.compiler;\n \n+        if let Some(keep_stage) = builder.config.keep_stage {\n+            if keep_stage <= compiler.stage {\n+                println!(\"Warning: Using a potentially old libtest. This may not behave well.\");\n+                builder.ensure(TestLink {\n+                    compiler: compiler,\n+                    target_compiler: compiler,\n+                    target,\n+                });\n+                return;\n+            }\n+        }\n+\n         builder.ensure(Std { compiler, target });\n \n         if builder.force_use_stage1(compiler, target) {\n@@ -467,6 +490,18 @@ impl Step for Rustc {\n         let compiler = self.compiler;\n         let target = self.target;\n \n+        if let Some(keep_stage) = builder.config.keep_stage {\n+            if keep_stage <= compiler.stage {\n+                println!(\"Warning: Using a potentially old librustc. This may not behave well.\");\n+                builder.ensure(RustcLink {\n+                    compiler: compiler,\n+                    target_compiler: compiler,\n+                    target,\n+                });\n+                return;\n+            }\n+        }\n+\n         builder.ensure(Test { compiler, target });\n \n         if builder.force_use_stage1(compiler, target) {\n@@ -915,28 +950,16 @@ impl Step for Assemble {\n         // link to these. (FIXME: Is that correct? It seems to be correct most\n         // of the time but I think we do link to these for stage2/bin compilers\n         // when not performing a full bootstrap).\n-        if builder.config.keep_stage.map_or(false, |s| target_compiler.stage <= s) {\n-            builder.verbose(\"skipping compilation of compiler due to --keep-stage\");\n-            let compiler = build_compiler;\n-            for stage in 0..min(target_compiler.stage, builder.config.keep_stage.unwrap()) {\n-                let target_compiler = builder.compiler(stage, target_compiler.host);\n-                let target = target_compiler.host;\n-                builder.ensure(StdLink { compiler, target_compiler, target });\n-                builder.ensure(TestLink { compiler, target_compiler, target });\n-                builder.ensure(RustcLink { compiler, target_compiler, target });\n-            }\n-        } else {\n-            builder.ensure(Rustc {\n+        builder.ensure(Rustc {\n+            compiler: build_compiler,\n+            target: target_compiler.host,\n+        });\n+        for &backend in builder.config.rust_codegen_backends.iter() {\n+            builder.ensure(CodegenBackend {\n                 compiler: build_compiler,\n                 target: target_compiler.host,\n+                backend,\n             });\n-            for &backend in builder.config.rust_codegen_backends.iter() {\n-                builder.ensure(CodegenBackend {\n-                    compiler: build_compiler,\n-                    target: target_compiler.host,\n-                    backend,\n-                });\n-            }\n         }\n \n         let lld_install = if builder.config.lld_enabled {"}]}