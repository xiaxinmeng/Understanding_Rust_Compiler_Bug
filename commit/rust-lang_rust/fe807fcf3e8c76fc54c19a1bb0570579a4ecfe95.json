{"sha": "fe807fcf3e8c76fc54c19a1bb0570579a4ecfe95", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZlODA3ZmNmM2U4Yzc2ZmM1NGMxOWExYmIwNTcwNTc5YTRlY2ZlOTU=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2019-07-07T15:00:18Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-07-07T15:00:18Z"}, "message": "Rollup merge of #62213 - QuietMisdreavus:cfg-doctest, r=GuillaumeGomez\n\nrustdoc: set cfg(doctest) when collecting doctests\n\nNote: This PR builds on top of https://github.com/rust-lang/rust/pull/61199; only the last commit is specific to this PR.\n\nAs discussed in https://github.com/rust-lang/rust/pull/61199, we want the ability to isolate items to only when rustdoc is collecting doctests, but we can't use `cfg(test)` because of libcore's `#![cfg(not(test))]`. This PR proposes a new cfg flag, `cfg(doctest)`, specific to this situation, rather than reusing an existing flag. I've isolated it behind a feature gate so that we can contain the effects to nightly only. (A stable workaround that can be used in lieu of `#[cfg(doctest)]` is `#[cfg(rustdoc)] #[doc(hidden)]`, at least once https://github.com/rust-lang/rust/pull/61351 lands.)\n\nTracking issue: https://github.com/rust-lang/rust/issues/62210", "tree": {"sha": "2d5ad6ab6c856ef8f112b5e957cd0f323829f807", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2d5ad6ab6c856ef8f112b5e957cd0f323829f807"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fe807fcf3e8c76fc54c19a1bb0570579a4ecfe95", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJdIgkCCRBK7hj4Ov3rIwAAdHIIAAJNpwqlu00nHKQkaGVCScL+\n5Oo6HbBTnBVSRxTJORTzjpD3sQxtkQjdzjLsyiVfnb4y3HmhkPzIwEt/44byjmei\nyv07qbOUKfje8hqr8w4Xev4yYuuJYtgKSpcgCGlYH/8xVXCbDKxTVnqhweNfCuC6\nKGFWwkdQJFh4e1Q/GOGTsdr3oo7vZb7uyPO7nFejw05Gh6jI+YpAOlRoMbScTcj/\nzM8M7iTPnrfypoDUFQl+bgeYke9ZGSXOtNt8PQuYjKT/QhccFCQgflnQdkpacYnl\nEXiXhZRmUQwLtola/SbsWSKKB+MVp9Hxzv4+mmhRDeSSuJSIkT7lIBKkWHylNwo=\n=PeOP\n-----END PGP SIGNATURE-----\n", "payload": "tree 2d5ad6ab6c856ef8f112b5e957cd0f323829f807\nparent 3250b8ee596afc9881aee092279efaa57486d2ea\nparent cff6ce667fd8c5002f789a55f75ba70b67be42f7\nauthor Mazdak Farrokhzad <twingoow@gmail.com> 1562511618 +0200\ncommitter GitHub <noreply@github.com> 1562511618 +0200\n\nRollup merge of #62213 - QuietMisdreavus:cfg-doctest, r=GuillaumeGomez\n\nrustdoc: set cfg(doctest) when collecting doctests\n\nNote: This PR builds on top of https://github.com/rust-lang/rust/pull/61199; only the last commit is specific to this PR.\n\nAs discussed in https://github.com/rust-lang/rust/pull/61199, we want the ability to isolate items to only when rustdoc is collecting doctests, but we can't use `cfg(test)` because of libcore's `#![cfg(not(test))]`. This PR proposes a new cfg flag, `cfg(doctest)`, specific to this situation, rather than reusing an existing flag. I've isolated it behind a feature gate so that we can contain the effects to nightly only. (A stable workaround that can be used in lieu of `#[cfg(doctest)]` is `#[cfg(rustdoc)] #[doc(hidden)]`, at least once https://github.com/rust-lang/rust/pull/61351 lands.)\n\nTracking issue: https://github.com/rust-lang/rust/issues/62210\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fe807fcf3e8c76fc54c19a1bb0570579a4ecfe95", "html_url": "https://github.com/rust-lang/rust/commit/fe807fcf3e8c76fc54c19a1bb0570579a4ecfe95", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fe807fcf3e8c76fc54c19a1bb0570579a4ecfe95/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3250b8ee596afc9881aee092279efaa57486d2ea", "url": "https://api.github.com/repos/rust-lang/rust/commits/3250b8ee596afc9881aee092279efaa57486d2ea", "html_url": "https://github.com/rust-lang/rust/commit/3250b8ee596afc9881aee092279efaa57486d2ea"}, {"sha": "cff6ce667fd8c5002f789a55f75ba70b67be42f7", "url": "https://api.github.com/repos/rust-lang/rust/commits/cff6ce667fd8c5002f789a55f75ba70b67be42f7", "html_url": "https://github.com/rust-lang/rust/commit/cff6ce667fd8c5002f789a55f75ba70b67be42f7"}], "stats": {"total": 82, "additions": 78, "deletions": 4}, "files": [{"sha": "1d9510c9aacabcc9f4bd9940e712f8f105ac4510", "filename": "src/doc/rustdoc/src/unstable-features.md", "status": "modified", "additions": 30, "deletions": 0, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/fe807fcf3e8c76fc54c19a1bb0570579a4ecfe95/src%2Fdoc%2Frustdoc%2Fsrc%2Funstable-features.md", "raw_url": "https://github.com/rust-lang/rust/raw/fe807fcf3e8c76fc54c19a1bb0570579a4ecfe95/src%2Fdoc%2Frustdoc%2Fsrc%2Funstable-features.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Frustdoc%2Fsrc%2Funstable-features.md?ref=fe807fcf3e8c76fc54c19a1bb0570579a4ecfe95", "patch": "@@ -212,6 +212,36 @@ pub struct BigX;\n Then, when looking for it through the `rustdoc` search, if you enter \"x\" or\n \"big\", search will show the `BigX` struct first.\n \n+### Include items only when collecting doctests\n+\n+Rustdoc's [documentation tests] can do some things that regular unit tests can't, so it can\n+sometimes be useful to extend your doctests with samples that wouldn't otherwise need to be in\n+documentation. To this end, Rustdoc allows you to have certain items only appear when it's\n+collecting doctests, so you can utilize doctest functionality without forcing the test to appear in\n+docs, or to find an arbitrary private item to include it on.\n+\n+If you add `#![feature(cfg_doctest)]` to your crate, Rustdoc will set `cfg(doctest)` when collecting\n+doctests. Note that they will still link against only the public items of your crate; if you need to\n+test private items, unit tests are still the way to go.\n+\n+In this example, we're adding doctests that we know won't compile, to verify that our struct can\n+only take in valid data:\n+\n+```rust\n+#![feature(cfg_doctest)]\n+\n+/// We have a struct here. Remember it doesn't accept negative numbers!\n+pub struct MyStruct(usize);\n+\n+/// ```compile_fail\n+/// let x = my_crate::MyStruct(-5);\n+/// ```\n+#[cfg(doctest)]\n+pub struct MyStructOnlyTakesUsize;\n+```\n+\n+[documentation tests]: documentation-tests.html\n+\n ## Unstable command-line arguments\n \n These features are enabled by passing a command-line flag to Rustdoc, but the flags in question are"}, {"sha": "9fae246155e06dcc411d8ef31b68d9243c3cceef", "filename": "src/librustdoc/config.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/fe807fcf3e8c76fc54c19a1bb0570579a4ecfe95/src%2Flibrustdoc%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fe807fcf3e8c76fc54c19a1bb0570579a4ecfe95/src%2Flibrustdoc%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fconfig.rs?ref=fe807fcf3e8c76fc54c19a1bb0570579a4ecfe95", "patch": "@@ -351,6 +351,9 @@ impl Options {\n                             .unwrap_or_else(|| PathBuf::from(\"doc\"));\n         let mut cfgs = matches.opt_strs(\"cfg\");\n         cfgs.push(\"rustdoc\".to_string());\n+        if should_test {\n+            cfgs.push(\"doctest\".to_string());\n+        }\n \n         let extension_css = matches.opt_str(\"e\").map(|s| PathBuf::from(&s));\n "}, {"sha": "fd1cb3d803b0916cf74a49c16427ac8039ff3239", "filename": "src/libsyntax/feature_gate.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/fe807fcf3e8c76fc54c19a1bb0570579a4ecfe95/src%2Flibsyntax%2Ffeature_gate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fe807fcf3e8c76fc54c19a1bb0570579a4ecfe95/src%2Flibsyntax%2Ffeature_gate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Ffeature_gate.rs?ref=fe807fcf3e8c76fc54c19a1bb0570579a4ecfe95", "patch": "@@ -577,6 +577,9 @@ declare_features! (\n     // Allows `async || body` closures.\n     (active, async_closure, \"1.37.0\", Some(62290), None),\n \n+    // Allows the use of `#[cfg(doctest)]`, set when rustdoc is collecting doctests\n+    (active, cfg_doctest, \"1.37.0\", Some(62210), None),\n+\n     // -------------------------------------------------------------------------\n     // feature-group-end: actual feature gates\n     // -------------------------------------------------------------------------\n@@ -1592,6 +1595,7 @@ const GATED_CFGS: &[(Symbol, Symbol, fn(&Features) -> bool)] = &[\n     (sym::target_thread_local, sym::cfg_target_thread_local, cfg_fn!(cfg_target_thread_local)),\n     (sym::target_has_atomic, sym::cfg_target_has_atomic, cfg_fn!(cfg_target_has_atomic)),\n     (sym::rustdoc, sym::doc_cfg, cfg_fn!(doc_cfg)),\n+    (sym::doctest, sym::cfg_doctest, cfg_fn!(cfg_doctest)),\n ];\n \n #[derive(Debug)]"}, {"sha": "89fcf3b1f8f190845213d7f55d709e50c5f22498", "filename": "src/libsyntax_pos/symbol.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/fe807fcf3e8c76fc54c19a1bb0570579a4ecfe95/src%2Flibsyntax_pos%2Fsymbol.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fe807fcf3e8c76fc54c19a1bb0570579a4ecfe95/src%2Flibsyntax_pos%2Fsymbol.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax_pos%2Fsymbol.rs?ref=fe807fcf3e8c76fc54c19a1bb0570579a4ecfe95", "patch": "@@ -171,6 +171,7 @@ symbols! {\n         cfg,\n         cfg_attr,\n         cfg_attr_multi,\n+        cfg_doctest,\n         cfg_target_feature,\n         cfg_target_has_atomic,\n         cfg_target_thread_local,\n@@ -241,6 +242,7 @@ symbols! {\n         doc_keyword,\n         doc_masked,\n         doc_spotlight,\n+        doctest,\n         document_private_items,\n         dotdoteq_in_patterns,\n         dotdot_in_tuple_patterns,"}, {"sha": "e88ddfb9e2ad206d858d8f8c3111ead2776da8b9", "filename": "src/test/rustdoc-ui/cfg-test.rs", "status": "modified", "additions": 11, "deletions": 1, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/fe807fcf3e8c76fc54c19a1bb0570579a4ecfe95/src%2Ftest%2Frustdoc-ui%2Fcfg-test.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fe807fcf3e8c76fc54c19a1bb0570579a4ecfe95/src%2Ftest%2Frustdoc-ui%2Fcfg-test.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fcfg-test.rs?ref=fe807fcf3e8c76fc54c19a1bb0570579a4ecfe95", "patch": "@@ -1,10 +1,12 @@\n // build-pass (FIXME(62277): could be check-pass?)\n-// compile-flags:--test\n+// compile-flags:--test --test-args --test-threads=1\n // normalize-stdout-test: \"src/test/rustdoc-ui\" -> \"$$DIR\"\n \n // Crates like core have doctests gated on `cfg(not(test))` so we need to make\n // sure `cfg(test)` is not active when running `rustdoc --test`.\n \n+#![feature(cfg_doctest)]\n+\n /// this doctest will be ignored:\n ///\n /// ```\n@@ -20,3 +22,11 @@ pub struct Foo;\n /// ```\n #[cfg(not(test))]\n pub struct Foo;\n+\n+/// this doctest will be tested, but will not appear in documentation:\n+///\n+/// ```\n+/// assert!(true)\n+/// ```\n+#[cfg(doctest)]\n+pub struct Bar;"}, {"sha": "86141aed5c3f2b0cfee6922ea5f17d08ad373503", "filename": "src/test/rustdoc-ui/cfg-test.stdout", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/fe807fcf3e8c76fc54c19a1bb0570579a4ecfe95/src%2Ftest%2Frustdoc-ui%2Fcfg-test.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/fe807fcf3e8c76fc54c19a1bb0570579a4ecfe95/src%2Ftest%2Frustdoc-ui%2Fcfg-test.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fcfg-test.stdout?ref=fe807fcf3e8c76fc54c19a1bb0570579a4ecfe95", "patch": "@@ -1,6 +1,7 @@\n \n-running 1 test\n-test $DIR/cfg-test.rs - Foo (line 18) ... ok\n+running 2 tests\n+test $DIR/cfg-test.rs - Bar (line 28) ... ok\n+test $DIR/cfg-test.rs - Foo (line 20) ... ok\n \n-test result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out\n+test result: ok. 2 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out\n "}, {"sha": "fca6d1029f981ea7b108b4bd40c553d481b5fe9d", "filename": "src/test/rustdoc/cfg-doctest.rs", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/fe807fcf3e8c76fc54c19a1bb0570579a4ecfe95/src%2Ftest%2Frustdoc%2Fcfg-doctest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fe807fcf3e8c76fc54c19a1bb0570579a4ecfe95/src%2Ftest%2Frustdoc%2Fcfg-doctest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fcfg-doctest.rs?ref=fe807fcf3e8c76fc54c19a1bb0570579a4ecfe95", "patch": "@@ -0,0 +1,8 @@\n+#![feature(cfg_doctest)]\n+\n+// @!has cfg_doctest/struct.SomeStruct.html\n+// @!has cfg_doctest/index.html '//a/@href' 'struct.SomeStruct.html'\n+\n+/// Sneaky, this isn't actually part of docs.\n+#[cfg(doctest)]\n+pub struct SomeStruct;"}, {"sha": "308f68bd52a79de82bf4011938a1c8547fc33626", "filename": "src/test/ui/feature-gate/feature-gate-cfg_doctest.rs", "status": "added", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/fe807fcf3e8c76fc54c19a1bb0570579a4ecfe95/src%2Ftest%2Fui%2Ffeature-gate%2Ffeature-gate-cfg_doctest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fe807fcf3e8c76fc54c19a1bb0570579a4ecfe95/src%2Ftest%2Fui%2Ffeature-gate%2Ffeature-gate-cfg_doctest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffeature-gate%2Ffeature-gate-cfg_doctest.rs?ref=fe807fcf3e8c76fc54c19a1bb0570579a4ecfe95", "patch": "@@ -0,0 +1,4 @@\n+#[cfg(doctest)] //~ ERROR\n+pub struct SomeStruct;\n+\n+fn main() {}"}, {"sha": "aa1d18a6f759de55ea8757dbde5de902326a6161", "filename": "src/test/ui/feature-gate/feature-gate-cfg_doctest.stderr", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/fe807fcf3e8c76fc54c19a1bb0570579a4ecfe95/src%2Ftest%2Fui%2Ffeature-gate%2Ffeature-gate-cfg_doctest.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/fe807fcf3e8c76fc54c19a1bb0570579a4ecfe95/src%2Ftest%2Fui%2Ffeature-gate%2Ffeature-gate-cfg_doctest.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffeature-gate%2Ffeature-gate-cfg_doctest.stderr?ref=fe807fcf3e8c76fc54c19a1bb0570579a4ecfe95", "patch": "@@ -0,0 +1,12 @@\n+error[E0658]: `cfg(doctest)` is experimental and subject to change\n+  --> $DIR/feature-gate-cfg_doctest.rs:1:7\n+   |\n+LL | #[cfg(doctest)]\n+   |       ^^^^^^^\n+   |\n+   = note: for more information, see https://github.com/rust-lang/rust/issues/62210\n+   = help: add #![feature(cfg_doctest)] to the crate attributes to enable\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0658`."}]}