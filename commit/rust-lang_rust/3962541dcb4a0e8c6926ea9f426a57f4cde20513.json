{"sha": "3962541dcb4a0e8c6926ea9f426a57f4cde20513", "node_id": "MDY6Q29tbWl0NzI0NzEyOjM5NjI1NDFkY2I0YTBlOGM2OTI2ZWE5ZjQyNmE1N2Y0Y2RlMjA1MTM=", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2021-05-10T18:05:26Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-05-10T18:05:26Z"}, "message": "Rollup merge of #85148 - GuillaumeGomez:source-code-line-number, r=jsha\n\nFix source code line number display and make it clickable again\n\nFixes https://github.com/rust-lang/rust/issues/85119.\n\nI used the same logic we're using for other codeblocks: putting the line number `<span>`s into the `example-wrap` directly and then add `display: inline-flex` on `example-wrap`.\n\nr? `@jsha`", "tree": {"sha": "e81177dfd7334a89dfedad29436cbee16ef6ca40", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e81177dfd7334a89dfedad29436cbee16ef6ca40"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3962541dcb4a0e8c6926ea9f426a57f4cde20513", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgmXXnCRBK7hj4Ov3rIwAAJP0IAKdMVjJ6WX/HSl+JfLjQ5HfF\nHqJ+WE1IkgqGeFhDsNSC24g4OpO8D+X6RtH7jj31ckc+fm5WbqaSZQylxSAdBU+D\n5LXG2v5qWZEC6ig/plEbUBhEQFI0tTRI+RL5EgG87G+HjkwYJQ7Z+sRYX6TdopBU\nz0MWmC0qlHIxc5yOQnvYpvKI62zajQGuAATQ+oIlzyJLlh5wTjqOPZf6WSb2a+Ze\n5neiLHpezDkSx5nd8GRDcx0O/iLJi3ipX93XtWfQUMx7hkKWubMU33oaDMuiCb7L\nGvh+BlorNoSdqcMD7YS4kTWeDCL63Aly2RGedcoQst9rzRqYnMgtXJiWzoy9AcE=\n=iGLY\n-----END PGP SIGNATURE-----\n", "payload": "tree e81177dfd7334a89dfedad29436cbee16ef6ca40\nparent c7e7de4021089598f16dbe90dbcccebbdcd31216\nparent 4e3fb6858ad46767c021174d7bbe6e14a44e22aa\nauthor Guillaume Gomez <guillaume1.gomez@gmail.com> 1620669926 +0200\ncommitter GitHub <noreply@github.com> 1620669926 +0200\n\nRollup merge of #85148 - GuillaumeGomez:source-code-line-number, r=jsha\n\nFix source code line number display and make it clickable again\n\nFixes https://github.com/rust-lang/rust/issues/85119.\n\nI used the same logic we're using for other codeblocks: putting the line number `<span>`s into the `example-wrap` directly and then add `display: inline-flex` on `example-wrap`.\n\nr? `@jsha`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3962541dcb4a0e8c6926ea9f426a57f4cde20513", "html_url": "https://github.com/rust-lang/rust/commit/3962541dcb4a0e8c6926ea9f426a57f4cde20513", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3962541dcb4a0e8c6926ea9f426a57f4cde20513/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c7e7de4021089598f16dbe90dbcccebbdcd31216", "url": "https://api.github.com/repos/rust-lang/rust/commits/c7e7de4021089598f16dbe90dbcccebbdcd31216", "html_url": "https://github.com/rust-lang/rust/commit/c7e7de4021089598f16dbe90dbcccebbdcd31216"}, {"sha": "4e3fb6858ad46767c021174d7bbe6e14a44e22aa", "url": "https://api.github.com/repos/rust-lang/rust/commits/4e3fb6858ad46767c021174d7bbe6e14a44e22aa", "html_url": "https://github.com/rust-lang/rust/commit/4e3fb6858ad46767c021174d7bbe6e14a44e22aa"}], "stats": {"total": 59, "additions": 40, "deletions": 19}, "files": [{"sha": "51392ca1191891a7dc3932f909bb4e5e9efa62eb", "filename": "src/librustdoc/html/highlight.rs", "status": "modified", "additions": 12, "deletions": 3, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/3962541dcb4a0e8c6926ea9f426a57f4cde20513/src%2Flibrustdoc%2Fhtml%2Fhighlight.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3962541dcb4a0e8c6926ea9f426a57f4cde20513/src%2Flibrustdoc%2Fhtml%2Fhighlight.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fhighlight.rs?ref=3962541dcb4a0e8c6926ea9f426a57f4cde20513", "patch": "@@ -24,6 +24,7 @@ crate fn render_with_highlighting(\n     playground_button: Option<&str>,\n     tooltip: Option<(Option<Edition>, &str)>,\n     edition: Edition,\n+    extra_content: Option<Buffer>,\n ) {\n     debug!(\"highlighting: ================\\n{}\\n==============\", src);\n     if let Some((edition_info, class)) = tooltip {\n@@ -39,13 +40,21 @@ crate fn render_with_highlighting(\n         );\n     }\n \n-    write_header(out, class);\n+    write_header(out, class, extra_content);\n     write_code(out, &src, edition);\n     write_footer(out, playground_button);\n }\n \n-fn write_header(out: &mut Buffer, class: Option<&str>) {\n-    writeln!(out, \"<div class=\\\"example-wrap\\\"><pre class=\\\"rust {}\\\">\", class.unwrap_or_default());\n+fn write_header(out: &mut Buffer, class: Option<&str>, extra_content: Option<Buffer>) {\n+    write!(out, \"<div class=\\\"example-wrap\\\">\");\n+    if let Some(extra) = extra_content {\n+        out.push_buffer(extra);\n+    }\n+    if let Some(class) = class {\n+        writeln!(out, \"<pre class=\\\"rust {}\\\">\", class);\n+    } else {\n+        writeln!(out, \"<pre class=\\\"rust\\\">\");\n+    }\n }\n \n fn write_code(out: &mut Buffer, src: &str, edition: Edition) {"}, {"sha": "c2b40ab34e2551c1062525c3ce6d7f33c45705c4", "filename": "src/librustdoc/html/markdown.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/3962541dcb4a0e8c6926ea9f426a57f4cde20513/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3962541dcb4a0e8c6926ea9f426a57f4cde20513/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs?ref=3962541dcb4a0e8c6926ea9f426a57f4cde20513", "patch": "@@ -315,6 +315,7 @@ impl<'a, I: Iterator<Item = Event<'a>>> Iterator for CodeBlocks<'_, 'a, I> {\n             playground_button.as_deref(),\n             tooltip,\n             edition,\n+            None,\n         );\n         Some(Event::Html(s.into_inner().into()))\n     }"}, {"sha": "7ccc313cc5905ef6c6486f33af86d43f80dd38bb", "filename": "src/librustdoc/html/render/print_item.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/3962541dcb4a0e8c6926ea9f426a57f4cde20513/src%2Flibrustdoc%2Fhtml%2Frender%2Fprint_item.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3962541dcb4a0e8c6926ea9f426a57f4cde20513/src%2Flibrustdoc%2Fhtml%2Frender%2Fprint_item.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fprint_item.rs?ref=3962541dcb4a0e8c6926ea9f426a57f4cde20513", "patch": "@@ -1026,6 +1026,7 @@ fn item_macro(w: &mut Buffer, cx: &Context<'_>, it: &clean::Item, t: &clean::Mac\n             None,\n             None,\n             it.span(cx.tcx()).inner().edition(),\n+            None,\n         );\n     });\n     document(w, cx, it, None)"}, {"sha": "57c33f94918d71fd097ddf80609814ca0e406504", "filename": "src/librustdoc/html/sources.rs", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/3962541dcb4a0e8c6926ea9f426a57f4cde20513/src%2Flibrustdoc%2Fhtml%2Fsources.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3962541dcb4a0e8c6926ea9f426a57f4cde20513/src%2Flibrustdoc%2Fhtml%2Fsources.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fsources.rs?ref=3962541dcb4a0e8c6926ea9f426a57f4cde20513", "patch": "@@ -169,16 +169,17 @@ where\n /// adding line numbers to the left-hand side.\n fn print_src(buf: &mut Buffer, s: &str, edition: Edition) {\n     let lines = s.lines().count();\n+    let mut line_numbers = Buffer::empty_from(buf);\n     let mut cols = 0;\n     let mut tmp = lines;\n     while tmp > 0 {\n         cols += 1;\n         tmp /= 10;\n     }\n-    buf.write_str(\"<pre class=\\\"line-numbers\\\">\");\n+    line_numbers.write_str(\"<pre class=\\\"line-numbers\\\">\");\n     for i in 1..=lines {\n-        writeln!(buf, \"<span id=\\\"{0}\\\">{0:1$}</span>\", i, cols);\n+        writeln!(line_numbers, \"<span id=\\\"{0}\\\">{0:1$}</span>\", i, cols);\n     }\n-    buf.write_str(\"</pre>\");\n-    highlight::render_with_highlighting(s, buf, None, None, None, edition);\n+    line_numbers.write_str(\"</pre>\");\n+    highlight::render_with_highlighting(s, buf, None, None, None, edition, Some(line_numbers));\n }"}, {"sha": "aaa2525644f117fa2318e26f5fb4d1c09c39c36c", "filename": "src/librustdoc/html/static/rustdoc.css", "status": "modified", "additions": 5, "deletions": 9, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/3962541dcb4a0e8c6926ea9f426a57f4cde20513/src%2Flibrustdoc%2Fhtml%2Fstatic%2Frustdoc.css", "raw_url": "https://github.com/rust-lang/rust/raw/3962541dcb4a0e8c6926ea9f426a57f4cde20513/src%2Flibrustdoc%2Fhtml%2Fstatic%2Frustdoc.css", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Frustdoc.css?ref=3962541dcb4a0e8c6926ea9f426a57f4cde20513", "patch": "@@ -206,7 +206,6 @@ li {\n \tmax-width: none;\n \toverflow: visible;\n \tmargin-left: 0px;\n-\tmin-width: 70em;\n }\n \n nav.sub {\n@@ -357,7 +356,7 @@ nav.sub {\n \tpadding-left: 0;\n }\n \n-.rustdoc:not(.source) .example-wrap {\n+.rustdoc .example-wrap {\n \tdisplay: inline-flex;\n \tmargin-bottom: 10px;\n }\n@@ -370,8 +369,6 @@ nav.sub {\n .example-wrap > pre.line-number {\n \toverflow: initial;\n \tborder: 1px solid;\n-\tborder-top-left-radius: 5px;\n-\tborder-bottom-left-radius: 5px;\n \tpadding: 13px 8px;\n \ttext-align: right;\n }\n@@ -381,7 +378,7 @@ nav.sub {\n \toverflow-x: auto;\n }\n \n-.rustdoc:not(.source) .example-wrap > pre {\n+.rustdoc .example-wrap > pre {\n \tmargin: 0;\n }\n \n@@ -395,15 +392,14 @@ nav.sub {\n \ttable-layout: fixed;\n }\n \n-.content pre.line-numbers {\n-\tfloat: left;\n-\tborder: none;\n+.content > .example-wrap pre.line-numbers {\n \tposition: relative;\n-\n \t-webkit-user-select: none;\n \t-moz-user-select: none;\n \t-ms-user-select: none;\n \tuser-select: none;\n+\tborder-top-left-radius: 5px;\n+\tborder-bottom-left-radius: 5px;\n }\n .line-numbers span {\n \tcursor: pointer;"}, {"sha": "aafb7f6300ea476aee1b7bc098401e68cd75eb18", "filename": "src/librustdoc/html/static/themes/ayu.css", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/3962541dcb4a0e8c6926ea9f426a57f4cde20513/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fthemes%2Fayu.css", "raw_url": "https://github.com/rust-lang/rust/raw/3962541dcb4a0e8c6926ea9f426a57f4cde20513/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fthemes%2Fayu.css", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fthemes%2Fayu.css?ref=3962541dcb4a0e8c6926ea9f426a57f4cde20513", "patch": "@@ -53,7 +53,7 @@ span code {\n .docblock code, .docblock-short code {\n \tbackground-color: #191f26;\n }\n-pre {\n+pre, .rustdoc.source .example-wrap {\n \tcolor: #e6e1cf;\n \tbackground-color: #191f26;\n }"}, {"sha": "715605d7b3785cfa0ea4dd962f40168915afb086", "filename": "src/librustdoc/html/static/themes/dark.css", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/3962541dcb4a0e8c6926ea9f426a57f4cde20513/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fthemes%2Fdark.css", "raw_url": "https://github.com/rust-lang/rust/raw/3962541dcb4a0e8c6926ea9f426a57f4cde20513/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fthemes%2Fdark.css", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fthemes%2Fdark.css?ref=3962541dcb4a0e8c6926ea9f426a57f4cde20513", "patch": "@@ -26,7 +26,7 @@ h4:not(.method):not(.type):not(.tymethod) {\n .docblock code, .docblock-short code {\n \tbackground-color: #2A2A2A;\n }\n-pre {\n+pre, .rustdoc.source .example-wrap {\n \tbackground-color: #2A2A2A;\n }\n "}, {"sha": "60ed8898793875504b60ac54d027699f55c7473d", "filename": "src/librustdoc/html/static/themes/light.css", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/3962541dcb4a0e8c6926ea9f426a57f4cde20513/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fthemes%2Flight.css", "raw_url": "https://github.com/rust-lang/rust/raw/3962541dcb4a0e8c6926ea9f426a57f4cde20513/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fthemes%2Flight.css", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fthemes%2Flight.css?ref=3962541dcb4a0e8c6926ea9f426a57f4cde20513", "patch": "@@ -28,7 +28,7 @@ h4:not(.method):not(.type):not(.tymethod) {\n .docblock code, .docblock-short code {\n \tbackground-color: #F5F5F5;\n }\n-pre {\n+pre, .rustdoc.source .example-wrap {\n \tbackground-color: #F5F5F5;\n }\n "}, {"sha": "f11c41e8bd552eb870377696b5abe25b5669ebaa", "filename": "src/test/rustdoc-gui/source-code-page.goml", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/3962541dcb4a0e8c6926ea9f426a57f4cde20513/src%2Ftest%2Frustdoc-gui%2Fsource-code-page.goml", "raw_url": "https://github.com/rust-lang/rust/raw/3962541dcb4a0e8c6926ea9f426a57f4cde20513/src%2Ftest%2Frustdoc-gui%2Fsource-code-page.goml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-gui%2Fsource-code-page.goml?ref=3962541dcb4a0e8c6926ea9f426a57f4cde20513", "patch": "@@ -0,0 +1,13 @@\n+goto: file://|DOC_PATH|/../src/test_docs/lib.rs.html\n+// Check that we can click on the line number.\n+click: (40, 224) // This is the position of the span for line 4.\n+// Unfortunately, \"#4\" isn't a valid query selector, so we have to go around that limitation\n+// by instead getting the nth span.\n+assert: (\".line-numbers > span:nth-child(4)\", \"class\", \"line-highlighted\")\n+// We now check that the good spans are highlighted\n+goto: file://|DOC_PATH|/../src/test_docs/lib.rs.html#4-6\n+assert-false: (\".line-numbers > span:nth-child(3)\", \"class\", \"line-highlighted\")\n+assert: (\".line-numbers > span:nth-child(4)\", \"class\", \"line-highlighted\")\n+assert: (\".line-numbers > span:nth-child(5)\", \"class\", \"line-highlighted\")\n+assert: (\".line-numbers > span:nth-child(6)\", \"class\", \"line-highlighted\")\n+assert-false: (\".line-numbers > span:nth-child(7)\", \"class\", \"line-highlighted\")"}]}