{"sha": "b0884c098bc3704f7ec9381ac1670eb923845127", "node_id": "MDY6Q29tbWl0NzI0NzEyOmIwODg0YzA5OGJjMzcwNGY3ZWM5MzgxYWMxNjcwZWI5MjM4NDUxMjc=", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2020-07-08T12:48:31Z"}, "committer": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2020-07-08T12:48:31Z"}, "message": "Move #[doc(alias)] check in rustc", "tree": {"sha": "a9f5a395ed17099dc15b838cfcd44d868fc1a52a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a9f5a395ed17099dc15b838cfcd44d868fc1a52a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b0884c098bc3704f7ec9381ac1670eb923845127", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b0884c098bc3704f7ec9381ac1670eb923845127", "html_url": "https://github.com/rust-lang/rust/commit/b0884c098bc3704f7ec9381ac1670eb923845127", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b0884c098bc3704f7ec9381ac1670eb923845127/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f844ea1e561475e6023282ef167e76bc973773ef", "url": "https://api.github.com/repos/rust-lang/rust/commits/f844ea1e561475e6023282ef167e76bc973773ef", "html_url": "https://github.com/rust-lang/rust/commit/f844ea1e561475e6023282ef167e76bc973773ef"}], "stats": {"total": 65, "additions": 34, "deletions": 31}, "files": [{"sha": "b44dc9e907960a4f388e53e77dda55133a32341d", "filename": "src/librustc_passes/check_attr.rs", "status": "modified", "additions": 30, "deletions": 0, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/b0884c098bc3704f7ec9381ac1670eb923845127/src%2Flibrustc_passes%2Fcheck_attr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b0884c098bc3704f7ec9381ac1670eb923845127/src%2Flibrustc_passes%2Fcheck_attr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_passes%2Fcheck_attr.rs?ref=b0884c098bc3704f7ec9381ac1670eb923845127", "patch": "@@ -70,6 +70,8 @@ impl CheckAttrVisitor<'tcx> {\n                 self.check_target_feature(attr, span, target)\n             } else if attr.check_name(sym::track_caller) {\n                 self.check_track_caller(&attr.span, attrs, span, target)\n+            } else if attr.check_name(sym::doc) {\n+                self.check_doc_alias(attr)\n             } else {\n                 true\n             };\n@@ -216,6 +218,34 @@ impl CheckAttrVisitor<'tcx> {\n         }\n     }\n \n+    fn check_doc_alias(&self, attr: &Attribute) -> bool {\n+        if let Some(mi) = attr.meta() {\n+            if let Some(list) = mi.meta_item_list() {\n+                for meta in list {\n+                    if meta.check_name(sym::alias) {\n+                        if !meta.is_value_str()\n+                            || meta\n+                                .value_str()\n+                                .map(|s| s.to_string())\n+                                .unwrap_or_else(String::new)\n+                                .is_empty()\n+                        {\n+                            self.tcx\n+                                .sess\n+                                .struct_span_err(\n+                                    meta.span(),\n+                                    \"doc alias attribute expects a string: #[doc(alias = \\\"0\\\")]\",\n+                                )\n+                                .emit();\n+                            return false;\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+        true\n+    }\n+\n     /// Checks if the `#[repr]` attributes on `item` are valid.\n     fn check_repr(\n         &self,"}, {"sha": "5c76c840b1ddd1910238457bd4aadbdd011fe404", "filename": "src/librustdoc/clean/types.rs", "status": "modified", "additions": 0, "deletions": 28, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/b0884c098bc3704f7ec9381ac1670eb923845127/src%2Flibrustdoc%2Fclean%2Ftypes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b0884c098bc3704f7ec9381ac1670eb923845127/src%2Flibrustdoc%2Fclean%2Ftypes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Ftypes.rs?ref=b0884c098bc3704f7ec9381ac1670eb923845127", "patch": "@@ -486,33 +486,6 @@ impl Attributes {\n         })\n     }\n \n-    /// Enforce the format of attributes inside `#[doc(...)]`.\n-    pub fn check_doc_attributes(\n-        diagnostic: &::rustc_errors::Handler,\n-        mi: &ast::MetaItem,\n-    ) -> Option<(String, String)> {\n-        mi.meta_item_list().and_then(|list| {\n-            for meta in list {\n-                if meta.check_name(sym::alias) {\n-                    if !meta.is_value_str()\n-                        || meta\n-                            .value_str()\n-                            .map(|s| s.to_string())\n-                            .unwrap_or_else(String::new)\n-                            .is_empty()\n-                    {\n-                        diagnostic.span_err(\n-                            meta.span(),\n-                            \"doc alias attribute expects a string: #[doc(alias = \\\"0\\\")]\",\n-                        );\n-                    }\n-                }\n-            }\n-\n-            None\n-        })\n-    }\n-\n     pub fn has_doc_flag(&self, flag: Symbol) -> bool {\n         for attr in &self.other_attrs {\n             if !attr.check_name(sym::doc) {\n@@ -556,7 +529,6 @@ impl Attributes {\n                 } else {\n                     if attr.check_name(sym::doc) {\n                         if let Some(mi) = attr.meta() {\n-                            Attributes::check_doc_attributes(&diagnostic, &mi);\n                             if let Some(cfg_mi) = Attributes::extract_cfg(&mi) {\n                                 // Extracted #[doc(cfg(...))]\n                                 match Cfg::parse(cfg_mi) {"}, {"sha": "b02cc1a4545b12b31e919576835afdef0062b445", "filename": "src/test/ui/check-doc-alias-attr.rs", "status": "renamed", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/b0884c098bc3704f7ec9381ac1670eb923845127/src%2Ftest%2Fui%2Fcheck-doc-alias-attr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b0884c098bc3704f7ec9381ac1670eb923845127/src%2Ftest%2Fui%2Fcheck-doc-alias-attr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcheck-doc-alias-attr.rs?ref=b0884c098bc3704f7ec9381ac1670eb923845127", "patch": "@@ -1,3 +1,4 @@\n+#![crate_type = \"lib\"]\n #![feature(doc_alias)]\n \n #[doc(alias = \"foo\")] // ok!", "previous_filename": "src/test/rustdoc-ui/check-doc-alias-attr.rs"}, {"sha": "268230ab44a0ac5d5efcc02c330960773f6fa5c9", "filename": "src/test/ui/check-doc-alias-attr.stderr", "status": "renamed", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/b0884c098bc3704f7ec9381ac1670eb923845127/src%2Ftest%2Fui%2Fcheck-doc-alias-attr.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/b0884c098bc3704f7ec9381ac1670eb923845127/src%2Ftest%2Fui%2Fcheck-doc-alias-attr.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcheck-doc-alias-attr.stderr?ref=b0884c098bc3704f7ec9381ac1670eb923845127", "patch": "@@ -1,17 +1,17 @@\n error: doc alias attribute expects a string: #[doc(alias = \"0\")]\n-  --> $DIR/check-doc-alias-attr.rs:6:7\n+  --> $DIR/check-doc-alias-attr.rs:7:7\n    |\n LL | #[doc(alias)]\n    |       ^^^^^\n \n error: doc alias attribute expects a string: #[doc(alias = \"0\")]\n-  --> $DIR/check-doc-alias-attr.rs:7:7\n+  --> $DIR/check-doc-alias-attr.rs:8:7\n    |\n LL | #[doc(alias = 0)]\n    |       ^^^^^^^^^\n \n error: doc alias attribute expects a string: #[doc(alias = \"0\")]\n-  --> $DIR/check-doc-alias-attr.rs:8:7\n+  --> $DIR/check-doc-alias-attr.rs:9:7\n    |\n LL | #[doc(alias(\"bar\"))]\n    |       ^^^^^^^^^^^^", "previous_filename": "src/test/rustdoc-ui/check-doc-alias-attr.stderr"}]}