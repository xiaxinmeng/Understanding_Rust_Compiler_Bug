{"sha": "9a893cc2b82ac6259aead1319758404b80b8a959", "node_id": "MDY6Q29tbWl0NzI0NzEyOjlhODkzY2MyYjgyYWM2MjU5YWVhZDEzMTk3NTg0MDRiODBiOGE5NTk=", "commit": {"author": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2018-07-25T03:46:22Z"}, "committer": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2018-07-25T03:46:22Z"}, "message": "Add span label for format str missing specifier", "tree": {"sha": "7e3916b0f97015e658c475060f2660ae7a8bb647", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7e3916b0f97015e658c475060f2660ae7a8bb647"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9a893cc2b82ac6259aead1319758404b80b8a959", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9a893cc2b82ac6259aead1319758404b80b8a959", "html_url": "https://github.com/rust-lang/rust/commit/9a893cc2b82ac6259aead1319758404b80b8a959", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9a893cc2b82ac6259aead1319758404b80b8a959/comments", "author": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "committer": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7bd94e0738dfaa91fe9fc16085969a7c9c3f8129", "url": "https://api.github.com/repos/rust-lang/rust/commits/7bd94e0738dfaa91fe9fc16085969a7c9c3f8129", "html_url": "https://github.com/rust-lang/rust/commit/7bd94e0738dfaa91fe9fc16085969a7c9c3f8129"}], "stats": {"total": 63, "additions": 42, "deletions": 21}, "files": [{"sha": "98de3d80b1e1f354ab2827b19b6a1f168637e2a5", "filename": "src/libsyntax_ext/format.rs", "status": "modified", "additions": 11, "deletions": 8, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/9a893cc2b82ac6259aead1319758404b80b8a959/src%2Flibsyntax_ext%2Fformat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9a893cc2b82ac6259aead1319758404b80b8a959/src%2Flibsyntax_ext%2Fformat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax_ext%2Fformat.rs?ref=9a893cc2b82ac6259aead1319758404b80b8a959", "patch": "@@ -915,12 +915,13 @@ pub fn expand_preparsed_format_args(ecx: &mut ExtCtxt,\n             errs.push((cx.args[i].span, msg));\n         }\n     }\n-    if errs.len() > 0 {\n-        let args_used = cx.arg_types.len() - errs.len();\n-        let args_unused = errs.len();\n+    let errs_len = errs.len();\n+    if errs_len > 0 {\n+        let args_used = cx.arg_types.len() - errs_len;\n+        let args_unused = errs_len;\n \n         let mut diag = {\n-            if errs.len() == 1 {\n+            if errs_len == 1 {\n                 let (sp, msg) = errs.into_iter().next().unwrap();\n                 cx.ecx.struct_span_err(sp, msg)\n             } else {\n@@ -933,6 +934,8 @@ pub fn expand_preparsed_format_args(ecx: &mut ExtCtxt,\n             }\n         };\n \n+        // Used to ensure we only report translations for *one* kind of foreign format.\n+        let mut found_foreign = false;\n         // Decide if we want to look for foreign formatting directives.\n         if args_used < args_unused {\n             use super::format_foreign as foreign;\n@@ -941,9 +944,6 @@ pub fn expand_preparsed_format_args(ecx: &mut ExtCtxt,\n             // with `%d should be written as {}` over and over again.\n             let mut explained = HashSet::new();\n \n-            // Used to ensure we only report translations for *one* kind of foreign format.\n-            let mut found_foreign = false;\n-\n             macro_rules! check_foreign {\n                 ($kind:ident) => {{\n                     let mut show_doc_note = false;\n@@ -987,7 +987,7 @@ pub fn expand_preparsed_format_args(ecx: &mut ExtCtxt,\n                     }\n                     if suggestions.len() > 0 {\n                         diag.multipart_suggestion(\n-                            \"format specifiers in Rust are written using `{}`\",\n+                            \"format specifiers use curly braces\",\n                             suggestions,\n                         );\n                     }\n@@ -999,6 +999,9 @@ pub fn expand_preparsed_format_args(ecx: &mut ExtCtxt,\n                 check_foreign!(shell);\n             }\n         }\n+        if !found_foreign && errs_len == 1 {\n+            diag.span_label(cx.fmtsp, \"formatting specifier missing\");\n+        }\n \n         diag.emit();\n     }"}, {"sha": "c8fd8bad19ba54402f1f3176ef4280ab4004288a", "filename": "src/test/ui/ifmt-bad-arg.stderr", "status": "modified", "additions": 22, "deletions": 8, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/9a893cc2b82ac6259aead1319758404b80b8a959/src%2Ftest%2Fui%2Fifmt-bad-arg.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/9a893cc2b82ac6259aead1319758404b80b8a959/src%2Ftest%2Fui%2Fifmt-bad-arg.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fifmt-bad-arg.stderr?ref=9a893cc2b82ac6259aead1319758404b80b8a959", "patch": "@@ -16,7 +16,9 @@ error: argument never used\n   --> $DIR/ifmt-bad-arg.rs:19:20\n    |\n LL |     format!(\"{1}\", 1);\n-   |                    ^\n+   |             -----  ^\n+   |             |\n+   |             formatting specifier missing\n \n error: 2 positional arguments in format string, but no arguments were given\n   --> $DIR/ifmt-bad-arg.rs:23:14\n@@ -86,31 +88,41 @@ error: argument never used\n   --> $DIR/ifmt-bad-arg.rs:43:22\n    |\n LL |     format!(\"{}\", 1, 2);             //~ ERROR: argument never used\n-   |                      ^\n+   |             ----     ^\n+   |             |\n+   |             formatting specifier missing\n \n error: argument never used\n   --> $DIR/ifmt-bad-arg.rs:44:20\n    |\n LL |     format!(\"{1}\", 1, 2);            //~ ERROR: argument never used\n-   |                    ^\n+   |             -----  ^\n+   |             |\n+   |             formatting specifier missing\n \n error: named argument never used\n   --> $DIR/ifmt-bad-arg.rs:45:26\n    |\n LL |     format!(\"{}\", 1, foo=2);         //~ ERROR: named argument never used\n-   |                          ^\n+   |             ----         ^\n+   |             |\n+   |             formatting specifier missing\n \n error: argument never used\n   --> $DIR/ifmt-bad-arg.rs:46:22\n    |\n LL |     format!(\"{foo}\", 1, foo=2);      //~ ERROR: argument never used\n-   |                      ^\n+   |             -------  ^\n+   |             |\n+   |             formatting specifier missing\n \n error: named argument never used\n   --> $DIR/ifmt-bad-arg.rs:47:21\n    |\n LL |     format!(\"\", foo=2);              //~ ERROR: named argument never used\n-   |                     ^\n+   |             --      ^\n+   |             |\n+   |             formatting specifier missing\n \n error: multiple unused formatting arguments\n   --> $DIR/ifmt-bad-arg.rs:48:32\n@@ -148,7 +160,9 @@ error: named argument never used\n   --> $DIR/ifmt-bad-arg.rs:55:51\n    |\n LL |     format!(\"{valuea} {valueb}\", valuea=5, valuec=7);\n-   |                                                   ^\n+   |             -------------------                   ^\n+   |             |\n+   |             formatting specifier missing\n \n error: invalid format string: expected `'}'` but string was terminated\n   --> $DIR/ifmt-bad-arg.rs:61:15\n@@ -180,7 +194,7 @@ error: argument never used\n LL |     format!(\"foo %s baz\", \"bar\"); //~ ERROR: argument never used\n    |                  --       ^^^^^\n    |                  |\n-   |                  help: format specifiers in Rust are written using `{}`: `{}`\n+   |                  help: format specifiers use curly braces: `{}`\n    |\n    = note: printf formatting not supported; see the documentation for `std::fmt`\n "}, {"sha": "5e76c0a322e51b941296762b1e793191c4112ba8", "filename": "src/test/ui/macros/format-foreign.stderr", "status": "modified", "additions": 6, "deletions": 4, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/9a893cc2b82ac6259aead1319758404b80b8a959/src%2Ftest%2Fui%2Fmacros%2Fformat-foreign.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/9a893cc2b82ac6259aead1319758404b80b8a959/src%2Ftest%2Fui%2Fmacros%2Fformat-foreign.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmacros%2Fformat-foreign.stderr?ref=9a893cc2b82ac6259aead1319758404b80b8a959", "patch": "@@ -7,7 +7,7 @@ LL |     println!(\"%.*3$s %s!/n\", \"Hello,\", \"World\", 4); //~ ERROR multiple unus\n    |              multiple missing formatting specifiers\n    |\n    = note: printf formatting not supported; see the documentation for `std::fmt`\n-help: format specifiers in Rust are written using `{}`\n+help: format specifiers use curly braces\n    |\n LL |     println!(\"{:.2$} {}!/n\", \"Hello,\", \"World\", 4); //~ ERROR multiple unused formatting arguments\n    |               ^^^^^^ ^^\n@@ -18,7 +18,7 @@ error: argument never used\n LL |     println!(\"%1$*2$.*3$f\", 123.456); //~ ERROR never used\n    |               -----------   ^^^^^^^\n    |               |\n-   |               help: format specifiers in Rust are written using `{}`: `{0:1$.2$}`\n+   |               help: format specifiers use curly braces: `{0:1$.2$}`\n    |\n    = note: printf formatting not supported; see the documentation for `std::fmt`\n \n@@ -34,7 +34,7 @@ LL | | \"###, \"Hello,\", \"World\", 4);\n    |      multiple missing formatting specifiers\n    |\n    = note: printf formatting not supported; see the documentation for `std::fmt`\n-help: format specifiers in Rust are written using `{}`\n+help: format specifiers use curly braces\n    |\n LL |     println!(r###\"{:.2$}\n LL |         {}!/n\n@@ -44,7 +44,9 @@ error: argument never used\n   --> $DIR/format-foreign.rs:22:30\n    |\n LL |     println!(\"{} %f\", \"one\", 2.0); //~ ERROR never used\n-   |                              ^^^\n+   |              -------         ^^^\n+   |              |\n+   |              formatting specifier missing\n \n error: named argument never used\n   --> $DIR/format-foreign.rs:24:39"}, {"sha": "81171a1ed01de5dfe035f8ab353e727ba8b2300a", "filename": "src/test/ui/macros/format-unused-lables.stderr", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/9a893cc2b82ac6259aead1319758404b80b8a959/src%2Ftest%2Fui%2Fmacros%2Fformat-unused-lables.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/9a893cc2b82ac6259aead1319758404b80b8a959/src%2Ftest%2Fui%2Fmacros%2Fformat-unused-lables.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmacros%2Fformat-unused-lables.stderr?ref=9a893cc2b82ac6259aead1319758404b80b8a959", "patch": "@@ -22,7 +22,9 @@ error: named argument never used\n   --> $DIR/format-unused-lables.rs:21:35\n    |\n LL |     println!(\"Some stuff\", UNUSED=\"args\"); //~ ERROR named argument never used\n-   |                                   ^^^^^^\n+   |              ------------         ^^^^^^\n+   |              |\n+   |              formatting specifier missing\n \n error: multiple unused formatting arguments\n   --> $DIR/format-unused-lables.rs:24:9"}]}