{"sha": "71d3a715721137ffc10becc10978fe038ee131ac", "node_id": "MDY6Q29tbWl0NzI0NzEyOjcxZDNhNzE1NzIxMTM3ZmZjMTBiZWNjMTA5NzhmZTAzOGVlMTMxYWM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-10-10T06:36:11Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-10-10T06:36:11Z"}, "message": "Auto merge of #54831 - davidtwco:issue-52663-struct-field-suggestion, r=nikomatsakis\n\nNLL is missing struct field suggestion\n\nPart of #52663.\n\nThis commit adds suggestions to change the definitions of fields in\nstruct definitions from immutable references to mutable references.\n\nr? @nikomatsakis\ncc @pnkfelix", "tree": {"sha": "55ae3bc9835fcbcd5fb64edb66c0c5f511edf102", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/55ae3bc9835fcbcd5fb64edb66c0c5f511edf102"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/71d3a715721137ffc10becc10978fe038ee131ac", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/71d3a715721137ffc10becc10978fe038ee131ac", "html_url": "https://github.com/rust-lang/rust/commit/71d3a715721137ffc10becc10978fe038ee131ac", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/71d3a715721137ffc10becc10978fe038ee131ac/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4623d4889373702428251967d9bf6ff6d677ec1a", "url": "https://api.github.com/repos/rust-lang/rust/commits/4623d4889373702428251967d9bf6ff6d677ec1a", "html_url": "https://github.com/rust-lang/rust/commit/4623d4889373702428251967d9bf6ff6d677ec1a"}, {"sha": "9e49ac067f205e4400e85c98e35c2fe9af820d7d", "url": "https://api.github.com/repos/rust-lang/rust/commits/9e49ac067f205e4400e85c98e35c2fe9af820d7d", "html_url": "https://github.com/rust-lang/rust/commit/9e49ac067f205e4400e85c98e35c2fe9af820d7d"}], "stats": {"total": 89, "additions": 89, "deletions": 0}, "files": [{"sha": "5ab1605d7f07ab404fc79d2ae791a68fe8a5412e", "filename": "src/librustc_mir/borrow_check/mutability_errors.rs", "status": "modified", "additions": 83, "deletions": 0, "changes": 83, "blob_url": "https://github.com/rust-lang/rust/blob/71d3a715721137ffc10becc10978fe038ee131ac/src%2Flibrustc_mir%2Fborrow_check%2Fmutability_errors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/71d3a715721137ffc10becc10978fe038ee131ac/src%2Flibrustc_mir%2Fborrow_check%2Fmutability_errors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fborrow_check%2Fmutability_errors.rs?ref=71d3a715721137ffc10becc10978fe038ee131ac", "patch": "@@ -218,6 +218,38 @@ impl<'a, 'gcx, 'tcx> MirBorrowckCtxt<'a, 'gcx, 'tcx> {\n         debug!(\"report_mutability_error: act={:?}, acted_on={:?}\", act, acted_on);\n \n         match the_place_err {\n+            // Suggest making an existing shared borrow in a struct definition a mutable borrow.\n+            //\n+            // This is applicable when we have a deref of a field access to a deref of a local -\n+            // something like `*((*_1).0`. The local that we get will be a reference to the\n+            // struct we've got a field access of (it must be a reference since there's a deref\n+            // after the field access).\n+            Place::Projection(box Projection {\n+                base: Place::Projection(box Projection {\n+                    base: Place::Projection(box Projection {\n+                        base,\n+                        elem: ProjectionElem::Deref,\n+                    }),\n+                    elem: ProjectionElem::Field(field, _),\n+                }),\n+                elem: ProjectionElem::Deref,\n+            }) => {\n+                err.span_label(span, format!(\"cannot {ACT}\", ACT = act));\n+\n+                if let Some((span, message)) = annotate_struct_field(\n+                    self.infcx.tcx,\n+                    base.ty(self.mir, self.infcx.tcx).to_ty(self.infcx.tcx),\n+                    field,\n+                ) {\n+                    err.span_suggestion_with_applicability(\n+                        span,\n+                        \"consider changing this to be mutable\",\n+                        message,\n+                        Applicability::MaybeIncorrect,\n+                    );\n+                }\n+            },\n+\n             // Suggest removing a `&mut` from the use of a mutable reference.\n             Place::Local(local)\n                 if {\n@@ -592,3 +624,54 @@ fn suggest_ampmut<'cx, 'gcx, 'tcx>(\n fn is_closure_or_generator(ty: ty::Ty) -> bool {\n     ty.is_closure() || ty.is_generator()\n }\n+\n+/// Add a suggestion to a struct definition given a field access to a local.\n+/// This function expects the local to be a reference to a struct in order to produce a suggestion.\n+///\n+/// ```text\n+/// LL |     s: &'a String\n+///    |        ---------- use `&'a mut String` here to make mutable\n+/// ```\n+fn annotate_struct_field(\n+    tcx: TyCtxt<'cx, 'gcx, 'tcx>,\n+    ty: ty::Ty<'tcx>,\n+    field: &mir::Field,\n+) -> Option<(Span, String)> {\n+    // Expect our local to be a reference to a struct of some kind.\n+    if let ty::TyKind::Ref(_, ty, _) = ty.sty {\n+        if let ty::TyKind::Adt(def, _) = ty.sty {\n+            let field = def.all_fields().nth(field.index())?;\n+            // Use the HIR types to construct the diagnostic message.\n+            let node_id = tcx.hir.as_local_node_id(field.did)?;\n+            let node = tcx.hir.find(node_id)?;\n+            // Now we're dealing with the actual struct that we're going to suggest a change to,\n+            // we can expect a field that is an immutable reference to a type.\n+            if let hir::Node::Field(field) = node {\n+                if let hir::TyKind::Rptr(lifetime, hir::MutTy {\n+                    mutbl: hir::Mutability::MutImmutable,\n+                    ref ty\n+                }) = field.ty.node {\n+                    // Get the snippets in two parts - the named lifetime (if there is one) and\n+                    // type being referenced, that way we can reconstruct the snippet without loss\n+                    // of detail.\n+                    let type_snippet = tcx.sess.source_map().span_to_snippet(ty.span).ok()?;\n+                    let lifetime_snippet = if !lifetime.is_elided() {\n+                        format!(\"{} \", tcx.sess.source_map().span_to_snippet(lifetime.span).ok()?)\n+                    } else {\n+                        String::new()\n+                    };\n+\n+                    return Some((\n+                        field.ty.span,\n+                        format!(\n+                            \"&{}mut {}\",\n+                            lifetime_snippet, &*type_snippet,\n+                        ),\n+                    ));\n+                }\n+            }\n+        }\n+    }\n+\n+    None\n+}"}, {"sha": "ebd44d46eb2ce544eb8e082a9e58dfc194d64ac0", "filename": "src/test/ui/did_you_mean/issue-38147-2.nll.stderr", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/71d3a715721137ffc10becc10978fe038ee131ac/src%2Ftest%2Fui%2Fdid_you_mean%2Fissue-38147-2.nll.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/71d3a715721137ffc10becc10978fe038ee131ac/src%2Ftest%2Fui%2Fdid_you_mean%2Fissue-38147-2.nll.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fdid_you_mean%2Fissue-38147-2.nll.stderr?ref=71d3a715721137ffc10becc10978fe038ee131ac", "patch": "@@ -1,6 +1,9 @@\n error[E0596]: cannot borrow `*self.s` as mutable, as it is behind a `&` reference\n   --> $DIR/issue-38147-2.rs:17:9\n    |\n+LL |     s: &'a String\n+   |        ---------- help: consider changing this to be mutable: `&'a mut String`\n+...\n LL |         self.s.push('x');\n    |         ^^^^^^ cannot borrow as mutable\n "}, {"sha": "d644a84c7bbcec2da5723cf079f523f68c0746ae", "filename": "src/test/ui/did_you_mean/issue-38147-3.nll.stderr", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/71d3a715721137ffc10becc10978fe038ee131ac/src%2Ftest%2Fui%2Fdid_you_mean%2Fissue-38147-3.nll.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/71d3a715721137ffc10becc10978fe038ee131ac/src%2Ftest%2Fui%2Fdid_you_mean%2Fissue-38147-3.nll.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fdid_you_mean%2Fissue-38147-3.nll.stderr?ref=71d3a715721137ffc10becc10978fe038ee131ac", "patch": "@@ -1,6 +1,9 @@\n error[E0596]: cannot borrow `*self.s` as mutable, as it is behind a `&` reference\n   --> $DIR/issue-38147-3.rs:17:9\n    |\n+LL |     s: &'a String\n+   |        ---------- help: consider changing this to be mutable: `&'a mut String`\n+...\n LL |         self.s.push('x');\n    |         ^^^^^^ cannot borrow as mutable\n "}]}