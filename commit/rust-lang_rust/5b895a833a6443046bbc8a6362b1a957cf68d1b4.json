{"sha": "5b895a833a6443046bbc8a6362b1a957cf68d1b4", "node_id": "MDY6Q29tbWl0NzI0NzEyOjViODk1YTgzM2E2NDQzMDQ2YmJjOGE2MzYyYjFhOTU3Y2Y2OGQxYjQ=", "commit": {"author": {"name": "Aaron Turon", "email": "aturon@mozilla.com", "date": "2014-11-11T20:46:47Z"}, "committer": {"name": "Aaron Turon", "email": "aturon@mozilla.com", "date": "2014-11-11T23:06:54Z"}, "message": "rustc: do not inherit #[stable]\n\nThis patch tweaks the stability inheritance infrastructure so that\n`#{stable]` attributes are not inherited. Doing so solves two problems:\n\n1. It allows us to mark module *names* as stable without accidentally\nmarking the items they contain as stable.\n\n2. It means that a `#[stable]` attribution must always appear directly\non the item it applies to, which makes it easier for reviewers to catch\nchanges to stable APIs.\n\nFixes #17484", "tree": {"sha": "f0cf1b984101b26bf43ebe2c9bfb8c78e9501e71", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f0cf1b984101b26bf43ebe2c9bfb8c78e9501e71"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5b895a833a6443046bbc8a6362b1a957cf68d1b4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5b895a833a6443046bbc8a6362b1a957cf68d1b4", "html_url": "https://github.com/rust-lang/rust/commit/5b895a833a6443046bbc8a6362b1a957cf68d1b4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5b895a833a6443046bbc8a6362b1a957cf68d1b4/comments", "author": {"login": "aturon", "id": 709807, "node_id": "MDQ6VXNlcjcwOTgwNw==", "avatar_url": "https://avatars.githubusercontent.com/u/709807?v=4", "gravatar_id": "", "url": "https://api.github.com/users/aturon", "html_url": "https://github.com/aturon", "followers_url": "https://api.github.com/users/aturon/followers", "following_url": "https://api.github.com/users/aturon/following{/other_user}", "gists_url": "https://api.github.com/users/aturon/gists{/gist_id}", "starred_url": "https://api.github.com/users/aturon/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/aturon/subscriptions", "organizations_url": "https://api.github.com/users/aturon/orgs", "repos_url": "https://api.github.com/users/aturon/repos", "events_url": "https://api.github.com/users/aturon/events{/privacy}", "received_events_url": "https://api.github.com/users/aturon/received_events", "type": "User", "site_admin": false}, "committer": {"login": "aturon", "id": 709807, "node_id": "MDQ6VXNlcjcwOTgwNw==", "avatar_url": "https://avatars.githubusercontent.com/u/709807?v=4", "gravatar_id": "", "url": "https://api.github.com/users/aturon", "html_url": "https://github.com/aturon", "followers_url": "https://api.github.com/users/aturon/followers", "following_url": "https://api.github.com/users/aturon/following{/other_user}", "gists_url": "https://api.github.com/users/aturon/gists{/gist_id}", "starred_url": "https://api.github.com/users/aturon/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/aturon/subscriptions", "organizations_url": "https://api.github.com/users/aturon/orgs", "repos_url": "https://api.github.com/users/aturon/repos", "events_url": "https://api.github.com/users/aturon/events{/privacy}", "received_events_url": "https://api.github.com/users/aturon/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8f8753878644b0bfb38d24781edb9ef2028730f2", "url": "https://api.github.com/repos/rust-lang/rust/commits/8f8753878644b0bfb38d24781edb9ef2028730f2", "html_url": "https://github.com/rust-lang/rust/commit/8f8753878644b0bfb38d24781edb9ef2028730f2"}], "stats": {"total": 31, "additions": 19, "deletions": 12}, "files": [{"sha": "3b7ad9e8f6b344cf4358556134c12c14381dd42c", "filename": "src/librustc/middle/stability.rs", "status": "modified", "additions": 19, "deletions": 12, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/5b895a833a6443046bbc8a6362b1a957cf68d1b4/src%2Flibrustc%2Fmiddle%2Fstability.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5b895a833a6443046bbc8a6362b1a957cf68d1b4/src%2Flibrustc%2Fmiddle%2Fstability.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fstability.rs?ref=5b895a833a6443046bbc8a6362b1a957cf68d1b4", "patch": "@@ -17,8 +17,7 @@ use syntax::{attr, visit};\n use syntax::ast;\n use syntax::ast::{Attribute, Block, Crate, DefId, FnDecl, NodeId, Variant};\n use syntax::ast::{Item, RequiredMethod, ProvidedMethod, TraitItem};\n-use syntax::ast::{TypeMethod, Method, Generics, StructDef, StructField};\n-use syntax::ast::{Ident, TypeTraitItem};\n+use syntax::ast::{TypeMethod, Method, Generics, StructField, TypeTraitItem};\n use syntax::ast_util::is_local;\n use syntax::attr::Stability;\n use syntax::visit::{FnKind, FkMethod, Visitor};\n@@ -48,9 +47,15 @@ impl Annotator {\n         match attr::find_stability(attrs.as_slice()) {\n             Some(stab) => {\n                 self.index.local.insert(id, stab.clone());\n-                let parent = replace(&mut self.parent, Some(stab));\n-                f(self);\n-                self.parent = parent;\n+\n+                // Don't inherit #[stable]\n+                if stab.level != attr::Stable {\n+                    let parent = replace(&mut self.parent, Some(stab));\n+                    f(self);\n+                    self.parent = parent;\n+                } else {\n+                    f(self);\n+                }\n             }\n             None => {\n                 self.parent.clone().map(|stab| self.index.local.insert(id, stab));\n@@ -63,6 +68,15 @@ impl Annotator {\n impl<'v> Visitor<'v> for Annotator {\n     fn visit_item(&mut self, i: &Item) {\n         self.annotate(i.id, &i.attrs, |v| visit::walk_item(v, i));\n+\n+        match i.node {\n+            ast::ItemStruct(ref sd, _) => {\n+                sd.ctor_id.map(|id| {\n+                    self.annotate(id, &i.attrs, |_| {})\n+                });\n+            }\n+            _ => {}\n+        }\n     }\n \n     fn visit_fn(&mut self, fk: FnKind<'v>, fd: &'v FnDecl,\n@@ -95,13 +109,6 @@ impl<'v> Visitor<'v> for Annotator {\n         self.annotate(var.node.id, &var.node.attrs, |v| visit::walk_variant(v, var, g))\n     }\n \n-    fn visit_struct_def(&mut self, s: &StructDef, _: Ident, _: &Generics, _: NodeId) {\n-        match s.ctor_id {\n-            Some(id) => self.annotate(id, &vec![], |v| visit::walk_struct_def(v, s)),\n-            None => visit::walk_struct_def(self, s)\n-        }\n-    }\n-\n     fn visit_struct_field(&mut self, s: &StructField) {\n         self.annotate(s.node.id, &s.node.attrs, |v| visit::walk_struct_field(v, s));\n     }"}]}