{"sha": "738ed383066a561ae4f3ef0a6a2d570eaba7b6fa", "node_id": "MDY6Q29tbWl0NzI0NzEyOjczOGVkMzgzMDY2YTU2MWFlNGYzZWYwYTZhMmQ1NzBlYWJhN2I2ZmE=", "commit": {"author": {"name": "Jo\u00e3o Paulo Taylor Ienczak Zanette", "email": "jpaulotiz@gmail.com", "date": "2020-10-08T00:41:54Z"}, "committer": {"name": "Jo\u00e3o Paulo Taylor Ienczak Zanette", "email": "jpaulotiz@gmail.com", "date": "2020-10-08T00:41:54Z"}, "message": "clippy_lints: Do not warn against Box parameter in C FFI\n\nFixes #5542.\n\nWhen using C FFI, to handle pointers in parameters it is needed to\ndeclare them as `Box` in its Rust-side signature. However, the current\nlinter warns against the usage of Box stating that \"local variable\ndoesn't need to be boxed here\".\n\nThis commit fixes it by ignoring functions whose Abi is Cdecl.", "tree": {"sha": "47002d37388543cfc2408b060249161892531bea", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/47002d37388543cfc2408b060249161892531bea"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/738ed383066a561ae4f3ef0a6a2d570eaba7b6fa", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/738ed383066a561ae4f3ef0a6a2d570eaba7b6fa", "html_url": "https://github.com/rust-lang/rust/commit/738ed383066a561ae4f3ef0a6a2d570eaba7b6fa", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/738ed383066a561ae4f3ef0a6a2d570eaba7b6fa/comments", "author": {"login": "JPTIZ", "id": 11988816, "node_id": "MDQ6VXNlcjExOTg4ODE2", "avatar_url": "https://avatars.githubusercontent.com/u/11988816?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JPTIZ", "html_url": "https://github.com/JPTIZ", "followers_url": "https://api.github.com/users/JPTIZ/followers", "following_url": "https://api.github.com/users/JPTIZ/following{/other_user}", "gists_url": "https://api.github.com/users/JPTIZ/gists{/gist_id}", "starred_url": "https://api.github.com/users/JPTIZ/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JPTIZ/subscriptions", "organizations_url": "https://api.github.com/users/JPTIZ/orgs", "repos_url": "https://api.github.com/users/JPTIZ/repos", "events_url": "https://api.github.com/users/JPTIZ/events{/privacy}", "received_events_url": "https://api.github.com/users/JPTIZ/received_events", "type": "User", "site_admin": false}, "committer": {"login": "JPTIZ", "id": 11988816, "node_id": "MDQ6VXNlcjExOTg4ODE2", "avatar_url": "https://avatars.githubusercontent.com/u/11988816?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JPTIZ", "html_url": "https://github.com/JPTIZ", "followers_url": "https://api.github.com/users/JPTIZ/followers", "following_url": "https://api.github.com/users/JPTIZ/following{/other_user}", "gists_url": "https://api.github.com/users/JPTIZ/gists{/gist_id}", "starred_url": "https://api.github.com/users/JPTIZ/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JPTIZ/subscriptions", "organizations_url": "https://api.github.com/users/JPTIZ/orgs", "repos_url": "https://api.github.com/users/JPTIZ/repos", "events_url": "https://api.github.com/users/JPTIZ/events{/privacy}", "received_events_url": "https://api.github.com/users/JPTIZ/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "13a80b34baab0576e07eaa986d68a355cb1637a9", "url": "https://api.github.com/repos/rust-lang/rust/commits/13a80b34baab0576e07eaa986d68a355cb1637a9", "html_url": "https://github.com/rust-lang/rust/commit/13a80b34baab0576e07eaa986d68a355cb1637a9"}], "stats": {"total": 9, "additions": 8, "deletions": 1}, "files": [{"sha": "ffe81b3966c7c71951651397660ee341527954a9", "filename": "clippy_lints/src/escape.rs", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/738ed383066a561ae4f3ef0a6a2d570eaba7b6fa/clippy_lints%2Fsrc%2Fescape.rs", "raw_url": "https://github.com/rust-lang/rust/raw/738ed383066a561ae4f3ef0a6a2d570eaba7b6fa/clippy_lints%2Fsrc%2Fescape.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fescape.rs?ref=738ed383066a561ae4f3ef0a6a2d570eaba7b6fa", "patch": "@@ -6,6 +6,7 @@ use rustc_middle::ty::{self, Ty};\n use rustc_session::{declare_tool_lint, impl_lint_pass};\n use rustc_span::source_map::Span;\n use rustc_target::abi::LayoutOf;\n+use rustc_target::spec::abi::Abi;\n use rustc_typeck::expr_use_visitor::{ConsumeMode, Delegate, ExprUseVisitor, PlaceBase, PlaceWithHirId};\n \n use crate::utils::span_lint;\n@@ -60,12 +61,18 @@ impl<'tcx> LateLintPass<'tcx> for BoxedLocal {\n     fn check_fn(\n         &mut self,\n         cx: &LateContext<'tcx>,\n-        _: intravisit::FnKind<'tcx>,\n+        fn_kind: intravisit::FnKind<'tcx>,\n         _: &'tcx FnDecl<'_>,\n         body: &'tcx Body<'_>,\n         _: Span,\n         hir_id: HirId,\n     ) {\n+        if let Some(header) = fn_kind.header() {\n+            if header.abi == Abi::Cdecl {\n+                return;\n+            }\n+        }\n+\n         // If the method is an impl for a trait, don't warn.\n         let parent_id = cx.tcx.hir().get_parent_item(hir_id);\n         let parent_node = cx.tcx.hir().find(parent_id);"}]}