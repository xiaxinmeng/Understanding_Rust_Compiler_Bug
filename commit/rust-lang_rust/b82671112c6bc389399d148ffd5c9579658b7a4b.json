{"sha": "b82671112c6bc389399d148ffd5c9579658b7a4b", "node_id": "MDY6Q29tbWl0NzI0NzEyOmI4MjY3MTExMmM2YmMzODkzOTlkMTQ4ZmZkNWM5NTc5NjU4YjdhNGI=", "commit": {"author": {"name": "Markus Reiter", "email": "me@reitermark.us", "date": "2019-12-20T03:27:28Z"}, "committer": {"name": "Markus Reiter", "email": "me@reitermark.us", "date": "2019-12-20T03:27:28Z"}, "message": "Remove `SOCK_CLOEXEC` dummy variable on platforms that don't use it.", "tree": {"sha": "9e111e8b202552e24a0ed0c4c1fe23b66e957ec3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9e111e8b202552e24a0ed0c4c1fe23b66e957ec3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b82671112c6bc389399d148ffd5c9579658b7a4b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b82671112c6bc389399d148ffd5c9579658b7a4b", "html_url": "https://github.com/rust-lang/rust/commit/b82671112c6bc389399d148ffd5c9579658b7a4b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b82671112c6bc389399d148ffd5c9579658b7a4b/comments", "author": {"login": "reitermarkus", "id": 1309829, "node_id": "MDQ6VXNlcjEzMDk4Mjk=", "avatar_url": "https://avatars.githubusercontent.com/u/1309829?v=4", "gravatar_id": "", "url": "https://api.github.com/users/reitermarkus", "html_url": "https://github.com/reitermarkus", "followers_url": "https://api.github.com/users/reitermarkus/followers", "following_url": "https://api.github.com/users/reitermarkus/following{/other_user}", "gists_url": "https://api.github.com/users/reitermarkus/gists{/gist_id}", "starred_url": "https://api.github.com/users/reitermarkus/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/reitermarkus/subscriptions", "organizations_url": "https://api.github.com/users/reitermarkus/orgs", "repos_url": "https://api.github.com/users/reitermarkus/repos", "events_url": "https://api.github.com/users/reitermarkus/events{/privacy}", "received_events_url": "https://api.github.com/users/reitermarkus/received_events", "type": "User", "site_admin": false}, "committer": {"login": "reitermarkus", "id": 1309829, "node_id": "MDQ6VXNlcjEzMDk4Mjk=", "avatar_url": "https://avatars.githubusercontent.com/u/1309829?v=4", "gravatar_id": "", "url": "https://api.github.com/users/reitermarkus", "html_url": "https://github.com/reitermarkus", "followers_url": "https://api.github.com/users/reitermarkus/followers", "following_url": "https://api.github.com/users/reitermarkus/following{/other_user}", "gists_url": "https://api.github.com/users/reitermarkus/gists{/gist_id}", "starred_url": "https://api.github.com/users/reitermarkus/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/reitermarkus/subscriptions", "organizations_url": "https://api.github.com/users/reitermarkus/orgs", "repos_url": "https://api.github.com/users/reitermarkus/repos", "events_url": "https://api.github.com/users/reitermarkus/events{/privacy}", "received_events_url": "https://api.github.com/users/reitermarkus/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "19b3813b5eab1988312f222e4316d3a225e20966", "url": "https://api.github.com/repos/rust-lang/rust/commits/19b3813b5eab1988312f222e4316d3a225e20966", "html_url": "https://github.com/rust-lang/rust/commit/19b3813b5eab1988312f222e4316d3a225e20966"}], "stats": {"total": 27, "additions": 9, "deletions": 18}, "files": [{"sha": "4c23aabf49741493e8b6676f83485c2103ea96da", "filename": "src/libstd/sys/unix/net.rs", "status": "modified", "additions": 9, "deletions": 16, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/b82671112c6bc389399d148ffd5c9579658b7a4b/src%2Flibstd%2Fsys%2Funix%2Fnet.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b82671112c6bc389399d148ffd5c9579658b7a4b/src%2Flibstd%2Fsys%2Funix%2Fnet.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Funix%2Fnet.rs?ref=b82671112c6bc389399d148ffd5c9579658b7a4b", "patch": "@@ -18,16 +18,6 @@ pub extern crate libc as netc;\n \n pub type wrlen_t = size_t;\n \n-// See below for the usage of SOCK_CLOEXEC, but this constant is only defined on\n-// Linux currently (e.g., support doesn't exist on other platforms). In order to\n-// get name resolution to work and things to compile we just define a dummy\n-// SOCK_CLOEXEC here for other platforms. Note that the dummy constant isn't\n-// actually ever used (the blocks below are wrapped in `if cfg!` as well.\n-#[cfg(target_os = \"linux\")]\n-use libc::SOCK_CLOEXEC;\n-#[cfg(not(target_os = \"linux\"))]\n-const SOCK_CLOEXEC: c_int = 0;\n-\n pub struct Socket(FileDesc);\n \n pub fn init() {}\n@@ -69,8 +59,9 @@ impl Socket {\n             // this option, however, was added in 2.6.27, and we still support\n             // 2.6.18 as a kernel, so if the returned error is EINVAL we\n             // fallthrough to the fallback.\n-            if cfg!(target_os = \"linux\") {\n-                match cvt(libc::socket(fam, ty | SOCK_CLOEXEC, 0)) {\n+            #[cfg(target_os = \"linux\")]\n+            {\n+                match cvt(libc::socket(fam, ty | libc::SOCK_CLOEXEC, 0)) {\n                     Ok(fd) => return Ok(Socket(FileDesc::new(fd))),\n                     Err(ref e) if e.raw_os_error() == Some(libc::EINVAL) => {}\n                     Err(e) => return Err(e),\n@@ -96,8 +87,9 @@ impl Socket {\n             let mut fds = [0, 0];\n \n             // Like above, see if we can set cloexec atomically\n-            if cfg!(target_os = \"linux\") {\n-                match cvt(libc::socketpair(fam, ty | SOCK_CLOEXEC, 0, fds.as_mut_ptr())) {\n+            #[cfg(target_os = \"linux\")]\n+            {\n+                match cvt(libc::socketpair(fam, ty | libc::SOCK_CLOEXEC, 0, fds.as_mut_ptr())) {\n                     Ok(_) => {\n                         return Ok((Socket(FileDesc::new(fds[0])), Socket(FileDesc::new(fds[1]))));\n                     }\n@@ -187,7 +179,8 @@ impl Socket {\n         // atomically set the CLOEXEC flag is to use the `accept4` syscall on\n         // Linux. This was added in 2.6.28, however, and because we support\n         // 2.6.18 we must detect this support dynamically.\n-        if cfg!(target_os = \"linux\") {\n+        #[cfg(target_os = \"linux\")]\n+        {\n             syscall! {\n                 fn accept4(\n                     fd: c_int,\n@@ -196,7 +189,7 @@ impl Socket {\n                     flags: c_int\n                 ) -> c_int\n             }\n-            let res = cvt_r(|| unsafe { accept4(self.0.raw(), storage, len, SOCK_CLOEXEC) });\n+            let res = cvt_r(|| unsafe { accept4(self.0.raw(), storage, len, libc::SOCK_CLOEXEC) });\n             match res {\n                 Ok(fd) => return Ok(Socket(FileDesc::new(fd))),\n                 Err(ref e) if e.raw_os_error() == Some(libc::ENOSYS) => {}"}, {"sha": "74cbd246fe8198b8266719cc70de0ac4a705dbea", "filename": "src/libstd/sys/vxworks/net.rs", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b82671112c6bc389399d148ffd5c9579658b7a4b/src%2Flibstd%2Fsys%2Fvxworks%2Fnet.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b82671112c6bc389399d148ffd5c9579658b7a4b/src%2Flibstd%2Fsys%2Fvxworks%2Fnet.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Fvxworks%2Fnet.rs?ref=b82671112c6bc389399d148ffd5c9579658b7a4b", "patch": "@@ -18,8 +18,6 @@ pub extern crate libc as netc;\n \n pub type wrlen_t = size_t;\n \n-const SOCK_CLOEXEC: c_int = 0;\n-\n pub struct Socket(FileDesc);\n \n pub fn init() {}"}]}