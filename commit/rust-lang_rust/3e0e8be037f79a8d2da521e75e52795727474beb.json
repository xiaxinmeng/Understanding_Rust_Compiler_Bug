{"sha": "3e0e8be037f79a8d2da521e75e52795727474beb", "node_id": "C_kwDOAAsO6NoAKDNlMGU4YmUwMzdmNzlhOGQyZGE1MjFlNzVlNTI3OTU3Mjc0NzRiZWI", "commit": {"author": {"name": "Dylan MacKenzie", "email": "ecstaticmorse@gmail.com", "date": "2021-11-30T23:45:16Z"}, "committer": {"name": "Dylan MacKenzie", "email": "ecstaticmorse@gmail.com", "date": "2021-12-01T01:25:30Z"}, "message": "Handle `DropAndReplace` in const-checking\n\nIt runs before the real drop elaboration pass.", "tree": {"sha": "9b6a6039eb13c89726cc4e688318b522b137ed83", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9b6a6039eb13c89726cc4e688318b522b137ed83"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3e0e8be037f79a8d2da521e75e52795727474beb", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3e0e8be037f79a8d2da521e75e52795727474beb", "html_url": "https://github.com/rust-lang/rust/commit/3e0e8be037f79a8d2da521e75e52795727474beb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3e0e8be037f79a8d2da521e75e52795727474beb/comments", "author": {"login": "ecstatic-morse", "id": 29463364, "node_id": "MDQ6VXNlcjI5NDYzMzY0", "avatar_url": "https://avatars.githubusercontent.com/u/29463364?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ecstatic-morse", "html_url": "https://github.com/ecstatic-morse", "followers_url": "https://api.github.com/users/ecstatic-morse/followers", "following_url": "https://api.github.com/users/ecstatic-morse/following{/other_user}", "gists_url": "https://api.github.com/users/ecstatic-morse/gists{/gist_id}", "starred_url": "https://api.github.com/users/ecstatic-morse/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ecstatic-morse/subscriptions", "organizations_url": "https://api.github.com/users/ecstatic-morse/orgs", "repos_url": "https://api.github.com/users/ecstatic-morse/repos", "events_url": "https://api.github.com/users/ecstatic-morse/events{/privacy}", "received_events_url": "https://api.github.com/users/ecstatic-morse/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ecstatic-morse", "id": 29463364, "node_id": "MDQ6VXNlcjI5NDYzMzY0", "avatar_url": "https://avatars.githubusercontent.com/u/29463364?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ecstatic-morse", "html_url": "https://github.com/ecstatic-morse", "followers_url": "https://api.github.com/users/ecstatic-morse/followers", "following_url": "https://api.github.com/users/ecstatic-morse/following{/other_user}", "gists_url": "https://api.github.com/users/ecstatic-morse/gists{/gist_id}", "starred_url": "https://api.github.com/users/ecstatic-morse/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ecstatic-morse/subscriptions", "organizations_url": "https://api.github.com/users/ecstatic-morse/orgs", "repos_url": "https://api.github.com/users/ecstatic-morse/repos", "events_url": "https://api.github.com/users/ecstatic-morse/events{/privacy}", "received_events_url": "https://api.github.com/users/ecstatic-morse/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ce2959da97aa98596ee041a3e42d30e50e3f2d7b", "url": "https://api.github.com/repos/rust-lang/rust/commits/ce2959da97aa98596ee041a3e42d30e50e3f2d7b", "html_url": "https://github.com/rust-lang/rust/commit/ce2959da97aa98596ee041a3e42d30e50e3f2d7b"}], "stats": {"total": 8, "additions": 2, "deletions": 6}, "files": [{"sha": "c1d47baa405311685cde2c10cd5da9c6dbd282ee", "filename": "compiler/rustc_const_eval/src/transform/check_consts/post_drop_elaboration.rs", "status": "modified", "additions": 2, "deletions": 6, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/3e0e8be037f79a8d2da521e75e52795727474beb/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fpost_drop_elaboration.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3e0e8be037f79a8d2da521e75e52795727474beb/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fpost_drop_elaboration.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fpost_drop_elaboration.rs?ref=3e0e8be037f79a8d2da521e75e52795727474beb", "patch": "@@ -80,7 +80,8 @@ impl Visitor<'tcx> for CheckLiveDrops<'mir, 'tcx> {\n         trace!(\"visit_terminator: terminator={:?} location={:?}\", terminator, location);\n \n         match &terminator.kind {\n-            mir::TerminatorKind::Drop { place: dropped_place, .. } => {\n+            mir::TerminatorKind::Drop { place: dropped_place, .. }\n+            | mir::TerminatorKind::DropAndReplace { place: dropped_place, .. } => {\n                 let dropped_ty = dropped_place.ty(self.body, self.tcx).ty;\n                 if !NeedsNonConstDrop::in_any_value_of_ty(self.ccx, dropped_ty) {\n                     // Instead of throwing a bug, we just return here. This is because we have to\n@@ -104,11 +105,6 @@ impl Visitor<'tcx> for CheckLiveDrops<'mir, 'tcx> {\n                 }\n             }\n \n-            mir::TerminatorKind::DropAndReplace { .. } => span_bug!(\n-                terminator.source_info.span,\n-                \"`DropAndReplace` should be removed by drop elaboration\",\n-            ),\n-\n             mir::TerminatorKind::Abort\n             | mir::TerminatorKind::Call { .. }\n             | mir::TerminatorKind::Assert { .. }"}]}