{"sha": "64710790d6ce6fce7aa33a07932fb46bdf54d7b3", "node_id": "C_kwDOAAsO6NoAKDY0NzEwNzkwZDZjZTZmY2U3YWEzM2EwNzkzMmZiNDZiZGY1NGQ3YjM", "commit": {"author": {"name": "nils", "email": "48135649+Nilstrieb@users.noreply.github.com", "date": "2023-03-28T10:51:13Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-03-28T10:51:13Z"}, "message": "Rollup merge of #109321 - compiler-errors:illegal-mono-w-regions, r=cjgillot\n\nErase impl regions when checking for impossible to eagerly monomorphize items\n\nWe were inserting `ReErased` for method substs, but not for impl substs, leading to the call for `subst_and_check_impossible_predicates` being a bit weaker than it should be (since it ignores predicates that need substitution -- incl early-bound regions).\n\nFixes #109297", "tree": {"sha": "78bb1b9a3f7a367de8dd403df9d4ec2172a2d1a9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/78bb1b9a3f7a367de8dd403df9d4ec2172a2d1a9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/64710790d6ce6fce7aa33a07932fb46bdf54d7b3", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkIsahCRBK7hj4Ov3rIwAAECkIAEErgUbMiAYCfEuQSoLfAdU1\nrnY2Bm/UQ1gpDvq9r7y0Cuv2LhRGgo7uvqv7EcaohJCKC8n1vsdekjipce/BF7xO\ngLCzDoA1EpH1dzGqEJsdr2TOhHMXZaliwAPZ1h3E4myX58zOcGFA4BfG4i4oQV5B\nqXUqxwLZrOVbjX4G+T+uZ1hDPjRiFjgjCGfd9ih0opyeq3M4ovwdtOj6TgnSLDml\n1jG9ZEpvsN7sOZ69onMxvELTJzMiJsSEYllgu8xJmdlL1BMEADFwQj+2lAH+sfLi\nB7Gmbwypo3eEtybO3wVQyTj5Hr10JiW0GcQsh4kC8/MS7PF6oBmU36Dg3eSuY9Q=\n=qO6S\n-----END PGP SIGNATURE-----\n", "payload": "tree 78bb1b9a3f7a367de8dd403df9d4ec2172a2d1a9\nparent c31f75209f0718e74b9ca48dab46c069c09744b1\nparent e3b0a728b4aa886fcb451b2a3bd7662942a5acaa\nauthor nils <48135649+Nilstrieb@users.noreply.github.com> 1680000673 +0200\ncommitter GitHub <noreply@github.com> 1680000673 +0200\n\nRollup merge of #109321 - compiler-errors:illegal-mono-w-regions, r=cjgillot\n\nErase impl regions when checking for impossible to eagerly monomorphize items\n\nWe were inserting `ReErased` for method substs, but not for impl substs, leading to the call for `subst_and_check_impossible_predicates` being a bit weaker than it should be (since it ignores predicates that need substitution -- incl early-bound regions).\n\nFixes #109297\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/64710790d6ce6fce7aa33a07932fb46bdf54d7b3", "html_url": "https://github.com/rust-lang/rust/commit/64710790d6ce6fce7aa33a07932fb46bdf54d7b3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/64710790d6ce6fce7aa33a07932fb46bdf54d7b3/comments", "author": {"login": "Nilstrieb", "id": 48135649, "node_id": "MDQ6VXNlcjQ4MTM1NjQ5", "avatar_url": "https://avatars.githubusercontent.com/u/48135649?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Nilstrieb", "html_url": "https://github.com/Nilstrieb", "followers_url": "https://api.github.com/users/Nilstrieb/followers", "following_url": "https://api.github.com/users/Nilstrieb/following{/other_user}", "gists_url": "https://api.github.com/users/Nilstrieb/gists{/gist_id}", "starred_url": "https://api.github.com/users/Nilstrieb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Nilstrieb/subscriptions", "organizations_url": "https://api.github.com/users/Nilstrieb/orgs", "repos_url": "https://api.github.com/users/Nilstrieb/repos", "events_url": "https://api.github.com/users/Nilstrieb/events{/privacy}", "received_events_url": "https://api.github.com/users/Nilstrieb/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c31f75209f0718e74b9ca48dab46c069c09744b1", "url": "https://api.github.com/repos/rust-lang/rust/commits/c31f75209f0718e74b9ca48dab46c069c09744b1", "html_url": "https://github.com/rust-lang/rust/commit/c31f75209f0718e74b9ca48dab46c069c09744b1"}, {"sha": "e3b0a728b4aa886fcb451b2a3bd7662942a5acaa", "url": "https://api.github.com/repos/rust-lang/rust/commits/e3b0a728b4aa886fcb451b2a3bd7662942a5acaa", "html_url": "https://github.com/rust-lang/rust/commit/e3b0a728b4aa886fcb451b2a3bd7662942a5acaa"}], "stats": {"total": 67, "additions": 48, "deletions": 19}, "files": [{"sha": "c286046fb674c1627af3a06aa165961b335624d9", "filename": "compiler/rustc_monomorphize/src/collector.rs", "status": "modified", "additions": 29, "deletions": 19, "changes": 48, "blob_url": "https://github.com/rust-lang/rust/blob/64710790d6ce6fce7aa33a07932fb46bdf54d7b3/compiler%2Frustc_monomorphize%2Fsrc%2Fcollector.rs", "raw_url": "https://github.com/rust-lang/rust/raw/64710790d6ce6fce7aa33a07932fb46bdf54d7b3/compiler%2Frustc_monomorphize%2Fsrc%2Fcollector.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_monomorphize%2Fsrc%2Fcollector.rs?ref=64710790d6ce6fce7aa33a07932fb46bdf54d7b3", "patch": "@@ -1326,27 +1326,40 @@ fn create_mono_items_for_default_impls<'tcx>(\n         return;\n     }\n \n+    let Some(trait_ref) = tcx.impl_trait_ref(item.owner_id) else {\n+        return;\n+    };\n+\n+    // Lifetimes never affect trait selection, so we are allowed to eagerly\n+    // instantiate an instance of an impl method if the impl (and method,\n+    // which we check below) is only parameterized over lifetime. In that case,\n+    // we use the ReErased, which has no lifetime information associated with\n+    // it, to validate whether or not the impl is legal to instantiate at all.\n+    let only_region_params = |param: &ty::GenericParamDef, _: &_| match param.kind {\n+        GenericParamDefKind::Lifetime => tcx.lifetimes.re_erased.into(),\n+        GenericParamDefKind::Type { .. } | GenericParamDefKind::Const { .. } => {\n+            unreachable!(\n+                \"`own_requires_monomorphization` check means that \\\n+                we should have no type/const params\"\n+            )\n+        }\n+    };\n+    let impl_substs = InternalSubsts::for_item(tcx, item.owner_id.to_def_id(), only_region_params);\n+    let trait_ref = trait_ref.subst(tcx, impl_substs);\n+\n     // Unlike 'lazy' monomorphization that begins by collecting items transitively\n     // called by `main` or other global items, when eagerly monomorphizing impl\n     // items, we never actually check that the predicates of this impl are satisfied\n     // in a empty reveal-all param env (i.e. with no assumptions).\n     //\n-    // Even though this impl has no substitutions, because we don't consider higher-\n-    // ranked predicates such as `for<'a> &'a mut [u8]: Copy` to be trivially false,\n-    // we must now check that the impl has no impossible-to-satisfy predicates.\n-    if tcx.subst_and_check_impossible_predicates((\n-        item.owner_id.to_def_id(),\n-        &InternalSubsts::identity_for_item(tcx, item.owner_id.to_def_id()),\n-    )) {\n+    // Even though this impl has no type or const substitutions, because we don't\n+    // consider higher-ranked predicates such as `for<'a> &'a mut [u8]: Copy` to\n+    // be trivially false. We must now check that the impl has no impossible-to-satisfy\n+    // predicates.\n+    if tcx.subst_and_check_impossible_predicates((item.owner_id.to_def_id(), impl_substs)) {\n         return;\n     }\n \n-    let Some(trait_ref) = tcx.impl_trait_ref(item.owner_id) else {\n-        return;\n-    };\n-\n-    let trait_ref = trait_ref.subst_identity();\n-\n     let param_env = ty::ParamEnv::reveal_all();\n     let trait_ref = tcx.normalize_erasing_regions(param_env, trait_ref);\n     let overridden_methods = tcx.impl_item_implementor_ids(item.owner_id);\n@@ -1359,12 +1372,9 @@ fn create_mono_items_for_default_impls<'tcx>(\n             continue;\n         }\n \n-        let substs = InternalSubsts::for_item(tcx, method.def_id, |param, _| match param.kind {\n-            GenericParamDefKind::Lifetime => tcx.lifetimes.re_erased.into(),\n-            GenericParamDefKind::Type { .. } | GenericParamDefKind::Const { .. } => {\n-                trait_ref.substs[param.index as usize]\n-            }\n-        });\n+        // As mentioned above, the method is legal to eagerly instantiate if it\n+        // only has lifetime substitutions. This is validated by\n+        let substs = trait_ref.substs.extend_to(tcx, method.def_id, only_region_params);\n         let instance = ty::Instance::expect_resolve(tcx, param_env, method.def_id, substs);\n \n         let mono_item = create_fn_mono_item(tcx, instance, DUMMY_SP);"}, {"sha": "21eb2c9b2f2da329cc9cd3e703115a66ba753f21", "filename": "tests/ui/codegen/mono-impossible-2.rs", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/64710790d6ce6fce7aa33a07932fb46bdf54d7b3/tests%2Fui%2Fcodegen%2Fmono-impossible-2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/64710790d6ce6fce7aa33a07932fb46bdf54d7b3/tests%2Fui%2Fcodegen%2Fmono-impossible-2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcodegen%2Fmono-impossible-2.rs?ref=64710790d6ce6fce7aa33a07932fb46bdf54d7b3", "patch": "@@ -0,0 +1,19 @@\n+//compile-flags: --crate-type=lib -Clink-dead-code=on\n+// build-pass\n+\n+// Make sure that we don't monomorphize the impossible method `<() as Visit>::visit`,\n+// which does not hold under a reveal-all param env.\n+\n+pub trait Visit {\n+    fn visit() {}\n+}\n+\n+pub trait Array {\n+    type Element;\n+}\n+\n+impl<'a> Visit for () where (): Array<Element = &'a ()> {}\n+\n+impl Array for () {\n+    type Element = ();\n+}"}]}