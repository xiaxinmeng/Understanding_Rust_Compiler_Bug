{"sha": "d3e123fc4f8c2907db8a88e851ecb5149fa7670f", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQzZTEyM2ZjNGY4YzI5MDdkYjhhODhlODUxZWNiNTE0OWZhNzY3MGY=", "commit": {"author": {"name": "Charles Lew", "email": "crlf0710@gmail.com", "date": "2021-06-14T10:02:53Z"}, "committer": {"name": "Charles Lew", "email": "crlf0710@gmail.com", "date": "2021-06-14T17:59:00Z"}, "message": "Refactor to make interpreter and codegen backend neutral to vtable internal representation.", "tree": {"sha": "e04af47e6cbb4cc30beb365cf7bb75a167d9bea4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e04af47e6cbb4cc30beb365cf7bb75a167d9bea4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d3e123fc4f8c2907db8a88e851ecb5149fa7670f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d3e123fc4f8c2907db8a88e851ecb5149fa7670f", "html_url": "https://github.com/rust-lang/rust/commit/d3e123fc4f8c2907db8a88e851ecb5149fa7670f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d3e123fc4f8c2907db8a88e851ecb5149fa7670f/comments", "author": {"login": "crlf0710", "id": 451806, "node_id": "MDQ6VXNlcjQ1MTgwNg==", "avatar_url": "https://avatars.githubusercontent.com/u/451806?v=4", "gravatar_id": "", "url": "https://api.github.com/users/crlf0710", "html_url": "https://github.com/crlf0710", "followers_url": "https://api.github.com/users/crlf0710/followers", "following_url": "https://api.github.com/users/crlf0710/following{/other_user}", "gists_url": "https://api.github.com/users/crlf0710/gists{/gist_id}", "starred_url": "https://api.github.com/users/crlf0710/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/crlf0710/subscriptions", "organizations_url": "https://api.github.com/users/crlf0710/orgs", "repos_url": "https://api.github.com/users/crlf0710/repos", "events_url": "https://api.github.com/users/crlf0710/events{/privacy}", "received_events_url": "https://api.github.com/users/crlf0710/received_events", "type": "User", "site_admin": false}, "committer": {"login": "crlf0710", "id": 451806, "node_id": "MDQ6VXNlcjQ1MTgwNg==", "avatar_url": "https://avatars.githubusercontent.com/u/451806?v=4", "gravatar_id": "", "url": "https://api.github.com/users/crlf0710", "html_url": "https://github.com/crlf0710", "followers_url": "https://api.github.com/users/crlf0710/followers", "following_url": "https://api.github.com/users/crlf0710/following{/other_user}", "gists_url": "https://api.github.com/users/crlf0710/gists{/gist_id}", "starred_url": "https://api.github.com/users/crlf0710/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/crlf0710/subscriptions", "organizations_url": "https://api.github.com/users/crlf0710/orgs", "repos_url": "https://api.github.com/users/crlf0710/repos", "events_url": "https://api.github.com/users/crlf0710/events{/privacy}", "received_events_url": "https://api.github.com/users/crlf0710/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "fa7545e49b212b569cf79694330b0d6550f335b4", "url": "https://api.github.com/repos/rust-lang/rust/commits/fa7545e49b212b569cf79694330b0d6550f335b4", "html_url": "https://github.com/rust-lang/rust/commit/fa7545e49b212b569cf79694330b0d6550f335b4"}], "stats": {"total": 72, "additions": 38, "deletions": 34}, "files": [{"sha": "4d1ee47b41e170c910d0f91d80d34c6c12717ad4", "filename": "src/vtable.rs", "status": "modified", "additions": 38, "deletions": 34, "changes": 72, "blob_url": "https://github.com/rust-lang/rust/blob/d3e123fc4f8c2907db8a88e851ecb5149fa7670f/src%2Fvtable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d3e123fc4f8c2907db8a88e851ecb5149fa7670f/src%2Fvtable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fvtable.rs?ref=d3e123fc4f8c2907db8a88e851ecb5149fa7670f", "patch": "@@ -4,10 +4,7 @@\n // FIXME dedup this logic between miri, cg_llvm and cg_clif\n \n use crate::prelude::*;\n-\n-const DROP_FN_INDEX: usize = 0;\n-const SIZE_INDEX: usize = 1;\n-const ALIGN_INDEX: usize = 2;\n+use ty::VtblEntry;\n \n fn vtable_memflags() -> MemFlags {\n     let mut flags = MemFlags::trusted(); // A vtable access is always aligned and will never trap.\n@@ -21,7 +18,7 @@ pub(crate) fn drop_fn_of_obj(fx: &mut FunctionCx<'_, '_, '_>, vtable: Value) ->\n         pointer_ty(fx.tcx),\n         vtable_memflags(),\n         vtable,\n-        (DROP_FN_INDEX * usize_size) as i32,\n+        (ty::COMMON_VTABLE_ENTRIES_DROPINPLACE * usize_size) as i32,\n     )\n }\n \n@@ -31,7 +28,7 @@ pub(crate) fn size_of_obj(fx: &mut FunctionCx<'_, '_, '_>, vtable: Value) -> Val\n         pointer_ty(fx.tcx),\n         vtable_memflags(),\n         vtable,\n-        (SIZE_INDEX * usize_size) as i32,\n+        (ty::COMMON_VTABLE_ENTRIES_SIZE * usize_size) as i32,\n     )\n }\n \n@@ -41,7 +38,7 @@ pub(crate) fn min_align_of_obj(fx: &mut FunctionCx<'_, '_, '_>, vtable: Value) -\n         pointer_ty(fx.tcx),\n         vtable_memflags(),\n         vtable,\n-        (ALIGN_INDEX * usize_size) as i32,\n+        (ty::COMMON_VTABLE_ENTRIES_SIZE * usize_size) as i32,\n     )\n }\n \n@@ -62,7 +59,7 @@ pub(crate) fn get_ptr_and_method_ref<'tcx>(\n         pointer_ty(fx.tcx),\n         vtable_memflags(),\n         vtable,\n-        ((idx + 3) * usize_size as usize) as i32,\n+        (idx * usize_size as usize) as i32,\n     );\n     (ptr, func_ref)\n }\n@@ -98,42 +95,49 @@ fn build_vtable<'tcx>(\n         Instance::resolve_drop_in_place(tcx, layout.ty).polymorphize(fx.tcx),\n     );\n \n-    let mut components: Vec<_> = vec![Some(drop_in_place_fn), None, None];\n-\n-    let methods_root;\n-    let methods = if let Some(trait_ref) = trait_ref {\n-        methods_root = tcx.vtable_methods(trait_ref.with_self_ty(tcx, layout.ty));\n-        methods_root.iter()\n+    let vtable_entries = if let Some(trait_ref) = trait_ref {\n+        tcx.vtable_entries(trait_ref.with_self_ty(tcx, layout.ty))\n     } else {\n-        (&[]).iter()\n+        ty::COMMON_VTABLE_ENTRIES\n     };\n-    let methods = methods.cloned().map(|opt_mth| {\n-        opt_mth.map(|(def_id, substs)| {\n-            import_function(\n-                tcx,\n-                fx.module,\n-                Instance::resolve_for_vtable(tcx, ParamEnv::reveal_all(), def_id, substs)\n-                    .unwrap()\n-                    .polymorphize(fx.tcx),\n-            )\n-        })\n-    });\n-    components.extend(methods);\n \n     let mut data_ctx = DataContext::new();\n     let mut data = ::std::iter::repeat(0u8)\n-        .take(components.len() * usize_size)\n+        .take(vtable_entries.len() * usize_size)\n         .collect::<Vec<u8>>()\n         .into_boxed_slice();\n \n-    write_usize(fx.tcx, &mut data, SIZE_INDEX, layout.size.bytes());\n-    write_usize(fx.tcx, &mut data, ALIGN_INDEX, layout.align.abi.bytes());\n+    for (idx, entry) in vtable_entries.iter().enumerate() {\n+        match entry {\n+            VtblEntry::MetadataSize => {\n+                write_usize(fx.tcx, &mut data, idx, layout.size.bytes());\n+            }\n+            VtblEntry::MetadataAlign => {\n+                write_usize(fx.tcx, &mut data, idx, layout.align.abi.bytes());\n+            }\n+            VtblEntry::MetadataDropInPlace | VtblEntry::Vacant | VtblEntry::Method(_, _) => {}\n+        }\n+    }\n     data_ctx.define(data);\n \n-    for (i, component) in components.into_iter().enumerate() {\n-        if let Some(func_id) = component {\n-            let func_ref = fx.module.declare_func_in_data(func_id, &mut data_ctx);\n-            data_ctx.write_function_addr((i * usize_size) as u32, func_ref);\n+    for (idx, entry) in vtable_entries.iter().enumerate() {\n+        match entry {\n+            VtblEntry::MetadataDropInPlace => {\n+                let func_ref = fx.module.declare_func_in_data(drop_in_place_fn, &mut data_ctx);\n+                data_ctx.write_function_addr((idx * usize_size) as u32, func_ref);\n+            }\n+            VtblEntry::Method(def_id, substs) => {\n+                let func_id = import_function(\n+                    tcx,\n+                    fx.module,\n+                    Instance::resolve_for_vtable(tcx, ParamEnv::reveal_all(), *def_id, substs)\n+                        .unwrap()\n+                        .polymorphize(fx.tcx),\n+                );\n+                let func_ref = fx.module.declare_func_in_data(func_id, &mut data_ctx);\n+                data_ctx.write_function_addr((idx * usize_size) as u32, func_ref);\n+            }\n+            VtblEntry::MetadataSize | VtblEntry::MetadataAlign | VtblEntry::Vacant => {}\n         }\n     }\n "}]}