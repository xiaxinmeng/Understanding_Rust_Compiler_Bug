{"sha": "334af886589f2854d9027d60fa79a62b6e5b4980", "node_id": "MDY6Q29tbWl0NzI0NzEyOjMzNGFmODg2NTg5ZjI4NTRkOTAyN2Q2MGZhNzlhNjJiNmU1YjQ5ODA=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2016-12-30T01:26:41Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2016-12-30T01:26:41Z"}, "message": "Rollup merge of #38695 - alexcrichton:debug-appveyor, r=brson\n\nappveyor: Attempt to debug flaky test runs\n\nThis commit is an attempt to debug #38620 since we're unable to reproduce it\nlocally. It follows the [advice] of those with AppVeyor to use the `handle.exe`\ntool to try to debug what processes have a handle to the file open.\n\nThis won't be guaranteed to actually help us, but hopefully it'll diagnose\nsomething at some point?\n\n[advice]: http://help.appveyor.com/discussions/questions/2898", "tree": {"sha": "2a89fce194c11bcdb8e9f86f940cd2a7b5108213", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2a89fce194c11bcdb8e9f86f940cd2a7b5108213"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/334af886589f2854d9027d60fa79a62b6e5b4980", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/334af886589f2854d9027d60fa79a62b6e5b4980", "html_url": "https://github.com/rust-lang/rust/commit/334af886589f2854d9027d60fa79a62b6e5b4980", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/334af886589f2854d9027d60fa79a62b6e5b4980/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "19e187c17539728ea661e17f4d0b63a6d07d5b99", "url": "https://api.github.com/repos/rust-lang/rust/commits/19e187c17539728ea661e17f4d0b63a6d07d5b99", "html_url": "https://github.com/rust-lang/rust/commit/19e187c17539728ea661e17f4d0b63a6d07d5b99"}, {"sha": "e5c778228e2e825002bc4eb1e62cfc35afce0dd4", "url": "https://api.github.com/repos/rust-lang/rust/commits/e5c778228e2e825002bc4eb1e62cfc35afce0dd4", "html_url": "https://github.com/rust-lang/rust/commit/e5c778228e2e825002bc4eb1e62cfc35afce0dd4"}], "stats": {"total": 45, "additions": 45, "deletions": 0}, "files": [{"sha": "521ab00d0bfafe925c5bbde612adbf8c9baff16c", "filename": "appveyor.yml", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/334af886589f2854d9027d60fa79a62b6e5b4980/appveyor.yml", "raw_url": "https://github.com/rust-lang/rust/raw/334af886589f2854d9027d60fa79a62b6e5b4980/appveyor.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/appveyor.yml?ref=334af886589f2854d9027d60fa79a62b6e5b4980", "patch": "@@ -96,6 +96,13 @@ install:\n   - 7z x -y sccache.tar > nul\n   - set PATH=%PATH%;%CD%\\sccache2\n \n+  # Help debug some handle issues on AppVeyor\n+  - ps: Invoke-WebRequest -Uri https://download.sysinternals.com/files/Handle.zip -OutFile handle.zip\n+  - mkdir handle\n+  - ps: Expand-Archive handle.zip -dest handle\n+  - set PATH=%PATH%;%CD%\\handle\n+  - handle.exe -accepteula -help\n+\n test_script:\n   - git submodule update --init\n   - set SRC=."}, {"sha": "05f9beca3d11aa1948284a08c5cc92384bab55a1", "filename": "src/tools/compiletest/src/runtest.rs", "status": "modified", "additions": 38, "deletions": 0, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/334af886589f2854d9027d60fa79a62b6e5b4980/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/334af886589f2854d9027d60fa79a62b6e5b4980/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs?ref=334af886589f2854d9027d60fa79a62b6e5b4980", "patch": "@@ -1619,10 +1619,48 @@ actual:\\n\\\n     }\n \n     fn fatal_proc_rec(&self, err: &str, proc_res: &ProcRes) -> ! {\n+        self.try_print_open_handles();\n         self.error(err);\n         proc_res.fatal(None);\n     }\n \n+    // This function is a poor man's attempt to debug rust-lang/rust#38620, if\n+    // that's closed then this should be deleted\n+    //\n+    // This is a very \"opportunistic\" debugging attempt, so we ignore all\n+    // errors here.\n+    fn try_print_open_handles(&self) {\n+        if !cfg!(windows) {\n+            return\n+        }\n+        if self.config.mode != Incremental {\n+            return\n+        }\n+\n+        let filename = match self.testpaths.file.file_stem() {\n+            Some(path) => path,\n+            None => return,\n+        };\n+\n+        let mut cmd = Command::new(\"handle.exe\");\n+        cmd.arg(\"-a\").arg(\"-u\");\n+        cmd.arg(filename);\n+        cmd.arg(\"-nobanner\");\n+        let output = match cmd.output() {\n+            Ok(output) => output,\n+            Err(_) => return,\n+        };\n+        println!(\"---------------------------------------------------\");\n+        println!(\"ran extra command to debug rust-lang/rust#38620: \");\n+        println!(\"{:?}\", cmd);\n+        println!(\"result: {}\", output.status);\n+        println!(\"--- stdout ----------------------------------------\");\n+        println!(\"{}\", String::from_utf8_lossy(&output.stdout));\n+        println!(\"--- stderr ----------------------------------------\");\n+        println!(\"{}\", String::from_utf8_lossy(&output.stderr));\n+        println!(\"---------------------------------------------------\");\n+    }\n+\n     fn _arm_exec_compiled_test(&self, env: Vec<(String, String)>) -> ProcRes {\n         let args = self.make_run_args();\n         let cmdline = self.make_cmdline(\"\", &args.prog, &args.args);"}]}