{"sha": "b2f040fc9ab841e0791254bcdbf82bd0ee771242", "node_id": "MDY6Q29tbWl0NzI0NzEyOmIyZjA0MGZjOWFiODQxZTA3OTEyNTRiY2RiZjgyYmQwZWU3NzEyNDI=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2021-05-04T11:02:23Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2021-05-04T12:14:33Z"}, "message": "internal: add integrated completion benchmark", "tree": {"sha": "2d51f573ecb9ef4df970347eb38fda88e2766603", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2d51f573ecb9ef4df970347eb38fda88e2766603"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b2f040fc9ab841e0791254bcdbf82bd0ee771242", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b2f040fc9ab841e0791254bcdbf82bd0ee771242", "html_url": "https://github.com/rust-lang/rust/commit/b2f040fc9ab841e0791254bcdbf82bd0ee771242", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b2f040fc9ab841e0791254bcdbf82bd0ee771242/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "41f8ae7daa6e6bab6d73807cd0803b8061f586a0", "url": "https://api.github.com/repos/rust-lang/rust/commits/41f8ae7daa6e6bab6d73807cd0803b8061f586a0", "html_url": "https://github.com/rust-lang/rust/commit/41f8ae7daa6e6bab6d73807cd0803b8061f586a0"}], "stats": {"total": 262, "additions": 187, "deletions": 75}, "files": [{"sha": "74bab464b9ad14585c25e6339575f03e85aec686", "filename": "crates/rust-analyzer/src/benchmarks.rs", "status": "removed", "additions": 0, "deletions": 74, "changes": 74, "blob_url": "https://github.com/rust-lang/rust/blob/41f8ae7daa6e6bab6d73807cd0803b8061f586a0/crates%2Frust-analyzer%2Fsrc%2Fbenchmarks.rs", "raw_url": "https://github.com/rust-lang/rust/raw/41f8ae7daa6e6bab6d73807cd0803b8061f586a0/crates%2Frust-analyzer%2Fsrc%2Fbenchmarks.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fbenchmarks.rs?ref=41f8ae7daa6e6bab6d73807cd0803b8061f586a0", "patch": "@@ -1,74 +0,0 @@\n-//! Fully integrated benchmarks for rust-analyzer, which load real cargo\n-//! projects.\n-//!\n-//! The benchmark here is used to debug specific performance regressions. If you\n-//! notice that, eg, completion is slow in some specific case, you can  modify\n-//! code here exercise this specific completion, and thus have a fast\n-//! edit/compile/test cycle.\n-//!\n-//! Note that \"Rust Analyzer: Run\" action does not allow running a single test\n-//! in release mode in VS Code. There's however \"Rust Analyzer: Copy Run Command Line\"\n-//! which you can use to paste the command in terminal and add `--release` manually.\n-\n-use std::sync::Arc;\n-\n-use ide::Change;\n-use test_utils::project_root;\n-use vfs::{AbsPathBuf, VfsPath};\n-\n-use crate::cli::load_cargo::{load_workspace_at, LoadCargoConfig};\n-\n-#[test]\n-fn integrated_highlighting_benchmark() {\n-    // Don't run slow benchmark by default\n-    if true {\n-        return;\n-    }\n-\n-    // Load rust-analyzer itself.\n-    let workspace_to_load = project_root();\n-    let file = \"./crates/ide_db/src/apply_change.rs\";\n-\n-    let cargo_config = Default::default();\n-    let load_cargo_config = LoadCargoConfig {\n-        load_out_dirs_from_check: true,\n-        wrap_rustc: false,\n-        with_proc_macro: false,\n-    };\n-\n-    let (mut host, vfs, _proc_macro) = {\n-        let _it = stdx::timeit(\"workspace loading\");\n-        load_workspace_at(&workspace_to_load, &cargo_config, &load_cargo_config, &|_| {}).unwrap()\n-    };\n-\n-    let file_id = {\n-        let file = workspace_to_load.join(file);\n-        let path = VfsPath::from(AbsPathBuf::assert(file));\n-        vfs.file_id(&path).unwrap_or_else(|| panic!(\"can't find virtual file for {}\", path))\n-    };\n-\n-    {\n-        let _it = stdx::timeit(\"initial\");\n-        let analysis = host.analysis();\n-        analysis.highlight_as_html(file_id, false).unwrap();\n-    }\n-\n-    profile::init_from(\"*>100\");\n-    // let _s = profile::heartbeat_span();\n-\n-    {\n-        let _it = stdx::timeit(\"change\");\n-        let mut text = host.analysis().file_text(file_id).unwrap().to_string();\n-        text.push_str(\"\\npub fn _dummy() {}\\n\");\n-        let mut change = Change::new();\n-        change.change_file(file_id, Some(Arc::new(text)));\n-        host.apply_change(change);\n-    }\n-\n-    {\n-        let _it = stdx::timeit(\"after change\");\n-        let _span = profile::cpu_span();\n-        let analysis = host.analysis();\n-        analysis.highlight_as_html(file_id, false).unwrap();\n-    }\n-}"}, {"sha": "411446b042b7640e8cb29eaf243a3ac07a690a6b", "filename": "crates/rust-analyzer/src/integrated_benchmarks.rs", "status": "added", "additions": 186, "deletions": 0, "changes": 186, "blob_url": "https://github.com/rust-lang/rust/blob/b2f040fc9ab841e0791254bcdbf82bd0ee771242/crates%2Frust-analyzer%2Fsrc%2Fintegrated_benchmarks.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b2f040fc9ab841e0791254bcdbf82bd0ee771242/crates%2Frust-analyzer%2Fsrc%2Fintegrated_benchmarks.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fintegrated_benchmarks.rs?ref=b2f040fc9ab841e0791254bcdbf82bd0ee771242", "patch": "@@ -0,0 +1,186 @@\n+//! Fully integrated benchmarks for rust-analyzer, which load real cargo\n+//! projects.\n+//!\n+//! The benchmark here is used to debug specific performance regressions. If you\n+//! notice that, eg, completion is slow in some specific case, you can  modify\n+//! code here exercise this specific completion, and thus have a fast\n+//! edit/compile/test cycle.\n+//!\n+//! Note that \"Rust Analyzer: Run\" action does not allow running a single test\n+//! in release mode in VS Code. There's however \"Rust Analyzer: Copy Run Command Line\"\n+//! which you can use to paste the command in terminal and add `--release` manually.\n+\n+use std::{convert::TryFrom, sync::Arc};\n+\n+use ide::{Change, CompletionConfig, FilePosition, TextSize};\n+use ide_db::helpers::{insert_use::InsertUseConfig, merge_imports::MergeBehavior, SnippetCap};\n+use test_utils::project_root;\n+use vfs::{AbsPathBuf, VfsPath};\n+\n+use crate::cli::load_cargo::{load_workspace_at, LoadCargoConfig};\n+\n+#[test]\n+fn integrated_highlighting_benchmark() {\n+    // Don't run slow benchmark by default\n+    if true {\n+        return;\n+    }\n+\n+    // Load rust-analyzer itself.\n+    let workspace_to_load = project_root();\n+    let file = \"./crates/ide_db/src/apply_change.rs\";\n+\n+    let cargo_config = Default::default();\n+    let load_cargo_config = LoadCargoConfig {\n+        load_out_dirs_from_check: true,\n+        wrap_rustc: false,\n+        with_proc_macro: false,\n+    };\n+\n+    let (mut host, vfs, _proc_macro) = {\n+        let _it = stdx::timeit(\"workspace loading\");\n+        load_workspace_at(&workspace_to_load, &cargo_config, &load_cargo_config, &|_| {}).unwrap()\n+    };\n+\n+    let file_id = {\n+        let file = workspace_to_load.join(file);\n+        let path = VfsPath::from(AbsPathBuf::assert(file));\n+        vfs.file_id(&path).unwrap_or_else(|| panic!(\"can't find virtual file for {}\", path))\n+    };\n+\n+    {\n+        let _it = stdx::timeit(\"initial\");\n+        let analysis = host.analysis();\n+        analysis.highlight_as_html(file_id, false).unwrap();\n+    }\n+\n+    profile::init_from(\"*>100\");\n+    // let _s = profile::heartbeat_span();\n+\n+    {\n+        let _it = stdx::timeit(\"change\");\n+        let mut text = host.analysis().file_text(file_id).unwrap().to_string();\n+        text.push_str(\"\\npub fn _dummy() {}\\n\");\n+        let mut change = Change::new();\n+        change.change_file(file_id, Some(Arc::new(text)));\n+        host.apply_change(change);\n+    }\n+\n+    {\n+        let _it = stdx::timeit(\"after change\");\n+        let _span = profile::cpu_span();\n+        let analysis = host.analysis();\n+        analysis.highlight_as_html(file_id, false).unwrap();\n+    }\n+}\n+\n+#[test]\n+fn integrated_completion_benchmark() {\n+    // Don't run slow benchmark by default\n+    if true {\n+        return;\n+    }\n+\n+    // Load rust-analyzer itself.\n+    let workspace_to_load = project_root();\n+    let file = \"./crates/hir/src/lib.rs\";\n+\n+    let cargo_config = Default::default();\n+    let load_cargo_config = LoadCargoConfig {\n+        load_out_dirs_from_check: true,\n+        wrap_rustc: false,\n+        with_proc_macro: false,\n+    };\n+\n+    let (mut host, vfs, _proc_macro) = {\n+        let _it = stdx::timeit(\"workspace loading\");\n+        load_workspace_at(&workspace_to_load, &cargo_config, &load_cargo_config, &|_| {}).unwrap()\n+    };\n+\n+    let file_id = {\n+        let file = workspace_to_load.join(file);\n+        let path = VfsPath::from(AbsPathBuf::assert(file));\n+        vfs.file_id(&path).unwrap_or_else(|| panic!(\"can't find virtual file for {}\", path))\n+    };\n+\n+    {\n+        let _it = stdx::timeit(\"initial\");\n+        let analysis = host.analysis();\n+        analysis.highlight_as_html(file_id, false).unwrap();\n+    }\n+\n+    profile::init_from(\"*>5\");\n+    // let _s = profile::heartbeat_span();\n+\n+    let completion_offset = {\n+        let _it = stdx::timeit(\"change\");\n+        let mut text = host.analysis().file_text(file_id).unwrap().to_string();\n+        let completion_offset =\n+            patch(&mut text, \"db.struct_data(self.id)\", \"sel;\\ndb.struct_data(self.id)\")\n+                + \"sel\".len();\n+        let mut change = Change::new();\n+        change.change_file(file_id, Some(Arc::new(text)));\n+        host.apply_change(change);\n+        completion_offset\n+    };\n+\n+    {\n+        let _it = stdx::timeit(\"unqualified path completion\");\n+        let _span = profile::cpu_span();\n+        let analysis = host.analysis();\n+        let config = CompletionConfig {\n+            enable_postfix_completions: true,\n+            enable_imports_on_the_fly: true,\n+            add_call_parenthesis: true,\n+            add_call_argument_snippets: true,\n+            snippet_cap: SnippetCap::new(true),\n+            insert_use: InsertUseConfig {\n+                merge: Some(MergeBehavior::Full),\n+                prefix_kind: hir::PrefixKind::ByCrate,\n+                group: true,\n+            },\n+        };\n+        let position =\n+            FilePosition { file_id, offset: TextSize::try_from(completion_offset).unwrap() };\n+        analysis.completions(&config, position).unwrap();\n+    }\n+\n+    let completion_offset = {\n+        let _it = stdx::timeit(\"change\");\n+        let mut text = host.analysis().file_text(file_id).unwrap().to_string();\n+        let completion_offset =\n+            patch(&mut text, \"sel;\\ndb.struct_data(self.id)\", \"self.;\\ndb.struct_data(self.id)\")\n+                + \"self.\".len();\n+        let mut change = Change::new();\n+        change.change_file(file_id, Some(Arc::new(text)));\n+        host.apply_change(change);\n+        completion_offset\n+    };\n+\n+    {\n+        let _it = stdx::timeit(\"dot completion\");\n+        let _span = profile::cpu_span();\n+        let analysis = host.analysis();\n+        let config = CompletionConfig {\n+            enable_postfix_completions: true,\n+            enable_imports_on_the_fly: true,\n+            add_call_parenthesis: true,\n+            add_call_argument_snippets: true,\n+            snippet_cap: SnippetCap::new(true),\n+            insert_use: InsertUseConfig {\n+                merge: Some(MergeBehavior::Full),\n+                prefix_kind: hir::PrefixKind::ByCrate,\n+                group: true,\n+            },\n+        };\n+        let position =\n+            FilePosition { file_id, offset: TextSize::try_from(completion_offset).unwrap() };\n+        analysis.completions(&config, position).unwrap();\n+    }\n+}\n+\n+fn patch(what: &mut String, from: &str, to: &str) -> usize {\n+    let idx = what.find(from).unwrap();\n+    *what = what.replacen(from, to, 1);\n+    idx\n+}"}, {"sha": "da7e24becd0ac4674ffb99fb63ed128e468c9e91", "filename": "crates/rust-analyzer/src/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b2f040fc9ab841e0791254bcdbf82bd0ee771242/crates%2Frust-analyzer%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b2f040fc9ab841e0791254bcdbf82bd0ee771242/crates%2Frust-analyzer%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Flib.rs?ref=b2f040fc9ab841e0791254bcdbf82bd0ee771242", "patch": "@@ -40,7 +40,7 @@ pub mod lsp_ext;\n pub mod config;\n \n #[cfg(test)]\n-mod benchmarks;\n+mod integrated_benchmarks;\n \n use serde::de::DeserializeOwned;\n use std::fmt;"}]}