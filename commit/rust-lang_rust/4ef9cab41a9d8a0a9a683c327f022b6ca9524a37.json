{"sha": "4ef9cab41a9d8a0a9a683c327f022b6ca9524a37", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRlZjljYWI0MWE5ZDhhMGE5YTY4M2MzMjdmMDIyYjZjYTk1MjRhMzc=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2019-11-20T13:36:19Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-11-20T13:36:19Z"}, "message": "Merge #2318\n\n2318: Fix panic when use `Expand Macro` on `assert_eq` r=matklad a=edwin0cheng\n\nThe cause of this [bug](https://github.com/rust-analyzer/rust-analyzer/pull/2291#issuecomment-555651542) is, when calling `SourceAnalyzer::expand` when an `ast::MacroCall` which is outside of `SourceAnalyzer::node`. \r\n\r\nNote that if we use a node in `SourceAnalyzer::new` with a `MacroFile` file id, the resolver inside `SourceAnalyzer` still will not work properly. Another PR will need to fix it.\n\nCo-authored-by: Edwin Cheng <edwin0cheng@gmail.com>", "tree": {"sha": "fc8009de0176c6904c3dd0484775e85592c9464d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fc8009de0176c6904c3dd0484775e85592c9464d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4ef9cab41a9d8a0a9a683c327f022b6ca9524a37", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJd1UFUCRBK7hj4Ov3rIwAAdHIIABlwDT8tgy6AkMld1XHI0m3q\nLddJnore1jkoLQj29qG4kQv79U4+59GHiJ2lB+sIEax7kyXMexoHKrJ9mpbNJqRM\nikoxaNO5ryNx0zYAKh0CuN+aDCnogTnlTpLs4ZyFwSBJqI9zERNM04l2tYIoqz7T\nxZmMZoel7cWV6cTE9yiL1stCqgf/fyr5vVMW/is+1WRXGKf3KikHZQNnJ4Mv/bRG\nmVL2joxhLjWqNy3NKCSFSEP4KB+JGYlQuuh/hP/Z/X0620g2CM43t7cQzEq/3UOu\ngSc2f2rbnHPNtPuWB2IsFh6y7dhiEoZ89cKSjSNtZ0m0EY6EDksUM1iO9uSSFcU=\n=rbKw\n-----END PGP SIGNATURE-----\n", "payload": "tree fc8009de0176c6904c3dd0484775e85592c9464d\nparent b568bcfe6d94d5f4c6cdc012b766473e5b771a26\nparent 0a9c80053ffcd72d076ca3792bf4a9ddb94eaf95\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1574256979 +0000\ncommitter GitHub <noreply@github.com> 1574256979 +0000\n\nMerge #2318\n\n2318: Fix panic when use `Expand Macro` on `assert_eq` r=matklad a=edwin0cheng\n\nThe cause of this [bug](https://github.com/rust-analyzer/rust-analyzer/pull/2291#issuecomment-555651542) is, when calling `SourceAnalyzer::expand` when an `ast::MacroCall` which is outside of `SourceAnalyzer::node`. \r\n\r\nNote that if we use a node in `SourceAnalyzer::new` with a `MacroFile` file id, the resolver inside `SourceAnalyzer` still will not work properly. Another PR will need to fix it.\n\nCo-authored-by: Edwin Cheng <edwin0cheng@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4ef9cab41a9d8a0a9a683c327f022b6ca9524a37", "html_url": "https://github.com/rust-lang/rust/commit/4ef9cab41a9d8a0a9a683c327f022b6ca9524a37", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4ef9cab41a9d8a0a9a683c327f022b6ca9524a37/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b568bcfe6d94d5f4c6cdc012b766473e5b771a26", "url": "https://api.github.com/repos/rust-lang/rust/commits/b568bcfe6d94d5f4c6cdc012b766473e5b771a26", "html_url": "https://github.com/rust-lang/rust/commit/b568bcfe6d94d5f4c6cdc012b766473e5b771a26"}, {"sha": "0a9c80053ffcd72d076ca3792bf4a9ddb94eaf95", "url": "https://api.github.com/repos/rust-lang/rust/commits/0a9c80053ffcd72d076ca3792bf4a9ddb94eaf95", "html_url": "https://github.com/rust-lang/rust/commit/0a9c80053ffcd72d076ca3792bf4a9ddb94eaf95"}], "stats": {"total": 25, "additions": 16, "deletions": 9}, "files": [{"sha": "caa8d0082f4fe98a90bd896b81dec6f75ab0a87b", "filename": "crates/ra_hir/src/source_binder.rs", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/4ef9cab41a9d8a0a9a683c327f022b6ca9524a37/crates%2Fra_hir%2Fsrc%2Fsource_binder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4ef9cab41a9d8a0a9a683c327f022b6ca9524a37/crates%2Fra_hir%2Fsrc%2Fsource_binder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fsource_binder.rs?ref=4ef9cab41a9d8a0a9a683c327f022b6ca9524a37", "patch": "@@ -405,9 +405,16 @@ impl SourceAnalyzer {\n         implements_trait(&canonical_ty, db, &self.resolver, krate, std_future_trait)\n     }\n \n-    pub fn expand(&self, db: &impl HirDatabase, macro_call: &ast::MacroCall) -> Option<Expansion> {\n-        let def = self.resolve_macro_call(db, macro_call)?.id;\n-        let ast_id = AstId::new(self.file_id, db.ast_id_map(self.file_id).ast_id(macro_call));\n+    pub fn expand(\n+        &self,\n+        db: &impl HirDatabase,\n+        macro_call: Source<&ast::MacroCall>,\n+    ) -> Option<Expansion> {\n+        let def = self.resolve_macro_call(db, macro_call.value)?.id;\n+        let ast_id = AstId::new(\n+            macro_call.file_id,\n+            db.ast_id_map(macro_call.file_id).ast_id(macro_call.value),\n+        );\n         let macro_call_loc = MacroCallLoc { def, ast_id };\n         Some(Expansion { macro_call_id: db.intern_macro(macro_call_loc) })\n     }"}, {"sha": "2f1abf509a00549b1359cef237341023a30ec8b9", "filename": "crates/ra_ide_api/src/expand.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/4ef9cab41a9d8a0a9a683c327f022b6ca9524a37/crates%2Fra_ide_api%2Fsrc%2Fexpand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4ef9cab41a9d8a0a9a683c327f022b6ca9524a37/crates%2Fra_ide_api%2Fsrc%2Fexpand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2Fsrc%2Fexpand.rs?ref=4ef9cab41a9d8a0a9a683c327f022b6ca9524a37", "patch": "@@ -55,7 +55,7 @@ pub(crate) fn descend_into_macros(\n         }\n         let source_analyzer =\n             hir::SourceAnalyzer::new(db, token.with_value(token.value.parent()).as_ref(), None);\n-        let exp = source_analyzer.expand(db, &macro_call)?;\n+        let exp = source_analyzer.expand(db, token.with_value(&macro_call))?;\n         exp.map_token_down(db, token.as_ref())\n     })\n     .last()"}, {"sha": "7f39262dc93697592a3a1b45128c40eb976efed8", "filename": "crates/ra_ide_api/src/expand_macro.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/4ef9cab41a9d8a0a9a683c327f022b6ca9524a37/crates%2Fra_ide_api%2Fsrc%2Fexpand_macro.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4ef9cab41a9d8a0a9a683c327f022b6ca9524a37/crates%2Fra_ide_api%2Fsrc%2Fexpand_macro.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2Fsrc%2Fexpand_macro.rs?ref=4ef9cab41a9d8a0a9a683c327f022b6ca9524a37", "patch": "@@ -23,7 +23,7 @@ pub(crate) fn expand_macro(db: &RootDatabase, position: FilePosition) -> Option<\n     let mac = name_ref.syntax().ancestors().find_map(ast::MacroCall::cast)?;\n \n     let source = hir::Source::new(position.file_id.into(), mac.syntax());\n-    let expanded = expand_macro_recur(db, source, &mac)?;\n+    let expanded = expand_macro_recur(db, source, source.with_value(&mac))?;\n \n     // FIXME:\n     // macro expansion may lose all white space information\n@@ -35,19 +35,19 @@ pub(crate) fn expand_macro(db: &RootDatabase, position: FilePosition) -> Option<\n fn expand_macro_recur(\n     db: &RootDatabase,\n     source: hir::Source<&SyntaxNode>,\n-    macro_call: &ast::MacroCall,\n+    macro_call: hir::Source<&ast::MacroCall>,\n ) -> Option<SyntaxNode> {\n     let analyzer = hir::SourceAnalyzer::new(db, source, None);\n-    let expansion = analyzer.expand(db, &macro_call)?;\n+    let expansion = analyzer.expand(db, macro_call)?;\n     let macro_file_id = expansion.file_id();\n     let expanded: SyntaxNode = db.parse_or_expand(macro_file_id)?;\n \n     let children = expanded.descendants().filter_map(ast::MacroCall::cast);\n     let mut replaces = FxHashMap::default();\n \n     for child in children.into_iter() {\n-        let source = hir::Source::new(macro_file_id, source.value);\n-        let new_node = expand_macro_recur(db, source, &child)?;\n+        let node = hir::Source::new(macro_file_id, &child);\n+        let new_node = expand_macro_recur(db, source, node)?;\n \n         replaces.insert(child.syntax().clone().into(), new_node.into());\n     }"}]}