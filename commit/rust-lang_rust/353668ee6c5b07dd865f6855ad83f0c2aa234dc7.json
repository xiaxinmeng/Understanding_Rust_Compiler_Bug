{"sha": "353668ee6c5b07dd865f6855ad83f0c2aa234dc7", "node_id": "MDY6Q29tbWl0NzI0NzEyOjM1MzY2OGVlNmM1YjA3ZGQ4NjVmNjg1NWFkODNmMGMyYWEyMzRkYzc=", "commit": {"author": {"name": "flip1995", "email": "hello@philkrones.com", "date": "2019-11-23T16:55:10Z"}, "committer": {"name": "flip1995", "email": "hello@philkrones.com", "date": "2019-11-23T16:55:10Z"}, "message": "Merge remote-tracking branch 'Areredify/large_stack_arrays' into rollup-new-lints", "tree": {"sha": "9cebae740285b09c341ccd4f0b5102b57b0cd79a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9cebae740285b09c341ccd4f0b5102b57b0cd79a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/353668ee6c5b07dd865f6855ad83f0c2aa234dc7", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEZxoS6lESXlRGMHWcaTCGhp1QZjcFAl3ZZHAACgkQaTCGhp1Q\nZjeX3Q//TI+AgFPgeYzBHGsYfO9Qu35q9AjfL3YynQ7kaEEq99s6JIfw8t2yGKl/\nhISh7ov7BtilPb24zhiqOBWY8zoPSwiQrRIBbKqsq30EX1WWIeMDGR9vOPU9w5kV\ngxmViNhKPHHlrt/MJ7bxH/6AiQnCkFjiqcFucmDnZatWuTXhTZ7A5+VTxqjzVskI\nZq/mj+Gs4oBVlFRZxqoxmWZCHjoF/3oM6ADo1Sb0MBe1H6TJB8NBIVMaSibBUxTg\nOkdvUS19iWpUfgwZNaGB3hL0DNgaLEtj6EQ4J66E/Ez3K7lNSpU9LsWybvUm5Wri\nks2mKdCcGy61FQ/IBIyjJ2QuBtqjl3Vniz7+hi2tQj4aeQ79KtrUL9WGzM4BOFQB\nZmXOlt8iUbvvunVtN6YZRfc9KrKVFubnmysxEwTbIAfDbWlCrVeY0VIoptz7p1Mb\nLMXbNeX59/ajAu2usFRGEpQgk4T/us+mjsxI6+NWwrkV63nGy5FbtzoUczK4YgYm\nNkUBTbekZn9ZJMuD3fu+kqEMzBgUQooCWT69wQOYixdx46gtiwjnJsvTMrt0HBFH\nnIqOisfE5VSttj64MkeU+WsEJ7iMTubWPIAokfalf+g29udrOZQ/cgV7fY5p6A9j\njemNsPqN5Mv/a1nDkvKDR3HZaBec+Q/8Auujgs1iDMaAOiYg0Uc=\n=thJB\n-----END PGP SIGNATURE-----", "payload": "tree 9cebae740285b09c341ccd4f0b5102b57b0cd79a\nparent 213765a1d39edb8b29b1b90670a3fc6b16fcc9cd\nparent 7fddac040469a26fa2fb1d1f1f2dea604d739f49\nauthor flip1995 <hello@philkrones.com> 1574528110 +0100\ncommitter flip1995 <hello@philkrones.com> 1574528110 +0100\n\nMerge remote-tracking branch 'Areredify/large_stack_arrays' into rollup-new-lints\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/353668ee6c5b07dd865f6855ad83f0c2aa234dc7", "html_url": "https://github.com/rust-lang/rust/commit/353668ee6c5b07dd865f6855ad83f0c2aa234dc7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/353668ee6c5b07dd865f6855ad83f0c2aa234dc7/comments", "author": {"login": "flip1995", "id": 9744647, "node_id": "MDQ6VXNlcjk3NDQ2NDc=", "avatar_url": "https://avatars.githubusercontent.com/u/9744647?v=4", "gravatar_id": "", "url": "https://api.github.com/users/flip1995", "html_url": "https://github.com/flip1995", "followers_url": "https://api.github.com/users/flip1995/followers", "following_url": "https://api.github.com/users/flip1995/following{/other_user}", "gists_url": "https://api.github.com/users/flip1995/gists{/gist_id}", "starred_url": "https://api.github.com/users/flip1995/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/flip1995/subscriptions", "organizations_url": "https://api.github.com/users/flip1995/orgs", "repos_url": "https://api.github.com/users/flip1995/repos", "events_url": "https://api.github.com/users/flip1995/events{/privacy}", "received_events_url": "https://api.github.com/users/flip1995/received_events", "type": "User", "site_admin": false}, "committer": {"login": "flip1995", "id": 9744647, "node_id": "MDQ6VXNlcjk3NDQ2NDc=", "avatar_url": "https://avatars.githubusercontent.com/u/9744647?v=4", "gravatar_id": "", "url": "https://api.github.com/users/flip1995", "html_url": "https://github.com/flip1995", "followers_url": "https://api.github.com/users/flip1995/followers", "following_url": "https://api.github.com/users/flip1995/following{/other_user}", "gists_url": "https://api.github.com/users/flip1995/gists{/gist_id}", "starred_url": "https://api.github.com/users/flip1995/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/flip1995/subscriptions", "organizations_url": "https://api.github.com/users/flip1995/orgs", "repos_url": "https://api.github.com/users/flip1995/repos", "events_url": "https://api.github.com/users/flip1995/events{/privacy}", "received_events_url": "https://api.github.com/users/flip1995/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "213765a1d39edb8b29b1b90670a3fc6b16fcc9cd", "url": "https://api.github.com/repos/rust-lang/rust/commits/213765a1d39edb8b29b1b90670a3fc6b16fcc9cd", "html_url": "https://github.com/rust-lang/rust/commit/213765a1d39edb8b29b1b90670a3fc6b16fcc9cd"}, {"sha": "7fddac040469a26fa2fb1d1f1f2dea604d739f49", "url": "https://api.github.com/repos/rust-lang/rust/commits/7fddac040469a26fa2fb1d1f1f2dea604d739f49", "html_url": "https://github.com/rust-lang/rust/commit/7fddac040469a26fa2fb1d1f1f2dea604d739f49"}], "stats": {"total": 149, "additions": 148, "deletions": 1}, "files": [{"sha": "2b7a883e5c76b8967a2fd60246911a9dbb7f507b", "filename": "CHANGELOG.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/353668ee6c5b07dd865f6855ad83f0c2aa234dc7/CHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/353668ee6c5b07dd865f6855ad83f0c2aa234dc7/CHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/CHANGELOG.md?ref=353668ee6c5b07dd865f6855ad83f0c2aa234dc7", "patch": "@@ -1060,6 +1060,7 @@ Released 2018-09-13\n [`just_underscores_and_digits`]: https://rust-lang.github.io/rust-clippy/master/index.html#just_underscores_and_digits\n [`large_digit_groups`]: https://rust-lang.github.io/rust-clippy/master/index.html#large_digit_groups\n [`large_enum_variant`]: https://rust-lang.github.io/rust-clippy/master/index.html#large_enum_variant\n+[`large_stack_arrays`]: https://rust-lang.github.io/rust-clippy/master/index.html#large_stack_arrays\n [`len_without_is_empty`]: https://rust-lang.github.io/rust-clippy/master/index.html#len_without_is_empty\n [`len_zero`]: https://rust-lang.github.io/rust-clippy/master/index.html#len_zero\n [`let_and_return`]: https://rust-lang.github.io/rust-clippy/master/index.html#let_and_return"}, {"sha": "acc90214ff86cf80db08b2d0f2cb9d4f3ab15f77", "filename": "clippy_lints/src/large_stack_arrays.rs", "status": "added", "additions": 67, "deletions": 0, "changes": 67, "blob_url": "https://github.com/rust-lang/rust/blob/353668ee6c5b07dd865f6855ad83f0c2aa234dc7/clippy_lints%2Fsrc%2Flarge_stack_arrays.rs", "raw_url": "https://github.com/rust-lang/rust/raw/353668ee6c5b07dd865f6855ad83f0c2aa234dc7/clippy_lints%2Fsrc%2Flarge_stack_arrays.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flarge_stack_arrays.rs?ref=353668ee6c5b07dd865f6855ad83f0c2aa234dc7", "patch": "@@ -0,0 +1,67 @@\n+use rustc::hir::*;\n+use rustc::lint::{LateContext, LateLintPass, LintArray, LintPass};\n+use rustc::mir::interpret::ConstValue;\n+use rustc::ty;\n+use rustc::{declare_tool_lint, impl_lint_pass};\n+\n+use if_chain::if_chain;\n+\n+use crate::rustc_target::abi::LayoutOf;\n+use crate::utils::{snippet, span_help_and_lint};\n+\n+declare_clippy_lint! {\n+    /// **What it does:** Checks for local arrays that may be too large.\n+    ///\n+    /// **Why is this bad?** Large local arrays may cause stack overflow.\n+    ///\n+    /// **Known problems:** None.\n+    ///\n+    /// **Example:**\n+    /// ```rust,ignore\n+    /// let a = [0u32; 1_000_000];\n+    /// ```\n+    pub LARGE_STACK_ARRAYS,\n+    pedantic,\n+    \"allocating large arrays on stack may cause stack overflow\"\n+}\n+\n+pub struct LargeStackArrays {\n+    maximum_allowed_size: u64,\n+}\n+\n+impl LargeStackArrays {\n+    #[must_use]\n+    pub fn new(maximum_allowed_size: u64) -> Self {\n+        Self { maximum_allowed_size }\n+    }\n+}\n+\n+impl_lint_pass!(LargeStackArrays => [LARGE_STACK_ARRAYS]);\n+\n+impl<'a, 'tcx> LateLintPass<'a, 'tcx> for LargeStackArrays {\n+    fn check_expr(&mut self, cx: &LateContext<'_, '_>, expr: &Expr) {\n+        if_chain! {\n+            if let ExprKind::Repeat(_, _) = expr.kind;\n+            if let ty::Array(element_type, cst) = cx.tables.expr_ty(expr).kind;\n+            if let ConstValue::Scalar(element_count) = cst.val;\n+            if let Ok(element_count) = element_count.to_machine_usize(&cx.tcx);\n+            if let Ok(element_size) = cx.layout_of(element_type).map(|l| l.size.bytes());\n+            if self.maximum_allowed_size < element_count * element_size;\n+            then {\n+                span_help_and_lint(\n+                    cx,\n+                    LARGE_STACK_ARRAYS,\n+                    expr.span,\n+                    &format!(\n+                        \"allocating a local array larger than {} bytes\",\n+                        self.maximum_allowed_size\n+                    ),\n+                    &format!(\n+                        \"consider allocating on the heap with vec!{}.into_boxed_slice()\",\n+                        snippet(cx, expr.span, \"[...]\")\n+                    ),\n+                );\n+            }\n+        }\n+    }\n+}"}, {"sha": "fbe2afc04eea8c77907f2195d10a1347a509d1de", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/353668ee6c5b07dd865f6855ad83f0c2aa234dc7/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/353668ee6c5b07dd865f6855ad83f0c2aa234dc7/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=353668ee6c5b07dd865f6855ad83f0c2aa234dc7", "patch": "@@ -212,6 +212,7 @@ pub mod int_plus_one;\n pub mod integer_division;\n pub mod items_after_statements;\n pub mod large_enum_variant;\n+pub mod large_stack_arrays;\n pub mod len_zero;\n pub mod let_if_seq;\n pub mod lifetimes;\n@@ -539,6 +540,7 @@ pub fn register_plugins(store: &mut lint::LintStore, sess: &Session, conf: &Conf\n         &integer_division::INTEGER_DIVISION,\n         &items_after_statements::ITEMS_AFTER_STATEMENTS,\n         &large_enum_variant::LARGE_ENUM_VARIANT,\n+        &large_stack_arrays::LARGE_STACK_ARRAYS,\n         &len_zero::LEN_WITHOUT_IS_EMPTY,\n         &len_zero::LEN_ZERO,\n         &let_if_seq::USELESS_LET_IF_SEQ,\n@@ -952,6 +954,8 @@ pub fn register_plugins(store: &mut lint::LintStore, sess: &Session, conf: &Conf\n     store.register_late_pass(|| box mutable_debug_assertion::DebugAssertWithMutCall);\n     store.register_late_pass(|| box exit::Exit);\n     store.register_late_pass(|| box to_digit_is_some::ToDigitIsSome);\n+    let array_size_threshold = conf.array_size_threshold;\n+    store.register_late_pass(move || box large_stack_arrays::LargeStackArrays::new(array_size_threshold));\n \n     store.register_group(true, \"clippy::restriction\", Some(\"clippy_restriction\"), vec![\n         LintId::of(&arithmetic::FLOAT_ARITHMETIC),\n@@ -1006,6 +1010,7 @@ pub fn register_plugins(store: &mut lint::LintStore, sess: &Session, conf: &Conf\n         LintId::of(&if_not_else::IF_NOT_ELSE),\n         LintId::of(&infinite_iter::MAYBE_INFINITE_ITER),\n         LintId::of(&items_after_statements::ITEMS_AFTER_STATEMENTS),\n+        LintId::of(&large_stack_arrays::LARGE_STACK_ARRAYS),\n         LintId::of(&literal_representation::LARGE_DIGIT_GROUPS),\n         LintId::of(&loops::EXPLICIT_INTO_ITER_LOOP),\n         LintId::of(&loops::EXPLICIT_ITER_LOOP),"}, {"sha": "a3407d1e9902e439f30ea9d82d8a4230392c6c66", "filename": "clippy_lints/src/utils/conf.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/353668ee6c5b07dd865f6855ad83f0c2aa234dc7/clippy_lints%2Fsrc%2Futils%2Fconf.rs", "raw_url": "https://github.com/rust-lang/rust/raw/353668ee6c5b07dd865f6855ad83f0c2aa234dc7/clippy_lints%2Fsrc%2Futils%2Fconf.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Futils%2Fconf.rs?ref=353668ee6c5b07dd865f6855ad83f0c2aa234dc7", "patch": "@@ -151,6 +151,8 @@ define_Conf! {\n     (trivial_copy_size_limit, \"trivial_copy_size_limit\", None => Option<u64>),\n     /// Lint: TOO_MANY_LINES. The maximum number of lines a function or method can have\n     (too_many_lines_threshold, \"too_many_lines_threshold\", 100 => u64),\n+    /// Lint: LARGE_STACK_ARRAYS. The maximum allowed size for arrays on the stack\n+    (array_size_threshold, \"array_size_threshold\", 512_000 => u64),\n }\n \n impl Default for Conf {"}, {"sha": "c223c5054f9ac9a34478aa9aa34cac8eb9ee3eb9", "filename": "src/lintlist/mod.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/353668ee6c5b07dd865f6855ad83f0c2aa234dc7/src%2Flintlist%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/353668ee6c5b07dd865f6855ad83f0c2aa234dc7/src%2Flintlist%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flintlist%2Fmod.rs?ref=353668ee6c5b07dd865f6855ad83f0c2aa234dc7", "patch": "@@ -910,6 +910,13 @@ pub const ALL_LINTS: [Lint; 334] = [\n         deprecation: None,\n         module: \"large_enum_variant\",\n     },\n+    Lint {\n+        name: \"large_stack_arrays\",\n+        group: \"pedantic\",\n+        desc: \"allocating large arrays on stack may cause stack overflow\",\n+        deprecation: None,\n+        module: \"large_stack_arrays\",\n+    },\n     Lint {\n         name: \"len_without_is_empty\",\n         group: \"style\","}, {"sha": "cbb4126a8668ad8304a2b09c4f1d49a1e9d6b920", "filename": "tests/ui-toml/toml_unknown_key/conf_unknown_key.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/353668ee6c5b07dd865f6855ad83f0c2aa234dc7/tests%2Fui-toml%2Ftoml_unknown_key%2Fconf_unknown_key.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/353668ee6c5b07dd865f6855ad83f0c2aa234dc7/tests%2Fui-toml%2Ftoml_unknown_key%2Fconf_unknown_key.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui-toml%2Ftoml_unknown_key%2Fconf_unknown_key.stderr?ref=353668ee6c5b07dd865f6855ad83f0c2aa234dc7", "patch": "@@ -1,4 +1,4 @@\n-error: error reading Clippy's configuration file `$DIR/clippy.toml`: unknown field `foobar`, expected one of `blacklisted-names`, `cognitive-complexity-threshold`, `cyclomatic-complexity-threshold`, `doc-valid-idents`, `too-many-arguments-threshold`, `type-complexity-threshold`, `single-char-binding-names-threshold`, `too-large-for-stack`, `enum-variant-name-threshold`, `enum-variant-size-threshold`, `verbose-bit-mask-threshold`, `literal-representation-threshold`, `trivial-copy-size-limit`, `too-many-lines-threshold`, `third-party` at line 5 column 1\n+error: error reading Clippy's configuration file `$DIR/clippy.toml`: unknown field `foobar`, expected one of `blacklisted-names`, `cognitive-complexity-threshold`, `cyclomatic-complexity-threshold`, `doc-valid-idents`, `too-many-arguments-threshold`, `type-complexity-threshold`, `single-char-binding-names-threshold`, `too-large-for-stack`, `enum-variant-name-threshold`, `enum-variant-size-threshold`, `verbose-bit-mask-threshold`, `literal-representation-threshold`, `trivial-copy-size-limit`, `too-many-lines-threshold`, `array-size-threshold`, `third-party` at line 5 column 1\n \n error: aborting due to previous error\n "}, {"sha": "d9161bfcf15433f491bb5c58125f9b327b6736c5", "filename": "tests/ui/large_stack_arrays.rs", "status": "added", "additions": 30, "deletions": 0, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/353668ee6c5b07dd865f6855ad83f0c2aa234dc7/tests%2Fui%2Flarge_stack_arrays.rs", "raw_url": "https://github.com/rust-lang/rust/raw/353668ee6c5b07dd865f6855ad83f0c2aa234dc7/tests%2Fui%2Flarge_stack_arrays.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Flarge_stack_arrays.rs?ref=353668ee6c5b07dd865f6855ad83f0c2aa234dc7", "patch": "@@ -0,0 +1,30 @@\n+#![warn(clippy::large_stack_arrays)]\n+#![allow(clippy::large_enum_variant)]\n+\n+#[derive(Clone, Copy)]\n+struct S {\n+    pub data: [u64; 32],\n+}\n+\n+#[derive(Clone, Copy)]\n+enum E {\n+    S(S),\n+    T(u32),\n+}\n+\n+fn main() {\n+    let bad = (\n+        [0u32; 20_000_000],\n+        [S { data: [0; 32] }; 5000],\n+        [Some(\"\"); 20_000_000],\n+        [E::T(0); 5000],\n+    );\n+\n+    let good = (\n+        [0u32; 1000],\n+        [S { data: [0; 32] }; 1000],\n+        [Some(\"\"); 1000],\n+        [E::T(0); 1000],\n+        [(); 20_000_000],\n+    );\n+}"}, {"sha": "98d8262372df689a28943141cbd58036dffcd459", "filename": "tests/ui/large_stack_arrays.stderr", "status": "added", "additions": 35, "deletions": 0, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/353668ee6c5b07dd865f6855ad83f0c2aa234dc7/tests%2Fui%2Flarge_stack_arrays.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/353668ee6c5b07dd865f6855ad83f0c2aa234dc7/tests%2Fui%2Flarge_stack_arrays.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Flarge_stack_arrays.stderr?ref=353668ee6c5b07dd865f6855ad83f0c2aa234dc7", "patch": "@@ -0,0 +1,35 @@\n+error: allocating a local array larger than 512000 bytes\n+  --> $DIR/large_stack_arrays.rs:17:9\n+   |\n+LL |         [0u32; 20_000_000],\n+   |         ^^^^^^^^^^^^^^^^^^\n+   |\n+   = note: `-D clippy::large-stack-arrays` implied by `-D warnings`\n+   = help: consider allocating on the heap with vec![0u32; 20_000_000].into_boxed_slice()\n+\n+error: allocating a local array larger than 512000 bytes\n+  --> $DIR/large_stack_arrays.rs:18:9\n+   |\n+LL |         [S { data: [0; 32] }; 5000],\n+   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+   = help: consider allocating on the heap with vec![S { data: [0; 32] }; 5000].into_boxed_slice()\n+\n+error: allocating a local array larger than 512000 bytes\n+  --> $DIR/large_stack_arrays.rs:19:9\n+   |\n+LL |         [Some(\"\"); 20_000_000],\n+   |         ^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+   = help: consider allocating on the heap with vec![Some(\"\"); 20_000_000].into_boxed_slice()\n+\n+error: allocating a local array larger than 512000 bytes\n+  --> $DIR/large_stack_arrays.rs:20:9\n+   |\n+LL |         [E::T(0); 5000],\n+   |         ^^^^^^^^^^^^^^^\n+   |\n+   = help: consider allocating on the heap with vec![E::T(0); 5000].into_boxed_slice()\n+\n+error: aborting due to 4 previous errors\n+"}]}