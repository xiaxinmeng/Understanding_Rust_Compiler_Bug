{"sha": "bbb40d746368eb6a38498649a723c7ead0ef8136", "node_id": "MDY6Q29tbWl0NzI0NzEyOmJiYjQwZDc0NjM2OGViNmEzODQ5ODY0OWE3MjNjN2VhZDBlZjgxMzY=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2020-06-05T14:45:20Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2020-06-05T15:22:56Z"}, "message": "Minimize FileLoader interface", "tree": {"sha": "6496e07d1558ef7b1f8c0cb51648fd44755c8f8e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6496e07d1558ef7b1f8c0cb51648fd44755c8f8e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bbb40d746368eb6a38498649a723c7ead0ef8136", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bbb40d746368eb6a38498649a723c7ead0ef8136", "html_url": "https://github.com/rust-lang/rust/commit/bbb40d746368eb6a38498649a723c7ead0ef8136", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bbb40d746368eb6a38498649a723c7ead0ef8136/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9c52f527a1cef7d39c2b1c55b49dc5459d392a4d", "url": "https://api.github.com/repos/rust-lang/rust/commits/9c52f527a1cef7d39c2b1c55b49dc5459d392a4d", "html_url": "https://github.com/rust-lang/rust/commit/9c52f527a1cef7d39c2b1c55b49dc5459d392a4d"}], "stats": {"total": 114, "additions": 35, "deletions": 79}, "files": [{"sha": "7354b3832b191e98a6bc97e183c5b677d7e5e8fb", "filename": "crates/ra_db/src/lib.rs", "status": "modified", "additions": 24, "deletions": 29, "changes": 53, "blob_url": "https://github.com/rust-lang/rust/blob/bbb40d746368eb6a38498649a723c7ead0ef8136/crates%2Fra_db%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bbb40d746368eb6a38498649a723c7ead0ef8136/crates%2Fra_db%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_db%2Fsrc%2Flib.rs?ref=bbb40d746368eb6a38498649a723c7ead0ef8136", "patch": "@@ -89,14 +89,13 @@ pub const DEFAULT_LRU_CAP: usize = 128;\n pub trait FileLoader {\n     /// Text of the file.\n     fn file_text(&self, file_id: FileId) -> Arc<String>;\n+    /// Note that we intentionally accept a `&str` and not a `&Path` here. This\n+    /// method exists to handle `#[path = \"/some/path.rs\"] mod foo;` and such,\n+    /// so the input is guaranteed to be utf-8 string. We might introduce\n+    /// `struct StrPath(str)` for clarity some day, but it's a bit messy, so we\n+    /// get by with a `&str` for the time being.\n     fn resolve_path(&self, anchor: FileId, path: &str) -> Option<FileId>;\n     fn relevant_crates(&self, file_id: FileId) -> Arc<Vec<CrateId>>;\n-\n-    fn resolve_extern_path(\n-        &self,\n-        extern_id: ExternSourceId,\n-        relative_path: &RelativePath,\n-    ) -> Option<FileId>;\n }\n \n /// Database which stores all significant input facts: source code and project\n@@ -154,34 +153,30 @@ impl<T: SourceDatabaseExt> FileLoader for FileLoaderDelegate<&'_ T> {\n     fn file_text(&self, file_id: FileId) -> Arc<String> {\n         SourceDatabaseExt::file_text(self.0, file_id)\n     }\n-    /// Note that we intentionally accept a `&str` and not a `&Path` here. This\n-    /// method exists to handle `#[path = \"/some/path.rs\"] mod foo;` and such,\n-    /// so the input is guaranteed to be utf-8 string. We might introduce\n-    /// `struct StrPath(str)` for clarity some day, but it's a bit messy, so we\n-    /// get by with a `&str` for the time being.\n     fn resolve_path(&self, anchor: FileId, path: &str) -> Option<FileId> {\n-        let rel_path = {\n-            let mut rel_path = self.0.file_relative_path(anchor);\n-            assert!(rel_path.pop());\n-            rel_path.push(path);\n-            rel_path.normalize()\n-        };\n-        let source_root = self.0.file_source_root(anchor);\n-        let source_root = self.0.source_root(source_root);\n-        source_root.file_by_relative_path(&rel_path)\n+        // FIXME: this *somehow* should be platform agnostic...\n+        if std::path::Path::new(path).is_absolute() {\n+            let krate = *self.relevant_crates(anchor).get(0)?;\n+            let (extern_source_id, relative_file) =\n+                self.0.crate_graph()[krate].extern_source.extern_path(path)?;\n+\n+            let source_root = self.0.source_root(SourceRootId(extern_source_id.0));\n+            source_root.file_by_relative_path(&relative_file)\n+        } else {\n+            let rel_path = {\n+                let mut rel_path = self.0.file_relative_path(anchor);\n+                assert!(rel_path.pop());\n+                rel_path.push(path);\n+                rel_path.normalize()\n+            };\n+            let source_root = self.0.file_source_root(anchor);\n+            let source_root = self.0.source_root(source_root);\n+            source_root.file_by_relative_path(&rel_path)\n+        }\n     }\n \n     fn relevant_crates(&self, file_id: FileId) -> Arc<Vec<CrateId>> {\n         let source_root = self.0.file_source_root(file_id);\n         self.0.source_root_crates(source_root)\n     }\n-\n-    fn resolve_extern_path(\n-        &self,\n-        extern_id: ExternSourceId,\n-        relative_path: &RelativePath,\n-    ) -> Option<FileId> {\n-        let source_root = self.0.source_root(SourceRootId(extern_id.0));\n-        source_root.file_by_relative_path(&relative_path)\n-    }\n }"}, {"sha": "bcfa66ac953cbe20e0a6586b957e5e61490d2b1d", "filename": "crates/ra_hir_def/src/test_db.rs", "status": "modified", "additions": 1, "deletions": 11, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/bbb40d746368eb6a38498649a723c7ead0ef8136/crates%2Fra_hir_def%2Fsrc%2Ftest_db.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bbb40d746368eb6a38498649a723c7ead0ef8136/crates%2Fra_hir_def%2Fsrc%2Ftest_db.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_def%2Fsrc%2Ftest_db.rs?ref=bbb40d746368eb6a38498649a723c7ead0ef8136", "patch": "@@ -6,9 +6,7 @@ use std::{\n };\n \n use hir_expand::db::AstDatabase;\n-use ra_db::{\n-    salsa, CrateId, ExternSourceId, FileId, FileLoader, FileLoaderDelegate, RelativePath, Upcast,\n-};\n+use ra_db::{salsa, CrateId, FileId, FileLoader, FileLoaderDelegate, Upcast};\n \n use crate::db::DefDatabase;\n \n@@ -64,14 +62,6 @@ impl FileLoader for TestDB {\n     fn relevant_crates(&self, file_id: FileId) -> Arc<Vec<CrateId>> {\n         FileLoaderDelegate(self).relevant_crates(file_id)\n     }\n-\n-    fn resolve_extern_path(\n-        &self,\n-        extern_id: ExternSourceId,\n-        relative_path: &RelativePath,\n-    ) -> Option<FileId> {\n-        FileLoaderDelegate(self).resolve_extern_path(extern_id, relative_path)\n-    }\n }\n \n impl TestDB {"}, {"sha": "7579546d2f3fafac2a05f4430cc82f9bf4d2a2c0", "filename": "crates/ra_hir_expand/src/builtin_macro.rs", "status": "modified", "additions": 6, "deletions": 12, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/bbb40d746368eb6a38498649a723c7ead0ef8136/crates%2Fra_hir_expand%2Fsrc%2Fbuiltin_macro.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bbb40d746368eb6a38498649a723c7ead0ef8136/crates%2Fra_hir_expand%2Fsrc%2Fbuiltin_macro.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_expand%2Fsrc%2Fbuiltin_macro.rs?ref=bbb40d746368eb6a38498649a723c7ead0ef8136", "patch": "@@ -295,19 +295,13 @@ fn concat_expand(\n \n fn relative_file(db: &dyn AstDatabase, call_id: MacroCallId, path: &str) -> Option<FileId> {\n     let call_site = call_id.as_file().original_file(db);\n-\n-    // Handle trivial case\n-    if let Some(res) = db.resolve_path(call_site, path) {\n-        // Prevent include itself\n-        return if res == call_site { None } else { Some(res) };\n+    let res = db.resolve_path(call_site, path)?;\n+    // Prevent include itself\n+    if res == call_site {\n+        None\n+    } else {\n+        Some(res)\n     }\n-\n-    // Extern paths ?\n-    let krate = *db.relevant_crates(call_site).get(0)?;\n-    let (extern_source_id, relative_file) =\n-        db.crate_graph()[krate].extern_source.extern_path(path)?;\n-\n-    db.resolve_extern_path(extern_source_id, &relative_file)\n }\n \n fn parse_string(tt: &tt::Subtree) -> Result<String, mbe::ExpandError> {"}, {"sha": "fdf225f55be9920777876f4b34345c4ed22e3a26", "filename": "crates/ra_hir_expand/src/test_db.rs", "status": "modified", "additions": 1, "deletions": 8, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/bbb40d746368eb6a38498649a723c7ead0ef8136/crates%2Fra_hir_expand%2Fsrc%2Ftest_db.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bbb40d746368eb6a38498649a723c7ead0ef8136/crates%2Fra_hir_expand%2Fsrc%2Ftest_db.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_expand%2Fsrc%2Ftest_db.rs?ref=bbb40d746368eb6a38498649a723c7ead0ef8136", "patch": "@@ -5,7 +5,7 @@ use std::{\n     sync::{Arc, Mutex},\n };\n \n-use ra_db::{salsa, CrateId, ExternSourceId, FileId, FileLoader, FileLoaderDelegate, RelativePath};\n+use ra_db::{salsa, CrateId, FileId, FileLoader, FileLoaderDelegate};\n \n #[salsa::database(\n     ra_db::SourceDatabaseExtStorage,\n@@ -47,11 +47,4 @@ impl FileLoader for TestDB {\n     fn relevant_crates(&self, file_id: FileId) -> Arc<Vec<CrateId>> {\n         FileLoaderDelegate(self).relevant_crates(file_id)\n     }\n-    fn resolve_extern_path(\n-        &self,\n-        anchor: ExternSourceId,\n-        relative_path: &RelativePath,\n-    ) -> Option<FileId> {\n-        FileLoaderDelegate(self).resolve_extern_path(anchor, relative_path)\n-    }\n }"}, {"sha": "e484968a099c39498e91416e7082b02b1227b330", "filename": "crates/ra_hir_ty/src/test_db.rs", "status": "modified", "additions": 1, "deletions": 10, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/bbb40d746368eb6a38498649a723c7ead0ef8136/crates%2Fra_hir_ty%2Fsrc%2Ftest_db.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bbb40d746368eb6a38498649a723c7ead0ef8136/crates%2Fra_hir_ty%2Fsrc%2Ftest_db.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_ty%2Fsrc%2Ftest_db.rs?ref=bbb40d746368eb6a38498649a723c7ead0ef8136", "patch": "@@ -7,9 +7,7 @@ use std::{\n \n use hir_def::{db::DefDatabase, AssocItemId, ModuleDefId, ModuleId};\n use hir_expand::{db::AstDatabase, diagnostics::DiagnosticSink};\n-use ra_db::{\n-    salsa, CrateId, FileId, FileLoader, FileLoaderDelegate, RelativePath, SourceDatabase, Upcast,\n-};\n+use ra_db::{salsa, CrateId, FileId, FileLoader, FileLoaderDelegate, SourceDatabase, Upcast};\n use stdx::format_to;\n \n use crate::{db::HirDatabase, diagnostics::Diagnostic, expr::ExprValidator};\n@@ -78,13 +76,6 @@ impl FileLoader for TestDB {\n     fn relevant_crates(&self, file_id: FileId) -> Arc<Vec<CrateId>> {\n         FileLoaderDelegate(self).relevant_crates(file_id)\n     }\n-    fn resolve_extern_path(\n-        &self,\n-        extern_id: ra_db::ExternSourceId,\n-        relative_path: &RelativePath,\n-    ) -> Option<FileId> {\n-        FileLoaderDelegate(self).resolve_extern_path(extern_id, relative_path)\n-    }\n }\n \n impl TestDB {"}, {"sha": "727d743b5fda59c8a8b68f7d94bbbe6e4b84f743", "filename": "crates/ra_ide_db/src/lib.rs", "status": "modified", "additions": 2, "deletions": 9, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/bbb40d746368eb6a38498649a723c7ead0ef8136/crates%2Fra_ide_db%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bbb40d746368eb6a38498649a723c7ead0ef8136/crates%2Fra_ide_db%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_db%2Fsrc%2Flib.rs?ref=bbb40d746368eb6a38498649a723c7ead0ef8136", "patch": "@@ -16,8 +16,8 @@ use std::sync::Arc;\n use hir::db::{AstDatabase, DefDatabase};\n use ra_db::{\n     salsa::{self, Database, Durability},\n-    Canceled, CheckCanceled, CrateId, FileId, FileLoader, FileLoaderDelegate, RelativePath,\n-    SourceDatabase, SourceRootId, Upcast,\n+    Canceled, CheckCanceled, CrateId, FileId, FileLoader, FileLoaderDelegate, SourceDatabase,\n+    SourceRootId, Upcast,\n };\n use rustc_hash::FxHashMap;\n \n@@ -63,13 +63,6 @@ impl FileLoader for RootDatabase {\n     fn relevant_crates(&self, file_id: FileId) -> Arc<Vec<CrateId>> {\n         FileLoaderDelegate(self).relevant_crates(file_id)\n     }\n-    fn resolve_extern_path(\n-        &self,\n-        extern_id: ra_db::ExternSourceId,\n-        relative_path: &RelativePath,\n-    ) -> Option<FileId> {\n-        FileLoaderDelegate(self).resolve_extern_path(extern_id, relative_path)\n-    }\n }\n \n impl salsa::Database for RootDatabase {"}]}