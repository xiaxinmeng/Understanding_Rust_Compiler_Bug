{"sha": "85b55ce00df3766db2b617bda4b2457f6d76e542", "node_id": "C_kwDOAAsO6NoAKDg1YjU1Y2UwMGRmMzc2NmRiMmI2MTdiZGE0YjI0NTdmNmQ3NmU1NDI", "commit": {"author": {"name": "Josh Stone", "email": "jistone@redhat.com", "date": "2021-10-15T19:21:45Z"}, "committer": {"name": "Josh Stone", "email": "jistone@redhat.com", "date": "2021-11-05T21:48:41Z"}, "message": "Only use `clone3` when needed for pidfd\n\nIn #89522 we learned that `clone3` is interacting poorly with Gentoo's\n`sandbox` tool. We only need that for the unstable pidfd extensions, so\notherwise avoid that and use a normal `fork`.", "tree": {"sha": "2607c754742cca400de0fc504eb67d8eb65465e3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2607c754742cca400de0fc504eb67d8eb65465e3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/85b55ce00df3766db2b617bda4b2457f6d76e542", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/85b55ce00df3766db2b617bda4b2457f6d76e542", "html_url": "https://github.com/rust-lang/rust/commit/85b55ce00df3766db2b617bda4b2457f6d76e542", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/85b55ce00df3766db2b617bda4b2457f6d76e542/comments", "author": {"login": "cuviper", "id": 36186, "node_id": "MDQ6VXNlcjM2MTg2", "avatar_url": "https://avatars.githubusercontent.com/u/36186?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cuviper", "html_url": "https://github.com/cuviper", "followers_url": "https://api.github.com/users/cuviper/followers", "following_url": "https://api.github.com/users/cuviper/following{/other_user}", "gists_url": "https://api.github.com/users/cuviper/gists{/gist_id}", "starred_url": "https://api.github.com/users/cuviper/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cuviper/subscriptions", "organizations_url": "https://api.github.com/users/cuviper/orgs", "repos_url": "https://api.github.com/users/cuviper/repos", "events_url": "https://api.github.com/users/cuviper/events{/privacy}", "received_events_url": "https://api.github.com/users/cuviper/received_events", "type": "User", "site_admin": false}, "committer": {"login": "cuviper", "id": 36186, "node_id": "MDQ6VXNlcjM2MTg2", "avatar_url": "https://avatars.githubusercontent.com/u/36186?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cuviper", "html_url": "https://github.com/cuviper", "followers_url": "https://api.github.com/users/cuviper/followers", "following_url": "https://api.github.com/users/cuviper/following{/other_user}", "gists_url": "https://api.github.com/users/cuviper/gists{/gist_id}", "starred_url": "https://api.github.com/users/cuviper/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cuviper/subscriptions", "organizations_url": "https://api.github.com/users/cuviper/orgs", "repos_url": "https://api.github.com/users/cuviper/repos", "events_url": "https://api.github.com/users/cuviper/events{/privacy}", "received_events_url": "https://api.github.com/users/cuviper/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "045612b8b97b344d55c13b9aad3cfb3e98405b77", "url": "https://api.github.com/repos/rust-lang/rust/commits/045612b8b97b344d55c13b9aad3cfb3e98405b77", "html_url": "https://github.com/rust-lang/rust/commit/045612b8b97b344d55c13b9aad3cfb3e98405b77"}], "stats": {"total": 13, "additions": 6, "deletions": 7}, "files": [{"sha": "d0af2b6e9db0c25e449d5b8aa324566c62391516", "filename": "library/std/src/sys/unix/process/process_unix.rs", "status": "modified", "additions": 6, "deletions": 7, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/85b55ce00df3766db2b617bda4b2457f6d76e542/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fprocess%2Fprocess_unix.rs", "raw_url": "https://github.com/rust-lang/rust/raw/85b55ce00df3766db2b617bda4b2457f6d76e542/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fprocess%2Fprocess_unix.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fprocess%2Fprocess_unix.rs?ref=85b55ce00df3766db2b617bda4b2457f6d76e542", "patch": "@@ -166,21 +166,20 @@ impl Command {\n             fn clone3(cl_args: *mut clone_args, len: libc::size_t) -> libc::c_long\n         }\n \n+        // Bypassing libc for `clone3` can make further libc calls unsafe,\n+        // so we use it sparingly for now. See #89522 for details.\n+        let want_clone3_pidfd = self.get_create_pidfd();\n+\n         // If we fail to create a pidfd for any reason, this will\n         // stay as -1, which indicates an error.\n         let mut pidfd: pid_t = -1;\n \n         // Attempt to use the `clone3` syscall, which supports more arguments\n         // (in particular, the ability to create a pidfd). If this fails,\n         // we will fall through this block to a call to `fork()`\n-        if HAS_CLONE3.load(Ordering::Relaxed) {\n-            let mut flags = 0;\n-            if self.get_create_pidfd() {\n-                flags |= CLONE_PIDFD;\n-            }\n-\n+        if want_clone3_pidfd && HAS_CLONE3.load(Ordering::Relaxed) {\n             let mut args = clone_args {\n-                flags,\n+                flags: CLONE_PIDFD,\n                 pidfd: &mut pidfd as *mut pid_t as u64,\n                 child_tid: 0,\n                 parent_tid: 0,"}]}