{"sha": "3f5c743b531e948788db18ce8d514de06113cb35", "node_id": "MDY6Q29tbWl0NzI0NzEyOjNmNWM3NDNiNTMxZTk0ODc4OGRiMThjZThkNTE0ZGUwNjExM2NiMzU=", "commit": {"author": {"name": "Wesley Wiser", "email": "wwiser@gmail.com", "date": "2019-05-11T15:24:14Z"}, "committer": {"name": "Wesley Wiser", "email": "wwiser@gmail.com", "date": "2019-05-19T20:46:51Z"}, "message": "[const-prop] Support propagating into SwitchInt's `discr` Operand", "tree": {"sha": "e7aed559ba3c9642b2b4e98a93c1eb2d2421ca41", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e7aed559ba3c9642b2b4e98a93c1eb2d2421ca41"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3f5c743b531e948788db18ce8d514de06113cb35", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3f5c743b531e948788db18ce8d514de06113cb35", "html_url": "https://github.com/rust-lang/rust/commit/3f5c743b531e948788db18ce8d514de06113cb35", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3f5c743b531e948788db18ce8d514de06113cb35/comments", "author": {"login": "wesleywiser", "id": 831192, "node_id": "MDQ6VXNlcjgzMTE5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/831192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wesleywiser", "html_url": "https://github.com/wesleywiser", "followers_url": "https://api.github.com/users/wesleywiser/followers", "following_url": "https://api.github.com/users/wesleywiser/following{/other_user}", "gists_url": "https://api.github.com/users/wesleywiser/gists{/gist_id}", "starred_url": "https://api.github.com/users/wesleywiser/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wesleywiser/subscriptions", "organizations_url": "https://api.github.com/users/wesleywiser/orgs", "repos_url": "https://api.github.com/users/wesleywiser/repos", "events_url": "https://api.github.com/users/wesleywiser/events{/privacy}", "received_events_url": "https://api.github.com/users/wesleywiser/received_events", "type": "User", "site_admin": false}, "committer": {"login": "wesleywiser", "id": 831192, "node_id": "MDQ6VXNlcjgzMTE5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/831192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wesleywiser", "html_url": "https://github.com/wesleywiser", "followers_url": "https://api.github.com/users/wesleywiser/followers", "following_url": "https://api.github.com/users/wesleywiser/following{/other_user}", "gists_url": "https://api.github.com/users/wesleywiser/gists{/gist_id}", "starred_url": "https://api.github.com/users/wesleywiser/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wesleywiser/subscriptions", "organizations_url": "https://api.github.com/users/wesleywiser/orgs", "repos_url": "https://api.github.com/users/wesleywiser/repos", "events_url": "https://api.github.com/users/wesleywiser/events{/privacy}", "received_events_url": "https://api.github.com/users/wesleywiser/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8e99c76089ecb69479532e22ae2879e3bb1b3d68", "url": "https://api.github.com/repos/rust-lang/rust/commits/8e99c76089ecb69479532e22ae2879e3bb1b3d68", "html_url": "https://github.com/rust-lang/rust/commit/8e99c76089ecb69479532e22ae2879e3bb1b3d68"}], "stats": {"total": 53, "additions": 49, "deletions": 4}, "files": [{"sha": "023b7132bd58d7cc2b3a0d874a84acc490772c70", "filename": "src/librustc_mir/transform/const_prop.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/3f5c743b531e948788db18ce8d514de06113cb35/src%2Flibrustc_mir%2Ftransform%2Fconst_prop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3f5c743b531e948788db18ce8d514de06113cb35/src%2Flibrustc_mir%2Ftransform%2Fconst_prop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fconst_prop.rs?ref=3f5c743b531e948788db18ce8d514de06113cb35", "patch": "@@ -736,6 +736,13 @@ impl<'b, 'a, 'tcx> MutVisitor<'tcx> for ConstPropagator<'b, 'a, 'tcx> {\n                     }\n                 }\n             },\n+            TerminatorKind::SwitchInt { ref mut discr, switch_ty, .. } => {\n+                if let Some(value) = self.eval_operand(&discr, source_info) {\n+                    if let ScalarMaybeUndef::Scalar(scalar) = self.ecx.read_scalar(value).unwrap() {\n+                        *discr = self.operand_from_scalar(scalar, switch_ty, source_info.span);\n+                    }\n+                }\n+            },\n             _ => {}\n         }\n     }"}, {"sha": "0df1112ec3eb7283ced4451208e1f1e31f9ad7bb", "filename": "src/test/mir-opt/const_prop/switch_int.rs", "status": "added", "additions": 38, "deletions": 0, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/3f5c743b531e948788db18ce8d514de06113cb35/src%2Ftest%2Fmir-opt%2Fconst_prop%2Fswitch_int.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3f5c743b531e948788db18ce8d514de06113cb35/src%2Ftest%2Fmir-opt%2Fconst_prop%2Fswitch_int.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fconst_prop%2Fswitch_int.rs?ref=3f5c743b531e948788db18ce8d514de06113cb35", "patch": "@@ -0,0 +1,38 @@\n+#[inline(never)]\n+fn foo(_: i32) { }\n+\n+fn main() {\n+    match 1 {\n+        1 => foo(0),\n+        _ => foo(-1),\n+    }\n+}\n+\n+// END RUST SOURCE\n+// START rustc.main.ConstProp.before.mir\n+//  bb0: {\n+//      ...\n+//      _1 = const 1i32;\n+//      switchInt(_1) -> [1i32: bb1, otherwise: bb2];\n+//  }\n+// END rustc.main.ConstProp.before.mir\n+// START rustc.main.ConstProp.after.mir\n+//  bb0: {\n+//      ...\n+//      switchInt(const 1i32) -> [1i32: bb1, otherwise: bb2];\n+//  }\n+// END rustc.main.ConstProp.after.mir\n+// START rustc.main.SimplifyBranches-after-const-prop.before.mir\n+//  bb0: {\n+//      ...\n+//      _1 = const 1i32;\n+//      switchInt(const 1i32) -> [1i32: bb1, otherwise: bb2];\n+//  }\n+// END rustc.main.SimplifyBranches-after-const-prop.before.mir\n+// START rustc.main.SimplifyBranches-after-const-prop.after.mir\n+//  bb0: {\n+//      ...\n+//      _1 = const 1i32;\n+//      goto -> bb1;\n+//  }\n+// END rustc.main.SimplifyBranches-after-const-prop.after.mir"}, {"sha": "35512b94c0c8cf8f96c87db6ab2350ae51118525", "filename": "src/test/mir-opt/simplify_if.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/3f5c743b531e948788db18ce8d514de06113cb35/src%2Ftest%2Fmir-opt%2Fsimplify_if.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3f5c743b531e948788db18ce8d514de06113cb35/src%2Ftest%2Fmir-opt%2Fsimplify_if.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fsimplify_if.rs?ref=3f5c743b531e948788db18ce8d514de06113cb35", "patch": "@@ -5,15 +5,15 @@ fn main() {\n }\n \n // END RUST SOURCE\n-// START rustc.main.SimplifyBranches-after-copy-prop.before.mir\n+// START rustc.main.SimplifyBranches-after-const-prop.before.mir\n // bb0: {\n //     ...\n //     switchInt(const false) -> [false: bb3, otherwise: bb1];\n // }\n-// END rustc.main.SimplifyBranches-after-copy-prop.before.mir\n-// START rustc.main.SimplifyBranches-after-copy-prop.after.mir\n+// END rustc.main.SimplifyBranches-after-const-prop.before.mir\n+// START rustc.main.SimplifyBranches-after-const-prop.after.mir\n // bb0: {\n //     ...\n //     goto -> bb3;\n // }\n-// END rustc.main.SimplifyBranches-after-copy-prop.after.mir\n+// END rustc.main.SimplifyBranches-after-const-prop.after.mir"}]}