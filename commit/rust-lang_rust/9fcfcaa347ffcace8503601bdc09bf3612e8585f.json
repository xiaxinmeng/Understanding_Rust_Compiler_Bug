{"sha": "9fcfcaa347ffcace8503601bdc09bf3612e8585f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjlmY2ZjYWEzNDdmZmNhY2U4NTAzNjAxYmRjMDliZjM2MTJlODU4NWY=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-09-21T18:15:30Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-09-21T18:15:30Z"}, "message": "auto merge of #17416 : vadimcn/rust/term-colors, r=alexcrichton", "tree": {"sha": "bf54c2a42fc0ac847b7550df7c093a562babe481", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bf54c2a42fc0ac847b7550df7c093a562babe481"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9fcfcaa347ffcace8503601bdc09bf3612e8585f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9fcfcaa347ffcace8503601bdc09bf3612e8585f", "html_url": "https://github.com/rust-lang/rust/commit/9fcfcaa347ffcace8503601bdc09bf3612e8585f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9fcfcaa347ffcace8503601bdc09bf3612e8585f/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8d3728fae0fa1979349836be112562aa6d455e76", "url": "https://api.github.com/repos/rust-lang/rust/commits/8d3728fae0fa1979349836be112562aa6d455e76", "html_url": "https://github.com/rust-lang/rust/commit/8d3728fae0fa1979349836be112562aa6d455e76"}, {"sha": "b11c5722f84879db3539e84d8d21c4c758165163", "url": "https://api.github.com/repos/rust-lang/rust/commits/b11c5722f84879db3539e84d8d21c4c758165163", "html_url": "https://github.com/rust-lang/rust/commit/b11c5722f84879db3539e84d8d21c4c758165163"}], "stats": {"total": 54, "additions": 51, "deletions": 3}, "files": [{"sha": "0aae85503d07ddaf5647950e410a1762c029f871", "filename": "src/libterm/win.rs", "status": "modified", "additions": 51, "deletions": 3, "changes": 54, "blob_url": "https://github.com/rust-lang/rust/blob/9fcfcaa347ffcace8503601bdc09bf3612e8585f/src%2Flibterm%2Fwin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9fcfcaa347ffcace8503601bdc09bf3612e8585f/src%2Flibterm%2Fwin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibterm%2Fwin.rs?ref=9fcfcaa347ffcace8503601bdc09bf3612e8585f", "patch": "@@ -23,15 +23,29 @@ use Terminal;\n /// A Terminal implementation which uses the Win32 Console API.\n pub struct WinConsole<T> {\n     buf: T,\n+    def_foreground: color::Color,\n+    def_background: color::Color,\n     foreground: color::Color,\n     background: color::Color,\n }\n \n+#[allow(non_snake_case)]\n+#[repr(C)]\n+struct CONSOLE_SCREEN_BUFFER_INFO {\n+    dwSize: [libc::c_short, ..2],\n+    dwCursorPosition: [libc::c_short, ..2],\n+    wAttributes: libc::WORD,\n+    srWindow: [libc::c_short, ..4],\n+    dwMaximumWindowSize: [libc::c_short, ..2],\n+}\n+\n #[allow(non_snake_case)]\n #[link(name = \"kernel32\")]\n extern \"system\" {\n     fn SetConsoleTextAttribute(handle: libc::HANDLE, attr: libc::WORD) -> libc::BOOL;\n     fn GetStdHandle(which: libc::DWORD) -> libc::HANDLE;\n+    fn GetConsoleScreenBufferInfo(handle: libc::HANDLE,\n+                                  info: *mut CONSOLE_SCREEN_BUFFER_INFO) -> libc::BOOL;\n }\n \n fn color_to_bits(color: color::Color) -> u16 {\n@@ -56,6 +70,26 @@ fn color_to_bits(color: color::Color) -> u16 {\n     }\n }\n \n+fn bits_to_color(bits: u16) -> color::Color {\n+    let color = match bits & 0x7 {\n+        0 => color::BLACK,\n+        0x1 => color::BLUE,\n+        0x2 => color::GREEN,\n+        0x4 => color::RED,\n+        0x6 => color::YELLOW,\n+        0x5 => color::MAGENTA,\n+        0x3 => color::CYAN,\n+        0x7 => color::WHITE,\n+        _ => unreachable!()\n+    };\n+\n+    if bits >= 8 {\n+        color | 0x8\n+    } else {\n+        color\n+    }\n+}\n+\n impl<T: Writer> WinConsole<T> {\n     fn apply(&mut self) {\n         let _unused = self.buf.flush();\n@@ -91,7 +125,21 @@ impl<T: Writer> Writer for WinConsole<T> {\n \n impl<T: Writer> Terminal<T> for WinConsole<T> {\n     fn new(out: T) -> Option<WinConsole<T>> {\n-        Some(WinConsole { buf: out, foreground: color::WHITE, background: color::BLACK })\n+        let fg;\n+        let bg;\n+        unsafe {\n+            let mut buffer_info = ::std::mem::uninitialized();\n+            if GetConsoleScreenBufferInfo(GetStdHandle(-11), &mut buffer_info) != 0 {\n+                fg = bits_to_color(buffer_info.wAttributes);\n+                bg = bits_to_color(buffer_info.wAttributes >> 4);\n+            } else {\n+                fg = color::WHITE;\n+                bg = color::BLACK;\n+            }\n+        }\n+        Some(WinConsole { buf: out,\n+                          def_foreground: fg, def_background: bg,\n+                          foreground: fg, background: bg } )\n     }\n \n     fn fg(&mut self, color: color::Color) -> IoResult<bool> {\n@@ -134,8 +182,8 @@ impl<T: Writer> Terminal<T> for WinConsole<T> {\n     }\n \n     fn reset(&mut self) -> IoResult<()> {\n-        self.foreground = color::WHITE;\n-        self.background = color::BLACK;\n+        self.foreground = self.def_foreground;\n+        self.background = self.def_background;\n         self.apply();\n \n         Ok(())"}]}