{"sha": "8a845eda7bfd24aa4d85f1656bd053db05446a3e", "node_id": "MDY6Q29tbWl0NzI0NzEyOjhhODQ1ZWRhN2JmZDI0YWE0ZDg1ZjE2NTZiZDA1M2RiMDU0NDZhM2U=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-08-25T10:58:27Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-08-25T10:58:27Z"}, "message": "Merge #5870\n\n5870: Move code_model attrs to a new module r=matklad a=matklad\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>", "tree": {"sha": "eb0452d7d5372c1dc5cd222189bc5835dab00536", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/eb0452d7d5372c1dc5cd222189bc5835dab00536"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8a845eda7bfd24aa4d85f1656bd053db05446a3e", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfRO7TCRBK7hj4Ov3rIwAAdHIIAA/9D8O2rk+E5BcZtHw+AFob\ndmGTqPVF7drQq3cK5DR3gYCZjVakUEjegcP9bhwcMtv6YQy8KDK4Ib+PINPvkDQ8\nbAvLt5vK2gSYrgkx2Q4/DcMJOC91BgdYSqDMJCqJt1gW9k/IgypoqayOfh3qXcE/\naRDyzSnKPJyVMZm+Lg6+2WgN5aKtknOYZZvsujf9XinPlhST9FlM0ZCENeJGgmRy\nHG47a00gI6qPRGqtdYoA8ueQ4Ce5OdaQVU8J6DGHaezHnDNMd9m/Y4nqGzOqHHol\nMXrpqZL+V44tCzLgzl7RD2/0qQjnHR422O9Sp4U8XOisFRc2k1bt6XgAMvMldow=\n=4dcw\n-----END PGP SIGNATURE-----\n", "payload": "tree eb0452d7d5372c1dc5cd222189bc5835dab00536\nparent 463d44075fa0420af7f2afe9d1a6727ae6baa5bd\nparent 748788530962a4095762b82c21756ff4589066b3\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1598353107 +0000\ncommitter GitHub <noreply@github.com> 1598353107 +0000\n\nMerge #5870\n\n5870: Move code_model attrs to a new module r=matklad a=matklad\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8a845eda7bfd24aa4d85f1656bd053db05446a3e", "html_url": "https://github.com/rust-lang/rust/commit/8a845eda7bfd24aa4d85f1656bd053db05446a3e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8a845eda7bfd24aa4d85f1656bd053db05446a3e/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "463d44075fa0420af7f2afe9d1a6727ae6baa5bd", "url": "https://api.github.com/repos/rust-lang/rust/commits/463d44075fa0420af7f2afe9d1a6727ae6baa5bd", "html_url": "https://github.com/rust-lang/rust/commit/463d44075fa0420af7f2afe9d1a6727ae6baa5bd"}, {"sha": "748788530962a4095762b82c21756ff4589066b3", "url": "https://api.github.com/repos/rust-lang/rust/commits/748788530962a4095762b82c21756ff4589066b3", "html_url": "https://github.com/rust-lang/rust/commit/748788530962a4095762b82c21756ff4589066b3"}], "stats": {"total": 266, "additions": 140, "deletions": 126}, "files": [{"sha": "953960e145353a5e8b4e761b82c6af8320d9674b", "filename": "crates/hir/src/attrs.rs", "status": "added", "additions": 132, "deletions": 0, "changes": 132, "blob_url": "https://github.com/rust-lang/rust/blob/8a845eda7bfd24aa4d85f1656bd053db05446a3e/crates%2Fhir%2Fsrc%2Fattrs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8a845eda7bfd24aa4d85f1656bd053db05446a3e/crates%2Fhir%2Fsrc%2Fattrs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir%2Fsrc%2Fattrs.rs?ref=8a845eda7bfd24aa4d85f1656bd053db05446a3e", "patch": "@@ -0,0 +1,132 @@\n+//! Attributes & documentation for hir types.\n+use hir_def::{\n+    attr::Attrs,\n+    db::DefDatabase,\n+    docs::Documentation,\n+    resolver::{HasResolver, Resolver},\n+    AdtId, FunctionId, GenericDefId, ModuleId, StaticId, TraitId, VariantId,\n+};\n+use hir_ty::db::HirDatabase;\n+use stdx::impl_from;\n+\n+use crate::{\n+    doc_links::Resolvable, Adt, Const, Enum, EnumVariant, Field, Function, GenericDef, ImplDef,\n+    Local, MacroDef, Module, ModuleDef, Static, Struct, Trait, TypeAlias, TypeParam, Union,\n+};\n+\n+#[derive(Clone, Copy, Debug, PartialEq, Eq, Hash)]\n+pub enum AttrDef {\n+    Module(Module),\n+    Field(Field),\n+    Adt(Adt),\n+    Function(Function),\n+    EnumVariant(EnumVariant),\n+    Static(Static),\n+    Const(Const),\n+    Trait(Trait),\n+    TypeAlias(TypeAlias),\n+    MacroDef(MacroDef),\n+}\n+\n+impl_from!(\n+    Module,\n+    Field,\n+    Adt(Struct, Enum, Union),\n+    EnumVariant,\n+    Static,\n+    Const,\n+    Function,\n+    Trait,\n+    TypeAlias,\n+    MacroDef\n+    for AttrDef\n+);\n+\n+pub trait HasAttrs {\n+    fn attrs(self, db: &dyn HirDatabase) -> Attrs;\n+    fn docs(self, db: &dyn HirDatabase) -> Option<Documentation>;\n+}\n+\n+impl<T: Into<AttrDef>> HasAttrs for T {\n+    fn attrs(self, db: &dyn HirDatabase) -> Attrs {\n+        let def: AttrDef = self.into();\n+        db.attrs(def.into())\n+    }\n+    fn docs(self, db: &dyn HirDatabase) -> Option<Documentation> {\n+        let def: AttrDef = self.into();\n+        db.documentation(def.into())\n+    }\n+}\n+\n+impl Resolvable for ModuleDef {\n+    fn resolver<D: DefDatabase + HirDatabase>(&self, db: &D) -> Option<Resolver> {\n+        Some(match self {\n+            ModuleDef::Module(m) => ModuleId::from(m.clone()).resolver(db),\n+            ModuleDef::Function(f) => FunctionId::from(f.clone()).resolver(db),\n+            ModuleDef::Adt(adt) => AdtId::from(adt.clone()).resolver(db),\n+            ModuleDef::EnumVariant(ev) => {\n+                GenericDefId::from(GenericDef::from(ev.clone())).resolver(db)\n+            }\n+            ModuleDef::Const(c) => GenericDefId::from(GenericDef::from(c.clone())).resolver(db),\n+            ModuleDef::Static(s) => StaticId::from(s.clone()).resolver(db),\n+            ModuleDef::Trait(t) => TraitId::from(t.clone()).resolver(db),\n+            ModuleDef::TypeAlias(t) => ModuleId::from(t.module(db)).resolver(db),\n+            // FIXME: This should be a resolver relative to `std/core`\n+            ModuleDef::BuiltinType(_t) => None?,\n+        })\n+    }\n+\n+    fn try_into_module_def(self) -> Option<ModuleDef> {\n+        Some(self)\n+    }\n+}\n+\n+impl Resolvable for TypeParam {\n+    fn resolver<D: DefDatabase + HirDatabase>(&self, db: &D) -> Option<Resolver> {\n+        Some(ModuleId::from(self.module(db)).resolver(db))\n+    }\n+\n+    fn try_into_module_def(self) -> Option<ModuleDef> {\n+        None\n+    }\n+}\n+\n+impl Resolvable for MacroDef {\n+    fn resolver<D: DefDatabase + HirDatabase>(&self, db: &D) -> Option<Resolver> {\n+        Some(ModuleId::from(self.module(db)?).resolver(db))\n+    }\n+\n+    fn try_into_module_def(self) -> Option<ModuleDef> {\n+        None\n+    }\n+}\n+\n+impl Resolvable for Field {\n+    fn resolver<D: DefDatabase + HirDatabase>(&self, db: &D) -> Option<Resolver> {\n+        Some(VariantId::from(self.parent_def(db)).resolver(db))\n+    }\n+\n+    fn try_into_module_def(self) -> Option<ModuleDef> {\n+        None\n+    }\n+}\n+\n+impl Resolvable for ImplDef {\n+    fn resolver<D: DefDatabase + HirDatabase>(&self, db: &D) -> Option<Resolver> {\n+        Some(ModuleId::from(self.module(db)).resolver(db))\n+    }\n+\n+    fn try_into_module_def(self) -> Option<ModuleDef> {\n+        None\n+    }\n+}\n+\n+impl Resolvable for Local {\n+    fn resolver<D: DefDatabase + HirDatabase>(&self, db: &D) -> Option<Resolver> {\n+        Some(ModuleId::from(self.module(db)).resolver(db))\n+    }\n+\n+    fn try_into_module_def(self) -> Option<ModuleDef> {\n+        None\n+    }\n+}"}, {"sha": "59d8b3073321c6258b7f825711b4973a2549cdce", "filename": "crates/hir/src/code_model.rs", "status": "modified", "additions": 2, "deletions": 121, "changes": 123, "blob_url": "https://github.com/rust-lang/rust/blob/8a845eda7bfd24aa4d85f1656bd053db05446a3e/crates%2Fhir%2Fsrc%2Fcode_model.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8a845eda7bfd24aa4d85f1656bd053db05446a3e/crates%2Fhir%2Fsrc%2Fcode_model.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir%2Fsrc%2Fcode_model.rs?ref=8a845eda7bfd24aa4d85f1656bd053db05446a3e", "patch": "@@ -9,7 +9,6 @@ use hir_def::{\n     adt::StructKind,\n     adt::VariantData,\n     builtin_type::BuiltinType,\n-    docs::Documentation,\n     expr::{BindingAnnotation, Pat, PatId},\n     import_map,\n     lang_item::LangItemTarget,\n@@ -20,7 +19,7 @@ use hir_def::{\n     type_ref::{Mutability, TypeRef},\n     AdtId, AssocContainerId, ConstId, DefWithBodyId, EnumId, FunctionId, GenericDefId, HasModule,\n     ImplId, LocalEnumVariantId, LocalFieldId, LocalModuleId, Lookup, ModuleId, StaticId, StructId,\n-    TraitId, TypeAliasId, TypeParamId, UnionId, VariantId,\n+    TraitId, TypeAliasId, TypeParamId, UnionId,\n };\n use hir_expand::{\n     diagnostics::DiagnosticSink,\n@@ -43,9 +42,8 @@ use tt::{Ident, Leaf, Literal, TokenTree};\n \n use crate::{\n     db::{DefDatabase, HirDatabase},\n-    doc_links::Resolvable,\n     has_source::HasSource,\n-    HirDisplay, InFile, Name,\n+    AttrDef, HirDisplay, InFile, Name,\n };\n \n /// hir::Crate describes a single crate. It's the main interface with which\n@@ -1741,127 +1739,10 @@ impl ScopeDef {\n     }\n }\n \n-#[derive(Clone, Copy, Debug, PartialEq, Eq, Hash)]\n-pub enum AttrDef {\n-    Module(Module),\n-    Field(Field),\n-    Adt(Adt),\n-    Function(Function),\n-    EnumVariant(EnumVariant),\n-    Static(Static),\n-    Const(Const),\n-    Trait(Trait),\n-    TypeAlias(TypeAlias),\n-    MacroDef(MacroDef),\n-}\n-\n-impl_from!(\n-    Module,\n-    Field,\n-    Adt(Struct, Enum, Union),\n-    EnumVariant,\n-    Static,\n-    Const,\n-    Function,\n-    Trait,\n-    TypeAlias,\n-    MacroDef\n-    for AttrDef\n-);\n-\n-pub trait HasAttrs {\n-    fn attrs(self, db: &dyn HirDatabase) -> Attrs;\n-    fn docs(self, db: &dyn HirDatabase) -> Option<Documentation>;\n-}\n-\n-impl<T: Into<AttrDef>> HasAttrs for T {\n-    fn attrs(self, db: &dyn HirDatabase) -> Attrs {\n-        let def: AttrDef = self.into();\n-        db.attrs(def.into())\n-    }\n-    fn docs(self, db: &dyn HirDatabase) -> Option<Documentation> {\n-        let def: AttrDef = self.into();\n-        db.documentation(def.into())\n-    }\n-}\n-\n pub trait HasVisibility {\n     fn visibility(&self, db: &dyn HirDatabase) -> Visibility;\n     fn is_visible_from(&self, db: &dyn HirDatabase, module: Module) -> bool {\n         let vis = self.visibility(db);\n         vis.is_visible_from(db.upcast(), module.id)\n     }\n }\n-\n-impl Resolvable for ModuleDef {\n-    fn resolver<D: DefDatabase + HirDatabase>(&self, db: &D) -> Option<Resolver> {\n-        Some(match self {\n-            ModuleDef::Module(m) => ModuleId::from(m.clone()).resolver(db),\n-            ModuleDef::Function(f) => FunctionId::from(f.clone()).resolver(db),\n-            ModuleDef::Adt(adt) => AdtId::from(adt.clone()).resolver(db),\n-            ModuleDef::EnumVariant(ev) => {\n-                GenericDefId::from(GenericDef::from(ev.clone())).resolver(db)\n-            }\n-            ModuleDef::Const(c) => GenericDefId::from(GenericDef::from(c.clone())).resolver(db),\n-            ModuleDef::Static(s) => StaticId::from(s.clone()).resolver(db),\n-            ModuleDef::Trait(t) => TraitId::from(t.clone()).resolver(db),\n-            ModuleDef::TypeAlias(t) => ModuleId::from(t.module(db)).resolver(db),\n-            // FIXME: This should be a resolver relative to `std/core`\n-            ModuleDef::BuiltinType(_t) => None?,\n-        })\n-    }\n-\n-    fn try_into_module_def(self) -> Option<ModuleDef> {\n-        Some(self)\n-    }\n-}\n-\n-impl Resolvable for TypeParam {\n-    fn resolver<D: DefDatabase + HirDatabase>(&self, db: &D) -> Option<Resolver> {\n-        Some(Into::<ModuleId>::into(self.module(db)).resolver(db))\n-    }\n-\n-    fn try_into_module_def(self) -> Option<ModuleDef> {\n-        None\n-    }\n-}\n-\n-impl Resolvable for MacroDef {\n-    fn resolver<D: DefDatabase + HirDatabase>(&self, db: &D) -> Option<Resolver> {\n-        Some(Into::<ModuleId>::into(self.module(db)?).resolver(db))\n-    }\n-\n-    fn try_into_module_def(self) -> Option<ModuleDef> {\n-        None\n-    }\n-}\n-\n-impl Resolvable for Field {\n-    fn resolver<D: DefDatabase + HirDatabase>(&self, db: &D) -> Option<Resolver> {\n-        Some(Into::<VariantId>::into(Into::<VariantDef>::into(self.parent_def(db))).resolver(db))\n-    }\n-\n-    fn try_into_module_def(self) -> Option<ModuleDef> {\n-        None\n-    }\n-}\n-\n-impl Resolvable for ImplDef {\n-    fn resolver<D: DefDatabase + HirDatabase>(&self, db: &D) -> Option<Resolver> {\n-        Some(Into::<ModuleId>::into(self.module(db)).resolver(db))\n-    }\n-\n-    fn try_into_module_def(self) -> Option<ModuleDef> {\n-        None\n-    }\n-}\n-\n-impl Resolvable for Local {\n-    fn resolver<D: DefDatabase + HirDatabase>(&self, db: &D) -> Option<Resolver> {\n-        Some(Into::<ModuleId>::into(self.module(db)).resolver(db))\n-    }\n-\n-    fn try_into_module_def(self) -> Option<ModuleDef> {\n-        None\n-    }\n-}"}, {"sha": "d1c198bffe6abd9eafec613024085f3b54dd9190", "filename": "crates/hir/src/lib.rs", "status": "modified", "additions": 6, "deletions": 5, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/8a845eda7bfd24aa4d85f1656bd053db05446a3e/crates%2Fhir%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8a845eda7bfd24aa4d85f1656bd053db05446a3e/crates%2Fhir%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir%2Fsrc%2Flib.rs?ref=8a845eda7bfd24aa4d85f1656bd053db05446a3e", "patch": "@@ -28,15 +28,16 @@ pub mod diagnostics;\n mod from_id;\n mod code_model;\n mod doc_links;\n-\n+mod attrs;\n mod has_source;\n \n pub use crate::{\n+    attrs::{AttrDef, HasAttrs},\n     code_model::{\n-        Access, Adt, AsAssocItem, AssocItem, AssocItemContainer, AttrDef, Callable, CallableKind,\n-        Const, Crate, CrateDependency, DefWithBody, Enum, EnumVariant, Field, FieldSource,\n-        Function, GenericDef, HasAttrs, HasVisibility, ImplDef, Local, MacroDef, Module, ModuleDef,\n-        ScopeDef, Static, Struct, Trait, Type, TypeAlias, TypeParam, Union, VariantDef, Visibility,\n+        Access, Adt, AsAssocItem, AssocItem, AssocItemContainer, Callable, CallableKind, Const,\n+        Crate, CrateDependency, DefWithBody, Enum, EnumVariant, Field, FieldSource, Function,\n+        GenericDef, HasVisibility, ImplDef, Local, MacroDef, Module, ModuleDef, ScopeDef, Static,\n+        Struct, Trait, Type, TypeAlias, TypeParam, Union, VariantDef, Visibility,\n     },\n     doc_links::resolve_doc_link,\n     has_source::HasSource,"}]}