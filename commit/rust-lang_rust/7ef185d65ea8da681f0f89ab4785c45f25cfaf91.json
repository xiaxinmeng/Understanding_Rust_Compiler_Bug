{"sha": "7ef185d65ea8da681f0f89ab4785c45f25cfaf91", "node_id": "C_kwDOAAsO6NoAKDdlZjE4NWQ2NWVhOGRhNjgxZjBmODlhYjQ3ODVjNDVmMjVjZmFmOTE", "commit": {"author": {"name": "hkalbasi", "email": "hamidrezakalbasi@protonmail.com", "date": "2023-05-25T16:07:04Z"}, "committer": {"name": "hkalbasi", "email": "hamidrezakalbasi@protonmail.com", "date": "2023-05-25T16:07:20Z"}, "message": "evaluate `UnevaluatedConst` in unify", "tree": {"sha": "5cddf702253015b6af603e5546efa96ac4a0f93a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5cddf702253015b6af603e5546efa96ac4a0f93a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7ef185d65ea8da681f0f89ab4785c45f25cfaf91", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7ef185d65ea8da681f0f89ab4785c45f25cfaf91", "html_url": "https://github.com/rust-lang/rust/commit/7ef185d65ea8da681f0f89ab4785c45f25cfaf91", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7ef185d65ea8da681f0f89ab4785c45f25cfaf91/comments", "author": {"login": "HKalbasi", "id": 45197576, "node_id": "MDQ6VXNlcjQ1MTk3NTc2", "avatar_url": "https://avatars.githubusercontent.com/u/45197576?v=4", "gravatar_id": "", "url": "https://api.github.com/users/HKalbasi", "html_url": "https://github.com/HKalbasi", "followers_url": "https://api.github.com/users/HKalbasi/followers", "following_url": "https://api.github.com/users/HKalbasi/following{/other_user}", "gists_url": "https://api.github.com/users/HKalbasi/gists{/gist_id}", "starred_url": "https://api.github.com/users/HKalbasi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/HKalbasi/subscriptions", "organizations_url": "https://api.github.com/users/HKalbasi/orgs", "repos_url": "https://api.github.com/users/HKalbasi/repos", "events_url": "https://api.github.com/users/HKalbasi/events{/privacy}", "received_events_url": "https://api.github.com/users/HKalbasi/received_events", "type": "User", "site_admin": false}, "committer": {"login": "HKalbasi", "id": 45197576, "node_id": "MDQ6VXNlcjQ1MTk3NTc2", "avatar_url": "https://avatars.githubusercontent.com/u/45197576?v=4", "gravatar_id": "", "url": "https://api.github.com/users/HKalbasi", "html_url": "https://github.com/HKalbasi", "followers_url": "https://api.github.com/users/HKalbasi/followers", "following_url": "https://api.github.com/users/HKalbasi/following{/other_user}", "gists_url": "https://api.github.com/users/HKalbasi/gists{/gist_id}", "starred_url": "https://api.github.com/users/HKalbasi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/HKalbasi/subscriptions", "organizations_url": "https://api.github.com/users/HKalbasi/orgs", "repos_url": "https://api.github.com/users/HKalbasi/repos", "events_url": "https://api.github.com/users/HKalbasi/events{/privacy}", "received_events_url": "https://api.github.com/users/HKalbasi/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "efd3094aba281de248f48e67b5b93bf2c557e16c", "url": "https://api.github.com/repos/rust-lang/rust/commits/efd3094aba281de248f48e67b5b93bf2c557e16c", "html_url": "https://github.com/rust-lang/rust/commit/efd3094aba281de248f48e67b5b93bf2c557e16c"}], "stats": {"total": 90, "additions": 89, "deletions": 1}, "files": [{"sha": "7772fab796cc29ecb2aae396e57ff830f187f8a7", "filename": "crates/hir-ty/src/infer/expr.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/7ef185d65ea8da681f0f89ab4785c45f25cfaf91/crates%2Fhir-ty%2Fsrc%2Finfer%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7ef185d65ea8da681f0f89ab4785c45f25cfaf91/crates%2Fhir-ty%2Fsrc%2Finfer%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-ty%2Fsrc%2Finfer%2Fexpr.rs?ref=7ef185d65ea8da681f0f89ab4785c45f25cfaf91", "patch": "@@ -575,6 +575,9 @@ impl<'a> InferenceContext<'a> {\n                     let field_ty = field_def.map_or(self.err_ty(), |it| {\n                         field_types[it.local_id].clone().substitute(Interner, &substs)\n                     });\n+                    // Field type might have some unknown types\n+                    // FIXME: we may want to emit a single type variable for all instance of type fields?\n+                    let field_ty = self.insert_type_vars(field_ty);\n                     self.infer_expr_coerce(field.expr, &Expectation::has_type(field_ty));\n                 }\n                 if let Some(expr) = spread {"}, {"sha": "38eae475b556fd95671d99299e512f0332dc52c3", "filename": "crates/hir-ty/src/infer/unify.rs", "status": "modified", "additions": 9, "deletions": 1, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/7ef185d65ea8da681f0f89ab4785c45f25cfaf91/crates%2Fhir-ty%2Fsrc%2Finfer%2Funify.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7ef185d65ea8da681f0f89ab4785c45f25cfaf91/crates%2Fhir-ty%2Fsrc%2Finfer%2Funify.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-ty%2Fsrc%2Finfer%2Funify.rs?ref=7ef185d65ea8da681f0f89ab4785c45f25cfaf91", "patch": "@@ -781,8 +781,16 @@ impl<'a> InferenceTable<'a> {\n     pub(super) fn insert_const_vars_shallow(&mut self, c: Const) -> Const {\n         let data = c.data(Interner);\n         match &data.value {\n-            ConstValue::Concrete(cc) => match cc.interned {\n+            ConstValue::Concrete(cc) => match &cc.interned {\n                 crate::ConstScalar::Unknown => self.new_const_var(data.ty.clone()),\n+                // try to evaluate unevaluated const. Replace with new var if const eval failed.\n+                crate::ConstScalar::UnevaluatedConst(id, subst) => {\n+                    if let Ok(eval) = self.db.const_eval(*id, subst.clone()) {\n+                        eval\n+                    } else {\n+                        self.new_const_var(data.ty.clone())\n+                    }\n+                }\n                 _ => c,\n             },\n             _ => c,"}, {"sha": "259f43e7e201ea7234996507ab5c2b5824ba8346", "filename": "crates/hir-ty/src/tests/regression.rs", "status": "modified", "additions": 55, "deletions": 0, "changes": 55, "blob_url": "https://github.com/rust-lang/rust/blob/7ef185d65ea8da681f0f89ab4785c45f25cfaf91/crates%2Fhir-ty%2Fsrc%2Ftests%2Fregression.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7ef185d65ea8da681f0f89ab4785c45f25cfaf91/crates%2Fhir-ty%2Fsrc%2Ftests%2Fregression.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-ty%2Fsrc%2Ftests%2Fregression.rs?ref=7ef185d65ea8da681f0f89ab4785c45f25cfaf91", "patch": "@@ -1837,3 +1837,58 @@ fn foo() {\n }\",\n     );\n }\n+\n+#[test]\n+fn regression_14844() {\n+    check_no_mismatches(\n+        r#\"\n+pub type Ty = Unknown;\n+\n+pub struct Inner<T>();\n+\n+pub struct Outer {\n+    pub inner: Inner<Ty>,\n+}\n+\n+fn main() {\n+    _ = Outer {\n+        inner: Inner::<i32>(),\n+    };\n+}\n+        \"#,\n+    );\n+    check_no_mismatches(\n+        r#\"\n+pub const ONE: usize = 1;\n+\n+pub struct Inner<const P: usize>();\n+\n+pub struct Outer {\n+    pub inner: Inner<ONE>,\n+}\n+\n+fn main() {\n+    _ = Outer {\n+        inner: Inner::<1>(),\n+    };\n+}\n+        \"#,\n+    );\n+    check_no_mismatches(\n+        r#\"\n+pub const ONE: usize = unknown();\n+\n+pub struct Inner<const P: usize>();\n+\n+pub struct Outer {\n+    pub inner: Inner<ONE>,\n+}\n+\n+fn main() {\n+    _ = Outer {\n+        inner: Inner::<1>(),\n+    };\n+}\n+        \"#,\n+    );\n+}"}, {"sha": "cc282bf9348127b7a5383ae4d2137056beb538e4", "filename": "crates/ide-diagnostics/src/handlers/type_mismatch.rs", "status": "modified", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/7ef185d65ea8da681f0f89ab4785c45f25cfaf91/crates%2Fide-diagnostics%2Fsrc%2Fhandlers%2Ftype_mismatch.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7ef185d65ea8da681f0f89ab4785c45f25cfaf91/crates%2Fide-diagnostics%2Fsrc%2Fhandlers%2Ftype_mismatch.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-diagnostics%2Fsrc%2Fhandlers%2Ftype_mismatch.rs?ref=7ef185d65ea8da681f0f89ab4785c45f25cfaf91", "patch": "@@ -644,6 +644,28 @@ fn h() {\n         );\n     }\n \n+    #[test]\n+    fn evaluate_const_generics_in_types() {\n+        check_diagnostics(\n+            r#\"\n+pub const ONE: usize = 1;\n+\n+pub struct Inner<const P: usize>();\n+\n+pub struct Outer {\n+    pub inner: Inner<ONE>,\n+}\n+\n+fn main() {\n+    _ = Outer {\n+        inner: Inner::<2>(),\n+             //^^^^^^^^^^^^ error: expected Inner<1>, found Inner<2>\n+    };\n+}\n+\"#,\n+        );\n+    }\n+\n     #[test]\n     fn type_mismatch_pat_smoke_test() {\n         check_diagnostics("}]}