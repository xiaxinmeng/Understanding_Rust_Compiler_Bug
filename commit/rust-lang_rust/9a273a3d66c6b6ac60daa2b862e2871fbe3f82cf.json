{"sha": "9a273a3d66c6b6ac60daa2b862e2871fbe3f82cf", "node_id": "MDY6Q29tbWl0NzI0NzEyOjlhMjczYTNkNjZjNmI2YWM2MGRhYTJiODYyZTI4NzFmYmUzZjgyY2Y=", "commit": {"author": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2018-07-20T18:59:05Z"}, "committer": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2018-07-20T20:08:06Z"}, "message": "Rollup merge of #52505 - alexcrichton:remove-thinlto-hack, r=nikomatsakis\n\nrustc: Remove a workaround in ThinLTO fixed upstream\n\nThis commit removes a hack in our ThinLTO passes which removes available\nexternally functions manually. The [upstream bug][1] has long since been fixed,\nso we should be able to rely on LLVM natively for this now!\n\n[1]: https://bugs.llvm.org/show_bug.cgi?id=35736", "tree": {"sha": "c30c956a1c05597f1cd4d7a5459a32de160ffe69", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c30c956a1c05597f1cd4d7a5459a32de160ffe69"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9a273a3d66c6b6ac60daa2b862e2871fbe3f82cf", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEZ1R8CLMp8f2GxWoQ/vbIBR0OATwFAltSQSYACgkQ/vbIBR0O\nATzWlw/+K/KOlbbmtlz1WPTZ2xuBP4KuyAkxqaRdu2/+QJA++w6/DCIyiiGnTP+D\nCfoboR4RiwhS/hNvLdlhUl/i9nP7qtcpXWY0z6Kkp/Q2hOm9ulHd2BI2wz3EWj05\naYSbGR7v3qdbVw+UUss/VpxZAmFr1VUp/Wslj1JSJ8hzBaEsxND4grcIgp7X+5MR\n9ARssDJLjrRzzF/vRhrDTgFhfZY/QxIU/by6hp8BuesuRRVg3ljThxCMk1lcc8NI\neygfHaDfEOB2tSvIwvf3FViLkc1Rqcceu/z6cl3K6oejUnh6Ompkdzlq49Y/RVMz\nTua4mW+nqLQh5M+rylA8jSp6lx6Tyfs0aTnI1lcHuJTp2Ltd6iALxLYMYo8xKr55\nmIf/aSJKDQ1dv5C2Mp4p+HNIcBQQX9N+vJRcC6VTilrzGfHNzjDbXALpTMA78OnU\nSevqTgdzZO5UUTwg2+22kzkSCVjb/P19IrZvZN4/CjKRELBalqSSvnUcz2EGh7KV\nRAAzw0CHdJWCaAc3k831p/cinpXHaJ/oxqHer7OtfgNtaPAuQCLiei/T+DkkBFM5\nXiVtR6XhxQYgLlBzi1ecQQilcebARlW1h7HRH1JC8Kr1JgsP2Vx8eo8Ug8vpb0tj\ntQuT2wzazcgobuPz/ThmmmSBG0T7rFgcNeOclEgosVPUyNkQOAc=\n=kcNW\n-----END PGP SIGNATURE-----", "payload": "tree c30c956a1c05597f1cd4d7a5459a32de160ffe69\nparent c74ff6cbd45ee79d623a6e1ad936d851c34fffc8\nparent 829bc268a9e3ef4d0f8ec4f6a2fadd604bdc7b8d\nauthor kennytm <kennytm@gmail.com> 1532113145 +0800\ncommitter kennytm <kennytm@gmail.com> 1532117286 +0800\n\nRollup merge of #52505 - alexcrichton:remove-thinlto-hack, r=nikomatsakis\n\nrustc: Remove a workaround in ThinLTO fixed upstream\n\nThis commit removes a hack in our ThinLTO passes which removes available\nexternally functions manually. The [upstream bug][1] has long since been fixed,\nso we should be able to rely on LLVM natively for this now!\n\n[1]: https://bugs.llvm.org/show_bug.cgi?id=35736\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9a273a3d66c6b6ac60daa2b862e2871fbe3f82cf", "html_url": "https://github.com/rust-lang/rust/commit/9a273a3d66c6b6ac60daa2b862e2871fbe3f82cf", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9a273a3d66c6b6ac60daa2b862e2871fbe3f82cf/comments", "author": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c74ff6cbd45ee79d623a6e1ad936d851c34fffc8", "url": "https://api.github.com/repos/rust-lang/rust/commits/c74ff6cbd45ee79d623a6e1ad936d851c34fffc8", "html_url": "https://github.com/rust-lang/rust/commit/c74ff6cbd45ee79d623a6e1ad936d851c34fffc8"}, {"sha": "829bc268a9e3ef4d0f8ec4f6a2fadd604bdc7b8d", "url": "https://api.github.com/repos/rust-lang/rust/commits/829bc268a9e3ef4d0f8ec4f6a2fadd604bdc7b8d", "html_url": "https://github.com/rust-lang/rust/commit/829bc268a9e3ef4d0f8ec4f6a2fadd604bdc7b8d"}], "stats": {"total": 29, "additions": 0, "deletions": 29}, "files": [{"sha": "60b5cf2ec765134f4d95ca629e34a574acf825d1", "filename": "src/librustc_codegen_llvm/back/lto.rs", "status": "modified", "additions": 0, "deletions": 14, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/9a273a3d66c6b6ac60daa2b862e2871fbe3f82cf/src%2Flibrustc_codegen_llvm%2Fback%2Flto.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9a273a3d66c6b6ac60daa2b862e2871fbe3f82cf/src%2Flibrustc_codegen_llvm%2Fback%2Flto.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fback%2Flto.rs?ref=9a273a3d66c6b6ac60daa2b862e2871fbe3f82cf", "patch": "@@ -759,20 +759,6 @@ impl ThinModule {\n         cgcx.save_temp_bitcode(&module, \"thin-lto-after-pm\");\n         timeline.record(\"thin-done\");\n \n-        // FIXME: this is a hack around a bug in LLVM right now. Discovered in\n-        // #46910 it was found out that on 32-bit MSVC LLVM will hit a codegen\n-        // error if there's an available_externally function in the LLVM module.\n-        // Typically we don't actually use these functions but ThinLTO makes\n-        // heavy use of them when inlining across modules.\n-        //\n-        // Tracked upstream at https://bugs.llvm.org/show_bug.cgi?id=35736 this\n-        // function call (and its definition on the C++ side of things)\n-        // shouldn't be necessary eventually and we can safetly delete these few\n-        // lines.\n-        llvm::LLVMRustThinLTORemoveAvailableExternally(llmod);\n-        cgcx.save_temp_bitcode(&module, \"thin-lto-after-rm-ae\");\n-        timeline.record(\"no-ae\");\n-\n         Ok(module)\n     }\n }"}, {"sha": "8d04438eea29000edf06fbeb0b26af50010d19e2", "filename": "src/librustc_llvm/ffi.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/9a273a3d66c6b6ac60daa2b862e2871fbe3f82cf/src%2Flibrustc_llvm%2Fffi.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9a273a3d66c6b6ac60daa2b862e2871fbe3f82cf/src%2Flibrustc_llvm%2Fffi.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_llvm%2Fffi.rs?ref=9a273a3d66c6b6ac60daa2b862e2871fbe3f82cf", "patch": "@@ -1791,7 +1791,6 @@ extern \"C\" {\n                                            CU1: *mut *mut c_void,\n                                            CU2: *mut *mut c_void);\n     pub fn LLVMRustThinLTOPatchDICompileUnit(M: ModuleRef, CU: *mut c_void);\n-    pub fn LLVMRustThinLTORemoveAvailableExternally(M: ModuleRef);\n \n     pub fn LLVMRustLinkerNew(M: ModuleRef) -> LinkerRef;\n     pub fn LLVMRustLinkerAdd(linker: LinkerRef,"}, {"sha": "2f28c5b32fb88de32c0e490a1df7301dc55a5dcc", "filename": "src/rustllvm/PassWrapper.cpp", "status": "modified", "additions": 0, "deletions": 14, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/9a273a3d66c6b6ac60daa2b862e2871fbe3f82cf/src%2Frustllvm%2FPassWrapper.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/9a273a3d66c6b6ac60daa2b862e2871fbe3f82cf/src%2Frustllvm%2FPassWrapper.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustllvm%2FPassWrapper.cpp?ref=9a273a3d66c6b6ac60daa2b862e2871fbe3f82cf", "patch": "@@ -1228,15 +1228,6 @@ LLVMRustThinLTOPatchDICompileUnit(LLVMModuleRef Mod, DICompileUnit *Unit) {\n   MD->addOperand(Unit);\n }\n \n-extern \"C\" void\n-LLVMRustThinLTORemoveAvailableExternally(LLVMModuleRef Mod) {\n-  Module *M = unwrap(Mod);\n-  for (Function &F : M->functions()) {\n-    if (F.hasAvailableExternallyLinkage())\n-      F.deleteBody();\n-  }\n-}\n-\n #else\n \n extern \"C\" bool\n@@ -1328,9 +1319,4 @@ LLVMRustThinLTOPatchDICompileUnit(LLVMModuleRef Mod) {\n   report_fatal_error(\"ThinLTO not available\");\n }\n \n-extern \"C\" void\n-LLVMRustThinLTORemoveAvailableExternally(LLVMModuleRef Mod) {\n-  report_fatal_error(\"ThinLTO not available\");\n-}\n-\n #endif // LLVM_VERSION_GE(4, 0)"}]}