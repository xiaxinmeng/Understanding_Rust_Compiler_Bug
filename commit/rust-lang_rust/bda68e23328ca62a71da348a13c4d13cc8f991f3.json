{"sha": "bda68e23328ca62a71da348a13c4d13cc8f991f3", "node_id": "MDY6Q29tbWl0NzI0NzEyOmJkYTY4ZTIzMzI4Y2E2MmE3MWRhMzQ4YTEzYzRkMTNjYzhmOTkxZjM=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-05-11T22:27:16Z"}, "committer": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-05-11T22:27:16Z"}, "message": "Strip delimiter from fn-like proc macro input", "tree": {"sha": "ee4d8eb1b2ac748fe40dfcbc6c991b20c44191de", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ee4d8eb1b2ac748fe40dfcbc6c991b20c44191de"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bda68e23328ca62a71da348a13c4d13cc8f991f3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bda68e23328ca62a71da348a13c4d13cc8f991f3", "html_url": "https://github.com/rust-lang/rust/commit/bda68e23328ca62a71da348a13c4d13cc8f991f3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bda68e23328ca62a71da348a13c4d13cc8f991f3/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a328a6bc75e3832930bd22fb644a994dcd3d93ff", "url": "https://api.github.com/repos/rust-lang/rust/commits/a328a6bc75e3832930bd22fb644a994dcd3d93ff", "html_url": "https://github.com/rust-lang/rust/commit/a328a6bc75e3832930bd22fb644a994dcd3d93ff"}], "stats": {"total": 35, "additions": 33, "deletions": 2}, "files": [{"sha": "860aa049ba0b531858ae7c4d8b4ada07be2fedcd", "filename": "crates/hir_expand/src/input.rs", "status": "modified", "additions": 29, "deletions": 2, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/bda68e23328ca62a71da348a13c4d13cc8f991f3/crates%2Fhir_expand%2Fsrc%2Finput.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bda68e23328ca62a71da348a13c4d13cc8f991f3/crates%2Fhir_expand%2Fsrc%2Finput.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_expand%2Fsrc%2Finput.rs?ref=bda68e23328ca62a71da348a13c4d13cc8f991f3", "patch": "@@ -1,8 +1,9 @@\n //! Macro input conditioning.\n \n+use parser::SyntaxKind;\n use syntax::{\n     ast::{self, AttrsOwner},\n-    AstNode, SyntaxNode,\n+    AstNode, SyntaxElement, SyntaxNode,\n };\n \n use crate::{\n@@ -19,7 +20,33 @@ pub(crate) fn process_macro_input(\n     let loc: MacroCallLoc = db.lookup_intern_macro(id);\n \n     match loc.kind {\n-        MacroCallKind::FnLike { .. } => node,\n+        MacroCallKind::FnLike { .. } => {\n+            if !loc.def.is_proc_macro() {\n+                // MBE macros expect the parentheses as part of their input.\n+                return node;\n+            }\n+\n+            // The input includes the `(` + `)` delimiter tokens, so remove them before passing this\n+            // to the macro.\n+            let node = node.clone_for_update();\n+            if let Some(SyntaxElement::Token(tkn)) = node.first_child_or_token() {\n+                if matches!(\n+                    tkn.kind(),\n+                    SyntaxKind::L_BRACK | SyntaxKind::L_PAREN | SyntaxKind::L_CURLY\n+                ) {\n+                    tkn.detach();\n+                }\n+            }\n+            if let Some(SyntaxElement::Token(tkn)) = node.last_child_or_token() {\n+                if matches!(\n+                    tkn.kind(),\n+                    SyntaxKind::R_BRACK | SyntaxKind::R_PAREN | SyntaxKind::R_CURLY\n+                ) {\n+                    tkn.detach();\n+                }\n+            }\n+            node\n+        }\n         MacroCallKind::Derive { derive_attr_index, .. } => {\n             let item = match ast::Item::cast(node.clone()) {\n                 Some(item) => item,"}, {"sha": "88cb16ca4d13fe36a4a4e211e1f5d77b86b59d09", "filename": "crates/hir_expand/src/lib.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/bda68e23328ca62a71da348a13c4d13cc8f991f3/crates%2Fhir_expand%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bda68e23328ca62a71da348a13c4d13cc8f991f3/crates%2Fhir_expand%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_expand%2Fsrc%2Flib.rs?ref=bda68e23328ca62a71da348a13c4d13cc8f991f3", "patch": "@@ -272,6 +272,10 @@ impl MacroDefId {\n         };\n         Either::Left(*id)\n     }\n+\n+    pub fn is_proc_macro(&self) -> bool {\n+        matches!(self.kind, MacroDefKind::ProcMacro(..))\n+    }\n }\n \n #[derive(Debug, Clone, Copy, PartialEq, Eq, Hash)]"}]}