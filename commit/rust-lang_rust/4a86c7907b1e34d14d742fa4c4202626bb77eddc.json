{"sha": "4a86c7907b1e34d14d742fa4c4202626bb77eddc", "node_id": "C_kwDOAAsO6NoAKDRhODZjNzkwN2IxZTM0ZDE0ZDc0MmZhNGM0MjAyNjI2YmI3N2VkZGM", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-05-21T01:56:51Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-05-21T01:56:51Z"}, "message": "Auto merge of #96605 - Urgau:string-retain-codegen, r=thomcc\n\nImprove codegen of String::retain method\n\nThis pull-request improve the codegen of the `String::retain` method.\n\nUsing `unwrap_unchecked` helps the optimizer to not generate a panicking path that will never be taken for valid UTF-8 like string.\n\nUsing `encode_utf8` saves us from an expensive call to `memcpy`, as the optimizer is unable to realize that `ch_len <= 4` and so can generate much better assembly code.\n\nhttps://rust.godbolt.org/z/z73ohenfc", "tree": {"sha": "ca6b724e0a8e3855c2168c58b4ad9796d7d59951", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ca6b724e0a8e3855c2168c58b4ad9796d7d59951"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4a86c7907b1e34d14d742fa4c4202626bb77eddc", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4a86c7907b1e34d14d742fa4c4202626bb77eddc", "html_url": "https://github.com/rust-lang/rust/commit/4a86c7907b1e34d14d742fa4c4202626bb77eddc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4a86c7907b1e34d14d742fa4c4202626bb77eddc/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e57884b6e96bede12447e21edcdc92fcac59ee46", "url": "https://api.github.com/repos/rust-lang/rust/commits/e57884b6e96bede12447e21edcdc92fcac59ee46", "html_url": "https://github.com/rust-lang/rust/commit/e57884b6e96bede12447e21edcdc92fcac59ee46"}, {"sha": "a98abe83eb42b2f537e8a2d7706ba08d9e296f31", "url": "https://api.github.com/repos/rust-lang/rust/commits/a98abe83eb42b2f537e8a2d7706ba08d9e296f31", "html_url": "https://github.com/rust-lang/rust/commit/a98abe83eb42b2f537e8a2d7706ba08d9e296f31"}], "stats": {"total": 25, "additions": 17, "deletions": 8}, "files": [{"sha": "668af60611b8606f8d306ed6b87890dd4cb54100", "filename": "library/alloc/src/string.rs", "status": "modified", "additions": 17, "deletions": 8, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/4a86c7907b1e34d14d742fa4c4202626bb77eddc/library%2Falloc%2Fsrc%2Fstring.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4a86c7907b1e34d14d742fa4c4202626bb77eddc/library%2Falloc%2Fsrc%2Fstring.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Falloc%2Fsrc%2Fstring.rs?ref=4a86c7907b1e34d14d742fa4c4202626bb77eddc", "patch": "@@ -1469,19 +1469,28 @@ impl String {\n         let mut guard = SetLenOnDrop { s: self, idx: 0, del_bytes: 0 };\n \n         while guard.idx < len {\n-            let ch = unsafe { guard.s.get_unchecked(guard.idx..len).chars().next().unwrap() };\n+            let ch =\n+                // SAFETY: `guard.idx` is positive-or-zero and less that len so the `get_unchecked`\n+                // is in bound. `self` is valid UTF-8 like string and the returned slice starts at\n+                // a unicode code point so the `Chars` always return one character.\n+                unsafe { guard.s.get_unchecked(guard.idx..len).chars().next().unwrap_unchecked() };\n             let ch_len = ch.len_utf8();\n \n             if !f(ch) {\n                 guard.del_bytes += ch_len;\n             } else if guard.del_bytes > 0 {\n-                unsafe {\n-                    ptr::copy(\n-                        guard.s.vec.as_ptr().add(guard.idx),\n-                        guard.s.vec.as_mut_ptr().add(guard.idx - guard.del_bytes),\n-                        ch_len,\n-                    );\n-                }\n+                // SAFETY: `guard.idx` is in bound and `guard.del_bytes` represent the number of\n+                // bytes that are erased from the string so the resulting `guard.idx -\n+                // guard.del_bytes` always represent a valid unicode code point.\n+                //\n+                // `guard.del_bytes` >= `ch.len_utf8()`, so taking a slice with `ch.len_utf8()` len\n+                // is safe.\n+                ch.encode_utf8(unsafe {\n+                    crate::slice::from_raw_parts_mut(\n+                        guard.s.as_mut_ptr().add(guard.idx - guard.del_bytes),\n+                        ch.len_utf8(),\n+                    )\n+                });\n             }\n \n             // Point idx to the next char"}]}