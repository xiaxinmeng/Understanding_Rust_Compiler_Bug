{"sha": "d7e6649326080219fbdad6465468086e46e69377", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQ3ZTY2NDkzMjYwODAyMTlmYmRhZDY0NjU0NjgwODZlNDZlNjkzNzc=", "commit": {"author": {"name": "Dylan MacKenzie", "email": "ecstaticmorse@gmail.com", "date": "2020-03-14T22:59:10Z"}, "committer": {"name": "Dylan MacKenzie", "email": "ecstaticmorse@gmail.com", "date": "2020-03-14T23:04:42Z"}, "message": "Return feature gate as a `Symbol`", "tree": {"sha": "3084430e33679757f4b9154dbfb943c06a246d11", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3084430e33679757f4b9154dbfb943c06a246d11"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d7e6649326080219fbdad6465468086e46e69377", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d7e6649326080219fbdad6465468086e46e69377", "html_url": "https://github.com/rust-lang/rust/commit/d7e6649326080219fbdad6465468086e46e69377", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d7e6649326080219fbdad6465468086e46e69377/comments", "author": {"login": "ecstatic-morse", "id": 29463364, "node_id": "MDQ6VXNlcjI5NDYzMzY0", "avatar_url": "https://avatars.githubusercontent.com/u/29463364?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ecstatic-morse", "html_url": "https://github.com/ecstatic-morse", "followers_url": "https://api.github.com/users/ecstatic-morse/followers", "following_url": "https://api.github.com/users/ecstatic-morse/following{/other_user}", "gists_url": "https://api.github.com/users/ecstatic-morse/gists{/gist_id}", "starred_url": "https://api.github.com/users/ecstatic-morse/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ecstatic-morse/subscriptions", "organizations_url": "https://api.github.com/users/ecstatic-morse/orgs", "repos_url": "https://api.github.com/users/ecstatic-morse/repos", "events_url": "https://api.github.com/users/ecstatic-morse/events{/privacy}", "received_events_url": "https://api.github.com/users/ecstatic-morse/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ecstatic-morse", "id": 29463364, "node_id": "MDQ6VXNlcjI5NDYzMzY0", "avatar_url": "https://avatars.githubusercontent.com/u/29463364?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ecstatic-morse", "html_url": "https://github.com/ecstatic-morse", "followers_url": "https://api.github.com/users/ecstatic-morse/followers", "following_url": "https://api.github.com/users/ecstatic-morse/following{/other_user}", "gists_url": "https://api.github.com/users/ecstatic-morse/gists{/gist_id}", "starred_url": "https://api.github.com/users/ecstatic-morse/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ecstatic-morse/subscriptions", "organizations_url": "https://api.github.com/users/ecstatic-morse/orgs", "repos_url": "https://api.github.com/users/ecstatic-morse/repos", "events_url": "https://api.github.com/users/ecstatic-morse/events{/privacy}", "received_events_url": "https://api.github.com/users/ecstatic-morse/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "131772c5e0ba40cd656dedb5e1990d36e3ea31cf", "url": "https://api.github.com/repos/rust-lang/rust/commits/131772c5e0ba40cd656dedb5e1990d36e3ea31cf", "html_url": "https://github.com/rust-lang/rust/commit/131772c5e0ba40cd656dedb5e1990d36e3ea31cf"}], "stats": {"total": 61, "additions": 32, "deletions": 29}, "files": [{"sha": "d06a2aa44f2316a2b0bbf5e363105281c7a185df", "filename": "src/librustc_mir/transform/check_consts/ops.rs", "status": "modified", "additions": 31, "deletions": 28, "changes": 59, "blob_url": "https://github.com/rust-lang/rust/blob/d7e6649326080219fbdad6465468086e46e69377/src%2Flibrustc_mir%2Ftransform%2Fcheck_consts%2Fops.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d7e6649326080219fbdad6465468086e46e69377/src%2Flibrustc_mir%2Ftransform%2Fcheck_consts%2Fops.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fcheck_consts%2Fops.rs?ref=d7e6649326080219fbdad6465468086e46e69377", "patch": "@@ -2,7 +2,6 @@\n \n use rustc::session::config::nightly_options;\n use rustc::session::parse::feature_err;\n-use rustc::ty::TyCtxt;\n use rustc_errors::struct_span_err;\n use rustc_hir::def_id::DefId;\n use rustc_span::symbol::sym;\n@@ -15,18 +14,21 @@ pub trait NonConstOp: std::fmt::Debug {\n     /// Whether this operation can be evaluated by miri.\n     const IS_SUPPORTED_IN_MIRI: bool = true;\n \n-    /// Returns a boolean indicating whether the feature gate that would allow this operation is\n-    /// enabled, or `None` if such a feature gate does not exist.\n-    fn feature_gate(_tcx: TyCtxt<'tcx>) -> Option<bool> {\n+    /// Returns the `Symbol` corresponding to the feature gate that would enable this operation,\n+    /// or `None` if such a feature gate does not exist.\n+    fn feature_gate() -> Option<Symbol> {\n         None\n     }\n \n     /// Returns `true` if this operation is allowed in the given item.\n     ///\n     /// This check should assume that we are not in a non-const `fn`, where all operations are\n     /// legal.\n+    ///\n+    /// By default, it returns `true` if and only if this operation has a corresponding feature\n+    /// gate and that gate is enabled.\n     fn is_allowed_in_item(&self, item: &Item<'_, '_>) -> bool {\n-        Self::feature_gate(item.tcx).unwrap_or(false)\n+        Self::feature_gate().map_or(false, |gate| item.tcx.features().enabled(gate))\n     }\n \n     fn emit_error(&self, item: &Item<'_, '_>, span: Span) {\n@@ -55,8 +57,8 @@ pub trait NonConstOp: std::fmt::Debug {\n #[derive(Debug)]\n pub struct Downcast;\n impl NonConstOp for Downcast {\n-    fn feature_gate(tcx: TyCtxt<'_>) -> Option<bool> {\n-        Some(tcx.features().const_if_match)\n+    fn feature_gate() -> Option<Symbol> {\n+        Some(sym::const_if_match)\n     }\n }\n \n@@ -147,8 +149,8 @@ impl NonConstOp for HeapAllocation {\n #[derive(Debug)]\n pub struct IfOrMatch;\n impl NonConstOp for IfOrMatch {\n-    fn feature_gate(tcx: TyCtxt<'_>) -> Option<bool> {\n-        Some(tcx.features().const_if_match)\n+    fn feature_gate() -> Option<Symbol> {\n+        Some(sym::const_if_match)\n     }\n \n     fn emit_error(&self, item: &Item<'_, '_>, span: Span) {\n@@ -175,8 +177,8 @@ impl NonConstOp for LiveDrop {\n #[derive(Debug)]\n pub struct Loop;\n impl NonConstOp for Loop {\n-    fn feature_gate(tcx: TyCtxt<'_>) -> Option<bool> {\n-        Some(tcx.features().const_loop)\n+    fn feature_gate() -> Option<Symbol> {\n+        Some(sym::const_loop)\n     }\n \n     fn emit_error(&self, item: &Item<'_, '_>, span: Span) {\n@@ -203,8 +205,8 @@ impl NonConstOp for CellBorrow {\n #[derive(Debug)]\n pub struct MutBorrow;\n impl NonConstOp for MutBorrow {\n-    fn feature_gate(tcx: TyCtxt<'_>) -> Option<bool> {\n-        Some(tcx.features().const_mut_refs)\n+    fn feature_gate() -> Option<Symbol> {\n+        Some(sym::const_mut_refs)\n     }\n \n     fn emit_error(&self, item: &Item<'_, '_>, span: Span) {\n@@ -238,8 +240,8 @@ impl NonConstOp for MutBorrow {\n #[derive(Debug)]\n pub struct MutAddressOf;\n impl NonConstOp for MutAddressOf {\n-    fn feature_gate(tcx: TyCtxt<'_>) -> Option<bool> {\n-        Some(tcx.features().const_mut_refs)\n+    fn feature_gate() -> Option<Symbol> {\n+        Some(sym::const_mut_refs)\n     }\n \n     fn emit_error(&self, item: &Item<'_, '_>, span: Span) {\n@@ -256,16 +258,16 @@ impl NonConstOp for MutAddressOf {\n #[derive(Debug)]\n pub struct MutDeref;\n impl NonConstOp for MutDeref {\n-    fn feature_gate(tcx: TyCtxt<'_>) -> Option<bool> {\n-        Some(tcx.features().const_mut_refs)\n+    fn feature_gate() -> Option<Symbol> {\n+        Some(sym::const_mut_refs)\n     }\n }\n \n #[derive(Debug)]\n pub struct Panic;\n impl NonConstOp for Panic {\n-    fn feature_gate(tcx: TyCtxt<'_>) -> Option<bool> {\n-        Some(tcx.features().const_panic)\n+    fn feature_gate() -> Option<Symbol> {\n+        Some(sym::const_panic)\n     }\n \n     fn emit_error(&self, item: &Item<'_, '_>, span: Span) {\n@@ -282,8 +284,8 @@ impl NonConstOp for Panic {\n #[derive(Debug)]\n pub struct RawPtrComparison;\n impl NonConstOp for RawPtrComparison {\n-    fn feature_gate(tcx: TyCtxt<'_>) -> Option<bool> {\n-        Some(tcx.features().const_compare_raw_pointers)\n+    fn feature_gate() -> Option<Symbol> {\n+        Some(sym::const_compare_raw_pointers)\n     }\n \n     fn emit_error(&self, item: &Item<'_, '_>, span: Span) {\n@@ -300,8 +302,8 @@ impl NonConstOp for RawPtrComparison {\n #[derive(Debug)]\n pub struct RawPtrDeref;\n impl NonConstOp for RawPtrDeref {\n-    fn feature_gate(tcx: TyCtxt<'_>) -> Option<bool> {\n-        Some(tcx.features().const_raw_ptr_deref)\n+    fn feature_gate() -> Option<Symbol> {\n+        Some(sym::const_raw_ptr_deref)\n     }\n \n     fn emit_error(&self, item: &Item<'_, '_>, span: Span) {\n@@ -318,8 +320,8 @@ impl NonConstOp for RawPtrDeref {\n #[derive(Debug)]\n pub struct RawPtrToIntCast;\n impl NonConstOp for RawPtrToIntCast {\n-    fn feature_gate(tcx: TyCtxt<'_>) -> Option<bool> {\n-        Some(tcx.features().const_raw_ptr_to_usize_cast)\n+    fn feature_gate() -> Option<Symbol> {\n+        Some(sym::const_raw_ptr_to_usize_cast)\n     }\n \n     fn emit_error(&self, item: &Item<'_, '_>, span: Span) {\n@@ -386,11 +388,12 @@ pub struct UnionAccess;\n impl NonConstOp for UnionAccess {\n     fn is_allowed_in_item(&self, item: &Item<'_, '_>) -> bool {\n         // Union accesses are stable in all contexts except `const fn`.\n-        item.const_kind() != ConstKind::ConstFn || Self::feature_gate(item.tcx).unwrap()\n+        item.const_kind() != ConstKind::ConstFn\n+            || item.tcx.features().enabled(Self::feature_gate().unwrap())\n     }\n \n-    fn feature_gate(tcx: TyCtxt<'_>) -> Option<bool> {\n-        Some(tcx.features().const_fn_union)\n+    fn feature_gate() -> Option<Symbol> {\n+        Some(sym::const_fn_union)\n     }\n \n     fn emit_error(&self, item: &Item<'_, '_>, span: Span) {"}, {"sha": "bfd97fcff3f28a8f35481e3f5487643da5b66802", "filename": "src/librustc_mir/transform/check_consts/validation.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d7e6649326080219fbdad6465468086e46e69377/src%2Flibrustc_mir%2Ftransform%2Fcheck_consts%2Fvalidation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d7e6649326080219fbdad6465468086e46e69377/src%2Flibrustc_mir%2Ftransform%2Fcheck_consts%2Fvalidation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fcheck_consts%2Fvalidation.rs?ref=d7e6649326080219fbdad6465468086e46e69377", "patch": "@@ -213,7 +213,7 @@ impl Validator<'a, 'mir, 'tcx> {\n \n         // If an operation is supported in miri (and is not already controlled by a feature gate) it\n         // can be turned on with `-Zunleash-the-miri-inside-of-you`.\n-        let is_unleashable = O::IS_SUPPORTED_IN_MIRI && O::feature_gate(self.tcx).is_none();\n+        let is_unleashable = O::IS_SUPPORTED_IN_MIRI && O::feature_gate().is_none();\n \n         if is_unleashable && self.tcx.sess.opts.debugging_opts.unleash_the_miri_inside_of_you {\n             self.tcx.sess.span_warn(span, \"skipping const checks\");"}]}