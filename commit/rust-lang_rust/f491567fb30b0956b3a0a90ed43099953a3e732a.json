{"sha": "f491567fb30b0956b3a0a90ed43099953a3e732a", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY0OTE1NjdmYjMwYjA5NTZiM2EwYTkwZWQ0MzA5OTk1M2EzZTczMmE=", "commit": {"author": {"name": "Lauren\u021biu Nicola", "email": "lnicola@dend.ro", "date": "2019-10-02T12:14:50Z"}, "committer": {"name": "Lauren\u021biu Nicola", "email": "lnicola@dend.ro", "date": "2019-10-02T14:31:34Z"}, "message": "Handle divergence in type inference for blocks", "tree": {"sha": "ec3bcea72a62114c1ba086f62a3ded7010545ec1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ec3bcea72a62114c1ba086f62a3ded7010545ec1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f491567fb30b0956b3a0a90ed43099953a3e732a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f491567fb30b0956b3a0a90ed43099953a3e732a", "html_url": "https://github.com/rust-lang/rust/commit/f491567fb30b0956b3a0a90ed43099953a3e732a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f491567fb30b0956b3a0a90ed43099953a3e732a/comments", "author": {"login": "lnicola", "id": 308347, "node_id": "MDQ6VXNlcjMwODM0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/308347?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lnicola", "html_url": "https://github.com/lnicola", "followers_url": "https://api.github.com/users/lnicola/followers", "following_url": "https://api.github.com/users/lnicola/following{/other_user}", "gists_url": "https://api.github.com/users/lnicola/gists{/gist_id}", "starred_url": "https://api.github.com/users/lnicola/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lnicola/subscriptions", "organizations_url": "https://api.github.com/users/lnicola/orgs", "repos_url": "https://api.github.com/users/lnicola/repos", "events_url": "https://api.github.com/users/lnicola/events{/privacy}", "received_events_url": "https://api.github.com/users/lnicola/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lnicola", "id": 308347, "node_id": "MDQ6VXNlcjMwODM0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/308347?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lnicola", "html_url": "https://github.com/lnicola", "followers_url": "https://api.github.com/users/lnicola/followers", "following_url": "https://api.github.com/users/lnicola/following{/other_user}", "gists_url": "https://api.github.com/users/lnicola/gists{/gist_id}", "starred_url": "https://api.github.com/users/lnicola/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lnicola/subscriptions", "organizations_url": "https://api.github.com/users/lnicola/orgs", "repos_url": "https://api.github.com/users/lnicola/repos", "events_url": "https://api.github.com/users/lnicola/events{/privacy}", "received_events_url": "https://api.github.com/users/lnicola/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "31f22d85491d9e7eaadf5fd4f9754c83fc0f3ea6", "url": "https://api.github.com/repos/rust-lang/rust/commits/31f22d85491d9e7eaadf5fd4f9754c83fc0f3ea6", "html_url": "https://github.com/rust-lang/rust/commit/31f22d85491d9e7eaadf5fd4f9754c83fc0f3ea6"}], "stats": {"total": 75, "additions": 72, "deletions": 3}, "files": [{"sha": "ca9aefc42f7b4f646a70d6636216af15bf24430e", "filename": "crates/ra_hir/src/ty/infer.rs", "status": "modified", "additions": 10, "deletions": 2, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/f491567fb30b0956b3a0a90ed43099953a3e732a/crates%2Fra_hir%2Fsrc%2Fty%2Finfer.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f491567fb30b0956b3a0a90ed43099953a3e732a/crates%2Fra_hir%2Fsrc%2Fty%2Finfer.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fty%2Finfer.rs?ref=f491567fb30b0956b3a0a90ed43099953a3e732a", "patch": "@@ -1602,6 +1602,7 @@ impl<'a, D: HirDatabase> InferenceContext<'a, D> {\n         tail: Option<ExprId>,\n         expected: &Expectation,\n     ) -> Ty {\n+        let mut diverges = false;\n         for stmt in statements {\n             match stmt {\n                 Statement::Let { pat, type_ref, initializer } => {\n@@ -1623,16 +1624,23 @@ impl<'a, D: HirDatabase> InferenceContext<'a, D> {\n                     self.infer_pat(*pat, &ty, BindingMode::default());\n                 }\n                 Statement::Expr(expr) => {\n-                    self.infer_expr(*expr, &Expectation::none());\n+                    if let ty_app!(TypeCtor::Never) = self.infer_expr(*expr, &Expectation::none()) {\n+                        diverges = true;\n+                    }\n                 }\n             }\n         }\n \n-        if let Some(expr) = tail {\n+        let ty = if let Some(expr) = tail {\n             self.infer_expr_coerce(expr, expected)\n         } else {\n             self.coerce(&Ty::unit(), &expected.ty);\n             Ty::unit()\n+        };\n+        if diverges {\n+            Ty::simple(TypeCtor::Never)\n+        } else {\n+            ty\n         }\n     }\n "}, {"sha": "66f63ca24011b8a071ed6e5ba3ff273bf471ba37", "filename": "crates/ra_hir/src/ty/tests.rs", "status": "modified", "additions": 62, "deletions": 1, "changes": 63, "blob_url": "https://github.com/rust-lang/rust/blob/f491567fb30b0956b3a0a90ed43099953a3e732a/crates%2Fra_hir%2Fsrc%2Fty%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f491567fb30b0956b3a0a90ed43099953a3e732a/crates%2Fra_hir%2Fsrc%2Fty%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fty%2Ftests.rs?ref=f491567fb30b0956b3a0a90ed43099953a3e732a", "patch": "@@ -218,7 +218,7 @@ fn test(a: u32, b: isize, c: !, d: &str) {\n     [17; 18) 'b': isize\n     [27; 28) 'c': !\n     [33; 34) 'd': &str\n-    [42; 121) '{     ...f32; }': ()\n+    [42; 121) '{     ...f32; }': !\n     [48; 49) 'a': u32\n     [55; 56) 'b': isize\n     [62; 63) 'c': !\n@@ -980,6 +980,67 @@ fn main(foo: Foo) {\n     )\n }\n \n+#[test]\n+fn infer_if_match_with_return() {\n+    assert_snapshot!(\n+        infer(r#\"\n+fn foo() {\n+    let _x1 = if true {\n+        1\n+    } else {\n+        return;\n+    };\n+    let _x2 = if true {\n+        2\n+    } else {\n+        return\n+    };\n+    let _x3 = match true {\n+        true => 3,\n+        _ => {\n+            return;\n+        }\n+    };\n+    let _x4 = match true {\n+        true => 4,\n+        _ => return\n+    };\n+}\"#),\n+        @r###\"\n+    [10; 323) '{     ...  }; }': ()\n+    [20; 23) '_x1': i32\n+    [26; 80) 'if tru...     }': i32\n+    [29; 33) 'true': bool\n+    [34; 51) '{     ...     }': i32\n+    [44; 45) '1': i32\n+    [57; 80) '{     ...     }': !\n+    [67; 73) 'return': !\n+    [90; 93) '_x2': i32\n+    [96; 149) 'if tru...     }': i32\n+    [99; 103) 'true': bool\n+    [104; 121) '{     ...     }': i32\n+    [114; 115) '2': i32\n+    [127; 149) '{     ...     }': !\n+    [137; 143) 'return': !\n+    [159; 162) '_x3': i32\n+    [165; 247) 'match ...     }': i32\n+    [171; 175) 'true': bool\n+    [186; 190) 'true': bool\n+    [194; 195) '3': i32\n+    [205; 206) '_': bool\n+    [210; 241) '{     ...     }': !\n+    [224; 230) 'return': !\n+    [257; 260) '_x4': i32\n+    [263; 320) 'match ...     }': i32\n+    [269; 273) 'true': bool\n+    [284; 288) 'true': bool\n+    [292; 293) '4': i32\n+    [303; 304) '_': bool\n+    [308; 314) 'return': !\n+    \"###\n+    )\n+}\n+\n #[test]\n fn infer_inherent_method() {\n     assert_snapshot!("}]}