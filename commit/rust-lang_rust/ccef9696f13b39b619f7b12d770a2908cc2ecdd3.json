{"sha": "ccef9696f13b39b619f7b12d770a2908cc2ecdd3", "node_id": "MDY6Q29tbWl0NzI0NzEyOmNjZWY5Njk2ZjEzYjM5YjYxOWY3YjEyZDc3MGEyOTA4Y2MyZWNkZDM=", "commit": {"author": {"name": "Jonathan A. Kollasch", "email": "jakllsch@kollasch.net", "date": "2017-11-29T17:31:09Z"}, "committer": {"name": "Jonathan A. Kollasch", "email": "jakllsch@kollasch.net", "date": "2017-11-30T18:17:44Z"}, "message": "NetBSD: add sysctl backend for std::env::current_exe\n\nUse the CTL_KERN.KERN_PROC_ARGS.-1.KERN_PROC_PATHNAME sysctl in\npreference over the /proc/curproc/exe symlink.\n\nAdditionally, perform more validation of aformentioned symlink.\nParticularly on pre-8.x NetBSD this symlink will point to '/' when\naccurate information is unavailable.", "tree": {"sha": "978bfed05020e11d0de2be1108732b5edd28b42b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/978bfed05020e11d0de2be1108732b5edd28b42b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ccef9696f13b39b619f7b12d770a2908cc2ecdd3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ccef9696f13b39b619f7b12d770a2908cc2ecdd3", "html_url": "https://github.com/rust-lang/rust/commit/ccef9696f13b39b619f7b12d770a2908cc2ecdd3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ccef9696f13b39b619f7b12d770a2908cc2ecdd3/comments", "author": {"login": "jakllsch", "id": 2145119, "node_id": "MDQ6VXNlcjIxNDUxMTk=", "avatar_url": "https://avatars.githubusercontent.com/u/2145119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakllsch", "html_url": "https://github.com/jakllsch", "followers_url": "https://api.github.com/users/jakllsch/followers", "following_url": "https://api.github.com/users/jakllsch/following{/other_user}", "gists_url": "https://api.github.com/users/jakllsch/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakllsch/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakllsch/subscriptions", "organizations_url": "https://api.github.com/users/jakllsch/orgs", "repos_url": "https://api.github.com/users/jakllsch/repos", "events_url": "https://api.github.com/users/jakllsch/events{/privacy}", "received_events_url": "https://api.github.com/users/jakllsch/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakllsch", "id": 2145119, "node_id": "MDQ6VXNlcjIxNDUxMTk=", "avatar_url": "https://avatars.githubusercontent.com/u/2145119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakllsch", "html_url": "https://github.com/jakllsch", "followers_url": "https://api.github.com/users/jakllsch/followers", "following_url": "https://api.github.com/users/jakllsch/following{/other_user}", "gists_url": "https://api.github.com/users/jakllsch/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakllsch/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakllsch/subscriptions", "organizations_url": "https://api.github.com/users/jakllsch/orgs", "repos_url": "https://api.github.com/users/jakllsch/repos", "events_url": "https://api.github.com/users/jakllsch/events{/privacy}", "received_events_url": "https://api.github.com/users/jakllsch/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4fa202d23b4c8c81b8ac6cf89cf843d35854d437", "url": "https://api.github.com/repos/rust-lang/rust/commits/4fa202d23b4c8c81b8ac6cf89cf843d35854d437", "html_url": "https://github.com/rust-lang/rust/commit/4fa202d23b4c8c81b8ac6cf89cf843d35854d437"}], "stats": {"total": 29, "additions": 28, "deletions": 1}, "files": [{"sha": "4f33a2b12fe5d1447fa20fcbbf1c84c8cb583dd4", "filename": "src/libstd/sys/unix/os.rs", "status": "modified", "additions": 28, "deletions": 1, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/ccef9696f13b39b619f7b12d770a2908cc2ecdd3/src%2Flibstd%2Fsys%2Funix%2Fos.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ccef9696f13b39b619f7b12d770a2908cc2ecdd3/src%2Flibstd%2Fsys%2Funix%2Fos.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Funix%2Fos.rs?ref=ccef9696f13b39b619f7b12d770a2908cc2ecdd3", "patch": "@@ -223,7 +223,34 @@ pub fn current_exe() -> io::Result<PathBuf> {\n \n #[cfg(target_os = \"netbsd\")]\n pub fn current_exe() -> io::Result<PathBuf> {\n-    ::fs::read_link(\"/proc/curproc/exe\")\n+    fn sysctl() -> io::Result<PathBuf> {\n+        unsafe {\n+            let mib = [libc::CTL_KERN, libc::KERN_PROC_ARGS, -1, libc::KERN_PROC_PATHNAME];\n+            let mut path_len: usize = 0;\n+            cvt(libc::sysctl(mib.as_ptr(), mib.len() as ::libc::c_uint,\n+                             ptr::null_mut(), &mut path_len,\n+                             ptr::null(), 0))?;\n+            if path_len <= 1 {\n+                return Err(io::Error::new(io::ErrorKind::Other,\n+                           \"KERN_PROC_PATHNAME sysctl returned zero-length string\"))\n+            }\n+            let mut path: Vec<u8> = Vec::with_capacity(path_len);\n+            cvt(libc::sysctl(mib.as_ptr(), mib.len() as ::libc::c_uint,\n+                             path.as_ptr() as *mut libc::c_void, &mut path_len,\n+                             ptr::null(), 0))?;\n+            path.set_len(path_len - 1); // chop off NUL\n+            Ok(PathBuf::from(OsString::from_vec(path)))\n+        }\n+    }\n+    fn procfs() -> io::Result<PathBuf> {\n+        let curproc_exe = path::Path::new(\"/proc/curproc/exe\");\n+        if curproc_exe.is_file() {\n+            return ::fs::read_link(curproc_exe);\n+        }\n+        Err(io::Error::new(io::ErrorKind::Other,\n+                           \"/proc/curproc/exe doesn't point to regular file.\"))\n+    }\n+    sysctl().or_else(|_| procfs())\n }\n \n #[cfg(any(target_os = \"bitrig\", target_os = \"openbsd\"))]"}]}