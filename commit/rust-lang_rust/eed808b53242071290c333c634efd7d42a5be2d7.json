{"sha": "eed808b53242071290c333c634efd7d42a5be2d7", "node_id": "MDY6Q29tbWl0NzI0NzEyOmVlZDgwOGI1MzI0MjA3MTI5MGMzMzNjNjM0ZWZkN2Q0MmE1YmUyZDc=", "commit": {"author": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2014-03-22T03:12:51Z"}, "committer": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2014-03-24T21:29:18Z"}, "message": "install: Improve error handling", "tree": {"sha": "a8b09b1cb0a47d0556dcbe74e7abf7b248f55958", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a8b09b1cb0a47d0556dcbe74e7abf7b248f55958"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/eed808b53242071290c333c634efd7d42a5be2d7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/eed808b53242071290c333c634efd7d42a5be2d7", "html_url": "https://github.com/rust-lang/rust/commit/eed808b53242071290c333c634efd7d42a5be2d7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/eed808b53242071290c333c634efd7d42a5be2d7/comments", "author": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "committer": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "169f08dd59f287a65da5188ff453f38f4215250c", "url": "https://api.github.com/repos/rust-lang/rust/commits/169f08dd59f287a65da5188ff453f38f4215250c", "html_url": "https://github.com/rust-lang/rust/commit/169f08dd59f287a65da5188ff453f38f4215250c"}], "stats": {"total": 39, "additions": 28, "deletions": 11}, "files": [{"sha": "63bb71558ab289b8b09985a4aac3efe2e45be6af", "filename": "src/etc/install.sh", "status": "modified", "additions": 28, "deletions": 11, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/eed808b53242071290c333c634efd7d42a5be2d7/src%2Fetc%2Finstall.sh", "raw_url": "https://github.com/rust-lang/rust/raw/eed808b53242071290c333c634efd7d42a5be2d7/src%2Fetc%2Finstall.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fetc%2Finstall.sh?ref=eed808b53242071290c333c634efd7d42a5be2d7", "patch": "@@ -224,49 +224,66 @@ step_msg \"validating $CFG_SELF args\"\n validate_opt\n \n # Sanity check: can we can write to the destination?\n-mkdir -p \"${CFG_PREFIX}/lib\"\n+umask 022 && mkdir -p \"${CFG_PREFIX}/lib\"\n+need_ok \"directory creation failed\"\n touch \"${CFG_PREFIX}/lib/rust-install-probe\" 2> /dev/null\n if [ $? -ne 0 ]\n then\n     err \"can't write to destination. try again with 'sudo'.\"\n fi\n-rm -r \"${CFG_PREFIX}/lib/rust-install-probe\"\n+rm \"${CFG_PREFIX}/lib/rust-install-probe\"\n need_ok \"failed to remove install probe\"\n \n # Sanity check: can we run these binaries?\n \"${CFG_SRC_DIR}/bin/rustc\" --version > /dev/null\n need_ok \"can't run these binaries on this platform\"\n \n \n-# First, uninstall from the installation prefix\n+# First, uninstall from the installation prefix.\n+# Errors are warnings - try to rm everything in the manifest even if some fail.\n # FIXME: Hardcoded 'rustlib' ignores CFG_RUSTLIBDIR\n if [ -f \"${CFG_PREFIX}/lib/rustlib/manifest\" ]\n then\n+    # Iterate through installed manifest and remove files\n     while read p; do\n-        msg \"uninstall ${CFG_PREFIX}/$p\"\n-        rm \"${CFG_PREFIX}/$p\"\n-        need_ok \"failed to remove file\"\n+        msg \"removing ${CFG_PREFIX}/$p\"\n+        if [ -f \"${CFG_PREFIX}/$p\" ]\n+        then\n+            rm \"${CFG_PREFIX}/$p\"\n+            if [ $? -ne 0 ]\n+            then\n+                warn \"failed to remove ${CFG_PREFIX}/$p\"\n+            fi\n+        else\n+            warn \"supposedly installed file ${CFG_PREFIX}/$p does not exist!\"\n+        fi\n     done < \"${CFG_PREFIX}/lib/rustlib/manifest\"\n \n     # Remove 'rustlib' directory\n-    msg \"uninstall ${CFG_PREFIX}/lib/rustlib\"\n+    msg \"removing ${CFG_PREFIX}/lib/rustlib\"\n     rm -r \"${CFG_PREFIX}/lib/rustlib\"\n-    need_ok \"failed to remove rustlib\"\n+    if [ $? -ne 0 ]\n+    then\n+        warn \"failed to remove rustlib\"\n+    fi\n else\n     if [ -n \"${CFG_UNINSTALL}\" ]\n     then\n-        err \"unable to find manifest at ${CFG_PREFIX}/lib/rustlib\"\n-        exit 0\n+        err \"unable to find installation manifest at ${CFG_PREFIX}/lib/rustlib\"\n     fi\n fi\n \n # If we're only uninstalling then exit\n if [ -n \"${CFG_UNINSTALL}\" ]\n then\n+    echo\n+    echo \"    Rust is uninstalled. Have a nice day.\"\n+    echo\n     exit 0\n fi\n \n-# Iterate through the new manifest and install files\n+\n+# Now install, iterate through the new manifest and copy files\n while read p; do\n \n     umask 022 && mkdir -p \"${CFG_PREFIX}/$(dirname $p)\""}]}