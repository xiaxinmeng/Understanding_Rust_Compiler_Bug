{"sha": "6a342a6ecb305b6d789646036ae463f8ebfc6f6f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZhMzQyYTZlY2IzMDViNmQ3ODk2NDYwMzZhZTQ2M2Y4ZWJmYzZmNmY=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-10-06T14:04:41Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-10-06T14:04:41Z"}, "message": "Auto merge of #1575 - Aaron1011:fix/macro-backtrace, r=oli-obk\n\nUse macro callsite spans in backtrace\n\nThis mirrors what we do in the debuginfo used for runtime backtraces.", "tree": {"sha": "aa19ce8b7d2bc2593bc0014f1f2fe2a255585401", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/aa19ce8b7d2bc2593bc0014f1f2fe2a255585401"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6a342a6ecb305b6d789646036ae463f8ebfc6f6f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6a342a6ecb305b6d789646036ae463f8ebfc6f6f", "html_url": "https://github.com/rust-lang/rust/commit/6a342a6ecb305b6d789646036ae463f8ebfc6f6f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6a342a6ecb305b6d789646036ae463f8ebfc6f6f/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "dbdc127d5dcb0f4d1c6516216f5f62586297c608", "url": "https://api.github.com/repos/rust-lang/rust/commits/dbdc127d5dcb0f4d1c6516216f5f62586297c608", "html_url": "https://github.com/rust-lang/rust/commit/dbdc127d5dcb0f4d1c6516216f5f62586297c608"}, {"sha": "8e8828259ac1433dd3981fcec9670d7394c2ade5", "url": "https://api.github.com/repos/rust-lang/rust/commits/8e8828259ac1433dd3981fcec9670d7394c2ade5", "html_url": "https://github.com/rust-lang/rust/commit/8e8828259ac1433dd3981fcec9670d7394c2ade5"}], "stats": {"total": 26, "additions": 20, "deletions": 6}, "files": [{"sha": "bd36587116a06f5822b2da1c30fff69b62b88177", "filename": "src/shims/backtrace.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/6a342a6ecb305b6d789646036ae463f8ebfc6f6f/src%2Fshims%2Fbacktrace.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6a342a6ecb305b6d789646036ae463f8ebfc6f6f/src%2Fshims%2Fbacktrace.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fshims%2Fbacktrace.rs?ref=6a342a6ecb305b6d789646036ae463f8ebfc6f6f", "patch": "@@ -26,7 +26,13 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n \n         let mut data = Vec::new();\n         for frame in this.active_thread_stack().iter().rev() {\n-            data.push((frame.instance, frame.current_span().lo()));\n+            let mut span = frame.current_span();\n+            // Match the behavior of runtime backtrace spans\n+            // by using a non-macro span in our backtrace. See `FunctionCx::debug_loc`.\n+            if span.from_expansion() && !tcx.sess.opts.debugging_opts.debug_macros {\n+                span = rustc_span::hygiene::walk_chain(span, frame.body.span.ctxt())\n+            }\n+            data.push((frame.instance, span.lo()));\n         }\n \n         let ptrs: Vec<_> = data.into_iter().map(|(instance, pos)| {"}, {"sha": "eaf29abfd9f48d16d864367ea8b68e0cfc0f0d1e", "filename": "tests/run-pass/backtrace-api.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/6a342a6ecb305b6d789646036ae463f8ebfc6f6f/tests%2Frun-pass%2Fbacktrace-api.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6a342a6ecb305b6d789646036ae463f8ebfc6f6f/tests%2Frun-pass%2Fbacktrace-api.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-pass%2Fbacktrace-api.rs?ref=6a342a6ecb305b6d789646036ae463f8ebfc6f6f", "patch": "@@ -18,7 +18,13 @@ struct MiriFrame {\n \n #[inline(never)] fn func_a() -> Box<[*mut ()]> { func_b::<u8>() }\n #[inline(never)] fn func_b<T>() -> Box<[*mut ()]> { func_c() }\n-#[inline(never)] fn func_c() -> Box<[*mut ()]> { unsafe { miri_get_backtrace(0) } }\n+\n+macro_rules! invoke_func_d {\n+    () => { func_d() }\n+}\n+\n+#[inline(never)] fn func_c() -> Box<[*mut ()]> { invoke_func_d!() }\n+#[inline(never)] fn func_d() -> Box<[*mut ()]> { unsafe { miri_get_backtrace(0) } }\n \n fn main() {\n     let mut seen_main = false;"}, {"sha": "02e7a7e1eaf9c88635b6c5d449b0b702ceb60840", "filename": "tests/run-pass/backtrace-api.stderr", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/6a342a6ecb305b6d789646036ae463f8ebfc6f6f/tests%2Frun-pass%2Fbacktrace-api.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/6a342a6ecb305b6d789646036ae463f8ebfc6f6f/tests%2Frun-pass%2Fbacktrace-api.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-pass%2Fbacktrace-api.stderr?ref=6a342a6ecb305b6d789646036ae463f8ebfc6f6f", "patch": "@@ -1,7 +1,8 @@\n-$DIR/backtrace-api.rs:21:59 (func_c)\n+$DIR/backtrace-api.rs:27:59 (func_d)\n+$DIR/backtrace-api.rs:26:50 (func_c)\n $DIR/backtrace-api.rs:20:53 (func_b)\n $DIR/backtrace-api.rs:19:50 (func_a)\n-$DIR/backtrace-api.rs:25:18 (main)\n+$DIR/backtrace-api.rs:31:18 (main)\n RUSTLIB/core/src/ops/function.rs:LL:COL (<fn() as std::ops::FnOnce<()>>::call_once - shim(fn()))\n RUSTLIB/std/src/sys_common/backtrace.rs:LL:COL (std::sys_common::backtrace::__rust_begin_short_backtrace)\n RUSTLIB/std/src/rt.rs:LL:COL (std::rt::lang_start::{closure#0})"}, {"sha": "90ab4bb96e625c5e2ac20904f8e273e56bd8ed27", "filename": "tests/run-pass/backtrace-api.stdout", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/6a342a6ecb305b6d789646036ae463f8ebfc6f6f/tests%2Frun-pass%2Fbacktrace-api.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/6a342a6ecb305b6d789646036ae463f8ebfc6f6f/tests%2Frun-pass%2Fbacktrace-api.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-pass%2Fbacktrace-api.stdout?ref=6a342a6ecb305b6d789646036ae463f8ebfc6f6f", "patch": "@@ -1,4 +1,5 @@\n-$DIR/backtrace-api.rs:21:59 (func_c)\n+$DIR/backtrace-api.rs:27:59 (func_d)\n+$DIR/backtrace-api.rs:26:50 (func_c)\n $DIR/backtrace-api.rs:20:53 (func_b::<u8>)\n $DIR/backtrace-api.rs:19:50 (func_a)\n-$DIR/backtrace-api.rs:25:18 (main)\n+$DIR/backtrace-api.rs:31:18 (main)"}]}