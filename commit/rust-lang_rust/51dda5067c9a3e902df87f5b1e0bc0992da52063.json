{"sha": "51dda5067c9a3e902df87f5b1e0bc0992da52063", "node_id": "C_kwDOAAsO6NoAKDUxZGRhNTA2N2M5YTNlOTAyZGY4N2Y1YjFlMGJjMDk5MmRhNTIwNjM", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2022-07-29T06:40:03Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-07-29T06:40:03Z"}, "message": "Rollup merge of #99850 - GuillaumeGomez:clean-more-items, r=notriddle\n\nrustdoc: Remove more Clean trait implementations\n\nFollow-up of https://github.com/rust-lang/rust/pull/99638.\n\nr? `@notriddle`", "tree": {"sha": "6169cecfe7bbec310aefad0c045b6d10ca78eb91", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6169cecfe7bbec310aefad0c045b6d10ca78eb91"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/51dda5067c9a3e902df87f5b1e0bc0992da52063", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJi44DECRBK7hj4Ov3rIwAAI58IAH3kE29Nu3mo7EXwPklORbYx\n4QuerbB5/5uOr8T3JXiTzEmC6Ke0lyJwwjPTh6sY0wlDQEF3uwG+kAMv4GmzncR5\n430QQhQ6xc5WbnX8FK+qW06DXpXLf1arBybjZF1aPClFSs57MHq5Mya3v/jttEF6\n3pphp3aEn1aVMVNC3BU+yCoCK+VyZ3yh8GEuNq9FDyRIWP7ciXfO8LrWFDB3nFez\nWRbM0COin1LuKJtq/fY+TwNMSRgulZVTLF9l9zHb8g7FtA5ij6stHvfmI2Ub7pNg\nfBUkMN22aKczvSAywKn6qCKQPg298kgLg0Gk1kabEt7iyQ84/vWN8fRtMAHibzM=\n=Ykay\n-----END PGP SIGNATURE-----\n", "payload": "tree 6169cecfe7bbec310aefad0c045b6d10ca78eb91\nparent da3f951bb04eb1070cd51b0355f8091671d2c98e\nparent 660dc6f393ed64b0fd007ac11a2dab445a28b9ed\nauthor Yuki Okushi <jtitor@2k36.org> 1659076803 +0900\ncommitter GitHub <noreply@github.com> 1659076803 +0900\n\nRollup merge of #99850 - GuillaumeGomez:clean-more-items, r=notriddle\n\nrustdoc: Remove more Clean trait implementations\n\nFollow-up of https://github.com/rust-lang/rust/pull/99638.\n\nr? `@notriddle`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/51dda5067c9a3e902df87f5b1e0bc0992da52063", "html_url": "https://github.com/rust-lang/rust/commit/51dda5067c9a3e902df87f5b1e0bc0992da52063", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/51dda5067c9a3e902df87f5b1e0bc0992da52063/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "da3f951bb04eb1070cd51b0355f8091671d2c98e", "url": "https://api.github.com/repos/rust-lang/rust/commits/da3f951bb04eb1070cd51b0355f8091671d2c98e", "html_url": "https://github.com/rust-lang/rust/commit/da3f951bb04eb1070cd51b0355f8091671d2c98e"}, {"sha": "660dc6f393ed64b0fd007ac11a2dab445a28b9ed", "url": "https://api.github.com/repos/rust-lang/rust/commits/660dc6f393ed64b0fd007ac11a2dab445a28b9ed", "html_url": "https://github.com/rust-lang/rust/commit/660dc6f393ed64b0fd007ac11a2dab445a28b9ed"}], "stats": {"total": 60, "additions": 28, "deletions": 32}, "files": [{"sha": "731d8766686c8be1ba70ecfe1a0da79afbab5bb5", "filename": "src/librustdoc/clean/inline.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/51dda5067c9a3e902df87f5b1e0bc0992da52063/src%2Flibrustdoc%2Fclean%2Finline.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51dda5067c9a3e902df87f5b1e0bc0992da52063/src%2Flibrustdoc%2Fclean%2Finline.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Finline.rs?ref=51dda5067c9a3e902df87f5b1e0bc0992da52063", "patch": "@@ -17,7 +17,8 @@ use rustc_span::symbol::{kw, sym, Symbol};\n \n use crate::clean::{\n     self, clean_fn_decl_from_did_and_sig, clean_middle_field, clean_middle_ty, clean_ty,\n-    clean_ty_generics, utils, Attributes, AttributesExt, Clean, ImplKind, ItemId, Type, Visibility,\n+    clean_ty_generics, clean_visibility, utils, Attributes, AttributesExt, Clean, ImplKind, ItemId,\n+    Type, Visibility,\n };\n use crate::core::DocContext;\n use crate::formats::item_type::ItemType;\n@@ -134,7 +135,7 @@ pub(crate) fn try_inline(\n     );\n     if let Some(import_def_id) = import_def_id {\n         // The visibility needs to reflect the one from the reexport and not from the \"source\" DefId.\n-        item.visibility = cx.tcx.visibility(import_def_id).clean(cx);\n+        item.visibility = clean_visibility(cx.tcx.visibility(import_def_id));\n     }\n     ret.push(item);\n     Some(ret)\n@@ -599,7 +600,7 @@ fn build_macro(\n     match CStore::from_tcx(cx.tcx).load_macro_untracked(def_id, cx.sess()) {\n         LoadedMacro::MacroDef(item_def, _) => {\n             if let ast::ItemKind::MacroDef(ref def) = item_def.kind {\n-                let vis = cx.tcx.visibility(import_def_id.unwrap_or(def_id)).clean(cx);\n+                let vis = clean_visibility(cx.tcx.visibility(import_def_id.unwrap_or(def_id)));\n                 clean::MacroItem(clean::Macro {\n                     source: utils::display_macro_source(cx, name, def, def_id, vis),\n                 })"}, {"sha": "624eec57e832488f1f13e079a1e0bd04da111e18", "filename": "src/librustdoc/clean/mod.rs", "status": "modified", "additions": 22, "deletions": 27, "changes": 49, "blob_url": "https://github.com/rust-lang/rust/blob/51dda5067c9a3e902df87f5b1e0bc0992da52063/src%2Flibrustdoc%2Fclean%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51dda5067c9a3e902df87f5b1e0bc0992da52063/src%2Flibrustdoc%2Fclean%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Fmod.rs?ref=51dda5067c9a3e902df87f5b1e0bc0992da52063", "patch": "@@ -1812,32 +1812,25 @@ fn is_field_vis_inherited(tcx: TyCtxt<'_>, def_id: DefId) -> bool {\n     }\n }\n \n-impl<'tcx> Clean<'tcx, Visibility> for ty::Visibility {\n-    fn clean(&self, _cx: &mut DocContext<'_>) -> Visibility {\n-        match *self {\n-            ty::Visibility::Public => Visibility::Public,\n-            // NOTE: this is not quite right: `ty` uses `Invisible` to mean 'private',\n-            // while rustdoc really does mean inherited. That means that for enum variants, such as\n-            // `pub enum E { V }`, `V` will be marked as `Public` by `ty`, but as `Inherited` by rustdoc.\n-            // Various parts of clean override `tcx.visibility` explicitly to make sure this distinction is captured.\n-            ty::Visibility::Invisible => Visibility::Inherited,\n-            ty::Visibility::Restricted(module) => Visibility::Restricted(module),\n-        }\n-    }\n-}\n-\n-impl<'tcx> Clean<'tcx, VariantStruct> for rustc_hir::VariantData<'tcx> {\n-    fn clean(&self, cx: &mut DocContext<'tcx>) -> VariantStruct {\n-        VariantStruct {\n-            struct_type: CtorKind::from_hir(self),\n-            fields: self.fields().iter().map(|x| clean_field(x, cx)).collect(),\n-        }\n+pub(crate) fn clean_visibility(vis: ty::Visibility) -> Visibility {\n+    match vis {\n+        ty::Visibility::Public => Visibility::Public,\n+        // NOTE: this is not quite right: `ty` uses `Invisible` to mean 'private',\n+        // while rustdoc really does mean inherited. That means that for enum variants, such as\n+        // `pub enum E { V }`, `V` will be marked as `Public` by `ty`, but as `Inherited` by rustdoc.\n+        // Various parts of clean override `tcx.visibility` explicitly to make sure this distinction is captured.\n+        ty::Visibility::Invisible => Visibility::Inherited,\n+        ty::Visibility::Restricted(module) => Visibility::Restricted(module),\n     }\n }\n \n-impl<'tcx> Clean<'tcx, Vec<Item>> for hir::VariantData<'tcx> {\n-    fn clean(&self, cx: &mut DocContext<'tcx>) -> Vec<Item> {\n-        self.fields().iter().map(|x| clean_field(x, cx)).collect()\n+fn clean_variant_data<'tcx>(\n+    variant: &hir::VariantData<'tcx>,\n+    cx: &mut DocContext<'tcx>,\n+) -> VariantStruct {\n+    VariantStruct {\n+        struct_type: CtorKind::from_hir(variant),\n+        fields: variant.fields().iter().map(|x| clean_field(x, cx)).collect(),\n     }\n }\n \n@@ -1863,8 +1856,10 @@ impl<'tcx> Clean<'tcx, Item> for ty::VariantDef {\n impl<'tcx> Clean<'tcx, Variant> for hir::VariantData<'tcx> {\n     fn clean(&self, cx: &mut DocContext<'tcx>) -> Variant {\n         match self {\n-            hir::VariantData::Struct(..) => Variant::Struct(self.clean(cx)),\n-            hir::VariantData::Tuple(..) => Variant::Tuple(self.clean(cx)),\n+            hir::VariantData::Struct(..) => Variant::Struct(clean_variant_data(self, cx)),\n+            hir::VariantData::Tuple(..) => {\n+                Variant::Tuple(self.fields().iter().map(|x| clean_field(x, cx)).collect())\n+            }\n             hir::VariantData::Unit(..) => Variant::CLike,\n         }\n     }\n@@ -1983,7 +1978,7 @@ fn clean_maybe_renamed_item<'tcx>(\n                 clean_fn_or_proc_macro(item, sig, generics, body_id, &mut name, cx)\n             }\n             ItemKind::Macro(ref macro_def, _) => {\n-                let ty_vis = cx.tcx.visibility(def_id).clean(cx);\n+                let ty_vis = clean_visibility(cx.tcx.visibility(def_id));\n                 MacroItem(Macro {\n                     source: display_macro_source(cx, name, macro_def, def_id, ty_vis),\n                 })\n@@ -2112,7 +2107,7 @@ fn clean_extern_crate<'tcx>(\n         name: Some(name),\n         attrs: Box::new(attrs.clean(cx)),\n         item_id: crate_def_id.into(),\n-        visibility: ty_vis.clean(cx),\n+        visibility: clean_visibility(ty_vis),\n         kind: box ExternCrateItem { src: orig_name },\n         cfg: attrs.cfg(cx.tcx, &cx.cache.hidden_cfg),\n     }]"}, {"sha": "a5d27a940341a2be5c85de2fcd67bcba09b0b65f", "filename": "src/librustdoc/clean/types.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/51dda5067c9a3e902df87f5b1e0bc0992da52063/src%2Flibrustdoc%2Fclean%2Ftypes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51dda5067c9a3e902df87f5b1e0bc0992da52063/src%2Flibrustdoc%2Fclean%2Ftypes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Ftypes.rs?ref=51dda5067c9a3e902df87f5b1e0bc0992da52063", "patch": "@@ -37,7 +37,7 @@ use crate::clean::cfg::Cfg;\n use crate::clean::external_path;\n use crate::clean::inline::{self, print_inlined_const};\n use crate::clean::utils::{is_literal_expr, print_const_expr, print_evaluated_const};\n-use crate::clean::Clean;\n+use crate::clean::{clean_visibility, Clean};\n use crate::core::DocContext;\n use crate::formats::cache::Cache;\n use crate::formats::item_type::ItemType;\n@@ -499,7 +499,7 @@ impl Item {\n         let visibility = if matches!(&kind, ItemKind::KeywordItem | ItemKind::PrimitiveItem(..)) {\n             Visibility::Public\n         } else {\n-            cx.tcx.visibility(def_id).clean(cx)\n+            clean_visibility(cx.tcx.visibility(def_id))\n         };\n \n         Item { item_id: def_id.into(), kind: box kind, name, attrs, visibility, cfg }"}]}