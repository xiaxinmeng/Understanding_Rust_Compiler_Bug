{"sha": "af1baa3befb18e8a22377197c20a7084ecb88848", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFmMWJhYTNiZWZiMThlOGEyMjM3NzE5N2MyMGE3MDg0ZWNiODg4NDg=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-04-04T04:39:47Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-04-04T04:39:47Z"}, "message": "auto merge of #5691 : ILyoan/rust/main_name, r=thestinger\n\nExisting rust code decides main name by host environment of rustc.\r\nI think it should be chosen by build target.\r\n\r\nThis patch is also removing one of the android hacks that is not necessary any longer(I think it was not necessary from the first).", "tree": {"sha": "c173446da35e8d6282fccbdb168ecbc0664c7274", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c173446da35e8d6282fccbdb168ecbc0664c7274"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/af1baa3befb18e8a22377197c20a7084ecb88848", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/af1baa3befb18e8a22377197c20a7084ecb88848", "html_url": "https://github.com/rust-lang/rust/commit/af1baa3befb18e8a22377197c20a7084ecb88848", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/af1baa3befb18e8a22377197c20a7084ecb88848/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "783392f70fcfd6770782796bef06bed47043cabf", "url": "https://api.github.com/repos/rust-lang/rust/commits/783392f70fcfd6770782796bef06bed47043cabf", "html_url": "https://github.com/rust-lang/rust/commit/783392f70fcfd6770782796bef06bed47043cabf"}, {"sha": "53232f7acfa651f14c7ed5afd5ec44da9f82eb08", "url": "https://api.github.com/repos/rust-lang/rust/commits/53232f7acfa651f14c7ed5afd5ec44da9f82eb08", "html_url": "https://github.com/rust-lang/rust/commit/53232f7acfa651f14c7ed5afd5ec44da9f82eb08"}], "stats": {"total": 39, "additions": 14, "deletions": 25}, "files": [{"sha": "a8fe60ba68ee80159fef8422581f7a8fcdc74a5c", "filename": "src/librustc/middle/trans/base.rs", "status": "modified", "additions": 13, "deletions": 24, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/af1baa3befb18e8a22377197c20a7084ecb88848/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/af1baa3befb18e8a22377197c20a7084ecb88848/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs?ref=af1baa3befb18e8a22377197c20a7084ecb88848", "patch": "@@ -2243,17 +2243,17 @@ pub fn create_main_wrapper(ccx: @CrateContext,\n     }\n \n     fn create_entry_fn(ccx: @CrateContext, rust_main: ValueRef) {\n-        #[cfg(windows)]\n-        fn main_name() -> ~str { return ~\"WinMain@16\"; }\n-        #[cfg(unix)]\n-        fn main_name() -> ~str { return ~\"main\"; }\n         let llfty = T_fn(~[ccx.int_type, T_ptr(T_ptr(T_i8()))], ccx.int_type);\n \n         // FIXME #4404 android JNI hacks\n         let llfn = if *ccx.sess.building_library {\n             decl_cdecl_fn(ccx.llmod, ~\"amain\", llfty)\n         } else {\n-            decl_cdecl_fn(ccx.llmod, main_name(), llfty)\n+            let main_name = match ccx.sess.targ_cfg.os {\n+                session::os_win32 => ~\"WinMain@16\",\n+                _ => ~\"main\",\n+            };\n+            decl_cdecl_fn(ccx.llmod, main_name, llfty)\n         };\n         let llbb = str::as_c_str(~\"top\", |buf| {\n             unsafe {\n@@ -2284,25 +2284,14 @@ pub fn create_main_wrapper(ccx: @CrateContext,\n             let opaque_crate_map = llvm::LLVMBuildPointerCast(\n                 bld, crate_map, T_ptr(T_i8()), noname());\n \n-            if *ccx.sess.building_library {\n-                ~[\n-                    retptr,\n-                    C_null(T_opaque_box_ptr(ccx)),\n-                    opaque_rust_main,\n-                    llvm::LLVMConstInt(T_i32(), 0u as c_ulonglong, False),\n-                    llvm::LLVMConstInt(T_i32(), 0u as c_ulonglong, False),\n-                    opaque_crate_map\n-                ]\n-            } else {\n-                ~[\n-                    retptr,\n-                    C_null(T_opaque_box_ptr(ccx)),\n-                    opaque_rust_main,\n-                    llvm::LLVMGetParam(llfn, 0 as c_uint),\n-                    llvm::LLVMGetParam(llfn, 1 as c_uint),\n-                    opaque_crate_map\n-                ]\n-            }\n+            ~[\n+                retptr,\n+                C_null(T_opaque_box_ptr(ccx)),\n+                opaque_rust_main,\n+                llvm::LLVMGetParam(llfn, 0 as c_uint),\n+                llvm::LLVMGetParam(llfn, 1 as c_uint),\n+                opaque_crate_map\n+            ]\n         };\n \n         unsafe {"}, {"sha": "4ac3e0b1747297aa015016874cd41ac99dea2597", "filename": "src/libstd/fileinput.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/af1baa3befb18e8a22377197c20a7084ecb88848/src%2Flibstd%2Ffileinput.rs", "raw_url": "https://github.com/rust-lang/rust/raw/af1baa3befb18e8a22377197c20a7084ecb88848/src%2Flibstd%2Ffileinput.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Ffileinput.rs?ref=af1baa3befb18e8a22377197c20a7084ecb88848", "patch": "@@ -534,7 +534,7 @@ mod test {\n     fn test_empty_files() {\n         let filenames = pathify(vec::from_fn(\n             3,\n-            |i| fmt!(\"tmp/lib-fileinput-test-next-file-%u.tmp\", i)),true);\n+            |i| fmt!(\"tmp/lib-fileinput-test-empty-files-%u.tmp\", i)),true);\n \n         make_file(filenames[0].get_ref(), ~[~\"1\", ~\"2\"]);\n         make_file(filenames[1].get_ref(), ~[]);"}]}