{"sha": "5eca09793e9e6969ce960601d83300e1d6065d97", "node_id": "MDY6Q29tbWl0NzI0NzEyOjVlY2EwOTc5M2U5ZTY5NjljZTk2MDYwMWQ4MzMwMGUxZDYwNjVkOTc=", "commit": {"author": {"name": "Oliver Schneider", "email": "git-spam-no-reply9815368754983@oli-obk.de", "date": "2016-05-27T10:12:38Z"}, "committer": {"name": "Oliver Schneider", "email": "git-spam-no-reply9815368754983@oli-obk.de", "date": "2016-05-27T10:12:38Z"}, "message": "needless_borrow reported on &&T when only &T implements Trait and &Trait is required", "tree": {"sha": "d5c97e93948a09900dbb392b091cb0a2d8a875f5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d5c97e93948a09900dbb392b091cb0a2d8a875f5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5eca09793e9e6969ce960601d83300e1d6065d97", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\nVersion: GnuPG v1\n\niQIcBAABAgAGBQJXSB2WAAoJEFbW7qD8Z6xGst4P/ROLzPcsbPjhrPNPJQFXcS95\nTu53r0oI6IIvR2JjyTAoPGZW11M9pFoZZNQma2c+r+6sJflW3bVkPw1HKh+2NAPM\nEBY9w4ztOXpN/hYGV004H9/M5lPOAoAGc1VyLP4f5bTX2ELZWAJXvhZM2ZkNs1qP\nZIIwVBjAWBo5OEslLldofVLuEn2fPrGSuJ/pwhnk+Rd9nRwLYiWQCSx4BWgAwfcp\nENWaI4SxxLKo7ZLDHU9xbh/glW/hBwIWpCzhNccIT/Q1IlXdh9EVB5ScHnlhRY2q\nKkXTfGTtgETIGYiA4kJgB8hS2fyV5w7mkEZafI64ac/x4OJzfG2v2BkoUisEk2fJ\nfD+NaOhUUCJa/WH4jlbG38ID3fPzgTi3FZvyuptv30pTIrgIaKOV3ggSk+3LE4DF\nxtFPmn+/UShmXnYM3Aym8gziVcJXJwOk394cad6qax5nm2gPOpteN2W46COJNctm\naGOCJoE1/qU0a0Tdv02lyrR8aNMkr95exmU8Mo3j9epSJt0/DSzh24BUzOiNkEa8\nmcmMRIOeHN99q7W7hHYJYmGQ+C55k4+L197XCtkQXYaXx9lGP2MZKe2KdIbZ+O6T\nK6r3DYLmW+D7d+FOm+upf5Cey5P0E3wv4VlJJ2xgdTwtGzGBEth9E3jD7FDQ6nIF\nIDRP27WdBUF2oANRKXQh\n=7aOW\n-----END PGP SIGNATURE-----", "payload": "tree d5c97e93948a09900dbb392b091cb0a2d8a875f5\nparent 8ac545d0fe224791875ed939db787cb311fac406\nauthor Oliver Schneider <git-spam-no-reply9815368754983@oli-obk.de> 1464343958 +0200\ncommitter Oliver Schneider <git-spam-no-reply9815368754983@oli-obk.de> 1464343958 +0200\n\nneedless_borrow reported on &&T when only &T implements Trait and &Trait is required"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5eca09793e9e6969ce960601d83300e1d6065d97", "html_url": "https://github.com/rust-lang/rust/commit/5eca09793e9e6969ce960601d83300e1d6065d97", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5eca09793e9e6969ce960601d83300e1d6065d97/comments", "author": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "committer": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8ac545d0fe224791875ed939db787cb311fac406", "url": "https://api.github.com/repos/rust-lang/rust/commits/8ac545d0fe224791875ed939db787cb311fac406", "html_url": "https://github.com/rust-lang/rust/commit/8ac545d0fe224791875ed939db787cb311fac406"}], "stats": {"total": 24, "additions": 16, "deletions": 8}, "files": [{"sha": "033811841ce6f8b5401636bdfe58cb7537c7369e", "filename": "src/needless_borrow.rs", "status": "modified", "additions": 9, "deletions": 8, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/5eca09793e9e6969ce960601d83300e1d6065d97/src%2Fneedless_borrow.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5eca09793e9e6969ce960601d83300e1d6065d97/src%2Fneedless_borrow.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fneedless_borrow.rs?ref=5eca09793e9e6969ce960601d83300e1d6065d97", "patch": "@@ -3,9 +3,10 @@\n //! This lint is **warn** by default\n \n use rustc::lint::*;\n-use rustc::hir::*;\n+use rustc::hir::{ExprAddrOf, Expr, MutImmutable};\n use rustc::ty::TyRef;\n use utils::{span_lint, in_macro};\n+use rustc::ty::adjustment::AutoAdjustment::AdjustDerefRef;\n \n /// **What it does:** This lint checks for address of operations (`&`) that are going to be dereferenced immediately by the compiler\n ///\n@@ -36,13 +37,13 @@ impl LateLintPass for NeedlessBorrow {\n         }\n         if let ExprAddrOf(MutImmutable, ref inner) = e.node {\n             if let TyRef(..) = cx.tcx.expr_ty(inner).sty {\n-                let ty = cx.tcx.expr_ty(e);\n-                let adj_ty = cx.tcx.expr_ty_adjusted(e);\n-                if ty != adj_ty {\n-                    span_lint(cx,\n-                              NEEDLESS_BORROW,\n-                              e.span,\n-                              \"this expression borrows a reference that is immediately dereferenced by the compiler\");\n+                if let Some(&AdjustDerefRef(ref deref)) = cx.tcx.tables.borrow().adjustments.get(&e.id) {\n+                    if deref.autoderefs > 1 && deref.autoref.is_some() {\n+                        span_lint(cx,\n+                                  NEEDLESS_BORROW,\n+                                  e.span,\n+                                  \"this expression borrows a reference that is immediately dereferenced by the compiler\");\n+                    }\n                 }\n             }\n         }"}, {"sha": "602e1e0859b8f83b26d0e07027cece6507853e41", "filename": "tests/compile-fail/needless_borrow.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/5eca09793e9e6969ce960601d83300e1d6065d97/tests%2Fcompile-fail%2Fneedless_borrow.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5eca09793e9e6969ce960601d83300e1d6065d97/tests%2Fcompile-fail%2Fneedless_borrow.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Fneedless_borrow.rs?ref=5eca09793e9e6969ce960601d83300e1d6065d97", "patch": "@@ -16,6 +16,7 @@ fn main() {\n     let g_val = g(&Vec::new()); // should not error, because `&Vec<T>` derefs to `&[T]`\n     let vec = Vec::new();\n     let vec_val = g(&vec); // should not error, because `&Vec<T>` derefs to `&[T]`\n+    h(&\"foo\"); // should not error, because the `&&str` is required, due to `&Trait`\n }\n \n fn f<T:Copy>(y: &T) -> T {\n@@ -25,3 +26,9 @@ fn f<T:Copy>(y: &T) -> T {\n fn g(y: &[u8]) -> u8 {\n     y[0]\n }\n+\n+trait Trait {}\n+\n+impl<'a> Trait for &'a str {}\n+\n+fn h(_: &Trait) {}"}]}