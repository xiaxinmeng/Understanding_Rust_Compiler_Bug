{"sha": "d634364462931c0a4944de29b38681a482817b6b", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQ2MzQzNjQ0NjI5MzFjMGE0OTQ0ZGUyOWIzODY4MWE0ODI4MTdiNmI=", "commit": {"author": {"name": "Matthias Einwag", "email": "matthias.einwag@live.com", "date": "2019-11-10T21:15:47Z"}, "committer": {"name": "Matthias Einwag", "email": "matthias.einwag@live.com", "date": "2019-11-10T21:15:47Z"}, "message": "Overwrite the prelude with one defined in a later dependency\n\nThis removes the special casing for the \"core\" prelude.\nWhenever a later dependency also exports a prelude, it will replace\nthe formerly imported prelude.  The utilized prelude then depends\npurely on import order.", "tree": {"sha": "e55d40fa70e9e1122aecbe66f258073b2c3d7a43", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e55d40fa70e9e1122aecbe66f258073b2c3d7a43"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d634364462931c0a4944de29b38681a482817b6b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d634364462931c0a4944de29b38681a482817b6b", "html_url": "https://github.com/rust-lang/rust/commit/d634364462931c0a4944de29b38681a482817b6b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d634364462931c0a4944de29b38681a482817b6b/comments", "author": {"login": "Matthias247", "id": 6330334, "node_id": "MDQ6VXNlcjYzMzAzMzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/6330334?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Matthias247", "html_url": "https://github.com/Matthias247", "followers_url": "https://api.github.com/users/Matthias247/followers", "following_url": "https://api.github.com/users/Matthias247/following{/other_user}", "gists_url": "https://api.github.com/users/Matthias247/gists{/gist_id}", "starred_url": "https://api.github.com/users/Matthias247/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Matthias247/subscriptions", "organizations_url": "https://api.github.com/users/Matthias247/orgs", "repos_url": "https://api.github.com/users/Matthias247/repos", "events_url": "https://api.github.com/users/Matthias247/events{/privacy}", "received_events_url": "https://api.github.com/users/Matthias247/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Matthias247", "id": 6330334, "node_id": "MDQ6VXNlcjYzMzAzMzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/6330334?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Matthias247", "html_url": "https://github.com/Matthias247", "followers_url": "https://api.github.com/users/Matthias247/followers", "following_url": "https://api.github.com/users/Matthias247/following{/other_user}", "gists_url": "https://api.github.com/users/Matthias247/gists{/gist_id}", "starred_url": "https://api.github.com/users/Matthias247/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Matthias247/subscriptions", "organizations_url": "https://api.github.com/users/Matthias247/orgs", "repos_url": "https://api.github.com/users/Matthias247/repos", "events_url": "https://api.github.com/users/Matthias247/events{/privacy}", "received_events_url": "https://api.github.com/users/Matthias247/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8baa05666c455b4dd6333fd5ac1a694136039f43", "url": "https://api.github.com/repos/rust-lang/rust/commits/8baa05666c455b4dd6333fd5ac1a694136039f43", "html_url": "https://github.com/rust-lang/rust/commit/8baa05666c455b4dd6333fd5ac1a694136039f43"}], "stats": {"total": 17, "additions": 8, "deletions": 9}, "files": [{"sha": "6db9937a43212880e162f9519c8ff9bba5a59361", "filename": "crates/ra_hir_def/src/nameres/collector.rs", "status": "modified", "additions": 6, "deletions": 9, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/d634364462931c0a4944de29b38681a482817b6b/crates%2Fra_hir_def%2Fsrc%2Fnameres%2Fcollector.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d634364462931c0a4944de29b38681a482817b6b/crates%2Fra_hir_def%2Fsrc%2Fnameres%2Fcollector.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_def%2Fsrc%2Fnameres%2Fcollector.rs?ref=d634364462931c0a4944de29b38681a482817b6b", "patch": "@@ -27,7 +27,6 @@ pub(super) fn collect_defs(db: &impl DefDatabase2, mut def_map: CrateDefMap) ->\n     let crate_graph = db.crate_graph();\n \n     // populate external prelude\n-    let mut prelude_is_core = false;\n     for dep in crate_graph.dependencies(def_map.krate) {\n         let dep_def_map = db.crate_def_map(dep.crate_id);\n         log::debug!(\"crate dep {:?} -> {:?}\", dep.name, dep.crate_id);\n@@ -37,14 +36,12 @@ pub(super) fn collect_defs(db: &impl DefDatabase2, mut def_map: CrateDefMap) ->\n         );\n \n         // look for the prelude\n-        // If the prelude is the \"core\" prelude, try to replace it with a higher\n-        // level prelude (e.g. \"std\") if available.\n-        if def_map.prelude.is_none() || prelude_is_core {\n-            let map = db.crate_def_map(dep.crate_id);\n-            if map.prelude.is_some() {\n-                def_map.prelude = map.prelude;\n-                prelude_is_core = dep.name == \"core\";\n-            }\n+        // If the dependency defines a prelude, we overwrite an already defined\n+        // prelude. This is necessary to import the \"std\" prelude if a crate\n+        // depends on both \"core\" and \"std\".\n+        let dep_def_map = db.crate_def_map(dep.crate_id);\n+        if dep_def_map.prelude.is_some() {\n+            def_map.prelude = dep_def_map.prelude;\n         }\n     }\n "}, {"sha": "0e14f1b70c9ffa0f516f4dcba4cb68f1da1b55b6", "filename": "crates/ra_project_model/src/lib.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d634364462931c0a4944de29b38681a482817b6b/crates%2Fra_project_model%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d634364462931c0a4944de29b38681a482817b6b/crates%2Fra_project_model%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_project_model%2Fsrc%2Flib.rs?ref=d634364462931c0a4944de29b38681a482817b6b", "patch": "@@ -241,6 +241,8 @@ impl ProjectWorkspace {\n                                 }\n                             }\n                         }\n+                        // core is added as a dependency before std in order to\n+                        // mimic rustcs dependency order\n                         if let Some(core) = libcore {\n                             if let Err(_) = crate_graph.add_dep(from, \"core\".into(), core) {\n                                 log::error!(\"cyclic dependency on core for {}\", pkg.name(&cargo))"}]}