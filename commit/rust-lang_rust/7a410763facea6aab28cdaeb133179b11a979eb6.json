{"sha": "7a410763facea6aab28cdaeb133179b11a979eb6", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdhNDEwNzYzZmFjZWE2YWFiMjhjZGFlYjEzMzE3OWIxMWE5NzllYjY=", "commit": {"author": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2021-07-01T00:00:00Z"}, "committer": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2021-07-01T11:30:00Z"}, "message": "Avoid byte to char position conversions in is_multiline\n\nConverting a byte position into a char position is currently linear in\nthe number of multibyte characters in the source code. Avoid it when\nchecking if a range spans across lines.\n\nThis makes it feasible to compile source files with a large number of\nmultibyte characters.", "tree": {"sha": "c44f9470f57a74d537efe4a48044890b26e77ac4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c44f9470f57a74d537efe4a48044890b26e77ac4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7a410763facea6aab28cdaeb133179b11a979eb6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7a410763facea6aab28cdaeb133179b11a979eb6", "html_url": "https://github.com/rust-lang/rust/commit/7a410763facea6aab28cdaeb133179b11a979eb6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7a410763facea6aab28cdaeb133179b11a979eb6/comments", "author": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f8ac8fdacf66b351c6479b0c8313e3e57e571ba4", "url": "https://api.github.com/repos/rust-lang/rust/commits/f8ac8fdacf66b351c6479b0c8313e3e57e571ba4", "html_url": "https://github.com/rust-lang/rust/commit/f8ac8fdacf66b351c6479b0c8313e3e57e571ba4"}], "stats": {"total": 10, "additions": 7, "deletions": 3}, "files": [{"sha": "77a3ad931d5717343eef8355a25a6c529ff11793", "filename": "compiler/rustc_span/src/source_map.rs", "status": "modified", "additions": 7, "deletions": 3, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/7a410763facea6aab28cdaeb133179b11a979eb6/compiler%2Frustc_span%2Fsrc%2Fsource_map.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7a410763facea6aab28cdaeb133179b11a979eb6/compiler%2Frustc_span%2Fsrc%2Fsource_map.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_span%2Fsrc%2Fsource_map.rs?ref=7a410763facea6aab28cdaeb133179b11a979eb6", "patch": "@@ -461,9 +461,13 @@ impl SourceMap {\n     }\n \n     pub fn is_multiline(&self, sp: Span) -> bool {\n-        let lo = self.lookup_char_pos(sp.lo());\n-        let hi = self.lookup_char_pos(sp.hi());\n-        lo.line != hi.line\n+        let lo = self.lookup_source_file_idx(sp.lo());\n+        let hi = self.lookup_source_file_idx(sp.hi());\n+        if lo != hi {\n+            return true;\n+        }\n+        let f = (*self.files.borrow().source_files)[lo].clone();\n+        f.lookup_line(sp.lo()) != f.lookup_line(sp.hi())\n     }\n \n     pub fn is_valid_span(&self, sp: Span) -> Result<(Loc, Loc), SpanLinesError> {"}]}