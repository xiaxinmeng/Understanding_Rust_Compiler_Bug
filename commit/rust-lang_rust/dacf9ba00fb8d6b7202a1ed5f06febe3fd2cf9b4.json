{"sha": "dacf9ba00fb8d6b7202a1ed5f06febe3fd2cf9b4", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRhY2Y5YmEwMGZiOGQ2YjcyMDJhMWVkNWYwNmZlYmUzZmQyY2Y5YjQ=", "commit": {"author": {"name": "John K\u00e5re Alsaker", "email": "john.kare.alsaker@gmail.com", "date": "2018-04-01T06:27:09Z"}, "committer": {"name": "John K\u00e5re Alsaker", "email": "john.kare.alsaker@gmail.com", "date": "2018-04-10T12:40:26Z"}, "message": "Make Session.injected_allocator and Session.allocator_kind thread-safe", "tree": {"sha": "e4415c86c1f462c2c7c9a7984fc062fb015e7e45", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e4415c86c1f462c2c7c9a7984fc062fb015e7e45"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/dacf9ba00fb8d6b7202a1ed5f06febe3fd2cf9b4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/dacf9ba00fb8d6b7202a1ed5f06febe3fd2cf9b4", "html_url": "https://github.com/rust-lang/rust/commit/dacf9ba00fb8d6b7202a1ed5f06febe3fd2cf9b4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/dacf9ba00fb8d6b7202a1ed5f06febe3fd2cf9b4/comments", "author": {"login": "Zoxc", "id": 25784, "node_id": "MDQ6VXNlcjI1Nzg0", "avatar_url": "https://avatars.githubusercontent.com/u/25784?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Zoxc", "html_url": "https://github.com/Zoxc", "followers_url": "https://api.github.com/users/Zoxc/followers", "following_url": "https://api.github.com/users/Zoxc/following{/other_user}", "gists_url": "https://api.github.com/users/Zoxc/gists{/gist_id}", "starred_url": "https://api.github.com/users/Zoxc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Zoxc/subscriptions", "organizations_url": "https://api.github.com/users/Zoxc/orgs", "repos_url": "https://api.github.com/users/Zoxc/repos", "events_url": "https://api.github.com/users/Zoxc/events{/privacy}", "received_events_url": "https://api.github.com/users/Zoxc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Zoxc", "id": 25784, "node_id": "MDQ6VXNlcjI1Nzg0", "avatar_url": "https://avatars.githubusercontent.com/u/25784?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Zoxc", "html_url": "https://github.com/Zoxc", "followers_url": "https://api.github.com/users/Zoxc/followers", "following_url": "https://api.github.com/users/Zoxc/following{/other_user}", "gists_url": "https://api.github.com/users/Zoxc/gists{/gist_id}", "starred_url": "https://api.github.com/users/Zoxc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Zoxc/subscriptions", "organizations_url": "https://api.github.com/users/Zoxc/orgs", "repos_url": "https://api.github.com/users/Zoxc/repos", "events_url": "https://api.github.com/users/Zoxc/events{/privacy}", "received_events_url": "https://api.github.com/users/Zoxc/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "66488a50f9752a87a6947f9284f5a3f6cb61301c", "url": "https://api.github.com/repos/rust-lang/rust/commits/66488a50f9752a87a6947f9284f5a3f6cb61301c", "html_url": "https://github.com/rust-lang/rust/commit/66488a50f9752a87a6947f9284f5a3f6cb61301c"}], "stats": {"total": 18, "additions": 13, "deletions": 5}, "files": [{"sha": "a92a2c916b266f3eae0e431e208a20829edb5915", "filename": "src/librustc/session/mod.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/dacf9ba00fb8d6b7202a1ed5f06febe3fd2cf9b4/src%2Flibrustc%2Fsession%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dacf9ba00fb8d6b7202a1ed5f06febe3fd2cf9b4/src%2Flibrustc%2Fsession%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fsession%2Fmod.rs?ref=dacf9ba00fb8d6b7202a1ed5f06febe3fd2cf9b4", "patch": "@@ -118,8 +118,8 @@ pub struct Session {\n     /// The metadata::creader module may inject an allocator/panic_runtime\n     /// dependency if it didn't already find one, and this tracks what was\n     /// injected.\n-    pub injected_allocator: Cell<Option<CrateNum>>,\n-    pub allocator_kind: Cell<Option<AllocatorKind>>,\n+    pub injected_allocator: Once<Option<CrateNum>>,\n+    pub allocator_kind: Once<Option<AllocatorKind>>,\n     pub injected_panic_runtime: Cell<Option<CrateNum>>,\n \n     /// Map from imported macro spans (which consist of\n@@ -1105,8 +1105,8 @@ pub fn build_session_(\n         const_eval_stack_frame_limit: 100,\n         const_eval_step_limit: 1_000_000,\n         next_node_id: OneThread::new(Cell::new(NodeId::new(1))),\n-        injected_allocator: Cell::new(None),\n-        allocator_kind: Cell::new(None),\n+        injected_allocator: Once::new(),\n+        allocator_kind: Once::new(),\n         injected_panic_runtime: Cell::new(None),\n         imported_macro_spans: OneThread::new(RefCell::new(HashMap::new())),\n         incr_comp_session: OneThread::new(RefCell::new(IncrCompSession::NotInitialized)),"}, {"sha": "06baea53cd535461bc206cd535853f81b62d129a", "filename": "src/librustc_metadata/creader.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/dacf9ba00fb8d6b7202a1ed5f06febe3fd2cf9b4/src%2Flibrustc_metadata%2Fcreader.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dacf9ba00fb8d6b7202a1ed5f06febe3fd2cf9b4/src%2Flibrustc_metadata%2Fcreader.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Fcreader.rs?ref=dacf9ba00fb8d6b7202a1ed5f06febe3fd2cf9b4", "patch": "@@ -823,6 +823,8 @@ impl<'a> CrateLoader<'a> {\n             needs_allocator = needs_allocator || data.needs_allocator(self.sess);\n         });\n         if !needs_allocator {\n+            self.sess.injected_allocator.set(None);\n+            self.sess.allocator_kind.set(None);\n             return\n         }\n \n@@ -842,6 +844,8 @@ impl<'a> CrateLoader<'a> {\n             }\n         }\n         if !need_lib_alloc && !need_exe_alloc {\n+            self.sess.injected_allocator.set(None);\n+            self.sess.allocator_kind.set(None);\n             return\n         }\n \n@@ -879,6 +883,7 @@ impl<'a> CrateLoader<'a> {\n         });\n         if global_allocator.is_some() {\n             self.sess.allocator_kind.set(Some(AllocatorKind::Global));\n+            self.sess.injected_allocator.set(None);\n             return\n         }\n \n@@ -922,6 +927,9 @@ impl<'a> CrateLoader<'a> {\n             };\n \n         let allocation_crate_data = exe_allocation_crate_data.or_else(|| {\n+            // No allocator was injected\n+            self.sess.injected_allocator.set(None);\n+\n             if attr::contains_name(&krate.attrs, \"default_lib_allocator\") {\n                 // Prefer self as the allocator if there's a collision\n                 return None;"}, {"sha": "f181275326c7133a141ca57144f7d0493b36aa79", "filename": "src/librustc_trans/base.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/dacf9ba00fb8d6b7202a1ed5f06febe3fd2cf9b4/src%2Flibrustc_trans%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dacf9ba00fb8d6b7202a1ed5f06febe3fd2cf9b4/src%2Flibrustc_trans%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Fbase.rs?ref=dacf9ba00fb8d6b7202a1ed5f06febe3fd2cf9b4", "patch": "@@ -795,7 +795,7 @@ pub fn trans_crate<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>,\n         codegen_units.len());\n \n     // Translate an allocator shim, if any\n-    let allocator_module = if let Some(kind) = tcx.sess.allocator_kind.get() {\n+    let allocator_module = if let Some(kind) = *tcx.sess.allocator_kind.get() {\n         unsafe {\n             let llmod_id = \"allocator\";\n             let (llcx, llmod) ="}]}