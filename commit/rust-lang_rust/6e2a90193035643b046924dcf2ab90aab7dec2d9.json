{"sha": "6e2a90193035643b046924dcf2ab90aab7dec2d9", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZlMmE5MDE5MzAzNTY0M2IwNDY5MjRkY2YyYWI5MGFhYjdkZWMyZDk=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2016-12-20T19:16:42Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2016-12-20T20:59:08Z"}, "message": "Rollup merge of #38468 - xen0n:tarball-wrangling, r=alexcrichton\n\nrustbuild: Eliminate duplication of dist tarballs\n\nFixes #38365 by not constructing the duplicate steps in the first place, as suggested. The source package step is lacking the check as in other steps, so it is added as well.\n\nTested locally with the `alexcrichton/rust-slave-linux-cross:2016-11-11` container (with the build slave init replaced with no-op, of course).\n\nr? @alexcrichton", "tree": {"sha": "b848a2483eef093df1a857d18e51ff4fd5a41c0b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b848a2483eef093df1a857d18e51ff4fd5a41c0b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6e2a90193035643b046924dcf2ab90aab7dec2d9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6e2a90193035643b046924dcf2ab90aab7dec2d9", "html_url": "https://github.com/rust-lang/rust/commit/6e2a90193035643b046924dcf2ab90aab7dec2d9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6e2a90193035643b046924dcf2ab90aab7dec2d9/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cade120da3bea3e26019b0a8c94d26ec7e136261", "url": "https://api.github.com/repos/rust-lang/rust/commits/cade120da3bea3e26019b0a8c94d26ec7e136261", "html_url": "https://github.com/rust-lang/rust/commit/cade120da3bea3e26019b0a8c94d26ec7e136261"}, {"sha": "8e38b2de42dda1752400524b69f76051586d469b", "url": "https://api.github.com/repos/rust-lang/rust/commits/8e38b2de42dda1752400524b69f76051586d469b", "html_url": "https://github.com/rust-lang/rust/commit/8e38b2de42dda1752400524b69f76051586d469b"}], "stats": {"total": 21, "additions": 18, "deletions": 3}, "files": [{"sha": "6e3174ed2f6d00cc6939c9f61f96414fe9634dd2", "filename": "src/bootstrap/dist.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/6e2a90193035643b046924dcf2ab90aab7dec2d9/src%2Fbootstrap%2Fdist.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6e2a90193035643b046924dcf2ab90aab7dec2d9/src%2Fbootstrap%2Fdist.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fdist.rs?ref=6e2a90193035643b046924dcf2ab90aab7dec2d9", "patch": "@@ -346,8 +346,14 @@ pub fn analysis(build: &Build, compiler: &Compiler, target: &str) {\n }\n \n /// Creates the `rust-src` installer component and the plain source tarball\n-pub fn rust_src(build: &Build) {\n+pub fn rust_src(build: &Build, host: &str) {\n     println!(\"Dist src\");\n+\n+    if host != build.config.build {\n+        println!(\"\\tskipping, not a build host\");\n+        return\n+    }\n+\n     let plain_name = format!(\"rustc-{}-src\", package_vers(build));\n     let name = format!(\"rust-src-{}\", package_vers(build));\n     let image = tmpdir(build).join(format!(\"{}-image\", name));"}, {"sha": "5b3ce2ea5bcef037cc0acb98b0a41be6c5f7cd9a", "filename": "src/bootstrap/step.rs", "status": "modified", "additions": 11, "deletions": 2, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/6e2a90193035643b046924dcf2ab90aab7dec2d9/src%2Fbootstrap%2Fstep.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6e2a90193035643b046924dcf2ab90aab7dec2d9/src%2Fbootstrap%2Fstep.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fstep.rs?ref=6e2a90193035643b046924dcf2ab90aab7dec2d9", "patch": "@@ -496,7 +496,7 @@ pub fn build_rules(build: &Build) -> Rules {\n     rules.dist(\"dist-src\", \"src\")\n          .default(true)\n          .host(true)\n-         .run(move |_| dist::rust_src(build));\n+         .run(move |s| dist::rust_src(build, s.target));\n     rules.dist(\"dist-docs\", \"src/doc\")\n          .default(true)\n          .dep(|s| s.name(\"default:doc\"))\n@@ -820,7 +820,16 @@ invalid rule dependency graph detected, was a rule added and maybe typo'd?\n             let hosts = if self.build.flags.host.len() > 0 {\n                 &self.build.flags.host\n             } else {\n-                &self.build.config.host\n+                if kind == Kind::Dist {\n+                    // For 'dist' steps we only distribute artifacts built from\n+                    // the build platform, so only consider that in the hosts\n+                    // array.\n+                    // NOTE: This relies on the fact that the build triple is\n+                    // always placed first, as done in `config.rs`.\n+                    &self.build.config.host[..1]\n+                } else {\n+                    &self.build.config.host\n+                }\n             };\n             let targets = if self.build.flags.target.len() > 0 {\n                 &self.build.flags.target"}]}