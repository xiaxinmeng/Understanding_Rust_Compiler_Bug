{"sha": "c97922dca563cb7f9385b18dbf7ca8c97f8e1597", "node_id": "C_kwDOAAsO6NoAKGM5NzkyMmRjYTU2M2NiN2Y5Mzg1YjE4ZGJmN2NhOGM5N2Y4ZTE1OTc", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-09-14T08:21:25Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-09-14T08:21:25Z"}, "message": "Auto merge of #99443 - jam1garner:mips-virt-feature, r=nagisa\n\nAdd support for MIPS VZ ISA extension\n\n[Link to relevant LLVM line where virt extension is specified](https://github.com/llvm/llvm-project/blob/83fab8cee9d6b9fa911195c20325b4512a7a22ef/llvm/lib/Target/Mips/Mips.td#L172-L173)\n\nThis has been tested on mips-unknown-linux-musl with a target-cpu that is >= MIPS32 5 and `target-features=+virt`. The example was checked in a disassembler to ensure the correct assembly sequence was being generated using the virtualization instructions.\n\nNeeded additional work:\n\n* MIPS is missing from [the Rust reference CPU feature lists](https://doc.rust-lang.org/reference/attributes/codegen.html#available-features)\n\nExample docs for later:\n\n```md\n#### `mips` or `mips64`\n\nThis platform requires that `#[target_feature]` is only applied to [`unsafe`\nfunctions][unsafe function]. This target's feature support is currently unstable\nand must be enabled by `#![feature(mips_target_feature)]` ([Issue #44839])\n\n[Issue #44839]: https://github.com/rust-lang/rust/issues/44839\n\nFurther documentation on these features can be found in the [MIPS Instruction Set\nReference Manual], or elsewhere on [mips.com].\n\n[MIPS Instruction Set Reference Manual]: https://s3-eu-west-1.amazonaws.com/downloads-mips/documents/MD00086-2B-MIPS32BIS-AFP-6.06.pdf\n[developer.arm.com]: https://www.mips.com/products/architectures/ase/\n\nFeature        | Implicitly Enables | Description\n---------------|--------------------|-------------------\n`fp64`         |                    | 64-bit Floating Point\n`msa`          |                    | \"MIPS SIMD Architecture\"\n`virt`         |                    | Virtualization instructions (VZ ASE)\n```\n\nIf the above is good I can also submit a PR for that if there's interest in documenting it while it's still unstable. Otherwise that can be dropped, I just wrote it before realizing it was possibly not a good idea.\n\nRelevant to #44839", "tree": {"sha": "f519e779470b773f49f19656416c2b994c8c7f69", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f519e779470b773f49f19656416c2b994c8c7f69"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c97922dca563cb7f9385b18dbf7ca8c97f8e1597", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c97922dca563cb7f9385b18dbf7ca8c97f8e1597", "html_url": "https://github.com/rust-lang/rust/commit/c97922dca563cb7f9385b18dbf7ca8c97f8e1597", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c97922dca563cb7f9385b18dbf7ca8c97f8e1597/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a0d1df4a5d6ed476e02ad46031dfcdb123fc0e84", "url": "https://api.github.com/repos/rust-lang/rust/commits/a0d1df4a5d6ed476e02ad46031dfcdb123fc0e84", "html_url": "https://github.com/rust-lang/rust/commit/a0d1df4a5d6ed476e02ad46031dfcdb123fc0e84"}, {"sha": "bec3a545a55590dd8029bad61d5ea18416c4caf8", "url": "https://api.github.com/repos/rust-lang/rust/commits/bec3a545a55590dd8029bad61d5ea18416c4caf8", "html_url": "https://github.com/rust-lang/rust/commit/bec3a545a55590dd8029bad61d5ea18416c4caf8"}], "stats": {"total": 11, "additions": 9, "deletions": 2}, "files": [{"sha": "60707a1c34e854df122c2dcacafb54846d10d87a", "filename": "compiler/rustc_codegen_llvm/src/llvm_util.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/c97922dca563cb7f9385b18dbf7ca8c97f8e1597/compiler%2Frustc_codegen_llvm%2Fsrc%2Fllvm_util.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c97922dca563cb7f9385b18dbf7ca8c97f8e1597/compiler%2Frustc_codegen_llvm%2Fsrc%2Fllvm_util.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fllvm_util.rs?ref=c97922dca563cb7f9385b18dbf7ca8c97f8e1597", "patch": "@@ -154,6 +154,10 @@ pub fn time_trace_profiler_finish(file_name: &Path) {\n //\n // To find a list of LLVM's names, check llvm-project/llvm/include/llvm/Support/*TargetParser.def\n // where the * matches the architecture's name\n+//\n+// For targets not present in the above location, see llvm-project/llvm/lib/Target/{ARCH}/*.td\n+// where `{ARCH}` is the architecture name. Look for instances of `SubtargetFeature`.\n+//\n // Beware to not use the llvm github project for this, but check the git submodule\n // found in src/llvm-project\n // Though note that Rust can also be build with an external precompiled version of LLVM"}, {"sha": "0e259bcd1a48dc1cddbb8f573a3f8c8dcf662935", "filename": "compiler/rustc_codegen_ssa/src/target_features.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/c97922dca563cb7f9385b18dbf7ca8c97f8e1597/compiler%2Frustc_codegen_ssa%2Fsrc%2Ftarget_features.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c97922dca563cb7f9385b18dbf7ca8c97f8e1597/compiler%2Frustc_codegen_ssa%2Fsrc%2Ftarget_features.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Ftarget_features.rs?ref=c97922dca563cb7f9385b18dbf7ca8c97f8e1597", "patch": "@@ -210,8 +210,11 @@ const POWERPC_ALLOWED_FEATURES: &[(&str, Option<Symbol>)] = &[\n     (\"vsx\", Some(sym::powerpc_target_feature)),\n ];\n \n-const MIPS_ALLOWED_FEATURES: &[(&str, Option<Symbol>)] =\n-    &[(\"fp64\", Some(sym::mips_target_feature)), (\"msa\", Some(sym::mips_target_feature))];\n+const MIPS_ALLOWED_FEATURES: &[(&str, Option<Symbol>)] = &[\n+    (\"fp64\", Some(sym::mips_target_feature)),\n+    (\"msa\", Some(sym::mips_target_feature)),\n+    (\"virt\", Some(sym::mips_target_feature)),\n+];\n \n const RISCV_ALLOWED_FEATURES: &[(&str, Option<Symbol>)] = &[\n     (\"m\", Some(sym::riscv_target_feature)),"}]}