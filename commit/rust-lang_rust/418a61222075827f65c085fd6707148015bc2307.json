{"sha": "418a61222075827f65c085fd6707148015bc2307", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQxOGE2MTIyMjA3NTgyN2Y2NWMwODVmZDY3MDcxNDgwMTViYzIzMDc=", "commit": {"author": {"name": "Nick Cameron", "email": "nrc@ncameron.org", "date": "2018-02-13T23:10:08Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2018-02-13T23:10:08Z"}, "message": "Merge pull request #2440 from topecongiro/issue-2439\n\nDisable formatting macro-def if args do not fit on one line", "tree": {"sha": "d5b73b32a42b4a70ae0d59ccc1cc73f42217d6fd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d5b73b32a42b4a70ae0d59ccc1cc73f42217d6fd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/418a61222075827f65c085fd6707148015bc2307", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJag3BQCRBK7hj4Ov3rIwAAdHIIAII8Zcda6R1+gDzHRxtyklrP\nIIkGXRAC1HUXGgHMRH1VuH1GRQnmQFPgwHmZZzEadJOqPXss73dufh1BQ1V/GRr0\nV3S1rxDyr79XXOJVWe7PX9ztzxyMGqiv0Pr1VaI3jUeDWRaht1s5w1hq20R5JgYy\ng1CHdfGe1Z0T9XvuEILP+Jb/VXah3FxrYT6hvdqT6zJ2FzFaOn+64rgNrxZkBya0\nCn4GVG6iynh6EsmJ9p/+TK78SwpRslYg4X0XISy44coqct+R3SzSx1QGHaoH1Gx1\nNXj7HLw8eu5/0NPmVxsc8UvJ3xDDwCyAHVndP+jwsOn3esbj6wFrRD4aGASkmwY=\n=V31k\n-----END PGP SIGNATURE-----\n", "payload": "tree d5b73b32a42b4a70ae0d59ccc1cc73f42217d6fd\nparent 9cbda9062f35c2c34b4a20a60e08565c9099fdef\nparent b49b30746d8276b833c058fde88073800a1fdf82\nauthor Nick Cameron <nrc@ncameron.org> 1518563408 +1300\ncommitter GitHub <noreply@github.com> 1518563408 +1300\n\nMerge pull request #2440 from topecongiro/issue-2439\n\nDisable formatting macro-def if args do not fit on one line"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/418a61222075827f65c085fd6707148015bc2307", "html_url": "https://github.com/rust-lang/rust/commit/418a61222075827f65c085fd6707148015bc2307", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/418a61222075827f65c085fd6707148015bc2307/comments", "author": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9cbda9062f35c2c34b4a20a60e08565c9099fdef", "url": "https://api.github.com/repos/rust-lang/rust/commits/9cbda9062f35c2c34b4a20a60e08565c9099fdef", "html_url": "https://github.com/rust-lang/rust/commit/9cbda9062f35c2c34b4a20a60e08565c9099fdef"}, {"sha": "b49b30746d8276b833c058fde88073800a1fdf82", "url": "https://api.github.com/repos/rust-lang/rust/commits/b49b30746d8276b833c058fde88073800a1fdf82", "html_url": "https://github.com/rust-lang/rust/commit/b49b30746d8276b833c058fde88073800a1fdf82"}], "stats": {"total": 43, "additions": 37, "deletions": 6}, "files": [{"sha": "a8a8c28c585b28f3b28fbce04a2b939a053f3c6c", "filename": "rustfmt-core/src/macros.rs", "status": "modified", "additions": 17, "deletions": 6, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/418a61222075827f65c085fd6707148015bc2307/rustfmt-core%2Fsrc%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/418a61222075827f65c085fd6707148015bc2307/rustfmt-core%2Fsrc%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/rustfmt-core%2Fsrc%2Fmacros.rs?ref=418a61222075827f65c085fd6707148015bc2307", "patch": "@@ -431,7 +431,8 @@ fn replace_names(input: &str) -> Option<(String, HashMap<String, String>)> {\n // and `(`/`)` have special meaning.\n //\n // We always try and format on one line.\n-fn format_macro_args(toks: ThinTokenStream) -> Option<String> {\n+// FIXME: Use multi-line when every thing does not fit on one line.\n+fn format_macro_args(toks: ThinTokenStream, shape: Shape) -> Option<String> {\n     let mut result = String::with_capacity(128);\n     let mut insert_space = SpaceState::Never;\n \n@@ -459,7 +460,7 @@ fn format_macro_args(toks: ThinTokenStream) -> Option<String> {\n                 if let SpaceState::Always = insert_space {\n                     result.push(' ');\n                 }\n-                let formatted = format_macro_args(d.tts)?;\n+                let formatted = format_macro_args(d.tts, shape)?;\n                 match d.delim {\n                     DelimToken::Paren => {\n                         result.push_str(&format!(\"({})\", formatted));\n@@ -482,7 +483,11 @@ fn format_macro_args(toks: ThinTokenStream) -> Option<String> {\n         }\n     }\n \n-    Some(result)\n+    if result.len() <= shape.width {\n+        Some(result)\n+    } else {\n+        None\n+    }\n }\n \n // We should insert a space if the next token is a:\n@@ -617,7 +622,7 @@ fn macro_style(mac: &ast::Mac, context: &RewriteContext) -> MacroStyle {\n ///         a,\n ///         b,\n ///         c,\n-//      ),\n+///     ),\n /// }\n /// ```\n fn indent_macro_snippet(\n@@ -757,7 +762,8 @@ impl MacroBranch {\n             return None;\n         }\n \n-        let mut result = format_macro_args(self.args.clone())?;\n+        // 5 = \" => {\"\n+        let mut result = format_macro_args(self.args.clone(), shape.sub_width(5)?)?;\n \n         if multi_branch_style {\n             result += \" =>\";\n@@ -847,7 +853,12 @@ mod test {\n             &ParseSess::new(FilePathMapping::empty()),\n             None,\n         );\n-        format_macro_args(input.into()).unwrap()\n+        let shape = Shape {\n+            width: 100,\n+            indent: Indent::empty(),\n+            offset: 0,\n+        };\n+        format_macro_args(input.into(), shape).unwrap()\n     }\n \n     #[test]"}, {"sha": "ed5f7e16c04755e5c982a76cb0e6f00c785410d1", "filename": "rustfmt-core/tests/source/macro_rules.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/418a61222075827f65c085fd6707148015bc2307/rustfmt-core%2Ftests%2Fsource%2Fmacro_rules.rs", "raw_url": "https://github.com/rust-lang/rust/raw/418a61222075827f65c085fd6707148015bc2307/rustfmt-core%2Ftests%2Fsource%2Fmacro_rules.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/rustfmt-core%2Ftests%2Fsource%2Fmacro_rules.rs?ref=418a61222075827f65c085fd6707148015bc2307", "patch": "@@ -49,3 +49,13 @@ macro m2 {\n \tmod macro_item    {  struct $item ; }\n }\n }\n+\n+// #2439\n+macro_rules! m {\n+    (\n+        $line0_xxxxxxxxxxxxxxxxx: expr,\n+        $line1_xxxxxxxxxxxxxxxxx: expr,\n+        $line2_xxxxxxxxxxxxxxxxx: expr,\n+        $line3_xxxxxxxxxxxxxxxxx: expr,\n+    ) => {};\n+}"}, {"sha": "ef4a59e38cd4a40419de909477f1d31cbff45670", "filename": "rustfmt-core/tests/target/macro_rules.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/418a61222075827f65c085fd6707148015bc2307/rustfmt-core%2Ftests%2Ftarget%2Fmacro_rules.rs", "raw_url": "https://github.com/rust-lang/rust/raw/418a61222075827f65c085fd6707148015bc2307/rustfmt-core%2Ftests%2Ftarget%2Fmacro_rules.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/rustfmt-core%2Ftests%2Ftarget%2Fmacro_rules.rs?ref=418a61222075827f65c085fd6707148015bc2307", "patch": "@@ -41,3 +41,13 @@ macro m2 {\n         }\n     }\n }\n+\n+// #2439\n+macro_rules! m {\n+    (\n+        $line0_xxxxxxxxxxxxxxxxx: expr,\n+        $line1_xxxxxxxxxxxxxxxxx: expr,\n+        $line2_xxxxxxxxxxxxxxxxx: expr,\n+        $line3_xxxxxxxxxxxxxxxxx: expr,\n+    ) => {};\n+}"}]}