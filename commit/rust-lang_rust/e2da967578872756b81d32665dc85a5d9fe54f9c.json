{"sha": "e2da967578872756b81d32665dc85a5d9fe54f9c", "node_id": "C_kwDOAAsO6NoAKGUyZGE5Njc1Nzg4NzI3NTZiODFkMzI2NjVkYzg1YTVkOWZlNTRmOWM", "commit": {"author": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2022-05-31T22:20:28Z"}, "committer": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2022-05-31T22:20:47Z"}, "message": "fix: Fix completions disappearing when typing two keys in quick succession", "tree": {"sha": "f4c5e5f05d3f0464ed23be9431471549e8b7251d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f4c5e5f05d3f0464ed23be9431471549e8b7251d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e2da967578872756b81d32665dc85a5d9fe54f9c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e2da967578872756b81d32665dc85a5d9fe54f9c", "html_url": "https://github.com/rust-lang/rust/commit/e2da967578872756b81d32665dc85a5d9fe54f9c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e2da967578872756b81d32665dc85a5d9fe54f9c/comments", "author": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1234d8647f42460df7e857514ee1534dc55372e5", "url": "https://api.github.com/repos/rust-lang/rust/commits/1234d8647f42460df7e857514ee1534dc55372e5", "html_url": "https://github.com/rust-lang/rust/commit/1234d8647f42460df7e857514ee1534dc55372e5"}], "stats": {"total": 157, "additions": 83, "deletions": 74}, "files": [{"sha": "a9e79cc7c3e7894e59936b1b5f76c3e00b0991c6", "filename": "crates/rust-analyzer/src/bin/main.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e2da967578872756b81d32665dc85a5d9fe54f9c/crates%2Frust-analyzer%2Fsrc%2Fbin%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e2da967578872756b81d32665dc85a5d9fe54f9c/crates%2Frust-analyzer%2Fsrc%2Fbin%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fbin%2Fmain.rs?ref=e2da967578872756b81d32665dc85a5d9fe54f9c", "patch": "@@ -157,7 +157,7 @@ fn run_server() -> Result<()> {\n     let (initialize_id, initialize_params) = connection.initialize_start()?;\n     tracing::info!(\"InitializeParams: {}\", initialize_params);\n     let initialize_params =\n-        from_json::<lsp_types::InitializeParams>(\"InitializeParams\", initialize_params)?;\n+        from_json::<lsp_types::InitializeParams>(\"InitializeParams\", &initialize_params)?;\n \n     let root_path = match initialize_params\n         .root_uri"}, {"sha": "8c74fcaeaf5aac6690f069fcb117dca444637d57", "filename": "crates/rust-analyzer/src/dispatch.rs", "status": "modified", "additions": 50, "deletions": 45, "changes": 95, "blob_url": "https://github.com/rust-lang/rust/blob/e2da967578872756b81d32665dc85a5d9fe54f9c/crates%2Frust-analyzer%2Fsrc%2Fdispatch.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e2da967578872756b81d32665dc85a5d9fe54f9c/crates%2Frust-analyzer%2Fsrc%2Fdispatch.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fdispatch.rs?ref=e2da967578872756b81d32665dc85a5d9fe54f9c", "patch": "@@ -1,12 +1,12 @@\n //! See [RequestDispatcher].\n use std::{fmt, panic, thread};\n \n+use ide::Cancelled;\n use lsp_server::ExtractError;\n use serde::{de::DeserializeOwned, Serialize};\n \n use crate::{\n     global_state::{GlobalState, GlobalStateSnapshot},\n-    lsp_utils::is_cancelled,\n     main_loop::Task,\n     LspError, Result,\n };\n@@ -37,49 +37,55 @@ impl<'a> RequestDispatcher<'a> {\n     pub(crate) fn on_sync_mut<R>(\n         &mut self,\n         f: fn(&mut GlobalState, R::Params) -> Result<R::Result>,\n-    ) -> Result<&mut Self>\n+    ) -> &mut Self\n     where\n         R: lsp_types::request::Request,\n         R::Params: DeserializeOwned + panic::UnwindSafe + fmt::Debug,\n         R::Result: Serialize,\n     {\n-        let (id, params, panic_context) = match self.parse::<R>() {\n+        let (req, params, panic_context) = match self.parse::<R>() {\n             Some(it) => it,\n-            None => return Ok(self),\n+            None => return self,\n+        };\n+        let result = {\n+            let _pctx = stdx::panic_context::enter(panic_context);\n+            f(self.global_state, params)\n+        };\n+        match result_to_response::<R>(req.id.clone(), result) {\n+            Ok(response) => self.global_state.respond(response),\n+            Err(_) => self.global_state.task_pool.handle.send_retry(req),\n         };\n-        let _pctx = stdx::panic_context::enter(panic_context);\n-\n-        let result = f(self.global_state, params);\n-        let response = result_to_response::<R>(id, result);\n \n-        self.global_state.respond(response);\n-        Ok(self)\n+        self\n     }\n \n     /// Dispatches the request onto the current thread.\n     pub(crate) fn on_sync<R>(\n         &mut self,\n         f: fn(GlobalStateSnapshot, R::Params) -> Result<R::Result>,\n-    ) -> Result<&mut Self>\n+    ) -> &mut Self\n     where\n-        R: lsp_types::request::Request + 'static,\n+        R: lsp_types::request::Request,\n         R::Params: DeserializeOwned + panic::UnwindSafe + fmt::Debug,\n         R::Result: Serialize,\n     {\n-        let (id, params, panic_context) = match self.parse::<R>() {\n+        let (req, params, panic_context) = match self.parse::<R>() {\n             Some(it) => it,\n-            None => return Ok(self),\n+            None => return self,\n         };\n         let global_state_snapshot = self.global_state.snapshot();\n \n         let result = panic::catch_unwind(move || {\n             let _pctx = stdx::panic_context::enter(panic_context);\n             f(global_state_snapshot, params)\n         });\n-        let response = thread_result_to_response::<R>(id, result);\n \n-        self.global_state.respond(response);\n-        Ok(self)\n+        match thread_result_to_response::<R>(req.id.clone(), result) {\n+            Ok(response) => self.global_state.respond(response),\n+            Err(_) => self.global_state.task_pool.handle.send_retry(req),\n+        };\n+\n+        self\n     }\n \n     /// Dispatches the request onto thread pool\n@@ -92,7 +98,7 @@ impl<'a> RequestDispatcher<'a> {\n         R::Params: DeserializeOwned + panic::UnwindSafe + Send + fmt::Debug,\n         R::Result: Serialize,\n     {\n-        let (id, params, panic_context) = match self.parse::<R>() {\n+        let (req, params, panic_context) = match self.parse::<R>() {\n             Some(it) => it,\n             None => return self,\n         };\n@@ -104,8 +110,10 @@ impl<'a> RequestDispatcher<'a> {\n                     let _pctx = stdx::panic_context::enter(panic_context);\n                     f(world, params)\n                 });\n-                let response = thread_result_to_response::<R>(id, result);\n-                Task::Response(response)\n+                match thread_result_to_response::<R>(req.id.clone(), result) {\n+                    Ok(response) => Task::Response(response),\n+                    Err(_) => Task::Retry(req),\n+                }\n             }\n         });\n \n@@ -124,7 +132,7 @@ impl<'a> RequestDispatcher<'a> {\n         }\n     }\n \n-    fn parse<R>(&mut self) -> Option<(lsp_server::RequestId, R::Params, String)>\n+    fn parse<R>(&mut self) -> Option<(lsp_server::Request, R::Params, String)>\n     where\n         R: lsp_types::request::Request,\n         R::Params: DeserializeOwned + fmt::Debug,\n@@ -134,12 +142,12 @@ impl<'a> RequestDispatcher<'a> {\n             _ => return None,\n         };\n \n-        let res = crate::from_json(R::METHOD, req.params);\n+        let res = crate::from_json(R::METHOD, &req.params);\n         match res {\n             Ok(params) => {\n                 let panic_context =\n                     format!(\"\\nversion: {}\\nrequest: {} {:#?}\", env!(\"REV\"), R::METHOD, params);\n-                Some((req.id, params, panic_context))\n+                Some((req, params, panic_context))\n             }\n             Err(err) => {\n                 let response = lsp_server::Response::new_err(\n@@ -157,7 +165,7 @@ impl<'a> RequestDispatcher<'a> {\n fn thread_result_to_response<R>(\n     id: lsp_server::RequestId,\n     result: thread::Result<Result<R::Result>>,\n-) -> lsp_server::Response\n+) -> Result<lsp_server::Response, Cancelled>\n where\n     R: lsp_types::request::Request,\n     R::Params: DeserializeOwned,\n@@ -166,53 +174,50 @@ where\n     match result {\n         Ok(result) => result_to_response::<R>(id, result),\n         Err(panic) => {\n-            let mut message = \"request handler panicked\".to_string();\n-\n             let panic_message = panic\n                 .downcast_ref::<String>()\n                 .map(String::as_str)\n                 .or_else(|| panic.downcast_ref::<&str>().copied());\n \n+            let mut message = \"request handler panicked\".to_string();\n             if let Some(panic_message) = panic_message {\n                 message.push_str(\": \");\n                 message.push_str(panic_message)\n             };\n \n-            lsp_server::Response::new_err(id, lsp_server::ErrorCode::InternalError as i32, message)\n+            Ok(lsp_server::Response::new_err(\n+                id,\n+                lsp_server::ErrorCode::InternalError as i32,\n+                message,\n+            ))\n         }\n     }\n }\n \n fn result_to_response<R>(\n     id: lsp_server::RequestId,\n     result: Result<R::Result>,\n-) -> lsp_server::Response\n+) -> Result<lsp_server::Response, Cancelled>\n where\n     R: lsp_types::request::Request,\n     R::Params: DeserializeOwned,\n     R::Result: Serialize,\n {\n-    match result {\n+    let res = match result {\n         Ok(resp) => lsp_server::Response::new_ok(id, &resp),\n         Err(e) => match e.downcast::<LspError>() {\n             Ok(lsp_error) => lsp_server::Response::new_err(id, lsp_error.code, lsp_error.message),\n-            Err(e) => {\n-                if is_cancelled(&*e) {\n-                    lsp_server::Response::new_err(\n-                        id,\n-                        lsp_server::ErrorCode::ContentModified as i32,\n-                        \"content modified\".to_string(),\n-                    )\n-                } else {\n-                    lsp_server::Response::new_err(\n-                        id,\n-                        lsp_server::ErrorCode::InternalError as i32,\n-                        e.to_string(),\n-                    )\n-                }\n-            }\n+            Err(e) => match e.downcast::<Cancelled>() {\n+                Ok(cancelled) => return Err(*cancelled),\n+                Err(e) => lsp_server::Response::new_err(\n+                    id,\n+                    lsp_server::ErrorCode::InternalError as i32,\n+                    e.to_string(),\n+                ),\n+            },\n         },\n-    }\n+    };\n+    Ok(res)\n }\n \n pub(crate) struct NotificationDispatcher<'a> {"}, {"sha": "7bdd34d1f093a0f242bed934e1e646b45c10f4ea", "filename": "crates/rust-analyzer/src/from_proto.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e2da967578872756b81d32665dc85a5d9fe54f9c/crates%2Frust-analyzer%2Fsrc%2Ffrom_proto.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e2da967578872756b81d32665dc85a5d9fe54f9c/crates%2Frust-analyzer%2Fsrc%2Ffrom_proto.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Ffrom_proto.rs?ref=e2da967578872756b81d32665dc85a5d9fe54f9c", "patch": "@@ -91,7 +91,7 @@ pub(crate) fn annotation(\n ) -> Result<Annotation> {\n     let data =\n         code_lens.data.ok_or_else(|| invalid_params_error(\"code lens without data\".to_string()))?;\n-    let resolve = from_json::<lsp_ext::CodeLensResolveData>(\"CodeLensResolveData\", data)?;\n+    let resolve = from_json::<lsp_ext::CodeLensResolveData>(\"CodeLensResolveData\", &data)?;\n \n     match resolve {\n         lsp_ext::CodeLensResolveData::Impls(params) => {"}, {"sha": "d5bc8f65f829525ecf19ba92b0c7a01fc83d0795", "filename": "crates/rust-analyzer/src/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e2da967578872756b81d32665dc85a5d9fe54f9c/crates%2Frust-analyzer%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e2da967578872756b81d32665dc85a5d9fe54f9c/crates%2Frust-analyzer%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Flib.rs?ref=e2da967578872756b81d32665dc85a5d9fe54f9c", "patch": "@@ -49,7 +49,7 @@ pub use crate::{caps::server_capabilities, main_loop::main_loop};\n pub type Error = Box<dyn std::error::Error + Send + Sync>;\n pub type Result<T, E = Error> = std::result::Result<T, E>;\n \n-pub fn from_json<T: DeserializeOwned>(what: &'static str, json: serde_json::Value) -> Result<T> {\n+pub fn from_json<T: DeserializeOwned>(what: &'static str, json: &serde_json::Value) -> Result<T> {\n     let res = serde_json::from_value(json.clone())\n         .map_err(|e| format!(\"Failed to deserialize {}: {}; {}\", what, e, json))?;\n     Ok(res)"}, {"sha": "22bab8fa82047991869990429add3484a2499dda", "filename": "crates/rust-analyzer/src/lsp_utils.rs", "status": "modified", "additions": 1, "deletions": 6, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/e2da967578872756b81d32665dc85a5d9fe54f9c/crates%2Frust-analyzer%2Fsrc%2Flsp_utils.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e2da967578872756b81d32665dc85a5d9fe54f9c/crates%2Frust-analyzer%2Fsrc%2Flsp_utils.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Flsp_utils.rs?ref=e2da967578872756b81d32665dc85a5d9fe54f9c", "patch": "@@ -1,7 +1,6 @@\n //! Utilities for LSP-related boilerplate code.\n-use std::{error::Error, ops::Range, sync::Arc};\n+use std::{ops::Range, sync::Arc};\n \n-use ide_db::base_db::Cancelled;\n use lsp_server::Notification;\n \n use crate::{\n@@ -15,10 +14,6 @@ pub(crate) fn invalid_params_error(message: String) -> LspError {\n     LspError { code: lsp_server::ErrorCode::InvalidParams as i32, message }\n }\n \n-pub(crate) fn is_cancelled(e: &(dyn Error + 'static)) -> bool {\n-    e.downcast_ref::<Cancelled>().is_some()\n-}\n-\n pub(crate) fn notification_is<N: lsp_types::notification::Notification>(\n     notification: &Notification,\n ) -> bool {"}, {"sha": "612d1c9b704445d8f37d7e2485579e4fa4c325f9", "filename": "crates/rust-analyzer/src/main_loop.rs", "status": "modified", "additions": 21, "deletions": 20, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/e2da967578872756b81d32665dc85a5d9fe54f9c/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e2da967578872756b81d32665dc85a5d9fe54f9c/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs?ref=e2da967578872756b81d32665dc85a5d9fe54f9c", "patch": "@@ -8,7 +8,7 @@ use std::{\n \n use always_assert::always;\n use crossbeam_channel::{select, Receiver};\n-use ide_db::base_db::{SourceDatabaseExt, VfsPath};\n+use ide_db::base_db::{Cancelled, SourceDatabaseExt, VfsPath};\n use lsp_server::{Connection, Notification, Request};\n use lsp_types::notification::Notification as _;\n use vfs::{ChangeKind, FileId};\n@@ -19,7 +19,7 @@ use crate::{\n     from_proto,\n     global_state::{file_id_to_url, url_to_file_id, GlobalState},\n     handlers, lsp_ext,\n-    lsp_utils::{apply_document_changes, is_cancelled, notification_is, Progress},\n+    lsp_utils::{apply_document_changes, notification_is, Progress},\n     mem_docs::DocumentData,\n     reload::{self, BuildDataProgress, ProjectWorkspaceProgress},\n     Result,\n@@ -60,6 +60,7 @@ enum Event {\n #[derive(Debug)]\n pub(crate) enum Task {\n     Response(lsp_server::Response),\n+    Retry(lsp_server::Request),\n     Diagnostics(Vec<(FileId, Vec<lsp_types::Diagnostic>)>),\n     PrimeCaches(PrimeCachesProgress),\n     FetchWorkspace(ProjectWorkspaceProgress),\n@@ -172,13 +173,13 @@ impl GlobalState {\n                 msg.ok().map(Event::Lsp),\n \n             recv(self.task_pool.receiver) -> task =>\n-                Some(Event::Task(task.unwrap())),\n+                task.ok().map(Event::Task),\n \n             recv(self.loader.receiver) -> task =>\n-                Some(Event::Vfs(task.unwrap())),\n+                task.ok().map(Event::Vfs),\n \n             recv(self.flycheck_receiver) -> task =>\n-                Some(Event::Flycheck(task.unwrap())),\n+                task.ok().map(Event::Flycheck),\n         }\n     }\n \n@@ -196,7 +197,7 @@ impl GlobalState {\n         let was_quiescent = self.is_quiescent();\n         match event {\n             Event::Lsp(msg) => match msg {\n-                lsp_server::Message::Request(req) => self.on_request(loop_start, req)?,\n+                lsp_server::Message::Request(req) => self.on_request(loop_start, req),\n                 lsp_server::Message::Notification(not) => {\n                     self.on_notification(not)?;\n                 }\n@@ -208,6 +209,7 @@ impl GlobalState {\n                 loop {\n                     match task {\n                         Task::Response(response) => self.respond(response),\n+                        Task::Retry(req) => self.on_request(loop_start, req),\n                         Task::Diagnostics(diagnostics_per_file) => {\n                             for (file_id, diagnostics) in diagnostics_per_file {\n                                 self.diagnostics.set_native_diagnostics(file_id, diagnostics)\n@@ -553,7 +555,7 @@ impl GlobalState {\n         Ok(())\n     }\n \n-    fn on_request(&mut self, request_received: Instant, req: Request) -> Result<()> {\n+    fn on_request(&mut self, request_received: Instant, req: Request) {\n         self.register_request(&req, request_received);\n \n         if self.shutdown_requested {\n@@ -562,8 +564,7 @@ impl GlobalState {\n                 lsp_server::ErrorCode::InvalidRequest as i32,\n                 \"Shutdown already requested.\".to_owned(),\n             ));\n-\n-            return Ok(());\n+            return;\n         }\n \n         // Avoid flashing a bunch of unresolved references during initial load.\n@@ -573,21 +574,21 @@ impl GlobalState {\n                 lsp_server::ErrorCode::ContentModified as i32,\n                 \"waiting for cargo metadata or cargo check\".to_owned(),\n             ));\n-            return Ok(());\n+            return;\n         }\n \n         RequestDispatcher { req: Some(req), global_state: self }\n             .on_sync_mut::<lsp_types::request::Shutdown>(|s, ()| {\n                 s.shutdown_requested = true;\n                 Ok(())\n-            })?\n-            .on_sync_mut::<lsp_ext::ReloadWorkspace>(handlers::handle_workspace_reload)?\n-            .on_sync_mut::<lsp_ext::MemoryUsage>(handlers::handle_memory_usage)?\n-            .on_sync_mut::<lsp_ext::ShuffleCrateGraph>(handlers::handle_shuffle_crate_graph)?\n-            .on_sync::<lsp_ext::JoinLines>(handlers::handle_join_lines)?\n-            .on_sync::<lsp_ext::OnEnter>(handlers::handle_on_enter)?\n-            .on_sync::<lsp_types::request::SelectionRangeRequest>(handlers::handle_selection_range)?\n-            .on_sync::<lsp_ext::MatchingBrace>(handlers::handle_matching_brace)?\n+            })\n+            .on_sync_mut::<lsp_ext::ReloadWorkspace>(handlers::handle_workspace_reload)\n+            .on_sync_mut::<lsp_ext::MemoryUsage>(handlers::handle_memory_usage)\n+            .on_sync_mut::<lsp_ext::ShuffleCrateGraph>(handlers::handle_shuffle_crate_graph)\n+            .on_sync::<lsp_ext::JoinLines>(handlers::handle_join_lines)\n+            .on_sync::<lsp_ext::OnEnter>(handlers::handle_on_enter)\n+            .on_sync::<lsp_types::request::SelectionRangeRequest>(handlers::handle_selection_range)\n+            .on_sync::<lsp_ext::MatchingBrace>(handlers::handle_matching_brace)\n             .on::<lsp_ext::AnalyzerStatus>(handlers::handle_analyzer_status)\n             .on::<lsp_ext::SyntaxTree>(handlers::handle_syntax_tree)\n             .on::<lsp_ext::ViewHir>(handlers::handle_view_hir)\n@@ -644,8 +645,8 @@ impl GlobalState {\n             .on::<lsp_types::request::WillRenameFiles>(handlers::handle_will_rename_files)\n             .on::<lsp_ext::Ssr>(handlers::handle_ssr)\n             .finish();\n-        Ok(())\n     }\n+\n     fn on_notification(&mut self, not: Notification) -> Result<()> {\n         NotificationDispatcher { not: Some(not), global_state: self }\n             .on::<lsp_types::notification::Cancel>(|this, params| {\n@@ -792,7 +793,7 @@ impl GlobalState {\n                 .filter_map(|file_id| {\n                     handlers::publish_diagnostics(&snapshot, file_id)\n                         .map_err(|err| {\n-                            if !is_cancelled(&*err) {\n+                            if err.is::<Cancelled>() {\n                                 tracing::error!(\"failed to compute diagnostics: {:?}\", err);\n                             }\n                         })"}, {"sha": "2c11a5f88315d39bc67f36344ae3f2dd2c65dd34", "filename": "crates/rust-analyzer/src/task_pool.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/e2da967578872756b81d32665dc85a5d9fe54f9c/crates%2Frust-analyzer%2Fsrc%2Ftask_pool.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e2da967578872756b81d32665dc85a5d9fe54f9c/crates%2Frust-analyzer%2Fsrc%2Ftask_pool.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Ftask_pool.rs?ref=e2da967578872756b81d32665dc85a5d9fe54f9c", "patch": "@@ -2,6 +2,8 @@\n //! properly.\n use crossbeam_channel::Sender;\n \n+use crate::main_loop::Task;\n+\n pub(crate) struct TaskPool<T> {\n     sender: Sender<T>,\n     inner: threadpool::ThreadPool,\n@@ -44,3 +46,9 @@ impl<T> Drop for TaskPool<T> {\n         self.inner.join()\n     }\n }\n+\n+impl TaskPool<Task> {\n+    pub(crate) fn send_retry(&self, req: lsp_server::Request) {\n+        let _ = self.sender.send(Task::Retry(req));\n+    }\n+}"}]}