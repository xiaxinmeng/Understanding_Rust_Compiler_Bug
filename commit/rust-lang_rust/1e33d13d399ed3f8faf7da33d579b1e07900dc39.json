{"sha": "1e33d13d399ed3f8faf7da33d579b1e07900dc39", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFlMzNkMTNkMzk5ZWQzZjhmYWY3ZGEzM2Q1NzliMWUwNzkwMGRjMzk=", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2021-07-23T10:27:48Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-07-23T10:27:48Z"}, "message": "Rollup merge of #87373 - Aaron1011:hir-wf-field, r=estebank\n\nExtend HIR WF checking to fields\n\nr? ``@estebank``", "tree": {"sha": "d9d4f8b5e2f277a5943a423938b3bcedda54f52f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d9d4f8b5e2f277a5943a423938b3bcedda54f52f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1e33d13d399ed3f8faf7da33d579b1e07900dc39", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJg+pmlCRBK7hj4Ov3rIwAAfSkIAAu1Ul+Mr00rxQcAyc7l1xtV\nBXuzPXegvL1RXpsdsCB2n0WpExpFIusNef2v/XnnIt5H/lKzdegVqZZ7GtUWGfVc\nRlIL0Lmu4FkR53GTS9lAv9vS09qgebz1FuWeG7kZPU8IJ/RbnZiGFUiFsPj+5o08\nHFoJpdKaZCqmU+JXwyOTe/odXQ6XpLZy9KBALImq+8cend3KdgB61FetGRs4ew3t\nzbFab6LvH1opVwElK2FwP/QFOvbZcNNC2HyMS6XXwWc0vxBmDb2eSXagdatWra4C\niDXRHjkRrtDXYsh1bd9mwCVb/qid3FQ7r2SUXcJYz/i8I4tUAQrTkoyebqCG6Cg=\n=ymcS\n-----END PGP SIGNATURE-----\n", "payload": "tree d9d4f8b5e2f277a5943a423938b3bcedda54f52f\nparent 7c2436ad340e092b4877bbba355bf3b39bc52a1c\nparent 0ebd6e489150ce79bee339ff713078bf6eff2eae\nauthor Yuki Okushi <jtitor@2k36.org> 1627036068 +0900\ncommitter GitHub <noreply@github.com> 1627036068 +0900\n\nRollup merge of #87373 - Aaron1011:hir-wf-field, r=estebank\n\nExtend HIR WF checking to fields\n\nr? ``@estebank``\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1e33d13d399ed3f8faf7da33d579b1e07900dc39", "html_url": "https://github.com/rust-lang/rust/commit/1e33d13d399ed3f8faf7da33d579b1e07900dc39", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1e33d13d399ed3f8faf7da33d579b1e07900dc39/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7c2436ad340e092b4877bbba355bf3b39bc52a1c", "url": "https://api.github.com/repos/rust-lang/rust/commits/7c2436ad340e092b4877bbba355bf3b39bc52a1c", "html_url": "https://github.com/rust-lang/rust/commit/7c2436ad340e092b4877bbba355bf3b39bc52a1c"}, {"sha": "0ebd6e489150ce79bee339ff713078bf6eff2eae", "url": "https://api.github.com/repos/rust-lang/rust/commits/0ebd6e489150ce79bee339ff713078bf6eff2eae", "html_url": "https://github.com/rust-lang/rust/commit/0ebd6e489150ce79bee339ff713078bf6eff2eae"}], "stats": {"total": 28, "additions": 15, "deletions": 13}, "files": [{"sha": "e33cc603b5e543cc95cd8b3699642cb2ec2761e4", "filename": "compiler/rustc_typeck/src/check/wfcheck.rs", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/1e33d13d399ed3f8faf7da33d579b1e07900dc39/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fwfcheck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1e33d13d399ed3f8faf7da33d579b1e07900dc39/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fwfcheck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fwfcheck.rs?ref=1e33d13d399ed3f8faf7da33d579b1e07900dc39", "patch": "@@ -523,8 +523,7 @@ fn check_type_defn<'tcx, F>(\n                 fcx.register_wf_obligation(\n                     field.ty.into(),\n                     field.span,\n-                    // We don't have an HIR id for the field\n-                    ObligationCauseCode::WellFormed(None),\n+                    ObligationCauseCode::WellFormed(Some(WellFormedLoc::Ty(field.def_id))),\n                 )\n             }\n \n@@ -1467,6 +1466,7 @@ struct AdtVariant<'tcx> {\n \n struct AdtField<'tcx> {\n     ty: Ty<'tcx>,\n+    def_id: LocalDefId,\n     span: Span,\n }\n \n@@ -1477,11 +1477,12 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n             .fields()\n             .iter()\n             .map(|field| {\n-                let field_ty = self.tcx.type_of(self.tcx.hir().local_def_id(field.hir_id));\n+                let def_id = self.tcx.hir().local_def_id(field.hir_id);\n+                let field_ty = self.tcx.type_of(def_id);\n                 let field_ty = self.normalize_associated_types_in(field.ty.span, field_ty);\n                 let field_ty = self.resolve_vars_if_possible(field_ty);\n                 debug!(\"non_enum_variant: type of field {:?} is {:?}\", field, field_ty);\n-                AdtField { ty: field_ty, span: field.ty.span }\n+                AdtField { ty: field_ty, span: field.ty.span, def_id }\n             })\n             .collect();\n         AdtVariant { fields, explicit_discr: None }"}, {"sha": "e7503d3d71ceaec5cb9480f521299b3d87a640fa", "filename": "compiler/rustc_typeck/src/hir_wf_check.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/1e33d13d399ed3f8faf7da33d579b1e07900dc39/compiler%2Frustc_typeck%2Fsrc%2Fhir_wf_check.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1e33d13d399ed3f8faf7da33d579b1e07900dc39/compiler%2Frustc_typeck%2Fsrc%2Fhir_wf_check.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fhir_wf_check.rs?ref=1e33d13d399ed3f8faf7da33d579b1e07900dc39", "patch": "@@ -25,7 +25,7 @@ fn diagnostic_hir_wf_check<'tcx>(\n         WellFormedLoc::Ty(def_id) => def_id,\n         WellFormedLoc::Param { function, param_idx: _ } => function,\n     };\n-    let hir_id = HirId::make_owner(def_id);\n+    let hir_id = hir.local_def_id_to_hir_id(def_id);\n \n     // HIR wfcheck should only ever happen as part of improving an existing error\n     tcx.sess\n@@ -140,6 +140,7 @@ fn diagnostic_hir_wf_check<'tcx>(\n                 }\n                 ref item => bug!(\"Unexpected item {:?}\", item),\n             },\n+            hir::Node::Field(field) => Some(field.ty),\n             ref node => bug!(\"Unexpected node {:?}\", node),\n         },\n         WellFormedLoc::Param { function: _, param_idx } => {"}, {"sha": "4400b6179c6f8ad782b870d846de1618226cc6e1", "filename": "src/test/ui/issues/issue-19380.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/1e33d13d399ed3f8faf7da33d579b1e07900dc39/src%2Ftest%2Fui%2Fissues%2Fissue-19380.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/1e33d13d399ed3f8faf7da33d579b1e07900dc39/src%2Ftest%2Fui%2Fissues%2Fissue-19380.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-19380.stderr?ref=1e33d13d399ed3f8faf7da33d579b1e07900dc39", "patch": "@@ -1,8 +1,8 @@\n error[E0038]: the trait `Qiz` cannot be made into an object\n-  --> $DIR/issue-19380.rs:11:9\n+  --> $DIR/issue-19380.rs:11:29\n    |\n LL |   foos: &'static [&'static (dyn Qiz + 'static)]\n-   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ `Qiz` cannot be made into an object\n+   |                             ^^^^^^^^^^^^^^^^^ `Qiz` cannot be made into an object\n    |\n note: for a trait to be \"object safe\" it needs to allow building a vtable to allow the call to be resolvable dynamically; for more information visit <https://doc.rust-lang.org/reference/items/traits.html#object-safety>\n   --> $DIR/issue-19380.rs:2:6"}, {"sha": "20aa97707105e2156079225216800fd2bb60229f", "filename": "src/test/ui/wf/wf-in-fn-type-arg.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/1e33d13d399ed3f8faf7da33d579b1e07900dc39/src%2Ftest%2Fui%2Fwf%2Fwf-in-fn-type-arg.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/1e33d13d399ed3f8faf7da33d579b1e07900dc39/src%2Ftest%2Fui%2Fwf%2Fwf-in-fn-type-arg.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fwf%2Fwf-in-fn-type-arg.stderr?ref=1e33d13d399ed3f8faf7da33d579b1e07900dc39", "patch": "@@ -1,11 +1,11 @@\n error[E0277]: the trait bound `T: Copy` is not satisfied\n-  --> $DIR/wf-in-fn-type-arg.rs:9:8\n+  --> $DIR/wf-in-fn-type-arg.rs:9:11\n    |\n LL | struct MustBeCopy<T:Copy> {\n    |                     ---- required by this bound in `MustBeCopy`\n ...\n LL |     x: fn(MustBeCopy<T>)\n-   |        ^^^^^^^^^^^^^^^^^ the trait `Copy` is not implemented for `T`\n+   |           ^^^^^^^^^^^^^ the trait `Copy` is not implemented for `T`\n    |\n help: consider restricting type parameter `T`\n    |"}, {"sha": "48af696c3a7527aac89b520c901bd24bc0c5ff98", "filename": "src/test/ui/wf/wf-in-fn-type-ret.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/1e33d13d399ed3f8faf7da33d579b1e07900dc39/src%2Ftest%2Fui%2Fwf%2Fwf-in-fn-type-ret.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/1e33d13d399ed3f8faf7da33d579b1e07900dc39/src%2Ftest%2Fui%2Fwf%2Fwf-in-fn-type-ret.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fwf%2Fwf-in-fn-type-ret.stderr?ref=1e33d13d399ed3f8faf7da33d579b1e07900dc39", "patch": "@@ -1,11 +1,11 @@\n error[E0277]: the trait bound `T: Copy` is not satisfied\n-  --> $DIR/wf-in-fn-type-ret.rs:9:8\n+  --> $DIR/wf-in-fn-type-ret.rs:9:16\n    |\n LL | struct MustBeCopy<T:Copy> {\n    |                     ---- required by this bound in `MustBeCopy`\n ...\n LL |     x: fn() -> MustBeCopy<T>\n-   |        ^^^^^^^^^^^^^^^^^^^^^ the trait `Copy` is not implemented for `T`\n+   |                ^^^^^^^^^^^^^ the trait `Copy` is not implemented for `T`\n    |\n help: consider restricting type parameter `T`\n    |"}, {"sha": "b3b919a569ed41fa0b08a79355bab4088a6dbb55", "filename": "src/test/ui/wf/wf-in-obj-type-trait.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/1e33d13d399ed3f8faf7da33d579b1e07900dc39/src%2Ftest%2Fui%2Fwf%2Fwf-in-obj-type-trait.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/1e33d13d399ed3f8faf7da33d579b1e07900dc39/src%2Ftest%2Fui%2Fwf%2Fwf-in-obj-type-trait.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fwf%2Fwf-in-obj-type-trait.stderr?ref=1e33d13d399ed3f8faf7da33d579b1e07900dc39", "patch": "@@ -1,11 +1,11 @@\n error[E0277]: the trait bound `T: Copy` is not satisfied\n-  --> $DIR/wf-in-obj-type-trait.rs:11:8\n+  --> $DIR/wf-in-obj-type-trait.rs:11:19\n    |\n LL | struct MustBeCopy<T:Copy> {\n    |                     ---- required by this bound in `MustBeCopy`\n ...\n LL |     x: dyn Object<MustBeCopy<T>>\n-   |        ^^^^^^^^^^^^^^^^^^^^^^^^^ the trait `Copy` is not implemented for `T`\n+   |                   ^^^^^^^^^^^^^ the trait `Copy` is not implemented for `T`\n    |\n help: consider restricting type parameter `T`\n    |"}]}