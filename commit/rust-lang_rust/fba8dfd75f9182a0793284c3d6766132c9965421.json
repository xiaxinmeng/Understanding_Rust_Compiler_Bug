{"sha": "fba8dfd75f9182a0793284c3d6766132c9965421", "node_id": "C_kwDOAAsO6NoAKGZiYThkZmQ3NWY5MTgyYTA3OTMyODRjM2Q2NzY2MTMyYzk5NjU0MjE", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2022-06-26T04:15:03Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-06-26T04:15:03Z"}, "message": "Rollup merge of #98513 - ehuss:rebuild-llvm-download, r=Mark-Simulacrum\n\nFix LLVM rebuild with download-ci-llvm.\n\nThis fixes an issue where updating a local checkout that includes a change in `src/version` causes a linking failure.\n\nThe cause is that the `rustc_llvm` build script uses `rerun-if-changed` of `llvm-config` to know if it needs to rerun. Cargo only compares the timestamp of the last time the build script to the file. However, extracting the tar files retains the timestamps in the tarball which may be some time in the past. Since `src/version` is included in the LLVM `.so` filename, `rustc` attempts to load the wrong shared library since the `rustc_llvm` build script doesn't rerun.\n\nhttps://github.com/rust-lang/cargo/issues/10791 contains a more detailed explanation.\n\nThe solution here is a hack which updates the timestamp of `llvm-config` to the current time when it is extracted.\n\nThis is a bit of a hack, but seems to be the best solution I can think of until https://github.com/rust-lang/cargo/issues/10791 is fixed. There are likely several other situations where this is a problem (such as using system LLVM), and this isn't really a complete fix.\n\nNote that apple platforms are not directly affected by this problem because they don't have a version in the dylib filename.\n\nHow to test this:\n\n1. On a linux host, enable download-ci-llvm\n2. Check out 7036449c774860a5b348dbbe01c20704c557382e (the commit just before the last version bump)\n3. `./x.py build library/std`\n4. Check out 5f015a24f99f52ea9b67beb420aff24f82acf1af (the commit that bumped the version)\n5. `./x.py build library/std`\n\nFixes #98495", "tree": {"sha": "b515e950192f1afb4048d30cdee51fe9ca7d21a9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b515e950192f1afb4048d30cdee51fe9ca7d21a9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fba8dfd75f9182a0793284c3d6766132c9965421", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJit91HCRBK7hj4Ov3rIwAAh/wIABRq1U+SlBoz/7GQhJ6/FhPi\n+GooWPxZzE3XmGy8ZKo4wLfuQao6tYARni7WI/imgLRapPHwcYoIIYrZa+9BfohM\n6ekdiCxFyy1T0LkSnzYtVCYeNf8G2c/JYSeGMhVq6w5mlPiv6t/0gq08E2WDn2xZ\n4NKNjIzbOuuiv+zT5NdwYB8vcN2pUE+jWzXL2Bb3yskPFqJPgnd5Zm1pVv72F5Wc\ndLyqGE1PxdCiYE/kJYhKKawQzbo6a5yZgTe7oJzBtEDzO7W5acgOigNuQr3U8sPA\nhzNbfspnqAB8uCvKxyLsjj6vvNJzklIUO3IymPRLxNgIArnLiTCGTivz5sHMNGE=\n=IXwW\n-----END PGP SIGNATURE-----\n", "payload": "tree b515e950192f1afb4048d30cdee51fe9ca7d21a9\nparent c3b2291dc31a7e3f00c93e186ea380ba15bf75e0\nparent 418b1fa77af366b3784c35d88927ec7f4d869dea\nauthor Yuki Okushi <jtitor@2k36.org> 1656216903 +0900\ncommitter GitHub <noreply@github.com> 1656216903 +0900\n\nRollup merge of #98513 - ehuss:rebuild-llvm-download, r=Mark-Simulacrum\n\nFix LLVM rebuild with download-ci-llvm.\n\nThis fixes an issue where updating a local checkout that includes a change in `src/version` causes a linking failure.\n\nThe cause is that the `rustc_llvm` build script uses `rerun-if-changed` of `llvm-config` to know if it needs to rerun. Cargo only compares the timestamp of the last time the build script to the file. However, extracting the tar files retains the timestamps in the tarball which may be some time in the past. Since `src/version` is included in the LLVM `.so` filename, `rustc` attempts to load the wrong shared library since the `rustc_llvm` build script doesn't rerun.\n\nhttps://github.com/rust-lang/cargo/issues/10791 contains a more detailed explanation.\n\nThe solution here is a hack which updates the timestamp of `llvm-config` to the current time when it is extracted.\n\nThis is a bit of a hack, but seems to be the best solution I can think of until https://github.com/rust-lang/cargo/issues/10791 is fixed. There are likely several other situations where this is a problem (such as using system LLVM), and this isn't really a complete fix.\n\nNote that apple platforms are not directly affected by this problem because they don't have a version in the dylib filename.\n\nHow to test this:\n\n1. On a linux host, enable download-ci-llvm\n2. Check out 7036449c774860a5b348dbbe01c20704c557382e (the commit just before the last version bump)\n3. `./x.py build library/std`\n4. Check out 5f015a24f99f52ea9b67beb420aff24f82acf1af (the commit that bumped the version)\n5. `./x.py build library/std`\n\nFixes #98495\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fba8dfd75f9182a0793284c3d6766132c9965421", "html_url": "https://github.com/rust-lang/rust/commit/fba8dfd75f9182a0793284c3d6766132c9965421", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fba8dfd75f9182a0793284c3d6766132c9965421/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c3b2291dc31a7e3f00c93e186ea380ba15bf75e0", "url": "https://api.github.com/repos/rust-lang/rust/commits/c3b2291dc31a7e3f00c93e186ea380ba15bf75e0", "html_url": "https://github.com/rust-lang/rust/commit/c3b2291dc31a7e3f00c93e186ea380ba15bf75e0"}, {"sha": "418b1fa77af366b3784c35d88927ec7f4d869dea", "url": "https://api.github.com/repos/rust-lang/rust/commits/418b1fa77af366b3784c35d88927ec7f4d869dea", "html_url": "https://github.com/rust-lang/rust/commit/418b1fa77af366b3784c35d88927ec7f4d869dea"}], "stats": {"total": 13, "additions": 13, "deletions": 0}, "files": [{"sha": "ea410849694ca9ab7b83b5f700707c45c99f23bc", "filename": "src/bootstrap/native.rs", "status": "modified", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/fba8dfd75f9182a0793284c3d6766132c9965421/src%2Fbootstrap%2Fnative.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fba8dfd75f9182a0793284c3d6766132c9965421/src%2Fbootstrap%2Fnative.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fnative.rs?ref=fba8dfd75f9182a0793284c3d6766132c9965421", "patch": "@@ -150,6 +150,19 @@ pub(crate) fn maybe_download_ci_llvm(builder: &Builder<'_>) {\n         for binary in [\"llvm-config\", \"FileCheck\"] {\n             builder.fix_bin_or_dylib(&llvm_root.join(\"bin\").join(binary));\n         }\n+\n+        // Update the timestamp of llvm-config to force rustc_llvm to be\n+        // rebuilt. This is a hacky workaround for a deficiency in Cargo where\n+        // the rerun-if-changed directive doesn't handle changes very well.\n+        // https://github.com/rust-lang/cargo/issues/10791\n+        // Cargo only compares the timestamp of the file relative to the last\n+        // time `rustc_llvm` build script ran. However, the timestamps of the\n+        // files in the tarball are in the past, so it doesn't trigger a\n+        // rebuild.\n+        let now = filetime::FileTime::from_system_time(std::time::SystemTime::now());\n+        let llvm_config = llvm_root.join(\"bin/llvm-config\");\n+        t!(filetime::set_file_times(&llvm_config, now, now));\n+\n         let llvm_lib = llvm_root.join(\"lib\");\n         for entry in t!(fs::read_dir(&llvm_lib)) {\n             let lib = t!(entry).path();"}]}