{"sha": "5bbdf659965abf2bcc16b4d0f9e487ee570ba999", "node_id": "C_kwDOAAsO6NoAKDViYmRmNjU5OTY1YWJmMmJjYzE2YjRkMGY5ZTQ4N2VlNTcwYmE5OTk", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2022-07-25T22:14:50Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-07-25T22:14:50Z"}, "message": "Rollup merge of #99703 - dtolnay:tokenstreamsizehint, r=petrochenkov\n\nExpose size_hint() for TokenStream's iterator\n\nThe iterator for `proc_macro::TokenStream` is a wrapper around a `Vec` iterator:\n\nhttps://github.com/rust-lang/rust/blob/babff2211e3ae9ef52852dc1b01f3eacdd94c12e/library/proc_macro/src/lib.rs#L363-L371\n\nso it can cheaply provide a perfectly precise size hint, with just a pointer subtraction:\n\nhttps://github.com/rust-lang/rust/blob/babff2211e3ae9ef52852dc1b01f3eacdd94c12e/library/alloc/src/vec/into_iter.rs#L170-L177\n\nI need the size hint in syn (https://github.com/dtolnay/syn/blob/1.0.98/src/buffer.rs) to reduce allocations when converting TokenStream into syn's internal TokenBuffer representation.\n\nAside from `size_hint`, the other non-default methods in `std::vec::IntoIter`'s `Iterator` impl are `advance_by`, `count`, and `__iterator_get_unchecked`. I've included `count` in this PR since it is trivial. I did not include `__iterator_get_unchecked` because it is spoopy and I did not feel like dealing with that. Lastly, I did not include `advance_by` because that requires `feature(iter_advance_by)` (https://github.com/rust-lang/rust/issues/77404) and I noticed this comment at the top of libproc_macro:\n\nhttps://github.com/rust-lang/rust/blob/babff2211e3ae9ef52852dc1b01f3eacdd94c12e/library/proc_macro/src/lib.rs#L20-L22", "tree": {"sha": "95ee6ee587744ec3703a8998c1d6c09fc6399f18", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/95ee6ee587744ec3703a8998c1d6c09fc6399f18"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5bbdf659965abf2bcc16b4d0f9e487ee570ba999", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJi3xXaCRBK7hj4Ov3rIwAAbnwIAE+tW87/lRCFS6lITlJZL94L\n0bISxJp61JVzxs43FlVPTrpccyDSxztOx54948Qq9lsUqHeYt5nQYMSTK/ojz5dm\n1UWHILnZVBW2JtKrBPPt8b/xq6sjGrBx5I9xB/z0GNuN6t0ENhieMpHajqtlfzJ1\n5hx8juyXgB13kSKPbCVC9kPV+mzCQZple2yQ5qcF6PZOmq6sX40HzXDArcsf5Mlx\nFXbgY9K9S6kBAUUN5GGKGDI9lHlXBMl0FXuLbsHdGHTTc4o+6NAMABnrjUX2gsfq\nQd6WmuSRhsDzgbyUVtjJNwfjySH5IZpHwouODQ0nywmyrkTPlv6p99+8ixXm/uA=\n=0VIN\n-----END PGP SIGNATURE-----\n", "payload": "tree 95ee6ee587744ec3703a8998c1d6c09fc6399f18\nparent 2973b00ca6bc85ba3552282657de81d4baf864cc\nparent 63e74aba813d2e24ffa094d05c2545b5e882229f\nauthor Yuki Okushi <jtitor@2k36.org> 1658787290 +0900\ncommitter GitHub <noreply@github.com> 1658787290 +0900\n\nRollup merge of #99703 - dtolnay:tokenstreamsizehint, r=petrochenkov\n\nExpose size_hint() for TokenStream's iterator\n\nThe iterator for `proc_macro::TokenStream` is a wrapper around a `Vec` iterator:\n\nhttps://github.com/rust-lang/rust/blob/babff2211e3ae9ef52852dc1b01f3eacdd94c12e/library/proc_macro/src/lib.rs#L363-L371\n\nso it can cheaply provide a perfectly precise size hint, with just a pointer subtraction:\n\nhttps://github.com/rust-lang/rust/blob/babff2211e3ae9ef52852dc1b01f3eacdd94c12e/library/alloc/src/vec/into_iter.rs#L170-L177\n\nI need the size hint in syn (https://github.com/dtolnay/syn/blob/1.0.98/src/buffer.rs) to reduce allocations when converting TokenStream into syn's internal TokenBuffer representation.\n\nAside from `size_hint`, the other non-default methods in `std::vec::IntoIter`'s `Iterator` impl are `advance_by`, `count`, and `__iterator_get_unchecked`. I've included `count` in this PR since it is trivial. I did not include `__iterator_get_unchecked` because it is spoopy and I did not feel like dealing with that. Lastly, I did not include `advance_by` because that requires `feature(iter_advance_by)` (https://github.com/rust-lang/rust/issues/77404) and I noticed this comment at the top of libproc_macro:\n\nhttps://github.com/rust-lang/rust/blob/babff2211e3ae9ef52852dc1b01f3eacdd94c12e/library/proc_macro/src/lib.rs#L20-L22\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5bbdf659965abf2bcc16b4d0f9e487ee570ba999", "html_url": "https://github.com/rust-lang/rust/commit/5bbdf659965abf2bcc16b4d0f9e487ee570ba999", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5bbdf659965abf2bcc16b4d0f9e487ee570ba999/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2973b00ca6bc85ba3552282657de81d4baf864cc", "url": "https://api.github.com/repos/rust-lang/rust/commits/2973b00ca6bc85ba3552282657de81d4baf864cc", "html_url": "https://github.com/rust-lang/rust/commit/2973b00ca6bc85ba3552282657de81d4baf864cc"}, {"sha": "63e74aba813d2e24ffa094d05c2545b5e882229f", "url": "https://api.github.com/repos/rust-lang/rust/commits/63e74aba813d2e24ffa094d05c2545b5e882229f", "html_url": "https://github.com/rust-lang/rust/commit/63e74aba813d2e24ffa094d05c2545b5e882229f"}], "stats": {"total": 8, "additions": 8, "deletions": 0}, "files": [{"sha": "8e478cd7bc8a2f9ade1430d59e247a4edbc295ce", "filename": "library/proc_macro/src/lib.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/5bbdf659965abf2bcc16b4d0f9e487ee570ba999/library%2Fproc_macro%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bbdf659965abf2bcc16b4d0f9e487ee570ba999/library%2Fproc_macro%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fproc_macro%2Fsrc%2Flib.rs?ref=5bbdf659965abf2bcc16b4d0f9e487ee570ba999", "patch": "@@ -382,6 +382,14 @@ pub mod token_stream {\n                 bridge::TokenTree::Literal(tt) => TokenTree::Literal(Literal(tt)),\n             })\n         }\n+\n+        fn size_hint(&self) -> (usize, Option<usize>) {\n+            self.0.size_hint()\n+        }\n+\n+        fn count(self) -> usize {\n+            self.0.count()\n+        }\n     }\n \n     #[stable(feature = \"proc_macro_lib2\", since = \"1.29.0\")]"}]}