{"sha": "cc009bc5364ec183e47e165c1afeb37e48af9ffe", "node_id": "C_kwDOAAsO6NoAKGNjMDA5YmM1MzY0ZWMxODNlNDdlMTY1YzFhZmViMzdlNDhhZjlmZmU", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-10-01T14:45:05Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-10-01T14:45:05Z"}, "message": "Rollup merge of #102500 - compiler-errors:parse-sess-cleanup, r=cjgillot\n\nRemove `expr_parentheses_needed` from `ParseSess`\n\nNot sure why this method needed to exist on `ParseSess`, but we can achieve the same behavior by just inlining it everywhere.", "tree": {"sha": "66aef1f525ca1c9b2b48778facf9f18434876aa5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/66aef1f525ca1c9b2b48778facf9f18434876aa5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cc009bc5364ec183e47e165c1afeb37e48af9ffe", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjOFJxCRBK7hj4Ov3rIwAAVS8IAGsXkEsV04uYHMaw7gXbMDK5\nQHmd+3P3Ce+FXmbsIlQyL/B+AdRNVll+2415BM9I97o8kSndpFuqNlNbfKeIsU2J\nt4heuURRwQD+52N42Gd6/Sj4ChzrGCgbfOYYlO0OL54t+oEISYmM2ppvz4Hg3QZo\nCWOrjPWbPihYy30rWF5tQyuyNaFmh/kY8KlfR7pud3rCCrCPrPekC3Wq+CvR1izO\n8rkdNrg/Xw3vx/AVqP9t4eva/igKIt+lYq73KXBS1tEFVz55caHxWdUrJneVFy1O\nXXGftb0lMDFvdzfSk93/cR9f/B/yhGi3UpAHNeamDAMFYCAKxTgi4DICH+ks8Ik=\n=GLsI\n-----END PGP SIGNATURE-----\n", "payload": "tree 66aef1f525ca1c9b2b48778facf9f18434876aa5\nparent 21fc2185325fcf6f1a002e4c0c015fecff2ac888\nparent 85a726e7540b801924cfb207e7b5714e00080471\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1664635505 +0200\ncommitter GitHub <noreply@github.com> 1664635505 +0200\n\nRollup merge of #102500 - compiler-errors:parse-sess-cleanup, r=cjgillot\n\nRemove `expr_parentheses_needed` from `ParseSess`\n\nNot sure why this method needed to exist on `ParseSess`, but we can achieve the same behavior by just inlining it everywhere.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cc009bc5364ec183e47e165c1afeb37e48af9ffe", "html_url": "https://github.com/rust-lang/rust/commit/cc009bc5364ec183e47e165c1afeb37e48af9ffe", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cc009bc5364ec183e47e165c1afeb37e48af9ffe/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "21fc2185325fcf6f1a002e4c0c015fecff2ac888", "url": "https://api.github.com/repos/rust-lang/rust/commits/21fc2185325fcf6f1a002e4c0c015fecff2ac888", "html_url": "https://github.com/rust-lang/rust/commit/21fc2185325fcf6f1a002e4c0c015fecff2ac888"}, {"sha": "85a726e7540b801924cfb207e7b5714e00080471", "url": "https://api.github.com/repos/rust-lang/rust/commits/85a726e7540b801924cfb207e7b5714e00080471", "html_url": "https://github.com/rust-lang/rust/commit/85a726e7540b801924cfb207e7b5714e00080471"}], "stats": {"total": 31, "additions": 14, "deletions": 17}, "files": [{"sha": "09362eab673e83faf667157c8173e9a8942bb986", "filename": "compiler/rustc_hir_analysis/src/check/expr.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/cc009bc5364ec183e47e165c1afeb37e48af9ffe/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cc009bc5364ec183e47e165c1afeb37e48af9ffe/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fexpr.rs?ref=cc009bc5364ec183e47e165c1afeb37e48af9ffe", "patch": "@@ -41,6 +41,7 @@ use rustc_middle::ty::adjustment::{Adjust, Adjustment, AllowTwoPhase};\n use rustc_middle::ty::error::TypeError::FieldMisMatch;\n use rustc_middle::ty::subst::SubstsRef;\n use rustc_middle::ty::{self, AdtKind, Ty, TypeVisitable};\n+use rustc_session::errors::ExprParenthesesNeeded;\n use rustc_session::parse::feature_err;\n use rustc_span::hygiene::DesugaringKind;\n use rustc_span::lev_distance::find_best_match_for_name;\n@@ -394,7 +395,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                         if let Some(sp) =\n                             tcx.sess.parse_sess.ambiguous_block_expr_parse.borrow().get(&sp)\n                         {\n-                            tcx.sess.parse_sess.expr_parentheses_needed(&mut err, *sp);\n+                            err.subdiagnostic(ExprParenthesesNeeded::surrounding(*sp));\n                         }\n                         err.emit();\n                         oprnd_t = tcx.ty_error();"}, {"sha": "05ed3b299726c03fceb87b1048f1f5aee9829469", "filename": "compiler/rustc_hir_analysis/src/check/fn_ctxt/suggestions.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/cc009bc5364ec183e47e165c1afeb37e48af9ffe/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Ffn_ctxt%2Fsuggestions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cc009bc5364ec183e47e165c1afeb37e48af9ffe/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Ffn_ctxt%2Fsuggestions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Ffn_ctxt%2Fsuggestions.rs?ref=cc009bc5364ec183e47e165c1afeb37e48af9ffe", "patch": "@@ -15,6 +15,7 @@ use rustc_infer::infer::{self, TyCtxtInferExt};\n use rustc_infer::traits::{self, StatementAsExpression};\n use rustc_middle::lint::in_external_macro;\n use rustc_middle::ty::{self, Binder, IsSuggestable, ToPredicate, Ty};\n+use rustc_session::errors::ExprParenthesesNeeded;\n use rustc_span::symbol::sym;\n use rustc_span::Span;\n use rustc_trait_selection::infer::InferCtxtExt;\n@@ -895,7 +896,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         let sp = self.tcx.sess.source_map().start_point(expr.span);\n         if let Some(sp) = self.tcx.sess.parse_sess.ambiguous_block_expr_parse.borrow().get(&sp) {\n             // `{ 42 } &&x` (#61475) or `{ 42 } && if x { 1 } else { 0 }`\n-            self.tcx.sess.parse_sess.expr_parentheses_needed(err, *sp);\n+            err.subdiagnostic(ExprParenthesesNeeded::surrounding(*sp));\n         }\n     }\n "}, {"sha": "2d7d9020e3ecc9f8afd7087ac5700c3e6940cea5", "filename": "compiler/rustc_hir_analysis/src/check/op.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/cc009bc5364ec183e47e165c1afeb37e48af9ffe/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cc009bc5364ec183e47e165c1afeb37e48af9ffe/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fop.rs?ref=cc009bc5364ec183e47e165c1afeb37e48af9ffe", "patch": "@@ -13,6 +13,7 @@ use rustc_middle::ty::adjustment::{\n };\n use rustc_middle::ty::print::with_no_trimmed_paths;\n use rustc_middle::ty::{self, DefIdTree, Ty, TyCtxt, TypeFolder, TypeSuperFoldable, TypeVisitable};\n+use rustc_session::errors::ExprParenthesesNeeded;\n use rustc_span::source_map::Spanned;\n use rustc_span::symbol::{sym, Ident};\n use rustc_span::Span;\n@@ -677,7 +678,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                         // If the previous expression was a block expression, suggest parentheses\n                         // (turning this into a binary subtraction operation instead.)\n                         // for example, `{2} - 2` -> `({2}) - 2` (see src\\test\\ui\\parser\\expr-as-stmt.rs)\n-                        self.tcx.sess.parse_sess.expr_parentheses_needed(&mut err, *sp);\n+                        err.subdiagnostic(ExprParenthesesNeeded::surrounding(*sp));\n                     } else {\n                         match actual.kind() {\n                             Uint(_) if op == hir::UnOp::Neg => {"}, {"sha": "f57bd9cec19200610617ed28edb52115ef57ec84", "filename": "compiler/rustc_parse/src/parser/diagnostics.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/cc009bc5364ec183e47e165c1afeb37e48af9ffe/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cc009bc5364ec183e47e165c1afeb37e48af9ffe/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fdiagnostics.rs?ref=cc009bc5364ec183e47e165c1afeb37e48af9ffe", "patch": "@@ -33,6 +33,7 @@ use rustc_errors::{\n     fluent, Applicability, DiagnosticBuilder, DiagnosticMessage, Handler, MultiSpan, PResult,\n };\n use rustc_errors::{pluralize, Diagnostic, ErrorGuaranteed, IntoDiagnostic};\n+use rustc_session::errors::ExprParenthesesNeeded;\n use rustc_span::source_map::Spanned;\n use rustc_span::symbol::{kw, sym, Ident};\n use rustc_span::{Span, SpanSnippetError, DUMMY_SP};\n@@ -2049,7 +2050,7 @@ impl<'a> Parser<'a> {\n         let mut err = self.struct_span_err(span, &msg);\n         let sp = self.sess.source_map().start_point(self.token.span);\n         if let Some(sp) = self.sess.ambiguous_block_expr_parse.borrow().get(&sp) {\n-            self.sess.expr_parentheses_needed(&mut err, *sp);\n+            err.subdiagnostic(ExprParenthesesNeeded::surrounding(*sp));\n         }\n         err.span_label(span, \"expected expression\");\n         err"}, {"sha": "11301f03e48eb70615f05abbcc8deb3c3e1393f8", "filename": "compiler/rustc_parse/src/parser/expr.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/cc009bc5364ec183e47e165c1afeb37e48af9ffe/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cc009bc5364ec183e47e165c1afeb37e48af9ffe/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fexpr.rs?ref=cc009bc5364ec183e47e165c1afeb37e48af9ffe", "patch": "@@ -1310,7 +1310,7 @@ impl<'a> Parser<'a> {\n                 // If the input is something like `if a { 1 } else { 2 } | if a { 3 } else { 4 }`\n                 // then suggest parens around the lhs.\n                 if let Some(sp) = self.sess.ambiguous_block_expr_parse.borrow().get(&lo) {\n-                    self.sess.expr_parentheses_needed(&mut err, *sp);\n+                    err.subdiagnostic(ExprParenthesesNeeded::surrounding(*sp));\n                 }\n                 err\n             })"}, {"sha": "0250b518243c1ee9dce286102231d377e4e1e731", "filename": "compiler/rustc_parse/src/parser/pat.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/cc009bc5364ec183e47e165c1afeb37e48af9ffe/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fpat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cc009bc5364ec183e47e165c1afeb37e48af9ffe/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fpat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fpat.rs?ref=cc009bc5364ec183e47e165c1afeb37e48af9ffe", "patch": "@@ -10,6 +10,7 @@ use rustc_ast::{\n };\n use rustc_ast_pretty::pprust;\n use rustc_errors::{struct_span_err, Applicability, DiagnosticBuilder, ErrorGuaranteed, PResult};\n+use rustc_session::errors::ExprParenthesesNeeded;\n use rustc_span::source_map::{respan, Span, Spanned};\n use rustc_span::symbol::{kw, sym, Ident};\n \n@@ -693,7 +694,7 @@ impl<'a> Parser<'a> {\n \n         let sp = self.sess.source_map().start_point(self.token.span);\n         if let Some(sp) = self.sess.ambiguous_block_expr_parse.borrow().get(&sp) {\n-            self.sess.expr_parentheses_needed(&mut err, *sp);\n+            err.subdiagnostic(ExprParenthesesNeeded::surrounding(*sp));\n         }\n \n         Err(err)"}, {"sha": "2c3d8d5283b5736c9004d9e86d755746a912e8eb", "filename": "compiler/rustc_session/src/parse.rs", "status": "modified", "additions": 3, "deletions": 11, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/cc009bc5364ec183e47e165c1afeb37e48af9ffe/compiler%2Frustc_session%2Fsrc%2Fparse.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cc009bc5364ec183e47e165c1afeb37e48af9ffe/compiler%2Frustc_session%2Fsrc%2Fparse.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Fparse.rs?ref=cc009bc5364ec183e47e165c1afeb37e48af9ffe", "patch": "@@ -2,9 +2,7 @@\n //! It also serves as an input to the parser itself.\n \n use crate::config::CheckCfg;\n-use crate::errors::{\n-    ExprParenthesesNeeded, FeatureDiagnosticForIssue, FeatureDiagnosticHelp, FeatureGateError,\n-};\n+use crate::errors::{FeatureDiagnosticForIssue, FeatureDiagnosticHelp, FeatureGateError};\n use crate::lint::{\n     builtin::UNSTABLE_SYNTAX_PRE_EXPANSION, BufferedEarlyLint, BuiltinLintDiagnostics, Lint, LintId,\n };\n@@ -13,8 +11,8 @@ use rustc_data_structures::fx::{FxHashMap, FxHashSet, FxIndexSet};\n use rustc_data_structures::sync::{Lock, Lrc};\n use rustc_errors::{emitter::SilentEmitter, ColorConfig, Handler};\n use rustc_errors::{\n-    fallback_fluent_bundle, AddToDiagnostic, Diagnostic, DiagnosticBuilder, DiagnosticId,\n-    DiagnosticMessage, EmissionGuarantee, ErrorGuaranteed, IntoDiagnostic, MultiSpan, StashKey,\n+    fallback_fluent_bundle, Diagnostic, DiagnosticBuilder, DiagnosticId, DiagnosticMessage,\n+    EmissionGuarantee, ErrorGuaranteed, IntoDiagnostic, MultiSpan, StashKey,\n };\n use rustc_feature::{find_feature_issue, GateIssue, UnstableFeatures};\n use rustc_span::edition::Edition;\n@@ -324,12 +322,6 @@ impl ParseSess {\n         });\n     }\n \n-    /// Extend an error with a suggestion to wrap an expression with parentheses to allow the\n-    /// parser to continue parsing the following operation as part of the same expression.\n-    pub fn expr_parentheses_needed(&self, err: &mut Diagnostic, span: Span) {\n-        ExprParenthesesNeeded::surrounding(span).add_to_diagnostic(err);\n-    }\n-\n     pub fn save_proc_macro_span(&self, span: Span) -> usize {\n         let mut spans = self.proc_macro_quoted_spans.lock();\n         spans.push(span);"}]}