{"sha": "c32f402749214840eb1ae73577d5e0864d43a056", "node_id": "MDY6Q29tbWl0NzI0NzEyOmMzMmY0MDI3NDkyMTQ4NDBlYjFhZTczNTc3ZDVlMDg2NGQ0M2EwNTY=", "commit": {"author": {"name": "Tom Tromey", "email": "tom@tromey.com", "date": "2018-09-07T15:29:40Z"}, "committer": {"name": "Tom Tromey", "email": "tom@tromey.com", "date": "2018-10-30T18:06:07Z"}, "message": "Address review comments\n\nThis fixes the issues pointed out in review.", "tree": {"sha": "861c877900e79b5f26b9914da7f6acaa68446913", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/861c877900e79b5f26b9914da7f6acaa68446913"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c32f402749214840eb1ae73577d5e0864d43a056", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c32f402749214840eb1ae73577d5e0864d43a056", "html_url": "https://github.com/rust-lang/rust/commit/c32f402749214840eb1ae73577d5e0864d43a056", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c32f402749214840eb1ae73577d5e0864d43a056/comments", "author": {"login": "tromey", "id": 1557670, "node_id": "MDQ6VXNlcjE1NTc2NzA=", "avatar_url": "https://avatars.githubusercontent.com/u/1557670?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tromey", "html_url": "https://github.com/tromey", "followers_url": "https://api.github.com/users/tromey/followers", "following_url": "https://api.github.com/users/tromey/following{/other_user}", "gists_url": "https://api.github.com/users/tromey/gists{/gist_id}", "starred_url": "https://api.github.com/users/tromey/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tromey/subscriptions", "organizations_url": "https://api.github.com/users/tromey/orgs", "repos_url": "https://api.github.com/users/tromey/repos", "events_url": "https://api.github.com/users/tromey/events{/privacy}", "received_events_url": "https://api.github.com/users/tromey/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tromey", "id": 1557670, "node_id": "MDQ6VXNlcjE1NTc2NzA=", "avatar_url": "https://avatars.githubusercontent.com/u/1557670?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tromey", "html_url": "https://github.com/tromey", "followers_url": "https://api.github.com/users/tromey/followers", "following_url": "https://api.github.com/users/tromey/following{/other_user}", "gists_url": "https://api.github.com/users/tromey/gists{/gist_id}", "starred_url": "https://api.github.com/users/tromey/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tromey/subscriptions", "organizations_url": "https://api.github.com/users/tromey/orgs", "repos_url": "https://api.github.com/users/tromey/repos", "events_url": "https://api.github.com/users/tromey/events{/privacy}", "received_events_url": "https://api.github.com/users/tromey/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "71ce4c3007b964208b89733b0931bf71e7514938", "url": "https://api.github.com/repos/rust-lang/rust/commits/71ce4c3007b964208b89733b0931bf71e7514938", "html_url": "https://github.com/rust-lang/rust/commit/71ce4c3007b964208b89733b0931bf71e7514938"}], "stats": {"total": 22, "additions": 11, "deletions": 11}, "files": [{"sha": "19ada960db3fa2c4ca3d419a31fa59bf1b02fe52", "filename": "src/librustc_codegen_llvm/debuginfo/metadata.rs", "status": "modified", "additions": 11, "deletions": 11, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/c32f402749214840eb1ae73577d5e0864d43a056/src%2Flibrustc_codegen_llvm%2Fdebuginfo%2Fmetadata.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c32f402749214840eb1ae73577d5e0864d43a056/src%2Flibrustc_codegen_llvm%2Fdebuginfo%2Fmetadata.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fdebuginfo%2Fmetadata.rs?ref=c32f402749214840eb1ae73577d5e0864d43a056", "patch": "@@ -33,7 +33,8 @@ use rustc_data_structures::fingerprint::Fingerprint;\n use rustc::ty::Instance;\n use common::{CodegenCx, C_u64};\n use rustc::ty::{self, AdtKind, ParamEnv, Ty, TyCtxt};\n-use rustc::ty::layout::{self, Align, Integer, IntegerExt, LayoutOf, PrimitiveExt, Size, TyLayout};\n+use rustc::ty::layout::{self, Align, HasDataLayout, Integer, IntegerExt, LayoutOf,\n+                        PrimitiveExt, Size, TyLayout};\n use rustc::session::config;\n use rustc::util::nodemap::FxHashMap;\n use rustc_fs_util::path2cstr;\n@@ -1635,16 +1636,15 @@ fn prepare_enum_metadata(\n \n         &layout::Variants::NicheFilling { ref niche, .. } => {\n             // Find the integer type of the correct size.\n-            let discr_type = niche.value.to_ty(cx.tcx);\n-            let (size, align) = cx.size_and_align_of(discr_type);\n-\n-            let discr_type = (match size.bits() {\n-                8 => Integer::I8,\n-                16 => Integer::I16,\n-                32 => Integer::I32,\n-                64 => Integer::I64,\n-                bits => bug!(\"prepare_enum_metadata: unknown niche bit size {}\", bits),\n-            }).to_ty(cx.tcx, false);\n+            let size = niche.value.size(cx);\n+            let align = niche.value.align(cx);\n+\n+            let discr_type = match niche.value {\n+                layout::Int(t, _) => t,\n+                layout::Float(layout::FloatTy::F32) => Integer::I32,\n+                layout::Float(layout::FloatTy::F64) => Integer::I64,\n+                layout::Pointer => cx.data_layout().ptr_sized_integer(),\n+            }.to_ty(cx.tcx, false);\n \n             let discr_metadata = basic_type_metadata(cx, discr_type);\n             unsafe {"}]}