{"sha": "e92180a1d8c964d386fc5ffb80bfb05abdb6c153", "node_id": "MDY6Q29tbWl0NzI0NzEyOmU5MjE4MGExZDhjOTY0ZDM4NmZjNWZmYjgwYmZiMDVhYmRiNmMxNTM=", "commit": {"author": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2021-02-09T18:47:21Z"}, "committer": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2021-02-09T18:47:21Z"}, "message": "Show Self pattern completions for Adts if inside impls", "tree": {"sha": "be07005b873aaf0931099bccef0bf4ceb3dab9d2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/be07005b873aaf0931099bccef0bf4ceb3dab9d2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e92180a1d8c964d386fc5ffb80bfb05abdb6c153", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e92180a1d8c964d386fc5ffb80bfb05abdb6c153", "html_url": "https://github.com/rust-lang/rust/commit/e92180a1d8c964d386fc5ffb80bfb05abdb6c153", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e92180a1d8c964d386fc5ffb80bfb05abdb6c153/comments", "author": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2f171ca78d306d105a9e36f8e509039d6a034c8e", "url": "https://api.github.com/repos/rust-lang/rust/commits/2f171ca78d306d105a9e36f8e509039d6a034c8e", "html_url": "https://github.com/rust-lang/rust/commit/2f171ca78d306d105a9e36f8e509039d6a034c8e"}], "stats": {"total": 46, "additions": 40, "deletions": 6}, "files": [{"sha": "43a5160cba3968cbcd49cde7b223f838d4b264f4", "filename": "crates/completion/src/completions/pattern.rs", "status": "modified", "additions": 28, "deletions": 0, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/e92180a1d8c964d386fc5ffb80bfb05abdb6c153/crates%2Fcompletion%2Fsrc%2Fcompletions%2Fpattern.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e92180a1d8c964d386fc5ffb80bfb05abdb6c153/crates%2Fcompletion%2Fsrc%2Fcompletions%2Fpattern.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fcompletion%2Fsrc%2Fcompletions%2Fpattern.rs?ref=e92180a1d8c964d386fc5ffb80bfb05abdb6c153", "patch": "@@ -31,6 +31,14 @@ pub(crate) fn complete_pattern(acc: &mut Completions, ctx: &CompletionContext) {\n                 _ => false,\n             },\n             hir::ScopeDef::MacroDef(_) => true,\n+            hir::ScopeDef::ImplSelfType(impl_) => match impl_.target_ty(ctx.db).as_adt() {\n+                Some(hir::Adt::Struct(strukt)) => {\n+                    acc.add_struct_pat(ctx, strukt, Some(name.clone()));\n+                    true\n+                }\n+                Some(hir::Adt::Enum(_)) => !ctx.is_irrefutable_pat_binding,\n+                _ => true,\n+            },\n             _ => false,\n         };\n         if add_resolution {\n@@ -258,4 +266,24 @@ fn main() {\n \"#,\n         );\n     }\n+\n+    #[test]\n+    fn completes_self_pats() {\n+        check_snippet(\n+            r#\"\n+struct Foo(i32);\n+impl Foo {\n+    fn foo() {\n+        match () {\n+            $0\n+        }\n+    }\n+}\n+    \"#,\n+            expect![[r#\"\n+                bn Self Self($1)$0\n+                bn Foo  Foo($1)$0\n+            \"#]],\n+        )\n+    }\n }"}, {"sha": "5112ecc2d9cad656e177916a2fcf5af519fd9989", "filename": "crates/completion/src/completions/unqualified_path.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e92180a1d8c964d386fc5ffb80bfb05abdb6c153/crates%2Fcompletion%2Fsrc%2Fcompletions%2Funqualified_path.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e92180a1d8c964d386fc5ffb80bfb05abdb6c153/crates%2Fcompletion%2Fsrc%2Fcompletions%2Funqualified_path.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fcompletion%2Fsrc%2Fcompletions%2Funqualified_path.rs?ref=e92180a1d8c964d386fc5ffb80bfb05abdb6c153", "patch": "@@ -746,7 +746,7 @@ fn f() -> m::E { V$0 }\n             r#\"\n enum Foo { Bar, Baz, Quux }\n impl Foo {\n-    fn foo() { let foo: Foo = Q$0 }\n+    fn foo() { match Foo::Bar { Q$0 } }\n }\n \"#,\n             expect![[r#\""}, {"sha": "3db3578555f8bb760d8b7c365b743e8249f4ae51", "filename": "crates/completion/src/context.rs", "status": "modified", "additions": 11, "deletions": 5, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/e92180a1d8c964d386fc5ffb80bfb05abdb6c153/crates%2Fcompletion%2Fsrc%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e92180a1d8c964d386fc5ffb80bfb05abdb6c153/crates%2Fcompletion%2Fsrc%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fcompletion%2Fsrc%2Fcontext.rs?ref=e92180a1d8c964d386fc5ffb80bfb05abdb6c153", "patch": "@@ -276,6 +276,14 @@ impl<'a> CompletionContext<'a> {\n             });\n     }\n \n+    fn fill_impl_def(&mut self) {\n+        self.impl_def = self\n+            .sema\n+            .ancestors_with_macros(self.token.parent())\n+            .take_while(|it| it.kind() != SOURCE_FILE && it.kind() != MODULE)\n+            .find_map(ast::Impl::cast);\n+    }\n+\n     fn fill(\n         &mut self,\n         original_file: &SyntaxNode,\n@@ -345,6 +353,8 @@ impl<'a> CompletionContext<'a> {\n                         self.is_irrefutable_pat_binding = true;\n                     }\n                 }\n+\n+                self.fill_impl_def();\n             }\n             if is_node::<ast::Param>(name.syntax()) {\n                 self.is_param = true;\n@@ -372,11 +382,7 @@ impl<'a> CompletionContext<'a> {\n                 self.sema.find_node_at_offset_with_macros(&original_file, offset);\n         }\n \n-        self.impl_def = self\n-            .sema\n-            .ancestors_with_macros(self.token.parent())\n-            .take_while(|it| it.kind() != SOURCE_FILE && it.kind() != MODULE)\n-            .find_map(ast::Impl::cast);\n+        self.fill_impl_def();\n \n         let top_node = name_ref\n             .syntax()"}]}