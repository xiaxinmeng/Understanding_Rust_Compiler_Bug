{"sha": "557f6848bd5b7183f55c1e1522a326e9e1df6030", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU1N2Y2ODQ4YmQ1YjcxODNmNTVjMWUxNTIyYTMyNmU5ZTFkZjYwMzA=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-03-10T12:25:07Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-03-10T12:25:07Z"}, "message": "Auto merge of #5296 - sinkuu:fix_ice_trivial_bounds, r=flip1995\n\nFix ICE with trivial_bounds feature\n\nhttps://github.com/rust-lang/rust/issues/69874#issuecomment-596890446\n\nchangelog: Fix ICE with trivial_bounds feature", "tree": {"sha": "9d2608fa6ac408f738dc9ad6177eacaf48f03d80", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9d2608fa6ac408f738dc9ad6177eacaf48f03d80"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/557f6848bd5b7183f55c1e1522a326e9e1df6030", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/557f6848bd5b7183f55c1e1522a326e9e1df6030", "html_url": "https://github.com/rust-lang/rust/commit/557f6848bd5b7183f55c1e1522a326e9e1df6030", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/557f6848bd5b7183f55c1e1522a326e9e1df6030/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3aa8da3e072651d9c68a579dcf598609983d2234", "url": "https://api.github.com/repos/rust-lang/rust/commits/3aa8da3e072651d9c68a579dcf598609983d2234", "html_url": "https://github.com/rust-lang/rust/commit/3aa8da3e072651d9c68a579dcf598609983d2234"}, {"sha": "227ef60a2b2fd3d78eb39d4361efc224be38cbb6", "url": "https://api.github.com/repos/rust-lang/rust/commits/227ef60a2b2fd3d78eb39d4361efc224be38cbb6", "html_url": "https://github.com/rust-lang/rust/commit/227ef60a2b2fd3d78eb39d4361efc224be38cbb6"}], "stats": {"total": 61, "additions": 56, "deletions": 5}, "files": [{"sha": "d968a928c33b5e7bc6bd2441fe0f1061392d156b", "filename": "clippy_lints/src/implicit_return.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/557f6848bd5b7183f55c1e1522a326e9e1df6030/clippy_lints%2Fsrc%2Fimplicit_return.rs", "raw_url": "https://github.com/rust-lang/rust/raw/557f6848bd5b7183f55c1e1522a326e9e1df6030/clippy_lints%2Fsrc%2Fimplicit_return.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fimplicit_return.rs?ref=557f6848bd5b7183f55c1e1522a326e9e1df6030", "patch": "@@ -1,5 +1,5 @@\n use crate::utils::{\n-    match_def_path,\n+    fn_has_unsatisfiable_preds, match_def_path,\n     paths::{BEGIN_PANIC, BEGIN_PANIC_FMT},\n     snippet_opt, span_lint_and_then,\n };\n@@ -133,6 +133,12 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for ImplicitReturn {\n         _: HirId,\n     ) {\n         let def_id = cx.tcx.hir().body_owner_def_id(body.id());\n+\n+        // Building MIR for `fn`s with unsatisfiable preds results in ICE.\n+        if fn_has_unsatisfiable_preds(cx, def_id) {\n+            return;\n+        }\n+\n         let mir = cx.tcx.optimized_mir(def_id);\n \n         // checking return type through MIR, HIR is not able to determine inferred closure return types"}, {"sha": "a22d8b4cf9ebdc10796ad7b65c4e80631db3aa94", "filename": "clippy_lints/src/missing_const_for_fn.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/557f6848bd5b7183f55c1e1522a326e9e1df6030/clippy_lints%2Fsrc%2Fmissing_const_for_fn.rs", "raw_url": "https://github.com/rust-lang/rust/raw/557f6848bd5b7183f55c1e1522a326e9e1df6030/clippy_lints%2Fsrc%2Fmissing_const_for_fn.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmissing_const_for_fn.rs?ref=557f6848bd5b7183f55c1e1522a326e9e1df6030", "patch": "@@ -1,4 +1,4 @@\n-use crate::utils::{has_drop, is_entrypoint_fn, span_lint, trait_ref_of_method};\n+use crate::utils::{fn_has_unsatisfiable_preds, has_drop, is_entrypoint_fn, span_lint, trait_ref_of_method};\n use rustc::lint::in_external_macro;\n use rustc_hir as hir;\n use rustc_hir::intravisit::FnKind;\n@@ -88,6 +88,11 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for MissingConstForFn {\n             return;\n         }\n \n+        // Building MIR for `fn`s with unsatisfiable preds results in ICE.\n+        if fn_has_unsatisfiable_preds(cx, def_id) {\n+            return;\n+        }\n+\n         // Perform some preliminary checks that rule out constness on the Clippy side. This way we\n         // can skip the actual const check and return early.\n         match kind {"}, {"sha": "103c063aef4b79e4d165d949c193b7a3e76881d3", "filename": "clippy_lints/src/redundant_clone.rs", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/557f6848bd5b7183f55c1e1522a326e9e1df6030/clippy_lints%2Fsrc%2Fredundant_clone.rs", "raw_url": "https://github.com/rust-lang/rust/raw/557f6848bd5b7183f55c1e1522a326e9e1df6030/clippy_lints%2Fsrc%2Fredundant_clone.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fredundant_clone.rs?ref=557f6848bd5b7183f55c1e1522a326e9e1df6030", "patch": "@@ -1,6 +1,6 @@\n use crate::utils::{\n-    has_drop, is_copy, match_def_path, match_type, paths, snippet_opt, span_lint_hir, span_lint_hir_and_then,\n-    walk_ptrs_ty_depth,\n+    fn_has_unsatisfiable_preds, has_drop, is_copy, match_def_path, match_type, paths, snippet_opt, span_lint_hir,\n+    span_lint_hir_and_then, walk_ptrs_ty_depth,\n };\n use if_chain::if_chain;\n use matches::matches;\n@@ -79,6 +79,12 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for RedundantClone {\n         _: HirId,\n     ) {\n         let def_id = cx.tcx.hir().body_owner_def_id(body.id());\n+\n+        // Building MIR for `fn`s with unsatisfiable preds results in ICE.\n+        if fn_has_unsatisfiable_preds(cx, def_id) {\n+            return;\n+        }\n+\n         let mir = cx.tcx.optimized_mir(def_id);\n         let mir_read_only = mir.unwrap_read_only();\n "}, {"sha": "9f7cf400765768c8b8b63726176e3072ce9e030e", "filename": "clippy_lints/src/utils/mod.rs", "status": "modified", "additions": 22, "deletions": 1, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/557f6848bd5b7183f55c1e1522a326e9e1df6030/clippy_lints%2Fsrc%2Futils%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/557f6848bd5b7183f55c1e1522a326e9e1df6030/clippy_lints%2Fsrc%2Futils%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Futils%2Fmod.rs?ref=557f6848bd5b7183f55c1e1522a326e9e1df6030", "patch": "@@ -32,7 +32,7 @@ use rustc::ty::{\n     self,\n     layout::{self, IntegerExt},\n     subst::GenericArg,\n-    Binder, Ty, TyCtxt,\n+    Binder, Ty, TyCtxt, TypeFoldable,\n };\n use rustc_ast::ast::{self, Attribute, LitKind};\n use rustc_attr as attr;\n@@ -1377,6 +1377,27 @@ pub fn is_trait_impl_item(cx: &LateContext<'_, '_>, hir_id: HirId) -> bool {\n     }\n }\n \n+/// Check if it's even possible to satisfy the `where` clause for the item.\n+///\n+/// `trivial_bounds` feature allows functions with unsatisfiable bounds, for example:\n+///\n+/// ```ignore\n+/// fn foo() where i32: Iterator {\n+///     for _ in 2i32 {}\n+/// }\n+/// ```\n+pub fn fn_has_unsatisfiable_preds(cx: &LateContext<'_, '_>, did: DefId) -> bool {\n+    use rustc_infer::traits;\n+    let predicates = cx\n+        .tcx\n+        .predicates_of(did)\n+        .predicates\n+        .iter()\n+        .filter_map(|(p, _)| if p.is_global() { Some(*p) } else { None })\n+        .collect();\n+    !traits::normalize_and_test_predicates(cx.tcx, traits::elaborate_predicates(cx.tcx, predicates).collect())\n+}\n+\n #[cfg(test)]\n mod test {\n     use super::{trim_multiline, without_block_comments};"}, {"sha": "2bb95c18a39129fd7028c5d505c17e74ca06227e", "filename": "tests/ui/crashes/trivial_bounds.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/557f6848bd5b7183f55c1e1522a326e9e1df6030/tests%2Fui%2Fcrashes%2Ftrivial_bounds.rs", "raw_url": "https://github.com/rust-lang/rust/raw/557f6848bd5b7183f55c1e1522a326e9e1df6030/tests%2Fui%2Fcrashes%2Ftrivial_bounds.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcrashes%2Ftrivial_bounds.rs?ref=557f6848bd5b7183f55c1e1522a326e9e1df6030", "patch": "@@ -0,0 +1,13 @@\n+// run-pass\n+\n+#![feature(trivial_bounds)]\n+#![allow(unused, trivial_bounds)]\n+\n+fn test_trivial_bounds()\n+where\n+    i32: Iterator,\n+{\n+    for _ in 2i32 {}\n+}\n+\n+fn main() {}"}]}