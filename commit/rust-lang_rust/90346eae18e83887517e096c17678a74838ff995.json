{"sha": "90346eae18e83887517e096c17678a74838ff995", "node_id": "MDY6Q29tbWl0NzI0NzEyOjkwMzQ2ZWFlMThlODM4ODc1MTdlMDk2YzE3Njc4YTc0ODM4ZmY5OTU=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-03-23T09:18:11Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-03-23T09:18:11Z"}, "message": "Auto merge of #40549 - alexcrichton:uwtable-everywhere, r=eddyb\n\nrustc: Always emit the `uwtable` attribute on Windows\n\nThis commit alters the translation layer to unconditionally emit the `uwtable`\nLLVM attribute on Windows regardless of the `no_landing_pads` setting.\nPreviously I believe we omitted this attribute as an optimization when the\n`-Cpanic=abort` flag was passed, but this unfortunately caused problems for\nGecko.\n\nIt [was discovered] that there was trouble unwinding through Rust functions due\nto foreign exceptions such as illegal instructions or otherwise in-practice\nmethods used to abort a process. In testing it looked like the major difference\nbetween a working binary and a non-working binary is indeed this `uwtable`\nattribute, but this PR has unfortunately not been thoroughly tested in terms of\ncompiling Gecko with `-C panic=abort` *and* this PR to see whether it works, so\nthis is still somewhat working on just suspicion.\n\n[was discovered]: https://bugzilla.mozilla.org/show_bug.cgi?id=1302078", "tree": {"sha": "97124d737d00126df01e1ae853878483103f52f6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/97124d737d00126df01e1ae853878483103f52f6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/90346eae18e83887517e096c17678a74838ff995", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/90346eae18e83887517e096c17678a74838ff995", "html_url": "https://github.com/rust-lang/rust/commit/90346eae18e83887517e096c17678a74838ff995", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/90346eae18e83887517e096c17678a74838ff995/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c6df67afca788453a3c494899fbf5295992bcfba", "url": "https://api.github.com/repos/rust-lang/rust/commits/c6df67afca788453a3c494899fbf5295992bcfba", "html_url": "https://github.com/rust-lang/rust/commit/c6df67afca788453a3c494899fbf5295992bcfba"}, {"sha": "ef90d32f07e187d3e1824d980ad01caac5313101", "url": "https://api.github.com/repos/rust-lang/rust/commits/ef90d32f07e187d3e1824d980ad01caac5313101", "html_url": "https://github.com/rust-lang/rust/commit/ef90d32f07e187d3e1824d980ad01caac5313101"}], "stats": {"total": 60, "additions": 59, "deletions": 1}, "files": [{"sha": "80b563729f5ce3678a641d900e8559834d15037f", "filename": "src/librustc_trans/base.rs", "status": "modified", "additions": 18, "deletions": 1, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/90346eae18e83887517e096c17678a74838ff995/src%2Flibrustc_trans%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/90346eae18e83887517e096c17678a74838ff995/src%2Flibrustc_trans%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Fbase.rs?ref=90346eae18e83887517e096c17678a74838ff995", "patch": "@@ -583,7 +583,24 @@ pub fn trans_instance<'a, 'tcx>(ccx: &CrateContext<'a, 'tcx>, instance: Instance\n \n     ccx.stats().n_closures.set(ccx.stats().n_closures.get() + 1);\n \n-    if !ccx.sess().no_landing_pads() {\n+    // The `uwtable` attribute according to LLVM is:\n+    //\n+    //     This attribute indicates that the ABI being targeted requires that an\n+    //     unwind table entry be produced for this function even if we can show\n+    //     that no exceptions passes by it. This is normally the case for the\n+    //     ELF x86-64 abi, but it can be disabled for some compilation units.\n+    //\n+    // Typically when we're compiling with `-C panic=abort` (which implies this\n+    // `no_landing_pads` check) we don't need `uwtable` because we can't\n+    // generate any exceptions! On Windows, however, exceptions include other\n+    // events such as illegal instructions, segfaults, etc. This means that on\n+    // Windows we end up still needing the `uwtable` attribute even if the `-C\n+    // panic=abort` flag is passed.\n+    //\n+    // You can also find more info on why Windows is whitelisted here in:\n+    //      https://bugzilla.mozilla.org/show_bug.cgi?id=1302078\n+    if !ccx.sess().no_landing_pads() ||\n+       ccx.sess().target.target.options.is_like_windows {\n         attributes::emit_uwtable(lldecl, true);\n     }\n "}, {"sha": "2ab15277084ca645b813fe762a680eadcb6ea00b", "filename": "src/test/codegen/panic-abort-windows.rs", "status": "added", "additions": 41, "deletions": 0, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/90346eae18e83887517e096c17678a74838ff995/src%2Ftest%2Fcodegen%2Fpanic-abort-windows.rs", "raw_url": "https://github.com/rust-lang/rust/raw/90346eae18e83887517e096c17678a74838ff995/src%2Ftest%2Fcodegen%2Fpanic-abort-windows.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fpanic-abort-windows.rs?ref=90346eae18e83887517e096c17678a74838ff995", "patch": "@@ -0,0 +1,41 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// ignore-tidy-linelength\n+\n+// This test is for *-windows-msvc only.\n+// ignore-android\n+// ignore-bitrig\n+// ignore-macos\n+// ignore-dragonfly\n+// ignore-freebsd\n+// ignore-haiku\n+// ignore-ios\n+// ignore-linux\n+// ignore-netbsd\n+// ignore-openbsd\n+// ignore-solaris\n+// ignore-emscripten\n+\n+// compile-flags: -C no-prepopulate-passes -C panic=abort -O\n+\n+#![crate_type = \"lib\"]\n+\n+// CHECK: Function Attrs: uwtable\n+// CHECK-NEXT: define void @normal_uwtable()\n+#[no_mangle]\n+pub fn normal_uwtable() {\n+}\n+\n+// CHECK: Function Attrs: nounwind uwtable\n+// CHECK-NEXT: define void @extern_uwtable()\n+#[no_mangle]\n+pub extern fn extern_uwtable() {\n+}"}]}