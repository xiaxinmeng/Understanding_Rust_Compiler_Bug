{"sha": "175be53e3f62664e445a57c2ad9e23f4bcb296b2", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE3NWJlNTNlM2Y2MjY2NGU0NDVhNTdjMmFkOWUyM2Y0YmNiMjk2YjI=", "commit": {"author": {"name": "Graydon Hoare", "email": "graydon@mozilla.com", "date": "2012-08-08T00:11:43Z"}, "committer": {"name": "Graydon Hoare", "email": "graydon@mozilla.com", "date": "2012-08-08T00:31:26Z"}, "message": "Translate const structs.", "tree": {"sha": "92dcb5d75cb0b8a32c7aacd4c83f3c9ff99df784", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/92dcb5d75cb0b8a32c7aacd4c83f3c9ff99df784"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/175be53e3f62664e445a57c2ad9e23f4bcb296b2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/175be53e3f62664e445a57c2ad9e23f4bcb296b2", "html_url": "https://github.com/rust-lang/rust/commit/175be53e3f62664e445a57c2ad9e23f4bcb296b2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/175be53e3f62664e445a57c2ad9e23f4bcb296b2/comments", "author": {"login": "graydon", "id": 14097, "node_id": "MDQ6VXNlcjE0MDk3", "avatar_url": "https://avatars.githubusercontent.com/u/14097?v=4", "gravatar_id": "", "url": "https://api.github.com/users/graydon", "html_url": "https://github.com/graydon", "followers_url": "https://api.github.com/users/graydon/followers", "following_url": "https://api.github.com/users/graydon/following{/other_user}", "gists_url": "https://api.github.com/users/graydon/gists{/gist_id}", "starred_url": "https://api.github.com/users/graydon/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/graydon/subscriptions", "organizations_url": "https://api.github.com/users/graydon/orgs", "repos_url": "https://api.github.com/users/graydon/repos", "events_url": "https://api.github.com/users/graydon/events{/privacy}", "received_events_url": "https://api.github.com/users/graydon/received_events", "type": "User", "site_admin": false}, "committer": {"login": "graydon", "id": 14097, "node_id": "MDQ6VXNlcjE0MDk3", "avatar_url": "https://avatars.githubusercontent.com/u/14097?v=4", "gravatar_id": "", "url": "https://api.github.com/users/graydon", "html_url": "https://github.com/graydon", "followers_url": "https://api.github.com/users/graydon/followers", "following_url": "https://api.github.com/users/graydon/following{/other_user}", "gists_url": "https://api.github.com/users/graydon/gists{/gist_id}", "starred_url": "https://api.github.com/users/graydon/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/graydon/subscriptions", "organizations_url": "https://api.github.com/users/graydon/orgs", "repos_url": "https://api.github.com/users/graydon/repos", "events_url": "https://api.github.com/users/graydon/events{/privacy}", "received_events_url": "https://api.github.com/users/graydon/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4be8239ac2fe2209dd4f19279151aa18792e6c4a", "url": "https://api.github.com/repos/rust-lang/rust/commits/4be8239ac2fe2209dd4f19279151aa18792e6c4a", "html_url": "https://github.com/rust-lang/rust/commit/4be8239ac2fe2209dd4f19279151aa18792e6c4a"}], "stats": {"total": 42, "additions": 42, "deletions": 0}, "files": [{"sha": "e8f3ecb35aca52d1552662409b916fc6ca330df7", "filename": "src/rustc/middle/check_const.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/175be53e3f62664e445a57c2ad9e23f4bcb296b2/src%2Frustc%2Fmiddle%2Fcheck_const.rs", "raw_url": "https://github.com/rust-lang/rust/raw/175be53e3f62664e445a57c2ad9e23f4bcb296b2/src%2Frustc%2Fmiddle%2Fcheck_const.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustc%2Fmiddle%2Fcheck_const.rs?ref=175be53e3f62664e445a57c2ad9e23f4bcb296b2", "patch": "@@ -103,6 +103,7 @@ fn check_expr(sess: session, def_map: resolve3::DefMap,\n           expr_vec(_, m_imm) |\n           expr_addr_of(m_imm, _) |\n           expr_tup(*) |\n+          expr_struct(*) |\n           expr_rec(*) => { }\n           expr_addr_of(*) => {\n                 sess.span_err("}, {"sha": "01b07d2b34e568377558200fe872b63e105b2348", "filename": "src/rustc/middle/const_eval.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/175be53e3f62664e445a57c2ad9e23f4bcb296b2/src%2Frustc%2Fmiddle%2Fconst_eval.rs", "raw_url": "https://github.com/rust-lang/rust/raw/175be53e3f62664e445a57c2ad9e23f4bcb296b2/src%2Frustc%2Fmiddle%2Fconst_eval.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustc%2Fmiddle%2Fconst_eval.rs?ref=175be53e3f62664e445a57c2ad9e23f4bcb296b2", "patch": "@@ -95,6 +95,7 @@ fn classify(e: @expr,\n                 }\n               }\n \n+              ast::expr_struct(_, fs, none) |\n               ast::expr_rec(fs, none) => {\n                 let cs = do vec::map(fs) |f| {\n                     if f.node.mutbl == ast::m_imm {"}, {"sha": "f4c67efdd77311c7c7bfbf1482262be8c8285ac0", "filename": "src/rustc/middle/trans/consts.rs", "status": "modified", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/175be53e3f62664e445a57c2ad9e23f4bcb296b2/src%2Frustc%2Fmiddle%2Ftrans%2Fconsts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/175be53e3f62664e445a57c2ad9e23f4bcb296b2/src%2Frustc%2Fmiddle%2Ftrans%2Fconsts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustc%2Fmiddle%2Ftrans%2Fconsts.rs?ref=175be53e3f62664e445a57c2ad9e23f4bcb296b2", "patch": "@@ -153,6 +153,32 @@ fn const_expr(cx: @crate_ctxt, e: @ast::expr) -> ValueRef {\n       ast::expr_tup(es) => {\n         C_struct(es.map(|e| const_expr(cx, e)))\n       }\n+      ast::expr_struct(_, fs, _) => {\n+          let ety = ty::expr_ty(cx.tcx, e);\n+          let llty = type_of::type_of(cx, ety);\n+          let class_fields =\n+              match ty::get(ety).struct {\n+              ty::ty_class(clsid, _) =>\n+                  ty::lookup_class_fields(cx.tcx, clsid),\n+              _ =>\n+                  cx.tcx.sess.span_bug(e.span,\n+                                       ~\"didn't resolve to a struct\")\n+          };\n+          let mut cs = ~[];\n+          for class_fields.each |class_field| {\n+              let mut found = false;\n+              for fs.each |field| {\n+                  if class_field.ident == field.node.ident  {\n+                      found = true;\n+                      vec::push(cs, const_expr(cx, field.node.expr));\n+                  }\n+              }\n+              if !found {\n+                  cx.tcx.sess.span_bug(e.span, ~\"missing struct field\");\n+              }\n+          }\n+          C_named_struct(llty, cs)\n+      }\n       ast::expr_rec(fs, none) => {\n         C_struct(fs.map(|f| const_expr(cx, f.node.expr)))\n       }"}, {"sha": "132ecb935cf80577eae365ab14fef4b585c5195c", "filename": "src/test/run-pass/const-struct.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/175be53e3f62664e445a57c2ad9e23f4bcb296b2/src%2Ftest%2Frun-pass%2Fconst-struct.rs", "raw_url": "https://github.com/rust-lang/rust/raw/175be53e3f62664e445a57c2ad9e23f4bcb296b2/src%2Ftest%2Frun-pass%2Fconst-struct.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fconst-struct.rs?ref=175be53e3f62664e445a57c2ad9e23f4bcb296b2", "patch": "@@ -0,0 +1,14 @@\n+\n+struct foo { a: int; b: int; c: int; }\n+\n+const x : foo = foo { a:1, b:2, c: 3 };\n+const y : foo = foo { b:2, c:3, a: 1 };\n+const z : &foo = &foo { a: 10, b: 22, c: 12 };\n+\n+fn main() {\n+    assert x.b == 2;\n+    assert x == y;\n+    assert z.b == 22;\n+    io::println(fmt!{\"0x%x\", x.b as uint});\n+    io::println(fmt!{\"0x%x\", z.c as uint});\n+}"}]}