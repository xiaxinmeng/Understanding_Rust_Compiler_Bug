{"sha": "0c3d08e9676a7defd16b88307838f7294d28c3e5", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBjM2QwOGU5Njc2YTdkZWZkMTZiODgzMDc4MzhmNzI5NGQyOGMzZTU=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2018-10-28T15:26:47Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2018-11-01T17:46:31Z"}, "message": "std: Improve codegen size of accessing TLS\n\nSome code in the TLS implementation in libstd stores `Some(val)` into an\n`&mut Option<T>` (effectively) and then pulls out `&T`, but it currently\nuses `.unwrap()` which can codegen into a panic even though it can never\npanic. With sufficient optimizations enabled (like LTO) the compiler can\nsee through this but this commit helps it along in normal mode\n(`--release` with Cargo by default) to avoid codegen'ing the panic path.\n\nThis ends up improving the optimized codegen on wasm by ensuring that a\ncall to panic pulling in more file size doesn't stick around.", "tree": {"sha": "c0989a845de8bc5eaccc4c042cea6a8eda8488ee", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c0989a845de8bc5eaccc4c042cea6a8eda8488ee"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0c3d08e9676a7defd16b88307838f7294d28c3e5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0c3d08e9676a7defd16b88307838f7294d28c3e5", "html_url": "https://github.com/rust-lang/rust/commit/0c3d08e9676a7defd16b88307838f7294d28c3e5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0c3d08e9676a7defd16b88307838f7294d28c3e5/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "49ec93586ba46b429b8a51e186b5a3719e6bc7d1", "url": "https://api.github.com/repos/rust-lang/rust/commits/49ec93586ba46b429b8a51e186b5a3719e6bc7d1", "html_url": "https://github.com/rust-lang/rust/commit/49ec93586ba46b429b8a51e186b5a3719e6bc7d1"}], "stats": {"total": 22, "additions": 21, "deletions": 1}, "files": [{"sha": "ccbead7cc2f77f3d77d52ba20bb16e6b11feac72", "filename": "src/libstd/thread/local.rs", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/0c3d08e9676a7defd16b88307838f7294d28c3e5/src%2Flibstd%2Fthread%2Flocal.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0c3d08e9676a7defd16b88307838f7294d28c3e5/src%2Flibstd%2Fthread%2Flocal.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fthread%2Flocal.rs?ref=0c3d08e9676a7defd16b88307838f7294d28c3e5", "patch": "@@ -14,6 +14,7 @@\n \n use cell::UnsafeCell;\n use fmt;\n+use hint;\n use mem;\n \n /// A thread local storage key which owns its contents.\n@@ -275,7 +276,15 @@ impl<T: 'static> LocalKey<T> {\n         // operations a little differently and make this safe to call.\n         mem::replace(&mut *ptr, Some(value));\n \n-        (*ptr).as_ref().unwrap()\n+        // After storing `Some` we want to get a reference to the contents of\n+        // what we just stored. While we could use `unwrap` here and it should\n+        // always work it empirically doesn't seem to always get optimized away,\n+        // which means that using something like `try_with` can pull in\n+        // panicking code and cause a large size bloat.\n+        match *ptr {\n+            Some(ref x) => x,\n+            None => hint::unreachable_unchecked(),\n+        }\n     }\n \n     /// Acquires a reference to the value in this TLS key."}, {"sha": "48b530c9957254528422e007a40075a1954d4f1d", "filename": "src/test/run-make/wasm-panic-small/Makefile", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/0c3d08e9676a7defd16b88307838f7294d28c3e5/src%2Ftest%2Frun-make%2Fwasm-panic-small%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/0c3d08e9676a7defd16b88307838f7294d28c3e5/src%2Ftest%2Frun-make%2Fwasm-panic-small%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fwasm-panic-small%2FMakefile?ref=0c3d08e9676a7defd16b88307838f7294d28c3e5", "patch": "@@ -11,6 +11,9 @@ all:\n \t$(RUSTC) foo.rs -C lto -O --target wasm32-unknown-unknown --cfg c\n \twc -c < $(TMPDIR)/foo.wasm\n \t[ \"`wc -c < $(TMPDIR)/foo.wasm`\" -lt \"5120\" ]\n+\t$(RUSTC) foo.rs -C lto -O --target wasm32-unknown-unknown --cfg d\n+\twc -c < $(TMPDIR)/foo.wasm\n+\t[ \"`wc -c < $(TMPDIR)/foo.wasm`\" -lt \"5120\" ]\n else\n all:\n endif"}, {"sha": "441e92976a39671283c142f531172d8cf49504f1", "filename": "src/test/run-make/wasm-panic-small/foo.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/0c3d08e9676a7defd16b88307838f7294d28c3e5/src%2Ftest%2Frun-make%2Fwasm-panic-small%2Ffoo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0c3d08e9676a7defd16b88307838f7294d28c3e5/src%2Ftest%2Frun-make%2Fwasm-panic-small%2Ffoo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fwasm-panic-small%2Ffoo.rs?ref=0c3d08e9676a7defd16b88307838f7294d28c3e5", "patch": "@@ -27,3 +27,11 @@ pub fn foo() {\n pub fn foo() {\n     panic!(\"{}\", \"a\");\n }\n+\n+#[no_mangle]\n+#[cfg(d)]\n+pub fn foo() -> usize {\n+    use std::cell::Cell;\n+    thread_local!(static A: Cell<Vec<u32>> = Cell::new(Vec::new()));\n+    A.try_with(|x| x.replace(Vec::new()).len()).unwrap_or(0)\n+}"}]}