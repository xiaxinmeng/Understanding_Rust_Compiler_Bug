{"sha": "63907234d71d44dc8ade7be37b1e0fefb02390e1", "node_id": "C_kwDOAAsO6NoAKDYzOTA3MjM0ZDcxZDQ0ZGM4YWRlN2JlMzdiMWUwZmVmYjAyMzkwZTE", "commit": {"author": {"name": "Andre Bogus", "email": "bogusandre@gmail.com", "date": "2022-03-03T18:28:05Z"}, "committer": {"name": "Andre Bogus", "email": "bogusandre@gmail.com", "date": "2022-03-03T18:28:05Z"}, "message": "Omit dbg_macro in test code", "tree": {"sha": "bfc1db5783d8f84c29d924276c45ffabc62e5b76", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bfc1db5783d8f84c29d924276c45ffabc62e5b76"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/63907234d71d44dc8ade7be37b1e0fefb02390e1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/63907234d71d44dc8ade7be37b1e0fefb02390e1", "html_url": "https://github.com/rust-lang/rust/commit/63907234d71d44dc8ade7be37b1e0fefb02390e1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/63907234d71d44dc8ade7be37b1e0fefb02390e1/comments", "author": {"login": "llogiq", "id": 4200835, "node_id": "MDQ6VXNlcjQyMDA4MzU=", "avatar_url": "https://avatars.githubusercontent.com/u/4200835?v=4", "gravatar_id": "", "url": "https://api.github.com/users/llogiq", "html_url": "https://github.com/llogiq", "followers_url": "https://api.github.com/users/llogiq/followers", "following_url": "https://api.github.com/users/llogiq/following{/other_user}", "gists_url": "https://api.github.com/users/llogiq/gists{/gist_id}", "starred_url": "https://api.github.com/users/llogiq/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/llogiq/subscriptions", "organizations_url": "https://api.github.com/users/llogiq/orgs", "repos_url": "https://api.github.com/users/llogiq/repos", "events_url": "https://api.github.com/users/llogiq/events{/privacy}", "received_events_url": "https://api.github.com/users/llogiq/received_events", "type": "User", "site_admin": false}, "committer": {"login": "llogiq", "id": 4200835, "node_id": "MDQ6VXNlcjQyMDA4MzU=", "avatar_url": "https://avatars.githubusercontent.com/u/4200835?v=4", "gravatar_id": "", "url": "https://api.github.com/users/llogiq", "html_url": "https://github.com/llogiq", "followers_url": "https://api.github.com/users/llogiq/followers", "following_url": "https://api.github.com/users/llogiq/following{/other_user}", "gists_url": "https://api.github.com/users/llogiq/gists{/gist_id}", "starred_url": "https://api.github.com/users/llogiq/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/llogiq/subscriptions", "organizations_url": "https://api.github.com/users/llogiq/orgs", "repos_url": "https://api.github.com/users/llogiq/repos", "events_url": "https://api.github.com/users/llogiq/events{/privacy}", "received_events_url": "https://api.github.com/users/llogiq/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6e211eac7c682b465ed21000f5a952a272208e2c", "url": "https://api.github.com/repos/rust-lang/rust/commits/6e211eac7c682b465ed21000f5a952a272208e2c", "html_url": "https://github.com/rust-lang/rust/commit/6e211eac7c682b465ed21000f5a952a272208e2c"}], "stats": {"total": 31, "additions": 21, "deletions": 10}, "files": [{"sha": "a0e5d30263316b88921d4b9671991106b4b4f510", "filename": "clippy_lints/src/dbg_macro.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/63907234d71d44dc8ade7be37b1e0fefb02390e1/clippy_lints%2Fsrc%2Fdbg_macro.rs", "raw_url": "https://github.com/rust-lang/rust/raw/63907234d71d44dc8ade7be37b1e0fefb02390e1/clippy_lints%2Fsrc%2Fdbg_macro.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fdbg_macro.rs?ref=63907234d71d44dc8ade7be37b1e0fefb02390e1", "patch": "@@ -1,4 +1,5 @@\n use clippy_utils::diagnostics::span_lint_and_sugg;\n+use clippy_utils::is_in_test_function;\n use clippy_utils::macros::root_macro_call_first_node;\n use clippy_utils::source::snippet_with_applicability;\n use rustc_errors::Applicability;\n@@ -35,6 +36,10 @@ impl LateLintPass<'_> for DbgMacro {\n     fn check_expr(&mut self, cx: &LateContext<'_>, expr: &Expr<'_>) {\n         let Some(macro_call) = root_macro_call_first_node(cx, expr) else { return };\n         if cx.tcx.is_diagnostic_item(sym::dbg_macro, macro_call.def_id) {\n+            // we make an exception for test code\n+            if is_in_test_function(cx.tcx, expr.hir_id) {\n+                return;\n+            }\n             let mut applicability = Applicability::MachineApplicable;\n             let suggestion = match expr.peel_drop_temps().kind {\n                 // dbg!()"}, {"sha": "baf01174b6764b8663d97593018db1549480e9ea", "filename": "tests/ui/dbg_macro.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/63907234d71d44dc8ade7be37b1e0fefb02390e1/tests%2Fui%2Fdbg_macro.rs", "raw_url": "https://github.com/rust-lang/rust/raw/63907234d71d44dc8ade7be37b1e0fefb02390e1/tests%2Fui%2Fdbg_macro.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fdbg_macro.rs?ref=63907234d71d44dc8ade7be37b1e0fefb02390e1", "patch": "@@ -1,3 +1,4 @@\n+// compile-flags: --test\n #![warn(clippy::dbg_macro)]\n \n fn foo(n: u32) -> u32 {\n@@ -40,3 +41,8 @@ mod issue7274 {\n         dbg!(2);\n     });\n }\n+\n+#[test]\n+pub fn issue8481() {\n+    dbg!(1);\n+}"}, {"sha": "a3e7a7162e51dff7516e79451764518e33e6f6bf", "filename": "tests/ui/dbg_macro.stderr", "status": "modified", "additions": 10, "deletions": 10, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/63907234d71d44dc8ade7be37b1e0fefb02390e1/tests%2Fui%2Fdbg_macro.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/63907234d71d44dc8ade7be37b1e0fefb02390e1/tests%2Fui%2Fdbg_macro.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fdbg_macro.stderr?ref=63907234d71d44dc8ade7be37b1e0fefb02390e1", "patch": "@@ -1,5 +1,5 @@\n error: `dbg!` macro is intended as a debugging tool\n-  --> $DIR/dbg_macro.rs:4:22\n+  --> $DIR/dbg_macro.rs:5:22\n    |\n LL |     if let Some(n) = dbg!(n.checked_sub(4)) { n } else { n }\n    |                      ^^^^^^^^^^^^^^^^^^^^^^\n@@ -11,7 +11,7 @@ LL |     if let Some(n) = n.checked_sub(4) { n } else { n }\n    |                      ~~~~~~~~~~~~~~~~\n \n error: `dbg!` macro is intended as a debugging tool\n-  --> $DIR/dbg_macro.rs:8:8\n+  --> $DIR/dbg_macro.rs:9:8\n    |\n LL |     if dbg!(n <= 1) {\n    |        ^^^^^^^^^^^^\n@@ -22,7 +22,7 @@ LL |     if n <= 1 {\n    |        ~~~~~~\n \n error: `dbg!` macro is intended as a debugging tool\n-  --> $DIR/dbg_macro.rs:9:9\n+  --> $DIR/dbg_macro.rs:10:9\n    |\n LL |         dbg!(1)\n    |         ^^^^^^^\n@@ -33,7 +33,7 @@ LL |         1\n    |\n \n error: `dbg!` macro is intended as a debugging tool\n-  --> $DIR/dbg_macro.rs:11:9\n+  --> $DIR/dbg_macro.rs:12:9\n    |\n LL |         dbg!(n * factorial(n - 1))\n    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^\n@@ -44,7 +44,7 @@ LL |         n * factorial(n - 1)\n    |\n \n error: `dbg!` macro is intended as a debugging tool\n-  --> $DIR/dbg_macro.rs:16:5\n+  --> $DIR/dbg_macro.rs:17:5\n    |\n LL |     dbg!(42);\n    |     ^^^^^^^^\n@@ -55,7 +55,7 @@ LL |     42;\n    |     ~~\n \n error: `dbg!` macro is intended as a debugging tool\n-  --> $DIR/dbg_macro.rs:17:5\n+  --> $DIR/dbg_macro.rs:18:5\n    |\n LL |     dbg!(dbg!(dbg!(42)));\n    |     ^^^^^^^^^^^^^^^^^^^^\n@@ -66,7 +66,7 @@ LL |     dbg!(dbg!(42));\n    |     ~~~~~~~~~~~~~~\n \n error: `dbg!` macro is intended as a debugging tool\n-  --> $DIR/dbg_macro.rs:18:14\n+  --> $DIR/dbg_macro.rs:19:14\n    |\n LL |     foo(3) + dbg!(factorial(4));\n    |              ^^^^^^^^^^^^^^^^^^\n@@ -77,7 +77,7 @@ LL |     foo(3) + factorial(4);\n    |              ~~~~~~~~~~~~\n \n error: `dbg!` macro is intended as a debugging tool\n-  --> $DIR/dbg_macro.rs:19:5\n+  --> $DIR/dbg_macro.rs:20:5\n    |\n LL |     dbg!(1, 2, dbg!(3, 4));\n    |     ^^^^^^^^^^^^^^^^^^^^^^\n@@ -88,7 +88,7 @@ LL |     (1, 2, dbg!(3, 4));\n    |     ~~~~~~~~~~~~~~~~~~\n \n error: `dbg!` macro is intended as a debugging tool\n-  --> $DIR/dbg_macro.rs:20:5\n+  --> $DIR/dbg_macro.rs:21:5\n    |\n LL |     dbg!(1, 2, 3, 4, 5);\n    |     ^^^^^^^^^^^^^^^^^^^\n@@ -99,7 +99,7 @@ LL |     (1, 2, 3, 4, 5);\n    |     ~~~~~~~~~~~~~~~\n \n error: `dbg!` macro is intended as a debugging tool\n-  --> $DIR/dbg_macro.rs:40:9\n+  --> $DIR/dbg_macro.rs:41:9\n    |\n LL |         dbg!(2);\n    |         ^^^^^^^"}]}