{"sha": "da7f1eb756ba849b70ccb7e6c961ccf233e19099", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRhN2YxZWI3NTZiYTg0OWI3MGNjYjdlNmM5NjFjY2YyMzNlMTkwOTk=", "commit": {"author": {"name": "Lukas Tobias Wirth", "email": "lukastw97@gmail.com", "date": "2021-05-20T15:27:51Z"}, "committer": {"name": "Lukas Tobias Wirth", "email": "lukastw97@gmail.com", "date": "2021-05-20T15:45:59Z"}, "message": "Don't compare ast::Visibility by stringifying", "tree": {"sha": "dcb4766c1dbd85188ebea29a2d6f9f48d369a76c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/dcb4766c1dbd85188ebea29a2d6f9f48d369a76c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/da7f1eb756ba849b70ccb7e6c961ccf233e19099", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/da7f1eb756ba849b70ccb7e6c961ccf233e19099", "html_url": "https://github.com/rust-lang/rust/commit/da7f1eb756ba849b70ccb7e6c961ccf233e19099", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/da7f1eb756ba849b70ccb7e6c961ccf233e19099/comments", "author": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8bb37737c9e8b7a390ae29d5fb0daaeeb495d2b5", "url": "https://api.github.com/repos/rust-lang/rust/commits/8bb37737c9e8b7a390ae29d5fb0daaeeb495d2b5", "html_url": "https://github.com/rust-lang/rust/commit/8bb37737c9e8b7a390ae29d5fb0daaeeb495d2b5"}], "stats": {"total": 80, "additions": 74, "deletions": 6}, "files": [{"sha": "fc117bd9a8469c6eb676977512eac5bd1211ca10", "filename": "crates/ide_assists/src/handlers/merge_imports.rs", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/da7f1eb756ba849b70ccb7e6c961ccf233e19099/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fmerge_imports.rs", "raw_url": "https://github.com/rust-lang/rust/raw/da7f1eb756ba849b70ccb7e6c961ccf233e19099/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fmerge_imports.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fmerge_imports.rs?ref=da7f1eb756ba849b70ccb7e6c961ccf233e19099", "patch": "@@ -212,6 +212,20 @@ pub(crate) use std::fmt::{Debug, Display};\n         )\n     }\n \n+    #[test]\n+    fn merge_pub_in_path_crate() {\n+        check_assist(\n+            merge_imports,\n+            r\"\n+pub(in this::path) use std::fmt$0::Debug;\n+pub(in this::path) use std::fmt::Display;\n+\",\n+            r\"\n+pub(in this::path) use std::fmt::{Debug, Display};\n+\",\n+        )\n+    }\n+\n     #[test]\n     fn test_merge_nested() {\n         check_assist("}, {"sha": "0dbabb44fba674986575f3b9fd2b0495aecc29b5", "filename": "crates/ide_db/src/helpers/merge_imports.rs", "status": "modified", "additions": 9, "deletions": 6, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/da7f1eb756ba849b70ccb7e6c961ccf233e19099/crates%2Fide_db%2Fsrc%2Fhelpers%2Fmerge_imports.rs", "raw_url": "https://github.com/rust-lang/rust/raw/da7f1eb756ba849b70ccb7e6c961ccf233e19099/crates%2Fide_db%2Fsrc%2Fhelpers%2Fmerge_imports.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_db%2Fsrc%2Fhelpers%2Fmerge_imports.rs?ref=da7f1eb756ba849b70ccb7e6c961ccf233e19099", "patch": "@@ -292,9 +292,7 @@ fn path_segment_cmp(a: &ast::PathSegment, b: &ast::PathSegment) -> Ordering {\n pub fn eq_visibility(vis0: Option<ast::Visibility>, vis1: Option<ast::Visibility>) -> bool {\n     match (vis0, vis1) {\n         (None, None) => true,\n-        // FIXME: Don't use the string representation to check for equality\n-        // spaces inside of the node would break this comparison\n-        (Some(vis0), Some(vis1)) => vis0.to_string() == vis1.to_string(),\n+        (Some(vis0), Some(vis1)) => vis0.is_eq_to(&vis1),\n         _ => false,\n     }\n }\n@@ -303,9 +301,14 @@ pub fn eq_attrs(\n     attrs0: impl Iterator<Item = ast::Attr>,\n     attrs1: impl Iterator<Item = ast::Attr>,\n ) -> bool {\n-    let attrs0 = attrs0.map(|attr| attr.to_string());\n-    let attrs1 = attrs1.map(|attr| attr.to_string());\n-    attrs0.eq(attrs1)\n+    // FIXME order of attributes should not matter\n+    let attrs0 = attrs0\n+        .flat_map(|attr| attr.syntax().descendants_with_tokens())\n+        .flat_map(|it| it.into_token());\n+    let attrs1 = attrs1\n+        .flat_map(|attr| attr.syntax().descendants_with_tokens())\n+        .flat_map(|it| it.into_token());\n+    stdx::iter_eq_by(attrs0, attrs1, |tok, tok2| tok.text() == tok2.text())\n }\n \n fn path_is_self(path: &ast::Path) -> bool {"}, {"sha": "18d5fadb9c52a428aa5d2bc80bee5ef9ea7676c1", "filename": "crates/stdx/src/lib.rs", "status": "modified", "additions": 28, "deletions": 0, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/da7f1eb756ba849b70ccb7e6c961ccf233e19099/crates%2Fstdx%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/da7f1eb756ba849b70ccb7e6c961ccf233e19099/crates%2Fstdx%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fstdx%2Fsrc%2Flib.rs?ref=da7f1eb756ba849b70ccb7e6c961ccf233e19099", "patch": "@@ -140,6 +140,34 @@ impl JodChild {\n     }\n }\n \n+// feature: iter_order_by\n+// Iterator::eq_by\n+pub fn iter_eq_by<I, I2, F>(this: I2, other: I, mut eq: F) -> bool\n+where\n+    I: IntoIterator,\n+    I2: IntoIterator,\n+    F: FnMut(I2::Item, I::Item) -> bool,\n+{\n+    let mut other = other.into_iter();\n+    let mut this = this.into_iter();\n+\n+    loop {\n+        let x = match this.next() {\n+            None => return other.next().is_none(),\n+            Some(val) => val,\n+        };\n+\n+        let y = match other.next() {\n+            None => return false,\n+            Some(val) => val,\n+        };\n+\n+        if !eq(x, y) {\n+            return false;\n+        }\n+    }\n+}\n+\n #[cfg(test)]\n mod tests {\n     use super::*;"}, {"sha": "df8f98b5b5f50448d1011c97459501ff066f9b79", "filename": "crates/syntax/src/ast/node_ext.rs", "status": "modified", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/da7f1eb756ba849b70ccb7e6c961ccf233e19099/crates%2Fsyntax%2Fsrc%2Fast%2Fnode_ext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/da7f1eb756ba849b70ccb7e6c961ccf233e19099/crates%2Fsyntax%2Fsrc%2Fast%2Fnode_ext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fsyntax%2Fsrc%2Fast%2Fnode_ext.rs?ref=da7f1eb756ba849b70ccb7e6c961ccf233e19099", "patch": "@@ -608,6 +608,29 @@ impl ast::Visibility {\n             None => VisibilityKind::Pub,\n         }\n     }\n+\n+    pub fn is_eq_to(&self, other: &Self) -> bool {\n+        match (self.kind(), other.kind()) {\n+            (VisibilityKind::In(this), VisibilityKind::In(other)) => {\n+                stdx::iter_eq_by(this.segments(), other.segments(), |lhs, rhs| {\n+                    lhs.kind().zip(rhs.kind()).map_or(false, |it| match it {\n+                        (PathSegmentKind::CrateKw, PathSegmentKind::CrateKw)\n+                        | (PathSegmentKind::SelfKw, PathSegmentKind::SelfKw)\n+                        | (PathSegmentKind::SuperKw, PathSegmentKind::SuperKw) => true,\n+                        (PathSegmentKind::Name(lhs), PathSegmentKind::Name(rhs)) => {\n+                            lhs.text() == rhs.text()\n+                        }\n+                        _ => false,\n+                    })\n+                })\n+            }\n+            (VisibilityKind::PubSelf, VisibilityKind::PubSelf)\n+            | (VisibilityKind::PubSuper, VisibilityKind::PubSuper)\n+            | (VisibilityKind::PubCrate, VisibilityKind::PubCrate)\n+            | (VisibilityKind::Pub, VisibilityKind::Pub) => true,\n+            _ => false,\n+        }\n+    }\n }\n \n impl ast::LifetimeParam {"}]}