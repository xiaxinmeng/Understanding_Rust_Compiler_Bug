{"sha": "0f8cd43ee8c3614e04b5c624dd8a45758d7023da", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBmOGNkNDNlZThjMzYxNGUwNGI1YzYyNGRkOGE0NTc1OGQ3MDIzZGE=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-05-23T12:05:47Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-05-23T12:05:47Z"}, "message": "Auto merge of #85599 - RalfJung:immut-allocs, r=oli-obk\n\nfix deallocation of immutable allocations\n\nAs part of https://github.com/rust-lang/miri/pull/1814, I realized that we currently allow deallocating immutable allocations. This PR fixes that, and also adds some new APIs that are required to still support the existing Miri backtrace support.\n\nr? `@oli-obk`", "tree": {"sha": "4c385da8a06e794176c44745c01018e04f3aff1d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4c385da8a06e794176c44745c01018e04f3aff1d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0f8cd43ee8c3614e04b5c624dd8a45758d7023da", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0f8cd43ee8c3614e04b5c624dd8a45758d7023da", "html_url": "https://github.com/rust-lang/rust/commit/0f8cd43ee8c3614e04b5c624dd8a45758d7023da", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0f8cd43ee8c3614e04b5c624dd8a45758d7023da/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6e92fb409816c65cd0a78a1fbcc71e2fbabdf50a", "url": "https://api.github.com/repos/rust-lang/rust/commits/6e92fb409816c65cd0a78a1fbcc71e2fbabdf50a", "html_url": "https://github.com/rust-lang/rust/commit/6e92fb409816c65cd0a78a1fbcc71e2fbabdf50a"}, {"sha": "f9b36b4f65ca1c4b73d1692350ada59d05aacece", "url": "https://api.github.com/repos/rust-lang/rust/commits/f9b36b4f65ca1c4b73d1692350ada59d05aacece", "html_url": "https://github.com/rust-lang/rust/commit/f9b36b4f65ca1c4b73d1692350ada59d05aacece"}], "stats": {"total": 55, "additions": 36, "deletions": 19}, "files": [{"sha": "6b132e4ff0fb8093712495e2935ff17cb7d2f3a6", "filename": "compiler/rustc_codegen_cranelift/src/constant.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0f8cd43ee8c3614e04b5c624dd8a45758d7023da/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fconstant.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0f8cd43ee8c3614e04b5c624dd8a45758d7023da/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fconstant.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fconstant.rs?ref=0f8cd43ee8c3614e04b5c624dd8a45758d7023da", "patch": "@@ -2,6 +2,7 @@\n \n use rustc_span::DUMMY_SP;\n \n+use rustc_ast::Mutability;\n use rustc_data_structures::fx::{FxHashMap, FxHashSet};\n use rustc_errors::ErrorReported;\n use rustc_middle::middle::codegen_fn_attrs::CodegenFnAttrFlags;\n@@ -175,6 +176,7 @@ pub(crate) fn codegen_const_value<'tcx>(\n                 let mut alloc = Allocation::from_bytes(\n                     std::iter::repeat(0).take(size.bytes_usize()).collect::<Vec<u8>>(),\n                     align,\n+                    Mutability::Not,\n                 );\n                 alloc.write_scalar(fx, alloc_range(Size::ZERO, size), x.into()).unwrap();\n                 let alloc = fx.tcx.intern_const_alloc(alloc);"}, {"sha": "ee3902991e911afe5073ea1606996d3ddf2339e7", "filename": "compiler/rustc_middle/src/mir/interpret/allocation.rs", "status": "modified", "additions": 9, "deletions": 5, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/0f8cd43ee8c3614e04b5c624dd8a45758d7023da/compiler%2Frustc_middle%2Fsrc%2Fmir%2Finterpret%2Fallocation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0f8cd43ee8c3614e04b5c624dd8a45758d7023da/compiler%2Frustc_middle%2Fsrc%2Fmir%2Finterpret%2Fallocation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fmir%2Finterpret%2Fallocation.rs?ref=0f8cd43ee8c3614e04b5c624dd8a45758d7023da", "patch": "@@ -99,22 +99,26 @@ impl AllocRange {\n \n // The constructors are all without extra; the extra gets added by a machine hook later.\n impl<Tag> Allocation<Tag> {\n-    /// Creates a read-only allocation initialized by the given bytes\n-    pub fn from_bytes<'a>(slice: impl Into<Cow<'a, [u8]>>, align: Align) -> Self {\n+    /// Creates an allocation initialized by the given bytes\n+    pub fn from_bytes<'a>(\n+        slice: impl Into<Cow<'a, [u8]>>,\n+        align: Align,\n+        mutability: Mutability,\n+    ) -> Self {\n         let bytes = slice.into().into_owned();\n         let size = Size::from_bytes(bytes.len());\n         Self {\n             bytes,\n             relocations: Relocations::new(),\n             init_mask: InitMask::new(size, true),\n             align,\n-            mutability: Mutability::Not,\n+            mutability,\n             extra: (),\n         }\n     }\n \n-    pub fn from_byte_aligned_bytes<'a>(slice: impl Into<Cow<'a, [u8]>>) -> Self {\n-        Allocation::from_bytes(slice, Align::ONE)\n+    pub fn from_bytes_byte_aligned_immutable<'a>(slice: impl Into<Cow<'a, [u8]>>) -> Self {\n+        Allocation::from_bytes(slice, Align::ONE, Mutability::Not)\n     }\n \n     pub fn uninit(size: Size, align: Align) -> Self {"}, {"sha": "790463d6fc6d256b673b8d1e29f030d7bbc429e6", "filename": "compiler/rustc_middle/src/ty/context.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0f8cd43ee8c3614e04b5c624dd8a45758d7023da/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0f8cd43ee8c3614e04b5c624dd8a45758d7023da/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs?ref=0f8cd43ee8c3614e04b5c624dd8a45758d7023da", "patch": "@@ -1072,7 +1072,7 @@ impl<'tcx> TyCtxt<'tcx> {\n     /// Allocates a read-only byte or string literal for `mir::interpret`.\n     pub fn allocate_bytes(self, bytes: &[u8]) -> interpret::AllocId {\n         // Create an allocation that just contains these bytes.\n-        let alloc = interpret::Allocation::from_byte_aligned_bytes(bytes);\n+        let alloc = interpret::Allocation::from_bytes_byte_aligned_immutable(bytes);\n         let alloc = self.intern_const_alloc(alloc);\n         self.create_memory_alloc(alloc)\n     }"}, {"sha": "a12185393de3e8c59a84a7e54f0cd5f3fa6a2548", "filename": "compiler/rustc_mir/src/const_eval/eval_queries.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/0f8cd43ee8c3614e04b5c624dd8a45758d7023da/compiler%2Frustc_mir%2Fsrc%2Fconst_eval%2Feval_queries.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0f8cd43ee8c3614e04b5c624dd8a45758d7023da/compiler%2Frustc_mir%2Fsrc%2Fconst_eval%2Feval_queries.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Fconst_eval%2Feval_queries.rs?ref=0f8cd43ee8c3614e04b5c624dd8a45758d7023da", "patch": "@@ -169,8 +169,9 @@ pub(super) fn op_to_const<'tcx>(\n                         (ecx.tcx.global_alloc(ptr.alloc_id).unwrap_memory(), ptr.offset.bytes())\n                     }\n                     Scalar::Int { .. } => (\n-                        ecx.tcx\n-                            .intern_const_alloc(Allocation::from_byte_aligned_bytes(b\"\" as &[u8])),\n+                        ecx.tcx.intern_const_alloc(Allocation::from_bytes_byte_aligned_immutable(\n+                            b\"\" as &[u8],\n+                        )),\n                         0,\n                     ),\n                 };"}, {"sha": "792a4749108be02132524a554174b025fcebba97", "filename": "compiler/rustc_mir/src/interpret/intrinsics/caller_location.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/0f8cd43ee8c3614e04b5c624dd8a45758d7023da/compiler%2Frustc_mir%2Fsrc%2Finterpret%2Fintrinsics%2Fcaller_location.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0f8cd43ee8c3614e04b5c624dd8a45758d7023da/compiler%2Frustc_mir%2Fsrc%2Finterpret%2Fintrinsics%2Fcaller_location.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Finterpret%2Fintrinsics%2Fcaller_location.rs?ref=0f8cd43ee8c3614e04b5c624dd8a45758d7023da", "patch": "@@ -1,5 +1,6 @@\n use std::convert::TryFrom;\n \n+use rustc_ast::Mutability;\n use rustc_hir::lang_items::LangItem;\n use rustc_middle::mir::TerminatorKind;\n use rustc_middle::ty::subst::Subst;\n@@ -79,7 +80,8 @@ impl<'mir, 'tcx: 'mir, M: Machine<'mir, 'tcx>> InterpCx<'mir, 'tcx, M> {\n         line: u32,\n         col: u32,\n     ) -> MPlaceTy<'tcx, M::PointerTag> {\n-        let file = self.allocate_str(&filename.as_str(), MemoryKind::CallerLocation);\n+        let file =\n+            self.allocate_str(&filename.as_str(), MemoryKind::CallerLocation, Mutability::Not);\n         let line = Scalar::from_u32(line);\n         let col = Scalar::from_u32(col);\n "}, {"sha": "4978cc3606dd69f09ce5ff7fb1336089ba64d453", "filename": "compiler/rustc_mir/src/interpret/intrinsics/type_name.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0f8cd43ee8c3614e04b5c624dd8a45758d7023da/compiler%2Frustc_mir%2Fsrc%2Finterpret%2Fintrinsics%2Ftype_name.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0f8cd43ee8c3614e04b5c624dd8a45758d7023da/compiler%2Frustc_mir%2Fsrc%2Finterpret%2Fintrinsics%2Ftype_name.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Finterpret%2Fintrinsics%2Ftype_name.rs?ref=0f8cd43ee8c3614e04b5c624dd8a45758d7023da", "patch": "@@ -197,6 +197,6 @@ impl Write for AbsolutePathPrinter<'_> {\n /// Directly returns an `Allocation` containing an absolute path representation of the given type.\n crate fn alloc_type_name<'tcx>(tcx: TyCtxt<'tcx>, ty: Ty<'tcx>) -> &'tcx Allocation {\n     let path = AbsolutePathPrinter { tcx, path: String::new() }.print_type(ty).unwrap().path;\n-    let alloc = Allocation::from_byte_aligned_bytes(path.into_bytes());\n+    let alloc = Allocation::from_bytes_byte_aligned_immutable(path.into_bytes());\n     tcx.intern_const_alloc(alloc)\n }"}, {"sha": "77de19ac674c22c205e4d48f270bf93c9144c2ff", "filename": "compiler/rustc_mir/src/interpret/memory.rs", "status": "modified", "additions": 6, "deletions": 4, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/0f8cd43ee8c3614e04b5c624dd8a45758d7023da/compiler%2Frustc_mir%2Fsrc%2Finterpret%2Fmemory.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0f8cd43ee8c3614e04b5c624dd8a45758d7023da/compiler%2Frustc_mir%2Fsrc%2Finterpret%2Fmemory.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Finterpret%2Fmemory.rs?ref=0f8cd43ee8c3614e04b5c624dd8a45758d7023da", "patch": "@@ -219,9 +219,11 @@ impl<'mir, 'tcx, M: Machine<'mir, 'tcx>> Memory<'mir, 'tcx, M> {\n     pub fn allocate_bytes(\n         &mut self,\n         bytes: &[u8],\n+        align: Align,\n         kind: MemoryKind<M::MemoryKind>,\n+        mutability: Mutability,\n     ) -> Pointer<M::PointerTag> {\n-        let alloc = Allocation::from_byte_aligned_bytes(bytes);\n+        let alloc = Allocation::from_bytes(bytes, align, mutability);\n         self.allocate_with(alloc, kind)\n     }\n \n@@ -321,6 +323,9 @@ impl<'mir, 'tcx, M: Machine<'mir, 'tcx>> Memory<'mir, 'tcx, M> {\n             }\n         };\n \n+        if alloc.mutability == Mutability::Not {\n+            throw_ub_format!(\"deallocating immutable allocation {}\", ptr.alloc_id);\n+        }\n         if alloc_kind != kind {\n             throw_ub_format!(\n                 \"deallocating {}, which is {} memory, using {} deallocation operation\",\n@@ -625,9 +630,6 @@ impl<'mir, 'tcx, M: Machine<'mir, 'tcx>> Memory<'mir, 'tcx, M> {\n             // Need to make a copy, even if `get_global_alloc` is able\n             // to give us a cheap reference.\n             let alloc = Self::get_global_alloc(memory_extra, tcx, id, /*is_write*/ true)?;\n-            if alloc.mutability == Mutability::Not {\n-                throw_ub!(WriteToReadOnly(id))\n-            }\n             let kind = M::GLOBAL_KIND.expect(\n                 \"I got a global allocation that I have to copy but the machine does \\\n                     not expect that to happen\","}, {"sha": "79aaff1c5eb34f60cc8bef308c7b20be03e96a9a", "filename": "compiler/rustc_mir/src/interpret/place.rs", "status": "modified", "additions": 9, "deletions": 3, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/0f8cd43ee8c3614e04b5c624dd8a45758d7023da/compiler%2Frustc_mir%2Fsrc%2Finterpret%2Fplace.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0f8cd43ee8c3614e04b5c624dd8a45758d7023da/compiler%2Frustc_mir%2Fsrc%2Finterpret%2Fplace.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Finterpret%2Fplace.rs?ref=0f8cd43ee8c3614e04b5c624dd8a45758d7023da", "patch": "@@ -6,6 +6,7 @@ use std::convert::TryFrom;\n use std::fmt::Debug;\n use std::hash::Hash;\n \n+use rustc_ast::Mutability;\n use rustc_macros::HashStable;\n use rustc_middle::mir;\n use rustc_middle::ty::layout::{PrimitiveExt, TyAndLayout};\n@@ -1024,18 +1025,23 @@ where\n         MPlaceTy::from_aligned_ptr(ptr, layout)\n     }\n \n-    /// Returns a wide MPlace.\n+    /// Returns a wide MPlace of type `&'static [mut] str` to a new 1-aligned allocation.\n     pub fn allocate_str(\n         &mut self,\n         str: &str,\n         kind: MemoryKind<M::MemoryKind>,\n+        mutbl: Mutability,\n     ) -> MPlaceTy<'tcx, M::PointerTag> {\n-        let ptr = self.memory.allocate_bytes(str.as_bytes(), kind);\n+        let ptr = self.memory.allocate_bytes(str.as_bytes(), Align::ONE, kind, mutbl);\n         let meta = Scalar::from_machine_usize(u64::try_from(str.len()).unwrap(), self);\n         let mplace =\n             MemPlace { ptr: ptr.into(), align: Align::ONE, meta: MemPlaceMeta::Meta(meta) };\n \n-        let layout = self.layout_of(self.tcx.mk_static_str()).unwrap();\n+        let ty = self.tcx.mk_ref(\n+            self.tcx.lifetimes.re_static,\n+            ty::TypeAndMut { ty: self.tcx.types.str_, mutbl },\n+        );\n+        let layout = self.layout_of(ty).unwrap();\n         MPlaceTy { mplace, layout }\n     }\n "}, {"sha": "d62fd161e2f86e0f84d7272faca42c0b52cbd6b3", "filename": "compiler/rustc_mir_build/src/thir/constant.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/0f8cd43ee8c3614e04b5c624dd8a45758d7023da/compiler%2Frustc_mir_build%2Fsrc%2Fthir%2Fconstant.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0f8cd43ee8c3614e04b5c624dd8a45758d7023da/compiler%2Frustc_mir_build%2Fsrc%2Fthir%2Fconstant.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fthir%2Fconstant.rs?ref=0f8cd43ee8c3614e04b5c624dd8a45758d7023da", "patch": "@@ -25,14 +25,14 @@ crate fn lit_to_const<'tcx>(\n     let lit = match (lit, &ty.kind()) {\n         (ast::LitKind::Str(s, _), ty::Ref(_, inner_ty, _)) if inner_ty.is_str() => {\n             let s = s.as_str();\n-            let allocation = Allocation::from_byte_aligned_bytes(s.as_bytes());\n+            let allocation = Allocation::from_bytes_byte_aligned_immutable(s.as_bytes());\n             let allocation = tcx.intern_const_alloc(allocation);\n             ConstValue::Slice { data: allocation, start: 0, end: s.len() }\n         }\n         (ast::LitKind::ByteStr(data), ty::Ref(_, inner_ty, _))\n             if matches!(inner_ty.kind(), ty::Slice(_)) =>\n         {\n-            let allocation = Allocation::from_byte_aligned_bytes(data as &[u8]);\n+            let allocation = Allocation::from_bytes_byte_aligned_immutable(data as &[u8]);\n             let allocation = tcx.intern_const_alloc(allocation);\n             ConstValue::Slice { data: allocation, start: 0, end: data.len() }\n         }"}]}