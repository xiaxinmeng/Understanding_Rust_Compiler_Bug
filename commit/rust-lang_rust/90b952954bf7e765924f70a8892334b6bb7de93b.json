{"sha": "90b952954bf7e765924f70a8892334b6bb7de93b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjkwYjk1Mjk1NGJmN2U3NjU5MjRmNzBhODg5MjMzNGI2YmI3ZGU5M2I=", "commit": {"author": {"name": "Kevin Ballard", "email": "kevin@sb.org", "date": "2015-05-14T07:54:05Z"}, "committer": {"name": "Kevin Ballard", "email": "kevin@sb.org", "date": "2015-05-14T17:35:35Z"}, "message": "Move configuration 1 phase before crate metadata collection\n\nStripping unconfigured items prior to collecting crate metadata means we\ncan say things like `#![cfg_attr(foo, crate_type=\"lib\")]`.\n\nFixes #25347.", "tree": {"sha": "fac99302c259441fc506d91bd721ed20400f6fcc", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fac99302c259441fc506d91bd721ed20400f6fcc"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/90b952954bf7e765924f70a8892334b6bb7de93b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/90b952954bf7e765924f70a8892334b6bb7de93b", "html_url": "https://github.com/rust-lang/rust/commit/90b952954bf7e765924f70a8892334b6bb7de93b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/90b952954bf7e765924f70a8892334b6bb7de93b/comments", "author": {"login": "lilyball", "id": 714, "node_id": "MDQ6VXNlcjcxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/714?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lilyball", "html_url": "https://github.com/lilyball", "followers_url": "https://api.github.com/users/lilyball/followers", "following_url": "https://api.github.com/users/lilyball/following{/other_user}", "gists_url": "https://api.github.com/users/lilyball/gists{/gist_id}", "starred_url": "https://api.github.com/users/lilyball/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lilyball/subscriptions", "organizations_url": "https://api.github.com/users/lilyball/orgs", "repos_url": "https://api.github.com/users/lilyball/repos", "events_url": "https://api.github.com/users/lilyball/events{/privacy}", "received_events_url": "https://api.github.com/users/lilyball/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lilyball", "id": 714, "node_id": "MDQ6VXNlcjcxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/714?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lilyball", "html_url": "https://github.com/lilyball", "followers_url": "https://api.github.com/users/lilyball/followers", "following_url": "https://api.github.com/users/lilyball/following{/other_user}", "gists_url": "https://api.github.com/users/lilyball/gists{/gist_id}", "starred_url": "https://api.github.com/users/lilyball/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lilyball/subscriptions", "organizations_url": "https://api.github.com/users/lilyball/orgs", "repos_url": "https://api.github.com/users/lilyball/repos", "events_url": "https://api.github.com/users/lilyball/events{/privacy}", "received_events_url": "https://api.github.com/users/lilyball/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3ca008dcf12283247122f25928630f2a484ff768", "url": "https://api.github.com/repos/rust-lang/rust/commits/3ca008dcf12283247122f25928630f2a484ff768", "html_url": "https://github.com/rust-lang/rust/commit/3ca008dcf12283247122f25928630f2a484ff768"}], "stats": {"total": 53, "additions": 42, "deletions": 11}, "files": [{"sha": "9c78c5aec00b44cae4399a300d1d31540a7a56c1", "filename": "src/librustc_driver/driver.rs", "status": "modified", "additions": 11, "deletions": 11, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/90b952954bf7e765924f70a8892334b6bb7de93b/src%2Flibrustc_driver%2Fdriver.rs", "raw_url": "https://github.com/rust-lang/rust/raw/90b952954bf7e765924f70a8892334b6bb7de93b/src%2Flibrustc_driver%2Fdriver.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_driver%2Fdriver.rs?ref=90b952954bf7e765924f70a8892334b6bb7de93b", "patch": "@@ -383,17 +383,8 @@ pub fn phase_2_configure_and_expand(sess: &Session,\n                                     -> Option<ast::Crate> {\n     let time_passes = sess.time_passes();\n \n-    *sess.crate_types.borrow_mut() =\n-        collect_crate_types(sess, &krate.attrs);\n-    *sess.crate_metadata.borrow_mut() =\n-        collect_crate_metadata(sess, &krate.attrs);\n-\n-    time(time_passes, \"recursion limit\", (), |_| {\n-        middle::recursion_limit::update_recursion_limit(sess, &krate);\n-    });\n-\n-    // strip before expansion to allow macros to depend on\n-    // configuration variables e.g/ in\n+    // strip before anything else because crate metadata may use #[cfg_attr]\n+    // and so macros can depend on configuration variables, such as\n     //\n     //   #[macro_use] #[cfg(foo)]\n     //   mod bar { macro_rules! baz!(() => {{}}) }\n@@ -403,6 +394,15 @@ pub fn phase_2_configure_and_expand(sess: &Session,\n     krate = time(time_passes, \"configuration 1\", krate, |krate|\n                  syntax::config::strip_unconfigured_items(sess.diagnostic(), krate));\n \n+    *sess.crate_types.borrow_mut() =\n+        collect_crate_types(sess, &krate.attrs);\n+    *sess.crate_metadata.borrow_mut() =\n+        collect_crate_metadata(sess, &krate.attrs);\n+\n+    time(time_passes, \"recursion limit\", (), |_| {\n+        middle::recursion_limit::update_recursion_limit(sess, &krate);\n+    });\n+\n     time(time_passes, \"gated macro checking\", (), |_| {\n         let features =\n             syntax::feature_gate::check_crate_macros(sess.codemap(),"}, {"sha": "0028b51f9d1ee8d6cfc0b56c2944336c70e78afa", "filename": "src/test/auxiliary/crate-attributes-using-cfg_attr.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/90b952954bf7e765924f70a8892334b6bb7de93b/src%2Ftest%2Fauxiliary%2Fcrate-attributes-using-cfg_attr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/90b952954bf7e765924f70a8892334b6bb7de93b/src%2Ftest%2Fauxiliary%2Fcrate-attributes-using-cfg_attr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fauxiliary%2Fcrate-attributes-using-cfg_attr.rs?ref=90b952954bf7e765924f70a8892334b6bb7de93b", "patch": "@@ -0,0 +1,16 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// no-prefer-dynamic\n+// compile-flags: --cfg foo\n+\n+#![cfg_attr(foo, crate_type=\"lib\")]\n+\n+pub fn foo() {}"}, {"sha": "72ccc6723f921324b95a6e7c9186b27b869f1993", "filename": "src/test/run-pass/crate-attributes-using-cfg_attr.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/90b952954bf7e765924f70a8892334b6bb7de93b/src%2Ftest%2Frun-pass%2Fcrate-attributes-using-cfg_attr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/90b952954bf7e765924f70a8892334b6bb7de93b/src%2Ftest%2Frun-pass%2Fcrate-attributes-using-cfg_attr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fcrate-attributes-using-cfg_attr.rs?ref=90b952954bf7e765924f70a8892334b6bb7de93b", "patch": "@@ -0,0 +1,15 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// aux-build:crate-attributes-using-cfg_attr.rs\n+\n+extern crate crate_attributes_using_cfg_attr;\n+\n+pub fn main() {}"}]}