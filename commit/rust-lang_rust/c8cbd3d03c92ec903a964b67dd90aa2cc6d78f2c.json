{"sha": "c8cbd3d03c92ec903a964b67dd90aa2cc6d78f2c", "node_id": "C_kwDOAAsO6NoAKGM4Y2JkM2QwM2M5MmVjOTAzYTk2NGI2N2RkOTBhYTJjYzZkNzhmMmM", "commit": {"author": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-02-22T05:26:37Z"}, "committer": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-03-23T01:15:29Z"}, "message": "better errors when a Copy impl is not coherent", "tree": {"sha": "651552508c4eb94f773426650383f5af3c55f45c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/651552508c4eb94f773426650383f5af3c55f45c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c8cbd3d03c92ec903a964b67dd90aa2cc6d78f2c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c8cbd3d03c92ec903a964b67dd90aa2cc6d78f2c", "html_url": "https://github.com/rust-lang/rust/commit/c8cbd3d03c92ec903a964b67dd90aa2cc6d78f2c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c8cbd3d03c92ec903a964b67dd90aa2cc6d78f2c/comments", "author": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a4a5e79814fb4d1568fb0ea5ca50f810b071ae12", "url": "https://api.github.com/repos/rust-lang/rust/commits/a4a5e79814fb4d1568fb0ea5ca50f810b071ae12", "html_url": "https://github.com/rust-lang/rust/commit/a4a5e79814fb4d1568fb0ea5ca50f810b071ae12"}], "stats": {"total": 104, "additions": 100, "deletions": 4}, "files": [{"sha": "b83b0bf1ca52eea50331e7aa1f89d254b47c7c5c", "filename": "compiler/rustc_trait_selection/src/traits/misc.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/c8cbd3d03c92ec903a964b67dd90aa2cc6d78f2c/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fmisc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c8cbd3d03c92ec903a964b67dd90aa2cc6d78f2c/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fmisc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fmisc.rs?ref=c8cbd3d03c92ec903a964b67dd90aa2cc6d78f2c", "patch": "@@ -11,7 +11,7 @@ use crate::traits::error_reporting::InferCtxtExt;\n \n #[derive(Clone)]\n pub enum CopyImplementationError<'tcx> {\n-    InfrigingFields(Vec<&'tcx ty::FieldDef>),\n+    InfrigingFields(Vec<(&'tcx ty::FieldDef, Ty<'tcx>)>),\n     NotAnAdt,\n     HasDestructor,\n }\n@@ -67,7 +67,7 @@ pub fn can_type_implement_copy<'tcx>(\n                 match traits::fully_normalize(&infcx, ctx, cause, param_env, ty) {\n                     Ok(ty) => {\n                         if !infcx.type_is_copy_modulo_regions(param_env, ty, span) {\n-                            infringing.push(field);\n+                            infringing.push((field, ty));\n                         }\n                     }\n                     Err(errors) => {"}, {"sha": "3135e9996ab8b8a7dc798dd604ac8ed09c7bfda3", "filename": "compiler/rustc_typeck/src/coherence/builtin.rs", "status": "modified", "additions": 34, "deletions": 2, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/c8cbd3d03c92ec903a964b67dd90aa2cc6d78f2c/compiler%2Frustc_typeck%2Fsrc%2Fcoherence%2Fbuiltin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c8cbd3d03c92ec903a964b67dd90aa2cc6d78f2c/compiler%2Frustc_typeck%2Fsrc%2Fcoherence%2Fbuiltin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcoherence%2Fbuiltin.rs?ref=c8cbd3d03c92ec903a964b67dd90aa2cc6d78f2c", "patch": "@@ -91,8 +91,40 @@ fn visit_implementation_of_copy(tcx: TyCtxt<'_>, impl_did: LocalDefId) {\n                 E0204,\n                 \"the trait `Copy` may not be implemented for this type\"\n             );\n-            for span in fields.iter().map(|f| tcx.def_span(f.did)) {\n-                err.span_label(span, \"this field does not implement `Copy`\");\n+            for (field, ty) in fields {\n+                let field_span = tcx.def_span(field.did);\n+                err.span_label(field_span, \"this field does not implement `Copy`\");\n+                // Spin up a new FulfillmentContext, so we can get the _precise_ reason\n+                // why this field does not implement Copy. This is useful because sometimes\n+                // it is not immediately clear why Copy is not implemented for a field, since\n+                // all we point at is the field itself.\n+                tcx.infer_ctxt().enter(|infcx| {\n+                    let mut fulfill_cx = traits::FulfillmentContext::new_ignoring_regions();\n+                    fulfill_cx.register_bound(\n+                        &infcx,\n+                        param_env,\n+                        ty,\n+                        tcx.lang_items().copy_trait().unwrap(),\n+                        traits::ObligationCause::dummy_with_span(field_span),\n+                    );\n+                    for error in fulfill_cx.select_all_or_error(&infcx) {\n+                        let error_predicate = error.obligation.predicate;\n+                        // Only note if it's not the root obligation, otherwise it's trivial and\n+                        // should be self-explanatory (i.e. a field literally doesn't implement Copy).\n+\n+                        // FIXME: This error could be more descriptive, especially if the error_predicate\n+                        // contains a foreign type or if it's a deeply nested type...\n+                        if error_predicate != error.root_obligation.predicate {\n+                            err.span_note(\n+                                error.obligation.cause.span,\n+                                &format!(\n+                                    \"the `Copy` impl for `{}` requires that `{}`\",\n+                                    ty, error_predicate\n+                                ),\n+                            );\n+                        }\n+                    }\n+                });\n             }\n             err.emit();\n         }"}, {"sha": "80bbe387ac719ffd612d7de87104d64abe1be762", "filename": "src/test/ui/coherence/deep-bad-copy-reason.rs", "status": "added", "additions": 40, "deletions": 0, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/c8cbd3d03c92ec903a964b67dd90aa2cc6d78f2c/src%2Ftest%2Fui%2Fcoherence%2Fdeep-bad-copy-reason.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c8cbd3d03c92ec903a964b67dd90aa2cc6d78f2c/src%2Ftest%2Fui%2Fcoherence%2Fdeep-bad-copy-reason.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcoherence%2Fdeep-bad-copy-reason.rs?ref=c8cbd3d03c92ec903a964b67dd90aa2cc6d78f2c", "patch": "@@ -0,0 +1,40 @@\n+#![feature(extern_types)]\n+\n+extern \"Rust\" {\n+    type OpaqueListContents;\n+}\n+\n+pub struct ListS<T> {\n+    len: usize,\n+    data: [T; 0],\n+    opaque: OpaqueListContents,\n+}\n+\n+pub struct Interned<'a, T>(&'a T);\n+\n+impl<'a, T> Clone for Interned<'a, T> {\n+    fn clone(&self) -> Self {\n+        *self\n+    }\n+}\n+\n+impl<'a, T> Copy for Interned<'a, T> {}\n+\n+pub struct List<'tcx, T>(Interned<'tcx, ListS<T>>);\n+//~^ NOTE this field does not implement `Copy`\n+//~| NOTE the `Copy` impl for `Interned<'tcx, ListS<T>>` requires that `OpaqueListContents: Sized`\n+\n+impl<'tcx, T> Clone for List<'tcx, T> {\n+    fn clone(&self) -> Self {\n+        *self\n+    }\n+}\n+\n+impl<'tcx, T> Copy for List<'tcx, T> {}\n+//~^ ERROR the trait `Copy` may not be implemented for this type\n+\n+fn assert_is_copy<T: Copy>() {}\n+\n+fn main() {\n+    assert_is_copy::<List<'static, ()>>();\n+}"}, {"sha": "295538cee60962b94da2a44414709af934bda0c1", "filename": "src/test/ui/coherence/deep-bad-copy-reason.stderr", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/c8cbd3d03c92ec903a964b67dd90aa2cc6d78f2c/src%2Ftest%2Fui%2Fcoherence%2Fdeep-bad-copy-reason.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c8cbd3d03c92ec903a964b67dd90aa2cc6d78f2c/src%2Ftest%2Fui%2Fcoherence%2Fdeep-bad-copy-reason.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcoherence%2Fdeep-bad-copy-reason.stderr?ref=c8cbd3d03c92ec903a964b67dd90aa2cc6d78f2c", "patch": "@@ -0,0 +1,18 @@\n+error[E0204]: the trait `Copy` may not be implemented for this type\n+  --> $DIR/deep-bad-copy-reason.rs:33:15\n+   |\n+LL | pub struct List<'tcx, T>(Interned<'tcx, ListS<T>>);\n+   |                          ------------------------ this field does not implement `Copy`\n+...\n+LL | impl<'tcx, T> Copy for List<'tcx, T> {}\n+   |               ^^^^\n+   |\n+note: the `Copy` impl for `Interned<'tcx, ListS<T>>` requires that `OpaqueListContents: Sized`\n+  --> $DIR/deep-bad-copy-reason.rs:23:26\n+   |\n+LL | pub struct List<'tcx, T>(Interned<'tcx, ListS<T>>);\n+   |                          ^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0204`."}, {"sha": "279808dd55bb4dea18fbaa79ccbbcc66d351fb9b", "filename": "src/test/ui/union/union-copy.stderr", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/c8cbd3d03c92ec903a964b67dd90aa2cc6d78f2c/src%2Ftest%2Fui%2Funion%2Funion-copy.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c8cbd3d03c92ec903a964b67dd90aa2cc6d78f2c/src%2Ftest%2Fui%2Funion%2Funion-copy.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Funion%2Funion-copy.stderr?ref=c8cbd3d03c92ec903a964b67dd90aa2cc6d78f2c", "patch": "@@ -6,6 +6,12 @@ LL |     a: std::mem::ManuallyDrop<String>\n ...\n LL | impl Copy for W {}\n    |      ^^^^\n+   |\n+note: the `Copy` impl for `ManuallyDrop<String>` requires that `String: Copy`\n+  --> $DIR/union-copy.rs:8:5\n+   |\n+LL |     a: std::mem::ManuallyDrop<String>\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n error: aborting due to previous error\n "}]}