{"sha": "82f05446a549b42af2ae544da05bb5503c3bd8ec", "node_id": "C_kwDOAAsO6NoAKDgyZjA1NDQ2YTU0OWI0MmFmMmFlNTQ0ZGEwNWJiNTUwM2MzYmQ4ZWM", "commit": {"author": {"name": "TheOddGarlic", "email": "umutinanerdogan@pm.me", "date": "2022-08-20T11:28:43Z"}, "committer": {"name": "mejrs", "email": "", "date": "2022-12-17T18:08:24Z"}, "message": "Migrate \"function cannot return without recursing\" diagnostic", "tree": {"sha": "0d1a170c18150a32dc02bc5fe9e997d927d2c281", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0d1a170c18150a32dc02bc5fe9e997d927d2c281"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/82f05446a549b42af2ae544da05bb5503c3bd8ec", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/82f05446a549b42af2ae544da05bb5503c3bd8ec", "html_url": "https://github.com/rust-lang/rust/commit/82f05446a549b42af2ae544da05bb5503c3bd8ec", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/82f05446a549b42af2ae544da05bb5503c3bd8ec/comments", "author": {"login": "AsyaTheAbove", "id": 40492846, "node_id": "MDQ6VXNlcjQwNDkyODQ2", "avatar_url": "https://avatars.githubusercontent.com/u/40492846?v=4", "gravatar_id": "", "url": "https://api.github.com/users/AsyaTheAbove", "html_url": "https://github.com/AsyaTheAbove", "followers_url": "https://api.github.com/users/AsyaTheAbove/followers", "following_url": "https://api.github.com/users/AsyaTheAbove/following{/other_user}", "gists_url": "https://api.github.com/users/AsyaTheAbove/gists{/gist_id}", "starred_url": "https://api.github.com/users/AsyaTheAbove/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/AsyaTheAbove/subscriptions", "organizations_url": "https://api.github.com/users/AsyaTheAbove/orgs", "repos_url": "https://api.github.com/users/AsyaTheAbove/repos", "events_url": "https://api.github.com/users/AsyaTheAbove/events{/privacy}", "received_events_url": "https://api.github.com/users/AsyaTheAbove/received_events", "type": "User", "site_admin": false}, "committer": {}, "parents": [{"sha": "65c53c3bb6190319e210c94164b05a17997073f2", "url": "https://api.github.com/repos/rust-lang/rust/commits/65c53c3bb6190319e210c94164b05a17997073f2", "html_url": "https://github.com/rust-lang/rust/commit/65c53c3bb6190319e210c94164b05a17997073f2"}], "stats": {"total": 41, "additions": 27, "deletions": 14}, "files": [{"sha": "dbff82cf536082b7d3cf455242193a584d88dd69", "filename": "Cargo.lock", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/82f05446a549b42af2ae544da05bb5503c3bd8ec/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/82f05446a549b42af2ae544da05bb5503c3bd8ec/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=82f05446a549b42af2ae544da05bb5503c3bd8ec", "patch": "@@ -4070,6 +4070,7 @@ dependencies = [\n  \"rustc_hir\",\n  \"rustc_index\",\n  \"rustc_infer\",\n+ \"rustc_macros\",\n  \"rustc_middle\",\n  \"rustc_serialize\",\n  \"rustc_session\","}, {"sha": "b5bd2eb21a8ad16ae94004d3b4dfce60de561f47", "filename": "compiler/rustc_error_messages/locales/en-US/mir_build.ftl", "status": "added", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/82f05446a549b42af2ae544da05bb5503c3bd8ec/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fmir_build.ftl", "raw_url": "https://github.com/rust-lang/rust/raw/82f05446a549b42af2ae544da05bb5503c3bd8ec/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fmir_build.ftl", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fmir_build.ftl?ref=82f05446a549b42af2ae544da05bb5503c3bd8ec", "patch": "@@ -0,0 +1,5 @@\n+mir_build_unconditional_recursion = function cannot return without recursing\n+    .label = cannot return without recursing\n+    .help = a `loop` may express intention better if this is on purpose\n+\n+mir_build_unconditional_recursion_call_site_label = recursive call site"}, {"sha": "db62643bc24ac7eda81506fd33c0a0a1b1aadee5", "filename": "compiler/rustc_error_messages/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/82f05446a549b42af2ae544da05bb5503c3bd8ec/compiler%2Frustc_error_messages%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/82f05446a549b42af2ae544da05bb5503c3bd8ec/compiler%2Frustc_error_messages%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_error_messages%2Fsrc%2Flib.rs?ref=82f05446a549b42af2ae544da05bb5503c3bd8ec", "patch": "@@ -58,6 +58,7 @@ fluent_messages! {\n     metadata => \"../locales/en-US/metadata.ftl\",\n     middle => \"../locales/en-US/middle.ftl\",\n     mir_dataflow => \"../locales/en-US/mir_dataflow.ftl\",\n+    mir_build => \"../locales/en-US/mir_build.ftl\",\n     monomorphize => \"../locales/en-US/monomorphize.ftl\",\n     parse => \"../locales/en-US/parse.ftl\",\n     passes => \"../locales/en-US/passes.ftl\","}, {"sha": "4ad3343d3031b2fa1e0f23eb2efc03ffd85edad1", "filename": "compiler/rustc_mir_build/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/82f05446a549b42af2ae544da05bb5503c3bd8ec/compiler%2Frustc_mir_build%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/82f05446a549b42af2ae544da05bb5503c3bd8ec/compiler%2Frustc_mir_build%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2FCargo.toml?ref=82f05446a549b42af2ae544da05bb5503c3bd8ec", "patch": "@@ -17,6 +17,7 @@ rustc_index = { path = \"../rustc_index\" }\n rustc_errors = { path = \"../rustc_errors\" }\n rustc_hir = { path = \"../rustc_hir\" }\n rustc_infer = { path = \"../rustc_infer\" }\n+rustc_macros = { path = \"../rustc_macros\" }\n rustc_serialize = { path = \"../rustc_serialize\" }\n rustc_session = { path = \"../rustc_session\" }\n rustc_span = { path = \"../rustc_span\" }"}, {"sha": "1d44db7eb3a7d80b7f7dbb5ae3488ab115e8e65f", "filename": "compiler/rustc_mir_build/src/errors.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/82f05446a549b42af2ae544da05bb5503c3bd8ec/compiler%2Frustc_mir_build%2Fsrc%2Ferrors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/82f05446a549b42af2ae544da05bb5503c3bd8ec/compiler%2Frustc_mir_build%2Fsrc%2Ferrors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Ferrors.rs?ref=82f05446a549b42af2ae544da05bb5503c3bd8ec", "patch": "@@ -0,0 +1,13 @@\n+use rustc_macros::LintDiagnostic;\n+use rustc_span::Span;\n+\n+#[derive(LintDiagnostic)]\n+#[lint(mir_build::unconditional_recursion)]\n+#[help]\n+pub struct UnconditionalRecursion {\n+    #[primary_span]\n+    #[label]\n+    pub span: Span,\n+    #[label(mir_build::unconditional_recursion_call_site_label)]\n+    pub call_sites: Vec<Span>,\n+}"}, {"sha": "2b05e92fdcf20c0913e199bf11fdeeb591b73d8d", "filename": "compiler/rustc_mir_build/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/82f05446a549b42af2ae544da05bb5503c3bd8ec/compiler%2Frustc_mir_build%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/82f05446a549b42af2ae544da05bb5503c3bd8ec/compiler%2Frustc_mir_build%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Flib.rs?ref=82f05446a549b42af2ae544da05bb5503c3bd8ec", "patch": "@@ -19,6 +19,7 @@ extern crate rustc_middle;\n \n mod build;\n mod check_unsafety;\n+mod errors;\n mod lints;\n pub mod thir;\n "}, {"sha": "383598fb094b6053065e10a7006b96e4c788813e", "filename": "compiler/rustc_mir_build/src/lints.rs", "status": "modified", "additions": 5, "deletions": 14, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/82f05446a549b42af2ae544da05bb5503c3bd8ec/compiler%2Frustc_mir_build%2Fsrc%2Flints.rs", "raw_url": "https://github.com/rust-lang/rust/raw/82f05446a549b42af2ae544da05bb5503c3bd8ec/compiler%2Frustc_mir_build%2Fsrc%2Flints.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Flints.rs?ref=82f05446a549b42af2ae544da05bb5503c3bd8ec", "patch": "@@ -1,3 +1,4 @@\n+use crate::errors::UnconditionalRecursion;\n use rustc_data_structures::graph::iterate::{\n     NodeStatus, TriColorDepthFirstSearch, TriColorVisitor,\n };\n@@ -36,20 +37,10 @@ pub(crate) fn check<'tcx>(tcx: TyCtxt<'tcx>, body: &Body<'tcx>) {\n \n         let sp = tcx.def_span(def_id);\n         let hir_id = tcx.hir().local_def_id_to_hir_id(def_id);\n-        tcx.struct_span_lint_hir(\n-            UNCONDITIONAL_RECURSION,\n-            hir_id,\n-            sp,\n-            \"function cannot return without recursing\",\n-            |lint| {\n-                lint.span_label(sp, \"cannot return without recursing\");\n-                // offer some help to the programmer.\n-                for call_span in vis.reachable_recursive_calls {\n-                    lint.span_label(call_span, \"recursive call site\");\n-                }\n-                lint.help(\"a `loop` may express intention better if this is on purpose\")\n-            },\n-        );\n+        tcx.emit_spanned_lint(UNCONDITIONAL_RECURSION, hir_id, sp, UnconditionalRecursion {\n+            span: sp,\n+            call_sites: vis.reachable_recursive_calls,\n+        });\n     }\n }\n "}]}