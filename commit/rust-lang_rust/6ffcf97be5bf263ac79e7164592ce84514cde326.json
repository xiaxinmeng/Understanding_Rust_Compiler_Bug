{"sha": "6ffcf97be5bf263ac79e7164592ce84514cde326", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZmZmNmOTdiZTViZjI2M2FjNzllNzE2NDU5MmNlODQ1MTRjZGUzMjY=", "commit": {"author": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2019-03-16T06:56:55Z"}, "committer": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2019-03-16T14:40:36Z"}, "message": "Rollup merge of #59173 - emilio:llvm-suffix, r=Mark-Simulacrum\n\nbootstrap: Default to a sensible llvm-suffix.\n\nI used version-channel-sha, hopefully that should work.\n\nI checked that bootstrap builds, but I cannot check anything else since the llvm\nbuild process is started from cargo, and thus calls clang, and thus I hit the\nsame bug I hope to fix with this change.\n\nHopefully fixes #59034.", "tree": {"sha": "a4096157d1c246b1f47249083b0673d9b8f962f0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a4096157d1c246b1f47249083b0673d9b8f962f0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6ffcf97be5bf263ac79e7164592ce84514cde326", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEZ1R8CLMp8f2GxWoQ/vbIBR0OATwFAlyNCuQACgkQ/vbIBR0O\nATx+NQ//Tt82/oYcXBKZZzsxHVtItptNR7fnR0tmOxDv/Be4AO8qwIYc9vvPNZWd\nCPUCEcnX+7bc97V6GJisalJtJ429y91aM0y2bUfd6L3ieCRr1t/Q9AeTcLcQLOan\n8hsLf/j+GLy1FIkcnLvpeQJV8mlQvZuI/MJTiIZEn9Xz8KSRk+UWbwPwHlx+f0gc\n/+yvyglupENyI9X4/uc/d/+x+wPVJSeYh/noX7u3rgp9K+ImZoxSVpuLAInvOC2Q\n/CPst0o0OhEh822f6P5ixIaQTOfh1X/U2WOJtBOa0jiWhmXuhIWX/DRq4jzx9Pwy\nVUdlTPScXNcG/oLmvardl/QRsXUaY0GlzpDYbNb+e6AoidXWIJ7SW2YwWMKzICmC\n5LYiekR7HZL8BY4OBXe4FnV3Q72rBpaXUuK0Q+oEa/pwM0KLXp5cqQ0lIy5A1iwO\nybpwQu2OMGGssW0Pf1d0VQ5P/zZFeYARJimRfnhQfcDccS+paYBvIh0xoZE3FW1r\noLCW6OPA/CUcb5ZgFcAXpKxdv3ilamhCE0nPb4+zi+c9J55tUkAbeWRaOSAwA17V\nM5VKAvLIOB4+OYN4cAwLBIEq5JeypCglHAeN9pEWt8HL3J4+zBwtnhzir+1M7qzd\niWxgnvuw7KbIxbIoOHv2CZMWaoi3OtdDAKkynMJ3dHtQf9HP/Yg=\n=MuIA\n-----END PGP SIGNATURE-----", "payload": "tree a4096157d1c246b1f47249083b0673d9b8f962f0\nparent 8601c79aff521a72565cbd5d4c5ae0ad84080217\nparent e7b7c417e639a2070ae91c2b84e0574beafb0bb7\nauthor kennytm <kennytm@gmail.com> 1552719415 +0800\ncommitter kennytm <kennytm@gmail.com> 1552747236 +0800\n\nRollup merge of #59173 - emilio:llvm-suffix, r=Mark-Simulacrum\n\nbootstrap: Default to a sensible llvm-suffix.\n\nI used version-channel-sha, hopefully that should work.\n\nI checked that bootstrap builds, but I cannot check anything else since the llvm\nbuild process is started from cargo, and thus calls clang, and thus I hit the\nsame bug I hope to fix with this change.\n\nHopefully fixes #59034.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6ffcf97be5bf263ac79e7164592ce84514cde326", "html_url": "https://github.com/rust-lang/rust/commit/6ffcf97be5bf263ac79e7164592ce84514cde326", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6ffcf97be5bf263ac79e7164592ce84514cde326/comments", "author": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8601c79aff521a72565cbd5d4c5ae0ad84080217", "url": "https://api.github.com/repos/rust-lang/rust/commits/8601c79aff521a72565cbd5d4c5ae0ad84080217", "html_url": "https://github.com/rust-lang/rust/commit/8601c79aff521a72565cbd5d4c5ae0ad84080217"}, {"sha": "e7b7c417e639a2070ae91c2b84e0574beafb0bb7", "url": "https://api.github.com/repos/rust-lang/rust/commits/e7b7c417e639a2070ae91c2b84e0574beafb0bb7", "html_url": "https://github.com/rust-lang/rust/commit/e7b7c417e639a2070ae91c2b84e0574beafb0bb7"}], "stats": {"total": 28, "additions": 27, "deletions": 1}, "files": [{"sha": "976b30a55c94b7d8db3e09a705069622ebfc9ade", "filename": "src/bootstrap/lib.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/6ffcf97be5bf263ac79e7164592ce84514cde326/src%2Fbootstrap%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6ffcf97be5bf263ac79e7164592ce84514cde326/src%2Fbootstrap%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Flib.rs?ref=6ffcf97be5bf263ac79e7164592ce84514cde326", "patch": "@@ -241,6 +241,8 @@ pub struct Build {\n     clippy_info: channel::GitInfo,\n     miri_info: channel::GitInfo,\n     rustfmt_info: channel::GitInfo,\n+    in_tree_llvm_info: channel::GitInfo,\n+    emscripten_llvm_info: channel::GitInfo,\n     local_rebuild: bool,\n     fail_fast: bool,\n     doc_tests: DocTests,\n@@ -363,6 +365,8 @@ impl Build {\n         let clippy_info = channel::GitInfo::new(&config, &src.join(\"src/tools/clippy\"));\n         let miri_info = channel::GitInfo::new(&config, &src.join(\"src/tools/miri\"));\n         let rustfmt_info = channel::GitInfo::new(&config, &src.join(\"src/tools/rustfmt\"));\n+        let in_tree_llvm_info = channel::GitInfo::new(&config, &src.join(\"src/llvm-project\"));\n+        let emscripten_llvm_info = channel::GitInfo::new(&config, &src.join(\"src/llvm-emscripten\"));\n \n         let mut build = Build {\n             initial_rustc: config.initial_rustc.clone(),\n@@ -386,6 +390,8 @@ impl Build {\n             clippy_info,\n             miri_info,\n             rustfmt_info,\n+            in_tree_llvm_info,\n+            emscripten_llvm_info,\n             cc: HashMap::new(),\n             cxx: HashMap::new(),\n             ar: HashMap::new(),"}, {"sha": "3babbc9e102310b372112691091d0d3593564eb8", "filename": "src/bootstrap/native.rs", "status": "modified", "additions": 21, "deletions": 1, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/6ffcf97be5bf263ac79e7164592ce84514cde326/src%2Fbootstrap%2Fnative.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6ffcf97be5bf263ac79e7164592ce84514cde326/src%2Fbootstrap%2Fnative.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fnative.rs?ref=6ffcf97be5bf263ac79e7164592ce84514cde326", "patch": "@@ -18,6 +18,7 @@ use build_helper::output;\n use cmake;\n use cc;\n \n+use crate::channel;\n use crate::util::{self, exe};\n use build_helper::up_to_date;\n use crate::builder::{Builder, RunConfig, ShouldRun, Step};\n@@ -231,7 +232,26 @@ impl Step for Llvm {\n         }\n \n         if let Some(ref suffix) = builder.config.llvm_version_suffix {\n-            cfg.define(\"LLVM_VERSION_SUFFIX\", suffix);\n+            // Allow version-suffix=\"\" to not define a version suffix at all.\n+            if !suffix.is_empty() {\n+                cfg.define(\"LLVM_VERSION_SUFFIX\", suffix);\n+            }\n+        } else {\n+            let mut default_suffix = format!(\n+                \"-rust-{}-{}\",\n+                channel::CFG_RELEASE_NUM,\n+                builder.config.channel,\n+            );\n+            let llvm_info = if self.emscripten {\n+                &builder.emscripten_llvm_info\n+            } else {\n+                &builder.in_tree_llvm_info\n+            };\n+            if let Some(sha) = llvm_info.sha_short() {\n+                default_suffix.push_str(\"-\");\n+                default_suffix.push_str(sha);\n+            }\n+            cfg.define(\"LLVM_VERSION_SUFFIX\", default_suffix);\n         }\n \n         if let Some(ref linker) = builder.config.llvm_use_linker {"}]}