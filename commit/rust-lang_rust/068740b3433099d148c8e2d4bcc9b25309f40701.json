{"sha": "068740b3433099d148c8e2d4bcc9b25309f40701", "node_id": "MDY6Q29tbWl0NzI0NzEyOjA2ODc0MGIzNDMzMDk5ZDE0OGM4ZTJkNGJjYzliMjUzMDlmNDA3MDE=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2014-03-19T15:47:59Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2014-03-19T17:47:00Z"}, "message": "rustc: Prevent false positives in crate loading\n\nPreviously, any library of the pattern `lib<name>-<hash>-<version>.so` was\n>considered a candidate (rightly so) for loading a crate. Sets are generated for\neach unique `<hash>`, and then from these sets a candidate is selected. If a set\ncontained more than one element, then it immediately generated an error saying\nthat multiple copies of the same dylib were found.\n\nThis is incorrect because each candidate needs to be validated to actually\ncontain a rust library (valid metadata). This commit alters the logic to filter\neach set of candidates for a hash to only libraries which are actually rust\nlibraries. This means that if multiple false positives are found with the right\nname pattern, they're all ignored.\n\nCloses #13010", "tree": {"sha": "09c90170b7de67ea6838252bed62dca9761a59ce", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/09c90170b7de67ea6838252bed62dca9761a59ce"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/068740b3433099d148c8e2d4bcc9b25309f40701", "comment_count": 5, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/068740b3433099d148c8e2d4bcc9b25309f40701", "html_url": "https://github.com/rust-lang/rust/commit/068740b3433099d148c8e2d4bcc9b25309f40701", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/068740b3433099d148c8e2d4bcc9b25309f40701/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "af9368452d8578af219713b34f7e3be4bd085186", "url": "https://api.github.com/repos/rust-lang/rust/commits/af9368452d8578af219713b34f7e3be4bd085186", "html_url": "https://github.com/rust-lang/rust/commit/af9368452d8578af219713b34f7e3be4bd085186"}], "stats": {"total": 79, "additions": 60, "deletions": 19}, "files": [{"sha": "e19a1402d30937fa194c2c262ad11e4901c833dd", "filename": "src/librustc/metadata/loader.rs", "status": "modified", "additions": 27, "deletions": 19, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/068740b3433099d148c8e2d4bcc9b25309f40701/src%2Flibrustc%2Fmetadata%2Floader.rs", "raw_url": "https://github.com/rust-lang/rust/raw/068740b3433099d148c8e2d4bcc9b25309f40701/src%2Flibrustc%2Fmetadata%2Floader.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmetadata%2Floader.rs?ref=068740b3433099d148c8e2d4bcc9b25309f40701", "patch": "@@ -284,38 +284,46 @@ impl<'a> Context<'a> {\n     //                reading dylib metadata is quite slow.\n     fn extract_one(&mut self, m: HashSet<Path>, flavor: &str,\n                    slot: &mut Option<MetadataBlob>) -> Option<Path> {\n-        if m.len() == 0 { return None }\n-        if m.len() > 1 {\n-            self.sess.span_err(self.span,\n-                               format!(\"multiple {} candidates for `{}` \\\n-                                        found\", flavor, self.crate_id.name));\n-            for (i, path) in m.iter().enumerate() {\n-                self.sess.span_note(self.span,\n-                                    format!(r\"candidate \\#{}: {}\", i + 1,\n-                                            path.display()));\n-            }\n-            return None\n-        }\n+        let mut ret = None::<Path>;\n+        let mut error = 0;\n \n-        let lib = m.move_iter().next().unwrap();\n-        if slot.is_none() {\n+        for lib in m.move_iter() {\n             info!(\"{} reading metadata from: {}\", flavor, lib.display());\n-            match get_metadata_section(self.os, &lib) {\n+            let metadata = match get_metadata_section(self.os, &lib) {\n                 Ok(blob) => {\n                     if self.crate_matches(blob.as_slice()) {\n-                        *slot = Some(blob);\n+                        blob\n                     } else {\n                         info!(\"metadata mismatch\");\n-                        return None;\n+                        continue\n                     }\n                 }\n                 Err(_) => {\n                     info!(\"no metadata found\");\n-                    return None\n+                    continue\n                 }\n+            };\n+            if ret.is_some() {\n+                self.sess.span_err(self.span,\n+                                   format!(\"multiple {} candidates for `{}` \\\n+                                            found\", flavor, self.crate_id.name));\n+                self.sess.span_note(self.span,\n+                                    format!(r\"candidate \\#1: {}\",\n+                                            ret.get_ref().display()));\n+                error = 1;\n+                ret = None;\n+            }\n+            if error > 0 {\n+                error += 1;\n+                self.sess.span_note(self.span,\n+                                    format!(r\"candidate \\#{}: {}\", error,\n+                                            lib.display()));\n+                continue\n             }\n+            *slot = Some(metadata);\n+            ret = Some(lib);\n         }\n-        return Some(lib);\n+        return if error > 0 {None} else {ret}\n     }\n \n     fn crate_matches(&mut self, crate_data: &[u8]) -> bool {"}, {"sha": "621f3064b5cede48a67a32fd9bcf51f44a39800f", "filename": "src/test/run-make/suspicious-library/Makefile", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/068740b3433099d148c8e2d4bcc9b25309f40701/src%2Ftest%2Frun-make%2Fsuspicious-library%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/068740b3433099d148c8e2d4bcc9b25309f40701/src%2Ftest%2Frun-make%2Fsuspicious-library%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fsuspicious-library%2FMakefile?ref=068740b3433099d148c8e2d4bcc9b25309f40701", "patch": "@@ -0,0 +1,7 @@\n+-include ../tools.mk\n+\n+all:\n+\t$(RUSTC) foo.rs\n+\ttouch $(call DYLIB,foo-something-special)\n+\ttouch $(call DYLIB,foo-something-special2)\n+\t$(RUSTC) bar.rs"}, {"sha": "ed0e8a7e23e80ac10908a40235953b52a9f73cda", "filename": "src/test/run-make/suspicious-library/bar.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/068740b3433099d148c8e2d4bcc9b25309f40701/src%2Ftest%2Frun-make%2Fsuspicious-library%2Fbar.rs", "raw_url": "https://github.com/rust-lang/rust/raw/068740b3433099d148c8e2d4bcc9b25309f40701/src%2Ftest%2Frun-make%2Fsuspicious-library%2Fbar.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fsuspicious-library%2Fbar.rs?ref=068740b3433099d148c8e2d4bcc9b25309f40701", "patch": "@@ -0,0 +1,13 @@\n+// Copyright 2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+extern crate foo;\n+\n+fn main() { foo::foo() }"}, {"sha": "890fd3a7dd66150de0affbfabdec46789b9f3dc0", "filename": "src/test/run-make/suspicious-library/foo.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/068740b3433099d148c8e2d4bcc9b25309f40701/src%2Ftest%2Frun-make%2Fsuspicious-library%2Ffoo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/068740b3433099d148c8e2d4bcc9b25309f40701/src%2Ftest%2Frun-make%2Fsuspicious-library%2Ffoo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fsuspicious-library%2Ffoo.rs?ref=068740b3433099d148c8e2d4bcc9b25309f40701", "patch": "@@ -0,0 +1,13 @@\n+// Copyright 2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#[crate_type = \"dylib\"];\n+\n+pub fn foo() {}"}]}