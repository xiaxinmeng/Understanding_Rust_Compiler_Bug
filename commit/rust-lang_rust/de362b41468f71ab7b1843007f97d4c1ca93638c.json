{"sha": "de362b41468f71ab7b1843007f97d4c1ca93638c", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRlMzYyYjQxNDY4ZjcxYWI3YjE4NDMwMDdmOTdkNGMxY2E5MzYzOGM=", "commit": {"author": {"name": "BaoshanPang", "email": "pangbw@gmail.com", "date": "2019-11-20T22:24:59Z"}, "committer": {"name": "BaoshanPang", "email": "pangbw@gmail.com", "date": "2019-11-22T22:36:54Z"}, "message": "ensure that access to the environment is synchronized", "tree": {"sha": "8b1d729ff9bc4108df3cb8c11344f7a633bd8e20", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8b1d729ff9bc4108df3cb8c11344f7a633bd8e20"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/de362b41468f71ab7b1843007f97d4c1ca93638c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/de362b41468f71ab7b1843007f97d4c1ca93638c", "html_url": "https://github.com/rust-lang/rust/commit/de362b41468f71ab7b1843007f97d4c1ca93638c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/de362b41468f71ab7b1843007f97d4c1ca93638c/comments", "author": {"login": "BaoshanPang", "id": 3380860, "node_id": "MDQ6VXNlcjMzODA4NjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3380860?v=4", "gravatar_id": "", "url": "https://api.github.com/users/BaoshanPang", "html_url": "https://github.com/BaoshanPang", "followers_url": "https://api.github.com/users/BaoshanPang/followers", "following_url": "https://api.github.com/users/BaoshanPang/following{/other_user}", "gists_url": "https://api.github.com/users/BaoshanPang/gists{/gist_id}", "starred_url": "https://api.github.com/users/BaoshanPang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/BaoshanPang/subscriptions", "organizations_url": "https://api.github.com/users/BaoshanPang/orgs", "repos_url": "https://api.github.com/users/BaoshanPang/repos", "events_url": "https://api.github.com/users/BaoshanPang/events{/privacy}", "received_events_url": "https://api.github.com/users/BaoshanPang/received_events", "type": "User", "site_admin": false}, "committer": {"login": "BaoshanPang", "id": 3380860, "node_id": "MDQ6VXNlcjMzODA4NjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3380860?v=4", "gravatar_id": "", "url": "https://api.github.com/users/BaoshanPang", "html_url": "https://github.com/BaoshanPang", "followers_url": "https://api.github.com/users/BaoshanPang/followers", "following_url": "https://api.github.com/users/BaoshanPang/following{/other_user}", "gists_url": "https://api.github.com/users/BaoshanPang/gists{/gist_id}", "starred_url": "https://api.github.com/users/BaoshanPang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/BaoshanPang/subscriptions", "organizations_url": "https://api.github.com/users/BaoshanPang/orgs", "repos_url": "https://api.github.com/users/BaoshanPang/repos", "events_url": "https://api.github.com/users/BaoshanPang/events{/privacy}", "received_events_url": "https://api.github.com/users/BaoshanPang/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e20f630f1caf7e95a725ed524109fc168a9e1345", "url": "https://api.github.com/repos/rust-lang/rust/commits/e20f630f1caf7e95a725ed524109fc168a9e1345", "html_url": "https://github.com/rust-lang/rust/commit/e20f630f1caf7e95a725ed524109fc168a9e1345"}], "stats": {"total": 27, "additions": 18, "deletions": 9}, "files": [{"sha": "71e1d1626c1d0bed0bd8027671a7352cb782f3fa", "filename": "src/libstd/sys/vxworks/os.rs", "status": "modified", "additions": 12, "deletions": 7, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/de362b41468f71ab7b1843007f97d4c1ca93638c/src%2Flibstd%2Fsys%2Fvxworks%2Fos.rs", "raw_url": "https://github.com/rust-lang/rust/raw/de362b41468f71ab7b1843007f97d4c1ca93638c/src%2Flibstd%2Fsys%2Fvxworks%2Fos.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Fvxworks%2Fos.rs?ref=de362b41468f71ab7b1843007f97d4c1ca93638c", "patch": "@@ -11,14 +11,12 @@ use crate::path::{self, PathBuf, Path};\n use crate::ptr;\n use crate::slice;\n use crate::str;\n-use crate::sys_common::mutex::Mutex;\n+use crate::sys_common::mutex::{Mutex, MutexGuard};\n use crate::sys::cvt;\n /*use sys::fd; this one is probably important */\n use crate::vec;\n \n const TMPBUF_SZ: usize = 128;\n-static ENV_LOCK: Mutex = Mutex::new();\n-\n \n // This is a terrible fix\n use crate::sys::os_str::Buf;\n@@ -200,11 +198,18 @@ pub unsafe fn environ() -> *mut *const *const c_char {\n     &mut environ\n }\n \n+pub unsafe fn env_lock() -> MutexGuard<'static> {\n+    // We never call `ENV_LOCK.init()`, so it is UB to attempt to\n+    // acquire this mutex reentrantly!\n+    static ENV_LOCK: Mutex = Mutex::new();\n+    ENV_LOCK.lock()\n+}\n+\n /// Returns a vector of (variable, value) byte-vector pairs for all the\n /// environment variables of the current process.\n pub fn env() -> Env {\n     unsafe {\n-        let _guard = ENV_LOCK.lock();\n+        let _guard = env_lock();\n         let mut environ = *environ();\n         if environ == ptr::null() {\n             panic!(\"os::env() failure getting env string from OS: {}\",\n@@ -244,7 +249,7 @@ pub fn getenv(k: &OsStr) -> io::Result<Option<OsString>> {\n     // always None as well\n     let k = CString::new(k.as_bytes())?;\n     unsafe {\n-        let _guard = ENV_LOCK.lock();\n+        let _guard = env_lock();\n         let s = libc::getenv(k.as_ptr()) as *const libc::c_char;\n         let ret = if s.is_null() {\n             None\n@@ -260,7 +265,7 @@ pub fn setenv(k: &OsStr, v: &OsStr) -> io::Result<()> {\n     let v = CString::new(v.as_bytes())?;\n \n     unsafe {\n-        let _guard = ENV_LOCK.lock();\n+        let _guard = env_lock();\n         cvt(libc::setenv(k.as_ptr(), v.as_ptr(), 1)).map(|_| ())\n     }\n }\n@@ -269,7 +274,7 @@ pub fn unsetenv(n: &OsStr) -> io::Result<()> {\n     let nbuf = CString::new(n.as_bytes())?;\n \n     unsafe {\n-        let _guard = ENV_LOCK.lock();\n+        let _guard = env_lock();\n         cvt(libc::unsetenv(nbuf.as_ptr())).map(|_| ())\n     }\n }"}, {"sha": "79bfd770f8ed7db057f48573959e2412ead1fc07", "filename": "src/libstd/sys/vxworks/process/process_vxworks.rs", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/de362b41468f71ab7b1843007f97d4c1ca93638c/src%2Flibstd%2Fsys%2Fvxworks%2Fprocess%2Fprocess_vxworks.rs", "raw_url": "https://github.com/rust-lang/rust/raw/de362b41468f71ab7b1843007f97d4c1ca93638c/src%2Flibstd%2Fsys%2Fvxworks%2Fprocess%2Fprocess_vxworks.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Fvxworks%2Fprocess%2Fprocess_vxworks.rs?ref=de362b41468f71ab7b1843007f97d4c1ca93638c", "patch": "@@ -55,13 +55,17 @@ impl Command {\n \n             let c_envp = envp.as_ref().map(|c| c.as_ptr())\n                 .unwrap_or_else(|| *sys::os::environ() as *const _);\n-            \n+            let stack_size = thread::min_stack();\n+\n+            // ensure that access to the environment is synchronized\n+            let _lock = sys::os::env_lock();\n+\n             let ret = libc::rtpSpawn(\n                 self.get_argv()[0],                   // executing program\n                 self.get_argv().as_ptr() as *mut *const c_char, // argv\n                 c_envp as *mut *const c_char,\n                 100 as c_int,                         // initial priority\n-                thread::min_stack(),                  // initial stack size.\n+                stack_size,                           // initial stack size.\n                 0,                                    // options\n                 0                                     // task options\n             );"}]}