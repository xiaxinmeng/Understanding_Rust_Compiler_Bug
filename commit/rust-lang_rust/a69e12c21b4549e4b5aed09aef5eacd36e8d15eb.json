{"sha": "a69e12c21b4549e4b5aed09aef5eacd36e8d15eb", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE2OWUxMmMyMWI0NTQ5ZTRiNWFlZDA5YWVmNWVhY2QzNmU4ZDE1ZWI=", "commit": {"author": {"name": "Oliver Scherer", "email": "github35764891676564198441@oli-obk.de", "date": "2019-03-16T21:33:15Z"}, "committer": {"name": "Oliver Scherer", "email": "github35764891676564198441@oli-obk.de", "date": "2019-03-16T21:33:15Z"}, "message": "Don't report deprecation lints in derive expansions", "tree": {"sha": "8d64f1971eb65d336cec5e5239b20cfe5580386f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8d64f1971eb65d336cec5e5239b20cfe5580386f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a69e12c21b4549e4b5aed09aef5eacd36e8d15eb", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a69e12c21b4549e4b5aed09aef5eacd36e8d15eb", "html_url": "https://github.com/rust-lang/rust/commit/a69e12c21b4549e4b5aed09aef5eacd36e8d15eb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a69e12c21b4549e4b5aed09aef5eacd36e8d15eb/comments", "author": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "committer": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2c8bbf50db0ef90a33f986ba8fc2e1fe129197ff", "url": "https://api.github.com/repos/rust-lang/rust/commits/2c8bbf50db0ef90a33f986ba8fc2e1fe129197ff", "html_url": "https://github.com/rust-lang/rust/commit/2c8bbf50db0ef90a33f986ba8fc2e1fe129197ff"}], "stats": {"total": 40, "additions": 38, "deletions": 2}, "files": [{"sha": "86a2d7af9556fda29909db9f5499529e8ee6df16", "filename": "src/librustc/lint/mod.rs", "status": "modified", "additions": 16, "deletions": 1, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/a69e12c21b4549e4b5aed09aef5eacd36e8d15eb/src%2Flibrustc%2Flint%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a69e12c21b4549e4b5aed09aef5eacd36e8d15eb/src%2Flibrustc%2Flint%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Flint%2Fmod.rs?ref=a69e12c21b4549e4b5aed09aef5eacd36e8d15eb", "patch": "@@ -833,7 +833,8 @@ pub fn provide(providers: &mut Providers<'_>) {\n \n /// Returns whether `span` originates in a foreign crate's external macro.\n ///\n-/// This is used to test whether a lint should be entirely aborted above.\n+/// This is used to test whether a lint should not even begin to figure out whether it should\n+/// be reported on the current node.\n pub fn in_external_macro(sess: &Session, span: Span) -> bool {\n     let info = match span.ctxt().outer().expn_info() {\n         Some(info) => info,\n@@ -859,3 +860,17 @@ pub fn in_external_macro(sess: &Session, span: Span) -> bool {\n         Err(_) => true,\n     }\n }\n+\n+/// Returns whether `span` originates in a derive macro's expansion\n+pub fn in_derive_expansion(span: Span) -> bool {\n+    let info = match span.ctxt().outer().expn_info() {\n+        Some(info) => info,\n+        // no ExpnInfo means this span doesn't come from a macro\n+        None => return false,\n+    };\n+\n+    match info.format {\n+        ExpnFormat::MacroAttribute(symbol) => symbol.as_str().starts_with(\"derive(\"),\n+        _ => false,\n+    }\n+}"}, {"sha": "6c24cb0a7b07ab23a500a39650583d57d252018a", "filename": "src/librustc/middle/stability.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/a69e12c21b4549e4b5aed09aef5eacd36e8d15eb/src%2Flibrustc%2Fmiddle%2Fstability.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a69e12c21b4549e4b5aed09aef5eacd36e8d15eb/src%2Flibrustc%2Fmiddle%2Fstability.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fstability.rs?ref=a69e12c21b4549e4b5aed09aef5eacd36e8d15eb", "patch": "@@ -3,7 +3,7 @@\n \n pub use self::StabilityLevel::*;\n \n-use crate::lint::{self, Lint};\n+use crate::lint::{self, Lint, in_derive_expansion};\n use crate::hir::{self, Item, Generics, StructField, Variant, HirId};\n use crate::hir::def::Def;\n use crate::hir::def_id::{CrateNum, CRATE_DEF_INDEX, DefId, LOCAL_CRATE};\n@@ -561,6 +561,9 @@ impl<'a, 'gcx, 'tcx> TyCtxt<'a, 'gcx, 'tcx> {\n                                suggestion: Option<Symbol>,\n                                message: &str,\n                                lint: &'static Lint| {\n+            if in_derive_expansion(span) {\n+                return;\n+            }\n             let msg = if let Some(note) = note {\n                 format!(\"{}: {}\", message, note)\n             } else {"}, {"sha": "4980a7f5aa31cb617510eff2175af74f0af96441", "filename": "src/test/ui/deprecation/derive_on_deprecated.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/a69e12c21b4549e4b5aed09aef5eacd36e8d15eb/src%2Ftest%2Fui%2Fdeprecation%2Fderive_on_deprecated.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a69e12c21b4549e4b5aed09aef5eacd36e8d15eb/src%2Ftest%2Fui%2Fdeprecation%2Fderive_on_deprecated.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fdeprecation%2Fderive_on_deprecated.rs?ref=a69e12c21b4549e4b5aed09aef5eacd36e8d15eb", "patch": "@@ -0,0 +1,9 @@\n+// compile-pass\n+\n+#![deny(deprecated)]\n+\n+#[deprecated = \"oh no\"]\n+#[derive(Default)]\n+struct X;\n+\n+fn main() {}"}, {"sha": "235146bad9c851f90c296a6987d46dfe267ff652", "filename": "src/test/ui/deprecation/derive_on_deprecated_forbidden.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/a69e12c21b4549e4b5aed09aef5eacd36e8d15eb/src%2Ftest%2Fui%2Fdeprecation%2Fderive_on_deprecated_forbidden.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a69e12c21b4549e4b5aed09aef5eacd36e8d15eb/src%2Ftest%2Fui%2Fdeprecation%2Fderive_on_deprecated_forbidden.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fdeprecation%2Fderive_on_deprecated_forbidden.rs?ref=a69e12c21b4549e4b5aed09aef5eacd36e8d15eb", "patch": "@@ -0,0 +1,9 @@\n+// compile-pass\n+\n+#![forbid(deprecated)]\n+\n+#[deprecated = \"oh no\"]\n+#[derive(Default)]\n+struct X;\n+\n+fn main() {}"}]}