{"sha": "a2c032631b8e9b7023502bd0210b97bf1661d9ba", "node_id": "MDY6Q29tbWl0NzI0NzEyOmEyYzAzMjYzMWI4ZTliNzAyMzUwMmJkMDIxMGI5N2JmMTY2MWQ5YmE=", "commit": {"author": {"name": "Corey Farwell", "email": "coreyf@rwell.org", "date": "2017-04-07T13:20:07Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2017-04-07T13:20:07Z"}, "message": "Rollup merge of #41075 - aidanhs:aphs-enable-appveyor-cache, r=alexcrichton\n\nRe-enable appveyor cache\n\nAfter breaking the queue last time, I'm cautiously back with a PR to re-enable caching on appveyor.\n\nIf you look at https://ci.appveyor.com/project/rust-lang/rust/build/1.0.2623/job/46o90by4ari6gege (one of the multiple runs that started failed, there are actually two errors - one for restoring the cache, one right at the bottom for creating a directory. I only noticed the restore error at the time as I was a bit rushed to revert and didn't stop to wonder why it continued - turns out appveyor [does not abort on cache restore failure](https://github.com/appveyor/ci/issues/723).\n\nTurns out the cause of the build failures was the cache directory existing and me being thinking that because mkdir on windows is [recursive by default](http://stackoverflow.com/a/905239/2352259), it ignores the error if the directory already exists. Apparently this is not true, so now it checks if the directory exists before attempting to create.\n\nIn addition, I've added some more paranoia to double check everything is sane.", "tree": {"sha": "4b1cb708390d5d0c51e465259dd40aa238c0c5fe", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4b1cb708390d5d0c51e465259dd40aa238c0c5fe"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a2c032631b8e9b7023502bd0210b97bf1661d9ba", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a2c032631b8e9b7023502bd0210b97bf1661d9ba", "html_url": "https://github.com/rust-lang/rust/commit/a2c032631b8e9b7023502bd0210b97bf1661d9ba", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a2c032631b8e9b7023502bd0210b97bf1661d9ba/comments", "author": {"login": "frewsxcv", "id": 416575, "node_id": "MDQ6VXNlcjQxNjU3NQ==", "avatar_url": "https://avatars.githubusercontent.com/u/416575?v=4", "gravatar_id": "", "url": "https://api.github.com/users/frewsxcv", "html_url": "https://github.com/frewsxcv", "followers_url": "https://api.github.com/users/frewsxcv/followers", "following_url": "https://api.github.com/users/frewsxcv/following{/other_user}", "gists_url": "https://api.github.com/users/frewsxcv/gists{/gist_id}", "starred_url": "https://api.github.com/users/frewsxcv/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/frewsxcv/subscriptions", "organizations_url": "https://api.github.com/users/frewsxcv/orgs", "repos_url": "https://api.github.com/users/frewsxcv/repos", "events_url": "https://api.github.com/users/frewsxcv/events{/privacy}", "received_events_url": "https://api.github.com/users/frewsxcv/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "996f06fe3597eeb2c671a34cf16d2b29aec961e7", "url": "https://api.github.com/repos/rust-lang/rust/commits/996f06fe3597eeb2c671a34cf16d2b29aec961e7", "html_url": "https://github.com/rust-lang/rust/commit/996f06fe3597eeb2c671a34cf16d2b29aec961e7"}, {"sha": "b970bc2a79719b5c1573fb87c96773ce131dbb8d", "url": "https://api.github.com/repos/rust-lang/rust/commits/b970bc2a79719b5c1573fb87c96773ce131dbb8d", "html_url": "https://github.com/rust-lang/rust/commit/b970bc2a79719b5c1573fb87c96773ce131dbb8d"}], "stats": {"total": 22, "additions": 18, "deletions": 4}, "files": [{"sha": "9070c5d9edf1ec2e11f8436cb8c216e5d6582961", "filename": "appveyor.yml", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/a2c032631b8e9b7023502bd0210b97bf1661d9ba/appveyor.yml", "raw_url": "https://github.com/rust-lang/rust/raw/a2c032631b8e9b7023502bd0210b97bf1661d9ba/appveyor.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/appveyor.yml?ref=a2c032631b8e9b7023502bd0210b97bf1661d9ba", "patch": "@@ -141,15 +141,18 @@ install:\n   - set SCCACHE_ERROR_LOG=%CD%/sccache.log\n \n test_script:\n-  - appveyor-retry sh -c 'git submodule deinit -f . && git submodule update --init'\n+  - if not exist C:\\cache\\rustsrc\\NUL mkdir C:\\cache\\rustsrc\n+  - sh src/ci/init_repo.sh . /c/cache/rustsrc\n   - set SRC=.\n   - set NO_CCACHE=1\n   - sh src/ci/run.sh\n \n on_failure:\n-  - cat %CD%/sccache.log\n+  - cat %CD%\\sccache.log\n+  - cat C:\\Users\\appveyor\\AppData\\Local\\Temp\\1\\build-cache-logs\\*.log\n \n cache:\n+  - C:\\cache\\rustsrc\n   - \"build/i686-pc-windows-msvc/llvm -> src/rustllvm/llvm-rebuild-trigger\"\n   - \"build/x86_64-pc-windows-msvc/llvm -> src/rustllvm/llvm-rebuild-trigger\"\n   - \"i686-pc-windows-msvc/llvm -> src/rustllvm/llvm-rebuild-trigger\""}, {"sha": "c235681cddd0c5dac224280a0d67c25c6599c23b", "filename": "src/ci/init_repo.sh", "status": "modified", "additions": 13, "deletions": 2, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/a2c032631b8e9b7023502bd0210b97bf1661d9ba/src%2Fci%2Finit_repo.sh", "raw_url": "https://github.com/rust-lang/rust/raw/a2c032631b8e9b7023502bd0210b97bf1661d9ba/src%2Fci%2Finit_repo.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Finit_repo.sh?ref=a2c032631b8e9b7023502bd0210b97bf1661d9ba", "patch": "@@ -38,9 +38,20 @@ fi\n \n # Wipe the cache if it's not valid, or mark it as invalid while we update it\n if [ ! -f \"$cache_valid_file\" ]; then\n-    rm -rf \"$CACHE_DIR\" && mkdir \"$CACHE_DIR\"\n+    rm -rf \"$CACHE_DIR\"\n+    mkdir \"$CACHE_DIR\"\n else\n-    rm \"$cache_valid_file\"\n+    stat_lines=$(cd \"$cache_src_dir\" && git status --porcelain | wc -l)\n+    stat_ec=$(cd \"$cache_src_dir\" && git status >/dev/null 2>&1 && echo $?)\n+    if [ ! -d \"$cache_src_dir/.git\" -o $stat_lines != 0 -o $stat_ec != 0 ]; then\n+        # Something is badly wrong - the cache valid file is here, but something\n+        # about the git repo is fishy. Nuke it all, just in case\n+        echo \"WARNING: $cache_valid_file exists but bad repo: l:$stat_lines, ec:$stat_ec\"\n+        rm -rf \"$CACHE_DIR\"\n+        mkdir \"$CACHE_DIR\"\n+    else\n+        rm \"$cache_valid_file\"\n+    fi\n fi\n \n # Update the cache (a pristine copy of the rust source master)"}]}