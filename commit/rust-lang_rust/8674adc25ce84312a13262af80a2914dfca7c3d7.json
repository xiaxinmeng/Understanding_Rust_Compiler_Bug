{"sha": "8674adc25ce84312a13262af80a2914dfca7c3d7", "node_id": "C_kwDOAAsO6NoAKDg2NzRhZGMyNWNlODQzMTJhMTMyNjJhZjgwYTI5MTRkZmNhN2MzZDc", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2023-02-13T10:34:57Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-02-13T10:34:57Z"}, "message": "Rollup merge of #107922 - Kobzol:ci-print-disk-size, r=Mark-Simulacrum\n\nPrint disk usage in PGO CI script\n\nTo diagnose issues like https://github.com/rust-lang/rust/pull/94857#issuecomment-1426648675.", "tree": {"sha": "356049372b713c32987e88ce2bde0e94c2423263", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/356049372b713c32987e88ce2bde0e94c2423263"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8674adc25ce84312a13262af80a2914dfca7c3d7", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJj6hJRCRBK7hj4Ov3rIwAAbQoIAFrkoeHVRjc+kGulw23u/AZQ\nPyn3ydnZ/ipROBFGEbzpBY5736EhGtgrkh3TUwDM68J4D9yH5j7q1kIXNIZTMQo6\nZqS1Ra65dWWwNi5RXvdNSvHURB7oIhGXWgsDPYhJr+1lE6Knc7zFmctFSRJBirEz\nGvsgTfauyWsDfDN+ZaoQ6s4vlVosubf6f6zojK1Rm0Q5xAGPbp0lbOqPCs8FnBPx\ntBTxwCJK8y7P5X5COnvQifdzhOjtd/u1glLrT8bycveUoLp2mLLwX8B7trDCwDS6\nuapAvrcjWbhs2Yg+/q/rzlfYbzhlckNOPjOGZOgdqBCEQKQ3WH8h4jtcP8fw59E=\n=Wxe0\n-----END PGP SIGNATURE-----\n", "payload": "tree 356049372b713c32987e88ce2bde0e94c2423263\nparent 780beae7bd598cc1c2667c5434b5a6034c706f8c\nparent 14033108cd34f08d92b28ff0ae2eafb2d81bf8b4\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1676284497 +0100\ncommitter GitHub <noreply@github.com> 1676284497 +0100\n\nRollup merge of #107922 - Kobzol:ci-print-disk-size, r=Mark-Simulacrum\n\nPrint disk usage in PGO CI script\n\nTo diagnose issues like https://github.com/rust-lang/rust/pull/94857#issuecomment-1426648675.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8674adc25ce84312a13262af80a2914dfca7c3d7", "html_url": "https://github.com/rust-lang/rust/commit/8674adc25ce84312a13262af80a2914dfca7c3d7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8674adc25ce84312a13262af80a2914dfca7c3d7/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "780beae7bd598cc1c2667c5434b5a6034c706f8c", "url": "https://api.github.com/repos/rust-lang/rust/commits/780beae7bd598cc1c2667c5434b5a6034c706f8c", "html_url": "https://github.com/rust-lang/rust/commit/780beae7bd598cc1c2667c5434b5a6034c706f8c"}, {"sha": "14033108cd34f08d92b28ff0ae2eafb2d81bf8b4", "url": "https://api.github.com/repos/rust-lang/rust/commits/14033108cd34f08d92b28ff0ae2eafb2d81bf8b4", "html_url": "https://github.com/rust-lang/rust/commit/14033108cd34f08d92b28ff0ae2eafb2d81bf8b4"}], "stats": {"total": 19, "additions": 17, "deletions": 2}, "files": [{"sha": "4e6bcba5e20d22be42b542bf3e66e62dd74cd5e0", "filename": "src/ci/stage-build.py", "status": "modified", "additions": 17, "deletions": 2, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/8674adc25ce84312a13262af80a2914dfca7c3d7/src%2Fci%2Fstage-build.py", "raw_url": "https://github.com/rust-lang/rust/raw/8674adc25ce84312a13262af80a2914dfca7c3d7/src%2Fci%2Fstage-build.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fstage-build.py?ref=8674adc25ce84312a13262af80a2914dfca7c3d7", "patch": "@@ -211,7 +211,8 @@ def get_timestamp() -> float:\n TimerSection = Union[Duration, \"Timer\"]\n \n \n-def iterate_sections(section: TimerSection, name: str, level: int = 0) -> Iterator[Tuple[int, str, Duration]]:\n+def iterate_sections(section: TimerSection, name: str, level: int = 0) -> Iterator[\n+    Tuple[int, str, Duration]]:\n     \"\"\"\n     Hierarchically iterate the sections of a timer, in a depth-first order.\n     \"\"\"\n@@ -239,7 +240,7 @@ def section(self, name: str) -> \"Timer\":\n         start = get_timestamp()\n         exc = None\n \n-        child_timer = Timer(parent_names=self.parent_names + (name, ))\n+        child_timer = Timer(parent_names=self.parent_names + (name,))\n         full_name = \" > \".join(child_timer.parent_names)\n         try:\n             LOGGER.info(f\"Section `{full_name}` starts\")\n@@ -648,6 +649,16 @@ def print_binary_sizes(pipeline: Pipeline):\n         LOGGER.info(f\"Rustc binary size\\n{output.getvalue()}\")\n \n \n+def print_free_disk_space(pipeline: Pipeline):\n+    usage = shutil.disk_usage(pipeline.opt_artifacts())\n+    total = usage.total\n+    used = usage.used\n+    free = usage.free\n+\n+    logging.info(\n+        f\"Free disk space: {format_bytes(free)} out of total {format_bytes(total)} ({(used / total) * 100:.2f}% used)\")\n+\n+\n def execute_build_pipeline(timer: Timer, pipeline: Pipeline, final_build_args: List[str]):\n     # Clear and prepare tmp directory\n     shutil.rmtree(pipeline.opt_artifacts(), ignore_errors=True)\n@@ -666,6 +677,7 @@ def execute_build_pipeline(timer: Timer, pipeline: Pipeline, final_build_args: L\n \n         with stage1.section(\"Gather profiles\"):\n             gather_llvm_profiles(pipeline)\n+        print_free_disk_space(pipeline)\n \n     clear_llvm_files(pipeline)\n     final_build_args += [\n@@ -683,6 +695,7 @@ def execute_build_pipeline(timer: Timer, pipeline: Pipeline, final_build_args: L\n \n         with stage2.section(\"Gather profiles\"):\n             gather_rustc_profiles(pipeline)\n+        print_free_disk_space(pipeline)\n \n     clear_llvm_files(pipeline)\n     final_build_args += [\n@@ -702,6 +715,7 @@ def execute_build_pipeline(timer: Timer, pipeline: Pipeline, final_build_args: L\n             with stage3.section(\"Gather profiles\"):\n                 gather_llvm_bolt_profiles(pipeline)\n \n+        print_free_disk_space(pipeline)\n         clear_llvm_files(pipeline)\n         final_build_args += [\n             \"--llvm-bolt-profile-use\",\n@@ -733,5 +747,6 @@ def execute_build_pipeline(timer: Timer, pipeline: Pipeline, final_build_args: L\n         raise e\n     finally:\n         timer.print_stats()\n+        print_free_disk_space(pipeline)\n \n     print_binary_sizes(pipeline)"}]}