{"sha": "5cad51c0c5a21c94bb119277131ac4b60576041a", "node_id": "C_kwDOAAsO6NoAKDVjYWQ1MWMwYzVhMjFjOTRiYjExOTI3NzEzMWFjNGI2MDU3NjA0MWE", "commit": {"author": {"name": "Michael Howell", "email": "michael@notriddle.com", "date": "2023-04-07T03:25:07Z"}, "committer": {"name": "Michael Howell", "email": "michael@notriddle.com", "date": "2023-04-07T03:25:07Z"}, "message": "rustdoc: add test and bug fix for theme defaults", "tree": {"sha": "7733fb28911fa9d26792d8aa786228d4b07c362d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7733fb28911fa9d26792d8aa786228d4b07c362d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5cad51c0c5a21c94bb119277131ac4b60576041a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5cad51c0c5a21c94bb119277131ac4b60576041a", "html_url": "https://github.com/rust-lang/rust/commit/5cad51c0c5a21c94bb119277131ac4b60576041a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5cad51c0c5a21c94bb119277131ac4b60576041a/comments", "author": {"login": "notriddle", "id": 1593513, "node_id": "MDQ6VXNlcjE1OTM1MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/1593513?v=4", "gravatar_id": "", "url": "https://api.github.com/users/notriddle", "html_url": "https://github.com/notriddle", "followers_url": "https://api.github.com/users/notriddle/followers", "following_url": "https://api.github.com/users/notriddle/following{/other_user}", "gists_url": "https://api.github.com/users/notriddle/gists{/gist_id}", "starred_url": "https://api.github.com/users/notriddle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/notriddle/subscriptions", "organizations_url": "https://api.github.com/users/notriddle/orgs", "repos_url": "https://api.github.com/users/notriddle/repos", "events_url": "https://api.github.com/users/notriddle/events{/privacy}", "received_events_url": "https://api.github.com/users/notriddle/received_events", "type": "User", "site_admin": false}, "committer": {"login": "notriddle", "id": 1593513, "node_id": "MDQ6VXNlcjE1OTM1MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/1593513?v=4", "gravatar_id": "", "url": "https://api.github.com/users/notriddle", "html_url": "https://github.com/notriddle", "followers_url": "https://api.github.com/users/notriddle/followers", "following_url": "https://api.github.com/users/notriddle/following{/other_user}", "gists_url": "https://api.github.com/users/notriddle/gists{/gist_id}", "starred_url": "https://api.github.com/users/notriddle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/notriddle/subscriptions", "organizations_url": "https://api.github.com/users/notriddle/orgs", "repos_url": "https://api.github.com/users/notriddle/repos", "events_url": "https://api.github.com/users/notriddle/events{/privacy}", "received_events_url": "https://api.github.com/users/notriddle/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "de74dab880447f5227030b261dbd0f2bc4f32dba", "url": "https://api.github.com/repos/rust-lang/rust/commits/de74dab880447f5227030b261dbd0f2bc4f32dba", "html_url": "https://github.com/rust-lang/rust/commit/de74dab880447f5227030b261dbd0f2bc4f32dba"}], "stats": {"total": 25, "additions": 25, "deletions": 0}, "files": [{"sha": "67d3981ce07cd3a0fe27dbc6b5750007f362be27", "filename": "src/librustdoc/html/static/js/storage.js", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/5cad51c0c5a21c94bb119277131ac4b60576041a/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fstorage.js", "raw_url": "https://github.com/rust-lang/rust/raw/5cad51c0c5a21c94bb119277131ac4b60576041a/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fstorage.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fstorage.js?ref=5cad51c0c5a21c94bb119277131ac4b60576041a", "patch": "@@ -158,6 +158,7 @@ const updateTheme = (function() {\n         if (getSettingValue(\"use-system-theme\") !== \"false\") {\n             const lightTheme = getSettingValue(\"preferred-light-theme\") || \"light\";\n             const darkTheme = getSettingValue(\"preferred-dark-theme\") || \"dark\";\n+            updateLocalStorage(\"use-system-theme\", \"true\");\n \n             if (mql.matches) {\n                 use(darkTheme, true);"}, {"sha": "d5ed536b1a9621a52ae25e9157890927a4db74c8", "filename": "tests/rustdoc-gui/theme-defaults.goml", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/5cad51c0c5a21c94bb119277131ac4b60576041a/tests%2Frustdoc-gui%2Ftheme-defaults.goml", "raw_url": "https://github.com/rust-lang/rust/raw/5cad51c0c5a21c94bb119277131ac4b60576041a/tests%2Frustdoc-gui%2Ftheme-defaults.goml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frustdoc-gui%2Ftheme-defaults.goml?ref=5cad51c0c5a21c94bb119277131ac4b60576041a", "patch": "@@ -0,0 +1,24 @@\n+// Ensure that the theme picker always starts with the actual defaults.\n+goto: \"file://\" + |DOC_PATH| + \"/test_docs/index.html\"\n+click: \"#settings-menu\"\n+wait-for: \"#theme-system-preference\"\n+assert: \"#theme-system-preference:checked\"\n+assert: \"#preferred-light-theme-light:checked\"\n+assert: \"#preferred-dark-theme-dark:checked\"\n+assert-false: \"#preferred-dark-theme-ayu:checked\"\n+\n+// Test legacy migration from old theme setup without system-preference matching.\n+// See https://github.com/rust-lang/rust/pull/77809#issuecomment-707875732\n+local-storage: {\n+    \"rustdoc-preferred-light-theme\": null,\n+    \"rustdoc-preferred-dark-theme\": null,\n+    \"rustdoc-use-system-theme\": null,\n+    \"rustdoc-theme\": \"ayu\"\n+}\n+goto: \"file://\" + |DOC_PATH| + \"/test_docs/index.html\"\n+click: \"#settings-menu\"\n+wait-for: \"#theme-system-preference\"\n+assert: \"#theme-system-preference:checked\"\n+assert: \"#preferred-light-theme-light:checked\"\n+assert-false: \"#preferred-dark-theme-dark:checked\"\n+assert: \"#preferred-dark-theme-ayu:checked\""}]}