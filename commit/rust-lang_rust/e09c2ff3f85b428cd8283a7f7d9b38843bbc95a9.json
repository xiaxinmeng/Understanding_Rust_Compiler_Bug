{"sha": "e09c2ff3f85b428cd8283a7f7d9b38843bbc95a9", "node_id": "MDY6Q29tbWl0NzI0NzEyOmUwOWMyZmYzZjg1YjQyOGNkODI4M2E3ZjdkOWIzODg0M2JiYzk1YTk=", "commit": {"author": {"name": "John K\u00e5re Alsaker", "email": "john.kare.alsaker@gmail.com", "date": "2018-03-17T22:02:27Z"}, "committer": {"name": "John K\u00e5re Alsaker", "email": "john.kare.alsaker@gmail.com", "date": "2018-03-17T22:02:27Z"}, "message": "Make interners thread-safe", "tree": {"sha": "de78ff15b6e165c0033d59cbdd138074eb247078", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/de78ff15b6e165c0033d59cbdd138074eb247078"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e09c2ff3f85b428cd8283a7f7d9b38843bbc95a9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e09c2ff3f85b428cd8283a7f7d9b38843bbc95a9", "html_url": "https://github.com/rust-lang/rust/commit/e09c2ff3f85b428cd8283a7f7d9b38843bbc95a9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e09c2ff3f85b428cd8283a7f7d9b38843bbc95a9/comments", "author": {"login": "Zoxc", "id": 25784, "node_id": "MDQ6VXNlcjI1Nzg0", "avatar_url": "https://avatars.githubusercontent.com/u/25784?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Zoxc", "html_url": "https://github.com/Zoxc", "followers_url": "https://api.github.com/users/Zoxc/followers", "following_url": "https://api.github.com/users/Zoxc/following{/other_user}", "gists_url": "https://api.github.com/users/Zoxc/gists{/gist_id}", "starred_url": "https://api.github.com/users/Zoxc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Zoxc/subscriptions", "organizations_url": "https://api.github.com/users/Zoxc/orgs", "repos_url": "https://api.github.com/users/Zoxc/repos", "events_url": "https://api.github.com/users/Zoxc/events{/privacy}", "received_events_url": "https://api.github.com/users/Zoxc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Zoxc", "id": 25784, "node_id": "MDQ6VXNlcjI1Nzg0", "avatar_url": "https://avatars.githubusercontent.com/u/25784?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Zoxc", "html_url": "https://github.com/Zoxc", "followers_url": "https://api.github.com/users/Zoxc/followers", "following_url": "https://api.github.com/users/Zoxc/following{/other_user}", "gists_url": "https://api.github.com/users/Zoxc/gists{/gist_id}", "starred_url": "https://api.github.com/users/Zoxc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Zoxc/subscriptions", "organizations_url": "https://api.github.com/users/Zoxc/orgs", "repos_url": "https://api.github.com/users/Zoxc/repos", "events_url": "https://api.github.com/users/Zoxc/events{/privacy}", "received_events_url": "https://api.github.com/users/Zoxc/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ec4a9c6b2fb188ffd5eeee00e635061fb784af5d", "url": "https://api.github.com/repos/rust-lang/rust/commits/ec4a9c6b2fb188ffd5eeee00e635061fb784af5d", "html_url": "https://github.com/rust-lang/rust/commit/ec4a9c6b2fb188ffd5eeee00e635061fb784af5d"}], "stats": {"total": 15, "additions": 9, "deletions": 6}, "files": [{"sha": "966c96e594fc4d1781f927b0cbb713a222dc58c6", "filename": "src/librustc/ty/context.rs", "status": "modified", "additions": 9, "deletions": 6, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/e09c2ff3f85b428cd8283a7f7d9b38843bbc95a9/src%2Flibrustc%2Fty%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e09c2ff3f85b428cd8283a7f7d9b38843bbc95a9/src%2Flibrustc%2Fty%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fcontext.rs?ref=e09c2ff3f85b428cd8283a7f7d9b38843bbc95a9", "patch": "@@ -1080,12 +1080,13 @@ impl<'a, 'gcx, 'tcx> TyCtxt<'a, 'gcx, 'tcx> {\n         self,\n         alloc: interpret::Allocation,\n     ) -> &'gcx interpret::Allocation {\n-        if let Some(alloc) = self.interpret_interner.inner.borrow().allocs.get(&alloc) {\n+        let allocs = &mut self.interpret_interner.inner.borrow_mut().allocs;\n+        if let Some(alloc) = allocs.get(&alloc) {\n             return alloc;\n         }\n \n         let interned = self.global_arenas.const_allocs.alloc(alloc);\n-        if let Some(prev) = self.interpret_interner.inner.borrow_mut().allocs.replace(interned) {\n+        if let Some(prev) = allocs.replace(interned) {\n             bug!(\"Tried to overwrite interned Allocation: {:#?}\", prev)\n         }\n         interned\n@@ -1112,24 +1113,26 @@ impl<'a, 'gcx, 'tcx> TyCtxt<'a, 'gcx, 'tcx> {\n     }\n \n     pub fn intern_stability(self, stab: attr::Stability) -> &'gcx attr::Stability {\n-        if let Some(st) = self.stability_interner.borrow().get(&stab) {\n+        let mut stability_interner = self.stability_interner.borrow_mut();\n+        if let Some(st) = stability_interner.get(&stab) {\n             return st;\n         }\n \n         let interned = self.global_interners.arena.alloc(stab);\n-        if let Some(prev) = self.stability_interner.borrow_mut().replace(interned) {\n+        if let Some(prev) = stability_interner.replace(interned) {\n             bug!(\"Tried to overwrite interned Stability: {:?}\", prev)\n         }\n         interned\n     }\n \n     pub fn intern_layout(self, layout: LayoutDetails) -> &'gcx LayoutDetails {\n-        if let Some(layout) = self.layout_interner.borrow().get(&layout) {\n+        let mut layout_interner = self.layout_interner.borrow_mut();\n+        if let Some(layout) = layout_interner.get(&layout) {\n             return layout;\n         }\n \n         let interned = self.global_arenas.layout.alloc(layout);\n-        if let Some(prev) = self.layout_interner.borrow_mut().replace(interned) {\n+        if let Some(prev) = layout_interner.replace(interned) {\n             bug!(\"Tried to overwrite interned Layout: {:?}\", prev)\n         }\n         interned"}]}