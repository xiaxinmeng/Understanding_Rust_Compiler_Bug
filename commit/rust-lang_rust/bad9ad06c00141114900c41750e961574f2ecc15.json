{"sha": "bad9ad06c00141114900c41750e961574f2ecc15", "node_id": "MDY6Q29tbWl0NzI0NzEyOmJhZDlhZDA2YzAwMTQxMTE0OTAwYzQxNzUwZTk2MTU3NGYyZWNjMTU=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-10-03T22:13:01Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-10-03T22:13:01Z"}, "message": "Auto merge of #77434 - jonas-schievink:ret-in-reg-2-electric-boogalo, r=nagisa\n\nReturns values up to 2*usize by value\n\nAddresses https://github.com/rust-lang/rust/pull/76986#discussion_r498306837 and https://github.com/rust-lang/rust/pull/76986#issuecomment-696415287 by doing the optimization on all targets.\n\nThis matches what we do for functions returning `&[T]` and other fat pointers, so it should be Harmless\u2122", "tree": {"sha": "ddb91ef2b789eaa66b5159a8ad66c439bbab4546", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ddb91ef2b789eaa66b5159a8ad66c439bbab4546"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bad9ad06c00141114900c41750e961574f2ecc15", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bad9ad06c00141114900c41750e961574f2ecc15", "html_url": "https://github.com/rust-lang/rust/commit/bad9ad06c00141114900c41750e961574f2ecc15", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bad9ad06c00141114900c41750e961574f2ecc15/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "25c8c53dd994acb3f4f7c02fe6bb46076393f8b0", "url": "https://api.github.com/repos/rust-lang/rust/commits/25c8c53dd994acb3f4f7c02fe6bb46076393f8b0", "html_url": "https://github.com/rust-lang/rust/commit/25c8c53dd994acb3f4f7c02fe6bb46076393f8b0"}, {"sha": "b01694e0a2f36cee14e5844e1b4abae965dee627", "url": "https://api.github.com/repos/rust-lang/rust/commits/b01694e0a2f36cee14e5844e1b4abae965dee627", "html_url": "https://github.com/rust-lang/rust/commit/b01694e0a2f36cee14e5844e1b4abae965dee627"}], "stats": {"total": 17, "additions": 3, "deletions": 14}, "files": [{"sha": "b61fde32c9ce84e5646d9e5a8366733ab4120769", "filename": "compiler/rustc_middle/src/ty/layout.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/bad9ad06c00141114900c41750e961574f2ecc15/compiler%2Frustc_middle%2Fsrc%2Fty%2Flayout.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bad9ad06c00141114900c41750e961574f2ecc15/compiler%2Frustc_middle%2Fsrc%2Fty%2Flayout.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Flayout.rs?ref=bad9ad06c00141114900c41750e961574f2ecc15", "patch": "@@ -2787,8 +2787,9 @@ where\n                     _ => return,\n                 }\n \n-                let max_by_val_size =\n-                    if is_ret { call::max_ret_by_val(cx) } else { Pointer.size(cx) };\n+                // Return structures up to 2 pointers in size by value, matching `ScalarPair`. LLVM\n+                // will usually return these in 2 registers, which is more efficient than by-ref.\n+                let max_by_val_size = if is_ret { Pointer.size(cx) * 2 } else { Pointer.size(cx) };\n                 let size = arg.layout.size;\n \n                 if arg.layout.is_unsized() || size > max_by_val_size {"}, {"sha": "8f7e2bba5aa6d785ea72f08fbd39d01ef7bfd55e", "filename": "compiler/rustc_target/src/abi/call/mod.rs", "status": "modified", "additions": 0, "deletions": 12, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/bad9ad06c00141114900c41750e961574f2ecc15/compiler%2Frustc_target%2Fsrc%2Fabi%2Fcall%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bad9ad06c00141114900c41750e961574f2ecc15/compiler%2Frustc_target%2Fsrc%2Fabi%2Fcall%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fabi%2Fcall%2Fmod.rs?ref=bad9ad06c00141114900c41750e961574f2ecc15", "patch": "@@ -610,15 +610,3 @@ impl<'a, Ty> FnAbi<'a, Ty> {\n         Ok(())\n     }\n }\n-\n-/// Returns the maximum size of return values to be passed by value in the Rust ABI.\n-///\n-/// Return values beyond this size will use an implicit out-pointer instead.\n-pub fn max_ret_by_val<C: HasTargetSpec + HasDataLayout>(spec: &C) -> Size {\n-    match spec.target_spec().arch.as_str() {\n-        // System-V will pass return values up to 128 bits in RAX/RDX.\n-        \"x86_64\" => Size::from_bits(128),\n-\n-        _ => spec.data_layout().pointer_size,\n-    }\n-}"}]}