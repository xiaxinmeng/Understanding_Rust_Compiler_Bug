{"sha": "e29a4c36c7135820929e741ed40192648556aca6", "node_id": "MDY6Q29tbWl0NzI0NzEyOmUyOWE0YzM2YzcxMzU4MjA5MjllNzQxZWQ0MDE5MjY0ODU1NmFjYTY=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-06-13T10:13:56Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-06-13T10:13:56Z"}, "message": "Merge #9243\n\n9243: internal: check that coverage marks are always paired r=matklad a=matklad\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>", "tree": {"sha": "020b9667f0f723b06ee7fb6948efaa9e6b135f68", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/020b9667f0f723b06ee7fb6948efaa9e6b135f68"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e29a4c36c7135820929e741ed40192648556aca6", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgxdpkCRBK7hj4Ov3rIwAAZTAIAAjrHfKzGmS4R8gK3VZxL9B4\n87aiO/7DwG4rBHLd9Q9M1NGOAca1zd+h9zW3Dnnq7CSHOI8mFPaL15NAuL07yHFP\ntB2njUNZOcBjM1g+bYngzZstNfcMa8+/wI5S8TmqC3RR0Vc6ZvbYKSOMZS9qvyjd\nnxiSqE0UbUIH9w5bzhJbHR5Hvn4pBcLsKVgKEn2vyLHeShVCB0ErHSXonpx8DRfR\nhTpzAHwHWQB1e2CXReNrfHo+rb0i9gtMuzQgz+m1ercdMyK9+bHzTKofPnmbTUuz\nAHHsv8eODPD7RcSYnVazJgp2OYCrgICkkGaECwcAFWtKCVr2RhvfiIgEteotsWg=\n=p5Wf\n-----END PGP SIGNATURE-----\n", "payload": "tree 020b9667f0f723b06ee7fb6948efaa9e6b135f68\nparent adbee621a75f47e0da4f30d7205dfce009138865\nparent 546be18e3a91e4844b0dacc76c9f055397b6d89e\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1623579236 +0000\ncommitter GitHub <noreply@github.com> 1623579236 +0000\n\nMerge #9243\n\n9243: internal: check that coverage marks are always paired r=matklad a=matklad\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e29a4c36c7135820929e741ed40192648556aca6", "html_url": "https://github.com/rust-lang/rust/commit/e29a4c36c7135820929e741ed40192648556aca6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e29a4c36c7135820929e741ed40192648556aca6/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "adbee621a75f47e0da4f30d7205dfce009138865", "url": "https://api.github.com/repos/rust-lang/rust/commits/adbee621a75f47e0da4f30d7205dfce009138865", "html_url": "https://github.com/rust-lang/rust/commit/adbee621a75f47e0da4f30d7205dfce009138865"}, {"sha": "546be18e3a91e4844b0dacc76c9f055397b6d89e", "url": "https://api.github.com/repos/rust-lang/rust/commits/546be18e3a91e4844b0dacc76c9f055397b6d89e", "html_url": "https://github.com/rust-lang/rust/commit/546be18e3a91e4844b0dacc76c9f055397b6d89e"}], "stats": {"total": 62, "additions": 56, "deletions": 6}, "files": [{"sha": "15c10d053f229adb6ffe8bdd54c9e3796cc58861", "filename": "crates/hir_def/src/body/tests/block.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/e29a4c36c7135820929e741ed40192648556aca6/crates%2Fhir_def%2Fsrc%2Fbody%2Ftests%2Fblock.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e29a4c36c7135820929e741ed40192648556aca6/crates%2Fhir_def%2Fsrc%2Fbody%2Ftests%2Fblock.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fbody%2Ftests%2Fblock.rs?ref=e29a4c36c7135820929e741ed40192648556aca6", "patch": "@@ -163,14 +163,14 @@ fn legacy_macro_items() {\n     // correctly.\n     check_at(\n         r#\"\n-macro_rules! hit {\n+macro_rules! mark {\n     () => {\n         struct Hit {}\n     }\n }\n \n fn f() {\n-    hit!();\n+    mark!();\n     $0\n }\n \"#,\n@@ -193,20 +193,20 @@ use core::cov_mark;\n \n fn f() {\n     fn nested() {\n-        cov_mark::hit!(Hit);\n+        cov_mark::mark!(Hit);\n         $0\n     }\n }\n //- /core.rs crate:core\n pub mod cov_mark {\n     #[macro_export]\n-    macro_rules! _hit {\n+    macro_rules! _mark {\n         ($name:ident) => {\n             struct $name {}\n         }\n     }\n \n-    pub use crate::_hit as hit;\n+    pub use crate::_mark as mark;\n }\n \"#,\n         expect![[r#\""}, {"sha": "471cd49210b0767f7b8649f9c5dffccc4377d425", "filename": "crates/hir_ty/src/diagnostics/match_check/deconstruct_pat.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/e29a4c36c7135820929e741ed40192648556aca6/crates%2Fhir_ty%2Fsrc%2Fdiagnostics%2Fmatch_check%2Fdeconstruct_pat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e29a4c36c7135820929e741ed40192648556aca6/crates%2Fhir_ty%2Fsrc%2Fdiagnostics%2Fmatch_check%2Fdeconstruct_pat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Fdiagnostics%2Fmatch_check%2Fdeconstruct_pat.rs?ref=e29a4c36c7135820929e741ed40192648556aca6", "patch": "@@ -664,6 +664,7 @@ impl Fields {\n                         let is_non_exhaustive =\n                             is_field_list_non_exhaustive(variant_id, cx) && !adt_is_local;\n \n+                        cov_mark::hit!(match_check_wildcard_expanded_to_substitutions);\n                         let field_ty_data = cx.db.field_types(variant_id);\n                         let field_tys = || {\n                             field_ty_data"}, {"sha": "337a904b6335fae0ed994451c597cd691703d617", "filename": "crates/ide/src/diagnostics.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/e29a4c36c7135820929e741ed40192648556aca6/crates%2Fide%2Fsrc%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e29a4c36c7135820929e741ed40192648556aca6/crates%2Fide%2Fsrc%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fdiagnostics.rs?ref=e29a4c36c7135820929e741ed40192648556aca6", "patch": "@@ -2172,6 +2172,7 @@ fn main() {\n \n     #[test]\n     fn pattern_type_is_of_substitution() {\n+        cov_mark::check!(match_check_wildcard_expanded_to_substitutions);\n         check_diagnostics(\n             r#\"\n struct Foo<T>(T);"}, {"sha": "d8ca18c733e1c6cb63550c6bcd955c5f92e9220a", "filename": "crates/ide_completion/src/render.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/e29a4c36c7135820929e741ed40192648556aca6/crates%2Fide_completion%2Fsrc%2Frender.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e29a4c36c7135820929e741ed40192648556aca6/crates%2Fide_completion%2Fsrc%2Frender.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Frender.rs?ref=e29a4c36c7135820929e741ed40192648556aca6", "patch": "@@ -1007,6 +1007,7 @@ fn go(world: &WorldSnapshot) { go(w$0) }\n \n     #[test]\n     fn too_many_arguments() {\n+        cov_mark::check!(too_many_arguments);\n         check_relevance(\n             r#\"\n struct Foo;"}, {"sha": "e6fa5868de58401a9eaeb9f78fd271e8da6ae7aa", "filename": "xtask/src/tidy.rs", "status": "modified", "additions": 48, "deletions": 1, "changes": 49, "blob_url": "https://github.com/rust-lang/rust/blob/e29a4c36c7135820929e741ed40192648556aca6/xtask%2Fsrc%2Ftidy.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e29a4c36c7135820929e741ed40192648556aca6/xtask%2Fsrc%2Ftidy.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/xtask%2Fsrc%2Ftidy.rs?ref=e29a4c36c7135820929e741ed40192648556aca6", "patch": "@@ -1,4 +1,7 @@\n-use std::path::{Path, PathBuf};\n+use std::{\n+    collections::HashSet,\n+    path::{Path, PathBuf},\n+};\n \n use xshell::{cmd, pushd, pushenv, read_file};\n \n@@ -81,15 +84,18 @@ Please adjust docs/dev/lsp-extensions.md.\n #[test]\n fn rust_files_are_tidy() {\n     let mut tidy_docs = TidyDocs::default();\n+    let mut tidy_marks = TidyMarks::default();\n     for path in rust_files() {\n         let text = read_file(&path).unwrap();\n         check_todo(&path, &text);\n         check_dbg(&path, &text);\n         check_trailing_ws(&path, &text);\n         deny_clippy(&path, &text);\n         tidy_docs.visit(&path, &text);\n+        tidy_marks.visit(&path, &text);\n     }\n     tidy_docs.finish();\n+    tidy_marks.finish();\n }\n \n #[test]\n@@ -408,6 +414,39 @@ fn is_exclude_dir(p: &Path, dirs_to_exclude: &[&str]) -> bool {\n         .any(|it| dirs_to_exclude.contains(&it))\n }\n \n+#[derive(Default)]\n+struct TidyMarks {\n+    hits: HashSet<String>,\n+    checks: HashSet<String>,\n+}\n+\n+impl TidyMarks {\n+    fn visit(&mut self, _path: &Path, text: &str) {\n+        for line in text.lines() {\n+            if let Some(mark) = find_mark(line, \"hit\") {\n+                self.hits.insert(mark.to_string());\n+            }\n+            if let Some(mark) = find_mark(line, \"check\") {\n+                self.checks.insert(mark.to_string());\n+            }\n+            if let Some(mark) = find_mark(line, \"check_count\") {\n+                self.checks.insert(mark.to_string());\n+            }\n+        }\n+    }\n+\n+    fn finish(self) {\n+        assert!(!self.hits.is_empty());\n+\n+        let diff: Vec<_> =\n+            self.hits.symmetric_difference(&self.checks).map(|it| it.as_str()).collect();\n+\n+        if !diff.is_empty() {\n+            panic!(\"unpaired marks: {:?}\", diff)\n+        }\n+    }\n+}\n+\n #[allow(deprecated)]\n fn stable_hash(text: &str) -> u64 {\n     use std::hash::{Hash, Hasher, SipHasher};\n@@ -417,3 +456,11 @@ fn stable_hash(text: &str) -> u64 {\n     text.hash(&mut hasher);\n     hasher.finish()\n }\n+\n+fn find_mark<'a>(text: &'a str, mark: &'static str) -> Option<&'a str> {\n+    let idx = text.find(mark)?;\n+    let text = text[idx + mark.len()..].strip_prefix(\"!(\")?;\n+    let idx = text.find(|c: char| !(c.is_alphanumeric() || c == '_'))?;\n+    let text = &text[..idx];\n+    Some(text)\n+}"}]}