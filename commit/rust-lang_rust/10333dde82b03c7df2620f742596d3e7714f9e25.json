{"sha": "10333dde82b03c7df2620f742596d3e7714f9e25", "node_id": "MDY6Q29tbWl0NzI0NzEyOjEwMzMzZGRlODJiMDNjN2RmMjYyMGY3NDI1OTZkM2U3NzE0ZjllMjU=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-01-19T04:45:22Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-01-19T04:45:22Z"}, "message": "Auto merge of #47494 - michaelwoerister:proc-macro-incremental, r=nikomatsakis\n\nDon't include DefIndex in proc-macro registrar function symbol.\n\nThere can only ever be one registrar function per plugin or proc-macro crate, so adding the `DefIndex` to the function's symbol name does not serve a real purpose. Remove the `DefIndex` from the symbol name makes it stable across incremental compilation sessions.\n\nThis should fix issue #47292.", "tree": {"sha": "8fb15906cf99a8aa18681c612b5b5a426afbb7c4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8fb15906cf99a8aa18681c612b5b5a426afbb7c4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/10333dde82b03c7df2620f742596d3e7714f9e25", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/10333dde82b03c7df2620f742596d3e7714f9e25", "html_url": "https://github.com/rust-lang/rust/commit/10333dde82b03c7df2620f742596d3e7714f9e25", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/10333dde82b03c7df2620f742596d3e7714f9e25/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9af8d42ec79558225043189e429e9d652ff89eab", "url": "https://api.github.com/repos/rust-lang/rust/commits/9af8d42ec79558225043189e429e9d652ff89eab", "html_url": "https://github.com/rust-lang/rust/commit/9af8d42ec79558225043189e429e9d652ff89eab"}, {"sha": "f0a7d8e2bd5a878ef65b34406637c1032507a675", "url": "https://api.github.com/repos/rust-lang/rust/commits/f0a7d8e2bd5a878ef65b34406637c1032507a675", "html_url": "https://github.com/rust-lang/rust/commit/f0a7d8e2bd5a878ef65b34406637c1032507a675"}], "stats": {"total": 108, "additions": 82, "deletions": 26}, "files": [{"sha": "1187376e1775311abc6c8c750d64e4d093cc3b2f", "filename": "src/bootstrap/check.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/10333dde82b03c7df2620f742596d3e7714f9e25/src%2Fbootstrap%2Fcheck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/10333dde82b03c7df2620f742596d3e7714f9e25/src%2Fbootstrap%2Fcheck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcheck.rs?ref=10333dde82b03c7df2620f742596d3e7714f9e25", "patch": "@@ -605,6 +605,11 @@ static HOST_COMPILETESTS: &[Test] = &[\n         mode: \"compile-fail\",\n         suite: \"compile-fail-fulldeps\",\n     },\n+    Test {\n+        path: \"src/test/incremental-fulldeps\",\n+        mode: \"incremental\",\n+        suite: \"incremental-fulldeps\",\n+    },\n     Test { path: \"src/test/run-make\", mode: \"run-make\", suite: \"run-make\" },\n     Test { path: \"src/test/rustdoc\", mode: \"rustdoc\", suite: \"rustdoc\" },\n "}, {"sha": "94fcfb7e2aa572ccc357df605c0b5e5bfa25f9d9", "filename": "src/librustc/session/mod.rs", "status": "modified", "additions": 7, "deletions": 9, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/10333dde82b03c7df2620f742596d3e7714f9e25/src%2Flibrustc%2Fsession%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/10333dde82b03c7df2620f742596d3e7714f9e25/src%2Flibrustc%2Fsession%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fsession%2Fmod.rs?ref=10333dde82b03c7df2620f742596d3e7714f9e25", "patch": "@@ -11,7 +11,7 @@\n pub use self::code_stats::{CodeStats, DataTypeKind, FieldInfo};\n pub use self::code_stats::{SizeKind, TypeSizeInfo, VariantInfo};\n \n-use hir::def_id::{CrateNum, DefIndex};\n+use hir::def_id::CrateNum;\n use ich::Fingerprint;\n \n use lint;\n@@ -558,18 +558,16 @@ impl Session {\n \n     /// Returns the symbol name for the registrar function,\n     /// given the crate Svh and the function DefIndex.\n-    pub fn generate_plugin_registrar_symbol(&self, disambiguator: CrateDisambiguator,\n-                                            index: DefIndex)\n+    pub fn generate_plugin_registrar_symbol(&self,\n+                                            disambiguator: CrateDisambiguator)\n                                             -> String {\n-        format!(\"__rustc_plugin_registrar__{}_{}\", disambiguator.to_fingerprint().to_hex(),\n-                                                   index.to_proc_macro_index())\n+        format!(\"__rustc_plugin_registrar_{}__\", disambiguator.to_fingerprint().to_hex())\n     }\n \n-    pub fn generate_derive_registrar_symbol(&self, disambiguator: CrateDisambiguator,\n-                                            index: DefIndex)\n+    pub fn generate_derive_registrar_symbol(&self,\n+                                            disambiguator: CrateDisambiguator)\n                                             -> String {\n-        format!(\"__rustc_derive_registrar__{}_{}\", disambiguator.to_fingerprint().to_hex(),\n-                                                   index.to_proc_macro_index())\n+        format!(\"__rustc_derive_registrar_{}__\", disambiguator.to_fingerprint().to_hex())\n     }\n \n     pub fn sysroot<'a>(&'a self) -> &'a Path {"}, {"sha": "246f5c9255ef414d1e450752891c42ba6c479292", "filename": "src/librustc_metadata/creader.rs", "status": "modified", "additions": 7, "deletions": 9, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/10333dde82b03c7df2620f742596d3e7714f9e25/src%2Flibrustc_metadata%2Fcreader.rs", "raw_url": "https://github.com/rust-lang/rust/raw/10333dde82b03c7df2620f742596d3e7714f9e25/src%2Flibrustc_metadata%2Fcreader.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Fcreader.rs?ref=10333dde82b03c7df2620f742596d3e7714f9e25", "patch": "@@ -15,7 +15,7 @@ use locator::{self, CratePaths};\n use native_libs::relevant_lib;\n use schema::CrateRoot;\n \n-use rustc::hir::def_id::{CrateNum, DefIndex, CRATE_DEF_INDEX};\n+use rustc::hir::def_id::{CrateNum, CRATE_DEF_INDEX};\n use rustc::hir::svh::Svh;\n use rustc::middle::allocator::AllocatorKind;\n use rustc::middle::cstore::DepKind;\n@@ -532,8 +532,7 @@ impl<'a> CrateLoader<'a> {\n             Err(err) => self.sess.span_fatal(span, &err),\n         };\n \n-        let sym = self.sess.generate_derive_registrar_symbol(root.disambiguator,\n-                                                             root.macro_derive_registrar.unwrap());\n+        let sym = self.sess.generate_derive_registrar_symbol(root.disambiguator);\n         let registrar = unsafe {\n             let sym = match lib.symbol(&sym) {\n                 Ok(f) => f,\n@@ -588,7 +587,7 @@ impl<'a> CrateLoader<'a> {\n     pub fn find_plugin_registrar(&mut self,\n                                  span: Span,\n                                  name: &str)\n-                                 -> Option<(PathBuf, CrateDisambiguator, DefIndex)> {\n+                                 -> Option<(PathBuf, CrateDisambiguator)> {\n         let name = Symbol::intern(name);\n         let ekrate = self.read_extension_crate(span, name, name);\n \n@@ -603,11 +602,11 @@ impl<'a> CrateLoader<'a> {\n         }\n \n         let root = ekrate.metadata.get_root();\n-        match (ekrate.dylib.as_ref(), root.plugin_registrar_fn) {\n-            (Some(dylib), Some(reg)) => {\n-                Some((dylib.to_path_buf(), root.disambiguator, reg))\n+        match ekrate.dylib.as_ref() {\n+            Some(dylib) => {\n+                Some((dylib.to_path_buf(), root.disambiguator))\n             }\n-            (None, Some(_)) => {\n+            None => {\n                 span_err!(self.sess, span, E0457,\n                           \"plugin `{}` only found in rlib format, but must be available \\\n                            in dylib format\",\n@@ -616,7 +615,6 @@ impl<'a> CrateLoader<'a> {\n                 // empty dylib.\n                 None\n             }\n-            _ => None,\n         }\n     }\n "}, {"sha": "a46b85d93cbb82cc3024e0b533822d26997a7739", "filename": "src/librustc_plugin/load.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/10333dde82b03c7df2620f742596d3e7714f9e25/src%2Flibrustc_plugin%2Fload.rs", "raw_url": "https://github.com/rust-lang/rust/raw/10333dde82b03c7df2620f742596d3e7714f9e25/src%2Flibrustc_plugin%2Fload.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_plugin%2Fload.rs?ref=10333dde82b03c7df2620f742596d3e7714f9e25", "patch": "@@ -100,8 +100,8 @@ impl<'a> PluginLoader<'a> {\n     fn load_plugin(&mut self, span: Span, name: &str, args: Vec<ast::NestedMetaItem>) {\n         let registrar = self.reader.find_plugin_registrar(span, name);\n \n-        if let Some((lib, disambiguator, index)) = registrar {\n-            let symbol = self.sess.generate_plugin_registrar_symbol(disambiguator, index);\n+        if let Some((lib, disambiguator)) = registrar {\n+            let symbol = self.sess.generate_plugin_registrar_symbol(disambiguator);\n             let fun = self.dylink_registrar(span, lib, symbol);\n             self.plugins.push(PluginRegistrar {\n                 fun,"}, {"sha": "15ff59c7df998098603d60a101b40dd164864f77", "filename": "src/librustc_trans/back/symbol_export.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/10333dde82b03c7df2620f742596d3e7714f9e25/src%2Flibrustc_trans%2Fback%2Fsymbol_export.rs", "raw_url": "https://github.com/rust-lang/rust/raw/10333dde82b03c7df2620f742596d3e7714f9e25/src%2Flibrustc_trans%2Fback%2Fsymbol_export.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Fback%2Fsymbol_export.rs?ref=10333dde82b03c7df2620f742596d3e7714f9e25", "patch": "@@ -115,9 +115,8 @@ pub fn provide(providers: &mut Providers) {\n \n         if let Some(id) = tcx.sess.derive_registrar_fn.get() {\n             let def_id = tcx.hir.local_def_id(id);\n-            let idx = def_id.index;\n             let disambiguator = tcx.sess.local_crate_disambiguator();\n-            let registrar = tcx.sess.generate_derive_registrar_symbol(disambiguator, idx);\n+            let registrar = tcx.sess.generate_derive_registrar_symbol(disambiguator);\n             local_crate.push((registrar, Some(def_id), SymbolExportLevel::C));\n         }\n "}, {"sha": "3ceff659ea93a40e79fbcbe0f74b2dbffc5b20c2", "filename": "src/librustc_trans/back/symbol_names.rs", "status": "modified", "additions": 2, "deletions": 4, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/10333dde82b03c7df2620f742596d3e7714f9e25/src%2Flibrustc_trans%2Fback%2Fsymbol_names.rs", "raw_url": "https://github.com/rust-lang/rust/raw/10333dde82b03c7df2620f742596d3e7714f9e25/src%2Flibrustc_trans%2Fback%2Fsymbol_names.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Fback%2Fsymbol_names.rs?ref=10333dde82b03c7df2620f742596d3e7714f9e25", "patch": "@@ -257,14 +257,12 @@ fn compute_symbol_name<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>, instance: Instance\n \n     if let Some(id) = node_id {\n         if tcx.sess.plugin_registrar_fn.get() == Some(id) {\n-            let idx = def_id.index;\n             let disambiguator = tcx.sess.local_crate_disambiguator();\n-            return tcx.sess.generate_plugin_registrar_symbol(disambiguator, idx);\n+            return tcx.sess.generate_plugin_registrar_symbol(disambiguator);\n         }\n         if tcx.sess.derive_registrar_fn.get() == Some(id) {\n-            let idx = def_id.index;\n             let disambiguator = tcx.sess.local_crate_disambiguator();\n-            return tcx.sess.generate_derive_registrar_symbol(disambiguator, idx);\n+            return tcx.sess.generate_derive_registrar_symbol(disambiguator);\n         }\n     }\n "}, {"sha": "e9f9ba86f23dcafcfbdeea1ed1fafb884f44875b", "filename": "src/test/incremental-fulldeps/auxiliary/incremental_proc_macro_aux.rs", "status": "added", "additions": 31, "deletions": 0, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/10333dde82b03c7df2620f742596d3e7714f9e25/src%2Ftest%2Fincremental-fulldeps%2Fauxiliary%2Fincremental_proc_macro_aux.rs", "raw_url": "https://github.com/rust-lang/rust/raw/10333dde82b03c7df2620f742596d3e7714f9e25/src%2Ftest%2Fincremental-fulldeps%2Fauxiliary%2Fincremental_proc_macro_aux.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fincremental-fulldeps%2Fauxiliary%2Fincremental_proc_macro_aux.rs?ref=10333dde82b03c7df2620f742596d3e7714f9e25", "patch": "@@ -0,0 +1,31 @@\n+// Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// no-prefer-dynamic\n+\n+#![crate_type = \"proc-macro\"]\n+\n+extern crate proc_macro;\n+\n+use proc_macro::TokenStream;\n+\n+// Add a function to shift DefIndex of registrar function\n+#[cfg(cfail2)]\n+fn foo() {}\n+\n+#[proc_macro_derive(IncrementalMacro)]\n+pub fn derive(input: TokenStream) -> TokenStream {\n+    #[cfg(cfail2)]\n+    {\n+        foo();\n+    }\n+\n+    \"\".parse().unwrap()\n+}"}, {"sha": "e434507085332e2f0ff32d91282d44ad34b1e500", "filename": "src/test/incremental-fulldeps/incremental_proc_macro.rs", "status": "added", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/10333dde82b03c7df2620f742596d3e7714f9e25/src%2Ftest%2Fincremental-fulldeps%2Fincremental_proc_macro.rs", "raw_url": "https://github.com/rust-lang/rust/raw/10333dde82b03c7df2620f742596d3e7714f9e25/src%2Ftest%2Fincremental-fulldeps%2Fincremental_proc_macro.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fincremental-fulldeps%2Fincremental_proc_macro.rs?ref=10333dde82b03c7df2620f742596d3e7714f9e25", "patch": "@@ -0,0 +1,27 @@\n+// Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// aux-build:incremental_proc_macro_aux.rs\n+// ignore-stage1\n+// revisions: cfail1 cfail2\n+// must-compile-successfully\n+\n+// This test makes sure that we still find the proc-macro registrar function\n+// when we compile proc-macros incrementally (see #47292).\n+\n+#![crate_type = \"rlib\"]\n+\n+#[macro_use]\n+extern crate incremental_proc_macro_aux;\n+\n+#[derive(IncrementalMacro)]\n+pub struct Foo {\n+    x: u32\n+}"}]}