{"sha": "999888c086446c4c43bd5e99d8a0d2a1a7ee0404", "node_id": "C_kwDOAAsO6NoAKDk5OTg4OGMwODY0NDZjNGM0M2JkNWU5OWQ4YTBkMmExYTdlZTA0MDQ", "commit": {"author": {"name": "b-naber", "email": "bn263@gmx.de", "date": "2021-09-21T13:07:28Z"}, "committer": {"name": "b-naber", "email": "bn263@gmx.de", "date": "2021-09-21T13:49:29Z"}, "message": "add case for checking const refs in check_const_value_eq", "tree": {"sha": "f0c178a95cc28d5ba28739c7e83e643b8c4c2cf8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f0c178a95cc28d5ba28739c7e83e643b8c4c2cf8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/999888c086446c4c43bd5e99d8a0d2a1a7ee0404", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/999888c086446c4c43bd5e99d8a0d2a1a7ee0404", "html_url": "https://github.com/rust-lang/rust/commit/999888c086446c4c43bd5e99d8a0d2a1a7ee0404", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/999888c086446c4c43bd5e99d8a0d2a1a7ee0404/comments", "author": {"login": "b-naber", "id": 71934879, "node_id": "MDQ6VXNlcjcxOTM0ODc5", "avatar_url": "https://avatars.githubusercontent.com/u/71934879?v=4", "gravatar_id": "", "url": "https://api.github.com/users/b-naber", "html_url": "https://github.com/b-naber", "followers_url": "https://api.github.com/users/b-naber/followers", "following_url": "https://api.github.com/users/b-naber/following{/other_user}", "gists_url": "https://api.github.com/users/b-naber/gists{/gist_id}", "starred_url": "https://api.github.com/users/b-naber/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/b-naber/subscriptions", "organizations_url": "https://api.github.com/users/b-naber/orgs", "repos_url": "https://api.github.com/users/b-naber/repos", "events_url": "https://api.github.com/users/b-naber/events{/privacy}", "received_events_url": "https://api.github.com/users/b-naber/received_events", "type": "User", "site_admin": false}, "committer": {"login": "b-naber", "id": 71934879, "node_id": "MDQ6VXNlcjcxOTM0ODc5", "avatar_url": "https://avatars.githubusercontent.com/u/71934879?v=4", "gravatar_id": "", "url": "https://api.github.com/users/b-naber", "html_url": "https://github.com/b-naber", "followers_url": "https://api.github.com/users/b-naber/followers", "following_url": "https://api.github.com/users/b-naber/following{/other_user}", "gists_url": "https://api.github.com/users/b-naber/gists{/gist_id}", "starred_url": "https://api.github.com/users/b-naber/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/b-naber/subscriptions", "organizations_url": "https://api.github.com/users/b-naber/orgs", "repos_url": "https://api.github.com/users/b-naber/repos", "events_url": "https://api.github.com/users/b-naber/events{/privacy}", "received_events_url": "https://api.github.com/users/b-naber/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e846f9c44f1e17cac66d7b75e2ca099c87a2dfcb", "url": "https://api.github.com/repos/rust-lang/rust/commits/e846f9c44f1e17cac66d7b75e2ca099c87a2dfcb", "html_url": "https://github.com/rust-lang/rust/commit/e846f9c44f1e17cac66d7b75e2ca099c87a2dfcb"}], "stats": {"total": 57, "additions": 57, "deletions": 0}, "files": [{"sha": "2c786538014ff20421324e5927de8a613caaf4e0", "filename": "compiler/rustc_middle/src/ty/relate.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/999888c086446c4c43bd5e99d8a0d2a1a7ee0404/compiler%2Frustc_middle%2Fsrc%2Fty%2Frelate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/999888c086446c4c43bd5e99d8a0d2a1a7ee0404/compiler%2Frustc_middle%2Fsrc%2Fty%2Frelate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Frelate.rs?ref=999888c086446c4c43bd5e99d8a0d2a1a7ee0404", "patch": "@@ -639,6 +639,15 @@ fn check_const_value_eq<R: TypeRelation<'tcx>>(\n             get_slice_bytes(&tcx, a_val) == get_slice_bytes(&tcx, b_val)\n         }\n \n+        (ConstValue::ByRef { alloc: alloc_a, .. }, ConstValue::ByRef { alloc: alloc_b, .. })\n+            if a.ty.is_ref() || b.ty.is_ref() =>\n+        {\n+            if a.ty.is_ref() && b.ty.is_ref() {\n+                alloc_a == alloc_b\n+            } else {\n+                false\n+            }\n+        }\n         (ConstValue::ByRef { .. }, ConstValue::ByRef { .. }) => {\n             let a_destructured = tcx.destructure_const(relation.param_env().and(a));\n             let b_destructured = tcx.destructure_const(relation.param_env().and(b));"}, {"sha": "204d18ea25de4482ead25c12fd49f9a1bc7b43ff", "filename": "src/test/ui/consts/refs_check_const_eq-issue-88384.rs", "status": "added", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/999888c086446c4c43bd5e99d8a0d2a1a7ee0404/src%2Ftest%2Fui%2Fconsts%2Frefs_check_const_eq-issue-88384.rs", "raw_url": "https://github.com/rust-lang/rust/raw/999888c086446c4c43bd5e99d8a0d2a1a7ee0404/src%2Ftest%2Fui%2Fconsts%2Frefs_check_const_eq-issue-88384.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Frefs_check_const_eq-issue-88384.rs?ref=999888c086446c4c43bd5e99d8a0d2a1a7ee0404", "patch": "@@ -0,0 +1,25 @@\n+// check-pass\n+\n+#![feature(fn_traits)]\n+#![feature(adt_const_params)]\n+//~^ WARNING the feature `adt_const_params` is incomplete\n+\n+#[derive(PartialEq, Eq)]\n+struct CompileTimeSettings{\n+    hooks: &'static[fn()],\n+}\n+\n+struct Foo<const T: CompileTimeSettings>;\n+\n+impl<const T: CompileTimeSettings> Foo<T> {\n+    fn call_hooks(){\n+    }\n+}\n+\n+fn main(){\n+    const SETTINGS: CompileTimeSettings = CompileTimeSettings{\n+        hooks: &[],\n+    };\n+\n+    Foo::<SETTINGS>::call_hooks();\n+}"}, {"sha": "55928b495b24caf4c401492be1718db7bb6b5574", "filename": "src/test/ui/consts/refs_check_const_eq-issue-88384.stderr", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/999888c086446c4c43bd5e99d8a0d2a1a7ee0404/src%2Ftest%2Fui%2Fconsts%2Frefs_check_const_eq-issue-88384.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/999888c086446c4c43bd5e99d8a0d2a1a7ee0404/src%2Ftest%2Fui%2Fconsts%2Frefs_check_const_eq-issue-88384.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Frefs_check_const_eq-issue-88384.stderr?ref=999888c086446c4c43bd5e99d8a0d2a1a7ee0404", "patch": "@@ -0,0 +1,11 @@\n+warning: the feature `adt_const_params` is incomplete and may not be safe to use and/or cause compiler crashes\n+  --> $DIR/refs_check_const_eq-issue-88384.rs:4:12\n+   |\n+LL | #![feature(adt_const_params)]\n+   |            ^^^^^^^^^^^^^^^^\n+   |\n+   = note: `#[warn(incomplete_features)]` on by default\n+   = note: see issue #44580 <https://github.com/rust-lang/rust/issues/44580> for more information\n+\n+warning: 1 warning emitted\n+"}, {"sha": "6ce9da436680047d2632c3274997e5eeda4666c1", "filename": "src/test/ui/consts/refs_check_const_value_eq-issue-88876.rs", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/999888c086446c4c43bd5e99d8a0d2a1a7ee0404/src%2Ftest%2Fui%2Fconsts%2Frefs_check_const_value_eq-issue-88876.rs", "raw_url": "https://github.com/rust-lang/rust/raw/999888c086446c4c43bd5e99d8a0d2a1a7ee0404/src%2Ftest%2Fui%2Fconsts%2Frefs_check_const_value_eq-issue-88876.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Frefs_check_const_value_eq-issue-88876.rs?ref=999888c086446c4c43bd5e99d8a0d2a1a7ee0404", "patch": "@@ -0,0 +1,12 @@\n+// check-pass\n+\n+#![allow(incomplete_features)]\n+#![feature(adt_const_params)]\n+\n+struct FooConst<const ARRAY: &'static [&'static str]> {}\n+\n+const FOO_ARR: &[&'static str; 2] = &[\"Hello\", \"Friend\"];\n+\n+fn main() {\n+    let _ = FooConst::<FOO_ARR> {};\n+}"}]}