{"sha": "4450807ead1c5f9a5f8d44ffee6ed0f968c68c34", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQ0NTA4MDdlYWQxYzVmOWE1ZjhkNDRmZmVlNmVkMGY5NjhjNjhjMzQ=", "commit": {"author": {"name": "Jan Niehusmann", "email": "github@gondor.com", "date": "2017-05-30T15:50:44Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2017-05-30T15:50:44Z"}, "message": "ARMv5 needs +strict-align\n\nWithout that flag, LLVM generates unaligned memory access instructions, which are not allowed on ARMv5.\r\n\r\nFor example, the 'hello world' example from `cargo --new` failed with:\r\n```\r\n$ ./hello\r\nHello, world!\r\nthread 'main' panicked at 'assertion failed: end <= len', src/libcollections/vec.rs:1113\r\nnote: Run with `RUST_BACKTRACE=1` for a backtrace.\r\n```\r\n\r\nI traced this error back to the following assembler code in `BufWriter::flush_buf`:\r\n```\r\n    6f44:       e28d0018        add     r0, sp, #24\r\n[...]\r\n    6f54:       e280b005        add     fp, r0, #5\r\n[...]\r\n    7018:       e5cd001c        strb    r0, [sp, #28]\r\n    701c:       e1a0082a        lsr     r0, sl, #16\r\n    7020:       03a01001        moveq   r1, #1\r\n    7024:       e5cb0002        strb    r0, [fp, #2]\r\n    7028:       e1cba0b0        strh    sl, [fp]\r\n```\r\n\r\nNote that `fp` points to `sp + 29`, so the three `str*`-instructions should fill up a 32bit - value at `sp + 28`, which is later used as the value `n` in `Ok(n) => written += n`. This doesn't work on ARMv5 as the `strh` can't write to the unaligned contents of `fp`, so the upper bits of `n` won't get cleared, leading to the assertion failure in Vec::drain.\r\n\r\nWith `+strict-align`, the code works as expected.", "tree": {"sha": "f22dfb05b9c53ceaf173a7f69aa5b211d47b67f0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f22dfb05b9c53ceaf173a7f69aa5b211d47b67f0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4450807ead1c5f9a5f8d44ffee6ed0f968c68c34", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4450807ead1c5f9a5f8d44ffee6ed0f968c68c34", "html_url": "https://github.com/rust-lang/rust/commit/4450807ead1c5f9a5f8d44ffee6ed0f968c68c34", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4450807ead1c5f9a5f8d44ffee6ed0f968c68c34/comments", "author": {"login": "jannic", "id": 232606, "node_id": "MDQ6VXNlcjIzMjYwNg==", "avatar_url": "https://avatars.githubusercontent.com/u/232606?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jannic", "html_url": "https://github.com/jannic", "followers_url": "https://api.github.com/users/jannic/followers", "following_url": "https://api.github.com/users/jannic/following{/other_user}", "gists_url": "https://api.github.com/users/jannic/gists{/gist_id}", "starred_url": "https://api.github.com/users/jannic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jannic/subscriptions", "organizations_url": "https://api.github.com/users/jannic/orgs", "repos_url": "https://api.github.com/users/jannic/repos", "events_url": "https://api.github.com/users/jannic/events{/privacy}", "received_events_url": "https://api.github.com/users/jannic/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f89d8d184490ecb3cf91f7b6bb7296d649f931ba", "url": "https://api.github.com/repos/rust-lang/rust/commits/f89d8d184490ecb3cf91f7b6bb7296d649f931ba", "html_url": "https://github.com/rust-lang/rust/commit/f89d8d184490ecb3cf91f7b6bb7296d649f931ba"}], "stats": {"total": 2, "additions": 1, "deletions": 1}, "files": [{"sha": "ef00c9a3278b925d07190053dc7c5fb34b97ee3d", "filename": "src/librustc_back/target/armv5te_unknown_linux_gnueabi.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/4450807ead1c5f9a5f8d44ffee6ed0f968c68c34/src%2Flibrustc_back%2Ftarget%2Farmv5te_unknown_linux_gnueabi.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4450807ead1c5f9a5f8d44ffee6ed0f968c68c34/src%2Flibrustc_back%2Ftarget%2Farmv5te_unknown_linux_gnueabi.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_back%2Ftarget%2Farmv5te_unknown_linux_gnueabi.rs?ref=4450807ead1c5f9a5f8d44ffee6ed0f968c68c34", "patch": "@@ -25,7 +25,7 @@ pub fn target() -> TargetResult {\n         linker_flavor: LinkerFlavor::Gcc,\n \n         options: TargetOptions {\n-            features: \"+soft-float\".to_string(),\n+            features: \"+soft-float,+strict-align\".to_string(),\n             // No atomic instructions on ARMv5\n             max_atomic_width: Some(0),\n             abi_blacklist: super::arm_base::abi_blacklist(),"}]}