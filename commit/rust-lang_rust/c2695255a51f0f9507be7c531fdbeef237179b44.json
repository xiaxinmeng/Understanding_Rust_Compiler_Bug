{"sha": "c2695255a51f0f9507be7c531fdbeef237179b44", "node_id": "MDY6Q29tbWl0NzI0NzEyOmMyNjk1MjU1YTUxZjBmOTUwN2JlN2M1MzFmZGJlZWYyMzcxNzliNDQ=", "commit": {"author": {"name": "Yuki Okushi", "email": "huyuumi.dev@gmail.com", "date": "2020-08-01T16:29:21Z"}, "committer": {"name": "Yuki Okushi", "email": "huyuumi.dev@gmail.com", "date": "2020-11-02T06:53:58Z"}, "message": "Avoid complex diagnostics in snippets which contain newlines", "tree": {"sha": "7829e1ba255a7a67b8264fafef95d5b6c7985c0b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7829e1ba255a7a67b8264fafef95d5b6c7985c0b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c2695255a51f0f9507be7c531fdbeef237179b44", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c2695255a51f0f9507be7c531fdbeef237179b44", "html_url": "https://github.com/rust-lang/rust/commit/c2695255a51f0f9507be7c531fdbeef237179b44", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c2695255a51f0f9507be7c531fdbeef237179b44/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d8ef0d7757742862116c455345120dcbfb7e74e0", "url": "https://api.github.com/repos/rust-lang/rust/commits/d8ef0d7757742862116c455345120dcbfb7e74e0", "html_url": "https://github.com/rust-lang/rust/commit/d8ef0d7757742862116c455345120dcbfb7e74e0"}], "stats": {"total": 56, "additions": 56, "deletions": 0}, "files": [{"sha": "2965a7e0654a4edb39d33d962c1c889116ee1d4c", "filename": "src/test/ui/async-await/issue-70935-complex-spans.rs", "status": "added", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/c2695255a51f0f9507be7c531fdbeef237179b44/src%2Ftest%2Fui%2Fasync-await%2Fissue-70935-complex-spans.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c2695255a51f0f9507be7c531fdbeef237179b44/src%2Ftest%2Fui%2Fasync-await%2Fissue-70935-complex-spans.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasync-await%2Fissue-70935-complex-spans.rs?ref=c2695255a51f0f9507be7c531fdbeef237179b44", "patch": "@@ -0,0 +1,25 @@\n+// edition:2018\n+// #70935: Check if we do not emit snippet\n+// with newlines which lead complex diagnostics.\n+\n+use std::future::Future;\n+\n+async fn baz<T>(_c: impl FnMut() -> T) where T: Future<Output=()> {\n+}\n+\n+fn foo(tx: std::sync::mpsc::Sender<i32>) -> impl Future + Send {\n+    //~^ ERROR: future cannot be sent between threads safely\n+    async move {\n+        baz(|| async{\n+            foo(tx.clone());\n+        }).await;\n+    }\n+}\n+\n+fn bar(_s: impl Future + Send) {\n+}\n+\n+fn main() {\n+    let (tx, _rx) = std::sync::mpsc::channel();\n+    bar(foo(tx));\n+}"}, {"sha": "d9ce038f72b1a97302df987491c9c7a71ef3f900", "filename": "src/test/ui/async-await/issue-70935-complex-spans.stderr", "status": "added", "additions": 31, "deletions": 0, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/c2695255a51f0f9507be7c531fdbeef237179b44/src%2Ftest%2Fui%2Fasync-await%2Fissue-70935-complex-spans.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c2695255a51f0f9507be7c531fdbeef237179b44/src%2Ftest%2Fui%2Fasync-await%2Fissue-70935-complex-spans.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasync-await%2Fissue-70935-complex-spans.stderr?ref=c2695255a51f0f9507be7c531fdbeef237179b44", "patch": "@@ -0,0 +1,31 @@\n+error: future cannot be sent between threads safely\n+  --> $DIR/issue-70935-complex-spans.rs:10:45\n+   |\n+LL |   fn foo(tx: std::sync::mpsc::Sender<i32>) -> impl Future + Send {\n+   |                                               ^^^^^^^^^^^^^^^^^^ future created by async block is not `Send`\n+LL |\n+LL | /     async move {\n+LL | |         baz(|| async{\n+LL | |             foo(tx.clone());\n+LL | |         }).await;\n+LL | |     }\n+   | |_____- this returned value is of type `impl std::future::Future`\n+   |\n+   = help: the trait `std::marker::Sync` is not implemented for `std::sync::mpsc::Sender<i32>`\n+note: future is not `Send` as this value is used across an await\n+  --> $DIR/issue-70935-complex-spans.rs:13:9\n+   |\n+LL |            baz(|| async{\n+   |  __________^___-\n+   | | _________|\n+   | ||\n+LL | ||             foo(tx.clone());\n+LL | ||         }).await;\n+   | ||         -      ^- value is later dropped here\n+   | ||_________|______|\n+   | |__________|      await occurs here, with value maybe used later\n+   |            has type `[closure@$DIR/issue-70935-complex-spans.rs:13:13: 15:10 tx:&std::sync::mpsc::Sender<i32>]` which is not `Send`\n+   = note: the return type of a function must have a statically known size\n+\n+error: aborting due to previous error\n+"}]}