{"sha": "28921b4213d1f0c0e5eacf2b69146ca7e5f2c22b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI4OTIxYjQyMTNkMWYwYzBlNWVhY2YyYjY5MTQ2Y2E3ZTVmMmMyMmI=", "commit": {"author": {"name": "Aman Arora", "email": "me@aman-arora.com", "date": "2021-07-09T08:34:11Z"}, "committer": {"name": "Aman Arora", "email": "me@aman-arora.com", "date": "2021-07-09T08:34:11Z"}, "message": "Add more tests", "tree": {"sha": "31de7f2746d59fac54a7aea59f7e6ea14f109aa8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/31de7f2746d59fac54a7aea59f7e6ea14f109aa8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/28921b4213d1f0c0e5eacf2b69146ca7e5f2c22b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/28921b4213d1f0c0e5eacf2b69146ca7e5f2c22b", "html_url": "https://github.com/rust-lang/rust/commit/28921b4213d1f0c0e5eacf2b69146ca7e5f2c22b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/28921b4213d1f0c0e5eacf2b69146ca7e5f2c22b/comments", "author": {"login": "arora-aman", "id": 4193035, "node_id": "MDQ6VXNlcjQxOTMwMzU=", "avatar_url": "https://avatars.githubusercontent.com/u/4193035?v=4", "gravatar_id": "", "url": "https://api.github.com/users/arora-aman", "html_url": "https://github.com/arora-aman", "followers_url": "https://api.github.com/users/arora-aman/followers", "following_url": "https://api.github.com/users/arora-aman/following{/other_user}", "gists_url": "https://api.github.com/users/arora-aman/gists{/gist_id}", "starred_url": "https://api.github.com/users/arora-aman/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/arora-aman/subscriptions", "organizations_url": "https://api.github.com/users/arora-aman/orgs", "repos_url": "https://api.github.com/users/arora-aman/repos", "events_url": "https://api.github.com/users/arora-aman/events{/privacy}", "received_events_url": "https://api.github.com/users/arora-aman/received_events", "type": "User", "site_admin": false}, "committer": {"login": "arora-aman", "id": 4193035, "node_id": "MDQ6VXNlcjQxOTMwMzU=", "avatar_url": "https://avatars.githubusercontent.com/u/4193035?v=4", "gravatar_id": "", "url": "https://api.github.com/users/arora-aman", "html_url": "https://github.com/arora-aman", "followers_url": "https://api.github.com/users/arora-aman/followers", "following_url": "https://api.github.com/users/arora-aman/following{/other_user}", "gists_url": "https://api.github.com/users/arora-aman/gists{/gist_id}", "starred_url": "https://api.github.com/users/arora-aman/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/arora-aman/subscriptions", "organizations_url": "https://api.github.com/users/arora-aman/orgs", "repos_url": "https://api.github.com/users/arora-aman/repos", "events_url": "https://api.github.com/users/arora-aman/events{/privacy}", "received_events_url": "https://api.github.com/users/arora-aman/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6195d6dcace1bc0f9b6d37089d33b8bed786c371", "url": "https://api.github.com/repos/rust-lang/rust/commits/6195d6dcace1bc0f9b6d37089d33b8bed786c371", "html_url": "https://github.com/rust-lang/rust/commit/6195d6dcace1bc0f9b6d37089d33b8bed786c371"}], "stats": {"total": 106, "additions": 105, "deletions": 1}, "files": [{"sha": "3b284eadbd0e3a6ef1073d66481a45e9850b8bf6", "filename": "src/test/ui/closures/2229_closure_analysis/move_closure.rs", "status": "modified", "additions": 38, "deletions": 0, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/28921b4213d1f0c0e5eacf2b69146ca7e5f2c22b/src%2Ftest%2Fui%2Fclosures%2F2229_closure_analysis%2Fmove_closure.rs", "raw_url": "https://github.com/rust-lang/rust/raw/28921b4213d1f0c0e5eacf2b69146ca7e5f2c22b/src%2Ftest%2Fui%2Fclosures%2F2229_closure_analysis%2Fmove_closure.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fclosures%2F2229_closure_analysis%2Fmove_closure.rs?ref=28921b4213d1f0c0e5eacf2b69146ca7e5f2c22b", "patch": "@@ -159,11 +159,49 @@ fn truncate_box_derefs() {\n     };\n }\n \n+struct Foo { x: i32 }\n+\n+// Ensure that even in move closures, if the data is not owned by the root variable\n+// then we don't truncate the derefs or a ByValue capture, rather do a reborrow\n+fn box_mut_1() {\n+    let mut foo = Foo { x: 0 } ;\n+\n+    let p_foo = &mut foo;\n+    let box_p_foo = Box::new(p_foo);\n+\n+    let c = #[rustc_capture_analysis] move || box_p_foo.x += 10;\n+    //~^ ERROR: attributes on expressions are experimental\n+    //~| NOTE: see issue #15701 <https://github.com/rust-lang/rust/issues/15701>\n+    //~| First Pass analysis includes:\n+    //~| NOTE: Capturing box_p_foo[Deref,Deref,(0, 0)] -> UniqueImmBorrow\n+    //~| Min Capture analysis includes:\n+    //~| NOTE: Min Capture box_p_foo[Deref,Deref,(0, 0)] -> UniqueImmBorrow\n+}\n+\n+// Ensure that even in move closures, if the data is not owned by the root variable\n+// then we don't truncate the derefs or a ByValue capture, rather do a reborrow\n+fn box_mut_2() {\n+    let foo = Foo { x: 0 } ;\n+\n+    let mut box_foo = Box::new(foo);\n+    let p_foo = &mut box_foo;\n+\n+    let c = #[rustc_capture_analysis] move || p_foo.x += 10;\n+    //~^ ERROR: attributes on expressions are experimental\n+    //~| NOTE: see issue #15701 <https://github.com/rust-lang/rust/issues/15701>\n+    //~| First Pass analysis includes:\n+    //~| NOTE: Capturing p_foo[Deref,Deref,(0, 0)] -> UniqueImmBorrow\n+    //~| Min Capture analysis includes:\n+    //~| NOTE: Min Capture p_foo[Deref,Deref,(0, 0)] -> UniqueImmBorrow\n+}\n+\n fn main() {\n     simple_move_closure();\n     simple_ref();\n     struct_contains_ref_to_another_struct_1();\n     struct_contains_ref_to_another_struct_2();\n     struct_contains_ref_to_another_struct_3();\n     truncate_box_derefs();\n+    box_mut_2();\n+    box_mut_1();\n }"}, {"sha": "c8e2708feee314a3ef7f765ee1174c6604daaea6", "filename": "src/test/ui/closures/2229_closure_analysis/move_closure.stderr", "status": "modified", "additions": 67, "deletions": 1, "changes": 68, "blob_url": "https://github.com/rust-lang/rust/blob/28921b4213d1f0c0e5eacf2b69146ca7e5f2c22b/src%2Ftest%2Fui%2Fclosures%2F2229_closure_analysis%2Fmove_closure.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/28921b4213d1f0c0e5eacf2b69146ca7e5f2c22b/src%2Ftest%2Fui%2Fclosures%2F2229_closure_analysis%2Fmove_closure.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fclosures%2F2229_closure_analysis%2Fmove_closure.stderr?ref=28921b4213d1f0c0e5eacf2b69146ca7e5f2c22b", "patch": "@@ -70,6 +70,24 @@ LL |     let c = #[rustc_capture_analysis]\n    = note: see issue #15701 <https://github.com/rust-lang/rust/issues/15701> for more information\n    = help: add `#![feature(stmt_expr_attributes)]` to the crate attributes to enable\n \n+error[E0658]: attributes on expressions are experimental\n+  --> $DIR/move_closure.rs:172:13\n+   |\n+LL |     let c = #[rustc_capture_analysis] move || box_p_foo.x += 10;\n+   |             ^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+   = note: see issue #15701 <https://github.com/rust-lang/rust/issues/15701> for more information\n+   = help: add `#![feature(stmt_expr_attributes)]` to the crate attributes to enable\n+\n+error[E0658]: attributes on expressions are experimental\n+  --> $DIR/move_closure.rs:189:13\n+   |\n+LL |     let c = #[rustc_capture_analysis] move || p_foo.x += 10;\n+   |             ^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+   = note: see issue #15701 <https://github.com/rust-lang/rust/issues/15701> for more information\n+   = help: add `#![feature(stmt_expr_attributes)]` to the crate attributes to enable\n+\n error: First Pass analysis includes:\n   --> $DIR/move_closure.rs:15:5\n    |\n@@ -358,6 +376,54 @@ note: Min Capture t[(1, 0)] -> ByValue\n LL |         println!(\"{}\", t.1.0);\n    |                        ^^^^^\n \n-error: aborting due to 24 previous errors\n+error: First Pass analysis includes:\n+  --> $DIR/move_closure.rs:172:39\n+   |\n+LL |     let c = #[rustc_capture_analysis] move || box_p_foo.x += 10;\n+   |                                       ^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+note: Capturing box_p_foo[Deref,Deref,(0, 0)] -> UniqueImmBorrow\n+  --> $DIR/move_closure.rs:172:47\n+   |\n+LL |     let c = #[rustc_capture_analysis] move || box_p_foo.x += 10;\n+   |                                               ^^^^^^^^^^^\n+\n+error: Min Capture analysis includes:\n+  --> $DIR/move_closure.rs:172:39\n+   |\n+LL |     let c = #[rustc_capture_analysis] move || box_p_foo.x += 10;\n+   |                                       ^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+note: Min Capture box_p_foo[Deref,Deref,(0, 0)] -> UniqueImmBorrow\n+  --> $DIR/move_closure.rs:172:47\n+   |\n+LL |     let c = #[rustc_capture_analysis] move || box_p_foo.x += 10;\n+   |                                               ^^^^^^^^^^^\n+\n+error: First Pass analysis includes:\n+  --> $DIR/move_closure.rs:189:39\n+   |\n+LL |     let c = #[rustc_capture_analysis] move || p_foo.x += 10;\n+   |                                       ^^^^^^^^^^^^^^^^^^^^^\n+   |\n+note: Capturing p_foo[Deref,Deref,(0, 0)] -> UniqueImmBorrow\n+  --> $DIR/move_closure.rs:189:47\n+   |\n+LL |     let c = #[rustc_capture_analysis] move || p_foo.x += 10;\n+   |                                               ^^^^^^^\n+\n+error: Min Capture analysis includes:\n+  --> $DIR/move_closure.rs:189:39\n+   |\n+LL |     let c = #[rustc_capture_analysis] move || p_foo.x += 10;\n+   |                                       ^^^^^^^^^^^^^^^^^^^^^\n+   |\n+note: Min Capture p_foo[Deref,Deref,(0, 0)] -> UniqueImmBorrow\n+  --> $DIR/move_closure.rs:189:47\n+   |\n+LL |     let c = #[rustc_capture_analysis] move || p_foo.x += 10;\n+   |                                               ^^^^^^^\n+\n+error: aborting due to 30 previous errors\n \n For more information about this error, try `rustc --explain E0658`."}]}