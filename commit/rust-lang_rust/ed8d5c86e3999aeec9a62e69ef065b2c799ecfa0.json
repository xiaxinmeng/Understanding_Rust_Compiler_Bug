{"sha": "ed8d5c86e3999aeec9a62e69ef065b2c799ecfa0", "node_id": "MDY6Q29tbWl0NzI0NzEyOmVkOGQ1Yzg2ZTM5OTlhZWVjOWE2MmU2OWVmMDY1YjJjNzk5ZWNmYTA=", "commit": {"author": {"name": "Edwin Cheng", "email": "edwin0cheng@gmail.com", "date": "2020-01-16T15:37:43Z"}, "committer": {"name": "Edwin Cheng", "email": "edwin0cheng@gmail.com", "date": "2020-01-16T15:37:43Z"}, "message": "Fix array element attribute position", "tree": {"sha": "c2764faa7663b25e137e1040e7499d57c47aed94", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c2764faa7663b25e137e1040e7499d57c47aed94"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ed8d5c86e3999aeec9a62e69ef065b2c799ecfa0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ed8d5c86e3999aeec9a62e69ef065b2c799ecfa0", "html_url": "https://github.com/rust-lang/rust/commit/ed8d5c86e3999aeec9a62e69ef065b2c799ecfa0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ed8d5c86e3999aeec9a62e69ef065b2c799ecfa0/comments", "author": {"login": "edwin0cheng", "id": 11014119, "node_id": "MDQ6VXNlcjExMDE0MTE5", "avatar_url": "https://avatars.githubusercontent.com/u/11014119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/edwin0cheng", "html_url": "https://github.com/edwin0cheng", "followers_url": "https://api.github.com/users/edwin0cheng/followers", "following_url": "https://api.github.com/users/edwin0cheng/following{/other_user}", "gists_url": "https://api.github.com/users/edwin0cheng/gists{/gist_id}", "starred_url": "https://api.github.com/users/edwin0cheng/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/edwin0cheng/subscriptions", "organizations_url": "https://api.github.com/users/edwin0cheng/orgs", "repos_url": "https://api.github.com/users/edwin0cheng/repos", "events_url": "https://api.github.com/users/edwin0cheng/events{/privacy}", "received_events_url": "https://api.github.com/users/edwin0cheng/received_events", "type": "User", "site_admin": false}, "committer": {"login": "edwin0cheng", "id": 11014119, "node_id": "MDQ6VXNlcjExMDE0MTE5", "avatar_url": "https://avatars.githubusercontent.com/u/11014119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/edwin0cheng", "html_url": "https://github.com/edwin0cheng", "followers_url": "https://api.github.com/users/edwin0cheng/followers", "following_url": "https://api.github.com/users/edwin0cheng/following{/other_user}", "gists_url": "https://api.github.com/users/edwin0cheng/gists{/gist_id}", "starred_url": "https://api.github.com/users/edwin0cheng/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/edwin0cheng/subscriptions", "organizations_url": "https://api.github.com/users/edwin0cheng/orgs", "repos_url": "https://api.github.com/users/edwin0cheng/repos", "events_url": "https://api.github.com/users/edwin0cheng/events{/privacy}", "received_events_url": "https://api.github.com/users/edwin0cheng/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b2ed130ffd9c79de26249a1dfb2a8312d6af12b3", "url": "https://api.github.com/repos/rust-lang/rust/commits/b2ed130ffd9c79de26249a1dfb2a8312d6af12b3", "html_url": "https://github.com/rust-lang/rust/commit/b2ed130ffd9c79de26249a1dfb2a8312d6af12b3"}], "stats": {"total": 96, "additions": 60, "deletions": 36}, "files": [{"sha": "224f4512767bf1a20914f73eb5393ca1a8bb863b", "filename": "crates/ra_parser/src/grammar/attributes.rs", "status": "modified", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/ed8d5c86e3999aeec9a62e69ef065b2c799ecfa0/crates%2Fra_parser%2Fsrc%2Fgrammar%2Fattributes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ed8d5c86e3999aeec9a62e69ef065b2c799ecfa0/crates%2Fra_parser%2Fsrc%2Fgrammar%2Fattributes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_parser%2Fsrc%2Fgrammar%2Fattributes.rs?ref=ed8d5c86e3999aeec9a62e69ef065b2c799ecfa0", "patch": "@@ -8,6 +8,28 @@ pub(super) fn inner_attributes(p: &mut Parser) {\n     }\n }\n \n+pub(super) fn with_outer_attributes(\n+    p: &mut Parser,\n+    f: impl Fn(&mut Parser) -> Option<CompletedMarker>,\n+) -> bool {\n+    let am = p.start();\n+    let has_attrs = p.at(T![#]);\n+    attributes::outer_attributes(p);    \n+    let cm = f(p);\n+    let success = cm.is_some();\n+\n+    match (has_attrs, cm) {\n+        (true, Some(cm)) => {\n+            let kind = cm.kind();\n+            cm.undo_completion(p).abandon(p);\n+            am.complete(p, kind);\n+        }\n+        _ => am.abandon(p),\n+    }\n+\n+    success\n+}\n+\n pub(super) fn outer_attributes(p: &mut Parser) {\n     while p.at(T![#]) {\n         attribute(p, false)"}, {"sha": "d733499d1b1310819d90e73c3c903dfd84682e54", "filename": "crates/ra_parser/src/grammar/expressions.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/ed8d5c86e3999aeec9a62e69ef065b2c799ecfa0/crates%2Fra_parser%2Fsrc%2Fgrammar%2Fexpressions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ed8d5c86e3999aeec9a62e69ef065b2c799ecfa0/crates%2Fra_parser%2Fsrc%2Fgrammar%2Fexpressions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_parser%2Fsrc%2Fgrammar%2Fexpressions.rs?ref=ed8d5c86e3999aeec9a62e69ef065b2c799ecfa0", "patch": "@@ -14,9 +14,9 @@ pub(super) enum StmtWithSemi {\n \n const EXPR_FIRST: TokenSet = LHS_FIRST;\n \n-pub(super) fn expr(p: &mut Parser) -> BlockLike {\n+pub(super) fn expr(p: &mut Parser) -> (Option<CompletedMarker>, BlockLike) {\n     let r = Restrictions { forbid_structs: false, prefer_stmt: false };\n-    expr_bp(p, r, 1).1\n+    expr_bp(p, r, 1)\n }\n \n pub(super) fn expr_stmt(p: &mut Parser) -> (Option<CompletedMarker>, BlockLike) {"}, {"sha": "700994e801d10b76e5ed8ead5cdfd5c23724c11d", "filename": "crates/ra_parser/src/grammar/expressions/atom.rs", "status": "modified", "additions": 8, "deletions": 6, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/ed8d5c86e3999aeec9a62e69ef065b2c799ecfa0/crates%2Fra_parser%2Fsrc%2Fgrammar%2Fexpressions%2Fatom.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ed8d5c86e3999aeec9a62e69ef065b2c799ecfa0/crates%2Fra_parser%2Fsrc%2Fgrammar%2Fexpressions%2Fatom.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_parser%2Fsrc%2Fgrammar%2Fexpressions%2Fatom.rs?ref=ed8d5c86e3999aeec9a62e69ef065b2c799ecfa0", "patch": "@@ -192,9 +192,8 @@ fn array_expr(p: &mut Parser) -> CompletedMarker {\n     //    1,\n     //    2,\n     // ];\n-    attributes::outer_attributes(p);\n+    attributes::with_outer_attributes(p, |p| expr(p).0);\n \n-    expr(p);\n     if p.eat(T![;]) {\n         expr(p);\n         p.expect(T![']']);\n@@ -212,12 +211,15 @@ fn array_expr(p: &mut Parser) -> CompletedMarker {\n         //    #[cfg(test)]\n         //    2,\n         // ];\n-        attributes::outer_attributes(p);\n-        if !p.at_ts(EXPR_FIRST) {\n-            p.error(\"expected expression\");\n+        if !attributes::with_outer_attributes(p, |p| {\n+            if !p.at_ts(EXPR_FIRST) {\n+                p.error(\"expected expression\");\n+                return None;\n+            }\n+            expr(p).0\n+        }) {\n             break;\n         }\n-        expr(p);\n     }\n     p.expect(T![']']);\n     m.complete(p, ARRAY_EXPR)"}, {"sha": "2e3a13005bda79d52916682e547fc91967e86d6e", "filename": "crates/ra_syntax/test_data/parser/inline/ok/0135_first_array_member_attributes.txt", "status": "modified", "additions": 14, "deletions": 14, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/ed8d5c86e3999aeec9a62e69ef065b2c799ecfa0/crates%2Fra_syntax%2Ftest_data%2Fparser%2Finline%2Fok%2F0135_first_array_member_attributes.txt", "raw_url": "https://github.com/rust-lang/rust/raw/ed8d5c86e3999aeec9a62e69ef065b2c799ecfa0/crates%2Fra_syntax%2Ftest_data%2Fparser%2Finline%2Fok%2F0135_first_array_member_attributes.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_syntax%2Ftest_data%2Fparser%2Finline%2Fok%2F0135_first_array_member_attributes.txt?ref=ed8d5c86e3999aeec9a62e69ef065b2c799ecfa0", "patch": "@@ -27,20 +27,20 @@ SOURCE_FILE@[0; 56)\n       ARRAY_EXPR@[23; 54)\n         L_BRACK@[23; 24) \"[\"\n         WHITESPACE@[24; 28) \"\\n   \"\n-        ATTR@[28; 40)\n-          POUND@[28; 29) \"#\"\n-          L_BRACK@[29; 30) \"[\"\n-          PATH@[30; 33)\n-            PATH_SEGMENT@[30; 33)\n-              NAME_REF@[30; 33)\n-                IDENT@[30; 33) \"cfg\"\n-          TOKEN_TREE@[33; 39)\n-            L_PAREN@[33; 34) \"(\"\n-            IDENT@[34; 38) \"test\"\n-            R_PAREN@[38; 39) \")\"\n-          R_BRACK@[39; 40) \"]\"\n-        WHITESPACE@[40; 44) \"\\n   \"\n-        LITERAL@[44; 45)\n+        LITERAL@[28; 45)\n+          ATTR@[28; 40)\n+            POUND@[28; 29) \"#\"\n+            L_BRACK@[29; 30) \"[\"\n+            PATH@[30; 33)\n+              PATH_SEGMENT@[30; 33)\n+                NAME_REF@[30; 33)\n+                  IDENT@[30; 33) \"cfg\"\n+            TOKEN_TREE@[33; 39)\n+              L_PAREN@[33; 34) \"(\"\n+              IDENT@[34; 38) \"test\"\n+              R_PAREN@[38; 39) \")\"\n+            R_BRACK@[39; 40) \"]\"\n+          WHITESPACE@[40; 44) \"\\n   \"\n           INT_NUMBER@[44; 45) \"1\"\n         COMMA@[45; 46) \",\"\n         WHITESPACE@[46; 50) \"\\n   \""}, {"sha": "1bb8a0afc75e7d8c32c287e051a7e7922edc1edf", "filename": "crates/ra_syntax/test_data/parser/inline/ok/0136_subsequent_array_member_attributes.txt", "status": "modified", "additions": 14, "deletions": 14, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/ed8d5c86e3999aeec9a62e69ef065b2c799ecfa0/crates%2Fra_syntax%2Ftest_data%2Fparser%2Finline%2Fok%2F0136_subsequent_array_member_attributes.txt", "raw_url": "https://github.com/rust-lang/rust/raw/ed8d5c86e3999aeec9a62e69ef065b2c799ecfa0/crates%2Fra_syntax%2Ftest_data%2Fparser%2Finline%2Fok%2F0136_subsequent_array_member_attributes.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_syntax%2Ftest_data%2Fparser%2Finline%2Fok%2F0136_subsequent_array_member_attributes.txt?ref=ed8d5c86e3999aeec9a62e69ef065b2c799ecfa0", "patch": "@@ -31,20 +31,20 @@ SOURCE_FILE@[0; 56)\n           INT_NUMBER@[28; 29) \"1\"\n         COMMA@[29; 30) \",\"\n         WHITESPACE@[30; 34) \"\\n   \"\n-        ATTR@[34; 46)\n-          POUND@[34; 35) \"#\"\n-          L_BRACK@[35; 36) \"[\"\n-          PATH@[36; 39)\n-            PATH_SEGMENT@[36; 39)\n-              NAME_REF@[36; 39)\n-                IDENT@[36; 39) \"cfg\"\n-          TOKEN_TREE@[39; 45)\n-            L_PAREN@[39; 40) \"(\"\n-            IDENT@[40; 44) \"test\"\n-            R_PAREN@[44; 45) \")\"\n-          R_BRACK@[45; 46) \"]\"\n-        WHITESPACE@[46; 50) \"\\n   \"\n-        LITERAL@[50; 51)\n+        LITERAL@[34; 51)\n+          ATTR@[34; 46)\n+            POUND@[34; 35) \"#\"\n+            L_BRACK@[35; 36) \"[\"\n+            PATH@[36; 39)\n+              PATH_SEGMENT@[36; 39)\n+                NAME_REF@[36; 39)\n+                  IDENT@[36; 39) \"cfg\"\n+            TOKEN_TREE@[39; 45)\n+              L_PAREN@[39; 40) \"(\"\n+              IDENT@[40; 44) \"test\"\n+              R_PAREN@[44; 45) \")\"\n+            R_BRACK@[45; 46) \"]\"\n+          WHITESPACE@[46; 50) \"\\n   \"\n           INT_NUMBER@[50; 51) \"2\"\n         COMMA@[51; 52) \",\"\n         WHITESPACE@[52; 53) \"\\n\""}]}