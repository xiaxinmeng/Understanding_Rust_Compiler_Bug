{"sha": "8d2bac8dff232f3e5ee3208c22865136a370ca72", "node_id": "MDY6Q29tbWl0NzI0NzEyOjhkMmJhYzhkZmYyMzJmM2U1ZWUzMjA4YzIyODY1MTM2YTM3MGNhNzI=", "commit": {"author": {"name": "Yuki Okushi", "email": "huyuumi.dev@gmail.com", "date": "2020-01-20T22:32:45Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-01-20T22:32:45Z"}, "message": "Rollup merge of #68302 - anp:caller-fn-ptr, r=eddyb,oli-obk\n\nFix #[track_caller] and function pointers\n\nStarting with failing tests, fix the miscompilation and ICE caused by `ReifyShim` bug.\n\nFixes #68178.", "tree": {"sha": "bfe5d992d0675376071b1ae4673e4b540aaa97cf", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bfe5d992d0675376071b1ae4673e4b540aaa97cf"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8d2bac8dff232f3e5ee3208c22865136a370ca72", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJeJiqOCRBK7hj4Ov3rIwAAdHIIAJB7ev77JjICdbSOy2rh4uMW\nJKSVpymdn4VvQcWIfSk5Ja5hReW7LsefGTpaZnNLdUzS9H4wZg6SZ9X7rPLim0+z\nqVmv9/LViiy8EW2O0AsTWXs/iyjtkQyABg7vWDO6Wj+WDHdNCTr6t+G06MgatWUz\nob1EyG0RiuqgyWuHWCbNiGp5knB8qbN6S+dZ+R5JOel3i4Q33cKbSvBpF9p/uZsq\nCitSv+rOtZsGQy3yy4XRap5wAP4Dpl02bBpmP+jmgbFPOng2XJldiKO2ytpV13xO\n6+zCMHgnJIjSOW1LitGL6JjpN74pbI2qDOmMMNf6SX/UguS31JoTvKURC9z6f84=\n=+0j1\n-----END PGP SIGNATURE-----\n", "payload": "tree bfe5d992d0675376071b1ae4673e4b540aaa97cf\nparent bff216c56f472dd751d3da636027d5e2d821e979\nparent 72dffac6cf170c6c16c043299e35848014aae8d4\nauthor Yuki Okushi <huyuumi.dev@gmail.com> 1579559565 +0900\ncommitter GitHub <noreply@github.com> 1579559565 +0900\n\nRollup merge of #68302 - anp:caller-fn-ptr, r=eddyb,oli-obk\n\nFix #[track_caller] and function pointers\n\nStarting with failing tests, fix the miscompilation and ICE caused by `ReifyShim` bug.\n\nFixes #68178.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8d2bac8dff232f3e5ee3208c22865136a370ca72", "html_url": "https://github.com/rust-lang/rust/commit/8d2bac8dff232f3e5ee3208c22865136a370ca72", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8d2bac8dff232f3e5ee3208c22865136a370ca72/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "bff216c56f472dd751d3da636027d5e2d821e979", "url": "https://api.github.com/repos/rust-lang/rust/commits/bff216c56f472dd751d3da636027d5e2d821e979", "html_url": "https://github.com/rust-lang/rust/commit/bff216c56f472dd751d3da636027d5e2d821e979"}, {"sha": "72dffac6cf170c6c16c043299e35848014aae8d4", "url": "https://api.github.com/repos/rust-lang/rust/commits/72dffac6cf170c6c16c043299e35848014aae8d4", "html_url": "https://github.com/rust-lang/rust/commit/72dffac6cf170c6c16c043299e35848014aae8d4"}], "stats": {"total": 125, "additions": 97, "deletions": 28}, "files": [{"sha": "1ea695e40b25556bfb95601e718266cb9395ca30", "filename": "src/librustc/ty/instance.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/8d2bac8dff232f3e5ee3208c22865136a370ca72/src%2Flibrustc%2Fty%2Finstance.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8d2bac8dff232f3e5ee3208c22865136a370ca72/src%2Flibrustc%2Fty%2Finstance.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Finstance.rs?ref=8d2bac8dff232f3e5ee3208c22865136a370ca72", "patch": "@@ -141,7 +141,12 @@ impl<'tcx> InstanceDef<'tcx> {\n     }\n \n     pub fn requires_caller_location(&self, tcx: TyCtxt<'_>) -> bool {\n-        tcx.codegen_fn_attrs(self.def_id()).flags.contains(CodegenFnAttrFlags::TRACK_CALLER)\n+        match *self {\n+            InstanceDef::Item(def_id) => {\n+                tcx.codegen_fn_attrs(def_id).flags.contains(CodegenFnAttrFlags::TRACK_CALLER)\n+            }\n+            _ => false,\n+        }\n     }\n }\n "}, {"sha": "b84616142cb07d843c060e1a405b985545c0a8a9", "filename": "src/librustc_mir/shim.rs", "status": "modified", "additions": 53, "deletions": 27, "changes": 80, "blob_url": "https://github.com/rust-lang/rust/blob/8d2bac8dff232f3e5ee3208c22865136a370ca72/src%2Flibrustc_mir%2Fshim.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8d2bac8dff232f3e5ee3208c22865136a370ca72/src%2Flibrustc_mir%2Fshim.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fshim.rs?ref=8d2bac8dff232f3e5ee3208c22865136a370ca72", "patch": "@@ -31,9 +31,13 @@ fn make_shim<'tcx>(tcx: TyCtxt<'tcx>, instance: ty::InstanceDef<'tcx>) -> &'tcx\n \n     let mut result = match instance {\n         ty::InstanceDef::Item(..) => bug!(\"item {:?} passed to make_shim\", instance),\n-        ty::InstanceDef::VtableShim(def_id) => {\n-            build_call_shim(tcx, instance, Adjustment::DerefMove, CallKind::Direct(def_id), None)\n-        }\n+        ty::InstanceDef::VtableShim(def_id) => build_call_shim(\n+            tcx,\n+            instance,\n+            Some(Adjustment::DerefMove),\n+            CallKind::Direct(def_id),\n+            None,\n+        ),\n         ty::InstanceDef::FnPtrShim(def_id, ty) => {\n             let trait_ = tcx.trait_of_item(def_id).unwrap();\n             let adjustment = match tcx.lang_items().fn_trait_kind(trait_) {\n@@ -50,15 +54,15 @@ fn make_shim<'tcx>(tcx: TyCtxt<'tcx>, instance: ty::InstanceDef<'tcx>) -> &'tcx\n             let sig = tcx.erase_late_bound_regions(&ty.fn_sig(tcx));\n             let arg_tys = sig.inputs();\n \n-            build_call_shim(tcx, instance, adjustment, CallKind::Indirect, Some(arg_tys))\n+            build_call_shim(tcx, instance, Some(adjustment), CallKind::Indirect, Some(arg_tys))\n         }\n         // We are generating a call back to our def-id, which the\n         // codegen backend knows to turn to an actual call, be it\n         // a virtual call, or a direct call to a function for which\n         // indirect calls must be codegen'd differently than direct ones\n         // (such as `#[track_caller]`).\n         ty::InstanceDef::ReifyShim(def_id) => {\n-            build_call_shim(tcx, instance, Adjustment::Identity, CallKind::Direct(def_id), None)\n+            build_call_shim(tcx, instance, None, CallKind::Direct(def_id), None)\n         }\n         ty::InstanceDef::ClosureOnceShim { call_once: _ } => {\n             let fn_mut = tcx.lang_items().fn_mut_trait().unwrap();\n@@ -68,7 +72,13 @@ fn make_shim<'tcx>(tcx: TyCtxt<'tcx>, instance: ty::InstanceDef<'tcx>) -> &'tcx\n                 .unwrap()\n                 .def_id;\n \n-            build_call_shim(tcx, instance, Adjustment::RefMut, CallKind::Direct(call_mut), None)\n+            build_call_shim(\n+                tcx,\n+                instance,\n+                Some(Adjustment::RefMut),\n+                CallKind::Direct(call_mut),\n+                None,\n+            )\n         }\n         ty::InstanceDef::DropGlue(def_id, ty) => build_drop_shim(tcx, def_id, ty),\n         ty::InstanceDef::CloneShim(def_id, ty) => {\n@@ -648,7 +658,7 @@ impl CloneShimBuilder<'tcx> {\n fn build_call_shim<'tcx>(\n     tcx: TyCtxt<'tcx>,\n     instance: ty::InstanceDef<'tcx>,\n-    rcvr_adjustment: Adjustment,\n+    rcvr_adjustment: Option<Adjustment>,\n     call_kind: CallKind,\n     untuple_args: Option<&[Ty<'tcx>]>,\n ) -> BodyAndCache<'tcx> {\n@@ -680,14 +690,16 @@ fn build_call_shim<'tcx>(\n     let mut local_decls = local_decls_for_sig(&sig, span);\n     let source_info = SourceInfo { span, scope: OUTERMOST_SOURCE_SCOPE };\n \n-    let rcvr_arg = Local::new(1 + 0);\n-    let rcvr_l = Place::from(rcvr_arg);\n+    let rcvr_place = || {\n+        assert!(rcvr_adjustment.is_some());\n+        Place::from(Local::new(1 + 0))\n+    };\n     let mut statements = vec![];\n \n-    let rcvr = match rcvr_adjustment {\n-        Adjustment::Identity => Operand::Move(rcvr_l),\n-        Adjustment::Deref => Operand::Copy(tcx.mk_place_deref(rcvr_l)),\n-        Adjustment::DerefMove => Operand::Move(tcx.mk_place_deref(rcvr_l)),\n+    let rcvr = rcvr_adjustment.map(|rcvr_adjustment| match rcvr_adjustment {\n+        Adjustment::Identity => Operand::Move(rcvr_place()),\n+        Adjustment::Deref => Operand::Copy(tcx.mk_place_deref(rcvr_place())),\n+        Adjustment::DerefMove => Operand::Move(tcx.mk_place_deref(rcvr_place())),\n         Adjustment::RefMut => {\n             // let rcvr = &mut rcvr;\n             let ref_rcvr = local_decls.push(temp_decl(\n@@ -703,15 +715,15 @@ fn build_call_shim<'tcx>(\n                 source_info,\n                 kind: StatementKind::Assign(box (\n                     Place::from(ref_rcvr),\n-                    Rvalue::Ref(tcx.lifetimes.re_erased, borrow_kind, rcvr_l),\n+                    Rvalue::Ref(tcx.lifetimes.re_erased, borrow_kind, rcvr_place()),\n                 )),\n             });\n             Operand::Move(Place::from(ref_rcvr))\n         }\n-    };\n+    });\n \n     let (callee, mut args) = match call_kind {\n-        CallKind::Indirect => (rcvr, vec![]),\n+        CallKind::Indirect => (rcvr.unwrap(), vec![]),\n         CallKind::Direct(def_id) => {\n             let ty = tcx.type_of(def_id);\n             (\n@@ -720,21 +732,35 @@ fn build_call_shim<'tcx>(\n                     user_ty: None,\n                     literal: ty::Const::zero_sized(tcx, ty),\n                 }),\n-                vec![rcvr],\n+                rcvr.into_iter().collect::<Vec<_>>(),\n             )\n         }\n     };\n \n+    let mut arg_range = 0..sig.inputs().len();\n+\n+    // Take the `self` (\"receiver\") argument out of the range (it's adjusted above).\n+    if rcvr_adjustment.is_some() {\n+        arg_range.start += 1;\n+    }\n+\n+    // Take the last argument, if we need to untuple it (handled below).\n+    if untuple_args.is_some() {\n+        arg_range.end -= 1;\n+    }\n+\n+    // Pass all of the non-special arguments directly.\n+    args.extend(arg_range.map(|i| Operand::Move(Place::from(Local::new(1 + i)))));\n+\n+    // Untuple the last argument, if we have to.\n     if let Some(untuple_args) = untuple_args {\n+        let tuple_arg = Local::new(1 + (sig.inputs().len() - 1));\n         args.extend(untuple_args.iter().enumerate().map(|(i, ity)| {\n-            let arg_place = Place::from(Local::new(1 + 1));\n-            Operand::Move(tcx.mk_place_field(arg_place, Field::new(i), *ity))\n+            Operand::Move(tcx.mk_place_field(Place::from(tuple_arg), Field::new(i), *ity))\n         }));\n-    } else {\n-        args.extend((1..sig.inputs().len()).map(|i| Operand::Move(Place::from(Local::new(1 + i)))));\n     }\n \n-    let n_blocks = if let Adjustment::RefMut = rcvr_adjustment { 5 } else { 2 };\n+    let n_blocks = if let Some(Adjustment::RefMut) = rcvr_adjustment { 5 } else { 2 };\n     let mut blocks = IndexVec::with_capacity(n_blocks);\n     let block = |blocks: &mut IndexVec<_, _>, statements, kind, is_cleanup| {\n         blocks.push(BasicBlockData {\n@@ -752,7 +778,7 @@ fn build_call_shim<'tcx>(\n             func: callee,\n             args,\n             destination: Some((Place::return_place(), BasicBlock::new(1))),\n-            cleanup: if let Adjustment::RefMut = rcvr_adjustment {\n+            cleanup: if let Some(Adjustment::RefMut) = rcvr_adjustment {\n                 Some(BasicBlock::new(3))\n             } else {\n                 None\n@@ -762,13 +788,13 @@ fn build_call_shim<'tcx>(\n         false,\n     );\n \n-    if let Adjustment::RefMut = rcvr_adjustment {\n+    if let Some(Adjustment::RefMut) = rcvr_adjustment {\n         // BB #1 - drop for Self\n         block(\n             &mut blocks,\n             vec![],\n             TerminatorKind::Drop {\n-                location: Place::from(rcvr_arg),\n+                location: rcvr_place(),\n                 target: BasicBlock::new(2),\n                 unwind: None,\n             },\n@@ -777,13 +803,13 @@ fn build_call_shim<'tcx>(\n     }\n     // BB #1/#2 - return\n     block(&mut blocks, vec![], TerminatorKind::Return, false);\n-    if let Adjustment::RefMut = rcvr_adjustment {\n+    if let Some(Adjustment::RefMut) = rcvr_adjustment {\n         // BB #3 - drop if closure panics\n         block(\n             &mut blocks,\n             vec![],\n             TerminatorKind::Drop {\n-                location: Place::from(rcvr_arg),\n+                location: rcvr_place(),\n                 target: BasicBlock::new(4),\n                 unwind: None,\n             },"}, {"sha": "0407eafbfd41c5f430f207a0ca28b5b4b3902067", "filename": "src/test/ui/rfc-2091-track-caller/tracked-fn-ptr-with-arg.rs", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/8d2bac8dff232f3e5ee3208c22865136a370ca72/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ftracked-fn-ptr-with-arg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8d2bac8dff232f3e5ee3208c22865136a370ca72/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ftracked-fn-ptr-with-arg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ftracked-fn-ptr-with-arg.rs?ref=8d2bac8dff232f3e5ee3208c22865136a370ca72", "patch": "@@ -0,0 +1,19 @@\n+// run-pass\n+\n+#![feature(track_caller)]\n+\n+fn pass_to_ptr_call<T>(f: fn(T), x: T) {\n+    f(x);\n+}\n+\n+#[track_caller]\n+fn tracked_unit(_: ()) {\n+    let expected_line = line!() - 1;\n+    let location = std::panic::Location::caller();\n+    assert_eq!(location.file(), file!());\n+    assert_eq!(location.line(), expected_line, \"call shims report location as fn definition\");\n+}\n+\n+fn main() {\n+    pass_to_ptr_call(tracked_unit, ());\n+}"}, {"sha": "a4baaa26ced1eed7ae3d5f477ec23772408c2027", "filename": "src/test/ui/rfc-2091-track-caller/tracked-fn-ptr.rs", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/8d2bac8dff232f3e5ee3208c22865136a370ca72/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ftracked-fn-ptr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8d2bac8dff232f3e5ee3208c22865136a370ca72/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ftracked-fn-ptr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ftracked-fn-ptr.rs?ref=8d2bac8dff232f3e5ee3208c22865136a370ca72", "patch": "@@ -0,0 +1,19 @@\n+// run-pass\n+\n+#![feature(track_caller)]\n+\n+fn ptr_call(f: fn()) {\n+    f();\n+}\n+\n+#[track_caller]\n+fn tracked() {\n+    let expected_line = line!() - 1;\n+    let location = std::panic::Location::caller();\n+    assert_eq!(location.file(), file!());\n+    assert_eq!(location.line(), expected_line, \"call shims report location as fn definition\");\n+}\n+\n+fn main() {\n+    ptr_call(tracked);\n+}"}]}