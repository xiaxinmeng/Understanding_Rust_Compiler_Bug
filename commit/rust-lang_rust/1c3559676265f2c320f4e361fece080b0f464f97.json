{"sha": "1c3559676265f2c320f4e361fece080b0f464f97", "node_id": "C_kwDOAAsO6NoAKDFjMzU1OTY3NjI2NWYyYzMyMGY0ZTM2MWZlY2UwODBiMGY0NjRmOTc", "commit": {"author": {"name": "Dylan DPC", "email": "99973273+Dylan-DPC@users.noreply.github.com", "date": "2022-09-08T06:25:08Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-09-08T06:25:08Z"}, "message": "Rollup merge of #101455 - thomcc:why-is-this-here, r=jyn514\n\nAvoid UB in the Windows filesystem code in... bootstrap?\n\nThis basically a subset of the changes from https://github.com/rust-lang/rust/pull/101171. I didn't think to look in src/bootstrap for more windows filesystem API usage, which was apparently a mistake on my part. It's kinda goofy that stuff like this is in here, but what are you gonna do, computers are awful.\n\nI also added `winbase` to the `winapi` dep -- I tested this in a tmp crate but needed to add this to your Cargo.toml -- you `use winapi::stuff::winbase` in this function, but are relying on something else turning on that feature.", "tree": {"sha": "9f846ae38d36dc15cd9e08763045a3736b26ac72", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9f846ae38d36dc15cd9e08763045a3736b26ac72"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1c3559676265f2c320f4e361fece080b0f464f97", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjGYrECRBK7hj4Ov3rIwAAz14IAFwtXbKBGDhOZamSLzWNJh0/\nH6whCHC/YdbBXU8qsS0f/dDjT/L2FpgOTv/2JYaDYCITiHGbQo2bcIBM7rDoFf+q\ncezqKZUtGAeVnatvle3RyB0Xdqtyjmu0cTIb9ak7v0VCL+9jNX0fAk1kVMAi93O3\nIfCH+GoZ2v//eoW5vhPpC8ZNcMcqPourTX9JO41yQHy8zRyxSKOkfLZBnGHA21mL\n4z3f35cMC52YsN4sqIBS8oiMRZhIdM1JCFzF+ZfAekDAGKE1jF7zFuojzd38Ecoa\nNrOR6b1HD7cQFYmtrt73OKQOMovCr+wAZ1MZgoi2ptqOerE56li8+ZLssgqY/Ps=\n=r6Ck\n-----END PGP SIGNATURE-----\n", "payload": "tree 9f846ae38d36dc15cd9e08763045a3736b26ac72\nparent 7064344ba4641ab463e51ba28a1d1bbf3ae8fc76\nparent 850090d99c81dde7615e2a7e2111c09650868a48\nauthor Dylan DPC <99973273+Dylan-DPC@users.noreply.github.com> 1662618308 +0530\ncommitter GitHub <noreply@github.com> 1662618308 +0530\n\nRollup merge of #101455 - thomcc:why-is-this-here, r=jyn514\n\nAvoid UB in the Windows filesystem code in... bootstrap?\n\nThis basically a subset of the changes from https://github.com/rust-lang/rust/pull/101171. I didn't think to look in src/bootstrap for more windows filesystem API usage, which was apparently a mistake on my part. It's kinda goofy that stuff like this is in here, but what are you gonna do, computers are awful.\n\nI also added `winbase` to the `winapi` dep -- I tested this in a tmp crate but needed to add this to your Cargo.toml -- you `use winapi::stuff::winbase` in this function, but are relying on something else turning on that feature.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1c3559676265f2c320f4e361fece080b0f464f97", "html_url": "https://github.com/rust-lang/rust/commit/1c3559676265f2c320f4e361fece080b0f464f97", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1c3559676265f2c320f4e361fece080b0f464f97/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7064344ba4641ab463e51ba28a1d1bbf3ae8fc76", "url": "https://api.github.com/repos/rust-lang/rust/commits/7064344ba4641ab463e51ba28a1d1bbf3ae8fc76", "html_url": "https://github.com/rust-lang/rust/commit/7064344ba4641ab463e51ba28a1d1bbf3ae8fc76"}, {"sha": "850090d99c81dde7615e2a7e2111c09650868a48", "url": "https://api.github.com/repos/rust-lang/rust/commits/850090d99c81dde7615e2a7e2111c09650868a48", "html_url": "https://github.com/rust-lang/rust/commit/850090d99c81dde7615e2a7e2111c09650868a48"}], "stats": {"total": 11, "additions": 7, "deletions": 4}, "files": [{"sha": "95e711737738a4e661fe1f86c0b7edfb09e3241c", "filename": "src/bootstrap/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/1c3559676265f2c320f4e361fece080b0f464f97/src%2Fbootstrap%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/1c3559676265f2c320f4e361fece080b0f464f97/src%2Fbootstrap%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2FCargo.toml?ref=1c3559676265f2c320f4e361fece080b0f464f97", "patch": "@@ -67,6 +67,7 @@ features = [\n     \"psapi\",\n     \"impl-default\",\n     \"timezoneapi\",\n+    \"winbase\",\n ]\n \n [dev-dependencies]"}, {"sha": "0ebabbd5ca5c04599f065a52f7654a93e6232fcc", "filename": "src/bootstrap/util.rs", "status": "modified", "additions": 6, "deletions": 4, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/1c3559676265f2c320f4e361fece080b0f464f97/src%2Fbootstrap%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1c3559676265f2c320f4e361fece080b0f464f97/src%2Fbootstrap%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Futil.rs?ref=1c3559676265f2c320f4e361fece080b0f464f97", "patch": "@@ -197,9 +197,11 @@ pub fn symlink_dir(config: &Config, src: &Path, dest: &Path) -> io::Result<()> {\n                 ptr::null_mut(),\n             );\n \n-            let mut data = [0u8; MAXIMUM_REPARSE_DATA_BUFFER_SIZE as usize];\n-            let db = data.as_mut_ptr() as *mut REPARSE_MOUNTPOINT_DATA_BUFFER;\n-            let buf = &mut (*db).ReparseTarget as *mut u16;\n+            #[repr(C, align(8))]\n+            struct Align8<T>(T);\n+            let mut data = Align8([0u8; MAXIMUM_REPARSE_DATA_BUFFER_SIZE as usize]);\n+            let db = data.0.as_mut_ptr() as *mut REPARSE_MOUNTPOINT_DATA_BUFFER;\n+            let buf = core::ptr::addr_of_mut!((*db).ReparseTarget) as *mut u16;\n             let mut i = 0;\n             // FIXME: this conversion is very hacky\n             let v = br\"\\??\\\";\n@@ -219,7 +221,7 @@ pub fn symlink_dir(config: &Config, src: &Path, dest: &Path) -> io::Result<()> {\n             let res = DeviceIoControl(\n                 h as *mut _,\n                 FSCTL_SET_REPARSE_POINT,\n-                data.as_ptr() as *mut _,\n+                db.cast(),\n                 (*db).ReparseDataLength + 8,\n                 ptr::null_mut(),\n                 0,"}]}