{"sha": "1217d70465edb2079880347fea4baaac56895f51", "node_id": "MDY6Q29tbWl0NzI0NzEyOjEyMTdkNzA0NjVlZGIyMDc5ODgwMzQ3ZmVhNGJhYWFjNTY4OTVmNTE=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2018-04-05T15:02:11Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2018-04-16T20:58:42Z"}, "message": "Separately gate each target_feature feature\n\nUse an explicit whitelist for what features are actually stable and can be\nenabled.", "tree": {"sha": "721aae979f95b233358796a8dfae2c02d8e0b198", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/721aae979f95b233358796a8dfae2c02d8e0b198"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1217d70465edb2079880347fea4baaac56895f51", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1217d70465edb2079880347fea4baaac56895f51", "html_url": "https://github.com/rust-lang/rust/commit/1217d70465edb2079880347fea4baaac56895f51", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1217d70465edb2079880347fea4baaac56895f51/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "598d836fff59787892de1d736e521b10d9117531", "url": "https://api.github.com/repos/rust-lang/rust/commits/598d836fff59787892de1d736e521b10d9117531", "html_url": "https://github.com/rust-lang/rust/commit/598d836fff59787892de1d736e521b10d9117531"}], "stats": {"total": 292, "additions": 220, "deletions": 72}, "files": [{"sha": "55f586389b11766c587af558c66a716cdced1fb9", "filename": ".gitmodules", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1217d70465edb2079880347fea4baaac56895f51/.gitmodules", "raw_url": "https://github.com/rust-lang/rust/raw/1217d70465edb2079880347fea4baaac56895f51/.gitmodules", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.gitmodules?ref=1217d70465edb2079880347fea4baaac56895f51", "patch": "@@ -49,7 +49,7 @@\n \turl = https://github.com/rust-lang/llvm\n [submodule \"src/stdsimd\"]\n \tpath = src/stdsimd\n-\turl = https://github.com/alexcrichton/stdsimd\n+\turl = https://github.com/rust-lang-nursery/stdsimd\n [submodule \"src/tools/lld\"]\n \tpath = src/tools/lld\n \turl = https://github.com/rust-lang/lld.git"}, {"sha": "ea7a46f44ae0f31cb16fa752bcd80debde88afb1", "filename": "src/libcore/lib.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/1217d70465edb2079880347fea4baaac56895f51/src%2Flibcore%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1217d70465edb2079880347fea4baaac56895f51/src%2Flibcore%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Flib.rs?ref=1217d70465edb2079880347fea4baaac56895f51", "patch": "@@ -99,6 +99,14 @@\n #![feature(untagged_unions)]\n #![feature(unwind_attributes)]\n \n+#![cfg_attr(not(stage0), feature(mmx_target_feature))]\n+#![cfg_attr(not(stage0), feature(tbm_target_feature))]\n+#![cfg_attr(not(stage0), feature(sse4a_target_feature))]\n+#![cfg_attr(not(stage0), feature(arm_target_feature))]\n+#![cfg_attr(not(stage0), feature(powerpc_target_feature))]\n+#![cfg_attr(not(stage0), feature(mips_target_feature))]\n+#![cfg_attr(not(stage0), feature(aarch64_target_feature))]\n+\n #![cfg_attr(stage0, feature(target_feature))]\n #![cfg_attr(stage0, feature(cfg_target_feature))]\n "}, {"sha": "2325b1893d996f85a6df0ff90e6662c23f898a14", "filename": "src/librustc/ty/maps/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1217d70465edb2079880347fea4baaac56895f51/src%2Flibrustc%2Fty%2Fmaps%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1217d70465edb2079880347fea4baaac56895f51/src%2Flibrustc%2Fty%2Fmaps%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fmaps%2Fmod.rs?ref=1217d70465edb2079880347fea4baaac56895f51", "patch": "@@ -437,7 +437,7 @@ define_maps! { <'tcx>\n         substitute_normalize_and_test_predicates_node((DefId, &'tcx Substs<'tcx>)) -> bool,\n \n     [] fn target_features_whitelist:\n-        target_features_whitelist_node(CrateNum) -> Lrc<FxHashSet<String>>,\n+        target_features_whitelist_node(CrateNum) -> Lrc<FxHashMap<String, Option<String>>>,\n \n     // Get an estimate of the size of an InstanceDef based on its MIR for CGU partitioning.\n     [] fn instance_def_size_estimate: instance_def_size_estimate_dep_node(ty::InstanceDef<'tcx>)"}, {"sha": "eb5c7396ae055606df48efe378bafe04fc417ba7", "filename": "src/librustc_trans/attributes.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/1217d70465edb2079880347fea4baaac56895f51/src%2Flibrustc_trans%2Fattributes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1217d70465edb2079880347fea4baaac56895f51/src%2Flibrustc_trans%2Fattributes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Fattributes.rs?ref=1217d70465edb2079880347fea4baaac56895f51", "patch": "@@ -174,12 +174,12 @@ pub fn provide(providers: &mut Providers) {\n             // rustdoc needs to be able to document functions that use all the features, so\n             // whitelist them all\n             Lrc::new(llvm_util::all_known_features()\n-                .map(|c| c.to_string())\n+                .map(|(a, b)| (a.to_string(), b.map(|s| s.to_string())))\n                 .collect())\n         } else {\n             Lrc::new(llvm_util::target_feature_whitelist(tcx.sess)\n                 .iter()\n-                .map(|c| c.to_string())\n+                .map(|&(a, b)| (a.to_string(), b.map(|s| s.to_string())))\n                 .collect())\n         }\n     };"}, {"sha": "bbd1c39a19e0eb95d534cd4cda6e0cebc9d0f7ec", "filename": "src/librustc_trans/llvm_util.rs", "status": "modified", "additions": 94, "deletions": 29, "changes": 123, "blob_url": "https://github.com/rust-lang/rust/blob/1217d70465edb2079880347fea4baaac56895f51/src%2Flibrustc_trans%2Fllvm_util.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1217d70465edb2079880347fea4baaac56895f51/src%2Flibrustc_trans%2Fllvm_util.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Fllvm_util.rs?ref=1217d70465edb2079880347fea4baaac56895f51", "patch": "@@ -15,6 +15,7 @@ use rustc::session::Session;\n use rustc::session::config::PrintRequest;\n use libc::c_int;\n use std::ffi::CString;\n+use syntax::feature_gate::UnstableFeatures;\n \n use std::sync::atomic::{AtomicBool, Ordering};\n use std::sync::Once;\n@@ -82,40 +83,95 @@ unsafe fn configure_llvm(sess: &Session) {\n // to LLVM or the feature detection code will walk past the end of the feature\n // array, leading to crashes.\n \n-const ARM_WHITELIST: &'static [&'static str] = &[\"neon\", \"v7\", \"vfp2\", \"vfp3\", \"vfp4\"];\n-\n-const AARCH64_WHITELIST: &'static [&'static str] = &[\"fp\", \"neon\", \"sve\", \"crc\", \"crypto\",\n-                                                     \"ras\", \"lse\", \"rdm\", \"fp16\", \"rcpc\",\n-                                                     \"dotprod\", \"v8.1a\", \"v8.2a\", \"v8.3a\"];\n-\n-const X86_WHITELIST: &'static [&'static str] = &[\"aes\", \"avx\", \"avx2\", \"avx512bw\",\n-                                                 \"avx512cd\", \"avx512dq\", \"avx512er\",\n-                                                 \"avx512f\", \"avx512ifma\", \"avx512pf\",\n-                                                 \"avx512vbmi\", \"avx512vl\", \"avx512vpopcntdq\",\n-                                                 \"bmi1\", \"bmi2\", \"fma\", \"fxsr\",\n-                                                 \"lzcnt\", \"mmx\", \"pclmulqdq\",\n-                                                 \"popcnt\", \"rdrand\", \"rdseed\",\n-                                                 \"sha\",\n-                                                 \"sse\", \"sse2\", \"sse3\", \"sse4.1\",\n-                                                 \"sse4.2\", \"sse4a\", \"ssse3\",\n-                                                 \"tbm\", \"xsave\", \"xsavec\",\n-                                                 \"xsaveopt\", \"xsaves\"];\n-\n-const HEXAGON_WHITELIST: &'static [&'static str] = &[\"hvx\", \"hvx-double\"];\n-\n-const POWERPC_WHITELIST: &'static [&'static str] = &[\"altivec\",\n-                                                     \"power8-altivec\", \"power9-altivec\",\n-                                                     \"power8-vector\", \"power9-vector\",\n-                                                     \"vsx\"];\n-\n-const MIPS_WHITELIST: &'static [&'static str] = &[\"fp64\", \"msa\"];\n+const ARM_WHITELIST: &[(&str, Option<&str>)] = &[\n+    (\"neon\", Some(\"arm_target_feature\")),\n+    (\"v7\", Some(\"arm_target_feature\")),\n+    (\"vfp2\", Some(\"arm_target_feature\")),\n+    (\"vfp3\", Some(\"arm_target_feature\")),\n+    (\"vfp4\", Some(\"arm_target_feature\")),\n+];\n+\n+const AARCH64_WHITELIST: &[(&str, Option<&str>)] = &[\n+    (\"fp\", Some(\"aarch64_target_feature\")),\n+    (\"neon\", Some(\"aarch64_target_feature\")),\n+    (\"sve\", Some(\"aarch64_target_feature\")),\n+    (\"crc\", Some(\"aarch64_target_feature\")),\n+    (\"crypto\", Some(\"aarch64_target_feature\")),\n+    (\"ras\", Some(\"aarch64_target_feature\")),\n+    (\"lse\", Some(\"aarch64_target_feature\")),\n+    (\"rdm\", Some(\"aarch64_target_feature\")),\n+    (\"fp16\", Some(\"aarch64_target_feature\")),\n+    (\"rcpc\", Some(\"aarch64_target_feature\")),\n+    (\"dotprod\", Some(\"aarch64_target_feature\")),\n+    (\"v8.1a\", Some(\"aarch64_target_feature\")),\n+    (\"v8.2a\", Some(\"aarch64_target_feature\")),\n+    (\"v8.3a\", Some(\"aarch64_target_feature\")),\n+];\n+\n+const X86_WHITELIST: &[(&str, Option<&str>)] = &[\n+    (\"aes\", None),\n+    (\"avx\", None),\n+    (\"avx2\", None),\n+    (\"avx512bw\", Some(\"avx512_target_feature\")),\n+    (\"avx512cd\", Some(\"avx512_target_feature\")),\n+    (\"avx512dq\", Some(\"avx512_target_feature\")),\n+    (\"avx512er\", Some(\"avx512_target_feature\")),\n+    (\"avx512f\", Some(\"avx512_target_feature\")),\n+    (\"avx512ifma\", Some(\"avx512_target_feature\")),\n+    (\"avx512pf\", Some(\"avx512_target_feature\")),\n+    (\"avx512vbmi\", Some(\"avx512_target_feature\")),\n+    (\"avx512vl\", Some(\"avx512_target_feature\")),\n+    (\"avx512vpopcntdq\", Some(\"avx512_target_feature\")),\n+    (\"bmi1\", None),\n+    (\"bmi2\", None),\n+    (\"fma\", None),\n+    (\"fxsr\", None),\n+    (\"lzcnt\", None),\n+    (\"mmx\", Some(\"mmx_target_feature\")),\n+    (\"pclmulqdq\", None),\n+    (\"popcnt\", None),\n+    (\"rdrand\", None),\n+    (\"rdseed\", None),\n+    (\"sha\", None),\n+    (\"sse\", None),\n+    (\"sse2\", None),\n+    (\"sse3\", None),\n+    (\"sse4.1\", None),\n+    (\"sse4.2\", None),\n+    (\"sse4a\", Some(\"sse4a_target_feature\")),\n+    (\"ssse3\", None),\n+    (\"tbm\", Some(\"tbm_target_feature\")),\n+    (\"xsave\", None),\n+    (\"xsavec\", None),\n+    (\"xsaveopt\", None),\n+    (\"xsaves\", None),\n+];\n+\n+const HEXAGON_WHITELIST: &[(&str, Option<&str>)] = &[\n+    (\"hvx\", Some(\"hexagon_target_feature\")),\n+    (\"hvx-double\", Some(\"hexagon_target_feature\")),\n+];\n+\n+const POWERPC_WHITELIST: &[(&str, Option<&str>)] = &[\n+    (\"altivec\", Some(\"powerpc_target_feature\")),\n+    (\"power8-altivec\", Some(\"powerpc_target_feature\")),\n+    (\"power9-altivec\", Some(\"powerpc_target_feature\")),\n+    (\"power8-vector\", Some(\"powerpc_target_feature\")),\n+    (\"power9-vector\", Some(\"powerpc_target_feature\")),\n+    (\"vsx\", Some(\"powerpc_target_feature\")),\n+];\n+\n+const MIPS_WHITELIST: &[(&str, Option<&str>)] = &[\n+    (\"fp64\", Some(\"mips_target_feature\")),\n+    (\"msa\", Some(\"mips_target_feature\")),\n+];\n \n /// When rustdoc is running, provide a list of all known features so that all their respective\n /// primtives may be documented.\n ///\n /// IMPORTANT: If you're adding another whitelist to the above lists, make sure to add it to this\n /// iterator!\n-pub fn all_known_features() -> impl Iterator<Item=&'static str> {\n+pub fn all_known_features() -> impl Iterator<Item=(&'static str, Option<&'static str>)> {\n     ARM_WHITELIST.iter().cloned()\n         .chain(AARCH64_WHITELIST.iter().cloned())\n         .chain(X86_WHITELIST.iter().cloned())\n@@ -144,6 +200,13 @@ pub fn target_features(sess: &Session) -> Vec<Symbol> {\n     let target_machine = create_target_machine(sess, true);\n     target_feature_whitelist(sess)\n         .iter()\n+        .filter_map(|&(feature, gate)| {\n+            if UnstableFeatures::from_environment().is_nightly_build() || gate.is_none() {\n+                Some(feature)\n+            } else {\n+                None\n+            }\n+        })\n         .filter(|feature| {\n             let llvm_feature = to_llvm_feature(sess, feature);\n             let cstr = CString::new(llvm_feature).unwrap();\n@@ -152,7 +215,9 @@ pub fn target_features(sess: &Session) -> Vec<Symbol> {\n         .map(|feature| Symbol::intern(feature)).collect()\n }\n \n-pub fn target_feature_whitelist(sess: &Session) -> &'static [&'static str] {\n+pub fn target_feature_whitelist(sess: &Session)\n+    -> &'static [(&'static str, Option<&'static str>)]\n+{\n     match &*sess.target.target.arch {\n         \"arm\" => ARM_WHITELIST,\n         \"aarch64\" => AARCH64_WHITELIST,"}, {"sha": "b7895631c6092dc75cfa2d9ce18cd9c4d0342e42", "filename": "src/librustc_trans_utils/trans_crate.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/1217d70465edb2079880347fea4baaac56895f51/src%2Flibrustc_trans_utils%2Ftrans_crate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1217d70465edb2079880347fea4baaac56895f51/src%2Flibrustc_trans_utils%2Ftrans_crate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans_utils%2Ftrans_crate.rs?ref=1217d70465edb2079880347fea4baaac56895f51", "patch": "@@ -44,7 +44,7 @@ use rustc::middle::cstore::EncodedMetadata;\n use rustc::middle::cstore::MetadataLoader;\n use rustc::dep_graph::DepGraph;\n use rustc_back::target::Target;\n-use rustc_data_structures::fx::FxHashSet;\n+use rustc_data_structures::fx::FxHashMap;\n use rustc_mir::monomorphize::collector;\n use link::{build_link_meta, out_filename};\n \n@@ -203,7 +203,7 @@ impl TransCrate for MetadataOnlyTransCrate {\n         ::symbol_names::provide(providers);\n \n         providers.target_features_whitelist = |_tcx, _cnum| {\n-            Lrc::new(FxHashSet()) // Just a dummy\n+            Lrc::new(FxHashMap()) // Just a dummy\n         };\n     }\n     fn provide_extern(&self, _providers: &mut Providers) {}"}, {"sha": "d9e5ac7f7c57195db886ee31e73af2f94260e032", "filename": "src/librustc_typeck/collect.rs", "status": "modified", "additions": 54, "deletions": 33, "changes": 87, "blob_url": "https://github.com/rust-lang/rust/blob/1217d70465edb2079880347fea4baaac56895f51/src%2Flibrustc_typeck%2Fcollect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1217d70465edb2079880347fea4baaac56895f51/src%2Flibrustc_typeck%2Fcollect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcollect.rs?ref=1217d70465edb2079880347fea4baaac56895f51", "patch": "@@ -37,13 +37,14 @@ use rustc::ty::maps::Providers;\n use rustc::ty::util::IntTypeExt;\n use rustc::ty::util::Discr;\n use rustc::util::captures::Captures;\n-use rustc::util::nodemap::{FxHashSet, FxHashMap};\n+use rustc::util::nodemap::FxHashMap;\n \n use syntax::{abi, ast};\n use syntax::ast::MetaItemKind;\n use syntax::attr::{InlineAttr, list_contains_name, mark_used};\n use syntax::codemap::Spanned;\n use syntax::symbol::{Symbol, keywords};\n+use syntax::feature_gate;\n use syntax_pos::{Span, DUMMY_SP};\n \n use rustc::hir::{self, map as hir_map, TransFnAttrs, TransFnAttrFlags, Unsafety};\n@@ -1682,7 +1683,7 @@ fn is_foreign_item<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>,\n fn from_target_feature(\n     tcx: TyCtxt,\n     attr: &ast::Attribute,\n-    whitelist: &FxHashSet<String>,\n+    whitelist: &FxHashMap<String, Option<String>>,\n     target_features: &mut Vec<Symbol>,\n ) {\n     let list = match attr.meta_item_list() {\n@@ -1694,41 +1695,75 @@ fn from_target_feature(\n             return\n         }\n     };\n-\n+    let rust_features = tcx.features();\n     for item in list {\n+        // Only `enable = ...` is accepted in the meta item list\n         if !item.check_name(\"enable\") {\n             let msg = \"#[target_feature(..)] only accepts sub-keys of `enable` \\\n                        currently\";\n             tcx.sess.span_err(item.span, &msg);\n             continue\n         }\n+\n+        // Must be of the form `enable = \"...\"` ( a string)\n         let value = match item.value_str() {\n-            Some(list) => list,\n+            Some(value) => value,\n             None => {\n                 let msg = \"#[target_feature] attribute must be of the form \\\n                            #[target_feature(enable = \\\"..\\\")]\";\n                 tcx.sess.span_err(item.span, &msg);\n                 continue\n             }\n         };\n-        let value = value.as_str();\n-        for feature in value.split(',') {\n-            if whitelist.contains(feature) {\n-                target_features.push(Symbol::intern(feature));\n-                continue\n-            }\n-\n-            let msg = format!(\"the feature named `{}` is not valid for \\\n-                               this target\", feature);\n-            let mut err = tcx.sess.struct_span_err(item.span, &msg);\n \n-            if feature.starts_with(\"+\") {\n-                let valid = whitelist.contains(&feature[1..]);\n-                if valid {\n-                    err.help(\"consider removing the leading `+` in the feature name\");\n+        // We allow comma separation to enable multiple features\n+        for feature in value.as_str().split(',') {\n+\n+            // Only allow whitelisted features per platform\n+            let feature_gate = match whitelist.get(feature) {\n+                Some(g) => g,\n+                None => {\n+                    let msg = format!(\"the feature named `{}` is not valid for \\\n+                                       this target\", feature);\n+                    let mut err = tcx.sess.struct_span_err(item.span, &msg);\n+\n+                    if feature.starts_with(\"+\") {\n+                        let valid = whitelist.contains_key(&feature[1..]);\n+                        if valid {\n+                            err.help(\"consider removing the leading `+` in the feature name\");\n+                        }\n+                    }\n+                    err.emit();\n+                    continue\n                 }\n+            };\n+\n+            // Only allow features whose feature gates have been enabled\n+            let allowed = match feature_gate.as_ref().map(|s| &**s) {\n+                Some(\"arm_target_feature\") => rust_features.arm_target_feature,\n+                Some(\"aarch64_target_feature\") => rust_features.aarch64_target_feature,\n+                Some(\"hexagon_target_feature\") => rust_features.hexagon_target_feature,\n+                Some(\"powerpc_target_feature\") => rust_features.powerpc_target_feature,\n+                Some(\"mips_target_feature\") => rust_features.mips_target_feature,\n+                Some(\"avx512_target_feature\") => rust_features.avx512_target_feature,\n+                Some(\"mmx_target_feature\") => rust_features.mmx_target_feature,\n+                Some(\"sse4a_target_feature\") => rust_features.sse4a_target_feature,\n+                Some(\"tbm_target_feature\") => rust_features.tbm_target_feature,\n+                Some(name) => bug!(\"unknown target feature gate {}\", name),\n+                None => true,\n+            };\n+            if !allowed {\n+                feature_gate::emit_feature_err(\n+                    &tcx.sess.parse_sess,\n+                    feature_gate.as_ref().unwrap(),\n+                    item.span,\n+                    feature_gate::GateIssue::Language,\n+                    &format!(\"the target feature `{}` is currently unstable\",\n+                             feature),\n+                );\n+                continue\n             }\n-            err.emit();\n+            target_features.push(Symbol::intern(feature));\n         }\n     }\n }\n@@ -1835,20 +1870,6 @@ fn trans_fn_attrs<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>, id: DefId) -> TransFnAt\n                     .emit();\n             }\n         } else if attr.check_name(\"target_feature\") {\n-            // handle deprecated #[target_feature = \"...\"]\n-            if let Some(val) = attr.value_str() {\n-                for feat in val.as_str().split(\",\").map(|f| f.trim()) {\n-                    if !feat.is_empty() && !feat.contains('\\0') {\n-                        trans_fn_attrs.target_features.push(Symbol::intern(feat));\n-                    }\n-                }\n-                let msg = \"#[target_feature = \\\"..\\\"] is deprecated and will \\\n-                           eventually be removed, use \\\n-                           #[target_feature(enable = \\\"..\\\")] instead\";\n-                tcx.sess.span_warn(attr.span, &msg);\n-                continue\n-            }\n-\n             if tcx.fn_sig(id).unsafety() == Unsafety::Normal {\n                 let msg = \"#[target_feature(..)] can only be applied to \\\n                            `unsafe` function\";"}, {"sha": "4a259366af3b9b2d5ec176340db4da2caf2872ee", "filename": "src/libsyntax/feature_gate.rs", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/1217d70465edb2079880347fea4baaac56895f51/src%2Flibsyntax%2Ffeature_gate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1217d70465edb2079880347fea4baaac56895f51/src%2Flibsyntax%2Ffeature_gate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Ffeature_gate.rs?ref=1217d70465edb2079880347fea4baaac56895f51", "patch": "@@ -446,6 +446,17 @@ declare_features! (\n \n     // Allows macro invocations in `extern {}` blocks\n     (active, macros_in_extern, \"1.27.0\", Some(49476), None),\n+\n+    // unstable #[target_feature] directives\n+    (active, arm_target_feature, \"1.27.0\", None, None),\n+    (active, aarch64_target_feature, \"1.27.0\", None, None),\n+    (active, hexagon_target_feature, \"1.27.0\", None, None),\n+    (active, powerpc_target_feature, \"1.27.0\", None, None),\n+    (active, mips_target_feature, \"1.27.0\", None, None),\n+    (active, avx512_target_feature, \"1.27.0\", None, None),\n+    (active, mmx_target_feature, \"1.27.0\", None, None),\n+    (active, sse4a_target_feature, \"1.27.0\", None, None),\n+    (active, tbm_target_feature, \"1.27.0\", None, None),\n );\n \n declare_features! ("}, {"sha": "effdcd0132d17b6c4badc67b4b6d3fdf749a2d22", "filename": "src/stdsimd", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": null, "raw_url": null, "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fstdsimd?ref=1217d70465edb2079880347fea4baaac56895f51", "patch": "@@ -1 +1 @@\n-Subproject commit 01ed2bb1dea492324fbe21c3069cb8efacb14ec0\n+Subproject commit effdcd0132d17b6c4badc67b4b6d3fdf749a2d22"}, {"sha": "139da046452646b77c1193c8f18691b3ae084a6d", "filename": "src/test/run-pass/simd-target-feature-mixup.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/1217d70465edb2079880347fea4baaac56895f51/src%2Ftest%2Frun-pass%2Fsimd-target-feature-mixup.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1217d70465edb2079880347fea4baaac56895f51/src%2Ftest%2Frun-pass%2Fsimd-target-feature-mixup.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fsimd-target-feature-mixup.rs?ref=1217d70465edb2079880347fea4baaac56895f51", "patch": "@@ -11,6 +11,7 @@\n // ignore-emscripten\n \n #![feature(repr_simd, target_feature, cfg_target_feature)]\n+#![feature(avx512_target_feature)]\n \n use std::process::{Command, ExitStatus};\n use std::env;"}, {"sha": "69208f151360b2e45ccaef5c467ed40771c93c92", "filename": "src/test/ui/target-feature-gate.rs", "status": "added", "additions": 31, "deletions": 0, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/1217d70465edb2079880347fea4baaac56895f51/src%2Ftest%2Fui%2Ftarget-feature-gate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1217d70465edb2079880347fea4baaac56895f51/src%2Ftest%2Fui%2Ftarget-feature-gate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftarget-feature-gate.rs?ref=1217d70465edb2079880347fea4baaac56895f51", "patch": "@@ -0,0 +1,31 @@\n+// Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// ignore-arm\n+// ignore-aarch64\n+// ignore-wasm\n+// ignore-emscripten\n+// gate-test-sse4a_target_feature\n+// gate-test-powerpc_target_feature\n+// gate-test-avx512_target_feature\n+// gate-test-tbm_target_feature\n+// gate-test-arm_target_feature\n+// gate-test-aarch64_target_feature\n+// gate-test-hexagon_target_feature\n+// gate-test-mips_target_feature\n+// gate-test-mmx_target_feature\n+// min-llvm-version 6.0\n+\n+#[target_feature(enable = \"avx512bw\")]\n+//~^ ERROR: currently unstable\n+unsafe fn foo() {\n+}\n+\n+fn main() {}"}, {"sha": "dc5e174984ba0d22ab9b6c0a9bc853b5cfbf22ab", "filename": "src/test/ui/target-feature-gate.stderr", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/1217d70465edb2079880347fea4baaac56895f51/src%2Ftest%2Fui%2Ftarget-feature-gate.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/1217d70465edb2079880347fea4baaac56895f51/src%2Ftest%2Fui%2Ftarget-feature-gate.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftarget-feature-gate.stderr?ref=1217d70465edb2079880347fea4baaac56895f51", "patch": "@@ -0,0 +1,11 @@\n+error[E0658]: the target feature `avx512bw` is currently unstable\n+  --> $DIR/target-feature-gate.rs:26:18\n+   |\n+LL | #[target_feature(enable = \"avx512bw\")]\n+   |                  ^^^^^^^^^^^^^^^^^^^\n+   |\n+   = help: add #![feature(avx512_target_feature)] to the crate attributes to enable\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0658`."}, {"sha": "0edd51ba779ac4eb0009a15ac3f3aa3a58f654fb", "filename": "src/test/ui/target-feature-wrong.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1217d70465edb2079880347fea4baaac56895f51/src%2Ftest%2Fui%2Ftarget-feature-wrong.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1217d70465edb2079880347fea4baaac56895f51/src%2Ftest%2Fui%2Ftarget-feature-wrong.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftarget-feature-wrong.rs?ref=1217d70465edb2079880347fea4baaac56895f51", "patch": "@@ -19,7 +19,7 @@\n #![feature(target_feature)]\n \n #[target_feature = \"+sse2\"]\n-//~^ WARN: deprecated\n+//~^ ERROR: must be of the form\n #[target_feature(enable = \"foo\")]\n //~^ ERROR: not valid for this target\n #[target_feature(bar)]"}, {"sha": "ed86687bb2fccbec23171b60c6a03989041a6a84", "filename": "src/test/ui/target-feature-wrong.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/1217d70465edb2079880347fea4baaac56895f51/src%2Ftest%2Fui%2Ftarget-feature-wrong.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/1217d70465edb2079880347fea4baaac56895f51/src%2Ftest%2Fui%2Ftarget-feature-wrong.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftarget-feature-wrong.stderr?ref=1217d70465edb2079880347fea4baaac56895f51", "patch": "@@ -1,4 +1,4 @@\n-warning: #[target_feature = \"..\"] is deprecated and will eventually be removed, use #[target_feature(enable = \"..\")] instead\n+error: #[target_feature] attribute must be of the form #[target_feature(..)]\n   --> $DIR/target-feature-wrong.rs:21:1\n    |\n LL | #[target_feature = \"+sse2\"]\n@@ -43,5 +43,5 @@ error: cannot use #[inline(always)] with #[target_feature]\n LL | #[inline(always)]\n    | ^^^^^^^^^^^^^^^^^\n \n-error: aborting due to 6 previous errors\n+error: aborting due to 7 previous errors\n "}]}