{"sha": "3f883b850d81be5ba6a2a4039de33fd7dd7c188d", "node_id": "C_kwDOAAsO6NoAKDNmODgzYjg1MGQ4MWJlNWJhNmEyYTQwMzlkZTMzZmQ3ZGQ3YzE4OGQ", "commit": {"author": {"name": "Adrian Tombu", "email": "adrian@otso.fr", "date": "2022-08-24T17:15:44Z"}, "committer": {"name": "Adrian Tombu", "email": "adrian@otso.fr", "date": "2022-08-25T16:06:12Z"}, "message": "Start adding enum errors for deserialize_rlink", "tree": {"sha": "872f17a48083210aa809cc416eeb2dad598d8824", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/872f17a48083210aa809cc416eeb2dad598d8824"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3f883b850d81be5ba6a2a4039de33fd7dd7c188d", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQFDBAABCAAtFiEEPq029qEtTUDaayZUnNjpedOpQ/4FAmMHnfQPHGFkcmlhbkBv\ndHNvLmZyAAoJEJzY6XnTqUP+8QsIALw5ojZqsBChuWPTvi984yujb/S86DpfBY20\nIfVZ7B++lP5OO2FIC+ovme2I9nmEme9nEp8eyf4uxkj+abLtuuocSqh6JemA63qw\ntrfDGznF+GYkefWSKrXhc0+nXKkacpORmf3jehgpU8iOeM1q3o9JoX0b9yMVLkNQ\nelU8Dc0KBBjEczpz8K61qpvQ9t3Lqw64kp8yerSGpY/8xazv9wrYiLuHNiR5axmJ\nFFOpdJ5yzmIpP/eHK3Rj0cL7GEakQrP3mGV+kDj/2jllTIz3q0yKPCMJKCymmor/\nC1apPj1EXXra9R9Q3cMoPFaVZ87sxXibaOThnzyRRNAlusciexM=\n=wj0d\n-----END PGP SIGNATURE-----", "payload": "tree 872f17a48083210aa809cc416eeb2dad598d8824\nparent 1c575c5fe05110a628a7bf0e609602bb9066edec\nauthor Adrian Tombu <adrian@otso.fr> 1661361344 +0200\ncommitter Adrian Tombu <adrian@otso.fr> 1661443572 +0200\n\nStart adding enum errors for deserialize_rlink\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3f883b850d81be5ba6a2a4039de33fd7dd7c188d", "html_url": "https://github.com/rust-lang/rust/commit/3f883b850d81be5ba6a2a4039de33fd7dd7c188d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3f883b850d81be5ba6a2a4039de33fd7dd7c188d/comments", "author": {"login": "adriantombu", "id": 383297, "node_id": "MDQ6VXNlcjM4MzI5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/383297?v=4", "gravatar_id": "", "url": "https://api.github.com/users/adriantombu", "html_url": "https://github.com/adriantombu", "followers_url": "https://api.github.com/users/adriantombu/followers", "following_url": "https://api.github.com/users/adriantombu/following{/other_user}", "gists_url": "https://api.github.com/users/adriantombu/gists{/gist_id}", "starred_url": "https://api.github.com/users/adriantombu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/adriantombu/subscriptions", "organizations_url": "https://api.github.com/users/adriantombu/orgs", "repos_url": "https://api.github.com/users/adriantombu/repos", "events_url": "https://api.github.com/users/adriantombu/events{/privacy}", "received_events_url": "https://api.github.com/users/adriantombu/received_events", "type": "User", "site_admin": false}, "committer": {"login": "adriantombu", "id": 383297, "node_id": "MDQ6VXNlcjM4MzI5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/383297?v=4", "gravatar_id": "", "url": "https://api.github.com/users/adriantombu", "html_url": "https://github.com/adriantombu", "followers_url": "https://api.github.com/users/adriantombu/followers", "following_url": "https://api.github.com/users/adriantombu/following{/other_user}", "gists_url": "https://api.github.com/users/adriantombu/gists{/gist_id}", "starred_url": "https://api.github.com/users/adriantombu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/adriantombu/subscriptions", "organizations_url": "https://api.github.com/users/adriantombu/orgs", "repos_url": "https://api.github.com/users/adriantombu/repos", "events_url": "https://api.github.com/users/adriantombu/events{/privacy}", "received_events_url": "https://api.github.com/users/adriantombu/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1c575c5fe05110a628a7bf0e609602bb9066edec", "url": "https://api.github.com/repos/rust-lang/rust/commits/1c575c5fe05110a628a7bf0e609602bb9066edec", "html_url": "https://github.com/rust-lang/rust/commit/1c575c5fe05110a628a7bf0e609602bb9066edec"}], "stats": {"total": 86, "additions": 76, "deletions": 10}, "files": [{"sha": "deabdca75cb54982783e00d0897ea9a55ea8765d", "filename": "compiler/rustc_codegen_ssa/src/lib.rs", "status": "modified", "additions": 19, "deletions": 7, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/3f883b850d81be5ba6a2a4039de33fd7dd7c188d/compiler%2Frustc_codegen_ssa%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3f883b850d81be5ba6a2a4039de33fd7dd7c188d/compiler%2Frustc_codegen_ssa%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Flib.rs?ref=3f883b850d81be5ba6a2a4039de33fd7dd7c188d", "patch": "@@ -21,6 +21,7 @@ extern crate tracing;\n #[macro_use]\n extern crate rustc_middle;\n \n+use crate::session_diagnostic::{DeserializeRlinkError, DeserializeRlinkErrorSub};\n use rustc_ast as ast;\n use rustc_data_structures::fx::{FxHashMap, FxHashSet};\n use rustc_data_structures::sync::Lrc;\n@@ -49,6 +50,7 @@ pub mod glue;\n pub mod meth;\n pub mod mir;\n pub mod mono_item;\n+pub mod session_diagnostic;\n pub mod target_features;\n pub mod traits;\n \n@@ -212,30 +214,40 @@ impl CodegenResults {\n         encoder.finish()\n     }\n \n-    pub fn deserialize_rlink(data: Vec<u8>) -> Result<Self, String> {\n+    pub fn deserialize_rlink(data: Vec<u8>) -> Result<Self, DeserializeRlinkError> {\n         // The Decodable machinery is not used here because it panics if the input data is invalid\n         // and because its internal representation may change.\n         if !data.starts_with(RLINK_MAGIC) {\n-            return Err(\"The input does not look like a .rlink file\".to_string());\n+            return Err(DeserializeRlinkError { sub: DeserializeRlinkErrorSub::WrongFileType });\n         }\n         let data = &data[RLINK_MAGIC.len()..];\n         if data.len() < 4 {\n-            return Err(\"The input does not contain version number\".to_string());\n+            return Err(DeserializeRlinkError {\n+                sub: DeserializeRlinkErrorSub::EmptyVersionNumber,\n+            });\n         }\n \n         let mut version_array: [u8; 4] = Default::default();\n         version_array.copy_from_slice(&data[..4]);\n         if u32::from_be_bytes(version_array) != RLINK_VERSION {\n-            return Err(\".rlink file was produced with encoding version {version_array}, but the current version is {RLINK_VERSION}\".to_string());\n+            return Err(DeserializeRlinkError {\n+                sub: DeserializeRlinkErrorSub::EncodingVersionMismatch {\n+                    version_array: String::from_utf8_lossy(&version_array).to_string(),\n+                    rlink_version: RLINK_VERSION.to_string(),\n+                },\n+            });\n         }\n \n         let mut decoder = MemDecoder::new(&data[4..], 0);\n         let rustc_version = decoder.read_str();\n         let current_version = RUSTC_VERSION.unwrap();\n         if rustc_version != current_version {\n-            return Err(format!(\n-                \".rlink file was produced by rustc version {rustc_version}, but the current version is {current_version}.\"\n-            ));\n+            return Err(DeserializeRlinkError {\n+                sub: DeserializeRlinkErrorSub::RustcVersionMismatch {\n+                    rustc_version: rustc_version.to_string(),\n+                    current_version: current_version.to_string(),\n+                },\n+            });\n         }\n \n         let codegen_results = CodegenResults::decode(&mut decoder);"}, {"sha": "ac7065ae23cd4ae92046aa59e8d76d9deb564b93", "filename": "compiler/rustc_codegen_ssa/src/session_diagnostic.rs", "status": "added", "additions": 42, "deletions": 0, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/3f883b850d81be5ba6a2a4039de33fd7dd7c188d/compiler%2Frustc_codegen_ssa%2Fsrc%2Fsession_diagnostic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3f883b850d81be5ba6a2a4039de33fd7dd7c188d/compiler%2Frustc_codegen_ssa%2Fsrc%2Fsession_diagnostic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fsession_diagnostic.rs?ref=3f883b850d81be5ba6a2a4039de33fd7dd7c188d", "patch": "@@ -0,0 +1,42 @@\n+use rustc_errors::{fluent, DiagnosticArgValue, IntoDiagnosticArg};\n+use rustc_macros::{SessionDiagnostic, SessionSubdiagnostic};\n+use std::borrow::Cow;\n+\n+#[derive(SessionDiagnostic)]\n+#[diag(codegen_ssa::error)]\n+pub struct DeserializeRlinkError {\n+    #[subdiagnostic]\n+    pub sub: DeserializeRlinkErrorSub,\n+}\n+\n+#[derive(SessionSubdiagnostic)]\n+pub enum DeserializeRlinkErrorSub {\n+    #[note(codegen_ssa::wrong_file_type)]\n+    WrongFileType,\n+\n+    #[note(codegen_ssa::empty_version_number)]\n+    EmptyVersionNumber,\n+\n+    #[note(codegen_ssa::encoding_version_mismatch)]\n+    EncodingVersionMismatch { version_array: String, rlink_version: String },\n+\n+    #[note(codegen_ssa::rustc_version_mismatch)]\n+    RustcVersionMismatch { rustc_version: String, current_version: String },\n+}\n+\n+impl IntoDiagnosticArg for DeserializeRlinkErrorSub {\n+    fn into_diagnostic_arg(self) -> DiagnosticArgValue<'static> {\n+        DiagnosticArgValue::Str(Cow::Borrowed(match self {\n+            DeserializeRlinkErrorSub::WrongFileType => fluent::codegen_ssa::wrong_file_type,\n+            DeserializeRlinkErrorSub::EmptyVersionNumber => {\n+                fluent::codegen_ssa::empty_version_number\n+            }\n+            DeserializeRlinkErrorSub::EncodingVersionMismatch { version_array, rlink_version } => {\n+                fluent::codegen_ssa::encoding_version_mismatch\n+            }\n+            DeserializeRlinkErrorSub::RustcVersionMismatch { rustc_version, current_version } => {\n+                fluent::codegen_ssa::rustc_version_mismatch\n+            }\n+        }))\n+    }\n+}"}, {"sha": "99999909d573f43cb83d95e221cafb2f1c4fa388", "filename": "compiler/rustc_driver/src/lib.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/3f883b850d81be5ba6a2a4039de33fd7dd7c188d/compiler%2Frustc_driver%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3f883b850d81be5ba6a2a4039de33fd7dd7c188d/compiler%2Frustc_driver%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_driver%2Fsrc%2Flib.rs?ref=3f883b850d81be5ba6a2a4039de33fd7dd7c188d", "patch": "@@ -590,8 +590,8 @@ pub fn try_process_rlink(sess: &Session, compiler: &interface::Compiler) -> Comp\n             });\n             let codegen_results = match CodegenResults::deserialize_rlink(rlink_data) {\n                 Ok(codegen) => codegen,\n-                Err(error_message) => {\n-                    sess.emit_fatal(RlinkUnableToDeserialize { error_message });\n+                Err(err) => {\n+                    sess.emit_fatal(RlinkUnableToDeserialize { err });\n                 }\n             };\n             let result = compiler.codegen_backend().link(sess, codegen_results, &outputs);"}, {"sha": "86ee51bc97d71786b49b38e9b595d330556b2b4f", "filename": "compiler/rustc_driver/src/session_diagnostics.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/3f883b850d81be5ba6a2a4039de33fd7dd7c188d/compiler%2Frustc_driver%2Fsrc%2Fsession_diagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3f883b850d81be5ba6a2a4039de33fd7dd7c188d/compiler%2Frustc_driver%2Fsrc%2Fsession_diagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_driver%2Fsrc%2Fsession_diagnostics.rs?ref=3f883b850d81be5ba6a2a4039de33fd7dd7c188d", "patch": "@@ -1,3 +1,4 @@\n+use rustc_codegen_ssa::session_diagnostic::DeserializeRlinkError;\n use rustc_macros::SessionDiagnostic;\n \n #[derive(SessionDiagnostic)]\n@@ -9,7 +10,7 @@ pub(crate) struct RlinkUnableToRead {\n #[derive(SessionDiagnostic)]\n #[diag(driver::rlink_unable_to_deserialize)]\n pub(crate) struct RlinkUnableToDeserialize {\n-    pub error_message: String,\n+    pub err: DeserializeRlinkError,\n }\n \n #[derive(SessionDiagnostic)]"}, {"sha": "f93ac354773a31b147e01f3c1f54ee6cc60f7138", "filename": "compiler/rustc_error_messages/locales/en-US/codegen_ssa.ftl", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/3f883b850d81be5ba6a2a4039de33fd7dd7c188d/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fcodegen_ssa.ftl", "raw_url": "https://github.com/rust-lang/rust/raw/3f883b850d81be5ba6a2a4039de33fd7dd7c188d/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fcodegen_ssa.ftl", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fcodegen_ssa.ftl?ref=3f883b850d81be5ba6a2a4039de33fd7dd7c188d", "patch": "@@ -0,0 +1,9 @@\n+codegen_ssa_error = Error while deserializing rlink file\n+\n+codegen_ssa_wrong_file_type = The input does not look like a .rlink file\n+\n+codegen_ssa_empty_version_number = The input does not contain version number\n+\n+codegen_ssa_encoding_version_mismatch = .rlink file was produced with encoding version `{$version_array}`, but the current version is `{$rlink_version}`\n+\n+codegen_ssa_rustc_version_mismatch = .rlink file was produced by rustc version `{$rustc_version}`, but the current version is `{$current_version}`"}, {"sha": "b4fd883d8457878bce5d187f633b019d04d0da71", "filename": "compiler/rustc_error_messages/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/3f883b850d81be5ba6a2a4039de33fd7dd7c188d/compiler%2Frustc_error_messages%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3f883b850d81be5ba6a2a4039de33fd7dd7c188d/compiler%2Frustc_error_messages%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_error_messages%2Fsrc%2Flib.rs?ref=3f883b850d81be5ba6a2a4039de33fd7dd7c188d", "patch": "@@ -35,6 +35,7 @@ fluent_messages! {\n     ast_passes => \"../locales/en-US/ast_passes.ftl\",\n     borrowck => \"../locales/en-US/borrowck.ftl\",\n     builtin_macros => \"../locales/en-US/builtin_macros.ftl\",\n+    codegen_ssa => \"../locales/en-US/codegen_ssa.ftl\",\n     const_eval => \"../locales/en-US/const_eval.ftl\",\n     driver => \"../locales/en-US/driver.ftl\",\n     expand => \"../locales/en-US/expand.ftl\","}, {"sha": "bcf406bcb9572caa3054bf1c07fbf29b12dba7e3", "filename": "compiler/rustc_macros/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/3f883b850d81be5ba6a2a4039de33fd7dd7c188d/compiler%2Frustc_macros%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3f883b850d81be5ba6a2a4039de33fd7dd7c188d/compiler%2Frustc_macros%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_macros%2Fsrc%2Flib.rs?ref=3f883b850d81be5ba6a2a4039de33fd7dd7c188d", "patch": "@@ -163,6 +163,7 @@ decl_derive!(\n decl_derive!(\n     [SessionSubdiagnostic, attributes(\n         // struct/variant attributes\n+        diag,\n         label,\n         help,\n         note,"}]}