{"sha": "ad5d9fba9b6d5482e504e4996e2aea54defb9ed6", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFkNWQ5ZmJhOWI2ZDU0ODJlNTA0ZTQ5OTZlMmFlYTU0ZGVmYjllZDY=", "commit": {"author": {"name": "Caleb Cartwright", "email": "calebcartwright@users.noreply.github.com", "date": "2019-09-02T09:36:51Z"}, "committer": {"name": "Seiichi Uchida", "email": "seuchida@gmail.com", "date": "2019-09-02T09:36:51Z"}, "message": "fix formatting mods inside cfg_if macro (#3763)", "tree": {"sha": "fd7848ff450f8801d698d6756f824f0fac27c677", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fd7848ff450f8801d698d6756f824f0fac27c677"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ad5d9fba9b6d5482e504e4996e2aea54defb9ed6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ad5d9fba9b6d5482e504e4996e2aea54defb9ed6", "html_url": "https://github.com/rust-lang/rust/commit/ad5d9fba9b6d5482e504e4996e2aea54defb9ed6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ad5d9fba9b6d5482e504e4996e2aea54defb9ed6/comments", "author": {"login": "calebcartwright", "id": 13042488, "node_id": "MDQ6VXNlcjEzMDQyNDg4", "avatar_url": "https://avatars.githubusercontent.com/u/13042488?v=4", "gravatar_id": "", "url": "https://api.github.com/users/calebcartwright", "html_url": "https://github.com/calebcartwright", "followers_url": "https://api.github.com/users/calebcartwright/followers", "following_url": "https://api.github.com/users/calebcartwright/following{/other_user}", "gists_url": "https://api.github.com/users/calebcartwright/gists{/gist_id}", "starred_url": "https://api.github.com/users/calebcartwright/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/calebcartwright/subscriptions", "organizations_url": "https://api.github.com/users/calebcartwright/orgs", "repos_url": "https://api.github.com/users/calebcartwright/repos", "events_url": "https://api.github.com/users/calebcartwright/events{/privacy}", "received_events_url": "https://api.github.com/users/calebcartwright/received_events", "type": "User", "site_admin": false}, "committer": {"login": "topecongiro", "id": 21980157, "node_id": "MDQ6VXNlcjIxOTgwMTU3", "avatar_url": "https://avatars.githubusercontent.com/u/21980157?v=4", "gravatar_id": "", "url": "https://api.github.com/users/topecongiro", "html_url": "https://github.com/topecongiro", "followers_url": "https://api.github.com/users/topecongiro/followers", "following_url": "https://api.github.com/users/topecongiro/following{/other_user}", "gists_url": "https://api.github.com/users/topecongiro/gists{/gist_id}", "starred_url": "https://api.github.com/users/topecongiro/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/topecongiro/subscriptions", "organizations_url": "https://api.github.com/users/topecongiro/orgs", "repos_url": "https://api.github.com/users/topecongiro/repos", "events_url": "https://api.github.com/users/topecongiro/events{/privacy}", "received_events_url": "https://api.github.com/users/topecongiro/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f800ce47d1da2a1c02ffd260deca8b7445f7facf", "url": "https://api.github.com/repos/rust-lang/rust/commits/f800ce47d1da2a1c02ffd260deca8b7445f7facf", "html_url": "https://github.com/rust-lang/rust/commit/f800ce47d1da2a1c02ffd260deca8b7445f7facf"}], "stats": {"total": 119, "additions": 114, "deletions": 5}, "files": [{"sha": "655d17d47a0281c4ebabec00fae2284439e34936", "filename": "src/modules.rs", "status": "modified", "additions": 9, "deletions": 2, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/ad5d9fba9b6d5482e504e4996e2aea54defb9ed6/src%2Fmodules.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad5d9fba9b6d5482e504e4996e2aea54defb9ed6/src%2Fmodules.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fmodules.rs?ref=ad5d9fba9b6d5482e504e4996e2aea54defb9ed6", "patch": "@@ -105,7 +105,7 @@ impl<'ast, 'sess, 'c> ModResolver<'ast, 'sess> {\n         visitor.visit_item(&item);\n         for module_item in visitor.mods() {\n             if let ast::ItemKind::Mod(ref sub_mod) = module_item.item.node {\n-                self.visit_sub_mod(&item, Cow::Owned(sub_mod.clone()))?;\n+                self.visit_sub_mod(&module_item.item, Cow::Owned(sub_mod.clone()))?;\n             }\n         }\n         Ok(())\n@@ -477,7 +477,14 @@ fn parse_mod_items<'a>(parser: &mut parser::Parser<'a>, inner_lo: Span) -> PResu\n \n fn is_cfg_if(item: &ast::Item) -> bool {\n     match item.node {\n-        ast::ItemKind::Mac(..) if item.ident.name == Symbol::intern(\"cfg_if\") => true,\n+        ast::ItemKind::Mac(ref mac) => {\n+            if let Some(first_segment) = mac.node.path.segments.first() {\n+                if first_segment.ident.name == Symbol::intern(\"cfg_if\") {\n+                    return true;\n+                }\n+            }\n+            false\n+        }\n         _ => false,\n     }\n }"}, {"sha": "48b56d4d102d1179b6a72fd7128ce6cf318cd6ef", "filename": "src/modules/visitor.rs", "status": "modified", "additions": 21, "deletions": 3, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/ad5d9fba9b6d5482e504e4996e2aea54defb9ed6/src%2Fmodules%2Fvisitor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad5d9fba9b6d5482e504e4996e2aea54defb9ed6/src%2Fmodules%2Fvisitor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fmodules%2Fvisitor.rs?ref=ad5d9fba9b6d5482e504e4996e2aea54defb9ed6", "patch": "@@ -43,9 +43,27 @@ impl<'a, 'ast: 'a> Visitor<'ast> for CfgIfVisitor<'a> {\n \n impl<'a, 'ast: 'a> CfgIfVisitor<'a> {\n     fn visit_mac_inner(&mut self, mac: &'ast ast::Mac) -> Result<(), &'static str> {\n-        if mac.node.path != Symbol::intern(\"cfg_if\") {\n-            return Err(\"Expected cfg_if\");\n-        }\n+        // Support both:\n+        // ```\n+        // extern crate cfg_if;\n+        // cfg_if::cfg_if! {..}\n+        // ```\n+        // And:\n+        // ```\n+        // #[macro_use]\n+        // extern crate cfg_if;\n+        // cfg_if! {..}\n+        // ```\n+        match mac.node.path.segments.first() {\n+            Some(first_segment) => {\n+                if first_segment.ident.name != Symbol::intern(\"cfg_if\") {\n+                    return Err(\"Expected cfg_if\");\n+                }\n+            }\n+            None => {\n+                return Err(\"Expected cfg_if\");\n+            }\n+        };\n \n         let mut parser = stream_to_parser_with_base_dir(\n             self.parse_sess,"}, {"sha": "3793a98ab00eccaec7f0382714286424e5f7873e", "filename": "src/test/mod.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/ad5d9fba9b6d5482e504e4996e2aea54defb9ed6/src%2Ftest%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad5d9fba9b6d5482e504e4996e2aea54defb9ed6/src%2Ftest%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmod.rs?ref=ad5d9fba9b6d5482e504e4996e2aea54defb9ed6", "patch": "@@ -30,6 +30,9 @@ const SKIP_FILE_WHITE_LIST: &[&str] = &[\n     // These files and directory are a part of modules defined inside `cfg_if!`.\n     \"cfg_if/mod.rs\",\n     \"cfg_if/detect\",\n+    \"issue-3253/foo.rs\",\n+    \"issue-3253/bar.rs\",\n+    \"issue-3253/paths\",\n     // These files and directory are a part of modules defined inside `cfg_attr(..)`.\n     \"cfg_mod/dir\",\n     \"cfg_mod/bar.rs\","}, {"sha": "eaeffd3ad00cf104c1bd20b36bb5165785d097f9", "filename": "tests/source/issue-3253/bar.rs", "status": "added", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/ad5d9fba9b6d5482e504e4996e2aea54defb9ed6/tests%2Fsource%2Fissue-3253%2Fbar.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad5d9fba9b6d5482e504e4996e2aea54defb9ed6/tests%2Fsource%2Fissue-3253%2Fbar.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fissue-3253%2Fbar.rs?ref=ad5d9fba9b6d5482e504e4996e2aea54defb9ed6", "patch": "@@ -0,0 +1,4 @@\n+// Empty\n+   fn empty()     {\n+\n+}"}, {"sha": "4ebe5326b3c8fab97d00e1729f4106fa4d9e4b43", "filename": "tests/source/issue-3253/foo.rs", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/ad5d9fba9b6d5482e504e4996e2aea54defb9ed6/tests%2Fsource%2Fissue-3253%2Ffoo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad5d9fba9b6d5482e504e4996e2aea54defb9ed6/tests%2Fsource%2Fissue-3253%2Ffoo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fissue-3253%2Ffoo.rs?ref=ad5d9fba9b6d5482e504e4996e2aea54defb9ed6", "patch": "@@ -0,0 +1,6 @@\n+pub    fn hello(  )\n+    {\n+println!(\"Hello World!\");\n+\n+            }\n+"}, {"sha": "3eef586bd6792bf3bf1466b3d6cd5a746bbda143", "filename": "tests/source/issue-3253/lib.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/ad5d9fba9b6d5482e504e4996e2aea54defb9ed6/tests%2Fsource%2Fissue-3253%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad5d9fba9b6d5482e504e4996e2aea54defb9ed6/tests%2Fsource%2Fissue-3253%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fissue-3253%2Flib.rs?ref=ad5d9fba9b6d5482e504e4996e2aea54defb9ed6", "patch": "@@ -0,0 +1,14 @@\n+#[macro_use]\n+extern crate cfg_if;\n+\n+cfg_if! {\n+    if #[cfg(target_family = \"unix\")] {\n+        mod foo;\n+        #[path = \"paths/bar_foo.rs\"]\n+        mod bar_foo;\n+    } else {\n+        mod bar;\n+        #[path = \"paths/foo_bar.rs\"]\n+        mod foo_bar;\n+    }\n+}"}, {"sha": "da19f9dfaa1621ca64692136ad4e25d0bfced362", "filename": "tests/source/issue-3253/paths/bar_foo.rs", "status": "added", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/ad5d9fba9b6d5482e504e4996e2aea54defb9ed6/tests%2Fsource%2Fissue-3253%2Fpaths%2Fbar_foo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad5d9fba9b6d5482e504e4996e2aea54defb9ed6/tests%2Fsource%2Fissue-3253%2Fpaths%2Fbar_foo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fissue-3253%2Fpaths%2Fbar_foo.rs?ref=ad5d9fba9b6d5482e504e4996e2aea54defb9ed6", "patch": "@@ -0,0 +1,3 @@\n+fn    foo_decl_item(x: &mut i32) {\n+    x = 3;\n+}"}, {"sha": "5c63eb83203eb7b8fc7581b130c0644afe2e64cb", "filename": "tests/source/issue-3253/paths/excluded.rs", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/ad5d9fba9b6d5482e504e4996e2aea54defb9ed6/tests%2Fsource%2Fissue-3253%2Fpaths%2Fexcluded.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad5d9fba9b6d5482e504e4996e2aea54defb9ed6/tests%2Fsource%2Fissue-3253%2Fpaths%2Fexcluded.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fissue-3253%2Fpaths%2Fexcluded.rs?ref=ad5d9fba9b6d5482e504e4996e2aea54defb9ed6", "patch": "@@ -0,0 +1,6 @@\n+// This module is not imported in the cfg_if macro in lib.rs so it is ignored\n+// while the foo and bar mods are formatted.\n+// Check the corresponding file in tests/target/issue-3253/paths/excluded.rs\n+trait CoolerTypes { fn dummy(&self) {\n+}\n+}"}, {"sha": "fbb5d92c6e33b70743b0a90589b28b917139f9e6", "filename": "tests/source/issue-3253/paths/foo_bar.rs", "status": "added", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/ad5d9fba9b6d5482e504e4996e2aea54defb9ed6/tests%2Fsource%2Fissue-3253%2Fpaths%2Ffoo_bar.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad5d9fba9b6d5482e504e4996e2aea54defb9ed6/tests%2Fsource%2Fissue-3253%2Fpaths%2Ffoo_bar.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fissue-3253%2Fpaths%2Ffoo_bar.rs?ref=ad5d9fba9b6d5482e504e4996e2aea54defb9ed6", "patch": "@@ -0,0 +1,4 @@\n+\n+\n+fn Foo<T>() where T: Bar {\n+}"}, {"sha": "6c6ab945b88f796046daf4721cdd6fbb93ff99a7", "filename": "tests/target/issue-3253/bar.rs", "status": "added", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ad5d9fba9b6d5482e504e4996e2aea54defb9ed6/tests%2Ftarget%2Fissue-3253%2Fbar.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad5d9fba9b6d5482e504e4996e2aea54defb9ed6/tests%2Ftarget%2Fissue-3253%2Fbar.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fissue-3253%2Fbar.rs?ref=ad5d9fba9b6d5482e504e4996e2aea54defb9ed6", "patch": "@@ -0,0 +1,2 @@\n+// Empty\n+fn empty() {}"}, {"sha": "1a42a10159e667f2555e3a141f861cb786550b9d", "filename": "tests/target/issue-3253/foo.rs", "status": "added", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/ad5d9fba9b6d5482e504e4996e2aea54defb9ed6/tests%2Ftarget%2Fissue-3253%2Ffoo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad5d9fba9b6d5482e504e4996e2aea54defb9ed6/tests%2Ftarget%2Fissue-3253%2Ffoo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fissue-3253%2Ffoo.rs?ref=ad5d9fba9b6d5482e504e4996e2aea54defb9ed6", "patch": "@@ -0,0 +1,3 @@\n+pub fn hello() {\n+    println!(\"Hello World!\");\n+}"}, {"sha": "3eef586bd6792bf3bf1466b3d6cd5a746bbda143", "filename": "tests/target/issue-3253/lib.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/ad5d9fba9b6d5482e504e4996e2aea54defb9ed6/tests%2Ftarget%2Fissue-3253%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad5d9fba9b6d5482e504e4996e2aea54defb9ed6/tests%2Ftarget%2Fissue-3253%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fissue-3253%2Flib.rs?ref=ad5d9fba9b6d5482e504e4996e2aea54defb9ed6", "patch": "@@ -0,0 +1,14 @@\n+#[macro_use]\n+extern crate cfg_if;\n+\n+cfg_if! {\n+    if #[cfg(target_family = \"unix\")] {\n+        mod foo;\n+        #[path = \"paths/bar_foo.rs\"]\n+        mod bar_foo;\n+    } else {\n+        mod bar;\n+        #[path = \"paths/foo_bar.rs\"]\n+        mod foo_bar;\n+    }\n+}"}, {"sha": "f7e1de29a306815850a08b77de9f182654adb2f9", "filename": "tests/target/issue-3253/paths/bar_foo.rs", "status": "added", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/ad5d9fba9b6d5482e504e4996e2aea54defb9ed6/tests%2Ftarget%2Fissue-3253%2Fpaths%2Fbar_foo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad5d9fba9b6d5482e504e4996e2aea54defb9ed6/tests%2Ftarget%2Fissue-3253%2Fpaths%2Fbar_foo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fissue-3253%2Fpaths%2Fbar_foo.rs?ref=ad5d9fba9b6d5482e504e4996e2aea54defb9ed6", "patch": "@@ -0,0 +1,3 @@\n+fn foo_decl_item(x: &mut i32) {\n+    x = 3;\n+}"}, {"sha": "9ab88414d465530ec2cd492df29407d546daeaa6", "filename": "tests/target/issue-3253/paths/excluded.rs", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/ad5d9fba9b6d5482e504e4996e2aea54defb9ed6/tests%2Ftarget%2Fissue-3253%2Fpaths%2Fexcluded.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad5d9fba9b6d5482e504e4996e2aea54defb9ed6/tests%2Ftarget%2Fissue-3253%2Fpaths%2Fexcluded.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fissue-3253%2Fpaths%2Fexcluded.rs?ref=ad5d9fba9b6d5482e504e4996e2aea54defb9ed6", "patch": "@@ -0,0 +1,17 @@\n+// This module is not imported in the cfg_if macro in lib.rs so it is ignored\n+// while the foo and bar mods are formatted.\n+// Check the corresponding file in tests/source/issue-3253/paths/excluded.rs\n+\n+\n+\n+\n+    fn Foo<T>() where T: Bar {\n+}\n+\n+\n+\n+trait CoolerTypes { fn dummy(&self) {\n+}\n+}\n+\n+"}, {"sha": "f52ac11b7399d0f86a8d4fbb3159ac106f2640c0", "filename": "tests/target/issue-3253/paths/foo_bar.rs", "status": "added", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/ad5d9fba9b6d5482e504e4996e2aea54defb9ed6/tests%2Ftarget%2Fissue-3253%2Fpaths%2Ffoo_bar.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad5d9fba9b6d5482e504e4996e2aea54defb9ed6/tests%2Ftarget%2Fissue-3253%2Fpaths%2Ffoo_bar.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fissue-3253%2Fpaths%2Ffoo_bar.rs?ref=ad5d9fba9b6d5482e504e4996e2aea54defb9ed6", "patch": "@@ -0,0 +1,5 @@\n+fn Foo<T>()\n+where\n+    T: Bar,\n+{\n+}"}]}