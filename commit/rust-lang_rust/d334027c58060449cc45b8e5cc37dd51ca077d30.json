{"sha": "d334027c58060449cc45b8e5cc37dd51ca077d30", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQzMzQwMjdjNTgwNjA0NDljYzQ1YjhlNWNjMzdkZDUxY2EwNzdkMzA=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-07-12T10:16:19Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-07-12T10:16:19Z"}, "message": "Auto merge of #52230 - alexcrichton:attr-and-derive, r=petrochenkov\n\nrustc: Search all derives for inert attributes\n\nThis commit fixes an apparent mistake in librustc_resolve where when the\n`proc_macro` feature is enabled (or `rust_2018_preview`) the resolution of\ncustom attributes for custom derive was tweaked. Previously when an attribute\nfailed to resolve it was attempted to locate if there is a custom derive also in\nscope which declares the attribute, but only the first custom derive directive\nwas search.\n\nInstead this commit fixes the loop to search all custom derive invocations\nlooking for any which register the attribute in question.\n\nCloses #52219", "tree": {"sha": "60321db9ce8000ebef7bf4651e0e1856935b3dbc", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/60321db9ce8000ebef7bf4651e0e1856935b3dbc"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d334027c58060449cc45b8e5cc37dd51ca077d30", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d334027c58060449cc45b8e5cc37dd51ca077d30", "html_url": "https://github.com/rust-lang/rust/commit/d334027c58060449cc45b8e5cc37dd51ca077d30", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d334027c58060449cc45b8e5cc37dd51ca077d30/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "de857bbcf02d192986efc380b4735d8c9bea85ac", "url": "https://api.github.com/repos/rust-lang/rust/commits/de857bbcf02d192986efc380b4735d8c9bea85ac", "html_url": "https://github.com/rust-lang/rust/commit/de857bbcf02d192986efc380b4735d8c9bea85ac"}, {"sha": "743a8171a99748890c7922d15c3f63ba180e2de8", "url": "https://api.github.com/repos/rust-lang/rust/commits/743a8171a99748890c7922d15c3f63ba180e2de8", "html_url": "https://github.com/rust-lang/rust/commit/743a8171a99748890c7922d15c3f63ba180e2de8"}], "stats": {"total": 70, "additions": 69, "deletions": 1}, "files": [{"sha": "024506ed7f8e73d11a5841fb2902e7830947c687", "filename": "src/librustc_resolve/macros.rs", "status": "modified", "additions": 17, "deletions": 1, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/d334027c58060449cc45b8e5cc37dd51ca077d30/src%2Flibrustc_resolve%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d334027c58060449cc45b8e5cc37dd51ca077d30/src%2Flibrustc_resolve%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_resolve%2Fmacros.rs?ref=d334027c58060449cc45b8e5cc37dd51ca077d30", "patch": "@@ -385,6 +385,22 @@ impl<'a> Resolver<'a> {\n             Err(Determinacy::Determined) => {}\n         }\n \n+        // Ok at this point we've determined that the `attr` above doesn't\n+        // actually resolve at this time, so we may want to report an error.\n+        // It could be the case, though, that `attr` won't ever resolve! If\n+        // there's a custom derive that could be used it might declare `attr` as\n+        // a custom attribute accepted by the derive. In this case we don't want\n+        // to report this particular invocation as unresolved, but rather we'd\n+        // want to move on to the next invocation.\n+        //\n+        // This loop here looks through all of the derive annotations in scope\n+        // and tries to resolve them. If they themselves successfully resolve\n+        // *and* the resolve mentions that this attribute's name is a registered\n+        // custom attribute then we flag this attribute as known and update\n+        // `invoc` above to point to the next invocation.\n+        //\n+        // By then returning `Undetermined` we should continue resolution to\n+        // resolve the next attribute.\n         let attr_name = match path.segments.len() {\n             1 => path.segments[0].ident.name,\n             _ => return Err(determinacy),\n@@ -406,8 +422,8 @@ impl<'a> Resolver<'a> {\n                             attrs.push(inert_attr);\n                             attrs\n                         });\n+                        return Err(Determinacy::Undetermined)\n                     }\n-                    return Err(Determinacy::Undetermined);\n                 },\n                 Err(Determinacy::Undetermined) => determinacy = Determinacy::Undetermined,\n                 Err(Determinacy::Determined) => {}"}, {"sha": "4609f57bddfa44c2a620f866c4e6a09b1a802658", "filename": "src/test/run-pass-fulldeps/proc-macro/auxiliary/custom-attr-only-one-derive.rs", "status": "added", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/d334027c58060449cc45b8e5cc37dd51ca077d30/src%2Ftest%2Frun-pass-fulldeps%2Fproc-macro%2Fauxiliary%2Fcustom-attr-only-one-derive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d334027c58060449cc45b8e5cc37dd51ca077d30/src%2Ftest%2Frun-pass-fulldeps%2Fproc-macro%2Fauxiliary%2Fcustom-attr-only-one-derive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass-fulldeps%2Fproc-macro%2Fauxiliary%2Fcustom-attr-only-one-derive.rs?ref=d334027c58060449cc45b8e5cc37dd51ca077d30", "patch": "@@ -0,0 +1,27 @@\n+// Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// no-prefer-dynamic\n+\n+#![crate_type = \"proc-macro\"]\n+\n+extern crate proc_macro;\n+\n+use proc_macro::TokenStream;\n+\n+#[proc_macro_derive(Foo)]\n+pub fn foo(a: TokenStream) -> TokenStream {\n+    \"\".parse().unwrap()\n+}\n+\n+#[proc_macro_derive(Bar, attributes(custom))]\n+pub fn bar(a: TokenStream) -> TokenStream {\n+    \"\".parse().unwrap()\n+}"}, {"sha": "3b2833a4bcf756fae3545d0305a7efdd21d1b4d0", "filename": "src/test/run-pass-fulldeps/proc-macro/custom-attr-only-one-derive.rs", "status": "added", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/d334027c58060449cc45b8e5cc37dd51ca077d30/src%2Ftest%2Frun-pass-fulldeps%2Fproc-macro%2Fcustom-attr-only-one-derive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d334027c58060449cc45b8e5cc37dd51ca077d30/src%2Ftest%2Frun-pass-fulldeps%2Fproc-macro%2Fcustom-attr-only-one-derive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass-fulldeps%2Fproc-macro%2Fcustom-attr-only-one-derive.rs?ref=d334027c58060449cc45b8e5cc37dd51ca077d30", "patch": "@@ -0,0 +1,25 @@\n+// Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// aux-build:custom-attr-only-one-derive.rs\n+\n+#![feature(rust_2018_preview)]\n+\n+#[macro_use]\n+extern crate custom_attr_only_one_derive;\n+\n+#[derive(Bar, Foo)]\n+#[custom = \"test\"]\n+pub enum A {\n+    B,\n+    C,\n+}\n+\n+fn main() {}"}]}