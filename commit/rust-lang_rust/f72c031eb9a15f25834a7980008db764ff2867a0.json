{"sha": "f72c031eb9a15f25834a7980008db764ff2867a0", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY3MmMwMzFlYjlhMTVmMjU4MzRhNzk4MDAwOGRiNzY0ZmYyODY3YTA=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-01-10T10:04:04Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-01-10T10:04:04Z"}, "message": "implement RefUnwindSafe", "tree": {"sha": "a3560becba476775f18c996293d6d5892e7611f0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a3560becba476775f18c996293d6d5892e7611f0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f72c031eb9a15f25834a7980008db764ff2867a0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f72c031eb9a15f25834a7980008db764ff2867a0", "html_url": "https://github.com/rust-lang/rust/commit/f72c031eb9a15f25834a7980008db764ff2867a0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f72c031eb9a15f25834a7980008db764ff2867a0/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "64455ad701c8bce6e35793042f5e2ec177e12f7e", "url": "https://api.github.com/repos/rust-lang/rust/commits/64455ad701c8bce6e35793042f5e2ec177e12f7e", "html_url": "https://github.com/rust-lang/rust/commit/64455ad701c8bce6e35793042f5e2ec177e12f7e"}], "stats": {"total": 22, "additions": 16, "deletions": 6}, "files": [{"sha": "74e9d0e6ec211e7ea7101f638489e1269ee78e02", "filename": "Cargo.lock", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f72c031eb9a15f25834a7980008db764ff2867a0/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/f72c031eb9a15f25834a7980008db764ff2867a0/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=f72c031eb9a15f25834a7980008db764ff2867a0", "patch": "@@ -1024,7 +1024,7 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n [[package]]\n name = \"salsa\"\n version = \"0.9.1\"\n-source = \"git+https://github.com/matklad/salsa?branch=panic-hooks#add15d83eaa865571cd33e60b2eb611a366ca3ff\"\n+source = \"git+https://github.com/matklad/salsa?branch=panic-hooks#a17757bbaaadeed4839366745b848d66ac991cd0\"\n dependencies = [\n  \"derive-new 0.5.6 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"indexmap 1.0.2 (registry+https://github.com/rust-lang/crates.io-index)\","}, {"sha": "20e712afe3538ac40406410ad5816312f883e15e", "filename": "crates/ra_db/src/lib.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/f72c031eb9a15f25834a7980008db764ff2867a0/crates%2Fra_db%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f72c031eb9a15f25834a7980008db764ff2867a0/crates%2Fra_db%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_db%2Fsrc%2Flib.rs?ref=f72c031eb9a15f25834a7980008db764ff2867a0", "patch": "@@ -20,7 +20,7 @@ pub use crate::{\n     loc2id::LocationIntener,\n };\n \n-pub trait BaseDatabase: salsa::Database {\n+pub trait BaseDatabase: salsa::Database + panic::RefUnwindSafe {\n     fn check_canceled(&self) -> Cancelable<()> {\n         self.salsa_runtime()\n             .if_current_revision_is_canceled(Canceled::throw);\n@@ -31,8 +31,7 @@ pub trait BaseDatabase: salsa::Database {\n         &self,\n         f: F,\n     ) -> Result<T, Canceled> {\n-        let me = panic::AssertUnwindSafe(self);\n-        panic::catch_unwind(|| f(me.0)).map_err(|err| match err.downcast::<Canceled>() {\n+        panic::catch_unwind(|| f(self)).map_err(|err| match err.downcast::<Canceled>() {\n             Ok(canceled) => *canceled,\n             Err(payload) => panic::resume_unwind(payload),\n         })"}, {"sha": "359cd893d87bab19e040868ba1985f67571613da", "filename": "crates/ra_db/src/loc2id.rs", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/f72c031eb9a15f25834a7980008db764ff2867a0/crates%2Fra_db%2Fsrc%2Floc2id.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f72c031eb9a15f25834a7980008db764ff2867a0/crates%2Fra_db%2Fsrc%2Floc2id.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_db%2Fsrc%2Floc2id.rs?ref=f72c031eb9a15f25834a7980008db764ff2867a0", "patch": "@@ -1,4 +1,4 @@\n-use std::hash::Hash;\n+use std::{panic, hash::Hash};\n \n use parking_lot::Mutex;\n use rustc_hash::FxHashMap;\n@@ -70,6 +70,15 @@ where\n     map: Mutex<Loc2IdMap<LOC, ID>>,\n }\n \n+impl<LOC, ID> panic::RefUnwindSafe for LocationIntener<LOC, ID>\n+where\n+    ID: ArenaId + Clone,\n+    LOC: Clone + Eq + Hash,\n+    ID: panic::RefUnwindSafe,\n+    LOC: panic::RefUnwindSafe,\n+{\n+}\n+\n impl<LOC, ID> Default for LocationIntener<LOC, ID>\n where\n     ID: ArenaId + Clone,"}, {"sha": "7a0301648a68ba115d465c4bb6a0f3b355083dbd", "filename": "crates/ra_hir/src/mock.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/f72c031eb9a15f25834a7980008db764ff2867a0/crates%2Fra_hir%2Fsrc%2Fmock.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f72c031eb9a15f25834a7980008db764ff2867a0/crates%2Fra_hir%2Fsrc%2Fmock.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fmock.rs?ref=f72c031eb9a15f25834a7980008db764ff2867a0", "patch": "@@ -1,4 +1,4 @@\n-use std::sync::Arc;\n+use std::{sync::Arc, panic};\n \n use parking_lot::Mutex;\n use salsa::{self, Database};\n@@ -18,6 +18,8 @@ pub(crate) struct MockDatabase {\n     file_counter: u32,\n }\n \n+impl panic::RefUnwindSafe for MockDatabase {}\n+\n impl MockDatabase {\n     pub(crate) fn with_files(fixture: &str) -> (MockDatabase, SourceRoot) {\n         let (db, source_root, position) = MockDatabase::from_fixture(fixture);"}]}