{"sha": "3618c4e0d3127e6d6eab1b55fd88c353b8d3f6d7", "node_id": "MDY6Q29tbWl0NzI0NzEyOjM2MThjNGUwZDMxMjdlNmQ2ZWFiMWI1NWZkODhjMzUzYjhkM2Y2ZDc=", "commit": {"author": {"name": "vsrs", "email": "vit@conrlab.com", "date": "2021-01-23T13:56:20Z"}, "committer": {"name": "vsrs", "email": "vit@conrlab.com", "date": "2021-01-23T13:56:20Z"}, "message": "Add References code lens.\n\nFor Struct, Enum, Union and Trait symbols.", "tree": {"sha": "2cd8ac2cbce891db29a338f3a31a0b48b7958c0a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2cd8ac2cbce891db29a338f3a31a0b48b7958c0a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3618c4e0d3127e6d6eab1b55fd88c353b8d3f6d7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3618c4e0d3127e6d6eab1b55fd88c353b8d3f6d7", "html_url": "https://github.com/rust-lang/rust/commit/3618c4e0d3127e6d6eab1b55fd88c353b8d3f6d7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3618c4e0d3127e6d6eab1b55fd88c353b8d3f6d7/comments", "author": {"login": "vsrs", "id": 62505555, "node_id": "MDQ6VXNlcjYyNTA1NTU1", "avatar_url": "https://avatars.githubusercontent.com/u/62505555?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vsrs", "html_url": "https://github.com/vsrs", "followers_url": "https://api.github.com/users/vsrs/followers", "following_url": "https://api.github.com/users/vsrs/following{/other_user}", "gists_url": "https://api.github.com/users/vsrs/gists{/gist_id}", "starred_url": "https://api.github.com/users/vsrs/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vsrs/subscriptions", "organizations_url": "https://api.github.com/users/vsrs/orgs", "repos_url": "https://api.github.com/users/vsrs/repos", "events_url": "https://api.github.com/users/vsrs/events{/privacy}", "received_events_url": "https://api.github.com/users/vsrs/received_events", "type": "User", "site_admin": false}, "committer": {"login": "vsrs", "id": 62505555, "node_id": "MDQ6VXNlcjYyNTA1NTU1", "avatar_url": "https://avatars.githubusercontent.com/u/62505555?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vsrs", "html_url": "https://github.com/vsrs", "followers_url": "https://api.github.com/users/vsrs/followers", "following_url": "https://api.github.com/users/vsrs/following{/other_user}", "gists_url": "https://api.github.com/users/vsrs/gists{/gist_id}", "starred_url": "https://api.github.com/users/vsrs/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vsrs/subscriptions", "organizations_url": "https://api.github.com/users/vsrs/orgs", "repos_url": "https://api.github.com/users/vsrs/repos", "events_url": "https://api.github.com/users/vsrs/events{/privacy}", "received_events_url": "https://api.github.com/users/vsrs/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "fb2b9c7212b8a8ad88132473ea03cd6de20c85ab", "url": "https://api.github.com/repos/rust-lang/rust/commits/fb2b9c7212b8a8ad88132473ea03cd6de20c85ab", "html_url": "https://github.com/rust-lang/rust/commit/fb2b9c7212b8a8ad88132473ea03cd6de20c85ab"}], "stats": {"total": 85, "additions": 52, "deletions": 33}, "files": [{"sha": "247bfe71ef34fa2bb52c14a745b7ce317b2101a3", "filename": "crates/rust-analyzer/src/config.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/3618c4e0d3127e6d6eab1b55fd88c353b8d3f6d7/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3618c4e0d3127e6d6eab1b55fd88c353b8d3f6d7/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs?ref=3618c4e0d3127e6d6eab1b55fd88c353b8d3f6d7", "patch": "@@ -147,6 +147,9 @@ config_data! {\n         /// Whether to show `Method References` lens. Only applies when\n         /// `#rust-analyzer.lens.enable#` is set.\n         lens_methodReferences: bool = \"false\",\n+        /// Whether to show `References` lens. Only applies when\n+        /// `#rust-analyzer.lens.enable#` is set.\n+        lens_references: bool = \"false\",\n \n         /// Disable project auto-discovery in favor of explicitly specified set\n         /// of projects.\\n\\nElements must be paths pointing to `Cargo.toml`,\n@@ -221,6 +224,7 @@ pub struct LensConfig {\n     pub debug: bool,\n     pub implementations: bool,\n     pub method_refs: bool,\n+    pub refs: bool, // for Struct, Enum, Union and Trait\n }\n \n impl LensConfig {\n@@ -237,7 +241,7 @@ impl LensConfig {\n     }\n \n     pub fn references(&self) -> bool {\n-        self.method_refs\n+        self.method_refs || self.refs\n     }\n }\n \n@@ -593,6 +597,7 @@ impl Config {\n             debug: self.data.lens_enable && self.data.lens_debug,\n             implementations: self.data.lens_enable && self.data.lens_implementations,\n             method_refs: self.data.lens_enable && self.data.lens_methodReferences,\n+            refs: self.data.lens_enable && self.data.lens_references,\n         }\n     }\n     pub fn hover(&self) -> HoverConfig {"}, {"sha": "07204436c5b3e8d99d9abbcfae4d8ed0631bf915", "filename": "crates/rust-analyzer/src/handlers.rs", "status": "modified", "additions": 38, "deletions": 32, "changes": 70, "blob_url": "https://github.com/rust-lang/rust/blob/3618c4e0d3127e6d6eab1b55fd88c353b8d3f6d7/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3618c4e0d3127e6d6eab1b55fd88c353b8d3f6d7/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs?ref=3618c4e0d3127e6d6eab1b55fd88c353b8d3f6d7", "patch": "@@ -1112,42 +1112,48 @@ pub(crate) fn handle_code_lens(\n         }\n     }\n \n-    if lens_config.implementations {\n-        // Handle impls\n-        lenses.extend(\n-            snap.analysis\n-                .file_structure(file_id)?\n-                .into_iter()\n-                .filter(|it| {\n-                    matches!(\n-                        it.kind,\n-                        SymbolKind::Trait\n-                            | SymbolKind::Struct\n-                            | SymbolKind::Enum\n-                            | SymbolKind::Union\n-                    )\n-                })\n-                .map(|it| {\n-                    let range = to_proto::range(&line_index, it.node_range);\n-                    let pos = range.start;\n-                    let lens_params = lsp_types::request::GotoImplementationParams {\n-                        text_document_position_params: lsp_types::TextDocumentPositionParams::new(\n-                            params.text_document.clone(),\n-                            pos,\n-                        ),\n-                        work_done_progress_params: Default::default(),\n-                        partial_result_params: Default::default(),\n-                    };\n-                    CodeLens {\n+    if lens_config.implementations || lens_config.refs {\n+        snap.analysis\n+            .file_structure(file_id)?\n+            .into_iter()\n+            .filter(|it| {\n+                matches!(\n+                    it.kind,\n+                    SymbolKind::Trait | SymbolKind::Struct | SymbolKind::Enum | SymbolKind::Union\n+                )\n+            })\n+            .for_each(|it| {\n+                let range = to_proto::range(&line_index, it.node_range);\n+                let position = to_proto::position(&line_index, it.navigation_range.start());\n+                let doc_pos = lsp_types::TextDocumentPositionParams::new(\n+                    params.text_document.clone(),\n+                    position,\n+                );\n+                let goto_params = lsp_types::request::GotoImplementationParams {\n+                    text_document_position_params: doc_pos.clone(),\n+                    work_done_progress_params: Default::default(),\n+                    partial_result_params: Default::default(),\n+                };\n+\n+                if lens_config.implementations {\n+                    lenses.push(CodeLens {\n                         range,\n                         command: None,\n-                        data: Some(to_value(CodeLensResolveData::Impls(lens_params)).unwrap()),\n-                    }\n-                }),\n-        );\n+                        data: Some(to_value(CodeLensResolveData::Impls(goto_params)).unwrap()),\n+                    })\n+                }\n+\n+                if lens_config.refs {\n+                    lenses.push(CodeLens {\n+                        range,\n+                        command: None,\n+                        data: Some(to_value(CodeLensResolveData::References(doc_pos)).unwrap()),\n+                    })\n+                }\n+            });\n     }\n \n-    if lens_config.references() {\n+    if lens_config.method_refs {\n         lenses.extend(snap.analysis.find_all_methods(file_id)?.into_iter().map(|it| {\n             let range = to_proto::range(&line_index, it.range);\n             let position = to_proto::position(&line_index, it.range.start());"}, {"sha": "2f681b01aa8e1df48654e7524dabc1b13d54816e", "filename": "docs/user/generated_config.adoc", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/3618c4e0d3127e6d6eab1b55fd88c353b8d3f6d7/docs%2Fuser%2Fgenerated_config.adoc", "raw_url": "https://github.com/rust-lang/rust/raw/3618c4e0d3127e6d6eab1b55fd88c353b8d3f6d7/docs%2Fuser%2Fgenerated_config.adoc", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/docs%2Fuser%2Fgenerated_config.adoc?ref=3618c4e0d3127e6d6eab1b55fd88c353b8d3f6d7", "patch": "@@ -86,6 +86,8 @@\n  Whether to show `Run` lens. Only applies when  `#rust-analyzer.lens.enable#` is set.\n [[rust-analyzer.lens.methodReferences]]rust-analyzer.lens.methodReferences (default: `false`)::\n  Whether to show `Method References` lens. Only applies when  `#rust-analyzer.lens.enable#` is set.\n+[[rust-analyzer.lens.references]]rust-analyzer.lens.references (default: `false`)::\n+ Whether to show `References` lens. Only applies when  `#rust-analyzer.lens.enable#` is set.\n [[rust-analyzer.linkedProjects]]rust-analyzer.linkedProjects (default: `[]`)::\n  Disable project auto-discovery in favor of explicitly specified set  of projects.\\n\\nElements must be paths pointing to `Cargo.toml`,  `rust-project.json`, or JSON objects in `rust-project.json` format.\n [[rust-analyzer.lruCapacity]]rust-analyzer.lruCapacity (default: `null`)::"}, {"sha": "2225cf1ddb07a2029b5038b55369daa7c38dc03a", "filename": "editors/code/package.json", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/3618c4e0d3127e6d6eab1b55fd88c353b8d3f6d7/editors%2Fcode%2Fpackage.json", "raw_url": "https://github.com/rust-lang/rust/raw/3618c4e0d3127e6d6eab1b55fd88c353b8d3f6d7/editors%2Fcode%2Fpackage.json", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fpackage.json?ref=3618c4e0d3127e6d6eab1b55fd88c353b8d3f6d7", "patch": "@@ -633,6 +633,11 @@\n                     \"default\": false,\n                     \"type\": \"boolean\"\n                 },\n+                \"rust-analyzer.lens.references\": {\n+                    \"markdownDescription\": \"Whether to show `References` lens. Only applies when `#rust-analyzer.lens.enable#` is set.\",\n+                    \"default\": false,\n+                    \"type\": \"boolean\"\n+                },\n                 \"rust-analyzer.linkedProjects\": {\n                     \"markdownDescription\": \"Disable project auto-discovery in favor of explicitly specified set of projects.\\\\n\\\\nElements must be paths pointing to `Cargo.toml`, `rust-project.json`, or JSON objects in `rust-project.json` format.\",\n                     \"default\": [],"}, {"sha": "ddb5cfbd330e1a560d9fc4cbf5083fffc9bbc943", "filename": "editors/code/src/config.ts", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/3618c4e0d3127e6d6eab1b55fd88c353b8d3f6d7/editors%2Fcode%2Fsrc%2Fconfig.ts", "raw_url": "https://github.com/rust-lang/rust/raw/3618c4e0d3127e6d6eab1b55fd88c353b8d3f6d7/editors%2Fcode%2Fsrc%2Fconfig.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fconfig.ts?ref=3618c4e0d3127e6d6eab1b55fd88c353b8d3f6d7", "patch": "@@ -144,6 +144,7 @@ export class Config {\n             debug: this.get<boolean>(\"lens.debug\"),\n             implementations: this.get<boolean>(\"lens.implementations\"),\n             methodReferences: this.get<boolean>(\"lens.methodReferences\"),\n+            references: this.get<boolean>(\"lens.references\"),\n         };\n     }\n "}]}