{"sha": "d9afca58081e09c7dd9fa5c874810e05dce18d49", "node_id": "C_kwDOAAsO6NoAKGQ5YWZjYTU4MDgxZTA5YzdkZDlmYTVjODc0ODEwZTA1ZGNlMThkNDk", "commit": {"author": {"name": "Jacob Hoffman-Andrews", "email": "github@hoffman-andrews.com", "date": "2021-11-24T05:23:54Z"}, "committer": {"name": "Jacob Hoffman-Andrews", "email": "github@hoffman-andrews.com", "date": "2021-11-25T03:41:48Z"}, "message": "Consistentize the system for image URLs in CSS.", "tree": {"sha": "cfa694426beca251eecfc1d7c6834b124a8afb39", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/cfa694426beca251eecfc1d7c6834b124a8afb39"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d9afca58081e09c7dd9fa5c874810e05dce18d49", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d9afca58081e09c7dd9fa5c874810e05dce18d49", "html_url": "https://github.com/rust-lang/rust/commit/d9afca58081e09c7dd9fa5c874810e05dce18d49", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d9afca58081e09c7dd9fa5c874810e05dce18d49/comments", "author": {"login": "jsha", "id": 220205, "node_id": "MDQ6VXNlcjIyMDIwNQ==", "avatar_url": "https://avatars.githubusercontent.com/u/220205?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jsha", "html_url": "https://github.com/jsha", "followers_url": "https://api.github.com/users/jsha/followers", "following_url": "https://api.github.com/users/jsha/following{/other_user}", "gists_url": "https://api.github.com/users/jsha/gists{/gist_id}", "starred_url": "https://api.github.com/users/jsha/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jsha/subscriptions", "organizations_url": "https://api.github.com/users/jsha/orgs", "repos_url": "https://api.github.com/users/jsha/repos", "events_url": "https://api.github.com/users/jsha/events{/privacy}", "received_events_url": "https://api.github.com/users/jsha/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jsha", "id": 220205, "node_id": "MDQ6VXNlcjIyMDIwNQ==", "avatar_url": "https://avatars.githubusercontent.com/u/220205?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jsha", "html_url": "https://github.com/jsha", "followers_url": "https://api.github.com/users/jsha/followers", "following_url": "https://api.github.com/users/jsha/following{/other_user}", "gists_url": "https://api.github.com/users/jsha/gists{/gist_id}", "starred_url": "https://api.github.com/users/jsha/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jsha/subscriptions", "organizations_url": "https://api.github.com/users/jsha/orgs", "repos_url": "https://api.github.com/users/jsha/repos", "events_url": "https://api.github.com/users/jsha/events{/privacy}", "received_events_url": "https://api.github.com/users/jsha/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f0683f98fa114cc4f9e795031f44be3eebb65790", "url": "https://api.github.com/repos/rust-lang/rust/commits/f0683f98fa114cc4f9e795031f44be3eebb65790", "html_url": "https://github.com/rust-lang/rust/commit/f0683f98fa114cc4f9e795031f44be3eebb65790"}], "stats": {"total": 73, "additions": 36, "deletions": 37}, "files": [{"sha": "3d3fa3aaeaa519f803fac82b7377d1fb6fa030d5", "filename": "src/librustdoc/html/layout.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/d9afca58081e09c7dd9fa5c874810e05dce18d49/src%2Flibrustdoc%2Fhtml%2Flayout.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9afca58081e09c7dd9fa5c874810e05dce18d49/src%2Flibrustdoc%2Fhtml%2Flayout.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Flayout.rs?ref=d9afca58081e09c7dd9fa5c874810e05dce18d49", "patch": "@@ -67,11 +67,12 @@ crate fn render<T: Print, S: Print>(\n ) -> String {\n     let static_root_path = page.get_static_root_path();\n     let krate_with_trailing_slash = ensure_trailing_slash(&layout.krate).to_string();\n-    let themes = style_files\n+    let mut themes: Vec<String> = style_files\n         .iter()\n         .map(StylePath::basename)\n         .collect::<Result<_, Error>>()\n         .unwrap_or_default();\n+    themes.sort();\n     let rustdoc_version = rustc_interface::util::version_str().unwrap_or(\"unknown version\");\n     let content = Buffer::html().to_display(t); // Note: This must happen before making the sidebar.\n     let sidebar = Buffer::html().to_display(sidebar);"}, {"sha": "0d5ba8e80d2429464ca2a1e842b8cc38de524558", "filename": "src/librustdoc/html/render/write_shared.rs", "status": "modified", "additions": 20, "deletions": 28, "changes": 48, "blob_url": "https://github.com/rust-lang/rust/blob/d9afca58081e09c7dd9fa5c874810e05dce18d49/src%2Flibrustdoc%2Fhtml%2Frender%2Fwrite_shared.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9afca58081e09c7dd9fa5c874810e05dce18d49/src%2Flibrustdoc%2Fhtml%2Frender%2Fwrite_shared.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fwrite_shared.rs?ref=d9afca58081e09c7dd9fa5c874810e05dce18d49", "patch": "@@ -181,42 +181,34 @@ pub(super) fn write_shared(\n         cx.write_shared(SharedResource::InvocationSpecific { basename: p }, content, &options.emit)\n     };\n \n-    fn add_background_image_to_css(\n-        cx: &Context<'_>,\n-        css: &mut String,\n-        rule: &str,\n-        file: &'static str,\n-    ) {\n-        css.push_str(&format!(\n-            \"{} {{ background-image: url({}); }}\",\n-            rule,\n-            SharedResource::ToolchainSpecific { basename: file }\n+    // Given \"foo.svg\", return e.g. \"url(\\\"foo1.58.0.svg\\\")\"\n+    fn ver_url(cx: &Context<'_>, basename: &'static str) -> String {\n+        format!(\n+            \"url(\\\"{}\\\")\",\n+            SharedResource::ToolchainSpecific { basename }\n                 .path(cx)\n                 .file_name()\n                 .unwrap()\n                 .to_str()\n                 .unwrap()\n-        ))\n+        )\n     }\n \n-    // Add all the static files. These may already exist, but we just\n-    // overwrite them anyway to make sure that they're fresh and up-to-date.\n-    let mut rustdoc_css = static_files::RUSTDOC_CSS.to_owned();\n-    add_background_image_to_css(\n-        cx,\n-        &mut rustdoc_css,\n-        \"details.undocumented[open] > summary::before, \\\n-         details.rustdoc-toggle[open] > summary::before, \\\n-         details.rustdoc-toggle[open] > summary.hideme::before\",\n-        \"toggle-minus.svg\",\n-    );\n-    add_background_image_to_css(\n+    // We use the AUTOREPLACE mechanism to inject into our static JS and CSS certain\n+    // values that are only known at doc build time. Since this mechanism is somewhat\n+    // surprising when reading the code, please limit it to rustdoc.css.\n+    write_minify(\n+        \"rustdoc.css\",\n+        static_files::RUSTDOC_CSS\n+            .replace(\n+                \"/* AUTOREPLACE: */url(\\\"toggle-minus.svg\\\")\",\n+                &ver_url(cx, \"toggle-minus.svg\"),\n+            )\n+            .replace(\"/* AUTOREPLACE: */url(\\\"toggle-plus.svg\\\")\", &ver_url(cx, \"toggle-plus.svg\"))\n+            .replace(\"/* AUTOREPLACE: */url(\\\"down-arrow.svg\\\")\", &ver_url(cx, \"down-arrow.svg\")),\n         cx,\n-        &mut rustdoc_css,\n-        \"details.undocumented > summary::before, details.rustdoc-toggle > summary::before\",\n-        \"toggle-plus.svg\",\n-    );\n-    write_minify(\"rustdoc.css\", rustdoc_css, cx, options)?;\n+        options,\n+    )?;\n \n     // Add all the static files. These may already exist, but we just\n     // overwrite them anyway to make sure that they're fresh and up-to-date."}, {"sha": "61ab502a8503d08d1ac75836130ad6fdc48d94ba", "filename": "src/librustdoc/html/static/css/rustdoc.css", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/d9afca58081e09c7dd9fa5c874810e05dce18d49/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Frustdoc.css", "raw_url": "https://github.com/rust-lang/rust/raw/d9afca58081e09c7dd9fa5c874810e05dce18d49/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Frustdoc.css", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Frustdoc.css?ref=d9afca58081e09c7dd9fa5c874810e05dce18d49", "patch": "@@ -824,6 +824,7 @@ h2.small-section-header > .anchor {\n \tbackground-color: transparent;\n \tbackground-size: 20px;\n \tbackground-position: calc(100% - 1px) 56%;\n+\tbackground-image: /* AUTOREPLACE: */url(\"down-arrow.svg\");\n }\n .search-container > .top-button {\n \tposition: absolute;\n@@ -1604,6 +1605,16 @@ details.rustdoc-toggle[open] > summary.hideme > span {\n \tdisplay: none;\n }\n \n+details.undocumented[open] > summary::before,\n+details.rustdoc-toggle[open] > summary::before,\n+details.rustdoc-toggle[open] > summary.hideme::before {\n+\tbackground-image: /* AUTOREPLACE: */url(\"toggle-minus.svg\");\n+}\n+\n+details.undocumented > summary::before, details.rustdoc-toggle > summary::before {\n+\tbackground-image: /* AUTOREPLACE: */url(\"toggle-plus.svg\");\n+}\n+\n details.rustdoc-toggle[open] > summary::before,\n details.rustdoc-toggle[open] > summary.hideme::before {\n \twidth: 17px;"}, {"sha": "5661d4973342f034c207b2b9beb725b934fdd80e", "filename": "src/librustdoc/html/static/js/main.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/d9afca58081e09c7dd9fa5c874810e05dce18d49/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fmain.js", "raw_url": "https://github.com/rust-lang/rust/raw/d9afca58081e09c7dd9fa5c874810e05dce18d49/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fmain.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fmain.js?ref=d9afca58081e09c7dd9fa5c874810e05dce18d49", "patch": "@@ -58,8 +58,8 @@ function resourcePath(basename, extension) {\n (function () {\n     window.rootPath = getVar(\"root-path\");\n     window.currentCrate = getVar(\"current-crate\");\n-    window.searchJS =  resourcePath(\"search\", \"js\");\n-    window.searchIndexJS = resourcePath(\"search-index\", \"js\");\n+    window.searchJS =  resourcePath(\"search\", \".js\");\n+    window.searchIndexJS = resourcePath(\"search-index\", \".js\");\n     var sidebarVars = document.getElementById(\"sidebar-vars\");\n     if (sidebarVars) {\n         window.sidebarCurrent = {"}, {"sha": "2a783c6da57e4f67713d58b01a78cb1bf4f1a28a", "filename": "src/librustdoc/html/templates/page.html", "status": "modified", "additions": 0, "deletions": 5, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/d9afca58081e09c7dd9fa5c874810e05dce18d49/src%2Flibrustdoc%2Fhtml%2Ftemplates%2Fpage.html", "raw_url": "https://github.com/rust-lang/rust/raw/d9afca58081e09c7dd9fa5c874810e05dce18d49/src%2Flibrustdoc%2Fhtml%2Ftemplates%2Fpage.html", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Ftemplates%2Fpage.html?ref=d9afca58081e09c7dd9fa5c874810e05dce18d49", "patch": "@@ -58,11 +58,6 @@\n             href=\"{{static_root_path | safe}}favicon{{page.resource_suffix}}.svg\"> {#- -#}\n     {%- endif -%}\n     {{- layout.external_html.in_header | safe -}}\n-    <style type=\"text/css\"> {#- -#}\n-    #crate-search{ {#- -#}\n-        background-image:url(\"{{static_root_path | safe}}down-arrow{{page.resource_suffix}}.svg\"); {#- -#}\n-    } {#- -#}\n-    </style> {#- -#}\n </head> {#- -#}\n <body class=\"rustdoc {{page.css_class}}\"> {#- -#}\n     <!--[if lte IE 11]> {#- -#}"}, {"sha": "f1d49b9fcb20ae98d5eea6d56731d4cc870dd1f0", "filename": "src/test/rustdoc/static-root-path.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d9afca58081e09c7dd9fa5c874810e05dce18d49/src%2Ftest%2Frustdoc%2Fstatic-root-path.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9afca58081e09c7dd9fa5c874810e05dce18d49/src%2Ftest%2Frustdoc%2Fstatic-root-path.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fstatic-root-path.rs?ref=d9afca58081e09c7dd9fa5c874810e05dce18d49", "patch": "@@ -3,7 +3,7 @@\n // @has static_root_path/struct.SomeStruct.html\n // @matches - '\"/cache/main\\.js\"'\n // @!matches - '\"\\.\\./main\\.js\"'\n-// @matches - '\"\\.\\./search-index\\.js\"'\n+// @matches - 'data-root-path=\"\\.\\./\"'\n // @!matches - '\"/cache/search-index\\.js\"'\n pub struct SomeStruct;\n "}]}