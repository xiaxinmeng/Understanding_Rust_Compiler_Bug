{"sha": "4ba57aa703397a34e92f055c9e07bc880b771226", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRiYTU3YWE3MDMzOTdhMzRlOTJmMDU1YzllMDdiYzg4MGI3NzEyMjY=", "commit": {"author": {"name": "Aaron Hill", "email": "aa1ronham@gmail.com", "date": "2020-10-29T15:37:55Z"}, "committer": {"name": "Aaron Hill", "email": "aa1ronham@gmail.com", "date": "2020-10-29T15:39:38Z"}, "message": "Strip tokens from trait and impl items before printing AST JSON\n\nFixes #78510", "tree": {"sha": "534ab1ad48edaaa1e574a1b0bcd0d8ee9878475e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/534ab1ad48edaaa1e574a1b0bcd0d8ee9878475e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4ba57aa703397a34e92f055c9e07bc880b771226", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE7J9Gc3TfBwj2K399tAh+UQ6YsWQFAl+a4jsACgkQtAh+UQ6Y\nsWS3uw//Wqv5UAex/KSIDbVl0kfzedSWmpaVuZ17Gq7D5EO9v6ixkBqJaRfis6eH\n0qPY52rj90yWwlZIcmSzTRwgyrpsxF2M3tM7zryMTzvbHMZzQ4NQmelCtGH0aIia\nvkiaIzgHOVTDc9z1jJGZ0Cr8UXL7G2y6YBtjDpcwPWAlSedC2y5RuPs3fYYUCI5e\nOSoBITa73fvo9396VNmhR8U9xD4xYg8qjQS60Z391lgyOLj8qHDsRUNW4NtwTyAD\nNfibxY4A/XU6tNY1ItKQvh4LsnrrwsQRZV0j70SQ3qdJKG5Fi4wZzFxC0pILxf5w\n6rpXlu29/JRDOnpYAfO+KN+VBG1nFVKwA8bcbIFycUERZuFfpC3ZHVwnHHxdpvd4\ntAMUZsvi3G+/6DGa0kG8kVdcXPMZHpDj6THayLeHcsPKy6JRmMOU1hS3iKCf6g9V\n9pFIUbgyJpa9ZJ8VsiFsDKp5RNg15SecoowcvNvdAb+LZ5/cYFpAx/fJhVpuUF0R\n9zoBsi1/IwBEeZtWydYvea6YIMYvbMQp8Yl8a3YUqKuzWnCzq0I7A+1zsxI//FJB\n2s0Ajm/iQldH/myGcslU+8gpjXbF4OIaxksL/ayUBxXFzuPBsdCoLuZLjeIZnmSU\n/qYp+vYgeq54lMiZLH92XIRwsp4kNIfm1QbdwsH4JEy0ja2oIYY=\n=QkoE\n-----END PGP SIGNATURE-----", "payload": "tree 534ab1ad48edaaa1e574a1b0bcd0d8ee9878475e\nparent a53fb30e3bf2655b0563da6d561c23cda5f3ec11\nauthor Aaron Hill <aa1ronham@gmail.com> 1603985875 -0400\ncommitter Aaron Hill <aa1ronham@gmail.com> 1603985978 -0400\n\nStrip tokens from trait and impl items before printing AST JSON\n\nFixes #78510\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4ba57aa703397a34e92f055c9e07bc880b771226", "html_url": "https://github.com/rust-lang/rust/commit/4ba57aa703397a34e92f055c9e07bc880b771226", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4ba57aa703397a34e92f055c9e07bc880b771226/comments", "author": {"login": "Aaron1011", "id": 1408859, "node_id": "MDQ6VXNlcjE0MDg4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1408859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Aaron1011", "html_url": "https://github.com/Aaron1011", "followers_url": "https://api.github.com/users/Aaron1011/followers", "following_url": "https://api.github.com/users/Aaron1011/following{/other_user}", "gists_url": "https://api.github.com/users/Aaron1011/gists{/gist_id}", "starred_url": "https://api.github.com/users/Aaron1011/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Aaron1011/subscriptions", "organizations_url": "https://api.github.com/users/Aaron1011/orgs", "repos_url": "https://api.github.com/users/Aaron1011/repos", "events_url": "https://api.github.com/users/Aaron1011/events{/privacy}", "received_events_url": "https://api.github.com/users/Aaron1011/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Aaron1011", "id": 1408859, "node_id": "MDQ6VXNlcjE0MDg4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1408859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Aaron1011", "html_url": "https://github.com/Aaron1011", "followers_url": "https://api.github.com/users/Aaron1011/followers", "following_url": "https://api.github.com/users/Aaron1011/following{/other_user}", "gists_url": "https://api.github.com/users/Aaron1011/gists{/gist_id}", "starred_url": "https://api.github.com/users/Aaron1011/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Aaron1011/subscriptions", "organizations_url": "https://api.github.com/users/Aaron1011/orgs", "repos_url": "https://api.github.com/users/Aaron1011/repos", "events_url": "https://api.github.com/users/Aaron1011/events{/privacy}", "received_events_url": "https://api.github.com/users/Aaron1011/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a53fb30e3bf2655b0563da6d561c23cda5f3ec11", "url": "https://api.github.com/repos/rust-lang/rust/commits/a53fb30e3bf2655b0563da6d561c23cda5f3ec11", "html_url": "https://github.com/rust-lang/rust/commit/a53fb30e3bf2655b0563da6d561c23cda5f3ec11"}], "stats": {"total": 45, "additions": 45, "deletions": 0}, "files": [{"sha": "a1487aa0060d5fe08000d8863f2874928dd842b1", "filename": "compiler/rustc_interface/src/passes.rs", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/4ba57aa703397a34e92f055c9e07bc880b771226/compiler%2Frustc_interface%2Fsrc%2Fpasses.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4ba57aa703397a34e92f055c9e07bc880b771226/compiler%2Frustc_interface%2Fsrc%2Fpasses.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_interface%2Fsrc%2Fpasses.rs?ref=4ba57aa703397a34e92f055c9e07bc880b771226", "patch": "@@ -70,6 +70,17 @@ impl mut_visit::MutVisitor for TokenStripper {\n         i.tokens = None;\n         mut_visit::noop_flat_map_foreign_item(i, self)\n     }\n+    fn flat_map_trait_item(\n+        &mut self,\n+        mut i: P<ast::AssocItem>,\n+    ) -> SmallVec<[P<ast::AssocItem>; 1]> {\n+        i.tokens = None;\n+        mut_visit::noop_flat_map_assoc_item(i, self)\n+    }\n+    fn flat_map_impl_item(&mut self, mut i: P<ast::AssocItem>) -> SmallVec<[P<ast::AssocItem>; 1]> {\n+        i.tokens = None;\n+        mut_visit::noop_flat_map_assoc_item(i, self)\n+    }\n     fn visit_block(&mut self, b: &mut P<ast::Block>) {\n         b.tokens = None;\n         mut_visit::noop_visit_block(b, self);"}, {"sha": "ef3117c49cad3d2d62f7e2e91d0b4617daa5976b", "filename": "src/test/ui/ast-json/issue-78510-assoc-ice.rs", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/4ba57aa703397a34e92f055c9e07bc880b771226/src%2Ftest%2Fui%2Fast-json%2Fissue-78510-assoc-ice.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4ba57aa703397a34e92f055c9e07bc880b771226/src%2Ftest%2Fui%2Fast-json%2Fissue-78510-assoc-ice.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fast-json%2Fissue-78510-assoc-ice.rs?ref=4ba57aa703397a34e92f055c9e07bc880b771226", "patch": "@@ -0,0 +1,18 @@\n+// compile-flags: -Zast-json\n+//\n+// Regression test for issue #78510\n+// Tests that we don't ICE when we have tokens for an associated item\n+\n+struct S;\n+\n+impl S {\n+    #[derive(Debug)] //~ ERROR `derive` may only be applied to structs, enums and unions\n+    fn f() {}\n+}\n+\n+trait Bar {\n+    #[derive(Debug)] //~ ERROR `derive` may only be applied to structs, enums and unions\n+    fn foo() {}\n+}\n+\n+fn main() {}"}, {"sha": "3573c203a789309f6e28a01dd0853c9d7249a55a", "filename": "src/test/ui/ast-json/issue-78510-assoc-ice.stderr", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/4ba57aa703397a34e92f055c9e07bc880b771226/src%2Ftest%2Fui%2Fast-json%2Fissue-78510-assoc-ice.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/4ba57aa703397a34e92f055c9e07bc880b771226/src%2Ftest%2Fui%2Fast-json%2Fissue-78510-assoc-ice.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fast-json%2Fissue-78510-assoc-ice.stderr?ref=4ba57aa703397a34e92f055c9e07bc880b771226", "patch": "@@ -0,0 +1,15 @@\n+error[E0774]: `derive` may only be applied to structs, enums and unions\n+  --> $DIR/issue-78510-assoc-ice.rs:9:5\n+   |\n+LL |     #[derive(Debug)]\n+   |     ^^^^^^^^^^^^^^^^\n+\n+error[E0774]: `derive` may only be applied to structs, enums and unions\n+  --> $DIR/issue-78510-assoc-ice.rs:14:5\n+   |\n+LL |     #[derive(Debug)]\n+   |     ^^^^^^^^^^^^^^^^\n+\n+error: aborting due to 2 previous errors\n+\n+For more information about this error, try `rustc --explain E0774`."}, {"sha": "fef9504285b530dec83f0ff48e6a91f4c6decd84", "filename": "src/test/ui/ast-json/issue-78510-assoc-ice.stdout", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/4ba57aa703397a34e92f055c9e07bc880b771226/src%2Ftest%2Fui%2Fast-json%2Fissue-78510-assoc-ice.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/4ba57aa703397a34e92f055c9e07bc880b771226/src%2Ftest%2Fui%2Fast-json%2Fissue-78510-assoc-ice.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fast-json%2Fissue-78510-assoc-ice.stdout?ref=4ba57aa703397a34e92f055c9e07bc880b771226", "patch": "@@ -0,0 +1 @@\n+{\"module\":{\"inner\":{\"lo\":139,\"hi\":397},\"unsafety\":\"No\",\"items\":[{\"attrs\":[{\"kind\":{\"variant\":\"Normal\",\"fields\":[{\"path\":{\"span\":{\"lo\":0,\"hi\":0},\"segments\":[{\"ident\":{\"name\":\"prelude_import\",\"span\":{\"lo\":0,\"hi\":0}},\"id\":3,\"args\":null}],\"tokens\":null},\"args\":\"Empty\",\"tokens\":null}]},\"id\":null,\"style\":\"Outer\",\"span\":{\"lo\":0,\"hi\":0},\"tokens\":null}],\"id\":4,\"span\":{\"lo\":0,\"hi\":0},\"vis\":{\"kind\":\"Inherited\",\"span\":{\"lo\":0,\"hi\":0},\"tokens\":null},\"ident\":{\"name\":\"\",\"span\":{\"lo\":0,\"hi\":0}},\"kind\":{\"variant\":\"Use\",\"fields\":[{\"prefix\":{\"span\":{\"lo\":0,\"hi\":0},\"segments\":[{\"ident\":{\"name\":\"{{root}}\",\"span\":{\"lo\":0,\"hi\":0}},\"id\":5,\"args\":null},{\"ident\":{\"name\":\"std\",\"span\":{\"lo\":0,\"hi\":0}},\"id\":6,\"args\":null},{\"ident\":{\"name\":\"prelude\",\"span\":{\"lo\":0,\"hi\":0}},\"id\":7,\"args\":null},{\"ident\":{\"name\":\"v1\",\"span\":{\"lo\":0,\"hi\":0}},\"id\":8,\"args\":null}],\"tokens\":null},\"kind\":\"Glob\",\"span\":{\"lo\":0,\"hi\":0}}]},\"tokens\":null},{\"attrs\":[{\"kind\":{\"variant\":\"Normal\",\"fields\":[{\"path\":{\"span\":{\"lo\":0,\"hi\":0},\"segments\":[{\"ident\":{\"name\":\"macro_use\",\"span\":{\"lo\":0,\"hi\":0}},\"id\":9,\"args\":null}],\"tokens\":null},\"args\":\"Empty\",\"tokens\":null}]},\"id\":null,\"style\":\"Outer\",\"span\":{\"lo\":0,\"hi\":0},\"tokens\":null}],\"id\":10,\"span\":{\"lo\":0,\"hi\":0},\"vis\":{\"kind\":\"Inherited\",\"span\":{\"lo\":0,\"hi\":0},\"tokens\":null},\"ident\":{\"name\":\"std\",\"span\":{\"lo\":0,\"hi\":0}},\"kind\":{\"variant\":\"ExternCrate\",\"fields\":[null]},\"tokens\":null},{\"attrs\":[],\"id\":11,\"span\":{\"lo\":139,\"hi\":148},\"vis\":{\"kind\":\"Inherited\",\"span\":{\"lo\":139,\"hi\":139},\"tokens\":null},\"ident\":{\"name\":\"S\",\"span\":{\"lo\":146,\"hi\":147}},\"kind\":{\"variant\":\"Struct\",\"fields\":[{\"variant\":\"Unit\",\"fields\":[12]},{\"params\":[],\"where_clause\":{\"has_where_token\":false,\"predicates\":[],\"span\":{\"lo\":147,\"hi\":147}},\"span\":{\"lo\":147,\"hi\":147}}]},\"tokens\":null},{\"attrs\":[],\"id\":13,\"span\":{\"lo\":150,\"hi\":263},\"vis\":{\"kind\":\"Inherited\",\"span\":{\"lo\":150,\"hi\":150},\"tokens\":null},\"ident\":{\"name\":\"\",\"span\":{\"lo\":0,\"hi\":0}},\"kind\":{\"variant\":\"Impl\",\"fields\":[\"No\",\"Positive\",\"Final\",\"No\",{\"params\":[],\"where_clause\":{\"has_where_token\":false,\"predicates\":[],\"span\":{\"lo\":156,\"hi\":156}},\"span\":{\"lo\":154,\"hi\":154}},null,{\"id\":14,\"kind\":{\"variant\":\"Path\",\"fields\":[null,{\"span\":{\"lo\":155,\"hi\":156},\"segments\":[{\"ident\":{\"name\":\"S\",\"span\":{\"lo\":155,\"hi\":156}},\"id\":15,\"args\":null}],\"tokens\":null}]},\"span\":{\"lo\":155,\"hi\":156},\"tokens\":null},[{\"attrs\":[],\"id\":19,\"span\":{\"lo\":252,\"hi\":261},\"vis\":{\"kind\":\"Inherited\",\"span\":{\"lo\":252,\"hi\":252},\"tokens\":null},\"ident\":{\"name\":\"f\",\"span\":{\"lo\":255,\"hi\":256}},\"kind\":{\"variant\":\"Fn\",\"fields\":[\"Final\",{\"header\":{\"unsafety\":\"No\",\"asyncness\":\"No\",\"constness\":\"No\",\"ext\":\"None\"},\"decl\":{\"inputs\":[],\"output\":{\"variant\":\"Default\",\"fields\":[{\"lo\":259,\"hi\":259}]}},\"span\":{\"lo\":252,\"hi\":258}},{\"params\":[],\"where_clause\":{\"has_where_token\":false,\"predicates\":[],\"span\":{\"lo\":258,\"hi\":258}},\"span\":{\"lo\":256,\"hi\":256}},{\"stmts\":[],\"id\":20,\"rules\":\"Default\",\"span\":{\"lo\":259,\"hi\":261},\"tokens\":null}]},\"tokens\":null}]]},\"tokens\":null},{\"attrs\":[],\"id\":16,\"span\":{\"lo\":265,\"hi\":383},\"vis\":{\"kind\":\"Inherited\",\"span\":{\"lo\":265,\"hi\":265},\"tokens\":null},\"ident\":{\"name\":\"Bar\",\"span\":{\"lo\":271,\"hi\":274}},\"kind\":{\"variant\":\"Trait\",\"fields\":[\"No\",\"No\",{\"params\":[],\"where_clause\":{\"has_where_token\":false,\"predicates\":[],\"span\":{\"lo\":274,\"hi\":274}},\"span\":{\"lo\":274,\"hi\":274}},[],[{\"attrs\":[],\"id\":21,\"span\":{\"lo\":370,\"hi\":381},\"vis\":{\"kind\":\"Inherited\",\"span\":{\"lo\":370,\"hi\":370},\"tokens\":null},\"ident\":{\"name\":\"foo\",\"span\":{\"lo\":373,\"hi\":376}},\"kind\":{\"variant\":\"Fn\",\"fields\":[\"Final\",{\"header\":{\"unsafety\":\"No\",\"asyncness\":\"No\",\"constness\":\"No\",\"ext\":\"None\"},\"decl\":{\"inputs\":[],\"output\":{\"variant\":\"Default\",\"fields\":[{\"lo\":379,\"hi\":379}]}},\"span\":{\"lo\":370,\"hi\":378}},{\"params\":[],\"where_clause\":{\"has_where_token\":false,\"predicates\":[],\"span\":{\"lo\":378,\"hi\":378}},\"span\":{\"lo\":376,\"hi\":376}},{\"stmts\":[],\"id\":22,\"rules\":\"Default\",\"span\":{\"lo\":379,\"hi\":381},\"tokens\":null}]},\"tokens\":null}]]},\"tokens\":null},{\"attrs\":[],\"id\":17,\"span\":{\"lo\":385,\"hi\":397},\"vis\":{\"kind\":\"Inherited\",\"span\":{\"lo\":385,\"hi\":385},\"tokens\":null},\"ident\":{\"name\":\"main\",\"span\":{\"lo\":388,\"hi\":392}},\"kind\":{\"variant\":\"Fn\",\"fields\":[\"Final\",{\"header\":{\"unsafety\":\"No\",\"asyncness\":\"No\",\"constness\":\"No\",\"ext\":\"None\"},\"decl\":{\"inputs\":[],\"output\":{\"variant\":\"Default\",\"fields\":[{\"lo\":395,\"hi\":395}]}},\"span\":{\"lo\":385,\"hi\":394}},{\"params\":[],\"where_clause\":{\"has_where_token\":false,\"predicates\":[],\"span\":{\"lo\":394,\"hi\":394}},\"span\":{\"lo\":392,\"hi\":392}},{\"stmts\":[],\"id\":18,\"rules\":\"Default\",\"span\":{\"lo\":395,\"hi\":397},\"tokens\":null}]},\"tokens\":null}],\"inline\":true},\"attrs\":[],\"span\":{\"lo\":139,\"hi\":397},\"proc_macros\":[]}"}]}