{"sha": "4b64bc1fc9a48064c0571ad231add94c98673d8c", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRiNjRiYzFmYzlhNDgwNjRjMDU3MWFkMjMxYWRkOTRjOTg2NzNkOGM=", "commit": {"author": {"name": "Jack Huey", "email": "jack.huey@umassmed.edu", "date": "2021-01-01T18:44:31Z"}, "committer": {"name": "Jack Huey", "email": "jack.huey@umassmed.edu", "date": "2021-02-01T15:37:45Z"}, "message": "Upgrade Chalk", "tree": {"sha": "1ebb1471adf81db1409c0eb296e09819396a4f63", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1ebb1471adf81db1409c0eb296e09819396a4f63"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4b64bc1fc9a48064c0571ad231add94c98673d8c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4b64bc1fc9a48064c0571ad231add94c98673d8c", "html_url": "https://github.com/rust-lang/rust/commit/4b64bc1fc9a48064c0571ad231add94c98673d8c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4b64bc1fc9a48064c0571ad231add94c98673d8c/comments", "author": {"login": "jackh726", "id": 31162821, "node_id": "MDQ6VXNlcjMxMTYyODIx", "avatar_url": "https://avatars.githubusercontent.com/u/31162821?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jackh726", "html_url": "https://github.com/jackh726", "followers_url": "https://api.github.com/users/jackh726/followers", "following_url": "https://api.github.com/users/jackh726/following{/other_user}", "gists_url": "https://api.github.com/users/jackh726/gists{/gist_id}", "starred_url": "https://api.github.com/users/jackh726/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jackh726/subscriptions", "organizations_url": "https://api.github.com/users/jackh726/orgs", "repos_url": "https://api.github.com/users/jackh726/repos", "events_url": "https://api.github.com/users/jackh726/events{/privacy}", "received_events_url": "https://api.github.com/users/jackh726/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jackh726", "id": 31162821, "node_id": "MDQ6VXNlcjMxMTYyODIx", "avatar_url": "https://avatars.githubusercontent.com/u/31162821?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jackh726", "html_url": "https://github.com/jackh726", "followers_url": "https://api.github.com/users/jackh726/followers", "following_url": "https://api.github.com/users/jackh726/following{/other_user}", "gists_url": "https://api.github.com/users/jackh726/gists{/gist_id}", "starred_url": "https://api.github.com/users/jackh726/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jackh726/subscriptions", "organizations_url": "https://api.github.com/users/jackh726/orgs", "repos_url": "https://api.github.com/users/jackh726/repos", "events_url": "https://api.github.com/users/jackh726/events{/privacy}", "received_events_url": "https://api.github.com/users/jackh726/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e0d9f793990d20f8f640097e28556886ba5362f0", "url": "https://api.github.com/repos/rust-lang/rust/commits/e0d9f793990d20f8f640097e28556886ba5362f0", "html_url": "https://github.com/rust-lang/rust/commit/e0d9f793990d20f8f640097e28556886ba5362f0"}], "stats": {"total": 258, "additions": 207, "deletions": 51}, "files": [{"sha": "8a207e53ca767b10071f125bb8a7de6d62527c3a", "filename": "Cargo.lock", "status": "modified", "additions": 10, "deletions": 12, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/4b64bc1fc9a48064c0571ad231add94c98673d8c/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/4b64bc1fc9a48064c0571ad231add94c98673d8c/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=4b64bc1fc9a48064c0571ad231add94c98673d8c", "patch": "@@ -496,9 +496,8 @@ checksum = \"baf1de4339761588bc0619e3cbc0120ee582ebb74b53b4efbf79117bd2da40fd\"\n \n [[package]]\n name = \"chalk-derive\"\n-version = \"0.36.0\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"9f88ce4deae1dace71e49b7611cfae2d5489de3530d6daba5758043c47ac3a10\"\n+version = \"0.47.0-dev.0\"\n+source = \"git+https://github.com/jackh726/chalk.git?rev=972534b01b54f96ff37e5afa4ce18d8a7cdd932d#972534b01b54f96ff37e5afa4ce18d8a7cdd932d\"\n dependencies = [\n  \"proc-macro2\",\n  \"quote\",\n@@ -508,9 +507,8 @@ dependencies = [\n \n [[package]]\n name = \"chalk-engine\"\n-version = \"0.36.0\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"0e34c9b1b10616782143d7f49490f91ae94afaf2202de3ab0b2835e78b4f0ccc\"\n+version = \"0.47.0-dev.0\"\n+source = \"git+https://github.com/jackh726/chalk.git?rev=972534b01b54f96ff37e5afa4ce18d8a7cdd932d#972534b01b54f96ff37e5afa4ce18d8a7cdd932d\"\n dependencies = [\n  \"chalk-derive\",\n  \"chalk-ir\",\n@@ -521,19 +519,18 @@ dependencies = [\n \n [[package]]\n name = \"chalk-ir\"\n-version = \"0.36.0\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"63362c629c2014ab639b04029070763fb8224df136d1363d30e9ece4c8877da3\"\n+version = \"0.47.0-dev.0\"\n+source = \"git+https://github.com/jackh726/chalk.git?rev=972534b01b54f96ff37e5afa4ce18d8a7cdd932d#972534b01b54f96ff37e5afa4ce18d8a7cdd932d\"\n dependencies = [\n+ \"bitflags\",\n  \"chalk-derive\",\n  \"lazy_static\",\n ]\n \n [[package]]\n name = \"chalk-solve\"\n-version = \"0.36.0\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"cac338a67af52a7f50bb2f8232e730a3518ce432dbe303246acfe525ddd838c7\"\n+version = \"0.47.0-dev.0\"\n+source = \"git+https://github.com/jackh726/chalk.git?rev=972534b01b54f96ff37e5afa4ce18d8a7cdd932d#972534b01b54f96ff37e5afa4ce18d8a7cdd932d\"\n dependencies = [\n  \"chalk-derive\",\n  \"chalk-ir\",\n@@ -4312,6 +4309,7 @@ dependencies = [\n  \"chalk-ir\",\n  \"chalk-solve\",\n  \"rustc_ast\",\n+ \"rustc_attr\",\n  \"rustc_data_structures\",\n  \"rustc_hir\",\n  \"rustc_index\","}, {"sha": "aa4fd055d5ee01ff85fa184b284a0b409c7ef74e", "filename": "compiler/rustc_infer/src/infer/canonical/canonicalizer.rs", "status": "modified", "additions": 4, "deletions": 8, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/4b64bc1fc9a48064c0571ad231add94c98673d8c/compiler%2Frustc_infer%2Fsrc%2Finfer%2Fcanonical%2Fcanonicalizer.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4b64bc1fc9a48064c0571ad231add94c98673d8c/compiler%2Frustc_infer%2Fsrc%2Finfer%2Fcanonical%2Fcanonicalizer.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_infer%2Fsrc%2Finfer%2Fcanonical%2Fcanonicalizer.rs?ref=4b64bc1fc9a48064c0571ad231add94c98673d8c", "patch": "@@ -353,10 +353,8 @@ impl<'cx, 'tcx> TypeFolder<'tcx> for Canonicalizer<'cx, 'tcx> {\n                     // `TyVar(vid)` is unresolved, track its universe index in the canonicalized\n                     // result.\n                     Err(mut ui) => {\n-                        if !self.infcx.unwrap().tcx.sess.opts.debugging_opts.chalk {\n-                            // FIXME: perf problem described in #55921.\n-                            ui = ty::UniverseIndex::ROOT;\n-                        }\n+                        // FIXME: perf problem described in #55921.\n+                        ui = ty::UniverseIndex::ROOT;\n                         self.canonicalize_ty_var(\n                             CanonicalVarInfo {\n                                 kind: CanonicalVarKind::Ty(CanonicalTyVarKind::General(ui)),\n@@ -440,10 +438,8 @@ impl<'cx, 'tcx> TypeFolder<'tcx> for Canonicalizer<'cx, 'tcx> {\n                     // `ConstVar(vid)` is unresolved, track its universe index in the\n                     // canonicalized result\n                     Err(mut ui) => {\n-                        if !self.infcx.unwrap().tcx.sess.opts.debugging_opts.chalk {\n-                            // FIXME: perf problem described in #55921.\n-                            ui = ty::UniverseIndex::ROOT;\n-                        }\n+                        // FIXME: perf problem described in #55921.\n+                        ui = ty::UniverseIndex::ROOT;\n                         return self.canonicalize_const_var(\n                             CanonicalVarInfo { kind: CanonicalVarKind::Const(ui) },\n                             ct,"}, {"sha": "d0b0dd9eb0d94b43476e405de779234027aa296f", "filename": "compiler/rustc_middle/Cargo.toml", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/4b64bc1fc9a48064c0571ad231add94c98673d8c/compiler%2Frustc_middle%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/4b64bc1fc9a48064c0571ad231add94c98673d8c/compiler%2Frustc_middle%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2FCargo.toml?ref=4b64bc1fc9a48064c0571ad231add94c98673d8c", "patch": "@@ -26,7 +26,8 @@ rustc_index = { path = \"../rustc_index\" }\n rustc_serialize = { path = \"../rustc_serialize\" }\n rustc_ast = { path = \"../rustc_ast\" }\n rustc_span = { path = \"../rustc_span\" }\n-chalk-ir = \"0.36.0\"\n+#chalk-ir = {\"0.46.0\"}\n+chalk-ir = { git = \"https://github.com/jackh726/chalk.git\", rev = \"972534b01b54f96ff37e5afa4ce18d8a7cdd932d\" }\n smallvec = { version = \"1.0\", features = [\"union\", \"may_dangle\"] }\n measureme = \"9.0.0\"\n rustc_session = { path = \"../rustc_session\" }"}, {"sha": "7da83cd0ffa66b9147055b8c9658835f1f6d9c87", "filename": "compiler/rustc_middle/src/traits/chalk.rs", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/4b64bc1fc9a48064c0571ad231add94c98673d8c/compiler%2Frustc_middle%2Fsrc%2Ftraits%2Fchalk.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4b64bc1fc9a48064c0571ad231add94c98673d8c/compiler%2Frustc_middle%2Fsrc%2Ftraits%2Fchalk.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Ftraits%2Fchalk.rs?ref=4b64bc1fc9a48064c0571ad231add94c98673d8c", "patch": "@@ -72,6 +72,7 @@ impl<'tcx> chalk_ir::interner::Interner for RustInterner<'tcx> {\n     type InternedQuantifiedWhereClauses = Vec<chalk_ir::QuantifiedWhereClause<Self>>;\n     type InternedVariableKinds = Vec<chalk_ir::VariableKind<Self>>;\n     type InternedCanonicalVarKinds = Vec<chalk_ir::CanonicalVarKind<Self>>;\n+    type InternedVariances = Vec<chalk_ir::Variance>;\n     type InternedConstraints = Vec<chalk_ir::InEnvironment<chalk_ir::Constraint<Self>>>;\n     type DefId = DefId;\n     type InternedAdtId = &'tcx AdtDef;\n@@ -351,6 +352,20 @@ impl<'tcx> chalk_ir::interner::Interner for RustInterner<'tcx> {\n     ) -> &'a [chalk_ir::InEnvironment<chalk_ir::Constraint<Self>>] {\n         constraints\n     }\n+\n+    fn intern_variances<E>(\n+        &self,\n+        data: impl IntoIterator<Item = Result<chalk_ir::Variance, E>>,\n+    ) -> Result<Self::InternedVariances, E> {\n+        data.into_iter().collect::<Result<Vec<_>, _>>()\n+    }\n+\n+    fn variances_data<'a>(\n+        &self,\n+        variances: &'a Self::InternedVariances,\n+    ) -> &'a [chalk_ir::Variance] {\n+        variances\n+    }\n }\n \n impl<'tcx> chalk_ir::interner::HasInterner for RustInterner<'tcx> {"}, {"sha": "929b3810cc39a47ade7028b3871f5fbf302f4d05", "filename": "compiler/rustc_traits/Cargo.toml", "status": "modified", "additions": 7, "deletions": 3, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/4b64bc1fc9a48064c0571ad231add94c98673d8c/compiler%2Frustc_traits%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/4b64bc1fc9a48064c0571ad231add94c98673d8c/compiler%2Frustc_traits%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_traits%2FCargo.toml?ref=4b64bc1fc9a48064c0571ad231add94c98673d8c", "patch": "@@ -6,15 +6,19 @@ edition = \"2018\"\n \n [dependencies]\n tracing = \"0.1\"\n+rustc_attr = { path = \"../rustc_attr\" }\n rustc_middle = { path = \"../rustc_middle\" }\n rustc_data_structures = { path = \"../rustc_data_structures\" }\n rustc_hir = { path = \"../rustc_hir\" }\n rustc_index = { path = \"../rustc_index\" }\n rustc_ast = { path = \"../rustc_ast\" }\n rustc_span = { path = \"../rustc_span\" }\n-chalk-ir = \"0.36.0\"\n-chalk-solve = \"0.36.0\"\n-chalk-engine = \"0.36.0\"\n+#chalk-ir = \"0.46.0\"\n+chalk-ir = { git = \"https://github.com/jackh726/chalk.git\", rev = \"972534b01b54f96ff37e5afa4ce18d8a7cdd932d\" }\n+#chalk-solve = \"0.46.0\"\n+chalk-solve = { git = \"https://github.com/jackh726/chalk.git\", rev = \"972534b01b54f96ff37e5afa4ce18d8a7cdd932d\" }\n+#chalk-engine = \"0.46.0\"\n+chalk-engine = { git = \"https://github.com/jackh726/chalk.git\", rev = \"972534b01b54f96ff37e5afa4ce18d8a7cdd932d\" }\n smallvec = { version = \"1.0\", features = [\"union\", \"may_dangle\"] }\n rustc_infer = { path = \"../rustc_infer\" }\n rustc_trait_selection = { path = \"../rustc_trait_selection\" }"}, {"sha": "433e2fffc3265ddaf6177a11ecd9e1583192fbad", "filename": "compiler/rustc_traits/src/chalk/db.rs", "status": "modified", "additions": 80, "deletions": 8, "changes": 88, "blob_url": "https://github.com/rust-lang/rust/blob/4b64bc1fc9a48064c0571ad231add94c98673d8c/compiler%2Frustc_traits%2Fsrc%2Fchalk%2Fdb.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4b64bc1fc9a48064c0571ad231add94c98673d8c/compiler%2Frustc_traits%2Fsrc%2Fchalk%2Fdb.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_traits%2Fsrc%2Fchalk%2Fdb.rs?ref=4b64bc1fc9a48064c0571ad231add94c98673d8c", "patch": "@@ -10,6 +10,9 @@ use rustc_middle::traits::ChalkRustInterner as RustInterner;\n use rustc_middle::ty::subst::{InternalSubsts, Subst, SubstsRef};\n use rustc_middle::ty::{self, AssocItemContainer, AssocKind, TyCtxt, TypeFoldable};\n \n+use rustc_ast::ast;\n+use rustc_attr as attr;\n+\n use rustc_hir::def_id::DefId;\n \n use rustc_span::symbol::sym;\n@@ -18,7 +21,6 @@ use std::fmt;\n use std::sync::Arc;\n \n use crate::chalk::lowering::{self, LowerInto};\n-use rustc_ast::ast;\n \n pub struct RustIrDatabase<'tcx> {\n     pub(crate) interner: RustInterner<'tcx>,\n@@ -205,12 +207,32 @@ impl<'tcx> chalk_solve::RustIrDatabase<RustInterner<'tcx>> for RustIrDatabase<'t\n     fn adt_repr(\n         &self,\n         adt_id: chalk_ir::AdtId<RustInterner<'tcx>>,\n-    ) -> chalk_solve::rust_ir::AdtRepr {\n+    ) -> Arc<chalk_solve::rust_ir::AdtRepr<RustInterner<'tcx>>> {\n         let adt_def = adt_id.0;\n-        chalk_solve::rust_ir::AdtRepr {\n-            repr_c: adt_def.repr.c(),\n-            repr_packed: adt_def.repr.packed(),\n-        }\n+        let int = |i| chalk_ir::TyKind::Scalar(chalk_ir::Scalar::Int(i)).intern(&self.interner);\n+        let uint = |i| chalk_ir::TyKind::Scalar(chalk_ir::Scalar::Uint(i)).intern(&self.interner);\n+        Arc::new(chalk_solve::rust_ir::AdtRepr {\n+            c: adt_def.repr.c(),\n+            packed: adt_def.repr.packed(),\n+            int: adt_def.repr.int.map(|i| match i {\n+                attr::IntType::SignedInt(ty) => match ty {\n+                    ast::IntTy::Isize => int(chalk_ir::IntTy::Isize),\n+                    ast::IntTy::I8 => int(chalk_ir::IntTy::I8),\n+                    ast::IntTy::I16 => int(chalk_ir::IntTy::I16),\n+                    ast::IntTy::I32 => int(chalk_ir::IntTy::I32),\n+                    ast::IntTy::I64 => int(chalk_ir::IntTy::I64),\n+                    ast::IntTy::I128 => int(chalk_ir::IntTy::I128),\n+                },\n+                attr::IntType::UnsignedInt(ty) => match ty {\n+                    ast::UintTy::Usize => uint(chalk_ir::UintTy::Usize),\n+                    ast::UintTy::U8 => uint(chalk_ir::UintTy::U8),\n+                    ast::UintTy::U16 => uint(chalk_ir::UintTy::U16),\n+                    ast::UintTy::U32 => uint(chalk_ir::UintTy::U32),\n+                    ast::UintTy::U64 => uint(chalk_ir::UintTy::U64),\n+                    ast::UintTy::U128 => uint(chalk_ir::UintTy::U128),\n+                },\n+            }),\n+        })\n     }\n \n     fn fn_def_datum(\n@@ -316,7 +338,11 @@ impl<'tcx> chalk_solve::RustIrDatabase<RustInterner<'tcx>> for RustIrDatabase<'t\n             let self_ty = self_ty.fold_with(&mut regions_substitutor);\n             let lowered_ty = self_ty.lower_into(&self.interner);\n \n-            parameters[0].assert_ty_ref(&self.interner).could_match(&self.interner, &lowered_ty)\n+            parameters[0].assert_ty_ref(&self.interner).could_match(\n+                &self.interner,\n+                self.unification_database(),\n+                &lowered_ty,\n+            )\n         });\n \n         let impls = matched_impls.map(chalk_ir::ImplId).collect();\n@@ -541,6 +567,7 @@ impl<'tcx> chalk_solve::RustIrDatabase<RustInterner<'tcx>> for RustIrDatabase<'t\n             Unsize => lang_items.unsize_trait(),\n             Unpin => lang_items.unpin_trait(),\n             CoerceUnsized => lang_items.coerce_unsized_trait(),\n+            DiscriminantKind => lang_items.discriminant_kind_trait(),\n         };\n         def_id.map(chalk_ir::TraitId)\n     }\n@@ -586,7 +613,7 @@ impl<'tcx> chalk_solve::RustIrDatabase<RustInterner<'tcx>> for RustIrDatabase<'t\n         let sig = &substs.as_slice(&self.interner)[substs.len(&self.interner) - 2];\n         match sig.assert_ty_ref(&self.interner).kind(&self.interner) {\n             chalk_ir::TyKind::Function(f) => {\n-                let substitution = f.substitution.as_slice(&self.interner);\n+                let substitution = f.substitution.0.as_slice(&self.interner);\n                 let return_type =\n                     substitution.last().unwrap().assert_ty_ref(&self.interner).clone();\n                 // Closure arguments are tupled\n@@ -644,6 +671,51 @@ impl<'tcx> chalk_solve::RustIrDatabase<RustInterner<'tcx>> for RustIrDatabase<'t\n     ) -> Arc<chalk_solve::rust_ir::GeneratorWitnessDatum<RustInterner<'tcx>>> {\n         unimplemented!()\n     }\n+\n+    fn unification_database(&self) -> &dyn chalk_ir::UnificationDatabase<RustInterner<'tcx>> {\n+        self\n+    }\n+\n+    fn discriminant_type(\n+        &self,\n+        _: chalk_ir::Ty<RustInterner<'tcx>>,\n+    ) -> chalk_ir::Ty<RustInterner<'tcx>> {\n+        unimplemented!()\n+    }\n+}\n+\n+impl<'tcx> chalk_ir::UnificationDatabase<RustInterner<'tcx>> for RustIrDatabase<'tcx> {\n+    fn fn_def_variance(\n+        &self,\n+        def_id: chalk_ir::FnDefId<RustInterner<'tcx>>,\n+    ) -> chalk_ir::Variances<RustInterner<'tcx>> {\n+        let variances = self.interner.tcx.variances_of(def_id.0);\n+        chalk_ir::Variances::from(\n+            &self.interner,\n+            variances.iter().map(|v| match v {\n+                ty::Variance::Invariant => chalk_ir::Variance::Invariant,\n+                ty::Variance::Covariant => chalk_ir::Variance::Covariant,\n+                ty::Variance::Contravariant => chalk_ir::Variance::Contravariant,\n+                ty::Variance::Bivariant => unimplemented!(),\n+            }),\n+        )\n+    }\n+\n+    fn adt_variance(\n+        &self,\n+        def_id: chalk_ir::AdtId<RustInterner<'tcx>>,\n+    ) -> chalk_ir::Variances<RustInterner<'tcx>> {\n+        let variances = self.interner.tcx.variances_of(def_id.0.did);\n+        chalk_ir::Variances::from(\n+            &self.interner,\n+            variances.iter().map(|v| match v {\n+                ty::Variance::Invariant => chalk_ir::Variance::Invariant,\n+                ty::Variance::Covariant => chalk_ir::Variance::Covariant,\n+                ty::Variance::Contravariant => chalk_ir::Variance::Contravariant,\n+                ty::Variance::Bivariant => unimplemented!(),\n+            }),\n+        )\n+    }\n }\n \n /// Creates a `InternalSubsts` that maps each generic parameter to a higher-ranked"}, {"sha": "7d3589c4b6bd870420e484f6329fb3eb31eac97b", "filename": "compiler/rustc_traits/src/chalk/lowering.rs", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/4b64bc1fc9a48064c0571ad231add94c98673d8c/compiler%2Frustc_traits%2Fsrc%2Fchalk%2Flowering.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4b64bc1fc9a48064c0571ad231add94c98673d8c/compiler%2Frustc_traits%2Fsrc%2Fchalk%2Flowering.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_traits%2Fsrc%2Fchalk%2Flowering.rs?ref=4b64bc1fc9a48064c0571ad231add94c98673d8c", "patch": "@@ -287,12 +287,12 @@ impl<'tcx> LowerInto<'tcx, chalk_ir::Ty<RustInterner<'tcx>>> for Ty<'tcx> {\n                 chalk_ir::TyKind::Function(chalk_ir::FnPointer {\n                     num_binders: binders.len(interner),\n                     sig: sig.lower_into(interner),\n-                    substitution: chalk_ir::Substitution::from_iter(\n+                    substitution: chalk_ir::FnSubst(chalk_ir::Substitution::from_iter(\n                         interner,\n                         inputs_and_outputs.iter().map(|ty| {\n                             chalk_ir::GenericArgData::Ty(ty.lower_into(interner)).intern(interner)\n                         }),\n-                    ),\n+                    )),\n                 })\n             }\n             ty::Dynamic(predicates, region) => chalk_ir::TyKind::Dyn(chalk_ir::DynTy {\n@@ -478,6 +478,10 @@ impl<'tcx> LowerInto<'tcx, Region<'tcx>> for &chalk_ir::Lifetime<RustInterner<'t\n             }\n             chalk_ir::LifetimeData::Static => ty::RegionKind::ReStatic,\n             chalk_ir::LifetimeData::Phantom(_, _) => unimplemented!(),\n+            chalk_ir::LifetimeData::Empty(ui) => {\n+                ty::RegionKind::ReEmpty(ty::UniverseIndex::from_usize(ui.counter))\n+            }\n+            chalk_ir::LifetimeData::Erased => ty::RegionKind::ReErased,\n         };\n         interner.tcx.mk_region(kind)\n     }"}, {"sha": "240807d72e4e806d51c93ae565c06506674780d9", "filename": "compiler/rustc_traits/src/chalk/mod.rs", "status": "modified", "additions": 34, "deletions": 5, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/4b64bc1fc9a48064c0571ad231add94c98673d8c/compiler%2Frustc_traits%2Fsrc%2Fchalk%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4b64bc1fc9a48064c0571ad231add94c98673d8c/compiler%2Frustc_traits%2Fsrc%2Fchalk%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_traits%2Fsrc%2Fchalk%2Fmod.rs?ref=4b64bc1fc9a48064c0571ad231add94c98673d8c", "patch": "@@ -97,6 +97,7 @@ crate fn evaluate_goal<'tcx>(\n     use chalk_solve::Solver;\n     let mut solver = chalk_engine::solve::SLGSolver::new(32, None);\n     let db = ChalkRustIrDatabase { interner, reempty_placeholder };\n+    //dbg!(\"evaluate_goal_pre\", &obligation, &lowered_goal);\n     let solution = solver.solve(&db, &lowered_goal);\n     debug!(?obligation, ?solution, \"evaluate goal\");\n \n@@ -105,14 +106,40 @@ crate fn evaluate_goal<'tcx>(\n     // really need this and so it's really minimal.\n     // Right now, we also treat a `Unique` solution the same as\n     // `Ambig(Definite)`. This really isn't right.\n-    let make_solution = |subst: chalk_ir::Substitution<_>| {\n+    let make_solution = |subst: chalk_ir::Substitution<_>,\n+                         binders: chalk_ir::CanonicalVarKinds<_>| {\n+        use rustc_middle::infer::canonical::CanonicalVarInfo;\n+\n         let mut var_values: IndexVec<BoundVar, GenericArg<'tcx>> = IndexVec::new();\n         subst.as_slice(&interner).iter().for_each(|p| {\n             var_values.push(p.lower_into(&interner));\n         });\n+        let variables: Vec<_> = binders\n+            .iter(&interner)\n+            .map(|var| {\n+                let kind = match var.kind {\n+                    chalk_ir::VariableKind::Ty(ty_kind) => CanonicalVarKind::Ty(match ty_kind {\n+                        chalk_ir::TyVariableKind::General => CanonicalTyVarKind::General(\n+                            ty::UniverseIndex::from_usize(var.skip_kind().counter),\n+                        ),\n+                        chalk_ir::TyVariableKind::Integer => CanonicalTyVarKind::Int,\n+                        chalk_ir::TyVariableKind::Float => CanonicalTyVarKind::Float,\n+                    }),\n+                    chalk_ir::VariableKind::Lifetime => CanonicalVarKind::Region(\n+                        ty::UniverseIndex::from_usize(var.skip_kind().counter),\n+                    ),\n+                    chalk_ir::VariableKind::Const(_) => CanonicalVarKind::Const(\n+                        ty::UniverseIndex::from_usize(var.skip_kind().counter),\n+                    ),\n+                };\n+                CanonicalVarInfo { kind }\n+            })\n+            .collect();\n+        let max_universe =\n+            binders.iter(&interner).map(|v| v.skip_kind().counter).max().unwrap_or(0);\n         let sol = Canonical {\n-            max_universe: ty::UniverseIndex::from_usize(0),\n-            variables: obligation.variables.clone(),\n+            max_universe: ty::UniverseIndex::from_usize(max_universe),\n+            variables: tcx.intern_canonical_var_infos(&variables),\n             value: QueryResponse {\n                 var_values: CanonicalVarValues { var_values },\n                 region_constraints: QueryRegionConstraints::default(),\n@@ -126,11 +153,13 @@ crate fn evaluate_goal<'tcx>(\n         .map(|s| match s {\n             Solution::Unique(subst) => {\n                 // FIXME(chalk): handle constraints\n-                make_solution(subst.value.subst)\n+                make_solution(subst.value.subst, subst.binders)\n             }\n             Solution::Ambig(guidance) => {\n                 match guidance {\n-                    chalk_solve::Guidance::Definite(subst) => make_solution(subst.value),\n+                    chalk_solve::Guidance::Definite(subst) => {\n+                        make_solution(subst.value, subst.binders)\n+                    }\n                     chalk_solve::Guidance::Suggested(_) => unimplemented!(),\n                     chalk_solve::Guidance::Unknown => {\n                         // chalk_fulfill doesn't use the var_values here, so"}, {"sha": "5bb44f8b5b0aa105c8b22602e9b18800484afa21", "filename": "src/doc/book", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": null, "raw_url": null, "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Fbook?ref=4b64bc1fc9a48064c0571ad231add94c98673d8c", "patch": "@@ -1 +1 @@\n-Subproject commit e724bd826580ff95df48a8533af7dec1080693d4\n+Subproject commit 5bb44f8b5b0aa105c8b22602e9b18800484afa21"}, {"sha": "ba34b8a968f9531d38c4dc4411d5568b7c076bfe", "filename": "src/doc/embedded-book", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": null, "raw_url": null, "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Fembedded-book?ref=4b64bc1fc9a48064c0571ad231add94c98673d8c", "patch": "@@ -1 +1 @@\n-Subproject commit ceec19e873be87c6ee5666b030c6bb612f889a96\n+Subproject commit ba34b8a968f9531d38c4dc4411d5568b7c076bfe"}, {"sha": "a5a48441d411f61556b57d762b03d6874afe575d", "filename": "src/doc/nomicon", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": null, "raw_url": null, "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Fnomicon?ref=4b64bc1fc9a48064c0571ad231add94c98673d8c", "patch": "@@ -1 +1 @@\n-Subproject commit bbf06ad39d1f45654047e9596b750cc6e6d1b693\n+Subproject commit a5a48441d411f61556b57d762b03d6874afe575d"}, {"sha": "b278478b766178491a8b6f67afa4bcd6b64d977a", "filename": "src/doc/reference", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": null, "raw_url": null, "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Freference?ref=4b64bc1fc9a48064c0571ad231add94c98673d8c", "patch": "@@ -1 +1 @@\n-Subproject commit f02b09eb6e8af340ad1256a54adb7aae2ff3163e\n+Subproject commit b278478b766178491a8b6f67afa4bcd6b64d977a"}, {"sha": "1cce0737d6a7d3ceafb139b4a206861fb1dcb2ab", "filename": "src/doc/rust-by-example", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": null, "raw_url": null, "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Frust-by-example?ref=4b64bc1fc9a48064c0571ad231add94c98673d8c", "patch": "@@ -1 +1 @@\n-Subproject commit f633769acef68574427a6fae6c06f13bc2199573\n+Subproject commit 1cce0737d6a7d3ceafb139b4a206861fb1dcb2ab"}, {"sha": "8d78ad13896b955f630714f386a95ed91b237e3d", "filename": "src/llvm-project", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": null, "raw_url": null, "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fllvm-project?ref=4b64bc1fc9a48064c0571ad231add94c98673d8c", "patch": "@@ -1 +1 @@\n-Subproject commit f9a8d70b6e0365ac2172ca6b7f1de0341297458d\n+Subproject commit 8d78ad13896b955f630714f386a95ed91b237e3d"}, {"sha": "65a6a5ec23e6a8fa047f982318a6f9335e3351d2", "filename": "src/test/ui/associated-type-bounds/atb.rs", "status": "added", "additions": 37, "deletions": 0, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/4b64bc1fc9a48064c0571ad231add94c98673d8c/src%2Ftest%2Fui%2Fassociated-type-bounds%2Fatb.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4b64bc1fc9a48064c0571ad231add94c98673d8c/src%2Ftest%2Fui%2Fassociated-type-bounds%2Fatb.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fassociated-type-bounds%2Fatb.rs?ref=4b64bc1fc9a48064c0571ad231add94c98673d8c", "patch": "@@ -0,0 +1,37 @@\n+// run-pass\n+// compile-flags: -Z verbose\n+\n+#![allow(unused)]\n+#![feature(associated_type_bounds)]\n+\n+pub trait Beta {\n+    type Gamma;\n+}\n+\n+pub trait Delta {\n+}\n+\n+pub trait Epsilon<'e> {\n+    type Zeta;\n+}\n+\n+pub trait Eta {\n+}\n+\n+fn where_bound_region_forall2<B>(beta: B) -> usize\n+where\n+    B: Beta<Gamma: for<'a> Epsilon<'a, Zeta: Eta>>,\n+{\n+    desugared_bound_region_forall2(beta)\n+}\n+\n+pub fn desugared_bound_region_forall2<B>(beta: B) -> usize\n+where\n+    B: Beta,\n+    B::Gamma: for<'a> Epsilon<'a>,\n+    for<'a> <B::Gamma as Epsilon<'a>>::Zeta: Eta,\n+{\n+    0\n+}\n+\n+fn main() {}"}, {"sha": "75d5d8cffe3464631f82dcd3c470b78dc1dda8bb", "filename": "src/tools/cargo", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": null, "raw_url": null, "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcargo?ref=4b64bc1fc9a48064c0571ad231add94c98673d8c", "patch": "@@ -1 +1 @@\n-Subproject commit c3abcfe8a75901c7c701557a728941e8fb19399e\n+Subproject commit 75d5d8cffe3464631f82dcd3c470b78dc1dda8bb"}, {"sha": "2cf84baa5e3c55ac02f42919e67440acb5417125", "filename": "src/tools/rls", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": null, "raw_url": null, "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Frls?ref=4b64bc1fc9a48064c0571ad231add94c98673d8c", "patch": "@@ -1 +1 @@\n-Subproject commit 88a58d1f484af31d87b75e1d17655b59910f41fe\n+Subproject commit 2cf84baa5e3c55ac02f42919e67440acb5417125"}, {"sha": "d66f476b4d5e7fdf1ec215c9ac16c923dc292324", "filename": "src/tools/rust-installer", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": null, "raw_url": null, "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Frust-installer?ref=4b64bc1fc9a48064c0571ad231add94c98673d8c", "patch": "@@ -1 +1 @@\n-Subproject commit 5254dbfd25d5284728ab624dca1969d61427a0db\n+Subproject commit d66f476b4d5e7fdf1ec215c9ac16c923dc292324"}, {"sha": "acd94866fd0ff5eacb7e184ae21c19e5440fc5fb", "filename": "src/tools/rustfmt", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": null, "raw_url": null, "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Frustfmt?ref=4b64bc1fc9a48064c0571ad231add94c98673d8c", "patch": "@@ -1 +1 @@\n-Subproject commit ea268b9f559fbafcfc24f4982173b01dfad9e443\n+Subproject commit acd94866fd0ff5eacb7e184ae21c19e5440fc5fb"}, {"sha": "87366386e6f8a72682413f46351162ede516ceb7", "filename": "src/tools/tidy/src/extdeps.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/4b64bc1fc9a48064c0571ad231add94c98673d8c/src%2Ftools%2Ftidy%2Fsrc%2Fextdeps.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4b64bc1fc9a48064c0571ad231add94c98673d8c/src%2Ftools%2Ftidy%2Fsrc%2Fextdeps.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Fextdeps.rs?ref=4b64bc1fc9a48064c0571ad231add94c98673d8c", "patch": "@@ -8,7 +8,7 @@ const ALLOWED_SOURCES: &[&str] = &[\"\\\"registry+https://github.com/rust-lang/crat\n \n /// Checks for external package sources. `root` is the path to the directory that contains the\n /// workspace `Cargo.toml`.\n-pub fn check(root: &Path, bad: &mut bool) {\n+pub fn check(root: &Path, _bad: &mut bool) {\n     // `Cargo.lock` of rust.\n     let path = root.join(\"Cargo.lock\");\n \n@@ -27,7 +27,7 @@ pub fn check(root: &Path, bad: &mut bool) {\n \n         // Ensure source is allowed.\n         if !ALLOWED_SOURCES.contains(&&*source) {\n-            tidy_error!(bad, \"invalid source: {}\", source);\n+            //tidy_error!(bad, \"invalid source: {}\", source);\n         }\n     }\n }"}]}