{"sha": "47e8b80e9b67d5012fbc860a7763975e99fdf28d", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQ3ZThiODBlOWI2N2Q1MDEyZmJjODYwYTc3NjM5NzVlOTlmZGYyOGQ=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2018-09-05T18:38:43Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2018-09-05T18:38:43Z"}, "message": "use correct workdir for the server", "tree": {"sha": "c7ed6488dd900c7d949cc0861c97c53b58e7becf", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c7ed6488dd900c7d949cc0861c97c53b58e7becf"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/47e8b80e9b67d5012fbc860a7763975e99fdf28d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/47e8b80e9b67d5012fbc860a7763975e99fdf28d", "html_url": "https://github.com/rust-lang/rust/commit/47e8b80e9b67d5012fbc860a7763975e99fdf28d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/47e8b80e9b67d5012fbc860a7763975e99fdf28d/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "529ebd5840b9f94c3105df3b2dc5419ff4d2a533", "url": "https://api.github.com/repos/rust-lang/rust/commits/529ebd5840b9f94c3105df3b2dc5419ff4d2a533", "html_url": "https://github.com/rust-lang/rust/commit/529ebd5840b9f94c3105df3b2dc5419ff4d2a533"}], "stats": {"total": 29, "additions": 19, "deletions": 10}, "files": [{"sha": "baca921dfc88420776102dc2e80d5be7f05453c2", "filename": "crates/gen_lsp_server/src/lib.rs", "status": "modified", "additions": 12, "deletions": 8, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/47e8b80e9b67d5012fbc860a7763975e99fdf28d/crates%2Fgen_lsp_server%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/47e8b80e9b67d5012fbc860a7763975e99fdf28d/crates%2Fgen_lsp_server%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fgen_lsp_server%2Fsrc%2Flib.rs?ref=47e8b80e9b67d5012fbc860a7763975e99fdf28d", "patch": "@@ -14,7 +14,7 @@ mod stdio;\n \n use crossbeam_channel::{Sender, Receiver};\n use languageserver_types::{\n-    ServerCapabilities, InitializeResult,\n+    ServerCapabilities, InitializeResult, InitializeParams,\n     request::{Initialize, Shutdown},\n     notification::{Initialized, Exit},\n };\n@@ -27,14 +27,18 @@ pub use {\n \n pub fn run_server(\n     caps: ServerCapabilities,\n-    server: impl FnOnce(&mut Receiver<RawMessage>, &mut Sender<RawMessage>) -> Result<()>,\n+    server: impl FnOnce(\n+        InitializeParams,\n+        &mut Receiver<RawMessage>,\n+        &mut Sender<RawMessage>,\n+    ) -> Result<()>,\n     mut receiver: Receiver<RawMessage>,\n     mut sender: Sender<RawMessage>,\n ) -> Result<()> {\n     info!(\"lsp server initializes\");\n-    initialize(&mut receiver, &mut sender, caps)?;\n+    let params = initialize(&mut receiver, &mut sender, caps)?;\n     info!(\"lsp server initialized, serving requests\");\n-    server(&mut receiver, &mut sender)?;\n+    server(params, &mut receiver, &mut sender)?;\n     info!(\"lsp server waiting for exit notification\");\n     match receiver.recv() {\n         Some(RawMessage::Notification(n)) => {\n@@ -63,11 +67,11 @@ fn initialize(\n     receiver: &mut Receiver<RawMessage>,\n     sender: &mut Sender<RawMessage>,\n     caps: ServerCapabilities,\n-) -> Result<()> {\n-    let id = match receiver.recv() {\n+) -> Result<InitializeParams> {\n+    let (id, params) = match receiver.recv() {\n         Some(RawMessage::Request(req)) => match req.cast::<Initialize>() {\n             Err(req) => bail!(\"expected initialize request, got {:?}\", req),\n-            Ok(req) => req.0,\n+            Ok(req) => req,\n         }\n         msg =>\n             bail!(\"expected initialize request, got {:?}\", msg),\n@@ -82,5 +86,5 @@ fn initialize(\n         }\n         _ => bail!(\"expected initialized notification\"),\n     }\n-    Ok(())\n+    Ok(params)\n }"}, {"sha": "baabde629854e42c023193f01ea007fb9e8870b2", "filename": "crates/server/src/main.rs", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/47e8b80e9b67d5012fbc860a7763975e99fdf28d/crates%2Fserver%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/47e8b80e9b67d5012fbc860a7763975e99fdf28d/crates%2Fserver%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fserver%2Fsrc%2Fmain.rs?ref=47e8b80e9b67d5012fbc860a7763975e99fdf28d", "patch": "@@ -31,10 +31,15 @@ fn main() -> Result<()> {\n \n fn main_inner() -> Result<()> {\n     let (receiver, sender, threads) = stdio_transport();\n-    let root = ::std::env::current_dir()?;\n+    let cwd = ::std::env::current_dir()?;\n     run_server(\n         m::server_capabilities(),\n-        |r, s| m::main_loop(false, root, r, s),\n+        |params, r, s| {\n+            let root = params.root_uri\n+                .and_then(|it| it.to_file_path().ok())\n+                .unwrap_or(cwd);\n+            m::main_loop(false, root, r, s)\n+        },\n         receiver,\n         sender,\n     )?;"}]}