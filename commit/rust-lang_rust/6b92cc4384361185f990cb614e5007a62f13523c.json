{"sha": "6b92cc4384361185f990cb614e5007a62f13523c", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZiOTJjYzQzODQzNjExODVmOTkwY2I2MTRlNTAwN2E2MmYxMzUyM2M=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-11-09T13:44:44Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-11-09T13:44:44Z"}, "message": "Merge #6509\n\n6509: Support multi-file assist tests r=matklad a=matklad\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>", "tree": {"sha": "8dccaadbf1fc9e012a4c7b2293adaa778584fe33", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8dccaadbf1fc9e012a4c7b2293adaa778584fe33"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6b92cc4384361185f990cb614e5007a62f13523c", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfqUfMCRBK7hj4Ov3rIwAAdHIIAEQAEQU6c+WhEB/7S8O2Mv54\nnEi/8G1j4m8po78Qw1rY88cpFzeLrd2ReN+rmxpSe7C0b0SbtXI09H103Ie1q+4R\n14fuj/PycIkq73o4I5CHU253H4c+s23C3sFLVS652mN42+uOgXmBoBRgF8rc1TAq\naswmYuJ8PNlL/11LJD+1ToV+3ZoH51VruDc8q6kjS/39xpb4wB17HwLBbgdp601E\n/4v3yEsngrJWQCpHzRtCasMAjubIBireTsX/gzJaLvdsp3HCJA/rHb1JbXMtCXo7\nVU2+jeI0MqSdw9bb9D9VJFayVQPGj4RU6hsmzvQBeLoHNKwzBZ5KqxFDFzxMkfg=\n=EBkH\n-----END PGP SIGNATURE-----\n", "payload": "tree 8dccaadbf1fc9e012a4c7b2293adaa778584fe33\nparent 9febb9eb0ec42d6b3fea6685402faef26f8b8186\nparent 018f826197bfc5b09c2aa2278714aadb7a66879a\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1604929484 +0000\ncommitter GitHub <noreply@github.com> 1604929484 +0000\n\nMerge #6509\n\n6509: Support multi-file assist tests r=matklad a=matklad\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6b92cc4384361185f990cb614e5007a62f13523c", "html_url": "https://github.com/rust-lang/rust/commit/6b92cc4384361185f990cb614e5007a62f13523c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6b92cc4384361185f990cb614e5007a62f13523c/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9febb9eb0ec42d6b3fea6685402faef26f8b8186", "url": "https://api.github.com/repos/rust-lang/rust/commits/9febb9eb0ec42d6b3fea6685402faef26f8b8186", "html_url": "https://github.com/rust-lang/rust/commit/9febb9eb0ec42d6b3fea6685402faef26f8b8186"}, {"sha": "018f826197bfc5b09c2aa2278714aadb7a66879a", "url": "https://api.github.com/repos/rust-lang/rust/commits/018f826197bfc5b09c2aa2278714aadb7a66879a", "html_url": "https://github.com/rust-lang/rust/commit/018f826197bfc5b09c2aa2278714aadb7a66879a"}], "stats": {"total": 62, "additions": 56, "deletions": 6}, "files": [{"sha": "58aadcef73ddbc9d74d8552d2a4e5b3cdb2b7d28", "filename": "crates/assists/src/handlers/extract_struct_from_enum_variant.rs", "status": "modified", "additions": 37, "deletions": 0, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/6b92cc4384361185f990cb614e5007a62f13523c/crates%2Fassists%2Fsrc%2Fhandlers%2Fextract_struct_from_enum_variant.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6b92cc4384361185f990cb614e5007a62f13523c/crates%2Fassists%2Fsrc%2Fhandlers%2Fextract_struct_from_enum_variant.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fassists%2Fsrc%2Fhandlers%2Fextract_struct_from_enum_variant.rs?ref=6b92cc4384361185f990cb614e5007a62f13523c", "patch": "@@ -345,6 +345,43 @@ fn another_fn() {\n         );\n     }\n \n+    #[test]\n+    fn test_several_files() {\n+        check_assist(\n+            extract_struct_from_enum_variant,\n+            r#\"\n+//- /main.rs\n+enum E {\n+    <|>V(i32, i32)\n+}\n+mod foo;\n+\n+//- /foo.rs\n+use crate::E;\n+fn f() {\n+    let e = E::V(9, 2);\n+}\n+\"#,\n+            r#\"\n+//- /main.rs\n+struct V(pub i32, pub i32);\n+\n+enum E {\n+    V(V)\n+}\n+mod foo;\n+\n+//- /foo.rs\n+use V;\n+\n+use crate::E;\n+fn f() {\n+    let e = E::V(V(9, 2));\n+}\n+\"#,\n+        )\n+    }\n+\n     fn check_not_applicable(ra_fixture: &str) {\n         let fixture =\n             format!(\"//- /main.rs crate:main deps:core\\n{}\\n{}\", ra_fixture, FamousDefs::FIXTURE);"}, {"sha": "709a34d03aabc1c3b218a1bb378b7082a1e8c0f5", "filename": "crates/assists/src/tests.rs", "status": "modified", "additions": 19, "deletions": 6, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/6b92cc4384361185f990cb614e5007a62f13523c/crates%2Fassists%2Fsrc%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6b92cc4384361185f990cb614e5007a62f13523c/crates%2Fassists%2Fsrc%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fassists%2Fsrc%2Ftests.rs?ref=6b92cc4384361185f990cb614e5007a62f13523c", "patch": "@@ -7,7 +7,7 @@ use syntax::TextRange;\n use test_utils::{assert_eq_text, extract_offset, extract_range};\n \n use crate::{handlers::Handler, Assist, AssistConfig, AssistContext, AssistKind, Assists};\n-use stdx::trim_indent;\n+use stdx::{format_to, trim_indent};\n \n pub(crate) fn with_single_file(text: &str) -> (RootDatabase, FileId) {\n     RootDatabase::with_single_file(text)\n@@ -98,11 +98,24 @@ fn check(handler: Handler, before: &str, expected: ExpectedResult, assist_label:\n     match (assist, expected) {\n         (Some(assist), ExpectedResult::After(after)) => {\n             let mut source_change = assist.source_change;\n-            let change = source_change.source_file_edits.pop().unwrap();\n-\n-            let mut actual = db.file_text(change.file_id).as_ref().to_owned();\n-            change.edit.apply(&mut actual);\n-            assert_eq_text!(after, &actual);\n+            assert!(!source_change.source_file_edits.is_empty());\n+            let skip_header = source_change.source_file_edits.len() == 1;\n+            source_change.source_file_edits.sort_by_key(|it| it.file_id);\n+\n+            let mut buf = String::new();\n+            for source_file_edit in source_change.source_file_edits {\n+                let mut text = db.file_text(source_file_edit.file_id).as_ref().to_owned();\n+                source_file_edit.edit.apply(&mut text);\n+                if !skip_header {\n+                    let sr = db.file_source_root(source_file_edit.file_id);\n+                    let sr = db.source_root(sr);\n+                    let path = sr.path_for_file(&source_file_edit.file_id).unwrap();\n+                    format_to!(buf, \"//- {}\\n\", path)\n+                }\n+                buf.push_str(&text);\n+            }\n+\n+            assert_eq_text!(after, &buf);\n         }\n         (Some(assist), ExpectedResult::Target(target)) => {\n             let range = assist.assist.target;"}]}