{"sha": "cbb41008fd43b512ffdbd35cebee2e4518b2181e", "node_id": "C_kwDOAAsO6NoAKGNiYjQxMDA4ZmQ0M2I1MTJmZmRiZDM1Y2ViZWUyZTQ1MThiMjE4MWU", "commit": {"author": {"name": "Badel2", "email": "2badel2@gmail.com", "date": "2023-05-18T22:44:14Z"}, "committer": {"name": "Badel2", "email": "2badel2@gmail.com", "date": "2023-05-19T18:58:06Z"}, "message": "Fix overflow in error emitter", "tree": {"sha": "be9a0219f072c1d5ab0480dcf7b7e34c18424b94", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/be9a0219f072c1d5ab0480dcf7b7e34c18424b94"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cbb41008fd43b512ffdbd35cebee2e4518b2181e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cbb41008fd43b512ffdbd35cebee2e4518b2181e", "html_url": "https://github.com/rust-lang/rust/commit/cbb41008fd43b512ffdbd35cebee2e4518b2181e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cbb41008fd43b512ffdbd35cebee2e4518b2181e/comments", "author": {"login": "Badel2", "id": 15879619, "node_id": "MDQ6VXNlcjE1ODc5NjE5", "avatar_url": "https://avatars.githubusercontent.com/u/15879619?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Badel2", "html_url": "https://github.com/Badel2", "followers_url": "https://api.github.com/users/Badel2/followers", "following_url": "https://api.github.com/users/Badel2/following{/other_user}", "gists_url": "https://api.github.com/users/Badel2/gists{/gist_id}", "starred_url": "https://api.github.com/users/Badel2/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Badel2/subscriptions", "organizations_url": "https://api.github.com/users/Badel2/orgs", "repos_url": "https://api.github.com/users/Badel2/repos", "events_url": "https://api.github.com/users/Badel2/events{/privacy}", "received_events_url": "https://api.github.com/users/Badel2/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Badel2", "id": 15879619, "node_id": "MDQ6VXNlcjE1ODc5NjE5", "avatar_url": "https://avatars.githubusercontent.com/u/15879619?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Badel2", "html_url": "https://github.com/Badel2", "followers_url": "https://api.github.com/users/Badel2/followers", "following_url": "https://api.github.com/users/Badel2/following{/other_user}", "gists_url": "https://api.github.com/users/Badel2/gists{/gist_id}", "starred_url": "https://api.github.com/users/Badel2/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Badel2/subscriptions", "organizations_url": "https://api.github.com/users/Badel2/orgs", "repos_url": "https://api.github.com/users/Badel2/repos", "events_url": "https://api.github.com/users/Badel2/events{/privacy}", "received_events_url": "https://api.github.com/users/Badel2/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8a281f9c796ee8cbebb07bbeec04ef2f2dd8db45", "url": "https://api.github.com/repos/rust-lang/rust/commits/8a281f9c796ee8cbebb07bbeec04ef2f2dd8db45", "html_url": "https://github.com/rust-lang/rust/commit/8a281f9c796ee8cbebb07bbeec04ef2f2dd8db45"}], "stats": {"total": 130, "additions": 108, "deletions": 22}, "files": [{"sha": "3e38d6afb0b8eed4b383bef78fbf05dd54db2d3e", "filename": "compiler/rustc_errors/src/emitter.rs", "status": "modified", "additions": 19, "deletions": 16, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/cbb41008fd43b512ffdbd35cebee2e4518b2181e/compiler%2Frustc_errors%2Fsrc%2Femitter.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cbb41008fd43b512ffdbd35cebee2e4518b2181e/compiler%2Frustc_errors%2Fsrc%2Femitter.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_errors%2Fsrc%2Femitter.rs?ref=cbb41008fd43b512ffdbd35cebee2e4518b2181e", "patch": "@@ -2303,22 +2303,25 @@ impl EmitterWriter {\n \n         // Colorize addition/replacements with green.\n         for &SubstitutionHighlight { start, end } in highlight_parts {\n-            // Account for tabs when highlighting (#87972).\n-            let tabs: usize = line_to_add\n-                .chars()\n-                .take(start)\n-                .map(|ch| match ch {\n-                    '\\t' => 3,\n-                    _ => 0,\n-                })\n-                .sum();\n-            buffer.set_style_range(\n-                *row_num,\n-                max_line_num_len + 3 + start + tabs,\n-                max_line_num_len + 3 + end + tabs,\n-                Style::Addition,\n-                true,\n-            );\n+            // This is a no-op for empty ranges\n+            if start != end {\n+                // Account for tabs when highlighting (#87972).\n+                let tabs: usize = line_to_add\n+                    .chars()\n+                    .take(start)\n+                    .map(|ch| match ch {\n+                        '\\t' => 3,\n+                        _ => 0,\n+                    })\n+                    .sum();\n+                buffer.set_style_range(\n+                    *row_num,\n+                    max_line_num_len + 3 + start + tabs,\n+                    max_line_num_len + 3 + end + tabs,\n+                    Style::Addition,\n+                    true,\n+                );\n+            }\n         }\n         *row_num += 1;\n     }"}, {"sha": "b1ee222b7c4bc28be09dca40af82a961ce01c3fc", "filename": "compiler/rustc_errors/src/lib.rs", "status": "modified", "additions": 5, "deletions": 6, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/cbb41008fd43b512ffdbd35cebee2e4518b2181e/compiler%2Frustc_errors%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cbb41008fd43b512ffdbd35cebee2e4518b2181e/compiler%2Frustc_errors%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_errors%2Fsrc%2Flib.rs?ref=cbb41008fd43b512ffdbd35cebee2e4518b2181e", "patch": "@@ -330,12 +330,11 @@ impl CodeSuggestion {\n                     });\n                     buf.push_str(&part.snippet);\n                     let cur_hi = sm.lookup_char_pos(part.span.hi());\n-                    if cur_hi.line == cur_lo.line && !part.snippet.is_empty() {\n-                        // Account for the difference between the width of the current code and the\n-                        // snippet being suggested, so that the *later* suggestions are correctly\n-                        // aligned on the screen.\n-                        acc += len - (cur_hi.col.0 - cur_lo.col.0) as isize;\n-                    }\n+                    // Account for the difference between the width of the current code and the\n+                    // snippet being suggested, so that the *later* suggestions are correctly\n+                    // aligned on the screen. Note that cur_hi and cur_lo can be on different\n+                    // lines, so cur_hi.col can be smaller than cur_lo.col\n+                    acc += len - (cur_hi.col.0 as isize - cur_lo.col.0 as isize);\n                     prev_hi = cur_hi;\n                     prev_line = sf.get_line(prev_hi.line - 1);\n                     for line in part.snippet.split('\\n').skip(1) {"}, {"sha": "dd4542dd71f7024ab1655493224c710328006d76", "filename": "tests/ui/suggestions/issue-109854.rs", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/cbb41008fd43b512ffdbd35cebee2e4518b2181e/tests%2Fui%2Fsuggestions%2Fissue-109854.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cbb41008fd43b512ffdbd35cebee2e4518b2181e/tests%2Fui%2Fsuggestions%2Fissue-109854.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fsuggestions%2Fissue-109854.rs?ref=cbb41008fd43b512ffdbd35cebee2e4518b2181e", "patch": "@@ -0,0 +1,12 @@\n+fn generate_setter() {\n+    String::with_capacity(\n+    //~^ ERROR this function takes 1 argument but 3 arguments were supplied\n+    generate_setter,\n+    r#\"\n+pub(crate) struct Person<T: Clone> {}\n+\"#,\n+     r#\"\"#,\n+    );\n+}\n+\n+fn main() {}"}, {"sha": "621a3897165b812fac5e31e7702323672726d65f", "filename": "tests/ui/suggestions/issue-109854.stderr", "status": "added", "additions": 31, "deletions": 0, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/cbb41008fd43b512ffdbd35cebee2e4518b2181e/tests%2Fui%2Fsuggestions%2Fissue-109854.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/cbb41008fd43b512ffdbd35cebee2e4518b2181e/tests%2Fui%2Fsuggestions%2Fissue-109854.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fsuggestions%2Fissue-109854.stderr?ref=cbb41008fd43b512ffdbd35cebee2e4518b2181e", "patch": "@@ -0,0 +1,31 @@\n+error[E0061]: this function takes 1 argument but 3 arguments were supplied\n+  --> $DIR/issue-109854.rs:2:5\n+   |\n+LL |       String::with_capacity(\n+   |       ^^^^^^^^^^^^^^^^^^^^^\n+...\n+LL | /     r#\"\n+LL | | pub(crate) struct Person<T: Clone> {}\n+LL | | \"#,\n+   | |__- unexpected argument of type `&'static str`\n+LL |        r#\"\"#,\n+   |        ----- unexpected argument of type `&'static str`\n+   |\n+note: expected `usize`, found fn item\n+  --> $DIR/issue-109854.rs:4:5\n+   |\n+LL |     generate_setter,\n+   |     ^^^^^^^^^^^^^^^\n+   = note: expected type `usize`\n+           found fn item `fn() {generate_setter}`\n+note: associated function defined here\n+  --> $SRC_DIR/alloc/src/string.rs:LL:COL\n+help: remove the extra arguments\n+   |\n+LL -     generate_setter,\n+LL +     /* usize */,\n+   |\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0061`."}, {"sha": "cbb9f9cec721142def77ecc4eb61d772b474d6b4", "filename": "tests/ui/suggestions/issue-94171.rs", "status": "added", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/cbb41008fd43b512ffdbd35cebee2e4518b2181e/tests%2Fui%2Fsuggestions%2Fissue-94171.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cbb41008fd43b512ffdbd35cebee2e4518b2181e/tests%2Fui%2Fsuggestions%2Fissue-94171.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fsuggestions%2Fissue-94171.rs?ref=cbb41008fd43b512ffdbd35cebee2e4518b2181e", "patch": "@@ -0,0 +1,5 @@\n+fn L(]{match\n+(; {`\n+//~^^ ERROR mismatched closing delimiter\n+//~^^ ERROR unknown start of token\n+//~ ERROR this file contains an unclosed delimiter"}, {"sha": "b3440e46e8acd7a98bf785863c8539f311a5d407", "filename": "tests/ui/suggestions/issue-94171.stderr", "status": "added", "additions": 36, "deletions": 0, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/cbb41008fd43b512ffdbd35cebee2e4518b2181e/tests%2Fui%2Fsuggestions%2Fissue-94171.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/cbb41008fd43b512ffdbd35cebee2e4518b2181e/tests%2Fui%2Fsuggestions%2Fissue-94171.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fsuggestions%2Fissue-94171.stderr?ref=cbb41008fd43b512ffdbd35cebee2e4518b2181e", "patch": "@@ -0,0 +1,36 @@\n+error: unknown start of token: `\n+  --> $DIR/issue-94171.rs:2:5\n+   |\n+LL | (; {`\n+   |     ^\n+   |\n+help: Unicode character '`' (Grave Accent) looks like ''' (Single Quote), but it is not\n+   |\n+LL | (; {'\n+   |     ~\n+\n+error: mismatched closing delimiter: `]`\n+  --> $DIR/issue-94171.rs:1:5\n+   |\n+LL | fn L(]{match\n+   |     ^^ mismatched closing delimiter\n+   |     |\n+   |     unclosed delimiter\n+\n+error: this file contains an unclosed delimiter\n+  --> $DIR/issue-94171.rs:5:52\n+   |\n+LL | fn L(]{match\n+   |      -- unclosed delimiter\n+   |      |\n+   |      missing open `[` for this delimiter\n+LL | (; {`\n+   | -  - unclosed delimiter\n+   | |\n+   | unclosed delimiter\n+...\n+LL |\n+   |                                                    ^\n+\n+error: aborting due to 3 previous errors\n+"}]}