{"sha": "65943c058583f912175f2cfde64ff2a0d92809b6", "node_id": "MDY6Q29tbWl0NzI0NzEyOjY1OTQzYzA1ODU4M2Y5MTIxNzVmMmNmZGU2NGZmMmEwZDkyODA5YjY=", "commit": {"author": {"name": "Leander Tentrup", "email": "leander.tentrup@gmail.com", "date": "2020-06-07T12:50:02Z"}, "committer": {"name": "Leander Tentrup", "email": "leander.tentrup@gmail.com", "date": "2020-06-07T12:50:02Z"}, "message": "Remove redundancy in syntax highlighting tests", "tree": {"sha": "ec63bb8bc9c8cc1c31cb3402bd4c1ce462b15b8d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ec63bb8bc9c8cc1c31cb3402bd4c1ce462b15b8d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/65943c058583f912175f2cfde64ff2a0d92809b6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/65943c058583f912175f2cfde64ff2a0d92809b6", "html_url": "https://github.com/rust-lang/rust/commit/65943c058583f912175f2cfde64ff2a0d92809b6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/65943c058583f912175f2cfde64ff2a0d92809b6/comments", "author": {"login": "ltentrup", "id": 201808, "node_id": "MDQ6VXNlcjIwMTgwOA==", "avatar_url": "https://avatars.githubusercontent.com/u/201808?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ltentrup", "html_url": "https://github.com/ltentrup", "followers_url": "https://api.github.com/users/ltentrup/followers", "following_url": "https://api.github.com/users/ltentrup/following{/other_user}", "gists_url": "https://api.github.com/users/ltentrup/gists{/gist_id}", "starred_url": "https://api.github.com/users/ltentrup/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ltentrup/subscriptions", "organizations_url": "https://api.github.com/users/ltentrup/orgs", "repos_url": "https://api.github.com/users/ltentrup/repos", "events_url": "https://api.github.com/users/ltentrup/events{/privacy}", "received_events_url": "https://api.github.com/users/ltentrup/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ltentrup", "id": 201808, "node_id": "MDQ6VXNlcjIwMTgwOA==", "avatar_url": "https://avatars.githubusercontent.com/u/201808?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ltentrup", "html_url": "https://github.com/ltentrup", "followers_url": "https://api.github.com/users/ltentrup/followers", "following_url": "https://api.github.com/users/ltentrup/following{/other_user}", "gists_url": "https://api.github.com/users/ltentrup/gists{/gist_id}", "starred_url": "https://api.github.com/users/ltentrup/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ltentrup/subscriptions", "organizations_url": "https://api.github.com/users/ltentrup/orgs", "repos_url": "https://api.github.com/users/ltentrup/repos", "events_url": "https://api.github.com/users/ltentrup/events{/privacy}", "received_events_url": "https://api.github.com/users/ltentrup/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "dc340f12a39e7cd8b495b84c009052c4d441d867", "url": "https://api.github.com/repos/rust-lang/rust/commits/dc340f12a39e7cd8b495b84c009052c4d441d867", "html_url": "https://github.com/rust-lang/rust/commit/dc340f12a39e7cd8b495b84c009052c4d441d867"}], "stats": {"total": 59, "additions": 27, "deletions": 32}, "files": [{"sha": "5e42c5b55b4201f19f20afebfad352c68e20fad2", "filename": "crates/ra_ide/src/syntax_highlighting/tests.rs", "status": "modified", "additions": 27, "deletions": 32, "changes": 59, "blob_url": "https://github.com/rust-lang/rust/blob/65943c058583f912175f2cfde64ff2a0d92809b6/crates%2Fra_ide%2Fsrc%2Fsyntax_highlighting%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/65943c058583f912175f2cfde64ff2a0d92809b6/crates%2Fra_ide%2Fsrc%2Fsyntax_highlighting%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fsyntax_highlighting%2Ftests.rs?ref=65943c058583f912175f2cfde64ff2a0d92809b6", "patch": "@@ -7,9 +7,21 @@ use crate::{\n     FileRange, TextRange,\n };\n \n+/// Highlights the code given by the `ra_fixture` argument, renders the\n+/// result as HTML, and compares it with the HTML file given as `snapshot`.\n+/// Note that the `snapshot` file is overwritten by the rendered HTML.\n+fn check_highlighting(ra_fixture: &str, snapshot: &str, rainbow: bool) {\n+    let (analysis, file_id) = single_file(ra_fixture);\n+    let dst_file = project_dir().join(snapshot);\n+    let actual_html = &analysis.highlight_as_html(file_id, rainbow).unwrap();\n+    let expected_html = &read_text(&dst_file);\n+    fs::write(dst_file, &actual_html).unwrap();\n+    assert_eq_text!(expected_html, actual_html);\n+}\n+\n #[test]\n fn test_highlighting() {\n-    let (analysis, file_id) = single_file(\n+    check_highlighting(\n         r#\"\n #[derive(Clone, Debug)]\n struct Foo {\n@@ -84,17 +96,14 @@ impl<T> Option<T> {\n }\n \"#\n         .trim(),\n+        \"crates/ra_ide/src/snapshots/highlighting.html\",\n+        false,\n     );\n-    let dst_file = project_dir().join(\"crates/ra_ide/src/snapshots/highlighting.html\");\n-    let actual_html = &analysis.highlight_as_html(file_id, false).unwrap();\n-    let expected_html = &read_text(&dst_file);\n-    fs::write(dst_file, &actual_html).unwrap();\n-    assert_eq_text!(expected_html, actual_html);\n }\n \n #[test]\n fn test_rainbow_highlighting() {\n-    let (analysis, file_id) = single_file(\n+    check_highlighting(\n         r#\"\n fn main() {\n     let hello = \"hello\";\n@@ -110,12 +119,9 @@ fn bar() {\n }\n \"#\n         .trim(),\n+        \"crates/ra_ide/src/snapshots/rainbow_highlighting.html\",\n+        true,\n     );\n-    let dst_file = project_dir().join(\"crates/ra_ide/src/snapshots/rainbow_highlighting.html\");\n-    let actual_html = &analysis.highlight_as_html(file_id, true).unwrap();\n-    let expected_html = &read_text(&dst_file);\n-    fs::write(dst_file, &actual_html).unwrap();\n-    assert_eq_text!(expected_html, actual_html);\n }\n \n #[test]\n@@ -153,7 +159,7 @@ fn test_ranges() {\n \n #[test]\n fn test_flattening() {\n-    let (analysis, file_id) = single_file(\n+    check_highlighting(\n         r##\"\n fn fixture(ra_fixture: &str) {}\n \n@@ -167,13 +173,9 @@ fn main() {\n     );\n }\"##\n         .trim(),\n+        \"crates/ra_ide/src/snapshots/highlight_injection.html\",\n+        false,\n     );\n-\n-    let dst_file = project_dir().join(\"crates/ra_ide/src/snapshots/highlight_injection.html\");\n-    let actual_html = &analysis.highlight_as_html(file_id, false).unwrap();\n-    let expected_html = &read_text(&dst_file);\n-    fs::write(dst_file, &actual_html).unwrap();\n-    assert_eq_text!(expected_html, actual_html);\n }\n \n #[test]\n@@ -192,7 +194,7 @@ macro_rules! test {}\n fn test_string_highlighting() {\n     // The format string detection is based on macro-expansion,\n     // thus, we have to copy the macro definition from `std`\n-    let (analysis, file_id) = single_file(\n+    check_highlighting(\n         r#\"\n macro_rules! println {\n     ($($arg:tt)*) => ({\n@@ -250,18 +252,14 @@ fn main() {\n     println!(\"{\u043d\u0438\u0447\u043e\u0441\u0438}\", \u043d\u0438\u0447\u043e\u0441\u0438 = 92);\n }\"#\n         .trim(),\n+        \"crates/ra_ide/src/snapshots/highlight_strings.html\",\n+        false,\n     );\n-\n-    let dst_file = project_dir().join(\"crates/ra_ide/src/snapshots/highlight_strings.html\");\n-    let actual_html = &analysis.highlight_as_html(file_id, false).unwrap();\n-    let expected_html = &read_text(&dst_file);\n-    fs::write(dst_file, &actual_html).unwrap();\n-    assert_eq_text!(expected_html, actual_html);\n }\n \n #[test]\n fn test_unsafe_highlighting() {\n-    let (analysis, file_id) = single_file(\n+    check_highlighting(\n         r#\"\n unsafe fn unsafe_fn() {}\n \n@@ -282,10 +280,7 @@ fn main() {\n }\n \"#\n         .trim(),\n+        \"crates/ra_ide/src/snapshots/highlight_unsafe.html\",\n+        false,\n     );\n-    let dst_file = project_dir().join(\"crates/ra_ide/src/snapshots/highlight_unsafe.html\");\n-    let actual_html = &analysis.highlight_as_html(file_id, false).unwrap();\n-    let expected_html = &read_text(&dst_file);\n-    fs::write(dst_file, &actual_html).unwrap();\n-    assert_eq_text!(expected_html, actual_html);\n }"}]}