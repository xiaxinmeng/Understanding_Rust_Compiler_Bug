{"sha": "f6a46cf4d16e5fa38ee983dd6e191ae7e46acaae", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY2YTQ2Y2Y0ZDE2ZTVmYTM4ZWU5ODNkZDZlMTkxYWU3ZTQ2YWNhYWU=", "commit": {"author": {"name": "Dan Robertson", "email": "danlrobertson89@gmail.com", "date": "2018-05-11T03:56:08Z"}, "committer": {"name": "Dan Robertson", "email": "danlrobertson89@gmail.com", "date": "2018-05-12T02:47:58Z"}, "message": "typeck: Fix ICE with struct update syntax\n\nIf check_expr_struct_fields fails, do not continue to record update.\nIf we continue to record update, the struct may cause us to ICE later\non indexing a field that may or may not exist.", "tree": {"sha": "3975f7c300121cb9ca3fe0ca6589af1bf6415d79", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3975f7c300121cb9ca3fe0ca6589af1bf6415d79"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f6a46cf4d16e5fa38ee983dd6e191ae7e46acaae", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEF5dO2RaKc5C+SCJ9RcSmUsR+QqUFAlr2VeEACgkQRcSmUsR+\nQqXJ3Q/9HcHFTyRt/x+13895LIwACHQ5WowjOwxOPZG3an6eYYZbDEI4kr40ZAya\nzYhF+hdG9TFf9UdrGqSWi7FYXiyKEWn4Iipur6FA5C5oq6gjOfwESX3csbndVtNM\nHrniI/ABz7StTjDr1Mip+SGSn/A6yPO1RCeff4IPtfxgsKFEIbNffi1uxqNKln64\nugQ/5oCt5df5CmCSpk+14CjaXgq0xgjn+Swl7V9ZghKfuciUSV/sxU57n5tqifNY\nhcQ7S8OlLIbmUorDTVB8CmnIQvoOYs1xm9S6d2lTwPRxjuqcTIvZs+vGEawt7fqh\n9ZjrfrfE1f01x7j0c8Vn3Bl2M7RNg3RdquLVuBW/24HTtcZsfaY/VOCxERGsCTBt\nbXteO3T8AG774ie/rqzqM+jKsuf7Jv6lQ0Ptlit41GiXiVvvngr8DUs8HUlPDDy6\nlj0cYylquJzmrpQ5KrbhHYIsZMHu/mLCrJAWVsiN3wEn1KtsJJvEIUa5Axbp59nq\nsRZKfmLC8amJGZpc9m+TLqmRpWwkPpiIE0+5pfzjiXVj06OKK2fgWsZfFTFXkL9Y\n3zhBStA4TahAj5vcw1s58R6IJqbz4voQQuaVP7nzW0BiTnc1tX6QiJCM/5upsFg0\npv2TabZYi5pcsfN+L+oXkqdRtFB32mugRxMXMKFsv8Qs5lzzWK4=\n=XfCb\n-----END PGP SIGNATURE-----", "payload": "tree 3975f7c300121cb9ca3fe0ca6589af1bf6415d79\nparent 41707d8df9a441e19387a4a61415ee0af58a9e48\nauthor Dan Robertson <danlrobertson89@gmail.com> 1526010968 +0000\ncommitter Dan Robertson <danlrobertson89@gmail.com> 1526093278 +0000\n\ntypeck: Fix ICE with struct update syntax\n\nIf check_expr_struct_fields fails, do not continue to record update.\nIf we continue to record update, the struct may cause us to ICE later\non indexing a field that may or may not exist.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f6a46cf4d16e5fa38ee983dd6e191ae7e46acaae", "html_url": "https://github.com/rust-lang/rust/commit/f6a46cf4d16e5fa38ee983dd6e191ae7e46acaae", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f6a46cf4d16e5fa38ee983dd6e191ae7e46acaae/comments", "author": {"login": "dlrobertson", "id": 7504153, "node_id": "MDQ6VXNlcjc1MDQxNTM=", "avatar_url": "https://avatars.githubusercontent.com/u/7504153?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dlrobertson", "html_url": "https://github.com/dlrobertson", "followers_url": "https://api.github.com/users/dlrobertson/followers", "following_url": "https://api.github.com/users/dlrobertson/following{/other_user}", "gists_url": "https://api.github.com/users/dlrobertson/gists{/gist_id}", "starred_url": "https://api.github.com/users/dlrobertson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dlrobertson/subscriptions", "organizations_url": "https://api.github.com/users/dlrobertson/orgs", "repos_url": "https://api.github.com/users/dlrobertson/repos", "events_url": "https://api.github.com/users/dlrobertson/events{/privacy}", "received_events_url": "https://api.github.com/users/dlrobertson/received_events", "type": "User", "site_admin": false}, "committer": {"login": "dlrobertson", "id": 7504153, "node_id": "MDQ6VXNlcjc1MDQxNTM=", "avatar_url": "https://avatars.githubusercontent.com/u/7504153?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dlrobertson", "html_url": "https://github.com/dlrobertson", "followers_url": "https://api.github.com/users/dlrobertson/followers", "following_url": "https://api.github.com/users/dlrobertson/following{/other_user}", "gists_url": "https://api.github.com/users/dlrobertson/gists{/gist_id}", "starred_url": "https://api.github.com/users/dlrobertson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dlrobertson/subscriptions", "organizations_url": "https://api.github.com/users/dlrobertson/orgs", "repos_url": "https://api.github.com/users/dlrobertson/repos", "events_url": "https://api.github.com/users/dlrobertson/events{/privacy}", "received_events_url": "https://api.github.com/users/dlrobertson/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "41707d8df9a441e19387a4a61415ee0af58a9e48", "url": "https://api.github.com/repos/rust-lang/rust/commits/41707d8df9a441e19387a4a61415ee0af58a9e48", "html_url": "https://github.com/rust-lang/rust/commit/41707d8df9a441e19387a4a61415ee0af58a9e48"}], "stats": {"total": 82, "additions": 64, "deletions": 18}, "files": [{"sha": "ad89e1dca869751e1f0ae2b89b04eaadee2d4e4c", "filename": "src/librustc_typeck/check/mod.rs", "status": "modified", "additions": 24, "deletions": 18, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/f6a46cf4d16e5fa38ee983dd6e191ae7e46acaae/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f6a46cf4d16e5fa38ee983dd6e191ae7e46acaae/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs?ref=f6a46cf4d16e5fa38ee983dd6e191ae7e46acaae", "patch": "@@ -3278,7 +3278,7 @@ impl<'a, 'gcx, 'tcx> FnCtxt<'a, 'gcx, 'tcx> {\n                                 span: Span,\n                                 variant: &'tcx ty::VariantDef,\n                                 ast_fields: &'gcx [hir::Field],\n-                                check_completeness: bool) {\n+                                check_completeness: bool) -> bool {\n         let tcx = self.tcx;\n \n         let adt_ty_hint =\n@@ -3380,6 +3380,7 @@ impl<'a, 'gcx, 'tcx> FnCtxt<'a, 'gcx, 'tcx> {\n                                           truncated_fields_error))\n                 .emit();\n         }\n+        error_happened\n     }\n \n     fn check_struct_fields_on_error(&self,\n@@ -3478,24 +3479,29 @@ impl<'a, 'gcx, 'tcx> FnCtxt<'a, 'gcx, 'tcx> {\n             }\n         }\n \n-        self.check_expr_struct_fields(struct_ty, expected, expr.id, path_span, variant, fields,\n-                                      base_expr.is_none());\n+        let error_happened = self.check_expr_struct_fields(struct_ty, expected, expr.id, path_span,\n+                                                           variant, fields, base_expr.is_none());\n         if let &Some(ref base_expr) = base_expr {\n-            self.check_expr_has_type_or_error(base_expr, struct_ty);\n-            match struct_ty.sty {\n-                ty::TyAdt(adt, substs) if adt.is_struct() => {\n-                    let fru_field_types = adt.non_enum_variant().fields.iter().map(|f| {\n-                        self.normalize_associated_types_in(expr.span, &f.ty(self.tcx, substs))\n-                    }).collect();\n-\n-                    self.tables\n-                        .borrow_mut()\n-                        .fru_field_types_mut()\n-                        .insert(expr.hir_id, fru_field_types);\n-                }\n-                _ => {\n-                    span_err!(self.tcx.sess, base_expr.span, E0436,\n-                              \"functional record update syntax requires a struct\");\n+            // If check_expr_struct_fields hit an error, do not attempt to populate\n+            // the fields with the base_expr. This could cause us to hit errors later\n+            // when certain fields are assumed to exist that in fact do not.\n+            if !error_happened {\n+                self.check_expr_has_type_or_error(base_expr, struct_ty);\n+                match struct_ty.sty {\n+                    ty::TyAdt(adt, substs) if adt.is_struct() => {\n+                        let fru_field_types = adt.non_enum_variant().fields.iter().map(|f| {\n+                            self.normalize_associated_types_in(expr.span, &f.ty(self.tcx, substs))\n+                        }).collect();\n+\n+                        self.tables\n+                            .borrow_mut()\n+                            .fru_field_types_mut()\n+                            .insert(expr.hir_id, fru_field_types);\n+                    }\n+                    _ => {\n+                        span_err!(self.tcx.sess, base_expr.span, E0436,\n+                                  \"functional record update syntax requires a struct\");\n+                    }\n                 }\n             }\n         }"}, {"sha": "ed427c293df47599894faf600dda70be9ad1d9f8", "filename": "src/test/ui/issue-50618.rs", "status": "added", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/f6a46cf4d16e5fa38ee983dd6e191ae7e46acaae/src%2Ftest%2Fui%2Fissue-50618.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f6a46cf4d16e5fa38ee983dd6e191ae7e46acaae/src%2Ftest%2Fui%2Fissue-50618.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissue-50618.rs?ref=f6a46cf4d16e5fa38ee983dd6e191ae7e46acaae", "patch": "@@ -0,0 +1,29 @@\n+// Copyright 2017 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+struct Point {\n+    pub x: u64,\n+    pub y: u64,\n+}\n+\n+const TEMPLATE: Point = Point {\n+    x: 0,\n+    y: 0\n+};\n+\n+fn main() {\n+    let _ = || {\n+        Point {\n+            nonexistent: 0,\n+            //~^ ERROR struct `Point` has no field named `nonexistent`\n+            ..TEMPLATE\n+        }\n+    };\n+}"}, {"sha": "07cc5a1318aa43980a80c439921d76270fdc81e0", "filename": "src/test/ui/issue-50618.stderr", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/f6a46cf4d16e5fa38ee983dd6e191ae7e46acaae/src%2Ftest%2Fui%2Fissue-50618.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/f6a46cf4d16e5fa38ee983dd6e191ae7e46acaae/src%2Ftest%2Fui%2Fissue-50618.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissue-50618.stderr?ref=f6a46cf4d16e5fa38ee983dd6e191ae7e46acaae", "patch": "@@ -0,0 +1,11 @@\n+error[E0560]: struct `Point` has no field named `nonexistent`\n+  --> $DIR/issue-50618.rs:24:13\n+   |\n+LL |             nonexistent: 0,\n+   |             ^^^^^^^^^^^ `Point` does not have this field\n+   |\n+   = note: available fields are: `x`, `y`\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0560`."}]}