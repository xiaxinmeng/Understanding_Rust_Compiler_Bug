{"sha": "7746d7c52fdbdc37a9eb9b5d463fb327685c9f08", "node_id": "MDY6Q29tbWl0NzI0NzEyOjc3NDZkN2M1MmZkYmRjMzdhOWViOWI1ZDQ2M2ZiMzI3Njg1YzlmMDg=", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2016-06-09T21:50:52Z"}, "committer": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2016-06-12T16:40:40Z"}, "message": "Add error codes block code flag", "tree": {"sha": "a561ed9ecfb96fab63a16c62007bc3d55036831d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a561ed9ecfb96fab63a16c62007bc3d55036831d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7746d7c52fdbdc37a9eb9b5d463fb327685c9f08", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7746d7c52fdbdc37a9eb9b5d463fb327685c9f08", "html_url": "https://github.com/rust-lang/rust/commit/7746d7c52fdbdc37a9eb9b5d463fb327685c9f08", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7746d7c52fdbdc37a9eb9b5d463fb327685c9f08/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0740a93cc290a5419807d2e8c6c442354baf46b0", "url": "https://api.github.com/repos/rust-lang/rust/commits/0740a93cc290a5419807d2e8c6c442354baf46b0", "html_url": "https://github.com/rust-lang/rust/commit/0740a93cc290a5419807d2e8c6c442354baf46b0"}], "stats": {"total": 54, "additions": 43, "deletions": 11}, "files": [{"sha": "ed08f2f012332d4fa714f04170656d051d0f4bd9", "filename": "src/librustdoc/html/markdown.rs", "status": "modified", "additions": 22, "deletions": 6, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/7746d7c52fdbdc37a9eb9b5d463fb327685c9f08/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7746d7c52fdbdc37a9eb9b5d463fb327685c9f08/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs?ref=7746d7c52fdbdc37a9eb9b5d463fb327685c9f08", "patch": "@@ -408,7 +408,7 @@ pub fn find_testable_code(doc: &str, tests: &mut ::test::Collector) {\n             tests.add_test(text.to_owned(),\n                            block_info.should_panic, block_info.no_run,\n                            block_info.ignore, block_info.test_harness,\n-                           block_info.compile_fail);\n+                           block_info.compile_fail, block_info.error_codes);\n         }\n     }\n \n@@ -454,6 +454,7 @@ struct LangString {\n     rust: bool,\n     test_harness: bool,\n     compile_fail: bool,\n+    error_codes: Vec<String>,\n }\n \n impl LangString {\n@@ -465,16 +466,22 @@ impl LangString {\n             rust: true,  // NB This used to be `notrust = false`\n             test_harness: false,\n             compile_fail: false,\n+            error_codes: Vec::new(),\n         }\n     }\n \n     fn parse(string: &str) -> LangString {\n         let mut seen_rust_tags = false;\n         let mut seen_other_tags = false;\n         let mut data = LangString::all_false();\n-        let allow_compile_fail = match get_unstable_features_setting() {\n-            UnstableFeatures::Allow | UnstableFeatures::Cheat=> true,\n-            _ => false,\n+        let mut allow_compile_fail = false;\n+        let mut allow_error_code_check = false;\n+        match get_unstable_features_setting() {\n+            UnstableFeatures::Allow | UnstableFeatures::Cheat => {\n+                allow_compile_fail = true;\n+                allow_error_code_check = true;\n+            }\n+            _ => {},\n         };\n \n         let tokens = string.split(|c: char|\n@@ -493,7 +500,15 @@ impl LangString {\n                     data.compile_fail = true;\n                     seen_rust_tags = true;\n                     data.no_run = true;\n-                },\n+                }\n+                x if allow_error_code_check && x.starts_with(\"E\") && x.len() == 5 => {\n+                    if let Ok(_) = x[1..].parse::<u32>() {\n+                        data.error_codes.push(x.to_owned());\n+                        seen_rust_tags = true;\n+                    } else {\n+                        seen_other_tags = true;\n+                    }\n+                }\n                 _ => { seen_other_tags = true }\n             }\n         }\n@@ -577,14 +592,15 @@ mod tests {\n     fn test_lang_string_parse() {\n         fn t(s: &str,\n             should_panic: bool, no_run: bool, ignore: bool, rust: bool, test_harness: bool,\n-            compile_fail: bool) {\n+            compile_fail: bool, error_codes: Vec<String>) {\n             assert_eq!(LangString::parse(s), LangString {\n                 should_panic: should_panic,\n                 no_run: no_run,\n                 ignore: ignore,\n                 rust: rust,\n                 test_harness: test_harness,\n                 compile_fail: compile_fail,\n+                error_codes: error_codes,\n             })\n         }\n "}, {"sha": "cb27da0a75978106f737164ba70c2db378bc2f52", "filename": "src/librustdoc/test.rs", "status": "modified", "additions": 21, "deletions": 5, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/7746d7c52fdbdc37a9eb9b5d463fb327685c9f08/src%2Flibrustdoc%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7746d7c52fdbdc37a9eb9b5d463fb327685c9f08/src%2Flibrustdoc%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Ftest.rs?ref=7746d7c52fdbdc37a9eb9b5d463fb327685c9f08", "patch": "@@ -176,7 +176,7 @@ fn scrape_test_config(krate: &::rustc::hir::Crate) -> TestOptions {\n fn runtest(test: &str, cratename: &str, cfgs: Vec<String>, libs: SearchPaths,\n            externs: core::Externs,\n            should_panic: bool, no_run: bool, as_test_harness: bool,\n-           compile_fail: bool, opts: &TestOptions) {\n+           compile_fail: bool, mut error_codes: Vec<String>, opts: &TestOptions) {\n     // the test harness wants its own `main` & top level functions, so\n     // never wrap the test in `fn main() { ... }`\n     let test = maketest(test, Some(cratename), as_test_harness, opts);\n@@ -232,7 +232,7 @@ fn runtest(test: &str, cratename: &str, cfgs: Vec<String>, libs: SearchPaths,\n                                                       None,\n                                                       codemap.clone());\n     let old = io::set_panic(box Sink(data.clone()));\n-    let _bomb = Bomb(data, old.unwrap_or(box io::stdout()));\n+    let _bomb = Bomb(data.clone(), old.unwrap_or(box io::stdout()));\n \n     // Compile the code\n     let diagnostic_handler = errors::Handler::with_emitter(true, false, box emitter);\n@@ -273,13 +273,28 @@ fn runtest(test: &str, cratename: &str, cfgs: Vec<String>, libs: SearchPaths,\n                     } else if count == 0 && compile_fail == true {\n                         panic!(\"test compiled while it wasn't supposed to\")\n                     }\n+                    if count > 0 && error_codes.len() > 0 {\n+                        let out = String::from_utf8(data.lock().unwrap().to_vec()).unwrap();\n+                        error_codes = error_codes.into_iter().filter(|err| !out.contains(err)).collect();\n+                    }\n                 }\n                 Ok(()) if compile_fail => panic!(\"test compiled while it wasn't supposed to\"),\n                 _ => {}\n             }\n         }\n-        Err(_) if compile_fail == false => panic!(\"couldn't compile the test\"),\n-        _ => {}\n+        Err(_) => {\n+            if compile_fail == false {\n+                panic!(\"couldn't compile the test\");\n+            }\n+            if error_codes.len() > 0 {\n+                let out = String::from_utf8(data.lock().unwrap().to_vec()).unwrap();\n+                error_codes.retain(|err| !out.contains(err));\n+            }\n+        }\n+    }\n+\n+    if error_codes.len() > 0 {\n+        panic!(\"Some expected error codes were not found: {:?}\", error_codes);\n     }\n \n     if no_run { return }\n@@ -411,7 +426,7 @@ impl Collector {\n \n     pub fn add_test(&mut self, test: String,\n                     should_panic: bool, no_run: bool, should_ignore: bool,\n-                    as_test_harness: bool, compile_fail: bool) {\n+                    as_test_harness: bool, compile_fail: bool, error_codes: Vec<String>) {\n         let name = if self.use_headers {\n             let s = self.current_header.as_ref().map(|s| &**s).unwrap_or(\"\");\n             format!(\"{}_{}\", s, self.cnt)\n@@ -442,6 +457,7 @@ impl Collector {\n                         no_run,\n                         as_test_harness,\n                         compile_fail,\n+                        error_codes,\n                         &opts);\n             })\n         });"}]}