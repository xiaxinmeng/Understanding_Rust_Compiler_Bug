{"sha": "0f6fb0ec3b5ac5cd4a5e74c74813abec8257868b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBmNmZiMGVjM2I1YWM1Y2Q0YTVlNzRjNzQ4MTNhYmVjODI1Nzg2OGI=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-03-25T16:01:54Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-03-25T16:01:54Z"}, "message": "Merge #3722\n\n3722: Fix parsing lambdas with return type r=matklad a=matklad\n\nWe should eat only a single block, and not whatever larger expression\nmay start with a block.\n\ncloses #3721\n\n\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>", "tree": {"sha": "2e5bc7a56752adfe4297daf712ad45ff8430b9a7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2e5bc7a56752adfe4297daf712ad45ff8430b9a7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0f6fb0ec3b5ac5cd4a5e74c74813abec8257868b", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJee4ByCRBK7hj4Ov3rIwAAdHIIAHMz0mrW20niVAHVW7tfXPXX\nDb/HkylD43AUmmn62GF3GBTM7MVq/n3bvbW3w1OQL9sm7OEgHaqtKKu5RMitLMae\nAjP0KN96AXv8SSTaNxtzHDG4JIiC3AE4S7n0kP5200QGv5izX3PZ6e/iUxTxG3Jh\norq+RZs9vEVCoNgOupDp5X1cJxzxU55nbr7FZYg8urNlAfCGd2rZ3ydQbdTZZdWr\n5fYy4J/Zph5asAt5F8m4Y7fHu0Ceg+HptNpWy1KkCOhCjuKIq5eknngG5kYHkn1F\ngPCd+cxOys3LPCCb4id2W0dNtGcpEbNvMmF/dUaQMTmFDiZ7zoo+m6bSA2n7oHc=\n=a1R7\n-----END PGP SIGNATURE-----\n", "payload": "tree 2e5bc7a56752adfe4297daf712ad45ff8430b9a7\nparent a69fc239257bff1cda54bc2070cb197d477bb563\nparent f6188caaa0d226bef88418c9ff3f13a63ae95358\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1585152114 +0000\ncommitter GitHub <noreply@github.com> 1585152114 +0000\n\nMerge #3722\n\n3722: Fix parsing lambdas with return type r=matklad a=matklad\n\nWe should eat only a single block, and not whatever larger expression\nmay start with a block.\n\ncloses #3721\n\n\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0f6fb0ec3b5ac5cd4a5e74c74813abec8257868b", "html_url": "https://github.com/rust-lang/rust/commit/0f6fb0ec3b5ac5cd4a5e74c74813abec8257868b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0f6fb0ec3b5ac5cd4a5e74c74813abec8257868b/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a69fc239257bff1cda54bc2070cb197d477bb563", "url": "https://api.github.com/repos/rust-lang/rust/commits/a69fc239257bff1cda54bc2070cb197d477bb563", "html_url": "https://github.com/rust-lang/rust/commit/a69fc239257bff1cda54bc2070cb197d477bb563"}, {"sha": "f6188caaa0d226bef88418c9ff3f13a63ae95358", "url": "https://api.github.com/repos/rust-lang/rust/commits/f6188caaa0d226bef88418c9ff3f13a63ae95358", "html_url": "https://github.com/rust-lang/rust/commit/f6188caaa0d226bef88418c9ff3f13a63ae95358"}], "stats": {"total": 96, "additions": 75, "deletions": 21}, "files": [{"sha": "0d277a58662da297afc47671a1b9c093b39f50e2", "filename": "crates/ra_parser/src/grammar/expressions/atom.rs", "status": "modified", "additions": 13, "deletions": 7, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/0f6fb0ec3b5ac5cd4a5e74c74813abec8257868b/crates%2Fra_parser%2Fsrc%2Fgrammar%2Fexpressions%2Fatom.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0f6fb0ec3b5ac5cd4a5e74c74813abec8257868b/crates%2Fra_parser%2Fsrc%2Fgrammar%2Fexpressions%2Fatom.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_parser%2Fsrc%2Fgrammar%2Fexpressions%2Fatom.rs?ref=0f6fb0ec3b5ac5cd4a5e74c74813abec8257868b", "patch": "@@ -230,14 +230,20 @@ fn lambda_expr(p: &mut Parser) -> CompletedMarker {\n     p.eat(T![async]);\n     p.eat(T![move]);\n     params::param_list_closure(p);\n-    if opt_fn_ret_type(p) && !p.at(T!['{']) {\n-        p.error(\"expected `{`\");\n-    }\n-\n-    if p.at_ts(EXPR_FIRST) {\n-        expr(p);\n+    if opt_fn_ret_type(p) {\n+        if p.at(T!['{']) {\n+            // test lambda_ret_block\n+            // fn main() { || -> i32 { 92 }(); }\n+            block_expr(p, None);\n+        } else {\n+            p.error(\"expected `{`\");\n+        }\n     } else {\n-        p.error(\"expected expression\");\n+        if p.at_ts(EXPR_FIRST) {\n+            expr(p);\n+        } else {\n+            p.error(\"expected expression\");\n+        }\n     }\n     m.complete(p, LAMBDA_EXPR)\n }"}, {"sha": "0ffbd25aa880b6eb12f5aaef1072778f9bcd4382", "filename": "crates/ra_syntax/test_data/parser/err/0010_unsafe_lambda_block.txt", "status": "modified", "additions": 16, "deletions": 14, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/0f6fb0ec3b5ac5cd4a5e74c74813abec8257868b/crates%2Fra_syntax%2Ftest_data%2Fparser%2Ferr%2F0010_unsafe_lambda_block.txt", "raw_url": "https://github.com/rust-lang/rust/raw/0f6fb0ec3b5ac5cd4a5e74c74813abec8257868b/crates%2Fra_syntax%2Ftest_data%2Fparser%2Ferr%2F0010_unsafe_lambda_block.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_syntax%2Ftest_data%2Fparser%2Ferr%2F0010_unsafe_lambda_block.txt?ref=0f6fb0ec3b5ac5cd4a5e74c74813abec8257868b", "patch": "@@ -12,8 +12,8 @@ SOURCE_FILE@[0; 42)\n       BLOCK@[10; 41)\n         L_CURLY@[10; 11) \"{\"\n         WHITESPACE@[11; 16) \"\\n    \"\n-        EXPR_STMT@[16; 39)\n-          LAMBDA_EXPR@[16; 38)\n+        EXPR_STMT@[16; 24)\n+          LAMBDA_EXPR@[16; 24)\n             PARAM_LIST@[16; 18)\n               PIPE@[16; 17) \"|\"\n               PIPE@[17; 18) \"|\"\n@@ -24,20 +24,22 @@ SOURCE_FILE@[0; 42)\n               TUPLE_TYPE@[22; 24)\n                 L_PAREN@[22; 23) \"(\"\n                 R_PAREN@[23; 24) \")\"\n-            WHITESPACE@[24; 25) \" \"\n-            BLOCK_EXPR@[25; 38)\n-              UNSAFE_KW@[25; 31) \"unsafe\"\n-              WHITESPACE@[31; 32) \" \"\n-              BLOCK@[32; 38)\n-                L_CURLY@[32; 33) \"{\"\n-                WHITESPACE@[33; 34) \" \"\n-                TUPLE_EXPR@[34; 36)\n-                  L_PAREN@[34; 35) \"(\"\n-                  R_PAREN@[35; 36) \")\"\n-                WHITESPACE@[36; 37) \" \"\n-                R_CURLY@[37; 38) \"}\"\n+        WHITESPACE@[24; 25) \" \"\n+        EXPR_STMT@[25; 39)\n+          BLOCK_EXPR@[25; 38)\n+            UNSAFE_KW@[25; 31) \"unsafe\"\n+            WHITESPACE@[31; 32) \" \"\n+            BLOCK@[32; 38)\n+              L_CURLY@[32; 33) \"{\"\n+              WHITESPACE@[33; 34) \" \"\n+              TUPLE_EXPR@[34; 36)\n+                L_PAREN@[34; 35) \"(\"\n+                R_PAREN@[35; 36) \")\"\n+              WHITESPACE@[36; 37) \" \"\n+              R_CURLY@[37; 38) \"}\"\n           SEMI@[38; 39) \";\"\n         WHITESPACE@[39; 40) \"\\n\"\n         R_CURLY@[40; 41) \"}\"\n   WHITESPACE@[41; 42) \"\\n\"\n error [24; 24): expected `{`\n+error [24; 24): expected SEMI"}, {"sha": "061118d3aab8a43a1ccbe3ab0d369d27dc00ba89", "filename": "crates/ra_syntax/test_data/parser/inline/ok/0158_lambda_ret_block.rs", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/0f6fb0ec3b5ac5cd4a5e74c74813abec8257868b/crates%2Fra_syntax%2Ftest_data%2Fparser%2Finline%2Fok%2F0158_lambda_ret_block.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0f6fb0ec3b5ac5cd4a5e74c74813abec8257868b/crates%2Fra_syntax%2Ftest_data%2Fparser%2Finline%2Fok%2F0158_lambda_ret_block.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_syntax%2Ftest_data%2Fparser%2Finline%2Fok%2F0158_lambda_ret_block.rs?ref=0f6fb0ec3b5ac5cd4a5e74c74813abec8257868b", "patch": "@@ -0,0 +1 @@\n+fn main() { || -> i32 { 92 }(); }"}, {"sha": "ba8779094f7d7c93d425bc5202137361dde5b3f8", "filename": "crates/ra_syntax/test_data/parser/inline/ok/0158_lambda_ret_block.txt", "status": "added", "additions": 45, "deletions": 0, "changes": 45, "blob_url": "https://github.com/rust-lang/rust/blob/0f6fb0ec3b5ac5cd4a5e74c74813abec8257868b/crates%2Fra_syntax%2Ftest_data%2Fparser%2Finline%2Fok%2F0158_lambda_ret_block.txt", "raw_url": "https://github.com/rust-lang/rust/raw/0f6fb0ec3b5ac5cd4a5e74c74813abec8257868b/crates%2Fra_syntax%2Ftest_data%2Fparser%2Finline%2Fok%2F0158_lambda_ret_block.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_syntax%2Ftest_data%2Fparser%2Finline%2Fok%2F0158_lambda_ret_block.txt?ref=0f6fb0ec3b5ac5cd4a5e74c74813abec8257868b", "patch": "@@ -0,0 +1,45 @@\n+SOURCE_FILE@[0; 34)\n+  FN_DEF@[0; 33)\n+    FN_KW@[0; 2) \"fn\"\n+    WHITESPACE@[2; 3) \" \"\n+    NAME@[3; 7)\n+      IDENT@[3; 7) \"main\"\n+    PARAM_LIST@[7; 9)\n+      L_PAREN@[7; 8) \"(\"\n+      R_PAREN@[8; 9) \")\"\n+    WHITESPACE@[9; 10) \" \"\n+    BLOCK_EXPR@[10; 33)\n+      BLOCK@[10; 33)\n+        L_CURLY@[10; 11) \"{\"\n+        WHITESPACE@[11; 12) \" \"\n+        EXPR_STMT@[12; 31)\n+          CALL_EXPR@[12; 30)\n+            LAMBDA_EXPR@[12; 28)\n+              PARAM_LIST@[12; 14)\n+                PIPE@[12; 13) \"|\"\n+                PIPE@[13; 14) \"|\"\n+              WHITESPACE@[14; 15) \" \"\n+              RET_TYPE@[15; 21)\n+                THIN_ARROW@[15; 17) \"->\"\n+                WHITESPACE@[17; 18) \" \"\n+                PATH_TYPE@[18; 21)\n+                  PATH@[18; 21)\n+                    PATH_SEGMENT@[18; 21)\n+                      NAME_REF@[18; 21)\n+                        IDENT@[18; 21) \"i32\"\n+              WHITESPACE@[21; 22) \" \"\n+              BLOCK_EXPR@[22; 28)\n+                BLOCK@[22; 28)\n+                  L_CURLY@[22; 23) \"{\"\n+                  WHITESPACE@[23; 24) \" \"\n+                  LITERAL@[24; 26)\n+                    INT_NUMBER@[24; 26) \"92\"\n+                  WHITESPACE@[26; 27) \" \"\n+                  R_CURLY@[27; 28) \"}\"\n+            ARG_LIST@[28; 30)\n+              L_PAREN@[28; 29) \"(\"\n+              R_PAREN@[29; 30) \")\"\n+          SEMI@[30; 31) \";\"\n+        WHITESPACE@[31; 32) \" \"\n+        R_CURLY@[32; 33) \"}\"\n+  WHITESPACE@[33; 34) \"\\n\""}]}