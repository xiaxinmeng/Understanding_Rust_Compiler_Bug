{"sha": "cf349567e44a704a496af3933054ae554e529b18", "node_id": "MDY6Q29tbWl0NzI0NzEyOmNmMzQ5NTY3ZTQ0YTcwNGE0OTZhZjM5MzMwNTRhZTU1NGU1MjliMTg=", "commit": {"author": {"name": "Mara Bos", "email": "m-ou.se@m-ou.se", "date": "2020-11-17T09:06:13Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-11-17T09:06:13Z"}, "message": "Rollup merge of #77939 - GuillaumeGomez:fix-source-code-dos-backline, r=jyn514\n\nEnsure that the source code display is working with DOS backline\n\nFixes #76361.\n\ncc ````@lzutao````\nr? ````@jyn514````", "tree": {"sha": "9aeecba1497af764495843bb1af2ec30d5b945a8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9aeecba1497af764495843bb1af2ec30d5b945a8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cf349567e44a704a496af3933054ae554e529b18", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfs5KGCRBK7hj4Ov3rIwAAdHIIADkMtCGJi4vNwqnQI5AvX3UG\nKrTIqMfQ1avTI1hCfX7D4O4A2URlPunKHASti4wcv/L4I5Qx4hLO39Dj7SOpL8z4\noUajiwg93tAJtq/XlmkOGch39yrKW7TkQIqQ/0doYBByp1wFEw/mkevDsEdMfHPf\nihXxZ2sSMsGfxg6nvn0EjsHjFcaDgBsbDKWNPfiVMM+4amYDO9Kg1d3+robzdciX\nHQ2apAsJ7ElVRwrWIGn9sL6qPZRGyUA0VGsuuodqtBYoORT/rgzGK0ka9XL57Lmq\nkv5rfuQlSpsfO1BwAwWt4l7V6W/zAI8bBh+EtXgZXCNro0RoEVb1ozYgbM1hEZw=\n=PNc1\n-----END PGP SIGNATURE-----\n", "payload": "tree 9aeecba1497af764495843bb1af2ec30d5b945a8\nparent b5c37e86ff1782923e3abfbf5491dd383fcf827d\nparent 0c52044528580fb5b02eb0dca7bbbe3e584d6b13\nauthor Mara Bos <m-ou.se@m-ou.se> 1605603973 +0100\ncommitter GitHub <noreply@github.com> 1605603973 +0100\n\nRollup merge of #77939 - GuillaumeGomez:fix-source-code-dos-backline, r=jyn514\n\nEnsure that the source code display is working with DOS backline\n\nFixes #76361.\n\ncc ````@lzutao````\nr? ````@jyn514````\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cf349567e44a704a496af3933054ae554e529b18", "html_url": "https://github.com/rust-lang/rust/commit/cf349567e44a704a496af3933054ae554e529b18", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cf349567e44a704a496af3933054ae554e529b18/comments", "author": {"login": "m-ou-se", "id": 783247, "node_id": "MDQ6VXNlcjc4MzI0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/783247?v=4", "gravatar_id": "", "url": "https://api.github.com/users/m-ou-se", "html_url": "https://github.com/m-ou-se", "followers_url": "https://api.github.com/users/m-ou-se/followers", "following_url": "https://api.github.com/users/m-ou-se/following{/other_user}", "gists_url": "https://api.github.com/users/m-ou-se/gists{/gist_id}", "starred_url": "https://api.github.com/users/m-ou-se/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/m-ou-se/subscriptions", "organizations_url": "https://api.github.com/users/m-ou-se/orgs", "repos_url": "https://api.github.com/users/m-ou-se/repos", "events_url": "https://api.github.com/users/m-ou-se/events{/privacy}", "received_events_url": "https://api.github.com/users/m-ou-se/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b5c37e86ff1782923e3abfbf5491dd383fcf827d", "url": "https://api.github.com/repos/rust-lang/rust/commits/b5c37e86ff1782923e3abfbf5491dd383fcf827d", "html_url": "https://github.com/rust-lang/rust/commit/b5c37e86ff1782923e3abfbf5491dd383fcf827d"}, {"sha": "0c52044528580fb5b02eb0dca7bbbe3e584d6b13", "url": "https://api.github.com/repos/rust-lang/rust/commits/0c52044528580fb5b02eb0dca7bbbe3e584d6b13", "html_url": "https://github.com/rust-lang/rust/commit/0c52044528580fb5b02eb0dca7bbbe3e584d6b13"}], "stats": {"total": 39, "additions": 27, "deletions": 12}, "files": [{"sha": "48518ef0dd8cf33cefcf6182f5047778d1a76dfb", "filename": "src/librustdoc/html/highlight.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/cf349567e44a704a496af3933054ae554e529b18/src%2Flibrustdoc%2Fhtml%2Fhighlight.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf349567e44a704a496af3933054ae554e529b18/src%2Flibrustdoc%2Fhtml%2Fhighlight.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fhighlight.rs?ref=cf349567e44a704a496af3933054ae554e529b18", "patch": "@@ -46,7 +46,9 @@ fn write_header(out: &mut String, class: Option<&str>) {\n }\n \n fn write_code(out: &mut String, src: &str) {\n-    Classifier::new(src).highlight(&mut |highlight| {\n+    // This replace allows to fix how the code source with DOS backline characters is displayed.\n+    let src = src.replace(\"\\r\\n\", \"\\n\");\n+    Classifier::new(&src).highlight(&mut |highlight| {\n         match highlight {\n             Highlight::Token { text, class } => string(out, Escape(text), class),\n             Highlight::EnterSpan { class } => enter_span(out, class),"}, {"sha": "4400f85681d8a7d5110da6bbd205c0277223eb08", "filename": "src/librustdoc/html/highlight/fixtures/dos_line.html", "status": "added", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/cf349567e44a704a496af3933054ae554e529b18/src%2Flibrustdoc%2Fhtml%2Fhighlight%2Ffixtures%2Fdos_line.html", "raw_url": "https://github.com/rust-lang/rust/raw/cf349567e44a704a496af3933054ae554e529b18/src%2Flibrustdoc%2Fhtml%2Fhighlight%2Ffixtures%2Fdos_line.html", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fhighlight%2Ffixtures%2Fdos_line.html?ref=cf349567e44a704a496af3933054ae554e529b18", "patch": "@@ -0,0 +1,3 @@\n+<span class=\"kw\">pub</span> <span class=\"kw\">fn</span> <span class=\"ident\">foo</span>() {\n+<span class=\"macro\">println</span><span class=\"macro\">!</span>(<span class=\"string\">&quot;foo&quot;</span>);\n+}"}, {"sha": "f57f52d6f087554ae57537cb98be73daa4f67663", "filename": "src/librustdoc/html/highlight/tests.rs", "status": "modified", "additions": 21, "deletions": 11, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/cf349567e44a704a496af3933054ae554e529b18/src%2Flibrustdoc%2Fhtml%2Fhighlight%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cf349567e44a704a496af3933054ae554e529b18/src%2Flibrustdoc%2Fhtml%2Fhighlight%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fhighlight%2Ftests.rs?ref=cf349567e44a704a496af3933054ae554e529b18", "patch": "@@ -1,17 +1,6 @@\n use super::write_code;\n use expect_test::expect_file;\n \n-#[test]\n-fn test_html_highlighting() {\n-    let src = include_str!(\"fixtures/sample.rs\");\n-    let html = {\n-        let mut out = String::new();\n-        write_code(&mut out, src);\n-        format!(\"{}<pre><code>{}</code></pre>\\n\", STYLE, out)\n-    };\n-    expect_file![\"fixtures/sample.html\"].assert_eq(&html);\n-}\n-\n const STYLE: &str = r#\"\n <style>\n .kw { color: #8959A8; }\n@@ -23,3 +12,24 @@ const STYLE: &str = r#\"\n .question-mark { color: #ff9011; }\n </style>\n \"#;\n+\n+#[test]\n+fn test_html_highlighting() {\n+    let src = include_str!(\"fixtures/sample.rs\");\n+    let html = {\n+        let mut out = String::new();\n+        write_code(&mut out, src);\n+        format!(\"{}<pre><code>{}</code></pre>\\n\", STYLE, out)\n+    };\n+    expect_file![\"fixtures/sample.html\"].assert_eq(&html);\n+}\n+\n+#[test]\n+fn test_dos_backline() {\n+    let src = \"pub fn foo() {\\r\\n\\\n+    println!(\\\"foo\\\");\\r\\n\\\n+}\\r\\n\";\n+    let mut html = String::new();\n+    write_code(&mut html, src);\n+    expect_file![\"fixtures/dos_line.html\"].assert_eq(&html);\n+}"}]}