{"sha": "89e55d108c5c6d5f29c4eb0cb829e47bccb8598b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg5ZTU1ZDEwOGM1YzZkNWYyOWM0ZWIwY2I4MjllNDdiY2NiODU5OGI=", "commit": {"author": {"name": "John K\u00e5re Alsaker", "email": "john.kare.alsaker@gmail.com", "date": "2017-12-03T13:24:14Z"}, "committer": {"name": "John K\u00e5re Alsaker", "email": "john.kare.alsaker@gmail.com", "date": "2018-02-27T18:07:33Z"}, "message": "Make TransitiveRelation thread safe. Avoid locking by using get_mut in some cases.", "tree": {"sha": "31d9ce8a14ce07ad5af4923fd9469868dcbced5b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/31d9ce8a14ce07ad5af4923fd9469868dcbced5b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/89e55d108c5c6d5f29c4eb0cb829e47bccb8598b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/89e55d108c5c6d5f29c4eb0cb829e47bccb8598b", "html_url": "https://github.com/rust-lang/rust/commit/89e55d108c5c6d5f29c4eb0cb829e47bccb8598b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/89e55d108c5c6d5f29c4eb0cb829e47bccb8598b/comments", "author": {"login": "Zoxc", "id": 25784, "node_id": "MDQ6VXNlcjI1Nzg0", "avatar_url": "https://avatars.githubusercontent.com/u/25784?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Zoxc", "html_url": "https://github.com/Zoxc", "followers_url": "https://api.github.com/users/Zoxc/followers", "following_url": "https://api.github.com/users/Zoxc/following{/other_user}", "gists_url": "https://api.github.com/users/Zoxc/gists{/gist_id}", "starred_url": "https://api.github.com/users/Zoxc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Zoxc/subscriptions", "organizations_url": "https://api.github.com/users/Zoxc/orgs", "repos_url": "https://api.github.com/users/Zoxc/repos", "events_url": "https://api.github.com/users/Zoxc/events{/privacy}", "received_events_url": "https://api.github.com/users/Zoxc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Zoxc", "id": 25784, "node_id": "MDQ6VXNlcjI1Nzg0", "avatar_url": "https://avatars.githubusercontent.com/u/25784?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Zoxc", "html_url": "https://github.com/Zoxc", "followers_url": "https://api.github.com/users/Zoxc/followers", "following_url": "https://api.github.com/users/Zoxc/following{/other_user}", "gists_url": "https://api.github.com/users/Zoxc/gists{/gist_id}", "starred_url": "https://api.github.com/users/Zoxc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Zoxc/subscriptions", "organizations_url": "https://api.github.com/users/Zoxc/orgs", "repos_url": "https://api.github.com/users/Zoxc/repos", "events_url": "https://api.github.com/users/Zoxc/events{/privacy}", "received_events_url": "https://api.github.com/users/Zoxc/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "29f5c699b11a6a148f097f82eaa05202f8799bbc", "url": "https://api.github.com/repos/rust-lang/rust/commits/29f5c699b11a6a148f097f82eaa05202f8799bbc", "html_url": "https://github.com/rust-lang/rust/commit/29f5c699b11a6a148f097f82eaa05202f8799bbc"}], "stats": {"total": 20, "additions": 10, "deletions": 10}, "files": [{"sha": "6d63bc4436fe874348a4524d9926761fbe92eee1", "filename": "src/librustc_data_structures/transitive_relation.rs", "status": "modified", "additions": 10, "deletions": 10, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/89e55d108c5c6d5f29c4eb0cb829e47bccb8598b/src%2Flibrustc_data_structures%2Ftransitive_relation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/89e55d108c5c6d5f29c4eb0cb829e47bccb8598b/src%2Flibrustc_data_structures%2Ftransitive_relation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_data_structures%2Ftransitive_relation.rs?ref=89e55d108c5c6d5f29c4eb0cb829e47bccb8598b", "patch": "@@ -10,16 +10,16 @@\n \n use bitvec::BitMatrix;\n use fx::FxHashMap;\n+use sync::Lock;\n use rustc_serialize::{Encodable, Encoder, Decodable, Decoder};\n use stable_hasher::{HashStable, StableHasher, StableHasherResult};\n-use std::cell::RefCell;\n use std::fmt::Debug;\n use std::hash::Hash;\n use std::mem;\n \n \n #[derive(Clone, Debug)]\n-pub struct TransitiveRelation<T: Clone + Debug + Eq + Hash + Clone> {\n+pub struct TransitiveRelation<T: Clone + Debug + Eq + Hash> {\n     // List of elements. This is used to map from a T to a usize.\n     elements: Vec<T>,\n \n@@ -32,14 +32,14 @@ pub struct TransitiveRelation<T: Clone + Debug + Eq + Hash + Clone> {\n \n     // This is a cached transitive closure derived from the edges.\n     // Currently, we build it lazilly and just throw out any existing\n-    // copy whenever a new edge is added. (The RefCell is to permit\n+    // copy whenever a new edge is added. (The Lock is to permit\n     // the lazy computation.) This is kind of silly, except for the\n     // fact its size is tied to `self.elements.len()`, so I wanted to\n     // wait before building it up to avoid reallocating as new edges\n     // are added with new elements. Perhaps better would be to ask the\n     // user for a batch of edges to minimize this effect, but I\n     // already wrote the code this way. :P -nmatsakis\n-    closure: RefCell<Option<BitMatrix>>,\n+    closure: Lock<Option<BitMatrix>>,\n }\n \n #[derive(Copy, Clone, PartialEq, Eq, PartialOrd, Ord, Hash, RustcEncodable, RustcDecodable, Debug)]\n@@ -51,13 +51,13 @@ struct Edge {\n     target: Index,\n }\n \n-impl<T: Clone + Debug + Eq + Hash + Clone> TransitiveRelation<T> {\n+impl<T: Clone + Debug + Eq + Hash> TransitiveRelation<T> {\n     pub fn new() -> TransitiveRelation<T> {\n         TransitiveRelation {\n             elements: vec![],\n             map: FxHashMap(),\n             edges: vec![],\n-            closure: RefCell::new(None),\n+            closure: Lock::new(None),\n         }\n     }\n \n@@ -72,7 +72,7 @@ impl<T: Clone + Debug + Eq + Hash + Clone> TransitiveRelation<T> {\n     fn add_index(&mut self, a: T) -> Index {\n         let &mut TransitiveRelation {\n             ref mut elements,\n-            ref closure,\n+            ref mut closure,\n             ref mut map,\n             ..\n         } = self;\n@@ -82,7 +82,7 @@ impl<T: Clone + Debug + Eq + Hash + Clone> TransitiveRelation<T> {\n                elements.push(a);\n \n                // if we changed the dimensions, clear the cache\n-               *closure.borrow_mut() = None;\n+               *closure.get_mut() = None;\n \n                Index(elements.len() - 1)\n            })\n@@ -122,7 +122,7 @@ impl<T: Clone + Debug + Eq + Hash + Clone> TransitiveRelation<T> {\n             self.edges.push(edge);\n \n             // added an edge, clear the cache\n-            *self.closure.borrow_mut() = None;\n+            *self.closure.get_mut() = None;\n         }\n     }\n \n@@ -443,7 +443,7 @@ impl<T> Decodable for TransitiveRelation<T>\n                               .enumerate()\n                               .map(|(index, elem)| (elem.clone(), Index(index)))\n                               .collect();\n-            Ok(TransitiveRelation { elements, edges, map, closure: RefCell::new(None) })\n+            Ok(TransitiveRelation { elements, edges, map, closure: Lock::new(None) })\n         })\n     }\n }"}]}