{"sha": "141f8404a8dc2a6c00aafc917c11071275ee82ef", "node_id": "C_kwDOAAsO6NoAKDE0MWY4NDA0YThkYzJhNmMwMGFhZmM5MTdjMTEwNzEyNzVlZTgyZWY", "commit": {"author": {"name": "David Wood", "email": "david.wood@huawei.com", "date": "2022-04-02T05:09:43Z"}, "committer": {"name": "David Wood", "email": "david.wood@huawei.com", "date": "2022-04-05T06:01:03Z"}, "message": "errors: don't try load default locale from sysroot\n\nIf the user requests a diagnostic locale of \"en-US\" then it doesn't make\nsense to try and load that from the `$sysroot` because it is just the\ndefault built-in locale.\n\nSigned-off-by: David Wood <david.wood@huawei.com>", "tree": {"sha": "3ffb645cc033e689ad43d3d6689726056fdb80ac", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3ffb645cc033e689ad43d3d6689726056fdb80ac"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/141f8404a8dc2a6c00aafc917c11071275ee82ef", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/141f8404a8dc2a6c00aafc917c11071275ee82ef", "html_url": "https://github.com/rust-lang/rust/commit/141f8404a8dc2a6c00aafc917c11071275ee82ef", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/141f8404a8dc2a6c00aafc917c11071275ee82ef/comments", "author": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "committer": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "22685b9607936ae1330e2f84773c04292f5cdd30", "url": "https://api.github.com/repos/rust-lang/rust/commits/22685b9607936ae1330e2f84773c04292f5cdd30", "html_url": "https://github.com/rust-lang/rust/commit/22685b9607936ae1330e2f84773c04292f5cdd30"}], "stats": {"total": 12, "additions": 9, "deletions": 3}, "files": [{"sha": "4a83a84a83db354def3cc27dee572c7885ebb4ed", "filename": "compiler/rustc_error_messages/src/lib.rs", "status": "modified", "additions": 9, "deletions": 3, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/141f8404a8dc2a6c00aafc917c11071275ee82ef/compiler%2Frustc_error_messages%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/141f8404a8dc2a6c00aafc917c11071275ee82ef/compiler%2Frustc_error_messages%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_error_messages%2Fsrc%2Flib.rs?ref=141f8404a8dc2a6c00aafc917c11071275ee82ef", "patch": "@@ -1,3 +1,4 @@\n+#![feature(let_chains)]\n #![feature(path_try_exists)]\n \n use fluent_bundle::FluentResource;\n@@ -105,9 +106,12 @@ pub fn fluent_bundle(\n         return Ok(None);\n     }\n \n+    let fallback_locale = langid!(\"en-US\");\n+    let requested_fallback_locale = requested_locale.as_ref() == Some(&fallback_locale);\n+\n     // If there is only `-Z additional-ftl-path`, assume locale is \"en-US\", otherwise use user\n     // provided locale.\n-    let locale = requested_locale.clone().unwrap_or_else(|| langid!(\"en-US\"));\n+    let locale = requested_locale.clone().unwrap_or(fallback_locale);\n     trace!(?locale);\n     let mut bundle = FluentBundle::new(vec![locale]);\n \n@@ -118,7 +122,8 @@ pub fn fluent_bundle(\n     // surrounding diagnostic messages are right-to-left, then these might be helpful).\n     bundle.set_use_isolating(false);\n \n-    if let Some(requested_locale) = requested_locale {\n+    // If the user requests the default locale then don't try to load anything.\n+    if !requested_fallback_locale && let Some(requested_locale) = requested_locale {\n         let mut sysroot = sysroot.to_path_buf();\n         sysroot.push(\"share\");\n         sysroot.push(\"locale\");\n@@ -140,7 +145,8 @@ pub fn fluent_bundle(\n                 continue;\n             }\n \n-            let resource_str = fs::read_to_string(path).map_err(TranslationBundleError::ReadFtl)?;\n+            let resource_str =\n+                fs::read_to_string(path).map_err(TranslationBundleError::ReadFtl)?;\n             let resource =\n                 FluentResource::try_new(resource_str).map_err(TranslationBundleError::from)?;\n             trace!(?resource);"}]}