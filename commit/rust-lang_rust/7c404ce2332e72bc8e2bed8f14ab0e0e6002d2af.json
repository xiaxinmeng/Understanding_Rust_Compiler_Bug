{"sha": "7c404ce2332e72bc8e2bed8f14ab0e0e6002d2af", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdjNDA0Y2UyMzMyZTcyYmM4ZTJiZWQ4ZjE0YWIwZTBlNjAwMmQyYWY=", "commit": {"author": {"name": "Yuki Okushi", "email": "huyuumi.dev@gmail.com", "date": "2020-01-03T08:56:20Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-01-03T08:56:20Z"}, "message": "Rollup merge of #67450 - michaelwoerister:bootstrap-import-limit, r=Mark-Simulacrum\n\nAllow for setting a ThinLTO import limit during bootstrap\n\nThe benchmarks in https://github.com/rust-lang/rust/pull/66625 have shown that a lower ThinLTO import limit can be a net win for bootstrap times. This PR:\n- exposes the setting to `config.toml`,\n- defaults to a lower limit if `incremental = true` in `config.toml`, and\n- sets a lower limit for `x86_64-gnu-llvm-7` CI image in order to make the jobs complete more quickly (which remains to be tested).\n\nThis setting will affect how the compiler and it's tools are compiled. It will not affect the settings the compiler uses when compiling user code.\n\nr? @pietroalbini\ncc @rust-lang/infra", "tree": {"sha": "07e4d429366c3212dd75f5147c9797726c8382dd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/07e4d429366c3212dd75f5147c9797726c8382dd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7c404ce2332e72bc8e2bed8f14ab0e0e6002d2af", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJeDwG0CRBK7hj4Ov3rIwAAdHIIAFzItRBejTyU6S+t+f4GUz8g\nw6ChaBXIcZKqreWzwR5Mz3iVigrLxz9zY0Y+6uM6/ck8jldgYz856czozmSFdnkw\nJr7GWPdttvKnjeQ6usxqC9rDFJ8fnBo0FaTcElegJoqiySQocVrkTHsuhqJ0MNPN\nnbqzaP89uihsRaXX92BK32dVC4nN1drfGPKkHFJpOiRwuDRY6ZNT8TB4SEH0LD/t\nRr/G5l/RU+N8Rs8iAF5N/d5Mn0WJmGlo216QbiNBhMFxaGaVXKo6zkOfH3/BinG3\n/Ugs964RrW+Uml/xXixb3sSIDvD1PYzBt0jbOrD8UukKMKdhikx4WXz/68hpReM=\n=kGMH\n-----END PGP SIGNATURE-----\n", "payload": "tree 07e4d429366c3212dd75f5147c9797726c8382dd\nparent 0a58f5864659ddfe1d95c122abaa75c88220aed0\nparent 6f57bad3182aa67368948dde1bead475f064160d\nauthor Yuki Okushi <huyuumi.dev@gmail.com> 1578041780 +0900\ncommitter GitHub <noreply@github.com> 1578041780 +0900\n\nRollup merge of #67450 - michaelwoerister:bootstrap-import-limit, r=Mark-Simulacrum\n\nAllow for setting a ThinLTO import limit during bootstrap\n\nThe benchmarks in https://github.com/rust-lang/rust/pull/66625 have shown that a lower ThinLTO import limit can be a net win for bootstrap times. This PR:\n- exposes the setting to `config.toml`,\n- defaults to a lower limit if `incremental = true` in `config.toml`, and\n- sets a lower limit for `x86_64-gnu-llvm-7` CI image in order to make the jobs complete more quickly (which remains to be tested).\n\nThis setting will affect how the compiler and it's tools are compiled. It will not affect the settings the compiler uses when compiling user code.\n\nr? @pietroalbini\ncc @rust-lang/infra\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7c404ce2332e72bc8e2bed8f14ab0e0e6002d2af", "html_url": "https://github.com/rust-lang/rust/commit/7c404ce2332e72bc8e2bed8f14ab0e0e6002d2af", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7c404ce2332e72bc8e2bed8f14ab0e0e6002d2af/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0a58f5864659ddfe1d95c122abaa75c88220aed0", "url": "https://api.github.com/repos/rust-lang/rust/commits/0a58f5864659ddfe1d95c122abaa75c88220aed0", "html_url": "https://github.com/rust-lang/rust/commit/0a58f5864659ddfe1d95c122abaa75c88220aed0"}, {"sha": "6f57bad3182aa67368948dde1bead475f064160d", "url": "https://api.github.com/repos/rust-lang/rust/commits/6f57bad3182aa67368948dde1bead475f064160d", "html_url": "https://github.com/rust-lang/rust/commit/6f57bad3182aa67368948dde1bead475f064160d"}], "stats": {"total": 29, "additions": 28, "deletions": 1}, "files": [{"sha": "f22f4a5a97579a7298a97cadf25ecf3426ced9fc", "filename": "config.toml.example", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/7c404ce2332e72bc8e2bed8f14ab0e0e6002d2af/config.toml.example", "raw_url": "https://github.com/rust-lang/rust/raw/7c404ce2332e72bc8e2bed8f14ab0e0e6002d2af/config.toml.example", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/config.toml.example?ref=7c404ce2332e72bc8e2bed8f14ab0e0e6002d2af", "patch": "@@ -406,6 +406,13 @@\n # Whether to verify generated LLVM IR\n #verify-llvm-ir = false\n \n+# Compile the compiler with a non-default ThinLTO import limit. This import\n+# limit controls the maximum size of functions imported by ThinLTO. Decreasing\n+# will make code compile faster at the expense of lower runtime performance.\n+# If `incremental` is set to true above, the import limit will default to 10\n+# instead of LLVM's default of 100.\n+#thin-lto-import-instr-limit = 100\n+\n # Map all debuginfo paths for libstd and crates to `/rust/$sha/$crate/...`,\n # generally only set for releases\n #remap-debuginfo = false"}, {"sha": "f7d8daa75ecb5fb95fb5bdb5ff382075cb096674", "filename": "src/bootstrap/builder.rs", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/7c404ce2332e72bc8e2bed8f14ab0e0e6002d2af/src%2Fbootstrap%2Fbuilder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7c404ce2332e72bc8e2bed8f14ab0e0e6002d2af/src%2Fbootstrap%2Fbuilder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuilder.rs?ref=7c404ce2332e72bc8e2bed8f14ab0e0e6002d2af", "patch": "@@ -1183,6 +1183,21 @@ impl<'a> Builder<'a> {\n             rustflags.arg(\"-Cprefer-dynamic\");\n         }\n \n+        // When building incrementally we default to a lower ThinLTO import limit\n+        // (unless explicitly specified otherwise). This will produce a somewhat\n+        // slower code but give way better compile times.\n+        {\n+            let limit = match self.config.rust_thin_lto_import_instr_limit {\n+                Some(limit) => Some(limit),\n+                None if self.config.incremental => Some(10),\n+                _ => None,\n+            };\n+\n+            if let Some(limit) = limit {\n+                rustflags.arg(&format!(\"-Cllvm-args=-import-instr-limit={}\", limit));\n+            }\n+        }\n+\n         Cargo { command: cargo, rustflags }\n     }\n "}, {"sha": "ed65a606ff525013f186e66ed4cd6baf16164db7", "filename": "src/bootstrap/config.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/7c404ce2332e72bc8e2bed8f14ab0e0e6002d2af/src%2Fbootstrap%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7c404ce2332e72bc8e2bed8f14ab0e0e6002d2af/src%2Fbootstrap%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fconfig.rs?ref=7c404ce2332e72bc8e2bed8f14ab0e0e6002d2af", "patch": "@@ -108,6 +108,7 @@ pub struct Config {\n     pub rust_dist_src: bool,\n     pub rust_codegen_backends: Vec<Interned<String>>,\n     pub rust_verify_llvm_ir: bool,\n+    pub rust_thin_lto_import_instr_limit: Option<u32>,\n     pub rust_remap_debuginfo: bool,\n \n     pub build: Interned<String>,\n@@ -325,6 +326,7 @@ struct Rust {\n     deny_warnings: Option<bool>,\n     backtrace_on_ice: Option<bool>,\n     verify_llvm_ir: Option<bool>,\n+    thin_lto_import_instr_limit: Option<u32>,\n     remap_debuginfo: Option<bool>,\n     jemalloc: Option<bool>,\n     test_compare_mode: Option<bool>,\n@@ -569,6 +571,7 @@ impl Config {\n             set(&mut config.deny_warnings, flags.deny_warnings.or(rust.deny_warnings));\n             set(&mut config.backtrace_on_ice, rust.backtrace_on_ice);\n             set(&mut config.rust_verify_llvm_ir, rust.verify_llvm_ir);\n+            config.rust_thin_lto_import_instr_limit = rust.thin_lto_import_instr_limit;\n             set(&mut config.rust_remap_debuginfo, rust.remap_debuginfo);\n \n             if let Some(ref backends) = rust.codegen_backends {"}, {"sha": "dc90c286f5cd166aec3f0879883768ed6e48d261", "filename": "src/ci/docker/x86_64-gnu-llvm-7/Dockerfile", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/7c404ce2332e72bc8e2bed8f14ab0e0e6002d2af/src%2Fci%2Fdocker%2Fx86_64-gnu-llvm-7%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/7c404ce2332e72bc8e2bed8f14ab0e0e6002d2af/src%2Fci%2Fdocker%2Fx86_64-gnu-llvm-7%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fx86_64-gnu-llvm-7%2FDockerfile?ref=7c404ce2332e72bc8e2bed8f14ab0e0e6002d2af", "patch": "@@ -25,7 +25,9 @@ RUN sh /scripts/sccache.sh\n ENV RUST_CONFIGURE_ARGS \\\n       --build=x86_64-unknown-linux-gnu \\\n       --llvm-root=/usr/lib/llvm-7 \\\n-      --enable-llvm-link-shared\n+      --enable-llvm-link-shared \\\n+      --set rust.thin-lto-import-instr-limit=10\n+\n ENV SCRIPT python2.7 ../x.py test src/tools/tidy && python2.7 ../x.py test\n \n # The purpose of this container isn't to test with debug assertions and"}]}