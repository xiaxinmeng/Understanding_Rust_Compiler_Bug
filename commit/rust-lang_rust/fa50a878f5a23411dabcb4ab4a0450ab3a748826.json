{"sha": "fa50a878f5a23411dabcb4ab4a0450ab3a748826", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZhNTBhODc4ZjVhMjM0MTFkYWJjYjRhYjRhMDQ1MGFiM2E3NDg4MjY=", "commit": {"author": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2020-07-11T06:26:39Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-07-11T06:26:39Z"}, "message": "Rollup merge of #74103 - ajpaverd:cfguard-msvc-only, r=nikomatsakis\n\nOnly add CFGuard on `windows-msvc` targets\n\nAs @ollie27 pointed out in #73893, the `cfguard` module flag causes incorrect behavior on `windows-gnu` targets. This patch restricts rustc to only add this flag for `windows-msvc` targets (this may need to be changed if other linkers gain support for CFGuard).", "tree": {"sha": "741f5e5b2a461546c5f2b11a989cb55314aab440", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/741f5e5b2a461546c5f2b11a989cb55314aab440"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fa50a878f5a23411dabcb4ab4a0450ab3a748826", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfCVugCRBK7hj4Ov3rIwAAdHIIAI8ta7f3mdkxuJ4miQaJvqMI\nvQpzhmUxbm0Run9OUbJJKpb+7HKbkSvO8D/Kvbx+eXfmfxHM7nKeAPf6LiDiqV6K\n5c5fEH8ILXIDieLkKtTC4STxRMhtryxGTGOzK8/K/gST4qR77WSr60GkUb/LoZ8N\nQ+9rKLLYnUFTEhWsrUFHfdQxZqN21a5hwB/e7k70Wj/GK6C/PAdyiiY3HeMBDD5/\nHTvEjvWbm+57Vt3FZzsUcbbFXqt93aOrfvFdSOM+133VtByoCtJyu3MNuRO4M9Ru\nLWQKjo8mrl8vMFXsCHqC1ebiaXI3mxcGK9eQzvGhLr9VVM6U9ufXzsU5RH+eURA=\n=VQng\n-----END PGP SIGNATURE-----\n", "payload": "tree 741f5e5b2a461546c5f2b11a989cb55314aab440\nparent 3a6209cd706179f7cb639f5688adad5b0dd3ad1c\nparent 1ca7bfe481a18909e4769a9f6aee58f8cec17b44\nauthor Manish Goregaokar <manishsmail@gmail.com> 1594448799 -0700\ncommitter GitHub <noreply@github.com> 1594448799 -0700\n\nRollup merge of #74103 - ajpaverd:cfguard-msvc-only, r=nikomatsakis\n\nOnly add CFGuard on `windows-msvc` targets\n\nAs @ollie27 pointed out in #73893, the `cfguard` module flag causes incorrect behavior on `windows-gnu` targets. This patch restricts rustc to only add this flag for `windows-msvc` targets (this may need to be changed if other linkers gain support for CFGuard).\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fa50a878f5a23411dabcb4ab4a0450ab3a748826", "html_url": "https://github.com/rust-lang/rust/commit/fa50a878f5a23411dabcb4ab4a0450ab3a748826", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fa50a878f5a23411dabcb4ab4a0450ab3a748826/comments", "author": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3a6209cd706179f7cb639f5688adad5b0dd3ad1c", "url": "https://api.github.com/repos/rust-lang/rust/commits/3a6209cd706179f7cb639f5688adad5b0dd3ad1c", "html_url": "https://github.com/rust-lang/rust/commit/3a6209cd706179f7cb639f5688adad5b0dd3ad1c"}, {"sha": "1ca7bfe481a18909e4769a9f6aee58f8cec17b44", "url": "https://api.github.com/repos/rust-lang/rust/commits/1ca7bfe481a18909e4769a9f6aee58f8cec17b44", "html_url": "https://github.com/rust-lang/rust/commit/1ca7bfe481a18909e4769a9f6aee58f8cec17b44"}], "stats": {"total": 55, "additions": 36, "deletions": 19}, "files": [{"sha": "21ba97d15a485776362716ed8b84b6c946cd1f8d", "filename": "src/librustc_codegen_llvm/context.rs", "status": "modified", "additions": 12, "deletions": 7, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/fa50a878f5a23411dabcb4ab4a0450ab3a748826/src%2Flibrustc_codegen_llvm%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fa50a878f5a23411dabcb4ab4a0450ab3a748826/src%2Flibrustc_codegen_llvm%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fcontext.rs?ref=fa50a878f5a23411dabcb4ab4a0450ab3a748826", "patch": "@@ -188,14 +188,19 @@ pub unsafe fn create_module(\n         llvm::LLVMRustAddModuleFlag(llmod, avoid_plt, 1);\n     }\n \n-    // Set module flags to enable Windows Control Flow Guard (/guard:cf) metadata\n-    // only (`cfguard=1`) or metadata and checks (`cfguard=2`).\n-    match sess.opts.debugging_opts.control_flow_guard {\n-        CFGuard::Disabled => {}\n-        CFGuard::NoChecks => {\n-            llvm::LLVMRustAddModuleFlag(llmod, \"cfguard\\0\".as_ptr() as *const _, 1)\n+    // Control Flow Guard is currently only supported by the MSVC linker on Windows.\n+    if sess.target.target.options.is_like_msvc {\n+        match sess.opts.debugging_opts.control_flow_guard {\n+            CFGuard::Disabled => {}\n+            CFGuard::NoChecks => {\n+                // Set `cfguard=1` module flag to emit metadata only.\n+                llvm::LLVMRustAddModuleFlag(llmod, \"cfguard\\0\".as_ptr() as *const _, 1)\n+            }\n+            CFGuard::Checks => {\n+                // Set `cfguard=2` module flag to emit metadata and checks.\n+                llvm::LLVMRustAddModuleFlag(llmod, \"cfguard\\0\".as_ptr() as *const _, 2)\n+            }\n         }\n-        CFGuard::Checks => llvm::LLVMRustAddModuleFlag(llmod, \"cfguard\\0\".as_ptr() as *const _, 2),\n     }\n \n     llmod"}, {"sha": "550de75c709fb8d194549dac6aaf796bb418b0a4", "filename": "src/librustc_codegen_ssa/back/linker.rs", "status": "modified", "additions": 4, "deletions": 12, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/fa50a878f5a23411dabcb4ab4a0450ab3a748826/src%2Flibrustc_codegen_ssa%2Fback%2Flinker.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fa50a878f5a23411dabcb4ab4a0450ab3a748826/src%2Flibrustc_codegen_ssa%2Fback%2Flinker.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_ssa%2Fback%2Flinker.rs?ref=fa50a878f5a23411dabcb4ab4a0450ab3a748826", "patch": "@@ -475,9 +475,7 @@ impl<'a> Linker for GccLinker<'a> {\n         self.cmd.arg(\"__llvm_profile_runtime\");\n     }\n \n-    fn control_flow_guard(&mut self) {\n-        self.sess.warn(\"Windows Control Flow Guard is not supported by this linker.\");\n-    }\n+    fn control_flow_guard(&mut self) {}\n \n     fn debuginfo(&mut self, strip: Strip) {\n         match strip {\n@@ -959,9 +957,7 @@ impl<'a> Linker for EmLinker<'a> {\n         // noop, but maybe we need something like the gnu linker?\n     }\n \n-    fn control_flow_guard(&mut self) {\n-        self.sess.warn(\"Windows Control Flow Guard is not supported by this linker.\");\n-    }\n+    fn control_flow_guard(&mut self) {}\n \n     fn debuginfo(&mut self, _strip: Strip) {\n         // Preserve names or generate source maps depending on debug info\n@@ -1163,9 +1159,7 @@ impl<'a> Linker for WasmLd<'a> {\n         }\n     }\n \n-    fn control_flow_guard(&mut self) {\n-        self.sess.warn(\"Windows Control Flow Guard is not supported by this linker.\");\n-    }\n+    fn control_flow_guard(&mut self) {}\n \n     fn no_crt_objects(&mut self) {}\n \n@@ -1330,9 +1324,7 @@ impl<'a> Linker for PtxLinker<'a> {\n \n     fn no_default_libraries(&mut self) {}\n \n-    fn control_flow_guard(&mut self) {\n-        self.sess.warn(\"Windows Control Flow Guard is not supported by this linker.\");\n-    }\n+    fn control_flow_guard(&mut self) {}\n \n     fn export_symbols(&mut self, _tmpdir: &Path, _crate_type: CrateType) {}\n "}, {"sha": "96a0a321199a37dc6e03eeb8f973cda45862ba64", "filename": "src/test/codegen/cfguard-checks.rs", "status": "renamed", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/fa50a878f5a23411dabcb4ab4a0450ab3a748826/src%2Ftest%2Fcodegen%2Fcfguard-checks.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fa50a878f5a23411dabcb4ab4a0450ab3a748826/src%2Ftest%2Fcodegen%2Fcfguard-checks.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fcfguard-checks.rs?ref=fa50a878f5a23411dabcb4ab4a0450ab3a748826", "patch": "@@ -1,4 +1,5 @@\n // compile-flags: -Z control-flow-guard=checks\n+// only-msvc\n \n #![crate_type = \"lib\"]\n ", "previous_filename": "src/test/codegen/cfguard_checks.rs"}, {"sha": "925e4e8e2d15557bc4dd9fdb9d43fcddba7cc6c1", "filename": "src/test/codegen/cfguard-disabled.rs", "status": "renamed", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/fa50a878f5a23411dabcb4ab4a0450ab3a748826/src%2Ftest%2Fcodegen%2Fcfguard-disabled.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fa50a878f5a23411dabcb4ab4a0450ab3a748826/src%2Ftest%2Fcodegen%2Fcfguard-disabled.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fcfguard-disabled.rs?ref=fa50a878f5a23411dabcb4ab4a0450ab3a748826", "patch": "@@ -1,4 +1,5 @@\n // compile-flags: -Z control-flow-guard=no\n+// only-msvc\n \n #![crate_type = \"lib\"]\n ", "previous_filename": "src/test/codegen/cfguard_disabled.rs"}, {"sha": "d7dc3d7e89eea007fdeb644d237efab8dd6c181d", "filename": "src/test/codegen/cfguard-nochecks.rs", "status": "renamed", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/fa50a878f5a23411dabcb4ab4a0450ab3a748826/src%2Ftest%2Fcodegen%2Fcfguard-nochecks.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fa50a878f5a23411dabcb4ab4a0450ab3a748826/src%2Ftest%2Fcodegen%2Fcfguard-nochecks.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fcfguard-nochecks.rs?ref=fa50a878f5a23411dabcb4ab4a0450ab3a748826", "patch": "@@ -1,4 +1,5 @@\n // compile-flags: -Z control-flow-guard=nochecks\n+// only-msvc\n \n #![crate_type = \"lib\"]\n ", "previous_filename": "src/test/codegen/cfguard_nochecks.rs"}, {"sha": "4008f0187a0b05bc318262744e5d8bb17d4ff63e", "filename": "src/test/codegen/cfguard-non-msvc.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/fa50a878f5a23411dabcb4ab4a0450ab3a748826/src%2Ftest%2Fcodegen%2Fcfguard-non-msvc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fa50a878f5a23411dabcb4ab4a0450ab3a748826/src%2Ftest%2Fcodegen%2Fcfguard-non-msvc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fcfguard-non-msvc.rs?ref=fa50a878f5a23411dabcb4ab4a0450ab3a748826", "patch": "@@ -0,0 +1,11 @@\n+// compile-flags: -Z control-flow-guard\n+// ignore-msvc\n+\n+#![crate_type = \"lib\"]\n+\n+// A basic test function.\n+pub fn test() {\n+}\n+\n+// Ensure the cfguard module flag is not added for non-MSVC targets.\n+// CHECK-NOT: !\"cfguard\""}, {"sha": "21368fad3b05848a47ae08cfaa1c02f3e006e264", "filename": "src/test/ui/cfguard-run.rs", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/fa50a878f5a23411dabcb4ab4a0450ab3a748826/src%2Ftest%2Fui%2Fcfguard-run.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fa50a878f5a23411dabcb4ab4a0450ab3a748826/src%2Ftest%2Fui%2Fcfguard-run.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcfguard-run.rs?ref=fa50a878f5a23411dabcb4ab4a0450ab3a748826", "patch": "@@ -0,0 +1,6 @@\n+// run-pass\n+// compile-flags: -Z control-flow-guard\n+\n+pub fn main() {\n+    println!(\"hello, world\");\n+}"}]}