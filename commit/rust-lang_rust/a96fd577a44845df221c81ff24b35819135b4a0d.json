{"sha": "a96fd577a44845df221c81ff24b35819135b4a0d", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE5NmZkNTc3YTQ0ODQ1ZGYyMjFjODFmZjI0YjM1ODE5MTM1YjRhMGQ=", "commit": {"author": {"name": "Nathaniel McCallum", "email": "nathaniel@congru.us", "date": "2021-08-03T21:43:21Z"}, "committer": {"name": "Nathaniel McCallum", "email": "nathaniel@congru.us", "date": "2021-08-03T21:50:50Z"}, "message": "Validate FFI-safety warnings on naked functions\n\nTest that FFI-safety warnings don't get accidentally dropped on naked\nfunctions. The big picture is that if you implement a naked function\nwith the Rust ABI you'll get a warning. Further, if you implement a\nnaked function with a standardized ABI, but use non-FFI-safe types you\nwill still get a warning.\n\nrust-lang/rfcs#2774\nrust-lang/rfcs#2972", "tree": {"sha": "b6f5f467f4eeeba471b47311a77e5240ecee4581", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b6f5f467f4eeeba471b47311a77e5240ecee4581"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a96fd577a44845df221c81ff24b35819135b4a0d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a96fd577a44845df221c81ff24b35819135b4a0d", "html_url": "https://github.com/rust-lang/rust/commit/a96fd577a44845df221c81ff24b35819135b4a0d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a96fd577a44845df221c81ff24b35819135b4a0d/comments", "author": {"login": "npmccallum", "id": 288304, "node_id": "MDQ6VXNlcjI4ODMwNA==", "avatar_url": "https://avatars.githubusercontent.com/u/288304?v=4", "gravatar_id": "", "url": "https://api.github.com/users/npmccallum", "html_url": "https://github.com/npmccallum", "followers_url": "https://api.github.com/users/npmccallum/followers", "following_url": "https://api.github.com/users/npmccallum/following{/other_user}", "gists_url": "https://api.github.com/users/npmccallum/gists{/gist_id}", "starred_url": "https://api.github.com/users/npmccallum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/npmccallum/subscriptions", "organizations_url": "https://api.github.com/users/npmccallum/orgs", "repos_url": "https://api.github.com/users/npmccallum/repos", "events_url": "https://api.github.com/users/npmccallum/events{/privacy}", "received_events_url": "https://api.github.com/users/npmccallum/received_events", "type": "User", "site_admin": false}, "committer": {"login": "npmccallum", "id": 288304, "node_id": "MDQ6VXNlcjI4ODMwNA==", "avatar_url": "https://avatars.githubusercontent.com/u/288304?v=4", "gravatar_id": "", "url": "https://api.github.com/users/npmccallum", "html_url": "https://github.com/npmccallum", "followers_url": "https://api.github.com/users/npmccallum/followers", "following_url": "https://api.github.com/users/npmccallum/following{/other_user}", "gists_url": "https://api.github.com/users/npmccallum/gists{/gist_id}", "starred_url": "https://api.github.com/users/npmccallum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/npmccallum/subscriptions", "organizations_url": "https://api.github.com/users/npmccallum/orgs", "repos_url": "https://api.github.com/users/npmccallum/repos", "events_url": "https://api.github.com/users/npmccallum/events{/privacy}", "received_events_url": "https://api.github.com/users/npmccallum/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c6bc102fea9f9274202d0bc55a0fef8a3bc92426", "url": "https://api.github.com/repos/rust-lang/rust/commits/c6bc102fea9f9274202d0bc55a0fef8a3bc92426", "html_url": "https://github.com/rust-lang/rust/commit/c6bc102fea9f9274202d0bc55a0fef8a3bc92426"}], "stats": {"total": 32, "additions": 32, "deletions": 0}, "files": [{"sha": "5b2a8ed3034a6cffe1714af6c75902063079cece", "filename": "src/test/ui/asm/naked-functions-ffi.rs", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/a96fd577a44845df221c81ff24b35819135b4a0d/src%2Ftest%2Fui%2Fasm%2Fnaked-functions-ffi.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a96fd577a44845df221c81ff24b35819135b4a0d/src%2Ftest%2Fui%2Fasm%2Fnaked-functions-ffi.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasm%2Fnaked-functions-ffi.rs?ref=a96fd577a44845df221c81ff24b35819135b4a0d", "patch": "@@ -0,0 +1,12 @@\n+// check-pass\n+// only-x86_64\n+#![feature(asm)]\n+#![feature(naked_functions)]\n+#![crate_type = \"lib\"]\n+\n+#[naked]\n+pub extern \"C\" fn naked(p: char) -> u128 {\n+    //~^ WARN uses type `char`\n+    //~| WARN uses type `u128`\n+    unsafe { asm!(\"\", options(noreturn)); }\n+}"}, {"sha": "a6772badeb65f50870eab9169a755f30978c5608", "filename": "src/test/ui/asm/naked-functions-ffi.stderr", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/a96fd577a44845df221c81ff24b35819135b4a0d/src%2Ftest%2Fui%2Fasm%2Fnaked-functions-ffi.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/a96fd577a44845df221c81ff24b35819135b4a0d/src%2Ftest%2Fui%2Fasm%2Fnaked-functions-ffi.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasm%2Fnaked-functions-ffi.stderr?ref=a96fd577a44845df221c81ff24b35819135b4a0d", "patch": "@@ -0,0 +1,20 @@\n+warning: `extern` fn uses type `char`, which is not FFI-safe\n+  --> $DIR/naked-functions-ffi.rs:8:28\n+   |\n+LL | pub extern \"C\" fn naked(p: char) -> u128 {\n+   |                            ^^^^ not FFI-safe\n+   |\n+   = note: `#[warn(improper_ctypes_definitions)]` on by default\n+   = help: consider using `u32` or `libc::wchar_t` instead\n+   = note: the `char` type has no C equivalent\n+\n+warning: `extern` fn uses type `u128`, which is not FFI-safe\n+  --> $DIR/naked-functions-ffi.rs:8:37\n+   |\n+LL | pub extern \"C\" fn naked(p: char) -> u128 {\n+   |                                     ^^^^ not FFI-safe\n+   |\n+   = note: 128-bit integers don't currently have a known stable ABI\n+\n+warning: 2 warnings emitted\n+"}]}