{"sha": "9791b9c36a7b59f94c257b3ca019ae76e66a6879", "node_id": "MDY6Q29tbWl0NzI0NzEyOjk3OTFiOWMzNmE3YjU5Zjk0YzI1N2IzY2EwMTlhZTc2ZTY2YTY4Nzk=", "commit": {"author": {"name": "kjeremy", "email": "kjeremy@gmail.com", "date": "2020-01-08T21:35:58Z"}, "committer": {"name": "kjeremy", "email": "kjeremy@gmail.com", "date": "2020-01-08T21:35:58Z"}, "message": "Actually test references", "tree": {"sha": "af58d7614b3335b5f06e2ac37d98ed85c1c62489", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/af58d7614b3335b5f06e2ac37d98ed85c1c62489"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9791b9c36a7b59f94c257b3ca019ae76e66a6879", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9791b9c36a7b59f94c257b3ca019ae76e66a6879", "html_url": "https://github.com/rust-lang/rust/commit/9791b9c36a7b59f94c257b3ca019ae76e66a6879", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9791b9c36a7b59f94c257b3ca019ae76e66a6879/comments", "author": {"login": "kjeremy", "id": 4325700, "node_id": "MDQ6VXNlcjQzMjU3MDA=", "avatar_url": "https://avatars.githubusercontent.com/u/4325700?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kjeremy", "html_url": "https://github.com/kjeremy", "followers_url": "https://api.github.com/users/kjeremy/followers", "following_url": "https://api.github.com/users/kjeremy/following{/other_user}", "gists_url": "https://api.github.com/users/kjeremy/gists{/gist_id}", "starred_url": "https://api.github.com/users/kjeremy/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kjeremy/subscriptions", "organizations_url": "https://api.github.com/users/kjeremy/orgs", "repos_url": "https://api.github.com/users/kjeremy/repos", "events_url": "https://api.github.com/users/kjeremy/events{/privacy}", "received_events_url": "https://api.github.com/users/kjeremy/received_events", "type": "User", "site_admin": false}, "committer": {"login": "kjeremy", "id": 4325700, "node_id": "MDQ6VXNlcjQzMjU3MDA=", "avatar_url": "https://avatars.githubusercontent.com/u/4325700?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kjeremy", "html_url": "https://github.com/kjeremy", "followers_url": "https://api.github.com/users/kjeremy/followers", "following_url": "https://api.github.com/users/kjeremy/following{/other_user}", "gists_url": "https://api.github.com/users/kjeremy/gists{/gist_id}", "starred_url": "https://api.github.com/users/kjeremy/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kjeremy/subscriptions", "organizations_url": "https://api.github.com/users/kjeremy/orgs", "repos_url": "https://api.github.com/users/kjeremy/repos", "events_url": "https://api.github.com/users/kjeremy/events{/privacy}", "received_events_url": "https://api.github.com/users/kjeremy/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2ffaad10f24ad9d3d748a347e02f170f24833ec3", "url": "https://api.github.com/repos/rust-lang/rust/commits/2ffaad10f24ad9d3d748a347e02f170f24833ec3", "html_url": "https://github.com/rust-lang/rust/commit/2ffaad10f24ad9d3d748a347e02f170f24833ec3"}], "stats": {"total": 114, "additions": 99, "deletions": 15}, "files": [{"sha": "7b187eba354a5374698b024c7573393c9d92e432", "filename": "crates/ra_ide/src/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/9791b9c36a7b59f94c257b3ca019ae76e66a6879/crates%2Fra_ide%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9791b9c36a7b59f94c257b3ca019ae76e66a6879/crates%2Fra_ide%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Flib.rs?ref=9791b9c36a7b59f94c257b3ca019ae76e66a6879", "patch": "@@ -75,7 +75,7 @@ pub use crate::{\n     inlay_hints::{InlayHint, InlayKind},\n     line_index::{LineCol, LineIndex},\n     line_index_utils::translate_offset_with_edit,\n-    references::{ReferenceSearchResult, SearchScope},\n+    references::{Reference, ReferenceKind, ReferenceSearchResult, SearchScope},\n     runnables::{Runnable, RunnableKind},\n     source_change::{FileSystemEdit, SourceChange, SourceFileEdit},\n     syntax_highlighting::HighlightedRange,"}, {"sha": "d1f52f808dda21c078107a87656fc09009f7866b", "filename": "crates/ra_ide/src/references.rs", "status": "modified", "additions": 98, "deletions": 14, "changes": 112, "blob_url": "https://github.com/rust-lang/rust/blob/9791b9c36a7b59f94c257b3ca019ae76e66a6879/crates%2Fra_ide%2Fsrc%2Freferences.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9791b9c36a7b59f94c257b3ca019ae76e66a6879/crates%2Fra_ide%2Fsrc%2Freferences.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Freferences.rs?ref=9791b9c36a7b59f94c257b3ca019ae76e66a6879", "patch": "@@ -214,7 +214,7 @@ fn process_definition(\n mod tests {\n     use crate::{\n         mock_analysis::{analysis_and_position, single_file_with_position, MockAnalysis},\n-        ReferenceSearchResult, SearchScope,\n+        Reference, ReferenceKind, ReferenceSearchResult, SearchScope,\n     };\n \n     #[test]\n@@ -232,7 +232,12 @@ mod tests {\n     }\"#;\n \n         let refs = get_all_refs(code);\n-        assert_eq!(refs.len(), 2);\n+        check_result(\n+            refs,\n+            \"Foo STRUCT_DEF FileId(1) [5; 39) [12; 15)\",\n+            ReferenceKind::Other,\n+            &[\"FileId(1) [142; 145) StructLiteral\"],\n+        );\n     }\n \n     #[test]\n@@ -251,7 +256,17 @@ mod tests {\n     }\"#;\n \n         let refs = get_all_refs(code);\n-        assert_eq!(refs.len(), 5);\n+        check_result(\n+            refs,\n+            \"i BIND_PAT FileId(1) [33; 34)\",\n+            ReferenceKind::Other,\n+            &[\n+                \"FileId(1) [67; 68) Other\",\n+                \"FileId(1) [71; 72) Other\",\n+                \"FileId(1) [101; 102) Other\",\n+                \"FileId(1) [127; 128) Other\",\n+            ],\n+        );\n     }\n \n     #[test]\n@@ -262,7 +277,12 @@ mod tests {\n     }\"#;\n \n         let refs = get_all_refs(code);\n-        assert_eq!(refs.len(), 2);\n+        check_result(\n+            refs,\n+            \"i BIND_PAT FileId(1) [12; 13)\",\n+            ReferenceKind::Other,\n+            &[\"FileId(1) [38; 39) Other\"],\n+        );\n     }\n \n     #[test]\n@@ -273,7 +293,12 @@ mod tests {\n     }\"#;\n \n         let refs = get_all_refs(code);\n-        assert_eq!(refs.len(), 2);\n+        check_result(\n+            refs,\n+            \"i BIND_PAT FileId(1) [12; 13)\",\n+            ReferenceKind::Other,\n+            &[\"FileId(1) [38; 39) Other\"],\n+        );\n     }\n \n     #[test]\n@@ -290,7 +315,12 @@ mod tests {\n         \"#;\n \n         let refs = get_all_refs(code);\n-        assert_eq!(refs.len(), 2);\n+        check_result(\n+            refs,\n+            \"spam RECORD_FIELD_DEF FileId(1) [66; 79) [70; 74)\",\n+            ReferenceKind::Other,\n+            &[\"FileId(1) [152; 156) Other\"],\n+        );\n     }\n \n     #[test]\n@@ -304,7 +334,7 @@ mod tests {\n         \"#;\n \n         let refs = get_all_refs(code);\n-        assert_eq!(refs.len(), 1);\n+        check_result(refs, \"f FN_DEF FileId(1) [88; 104) [91; 92)\", ReferenceKind::Other, &[]);\n     }\n \n     #[test]\n@@ -319,7 +349,7 @@ mod tests {\n         \"#;\n \n         let refs = get_all_refs(code);\n-        assert_eq!(refs.len(), 1);\n+        check_result(refs, \"B ENUM_VARIANT FileId(1) [83; 84) [83; 84)\", ReferenceKind::Other, &[]);\n     }\n \n     #[test]\n@@ -358,7 +388,12 @@ mod tests {\n \n         let (analysis, pos) = analysis_and_position(code);\n         let refs = analysis.find_all_refs(pos, None).unwrap().unwrap();\n-        assert_eq!(refs.len(), 3);\n+        check_result(\n+            refs,\n+            \"Foo STRUCT_DEF FileId(2) [16; 50) [27; 30)\",\n+            ReferenceKind::Other,\n+            &[\"FileId(1) [52; 55) StructLiteral\", \"FileId(3) [77; 80) StructLiteral\"],\n+        );\n     }\n \n     // `mod foo;` is not in the results because `foo` is an `ast::Name`.\n@@ -384,7 +419,12 @@ mod tests {\n \n         let (analysis, pos) = analysis_and_position(code);\n         let refs = analysis.find_all_refs(pos, None).unwrap().unwrap();\n-        assert_eq!(refs.len(), 2);\n+        check_result(\n+            refs,\n+            \"foo SOURCE_FILE FileId(2) [0; 35)\",\n+            ReferenceKind::Other,\n+            &[\"FileId(1) [13; 16) Other\"],\n+        );\n     }\n \n     #[test]\n@@ -409,7 +449,12 @@ mod tests {\n \n         let (analysis, pos) = analysis_and_position(code);\n         let refs = analysis.find_all_refs(pos, None).unwrap().unwrap();\n-        assert_eq!(refs.len(), 3);\n+        check_result(\n+            refs,\n+            \"Foo STRUCT_DEF FileId(3) [0; 41) [18; 21)\",\n+            ReferenceKind::Other,\n+            &[\"FileId(2) [20; 23) Other\", \"FileId(2) [46; 49) StructLiteral\"],\n+        );\n     }\n \n     #[test]\n@@ -433,11 +478,21 @@ mod tests {\n         let analysis = mock.analysis();\n \n         let refs = analysis.find_all_refs(pos, None).unwrap().unwrap();\n-        assert_eq!(refs.len(), 3);\n+        check_result(\n+            refs,\n+            \"quux FN_DEF FileId(1) [18; 34) [25; 29)\",\n+            ReferenceKind::Other,\n+            &[\"FileId(2) [16; 20) Other\", \"FileId(3) [16; 20) Other\"],\n+        );\n \n         let refs =\n             analysis.find_all_refs(pos, Some(SearchScope::single_file(bar))).unwrap().unwrap();\n-        assert_eq!(refs.len(), 2);\n+        check_result(\n+            refs,\n+            \"quux FN_DEF FileId(1) [18; 34) [25; 29)\",\n+            ReferenceKind::Other,\n+            &[\"FileId(3) [16; 20) Other\"],\n+        );\n     }\n \n     #[test]\n@@ -452,11 +507,40 @@ mod tests {\n         }\"#;\n \n         let refs = get_all_refs(code);\n-        assert_eq!(refs.len(), 3);\n+        check_result(\n+            refs,\n+            \"m1 MACRO_CALL FileId(1) [9; 63) [46; 48)\",\n+            ReferenceKind::Other,\n+            &[\"FileId(1) [96; 98) Other\", \"FileId(1) [114; 116) Other\"],\n+        );\n     }\n \n     fn get_all_refs(text: &str) -> ReferenceSearchResult {\n         let (analysis, position) = single_file_with_position(text);\n         analysis.find_all_refs(position, None).unwrap().unwrap()\n     }\n+\n+    fn check_result(\n+        res: ReferenceSearchResult,\n+        expected_decl: &str,\n+        decl_kind: ReferenceKind,\n+        expected_refs: &[&str],\n+    ) {\n+        res.declaration().assert_match(expected_decl);\n+        assert_eq!(res.declaration_kind, decl_kind);\n+\n+        assert_eq!(res.references.len(), expected_refs.len());\n+        res.references().iter().enumerate().for_each(|(i, r)| r.assert_match(expected_refs[i]));\n+    }\n+\n+    impl Reference {\n+        pub fn debug_render(&self) -> String {\n+            format!(\"{:?} {:?} {:?}\", self.file_range.file_id, self.file_range.range, self.kind)\n+        }\n+\n+        pub fn assert_match(&self, expected: &str) {\n+            let actual = self.debug_render();\n+            test_utils::assert_eq_text!(expected.trim(), actual.trim(),);\n+        }\n+    }\n }"}]}