{"sha": "503e19d01e941b88bf6d5b28e9108d046abcfa2d", "node_id": "C_kwDOAAsO6NoAKDUwM2UxOWQwMWU5NDFiODhiZjZkNWIyOGU5MTA4ZDA0NmFiY2ZhMmQ", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-09-19T07:41:54Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-09-19T07:41:54Z"}, "message": "Auto merge of #101629 - compiler-errors:issue-101623, r=sanxiyn\n\nBe careful about `expr_ty_adjusted` when noting block tail type\n\nFixes #101623", "tree": {"sha": "f2b6f6bd176a03ff1c4e0b2588707d733eecb14c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f2b6f6bd176a03ff1c4e0b2588707d733eecb14c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/503e19d01e941b88bf6d5b28e9108d046abcfa2d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/503e19d01e941b88bf6d5b28e9108d046abcfa2d", "html_url": "https://github.com/rust-lang/rust/commit/503e19d01e941b88bf6d5b28e9108d046abcfa2d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/503e19d01e941b88bf6d5b28e9108d046abcfa2d/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "efa717bc2d82c19c6957f362a936a6f95169d138", "url": "https://api.github.com/repos/rust-lang/rust/commits/efa717bc2d82c19c6957f362a936a6f95169d138", "html_url": "https://github.com/rust-lang/rust/commit/efa717bc2d82c19c6957f362a936a6f95169d138"}, {"sha": "44738ee336f72e683b2c24dac22b919567ec03a7", "url": "https://api.github.com/repos/rust-lang/rust/commits/44738ee336f72e683b2c24dac22b919567ec03a7", "html_url": "https://github.com/rust-lang/rust/commit/44738ee336f72e683b2c24dac22b919567ec03a7"}], "stats": {"total": 48, "additions": 44, "deletions": 4}, "files": [{"sha": "d90b77fc55682721f988b6eb75c194b5cee7764b", "filename": "compiler/rustc_trait_selection/src/traits/error_reporting/suggestions.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/503e19d01e941b88bf6d5b28e9108d046abcfa2d/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/503e19d01e941b88bf6d5b28e9108d046abcfa2d/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs?ref=503e19d01e941b88bf6d5b28e9108d046abcfa2d", "patch": "@@ -2714,12 +2714,13 @@ impl<'a, 'tcx> InferCtxtExt<'tcx> for InferCtxt<'a, 'tcx> {\n                         Some(t) if t.hir_owner == parent_id => t,\n                         _ => self.tcx.typeck(parent_id),\n                     };\n-                    let ty = typeck_results.expr_ty_adjusted(expr);\n-                    let span = expr.peel_blocks().span;\n+                    let expr = expr.peel_blocks();\n+                    let ty = typeck_results.expr_ty_adjusted_opt(expr).unwrap_or(tcx.ty_error());\n+                    let span = expr.span;\n                     if Some(span) != err.span.primary_span() {\n                         err.span_label(\n                             span,\n-                            &if ty.references_error() {\n+                            if ty.references_error() {\n                                 String::new()\n                             } else {\n                                 format!(\"this tail expression is of type `{:?}`\", ty)"}, {"sha": "759d79493a9cf6e89803649b6d4676be1605b5df", "filename": "src/test/ui/expr/malformed_closure/ruby_style_closure.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/503e19d01e941b88bf6d5b28e9108d046abcfa2d/src%2Ftest%2Fui%2Fexpr%2Fmalformed_closure%2Fruby_style_closure.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/503e19d01e941b88bf6d5b28e9108d046abcfa2d/src%2Ftest%2Fui%2Fexpr%2Fmalformed_closure%2Fruby_style_closure.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fexpr%2Fmalformed_closure%2Fruby_style_closure.stderr?ref=503e19d01e941b88bf6d5b28e9108d046abcfa2d", "patch": "@@ -14,7 +14,7 @@ LL |       let p = Some(45).and_then({\n LL | |\n LL | |         |x| println!(\"doubling {}\", x);\n LL | |         Some(x * 2)\n-   | |         -----------\n+   | |         ----------- this tail expression is of type `std::option::Option<_>`\n LL | |\n LL | |     });\n    | |_____^ expected an `FnOnce<({integer},)>` closure, found `Option<_>`"}, {"sha": "d18a4a21f0a518b25534451faa880f53f37e779b", "filename": "src/test/ui/suggestions/issue-101623.rs", "status": "added", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/503e19d01e941b88bf6d5b28e9108d046abcfa2d/src%2Ftest%2Fui%2Fsuggestions%2Fissue-101623.rs", "raw_url": "https://github.com/rust-lang/rust/raw/503e19d01e941b88bf6d5b28e9108d046abcfa2d/src%2Ftest%2Fui%2Fsuggestions%2Fissue-101623.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsuggestions%2Fissue-101623.rs?ref=503e19d01e941b88bf6d5b28e9108d046abcfa2d", "patch": "@@ -0,0 +1,25 @@\n+pub struct Stuff {\n+    inner: *mut (),\n+}\n+\n+pub struct Wrap<T>(T);\n+\n+fn fun<T>(t: T) -> Wrap<T> {\n+    todo!()\n+}\n+\n+pub trait Trait<'de> {\n+    fn do_stuff(_: Wrap<&'de mut Self>);\n+}\n+\n+impl<'a> Trait<'a> for () {\n+    fn do_stuff(_: Wrap<&'a mut Self>) {}\n+}\n+\n+fn fun2(t: &mut Stuff) -> () {\n+    let Stuff { inner, .. } = t;\n+    Trait::do_stuff({ fun(&mut *inner) });\n+    //~^ ERROR the trait bound `*mut (): Trait<'_>` is not satisfied\n+}\n+\n+fn main() {}"}, {"sha": "361483cc08db2bdcddb1e865e2b2f074d8f0af97", "filename": "src/test/ui/suggestions/issue-101623.stderr", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/503e19d01e941b88bf6d5b28e9108d046abcfa2d/src%2Ftest%2Fui%2Fsuggestions%2Fissue-101623.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/503e19d01e941b88bf6d5b28e9108d046abcfa2d/src%2Ftest%2Fui%2Fsuggestions%2Fissue-101623.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsuggestions%2Fissue-101623.stderr?ref=503e19d01e941b88bf6d5b28e9108d046abcfa2d", "patch": "@@ -0,0 +1,14 @@\n+error[E0277]: the trait bound `*mut (): Trait<'_>` is not satisfied\n+  --> $DIR/issue-101623.rs:21:21\n+   |\n+LL |     Trait::do_stuff({ fun(&mut *inner) });\n+   |     --------------- ^^----------------^^\n+   |     |               |\n+   |     |               the trait `Trait<'_>` is not implemented for `*mut ()`\n+   |     required by a bound introduced by this call\n+   |\n+   = help: the trait `Trait<'a>` is implemented for `()`\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0277`."}]}