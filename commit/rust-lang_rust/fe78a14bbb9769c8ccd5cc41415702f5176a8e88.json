{"sha": "fe78a14bbb9769c8ccd5cc41415702f5176a8e88", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZlNzhhMTRiYmI5NzY5YzhjY2Q1Y2M0MTQxNTcwMmY1MTc2YThlODg=", "commit": {"author": {"name": "Edwin Cheng", "email": "edwin0cheng@gmail.com", "date": "2020-03-14T06:25:30Z"}, "committer": {"name": "Edwin Cheng", "email": "edwin0cheng@gmail.com", "date": "2020-03-14T06:25:51Z"}, "message": "Support local macro_rules", "tree": {"sha": "2ec165fbab4bba4d379d5b1936168456dab4585f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2ec165fbab4bba4d379d5b1936168456dab4585f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fe78a14bbb9769c8ccd5cc41415702f5176a8e88", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fe78a14bbb9769c8ccd5cc41415702f5176a8e88", "html_url": "https://github.com/rust-lang/rust/commit/fe78a14bbb9769c8ccd5cc41415702f5176a8e88", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fe78a14bbb9769c8ccd5cc41415702f5176a8e88/comments", "author": {"login": "edwin0cheng", "id": 11014119, "node_id": "MDQ6VXNlcjExMDE0MTE5", "avatar_url": "https://avatars.githubusercontent.com/u/11014119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/edwin0cheng", "html_url": "https://github.com/edwin0cheng", "followers_url": "https://api.github.com/users/edwin0cheng/followers", "following_url": "https://api.github.com/users/edwin0cheng/following{/other_user}", "gists_url": "https://api.github.com/users/edwin0cheng/gists{/gist_id}", "starred_url": "https://api.github.com/users/edwin0cheng/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/edwin0cheng/subscriptions", "organizations_url": "https://api.github.com/users/edwin0cheng/orgs", "repos_url": "https://api.github.com/users/edwin0cheng/repos", "events_url": "https://api.github.com/users/edwin0cheng/events{/privacy}", "received_events_url": "https://api.github.com/users/edwin0cheng/received_events", "type": "User", "site_admin": false}, "committer": {"login": "edwin0cheng", "id": 11014119, "node_id": "MDQ6VXNlcjExMDE0MTE5", "avatar_url": "https://avatars.githubusercontent.com/u/11014119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/edwin0cheng", "html_url": "https://github.com/edwin0cheng", "followers_url": "https://api.github.com/users/edwin0cheng/followers", "following_url": "https://api.github.com/users/edwin0cheng/following{/other_user}", "gists_url": "https://api.github.com/users/edwin0cheng/gists{/gist_id}", "starred_url": "https://api.github.com/users/edwin0cheng/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/edwin0cheng/subscriptions", "organizations_url": "https://api.github.com/users/edwin0cheng/orgs", "repos_url": "https://api.github.com/users/edwin0cheng/repos", "events_url": "https://api.github.com/users/edwin0cheng/events{/privacy}", "received_events_url": "https://api.github.com/users/edwin0cheng/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4c85e53531fc9e2e2c2f1368c01e08e10e190cd5", "url": "https://api.github.com/repos/rust-lang/rust/commits/4c85e53531fc9e2e2c2f1368c01e08e10e190cd5", "html_url": "https://github.com/rust-lang/rust/commit/4c85e53531fc9e2e2c2f1368c01e08e10e190cd5"}], "stats": {"total": 112, "additions": 96, "deletions": 16}, "files": [{"sha": "2bc405a59278b14050cd7785b770ddabbd00ee6b", "filename": "crates/ra_hir_def/src/body.rs", "status": "modified", "additions": 9, "deletions": 3, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/fe78a14bbb9769c8ccd5cc41415702f5176a8e88/crates%2Fra_hir_def%2Fsrc%2Fbody.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fe78a14bbb9769c8ccd5cc41415702f5176a8e88/crates%2Fra_hir_def%2Fsrc%2Fbody.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_def%2Fsrc%2Fbody.rs?ref=fe78a14bbb9769c8ccd5cc41415702f5176a8e88", "patch": "@@ -47,13 +47,19 @@ impl Expander {\n     pub(crate) fn enter_expand<T: ast::AstNode, DB: DefDatabase>(\n         &mut self,\n         db: &DB,\n+        local_scope: Option<&ItemScope>,\n         macro_call: ast::MacroCall,\n     ) -> Option<(Mark, T)> {\n         let macro_call = InFile::new(self.current_file_id, &macro_call);\n \n-        if let Some(call_id) =\n-            macro_call.as_call_id(db, |path| self.resolve_path_as_macro(db, &path))\n-        {\n+        if let Some(call_id) = macro_call.as_call_id(db, |path| {\n+            if let Some(local_scope) = local_scope {\n+                if let Some(def) = path.as_ident().and_then(|n| local_scope.get_legacy_macro(n)) {\n+                    return Some(def);\n+                }\n+            }\n+            self.resolve_path_as_macro(db, &path)\n+        }) {\n             let file_id = call_id.as_file();\n             if let Some(node) = db.parse_or_expand(file_id) {\n                 if let Some(expr) = T::cast(node) {"}, {"sha": "54b5591d31981c8523222e00bbac15b8ddce6821", "filename": "crates/ra_hir_def/src/body/lower.rs", "status": "modified", "additions": 36, "deletions": 12, "changes": 48, "blob_url": "https://github.com/rust-lang/rust/blob/fe78a14bbb9769c8ccd5cc41415702f5176a8e88/crates%2Fra_hir_def%2Fsrc%2Fbody%2Flower.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fe78a14bbb9769c8ccd5cc41415702f5176a8e88/crates%2Fra_hir_def%2Fsrc%2Fbody%2Flower.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_def%2Fsrc%2Fbody%2Flower.rs?ref=fe78a14bbb9769c8ccd5cc41415702f5176a8e88", "patch": "@@ -3,7 +3,10 @@\n \n use either::Either;\n \n-use hir_expand::name::{name, AsName, Name};\n+use hir_expand::{\n+    name::{name, AsName, Name},\n+    MacroDefId, MacroDefKind,\n+};\n use ra_arena::Arena;\n use ra_syntax::{\n     ast::{\n@@ -452,19 +455,30 @@ where\n                     None => self.alloc_expr(Expr::Missing, syntax_ptr),\n                 }\n             }\n-            // FIXME expand to statements in statement position\n             ast::Expr::MacroCall(e) => {\n-                let macro_call = self.expander.to_source(AstPtr::new(&e));\n-                match self.expander.enter_expand(self.db, e) {\n-                    Some((mark, expansion)) => {\n-                        self.source_map\n-                            .expansions\n-                            .insert(macro_call, self.expander.current_file_id);\n-                        let id = self.collect_expr(expansion);\n-                        self.expander.exit(self.db, mark);\n-                        id\n+                if let Some(name) = is_macro_rules(&e) {\n+                    let mac = MacroDefId {\n+                        krate: Some(self.expander.module.krate),\n+                        ast_id: Some(self.expander.ast_id(&e)),\n+                        kind: MacroDefKind::Declarative,\n+                    };\n+                    self.body.item_scope.define_legacy_macro(name, mac);\n+\n+                    // FIXME: do we still need to allocate this as missing ?\n+                    self.alloc_expr(Expr::Missing, syntax_ptr)\n+                } else {\n+                    let macro_call = self.expander.to_source(AstPtr::new(&e));\n+                    match self.expander.enter_expand(self.db, Some(&self.body.item_scope), e) {\n+                        Some((mark, expansion)) => {\n+                            self.source_map\n+                                .expansions\n+                                .insert(macro_call, self.expander.current_file_id);\n+                            let id = self.collect_expr(expansion);\n+                            self.expander.exit(self.db, mark);\n+                            id\n+                        }\n+                        None => self.alloc_expr(Expr::Missing, syntax_ptr),\n                     }\n-                    None => self.alloc_expr(Expr::Missing, syntax_ptr),\n                 }\n             }\n \n@@ -686,6 +700,16 @@ where\n     }\n }\n \n+fn is_macro_rules(m: &ast::MacroCall) -> Option<Name> {\n+    let name = m.path()?.segment()?.name_ref()?.as_name();\n+\n+    if name == name![macro_rules] {\n+        Some(m.name()?.as_name())\n+    } else {\n+        None\n+    }\n+}\n+\n impl From<ast::BinOp> for BinaryOp {\n     fn from(ast_op: ast::BinOp) -> Self {\n         match ast_op {"}, {"sha": "eb4c5de4566610c26db356c6f22d2383768ca995", "filename": "crates/ra_hir_def/src/data.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/fe78a14bbb9769c8ccd5cc41415702f5176a8e88/crates%2Fra_hir_def%2Fsrc%2Fdata.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fe78a14bbb9769c8ccd5cc41415702f5176a8e88/crates%2Fra_hir_def%2Fsrc%2Fdata.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_def%2Fsrc%2Fdata.rs?ref=fe78a14bbb9769c8ccd5cc41415702f5176a8e88", "patch": "@@ -280,7 +280,7 @@ fn collect_impl_items_in_macro(\n         return Vec::new();\n     }\n \n-    if let Some((mark, items)) = expander.enter_expand(db, m) {\n+    if let Some((mark, items)) = expander.enter_expand(db, None, m) {\n         let items: InFile<ast::MacroItems> = expander.to_source(items);\n         let mut res = collect_impl_items(\n             db,"}, {"sha": "123fae72a13d379cf404a4d8c5125780e48b5896", "filename": "crates/ra_hir_def/src/resolver.rs", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/fe78a14bbb9769c8ccd5cc41415702f5176a8e88/crates%2Fra_hir_def%2Fsrc%2Fresolver.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fe78a14bbb9769c8ccd5cc41415702f5176a8e88/crates%2Fra_hir_def%2Fsrc%2Fresolver.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_def%2Fsrc%2Fresolver.rs?ref=fe78a14bbb9769c8ccd5cc41415702f5176a8e88", "patch": "@@ -381,6 +381,11 @@ impl Resolver {\n         db: &impl DefDatabase,\n         path: &ModPath,\n     ) -> Option<MacroDefId> {\n+        // Search item scope legacy macro first\n+        if let Some(def) = self.resolve_local_macro_def(path) {\n+            return Some(def);\n+        }\n+\n         let (item_map, module) = self.module_scope()?;\n         item_map.resolve_path(db, module, &path, BuiltinShadowMode::Other).0.take_macros()\n     }\n@@ -413,6 +418,16 @@ impl Resolver {\n         })\n     }\n \n+    fn resolve_local_macro_def(&self, path: &ModPath) -> Option<MacroDefId> {\n+        let name = path.as_ident()?;\n+        self.scopes.iter().rev().find_map(|scope| {\n+            if let Scope::LocalItemsScope(body) = scope {\n+                return body.item_scope.get_legacy_macro(name);\n+            }\n+            None\n+        })\n+    }\n+\n     pub fn module(&self) -> Option<ModuleId> {\n         let (def_map, local_id) = self.module_scope()?;\n         Some(ModuleId { krate: def_map.krate, local_id })"}, {"sha": "3b7022ad501eea2c023af8a6b38f4d362947338b", "filename": "crates/ra_hir_ty/src/tests/macros.rs", "status": "modified", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/fe78a14bbb9769c8ccd5cc41415702f5176a8e88/crates%2Fra_hir_ty%2Fsrc%2Ftests%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fe78a14bbb9769c8ccd5cc41415702f5176a8e88/crates%2Fra_hir_ty%2Fsrc%2Ftests%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_ty%2Fsrc%2Ftests%2Fmacros.rs?ref=fe78a14bbb9769c8ccd5cc41415702f5176a8e88", "patch": "@@ -362,6 +362,26 @@ fn main() {\n     );\n }\n \n+#[test]\n+fn infer_local_macro() {\n+    assert_snapshot!(\n+        infer(r#\"\n+fn main() {\n+    macro_rules! foo {\n+        () => { 1usize }\n+    }\n+    let _a  = foo!();\n+}\n+\"#),\n+        @r###\"\n+        ![0; 6) '1usize': usize\n+        [11; 90) '{     ...!(); }': ()\n+        [17; 66) 'macro_...     }': {unknown}\n+        [75; 77) '_a': usize\n+    \"###\n+    );\n+}\n+\n #[test]\n fn infer_builtin_macros_line() {\n     assert_snapshot!("}, {"sha": "a7be92ce3ebfe6e844d588e5d2ea88bd74b544e5", "filename": "crates/ra_ide/src/goto_definition.rs", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/fe78a14bbb9769c8ccd5cc41415702f5176a8e88/crates%2Fra_ide%2Fsrc%2Fgoto_definition.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fe78a14bbb9769c8ccd5cc41415702f5176a8e88/crates%2Fra_ide%2Fsrc%2Fgoto_definition.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fgoto_definition.rs?ref=fe78a14bbb9769c8ccd5cc41415702f5176a8e88", "patch": "@@ -787,6 +787,21 @@ mod tests {\n         );\n     }\n \n+    #[test]\n+    fn goto_def_in_local_macro() {\n+        check_goto(\n+            \"\n+            //- /lib.rs            \n+            fn bar() {\n+                macro_rules! foo { () => { () } }\n+                <|>foo!();\n+            }\n+            \",\n+            \"foo MACRO_CALL FileId(1) [15; 48) [28; 31)\",\n+            \"macro_rules! foo { () => { () } }|foo\",\n+        );\n+    }\n+\n     #[test]\n     fn goto_def_for_field_init_shorthand() {\n         covers!(ra_ide_db::goto_def_for_field_init_shorthand);"}]}