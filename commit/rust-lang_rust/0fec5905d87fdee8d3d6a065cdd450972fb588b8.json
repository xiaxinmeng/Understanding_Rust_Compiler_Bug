{"sha": "0fec5905d87fdee8d3d6a065cdd450972fb588b8", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBmZWM1OTA1ZDg3ZmRlZThkM2Q2YTA2NWNkZDQ1MDk3MmZiNTg4Yjg=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-12-27T20:05:08Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-12-27T20:05:08Z"}, "message": "Auto merge of #4963 - JohnTitor:unknown-clippy-lint, r=phansch\n\nSuggest similar lint name on `unknown_clippy_lints`\n\nSuggest a similar lint name with Levenshtein distance on `unknown_clippy_lints`.\nAnd lowercase suggestion behavior is also changed.\n\nchangelog: Suggest similar lint name on `unknown_clippy_lints`", "tree": {"sha": "98c95bcaa6db02f81d66a1069fb9b3630fd11756", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/98c95bcaa6db02f81d66a1069fb9b3630fd11756"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0fec5905d87fdee8d3d6a065cdd450972fb588b8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0fec5905d87fdee8d3d6a065cdd450972fb588b8", "html_url": "https://github.com/rust-lang/rust/commit/0fec5905d87fdee8d3d6a065cdd450972fb588b8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0fec5905d87fdee8d3d6a065cdd450972fb588b8/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0fcb5304e27a747267276cdbac720f4bd2672172", "url": "https://api.github.com/repos/rust-lang/rust/commits/0fcb5304e27a747267276cdbac720f4bd2672172", "html_url": "https://github.com/rust-lang/rust/commit/0fcb5304e27a747267276cdbac720f4bd2672172"}, {"sha": "6e525fc7b1a78fffd87636cc70f052c53d3d0248", "url": "https://api.github.com/repos/rust-lang/rust/commits/6e525fc7b1a78fffd87636cc70f052c53d3d0248", "html_url": "https://github.com/rust-lang/rust/commit/6e525fc7b1a78fffd87636cc70f052c53d3d0248"}], "stats": {"total": 122, "additions": 98, "deletions": 24}, "files": [{"sha": "b618fcfd7b87aa5ae5c139dd8ddeb7aa2ef1f7c9", "filename": "clippy_lints/src/attrs.rs", "status": "modified", "additions": 25, "deletions": 18, "changes": 43, "blob_url": "https://github.com/rust-lang/rust/blob/0fec5905d87fdee8d3d6a065cdd450972fb588b8/clippy_lints%2Fsrc%2Fattrs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0fec5905d87fdee8d3d6a065cdd450972fb588b8/clippy_lints%2Fsrc%2Fattrs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fattrs.rs?ref=0fec5905d87fdee8d3d6a065cdd450972fb588b8", "patch": "@@ -18,6 +18,7 @@ use rustc_session::declare_tool_lint;\n use semver::Version;\n use syntax::ast::{AttrKind, AttrStyle, Attribute, Lit, LitKind, MetaItemKind, NestedMetaItem};\n use syntax::source_map::Span;\n+use syntax::util::lev_distance::find_best_match_for_name;\n use syntax_pos::symbol::Symbol;\n \n declare_clippy_lint! {\n@@ -329,24 +330,30 @@ fn check_clippy_lint_names(cx: &LateContext<'_, '_>, items: &[NestedMetaItem]) {\n                     lint.span(),\n                     &format!(\"unknown clippy lint: clippy::{}\", name),\n                     |db| {\n-                        if name.as_str().chars().any(char::is_uppercase) {\n-                            let name_lower = name.as_str().to_lowercase();\n-                            match lint_store.check_lint_name(\n-                                &name_lower,\n-                                Some(tool_name.name)\n-                            ) {\n-                                // FIXME: can we suggest similar lint names here?\n-                                // https://github.com/rust-lang/rust/pull/56992\n-                                CheckLintNameResult::NoLint(None) => (),\n-                                _ => {\n-                                    db.span_suggestion(\n-                                        lint.span(),\n-                                        \"lowercase the lint name\",\n-                                        name_lower,\n-                                        Applicability::MaybeIncorrect,\n-                                    );\n-                                }\n-                            }\n+                        let name_lower = name.as_str().to_lowercase();\n+                        let symbols = lint_store.get_lints().iter().map(\n+                            |l| Symbol::intern(&l.name_lower())\n+                        ).collect::<Vec<_>>();\n+                        let sugg = find_best_match_for_name(\n+                            symbols.iter(),\n+                            &format!(\"clippy::{}\", name_lower),\n+                            None,\n+                        );\n+                        if name.as_str().chars().any(char::is_uppercase)\n+                            && lint_store.find_lints(&format!(\"clippy::{}\", name_lower)).is_ok() {\n+                            db.span_suggestion(\n+                                lint.span(),\n+                                \"lowercase the lint name\",\n+                                format!(\"clippy::{}\", name_lower),\n+                                Applicability::MachineApplicable,\n+                            );\n+                        } else if let Some(sugg) = sugg {\n+                            db.span_suggestion(\n+                                lint.span(),\n+                                \"did you mean\",\n+                                sugg.to_string(),\n+                                Applicability::MachineApplicable,\n+                            );\n                         }\n                     }\n                 );"}, {"sha": "4249ff8a958d1fb70b966a7ac3fe466408655ee5", "filename": "tests/ui/unknown_clippy_lints.fixed", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/0fec5905d87fdee8d3d6a065cdd450972fb588b8/tests%2Fui%2Funknown_clippy_lints.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/0fec5905d87fdee8d3d6a065cdd450972fb588b8/tests%2Fui%2Funknown_clippy_lints.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Funknown_clippy_lints.fixed?ref=0fec5905d87fdee8d3d6a065cdd450972fb588b8", "patch": "@@ -0,0 +1,18 @@\n+// run-rustfix\n+\n+#![warn(clippy::pedantic)]\n+// Should suggest lowercase\n+#![allow(clippy::all)]\n+#![warn(clippy::cmp_nan)]\n+\n+// Should suggest similar clippy lint name\n+#[warn(clippy::if_not_else)]\n+#[warn(clippy::unnecessary_cast)]\n+#[warn(clippy::useless_transmute)]\n+// Shouldn't suggest rustc lint name(`dead_code`)\n+#[warn(clippy::drop_copy)]\n+// Shouldn't suggest removed/deprecated clippy lint name(`unused_collect`)\n+#[warn(clippy::unused_self)]\n+// Shouldn't suggest renamed clippy lint name(`const_static_lifetime`)\n+#[warn(clippy::redundant_static_lifetimes)]\n+fn main() {}"}, {"sha": "5db345f5444137fecca77f3486524310bcc33cb7", "filename": "tests/ui/unknown_clippy_lints.rs", "status": "modified", "additions": 14, "deletions": 1, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/0fec5905d87fdee8d3d6a065cdd450972fb588b8/tests%2Fui%2Funknown_clippy_lints.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0fec5905d87fdee8d3d6a065cdd450972fb588b8/tests%2Fui%2Funknown_clippy_lints.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Funknown_clippy_lints.rs?ref=0fec5905d87fdee8d3d6a065cdd450972fb588b8", "patch": "@@ -1,5 +1,18 @@\n-#![allow(clippy::All)]\n+// run-rustfix\n+\n #![warn(clippy::pedantic)]\n+// Should suggest lowercase\n+#![allow(clippy::All)]\n+#![warn(clippy::CMP_NAN)]\n \n+// Should suggest similar clippy lint name\n #[warn(clippy::if_not_els)]\n+#[warn(clippy::UNNecsaRy_cAst)]\n+#[warn(clippy::useles_transute)]\n+// Shouldn't suggest rustc lint name(`dead_code`)\n+#[warn(clippy::dead_cod)]\n+// Shouldn't suggest removed/deprecated clippy lint name(`unused_collect`)\n+#[warn(clippy::unused_colle)]\n+// Shouldn't suggest renamed clippy lint name(`const_static_lifetime`)\n+#[warn(clippy::const_static_lifetim)]\n fn main() {}"}, {"sha": "1b859043bb53b8a493a1f98a6b3a87a6b0c069df", "filename": "tests/ui/unknown_clippy_lints.stderr", "status": "modified", "additions": 41, "deletions": 5, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/0fec5905d87fdee8d3d6a065cdd450972fb588b8/tests%2Fui%2Funknown_clippy_lints.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/0fec5905d87fdee8d3d6a065cdd450972fb588b8/tests%2Fui%2Funknown_clippy_lints.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Funknown_clippy_lints.stderr?ref=0fec5905d87fdee8d3d6a065cdd450972fb588b8", "patch": "@@ -1,16 +1,52 @@\n error: unknown clippy lint: clippy::if_not_els\n-  --> $DIR/unknown_clippy_lints.rs:4:8\n+  --> $DIR/unknown_clippy_lints.rs:9:8\n    |\n LL | #[warn(clippy::if_not_els)]\n-   |        ^^^^^^^^^^^^^^^^^^\n+   |        ^^^^^^^^^^^^^^^^^^ help: did you mean: `clippy::if_not_else`\n    |\n    = note: `-D clippy::unknown-clippy-lints` implied by `-D warnings`\n \n+error: unknown clippy lint: clippy::UNNecsaRy_cAst\n+  --> $DIR/unknown_clippy_lints.rs:10:8\n+   |\n+LL | #[warn(clippy::UNNecsaRy_cAst)]\n+   |        ^^^^^^^^^^^^^^^^^^^^^^ help: did you mean: `clippy::unnecessary_cast`\n+\n+error: unknown clippy lint: clippy::useles_transute\n+  --> $DIR/unknown_clippy_lints.rs:11:8\n+   |\n+LL | #[warn(clippy::useles_transute)]\n+   |        ^^^^^^^^^^^^^^^^^^^^^^^ help: did you mean: `clippy::useless_transmute`\n+\n+error: unknown clippy lint: clippy::dead_cod\n+  --> $DIR/unknown_clippy_lints.rs:13:8\n+   |\n+LL | #[warn(clippy::dead_cod)]\n+   |        ^^^^^^^^^^^^^^^^ help: did you mean: `clippy::drop_copy`\n+\n+error: unknown clippy lint: clippy::unused_colle\n+  --> $DIR/unknown_clippy_lints.rs:15:8\n+   |\n+LL | #[warn(clippy::unused_colle)]\n+   |        ^^^^^^^^^^^^^^^^^^^^ help: did you mean: `clippy::unused_self`\n+\n+error: unknown clippy lint: clippy::const_static_lifetim\n+  --> $DIR/unknown_clippy_lints.rs:17:8\n+   |\n+LL | #[warn(clippy::const_static_lifetim)]\n+   |        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: did you mean: `clippy::redundant_static_lifetimes`\n+\n error: unknown clippy lint: clippy::All\n-  --> $DIR/unknown_clippy_lints.rs:1:10\n+  --> $DIR/unknown_clippy_lints.rs:5:10\n    |\n LL | #![allow(clippy::All)]\n-   |          ^^^^^^^^^^^ help: lowercase the lint name: `all`\n+   |          ^^^^^^^^^^^ help: lowercase the lint name: `clippy::all`\n+\n+error: unknown clippy lint: clippy::CMP_NAN\n+  --> $DIR/unknown_clippy_lints.rs:6:9\n+   |\n+LL | #![warn(clippy::CMP_NAN)]\n+   |         ^^^^^^^^^^^^^^^ help: lowercase the lint name: `clippy::cmp_nan`\n \n-error: aborting due to 2 previous errors\n+error: aborting due to 8 previous errors\n "}]}