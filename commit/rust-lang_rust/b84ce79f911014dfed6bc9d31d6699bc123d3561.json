{"sha": "b84ce79f911014dfed6bc9d31d6699bc123d3561", "node_id": "MDY6Q29tbWl0NzI0NzEyOmI4NGNlNzlmOTExMDE0ZGZlZDZiYzlkMzFkNjY5OWJjMTIzZDM1NjE=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-12-05T20:17:17Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-12-05T20:17:17Z"}, "message": "Simplify test", "tree": {"sha": "b0978346224588b9c3186cc6bc895d9b25b2bb51", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b0978346224588b9c3186cc6bc895d9b25b2bb51"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b84ce79f911014dfed6bc9d31d6699bc123d3561", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b84ce79f911014dfed6bc9d31d6699bc123d3561", "html_url": "https://github.com/rust-lang/rust/commit/b84ce79f911014dfed6bc9d31d6699bc123d3561", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b84ce79f911014dfed6bc9d31d6699bc123d3561/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6e10a9f57815ad865a570816436adfdf0de1cdf0", "url": "https://api.github.com/repos/rust-lang/rust/commits/6e10a9f57815ad865a570816436adfdf0de1cdf0", "html_url": "https://github.com/rust-lang/rust/commit/6e10a9f57815ad865a570816436adfdf0de1cdf0"}], "stats": {"total": 23, "additions": 10, "deletions": 13}, "files": [{"sha": "9f373a8f41c31972571956a9ebe7e23f7d2717cc", "filename": "crates/ra_hir_ty/src/tests.rs", "status": "modified", "additions": 10, "deletions": 13, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/b84ce79f911014dfed6bc9d31d6699bc123d3561/crates%2Fra_hir_ty%2Fsrc%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b84ce79f911014dfed6bc9d31d6699bc123d3561/crates%2Fra_hir_ty%2Fsrc%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_ty%2Fsrc%2Ftests.rs?ref=b84ce79f911014dfed6bc9d31d6699bc123d3561", "patch": "@@ -11,8 +11,8 @@ use std::fmt::Write;\n use std::sync::Arc;\n \n use hir_def::{\n-    body::BodySourceMap, db::DefDatabase, nameres::CrateDefMap, AssocItemId, DefWithBodyId,\n-    LocalModuleId, Lookup, ModuleDefId,\n+    body::BodySourceMap, child_from_source::ChildFromSource, db::DefDatabase, nameres::CrateDefMap,\n+    AssocItemId, DefWithBodyId, LocalModuleId, Lookup, ModuleDefId,\n };\n use hir_expand::InFile;\n use insta::assert_snapshot;\n@@ -31,18 +31,15 @@ use crate::{db::HirDatabase, display::HirDisplay, test_db::TestDB, InferenceResu\n fn type_at_pos(db: &TestDB, pos: FilePosition) -> String {\n     let file = db.parse(pos.file_id).ok().unwrap();\n     let expr = algo::find_node_at_offset::<ast::Expr>(file.syntax(), pos.offset).unwrap();\n-\n+    let fn_def = expr.syntax().ancestors().find_map(ast::FnDef::cast).unwrap();\n     let module = db.module_for_file(pos.file_id);\n-    let crate_def_map = db.crate_def_map(module.krate);\n-    for decl in crate_def_map[module.local_id].scope.declarations() {\n-        if let ModuleDefId::FunctionId(func) = decl {\n-            let (_body, source_map) = db.body_with_source_map(func.into());\n-            if let Some(expr_id) = source_map.node_expr(InFile::new(pos.file_id.into(), &expr)) {\n-                let infer = db.infer(func.into());\n-                let ty = &infer[expr_id];\n-                return ty.display(db).to_string();\n-            }\n-        }\n+    let func = module.child_from_source(db, InFile::new(pos.file_id.into(), fn_def)).unwrap();\n+\n+    let (_body, source_map) = db.body_with_source_map(func.into());\n+    if let Some(expr_id) = source_map.node_expr(InFile::new(pos.file_id.into(), &expr)) {\n+        let infer = db.infer(func.into());\n+        let ty = &infer[expr_id];\n+        return ty.display(db).to_string();\n     }\n     panic!(\"Can't find expression\")\n }"}]}