{"sha": "b1f8e27b74c541d3d555149c8efa4bfe9385cd56", "node_id": "MDY6Q29tbWl0NzI0NzEyOmIxZjhlMjdiNzRjNTQxZDNkNTU1MTQ5YzhlZmE0YmZlOTM4NWNkNTY=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-07-15T19:51:17Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-07-15T19:51:17Z"}, "message": "Auto merge of #83319 - tmiasko:packed-aligned, r=jackh726\n\nLayout error instead of an ICE for packed and aligned types\n\nFixes #83107.", "tree": {"sha": "888b8d3d6fa20129600bc8ee9a58cfbbed246160", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/888b8d3d6fa20129600bc8ee9a58cfbbed246160"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b1f8e27b74c541d3d555149c8efa4bfe9385cd56", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b1f8e27b74c541d3d555149c8efa4bfe9385cd56", "html_url": "https://github.com/rust-lang/rust/commit/b1f8e27b74c541d3d555149c8efa4bfe9385cd56", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b1f8e27b74c541d3d555149c8efa4bfe9385cd56/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "26366828a40403c83d6cc29bf5614a6e0388354c", "url": "https://api.github.com/repos/rust-lang/rust/commits/26366828a40403c83d6cc29bf5614a6e0388354c", "html_url": "https://github.com/rust-lang/rust/commit/26366828a40403c83d6cc29bf5614a6e0388354c"}, {"sha": "d49f977ed9fef7bc0734693eb6f6b1f41b72735e", "url": "https://api.github.com/repos/rust-lang/rust/commits/d49f977ed9fef7bc0734693eb6f6b1f41b72735e", "html_url": "https://github.com/rust-lang/rust/commit/d49f977ed9fef7bc0734693eb6f6b1f41b72735e"}], "stats": {"total": 36, "additions": 33, "deletions": 3}, "files": [{"sha": "e089b2526078c869db0fb00f23b4c4a8c3fb3abb", "filename": "compiler/rustc_middle/src/ty/layout.rs", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/b1f8e27b74c541d3d555149c8efa4bfe9385cd56/compiler%2Frustc_middle%2Fsrc%2Fty%2Flayout.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b1f8e27b74c541d3d555149c8efa4bfe9385cd56/compiler%2Frustc_middle%2Fsrc%2Fty%2Flayout.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Flayout.rs?ref=b1f8e27b74c541d3d555149c8efa4bfe9385cd56", "patch": "@@ -312,7 +312,8 @@ impl<'tcx> LayoutCx<'tcx, TyCtxt<'tcx>> {\n         let dl = self.data_layout();\n         let pack = repr.pack;\n         if pack.is_some() && repr.align.is_some() {\n-            bug!(\"struct cannot be packed and aligned\");\n+            self.tcx.sess.delay_span_bug(DUMMY_SP, \"struct cannot be packed and aligned\");\n+            return Err(LayoutError::Unknown(ty));\n         }\n \n         let mut align = if pack.is_some() { dl.i8_align } else { dl.aggregate_align };\n@@ -808,7 +809,11 @@ impl<'tcx> LayoutCx<'tcx, TyCtxt<'tcx>> {\n \n                 if def.is_union() {\n                     if def.repr.pack.is_some() && def.repr.align.is_some() {\n-                        bug!(\"union cannot be packed and aligned\");\n+                        self.tcx.sess.delay_span_bug(\n+                            tcx.def_span(def.did),\n+                            \"union cannot be packed and aligned\",\n+                        );\n+                        return Err(LayoutError::Unknown(ty));\n                     }\n \n                     let mut align ="}, {"sha": "ed82b6a742c8de7aebef7428e7ccb52728431e70", "filename": "src/test/ui/conflicting-repr-hints.rs", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/b1f8e27b74c541d3d555149c8efa4bfe9385cd56/src%2Ftest%2Fui%2Fconflicting-repr-hints.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b1f8e27b74c541d3d555149c8efa4bfe9385cd56/src%2Ftest%2Fui%2Fconflicting-repr-hints.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconflicting-repr-hints.rs?ref=b1f8e27b74c541d3d555149c8efa4bfe9385cd56", "patch": "@@ -66,4 +66,15 @@ union Z {\n     i: i32,\n }\n \n+#[repr(packed, align(0x100))]\n+pub struct S(u16); //~ ERROR type has conflicting packed and align representation hints\n+\n+#[repr(packed, align(0x100))]\n+pub union U { //~ ERROR type has conflicting packed and align representation hints\n+    u: u16\n+}\n+\n+static B: U = U { u: 0 };\n+static A: S = S(0);\n+\n fn main() {}"}, {"sha": "0f32fc0481bc6e251c2a581675d76a3ffa02ce63", "filename": "src/test/ui/conflicting-repr-hints.stderr", "status": "modified", "additions": 15, "deletions": 1, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/b1f8e27b74c541d3d555149c8efa4bfe9385cd56/src%2Ftest%2Fui%2Fconflicting-repr-hints.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/b1f8e27b74c541d3d555149c8efa4bfe9385cd56/src%2Ftest%2Fui%2Fconflicting-repr-hints.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconflicting-repr-hints.stderr?ref=b1f8e27b74c541d3d555149c8efa4bfe9385cd56", "patch": "@@ -74,7 +74,21 @@ LL | |     i: i32,\n LL | | }\n    | |_^\n \n-error: aborting due to 10 previous errors\n+error[E0587]: type has conflicting packed and align representation hints\n+  --> $DIR/conflicting-repr-hints.rs:70:1\n+   |\n+LL | pub struct S(u16);\n+   | ^^^^^^^^^^^^^^^^^^\n+\n+error[E0587]: type has conflicting packed and align representation hints\n+  --> $DIR/conflicting-repr-hints.rs:73:1\n+   |\n+LL | / pub union U {\n+LL | |     u: u16\n+LL | | }\n+   | |_^\n+\n+error: aborting due to 12 previous errors\n \n Some errors have detailed explanations: E0566, E0587, E0634.\n For more information about an error, try `rustc --explain E0566`."}]}