{"sha": "349b45bb995ce8d022bd4497ddce89b823596007", "node_id": "MDY6Q29tbWl0NzI0NzEyOjM0OWI0NWJiOTk1Y2U4ZDAyMmJkNDQ5N2RkY2U4OWI4MjM1OTYwMDc=", "commit": {"author": {"name": "mcarton", "email": "cartonmartin+git@gmail.com", "date": "2017-05-30T17:28:44Z"}, "committer": {"name": "mcarton", "email": "cartonmartin+git@gmail.com", "date": "2017-06-17T16:23:37Z"}, "message": "Fix spans in all cases in `doc_markdown`", "tree": {"sha": "a3885c96ee6710467b1a7dcf50b951215f9bc542", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a3885c96ee6710467b1a7dcf50b951215f9bc542"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/349b45bb995ce8d022bd4497ddce89b823596007", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/349b45bb995ce8d022bd4497ddce89b823596007", "html_url": "https://github.com/rust-lang/rust/commit/349b45bb995ce8d022bd4497ddce89b823596007", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/349b45bb995ce8d022bd4497ddce89b823596007/comments", "author": {"login": "mcarton", "id": 3751788, "node_id": "MDQ6VXNlcjM3NTE3ODg=", "avatar_url": "https://avatars.githubusercontent.com/u/3751788?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mcarton", "html_url": "https://github.com/mcarton", "followers_url": "https://api.github.com/users/mcarton/followers", "following_url": "https://api.github.com/users/mcarton/following{/other_user}", "gists_url": "https://api.github.com/users/mcarton/gists{/gist_id}", "starred_url": "https://api.github.com/users/mcarton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mcarton/subscriptions", "organizations_url": "https://api.github.com/users/mcarton/orgs", "repos_url": "https://api.github.com/users/mcarton/repos", "events_url": "https://api.github.com/users/mcarton/events{/privacy}", "received_events_url": "https://api.github.com/users/mcarton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "mcarton", "id": 3751788, "node_id": "MDQ6VXNlcjM3NTE3ODg=", "avatar_url": "https://avatars.githubusercontent.com/u/3751788?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mcarton", "html_url": "https://github.com/mcarton", "followers_url": "https://api.github.com/users/mcarton/followers", "following_url": "https://api.github.com/users/mcarton/following{/other_user}", "gists_url": "https://api.github.com/users/mcarton/gists{/gist_id}", "starred_url": "https://api.github.com/users/mcarton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mcarton/subscriptions", "organizations_url": "https://api.github.com/users/mcarton/orgs", "repos_url": "https://api.github.com/users/mcarton/repos", "events_url": "https://api.github.com/users/mcarton/events{/privacy}", "received_events_url": "https://api.github.com/users/mcarton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "aaf9bce90550b1c0a726fbf42bd317dc2ff8e6ed", "url": "https://api.github.com/repos/rust-lang/rust/commits/aaf9bce90550b1c0a726fbf42bd317dc2ff8e6ed", "html_url": "https://github.com/rust-lang/rust/commit/aaf9bce90550b1c0a726fbf42bd317dc2ff8e6ed"}], "stats": {"total": 159, "additions": 67, "deletions": 92}, "files": [{"sha": "ff502819ffc5fed39ce4972b8d109a74069af00a", "filename": "clippy_lints/src/doc.rs", "status": "modified", "additions": 11, "deletions": 12, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/349b45bb995ce8d022bd4497ddce89b823596007/clippy_lints%2Fsrc%2Fdoc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/349b45bb995ce8d022bd4497ddce89b823596007/clippy_lints%2Fsrc%2Fdoc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fdoc.rs?ref=349b45bb995ce8d022bd4497ddce89b823596007", "patch": "@@ -4,7 +4,7 @@ use rustc::lint::*;\n use syntax::ast;\n use syntax::codemap::{Span, BytePos};\n use syntax_pos::Pos;\n-use utils::{span_lint, snippet_opt};\n+use utils::span_lint;\n \n /// **What it does:** Checks for the presence of `_`, `::` or camel-case words\n /// outside ticks in documentation.\n@@ -81,7 +81,7 @@ impl<'a> Iterator for Parser<'a> {\n /// `syntax::parse::lexer::comments::strip_doc_comment_decoration` because we need to keep track of\n /// the spans but this function is inspired from the later.\n #[allow(cast_possible_truncation)]\n-pub fn strip_doc_comment_decoration(comment: String, span: Span) -> (String, Vec<(usize, Span)>) {\n+pub fn strip_doc_comment_decoration(comment: &str, span: Span) -> (String, Vec<(usize, Span)>) {\n     // one-line comments lose their prefix\n     const ONELINERS: &'static [&'static str] = &[\"///!\", \"///\", \"//!\", \"//\"];\n     for prefix in ONELINERS {\n@@ -104,7 +104,8 @@ pub fn strip_doc_comment_decoration(comment: String, span: Span) -> (String, Vec\n             let offset = line.as_ptr() as usize - comment.as_ptr() as usize;\n             debug_assert_eq!(offset as u32 as usize, offset);\n \n-            sizes.push((line.len(), Span { lo: span.lo + BytePos(offset as u32), ..span }));\n+            // +1 for the newline\n+            sizes.push((line.len()+1, Span { lo: span.lo + BytePos(offset as u32), ..span }));\n         }\n \n         return (doc.to_string(), sizes);\n@@ -121,7 +122,7 @@ pub fn check_attrs<'a>(cx: &EarlyContext, valid_idents: &[String], attrs: &'a [a\n         if attr.is_sugared_doc {\n             if let Some(ref current) = attr.value_str() {\n                 let current = current.to_string();\n-                let (current, current_spans) = strip_doc_comment_decoration(current, attr.span);\n+                let (current, current_spans) = strip_doc_comment_decoration(&current, attr.span);\n                 spans.extend_from_slice(&current_spans);\n                 doc.push_str(&current);\n             }\n@@ -144,7 +145,11 @@ pub fn check_attrs<'a>(cx: &EarlyContext, valid_idents: &[String], attrs: &'a [a\n             let y_offset = y.0;\n \n             match (x.1, y.1) {\n-                (Text(x), Text(y)) => Ok((x_offset, Text((x.into_owned() + &y).into()))),\n+                (Text(x), Text(y)) => {\n+                    let mut x = x.into_owned();\n+                    x.push_str(&y);\n+                    Ok((x_offset, Text(x.into())))\n+                }\n                 (x, y) => Err(((x_offset, x), (y_offset, y))),\n             }\n         });\n@@ -163,18 +168,15 @@ fn check_doc<'a, Events: Iterator<Item=(usize, pulldown_cmark::Event<'a>)>>(\n \n     let mut in_code = false;\n \n-    println!(\"{:?}\", spans);\n     for (offset, event) in docs {\n-        println!(\"{:?}, {:?}\", offset, event);\n         match event {\n             Start(CodeBlock(_)) | Start(Code) => in_code = true,\n             End(CodeBlock(_)) | End(Code) => in_code = false,\n             Start(_tag) | End(_tag) => (), // We don't care about other tags\n             Html(_html) | InlineHtml(_html) => (), // HTML is weird, just ignore it\n-            FootnoteReference(footnote) => (), // TODO\n             SoftBreak => (),\n             HardBreak => (),\n-            Text(text) => {\n+            FootnoteReference(text) | Text(text) => {\n                 if !in_code {\n                     let index = match spans.binary_search_by(|c| c.0.cmp(&offset)) {\n                         Ok(o) => o,\n@@ -183,15 +185,12 @@ fn check_doc<'a, Events: Iterator<Item=(usize, pulldown_cmark::Event<'a>)>>(\n \n                     let (begin, span) = spans[index];\n \n-                    println!(\"raw: {:?}, {}, {}, {:?}\", snippet_opt(cx, span), offset, begin, span);\n-\n                     // Adjust for the begining of the current `Event`\n                     let span = Span {\n                         lo: span.lo + BytePos::from_usize(offset - begin),\n                         ..span\n                     };\n \n-                    println!(\"adjusted: {:?}\", snippet_opt(cx, span));\n                     check_text(cx, valid_idents, &text, span);\n                 }\n             },"}, {"sha": "7e23de55da1e70f39dfb24619d2f94b62a241be4", "filename": "clippy_tests/examples/doc.stderr", "status": "modified", "additions": 56, "deletions": 80, "changes": 136, "blob_url": "https://github.com/rust-lang/rust/blob/349b45bb995ce8d022bd4497ddce89b823596007/clippy_tests%2Fexamples%2Fdoc.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/349b45bb995ce8d022bd4497ddce89b823596007/clippy_tests%2Fexamples%2Fdoc.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_tests%2Fexamples%2Fdoc.stderr?ref=349b45bb995ce8d022bd4497ddce89b823596007", "patch": "@@ -30,19 +30,19 @@ error: you should put `Foo::some_fun` between ticks in the documentation\n   |\n   = note: `-D doc-markdown` implied by `-D warnings`\n \n-error: you should put `is::a::global:path` between ticks in the documentation\n-  --> doc.rs:11:13\n+error: you should put `a::global:path` between ticks in the documentation\n+  --> doc.rs:11:15\n    |\n-11 | /// Here be ::is::a::global:path.\n-   |             ^^^^^^^^^^^^^^^^^^^^\n+11 | /// Here be ::a::global:path.\n+   |               ^^^^^^^^^^^^^^\n    |\n    = note: `-D doc-markdown` implied by `-D warnings`\n \n error: you should put `NotInCodeBlock` between ticks in the documentation\n-  --> doc.rs:12:21\n+  --> doc.rs:12:22\n    |\n 12 | /// That's not code ~NotInCodeBlock~.\n-   |                     ^^^^^^^^^^^^^^^\n+   |                      ^^^^^^^^^^^^^^\n    |\n    = note: `-D doc-markdown` implied by `-D warnings`\n \n@@ -78,154 +78,130 @@ error: you should put `be_sure_we_got_to_the_end_of_it` between ticks in the doc\n    |\n    = note: `-D doc-markdown` implied by `-D warnings`\n \n-error: you should put `\u00df_foo` between ticks in the documentation\n-  --> doc.rs:57:5\n+error: you should put `link_with_underscores` between ticks in the documentation\n+  --> doc.rs:52:22\n    |\n-57 | /// \u00df_foo\n-   |     ^^^^^\n+52 | /// This test has [a link_with_underscores][chunked-example] inside it. See #823.\n+   |                      ^^^^^^^^^^^^^^^^^^^^^\n    |\n    = note: `-D doc-markdown` implied by `-D warnings`\n \n-error: you should put `\u211d_foo` between ticks in the documentation\n-  --> doc.rs:58:5\n+error: you should put `inline_link2` between ticks in the documentation\n+  --> doc.rs:55:21\n    |\n-58 | /// \u211d_foo\n-   |     ^^^^^\n+55 | /// It can also be [inline_link2].\n+   |                     ^^^^^^^^^^^^\n    |\n    = note: `-D doc-markdown` implied by `-D warnings`\n \n-error: you should put `foo_\u00df` between ticks in the documentation\n-  --> doc.rs:61:5\n+error: you should put `be_sure_we_got_to_the_end_of_it` between ticks in the documentation\n+  --> doc.rs:65:5\n    |\n-61 | /// foo_\u00df\n-   |     ^^^^^\n+65 | /// be_sure_we_got_to_the_end_of_it\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |\n    = note: `-D doc-markdown` implied by `-D warnings`\n \n-error: you should put `foo_\u211d` between ticks in the documentation\n-  --> doc.rs:62:5\n+error: you should put `CamelCaseThing` between ticks in the documentation\n+  --> doc.rs:73:8\n    |\n-62 | /// foo_\u211d\n-   |     ^^^^^\n+73 | /// ## CamelCaseThing\n+   |        ^^^^^^^^^^^^^^\n    |\n    = note: `-D doc-markdown` implied by `-D warnings`\n \n-error: you should put `be_sure_we_got_to_the_end_of_it` between ticks in the documentation\n-  --> doc.rs:77:5\n+error: you should put `CamelCaseThing` between ticks in the documentation\n+  --> doc.rs:76:7\n    |\n-77 | /// be_sure_we_got_to_the_end_of_it\n-   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+76 | /// # CamelCaseThing\n+   |       ^^^^^^^^^^^^^^\n    |\n    = note: `-D doc-markdown` implied by `-D warnings`\n \n-error: you should put `link_with_underscores` between ticks in the documentation\n-  --> doc.rs:81:22\n+error: you should put `CamelCaseThing` between ticks in the documentation\n+  --> doc.rs:78:22\n    |\n-81 | /// This test has [a link_with_underscores][chunked-example] inside it. See #823.\n-   |                      ^^^^^^^^^^^^^^^^^^^^^\n+78 | /// Not a title #897 CamelCaseThing\n+   |                      ^^^^^^^^^^^^^^\n    |\n    = note: `-D doc-markdown` implied by `-D warnings`\n \n-error: you should put `inline_link2` between ticks in the documentation\n-  --> doc.rs:84:21\n+error: you should put `be_sure_we_got_to_the_end_of_it` between ticks in the documentation\n+  --> doc.rs:79:5\n    |\n-84 | /// It can also be [inline_link2].\n-   |                     ^^^^^^^^^^^^\n+79 | /// be_sure_we_got_to_the_end_of_it\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |\n    = note: `-D doc-markdown` implied by `-D warnings`\n \n error: you should put `be_sure_we_got_to_the_end_of_it` between ticks in the documentation\n-  --> doc.rs:94:5\n+  --> doc.rs:86:5\n    |\n-94 | /// be_sure_we_got_to_the_end_of_it\n+86 | /// be_sure_we_got_to_the_end_of_it\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |\n    = note: `-D doc-markdown` implied by `-D warnings`\n \n-error: you should put `CamelCaseThing` between ticks in the documentation\n-   --> doc.rs:107:22\n-    |\n-107 | /// Not a title #897 CamelCaseThing\n-    |                      ^^^^^^^^^^^^^^\n-    |\n-    = note: `-D doc-markdown` implied by `-D warnings`\n-\n error: you should put `be_sure_we_got_to_the_end_of_it` between ticks in the documentation\n-   --> doc.rs:108:5\n-    |\n-108 | /// be_sure_we_got_to_the_end_of_it\n-    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n-    |\n-    = note: `-D doc-markdown` implied by `-D warnings`\n-\n-error: you should put `be_sure_we_got_to_the_end_of_it` between ticks in the documentation\n-   --> doc.rs:115:5\n-    |\n-115 | /// be_sure_we_got_to_the_end_of_it\n-    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n-    |\n-    = note: `-D doc-markdown` implied by `-D warnings`\n-\n-error: you should put `be_sure_we_got_to_the_end_of_it` between ticks in the documentation\n-   --> doc.rs:128:5\n-    |\n-128 | /// be_sure_we_got_to_the_end_of_it\n-    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n-    |\n-    = note: `-D doc-markdown` implied by `-D warnings`\n+  --> doc.rs:99:5\n+   |\n+99 | /// be_sure_we_got_to_the_end_of_it\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+   = note: `-D doc-markdown` implied by `-D warnings`\n \n error: you should put `FooBar` between ticks in the documentation\n-   --> doc.rs:139:42\n+   --> doc.rs:110:42\n     |\n-139 | /** E.g. serialization of an empty list: FooBar\n+110 | /** E.g. serialization of an empty list: FooBar\n     |                                          ^^^^^^\n     |\n     = note: `-D doc-markdown` implied by `-D warnings`\n \n error: you should put `BarQuz` between ticks in the documentation\n-   --> doc.rs:144:5\n+   --> doc.rs:115:5\n     |\n-144 | And BarQuz too.\n+115 | And BarQuz too.\n     |     ^^^^^^\n     |\n     = note: `-D doc-markdown` implied by `-D warnings`\n \n error: you should put `be_sure_we_got_to_the_end_of_it` between ticks in the documentation\n-   --> doc.rs:145:1\n+   --> doc.rs:116:1\n     |\n-145 | be_sure_we_got_to_the_end_of_it\n+116 | be_sure_we_got_to_the_end_of_it\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n     |\n     = note: `-D doc-markdown` implied by `-D warnings`\n \n error: you should put `FooBar` between ticks in the documentation\n-   --> doc.rs:150:42\n+   --> doc.rs:121:42\n     |\n-150 | /** E.g. serialization of an empty list: FooBar\n+121 | /** E.g. serialization of an empty list: FooBar\n     |                                          ^^^^^^\n     |\n     = note: `-D doc-markdown` implied by `-D warnings`\n \n error: you should put `BarQuz` between ticks in the documentation\n-   --> doc.rs:155:5\n+   --> doc.rs:126:5\n     |\n-155 | And BarQuz too.\n+126 | And BarQuz too.\n     |     ^^^^^^\n     |\n     = note: `-D doc-markdown` implied by `-D warnings`\n \n error: you should put `be_sure_we_got_to_the_end_of_it` between ticks in the documentation\n-   --> doc.rs:156:1\n+   --> doc.rs:127:1\n     |\n-156 | be_sure_we_got_to_the_end_of_it\n+127 | be_sure_we_got_to_the_end_of_it\n     | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n     |\n     = note: `-D doc-markdown` implied by `-D warnings`\n \n error: you should put `be_sure_we_got_to_the_end_of_it` between ticks in the documentation\n-   --> doc.rs:167:5\n+   --> doc.rs:138:5\n     |\n-167 | /// be_sure_we_got_to_the_end_of_it\n+138 | /// be_sure_we_got_to_the_end_of_it\n     |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n     |\n     = note: `-D doc-markdown` implied by `-D warnings`"}]}