{"sha": "1ebac28f0d47341173a1271b050e4a07693c8bc6", "node_id": "C_kwDOAAsO6NoAKDFlYmFjMjhmMGQ0NzM0MTE3M2ExMjcxYjA1MGU0YTA3NjkzYzhiYzY", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-04-01T16:44:11Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-04-01T16:44:11Z"}, "message": "Auto merge of #14465 - tamasfe:feat/rtn-syntax, r=Veykril\n\nLimited syntax support for return type notations (RTN)\n\nExperimental RTN bound support was recently merged into rustc (https://github.com/rust-lang/rust/issues/109417), the goal of this PR is to allow experimentation without syntax errors everywhere.\n\nThe parsing implemented currently aligns with the state of the tracking issue, it only supports the form `T<foo(..): Bounds>`. The parser always checks for the presence of `..` to disambiguate from `Fn*()` types, this is not ideal but I didn't want to spend too much time as it is an experimental feature.", "tree": {"sha": "619f1d94f6eaf1427b6a3b5c8d6b442b3ba9cafd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/619f1d94f6eaf1427b6a3b5c8d6b442b3ba9cafd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1ebac28f0d47341173a1271b050e4a07693c8bc6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1ebac28f0d47341173a1271b050e4a07693c8bc6", "html_url": "https://github.com/rust-lang/rust/commit/1ebac28f0d47341173a1271b050e4a07693c8bc6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1ebac28f0d47341173a1271b050e4a07693c8bc6/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1ce25f114d703564741f1395874d4e8eff83beda", "url": "https://api.github.com/repos/rust-lang/rust/commits/1ce25f114d703564741f1395874d4e8eff83beda", "html_url": "https://github.com/rust-lang/rust/commit/1ce25f114d703564741f1395874d4e8eff83beda"}, {"sha": "25910bcde6aca341dd96fb6a15b964dff7c4b98a", "url": "https://api.github.com/repos/rust-lang/rust/commits/25910bcde6aca341dd96fb6a15b964dff7c4b98a", "html_url": "https://github.com/rust-lang/rust/commit/25910bcde6aca341dd96fb6a15b964dff7c4b98a"}], "stats": {"total": 105, "additions": 103, "deletions": 2}, "files": [{"sha": "c35f915b00e63c67cb32377b001e9077c8a5a478", "filename": "crates/hir-def/src/path/lower.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/1ebac28f0d47341173a1271b050e4a07693c8bc6/crates%2Fhir-def%2Fsrc%2Fpath%2Flower.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1ebac28f0d47341173a1271b050e4a07693c8bc6/crates%2Fhir-def%2Fsrc%2Fpath%2Flower.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-def%2Fsrc%2Fpath%2Flower.rs?ref=1ebac28f0d47341173a1271b050e4a07693c8bc6", "patch": "@@ -218,6 +218,9 @@ pub(super) fn lower_generic_args(\n                 let arg = ConstRefOrPath::from_expr_opt(arg.expr());\n                 args.push(GenericArg::Const(arg))\n             }\n+            ast::GenericArg::ReturnTypeArg(_) => {\n+                // FIXME: return type notation is experimental, we don't do anything with it yet.\n+            }\n         }\n     }\n "}, {"sha": "55794954a829961b6bc724738b42172f1b940d01", "filename": "crates/parser/src/grammar/generic_args.rs", "status": "modified", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/1ebac28f0d47341173a1271b050e4a07693c8bc6/crates%2Fparser%2Fsrc%2Fgrammar%2Fgeneric_args.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1ebac28f0d47341173a1271b050e4a07693c8bc6/crates%2Fparser%2Fsrc%2Fgrammar%2Fgeneric_args.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fparser%2Fsrc%2Fgrammar%2Fgeneric_args.rs?ref=1ebac28f0d47341173a1271b050e4a07693c8bc6", "patch": "@@ -76,6 +76,7 @@ fn generic_arg(p: &mut Parser<'_>) -> bool {\n                 }\n             }\n         }\n+        IDENT if p.nth(1) == T!['('] && p.nth_at(2, T![..]) => return_type_arg(p),\n         _ if p.at_ts(types::TYPE_FIRST) => type_arg(p),\n         _ => return false,\n     }\n@@ -139,3 +140,20 @@ fn type_arg(p: &mut Parser<'_>) {\n     types::type_(p);\n     m.complete(p, TYPE_ARG);\n }\n+\n+// test return_type_arg\n+// type T = S<foo(..): Send>;\n+pub(super) fn return_type_arg(p: &mut Parser<'_>) {\n+    let m = p.start();\n+    p.expect(IDENT);\n+    p.expect(T!['(']);\n+    p.expect(T![..]);\n+    p.expect(T![')']);\n+    if !p.at(T![:]) {\n+        p.error(\"expected :\");\n+        m.abandon(p);\n+        return;\n+    }\n+    generic_params::bounds(p);\n+    m.complete(p, RETURN_TYPE_ARG);\n+}"}, {"sha": "2af6e1b9867cf91d002685f090bdeb04686c62bc", "filename": "crates/parser/src/syntax_kind/generated.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/1ebac28f0d47341173a1271b050e4a07693c8bc6/crates%2Fparser%2Fsrc%2Fsyntax_kind%2Fgenerated.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1ebac28f0d47341173a1271b050e4a07693c8bc6/crates%2Fparser%2Fsrc%2Fsyntax_kind%2Fgenerated.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fparser%2Fsrc%2Fsyntax_kind%2Fgenerated.rs?ref=1ebac28f0d47341173a1271b050e4a07693c8bc6", "patch": "@@ -245,6 +245,7 @@ pub enum SyntaxKind {\n     GENERIC_PARAM,\n     LIFETIME_PARAM,\n     TYPE_PARAM,\n+    RETURN_TYPE_ARG,\n     CONST_PARAM,\n     GENERIC_ARG_LIST,\n     LIFETIME,"}, {"sha": "26d474f54f47f7f1b7b255394771ec45530e9619", "filename": "crates/parser/test_data/parser/inline/ok/0206_return_type_arg.rast", "status": "added", "additions": 33, "deletions": 0, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/1ebac28f0d47341173a1271b050e4a07693c8bc6/crates%2Fparser%2Ftest_data%2Fparser%2Finline%2Fok%2F0206_return_type_arg.rast", "raw_url": "https://github.com/rust-lang/rust/raw/1ebac28f0d47341173a1271b050e4a07693c8bc6/crates%2Fparser%2Ftest_data%2Fparser%2Finline%2Fok%2F0206_return_type_arg.rast", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fparser%2Ftest_data%2Fparser%2Finline%2Fok%2F0206_return_type_arg.rast?ref=1ebac28f0d47341173a1271b050e4a07693c8bc6", "patch": "@@ -0,0 +1,33 @@\n+SOURCE_FILE\n+  TYPE_ALIAS\n+    TYPE_KW \"type\"\n+    WHITESPACE \" \"\n+    NAME\n+      IDENT \"T\"\n+    WHITESPACE \" \"\n+    EQ \"=\"\n+    WHITESPACE \" \"\n+    PATH_TYPE\n+      PATH\n+        PATH_SEGMENT\n+          NAME_REF\n+            IDENT \"S\"\n+          GENERIC_ARG_LIST\n+            L_ANGLE \"<\"\n+            RETURN_TYPE_ARG\n+              IDENT \"foo\"\n+              L_PAREN \"(\"\n+              DOT2 \"..\"\n+              R_PAREN \")\"\n+              COLON \":\"\n+              WHITESPACE \" \"\n+              TYPE_BOUND_LIST\n+                TYPE_BOUND\n+                  PATH_TYPE\n+                    PATH\n+                      PATH_SEGMENT\n+                        NAME_REF\n+                          IDENT \"Send\"\n+            R_ANGLE \">\"\n+    SEMICOLON \";\"\n+  WHITESPACE \"\\n\""}, {"sha": "2a9ff270839f8b2b5ac1a13c61df2efffb288954", "filename": "crates/parser/test_data/parser/inline/ok/0206_return_type_arg.rs", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/1ebac28f0d47341173a1271b050e4a07693c8bc6/crates%2Fparser%2Ftest_data%2Fparser%2Finline%2Fok%2F0206_return_type_arg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1ebac28f0d47341173a1271b050e4a07693c8bc6/crates%2Fparser%2Ftest_data%2Fparser%2Finline%2Fok%2F0206_return_type_arg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fparser%2Ftest_data%2Fparser%2Finline%2Fok%2F0206_return_type_arg.rs?ref=1ebac28f0d47341173a1271b050e4a07693c8bc6", "patch": "@@ -0,0 +1 @@\n+type T = S<foo(..): Send>;"}, {"sha": "08c8749e36c7c159eb3fdcfacd4cf050fba53146", "filename": "crates/syntax/rust.ungram", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/1ebac28f0d47341173a1271b050e4a07693c8bc6/crates%2Fsyntax%2Frust.ungram", "raw_url": "https://github.com/rust-lang/rust/raw/1ebac28f0d47341173a1271b050e4a07693c8bc6/crates%2Fsyntax%2Frust.ungram", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fsyntax%2Frust.ungram?ref=1ebac28f0d47341173a1271b050e4a07693c8bc6", "patch": "@@ -46,6 +46,7 @@ GenericArg =\n | AssocTypeArg\n | LifetimeArg\n | ConstArg\n+| ReturnTypeArg\n \n TypeArg =\n   Type\n@@ -59,6 +60,9 @@ LifetimeArg =\n ConstArg =\n   Expr\n \n+ReturnTypeArg =\n+  NameRef '(' '..' ')' ':' TypeBoundList\n+\n MacroCall =\n   Attr* Path '!' TokenTree ';'?\n "}, {"sha": "6aa7efd83246268fdf4355ecb9bddf33f54ba52d", "filename": "crates/syntax/src/ast/generated/nodes.rs", "status": "modified", "additions": 42, "deletions": 2, "changes": 44, "blob_url": "https://github.com/rust-lang/rust/blob/1ebac28f0d47341173a1271b050e4a07693c8bc6/crates%2Fsyntax%2Fsrc%2Fast%2Fgenerated%2Fnodes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1ebac28f0d47341173a1271b050e4a07693c8bc6/crates%2Fsyntax%2Fsrc%2Fast%2Fgenerated%2Fnodes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fsyntax%2Fsrc%2Fast%2Fgenerated%2Fnodes.rs?ref=1ebac28f0d47341173a1271b050e4a07693c8bc6", "patch": "@@ -142,6 +142,18 @@ impl ConstArg {\n     pub fn expr(&self) -> Option<Expr> { support::child(&self.syntax) }\n }\n \n+#[derive(Debug, Clone, PartialEq, Eq, Hash)]\n+pub struct ReturnTypeArg {\n+    pub(crate) syntax: SyntaxNode,\n+}\n+impl ast::HasTypeBounds for ReturnTypeArg {}\n+impl ReturnTypeArg {\n+    pub fn name_ref(&self) -> Option<NameRef> { support::child(&self.syntax) }\n+    pub fn l_paren_token(&self) -> Option<SyntaxToken> { support::token(&self.syntax, T!['(']) }\n+    pub fn dotdot_token(&self) -> Option<SyntaxToken> { support::token(&self.syntax, T![..]) }\n+    pub fn r_paren_token(&self) -> Option<SyntaxToken> { support::token(&self.syntax, T![')']) }\n+}\n+\n #[derive(Debug, Clone, PartialEq, Eq, Hash)]\n pub struct TypeBoundList {\n     pub(crate) syntax: SyntaxNode,\n@@ -1516,6 +1528,7 @@ pub enum GenericArg {\n     AssocTypeArg(AssocTypeArg),\n     LifetimeArg(LifetimeArg),\n     ConstArg(ConstArg),\n+    ReturnTypeArg(ReturnTypeArg),\n }\n \n #[derive(Debug, Clone, PartialEq, Eq, Hash)]\n@@ -1865,6 +1878,17 @@ impl AstNode for ConstArg {\n     }\n     fn syntax(&self) -> &SyntaxNode { &self.syntax }\n }\n+impl AstNode for ReturnTypeArg {\n+    fn can_cast(kind: SyntaxKind) -> bool { kind == RETURN_TYPE_ARG }\n+    fn cast(syntax: SyntaxNode) -> Option<Self> {\n+        if Self::can_cast(syntax.kind()) {\n+            Some(Self { syntax })\n+        } else {\n+            None\n+        }\n+    }\n+    fn syntax(&self) -> &SyntaxNode { &self.syntax }\n+}\n impl AstNode for TypeBoundList {\n     fn can_cast(kind: SyntaxKind) -> bool { kind == TYPE_BOUND_LIST }\n     fn cast(syntax: SyntaxNode) -> Option<Self> {\n@@ -3219,16 +3243,20 @@ impl From<LifetimeArg> for GenericArg {\n impl From<ConstArg> for GenericArg {\n     fn from(node: ConstArg) -> GenericArg { GenericArg::ConstArg(node) }\n }\n+impl From<ReturnTypeArg> for GenericArg {\n+    fn from(node: ReturnTypeArg) -> GenericArg { GenericArg::ReturnTypeArg(node) }\n+}\n impl AstNode for GenericArg {\n     fn can_cast(kind: SyntaxKind) -> bool {\n-        matches!(kind, TYPE_ARG | ASSOC_TYPE_ARG | LIFETIME_ARG | CONST_ARG)\n+        matches!(kind, TYPE_ARG | ASSOC_TYPE_ARG | LIFETIME_ARG | CONST_ARG | RETURN_TYPE_ARG)\n     }\n     fn cast(syntax: SyntaxNode) -> Option<Self> {\n         let res = match syntax.kind() {\n             TYPE_ARG => GenericArg::TypeArg(TypeArg { syntax }),\n             ASSOC_TYPE_ARG => GenericArg::AssocTypeArg(AssocTypeArg { syntax }),\n             LIFETIME_ARG => GenericArg::LifetimeArg(LifetimeArg { syntax }),\n             CONST_ARG => GenericArg::ConstArg(ConstArg { syntax }),\n+            RETURN_TYPE_ARG => GenericArg::ReturnTypeArg(ReturnTypeArg { syntax }),\n             _ => return None,\n         };\n         Some(res)\n@@ -3239,6 +3267,7 @@ impl AstNode for GenericArg {\n             GenericArg::AssocTypeArg(it) => &it.syntax,\n             GenericArg::LifetimeArg(it) => &it.syntax,\n             GenericArg::ConstArg(it) => &it.syntax,\n+            GenericArg::ReturnTypeArg(it) => &it.syntax,\n         }\n     }\n }\n@@ -4170,7 +4199,13 @@ impl AstNode for AnyHasTypeBounds {\n     fn can_cast(kind: SyntaxKind) -> bool {\n         matches!(\n             kind,\n-            ASSOC_TYPE_ARG | TRAIT | TYPE_ALIAS | LIFETIME_PARAM | TYPE_PARAM | WHERE_PRED\n+            ASSOC_TYPE_ARG\n+                | RETURN_TYPE_ARG\n+                | TRAIT\n+                | TYPE_ALIAS\n+                | LIFETIME_PARAM\n+                | TYPE_PARAM\n+                | WHERE_PRED\n         )\n     }\n     fn cast(syntax: SyntaxNode) -> Option<Self> {\n@@ -4333,6 +4368,11 @@ impl std::fmt::Display for ConstArg {\n         std::fmt::Display::fmt(self.syntax(), f)\n     }\n }\n+impl std::fmt::Display for ReturnTypeArg {\n+    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {\n+        std::fmt::Display::fmt(self.syntax(), f)\n+    }\n+}\n impl std::fmt::Display for TypeBoundList {\n     fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {\n         std::fmt::Display::fmt(self.syntax(), f)"}, {"sha": "caef6a7953971bef3e987ec45000ef83ddc3d53e", "filename": "crates/syntax/src/tests/ast_src.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/1ebac28f0d47341173a1271b050e4a07693c8bc6/crates%2Fsyntax%2Fsrc%2Ftests%2Fast_src.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1ebac28f0d47341173a1271b050e4a07693c8bc6/crates%2Fsyntax%2Fsrc%2Ftests%2Fast_src.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fsyntax%2Fsrc%2Ftests%2Fast_src.rs?ref=1ebac28f0d47341173a1271b050e4a07693c8bc6", "patch": "@@ -199,6 +199,7 @@ pub(crate) const KINDS_SRC: KindsSrc<'_> = KindsSrc {\n         \"GENERIC_PARAM\",\n         \"LIFETIME_PARAM\",\n         \"TYPE_PARAM\",\n+        \"RETURN_TYPE_ARG\",\n         \"CONST_PARAM\",\n         \"GENERIC_ARG_LIST\",\n         \"LIFETIME\","}]}