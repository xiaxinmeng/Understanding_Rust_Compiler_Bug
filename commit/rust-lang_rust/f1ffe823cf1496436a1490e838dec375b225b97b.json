{"sha": "f1ffe823cf1496436a1490e838dec375b225b97b", "node_id": "C_kwDOAAsO6NoAKGYxZmZlODIzY2YxNDk2NDM2YTE0OTBlODM4ZGVjMzc1YjIyNWI5N2I", "commit": {"author": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2023-01-08T18:41:09Z"}, "committer": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2023-01-11T21:40:39Z"}, "message": "Hide more of long types in E0271\n\nFix #40186.", "tree": {"sha": "b8b582d25af3076e08ea6c26a68cb48f3fdb4706", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b8b582d25af3076e08ea6c26a68cb48f3fdb4706"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f1ffe823cf1496436a1490e838dec375b225b97b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f1ffe823cf1496436a1490e838dec375b225b97b", "html_url": "https://github.com/rust-lang/rust/commit/f1ffe823cf1496436a1490e838dec375b225b97b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f1ffe823cf1496436a1490e838dec375b225b97b/comments", "author": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "committer": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b22c152958eade17a71d899b29a2d39bcc77aa48", "url": "https://api.github.com/repos/rust-lang/rust/commits/b22c152958eade17a71d899b29a2d39bcc77aa48", "html_url": "https://github.com/rust-lang/rust/commit/b22c152958eade17a71d899b29a2d39bcc77aa48"}], "stats": {"total": 139, "additions": 123, "deletions": 16}, "files": [{"sha": "a91e8de5f21ea5221f33fccaa8b8b4392b46d178", "filename": "compiler/rustc_middle/src/ty/print/pretty.rs", "status": "modified", "additions": 15, "deletions": 3, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/f1ffe823cf1496436a1490e838dec375b225b97b/compiler%2Frustc_middle%2Fsrc%2Fty%2Fprint%2Fpretty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f1ffe823cf1496436a1490e838dec375b225b97b/compiler%2Frustc_middle%2Fsrc%2Fty%2Fprint%2Fpretty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fprint%2Fpretty.rs?ref=f1ffe823cf1496436a1490e838dec375b225b97b", "patch": "@@ -283,6 +283,8 @@ pub trait PrettyPrinter<'tcx>:\n     /// This is typically the case for all non-`'_` regions.\n     fn should_print_region(&self, region: ty::Region<'tcx>) -> bool;\n \n+    fn reset_type_limit(&mut self) {}\n+\n     // Defaults (should not be overridden):\n \n     /// If possible, this returns a global path resolving to `def_id` that is visible\n@@ -1981,6 +1983,10 @@ impl<'tcx> PrettyPrinter<'tcx> for FmtPrinter<'_, 'tcx> {\n         self.0.ty_infer_name_resolver.as_ref().and_then(|func| func(id))\n     }\n \n+    fn reset_type_limit(&mut self) {\n+        self.printed_type_count = 0;\n+    }\n+\n     fn const_infer_name(&self, id: ty::ConstVid<'tcx>) -> Option<Symbol> {\n         self.0.const_infer_name_resolver.as_ref().and_then(|func| func(id))\n     }\n@@ -2722,11 +2728,15 @@ define_print_and_forward_display! {\n     }\n \n     ty::SubtypePredicate<'tcx> {\n-        p!(print(self.a), \" <: \", print(self.b))\n+        p!(print(self.a), \" <: \");\n+        cx.reset_type_limit();\n+        p!(print(self.b))\n     }\n \n     ty::CoercePredicate<'tcx> {\n-        p!(print(self.a), \" -> \", print(self.b))\n+        p!(print(self.a), \" -> \");\n+        cx.reset_type_limit();\n+        p!(print(self.b))\n     }\n \n     ty::TraitPredicate<'tcx> {\n@@ -2738,7 +2748,9 @@ define_print_and_forward_display! {\n     }\n \n     ty::ProjectionPredicate<'tcx> {\n-        p!(print(self.projection_ty), \" == \", print(self.term))\n+        p!(print(self.projection_ty), \" == \");\n+        cx.reset_type_limit();\n+        p!(print(self.term))\n     }\n \n     ty::Term<'tcx> {"}, {"sha": "20bede22c3427dfc0b08c478194d0529cea9169c", "filename": "compiler/rustc_trait_selection/src/traits/error_reporting/mod.rs", "status": "modified", "additions": 27, "deletions": 2, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/f1ffe823cf1496436a1490e838dec375b225b97b/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f1ffe823cf1496436a1490e838dec375b225b97b/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fmod.rs?ref=f1ffe823cf1496436a1490e838dec375b225b97b", "patch": "@@ -1724,7 +1724,19 @@ impl<'tcx> InferCtxtPrivExt<'tcx> for TypeErrCtxt<'_, 'tcx> {\n                 .and_then(|(predicate, _, normalized_term, expected_term)| {\n                     self.maybe_detailed_projection_msg(predicate, normalized_term, expected_term)\n                 })\n-                .unwrap_or_else(|| format!(\"type mismatch resolving `{}`\", predicate));\n+                .unwrap_or_else(|| {\n+                    with_forced_trimmed_paths!(format!(\n+                        \"type mismatch resolving `{}`\",\n+                        self.resolve_vars_if_possible(predicate)\n+                            .print(FmtPrinter::new_with_limit(\n+                                self.tcx,\n+                                Namespace::TypeNS,\n+                                rustc_session::Limit(10),\n+                            ))\n+                            .unwrap()\n+                            .into_buffer()\n+                    ))\n+                });\n             let mut diag = struct_span_err!(self.tcx.sess, obligation.cause.span, E0271, \"{msg}\");\n \n             let secondary_span = match predicate.kind().skip_binder() {\n@@ -1755,7 +1767,20 @@ impl<'tcx> InferCtxtPrivExt<'tcx> for TypeErrCtxt<'_, 'tcx> {\n                                 kind: hir::ImplItemKind::Type(ty),\n                                 ..\n                             }),\n-                        ) => Some((ty.span, format!(\"type mismatch resolving `{}`\", predicate))),\n+                        ) => Some((\n+                            ty.span,\n+                            with_forced_trimmed_paths!(format!(\n+                                \"type mismatch resolving `{}`\",\n+                                self.resolve_vars_if_possible(predicate)\n+                                    .print(FmtPrinter::new_with_limit(\n+                                        self.tcx,\n+                                        Namespace::TypeNS,\n+                                        rustc_session::Limit(5),\n+                                    ))\n+                                    .unwrap()\n+                                    .into_buffer()\n+                            )),\n+                        )),\n                         _ => None,\n                     }),\n                 _ => None,"}, {"sha": "e3e1663be2546b30a6949998e043fd0e74235197", "filename": "compiler/rustc_trait_selection/src/traits/error_reporting/suggestions.rs", "status": "modified", "additions": 19, "deletions": 5, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/f1ffe823cf1496436a1490e838dec375b225b97b/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f1ffe823cf1496436a1490e838dec375b225b97b/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs?ref=f1ffe823cf1496436a1490e838dec375b225b97b", "patch": "@@ -2622,11 +2622,25 @@ impl<'tcx> TypeErrCtxtExt<'tcx> for TypeErrCtxt<'_, 'tcx> {\n                 }\n             }\n             ObligationCauseCode::ObjectCastObligation(concrete_ty, object_ty) => {\n-                err.note(&format!(\n-                    \"required for the cast from `{}` to the object type `{}`\",\n-                    self.ty_to_string(concrete_ty),\n-                    self.ty_to_string(object_ty)\n-                ));\n+                let (concrete_ty, concrete_file) =\n+                    self.tcx.short_ty_string(self.resolve_vars_if_possible(concrete_ty));\n+                let (object_ty, object_file) =\n+                    self.tcx.short_ty_string(self.resolve_vars_if_possible(object_ty));\n+                err.note(&with_forced_trimmed_paths!(format!(\n+                    \"required for the cast from `{concrete_ty}` to the object type `{object_ty}`\",\n+                )));\n+                if let Some(file) = concrete_file {\n+                    err.note(&format!(\n+                        \"the full name for the casted type has been written to '{}'\",\n+                        file.display(),\n+                    ));\n+                }\n+                if let Some(file) = object_file {\n+                    err.note(&format!(\n+                        \"the full name for the object type has been written to '{}'\",\n+                        file.display(),\n+                    ));\n+                }\n             }\n             ObligationCauseCode::Coercion { source: _, target } => {\n                 err.note(&format!(\"required by cast to type `{}`\", self.ty_to_string(target)));"}, {"sha": "7e6b71408558345b0a00c3bcede817b03a98559b", "filename": "tests/ui/diagnostic-width/E0271.rs", "status": "added", "additions": 33, "deletions": 0, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/f1ffe823cf1496436a1490e838dec375b225b97b/tests%2Fui%2Fdiagnostic-width%2FE0271.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f1ffe823cf1496436a1490e838dec375b225b97b/tests%2Fui%2Fdiagnostic-width%2FE0271.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fdiagnostic-width%2FE0271.rs?ref=f1ffe823cf1496436a1490e838dec375b225b97b", "patch": "@@ -0,0 +1,33 @@\n+// compile-flags: --diagnostic-width=40\n+// normalize-stderr-test: \"long-type-\\d+\" -> \"long-type-hash\"\n+trait Future {\n+    type Error;\n+}\n+\n+impl<T, E> Future for Result<T, E> {\n+    type Error = E;\n+}\n+\n+impl<T> Future for Option<T> {\n+    type Error = ();\n+}\n+\n+struct Foo;\n+\n+fn foo() -> Box<dyn Future<Error=Foo>> {\n+    Box::new( //~ ERROR E0271\n+        Ok::<_, ()>(\n+            Err::<(), _>(\n+                Ok::<_, ()>(\n+                    Err::<(), _>(\n+                        Ok::<_, ()>(\n+                            Err::<(), _>(Some(5))\n+                        )\n+                    )\n+                )\n+            )\n+        )\n+    )\n+}\n+fn main() {\n+}"}, {"sha": "ed7b6651d018645f3599c751dbf6432bb1b24c10", "filename": "tests/ui/diagnostic-width/E0271.stderr", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/f1ffe823cf1496436a1490e838dec375b225b97b/tests%2Fui%2Fdiagnostic-width%2FE0271.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/f1ffe823cf1496436a1490e838dec375b225b97b/tests%2Fui%2Fdiagnostic-width%2FE0271.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fdiagnostic-width%2FE0271.stderr?ref=f1ffe823cf1496436a1490e838dec375b225b97b", "patch": "@@ -0,0 +1,23 @@\n+error[E0271]: type mismatch resolving `<Result<Result<(), Result<Result<(), Result<Result<(), Option<{integer}>>, ...>>, ...>>, ...> as Future>::Error == Foo`\n+  --> $DIR/E0271.rs:18:5\n+   |\n+LL | /     Box::new(\n+LL | |         Ok::<_, ()>(\n+LL | |             Err::<(), _>(\n+LL | |                 Ok::<_, ()>(\n+...  |\n+LL | |         )\n+LL | |     )\n+   | |_____^ type mismatch resolving `<Result<Result<(), Result<Result<(), ...>, ...>>, ...> as Future>::Error == Foo`\n+   |\n+note: expected this to be `Foo`\n+  --> $DIR/E0271.rs:8:18\n+   |\n+LL |     type Error = E;\n+   |                  ^\n+   = note: required for the cast from `Result<Result<..., ...>, ...>` to the object type `dyn Future<Error = Foo>`\n+   = note: the full name for the casted type has been written to '$TEST_BUILD_DIR/diagnostic-width/E0271/E0271.long-type-hash.txt'\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0271`."}, {"sha": "f843115a1d9a144b630935ab25e0afea04992772", "filename": "tests/ui/higher-rank-trait-bounds/issue-62203-hrtb-ice.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/f1ffe823cf1496436a1490e838dec375b225b97b/tests%2Fui%2Fhigher-rank-trait-bounds%2Fissue-62203-hrtb-ice.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/f1ffe823cf1496436a1490e838dec375b225b97b/tests%2Fui%2Fhigher-rank-trait-bounds%2Fissue-62203-hrtb-ice.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fhigher-rank-trait-bounds%2Fissue-62203-hrtb-ice.stderr?ref=f1ffe823cf1496436a1490e838dec375b225b97b", "patch": "@@ -1,4 +1,4 @@\n-error[E0271]: type mismatch resolving `for<'r> <L<[closure@$DIR/issue-62203-hrtb-ice.rs:42:16: 42:19]> as T0<'r, (&'r u8,)>>::O == <_ as Ty<'r>>::V`\n+error[E0271]: type mismatch resolving `for<'r> <L<[closure@issue-62203-hrtb-ice.rs:42:16]> as T0<'r, (&'r u8,)>>::O == <_ as Ty<'r>>::V`\n   --> $DIR/issue-62203-hrtb-ice.rs:39:9\n    |\n LL |       let v = Unit2.m(\n@@ -10,7 +10,7 @@ LL | |             f: |x| {\n ...  |\n LL | |             },\n LL | |         },\n-   | |_________^ type mismatch resolving `for<'r> <L<[closure@$DIR/issue-62203-hrtb-ice.rs:42:16: 42:19]> as T0<'r, (&'r u8,)>>::O == <_ as Ty<'r>>::V`\n+   | |_________^ type mismatch resolving `for<'r> <L<[closure@issue-62203-hrtb-ice.rs:42:16]> as T0<'r, (&'r u8,)>>::O == <_ as Ty<'r>>::V`\n    |\n note: expected this to be `<_ as Ty<'_>>::V`\n   --> $DIR/issue-62203-hrtb-ice.rs:21:14"}, {"sha": "f04a753a0e8bd5cc5df21dcb15c3d6c1fbba7831", "filename": "tests/ui/impl-trait/bound-normalization-fail.stderr", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/f1ffe823cf1496436a1490e838dec375b225b97b/tests%2Fui%2Fimpl-trait%2Fbound-normalization-fail.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/f1ffe823cf1496436a1490e838dec375b225b97b/tests%2Fui%2Fimpl-trait%2Fbound-normalization-fail.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fimpl-trait%2Fbound-normalization-fail.stderr?ref=f1ffe823cf1496436a1490e838dec375b225b97b", "patch": "@@ -1,8 +1,8 @@\n-error[E0271]: type mismatch resolving `<Foo<()> as FooLike>::Output == <T as impl_trait::Trait>::Assoc`\n+error[E0271]: type mismatch resolving `<Foo<()> as FooLike>::Output == <T as Trait>::Assoc`\n   --> $DIR/bound-normalization-fail.rs:25:32\n    |\n LL |     fn foo_fail<T: Trait>() -> impl FooLike<Output = T::Assoc> {\n-   |                                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ type mismatch resolving `<Foo<()> as FooLike>::Output == <T as impl_trait::Trait>::Assoc`\n+   |                                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ type mismatch resolving `<Foo<()> as FooLike>::Output == <T as Trait>::Assoc`\n LL |\n LL |         Foo(())\n    |         ------- return type was inferred to be `Foo<()>` here\n@@ -28,11 +28,11 @@ LL |     fn foo2_fail<'a, T: Trait<'a>>() -> impl FooLike<Output = T::Assoc> {\n    = note: see issue #103532 <https://github.com/rust-lang/rust/issues/103532> for more information\n    = help: add `#![feature(impl_trait_projections)]` to the crate attributes to enable\n \n-error[E0271]: type mismatch resolving `<Foo<()> as FooLike>::Output == <T as lifetimes::Trait<'a>>::Assoc`\n+error[E0271]: type mismatch resolving `<Foo<()> as FooLike>::Output == <T as Trait<'a>>::Assoc`\n   --> $DIR/bound-normalization-fail.rs:41:41\n    |\n LL |     fn foo2_fail<'a, T: Trait<'a>>() -> impl FooLike<Output = T::Assoc> {\n-   |                                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ type mismatch resolving `<Foo<()> as FooLike>::Output == <T as lifetimes::Trait<'a>>::Assoc`\n+   |                                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ type mismatch resolving `<Foo<()> as FooLike>::Output == <T as Trait<'a>>::Assoc`\n ...\n LL |         Foo(())\n    |         ------- return type was inferred to be `Foo<()>` here"}]}