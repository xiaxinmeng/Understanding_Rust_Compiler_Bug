{"sha": "83298a212076e74808198f46bb98467d2cb41ac9", "node_id": "MDY6Q29tbWl0NzI0NzEyOjgzMjk4YTIxMjA3NmU3NDgwODE5OGY0NmJiOTg0NjdkMmNiNDFhYzk=", "commit": {"author": {"name": "Shotaro Yamada", "email": "sinkuu@sinkuu.xyz", "date": "2018-12-13T02:43:14Z"}, "committer": {"name": "Shotaro Yamada", "email": "sinkuu@sinkuu.xyz", "date": "2018-12-13T03:01:15Z"}, "message": "Make SimplifyCfg collapse goto chains from bb0", "tree": {"sha": "c2412d40350da7e76c5bf1de2c999c9a04e53279", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c2412d40350da7e76c5bf1de2c999c9a04e53279"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/83298a212076e74808198f46bb98467d2cb41ac9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/83298a212076e74808198f46bb98467d2cb41ac9", "html_url": "https://github.com/rust-lang/rust/commit/83298a212076e74808198f46bb98467d2cb41ac9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/83298a212076e74808198f46bb98467d2cb41ac9/comments", "author": {"login": "sinkuu", "id": 7091080, "node_id": "MDQ6VXNlcjcwOTEwODA=", "avatar_url": "https://avatars.githubusercontent.com/u/7091080?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sinkuu", "html_url": "https://github.com/sinkuu", "followers_url": "https://api.github.com/users/sinkuu/followers", "following_url": "https://api.github.com/users/sinkuu/following{/other_user}", "gists_url": "https://api.github.com/users/sinkuu/gists{/gist_id}", "starred_url": "https://api.github.com/users/sinkuu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sinkuu/subscriptions", "organizations_url": "https://api.github.com/users/sinkuu/orgs", "repos_url": "https://api.github.com/users/sinkuu/repos", "events_url": "https://api.github.com/users/sinkuu/events{/privacy}", "received_events_url": "https://api.github.com/users/sinkuu/received_events", "type": "User", "site_admin": false}, "committer": {"login": "sinkuu", "id": 7091080, "node_id": "MDQ6VXNlcjcwOTEwODA=", "avatar_url": "https://avatars.githubusercontent.com/u/7091080?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sinkuu", "html_url": "https://github.com/sinkuu", "followers_url": "https://api.github.com/users/sinkuu/followers", "following_url": "https://api.github.com/users/sinkuu/following{/other_user}", "gists_url": "https://api.github.com/users/sinkuu/gists{/gist_id}", "starred_url": "https://api.github.com/users/sinkuu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sinkuu/subscriptions", "organizations_url": "https://api.github.com/users/sinkuu/orgs", "repos_url": "https://api.github.com/users/sinkuu/repos", "events_url": "https://api.github.com/users/sinkuu/events{/privacy}", "received_events_url": "https://api.github.com/users/sinkuu/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a64cdec1b48b0d042e5f0e38634a7c438c104b85", "url": "https://api.github.com/repos/rust-lang/rust/commits/a64cdec1b48b0d042e5f0e38634a7c438c104b85", "html_url": "https://github.com/rust-lang/rust/commit/a64cdec1b48b0d042e5f0e38634a7c438c104b85"}], "stats": {"total": 81, "additions": 80, "deletions": 1}, "files": [{"sha": "592f721b2f545d79a611e0c4db0eb1d5eae9d394", "filename": "src/librustc_mir/transform/simplify.rs", "status": "modified", "additions": 26, "deletions": 1, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/83298a212076e74808198f46bb98467d2cb41ac9/src%2Flibrustc_mir%2Ftransform%2Fsimplify.rs", "raw_url": "https://github.com/rust-lang/rust/raw/83298a212076e74808198f46bb98467d2cb41ac9/src%2Flibrustc_mir%2Ftransform%2Fsimplify.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fsimplify.rs?ref=83298a212076e74808198f46bb98467d2cb41ac9", "patch": "@@ -108,10 +108,14 @@ impl<'a, 'tcx: 'a> CfgSimplifier<'a, 'tcx> {\n     pub fn simplify(mut self) {\n         self.strip_nops();\n \n+        let mut start = START_BLOCK;\n+\n         loop {\n             let mut changed = false;\n \n-            for bb in (0..self.basic_blocks.len()).map(BasicBlock::new) {\n+            self.collapse_goto_chain(&mut start, &mut changed);\n+\n+            for bb in self.basic_blocks.indices() {\n                 if self.pred_count[bb] == 0 {\n                     continue\n                 }\n@@ -142,6 +146,27 @@ impl<'a, 'tcx: 'a> CfgSimplifier<'a, 'tcx> {\n \n             if !changed { break }\n         }\n+\n+        if start != START_BLOCK {\n+            debug_assert!(self.pred_count[START_BLOCK] == 0);\n+            self.basic_blocks.swap(START_BLOCK, start);\n+            self.pred_count.swap(START_BLOCK, start);\n+\n+            // pred_count == 1 if the start block has no predecessor _blocks_.\n+            if self.pred_count[START_BLOCK] > 1 {\n+                for (bb, data) in self.basic_blocks.iter_enumerated_mut() {\n+                    if self.pred_count[bb] == 0 {\n+                        continue;\n+                    }\n+\n+                    for target in data.terminator_mut().successors_mut() {\n+                        if *target == start {\n+                            *target = START_BLOCK;\n+                        }\n+                    }\n+                }\n+            }\n+        }\n     }\n \n     // Collapse a goto chain starting from `start`"}, {"sha": "ef843f7158130b7a326931fd771e66874b4dd8b4", "filename": "src/test/mir-opt/simplify_cfg.rs", "status": "added", "additions": 54, "deletions": 0, "changes": 54, "blob_url": "https://github.com/rust-lang/rust/blob/83298a212076e74808198f46bb98467d2cb41ac9/src%2Ftest%2Fmir-opt%2Fsimplify_cfg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/83298a212076e74808198f46bb98467d2cb41ac9/src%2Ftest%2Fmir-opt%2Fsimplify_cfg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fsimplify_cfg.rs?ref=83298a212076e74808198f46bb98467d2cb41ac9", "patch": "@@ -0,0 +1,54 @@\n+// Test that the goto chain starting from bb0 is collapsed.\n+\n+fn main() {\n+    loop {\n+        if bar() {\n+            break;\n+        }\n+    }\n+}\n+\n+#[inline(never)]\n+fn bar() -> bool {\n+    true\n+}\n+\n+// END RUST SOURCE\n+// START rustc.main.SimplifyCfg-initial.before.mir\n+//     bb0: {\n+//         goto -> bb1;\n+//     }\n+//     bb1: {\n+//         falseUnwind -> [real: bb3, cleanup: bb4];\n+//     }\n+//     ...\n+//     bb11: {\n+//         ...\n+//         goto -> bb1;\n+//     }\n+// END rustc.main.SimplifyCfg-initial.before.mir\n+// START rustc.main.SimplifyCfg-initial.after.mir\n+//     bb0: {\n+//         falseUnwind -> [real: bb1, cleanup: bb2];\n+//     }\n+//     ...\n+//     bb5: {\n+//         ...\n+//         goto -> bb0;\n+//     }\n+// END rustc.main.SimplifyCfg-initial.after.mir\n+// START rustc.main.SimplifyCfg-early-opt.before.mir\n+//     bb0: {\n+//         goto -> bb1;\n+//     }\n+//     bb1: {\n+//         StorageLive(_2);\n+//         _2 = const bar() -> bb3;\n+//     }\n+// END rustc.main.SimplifyCfg-early-opt.before.mir\n+// START rustc.main.SimplifyCfg-early-opt.after.mir\n+//     bb0: {\n+//         StorageLive(_2);\n+//         _2 = const bar() -> bb1;\n+//     }\n+// END rustc.main.SimplifyCfg-early-opt.after.mir"}]}