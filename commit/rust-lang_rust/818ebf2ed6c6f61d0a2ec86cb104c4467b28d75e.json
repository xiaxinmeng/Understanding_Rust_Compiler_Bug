{"sha": "818ebf2ed6c6f61d0a2ec86cb104c4467b28d75e", "node_id": "MDY6Q29tbWl0NzI0NzEyOjgxOGViZjJlZDZjNmY2MWQwYTJlYzg2Y2IxMDRjNDQ2N2IyOGQ3NWU=", "commit": {"author": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2013-10-14T23:08:18Z"}, "committer": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2013-10-14T23:08:18Z"}, "message": "std::rt: Fix the set up of the main thread so that it doesn't try to steal work\n\nThis is causing really awful scheduler behavior where the main thread scheduler is\ncontinually waking up, stealing work, discovering it can't actually run the work,\nand sending it off to another scheduler.", "tree": {"sha": "02921bb60e0e54f7e7eb2e0a4ef1edcf25514bf5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/02921bb60e0e54f7e7eb2e0a4ef1edcf25514bf5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/818ebf2ed6c6f61d0a2ec86cb104c4467b28d75e", "comment_count": 5, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/818ebf2ed6c6f61d0a2ec86cb104c4467b28d75e", "html_url": "https://github.com/rust-lang/rust/commit/818ebf2ed6c6f61d0a2ec86cb104c4467b28d75e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/818ebf2ed6c6f61d0a2ec86cb104c4467b28d75e/comments", "author": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "committer": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c6e3501da14784cd2401dded3b53f3ce3405b4ec", "url": "https://api.github.com/repos/rust-lang/rust/commits/c6e3501da14784cd2401dded3b53f3ce3405b4ec", "html_url": "https://github.com/rust-lang/rust/commit/c6e3501da14784cd2401dded3b53f3ce3405b4ec"}], "stats": {"total": 10, "additions": 8, "deletions": 2}, "files": [{"sha": "9ea7b734d248cd8f0219340b176c7e7c7725cd6c", "filename": "src/libstd/rt/mod.rs", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/818ebf2ed6c6f61d0a2ec86cb104c4467b28d75e/src%2Flibstd%2Frt%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/818ebf2ed6c6f61d0a2ec86cb104c4467b28d75e/src%2Flibstd%2Frt%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Frt%2Fmod.rs?ref=818ebf2ed6c6f61d0a2ec86cb104c4467b28d75e", "patch": "@@ -310,8 +310,14 @@ fn run_(main: ~fn(), use_main_sched: bool) -> int {\n                                                      sleepers.clone(),\n                                                      false,\n                                                      Some(friend_handle));\n-        let main_handle = main_sched.make_handle();\n-        handles.push(main_handle);\n+        let mut main_handle = main_sched.make_handle();\n+        // Allow the scheduler to exit when the main task exits.\n+        // Note: sending the shutdown message also prevents the scheduler\n+        // from pushing itself to the sleeper list, which is used for\n+        // waking up schedulers for work stealing; since this is a\n+        // non-work-stealing scheduler it should not be adding itself\n+        // to the list.\n+        main_handle.send_shutdown();\n         Some(main_sched)\n     } else {\n         None"}]}