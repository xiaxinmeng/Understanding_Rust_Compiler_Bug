{"sha": "8a0fda2ec1b9f70b9cbcb52c2b72ee0fe7987b44", "node_id": "C_kwDOAAsO6NoAKDhhMGZkYTJlYzFiOWY3MGI5Y2JjYjUyYzJiNzJlZTBmZTc5ODdiNDQ", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-10-04T04:14:11Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-10-04T04:14:11Z"}, "message": "Rollup merge of #102567 - compiler-errors:issue-102561, r=davidtwco\n\nDelay evaluating lint primary message until after it would be suppressed\n\nFixes #102561\nFixes #102572", "tree": {"sha": "8d72e227d6e2da246feb4478648bf9f390d59785", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8d72e227d6e2da246feb4478648bf9f390d59785"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8a0fda2ec1b9f70b9cbcb52c2b72ee0fe7987b44", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjO7MTCRBK7hj4Ov3rIwAAHvwIAErlLsC/qxsGLJJpdSH7u4D2\nL6vM7gPsqGep+J7DlV/y7BTXiWcdM0AEZXYkgim9Y7lUf7GW3l85cuJQJG7XHl42\n9XYkMQGFN9xdUzpU8y6RFhEt1y5uxuYz8S28TOtF2BKs/yovOUmNsIdbxuxVF94H\nKBMscV307svuIRyvy2BEtPoGF6Z0HPwn98Wixaw8IMwzp234KILT3eimfK52pHOu\nkI/S2K5LTzzJthGQ1+qg0rcc+hiwrA8bpfzNnM8C0vKIcM+k/8VUy8t/EssS4tIp\nEmm7yDhgncM/FbZN+od4zBk+cm816Aa0f3PGouJEQMDM+J5iLzpBQF6b0q+PWFI=\n=NjF0\n-----END PGP SIGNATURE-----\n", "payload": "tree 8d72e227d6e2da246feb4478648bf9f390d59785\nparent f33343632e3dccb0b95a4e9c59ad4b83bc687aa8\nparent f088e543cb51afa12c05097c131969d7962eca36\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1664856851 +0200\ncommitter GitHub <noreply@github.com> 1664856851 +0200\n\nRollup merge of #102567 - compiler-errors:issue-102561, r=davidtwco\n\nDelay evaluating lint primary message until after it would be suppressed\n\nFixes #102561\nFixes #102572\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8a0fda2ec1b9f70b9cbcb52c2b72ee0fe7987b44", "html_url": "https://github.com/rust-lang/rust/commit/8a0fda2ec1b9f70b9cbcb52c2b72ee0fe7987b44", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8a0fda2ec1b9f70b9cbcb52c2b72ee0fe7987b44/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f33343632e3dccb0b95a4e9c59ad4b83bc687aa8", "url": "https://api.github.com/repos/rust-lang/rust/commits/f33343632e3dccb0b95a4e9c59ad4b83bc687aa8", "html_url": "https://github.com/rust-lang/rust/commit/f33343632e3dccb0b95a4e9c59ad4b83bc687aa8"}, {"sha": "f088e543cb51afa12c05097c131969d7962eca36", "url": "https://api.github.com/repos/rust-lang/rust/commits/f088e543cb51afa12c05097c131969d7962eca36", "html_url": "https://github.com/rust-lang/rust/commit/f088e543cb51afa12c05097c131969d7962eca36"}], "stats": {"total": 24, "additions": 23, "deletions": 1}, "files": [{"sha": "b3b02f5b9879b7932224126f7b8784ddbeba1b66", "filename": "compiler/rustc_middle/src/lint.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/8a0fda2ec1b9f70b9cbcb52c2b72ee0fe7987b44/compiler%2Frustc_middle%2Fsrc%2Flint.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8a0fda2ec1b9f70b9cbcb52c2b72ee0fe7987b44/compiler%2Frustc_middle%2Fsrc%2Flint.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Flint.rs?ref=8a0fda2ec1b9f70b9cbcb52c2b72ee0fe7987b44", "patch": "@@ -350,7 +350,6 @@ pub fn struct_lint_level(\n             (Level::Deny | Level::Forbid, None) => sess.diagnostic().struct_err_lint(\"\"),\n         };\n \n-        err.set_primary_message(msg);\n         err.set_is_lint();\n \n         // If this code originates in a foreign macro, aka something that this crate\n@@ -375,6 +374,10 @@ pub fn struct_lint_level(\n             }\n         }\n \n+        // Delay evaluating and setting the primary message until after we've\n+        // suppressed the lint due to macros.\n+        err.set_primary_message(msg);\n+\n         // Lint diagnostics that are covered by the expect level will not be emitted outside\n         // the compiler. It is therefore not necessary to add any information for the user.\n         // This will therefore directly call the decorate function which will in turn emit"}, {"sha": "ab2332d065655c1738d13c03334127a3b89198ec", "filename": "src/test/ui/lint/auxiliary/trivial-cast-ice.rs", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/8a0fda2ec1b9f70b9cbcb52c2b72ee0fe7987b44/src%2Ftest%2Fui%2Flint%2Fauxiliary%2Ftrivial-cast-ice.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8a0fda2ec1b9f70b9cbcb52c2b72ee0fe7987b44/src%2Ftest%2Fui%2Flint%2Fauxiliary%2Ftrivial-cast-ice.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Fauxiliary%2Ftrivial-cast-ice.rs?ref=8a0fda2ec1b9f70b9cbcb52c2b72ee0fe7987b44", "patch": "@@ -0,0 +1,7 @@\n+#[macro_export]\n+macro_rules! foo {\n+    () => {\n+        let x: &Option<i32> = &Some(1);\n+        let _y = x as *const Option<i32>;\n+    }\n+}"}, {"sha": "f781fab2212cc535526762ba12910aea035f5f23", "filename": "src/test/ui/lint/trivial-cast-ice.rs", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/8a0fda2ec1b9f70b9cbcb52c2b72ee0fe7987b44/src%2Ftest%2Fui%2Flint%2Ftrivial-cast-ice.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8a0fda2ec1b9f70b9cbcb52c2b72ee0fe7987b44/src%2Ftest%2Fui%2Flint%2Ftrivial-cast-ice.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Ftrivial-cast-ice.rs?ref=8a0fda2ec1b9f70b9cbcb52c2b72ee0fe7987b44", "patch": "@@ -0,0 +1,12 @@\n+// aux-build:trivial-cast-ice.rs\n+// check-pass\n+\n+// Demonstrates the ICE in #102561\n+\n+#![deny(trivial_casts)]\n+\n+extern crate trivial_cast_ice;\n+\n+fn main() {\n+    trivial_cast_ice::foo!();\n+}"}]}