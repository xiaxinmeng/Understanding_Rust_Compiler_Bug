{"sha": "1cf7bcc388b5aee7ef940d730d1ede212f8e5a31", "node_id": "C_kwDOAAsO6NoAKDFjZjdiY2MzODhiNWFlZTdlZjk0MGQ3MzBkMWVkZTIxMmY4ZTVhMzE", "commit": {"author": {"name": "Joshua Nelson", "email": "jnelson@cloudflare.com", "date": "2022-08-24T02:47:59Z"}, "committer": {"name": "Joshua Nelson", "email": "jnelson@cloudflare.com", "date": "2022-09-01T23:34:37Z"}, "message": "Get rid of `make_query` module", "tree": {"sha": "731d73513019b3265e215afb4c36773a80b186fa", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/731d73513019b3265e215afb4c36773a80b186fa"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1cf7bcc388b5aee7ef940d730d1ede212f8e5a31", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1cf7bcc388b5aee7ef940d730d1ede212f8e5a31", "html_url": "https://github.com/rust-lang/rust/commit/1cf7bcc388b5aee7ef940d730d1ede212f8e5a31", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1cf7bcc388b5aee7ef940d730d1ede212f8e5a31/comments", "author": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2e35f954ada0f0c777844dc4fa66684efe90a035", "url": "https://api.github.com/repos/rust-lang/rust/commits/2e35f954ada0f0c777844dc4fa66684efe90a035", "html_url": "https://github.com/rust-lang/rust/commit/2e35f954ada0f0c777844dc4fa66684efe90a035"}], "stats": {"total": 19, "additions": 6, "deletions": 13}, "files": [{"sha": "b115381eb1c1dcf97a83409dfcbb5b7e4ecef4ab", "filename": "compiler/rustc_query_impl/src/plumbing.rs", "status": "modified", "additions": 6, "deletions": 13, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/1cf7bcc388b5aee7ef940d730d1ede212f8e5a31/compiler%2Frustc_query_impl%2Fsrc%2Fplumbing.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1cf7bcc388b5aee7ef940d730d1ede212f8e5a31/compiler%2Frustc_query_impl%2Fsrc%2Fplumbing.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_query_impl%2Fsrc%2Fplumbing.rs?ref=1cf7bcc388b5aee7ef940d730d1ede212f8e5a31", "patch": "@@ -308,18 +308,6 @@ macro_rules! define_queries {\n             input: ($(([$($modifiers)*] [$($attr)*] [$name]))*)\n         }\n \n-        mod make_query {\n-            use super::*;\n-\n-            // Create an eponymous constructor for each query.\n-            $(#[allow(nonstandard_style)] $(#[$attr])*\n-            pub fn $name<'tcx>(tcx: QueryCtxt<'tcx>, key: <queries::$name<'tcx> as QueryConfig>::Key) -> QueryStackFrame {\n-                let kind = dep_graph::DepKind::$name;\n-                let name = stringify!($name);\n-                $crate::plumbing::create_query_frame(tcx, queries::$name::describe, key, kind, name)\n-            })*\n-        }\n-\n         #[allow(nonstandard_style)]\n         mod queries {\n             use std::marker::PhantomData;\n@@ -531,9 +519,14 @@ macro_rules! define_queries_struct {\n                 let mut jobs = QueryMap::default();\n \n                 $(\n+                    let make_query = |tcx, key| {\n+                        let kind = dep_graph::DepKind::$name;\n+                        let name = stringify!($name);\n+                        $crate::plumbing::create_query_frame(tcx, queries::$name::describe, key, kind, name)\n+                    };\n                     self.$name.try_collect_active_jobs(\n                         tcx,\n-                        make_query::$name,\n+                        make_query,\n                         &mut jobs,\n                     )?;\n                 )*"}]}