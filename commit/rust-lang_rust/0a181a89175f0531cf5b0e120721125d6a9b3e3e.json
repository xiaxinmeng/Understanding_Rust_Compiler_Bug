{"sha": "0a181a89175f0531cf5b0e120721125d6a9b3e3e", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBhMTgxYTg5MTc1ZjA1MzFjZjViMGUxMjA3MjExMjVkNmE5YjNlM2U=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-03-17T16:57:06Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-03-17T16:57:06Z"}, "message": "auto merge of #12742 : FlaPer87/rust/issue-11411-static-mut-slice, r=nikomatsakis\n\nThis PR enables the use of mutable slices in *mutable* static items. The work was started by @xales and I added a follow-up commit that moves the *immutable* restriction to the recently added `check_static`\r\n\r\nCloses #11411", "tree": {"sha": "7c7785b43798bc0b508734d0aee132b2c10b62c2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7c7785b43798bc0b508734d0aee132b2c10b62c2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0a181a89175f0531cf5b0e120721125d6a9b3e3e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0a181a89175f0531cf5b0e120721125d6a9b3e3e", "html_url": "https://github.com/rust-lang/rust/commit/0a181a89175f0531cf5b0e120721125d6a9b3e3e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0a181a89175f0531cf5b0e120721125d6a9b3e3e/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "79203b522b9a467c57881b17c486673fdb40c490", "url": "https://api.github.com/repos/rust-lang/rust/commits/79203b522b9a467c57881b17c486673fdb40c490", "html_url": "https://github.com/rust-lang/rust/commit/79203b522b9a467c57881b17c486673fdb40c490"}, {"sha": "abfc6db4c2b9c9c686a5c09d59e4c534e5f4f2ec", "url": "https://api.github.com/repos/rust-lang/rust/commits/abfc6db4c2b9c9c686a5c09d59e4c534e5f4f2ec", "html_url": "https://github.com/rust-lang/rust/commit/abfc6db4c2b9c9c686a5c09d59e4c534e5f4f2ec"}], "stats": {"total": 53, "additions": 50, "deletions": 3}, "files": [{"sha": "841123906cc876ac7f97e1d9dc30b0bef302a370", "filename": "src/librustc/middle/borrowck/check_loans.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/0a181a89175f0531cf5b0e120721125d6a9b3e3e/src%2Flibrustc%2Fmiddle%2Fborrowck%2Fcheck_loans.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0a181a89175f0531cf5b0e120721125d6a9b3e3e/src%2Flibrustc%2Fmiddle%2Fborrowck%2Fcheck_loans.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fborrowck%2Fcheck_loans.rs?ref=0a181a89175f0531cf5b0e120721125d6a9b3e3e", "patch": "@@ -522,6 +522,9 @@ impl<'a> CheckLoanCtxt<'a> {\n                 None => {\n                     return true;\n                 }\n+                Some(mc::AliasableStaticMut) => {\n+                    return true;\n+                }\n                 Some(cause) => {\n                     this.bccx.report_aliasability_violation(\n                         expr.span,"}, {"sha": "e980712d1aa23cdc22bf316dc0e884ce217ddff5", "filename": "src/librustc/middle/check_const.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/0a181a89175f0531cf5b0e120721125d6a9b3e3e/src%2Flibrustc%2Fmiddle%2Fcheck_const.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0a181a89175f0531cf5b0e120721125d6a9b3e3e/src%2Flibrustc%2Fmiddle%2Fcheck_const.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fcheck_const.rs?ref=0a181a89175f0531cf5b0e120721125d6a9b3e3e", "patch": "@@ -156,6 +156,7 @@ fn check_expr(v: &mut CheckCrateVisitor, e: &Expr, is_const: bool) {\n                 }\n             }\n           }\n+          ExprVstore(_, ExprVstoreMutSlice) |\n           ExprVstore(_, ExprVstoreSlice) |\n           ExprVec(_, MutImmutable) |\n           ExprAddrOf(MutImmutable, _) |"}, {"sha": "83f987a0bd0b3343c54356ef60baef2930e680c6", "filename": "src/librustc/middle/check_static.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/0a181a89175f0531cf5b0e120721125d6a9b3e3e/src%2Flibrustc%2Fmiddle%2Fcheck_static.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0a181a89175f0531cf5b0e120721125d6a9b3e3e/src%2Flibrustc%2Fmiddle%2Fcheck_static.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fcheck_static.rs?ref=0a181a89175f0531cf5b0e120721125d6a9b3e3e", "patch": "@@ -107,6 +107,10 @@ impl<'a> Visitor<bool> for CheckStaticVisitor<'a> {\n             ast::ExprVstore(_, ast::ExprVstoreSlice) => {\n                 visit::walk_expr(self, e, is_const);\n             }\n+            ast::ExprVstore(_, ast::ExprVstoreMutSlice) => {\n+                self.tcx.sess.span_err(e.span,\n+                                       \"static items are not allowed to have mutable slices\");\n+           },\n             ast::ExprUnary(ast::UnBox, _) => {\n                 self.tcx.sess.span_err(e.span,\n                                    \"static items are not allowed to have managed pointers\");"}, {"sha": "390c40c0a751e17ee588bd077c212cd24385168d", "filename": "src/librustc/middle/trans/consts.rs", "status": "modified", "additions": 6, "deletions": 3, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/0a181a89175f0531cf5b0e120721125d6a9b3e3e/src%2Flibrustc%2Fmiddle%2Ftrans%2Fconsts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0a181a89175f0531cf5b0e120721125d6a9b3e3e/src%2Flibrustc%2Fmiddle%2Ftrans%2Fconsts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fconsts.rs?ref=0a181a89175f0531cf5b0e120721125d6a9b3e3e", "patch": "@@ -10,7 +10,8 @@\n \n \n use back::abi;\n-use lib::llvm::{llvm, ConstFCmp, ConstICmp, SetLinkage, PrivateLinkage, ValueRef, Bool, True};\n+use lib::llvm::{llvm, ConstFCmp, ConstICmp, SetLinkage, PrivateLinkage, ValueRef, Bool, True,\n+    False};\n use lib::llvm::{IntEQ, IntNE, IntUGT, IntUGE, IntULT, IntULE, IntSGT, IntSGE, IntSLT, IntSLE,\n     RealOEQ, RealOGT, RealOGE, RealOLT, RealOLE, RealONE};\n \n@@ -574,7 +575,8 @@ fn const_expr_unadjusted(cx: &CrateContext, e: &ast::Expr,\n                                                is_local);\n             (v, inlineable)\n           }\n-          ast::ExprVstore(sub, ast::ExprVstoreSlice) => {\n+          ast::ExprVstore(sub, store @ ast::ExprVstoreSlice) |\n+          ast::ExprVstore(sub, store @ ast::ExprVstoreMutSlice) => {\n             match sub.node {\n               ast::ExprLit(ref lit) => {\n                 match lit.node {\n@@ -592,7 +594,8 @@ fn const_expr_unadjusted(cx: &CrateContext, e: &ast::Expr,\n                     llvm::LLVMAddGlobal(cx.llmod, llty.to_ref(), name)\n                 });\n                 llvm::LLVMSetInitializer(gv, cv);\n-                llvm::LLVMSetGlobalConstant(gv, True);\n+                llvm::LLVMSetGlobalConstant(gv,\n+                      if store == ast::ExprVstoreMutSlice { False } else { True });\n                 SetLinkage(gv, PrivateLinkage);\n                 let p = const_ptrcast(cx, gv, llunitty);\n                 (C_struct(cx, [p, C_uint(cx, es.len())], false), false)"}, {"sha": "73ce488cbc6692a45e63c22ed4dba264d25424dc", "filename": "src/test/compile-fail/check-static-immutable-mut-slices.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/0a181a89175f0531cf5b0e120721125d6a9b3e3e/src%2Ftest%2Fcompile-fail%2Fcheck-static-immutable-mut-slices.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0a181a89175f0531cf5b0e120721125d6a9b3e3e/src%2Ftest%2Fcompile-fail%2Fcheck-static-immutable-mut-slices.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fcheck-static-immutable-mut-slices.rs?ref=0a181a89175f0531cf5b0e120721125d6a9b3e3e", "patch": "@@ -0,0 +1,16 @@\n+// Copyright 2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// Checks that immutable static items can't have mutable slices\n+\n+static TEST: &'static mut [int] = &mut [];\n+//~^ ERROR static items are not allowed to have mutable slices\n+\n+pub fn main() { }"}, {"sha": "af25c43005dd4c2a7b9ca3428f39dacfc572ba3b", "filename": "src/test/run-pass/check-static-mut-slices.rs", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/0a181a89175f0531cf5b0e120721125d6a9b3e3e/src%2Ftest%2Frun-pass%2Fcheck-static-mut-slices.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0a181a89175f0531cf5b0e120721125d6a9b3e3e/src%2Ftest%2Frun-pass%2Fcheck-static-mut-slices.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fcheck-static-mut-slices.rs?ref=0a181a89175f0531cf5b0e120721125d6a9b3e3e", "patch": "@@ -0,0 +1,20 @@\n+// Copyright 2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// Checks that mutable static items can have mutable slices\n+\n+static mut TEST: &'static mut [int] = &mut [1];\n+\n+pub fn main() {\n+    unsafe {\n+        TEST[0] += 1;\n+        assert_eq!(TEST[0], 2);\n+    }\n+}"}]}