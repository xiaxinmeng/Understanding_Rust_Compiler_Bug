{"sha": "bc4d39e5fea64970dded1e6d2132d41435c0ef24", "node_id": "C_kwDOAAsO6NoAKGJjNGQzOWU1ZmVhNjQ5NzBkZGVkMWU2ZDIxMzJkNDE0MzVjMGVmMjQ", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-05-26T05:16:37Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-05-26T05:16:37Z"}, "message": "Auto merge of #8866 - botahamec:unused-rounding, r=llogiq\n\nAdd new lint `[unused_rounding]`\n\nfixes #39\n\nchangelog: added a ``[`unused_rounding`]`` lint to check for the rounding of whole-number literals", "tree": {"sha": "1573f39988223caff674bfe5d471e94801bae4d2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1573f39988223caff674bfe5d471e94801bae4d2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bc4d39e5fea64970dded1e6d2132d41435c0ef24", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bc4d39e5fea64970dded1e6d2132d41435c0ef24", "html_url": "https://github.com/rust-lang/rust/commit/bc4d39e5fea64970dded1e6d2132d41435c0ef24", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bc4d39e5fea64970dded1e6d2132d41435c0ef24/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "45785fe1ee254ba988fc39e540475e1bac1f75e1", "url": "https://api.github.com/repos/rust-lang/rust/commits/45785fe1ee254ba988fc39e540475e1bac1f75e1", "html_url": "https://github.com/rust-lang/rust/commit/45785fe1ee254ba988fc39e540475e1bac1f75e1"}, {"sha": "f489954e3e6c7b15fd243d33bdd9eabdf90161b6", "url": "https://api.github.com/repos/rust-lang/rust/commits/f489954e3e6c7b15fd243d33bdd9eabdf90161b6", "html_url": "https://github.com/rust-lang/rust/commit/f489954e3e6c7b15fd243d33bdd9eabdf90161b6"}], "stats": {"total": 114, "additions": 114, "deletions": 0}, "files": [{"sha": "137fd793e754c266768001d7483f7270963e2f1c", "filename": "CHANGELOG.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/bc4d39e5fea64970dded1e6d2132d41435c0ef24/CHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/bc4d39e5fea64970dded1e6d2132d41435c0ef24/CHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/CHANGELOG.md?ref=bc4d39e5fea64970dded1e6d2132d41435c0ef24", "patch": "@@ -3821,6 +3821,7 @@ Released 2018-09-13\n [`unused_collect`]: https://rust-lang.github.io/rust-clippy/master/index.html#unused_collect\n [`unused_io_amount`]: https://rust-lang.github.io/rust-clippy/master/index.html#unused_io_amount\n [`unused_label`]: https://rust-lang.github.io/rust-clippy/master/index.html#unused_label\n+[`unused_rounding`]: https://rust-lang.github.io/rust-clippy/master/index.html#unused_rounding\n [`unused_self`]: https://rust-lang.github.io/rust-clippy/master/index.html#unused_self\n [`unused_unit`]: https://rust-lang.github.io/rust-clippy/master/index.html#unused_unit\n [`unusual_byte_groupings`]: https://rust-lang.github.io/rust-clippy/master/index.html#unusual_byte_groupings"}, {"sha": "02171a0909ed7e9c9f4991384cf9a14937b053aa", "filename": "clippy_lints/src/lib.register_lints.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/bc4d39e5fea64970dded1e6d2132d41435c0ef24/clippy_lints%2Fsrc%2Flib.register_lints.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bc4d39e5fea64970dded1e6d2132d41435c0ef24/clippy_lints%2Fsrc%2Flib.register_lints.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.register_lints.rs?ref=bc4d39e5fea64970dded1e6d2132d41435c0ef24", "patch": "@@ -546,6 +546,7 @@ store.register_lints(&[\n     unsafe_removed_from_name::UNSAFE_REMOVED_FROM_NAME,\n     unused_async::UNUSED_ASYNC,\n     unused_io_amount::UNUSED_IO_AMOUNT,\n+    unused_rounding::UNUSED_ROUNDING,\n     unused_self::UNUSED_SELF,\n     unused_unit::UNUSED_UNIT,\n     unwrap::PANICKING_UNWRAP,"}, {"sha": "10808af363d7019d6bb393c37e29f7760a215b47", "filename": "clippy_lints/src/lib.register_nursery.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/bc4d39e5fea64970dded1e6d2132d41435c0ef24/clippy_lints%2Fsrc%2Flib.register_nursery.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bc4d39e5fea64970dded1e6d2132d41435c0ef24/clippy_lints%2Fsrc%2Flib.register_nursery.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.register_nursery.rs?ref=bc4d39e5fea64970dded1e6d2132d41435c0ef24", "patch": "@@ -32,5 +32,6 @@ store.register_group(true, \"clippy::nursery\", Some(\"clippy_nursery\"), vec![\n     LintId::of(trait_bounds::TYPE_REPETITION_IN_BOUNDS),\n     LintId::of(transmute::TRANSMUTE_UNDEFINED_REPR),\n     LintId::of(transmute::USELESS_TRANSMUTE),\n+    LintId::of(unused_rounding::UNUSED_ROUNDING),\n     LintId::of(use_self::USE_SELF),\n ])"}, {"sha": "09435b06d0a1e403059f60e81b8836b8a8896452", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/bc4d39e5fea64970dded1e6d2132d41435c0ef24/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bc4d39e5fea64970dded1e6d2132d41435c0ef24/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=bc4d39e5fea64970dded1e6d2132d41435c0ef24", "patch": "@@ -402,6 +402,7 @@ mod unnested_or_patterns;\n mod unsafe_removed_from_name;\n mod unused_async;\n mod unused_io_amount;\n+mod unused_rounding;\n mod unused_self;\n mod unused_unit;\n mod unwrap;\n@@ -906,6 +907,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n     store.register_late_pass(|| Box::new(rc_clone_in_vec_init::RcCloneInVecInit));\n     store.register_early_pass(|| Box::new(duplicate_mod::DuplicateMod::default()));\n     store.register_late_pass(|| Box::new(get_first::GetFirst));\n+    store.register_early_pass(|| Box::new(unused_rounding::UnusedRounding));\n     // add lints here, do not remove this comment, it's used in `new_lint`\n }\n "}, {"sha": "306afe441484755d025289dee2a7992329ab2d9d", "filename": "clippy_lints/src/unused_rounding.rs", "status": "added", "additions": 69, "deletions": 0, "changes": 69, "blob_url": "https://github.com/rust-lang/rust/blob/bc4d39e5fea64970dded1e6d2132d41435c0ef24/clippy_lints%2Fsrc%2Funused_rounding.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bc4d39e5fea64970dded1e6d2132d41435c0ef24/clippy_lints%2Fsrc%2Funused_rounding.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Funused_rounding.rs?ref=bc4d39e5fea64970dded1e6d2132d41435c0ef24", "patch": "@@ -0,0 +1,69 @@\n+use clippy_utils::diagnostics::span_lint_and_sugg;\n+use rustc_ast::ast::{Expr, ExprKind, LitFloatType, LitKind};\n+use rustc_errors::Applicability;\n+use rustc_lint::{EarlyContext, EarlyLintPass};\n+use rustc_session::{declare_lint_pass, declare_tool_lint};\n+\n+declare_clippy_lint! {\n+    /// ### What it does\n+    ///\n+    /// Detects cases where a whole-number literal float is being rounded, using\n+    /// the `floor`, `ceil`, or `round` methods.\n+    ///\n+    /// ### Why is this bad?\n+    ///\n+    /// This is unnecessary and confusing to the reader. Doing this is probably a mistake.\n+    ///\n+    /// ### Example\n+    /// ```rust\n+    /// let x = 1f32.ceil();\n+    /// ```\n+    /// Use instead:\n+    /// ```rust\n+    /// let x = 1f32;\n+    /// ```\n+    #[clippy::version = \"1.62.0\"]\n+    pub UNUSED_ROUNDING,\n+    nursery,\n+    \"Uselessly rounding a whole number floating-point literal\"\n+}\n+declare_lint_pass!(UnusedRounding => [UNUSED_ROUNDING]);\n+\n+fn is_useless_rounding(expr: &Expr) -> Option<(&str, String)> {\n+    if let ExprKind::MethodCall(name_ident, args, _) = &expr.kind\n+        && let method_name = name_ident.ident.name.as_str()\n+        && (method_name == \"ceil\" || method_name == \"round\" || method_name == \"floor\")\n+        && !args.is_empty()\n+        && let ExprKind::Lit(spanned) = &args[0].kind\n+        && let LitKind::Float(symbol, ty) = spanned.kind {\n+            let f = symbol.as_str().parse::<f64>().unwrap();\n+            let f_str = symbol.to_string() + if let LitFloatType::Suffixed(ty) = ty {\n+                ty.name_str()\n+            } else {\n+                \"\"\n+            };\n+            if f.fract() == 0.0 {\n+                Some((method_name, f_str))\n+            } else {\n+                None\n+            }\n+        } else {\n+            None\n+        }\n+}\n+\n+impl EarlyLintPass for UnusedRounding {\n+    fn check_expr(&mut self, cx: &EarlyContext<'_>, expr: &Expr) {\n+        if let Some((method_name, float)) = is_useless_rounding(expr) {\n+            span_lint_and_sugg(\n+                cx,\n+                UNUSED_ROUNDING,\n+                expr.span,\n+                &format!(\"used the `{}` method with a whole number float\", method_name),\n+                &format!(\"remove the `{}` method call\", method_name),\n+                float,\n+                Applicability::MachineApplicable,\n+            );\n+        }\n+    }\n+}"}, {"sha": "54f85806ac3b3e5c402e18a573896fc14aa2acc2", "filename": "tests/ui/unused_rounding.fixed", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/bc4d39e5fea64970dded1e6d2132d41435c0ef24/tests%2Fui%2Funused_rounding.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/bc4d39e5fea64970dded1e6d2132d41435c0ef24/tests%2Fui%2Funused_rounding.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Funused_rounding.fixed?ref=bc4d39e5fea64970dded1e6d2132d41435c0ef24", "patch": "@@ -0,0 +1,9 @@\n+// run-rustfix\n+#![warn(clippy::unused_rounding)]\n+\n+fn main() {\n+    let _ = 1f32;\n+    let _ = 1.0f64;\n+    let _ = 1.00f32;\n+    let _ = 2e-54f64.floor();\n+}"}, {"sha": "8d007bc4a1dc8f3333ab72ac2f230fa56808b011", "filename": "tests/ui/unused_rounding.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/bc4d39e5fea64970dded1e6d2132d41435c0ef24/tests%2Fui%2Funused_rounding.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bc4d39e5fea64970dded1e6d2132d41435c0ef24/tests%2Fui%2Funused_rounding.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Funused_rounding.rs?ref=bc4d39e5fea64970dded1e6d2132d41435c0ef24", "patch": "@@ -0,0 +1,9 @@\n+// run-rustfix\n+#![warn(clippy::unused_rounding)]\n+\n+fn main() {\n+    let _ = 1f32.ceil();\n+    let _ = 1.0f64.floor();\n+    let _ = 1.00f32.round();\n+    let _ = 2e-54f64.floor();\n+}"}, {"sha": "6cfb02e040283f615f1162618993fe7709dbe05c", "filename": "tests/ui/unused_rounding.stderr", "status": "added", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/bc4d39e5fea64970dded1e6d2132d41435c0ef24/tests%2Fui%2Funused_rounding.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/bc4d39e5fea64970dded1e6d2132d41435c0ef24/tests%2Fui%2Funused_rounding.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Funused_rounding.stderr?ref=bc4d39e5fea64970dded1e6d2132d41435c0ef24", "patch": "@@ -0,0 +1,22 @@\n+error: used the `ceil` method with a whole number float\n+  --> $DIR/unused_rounding.rs:5:13\n+   |\n+LL |     let _ = 1f32.ceil();\n+   |             ^^^^^^^^^^^ help: remove the `ceil` method call: `1f32`\n+   |\n+   = note: `-D clippy::unused-rounding` implied by `-D warnings`\n+\n+error: used the `floor` method with a whole number float\n+  --> $DIR/unused_rounding.rs:6:13\n+   |\n+LL |     let _ = 1.0f64.floor();\n+   |             ^^^^^^^^^^^^^^ help: remove the `floor` method call: `1.0f64`\n+\n+error: used the `round` method with a whole number float\n+  --> $DIR/unused_rounding.rs:7:13\n+   |\n+LL |     let _ = 1.00f32.round();\n+   |             ^^^^^^^^^^^^^^^ help: remove the `round` method call: `1.00f32`\n+\n+error: aborting due to 3 previous errors\n+"}]}