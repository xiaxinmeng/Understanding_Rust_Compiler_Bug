{"sha": "c16b969f1d4ae9882181e4af2155e57fc061f6f8", "node_id": "C_kwDOAAsO6NoAKGMxNmI5NjlmMWQ0YWU5ODgyMTgxZTRhZjIxNTVlNTdmYzA2MWY2Zjg", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-12-18T17:57:03Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-12-18T17:57:03Z"}, "message": "Rollup merge of #105844 - albertlarsan68:x-rewrite, r=jyn514\n\nMake the x tool use the x and x.ps1 scripts\n\nThis removes another python search from bootstrap.\n\nr? `@jyn514`", "tree": {"sha": "2a05bd2911825455c8857fb360b0a8b0ce833bba", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2a05bd2911825455c8857fb360b0a8b0ce833bba"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c16b969f1d4ae9882181e4af2155e57fc061f6f8", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjn1RvCRBK7hj4Ov3rIwAAm08IAHar7Xz687U/v7I4CjcqRkNh\n2jNdvkT6oVJoD9hHIjs2eTWTfiM3ws+cBVrCOI/5r/ZtSyqPBwEdSAGKTdtqBmSH\nCVLosLZocxRMRRU1yMwdAN3PONbrkA3HXr+/gB4gmLguO2PfmxkoNBHPTZtdUjTQ\n78CUo0+oJpedBuB3FIQpEvzjBcZHA9yIT+XBgp/HiwSH6Pa4hMBZ4LGOqKXRo04k\nVY57NmtNaEEYa0ITfyb6GfJlr/k22TJdf4KVf2GM6XgI3e5dOEA19GX59E9+x6NA\nlsP+fEST324lRiYpCTzkfIIevsis4fAo4mKY5B9W7bfd2Wgr7BqBfbx/YyawTuI=\n=aN6o\n-----END PGP SIGNATURE-----\n", "payload": "tree 2a05bd2911825455c8857fb360b0a8b0ce833bba\nparent f2f297a4f88712ed144f0d714cc4d0191407efb4\nparent 8348e05644777d08d1fa3d245f9be4040e6dcb16\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1671386223 +0100\ncommitter GitHub <noreply@github.com> 1671386223 +0100\n\nRollup merge of #105844 - albertlarsan68:x-rewrite, r=jyn514\n\nMake the x tool use the x and x.ps1 scripts\n\nThis removes another python search from bootstrap.\n\nr? `@jyn514`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c16b969f1d4ae9882181e4af2155e57fc061f6f8", "html_url": "https://github.com/rust-lang/rust/commit/c16b969f1d4ae9882181e4af2155e57fc061f6f8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c16b969f1d4ae9882181e4af2155e57fc061f6f8/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f2f297a4f88712ed144f0d714cc4d0191407efb4", "url": "https://api.github.com/repos/rust-lang/rust/commits/f2f297a4f88712ed144f0d714cc4d0191407efb4", "html_url": "https://github.com/rust-lang/rust/commit/f2f297a4f88712ed144f0d714cc4d0191407efb4"}, {"sha": "8348e05644777d08d1fa3d245f9be4040e6dcb16", "url": "https://api.github.com/repos/rust-lang/rust/commits/8348e05644777d08d1fa3d245f9be4040e6dcb16", "html_url": "https://github.com/rust-lang/rust/commit/8348e05644777d08d1fa3d245f9be4040e6dcb16"}], "stats": {"total": 72, "additions": 32, "deletions": 40}, "files": [{"sha": "f07ff43efe987fec445e76d8102f6c2bbdcabd4a", "filename": "src/tools/x/src/main.rs", "status": "modified", "additions": 32, "deletions": 40, "changes": 72, "blob_url": "https://github.com/rust-lang/rust/blob/c16b969f1d4ae9882181e4af2155e57fc061f6f8/src%2Ftools%2Fx%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c16b969f1d4ae9882181e4af2155e57fc061f6f8/src%2Ftools%2Fx%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fx%2Fsrc%2Fmain.rs?ref=c16b969f1d4ae9882181e4af2155e57fc061f6f8", "patch": "@@ -1,51 +1,43 @@\n-//! Run `x.py` from any subdirectory of a rust compiler checkout.\n+//! Run bootstrap from any subdirectory of a rust compiler checkout.\n //!\n //! We prefer `exec`, to avoid adding an extra process in the process tree.\n //! However, since `exec` isn't available on Windows, we indirect through\n //! `exec_or_status`, which will call `exec` on unix and `status` on Windows.\n //!\n-//! We use `python`, `python3`, or `python2` as the python interpreter to run\n-//! `x.py`, in that order of preference.\n+//! We use `powershell.exe x.ps1` on Windows, and `sh -c x` on Unix, those are\n+//! the ones that call `x.py`. We use `sh -c` on Unix, because it is a standard.\n+//! We also don't use `pwsh` on Windows, because it is not installed by default;\n \n use std::{\n-    env::{self, consts::EXE_EXTENSION},\n-    io,\n+    env, io,\n+    path::Path,\n     process::{self, Command, ExitStatus},\n };\n \n-const PYTHON: &str = \"python\";\n-const PYTHON2: &str = \"python2\";\n-const PYTHON3: &str = \"python3\";\n-\n-fn python() -> &'static str {\n-    let val = match env::var_os(\"PATH\") {\n-        Some(val) => val,\n-        None => return PYTHON,\n-    };\n-\n-    let mut python2 = false;\n-    let mut python3 = false;\n-\n-    for dir in env::split_paths(&val) {\n-        // `python` should always take precedence over python2 / python3 if it exists\n-        if dir.join(PYTHON).with_extension(EXE_EXTENSION).exists() {\n-            return PYTHON;\n-        }\n+#[cfg(windows)]\n+fn x_command(dir: &Path) -> Command {\n+    let mut cmd = Command::new(\"powershell.exe\");\n+    cmd.args([\n+        \"-NoLogo\",\n+        \"-NoProfile\",\n+        \"-NonInteractive\",\n+        \"-ExecutionPolicy\",\n+        \"RemoteSigned\",\n+        \"-Command\",\n+        \"./x.ps1\",\n+    ])\n+    .current_dir(dir);\n+    cmd\n+}\n \n-        python2 |= dir.join(PYTHON2).with_extension(EXE_EXTENSION).exists();\n-        python3 |= dir.join(PYTHON3).with_extension(EXE_EXTENSION).exists();\n-    }\n+#[cfg(unix)]\n+fn x_command(dir: &Path) -> Command {\n+    Command::new(dir.join(\"x\"))\n+}\n \n-    // try 3 before 2\n-    if python3 {\n-        PYTHON3\n-    } else if python2 {\n-        PYTHON2\n-    } else {\n-        // Python was not found on path, so exit\n-        eprintln!(\"Unable to find python in your PATH. Please check it is installed.\");\n-        process::exit(1);\n-    }\n+#[cfg(not(any(windows, unix)))]\n+fn x_command(_dir: &Path) -> Command {\n+    compile_error!(\"Unsupported platform\");\n }\n \n #[cfg(unix)]\n@@ -72,15 +64,15 @@ fn main() {\n         let candidate = dir.join(\"x.py\");\n \n         if candidate.exists() {\n-            let mut python = Command::new(python());\n+            let mut cmd = x_command(dir);\n \n-            python.arg(&candidate).args(env::args().skip(1)).current_dir(dir);\n+            cmd.args(env::args().skip(1)).current_dir(dir);\n \n-            let result = exec_or_status(&mut python);\n+            let result = exec_or_status(&mut cmd);\n \n             match result {\n                 Err(error) => {\n-                    eprintln!(\"Failed to invoke `{}`: {}\", candidate.display(), error);\n+                    eprintln!(\"Failed to invoke `{:?}`: {}\", cmd, error);\n                 }\n                 Ok(status) => {\n                     process::exit(status.code().unwrap_or(1));"}]}