{"sha": "8db0bc0ce9d158ac016d8bec1422d1f01835266f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjhkYjBiYzBjZTlkMTU4YWMwMTZkOGJlYzE0MjJkMWYwMTgzNTI2NmY=", "commit": {"author": {"name": "Scott Olson", "email": "scott@solson.me", "date": "2016-06-16T19:03:41Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2016-06-16T19:03:41Z"}, "message": "Merge pull request #27 from oli-obk/travis\n\ncreate a miri-pass test that allows us to run miri for arbitrary targets", "tree": {"sha": "2d09bf4b54a702c1f8776500ba7c681bea5e2920", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2d09bf4b54a702c1f8776500ba7c681bea5e2920"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8db0bc0ce9d158ac016d8bec1422d1f01835266f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8db0bc0ce9d158ac016d8bec1422d1f01835266f", "html_url": "https://github.com/rust-lang/rust/commit/8db0bc0ce9d158ac016d8bec1422d1f01835266f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8db0bc0ce9d158ac016d8bec1422d1f01835266f/comments", "author": {"login": "solson", "id": 26806, "node_id": "MDQ6VXNlcjI2ODA2", "avatar_url": "https://avatars.githubusercontent.com/u/26806?v=4", "gravatar_id": "", "url": "https://api.github.com/users/solson", "html_url": "https://github.com/solson", "followers_url": "https://api.github.com/users/solson/followers", "following_url": "https://api.github.com/users/solson/following{/other_user}", "gists_url": "https://api.github.com/users/solson/gists{/gist_id}", "starred_url": "https://api.github.com/users/solson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/solson/subscriptions", "organizations_url": "https://api.github.com/users/solson/orgs", "repos_url": "https://api.github.com/users/solson/repos", "events_url": "https://api.github.com/users/solson/events{/privacy}", "received_events_url": "https://api.github.com/users/solson/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "bac37e69d77ca6c8ad78a53672e9be6f5b4c69dd", "url": "https://api.github.com/repos/rust-lang/rust/commits/bac37e69d77ca6c8ad78a53672e9be6f5b4c69dd", "html_url": "https://github.com/rust-lang/rust/commit/bac37e69d77ca6c8ad78a53672e9be6f5b4c69dd"}, {"sha": "60f2bb9c70b89eccf432864e9bd3b448b1363086", "url": "https://api.github.com/repos/rust-lang/rust/commits/60f2bb9c70b89eccf432864e9bd3b448b1363086", "html_url": "https://github.com/rust-lang/rust/commit/60f2bb9c70b89eccf432864e9bd3b448b1363086"}], "stats": {"total": 115, "additions": 83, "deletions": 32}, "files": [{"sha": "e76a2f86cf93db7b3c7290de305dc13ae6b16c60", "filename": ".travis.yml", "status": "modified", "additions": 1, "deletions": 4, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/8db0bc0ce9d158ac016d8bec1422d1f01835266f/.travis.yml", "raw_url": "https://github.com/rust-lang/rust/raw/8db0bc0ce9d158ac016d8bec1422d1f01835266f/.travis.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.travis.yml?ref=8db0bc0ce9d158ac016d8bec1422d1f01835266f", "patch": "@@ -1,16 +1,13 @@\n language: rust\n rust:\n - nightly\n-matrix:\n-  allow_failures:\n-  - rust: nightly\n before_script:\n - |\n   pip install 'travis-cargo<0.2' --user &&\n   export PATH=$HOME/.local/bin:$PATH\n script:\n - |\n-  travis-cargo build &&\n+  env RUST_SYSROOT=$HOME/rust travis-cargo build &&\n   env RUST_SYSROOT=$HOME/rust travis-cargo test\n notifications:\n   email:"}, {"sha": "d0b785a061fbb821312dd464b6c5507ff8d6af84", "filename": "Cargo.lock", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/8db0bc0ce9d158ac016d8bec1422d1f01835266f/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/8db0bc0ce9d158ac016d8bec1422d1f01835266f/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=8db0bc0ce9d158ac016d8bec1422d1f01835266f", "patch": "@@ -3,7 +3,7 @@ name = \"miri\"\n version = \"0.1.0\"\n dependencies = [\n  \"byteorder 0.4.2 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"compiletest_rs 0.1.3 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"compiletest_rs 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"env_logger 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"log 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"log_settings 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)\",\n@@ -24,10 +24,11 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n \n [[package]]\n name = \"compiletest_rs\"\n-version = \"0.1.3\"\n+version = \"0.2.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n dependencies = [\n  \"log 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"rustc-serialize 0.3.19 (registry+https://github.com/rust-lang/crates.io-index)\",\n ]\n \n [[package]]\n@@ -96,6 +97,11 @@ name = \"regex-syntax\"\n version = \"0.3.3\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n \n+[[package]]\n+name = \"rustc-serialize\"\n+version = \"0.3.19\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+\n [[package]]\n name = \"thread-id\"\n version = \"2.0.0\""}, {"sha": "fea568e244d43dfdb2448b75c049bfb9da6bfa3a", "filename": "Cargo.toml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/8db0bc0ce9d158ac016d8bec1422d1f01835266f/Cargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/8db0bc0ce9d158ac016d8bec1422d1f01835266f/Cargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.toml?ref=8db0bc0ce9d158ac016d8bec1422d1f01835266f", "patch": "@@ -21,4 +21,4 @@ log = \"0.3.6\"\n log_settings = \"0.1.1\"\n \n [dev-dependencies]\n-compiletest_rs = \"0.1.1\"\n+compiletest_rs = \"0.2\""}, {"sha": "7c64ad050daf0e3ecba3a5c1127b3e2643f2da5f", "filename": "src/bin/miri.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/8db0bc0ce9d158ac016d8bec1422d1f01835266f/src%2Fbin%2Fmiri.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8db0bc0ce9d158ac016d8bec1422d1f01835266f/src%2Fbin%2Fmiri.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbin%2Fmiri.rs?ref=8db0bc0ce9d158ac016d8bec1422d1f01835266f", "patch": "@@ -17,7 +17,7 @@ use miri::{\n     Frame,\n };\n use rustc::session::Session;\n-use rustc_driver::{driver, CompilerCalls};\n+use rustc_driver::{driver, CompilerCalls, Compilation};\n use rustc::ty::{TyCtxt, subst};\n use rustc::hir::def_id::DefId;\n \n@@ -31,6 +31,7 @@ impl<'a> CompilerCalls<'a> for MiriCompilerCalls {\n     ) -> driver::CompileController<'a> {\n         let mut control = driver::CompileController::basic();\n \n+        control.after_analysis.stop = Compilation::Stop;\n         control.after_analysis.callback = Box::new(|state| {\n             state.session.abort_if_errors();\n \n@@ -70,6 +71,7 @@ impl<'a> CompilerCalls<'a> for MiriCompilerCalls {\n                     }\n                 }\n             }\n+            state.session.abort_if_errors();\n         });\n \n         control"}, {"sha": "66b94ad88da5a69c894d07faefa8590bd396cca4", "filename": "tests/compiletest.rs", "status": "modified", "additions": 70, "deletions": 24, "changes": 94, "blob_url": "https://github.com/rust-lang/rust/blob/8db0bc0ce9d158ac016d8bec1422d1f01835266f/tests%2Fcompiletest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8db0bc0ce9d158ac016d8bec1422d1f01835266f/tests%2Fcompiletest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompiletest.rs?ref=8db0bc0ce9d158ac016d8bec1422d1f01835266f", "patch": "@@ -1,43 +1,89 @@\n extern crate compiletest_rs as compiletest;\n \n-use std::path::PathBuf;\n+use std::path::{PathBuf, Path};\n+use std::io::Write;\n \n-fn run_mode(mode: &'static str) {\n+fn run_mode(dir: &'static str, mode: &'static str, sysroot: &str) {\n     // Disable rustc's new error fomatting. It breaks these tests.\n     std::env::remove_var(\"RUST_NEW_ERROR_FORMAT\");\n-\n-    // Taken from https://github.com/Manishearth/rust-clippy/pull/911.\n-    let home = option_env!(\"RUSTUP_HOME\").or(option_env!(\"MULTIRUST_HOME\"));\n-    let toolchain = option_env!(\"RUSTUP_TOOLCHAIN\").or(option_env!(\"MULTIRUST_TOOLCHAIN\"));\n-    let sysroot = match (home, toolchain) {\n-        (Some(home), Some(toolchain)) => format!(\"{}/toolchains/{}\", home, toolchain),\n-        _ => option_env!(\"RUST_SYSROOT\")\n-            .expect(\"need to specify RUST_SYSROOT env var or use rustup or multirust\")\n-            .to_owned(),\n-    };\n     let flags = format!(\"--sysroot {} -Dwarnings\", sysroot);\n-\n-    // FIXME: read directories in sysroot/lib/rustlib and generate the test targets from that\n-    let targets = &[\"x86_64-unknown-linux-gnu\", \"i686-unknown-linux-gnu\"];\n-\n-    for &target in targets {\n-        use std::io::Write;\n-        let stderr = std::io::stderr();\n-        write!(stderr.lock(), \"running tests for target {}\", target).unwrap();\n+    for_all_targets(sysroot, |target| {\n         let mut config = compiletest::default_config();\n         config.host_rustcflags = Some(flags.clone());\n         config.mode = mode.parse().expect(\"Invalid mode\");\n-        config.run_lib_path = format!(\"{}/lib/rustlib/{}/lib\", sysroot, target);\n+        config.run_lib_path = Path::new(sysroot).join(\"lib\").join(\"rustlib\").join(&target).join(\"lib\");\n         config.rustc_path = \"target/debug/miri\".into();\n-        config.src_base = PathBuf::from(format!(\"tests/{}\", mode));\n+        config.src_base = PathBuf::from(format!(\"tests/{}\", dir));\n         config.target = target.to_owned();\n         config.target_rustcflags = Some(flags.clone());\n         compiletest::run_tests(&config);\n+    });\n+}\n+\n+fn for_all_targets<F: FnMut(String)>(sysroot: &str, mut f: F) {\n+    for target in std::fs::read_dir(format!(\"{}/lib/rustlib/\", sysroot)).unwrap() {\n+        let target = target.unwrap();\n+        if !target.metadata().unwrap().is_dir() {\n+            continue;\n+        }\n+        let target = target.file_name().into_string().unwrap();\n+        if target == \"etc\" {\n+            continue;\n+        }\n+        let stderr = std::io::stderr();\n+        writeln!(stderr.lock(), \"running tests for target {}\", target).unwrap();\n+        f(target);\n     }\n }\n \n #[test]\n fn compile_test() {\n-    run_mode(\"compile-fail\");\n-    run_mode(\"run-pass\");\n+    let mut failed = false;\n+    // Taken from https://github.com/Manishearth/rust-clippy/pull/911.\n+    let home = option_env!(\"RUSTUP_HOME\").or(option_env!(\"MULTIRUST_HOME\"));\n+    let toolchain = option_env!(\"RUSTUP_TOOLCHAIN\").or(option_env!(\"MULTIRUST_TOOLCHAIN\"));\n+    let sysroot = match (home, toolchain) {\n+        (Some(home), Some(toolchain)) => format!(\"{}/toolchains/{}\", home, toolchain),\n+        _ => option_env!(\"RUST_SYSROOT\")\n+            .expect(\"need to specify RUST_SYSROOT env var or use rustup or multirust\")\n+            .to_owned(),\n+    };\n+    run_mode(\"compile-fail\", \"compile-fail\", &sysroot);\n+    for_all_targets(&sysroot, |target| {\n+        for file in std::fs::read_dir(\"tests/run-pass\").unwrap() {\n+            let file = file.unwrap();\n+            if !file.metadata().unwrap().is_file() {\n+                continue;\n+            }\n+            let file = file.path();\n+            let stderr = std::io::stderr();\n+            write!(stderr.lock(), \"test [miri-pass] {} \", file.to_str().unwrap()).unwrap();\n+            let mut cmd = std::process::Command::new(\"target/debug/miri\");\n+            cmd.arg(file);\n+            cmd.arg(\"-Dwarnings\");\n+            cmd.arg(format!(\"--target={}\", target));\n+            let libs = Path::new(&sysroot).join(\"lib\");\n+            let sysroot = libs.join(\"rustlib\").join(&target).join(\"lib\");\n+            let paths = std::env::join_paths(&[libs, sysroot]).unwrap();\n+            cmd.env(compiletest::procsrv::dylib_env_var(), paths);\n+            match cmd.output() {\n+                Ok(ref output) if output.status.success() => writeln!(stderr.lock(), \"ok\").unwrap(),\n+                Ok(output) => {\n+                    failed = true;\n+                    writeln!(stderr.lock(), \"FAILED with exit code {}\", output.status.code().unwrap_or(0)).unwrap();\n+                    writeln!(stderr.lock(), \"stdout: \\n {}\", std::str::from_utf8(&output.stdout).unwrap()).unwrap();\n+                    writeln!(stderr.lock(), \"stderr: \\n {}\", std::str::from_utf8(&output.stderr).unwrap()).unwrap();\n+                }\n+                Err(e) => {\n+                    failed = true;\n+                    writeln!(stderr.lock(), \"FAILED: {}\", e).unwrap();\n+                },\n+            }\n+        }\n+        let stderr = std::io::stderr();\n+        writeln!(stderr.lock(), \"\").unwrap();\n+    });\n+    if failed {\n+        panic!(\"some tests failed\");\n+    }\n }"}]}