{"sha": "08e954f0fd35f4f5f847dba7921d48dc4aa669c0", "node_id": "MDY6Q29tbWl0NzI0NzEyOjA4ZTk1NGYwZmQzNWY0ZjVmODQ3ZGJhNzkyMWQ0OGRjNGFhNjY5YzA=", "commit": {"author": {"name": "Unreal Hoang", "email": "unrealhoang@gmail.com", "date": "2019-05-16T03:54:32Z"}, "committer": {"name": "Unreal Hoang", "email": "unrealhoang@gmail.com", "date": "2019-05-21T14:31:51Z"}, "message": "add assist to move arm condition to match guard", "tree": {"sha": "4abd1ae396b0a356902cd735d7783585b121d4ee", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4abd1ae396b0a356902cd735d7783585b121d4ee"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/08e954f0fd35f4f5f847dba7921d48dc4aa669c0", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEE5FNMeJ7UuhhqQiT99mIXvcbzfPoFAlzkC9wACgkQ9mIXvcbz\nfPo6KA//ci3Yew6zZA523h94utA1z/MU6P6KRtS0LohZEFveiKTMnP4OmGMe8beX\n5+AGyU+rvJvY2oSJly6gNkrN6ZQ5N+Bu4gXmACHOh109pAzpiDOAefoU0ajOpEyx\ngA26ZaY2rBuN/IwkF1QNx8gEELkZIrgd7jKJU6vBtT1VH+4v7oMXUrg2bDPmrQGV\neV1Xw0NIBGNT7iGEnwRhF/LmqPMZjQrvEwEPmOiWQVeXhT/ehc8rZRQU6z3J28d/\ntgnA7QDU9VvNYbMs9tSzzH/M/HV9dKIayxk4hCUTprQDmssM7NQh4M0cykxcWunQ\n0IBFl2XDPKRLRKk2rPcTSEggM9qWRFQ6p5fAfoysLiopDrbGaVIzUCJbk8KlvWWg\nlqxnfTBi2kTIwvCWWNtzzxyD/SnpFen53OZYjJZiuCv91UwnjvM760CbsnHdzCuO\nJz+/DhNbn28odY2fDekV0LqBqQIXeF4YOXssUAcg23UZBEQ2RULt2lHSKUpG1H4C\nPiMoDOtXoIXOYvCa3uZV/ZpaVxWviwakBvCzuif16GIEpXQG3Ogq+uDHvOvIQYRG\nBFc/Kn60oREIBYLreNAMJOS5n10Ks/jaAnoXmUYVEzZnK6/mp7gcRqFm6c1uVper\nsEeDlJQ64mgqtE/pqb80zNhA6tPIrtQvQH++aBFlRdZHPCzg6n0=\n=2Yeo\n-----END PGP SIGNATURE-----", "payload": "tree 4abd1ae396b0a356902cd735d7783585b121d4ee\nparent 99ad6143cdbd783e969649d9243aaa2e5a8131c4\nauthor Unreal Hoang <unrealhoang@gmail.com> 1557978872 +0900\ncommitter Unreal Hoang <unrealhoang@gmail.com> 1558449111 +0900\n\nadd assist to move arm condition to match guard\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/08e954f0fd35f4f5f847dba7921d48dc4aa669c0", "html_url": "https://github.com/rust-lang/rust/commit/08e954f0fd35f4f5f847dba7921d48dc4aa669c0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/08e954f0fd35f4f5f847dba7921d48dc4aa669c0/comments", "author": {"login": "unrealhoang", "id": 1218094, "node_id": "MDQ6VXNlcjEyMTgwOTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1218094?v=4", "gravatar_id": "", "url": "https://api.github.com/users/unrealhoang", "html_url": "https://github.com/unrealhoang", "followers_url": "https://api.github.com/users/unrealhoang/followers", "following_url": "https://api.github.com/users/unrealhoang/following{/other_user}", "gists_url": "https://api.github.com/users/unrealhoang/gists{/gist_id}", "starred_url": "https://api.github.com/users/unrealhoang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/unrealhoang/subscriptions", "organizations_url": "https://api.github.com/users/unrealhoang/orgs", "repos_url": "https://api.github.com/users/unrealhoang/repos", "events_url": "https://api.github.com/users/unrealhoang/events{/privacy}", "received_events_url": "https://api.github.com/users/unrealhoang/received_events", "type": "User", "site_admin": false}, "committer": {"login": "unrealhoang", "id": 1218094, "node_id": "MDQ6VXNlcjEyMTgwOTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1218094?v=4", "gravatar_id": "", "url": "https://api.github.com/users/unrealhoang", "html_url": "https://github.com/unrealhoang", "followers_url": "https://api.github.com/users/unrealhoang/followers", "following_url": "https://api.github.com/users/unrealhoang/following{/other_user}", "gists_url": "https://api.github.com/users/unrealhoang/gists{/gist_id}", "starred_url": "https://api.github.com/users/unrealhoang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/unrealhoang/subscriptions", "organizations_url": "https://api.github.com/users/unrealhoang/orgs", "repos_url": "https://api.github.com/users/unrealhoang/repos", "events_url": "https://api.github.com/users/unrealhoang/events{/privacy}", "received_events_url": "https://api.github.com/users/unrealhoang/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "99ad6143cdbd783e969649d9243aaa2e5a8131c4", "url": "https://api.github.com/repos/rust-lang/rust/commits/99ad6143cdbd783e969649d9243aaa2e5a8131c4", "html_url": "https://github.com/rust-lang/rust/commit/99ad6143cdbd783e969649d9243aaa2e5a8131c4"}], "stats": {"total": 380, "additions": 263, "deletions": 117}, "files": [{"sha": "28eb0226b783e248a79f4734c5e524a4c867765b", "filename": "crates/ra_assists/src/lib.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/08e954f0fd35f4f5f847dba7921d48dc4aa669c0/crates%2Fra_assists%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/08e954f0fd35f4f5f847dba7921d48dc4aa669c0/crates%2Fra_assists%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_assists%2Fsrc%2Flib.rs?ref=08e954f0fd35f4f5f847dba7921d48dc4aa669c0", "patch": "@@ -100,7 +100,7 @@ mod split_import;\n mod remove_dbg;\n pub mod auto_import;\n mod add_missing_impl_members;\n-mod move_guard_to_arm_body_and_back;\n+mod move_guard;\n \n fn all_assists<DB: HirDatabase>() -> &'static [fn(AssistCtx<DB>) -> Option<Assist>] {\n     &[\n@@ -119,7 +119,8 @@ fn all_assists<DB: HirDatabase>() -> &'static [fn(AssistCtx<DB>) -> Option<Assis\n         add_missing_impl_members::add_missing_impl_members,\n         add_missing_impl_members::add_missing_default_members,\n         inline_local_variable::inline_local_varialbe,\n-        move_guard_to_arm_body_and_back::move_guard_to_arm_body,\n+        move_guard::move_guard_to_arm_body,\n+        move_guard::move_arm_cond_to_match_guard,\n     ]\n }\n "}, {"sha": "22ba91fb77103773f16d4607892c776c4c321cc2", "filename": "crates/ra_assists/src/move_guard.rs", "status": "added", "additions": 260, "deletions": 0, "changes": 260, "blob_url": "https://github.com/rust-lang/rust/blob/08e954f0fd35f4f5f847dba7921d48dc4aa669c0/crates%2Fra_assists%2Fsrc%2Fmove_guard.rs", "raw_url": "https://github.com/rust-lang/rust/raw/08e954f0fd35f4f5f847dba7921d48dc4aa669c0/crates%2Fra_assists%2Fsrc%2Fmove_guard.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_assists%2Fsrc%2Fmove_guard.rs?ref=08e954f0fd35f4f5f847dba7921d48dc4aa669c0", "patch": "@@ -0,0 +1,260 @@\n+use hir::db::HirDatabase;\n+use ra_syntax::{\n+    TextUnit,\n+    SyntaxElement,\n+    ast::{MatchArm, AstNode, AstToken, IfExpr},\n+    ast,\n+};\n+\n+use crate::{AssistCtx, Assist, AssistId};\n+\n+pub(crate) fn move_guard_to_arm_body(mut ctx: AssistCtx<impl HirDatabase>) -> Option<Assist> {\n+    let match_arm = ctx.node_at_offset::<MatchArm>()?;\n+    let guard = match_arm.guard()?;\n+    let space_before_guard = guard.syntax().prev_sibling_or_token();\n+\n+    let guard_conditions = guard.expr()?;\n+    let arm_expr = match_arm.expr()?;\n+    let buf = format!(\"if {} {{ {} }}\", guard_conditions.syntax().text(), arm_expr.syntax().text());\n+\n+    ctx.add_action(AssistId(\"move_guard_to_arm_body\"), \"move guard to arm body\", |edit| {\n+        edit.target(guard.syntax().range());\n+        let offseting_amount = match space_before_guard {\n+            Some(SyntaxElement::Token(tok)) => {\n+                if let Some(_) = ast::Whitespace::cast(tok) {\n+                    let ele = space_before_guard.unwrap().range();\n+                    edit.delete(ele);\n+                    ele.len()\n+                } else {\n+                    TextUnit::from(0)\n+                }\n+            }\n+            _ => TextUnit::from(0),\n+        };\n+\n+        edit.delete(guard.syntax().range());\n+        edit.replace_node_and_indent(arm_expr.syntax(), buf);\n+        edit.set_cursor(arm_expr.syntax().range().start() + TextUnit::from(3) - offseting_amount);\n+    });\n+    ctx.build()\n+}\n+\n+pub(crate) fn move_arm_cond_to_match_guard(mut ctx: AssistCtx<impl HirDatabase>) -> Option<Assist> {\n+    let match_arm: &MatchArm = ctx.node_at_offset::<MatchArm>()?;\n+    let last_match_pat = match_arm.pats().last()?;\n+\n+    let arm_body = match_arm.expr()?;\n+    let if_expr: &IfExpr = IfExpr::cast(arm_body.syntax())?;\n+    let cond = if_expr.condition()?;\n+    let then_block = if_expr.then_branch()?;\n+\n+    // Not support if with else branch\n+    if let Some(_) = if_expr.else_branch() {\n+        return None;\n+    }\n+    // Not support moving if let to arm guard\n+    if let Some(_) = cond.pat() {\n+        return None;\n+    }\n+\n+    let buf = format!(\" if {}\", cond.syntax().text());\n+\n+    ctx.add_action(\n+        AssistId(\"move_arm_cond_to_match_guard\"),\n+        \"move condition to match guard\",\n+        |edit| {\n+            edit.target(if_expr.syntax().range());\n+            let then_only_expr = then_block.statements().next().is_none();\n+\n+            match then_block.expr() {\n+                Some(then_expr) if then_only_expr => {\n+                    edit.replace(if_expr.syntax().range(), then_expr.syntax().text())\n+                }\n+                _ => edit.replace(if_expr.syntax().range(), then_block.syntax().text()),\n+            }\n+\n+            edit.insert(last_match_pat.syntax().range().end(), buf);\n+            edit.set_cursor(last_match_pat.syntax().range().end() + TextUnit::from(1));\n+        },\n+    );\n+    ctx.build()\n+}\n+\n+#[cfg(test)]\n+mod tests {\n+    use super::*;\n+\n+    use crate::helpers::{ check_assist, check_assist_target, check_assist_not_applicable };\n+\n+    #[test]\n+    fn move_guard_to_arm_body_target() {\n+        check_assist_target(\n+            move_guard_to_arm_body,\n+            r#\"\n+            fn f() {\n+                let t = 'a';\n+                let chars = \"abcd\";\n+                match t {\n+                    '\\r' <|>if chars.clone().next() == Some('\\n') => false,\n+                    _ => true\n+                }\n+            }\n+            \"#,\n+            r#\"if chars.clone().next() == Some('\\n')\"#,\n+        );\n+    }\n+\n+    #[test]\n+    fn move_guard_to_arm_body_works() {\n+        check_assist(\n+            move_guard_to_arm_body,\n+            r#\"\n+            fn f() {\n+                let t = 'a';\n+                let chars = \"abcd\";\n+                match t {\n+                    '\\r' <|>if chars.clone().next() == Some('\\n') => false,\n+                    _ => true\n+                }\n+            }\n+            \"#,\n+            r#\"\n+            fn f() {\n+                let t = 'a';\n+                let chars = \"abcd\";\n+                match t {\n+                    '\\r' => if chars.clone().next() == Some('\\n') { <|>false },\n+                    _ => true\n+                }\n+            }\n+            \"#,\n+        );\n+    }\n+\n+    #[test]\n+    fn move_guard_to_arm_body_works_complex_match() {\n+        check_assist(\n+            move_guard_to_arm_body,\n+            r#\"\n+            fn f() {\n+                match x {\n+                    <|>y @ 4 | y @ 5    if y > 5 => true,\n+                    _ => false\n+                }\n+            }\n+            \"#,\n+            r#\"\n+            fn f() {\n+                match x {\n+                    y @ 4 | y @ 5 => if y > 5 { <|>true },\n+                    _ => false\n+                }\n+            }\n+            \"#,\n+        );\n+    }\n+\n+    #[test]\n+    fn move_arm_cond_to_match_guard_works() {\n+        check_assist(\n+            move_arm_cond_to_match_guard,\n+            r#\"\n+            fn f() {\n+                let t = 'a';\n+                let chars = \"abcd\";\n+                match t {\n+                    '\\r' => if chars.clone().next() == Some('\\n') { <|>false },\n+                    _ => true\n+                }\n+            }\n+            \"#,\n+            r#\"\n+            fn f() {\n+                let t = 'a';\n+                let chars = \"abcd\";\n+                match t {\n+                    '\\r' <|>if chars.clone().next() == Some('\\n') => false,\n+                    _ => true\n+                }\n+            }\n+            \"#,\n+        );\n+    }\n+\n+    #[test]\n+    fn move_arm_cond_to_match_guard_if_let_not_works() {\n+        check_assist_not_applicable(\n+            move_arm_cond_to_match_guard,\n+            r#\"\n+            fn f() {\n+                let t = 'a';\n+                let chars = \"abcd\";\n+                match t {\n+                    '\\r' => if let Some(_) = chars.clone().next() { <|>false },\n+                    _ => true\n+                }\n+            }\n+            \"#,\n+        );\n+    }\n+\n+    #[test]\n+    fn move_arm_cond_to_match_guard_if_empty_body_works() {\n+        check_assist(\n+            move_arm_cond_to_match_guard,\n+            r#\"\n+            fn f() {\n+                let t = 'a';\n+                let chars = \"abcd\";\n+                match t {\n+                    '\\r' => if chars.clone().next().is_some() { <|> },\n+                    _ => true\n+                }\n+            }\n+            \"#,\n+            r#\"\n+            fn f() {\n+                let t = 'a';\n+                let chars = \"abcd\";\n+                match t {\n+                    '\\r' <|>if chars.clone().next().is_some() => {  },\n+                    _ => true\n+                }\n+            }\n+            \"#,\n+        );\n+    }\n+\n+    #[test]\n+    fn move_arm_cond_to_match_guard_if_multiline_body_works() {\n+        check_assist(\n+            move_arm_cond_to_match_guard,\n+            r#\"\n+            fn f() {\n+                let mut t = 'a';\n+                let chars = \"abcd\";\n+                match t {\n+                    '\\r' => if chars.clone().next().is_some() {\n+                        t = 'e';<|>\n+                        false\n+                    },\n+                    _ => true\n+                }\n+            }\n+            \"#,\n+            r#\"\n+            fn f() {\n+                let mut t = 'a';\n+                let chars = \"abcd\";\n+                match t {\n+                    '\\r' <|>if chars.clone().next().is_some() => {\n+                        t = 'e';\n+                        false\n+                    },\n+                    _ => true\n+                }\n+            }\n+            \"#,\n+        );\n+    }\n+}"}, {"sha": "a8ca19f5ddf7f343eef41ee959e45eaa67f0eaf0", "filename": "crates/ra_assists/src/move_guard_to_arm_body_and_back.rs", "status": "removed", "additions": 0, "deletions": 115, "changes": 115, "blob_url": "https://github.com/rust-lang/rust/blob/99ad6143cdbd783e969649d9243aaa2e5a8131c4/crates%2Fra_assists%2Fsrc%2Fmove_guard_to_arm_body_and_back.rs", "raw_url": "https://github.com/rust-lang/rust/raw/99ad6143cdbd783e969649d9243aaa2e5a8131c4/crates%2Fra_assists%2Fsrc%2Fmove_guard_to_arm_body_and_back.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_assists%2Fsrc%2Fmove_guard_to_arm_body_and_back.rs?ref=99ad6143cdbd783e969649d9243aaa2e5a8131c4", "patch": "@@ -1,115 +0,0 @@\n-use hir::db::HirDatabase;\n-use ra_syntax::{\n-    TextUnit,\n-    SyntaxElement,\n-    ast::{MatchArm, AstNode, AstToken},\n-    ast,\n-};\n-\n-use crate::{AssistCtx, Assist, AssistId};\n-\n-pub(crate) fn move_guard_to_arm_body(mut ctx: AssistCtx<impl HirDatabase>) -> Option<Assist> {\n-    let match_arm = ctx.node_at_offset::<MatchArm>()?;\n-    let guard = match_arm.guard()?;\n-    let space_before_guard = guard.syntax().prev_sibling_or_token();\n-\n-    let guard_conditions = guard.expr()?;\n-    let arm_expr = match_arm.expr()?;\n-    let buf = format!(\"if {} {{ {} }}\", guard_conditions.syntax().text(), arm_expr.syntax().text());\n-\n-    ctx.add_action(AssistId(\"move_guard_to_arm_body\"), \"move guard to arm body\", |edit| {\n-        edit.target(guard.syntax().range());\n-        let offseting_amount = match space_before_guard {\n-            Some(SyntaxElement::Token(tok)) => {\n-                if let Some(_) = ast::Whitespace::cast(tok) {\n-                    let ele = space_before_guard.unwrap().range();\n-                    edit.delete(ele);\n-                    ele.len()\n-                } else {\n-                    TextUnit::from(0)\n-                }\n-            }\n-            _ => TextUnit::from(0),\n-        };\n-\n-        edit.delete(guard.syntax().range());\n-        edit.replace_node_and_indent(arm_expr.syntax(), buf);\n-        edit.set_cursor(arm_expr.syntax().range().start() + TextUnit::from(3) - offseting_amount);\n-    });\n-    ctx.build()\n-}\n-\n-#[cfg(test)]\n-mod tests {\n-    use super::*;\n-\n-    use crate::helpers::{ check_assist, check_assist_target };\n-\n-    #[test]\n-    fn move_guard_to_arm_body_target() {\n-        check_assist_target(\n-            move_guard_to_arm_body,\n-            r#\"\n-            fn f() {\n-                let t = 'a';\n-                let chars = \"abcd\";\n-                match t {\n-                    '\\r' <|>if chars.clone().next() == Some('\\n') => false,\n-                    _ => true\n-                }\n-            }\n-            \"#,\n-            r#\"if chars.clone().next() == Some('\\n')\"#,\n-        );\n-    }\n-\n-    #[test]\n-    fn move_guard_to_arm_body_works() {\n-        check_assist(\n-            move_guard_to_arm_body,\n-            r#\"\n-            fn f() {\n-                let t = 'a';\n-                let chars = \"abcd\";\n-                match t {\n-                    '\\r' <|>if chars.clone().next() == Some('\\n') => false,\n-                    _ => true\n-                }\n-            }\n-            \"#,\n-            r#\"\n-            fn f() {\n-                let t = 'a';\n-                let chars = \"abcd\";\n-                match t {\n-                    '\\r' => if chars.clone().next() == Some('\\n') { <|>false },\n-                    _ => true\n-                }\n-            }\n-            \"#,\n-        );\n-    }\n-\n-    #[test]\n-    fn move_guard_to_arm_body_works_complex_match() {\n-        check_assist(\n-            move_guard_to_arm_body,\n-            r#\"\n-            fn f() {\n-                match x {\n-                    <|>y @ 4 | y @ 5    if y > 5 => true,\n-                    _ => false\n-                }\n-            }\n-            \"#,\n-            r#\"\n-            fn f() {\n-                match x {\n-                    y @ 4 | y @ 5 => if y > 5 { <|>true },\n-                    _ => false\n-                }\n-            }\n-            \"#,\n-        );\n-    }\n-}"}]}