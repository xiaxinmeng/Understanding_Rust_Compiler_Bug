{"sha": "e5e5a0932dbdfa5de7b6cdae10a76378ff041cf2", "node_id": "C_kwDOAAsO6NoAKGU1ZTVhMDkzMmRiZGZhNWRlN2I2Y2RhZTEwYTc2Mzc4ZmYwNDFjZjI", "commit": {"author": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2022-07-01T13:52:52Z"}, "committer": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2022-07-01T14:25:52Z"}, "message": "Fix blocks not considering stmt without semi as tails", "tree": {"sha": "1cbd2bebdddc748afd1ddcf8ab153effcdfde2f4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1cbd2bebdddc748afd1ddcf8ab153effcdfde2f4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e5e5a0932dbdfa5de7b6cdae10a76378ff041cf2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e5e5a0932dbdfa5de7b6cdae10a76378ff041cf2", "html_url": "https://github.com/rust-lang/rust/commit/e5e5a0932dbdfa5de7b6cdae10a76378ff041cf2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e5e5a0932dbdfa5de7b6cdae10a76378ff041cf2/comments", "author": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "58d5c69a638c278b893212f7b931e1ab09baeaab", "url": "https://api.github.com/repos/rust-lang/rust/commits/58d5c69a638c278b893212f7b931e1ab09baeaab", "html_url": "https://github.com/rust-lang/rust/commit/58d5c69a638c278b893212f7b931e1ab09baeaab"}], "stats": {"total": 51, "additions": 46, "deletions": 5}, "files": [{"sha": "049afa82279d13d671f866c57f0bb0e88b124102", "filename": "crates/hir-def/src/body/lower.rs", "status": "modified", "additions": 16, "deletions": 2, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/e5e5a0932dbdfa5de7b6cdae10a76378ff041cf2/crates%2Fhir-def%2Fsrc%2Fbody%2Flower.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e5e5a0932dbdfa5de7b6cdae10a76378ff041cf2/crates%2Fhir-def%2Fsrc%2Fbody%2Flower.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-def%2Fsrc%2Fbody%2Flower.rs?ref=e5e5a0932dbdfa5de7b6cdae10a76378ff041cf2", "patch": "@@ -690,12 +690,26 @@ impl ExprCollector<'_> {\n         let prev_def_map = mem::replace(&mut self.expander.def_map, def_map);\n         let prev_local_module = mem::replace(&mut self.expander.module, module);\n \n-        let statements = block.statements().filter_map(|s| self.collect_stmt(s)).collect();\n+        let mut statements: Vec<_> =\n+            block.statements().filter_map(|s| self.collect_stmt(s)).collect();\n         let tail = block.tail_expr().and_then(|e| self.maybe_collect_expr(e));\n+        let tail = tail.or_else(|| {\n+            let stmt = statements.pop()?;\n+            if let Statement::Expr { expr, has_semi: false } = stmt {\n+                return Some(expr);\n+            }\n+            statements.push(stmt);\n+            None\n+        });\n \n         let syntax_node_ptr = AstPtr::new(&block.into());\n         let expr_id = self.alloc_expr(\n-            Expr::Block { id: block_id, statements, tail, label: None },\n+            Expr::Block {\n+                id: block_id,\n+                statements: statements.into_boxed_slice(),\n+                tail,\n+                label: None,\n+            },\n             syntax_node_ptr,\n         );\n "}, {"sha": "a4299d9f0500e50406a65ed7443e0fdea96f855f", "filename": "crates/hir-ty/src/tests/macros.rs", "status": "modified", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/e5e5a0932dbdfa5de7b6cdae10a76378ff041cf2/crates%2Fhir-ty%2Fsrc%2Ftests%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e5e5a0932dbdfa5de7b6cdae10a76378ff041cf2/crates%2Fhir-ty%2Fsrc%2Ftests%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-ty%2Fsrc%2Ftests%2Fmacros.rs?ref=e5e5a0932dbdfa5de7b6cdae10a76378ff041cf2", "patch": "@@ -1,6 +1,8 @@\n use expect_test::expect;\n use test_utils::{bench, bench_fixture, skip_slow_tests};\n \n+use crate::tests::check_infer_with_mismatches;\n+\n use super::{check_infer, check_types};\n \n #[test]\n@@ -1247,3 +1249,28 @@ fn infinitely_recursive_macro_type() {\n         \"#]],\n     );\n }\n+\n+#[test]\n+fn cfg_tails() {\n+    check_infer_with_mismatches(\n+        r#\"\n+//- /lib.rs crate:foo cfg:feature=foo\n+struct S {}\n+\n+impl S {\n+    fn new2(bar: u32) -> Self {\n+        #[cfg(feature = \"foo\")]\n+        { Self { } }\n+        #[cfg(not(feature = \"foo\"))]\n+        { Self { } }\n+    }\n+}\n+\"#,\n+        expect![[r#\"\n+            34..37 'bar': u32\n+            52..170 '{     ...     }': S\n+            62..106 '#[cfg(... { } }': S\n+            96..104 'Self { }': S\n+        \"#]],\n+    );\n+}"}, {"sha": "ee0a631a1bc734663f94488294ef5cb03c2959bf", "filename": "crates/hir-ty/src/tests/regression.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/e5e5a0932dbdfa5de7b6cdae10a76378ff041cf2/crates%2Fhir-ty%2Fsrc%2Ftests%2Fregression.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e5e5a0932dbdfa5de7b6cdae10a76378ff041cf2/crates%2Fhir-ty%2Fsrc%2Ftests%2Fregression.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-ty%2Fsrc%2Ftests%2Fregression.rs?ref=e5e5a0932dbdfa5de7b6cdae10a76378ff041cf2", "patch": "@@ -1013,17 +1013,17 @@ fn cfg_tail() {\n         \"#,\n         expect![[r#\"\n             14..53 '{     ...)] 9 }': ()\n-            20..31 '{ \"first\" }': &str\n+            20..31 '{ \"first\" }': ()\n             22..29 '\"first\"': &str\n             72..190 '{     ...] 13 }': ()\n             78..88 '{ \"fake\" }': &str\n             80..86 '\"fake\"': &str\n             93..103 '{ \"fake\" }': &str\n             95..101 '\"fake\"': &str\n-            108..120 '{ \"second\" }': &str\n+            108..120 '{ \"second\" }': ()\n             110..118 '\"second\"': &str\n             210..273 '{     ... 15; }': ()\n-            216..227 '{ \"third\" }': &str\n+            216..227 '{ \"third\" }': ()\n             218..225 '\"third\"': &str\n             293..357 '{     ...] 15 }': ()\n             299..311 '{ \"fourth\" }': &str"}]}