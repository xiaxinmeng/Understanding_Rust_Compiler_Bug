{"sha": "8f06f995c5d4ddd0fb5dc451e482a8b3024fa151", "node_id": "C_kwDOAAsO6NoAKDhmMDZmOTk1YzVkNGRkZDBmYjVkYzQ1MWU0ODJhOGIzMDI0ZmExNTE", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-04-24T10:38:27Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-04-24T10:38:27Z"}, "message": "Auto merge of #14644 - matklad:matklad/diag-adj, r=lnicola\n\nfeat: don't wavy-underline the whole for loop", "tree": {"sha": "086ffd80e61ad59051c756b86473654f6d95593d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/086ffd80e61ad59051c756b86473654f6d95593d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8f06f995c5d4ddd0fb5dc451e482a8b3024fa151", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8f06f995c5d4ddd0fb5dc451e482a8b3024fa151", "html_url": "https://github.com/rust-lang/rust/commit/8f06f995c5d4ddd0fb5dc451e482a8b3024fa151", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8f06f995c5d4ddd0fb5dc451e482a8b3024fa151/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "420a038da9ea6d809c3c97491eb47f61b8afdae9", "url": "https://api.github.com/repos/rust-lang/rust/commits/420a038da9ea6d809c3c97491eb47f61b8afdae9", "html_url": "https://github.com/rust-lang/rust/commit/420a038da9ea6d809c3c97491eb47f61b8afdae9"}, {"sha": "774575106ce2e37c3a9a5e10f038b7d1237ab02b", "url": "https://api.github.com/repos/rust-lang/rust/commits/774575106ce2e37c3a9a5e10f038b7d1237ab02b", "html_url": "https://github.com/rust-lang/rust/commit/774575106ce2e37c3a9a5e10f038b7d1237ab02b"}], "stats": {"total": 35, "additions": 27, "deletions": 8}, "files": [{"sha": "d240ca13e6053860862511b082ae94bc91af77bc", "filename": "crates/ide-diagnostics/src/handlers/type_mismatch.rs", "status": "modified", "additions": 27, "deletions": 8, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/8f06f995c5d4ddd0fb5dc451e482a8b3024fa151/crates%2Fide-diagnostics%2Fsrc%2Fhandlers%2Ftype_mismatch.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8f06f995c5d4ddd0fb5dc451e482a8b3024fa151/crates%2Fide-diagnostics%2Fsrc%2Fhandlers%2Ftype_mismatch.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-diagnostics%2Fsrc%2Fhandlers%2Ftype_mismatch.rs?ref=8f06f995c5d4ddd0fb5dc451e482a8b3024fa151", "patch": "@@ -1,6 +1,7 @@\n use either::Either;\n use hir::{db::ExpandDatabase, ClosureStyle, HirDisplay, InFile, Type};\n use ide_db::{famous_defs::FamousDefs, source_change::SourceChange};\n+use stdx::never;\n use syntax::{\n     ast::{self, BlockExpr, ExprStmt},\n     AstNode, AstPtr,\n@@ -15,15 +16,29 @@ use crate::{adjusted_display_range, fix, Assist, Diagnostic, DiagnosticsContext}\n // the expected type.\n pub(crate) fn type_mismatch(ctx: &DiagnosticsContext<'_>, d: &hir::TypeMismatch) -> Diagnostic {\n     let display_range = match &d.expr_or_pat {\n-        Either::Left(expr) => adjusted_display_range::<ast::BlockExpr>(\n-            ctx,\n-            expr.clone().map(|it| it.into()),\n-            &|block| {\n-                let r_curly_range = block.stmt_list()?.r_curly_token()?.text_range();\n+        Either::Left(expr) => {\n+            adjusted_display_range::<ast::Expr>(ctx, expr.clone().map(|it| it.into()), &|expr| {\n+                if !expr.is_block_like() {\n+                    return None;\n+                }\n+\n+                let salient_token_range = match expr {\n+                    ast::Expr::IfExpr(it) => it.if_token()?.text_range(),\n+                    ast::Expr::LoopExpr(it) => it.loop_token()?.text_range(),\n+                    ast::Expr::ForExpr(it) => it.for_token()?.text_range(),\n+                    ast::Expr::WhileExpr(it) => it.while_token()?.text_range(),\n+                    ast::Expr::BlockExpr(it) => it.stmt_list()?.r_curly_token()?.text_range(),\n+                    ast::Expr::MatchExpr(it) => it.match_token()?.text_range(),\n+                    _ => {\n+                        never!();\n+                        return None;\n+                    }\n+                };\n+\n                 cov_mark::hit!(type_mismatch_on_block);\n-                Some(r_curly_range)\n-            },\n-        ),\n+                Some(salient_token_range)\n+            })\n+        }\n         Either::Right(pat) => {\n             ctx.sema.diagnostics_display_range(pat.clone().map(|it| it.into())).range\n         }\n@@ -620,6 +635,10 @@ fn f() -> i32 {\n     let _ = x + y;\n   }\n //^ error: expected i32, found ()\n+\n+fn h() -> i32 {\n+    while true {}\n+} //^^^^^ error: expected i32, found ()\n \"#,\n         );\n     }"}]}