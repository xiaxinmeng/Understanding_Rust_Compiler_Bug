{"sha": "9d26a25bb627e8cee8476331cf25212a5aacebd1", "node_id": "MDY6Q29tbWl0NzI0NzEyOjlkMjZhMjViYjYyN2U4Y2VlODQ3NjMzMWNmMjUyMTJhNWFhY2ViZDE=", "commit": {"author": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2018-01-23T09:03:42Z"}, "committer": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2018-01-23T14:30:57Z"}, "message": "Rollup merge of #47635 - Zoxc:remove-attr, r=michaelwoerister\n\nRemove the IGNORED_ATTR_NAMES thread local", "tree": {"sha": "7303dc3425ac6686fb68f9cf614f641568feda76", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7303dc3425ac6686fb68f9cf614f641568feda76"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9d26a25bb627e8cee8476331cf25212a5aacebd1", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEZ1R8CLMp8f2GxWoQ/vbIBR0OATwFAlpnRyEACgkQ/vbIBR0O\nATyG5xAAueMoJkRbGsiebL8zp/Q5xPgtdpB5CYOWhmYrFV6KMVA4V0ICADTzgpPV\ngFh4WPFHZTC0oA930gBWJail1hCEfsL/p1+ANs3IBDFo/t0pa1nQL2QDi1G/vfkQ\n20ZNXyKALPmdIkeNLbWfVqnveBJFelzXx7lDkj/q+pdXfsIW9JB+ZdrKh/LVvTFB\nmhdT7tKuqCtZSeJnk0oyjbPfrLnu+9mdfYuLLj7r9W9peV7pglqL2DFE2D/rTKVK\nXdW/FKAIGhL52L10hp99pLeGqMEyke9uPPOHXJ/x/CQkqSNvoXdA/M4EFzvaXA7g\nWbh0vRyp4qHWo24S7OAbFUXSvC9fTYHcMRdMIaL3PwLCd6/LxSO7qr3ngWVvvBeW\nvLzcD5DLefVwUWjF125pRm+4+dbIv9Rof957DZGu8cjOh6EoKfSp4MlE/dJ3qNDO\nLAWo+urLVGjxX/lbJ2kv6Wj115ajf1irybqBUY+7EN3AElM7oNGT7Tagz8xju7Eb\nf6OAYYyEi1B1w9Jlz++U4wUlzLNjWPGEQ01wgwJ8jNXONyEb0GKKH8K4923PuYee\nb++O5TBirty2f3tNMRRs9EfiLwNgvIYmoGNtSthF5IghtFu3vnMLdjIrNxixtjF1\nsDvLC56b6dSzojVLzSlm98D+ODlj19EbB2vTkfQvLud/5EdPi28=\n=RZMy\n-----END PGP SIGNATURE-----", "payload": "tree 7303dc3425ac6686fb68f9cf614f641568feda76\nparent cb0a8bf7d157d91db9be5b628c1b43e14f5b5d7c\nparent 643e71e2e125a1859793f729bdb2149bc0e6b23c\nauthor kennytm <kennytm@gmail.com> 1516698222 +0800\ncommitter kennytm <kennytm@gmail.com> 1516717857 +0800\n\nRollup merge of #47635 - Zoxc:remove-attr, r=michaelwoerister\n\nRemove the IGNORED_ATTR_NAMES thread local\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9d26a25bb627e8cee8476331cf25212a5aacebd1", "html_url": "https://github.com/rust-lang/rust/commit/9d26a25bb627e8cee8476331cf25212a5aacebd1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9d26a25bb627e8cee8476331cf25212a5aacebd1/comments", "author": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cb0a8bf7d157d91db9be5b628c1b43e14f5b5d7c", "url": "https://api.github.com/repos/rust-lang/rust/commits/cb0a8bf7d157d91db9be5b628c1b43e14f5b5d7c", "html_url": "https://github.com/rust-lang/rust/commit/cb0a8bf7d157d91db9be5b628c1b43e14f5b5d7c"}, {"sha": "643e71e2e125a1859793f729bdb2149bc0e6b23c", "url": "https://api.github.com/repos/rust-lang/rust/commits/643e71e2e125a1859793f729bdb2149bc0e6b23c", "html_url": "https://github.com/rust-lang/rust/commit/643e71e2e125a1859793f729bdb2149bc0e6b23c"}], "stats": {"total": 29, "additions": 13, "deletions": 16}, "files": [{"sha": "67f6c0c2e49e88dda4be510bb45b63ad9e5e3caf", "filename": "src/librustc/ich/hcx.rs", "status": "modified", "additions": 6, "deletions": 15, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/9d26a25bb627e8cee8476331cf25212a5aacebd1/src%2Flibrustc%2Fich%2Fhcx.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9d26a25bb627e8cee8476331cf25212a5aacebd1/src%2Flibrustc%2Fich%2Fhcx.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fich%2Fhcx.rs?ref=9d26a25bb627e8cee8476331cf25212a5aacebd1", "patch": "@@ -19,8 +19,8 @@ use session::Session;\n \n use std::cmp::Ord;\n use std::hash as std_hash;\n-use std::cell::RefCell;\n use std::collections::HashMap;\n+use std::cell::RefCell;\n \n use syntax::ast;\n \n@@ -36,8 +36,10 @@ use rustc_data_structures::stable_hasher::{HashStable, StableHashingContextProvi\n use rustc_data_structures::accumulate_vec::AccumulateVec;\n use rustc_data_structures::fx::{FxHashSet, FxHashMap};\n \n-thread_local!(static IGNORED_ATTR_NAMES: RefCell<FxHashSet<Symbol>> =\n-    RefCell::new(FxHashSet()));\n+pub fn compute_ignored_attr_names() -> FxHashSet<Symbol> {\n+    debug_assert!(ich::IGNORED_ATTRIBUTES.len() > 0);\n+    ich::IGNORED_ATTRIBUTES.iter().map(|&s| Symbol::intern(s)).collect()\n+}\n \n /// This is the context state available during incr. comp. hashing. It contains\n /// enough information to transform DefIds and HirIds into stable DefPaths (i.e.\n@@ -90,15 +92,6 @@ impl<'gcx> StableHashingContext<'gcx> {\n                -> Self {\n         let hash_spans_initial = !sess.opts.debugging_opts.incremental_ignore_spans;\n \n-        debug_assert!(ich::IGNORED_ATTRIBUTES.len() > 0);\n-        IGNORED_ATTR_NAMES.with(|names| {\n-            let mut names = names.borrow_mut();\n-            if names.is_empty() {\n-                names.extend(ich::IGNORED_ATTRIBUTES.iter()\n-                                                    .map(|&s| Symbol::intern(s)));\n-            }\n-        });\n-\n         StableHashingContext {\n             sess,\n             body_resolver: BodyResolver(krate),\n@@ -186,9 +179,7 @@ impl<'gcx> StableHashingContext<'gcx> {\n \n     #[inline]\n     pub fn is_ignored_attr(&self, name: Symbol) -> bool {\n-        IGNORED_ATTR_NAMES.with(|names| {\n-            names.borrow().contains(&name)\n-        })\n+        self.sess.ignored_attr_names.contains(&name)\n     }\n \n     pub fn hash_hir_item_like<F: FnOnce(&mut Self)>(&mut self, f: F) {"}, {"sha": "ce1bd07b14ce0b7a139a41d7df0b0212f50fb306", "filename": "src/librustc/ich/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/9d26a25bb627e8cee8476331cf25212a5aacebd1/src%2Flibrustc%2Fich%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9d26a25bb627e8cee8476331cf25212a5aacebd1/src%2Flibrustc%2Fich%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fich%2Fmod.rs?ref=9d26a25bb627e8cee8476331cf25212a5aacebd1", "patch": "@@ -13,7 +13,7 @@\n pub use self::fingerprint::Fingerprint;\n pub use self::caching_codemap_view::CachingCodemapView;\n pub use self::hcx::{StableHashingContext, NodeIdHashingMode,\n-                    hash_stable_trait_impls};\n+                    hash_stable_trait_impls, compute_ignored_attr_names};\n mod fingerprint;\n mod caching_codemap_view;\n mod hcx;"}, {"sha": "36f716a4a76942c8e85364c640f18bb68ff95440", "filename": "src/librustc/session/mod.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/9d26a25bb627e8cee8476331cf25212a5aacebd1/src%2Flibrustc%2Fsession%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9d26a25bb627e8cee8476331cf25212a5aacebd1/src%2Flibrustc%2Fsession%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fsession%2Fmod.rs?ref=9d26a25bb627e8cee8476331cf25212a5aacebd1", "patch": "@@ -14,6 +14,7 @@ pub use self::code_stats::{SizeKind, TypeSizeInfo, VariantInfo};\n use hir::def_id::CrateNum;\n use ich::Fingerprint;\n \n+use ich;\n use lint;\n use middle::allocator::AllocatorKind;\n use middle::dependency_format;\n@@ -28,6 +29,7 @@ use errors::{self, DiagnosticBuilder, DiagnosticId};\n use errors::emitter::{Emitter, EmitterWriter};\n use syntax::json::JsonEmitter;\n use syntax::feature_gate;\n+use syntax::symbol::Symbol;\n use syntax::parse;\n use syntax::parse::ParseSess;\n use syntax::{ast, codemap};\n@@ -112,6 +114,9 @@ pub struct Session {\n \n     incr_comp_session: RefCell<IncrCompSession>,\n \n+    /// A cache of attributes ignored by StableHashingContext\n+    pub ignored_attr_names: FxHashSet<Symbol>,\n+\n     /// Some measurements that are being gathered during compilation.\n     pub perf_stats: PerfStats,\n \n@@ -975,6 +980,7 @@ pub fn build_session_(sopts: config::Options,\n         injected_panic_runtime: Cell::new(None),\n         imported_macro_spans: RefCell::new(HashMap::new()),\n         incr_comp_session: RefCell::new(IncrCompSession::NotInitialized),\n+        ignored_attr_names: ich::compute_ignored_attr_names(),\n         perf_stats: PerfStats {\n             svh_time: Cell::new(Duration::from_secs(0)),\n             incr_comp_hashes_time: Cell::new(Duration::from_secs(0)),"}]}