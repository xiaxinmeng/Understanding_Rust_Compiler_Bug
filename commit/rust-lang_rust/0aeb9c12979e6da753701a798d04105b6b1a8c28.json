{"sha": "0aeb9c12979e6da753701a798d04105b6b1a8c28", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBhZWI5YzEyOTc5ZTZkYTc1MzcwMWE3OThkMDQxMDViNmIxYThjMjg=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-03-15T13:50:13Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-03-15T13:50:13Z"}, "message": "Auto merge of #40383 - ishitatsuyuki:easy-dist-analysis, r=alexcrichton\n\nrustbuild: Make save-analysis an option\n\nThis makes save-analysis an option independent from the release channel.\n\nThe CI build scripts have been modified to enable the flag.\n\n*Merge with caution.* I haven't tested this, and this can cause nightly breakage.", "tree": {"sha": "847107cd73b51517d22d90ebdfedadc701f2a291", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/847107cd73b51517d22d90ebdfedadc701f2a291"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0aeb9c12979e6da753701a798d04105b6b1a8c28", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0aeb9c12979e6da753701a798d04105b6b1a8c28", "html_url": "https://github.com/rust-lang/rust/commit/0aeb9c12979e6da753701a798d04105b6b1a8c28", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0aeb9c12979e6da753701a798d04105b6b1a8c28/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "11a33760ecfd925be089a28c54f12a5490fd9a2f", "url": "https://api.github.com/repos/rust-lang/rust/commits/11a33760ecfd925be089a28c54f12a5490fd9a2f", "html_url": "https://github.com/rust-lang/rust/commit/11a33760ecfd925be089a28c54f12a5490fd9a2f"}, {"sha": "d4040c3a3fa9cc416f2f997b52946d6cd6b17e48", "url": "https://api.github.com/repos/rust-lang/rust/commits/d4040c3a3fa9cc416f2f997b52946d6cd6b17e48", "html_url": "https://github.com/rust-lang/rust/commit/d4040c3a3fa9cc416f2f997b52946d6cd6b17e48"}], "stats": {"total": 29, "additions": 19, "deletions": 10}, "files": [{"sha": "d6dded6dc5f7bccfbeb0d57a48f394d7b326f1f7", "filename": "configure", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/0aeb9c12979e6da753701a798d04105b6b1a8c28/configure", "raw_url": "https://github.com/rust-lang/rust/raw/0aeb9c12979e6da753701a798d04105b6b1a8c28/configure", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/configure?ref=0aeb9c12979e6da753701a798d04105b6b1a8c28", "patch": "@@ -445,6 +445,7 @@ opt dist-host-only 0 \"only install bins for the host architecture\"\n opt inject-std-version 1 \"inject the current compiler version of libstd into programs\"\n opt llvm-version-check 1 \"check if the LLVM version is supported, build anyway\"\n opt codegen-tests 1 \"run the src/test/codegen tests\"\n+opt save-analysis 0 \"save API analysis data\"\n opt option-checking 1 \"complain about unrecognized options in this configure script\"\n opt ninja 0 \"build LLVM using the Ninja generator (for MSVC, requires building in the correct environment)\"\n opt locked-deps 0 \"force Cargo.lock to be up to date\""}, {"sha": "b1d1d79b9eaa3c58d4e8b4f5575f45c054a275aa", "filename": "src/bootstrap/config.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/0aeb9c12979e6da753701a798d04105b6b1a8c28/src%2Fbootstrap%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0aeb9c12979e6da753701a798d04105b6b1a8c28/src%2Fbootstrap%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fconfig.rs?ref=0aeb9c12979e6da753701a798d04105b6b1a8c28", "patch": "@@ -74,6 +74,7 @@ pub struct Config {\n     pub rustc_default_ar: Option<String>,\n     pub rust_optimize_tests: bool,\n     pub rust_debuginfo_tests: bool,\n+    pub rust_save_analysis: bool,\n     pub rust_dist_src: bool,\n \n     pub build: String,\n@@ -225,6 +226,7 @@ struct Rust {\n     optimize_tests: Option<bool>,\n     debuginfo_tests: Option<bool>,\n     codegen_tests: Option<bool>,\n+    save_analysis: Option<bool>,\n }\n \n /// TOML representation of how each build target is configured.\n@@ -350,6 +352,7 @@ impl Config {\n             set(&mut config.rust_optimize_tests, rust.optimize_tests);\n             set(&mut config.rust_debuginfo_tests, rust.debuginfo_tests);\n             set(&mut config.codegen_tests, rust.codegen_tests);\n+            set(&mut config.rust_save_analysis, rust.save_analysis);\n             set(&mut config.rust_rpath, rust.rpath);\n             set(&mut config.debug_jemalloc, rust.debug_jemalloc);\n             set(&mut config.use_jemalloc, rust.use_jemalloc);\n@@ -457,6 +460,7 @@ impl Config {\n                 (\"LOCAL_REBUILD\", self.local_rebuild),\n                 (\"NINJA\", self.ninja),\n                 (\"CODEGEN_TESTS\", self.codegen_tests),\n+                (\"SAVE_ANALYSIS\", self.rust_save_analysis),\n                 (\"LOCKED_DEPS\", self.locked_deps),\n                 (\"VENDOR\", self.vendor),\n                 (\"FULL_BOOTSTRAP\", self.full_bootstrap),"}, {"sha": "76fedae0f03ebb6189b0ab2695b0db1c7a948f16", "filename": "src/bootstrap/config.toml.example", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/0aeb9c12979e6da753701a798d04105b6b1a8c28/src%2Fbootstrap%2Fconfig.toml.example", "raw_url": "https://github.com/rust-lang/rust/raw/0aeb9c12979e6da753701a798d04105b6b1a8c28/src%2Fbootstrap%2Fconfig.toml.example", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fconfig.toml.example?ref=0aeb9c12979e6da753701a798d04105b6b1a8c28", "patch": "@@ -234,6 +234,9 @@\n # saying that the FileCheck executable is missing, you may want to disable this.\n #codegen-tests = true\n \n+# Flag indicating whether the API analysis data should be saved.\n+#save-analysis = false\n+\n # =============================================================================\n # Options for specific targets\n #"}, {"sha": "289c1e1c3a99c5053883ee4eb42c900a7f511858", "filename": "src/bootstrap/dist.rs", "status": "modified", "additions": 5, "deletions": 9, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/0aeb9c12979e6da753701a798d04105b6b1a8c28/src%2Fbootstrap%2Fdist.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0aeb9c12979e6da753701a798d04105b6b1a8c28/src%2Fbootstrap%2Fdist.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fdist.rs?ref=0aeb9c12979e6da753701a798d04105b6b1a8c28", "patch": "@@ -311,18 +311,14 @@ pub fn rust_src_location(build: &Build) -> PathBuf {\n \n /// Creates a tarball of save-analysis metadata, if available.\n pub fn analysis(build: &Build, compiler: &Compiler, target: &str) {\n+    if !build.config.rust_save_analysis {\n+        return\n+    }\n+\n     println!(\"Dist analysis\");\n \n-    if build.config.channel != \"nightly\" {\n-        println!(\"\\tskipping - not on nightly channel\");\n-        return;\n-    }\n     if compiler.host != build.config.build {\n-        println!(\"\\tskipping - not a build host\");\n-        return\n-    }\n-    if compiler.stage != 2 {\n-        println!(\"\\tskipping - not stage2\");\n+        println!(\"\\tskipping, not a build host\");\n         return\n     }\n "}, {"sha": "249f241a151bbd446dc3fc5c92661b954ceba9e2", "filename": "src/bootstrap/install.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/0aeb9c12979e6da753701a798d04105b6b1a8c28/src%2Fbootstrap%2Finstall.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0aeb9c12979e6da753701a798d04105b6b1a8c28/src%2Fbootstrap%2Finstall.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Finstall.rs?ref=0aeb9c12979e6da753701a798d04105b6b1a8c28", "patch": "@@ -49,6 +49,10 @@ pub fn install(build: &Build, stage: u32, host: &str) {\n         install_sh(&build, \"docs\", \"rust-docs\", stage, host, &prefix,\n                    &docdir, &libdir, &mandir, &empty_dir);\n     }\n+    if build.config.rust_save_analysis {\n+        install_sh(&build, \"analysis\", \"rust-analysis\", stage, host, &prefix,\n+                   &docdir, &libdir, &mandir, &empty_dir);\n+    }\n     install_sh(&build, \"std\", \"rust-std\", stage, host, &prefix,\n                &docdir, &libdir, &mandir, &empty_dir);\n     install_sh(&build, \"rustc\", \"rustc\", stage, host, &prefix,"}, {"sha": "2d2be531e628c5b075fb15a71479f8ba50c08d6b", "filename": "src/bootstrap/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0aeb9c12979e6da753701a798d04105b6b1a8c28/src%2Fbootstrap%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0aeb9c12979e6da753701a798d04105b6b1a8c28/src%2Fbootstrap%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Flib.rs?ref=0aeb9c12979e6da753701a798d04105b6b1a8c28", "patch": "@@ -524,7 +524,7 @@ impl Build {\n                  .env(format!(\"CFLAGS_{}\", target), self.cflags(target).join(\" \"));\n         }\n \n-        if self.config.channel == \"nightly\" && compiler.is_final_stage(self) {\n+        if self.config.rust_save_analysis && compiler.is_final_stage(self) {\n             cargo.env(\"RUSTC_SAVE_ANALYSIS\", \"api\".to_string());\n         }\n "}, {"sha": "d8b317a46c31e7f8653fbff7108a18ba5ec53529", "filename": "src/ci/run.sh", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/0aeb9c12979e6da753701a798d04105b6b1a8c28/src%2Fci%2Frun.sh", "raw_url": "https://github.com/rust-lang/rust/raw/0aeb9c12979e6da753701a798d04105b6b1a8c28/src%2Fci%2Frun.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Frun.sh?ref=0aeb9c12979e6da753701a798d04105b6b1a8c28", "patch": "@@ -43,6 +43,7 @@ fi\n if [ \"$DEPLOY$DEPLOY_ALT\" != \"\" ]; then\n   RUST_CONFIGURE_ARGS=\"$RUST_CONFIGURE_ARGS --release-channel=nightly\"\n   RUST_CONFIGURE_ARGS=\"$RUST_CONFIGURE_ARGS --enable-llvm-static-stdcpp\"\n+  RUST_CONFIGURE_ARGS=\"$RUST_CONFIGURE_ARGS --enable-save-analysis\"\n \n   if [ \"$NO_LLVM_ASSERTIONS\" = \"1\" ]; then\n     RUST_CONFIGURE_ARGS=\"$RUST_CONFIGURE_ARGS --disable-llvm-assertions\""}]}