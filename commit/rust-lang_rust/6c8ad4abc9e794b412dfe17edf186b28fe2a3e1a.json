{"sha": "6c8ad4abc9e794b412dfe17edf186b28fe2a3e1a", "node_id": "C_kwDOAAsO6NoAKDZjOGFkNGFiYzllNzk0YjQxMmRmZTE3ZWRmMTg2YjI4ZmUyYTNlMWE", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2022-07-06T01:11:48Z"}, "committer": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2022-07-06T01:21:02Z"}, "message": "fix comparing wide raw pointers", "tree": {"sha": "fa39e9414ac55ffcb8563b23cda8ae0dfe1d330d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fa39e9414ac55ffcb8563b23cda8ae0dfe1d330d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6c8ad4abc9e794b412dfe17edf186b28fe2a3e1a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6c8ad4abc9e794b412dfe17edf186b28fe2a3e1a", "html_url": "https://github.com/rust-lang/rust/commit/6c8ad4abc9e794b412dfe17edf186b28fe2a3e1a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6c8ad4abc9e794b412dfe17edf186b28fe2a3e1a/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1118d94bdfb0275ed1fa8a498bb2f3ea1ed60c3b", "url": "https://api.github.com/repos/rust-lang/rust/commits/1118d94bdfb0275ed1fa8a498bb2f3ea1ed60c3b", "html_url": "https://github.com/rust-lang/rust/commit/1118d94bdfb0275ed1fa8a498bb2f3ea1ed60c3b"}], "stats": {"total": 41, "additions": 38, "deletions": 3}, "files": [{"sha": "33c97e7d31098ed8e67ec2a724864400caa361c2", "filename": "src/operator.rs", "status": "modified", "additions": 13, "deletions": 3, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/6c8ad4abc9e794b412dfe17edf186b28fe2a3e1a/src%2Foperator.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6c8ad4abc9e794b412dfe17edf186b28fe2a3e1a/src%2Foperator.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Foperator.rs?ref=6c8ad4abc9e794b412dfe17edf186b28fe2a3e1a", "patch": "@@ -44,9 +44,19 @@ impl<'mir, 'tcx> EvalContextExt<'tcx> for super::MiriEvalContext<'mir, 'tcx> {\n             }\n \n             Lt | Le | Gt | Ge => {\n-                // Just compare the integers.\n-                let left = left.to_scalar()?.to_bits(left.layout.size)?;\n-                let right = right.to_scalar()?.to_bits(right.layout.size)?;\n+                let size = self.pointer_size();\n+                // Just compare the bits. ScalarPairs are compared lexicographically.\n+                // We thus always compare pairs and simply fill scalars up with 0.\n+                let left = match **left {\n+                    Immediate::Scalar(l) => (l.check_init()?.to_bits(size)?, 0),\n+                    Immediate::ScalarPair(l1, l2) =>\n+                        (l1.check_init()?.to_bits(size)?, l2.check_init()?.to_bits(size)?),\n+                };\n+                let right = match **right {\n+                    Immediate::Scalar(r) => (r.check_init()?.to_bits(size)?, 0),\n+                    Immediate::ScalarPair(r1, r2) =>\n+                        (r1.check_init()?.to_bits(size)?, r2.check_init()?.to_bits(size)?),\n+                };\n                 let res = match bin_op {\n                     Lt => left < right,\n                     Le => left <= right,"}, {"sha": "a0c20af426973a143f6bba381f7f776b20e1870f", "filename": "tests/pass/pointers.rs", "status": "modified", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/6c8ad4abc9e794b412dfe17edf186b28fe2a3e1a/tests%2Fpass%2Fpointers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6c8ad4abc9e794b412dfe17edf186b28fe2a3e1a/tests%2Fpass%2Fpointers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fpass%2Fpointers.rs?ref=6c8ad4abc9e794b412dfe17edf186b28fe2a3e1a", "patch": "@@ -1,3 +1,5 @@\n+use std::mem::transmute;\n+\n fn one_line_ref() -> i16 {\n     *&1\n }\n@@ -48,6 +50,27 @@ fn dangling_pointer() -> *const i32 {\n     &b.0 as *const i32\n }\n \n+fn wide_ptr_ops() {\n+    let a: *const dyn Send = &1 as &dyn Send;\n+    let b: *const dyn Send = &1 as &dyn Send;\n+    let _val = a == b;\n+    let _val = a != b;\n+    let _val = a < b;\n+    let _val = a <= b;\n+    let _val = a > b;\n+    let _val = a >= b;\n+\n+    let a: *const [u8] = unsafe { transmute((1usize, 1usize)) };\n+    let b: *const [u8] = unsafe { transmute((1usize, 2usize)) };\n+    // confirmed with rustc.\n+    assert!(!(a == b));\n+    assert!(a != b);\n+    assert!(a <= b);\n+    assert!(a < b);\n+    assert!(!(a >= b));\n+    assert!(!(a > b));\n+}\n+\n fn main() {\n     assert_eq!(one_line_ref(), 1);\n     assert_eq!(basic_ref(), 1);\n@@ -91,4 +114,6 @@ fn main() {\n     assert!(dangling > 2);\n     assert!(dangling > 3);\n     assert!(dangling >= 4);\n+\n+    wide_ptr_ops();\n }"}]}