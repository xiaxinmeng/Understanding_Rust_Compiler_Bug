{"sha": "734b924d05a18194048381505960066a2a0a91f1", "node_id": "C_kwDOAAsO6NoAKDczNGI5MjRkMDVhMTgxOTQwNDgzODE1MDU5NjAwNjZhMmEwYTkxZjE", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-02-26T06:52:42Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-02-26T06:52:42Z"}, "message": "Rollup merge of #94087 - tmiasko:rm-ignore-borrow-on-drop, r=jackh726\n\nRemove unused `unsound_ignore_borrow_on_drop`", "tree": {"sha": "1bcd3a067166bd510282ac221db8049f20024a01", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1bcd3a067166bd510282ac221db8049f20024a01"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/734b924d05a18194048381505960066a2a0a91f1", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJiGc46CRBK7hj4Ov3rIwAACXEIAKLu2RI/YBe0vgjU7169HXaf\nDff2pd34tTBaOmAgmdloRPlphpxn27r7k0cn25XWcCHiOU4hXYUfd1jQicJumL2v\nFmHZ+LD7X0THpLCo/FuJZD21OCFrF7nmXN+4z6u2CNJVPWLTEf92heYVc6aA+f7H\nFApkomd5d7K1mODvv+QRHGcIpt9l+ErrkCByq3VnrbWSG52ZxeK4ibjDfA5sUG61\nUG2uVHfxFCD9qnUcnj09+dgRzPg46NwU5TCpngWF/cORizfE6Hift9kUNcbYFbMZ\nOwQxxSPt1NCmxQPeWeF/y14GM2s8UOYSnLs7TrleuXO99W/Xc0sUxfbrw8lkSBg=\n=mft9\n-----END PGP SIGNATURE-----\n", "payload": "tree 1bcd3a067166bd510282ac221db8049f20024a01\nparent 5dcee689d179477175eda68502764afce6ba9caa\nparent 06ac05af1156d8a5822064035171a4ee1b06b95b\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1645858362 +0100\ncommitter GitHub <noreply@github.com> 1645858362 +0100\n\nRollup merge of #94087 - tmiasko:rm-ignore-borrow-on-drop, r=jackh726\n\nRemove unused `unsound_ignore_borrow_on_drop`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/734b924d05a18194048381505960066a2a0a91f1", "html_url": "https://github.com/rust-lang/rust/commit/734b924d05a18194048381505960066a2a0a91f1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/734b924d05a18194048381505960066a2a0a91f1/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5dcee689d179477175eda68502764afce6ba9caa", "url": "https://api.github.com/repos/rust-lang/rust/commits/5dcee689d179477175eda68502764afce6ba9caa", "html_url": "https://github.com/rust-lang/rust/commit/5dcee689d179477175eda68502764afce6ba9caa"}, {"sha": "06ac05af1156d8a5822064035171a4ee1b06b95b", "url": "https://api.github.com/repos/rust-lang/rust/commits/06ac05af1156d8a5822064035171a4ee1b06b95b", "html_url": "https://github.com/rust-lang/rust/commit/06ac05af1156d8a5822064035171a4ee1b06b95b"}], "stats": {"total": 51, "additions": 13, "deletions": 38}, "files": [{"sha": "4981ab5152cd766f8ba7e7ace6c49b7cd8ee288d", "filename": "compiler/rustc_mir_dataflow/src/impls/borrowed_locals.rs", "status": "modified", "additions": 11, "deletions": 34, "changes": 45, "blob_url": "https://github.com/rust-lang/rust/blob/734b924d05a18194048381505960066a2a0a91f1/compiler%2Frustc_mir_dataflow%2Fsrc%2Fimpls%2Fborrowed_locals.rs", "raw_url": "https://github.com/rust-lang/rust/raw/734b924d05a18194048381505960066a2a0a91f1/compiler%2Frustc_mir_dataflow%2Fsrc%2Fimpls%2Fborrowed_locals.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_dataflow%2Fsrc%2Fimpls%2Fborrowed_locals.rs?ref=734b924d05a18194048381505960066a2a0a91f1", "patch": "@@ -10,38 +10,11 @@ use rustc_middle::mir::*;\n /// At present, this is used as a very limited form of alias analysis. For example,\n /// `MaybeBorrowedLocals` is used to compute which locals are live during a yield expression for\n /// immovable generators.\n-pub struct MaybeBorrowedLocals {\n-    ignore_borrow_on_drop: bool,\n-}\n-\n-impl MaybeBorrowedLocals {\n-    /// A dataflow analysis that records whether a pointer or reference exists that may alias the\n-    /// given local.\n-    pub fn all_borrows() -> Self {\n-        MaybeBorrowedLocals { ignore_borrow_on_drop: false }\n-    }\n-}\n+pub struct MaybeBorrowedLocals;\n \n impl MaybeBorrowedLocals {\n-    /// During dataflow analysis, ignore the borrow that may occur when a place is dropped.\n-    ///\n-    /// Drop terminators may call custom drop glue (`Drop::drop`), which takes `&mut self` as a\n-    /// parameter. In the general case, a drop impl could launder that reference into the\n-    /// surrounding environment through a raw pointer, thus creating a valid `*mut` pointing to the\n-    /// dropped local. We are not yet willing to declare this particular case UB, so we must treat\n-    /// all dropped locals as mutably borrowed for now. See discussion on [#61069].\n-    ///\n-    /// In some contexts, we know that this borrow will never occur. For example, during\n-    /// const-eval, custom drop glue cannot be run. Code that calls this should document the\n-    /// assumptions that justify ignoring `Drop` terminators in this way.\n-    ///\n-    /// [#61069]: https://github.com/rust-lang/rust/pull/61069\n-    pub fn unsound_ignore_borrow_on_drop(self) -> Self {\n-        MaybeBorrowedLocals { ignore_borrow_on_drop: true, ..self }\n-    }\n-\n     fn transfer_function<'a, T>(&'a self, trans: &'a mut T) -> TransferFunction<'a, T> {\n-        TransferFunction { trans, ignore_borrow_on_drop: self.ignore_borrow_on_drop }\n+        TransferFunction { trans }\n     }\n }\n \n@@ -92,7 +65,6 @@ impl<'tcx> GenKillAnalysis<'tcx> for MaybeBorrowedLocals {\n /// A `Visitor` that defines the transfer function for `MaybeBorrowedLocals`.\n struct TransferFunction<'a, T> {\n     trans: &'a mut T,\n-    ignore_borrow_on_drop: bool,\n }\n \n impl<'tcx, T> Visitor<'tcx> for TransferFunction<'_, T>\n@@ -146,10 +118,15 @@ where\n         match terminator.kind {\n             mir::TerminatorKind::Drop { place: dropped_place, .. }\n             | mir::TerminatorKind::DropAndReplace { place: dropped_place, .. } => {\n-                // See documentation for `unsound_ignore_borrow_on_drop` for an explanation.\n-                if !self.ignore_borrow_on_drop {\n-                    self.trans.gen(dropped_place.local);\n-                }\n+                // Drop terminators may call custom drop glue (`Drop::drop`), which takes `&mut\n+                // self` as a parameter. In the general case, a drop impl could launder that\n+                // reference into the surrounding environment through a raw pointer, thus creating\n+                // a valid `*mut` pointing to the dropped local. We are not yet willing to declare\n+                // this particular case UB, so we must treat all dropped locals as mutably borrowed\n+                // for now. See discussion on [#61069].\n+                //\n+                // [#61069]: https://github.com/rust-lang/rust/pull/61069\n+                self.trans.gen(dropped_place.local);\n             }\n \n             TerminatorKind::Abort"}, {"sha": "d9a66cace52e5bd4013afd1d0fd67480b29b781f", "filename": "compiler/rustc_mir_transform/src/generator.rs", "status": "modified", "additions": 2, "deletions": 4, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/734b924d05a18194048381505960066a2a0a91f1/compiler%2Frustc_mir_transform%2Fsrc%2Fgenerator.rs", "raw_url": "https://github.com/rust-lang/rust/raw/734b924d05a18194048381505960066a2a0a91f1/compiler%2Frustc_mir_transform%2Fsrc%2Fgenerator.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_transform%2Fsrc%2Fgenerator.rs?ref=734b924d05a18194048381505960066a2a0a91f1", "patch": "@@ -463,10 +463,8 @@ fn locals_live_across_suspend_points<'tcx>(\n \n     // Calculate the MIR locals which have been previously\n     // borrowed (even if they are still active).\n-    let borrowed_locals_results = MaybeBorrowedLocals::all_borrows()\n-        .into_engine(tcx, body_ref)\n-        .pass_name(\"generator\")\n-        .iterate_to_fixpoint();\n+    let borrowed_locals_results =\n+        MaybeBorrowedLocals.into_engine(tcx, body_ref).pass_name(\"generator\").iterate_to_fixpoint();\n \n     let mut borrowed_locals_cursor =\n         rustc_mir_dataflow::ResultsCursor::new(body_ref, &borrowed_locals_results);"}]}