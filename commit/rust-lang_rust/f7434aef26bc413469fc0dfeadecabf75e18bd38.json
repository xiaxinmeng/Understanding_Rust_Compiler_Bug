{"sha": "f7434aef26bc413469fc0dfeadecabf75e18bd38", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY3NDM0YWVmMjZiYzQxMzQ2OWZjMGRmZWFkZWNhYmY3NWUxOGJkMzg=", "commit": {"author": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2019-09-01T11:54:57Z"}, "committer": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2019-09-07T18:37:51Z"}, "message": "Support \"soft\" feature-gating using a lint\n\nUse it for feature-gating `#[bench]`", "tree": {"sha": "3cac9e58eec901a58254d7b842e811d2fa06edac", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3cac9e58eec901a58254d7b842e811d2fa06edac"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f7434aef26bc413469fc0dfeadecabf75e18bd38", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f7434aef26bc413469fc0dfeadecabf75e18bd38", "html_url": "https://github.com/rust-lang/rust/commit/f7434aef26bc413469fc0dfeadecabf75e18bd38", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f7434aef26bc413469fc0dfeadecabf75e18bd38/comments", "author": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "committer": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ef54f57c5b9d894a38179d09b00610c1b337b086", "url": "https://api.github.com/repos/rust-lang/rust/commits/ef54f57c5b9d894a38179d09b00610c1b337b086", "html_url": "https://github.com/rust-lang/rust/commit/ef54f57c5b9d894a38179d09b00610c1b337b086"}], "stats": {"total": 85, "additions": 58, "deletions": 27}, "files": [{"sha": "384bc87499887ad84542a5fd8573e3722b393ff0", "filename": "src/libcore/macros.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/f7434aef26bc413469fc0dfeadecabf75e18bd38/src%2Flibcore%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f7434aef26bc413469fc0dfeadecabf75e18bd38/src%2Flibcore%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fmacros.rs?ref=f7434aef26bc413469fc0dfeadecabf75e18bd38", "patch": "@@ -1236,8 +1236,10 @@ pub(crate) mod builtin {\n     pub macro test($item:item) { /* compiler built-in */ }\n \n     /// Attribute macro applied to a function to turn it into a benchmark test.\n-    #[unstable(feature = \"test\", issue = \"50297\",\n-               reason = \"`bench` is a part of custom test frameworks which are unstable\")]\n+    #[cfg_attr(not(boostrap_stdarch_ignore_this), unstable(soft, feature = \"test\", issue = \"50297\",\n+               reason = \"`bench` is a part of custom test frameworks which are unstable\"))]\n+    #[cfg_attr(boostrap_stdarch_ignore_this, unstable(feature = \"test\", issue = \"50297\",\n+               reason = \"`bench` is a part of custom test frameworks which are unstable\"))]\n     #[allow_internal_unstable(test, rustc_attrs)]\n     #[rustc_builtin_macro]\n     pub macro bench($item:item) { /* compiler built-in */ }"}, {"sha": "a33181e5925cda13aef96e1b5f138237beb138e3", "filename": "src/librustc/ich/impls_syntax.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/f7434aef26bc413469fc0dfeadecabf75e18bd38/src%2Flibrustc%2Fich%2Fimpls_syntax.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f7434aef26bc413469fc0dfeadecabf75e18bd38/src%2Flibrustc%2Fich%2Fimpls_syntax.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fich%2Fimpls_syntax.rs?ref=f7434aef26bc413469fc0dfeadecabf75e18bd38", "patch": "@@ -115,9 +115,10 @@ for ::syntax::attr::StabilityLevel {\n                                           hasher: &mut StableHasher<W>) {\n         mem::discriminant(self).hash_stable(hcx, hasher);\n         match *self {\n-            ::syntax::attr::StabilityLevel::Unstable { ref reason, ref issue } => {\n+            ::syntax::attr::StabilityLevel::Unstable { ref reason, ref issue, ref is_soft } => {\n                 reason.hash_stable(hcx, hasher);\n                 issue.hash_stable(hcx, hasher);\n+                is_soft.hash_stable(hcx, hasher);\n             }\n             ::syntax::attr::StabilityLevel::Stable { ref since } => {\n                 since.hash_stable(hcx, hasher);"}, {"sha": "dd290572d7bb790208278e70e43dd050050005dd", "filename": "src/librustc/lint/builtin.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/f7434aef26bc413469fc0dfeadecabf75e18bd38/src%2Flibrustc%2Flint%2Fbuiltin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f7434aef26bc413469fc0dfeadecabf75e18bd38/src%2Flibrustc%2Flint%2Fbuiltin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Flint%2Fbuiltin.rs?ref=f7434aef26bc413469fc0dfeadecabf75e18bd38", "patch": "@@ -395,6 +395,12 @@ declare_lint! {\n     \"reservation of a two-phased borrow conflicts with other shared borrows\"\n }\n \n+declare_lint! {\n+    pub SOFT_UNSTABLE,\n+    Deny,\n+    \"a feature gate that doesn't break dependent crates\"\n+}\n+\n declare_lint_pass! {\n     /// Does nothing as a lint pass, but registers some `Lint`s\n     /// that are used by other parts of the compiler.\n@@ -460,6 +466,7 @@ declare_lint_pass! {\n         NESTED_IMPL_TRAIT,\n         MUTABLE_BORROW_RESERVATION_CONFLICT,\n         INDIRECT_STRUCTURAL_MATCH,\n+        SOFT_UNSTABLE,\n     ]\n }\n "}, {"sha": "c06a0feb6a99381f6f8d870e992b80c610832cec", "filename": "src/librustc/middle/stability.rs", "status": "modified", "additions": 16, "deletions": 6, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/f7434aef26bc413469fc0dfeadecabf75e18bd38/src%2Flibrustc%2Fmiddle%2Fstability.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f7434aef26bc413469fc0dfeadecabf75e18bd38/src%2Flibrustc%2Fmiddle%2Fstability.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fstability.rs?ref=f7434aef26bc413469fc0dfeadecabf75e18bd38", "patch": "@@ -438,6 +438,7 @@ impl<'tcx> Index<'tcx> {\n                     level: attr::StabilityLevel::Unstable {\n                         reason: Some(Symbol::intern(reason)),\n                         issue: 27812,\n+                        is_soft: false,\n                     },\n                     feature: sym::rustc_private,\n                     rustc_depr: None,\n@@ -480,7 +481,7 @@ pub fn provide(providers: &mut Providers<'_>) {\n }\n \n pub fn report_unstable(\n-    sess: &Session, feature: Symbol, reason: Option<Symbol>, issue: u32, span: Span\n+    sess: &Session, feature: Symbol, reason: Option<Symbol>, issue: u32, is_soft: bool, span: Span\n ) {\n     let msg = match reason {\n         Some(r) => format!(\"use of unstable library feature '{}': {}\", feature, r),\n@@ -505,7 +506,13 @@ pub fn report_unstable(\n     let error_id = (DiagnosticMessageId::StabilityId(issue), span_key, msg.clone());\n     let fresh = sess.one_time_diagnostics.borrow_mut().insert(error_id);\n     if fresh {\n-        emit_feature_err(&sess.parse_sess, feature, span, GateIssue::Library(Some(issue)), &msg);\n+        if is_soft {\n+            sess.buffer_lint(lint::builtin::SOFT_UNSTABLE, CRATE_NODE_ID, span, &msg);\n+        } else {\n+            emit_feature_err(\n+                &sess.parse_sess, feature, span, GateIssue::Library(Some(issue)), &msg\n+            );\n+        }\n     }\n }\n \n@@ -621,6 +628,7 @@ pub enum EvalResult {\n         feature: Symbol,\n         reason: Option<Symbol>,\n         issue: u32,\n+        is_soft: bool,\n     },\n     /// The item does not have the `#[stable]` or `#[unstable]` marker assigned.\n     Unmarked,\n@@ -720,7 +728,9 @@ impl<'tcx> TyCtxt<'tcx> {\n         }\n \n         match stability {\n-            Some(&Stability { level: attr::Unstable { reason, issue }, feature, .. }) => {\n+            Some(&Stability {\n+                level: attr::Unstable { reason, issue, is_soft }, feature, ..\n+            }) => {\n                 if span.allows_unstable(feature) {\n                     debug!(\"stability: skipping span={:?} since it is internal\", span);\n                     return EvalResult::Allow;\n@@ -744,7 +754,7 @@ impl<'tcx> TyCtxt<'tcx> {\n                     }\n                 }\n \n-                EvalResult::Deny { feature, reason, issue }\n+                EvalResult::Deny { feature, reason, issue, is_soft }\n             }\n             Some(_) => {\n                 // Stable APIs are always ok to call and deprecated APIs are\n@@ -767,8 +777,8 @@ impl<'tcx> TyCtxt<'tcx> {\n     pub fn check_stability(self, def_id: DefId, id: Option<HirId>, span: Span) {\n         match self.eval_stability(def_id, id, span) {\n             EvalResult::Allow => {}\n-            EvalResult::Deny { feature, reason, issue } =>\n-                report_unstable(self.sess, feature, reason, issue, span),\n+            EvalResult::Deny { feature, reason, issue, is_soft } =>\n+                report_unstable(self.sess, feature, reason, issue, is_soft, span),\n             EvalResult::Unmarked => {\n                 // The API could be uncallable for other reasons, for example when a private module\n                 // was referenced."}, {"sha": "87439440463b3ba2265eaeee52e18505eac58a76", "filename": "src/librustc_resolve/macros.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/f7434aef26bc413469fc0dfeadecabf75e18bd38/src%2Flibrustc_resolve%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f7434aef26bc413469fc0dfeadecabf75e18bd38/src%2Flibrustc_resolve%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_resolve%2Fmacros.rs?ref=f7434aef26bc413469fc0dfeadecabf75e18bd38", "patch": "@@ -774,10 +774,10 @@ impl<'a> Resolver<'a> {\n     fn check_stability_and_deprecation(&self, ext: &SyntaxExtension, path: &ast::Path) {\n         let span = path.span;\n         if let Some(stability) = &ext.stability {\n-            if let StabilityLevel::Unstable { reason, issue } = stability.level {\n+            if let StabilityLevel::Unstable { reason, issue, is_soft } = stability.level {\n                 let feature = stability.feature;\n                 if !self.active_features.contains(&feature) && !span.allows_unstable(feature) {\n-                    stability::report_unstable(self.session, feature, reason, issue, span);\n+                    stability::report_unstable(self.session, feature, reason, issue, is_soft, span);\n                 }\n             }\n             if let Some(depr) = &stability.rustc_depr {"}, {"sha": "b5037b75f79e717387a18a59fbf118d3ef54710b", "filename": "src/libsyntax/attr/builtin.rs", "status": "modified", "additions": 12, "deletions": 16, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/f7434aef26bc413469fc0dfeadecabf75e18bd38/src%2Flibsyntax%2Fattr%2Fbuiltin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f7434aef26bc413469fc0dfeadecabf75e18bd38/src%2Flibsyntax%2Fattr%2Fbuiltin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fattr%2Fbuiltin.rs?ref=f7434aef26bc413469fc0dfeadecabf75e18bd38", "patch": "@@ -154,23 +154,10 @@ pub struct Stability {\n #[derive(RustcEncodable, RustcDecodable, PartialEq, PartialOrd, Copy, Clone, Debug, Eq, Hash)]\n pub enum StabilityLevel {\n     // Reason for the current stability level and the relevant rust-lang issue\n-    Unstable { reason: Option<Symbol>, issue: u32 },\n+    Unstable { reason: Option<Symbol>, issue: u32, is_soft: bool },\n     Stable { since: Symbol },\n }\n \n-impl Stability {\n-    pub fn unstable(feature: Symbol, reason: Option<Symbol>, issue: u32) -> Stability {\n-        Stability {\n-            level: StabilityLevel::Unstable { reason, issue },\n-            feature,\n-            rustc_depr: None,\n-            const_stability: None,\n-            promotable: false,\n-            allow_const_fn_ptr: false,\n-        }\n-    }\n-}\n-\n impl StabilityLevel {\n     pub fn is_unstable(&self) -> bool {\n         if let StabilityLevel::Unstable {..} = *self {\n@@ -356,19 +343,27 @@ fn find_stability_generic<'a, I>(sess: &ParseSess,\n                     let mut feature = None;\n                     let mut reason = None;\n                     let mut issue = None;\n+                    let mut is_soft = false;\n                     for meta in metas {\n                         if let Some(mi) = meta.meta_item() {\n                             match mi.name_or_empty() {\n                                 sym::feature => if !get(mi, &mut feature) { continue 'outer },\n                                 sym::reason => if !get(mi, &mut reason) { continue 'outer },\n                                 sym::issue => if !get(mi, &mut issue) { continue 'outer },\n+                                sym::soft => {\n+                                    if !mi.is_word() {\n+                                        let msg = \"`soft` should not have any arguments\";\n+                                        sess.span_diagnostic.span_err(mi.span, msg);\n+                                    }\n+                                    is_soft = true;\n+                                }\n                                 _ => {\n                                     handle_errors(\n                                         sess,\n                                         meta.span(),\n                                         AttrError::UnknownMetaItem(\n                                             mi.path.to_string(),\n-                                            &[\"feature\", \"reason\", \"issue\"]\n+                                            &[\"feature\", \"reason\", \"issue\", \"soft\"]\n                                         ),\n                                     );\n                                     continue 'outer\n@@ -400,7 +395,8 @@ fn find_stability_generic<'a, I>(sess: &ParseSess,\n                                                       \"incorrect 'issue'\");\n                                             continue\n                                         }\n-                                    }\n+                                    },\n+                                    is_soft,\n                                 },\n                                 feature,\n                                 rustc_depr: None,"}, {"sha": "ab32d4461ef8775ea73666449e0380ad0f5967a6", "filename": "src/libsyntax_pos/symbol.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/f7434aef26bc413469fc0dfeadecabf75e18bd38/src%2Flibsyntax_pos%2Fsymbol.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f7434aef26bc413469fc0dfeadecabf75e18bd38/src%2Flibsyntax_pos%2Fsymbol.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax_pos%2Fsymbol.rs?ref=f7434aef26bc413469fc0dfeadecabf75e18bd38", "patch": "@@ -626,6 +626,7 @@ symbols! {\n         size,\n         slice_patterns,\n         slicing_syntax,\n+        soft,\n         Some,\n         specialization,\n         speed,"}, {"sha": "d8a09625e9639f4ea348d06fa63991613f40e96a", "filename": "src/test/ui/feature-gates/bench.rs", "status": "added", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/f7434aef26bc413469fc0dfeadecabf75e18bd38/src%2Ftest%2Fui%2Ffeature-gates%2Fbench.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f7434aef26bc413469fc0dfeadecabf75e18bd38/src%2Ftest%2Fui%2Ffeature-gates%2Fbench.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffeature-gates%2Fbench.rs?ref=f7434aef26bc413469fc0dfeadecabf75e18bd38", "patch": "@@ -0,0 +1,4 @@\n+#[bench] //~ ERROR use of unstable library feature 'test'\n+fn bench() {}\n+\n+fn main() {}"}, {"sha": "25ddcc5e36169e86abd5d0c94321ee0092ba1b96", "filename": "src/test/ui/feature-gates/bench.stderr", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/f7434aef26bc413469fc0dfeadecabf75e18bd38/src%2Ftest%2Fui%2Ffeature-gates%2Fbench.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/f7434aef26bc413469fc0dfeadecabf75e18bd38/src%2Ftest%2Fui%2Ffeature-gates%2Fbench.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffeature-gates%2Fbench.stderr?ref=f7434aef26bc413469fc0dfeadecabf75e18bd38", "patch": "@@ -0,0 +1,10 @@\n+error: use of unstable library feature 'test': `bench` is a part of custom test frameworks which are unstable\n+  --> $DIR/bench.rs:1:3\n+   |\n+LL | #[bench]\n+   |   ^^^^^\n+   |\n+   = note: `#[deny(soft_unstable)]` on by default\n+\n+error: aborting due to previous error\n+"}]}