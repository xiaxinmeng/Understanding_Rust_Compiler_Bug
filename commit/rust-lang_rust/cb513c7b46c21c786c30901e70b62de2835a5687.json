{"sha": "cb513c7b46c21c786c30901e70b62de2835a5687", "node_id": "MDY6Q29tbWl0NzI0NzEyOmNiNTEzYzdiNDZjMjFjNzg2YzMwOTAxZTcwYjYyZGUyODM1YTU2ODc=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2015-05-11T19:24:56Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2015-05-19T17:35:58Z"}, "message": "rt: Clean up to build with cl.exe\n\n* Detect the #define _MSC_VER in addition to __WIN32__\n* Don't include valgrind.h for windows\n* Remove unused `rust_valgrind_stack_{un,}register` functions\n* Add stub definition for `rust_running_on_valgrind` for windows\n* Conditionally define `rust_dbg_extern_empty_struct` as empty structures are\n  not allowed by cl.exe apparently.", "tree": {"sha": "30ed83b091cdddf92b4650c1c3a20420012c5c24", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/30ed83b091cdddf92b4650c1c3a20420012c5c24"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cb513c7b46c21c786c30901e70b62de2835a5687", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cb513c7b46c21c786c30901e70b62de2835a5687", "html_url": "https://github.com/rust-lang/rust/commit/cb513c7b46c21c786c30901e70b62de2835a5687", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cb513c7b46c21c786c30901e70b62de2835a5687/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "40570eb49eb1cb688637cb58d14cdb9664ea1039", "url": "https://api.github.com/repos/rust-lang/rust/commits/40570eb49eb1cb688637cb58d14cdb9664ea1039", "html_url": "https://github.com/rust-lang/rust/commit/40570eb49eb1cb688637cb58d14cdb9664ea1039"}], "stats": {"total": 30, "additions": 15, "deletions": 15}, "files": [{"sha": "5939a5a3c90f5e5ea3df771387327c3240ce003a", "filename": "src/rt/rust_builtin.c", "status": "modified", "additions": 12, "deletions": 15, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/cb513c7b46c21c786c30901e70b62de2835a5687/src%2Frt%2Frust_builtin.c", "raw_url": "https://github.com/rust-lang/rust/raw/cb513c7b46c21c786c30901e70b62de2835a5687/src%2Frt%2Frust_builtin.c", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_builtin.c?ref=cb513c7b46c21c786c30901e70b62de2835a5687", "patch": "@@ -14,7 +14,8 @@\n #include <assert.h>\n #include <stdlib.h>\n \n-#if !defined(__WIN32__)\n+\n+#if !defined(_WIN32)\n #include <dirent.h>\n #include <pthread.h>\n #include <signal.h>\n@@ -40,7 +41,9 @@\n \n /* Foreign builtins. */\n //include valgrind.h after stdint.h so that uintptr_t is defined for msys2 w64\n+#ifndef _WIN32\n #include \"valgrind/valgrind.h\"\n+#endif\n \n #ifndef _WIN32\n char*\n@@ -84,12 +87,7 @@ rust_dirent_t_size() {\n }\n #endif\n \n-uintptr_t\n-rust_running_on_valgrind() {\n-    return RUNNING_ON_VALGRIND;\n-}\n-\n-#if defined(__WIN32__)\n+#if defined(_WIN32)\n int\n get_num_cpus() {\n     SYSTEM_INFO sysinfo;\n@@ -136,14 +134,13 @@ rust_get_num_cpus() {\n     return get_num_cpus();\n }\n \n-unsigned int\n-rust_valgrind_stack_register(void *start, void *end) {\n-  return VALGRIND_STACK_REGISTER(start, end);\n-}\n-\n-void\n-rust_valgrind_stack_deregister(unsigned int id) {\n-  VALGRIND_STACK_DEREGISTER(id);\n+uintptr_t\n+rust_running_on_valgrind() {\n+#ifdef _WIN32\n+    return 0;\n+#else\n+    return RUNNING_ON_VALGRIND;\n+#endif\n }\n \n #if defined(__DragonFly__)"}, {"sha": "8824cef2a816c153ea468796cebea190d99a91f6", "filename": "src/rt/rust_test_helpers.c", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/cb513c7b46c21c786c30901e70b62de2835a5687/src%2Frt%2Frust_test_helpers.c", "raw_url": "https://github.com/rust-lang/rust/raw/cb513c7b46c21c786c30901e70b62de2835a5687/src%2Frt%2Frust_test_helpers.c", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_test_helpers.c?ref=cb513c7b46c21c786c30901e70b62de2835a5687", "patch": "@@ -135,6 +135,8 @@ struct ManyInts {\n     struct TwoU8s arg6;\n };\n \n+// MSVC doesn't allow empty structs or unions\n+#ifndef _MSC_VER\n struct Empty {\n };\n \n@@ -148,6 +150,7 @@ rust_dbg_extern_empty_struct(struct ManyInts v1, struct Empty e, struct ManyInts\n     assert(v1.arg6.one == v2.arg6.one + 1);\n     assert(v1.arg6.two == v2.arg6.two + 1);\n }\n+#endif\n \n intptr_t\n rust_get_test_int() {"}]}