{"sha": "319f2dd9e1f4d07c9631bffda5229bb11bf38e60", "node_id": "MDY6Q29tbWl0NzI0NzEyOjMxOWYyZGQ5ZTFmNGQwN2M5NjMxYmZmZGE1MjI5YmIxMWJmMzhlNjA=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-03-30T15:49:45Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-03-30T15:49:45Z"}, "message": "Auto merge of #1279 - divergentdave:open_O_EXCL, r=RalfJung\n\nAdd support for OpenOptions::create_new()/O_EXCL\n\nThis PR extends the POSIX shim for `open` to support the `O_EXCL` flag, when it is used alongside `O_CREAT`, and exercises it by testing `OpenOptions::create_new`.", "tree": {"sha": "e96214364b161fb6a765b1dd0861fb5718fd9f57", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e96214364b161fb6a765b1dd0861fb5718fd9f57"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/319f2dd9e1f4d07c9631bffda5229bb11bf38e60", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/319f2dd9e1f4d07c9631bffda5229bb11bf38e60", "html_url": "https://github.com/rust-lang/rust/commit/319f2dd9e1f4d07c9631bffda5229bb11bf38e60", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/319f2dd9e1f4d07c9631bffda5229bb11bf38e60/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7743a73be7b51d046f0d745ab247be74d965ee0b", "url": "https://api.github.com/repos/rust-lang/rust/commits/7743a73be7b51d046f0d745ab247be74d965ee0b", "html_url": "https://github.com/rust-lang/rust/commit/7743a73be7b51d046f0d745ab247be74d965ee0b"}, {"sha": "808709c2889e11b079205fbbf830cd58d1f3711b", "url": "https://api.github.com/repos/rust-lang/rust/commits/808709c2889e11b079205fbbf830cd58d1f3711b", "html_url": "https://github.com/rust-lang/rust/commit/808709c2889e11b079205fbbf830cd58d1f3711b"}], "stats": {"total": 28, "additions": 26, "deletions": 2}, "files": [{"sha": "89d067be860d22224081fa164d1f807f637e6b65", "filename": "src/shims/fs.rs", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/319f2dd9e1f4d07c9631bffda5229bb11bf38e60/src%2Fshims%2Ffs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/319f2dd9e1f4d07c9631bffda5229bb11bf38e60/src%2Fshims%2Ffs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fshims%2Ffs.rs?ref=319f2dd9e1f4d07c9631bffda5229bb11bf38e60", "patch": "@@ -288,8 +288,15 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n         }\n         let o_creat = this.eval_libc_i32(\"O_CREAT\")?;\n         if flag & o_creat != 0 {\n-            options.create(true);\n             mirror |= o_creat;\n+\n+            let o_excl = this.eval_libc_i32(\"O_EXCL\")?;\n+            if flag & o_excl != 0 {\n+                mirror |= o_excl;\n+                options.create_new(true);\n+            } else {\n+                options.create(true);\n+            }\n         }\n         let o_cloexec = this.eval_libc_i32(\"O_CLOEXEC\")?;\n         if flag & o_cloexec != 0 {"}, {"sha": "d8b6e5b4457554dd4f36809490242e581bce1b1d", "filename": "tests/run-pass/fs.rs", "status": "modified", "additions": 18, "deletions": 1, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/319f2dd9e1f4d07c9631bffda5229bb11bf38e60/tests%2Frun-pass%2Ffs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/319f2dd9e1f4d07c9631bffda5229bb11bf38e60/tests%2Frun-pass%2Ffs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-pass%2Ffs.rs?ref=319f2dd9e1f4d07c9631bffda5229bb11bf38e60", "patch": "@@ -1,13 +1,16 @@\n // ignore-windows: File handling is not implemented yet\n // compile-flags: -Zmiri-disable-isolation\n \n-use std::fs::{File, create_dir, read_dir, remove_dir, remove_dir_all, remove_file, rename};\n+use std::fs::{\n+    File, create_dir, OpenOptions, read_dir, remove_dir, remove_dir_all, remove_file, rename,\n+};\n use std::io::{Read, Write, ErrorKind, Result, Seek, SeekFrom};\n use std::path::{PathBuf, Path};\n \n fn main() {\n     test_file();\n     test_file_clone();\n+    test_file_create_new();\n     test_seek();\n     test_metadata();\n     test_symlink();\n@@ -85,6 +88,20 @@ fn test_file_clone() {\n     remove_file(&path).unwrap();\n }\n \n+fn test_file_create_new() {\n+    let path = prepare(\"miri_test_fs_file_create_new.txt\");\n+\n+    // Creating a new file that doesn't yet exist should succeed.\n+    OpenOptions::new().write(true).create_new(true).open(&path).unwrap();\n+    // Creating a new file that already exists should fail.\n+    assert_eq!(ErrorKind::AlreadyExists, OpenOptions::new().write(true).create_new(true).open(&path).unwrap_err().kind());\n+    // Optionally creating a new file that already exists should succeed.\n+    OpenOptions::new().write(true).create(true).open(&path).unwrap();\n+\n+    // Clean up\n+    remove_file(&path).unwrap();\n+}\n+\n fn test_seek() {\n     let bytes = b\"Hello, entire World!\\n\";\n     let path = prepare_with_content(\"miri_test_fs_seek.txt\", bytes);"}]}