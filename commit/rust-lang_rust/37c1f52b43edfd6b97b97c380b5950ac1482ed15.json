{"sha": "37c1f52b43edfd6b97b97c380b5950ac1482ed15", "node_id": "MDY6Q29tbWl0NzI0NzEyOjM3YzFmNTJiNDNlZGZkNmI5N2I5N2MzODBiNTk1MGFjMTQ4MmVkMTU=", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2019-11-29T21:57:36Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-11-29T21:57:36Z"}, "message": "Rollup merge of #66793 - matthewjasper:record-static-refs, r=cramertj\n\nRecord temporary static references in generator witnesses\n\nCloses #66695\n\n* Record the pointer to static's type in MIR.\n* Normalize the static's type (so that constants can be compared correctly).", "tree": {"sha": "f9bca55bb4e7a2747d1a7a619d27169b9ed9d5ab", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f9bca55bb4e7a2747d1a7a619d27169b9ed9d5ab"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/37c1f52b43edfd6b97b97c380b5950ac1482ed15", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJd4ZRQCRBK7hj4Ov3rIwAAdHIIAExajS3wgd2piWJDf2Z3/zcc\nPPRbI65QOMeIpsMwqH5vQLXku7vmgJOi0CJ30n6qGNnRdD4jLhKARb4HcSdWNsds\neK+wuHWDJZ2EFa9dVEFZDTNEIHIy+ySOurCfn+SquTSzr3cunWhb6T6aDUwPc1kv\naP6PvCUz8APAMAsiv2u+XvEMzANLFsvvsWve2cXjAJa8GPrIBIBCosoc6Teegv8S\nbuflQzX0iIOZ2SwW95Zxhh9cs/Ou2M5M04Zpr9q8d2L5iNMy67cNg7ArMdQK6U3F\n2DfGuVKh2u03z8bftub3EbtbCduieJR49Hko6BOldeWOxeT7srnJeTAycYTSItY=\n=Slnp\n-----END PGP SIGNATURE-----\n", "payload": "tree f9bca55bb4e7a2747d1a7a619d27169b9ed9d5ab\nparent 6ea1df234016590ee932a89b7c5a78b905dcf71a\nparent df625bdc26b0bccd6390fe22f0fc112e511667f4\nauthor Ralf Jung <post@ralfj.de> 1575064656 +0100\ncommitter GitHub <noreply@github.com> 1575064656 +0100\n\nRollup merge of #66793 - matthewjasper:record-static-refs, r=cramertj\n\nRecord temporary static references in generator witnesses\n\nCloses #66695\n\n* Record the pointer to static's type in MIR.\n* Normalize the static's type (so that constants can be compared correctly).\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/37c1f52b43edfd6b97b97c380b5950ac1482ed15", "html_url": "https://github.com/rust-lang/rust/commit/37c1f52b43edfd6b97b97c380b5950ac1482ed15", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/37c1f52b43edfd6b97b97c380b5950ac1482ed15/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6ea1df234016590ee932a89b7c5a78b905dcf71a", "url": "https://api.github.com/repos/rust-lang/rust/commits/6ea1df234016590ee932a89b7c5a78b905dcf71a", "html_url": "https://github.com/rust-lang/rust/commit/6ea1df234016590ee932a89b7c5a78b905dcf71a"}, {"sha": "df625bdc26b0bccd6390fe22f0fc112e511667f4", "url": "https://api.github.com/repos/rust-lang/rust/commits/df625bdc26b0bccd6390fe22f0fc112e511667f4", "html_url": "https://github.com/rust-lang/rust/commit/df625bdc26b0bccd6390fe22f0fc112e511667f4"}], "stats": {"total": 79, "additions": 69, "deletions": 10}, "files": [{"sha": "0b11a9efd81d7a5a387c9fae1b58edb9c60ff431", "filename": "src/librustc/ty/util.rs", "status": "modified", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/37c1f52b43edfd6b97b97c380b5950ac1482ed15/src%2Flibrustc%2Fty%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/37c1f52b43edfd6b97b97c380b5950ac1482ed15/src%2Flibrustc%2Fty%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Futil.rs?ref=37c1f52b43edfd6b97b97c380b5950ac1482ed15", "patch": "@@ -682,6 +682,23 @@ impl<'tcx> TyCtxt<'tcx> {\n         self.static_mutability(def_id) == Some(hir::Mutability::Mutable)\n     }\n \n+    /// Get the type of the pointer to the static that we use in MIR.\n+    pub fn static_ptr_ty(&self, def_id: DefId) -> Ty<'tcx> {\n+        // Make sure that any constants in the static's type are evaluated.\n+        let static_ty = self.normalize_erasing_regions(\n+            ty::ParamEnv::empty(),\n+            self.type_of(def_id),\n+        );\n+\n+        if self.is_mutable_static(def_id) {\n+            self.mk_mut_ptr(static_ty)\n+        } else if self.is_foreign_item(def_id) {\n+            self.mk_imm_ptr(static_ty)\n+        } else {\n+            self.mk_imm_ref(self.lifetimes.re_erased, static_ty)\n+        }\n+    }\n+\n     /// Expands the given impl trait type, stopping if the type is recursive.\n     pub fn try_expand_impl_trait_type(\n         self,"}, {"sha": "8c852854be1f99f0c697c875ed85eea403c650e1", "filename": "src/librustc_mir/hair/cx/expr.rs", "status": "modified", "additions": 1, "deletions": 8, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/37c1f52b43edfd6b97b97c380b5950ac1482ed15/src%2Flibrustc_mir%2Fhair%2Fcx%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/37c1f52b43edfd6b97b97c380b5950ac1482ed15/src%2Flibrustc_mir%2Fhair%2Fcx%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fhair%2Fcx%2Fexpr.rs?ref=37c1f52b43edfd6b97b97c380b5950ac1482ed15", "patch": "@@ -933,14 +933,7 @@ fn convert_path_expr<'a, 'tcx>(\n         // We encode uses of statics as a `*&STATIC` where the `&STATIC` part is\n         // a constant reference (or constant raw pointer for `static mut`) in MIR\n         Res::Def(DefKind::Static, id) => {\n-            let ty = cx.tcx.type_of(id);\n-            let ty = if cx.tcx.is_mutable_static(id) {\n-                cx.tcx.mk_mut_ptr(ty)\n-            } else if cx.tcx.is_foreign_item(id) {\n-                cx.tcx.mk_imm_ptr(ty)\n-            } else {\n-                cx.tcx.mk_imm_ref(cx.tcx.lifetimes.re_static, ty)\n-            };\n+            let ty = cx.tcx.static_ptr_ty(id);\n             let ptr = cx.tcx.alloc_map.lock().create_static_alloc(id);\n             let temp_lifetime = cx.region_scope_tree.temporary_scope(expr.hir_id.local_id);\n             ExprKind::Deref { arg: Expr {"}, {"sha": "fcf6b22f74f3c01e49c12fa836d7e3d5f7189cc5", "filename": "src/librustc_typeck/check/generator_interior.rs", "status": "modified", "additions": 11, "deletions": 2, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/37c1f52b43edfd6b97b97c380b5950ac1482ed15/src%2Flibrustc_typeck%2Fcheck%2Fgenerator_interior.rs", "raw_url": "https://github.com/rust-lang/rust/raw/37c1f52b43edfd6b97b97c380b5950ac1482ed15/src%2Flibrustc_typeck%2Fcheck%2Fgenerator_interior.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fgenerator_interior.rs?ref=37c1f52b43edfd6b97b97c380b5950ac1482ed15", "patch": "@@ -185,6 +185,8 @@ impl<'a, 'tcx> Visitor<'tcx> for InteriorVisitor<'a, 'tcx> {\n     }\n \n     fn visit_expr(&mut self, expr: &'tcx Expr) {\n+        let scope = self.region_scope_tree.temporary_scope(expr.hir_id.local_id);\n+\n         match &expr.kind {\n             ExprKind::Call(callee, args) => match &callee.kind {\n                 ExprKind::Path(qpath) => {\n@@ -210,13 +212,20 @@ impl<'a, 'tcx> Visitor<'tcx> for InteriorVisitor<'a, 'tcx> {\n                 }\n                 _ => intravisit::walk_expr(self, expr),\n             }\n+            ExprKind::Path(qpath) => {\n+                let res = self.fcx.tables.borrow().qpath_res(qpath, expr.hir_id);\n+                if let Res::Def(DefKind::Static, def_id) = res {\n+                    // Statics are lowered to temporary references or\n+                    // pointers in MIR, so record that type.\n+                    let ptr_ty = self.fcx.tcx.static_ptr_ty(def_id);\n+                    self.record(ptr_ty, scope, Some(expr), expr.span);\n+                }\n+            }\n             _ => intravisit::walk_expr(self, expr),\n         }\n \n         self.expr_count += 1;\n \n-        let scope = self.region_scope_tree.temporary_scope(expr.hir_id.local_id);\n-\n         // If there are adjustments, then record the final type --\n         // this is the actual value that is being produced.\n         if let Some(adjusted_ty) = self.fcx.tables.borrow().expr_ty_adjusted_opt(expr) {"}, {"sha": "f0609713b4ddcb652f97d1c7c05e4c4b815761d8", "filename": "src/test/ui/async-await/issues/issue-66695-static-refs.rs", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/37c1f52b43edfd6b97b97c380b5950ac1482ed15/src%2Ftest%2Fui%2Fasync-await%2Fissues%2Fissue-66695-static-refs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/37c1f52b43edfd6b97b97c380b5950ac1482ed15/src%2Ftest%2Fui%2Fasync-await%2Fissues%2Fissue-66695-static-refs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasync-await%2Fissues%2Fissue-66695-static-refs.rs?ref=37c1f52b43edfd6b97b97c380b5950ac1482ed15", "patch": "@@ -0,0 +1,24 @@\n+// build-pass\n+// edition:2018\n+\n+static A: [i32; 5] = [1, 2, 3, 4, 5];\n+\n+async fn fun() {\n+    let u = A[async { 1 }.await];\n+    match A {\n+        i if async { true }.await => (),\n+        _ => (),\n+    }\n+}\n+\n+fn main() {\n+    async {\n+        let u = A[async { 1 }.await];\n+    };\n+    async {\n+        match A {\n+            i if async { true }.await => (),\n+            _ => (),\n+        }\n+    };\n+}"}, {"sha": "23b11593bb5d6444354972faea766d580765247f", "filename": "src/test/ui/generator/static-reference-across-yield.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/37c1f52b43edfd6b97b97c380b5950ac1482ed15/src%2Ftest%2Fui%2Fgenerator%2Fstatic-reference-across-yield.rs", "raw_url": "https://github.com/rust-lang/rust/raw/37c1f52b43edfd6b97b97c380b5950ac1482ed15/src%2Ftest%2Fui%2Fgenerator%2Fstatic-reference-across-yield.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fgenerator%2Fstatic-reference-across-yield.rs?ref=37c1f52b43edfd6b97b97c380b5950ac1482ed15", "patch": "@@ -0,0 +1,16 @@\n+// build-pass\n+#![feature(generators)]\n+\n+static A: [i32; 5] = [1, 2, 3, 4, 5];\n+\n+fn main() {\n+    static || {\n+        let u = A[{yield; 1}];\n+    };\n+    static || {\n+        match A {\n+            i if { yield; true } => (),\n+            _ => (),\n+        }\n+    };\n+}"}]}