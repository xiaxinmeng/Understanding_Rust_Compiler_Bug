{"sha": "71b0ea62354686553d180ad6f192c234c97501f2", "node_id": "MDY6Q29tbWl0NzI0NzEyOjcxYjBlYTYyMzU0Njg2NTUzZDE4MGFkNmYxOTJjMjM0Yzk3NTAxZjI=", "commit": {"author": {"name": "Dylan DPC", "email": "dylan.dpc@gmail.com", "date": "2020-10-16T00:10:19Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-10-16T00:10:19Z"}, "message": "Rollup merge of #77672 - Nemo157:simplify-cfg, r=jyn514\n\nSimplify doc-cfg rendering based on the current context\n\nFor sub-items on a page don't show cfg that has already been rendered on\na parent item. At its simplest this means not showing anything that is\nshown in the portability message at the top of the page, but also for\nthings like fields of an enum variant if that variant itself is\ncfg-gated then don't repeat those cfg on each field of the variant.\n\nThis does not touch trait implementation rendering, as that is more\ncomplex and there are existing issues around how it deals with doc-cfg\nthat need to be fixed first.\n\n### Screenshots, left is current, right is new:\n\n![image](https://user-images.githubusercontent.com/81079/95387261-c2e6a200-08f0-11eb-90d4-0a9734acd922.png)\n\n![image](https://user-images.githubusercontent.com/81079/95387458-06411080-08f1-11eb-81f7-5dd7f37695dd.png)\n\n![image](https://user-images.githubusercontent.com/81079/95387702-6637b700-08f1-11eb-82f4-46b6cd9b24f2.png)\n\n![image](https://user-images.githubusercontent.com/81079/95387905-b9aa0500-08f1-11eb-8d95-8b618d31d419.png)\n\n![image](https://user-images.githubusercontent.com/81079/95388300-5bc9ed00-08f2-11eb-9ac9-b92cbdb60b89.png)\n\ncc #43781", "tree": {"sha": "1e83eed12f37d235f9d849255bbf3443124f5022", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1e83eed12f37d235f9d849255bbf3443124f5022"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/71b0ea62354686553d180ad6f192c234c97501f2", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfiOTsCRBK7hj4Ov3rIwAAdHIIAIqqOtuzPfZMipqBs1qLBZ2r\nraoVCy1hdKlobI08Am65bVv8ZcIL0WqMS3QDvOTkzitmRHgUdcKe50gynX9Rjwqf\nBpU1YjpkyHvKdjdfPgZNNFsrtv5f0ZBUT7TdbYxfW6SDk6t6aomSgGeO6S+TvRkw\nECdhevSS6foX/w+ggHzvnkAzwvakbtVziy79XmIjzvplYmDPJHL0LPFplVMMROL6\n3PwDeF0WXUZ3Zdsks6ivGPmLMhlDREYoQInwxcyHTcI1kE9vkx0JBtfXJz7AhPQL\n+lKsE+MbVUqZQiKoS5QMvrkjER207K7qg6b5gsfQptvI57rStfhD6Cfy+RMf9Cg=\n=XJTH\n-----END PGP SIGNATURE-----\n", "payload": "tree 1e83eed12f37d235f9d849255bbf3443124f5022\nparent 9b8c0eb107f75cf154b814cee10113c0359fefcf\nparent 4409cb2e3807c50d2e636ab293f10e6b8a87a7d4\nauthor Dylan DPC <dylan.dpc@gmail.com> 1602807019 +0200\ncommitter GitHub <noreply@github.com> 1602807019 +0200\n\nRollup merge of #77672 - Nemo157:simplify-cfg, r=jyn514\n\nSimplify doc-cfg rendering based on the current context\n\nFor sub-items on a page don't show cfg that has already been rendered on\na parent item. At its simplest this means not showing anything that is\nshown in the portability message at the top of the page, but also for\nthings like fields of an enum variant if that variant itself is\ncfg-gated then don't repeat those cfg on each field of the variant.\n\nThis does not touch trait implementation rendering, as that is more\ncomplex and there are existing issues around how it deals with doc-cfg\nthat need to be fixed first.\n\n### Screenshots, left is current, right is new:\n\n![image](https://user-images.githubusercontent.com/81079/95387261-c2e6a200-08f0-11eb-90d4-0a9734acd922.png)\n\n![image](https://user-images.githubusercontent.com/81079/95387458-06411080-08f1-11eb-81f7-5dd7f37695dd.png)\n\n![image](https://user-images.githubusercontent.com/81079/95387702-6637b700-08f1-11eb-82f4-46b6cd9b24f2.png)\n\n![image](https://user-images.githubusercontent.com/81079/95387905-b9aa0500-08f1-11eb-8d95-8b618d31d419.png)\n\n![image](https://user-images.githubusercontent.com/81079/95388300-5bc9ed00-08f2-11eb-9ac9-b92cbdb60b89.png)\n\ncc #43781\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/71b0ea62354686553d180ad6f192c234c97501f2", "html_url": "https://github.com/rust-lang/rust/commit/71b0ea62354686553d180ad6f192c234c97501f2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/71b0ea62354686553d180ad6f192c234c97501f2/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9b8c0eb107f75cf154b814cee10113c0359fefcf", "url": "https://api.github.com/repos/rust-lang/rust/commits/9b8c0eb107f75cf154b814cee10113c0359fefcf", "html_url": "https://github.com/rust-lang/rust/commit/9b8c0eb107f75cf154b814cee10113c0359fefcf"}, {"sha": "4409cb2e3807c50d2e636ab293f10e6b8a87a7d4", "url": "https://api.github.com/repos/rust-lang/rust/commits/4409cb2e3807c50d2e636ab293f10e6b8a87a7d4", "html_url": "https://github.com/rust-lang/rust/commit/4409cb2e3807c50d2e636ab293f10e6b8a87a7d4"}], "stats": {"total": 386, "additions": 334, "deletions": 52}, "files": [{"sha": "b659f3eab4318146b3a51c46f0862dcd4f7ea38e", "filename": "src/librustdoc/clean/cfg.rs", "status": "modified", "additions": 31, "deletions": 0, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/71b0ea62354686553d180ad6f192c234c97501f2/src%2Flibrustdoc%2Fclean%2Fcfg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/71b0ea62354686553d180ad6f192c234c97501f2/src%2Flibrustdoc%2Fclean%2Fcfg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Fcfg.rs?ref=71b0ea62354686553d180ad6f192c234c97501f2", "patch": "@@ -201,6 +201,37 @@ impl Cfg {\n             _ => false,\n         }\n     }\n+\n+    /// Attempt to simplify this cfg by assuming that `assume` is already known to be true, will\n+    /// return `None` if simplification managed to completely eliminate any requirements from this\n+    /// `Cfg`.\n+    ///\n+    /// See `tests::test_simplify_with` for examples.\n+    pub(crate) fn simplify_with(&self, assume: &Cfg) -> Option<Cfg> {\n+        if self == assume {\n+            return None;\n+        }\n+\n+        if let Cfg::All(a) = self {\n+            let mut sub_cfgs: Vec<Cfg> = if let Cfg::All(b) = assume {\n+                a.iter().filter(|a| !b.contains(a)).cloned().collect()\n+            } else {\n+                a.iter().filter(|&a| a != assume).cloned().collect()\n+            };\n+            let len = sub_cfgs.len();\n+            return match len {\n+                0 => None,\n+                1 => sub_cfgs.pop(),\n+                _ => Some(Cfg::All(sub_cfgs)),\n+            };\n+        } else if let Cfg::All(b) = assume {\n+            if b.contains(self) {\n+                return None;\n+            }\n+        }\n+\n+        Some(self.clone())\n+    }\n }\n \n impl ops::Not for Cfg {"}, {"sha": "3a78269f19af0a5a59ad71953c4f45a7927330fe", "filename": "src/librustdoc/clean/cfg/tests.rs", "status": "modified", "additions": 36, "deletions": 0, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/71b0ea62354686553d180ad6f192c234c97501f2/src%2Flibrustdoc%2Fclean%2Fcfg%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/71b0ea62354686553d180ad6f192c234c97501f2/src%2Flibrustdoc%2Fclean%2Fcfg%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Fcfg%2Ftests.rs?ref=71b0ea62354686553d180ad6f192c234c97501f2", "patch": "@@ -433,3 +433,39 @@ fn test_render_long_html() {\n         );\n     })\n }\n+\n+#[test]\n+fn test_simplify_with() {\n+    // This is a tiny subset of things that could be simplified, but it likely covers 90% of\n+    // real world usecases well.\n+    with_default_session_globals(|| {\n+        let foo = word_cfg(\"foo\");\n+        let bar = word_cfg(\"bar\");\n+        let baz = word_cfg(\"baz\");\n+        let quux = word_cfg(\"quux\");\n+\n+        let foobar = Cfg::All(vec![foo.clone(), bar.clone()]);\n+        let barbaz = Cfg::All(vec![bar.clone(), baz.clone()]);\n+        let foobarbaz = Cfg::All(vec![foo.clone(), bar.clone(), baz.clone()]);\n+        let bazquux = Cfg::All(vec![baz.clone(), quux.clone()]);\n+\n+        // Unrelated cfgs don't affect each other\n+        assert_eq!(foo.simplify_with(&bar).as_ref(), Some(&foo));\n+        assert_eq!(foobar.simplify_with(&bazquux).as_ref(), Some(&foobar));\n+\n+        // Identical cfgs are eliminated\n+        assert_eq!(foo.simplify_with(&foo), None);\n+        assert_eq!(foobar.simplify_with(&foobar), None);\n+\n+        // Multiple cfgs eliminate a single assumed cfg\n+        assert_eq!(foobar.simplify_with(&foo).as_ref(), Some(&bar));\n+        assert_eq!(foobar.simplify_with(&bar).as_ref(), Some(&foo));\n+\n+        // A single cfg is eliminated by multiple assumed cfg containing it\n+        assert_eq!(foo.simplify_with(&foobar), None);\n+\n+        // Multiple cfgs eliminate the matching subset of multiple assumed cfg\n+        assert_eq!(foobar.simplify_with(&barbaz).as_ref(), Some(&foo));\n+        assert_eq!(foobar.simplify_with(&foobarbaz), None);\n+    });\n+}"}, {"sha": "22ae7af617fc7b0f03d8133a953bf08899520eeb", "filename": "src/librustdoc/html/render/mod.rs", "status": "modified", "additions": 71, "deletions": 33, "changes": 104, "blob_url": "https://github.com/rust-lang/rust/blob/71b0ea62354686553d180ad6f192c234c97501f2/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/71b0ea62354686553d180ad6f192c234c97501f2/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs?ref=71b0ea62354686553d180ad6f192c234c97501f2", "patch": "@@ -1763,11 +1763,11 @@ crate fn shorten(s: String) -> String {\n     }\n }\n \n-fn document(w: &mut Buffer, cx: &Context, item: &clean::Item) {\n+fn document(w: &mut Buffer, cx: &Context, item: &clean::Item, parent: Option<&clean::Item>) {\n     if let Some(ref name) = item.name {\n         info!(\"Documenting {}\", name);\n     }\n-    document_stability(w, cx, item, false);\n+    document_stability(w, cx, item, false, parent);\n     document_full(w, item, cx, \"\", false);\n }\n \n@@ -1851,8 +1851,14 @@ fn document_full(w: &mut Buffer, item: &clean::Item, cx: &Context, prefix: &str,\n     }\n }\n \n-fn document_stability(w: &mut Buffer, cx: &Context, item: &clean::Item, is_hidden: bool) {\n-    let stabilities = short_stability(item, cx);\n+fn document_stability(\n+    w: &mut Buffer,\n+    cx: &Context,\n+    item: &clean::Item,\n+    is_hidden: bool,\n+    parent: Option<&clean::Item>,\n+) {\n+    let stabilities = short_stability(item, cx, parent);\n     if !stabilities.is_empty() {\n         write!(w, \"<div class='stability{}'>\", if is_hidden { \" hidden\" } else { \"\" });\n         for stability in stabilities {\n@@ -1952,7 +1958,7 @@ pub fn compare_names(mut lhs: &str, mut rhs: &str) -> Ordering {\n }\n \n fn item_module(w: &mut Buffer, cx: &Context, item: &clean::Item, items: &[clean::Item]) {\n-    document(w, cx, item);\n+    document(w, cx, item, None);\n \n     let mut indices = (0..items.len()).filter(|i| !items[*i].is_stripped()).collect::<Vec<usize>>();\n \n@@ -2111,7 +2117,7 @@ fn item_module(w: &mut Buffer, cx: &Context, item: &clean::Item, items: &[clean:\n                          <td class='docblock-short'>{stab_tags}{docs}</td>\\\n                      </tr>\",\n                     name = *myitem.name.as_ref().unwrap(),\n-                    stab_tags = stability_tags(myitem),\n+                    stab_tags = stability_tags(myitem, item),\n                     docs = MarkdownSummaryLine(doc_value, &myitem.links()).into_string(),\n                     class = myitem.type_(),\n                     add = add,\n@@ -2135,7 +2141,7 @@ fn item_module(w: &mut Buffer, cx: &Context, item: &clean::Item, items: &[clean:\n \n /// Render the stability and deprecation tags that are displayed in the item's summary at the\n /// module level.\n-fn stability_tags(item: &clean::Item) -> String {\n+fn stability_tags(item: &clean::Item, parent: &clean::Item) -> String {\n     let mut tags = String::new();\n \n     fn tag_html(class: &str, title: &str, contents: &str) -> String {\n@@ -2159,7 +2165,13 @@ fn stability_tags(item: &clean::Item) -> String {\n         tags += &tag_html(\"unstable\", \"\", \"Experimental\");\n     }\n \n-    if let Some(ref cfg) = item.attrs.cfg {\n+    let cfg = match (&item.attrs.cfg, parent.attrs.cfg.as_ref()) {\n+        (Some(cfg), Some(parent_cfg)) => cfg.simplify_with(parent_cfg),\n+        (cfg, _) => cfg.as_deref().cloned(),\n+    };\n+\n+    debug!(\"Portability {:?} - {:?} = {:?}\", item.attrs.cfg, parent.attrs.cfg, cfg);\n+    if let Some(ref cfg) = cfg {\n         tags += &tag_html(\"portability\", &cfg.render_long_plain(), &cfg.render_short_html());\n     }\n \n@@ -2168,7 +2180,7 @@ fn stability_tags(item: &clean::Item) -> String {\n \n /// Render the stability and/or deprecation warning that is displayed at the top of the item's\n /// documentation.\n-fn short_stability(item: &clean::Item, cx: &Context) -> Vec<String> {\n+fn short_stability(item: &clean::Item, cx: &Context, parent: Option<&clean::Item>) -> Vec<String> {\n     let mut stability = vec![];\n     let error_codes = cx.shared.codes;\n \n@@ -2243,7 +2255,18 @@ fn short_stability(item: &clean::Item, cx: &Context) -> Vec<String> {\n         stability.push(format!(\"<div class='stab unstable'>{}</div>\", message));\n     }\n \n-    if let Some(ref cfg) = item.attrs.cfg {\n+    let cfg = match (&item.attrs.cfg, parent.and_then(|p| p.attrs.cfg.as_ref())) {\n+        (Some(cfg), Some(parent_cfg)) => cfg.simplify_with(parent_cfg),\n+        (cfg, _) => cfg.as_deref().cloned(),\n+    };\n+\n+    debug!(\n+        \"Portability {:?} - {:?} = {:?}\",\n+        item.attrs.cfg,\n+        parent.and_then(|p| p.attrs.cfg.as_ref()),\n+        cfg\n+    );\n+    if let Some(cfg) = cfg {\n         stability.push(format!(\"<div class='stab portability'>{}</div>\", cfg.render_long_html()));\n     }\n \n@@ -2282,7 +2305,7 @@ fn item_constant(w: &mut Buffer, cx: &Context, it: &clean::Item, c: &clean::Cons\n     }\n \n     write!(w, \"</pre>\");\n-    document(w, cx, it)\n+    document(w, cx, it, None)\n }\n \n fn item_static(w: &mut Buffer, cx: &Context, it: &clean::Item, s: &clean::Static) {\n@@ -2296,7 +2319,7 @@ fn item_static(w: &mut Buffer, cx: &Context, it: &clean::Item, s: &clean::Static\n         name = it.name.as_ref().unwrap(),\n         typ = s.type_.print()\n     );\n-    document(w, cx, it)\n+    document(w, cx, it, None)\n }\n \n fn item_function(w: &mut Buffer, cx: &Context, it: &clean::Item, f: &clean::Function) {\n@@ -2329,7 +2352,7 @@ fn item_function(w: &mut Buffer, cx: &Context, it: &clean::Item, f: &clean::Func\n             .print(),\n         spotlight = spotlight_decl(&f.decl),\n     );\n-    document(w, cx, it)\n+    document(w, cx, it, None)\n }\n \n fn render_implementor(\n@@ -2354,6 +2377,7 @@ fn render_implementor(\n         w,\n         cx,\n         implementor,\n+        None,\n         AssocItemLink::Anchor(None),\n         RenderMode::Normal,\n         implementor.impl_item.stable_since().as_deref(),\n@@ -2383,6 +2407,7 @@ fn render_impls(\n                 &mut buffer,\n                 cx,\n                 i,\n+                Some(containing_item),\n                 assoc_link,\n                 RenderMode::Normal,\n                 containing_item.stable_since().as_deref(),\n@@ -2502,7 +2527,7 @@ fn item_trait(w: &mut Buffer, cx: &Context, it: &clean::Item, t: &clean::Trait,\n     });\n \n     // Trait documentation\n-    document(w, cx, it);\n+    document(w, cx, it, None);\n \n     fn write_small_section_header(w: &mut Buffer, id: &str, title: &str, extra_content: &str) {\n         write!(\n@@ -2520,14 +2545,15 @@ fn item_trait(w: &mut Buffer, cx: &Context, it: &clean::Item, t: &clean::Trait,\n \n     fn trait_item(w: &mut Buffer, cx: &Context, m: &clean::Item, t: &clean::Item) {\n         let name = m.name.as_ref().unwrap();\n+        info!(\"Documenting {} on {}\", name, t.name.as_deref().unwrap_or_default());\n         let item_type = m.type_();\n         let id = cx.derive_id(format!(\"{}.{}\", item_type, name));\n         write!(w, \"<h3 id='{id}' class='method'><code>\", id = id,);\n         render_assoc_item(w, m, AssocItemLink::Anchor(Some(&id)), ItemType::Impl);\n         write!(w, \"</code>\");\n         render_stability_since(w, m, t);\n         write!(w, \"</h3>\");\n-        document(w, cx, m);\n+        document(w, cx, m, Some(t));\n     }\n \n     if !types.is_empty() {\n@@ -2628,6 +2654,7 @@ fn item_trait(w: &mut Buffer, cx: &Context, it: &clean::Item, t: &clean::Trait,\n                     w,\n                     cx,\n                     &implementor,\n+                    None,\n                     assoc_link,\n                     RenderMode::Normal,\n                     implementor.impl_item.stable_since().as_deref(),\n@@ -2890,7 +2917,7 @@ fn item_struct(w: &mut Buffer, cx: &Context, it: &clean::Item, s: &clean::Struct\n         write!(w, \"</pre>\")\n     });\n \n-    document(w, cx, it);\n+    document(w, cx, it, None);\n     let mut fields = s\n         .fields\n         .iter()\n@@ -2925,7 +2952,7 @@ fn item_struct(w: &mut Buffer, cx: &Context, it: &clean::Item, s: &clean::Struct\n                     name = field.name.as_ref().unwrap(),\n                     ty = ty.print()\n                 );\n-                document(w, cx, field);\n+                document(w, cx, field, Some(it));\n             }\n         }\n     }\n@@ -2940,7 +2967,7 @@ fn item_union(w: &mut Buffer, cx: &Context, it: &clean::Item, s: &clean::Union,\n         write!(w, \"</pre>\")\n     });\n \n-    document(w, cx, it);\n+    document(w, cx, it, None);\n     let mut fields = s\n         .fields\n         .iter()\n@@ -2972,7 +2999,7 @@ fn item_union(w: &mut Buffer, cx: &Context, it: &clean::Item, s: &clean::Union,\n             if let Some(stability_class) = field.stability_class() {\n                 write!(w, \"<span class='stab {stab}'></span>\", stab = stability_class);\n             }\n-            document(w, cx, field);\n+            document(w, cx, field, Some(it));\n         }\n     }\n     render_assoc_items(w, cx, it, it.def_id, AssocItemRender::All, cache)\n@@ -3027,7 +3054,7 @@ fn item_enum(w: &mut Buffer, cx: &Context, it: &clean::Item, e: &clean::Enum, ca\n         write!(w, \"</pre>\")\n     });\n \n-    document(w, cx, it);\n+    document(w, cx, it, None);\n     if !e.variants.is_empty() {\n         write!(\n             w,\n@@ -3060,7 +3087,7 @@ fn item_enum(w: &mut Buffer, cx: &Context, it: &clean::Item, e: &clean::Enum, ca\n                 }\n             }\n             write!(w, \"</code></div>\");\n-            document(w, cx, variant);\n+            document(w, cx, variant, Some(it));\n             document_non_exhaustive(w, variant);\n \n             use crate::clean::{Variant, VariantKind};\n@@ -3095,7 +3122,7 @@ fn item_enum(w: &mut Buffer, cx: &Context, it: &clean::Item, e: &clean::Enum, ca\n                             f = field.name.as_ref().unwrap(),\n                             t = ty.print()\n                         );\n-                        document(w, cx, field);\n+                        document(w, cx, field, Some(variant));\n                     }\n                 }\n                 write!(w, \"</div></div>\");\n@@ -3293,6 +3320,10 @@ fn render_assoc_items(\n     what: AssocItemRender<'_>,\n     cache: &Cache,\n ) {\n+    info!(\n+        \"Documenting associated items of {}\",\n+        containing_item.name.as_deref().unwrap_or_default()\n+    );\n     let v = match cache.impls.get(&it) {\n         Some(v) => v,\n         None => return,\n@@ -3327,6 +3358,7 @@ fn render_assoc_items(\n                 w,\n                 cx,\n                 i,\n+                Some(containing_item),\n                 AssocItemLink::Anchor(None),\n                 render_mode,\n                 containing_item.stable_since().as_deref(),\n@@ -3518,6 +3550,7 @@ fn render_impl(\n     w: &mut Buffer,\n     cx: &Context,\n     i: &Impl,\n+    parent: Option<&clean::Item>,\n     link: AssocItemLink<'_>,\n     render_mode: RenderMode,\n     outer_version: Option<&str>,\n@@ -3600,6 +3633,7 @@ fn render_impl(\n         w: &mut Buffer,\n         cx: &Context,\n         item: &clean::Item,\n+        parent: Option<&clean::Item>,\n         link: AssocItemLink<'_>,\n         render_mode: RenderMode,\n         is_default_item: bool,\n@@ -3684,7 +3718,7 @@ fn render_impl(\n                     if let Some(it) = t.items.iter().find(|i| i.name == item.name) {\n                         // We need the stability of the item from the trait\n                         // because impls can't have a stability.\n-                        document_stability(w, cx, it, is_hidden);\n+                        document_stability(w, cx, it, is_hidden, parent);\n                         if item.doc_value().is_some() {\n                             document_full(w, item, cx, \"\", is_hidden);\n                         } else if show_def_docs {\n@@ -3694,13 +3728,13 @@ fn render_impl(\n                         }\n                     }\n                 } else {\n-                    document_stability(w, cx, item, is_hidden);\n+                    document_stability(w, cx, item, is_hidden, parent);\n                     if show_def_docs {\n                         document_full(w, item, cx, \"\", is_hidden);\n                     }\n                 }\n             } else {\n-                document_stability(w, cx, item, is_hidden);\n+                document_stability(w, cx, item, is_hidden, parent);\n                 if show_def_docs {\n                     document_short(w, item, link, \"\", is_hidden);\n                 }\n@@ -3717,6 +3751,7 @@ fn render_impl(\n             w,\n             cx,\n             trait_item,\n+            parent,\n             link,\n             render_mode,\n             false,\n@@ -3732,6 +3767,7 @@ fn render_impl(\n         cx: &Context,\n         t: &clean::Trait,\n         i: &clean::Impl,\n+        parent: Option<&clean::Item>,\n         render_mode: RenderMode,\n         outer_version: Option<&str>,\n         show_def_docs: bool,\n@@ -3749,6 +3785,7 @@ fn render_impl(\n                 w,\n                 cx,\n                 trait_item,\n+                parent,\n                 assoc_link,\n                 render_mode,\n                 true,\n@@ -3771,6 +3808,7 @@ fn render_impl(\n                 cx,\n                 t,\n                 &i.inner_impl(),\n+                parent,\n                 render_mode,\n                 outer_version,\n                 show_def_docs,\n@@ -3799,7 +3837,7 @@ fn item_opaque_ty(\n         bounds = bounds(&t.bounds, false)\n     );\n \n-    document(w, cx, it);\n+    document(w, cx, it, None);\n \n     // Render any items associated directly to this alias, as otherwise they\n     // won't be visible anywhere in the docs. It would be nice to also show\n@@ -3826,7 +3864,7 @@ fn item_trait_alias(\n         bounds(&t.bounds, true)\n     );\n \n-    document(w, cx, it);\n+    document(w, cx, it, None);\n \n     // Render any items associated directly to this alias, as otherwise they\n     // won't be visible anywhere in the docs. It would be nice to also show\n@@ -3847,7 +3885,7 @@ fn item_typedef(w: &mut Buffer, cx: &Context, it: &clean::Item, t: &clean::Typed\n         type_ = t.type_.print()\n     );\n \n-    document(w, cx, it);\n+    document(w, cx, it, None);\n \n     // Render any items associated directly to this alias, as otherwise they\n     // won't be visible anywhere in the docs. It would be nice to also show\n@@ -3866,7 +3904,7 @@ fn item_foreign_type(w: &mut Buffer, cx: &Context, it: &clean::Item, cache: &Cac\n         it.name.as_ref().unwrap(),\n     );\n \n-    document(w, cx, it);\n+    document(w, cx, it, None);\n \n     render_assoc_items(w, cx, it, it.def_id, AssocItemRender::All, cache)\n }\n@@ -4511,7 +4549,7 @@ fn item_macro(w: &mut Buffer, cx: &Context, it: &clean::Item, t: &clean::Macro)\n             None,\n         ))\n     });\n-    document(w, cx, it)\n+    document(w, cx, it, None)\n }\n \n fn item_proc_macro(w: &mut Buffer, cx: &Context, it: &clean::Item, m: &clean::ProcMacro) {\n@@ -4541,16 +4579,16 @@ fn item_proc_macro(w: &mut Buffer, cx: &Context, it: &clean::Item, m: &clean::Pr\n             write!(w, \"</pre>\");\n         }\n     }\n-    document(w, cx, it)\n+    document(w, cx, it, None)\n }\n \n fn item_primitive(w: &mut Buffer, cx: &Context, it: &clean::Item, cache: &Cache) {\n-    document(w, cx, it);\n+    document(w, cx, it, None);\n     render_assoc_items(w, cx, it, it.def_id, AssocItemRender::All, cache)\n }\n \n fn item_keyword(w: &mut Buffer, cx: &Context, it: &clean::Item) {\n-    document(w, cx, it)\n+    document(w, cx, it, None)\n }\n \n crate const BASIC_KEYWORDS: &str = \"rust, rustlang, rust-lang\";"}, {"sha": "633df661be02642182a8de54e0f9e76e3d3c3b8d", "filename": "src/test/rustdoc/doc-cfg-simplification.rs", "status": "added", "additions": 182, "deletions": 0, "changes": 182, "blob_url": "https://github.com/rust-lang/rust/blob/71b0ea62354686553d180ad6f192c234c97501f2/src%2Ftest%2Frustdoc%2Fdoc-cfg-simplification.rs", "raw_url": "https://github.com/rust-lang/rust/raw/71b0ea62354686553d180ad6f192c234c97501f2/src%2Ftest%2Frustdoc%2Fdoc-cfg-simplification.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fdoc-cfg-simplification.rs?ref=71b0ea62354686553d180ad6f192c234c97501f2", "patch": "@@ -0,0 +1,182 @@\n+#![crate_name = \"globuliferous\"]\n+#![feature(doc_cfg)]\n+\n+// @has 'globuliferous/index.html'\n+// @count   - '//*[@class=\"stab portability\"]' 1\n+// @matches - '//*[@class=\"stab portability\"]' '^ratel$'\n+\n+// @has 'globuliferous/ratel/index.html'\n+// @count   - '//*[@class=\"stab portability\"]' 8\n+// @matches - '//*[@class=\"stab portability\"]' 'crate feature ratel'\n+// @matches - '//*[@class=\"stab portability\"]' '^zoonosology$'\n+// @matches - '//*[@class=\"stab portability\"]' '^yusho$'\n+// @matches - '//*[@class=\"stab portability\"]' '^nunciative$'\n+// @matches - '//*[@class=\"stab portability\"]' '^thionic$'\n+// @matches - '//*[@class=\"stab portability\"]' '^zincic$'\n+// @matches - '//*[@class=\"stab portability\"]' '^cosmotellurian$'\n+// @matches - '//*[@class=\"stab portability\"]' '^aposiopesis$'\n+#[doc(cfg(feature = \"ratel\"))]\n+pub mod ratel {\n+    // @has 'globuliferous/ratel/fn.ovicide.html'\n+    // @count   - '//*[@class=\"stab portability\"]' 1\n+    // @matches - '//*[@class=\"stab portability\"]' 'crate feature ratel'\n+    pub fn ovicide() {}\n+\n+    // @has 'globuliferous/ratel/fn.zoonosology.html'\n+    // @count   - '//*[@class=\"stab portability\"]' 1\n+    // @matches - '//*[@class=\"stab portability\"]' 'crate features ratel and zoonosology'\n+    #[doc(cfg(feature = \"zoonosology\"))]\n+    pub fn zoonosology() {}\n+\n+    // @has 'globuliferous/ratel/constant.DIAGRAPHICS.html'\n+    // @count   - '//*[@class=\"stab portability\"]' 1\n+    // @matches - '//*[@class=\"stab portability\"]' 'crate feature ratel'\n+    pub const DIAGRAPHICS: () = ();\n+\n+    // @has 'globuliferous/ratel/constant.YUSHO.html'\n+    // @count   - '//*[@class=\"stab portability\"]' 1\n+    // @matches - '//*[@class=\"stab portability\"]' 'crate features ratel and yusho'\n+    #[doc(cfg(feature = \"yusho\"))]\n+    pub const YUSHO: () = ();\n+\n+    // @has 'globuliferous/ratel/static.KEYBUGLE.html'\n+    // @count   - '//*[@class=\"stab portability\"]' 1\n+    // @matches - '//*[@class=\"stab portability\"]' 'crate feature ratel'\n+    pub static KEYBUGLE: () = ();\n+\n+    // @has 'globuliferous/ratel/static.NUNCIATIVE.html'\n+    // @count   - '//*[@class=\"stab portability\"]' 1\n+    // @matches - '//*[@class=\"stab portability\"]' 'crate features ratel and nunciative'\n+    #[doc(cfg(feature = \"nunciative\"))]\n+    pub static NUNCIATIVE: () = ();\n+\n+    // @has 'globuliferous/ratel/type.Wrick.html'\n+    // @count   - '//*[@class=\"stab portability\"]' 1\n+    // @matches - '//*[@class=\"stab portability\"]' 'crate feature ratel'\n+    pub type Wrick = ();\n+\n+    // @has 'globuliferous/ratel/type.Thionic.html'\n+    // @count   - '//*[@class=\"stab portability\"]' 1\n+    // @matches - '//*[@class=\"stab portability\"]' 'crate features ratel and thionic'\n+    #[doc(cfg(feature = \"thionic\"))]\n+    pub type Thionic = ();\n+\n+    // @has 'globuliferous/ratel/struct.Eventration.html'\n+    // @count   - '//*[@class=\"stab portability\"]' 1\n+    // @matches - '//*[@class=\"stab portability\"]' 'crate feature ratel'\n+    pub struct Eventration;\n+\n+    // @has 'globuliferous/ratel/struct.Zincic.html'\n+    // @count   - '//*[@class=\"stab portability\"]' 2\n+    // @matches - '//*[@class=\"stab portability\"]' 'crate features ratel and zincic'\n+    // @matches - '//*[@class=\"stab portability\"]' 'crate feature rutherford'\n+    #[doc(cfg(feature = \"zincic\"))]\n+    pub struct Zincic {\n+        pub rectigrade: (),\n+\n+        #[doc(cfg(feature = \"rutherford\"))]\n+        pub rutherford: (),\n+    }\n+\n+    // @has 'globuliferous/ratel/enum.Cosmotellurian.html'\n+    // @count   - '//*[@class=\"stab portability\"]' 10\n+    // @matches - '//*[@class=\"stab portability\"]' 'crate features ratel and cosmotellurian'\n+    // @matches - '//*[@class=\"stab portability\"]' 'crate feature biotaxy'\n+    // @matches - '//*[@class=\"stab portability\"]' 'crate feature xiphopagus'\n+    // @matches - '//*[@class=\"stab portability\"]' 'crate feature juxtapositive'\n+    // @matches - '//*[@class=\"stab portability\"]' 'crate feature fuero'\n+    // @matches - '//*[@class=\"stab portability\"]' 'crate feature palaeophile'\n+    // @matches - '//*[@class=\"stab portability\"]' 'crate feature broadcloth'\n+    // @matches - '//*[@class=\"stab portability\"]' 'crate features broadcloth and xanthocomic'\n+    // @matches - '//*[@class=\"stab portability\"]' 'crate feature broadcloth'\n+    // @matches - '//*[@class=\"stab portability\"]' 'crate features broadcloth and whosoever'\n+    #[doc(cfg(feature = \"cosmotellurian\"))]\n+    pub enum Cosmotellurian {\n+        Groundsel {\n+            jagger: (),\n+\n+            #[doc(cfg(feature = \"xiphopagus\"))]\n+            xiphopagus: (),\n+        },\n+\n+        #[doc(cfg(feature = \"biotaxy\"))]\n+        Biotaxy {\n+            glossography: (),\n+\n+            #[doc(cfg(feature = \"juxtapositive\"))]\n+            juxtapositive: (),\n+        },\n+    }\n+\n+    impl Cosmotellurian {\n+        pub fn uxoricide() {}\n+\n+        #[doc(cfg(feature = \"fuero\"))]\n+        pub fn fuero() {}\n+\n+        pub const MAMELLE: () = ();\n+\n+        #[doc(cfg(feature = \"palaeophile\"))]\n+        pub const PALAEOPHILE: () = ();\n+    }\n+\n+    #[doc(cfg(feature = \"broadcloth\"))]\n+    impl Cosmotellurian {\n+        pub fn trabeculated() {}\n+\n+        #[doc(cfg(feature = \"xanthocomic\"))]\n+        pub fn xanthocomic() {}\n+\n+        pub const BRACHIFEROUS: () = ();\n+\n+        #[doc(cfg(feature = \"whosoever\"))]\n+        pub const WHOSOEVER: () = ();\n+    }\n+\n+    // @has 'globuliferous/ratel/trait.Gnotobiology.html'\n+    // @count   - '//*[@class=\"stab portability\"]' 4\n+    // @matches - '//*[@class=\"stab portability\"]' 'crate feature ratel'\n+    // @matches - '//*[@class=\"stab portability\"]' 'crate feature unzymotic'\n+    // @matches - '//*[@class=\"stab portability\"]' 'crate feature summate'\n+    // @matches - '//*[@class=\"stab portability\"]' 'crate feature unctuous'\n+    pub trait Gnotobiology {\n+        const XYLOTHERAPY: ();\n+\n+        #[doc(cfg(feature = \"unzymotic\"))]\n+        const UNZYMOTIC: ();\n+\n+        type Lepadoid;\n+\n+        #[doc(cfg(feature = \"summate\"))]\n+        type Summate;\n+\n+        fn decalcomania();\n+\n+        #[doc(cfg(feature = \"unctuous\"))]\n+        fn unctuous();\n+    }\n+\n+    // @has 'globuliferous/ratel/trait.Aposiopesis.html'\n+    // @count   - '//*[@class=\"stab portability\"]' 4\n+    // @matches - '//*[@class=\"stab portability\"]' 'crate features ratel and aposiopesis'\n+    // @matches - '//*[@class=\"stab portability\"]' 'crate feature umbracious'\n+    // @matches - '//*[@class=\"stab portability\"]' 'crate feature uakari'\n+    // @matches - '//*[@class=\"stab portability\"]' 'crate feature rotograph'\n+    #[doc(cfg(feature = \"aposiopesis\"))]\n+    pub trait Aposiopesis {\n+        const REDHIBITION: ();\n+\n+        #[doc(cfg(feature = \"umbracious\"))]\n+        const UMBRACIOUS: ();\n+\n+        type Ophthalmoscope;\n+\n+        #[doc(cfg(feature = \"uakari\"))]\n+        type Uakari;\n+\n+        fn meseems();\n+\n+        #[doc(cfg(feature = \"rotograph\"))]\n+        fn rotograph();\n+    }\n+}"}, {"sha": "d7041ee2f1af82de5d990fd67e75306e17100fb3", "filename": "src/test/rustdoc/doc-cfg.rs", "status": "modified", "additions": 3, "deletions": 4, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/71b0ea62354686553d180ad6f192c234c97501f2/src%2Ftest%2Frustdoc%2Fdoc-cfg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/71b0ea62354686553d180ad6f192c234c97501f2/src%2Ftest%2Frustdoc%2Fdoc-cfg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fdoc-cfg.rs?ref=71b0ea62354686553d180ad6f192c234c97501f2", "patch": "@@ -10,9 +10,8 @@ pub struct Portable;\n // @has doc_cfg/unix_only/index.html \\\n //  '//*[@id=\"main\"]/*[@class=\"stability\"]/*[@class=\"stab portability\"]' \\\n //  'This is supported on Unix only.'\n-// @matches - '//*[@class=\"module-item\"]//*[@class=\"stab portability\"]' '\\AUnix\\Z'\n-// @matches - '//*[@class=\"module-item\"]//*[@class=\"stab portability\"]' '\\AUnix and ARM\\Z'\n-// @count - '//*[@class=\"stab portability\"]' 3\n+// @matches - '//*[@class=\"module-item\"]//*[@class=\"stab portability\"]' '\\AARM\\Z'\n+// @count - '//*[@class=\"stab portability\"]' 2\n #[doc(cfg(unix))]\n pub mod unix_only {\n     // @has doc_cfg/unix_only/fn.unix_only_function.html \\\n@@ -26,7 +25,7 @@ pub mod unix_only {\n     // @has doc_cfg/unix_only/trait.ArmOnly.html \\\n     //  '//*[@id=\"main\"]/*[@class=\"stability\"]/*[@class=\"stab portability\"]' \\\n     //  'This is supported on Unix and ARM only.'\n-    // @count - '//*[@class=\"stab portability\"]' 3\n+    // @count - '//*[@class=\"stab portability\"]' 2\n     #[doc(cfg(target_arch = \"arm\"))]\n     pub trait ArmOnly {\n         fn unix_and_arm_only_function();"}, {"sha": "7b938af3c7d5017f94c2ef464932eb5e497eb63f", "filename": "src/test/rustdoc/duplicate-cfg.rs", "status": "modified", "additions": 11, "deletions": 15, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/71b0ea62354686553d180ad6f192c234c97501f2/src%2Ftest%2Frustdoc%2Fduplicate-cfg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/71b0ea62354686553d180ad6f192c234c97501f2/src%2Ftest%2Frustdoc%2Fduplicate-cfg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fduplicate-cfg.rs?ref=71b0ea62354686553d180ad6f192c234c97501f2", "patch": "@@ -14,45 +14,41 @@\n pub struct Foo;\n \n // @has 'foo/bar/index.html'\n-// @matches '-' '//*[@class=\"module-item\"]//*[@class=\"stab portability\"]' '^sync$'\n-// @has '-' '//*[@class=\"module-item\"]//*[@class=\"stab portability\"]/@title' 'This is supported on crate feature `sync` only'\n-\n-// @has 'foo/bar/struct.Bar.html'\n // @has '-' '//*[@class=\"stab portability\"]' 'This is supported on crate feature sync only.'\n #[doc(cfg(feature = \"sync\"))]\n pub mod bar {\n+    // @has 'foo/bar/struct.Bar.html'\n+    // @has '-' '//*[@class=\"stab portability\"]' 'This is supported on crate feature sync only.'\n     #[doc(cfg(feature = \"sync\"))]\n     pub struct Bar;\n }\n \n // @has 'foo/baz/index.html'\n-// @matches '-' '//*[@class=\"module-item\"]//*[@class=\"stab portability\"]' '^sync and send$'\n-// @has '-' '//*[@class=\"module-item\"]//*[@class=\"stab portability\"]/@title' 'This is supported on crate features `sync` and `send` only'\n-\n-// @has 'foo/baz/struct.Baz.html'\n // @has '-' '//*[@class=\"stab portability\"]' 'This is supported on crate features sync and send only.'\n #[doc(cfg(all(feature = \"sync\", feature = \"send\")))]\n pub mod baz {\n+    // @has 'foo/baz/struct.Baz.html'\n+    // @has '-' '//*[@class=\"stab portability\"]' 'This is supported on crate features sync and send only.'\n     #[doc(cfg(feature = \"sync\"))]\n     pub struct Baz;\n }\n \n-// @has 'foo/qux/struct.Qux.html'\n-// @has '-' '//*[@class=\"stab portability\"]' 'This is supported on crate features sync and send only.'\n+// @has 'foo/qux/index.html'\n+// @has '-' '//*[@class=\"stab portability\"]' 'This is supported on crate feature sync only.'\n #[doc(cfg(feature = \"sync\"))]\n pub mod qux {\n+    // @has 'foo/qux/struct.Qux.html'\n+    // @has '-' '//*[@class=\"stab portability\"]' 'This is supported on crate features sync and send only.'\n     #[doc(cfg(all(feature = \"sync\", feature = \"send\")))]\n     pub struct Qux;\n }\n \n // @has 'foo/quux/index.html'\n-// @matches '-' '//*[@class=\"module-item\"]//*[@class=\"stab portability\"]' '^sync and send and foo and bar$'\n-// @has '-' '//*[@class=\"module-item\"]//*[@class=\"stab portability\"]/@title' 'This is supported on crate feature `sync` and crate feature `send` and `foo` and `bar` only'\n-\n-// @has 'foo/quux/struct.Quux.html'\n-// @has '-' '//*[@class=\"stab portability\"]' 'This is supported on crate feature sync and crate feature send and foo and bar only.'\n+// @has '-' '//*[@class=\"stab portability\"]' 'This is supported on crate feature sync and crate feature send and foo only.'\n #[doc(cfg(all(feature = \"sync\", feature = \"send\", foo)))]\n pub mod quux {\n+    // @has 'foo/quux/struct.Quux.html'\n+    // @has '-' '//*[@class=\"stab portability\"]' 'This is supported on crate feature sync and crate feature send and foo and bar only.'\n     #[doc(cfg(all(feature = \"send\", feature = \"sync\", bar)))]\n     pub struct Quux;\n }"}]}