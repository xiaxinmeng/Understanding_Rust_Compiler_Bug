{"sha": "9aa24fd8fb6f59381f7c3af8a8b13e6bd5274828", "node_id": "C_kwDOAAsO6NoAKDlhYTI0ZmQ4ZmI2ZjU5MzgxZjdjM2FmOGE4YjEzZTZiZDUyNzQ4Mjg", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2023-04-14T14:00:33Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-04-14T14:00:33Z"}, "message": "Rollup merge of #103682 - Swatinem:stable-run-directory, r=GuillaumeGomez\n\nStabilize rustdoc `--test-run-directory`\n\nThis should resolve https://github.com/rust-lang/rust/issues/84674", "tree": {"sha": "d639ebe7dbad34a58ee67d9a8eb42946c130fc03", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d639ebe7dbad34a58ee67d9a8eb42946c130fc03"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9aa24fd8fb6f59381f7c3af8a8b13e6bd5274828", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkOVyBCRBK7hj4Ov3rIwAAp80IAAn7kZYfuXb9zDXiD4Wb1J4F\nyx2D8kq8TVnqM5xw3ej9DdqvNLL4/irtKK4Zq3FQCUUgm6OXhK1UIF9SBYAQzlHO\n8nyV4CXhayyvfO336MjwWt3DsgPfEdm4voG2+os0eXFaDkpbuqDnA8oWKM8z0Ep4\nnWoJIi9TUtSGTEnErxigC79ESzbolzg9U71wkalA/yB8MgbiKLZWwYctiwOajfIg\npv4iKd2RMw+1X26eVxbe9YxxKAYzHLpi0GnPInKO62fs/TxNbRyZDLZVAVKuG8xO\nBIDJRuyuQ2B1H1nhqm8IDiCxCyiz6Y7RKV/o6ugljLRReZtnEqyD0OT1r9/sFPg=\n=8waN\n-----END PGP SIGNATURE-----\n", "payload": "tree d639ebe7dbad34a58ee67d9a8eb42946c130fc03\nparent 3e565f1a27a19f7da48c7109500b4351c0819e68\nparent 2e924bbef303ee8fc610e49d81825c2263b0b4bf\nauthor Yuki Okushi <jtitor@2k36.org> 1681480833 +0900\ncommitter GitHub <noreply@github.com> 1681480833 +0900\n\nRollup merge of #103682 - Swatinem:stable-run-directory, r=GuillaumeGomez\n\nStabilize rustdoc `--test-run-directory`\n\nThis should resolve https://github.com/rust-lang/rust/issues/84674\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9aa24fd8fb6f59381f7c3af8a8b13e6bd5274828", "html_url": "https://github.com/rust-lang/rust/commit/9aa24fd8fb6f59381f7c3af8a8b13e6bd5274828", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9aa24fd8fb6f59381f7c3af8a8b13e6bd5274828/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3e565f1a27a19f7da48c7109500b4351c0819e68", "url": "https://api.github.com/repos/rust-lang/rust/commits/3e565f1a27a19f7da48c7109500b4351c0819e68", "html_url": "https://github.com/rust-lang/rust/commit/3e565f1a27a19f7da48c7109500b4351c0819e68"}, {"sha": "2e924bbef303ee8fc610e49d81825c2263b0b4bf", "url": "https://api.github.com/repos/rust-lang/rust/commits/2e924bbef303ee8fc610e49d81825c2263b0b4bf", "html_url": "https://github.com/rust-lang/rust/commit/2e924bbef303ee8fc610e49d81825c2263b0b4bf"}], "stats": {"total": 33, "additions": 29, "deletions": 4}, "files": [{"sha": "b46d80eb362e26209328ba6e045a33e7c586435e", "filename": "src/doc/rustdoc/src/command-line-arguments.md", "status": "modified", "additions": 14, "deletions": 1, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/9aa24fd8fb6f59381f7c3af8a8b13e6bd5274828/src%2Fdoc%2Frustdoc%2Fsrc%2Fcommand-line-arguments.md", "raw_url": "https://github.com/rust-lang/rust/raw/9aa24fd8fb6f59381f7c3af8a8b13e6bd5274828/src%2Fdoc%2Frustdoc%2Fsrc%2Fcommand-line-arguments.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Frustdoc%2Fsrc%2Fcommand-line-arguments.md?ref=9aa24fd8fb6f59381f7c3af8a8b13e6bd5274828", "patch": "@@ -179,7 +179,7 @@ $ rustdoc src/lib.rs --test\n This flag will run your code examples as tests. For more, see [the chapter\n on documentation tests](write-documentation/documentation-tests.md).\n \n-See also `--test-args`.\n+See also `--test-args` and `--test-run-directory`.\n \n ## `--test-args`: pass options to test runner\n \n@@ -194,6 +194,19 @@ For more, see [the chapter on documentation tests](write-documentation/documenta\n \n See also `--test`.\n \n+## `--test-run-directory`: run code examples in a specific directory\n+\n+Using this flag looks like this:\n+\n+```bash\n+$ rustdoc src/lib.rs --test --test-run-directory=/path/to/working/directory\n+```\n+\n+This flag will run your code examples in the specified working directory.\n+For more, see [the chapter on documentation tests](write-documentation/documentation-tests.md).\n+\n+See also `--test`.\n+\n ## `--target`: generate documentation for the specified target triple\n \n Using this flag looks like this:"}, {"sha": "a7d3186fb78b7afcea61203d90046840fa405aa2", "filename": "src/doc/rustdoc/src/write-documentation/documentation-tests.md", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/9aa24fd8fb6f59381f7c3af8a8b13e6bd5274828/src%2Fdoc%2Frustdoc%2Fsrc%2Fwrite-documentation%2Fdocumentation-tests.md", "raw_url": "https://github.com/rust-lang/rust/raw/9aa24fd8fb6f59381f7c3af8a8b13e6bd5274828/src%2Fdoc%2Frustdoc%2Fsrc%2Fwrite-documentation%2Fdocumentation-tests.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Frustdoc%2Fsrc%2Fwrite-documentation%2Fdocumentation-tests.md?ref=9aa24fd8fb6f59381f7c3af8a8b13e6bd5274828", "patch": "@@ -443,3 +443,15 @@ pub struct ReadmeDoctests;\n \n This will include your README as documentation on the hidden struct `ReadmeDoctests`, which will\n then be tested alongside the rest of your doctests.\n+\n+## Controlling the compilation and run directories\n+\n+By default, `rustdoc --test` will compile and run documentation test examples\n+from the same working directory.\n+The compilation directory is being used for compiler diagnostics, the `file!()` macro and\n+the output of `rustdoc` test runner itself, whereas the run directory has an influence on file-system\n+operations within documentation test examples, such as `std::fs::read_to_string`.\n+\n+The `--test-run-directory` flag allows controlling the run directory separately from the compilation directory.\n+This is particularly useful in workspaces, where compiler invocations and thus diagnostics should be\n+relative to the workspace directory, but documentation test examples should run relative to the crate directory."}, {"sha": "60c98cc3831bd8cf9b10626e783dcead1aec43b5", "filename": "src/librustdoc/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/9aa24fd8fb6f59381f7c3af8a8b13e6bd5274828/src%2Flibrustdoc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9aa24fd8fb6f59381f7c3af8a8b13e6bd5274828/src%2Flibrustdoc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Flib.rs?ref=9aa24fd8fb6f59381f7c3af8a8b13e6bd5274828", "patch": "@@ -284,7 +284,7 @@ fn opts() -> Vec<RustcOptGroup> {\n         stable(\"test-args\", |o| {\n             o.optmulti(\"\", \"test-args\", \"arguments to pass to the test runner\", \"ARGS\")\n         }),\n-        unstable(\"test-run-directory\", |o| {\n+        stable(\"test-run-directory\", |o| {\n             o.optopt(\n                 \"\",\n                 \"test-run-directory\","}, {"sha": "b8d0647f08d8e0d8a35e70f78febb154da8fa0ab", "filename": "tests/rustdoc-ui/run-directory.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/9aa24fd8fb6f59381f7c3af8a8b13e6bd5274828/tests%2Frustdoc-ui%2Frun-directory.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9aa24fd8fb6f59381f7c3af8a8b13e6bd5274828/tests%2Frustdoc-ui%2Frun-directory.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frustdoc-ui%2Frun-directory.rs?ref=9aa24fd8fb6f59381f7c3af8a8b13e6bd5274828", "patch": "@@ -2,8 +2,8 @@\n \n // revisions: correct incorrect\n // check-pass\n-// [correct]compile-flags:--test --test-run-directory={{src-base}} -Zunstable-options\n-// [incorrect]compile-flags:--test --test-run-directory={{src-base}}/coverage -Zunstable-options\n+// [correct]compile-flags:--test --test-run-directory={{src-base}}\n+// [incorrect]compile-flags:--test --test-run-directory={{src-base}}/coverage\n // normalize-stdout-test: \"tests/rustdoc-ui\" -> \"$$DIR\"\n // normalize-stdout-test \"finished in \\d+\\.\\d+s\" -> \"finished in $$TIME\"\n "}]}