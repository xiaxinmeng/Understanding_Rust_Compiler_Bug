{"sha": "54bb4fec68cb592e23077896baea072919721573", "node_id": "C_kwDOAAsO6NoAKDU0YmI0ZmVjNjhjYjU5MmUyMzA3Nzg5NmJhZWEwNzI5MTk3MjE1NzM", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-10-08T18:12:50Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-10-08T18:12:50Z"}, "message": "Auto merge of #89666 - rusticstuff:disable_new_llvm_pass_manager_on_s390x_take_two, r=nagisa\n\nDefault to disabling the new pass manager for the s390x arch targets.\n\nThis hack disables the new LLVM pass manager by default for s390x arch targets until the performance issues are fixed (see #89609). The command line option `-Z new-llvm-pass-manager=(yes|no)` continues to take precedence over this default.", "tree": {"sha": "3b83e54ffa6e0edc726afdbea13d300ecaf914ed", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3b83e54ffa6e0edc726afdbea13d300ecaf914ed"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/54bb4fec68cb592e23077896baea072919721573", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/54bb4fec68cb592e23077896baea072919721573", "html_url": "https://github.com/rust-lang/rust/commit/54bb4fec68cb592e23077896baea072919721573", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/54bb4fec68cb592e23077896baea072919721573/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "87df4dd70f13f248a4d2d22cdd96ee59d161d741", "url": "https://api.github.com/repos/rust-lang/rust/commits/87df4dd70f13f248a4d2d22cdd96ee59d161d741", "html_url": "https://github.com/rust-lang/rust/commit/87df4dd70f13f248a4d2d22cdd96ee59d161d741"}, {"sha": "4593d78e96253ccf8440605f8db49c09ece48b8c", "url": "https://api.github.com/repos/rust-lang/rust/commits/4593d78e96253ccf8440605f8db49c09ece48b8c", "html_url": "https://github.com/rust-lang/rust/commit/4593d78e96253ccf8440605f8db49c09ece48b8c"}], "stats": {"total": 17, "additions": 13, "deletions": 4}, "files": [{"sha": "97780de9ba4af4d4e9ae0374f835d82cb11a0ffd", "filename": "compiler/rustc_codegen_llvm/src/back/lto.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/54bb4fec68cb592e23077896baea072919721573/compiler%2Frustc_codegen_llvm%2Fsrc%2Fback%2Flto.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54bb4fec68cb592e23077896baea072919721573/compiler%2Frustc_codegen_llvm%2Fsrc%2Fback%2Flto.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fback%2Flto.rs?ref=54bb4fec68cb592e23077896baea072919721573", "patch": "@@ -596,7 +596,7 @@ pub(crate) fn run_pass_manager(\n     //      tools/lto/LTOCodeGenerator.cpp\n     debug!(\"running the pass manager\");\n     unsafe {\n-        if write::should_use_new_llvm_pass_manager(config) {\n+        if write::should_use_new_llvm_pass_manager(cgcx, config) {\n             let opt_stage = if thin { llvm::OptStage::ThinLTO } else { llvm::OptStage::FatLTO };\n             let opt_level = config.opt_level.unwrap_or(config::OptLevel::No);\n             write::optimize_with_new_llvm_pass_manager("}, {"sha": "380dfd387235d1b6037c193db8aefdf8a7d7aa22", "filename": "compiler/rustc_codegen_llvm/src/back/write.rs", "status": "modified", "additions": 12, "deletions": 3, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/54bb4fec68cb592e23077896baea072919721573/compiler%2Frustc_codegen_llvm%2Fsrc%2Fback%2Fwrite.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54bb4fec68cb592e23077896baea072919721573/compiler%2Frustc_codegen_llvm%2Fsrc%2Fback%2Fwrite.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fback%2Fwrite.rs?ref=54bb4fec68cb592e23077896baea072919721573", "patch": "@@ -377,10 +377,19 @@ fn get_pgo_sample_use_path(config: &ModuleConfig) -> Option<CString> {\n         .map(|path_buf| CString::new(path_buf.to_string_lossy().as_bytes()).unwrap())\n }\n \n-pub(crate) fn should_use_new_llvm_pass_manager(config: &ModuleConfig) -> bool {\n+pub(crate) fn should_use_new_llvm_pass_manager(\n+    cgcx: &CodegenContext<LlvmCodegenBackend>,\n+    config: &ModuleConfig,\n+) -> bool {\n     // The new pass manager is enabled by default for LLVM >= 13.\n     // This matches Clang, which also enables it since Clang 13.\n-    config.new_llvm_pass_manager.unwrap_or_else(|| llvm_util::get_version() >= (13, 0, 0))\n+\n+    // FIXME: There are some perf issues with the new pass manager\n+    // when targeting s390x, so it is temporarily disabled for that\n+    // arch, see https://github.com/rust-lang/rust/issues/89609\n+    config\n+        .new_llvm_pass_manager\n+        .unwrap_or_else(|| cgcx.target_arch != \"s390x\" && llvm_util::get_version() >= (13, 0, 0))\n }\n \n pub(crate) unsafe fn optimize_with_new_llvm_pass_manager(\n@@ -482,7 +491,7 @@ pub(crate) unsafe fn optimize(\n     }\n \n     if let Some(opt_level) = config.opt_level {\n-        if should_use_new_llvm_pass_manager(config) {\n+        if should_use_new_llvm_pass_manager(cgcx, config) {\n             let opt_stage = match cgcx.lto {\n                 Lto::Fat => llvm::OptStage::PreLinkFatLTO,\n                 Lto::Thin | Lto::ThinLocal => llvm::OptStage::PreLinkThinLTO,"}]}