{"sha": "420f9a34897d0696687891b7970b3c7680bd2783", "node_id": "C_kwDOAAsO6NoAKDQyMGY5YTM0ODk3ZDA2OTY2ODc4OTFiNzk3MGIzYzc2ODBiZDI3ODM", "commit": {"author": {"name": "SparrowLii", "email": "liyuan179@huawei.com", "date": "2022-05-18T12:58:11Z"}, "committer": {"name": "SparrowLii", "email": "liyuan179@huawei.com", "date": "2022-05-18T12:58:11Z"}, "message": "move processing of `source_scope_data` into `MutVisitor`'s impl of Integrator when inline mir-opt", "tree": {"sha": "256014748438e252ff04d1121dfadc23995fedba", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/256014748438e252ff04d1121dfadc23995fedba"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/420f9a34897d0696687891b7970b3c7680bd2783", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/420f9a34897d0696687891b7970b3c7680bd2783", "html_url": "https://github.com/rust-lang/rust/commit/420f9a34897d0696687891b7970b3c7680bd2783", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/420f9a34897d0696687891b7970b3c7680bd2783/comments", "author": {"login": "SparrowLii", "id": 68270294, "node_id": "MDQ6VXNlcjY4MjcwMjk0", "avatar_url": "https://avatars.githubusercontent.com/u/68270294?v=4", "gravatar_id": "", "url": "https://api.github.com/users/SparrowLii", "html_url": "https://github.com/SparrowLii", "followers_url": "https://api.github.com/users/SparrowLii/followers", "following_url": "https://api.github.com/users/SparrowLii/following{/other_user}", "gists_url": "https://api.github.com/users/SparrowLii/gists{/gist_id}", "starred_url": "https://api.github.com/users/SparrowLii/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/SparrowLii/subscriptions", "organizations_url": "https://api.github.com/users/SparrowLii/orgs", "repos_url": "https://api.github.com/users/SparrowLii/repos", "events_url": "https://api.github.com/users/SparrowLii/events{/privacy}", "received_events_url": "https://api.github.com/users/SparrowLii/received_events", "type": "User", "site_admin": false}, "committer": {"login": "SparrowLii", "id": 68270294, "node_id": "MDQ6VXNlcjY4MjcwMjk0", "avatar_url": "https://avatars.githubusercontent.com/u/68270294?v=4", "gravatar_id": "", "url": "https://api.github.com/users/SparrowLii", "html_url": "https://github.com/SparrowLii", "followers_url": "https://api.github.com/users/SparrowLii/followers", "following_url": "https://api.github.com/users/SparrowLii/following{/other_user}", "gists_url": "https://api.github.com/users/SparrowLii/gists{/gist_id}", "starred_url": "https://api.github.com/users/SparrowLii/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/SparrowLii/subscriptions", "organizations_url": "https://api.github.com/users/SparrowLii/orgs", "repos_url": "https://api.github.com/users/SparrowLii/repos", "events_url": "https://api.github.com/users/SparrowLii/events{/privacy}", "received_events_url": "https://api.github.com/users/SparrowLii/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "56d540e0571ac1b0633ce10644224c495aaf42a0", "url": "https://api.github.com/repos/rust-lang/rust/commits/56d540e0571ac1b0633ce10644224c495aaf42a0", "html_url": "https://github.com/rust-lang/rust/commit/56d540e0571ac1b0633ce10644224c495aaf42a0"}], "stats": {"total": 55, "additions": 27, "deletions": 28}, "files": [{"sha": "4193c5779f96d4f1458d1cc1c5244464c5489170", "filename": "compiler/rustc_mir_transform/src/inline.rs", "status": "modified", "additions": 27, "deletions": 28, "changes": 55, "blob_url": "https://github.com/rust-lang/rust/blob/420f9a34897d0696687891b7970b3c7680bd2783/compiler%2Frustc_mir_transform%2Fsrc%2Finline.rs", "raw_url": "https://github.com/rust-lang/rust/raw/420f9a34897d0696687891b7970b3c7680bd2783/compiler%2Frustc_mir_transform%2Fsrc%2Finline.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_transform%2Fsrc%2Finline.rs?ref=420f9a34897d0696687891b7970b3c7680bd2783", "patch": "@@ -555,7 +555,8 @@ impl<'tcx> Inliner<'tcx> {\n                     new_scopes: SourceScope::new(caller_body.source_scopes.len())..,\n                     new_blocks: BasicBlock::new(caller_body.basic_blocks().len())..,\n                     destination: dest,\n-                    return_block: callsite.target,\n+                    callsite_scope: caller_body.source_scopes[callsite.source_info.scope].clone(),\n+                    callsite,\n                     cleanup_block: cleanup,\n                     in_cleanup_block: false,\n                     tcx: self.tcx,\n@@ -567,31 +568,6 @@ impl<'tcx> Inliner<'tcx> {\n                 // (or existing ones, in a few special cases) in the caller.\n                 integrator.visit_body(&mut callee_body);\n \n-                for scope in &mut callee_body.source_scopes {\n-                    // FIXME(eddyb) move this into a `fn visit_scope_data` in `Integrator`.\n-                    if scope.parent_scope.is_none() {\n-                        let callsite_scope = &caller_body.source_scopes[callsite.source_info.scope];\n-\n-                        // Attach the outermost callee scope as a child of the callsite\n-                        // scope, via the `parent_scope` and `inlined_parent_scope` chains.\n-                        scope.parent_scope = Some(callsite.source_info.scope);\n-                        assert_eq!(scope.inlined_parent_scope, None);\n-                        scope.inlined_parent_scope = if callsite_scope.inlined.is_some() {\n-                            Some(callsite.source_info.scope)\n-                        } else {\n-                            callsite_scope.inlined_parent_scope\n-                        };\n-\n-                        // Mark the outermost callee scope as an inlined one.\n-                        assert_eq!(scope.inlined, None);\n-                        scope.inlined = Some((callsite.callee, callsite.source_info.span));\n-                    } else if scope.inlined_parent_scope.is_none() {\n-                        // Make it easy to find the scope with `inlined` set above.\n-                        scope.inlined_parent_scope =\n-                            Some(integrator.map_scope(OUTERMOST_SOURCE_SCOPE));\n-                    }\n-                }\n-\n                 // If there are any locals without storage markers, give them storage only for the\n                 // duration of the call.\n                 for local in callee_body.vars_and_temps_iter() {\n@@ -787,7 +763,8 @@ struct Integrator<'a, 'tcx> {\n     new_scopes: RangeFrom<SourceScope>,\n     new_blocks: RangeFrom<BasicBlock>,\n     destination: Place<'tcx>,\n-    return_block: Option<BasicBlock>,\n+    callsite_scope: SourceScopeData<'tcx>,\n+    callsite: &'a CallSite<'tcx>,\n     cleanup_block: Option<BasicBlock>,\n     in_cleanup_block: bool,\n     tcx: TyCtxt<'tcx>,\n@@ -833,6 +810,28 @@ impl<'tcx> MutVisitor<'tcx> for Integrator<'_, 'tcx> {\n         *local = self.map_local(*local);\n     }\n \n+    fn visit_source_scope_data(&mut self, scope_data: &mut SourceScopeData<'tcx>) {\n+        self.super_source_scope_data(scope_data);\n+        if scope_data.parent_scope.is_none() {\n+            // Attach the outermost callee scope as a child of the callsite\n+            // scope, via the `parent_scope` and `inlined_parent_scope` chains.\n+            scope_data.parent_scope = Some(self.callsite.source_info.scope);\n+            assert_eq!(scope_data.inlined_parent_scope, None);\n+            scope_data.inlined_parent_scope = if self.callsite_scope.inlined.is_some() {\n+                Some(self.callsite.source_info.scope)\n+            } else {\n+                self.callsite_scope.inlined_parent_scope\n+            };\n+\n+            // Mark the outermost callee scope as an inlined one.\n+            assert_eq!(scope_data.inlined, None);\n+            scope_data.inlined = Some((self.callsite.callee, self.callsite.source_info.span));\n+        } else if scope_data.inlined_parent_scope.is_none() {\n+            // Make it easy to find the scope with `inlined` set above.\n+            scope_data.inlined_parent_scope = Some(self.map_scope(OUTERMOST_SOURCE_SCOPE));\n+        }\n+    }\n+\n     fn visit_source_scope(&mut self, scope: &mut SourceScope) {\n         *scope = self.map_scope(*scope);\n     }\n@@ -939,7 +938,7 @@ impl<'tcx> MutVisitor<'tcx> for Integrator<'_, 'tcx> {\n                 }\n             }\n             TerminatorKind::Return => {\n-                terminator.kind = if let Some(tgt) = self.return_block {\n+                terminator.kind = if let Some(tgt) = self.callsite.target {\n                     TerminatorKind::Goto { target: tgt }\n                 } else {\n                     TerminatorKind::Unreachable"}]}