{"sha": "8da5f46fac3b869e3e6907b07a992fce12c2c760", "node_id": "C_kwDOAAsO6NoAKDhkYTVmNDZmYWMzYjg2OWUzZTY5MDdiMDdhOTkyZmNlMTJjMmM3NjA", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2022-01-01T21:20:55Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-01-01T21:20:55Z"}, "message": "Merge #11158\n\n11158: fix: Enable completions for `<_>::$0` r=Veykril a=Veykril\n\nFixes https://github.com/rust-analyzer/rust-analyzer/issues/10462\r\nbors r+\n\nCo-authored-by: Lukas Wirth <lukastw97@gmail.com>", "tree": {"sha": "099d8823c990efab2fe389d52c2b43186a2a1ea6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/099d8823c990efab2fe389d52c2b43186a2a1ea6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8da5f46fac3b869e3e6907b07a992fce12c2c760", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJh0MW3CRBK7hj4Ov3rIwAA5iAIAKZQ3/eVzjxcoqWpQGICz4vw\nVCl7CYDCoZDOl2CKxKl5h+wJtAVkqMGM4UG/g4mTvk8d5bNSv4mH//EoxP0BdOpK\nHOmtNmJ59HiDO2P567x4f+VgaHL689mVjz/UWfhW01C25SutA2auILKsUMc8oCvT\n+aGHOUr+sAd9BHvhPr5epL3wHhppHuOKCi3F1mxAM699jwwQMRFWjqIJMZGJQjYy\npqv5+5DH1HKY5VlxRTai5PHz16jSmXZ+f71n0OWV5a9eVJQmWAKFp+7PTYUrQc/F\nwJLjinX8ZlnI08gw71UdDpeOGJwHZpTBwPhxO+NXcu1haxyrKOgJ0OO20/8t9Ok=\n=sON5\n-----END PGP SIGNATURE-----\n", "payload": "tree 099d8823c990efab2fe389d52c2b43186a2a1ea6\nparent 55f3297e7820f7f4bdbbd30dc62c589e5f93225b\nparent 809461cc420648eb7d4d53effbff0216bd9196b4\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1641072055 +0000\ncommitter GitHub <noreply@github.com> 1641072055 +0000\n\nMerge #11158\n\n11158: fix: Enable completions for `<_>::$0` r=Veykril a=Veykril\n\nFixes https://github.com/rust-analyzer/rust-analyzer/issues/10462\r\nbors r+\n\nCo-authored-by: Lukas Wirth <lukastw97@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8da5f46fac3b869e3e6907b07a992fce12c2c760", "html_url": "https://github.com/rust-lang/rust/commit/8da5f46fac3b869e3e6907b07a992fce12c2c760", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8da5f46fac3b869e3e6907b07a992fce12c2c760/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "55f3297e7820f7f4bdbbd30dc62c589e5f93225b", "url": "https://api.github.com/repos/rust-lang/rust/commits/55f3297e7820f7f4bdbbd30dc62c589e5f93225b", "html_url": "https://github.com/rust-lang/rust/commit/55f3297e7820f7f4bdbbd30dc62c589e5f93225b"}, {"sha": "809461cc420648eb7d4d53effbff0216bd9196b4", "url": "https://api.github.com/repos/rust-lang/rust/commits/809461cc420648eb7d4d53effbff0216bd9196b4", "html_url": "https://github.com/rust-lang/rust/commit/809461cc420648eb7d4d53effbff0216bd9196b4"}], "stats": {"total": 45, "additions": 44, "deletions": 1}, "files": [{"sha": "2a89bd29faddeffeed07eca1ff785edca2c7e37c", "filename": "crates/ide_completion/src/completions/qualified_path.rs", "status": "modified", "additions": 44, "deletions": 1, "changes": 45, "blob_url": "https://github.com/rust-lang/rust/blob/8da5f46fac3b869e3e6907b07a992fce12c2c760/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fqualified_path.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8da5f46fac3b869e3e6907b07a992fce12c2c760/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fqualified_path.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fqualified_path.rs?ref=8da5f46fac3b869e3e6907b07a992fce12c2c760", "patch": "@@ -2,7 +2,7 @@\n \n use std::iter;\n \n-use hir::ScopeDef;\n+use hir::{ScopeDef, Trait};\n use rustc_hash::FxHashSet;\n use syntax::{ast, AstNode};\n \n@@ -27,6 +27,25 @@ pub(crate) fn complete_qualified_path(acc: &mut Completions, ctx: &CompletionCon\n         _ => return,\n     };\n \n+    // special case `<_>::$0` as this doesn't resolve to anything.\n+    if path.qualifier().is_none() {\n+        if matches!(\n+            path.segment().and_then(|it| it.kind()),\n+            Some(ast::PathSegmentKind::Type {\n+                type_ref: Some(ast::Type::InferType(_)),\n+                trait_ref: None,\n+            })\n+        ) {\n+            cov_mark::hit!(completion_type_anchor_empty);\n+            ctx.scope\n+                .visible_traits()\n+                .into_iter()\n+                .flat_map(|it| Trait::from(it).items(ctx.sema.db))\n+                .for_each(|item| add_assoc_item(acc, ctx, item));\n+            return;\n+        }\n+    }\n+\n     let resolution = match ctx.sema.resolve_path(path) {\n         Some(res) => res,\n         None => return,\n@@ -707,4 +726,28 @@ pub mod m {}\n             expect![[r#\"\"#]],\n         )\n     }\n+\n+    #[test]\n+    fn type_anchor_empty() {\n+        cov_mark::check!(completion_type_anchor_empty);\n+        check(\n+            r#\"\n+trait Foo {\n+    fn foo() -> Self;\n+}\n+struct Bar;\n+impl Foo for Bar {\n+    fn foo() -> {\n+        Bar\n+    }\n+}\n+fn bar() -> Bar {\n+    <_>::$0\n+}\n+\"#,\n+            expect![[r#\"\n+                fn foo() (as Foo) fn() -> Self\n+            \"#]],\n+        )\n+    }\n }"}]}