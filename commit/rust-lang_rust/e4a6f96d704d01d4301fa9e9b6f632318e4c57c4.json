{"sha": "e4a6f96d704d01d4301fa9e9b6f632318e4c57c4", "node_id": "MDY6Q29tbWl0NzI0NzEyOmU0YTZmOTZkNzA0ZDAxZDQzMDFmYTllOWI2ZjYzMjMxOGU0YzU3YzQ=", "commit": {"author": {"name": "Nick Cameron", "email": "nrc@ncameron.org", "date": "2015-07-15T22:08:36Z"}, "committer": {"name": "Nick Cameron", "email": "nrc@ncameron.org", "date": "2015-07-15T22:08:36Z"}, "message": "Merge pull request #128 from marcusklaas/subexpr\n\nFormat loops", "tree": {"sha": "d1806b28850885e7871086c6e35a64078051fc32", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d1806b28850885e7871086c6e35a64078051fc32"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e4a6f96d704d01d4301fa9e9b6f632318e4c57c4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e4a6f96d704d01d4301fa9e9b6f632318e4c57c4", "html_url": "https://github.com/rust-lang/rust/commit/e4a6f96d704d01d4301fa9e9b6f632318e4c57c4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e4a6f96d704d01d4301fa9e9b6f632318e4c57c4/comments", "author": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "337c5b5fba002fa8f7ab826102d0885f3648142c", "url": "https://api.github.com/repos/rust-lang/rust/commits/337c5b5fba002fa8f7ab826102d0885f3648142c", "html_url": "https://github.com/rust-lang/rust/commit/337c5b5fba002fa8f7ab826102d0885f3648142c"}, {"sha": "b473c2bd2a56a61275a47b95f75b0aff8fdb600a", "url": "https://api.github.com/repos/rust-lang/rust/commits/b473c2bd2a56a61275a47b95f75b0aff8fdb600a", "html_url": "https://github.com/rust-lang/rust/commit/b473c2bd2a56a61275a47b95f75b0aff8fdb600a"}], "stats": {"total": 69, "additions": 67, "deletions": 2}, "files": [{"sha": "4cce45e5eb3af31a4a0f4a2198f108244fc200da", "filename": "src/changes.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/e4a6f96d704d01d4301fa9e9b6f632318e4c57c4/src%2Fchanges.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e4a6f96d704d01d4301fa9e9b6f632318e4c57c4/src%2Fchanges.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fchanges.rs?ref=e4a6f96d704d01d4301fa9e9b6f632318e4c57c4", "patch": "@@ -99,6 +99,14 @@ impl<'a> ChangeSet<'a> {\n         self.push_str(&file_name, text)\n     }\n \n+    // Fetch the output buffer for the given file name.\n+    // Panics on unknown files.\n+    pub fn get(&mut self, file_name: &str) -> &StringBuffer {\n+        self.file_map.get(file_name).unwrap()\n+    }\n+\n+    // Fetch a mutable reference to the output buffer for the given file name.\n+    // Panics on unknown files.\n     pub fn get_mut(&mut self, file_name: &str) -> &mut StringBuffer {\n         self.file_map.get_mut(file_name).unwrap()\n     }"}, {"sha": "33a82da0f29ff4c9e8cfcfc7c535cd41cb8bd16c", "filename": "src/expr.rs", "status": "modified", "additions": 30, "deletions": 1, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/e4a6f96d704d01d4301fa9e9b6f632318e4c57c4/src%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e4a6f96d704d01d4301fa9e9b6f632318e4c57c4/src%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fexpr.rs?ref=e4a6f96d704d01d4301fa9e9b6f632318e4c57c4", "patch": "@@ -12,11 +12,13 @@ use rewrite::{Rewrite, RewriteContext};\n use lists::{write_list, itemize_list, ListFormatting, SeparatorTactic, ListTactic};\n use string::{StringFormat, rewrite_string};\n use utils::{span_after, make_indent};\n+use visitor::FmtVisitor;\n \n use syntax::{ast, ptr};\n-use syntax::codemap::{Pos, Span, BytePos};\n+use syntax::codemap::{Pos, Span, BytePos, mk_sp};\n use syntax::parse::token;\n use syntax::print::pprust;\n+use syntax::visit::Visitor;\n \n impl Rewrite for ast::Expr {\n     fn rewrite(&self, context: &RewriteContext, width: usize, offset: usize) -> Option<String> {\n@@ -53,11 +55,38 @@ impl Rewrite for ast::Expr {\n             ast::Expr_::ExprTup(ref items) => {\n                 rewrite_tuple_lit(context, items, self.span, width, offset)\n             }\n+            ast::Expr_::ExprLoop(ref block, _) => {\n+                // FIXME: this drops any comment between \"loop\" and the block.\n+                // TODO: format label\n+                block.rewrite(context, width, offset).map(|result| {\n+                    format!(\"loop {}\", result)\n+                })\n+            }\n             _ => context.codemap.span_to_snippet(self.span).ok()\n         }\n     }\n }\n \n+impl Rewrite for ast::Block {\n+    fn rewrite(&self, context: &RewriteContext, _: usize, _: usize) -> Option<String> {\n+        let mut visitor = FmtVisitor::from_codemap(context.codemap, context.config);\n+        visitor.last_pos = self.span.lo;\n+        visitor.block_indent = context.block_indent;\n+\n+        visitor.visit_block(self);\n+\n+        // Push text between last block item and end of block\n+        let snippet = visitor.snippet(mk_sp(visitor.last_pos, self.span.hi));\n+        visitor.changes.push_str_span(self.span, &snippet);\n+\n+        // Stringify visitor\n+        let file_name = context.codemap.span_to_filename(self.span);\n+        let string_buffer = visitor.changes.get(&file_name);\n+\n+        Some(string_buffer.to_string())\n+    }\n+}\n+\n fn rewrite_string_lit(context: &RewriteContext,\n                       s: &str,\n                       span: Span,"}, {"sha": "33e4d5fbbf33dd2971424b84444e6f01c1220a06", "filename": "src/rewrite.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/e4a6f96d704d01d4301fa9e9b6f632318e4c57c4/src%2Frewrite.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e4a6f96d704d01d4301fa9e9b6f632318e4c57c4/src%2Frewrite.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frewrite.rs?ref=e4a6f96d704d01d4301fa9e9b6f632318e4c57c4", "patch": "@@ -28,4 +28,5 @@ pub trait Rewrite {\n pub struct RewriteContext<'a> {\n     pub codemap: &'a CodeMap,\n     pub config: &'a Config,\n+    pub block_indent: usize,\n }"}, {"sha": "1b1fd9d17c64a13bd34039a327a47be94e3d569a", "filename": "src/visitor.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/e4a6f96d704d01d4301fa9e9b6f632318e4c57c4/src%2Fvisitor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e4a6f96d704d01d4301fa9e9b6f632318e4c57c4/src%2Fvisitor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fvisitor.rs?ref=e4a6f96d704d01d4301fa9e9b6f632318e4c57c4", "patch": "@@ -38,7 +38,9 @@ impl<'a, 'v> visit::Visitor<'v> for FmtVisitor<'a> {\n                self.codemap.lookup_char_pos(ex.span.hi));\n         self.format_missing(ex.span.lo);\n         let offset = self.changes.cur_offset_span(ex.span);\n-        let context = RewriteContext { codemap: self.codemap, config: self.config };\n+        let context = RewriteContext { codemap: self.codemap,\n+                                       config: self.config,\n+                                       block_indent: self.block_indent, };\n         let rewrite = ex.rewrite(&context, self.config.max_width - offset, offset);\n \n         if let Some(new_str) = rewrite {"}, {"sha": "ad5ef93521d1fef0acd61c190e1a9b9e64282ba8", "filename": "tests/source/loop.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/e4a6f96d704d01d4301fa9e9b6f632318e4c57c4/tests%2Fsource%2Floop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e4a6f96d704d01d4301fa9e9b6f632318e4c57c4/tests%2Fsource%2Floop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Floop.rs?ref=e4a6f96d704d01d4301fa9e9b6f632318e4c57c4", "patch": "@@ -0,0 +1,11 @@\n+\n+fn main() {\n+    loop    \n+    {   return some_val;}\n+\n+let x = loop { do_forever(); };\n+\n+         loop {\n+        // Just comments\n+    }\n+}"}, {"sha": "3eb506eb6ede4ffc7d72a842a0e5afc3a0bd9872", "filename": "tests/target/loop.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/e4a6f96d704d01d4301fa9e9b6f632318e4c57c4/tests%2Ftarget%2Floop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e4a6f96d704d01d4301fa9e9b6f632318e4c57c4/tests%2Ftarget%2Floop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Floop.rs?ref=e4a6f96d704d01d4301fa9e9b6f632318e4c57c4", "patch": "@@ -0,0 +1,14 @@\n+\n+fn main() {\n+    loop {\n+        return some_val;\n+    }\n+\n+    let x = loop {\n+        do_forever();\n+    };\n+\n+    loop {\n+        // Just comments\n+    }\n+}"}]}