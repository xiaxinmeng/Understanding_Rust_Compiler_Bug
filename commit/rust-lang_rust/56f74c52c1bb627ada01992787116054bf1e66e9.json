{"sha": "56f74c52c1bb627ada01992787116054bf1e66e9", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU2Zjc0YzUyYzFiYjYyN2FkYTAxOTkyNzg3MTE2MDU0YmYxZTY2ZTk=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-03-13T15:11:25Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-03-13T15:11:25Z"}, "message": "Auto merge of #83069 - tgnottingham:simplify-query-cache-iter, r=cjgillot\n\nrustc_query_system: simplify QueryCache::iter\n\nMinor cleanup to reduce a small amount of complexity and code bloat.\nReduces the number of mono items in rustc_query_impl by 15%.", "tree": {"sha": "0ecb6d9e4e7a5b280ef77bfe54d234f03df72a48", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0ecb6d9e4e7a5b280ef77bfe54d234f03df72a48"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/56f74c52c1bb627ada01992787116054bf1e66e9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/56f74c52c1bb627ada01992787116054bf1e66e9", "html_url": "https://github.com/rust-lang/rust/commit/56f74c52c1bb627ada01992787116054bf1e66e9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/56f74c52c1bb627ada01992787116054bf1e66e9/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "32dce353dec5f9069c941d4cd0c059ecc67b7c2b", "url": "https://api.github.com/repos/rust-lang/rust/commits/32dce353dec5f9069c941d4cd0c059ecc67b7c2b", "html_url": "https://github.com/rust-lang/rust/commit/32dce353dec5f9069c941d4cd0c059ecc67b7c2b"}, {"sha": "adcbe49b16dff960600b5d54171d38d6b556d228", "url": "https://api.github.com/repos/rust-lang/rust/commits/adcbe49b16dff960600b5d54171d38d6b556d228", "html_url": "https://github.com/rust-lang/rust/commit/adcbe49b16dff960600b5d54171d38d6b556d228"}], "stats": {"total": 39, "additions": 17, "deletions": 22}, "files": [{"sha": "001bf3b216b1b014c8b765ec3a2a6afdca8f65ac", "filename": "compiler/rustc_query_system/src/query/caches.rs", "status": "modified", "additions": 15, "deletions": 20, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/56f74c52c1bb627ada01992787116054bf1e66e9/compiler%2Frustc_query_system%2Fsrc%2Fquery%2Fcaches.rs", "raw_url": "https://github.com/rust-lang/rust/raw/56f74c52c1bb627ada01992787116054bf1e66e9/compiler%2Frustc_query_system%2Fsrc%2Fquery%2Fcaches.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_query_system%2Fsrc%2Fquery%2Fcaches.rs?ref=56f74c52c1bb627ada01992787116054bf1e66e9", "patch": "@@ -49,12 +49,11 @@ pub trait QueryCache: QueryStorage {\n         index: DepNodeIndex,\n     ) -> Self::Stored;\n \n-    fn iter<R, L>(\n+    fn iter<R>(\n         &self,\n-        shards: &Sharded<L>,\n-        get_shard: impl Fn(&mut L) -> &mut Self::Sharded,\n+        shards: &Sharded<Self::Sharded>,\n         f: impl for<'a> FnOnce(\n-            Box<dyn Iterator<Item = (&'a Self::Key, &'a Self::Value, DepNodeIndex)> + 'a>,\n+            &'a mut dyn Iterator<Item = (&'a Self::Key, &'a Self::Value, DepNodeIndex)>,\n         ) -> R,\n     ) -> R;\n }\n@@ -125,16 +124,14 @@ where\n         value\n     }\n \n-    fn iter<R, L>(\n+    fn iter<R>(\n         &self,\n-        shards: &Sharded<L>,\n-        get_shard: impl Fn(&mut L) -> &mut Self::Sharded,\n-        f: impl for<'a> FnOnce(Box<dyn Iterator<Item = (&'a K, &'a V, DepNodeIndex)> + 'a>) -> R,\n+        shards: &Sharded<Self::Sharded>,\n+        f: impl for<'a> FnOnce(&'a mut dyn Iterator<Item = (&'a K, &'a V, DepNodeIndex)>) -> R,\n     ) -> R {\n-        let mut shards = shards.lock_shards();\n-        let mut shards: Vec<_> = shards.iter_mut().map(|shard| get_shard(shard)).collect();\n-        let results = shards.iter_mut().flat_map(|shard| shard.iter()).map(|(k, v)| (k, &v.0, v.1));\n-        f(Box::new(results))\n+        let shards = shards.lock_shards();\n+        let mut results = shards.iter().flat_map(|shard| shard.iter()).map(|(k, v)| (k, &v.0, v.1));\n+        f(&mut results)\n     }\n }\n \n@@ -210,15 +207,13 @@ where\n         &value.0\n     }\n \n-    fn iter<R, L>(\n+    fn iter<R>(\n         &self,\n-        shards: &Sharded<L>,\n-        get_shard: impl Fn(&mut L) -> &mut Self::Sharded,\n-        f: impl for<'a> FnOnce(Box<dyn Iterator<Item = (&'a K, &'a V, DepNodeIndex)> + 'a>) -> R,\n+        shards: &Sharded<Self::Sharded>,\n+        f: impl for<'a> FnOnce(&'a mut dyn Iterator<Item = (&'a K, &'a V, DepNodeIndex)>) -> R,\n     ) -> R {\n-        let mut shards = shards.lock_shards();\n-        let mut shards: Vec<_> = shards.iter_mut().map(|shard| get_shard(shard)).collect();\n-        let results = shards.iter_mut().flat_map(|shard| shard.iter()).map(|(k, v)| (k, &v.0, v.1));\n-        f(Box::new(results))\n+        let shards = shards.lock_shards();\n+        let mut results = shards.iter().flat_map(|shard| shard.iter()).map(|(k, v)| (k, &v.0, v.1));\n+        f(&mut results)\n     }\n }"}, {"sha": "c3e92b87c27d2bf26fbb9aced7491e3f5c2912dd", "filename": "compiler/rustc_query_system/src/query/plumbing.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/56f74c52c1bb627ada01992787116054bf1e66e9/compiler%2Frustc_query_system%2Fsrc%2Fquery%2Fplumbing.rs", "raw_url": "https://github.com/rust-lang/rust/raw/56f74c52c1bb627ada01992787116054bf1e66e9/compiler%2Frustc_query_system%2Fsrc%2Fquery%2Fplumbing.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_query_system%2Fsrc%2Fquery%2Fplumbing.rs?ref=56f74c52c1bb627ada01992787116054bf1e66e9", "patch": "@@ -76,10 +76,10 @@ impl<C: QueryCache> QueryCacheStore<C> {\n     pub fn iter_results<R>(\n         &self,\n         f: impl for<'a> FnOnce(\n-            Box<dyn Iterator<Item = (&'a C::Key, &'a C::Value, DepNodeIndex)> + 'a>,\n+            &'a mut dyn Iterator<Item = (&'a C::Key, &'a C::Value, DepNodeIndex)>,\n         ) -> R,\n     ) -> R {\n-        self.cache.iter(&self.shards, |shard| &mut *shard, f)\n+        self.cache.iter(&self.shards, f)\n     }\n }\n "}]}