{"sha": "f60a810730aa684f1354d852719b1a3edd0cd2fe", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY2MGE4MTA3MzBhYTY4NGYxMzU0ZDg1MjcxOWIxYTNlZGQwY2QyZmU=", "commit": {"author": {"name": "topecongiro", "email": "seuchida@gmail.com", "date": "2017-06-16T20:44:54Z"}, "committer": {"name": "topecongiro", "email": "seuchida@gmail.com", "date": "2017-06-16T20:44:54Z"}, "message": "Preserve comments inside attributes", "tree": {"sha": "e987550b4875765a262da77b57c0eed9e0ce0074", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e987550b4875765a262da77b57c0eed9e0ce0074"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f60a810730aa684f1354d852719b1a3edd0cd2fe", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f60a810730aa684f1354d852719b1a3edd0cd2fe", "html_url": "https://github.com/rust-lang/rust/commit/f60a810730aa684f1354d852719b1a3edd0cd2fe", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f60a810730aa684f1354d852719b1a3edd0cd2fe/comments", "author": {"login": "topecongiro", "id": 21980157, "node_id": "MDQ6VXNlcjIxOTgwMTU3", "avatar_url": "https://avatars.githubusercontent.com/u/21980157?v=4", "gravatar_id": "", "url": "https://api.github.com/users/topecongiro", "html_url": "https://github.com/topecongiro", "followers_url": "https://api.github.com/users/topecongiro/followers", "following_url": "https://api.github.com/users/topecongiro/following{/other_user}", "gists_url": "https://api.github.com/users/topecongiro/gists{/gist_id}", "starred_url": "https://api.github.com/users/topecongiro/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/topecongiro/subscriptions", "organizations_url": "https://api.github.com/users/topecongiro/orgs", "repos_url": "https://api.github.com/users/topecongiro/repos", "events_url": "https://api.github.com/users/topecongiro/events{/privacy}", "received_events_url": "https://api.github.com/users/topecongiro/received_events", "type": "User", "site_admin": false}, "committer": {"login": "topecongiro", "id": 21980157, "node_id": "MDQ6VXNlcjIxOTgwMTU3", "avatar_url": "https://avatars.githubusercontent.com/u/21980157?v=4", "gravatar_id": "", "url": "https://api.github.com/users/topecongiro", "html_url": "https://github.com/topecongiro", "followers_url": "https://api.github.com/users/topecongiro/followers", "following_url": "https://api.github.com/users/topecongiro/following{/other_user}", "gists_url": "https://api.github.com/users/topecongiro/gists{/gist_id}", "starred_url": "https://api.github.com/users/topecongiro/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/topecongiro/subscriptions", "organizations_url": "https://api.github.com/users/topecongiro/orgs", "repos_url": "https://api.github.com/users/topecongiro/repos", "events_url": "https://api.github.com/users/topecongiro/events{/privacy}", "received_events_url": "https://api.github.com/users/topecongiro/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "05559fc8a4da2f3986d5716df8ddb9729bcbb5cc", "url": "https://api.github.com/repos/rust-lang/rust/commits/05559fc8a4da2f3986d5716df8ddb9729bcbb5cc", "html_url": "https://github.com/rust-lang/rust/commit/05559fc8a4da2f3986d5716df8ddb9729bcbb5cc"}], "stats": {"total": 25, "additions": 19, "deletions": 6}, "files": [{"sha": "1b17ced8a42e195a3a6f6da5aa6b7a282f7395e4", "filename": "src/expr.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/f60a810730aa684f1354d852719b1a3edd0cd2fe/src%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f60a810730aa684f1354d852719b1a3edd0cd2fe/src%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fexpr.rs?ref=f60a810730aa684f1354d852719b1a3edd0cd2fe", "patch": "@@ -157,9 +157,8 @@ fn format_expr(\n         ast::ExprKind::Loop(..) |\n         ast::ExprKind::While(..) |\n         ast::ExprKind::WhileLet(..) => {\n-            to_control_flow(expr, expr_type).and_then(|control_flow| {\n-                control_flow.rewrite(context, shape)\n-            })\n+            to_control_flow(expr, expr_type)\n+                .and_then(|control_flow| control_flow.rewrite(context, shape))\n         }\n         ast::ExprKind::Block(ref block) => block.rewrite(context, shape),\n         ast::ExprKind::Match(ref cond, ref arms) => {"}, {"sha": "17f489334991cffe72c3d80d2a67a618803cd4cb", "filename": "src/visitor.rs", "status": "modified", "additions": 8, "deletions": 3, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/f60a810730aa684f1354d852719b1a3edd0cd2fe/src%2Fvisitor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f60a810730aa684f1354d852719b1a3edd0cd2fe/src%2Fvisitor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fvisitor.rs?ref=f60a810730aa684f1354d852719b1a3edd0cd2fe", "patch": "@@ -19,7 +19,7 @@ use strings::string_buffer::StringBuffer;\n use {Indent, Shape};\n use utils::{self, mk_sp};\n use codemap::{LineRangeUtils, SpanUtils};\n-use comment::FindUncommented;\n+use comment::{contains_comment, FindUncommented};\n use config::Config;\n use rewrite::{Rewrite, RewriteContext};\n use comment::rewrite_comment;\n@@ -761,7 +761,7 @@ impl Rewrite for ast::MetaItem {\n             ast::MetaItemKind::NameValue(ref literal) => {\n                 let name = self.name.as_str();\n                 let value = context.snippet(literal.span);\n-                if &*name == \"doc\" && value.starts_with(\"///\") {\n+                if &*name == \"doc\" && contains_comment(&value) {\n                     let doc_shape = Shape {\n                         width: cmp::min(shape.width, context.config.comment_width())\n                             .checked_sub(shape.indent.width())\n@@ -786,7 +786,12 @@ impl Rewrite for ast::Attribute {\n             if rw.starts_with(\"///\") {\n                 rw\n             } else {\n-                format!(\"#[{}]\", rw)\n+                let original = context.snippet(self.span);\n+                if contains_comment(&original) {\n+                    original\n+                } else {\n+                    format!(\"#[{}]\", rw)\n+                }\n             }\n         })\n     }"}, {"sha": "4079ef4cfca3d9b83724cc6e4d415332c88bd4d5", "filename": "tests/target/issue-1703.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/f60a810730aa684f1354d852719b1a3edd0cd2fe/tests%2Ftarget%2Fissue-1703.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f60a810730aa684f1354d852719b1a3edd0cd2fe/tests%2Ftarget%2Fissue-1703.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fissue-1703.rs?ref=f60a810730aa684f1354d852719b1a3edd0cd2fe", "patch": "@@ -0,0 +1,9 @@\n+// rustfmt should not remove doc comments or comments inside attributes.\n+\n+/**\n+This function has a block doc comment.\n+ */\n+fn test_function() {}\n+\n+#[foo /* do not remove this! */]\n+fn foo() {}"}]}