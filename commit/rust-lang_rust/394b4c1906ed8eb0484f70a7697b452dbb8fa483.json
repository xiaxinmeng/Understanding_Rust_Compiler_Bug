{"sha": "394b4c1906ed8eb0484f70a7697b452dbb8fa483", "node_id": "C_kwDOAAsO6NoAKDM5NGI0YzE5MDZlZDhlYjA0ODRmNzBhNzY5N2I0NTJkYmI4ZmE0ODM", "commit": {"author": {"name": "Renato Lochetti", "email": "renato.lochetti@gmail.com", "date": "2023-05-07T11:35:17Z"}, "committer": {"name": "Renato Lochetti", "email": "renato.lochetti@gmail.com", "date": "2023-05-07T11:35:17Z"}, "message": "Ignore `borrow_deref_ref` warnings in code from procedural macros.", "tree": {"sha": "fe8db74a3045ada0245dad3e42c4fd63633bd091", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fe8db74a3045ada0245dad3e42c4fd63633bd091"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/394b4c1906ed8eb0484f70a7697b452dbb8fa483", "comment_count": 0, "verification": {"verified": false, "reason": "bad_email", "signature": "-----BEGIN PGP SIGNATURE-----\n\niHUEABYKAB0WIQSUUq9F5en84QJ6JSz95O9WxHnTCAUCZFeM9QAKCRD95O9WxHnT\nCAL/AP923OkVUAvsDhOLGkX+AZ2JN0gOQzxSs+FBSj3l+5QDwgD+MajYEHrsLF0d\nOWZqAE1YTwPGu2nFVMlOcb5IUs4ECQ8=\n=+7Z8\n-----END PGP SIGNATURE-----", "payload": "tree fe8db74a3045ada0245dad3e42c4fd63633bd091\nparent 371120bdbf58a331db5dcfb2d9cddc040f486de8\nauthor Renato Lochetti <renato.lochetti@gmail.com> 1683459317 +0100\ncommitter Renato Lochetti <renato.lochetti@gmail.com> 1683459317 +0100\n\nIgnore `borrow_deref_ref` warnings in code from procedural macros.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/394b4c1906ed8eb0484f70a7697b452dbb8fa483", "html_url": "https://github.com/rust-lang/rust/commit/394b4c1906ed8eb0484f70a7697b452dbb8fa483", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/394b4c1906ed8eb0484f70a7697b452dbb8fa483/comments", "author": {"login": "lochetti", "id": 2541422, "node_id": "MDQ6VXNlcjI1NDE0MjI=", "avatar_url": "https://avatars.githubusercontent.com/u/2541422?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lochetti", "html_url": "https://github.com/lochetti", "followers_url": "https://api.github.com/users/lochetti/followers", "following_url": "https://api.github.com/users/lochetti/following{/other_user}", "gists_url": "https://api.github.com/users/lochetti/gists{/gist_id}", "starred_url": "https://api.github.com/users/lochetti/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lochetti/subscriptions", "organizations_url": "https://api.github.com/users/lochetti/orgs", "repos_url": "https://api.github.com/users/lochetti/repos", "events_url": "https://api.github.com/users/lochetti/events{/privacy}", "received_events_url": "https://api.github.com/users/lochetti/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lochetti", "id": 2541422, "node_id": "MDQ6VXNlcjI1NDE0MjI=", "avatar_url": "https://avatars.githubusercontent.com/u/2541422?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lochetti", "html_url": "https://github.com/lochetti", "followers_url": "https://api.github.com/users/lochetti/followers", "following_url": "https://api.github.com/users/lochetti/following{/other_user}", "gists_url": "https://api.github.com/users/lochetti/gists{/gist_id}", "starred_url": "https://api.github.com/users/lochetti/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lochetti/subscriptions", "organizations_url": "https://api.github.com/users/lochetti/orgs", "repos_url": "https://api.github.com/users/lochetti/repos", "events_url": "https://api.github.com/users/lochetti/events{/privacy}", "received_events_url": "https://api.github.com/users/lochetti/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "371120bdbf58a331db5dcfb2d9cddc040f486de8", "url": "https://api.github.com/repos/rust-lang/rust/commits/371120bdbf58a331db5dcfb2d9cddc040f486de8", "html_url": "https://github.com/rust-lang/rust/commit/371120bdbf58a331db5dcfb2d9cddc040f486de8"}], "stats": {"total": 42, "additions": 37, "deletions": 5}, "files": [{"sha": "814108ed8a7c2b1ef60c4e9888b7dc26ebae757d", "filename": "clippy_lints/src/borrow_deref_ref.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/394b4c1906ed8eb0484f70a7697b452dbb8fa483/clippy_lints%2Fsrc%2Fborrow_deref_ref.rs", "raw_url": "https://github.com/rust-lang/rust/raw/394b4c1906ed8eb0484f70a7697b452dbb8fa483/clippy_lints%2Fsrc%2Fborrow_deref_ref.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fborrow_deref_ref.rs?ref=394b4c1906ed8eb0484f70a7697b452dbb8fa483", "patch": "@@ -1,5 +1,6 @@\n use crate::reference::DEREF_ADDROF;\n use clippy_utils::diagnostics::span_lint_and_then;\n+use clippy_utils::is_from_proc_macro;\n use clippy_utils::source::snippet_opt;\n use clippy_utils::ty::implements_trait;\n use clippy_utils::{get_parent_expr, is_lint_allowed};\n@@ -47,8 +48,8 @@ declare_clippy_lint! {\n \n declare_lint_pass!(BorrowDerefRef => [BORROW_DEREF_REF]);\n \n-impl LateLintPass<'_> for BorrowDerefRef {\n-    fn check_expr(&mut self, cx: &LateContext<'_>, e: &rustc_hir::Expr<'_>) {\n+impl<'tcx> LateLintPass<'tcx> for BorrowDerefRef {\n+    fn check_expr(&mut self, cx: &LateContext<'tcx>, e: &rustc_hir::Expr<'tcx>) {\n         if_chain! {\n             if !e.span.from_expansion();\n             if let ExprKind::AddrOf(_, Mutability::Not, addrof_target) = e.kind;\n@@ -58,6 +59,7 @@ impl LateLintPass<'_> for BorrowDerefRef {\n             if !matches!(deref_target.kind, ExprKind::Unary(UnOp::Deref, ..) );\n             let ref_ty = cx.typeck_results().expr_ty(deref_target);\n             if let ty::Ref(_, inner_ty, Mutability::Not) = ref_ty.kind();\n+            if !is_from_proc_macro(cx, e);\n             then{\n \n                 if let Some(parent_expr) = get_parent_expr(cx, e){"}, {"sha": "755264617920eb5385523b0e93a5bb918f3a3e6c", "filename": "tests/ui/borrow_deref_ref.fixed", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/394b4c1906ed8eb0484f70a7697b452dbb8fa483/tests%2Fui%2Fborrow_deref_ref.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/394b4c1906ed8eb0484f70a7697b452dbb8fa483/tests%2Fui%2Fborrow_deref_ref.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fborrow_deref_ref.fixed?ref=394b4c1906ed8eb0484f70a7697b452dbb8fa483", "patch": "@@ -1,7 +1,11 @@\n //@run-rustfix\n+//@aux-build: proc_macros.rs\n \n #![allow(dead_code, unused_variables)]\n \n+extern crate proc_macros;\n+use proc_macros::with_span;\n+\n fn main() {}\n \n mod should_lint {\n@@ -47,6 +51,17 @@ mod should_not_lint2 {\n     }\n }\n \n+with_span!(\n+    span\n+\n+    fn just_returning(x: &u32) -> &u32 {\n+        x\n+    }\n+\n+    fn dont_lint_proc_macro() {\n+        let a = &mut &*just_returning(&12);\n+    }\n+);\n // this mod explains why we should not lint `& &* (&T)`\n mod false_negative {\n     fn foo() {"}, {"sha": "e319d365f7e77f283ca9e43f3f8989c75cd35138", "filename": "tests/ui/borrow_deref_ref.rs", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/394b4c1906ed8eb0484f70a7697b452dbb8fa483/tests%2Fui%2Fborrow_deref_ref.rs", "raw_url": "https://github.com/rust-lang/rust/raw/394b4c1906ed8eb0484f70a7697b452dbb8fa483/tests%2Fui%2Fborrow_deref_ref.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fborrow_deref_ref.rs?ref=394b4c1906ed8eb0484f70a7697b452dbb8fa483", "patch": "@@ -1,7 +1,11 @@\n //@run-rustfix\n+//@aux-build: proc_macros.rs\n \n #![allow(dead_code, unused_variables)]\n \n+extern crate proc_macros;\n+use proc_macros::with_span;\n+\n fn main() {}\n \n mod should_lint {\n@@ -47,6 +51,17 @@ mod should_not_lint2 {\n     }\n }\n \n+with_span!(\n+    span\n+\n+    fn just_returning(x: &u32) -> &u32 {\n+        x\n+    }\n+\n+    fn dont_lint_proc_macro() {\n+        let a = &mut &*just_returning(&12);\n+    }\n+);\n // this mod explains why we should not lint `& &* (&T)`\n mod false_negative {\n     fn foo() {"}, {"sha": "1e47cda6796019d05627f364a9fc2a78f5b623d6", "filename": "tests/ui/borrow_deref_ref.stderr", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/394b4c1906ed8eb0484f70a7697b452dbb8fa483/tests%2Fui%2Fborrow_deref_ref.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/394b4c1906ed8eb0484f70a7697b452dbb8fa483/tests%2Fui%2Fborrow_deref_ref.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fborrow_deref_ref.stderr?ref=394b4c1906ed8eb0484f70a7697b452dbb8fa483", "patch": "@@ -1,19 +1,19 @@\n error: deref on an immutable reference\n-  --> $DIR/borrow_deref_ref.rs:10:17\n+  --> $DIR/borrow_deref_ref.rs:14:17\n    |\n LL |         let b = &*a;\n    |                 ^^^ help: if you would like to reborrow, try removing `&*`: `a`\n    |\n    = note: `-D clippy::borrow-deref-ref` implied by `-D warnings`\n \n error: deref on an immutable reference\n-  --> $DIR/borrow_deref_ref.rs:12:22\n+  --> $DIR/borrow_deref_ref.rs:16:22\n    |\n LL |         let b = &mut &*bar(&12);\n    |                      ^^^^^^^^^^ help: if you would like to reborrow, try removing `&*`: `bar(&12)`\n \n error: deref on an immutable reference\n-  --> $DIR/borrow_deref_ref.rs:55:23\n+  --> $DIR/borrow_deref_ref.rs:70:23\n    |\n LL |         let addr_y = &&*x as *const _ as usize; // assert ok\n    |                       ^^^ help: if you would like to reborrow, try removing `&*`: `x`"}]}