{"sha": "e1a5bd866e5e27a9ee2d37bcdc5e817c1fa8672d", "node_id": "MDY6Q29tbWl0NzI0NzEyOmUxYTViZDg2NmU1ZTI3YTllZTJkMzdiY2RjNWU4MTdjMWZhODY3MmQ=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-06-29T16:03:10Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-06-29T16:03:10Z"}, "message": "Merge #5096 #5097\n\n5096: Fix handling of whitespace when applying SSR within macro expansions. r=matklad a=davidlattimore\n\nI originally did replacement by passing in the full file text. Then as some point I thought I could do without it. Turns out calling .text() on a node coming from a macro expansion isn't a great idea, especially when you then try and use ranges from the original source to cut that text. The test I added here actually panics without the rest of this change (sorry I didn't notice sooner).\n\n5097: Fix SSR prompt following #4919 r=matklad a=davidlattimore\n\n\n\nCo-authored-by: David Lattimore <dml@google.com>", "tree": {"sha": "2f1cb8826b1fa0ac6b693377118ca13a561332b2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2f1cb8826b1fa0ac6b693377118ca13a561332b2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e1a5bd866e5e27a9ee2d37bcdc5e817c1fa8672d", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJe+hC+CRBK7hj4Ov3rIwAAdHIIAFFpw8cL7nhNKYhWKUnRrGGa\nImYv7nUgDBoTx6aAubiR7mkJeXe+2CJ8maigkoKp6aRgKL39dj8PnKmcBYpGO3dj\nfNLf/+J4NUAfm0TWZeiWTUdj/zdhxUf++BKu1gj/4u/oPXlW447HgLDhJ1pb1qeN\nY3kfrRFyoZuZ1WWFmT8JlhyNBdazHMMYYdGZiU7tQrIBraNprqI3Le5xcbrg/JK8\nRrB/17OLY+Qsj53au+A5IU2nl3LynWGcoLzqkmNgR4yVW01EGudEo5MmZhmVpS1d\nNy+1hoM2cxl4tqjRbEY+qSEUxgWkJFkIlQT1E0yx+Pv6GUdtQU5NQ5Ydh2sZ9/s=\n=QtI/\n-----END PGP SIGNATURE-----\n", "payload": "tree 2f1cb8826b1fa0ac6b693377118ca13a561332b2\nparent 86f1556f7c1fa2cf04753be90c83afc1f825d7de\nparent 64a49589e74447da668bd5acab8375206a10253f\nparent 2a18ef0b0910af2515eab6fb1354a066b738c513\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1593446590 +0000\ncommitter GitHub <noreply@github.com> 1593446590 +0000\n\nMerge #5096 #5097\n\n5096: Fix handling of whitespace when applying SSR within macro expansions. r=matklad a=davidlattimore\n\nI originally did replacement by passing in the full file text. Then as some point I thought I could do without it. Turns out calling .text() on a node coming from a macro expansion isn't a great idea, especially when you then try and use ranges from the original source to cut that text. The test I added here actually panics without the rest of this change (sorry I didn't notice sooner).\n\n5097: Fix SSR prompt following #4919 r=matklad a=davidlattimore\n\n\n\nCo-authored-by: David Lattimore <dml@google.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e1a5bd866e5e27a9ee2d37bcdc5e817c1fa8672d", "html_url": "https://github.com/rust-lang/rust/commit/e1a5bd866e5e27a9ee2d37bcdc5e817c1fa8672d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e1a5bd866e5e27a9ee2d37bcdc5e817c1fa8672d/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "86f1556f7c1fa2cf04753be90c83afc1f825d7de", "url": "https://api.github.com/repos/rust-lang/rust/commits/86f1556f7c1fa2cf04753be90c83afc1f825d7de", "html_url": "https://github.com/rust-lang/rust/commit/86f1556f7c1fa2cf04753be90c83afc1f825d7de"}, {"sha": "64a49589e74447da668bd5acab8375206a10253f", "url": "https://api.github.com/repos/rust-lang/rust/commits/64a49589e74447da668bd5acab8375206a10253f", "html_url": "https://github.com/rust-lang/rust/commit/64a49589e74447da668bd5acab8375206a10253f"}, {"sha": "2a18ef0b0910af2515eab6fb1354a066b738c513", "url": "https://api.github.com/repos/rust-lang/rust/commits/2a18ef0b0910af2515eab6fb1354a066b738c513", "html_url": "https://github.com/rust-lang/rust/commit/2a18ef0b0910af2515eab6fb1354a066b738c513"}], "stats": {"total": 57, "additions": 38, "deletions": 19}, "files": [{"sha": "e148f4564bd9d6d8d5f3d9ee5dfe7bdad9c0e079", "filename": "crates/ra_ssr/src/lib.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/e1a5bd866e5e27a9ee2d37bcdc5e817c1fa8672d/crates%2Fra_ssr%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e1a5bd866e5e27a9ee2d37bcdc5e817c1fa8672d/crates%2Fra_ssr%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ssr%2Fsrc%2Flib.rs?ref=e1a5bd866e5e27a9ee2d37bcdc5e817c1fa8672d", "patch": "@@ -69,7 +69,8 @@ impl<'db> MatchFinder<'db> {\n         if matches.matches.is_empty() {\n             None\n         } else {\n-            Some(replacing::matches_to_edit(&matches))\n+            use ra_db::SourceDatabaseExt;\n+            Some(replacing::matches_to_edit(&matches, &self.sema.db.file_text(file_id)))\n         }\n     }\n "}, {"sha": "bb87bda43129f943b8833c18694985ad3e805393", "filename": "crates/ra_ssr/src/matching.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e1a5bd866e5e27a9ee2d37bcdc5e817c1fa8672d/crates%2Fra_ssr%2Fsrc%2Fmatching.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e1a5bd866e5e27a9ee2d37bcdc5e817c1fa8672d/crates%2Fra_ssr%2Fsrc%2Fmatching.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ssr%2Fsrc%2Fmatching.rs?ref=e1a5bd866e5e27a9ee2d37bcdc5e817c1fa8672d", "patch": "@@ -585,7 +585,7 @@ mod tests {\n             \"1+2\"\n         );\n \n-        let edit = crate::replacing::matches_to_edit(&matches);\n+        let edit = crate::replacing::matches_to_edit(&matches, input);\n         let mut after = input.to_string();\n         edit.apply(&mut after);\n         assert_eq!(after, \"fn main() { bar(1+2); }\");"}, {"sha": "70ce1c185b55dd5beffc0d0d1e3854e96ccf6b71", "filename": "crates/ra_ssr/src/replacing.rs", "status": "modified", "additions": 17, "deletions": 16, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/e1a5bd866e5e27a9ee2d37bcdc5e817c1fa8672d/crates%2Fra_ssr%2Fsrc%2Freplacing.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e1a5bd866e5e27a9ee2d37bcdc5e817c1fa8672d/crates%2Fra_ssr%2Fsrc%2Freplacing.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ssr%2Fsrc%2Freplacing.rs?ref=e1a5bd866e5e27a9ee2d37bcdc5e817c1fa8672d", "patch": "@@ -10,21 +10,25 @@ use ra_text_edit::TextEdit;\n /// Returns a text edit that will replace each match in `matches` with its corresponding replacement\n /// template. Placeholders in the template will have been substituted with whatever they matched to\n /// in the original code.\n-pub(crate) fn matches_to_edit(matches: &SsrMatches) -> TextEdit {\n-    matches_to_edit_at_offset(matches, 0.into())\n+pub(crate) fn matches_to_edit(matches: &SsrMatches, file_src: &str) -> TextEdit {\n+    matches_to_edit_at_offset(matches, file_src, 0.into())\n }\n \n-fn matches_to_edit_at_offset(matches: &SsrMatches, relative_start: TextSize) -> TextEdit {\n+fn matches_to_edit_at_offset(\n+    matches: &SsrMatches,\n+    file_src: &str,\n+    relative_start: TextSize,\n+) -> TextEdit {\n     let mut edit_builder = ra_text_edit::TextEditBuilder::default();\n     for m in &matches.matches {\n-        edit_builder.replace(m.range.checked_sub(relative_start).unwrap(), render_replace(m));\n+        edit_builder\n+            .replace(m.range.checked_sub(relative_start).unwrap(), render_replace(m, file_src));\n     }\n     edit_builder.finish()\n }\n \n-fn render_replace(match_info: &Match) -> String {\n+fn render_replace(match_info: &Match, file_src: &str) -> String {\n     let mut out = String::new();\n-    let match_start = match_info.matched_node.text_range().start();\n     for r in &match_info.template.tokens {\n         match r {\n             PatternElement::Token(t) => out.push_str(t.text.as_str()),\n@@ -33,16 +37,13 @@ fn render_replace(match_info: &Match) -> String {\n                     match_info.placeholder_values.get(&Var(p.ident.to_string()))\n                 {\n                     let range = &placeholder_value.range.range;\n-                    let mut matched_text = if let Some(node) = &placeholder_value.node {\n-                        node.text().to_string()\n-                    } else {\n-                        let relative_range = range.checked_sub(match_start).unwrap();\n-                        match_info.matched_node.text().to_string()\n-                            [usize::from(relative_range.start())..usize::from(relative_range.end())]\n-                            .to_string()\n-                    };\n-                    let edit =\n-                        matches_to_edit_at_offset(&placeholder_value.inner_matches, range.start());\n+                    let mut matched_text =\n+                        file_src[usize::from(range.start())..usize::from(range.end())].to_owned();\n+                    let edit = matches_to_edit_at_offset(\n+                        &placeholder_value.inner_matches,\n+                        file_src,\n+                        range.start(),\n+                    );\n                     edit.apply(&mut matched_text);\n                     out.push_str(&matched_text);\n                 } else {"}, {"sha": "8be60c2932955b7ca74d8ca2d5e8fd3991203428", "filename": "crates/ra_ssr/src/tests.rs", "status": "modified", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/e1a5bd866e5e27a9ee2d37bcdc5e817c1fa8672d/crates%2Fra_ssr%2Fsrc%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e1a5bd866e5e27a9ee2d37bcdc5e817c1fa8672d/crates%2Fra_ssr%2Fsrc%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ssr%2Fsrc%2Ftests.rs?ref=e1a5bd866e5e27a9ee2d37bcdc5e817c1fa8672d", "patch": "@@ -606,3 +606,20 @@ fn replace_within_macro_expansion() {\n             fn f() {macro1!(bar(5.x()).o2())}\"#,\n     )\n }\n+\n+#[test]\n+fn preserves_whitespace_within_macro_expansion() {\n+    assert_ssr_transform(\n+        \"$a + $b ==>> $b - $a\",\n+        r#\"\n+            macro_rules! macro1 {\n+                ($a:expr) => {$a}\n+            }\n+            fn f() {macro1!(1   *   2 + 3 + 4}\"#,\n+        r#\"\n+            macro_rules! macro1 {\n+                ($a:expr) => {$a}\n+            }\n+            fn f() {macro1!(4 - 3 - 1   *   2}\"#,\n+    )\n+}"}, {"sha": "5a1bc7f5769b152bdbc371484809b20f35d040c0", "filename": "editors/code/src/commands.ts", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e1a5bd866e5e27a9ee2d37bcdc5e817c1fa8672d/editors%2Fcode%2Fsrc%2Fcommands.ts", "raw_url": "https://github.com/rust-lang/rust/raw/e1a5bd866e5e27a9ee2d37bcdc5e817c1fa8672d/editors%2Fcode%2Fsrc%2Fcommands.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fcommands.ts?ref=e1a5bd866e5e27a9ee2d37bcdc5e817c1fa8672d", "patch": "@@ -158,7 +158,7 @@ export function ssr(ctx: Ctx): Cmd {\n \n         const options: vscode.InputBoxOptions = {\n             value: \"() ==>> ()\",\n-            prompt: \"Enter request, for example 'Foo($a:expr) ==> Foo::new($a)' \",\n+            prompt: \"Enter request, for example 'Foo($a) ==> Foo::new($a)' \",\n             validateInput: async (x: string) => {\n                 try {\n                     await client.sendRequest(ra.ssr, { query: x, parseOnly: true });"}]}