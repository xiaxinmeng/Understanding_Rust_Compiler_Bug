{"sha": "d08eb98698cbce56e599324fb83d55eef2cac408", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQwOGViOTg2OThjYmNlNTZlNTk5MzI0ZmI4M2Q1NWVlZjJjYWM0MDg=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-08-04T17:07:40Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-08-04T17:07:40Z"}, "message": "Auto merge of #75133 - nnethercote:rm-SubstFolder-fields, r=matthewjasper\n\nRemove two fields from `SubstFolder`.\n\nThey're only used in error messages printed if there's an internal\ncompiler error, and the cost of maintaining them is high enough to show\nup in profiles.\n\nr? @matthewjasper", "tree": {"sha": "8b65462dd814fb0f9c9d335f3c88d72e4d4cecd1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8b65462dd814fb0f9c9d335f3c88d72e4d4cecd1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d08eb98698cbce56e599324fb83d55eef2cac408", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d08eb98698cbce56e599324fb83d55eef2cac408", "html_url": "https://github.com/rust-lang/rust/commit/d08eb98698cbce56e599324fb83d55eef2cac408", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d08eb98698cbce56e599324fb83d55eef2cac408/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5f6bd6ec0ac422991b89bb8643eaa5d9d46eed11", "url": "https://api.github.com/repos/rust-lang/rust/commits/5f6bd6ec0ac422991b89bb8643eaa5d9d46eed11", "html_url": "https://github.com/rust-lang/rust/commit/5f6bd6ec0ac422991b89bb8643eaa5d9d46eed11"}, {"sha": "eeb4b83289e09956e0dda174047729ca87c709fe", "url": "https://api.github.com/repos/rust-lang/rust/commits/eeb4b83289e09956e0dda174047729ca87c709fe", "html_url": "https://github.com/rust-lang/rust/commit/eeb4b83289e09956e0dda174047729ca87c709fe"}], "stats": {"total": 37, "additions": 6, "deletions": 31}, "files": [{"sha": "866b529f35ec381d4e751e0d835942b167ba859a", "filename": "src/librustc_middle/ty/subst.rs", "status": "modified", "additions": 6, "deletions": 31, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/d08eb98698cbce56e599324fb83d55eef2cac408/src%2Flibrustc_middle%2Fty%2Fsubst.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d08eb98698cbce56e599324fb83d55eef2cac408/src%2Flibrustc_middle%2Fty%2Fsubst.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_middle%2Fty%2Fsubst.rs?ref=d08eb98698cbce56e599324fb83d55eef2cac408", "patch": "@@ -425,8 +425,7 @@ impl<'tcx, T: TypeFoldable<'tcx>> Subst<'tcx> for T {\n         substs: &[GenericArg<'tcx>],\n         span: Option<Span>,\n     ) -> T {\n-        let mut folder =\n-            SubstFolder { tcx, substs, span, root_ty: None, ty_stack_depth: 0, binders_passed: 0 };\n+        let mut folder = SubstFolder { tcx, substs, span, binders_passed: 0 };\n         (*self).fold_with(&mut folder)\n     }\n }\n@@ -441,12 +440,6 @@ struct SubstFolder<'a, 'tcx> {\n     /// The location for which the substitution is performed, if available.\n     span: Option<Span>,\n \n-    /// The root type that is being substituted, if available.\n-    root_ty: Option<Ty<'tcx>>,\n-\n-    /// Depth of type stack\n-    ty_stack_depth: usize,\n-\n     /// Number of region binders we have passed through while doing the substitution\n     binders_passed: u32,\n }\n@@ -478,9 +471,8 @@ impl<'a, 'tcx> TypeFolder<'tcx> for SubstFolder<'a, 'tcx> {\n                         let span = self.span.unwrap_or(DUMMY_SP);\n                         let msg = format!(\n                             \"Region parameter out of range \\\n-                             when substituting in region {} (root type={:?}) \\\n-                             (index={})\",\n-                            data.name, self.root_ty, data.index\n+                             when substituting in region {} (index={})\",\n+                            data.name, data.index\n                         );\n                         span_bug!(span, \"{}\", msg);\n                     }\n@@ -495,25 +487,10 @@ impl<'a, 'tcx> TypeFolder<'tcx> for SubstFolder<'a, 'tcx> {\n             return t;\n         }\n \n-        // track the root type we were asked to substitute\n-        let depth = self.ty_stack_depth;\n-        if depth == 0 {\n-            self.root_ty = Some(t);\n-        }\n-        self.ty_stack_depth += 1;\n-\n-        let t1 = match t.kind {\n+        match t.kind {\n             ty::Param(p) => self.ty_for_param(p, t),\n             _ => t.super_fold_with(self),\n-        };\n-\n-        assert_eq!(depth + 1, self.ty_stack_depth);\n-        self.ty_stack_depth -= 1;\n-        if depth == 0 {\n-            self.root_ty = None;\n         }\n-\n-        t1\n     }\n \n     fn fold_const(&mut self, c: &'tcx ty::Const<'tcx>) -> &'tcx ty::Const<'tcx> {\n@@ -540,12 +517,11 @@ impl<'a, 'tcx> SubstFolder<'a, 'tcx> {\n                 span_bug!(\n                     span,\n                     \"expected type for `{:?}` ({:?}/{}) but found {:?} \\\n-                     when substituting (root type={:?}) substs={:?}\",\n+                     when substituting, substs={:?}\",\n                     p,\n                     source_ty,\n                     p.index,\n                     kind,\n-                    self.root_ty,\n                     self.substs,\n                 );\n             }\n@@ -554,11 +530,10 @@ impl<'a, 'tcx> SubstFolder<'a, 'tcx> {\n                 span_bug!(\n                     span,\n                     \"type parameter `{:?}` ({:?}/{}) out of range \\\n-                     when substituting (root type={:?}) substs={:?}\",\n+                     when substituting, substs={:?}\",\n                     p,\n                     source_ty,\n                     p.index,\n-                    self.root_ty,\n                     self.substs,\n                 );\n             }"}]}