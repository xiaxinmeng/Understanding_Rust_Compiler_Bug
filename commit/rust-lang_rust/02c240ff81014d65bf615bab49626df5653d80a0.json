{"sha": "02c240ff81014d65bf615bab49626df5653d80a0", "node_id": "C_kwDOAAsO6NoAKDAyYzI0MGZmODEwMTRkNjViZjYxNWJhYjQ5NjI2ZGY1NjUzZDgwYTA", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-07-28T13:48:12Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-07-28T13:48:12Z"}, "message": "Auto merge of #12898 - Veykril:compl-pat-brace, r=Veykril\n\nfix: Fix pattern completions adding unnecessary braces\n\nFixes https://github.com/rust-lang/rust-analyzer/issues/12852", "tree": {"sha": "445a6239ddb9047d45d39fcf1366d34cbee3f13f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/445a6239ddb9047d45d39fcf1366d34cbee3f13f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/02c240ff81014d65bf615bab49626df5653d80a0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/02c240ff81014d65bf615bab49626df5653d80a0", "html_url": "https://github.com/rust-lang/rust/commit/02c240ff81014d65bf615bab49626df5653d80a0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/02c240ff81014d65bf615bab49626df5653d80a0/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "02f9ec4be5739d1b50f47b963293ad71e18b28f8", "url": "https://api.github.com/repos/rust-lang/rust/commits/02f9ec4be5739d1b50f47b963293ad71e18b28f8", "html_url": "https://github.com/rust-lang/rust/commit/02f9ec4be5739d1b50f47b963293ad71e18b28f8"}, {"sha": "7c59d7c75c1aed160bf1aa67047ba6063ae21ba0", "url": "https://api.github.com/repos/rust-lang/rust/commits/7c59d7c75c1aed160bf1aa67047ba6063ae21ba0", "html_url": "https://github.com/rust-lang/rust/commit/7c59d7c75c1aed160bf1aa67047ba6063ae21ba0"}], "stats": {"total": 42, "additions": 33, "deletions": 9}, "files": [{"sha": "72579e6026aee736868f1ae64bbdc310b00b46cd", "filename": "crates/ide-completion/src/completions.rs", "status": "modified", "additions": 11, "deletions": 2, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/02c240ff81014d65bf615bab49626df5653d80a0/crates%2Fide-completion%2Fsrc%2Fcompletions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/02c240ff81014d65bf615bab49626df5653d80a0/crates%2Fide-completion%2Fsrc%2Fcompletions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-completion%2Fsrc%2Fcompletions.rs?ref=02c240ff81014d65bf615bab49626df5653d80a0", "patch": "@@ -400,7 +400,7 @@ impl Completions {\n     ) {\n         if let PathCompletionCtx { kind: PathKind::Pat { pat_ctx }, .. } = path_ctx {\n             cov_mark::hit!(enum_variant_pattern_path);\n-            self.add_variant_pat(ctx, pat_ctx, variant, local_name);\n+            self.add_variant_pat(ctx, pat_ctx, Some(path_ctx), variant, local_name);\n             return;\n         }\n \n@@ -484,12 +484,14 @@ impl Completions {\n         &mut self,\n         ctx: &CompletionContext<'_>,\n         pattern_ctx: &PatternContext,\n+        path_ctx: Option<&PathCompletionCtx>,\n         variant: hir::Variant,\n         local_name: Option<hir::Name>,\n     ) {\n         self.add_opt(render_variant_pat(\n             RenderContext::new(ctx),\n             pattern_ctx,\n+            path_ctx,\n             variant,\n             local_name.clone(),\n             None,\n@@ -504,7 +506,14 @@ impl Completions {\n         path: hir::ModPath,\n     ) {\n         let path = Some(&path);\n-        self.add_opt(render_variant_pat(RenderContext::new(ctx), pattern_ctx, variant, None, path));\n+        self.add_opt(render_variant_pat(\n+            RenderContext::new(ctx),\n+            pattern_ctx,\n+            None,\n+            variant,\n+            None,\n+            path,\n+        ));\n     }\n \n     pub(crate) fn add_struct_pat("}, {"sha": "71d2d9d434b449f915dbad29a58c756ae591b651", "filename": "crates/ide-completion/src/completions/pattern.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/02c240ff81014d65bf615bab49626df5653d80a0/crates%2Fide-completion%2Fsrc%2Fcompletions%2Fpattern.rs", "raw_url": "https://github.com/rust-lang/rust/raw/02c240ff81014d65bf615bab49626df5653d80a0/crates%2Fide-completion%2Fsrc%2Fcompletions%2Fpattern.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-completion%2Fsrc%2Fcompletions%2Fpattern.rs?ref=02c240ff81014d65bf615bab49626df5653d80a0", "patch": "@@ -74,7 +74,7 @@ pub(crate) fn complete_pattern(\n                 hir::ModuleDef::Variant(variant)\n                     if refutable || single_variant_enum(variant.parent_enum(ctx.db)) =>\n                 {\n-                    acc.add_variant_pat(ctx, pattern_ctx, variant, Some(name.clone()));\n+                    acc.add_variant_pat(ctx, pattern_ctx, None, variant, Some(name.clone()));\n                     true\n                 }\n                 hir::ModuleDef::Adt(hir::Adt::Enum(e)) => refutable || single_variant_enum(e),"}, {"sha": "34a384f2f7ae8cabdffbdc986101c5f71bed1936", "filename": "crates/ide-completion/src/render/pattern.rs", "status": "modified", "additions": 19, "deletions": 4, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/02c240ff81014d65bf615bab49626df5653d80a0/crates%2Fide-completion%2Fsrc%2Frender%2Fpattern.rs", "raw_url": "https://github.com/rust-lang/rust/raw/02c240ff81014d65bf615bab49626df5653d80a0/crates%2Fide-completion%2Fsrc%2Frender%2Fpattern.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-completion%2Fsrc%2Frender%2Fpattern.rs?ref=02c240ff81014d65bf615bab49626df5653d80a0", "patch": "@@ -6,7 +6,7 @@ use itertools::Itertools;\n use syntax::SmolStr;\n \n use crate::{\n-    context::{ParamContext, ParamKind, PatternContext},\n+    context::{ParamContext, ParamKind, PathCompletionCtx, PatternContext},\n     render::{\n         variant::{format_literal_label, visible_fields},\n         RenderContext,\n@@ -42,6 +42,7 @@ pub(crate) fn render_struct_pat(\n pub(crate) fn render_variant_pat(\n     ctx: RenderContext<'_>,\n     pattern_ctx: &PatternContext,\n+    path_ctx: Option<&PathCompletionCtx>,\n     variant: hir::Variant,\n     local_name: Option<Name>,\n     path: Option<&hir::ModPath>,\n@@ -58,9 +59,23 @@ pub(crate) fn render_variant_pat(\n             (name.to_smol_str(), name.escaped().to_smol_str())\n         }\n     };\n-    let kind = variant.kind(ctx.db());\n-    let label = format_literal_label(name.as_str(), kind);\n-    let pat = render_pat(&ctx, pattern_ctx, &escaped_name, kind, &visible_fields, fields_omitted)?;\n+\n+    let (label, pat) = match path_ctx {\n+        Some(PathCompletionCtx { has_call_parens: true, .. }) => (name, escaped_name.to_string()),\n+        _ => {\n+            let kind = variant.kind(ctx.db());\n+            let label = format_literal_label(name.as_str(), kind);\n+            let pat = render_pat(\n+                &ctx,\n+                pattern_ctx,\n+                &escaped_name,\n+                kind,\n+                &visible_fields,\n+                fields_omitted,\n+            )?;\n+            (label, pat)\n+        }\n+    };\n \n     Some(build_completion(ctx, label, pat, variant))\n }"}, {"sha": "30ddbe2dc6f6010caca0c48d70e718a3178c1c90", "filename": "crates/ide-completion/src/tests/pattern.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/02c240ff81014d65bf615bab49626df5653d80a0/crates%2Fide-completion%2Fsrc%2Ftests%2Fpattern.rs", "raw_url": "https://github.com/rust-lang/rust/raw/02c240ff81014d65bf615bab49626df5653d80a0/crates%2Fide-completion%2Fsrc%2Ftests%2Fpattern.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-completion%2Fsrc%2Ftests%2Fpattern.rs?ref=02c240ff81014d65bf615bab49626df5653d80a0", "patch": "@@ -443,7 +443,7 @@ fn foo() {\n }\n \"#,\n         expect![[r#\"\n-            bn TupleVariant(\u2026) TupleVariant($1)$0\n+            bn TupleVariant TupleVariant\n         \"#]],\n     );\n     check_empty(\n@@ -458,7 +458,7 @@ fn foo() {\n }\n \"#,\n         expect![[r#\"\n-            bn RecordVariant {\u2026} RecordVariant { field$1 }$0\n+            bn RecordVariant RecordVariant\n         \"#]],\n     );\n }"}]}