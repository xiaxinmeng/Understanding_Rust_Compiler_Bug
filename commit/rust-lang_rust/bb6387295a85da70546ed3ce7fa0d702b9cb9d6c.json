{"sha": "bb6387295a85da70546ed3ce7fa0d702b9cb9d6c", "node_id": "MDY6Q29tbWl0NzI0NzEyOmJiNjM4NzI5NWE4NWRhNzA1NDZlZDNjZTdmYTBkNzAyYjljYjlkNmM=", "commit": {"author": {"name": "Michael Woerister", "email": "michaelwoerister@posteo.net", "date": "2017-04-03T17:39:12Z"}, "committer": {"name": "Michael Woerister", "email": "michaelwoerister@posteo.net", "date": "2017-04-07T12:37:48Z"}, "message": "SVH: Don't hash the HIR twice when once is enough.\n\nThe SVH (Strict Version Hash) of a crate is currently computed\nby hashing the ICHes (Incremental Computation Hashes) of the\ncrate's HIR. This is fine, expect that for incr. comp. we compute\ntwo ICH values for each HIR item, one for the complete item and\none that just includes the item's interface. The two hashes are\nare needed for dependency tracking but if we are compiling\nnon-incrementally and just need the ICH values for the SVH,\none of them is enough, giving us the opportunity to save some\nwork in this case.", "tree": {"sha": "1bfe6b43121735f50bbc90e78a1a3685d276a971", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1bfe6b43121735f50bbc90e78a1a3685d276a971"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bb6387295a85da70546ed3ce7fa0d702b9cb9d6c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bb6387295a85da70546ed3ce7fa0d702b9cb9d6c", "html_url": "https://github.com/rust-lang/rust/commit/bb6387295a85da70546ed3ce7fa0d702b9cb9d6c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bb6387295a85da70546ed3ce7fa0d702b9cb9d6c/comments", "author": {"login": "michaelwoerister", "id": 1825894, "node_id": "MDQ6VXNlcjE4MjU4OTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1825894?v=4", "gravatar_id": "", "url": "https://api.github.com/users/michaelwoerister", "html_url": "https://github.com/michaelwoerister", "followers_url": "https://api.github.com/users/michaelwoerister/followers", "following_url": "https://api.github.com/users/michaelwoerister/following{/other_user}", "gists_url": "https://api.github.com/users/michaelwoerister/gists{/gist_id}", "starred_url": "https://api.github.com/users/michaelwoerister/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/michaelwoerister/subscriptions", "organizations_url": "https://api.github.com/users/michaelwoerister/orgs", "repos_url": "https://api.github.com/users/michaelwoerister/repos", "events_url": "https://api.github.com/users/michaelwoerister/events{/privacy}", "received_events_url": "https://api.github.com/users/michaelwoerister/received_events", "type": "User", "site_admin": false}, "committer": {"login": "michaelwoerister", "id": 1825894, "node_id": "MDQ6VXNlcjE4MjU4OTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1825894?v=4", "gravatar_id": "", "url": "https://api.github.com/users/michaelwoerister", "html_url": "https://github.com/michaelwoerister", "followers_url": "https://api.github.com/users/michaelwoerister/followers", "following_url": "https://api.github.com/users/michaelwoerister/following{/other_user}", "gists_url": "https://api.github.com/users/michaelwoerister/gists{/gist_id}", "starred_url": "https://api.github.com/users/michaelwoerister/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/michaelwoerister/subscriptions", "organizations_url": "https://api.github.com/users/michaelwoerister/orgs", "repos_url": "https://api.github.com/users/michaelwoerister/repos", "events_url": "https://api.github.com/users/michaelwoerister/events{/privacy}", "received_events_url": "https://api.github.com/users/michaelwoerister/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "edc1ac3016d0e8383e174312db7c3b7a885af0c3", "url": "https://api.github.com/repos/rust-lang/rust/commits/edc1ac3016d0e8383e174312db7c3b7a885af0c3", "html_url": "https://github.com/rust-lang/rust/commit/edc1ac3016d0e8383e174312db7c3b7a885af0c3"}], "stats": {"total": 10, "additions": 9, "deletions": 1}, "files": [{"sha": "c67866971e1990ac398308ada8ce5fb62f201a95", "filename": "src/librustc_incremental/calculate_svh/mod.rs", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/bb6387295a85da70546ed3ce7fa0d702b9cb9d6c/src%2Flibrustc_incremental%2Fcalculate_svh%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bb6387295a85da70546ed3ce7fa0d702b9cb9d6c/src%2Flibrustc_incremental%2Fcalculate_svh%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_incremental%2Fcalculate_svh%2Fmod.rs?ref=bb6387295a85da70546ed3ce7fa0d702b9cb9d6c", "patch": "@@ -99,6 +99,13 @@ impl<'a, 'tcx: 'a> ComputeItemHashesVisitor<'a, 'tcx> {\n                                               item_like: T)\n         where T: HashStable<StableHashingContext<'a, 'tcx>>\n     {\n+        if !hash_bodies && !self.hcx.tcx().sess.opts.build_dep_graph() {\n+            // If we just need the hashes in order to compute the SVH, we don't\n+            // need have two hashes per item. Just the one containing also the\n+            // item's body is sufficient.\n+            return\n+        }\n+\n         let mut hasher = IchHasher::new();\n         self.hcx.while_hashing_hir_bodies(hash_bodies, |hcx| {\n             item_like.hash_stable(hcx, &mut hasher);\n@@ -143,7 +150,7 @@ impl<'a, 'tcx: 'a> ComputeItemHashesVisitor<'a, 'tcx> {\n                                (item_dep_node, item_hash)\n                            })\n                            .collect();\n-            item_hashes.sort(); // avoid artificial dependencies on item ordering\n+            item_hashes.sort_unstable(); // avoid artificial dependencies on item ordering\n             item_hashes.hash(&mut crate_state);\n         }\n "}, {"sha": "aa7eb36581f3ea549e3378aa8378a15a1d9f8394", "filename": "src/librustc_incremental/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/bb6387295a85da70546ed3ce7fa0d702b9cb9d6c/src%2Flibrustc_incremental%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bb6387295a85da70546ed3ce7fa0d702b9cb9d6c/src%2Flibrustc_incremental%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_incremental%2Flib.rs?ref=bb6387295a85da70546ed3ce7fa0d702b9cb9d6c", "patch": "@@ -23,6 +23,7 @@\n #![feature(staged_api)]\n #![feature(rand)]\n #![feature(conservative_impl_trait)]\n+#![feature(sort_unstable)]\n #![cfg_attr(stage0, feature(pub_restricted))]\n \n extern crate graphviz;"}]}