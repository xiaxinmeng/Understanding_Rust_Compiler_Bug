{"sha": "c75409d5e423d0ba21a44eb7c2bf11df6bcf6072", "node_id": "C_kwDOAAsO6NoAKGM3NTQwOWQ1ZTQyM2QwYmEyMWE0NGViN2MyYmYxMWRmNmJjZjYwNzI", "commit": {"author": {"name": "Camille GILLOT", "email": "gillot.camille@gmail.com", "date": "2022-05-27T09:29:18Z"}, "committer": {"name": "Camille GILLOT", "email": "gillot.camille@gmail.com", "date": "2022-06-03T06:26:10Z"}, "message": "Do not lower generic lifetime params when AST resolution emitted an error.", "tree": {"sha": "a47e38918ccd43f294def2fe42a224f10ddd120d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a47e38918ccd43f294def2fe42a224f10ddd120d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c75409d5e423d0ba21a44eb7c2bf11df6bcf6072", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c75409d5e423d0ba21a44eb7c2bf11df6bcf6072", "html_url": "https://github.com/rust-lang/rust/commit/c75409d5e423d0ba21a44eb7c2bf11df6bcf6072", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c75409d5e423d0ba21a44eb7c2bf11df6bcf6072/comments", "author": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "committer": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a265c49b252a932b06a94d5715013c8311989139", "url": "https://api.github.com/repos/rust-lang/rust/commits/a265c49b252a932b06a94d5715013c8311989139", "html_url": "https://github.com/rust-lang/rust/commit/a265c49b252a932b06a94d5715013c8311989139"}], "stats": {"total": 42, "additions": 18, "deletions": 24}, "files": [{"sha": "b55b2e7148e7c3751529d6d86beaa2ebf460ebc8", "filename": "compiler/rustc_ast_lowering/src/lib.rs", "status": "modified", "additions": 9, "deletions": 12, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/c75409d5e423d0ba21a44eb7c2bf11df6bcf6072/compiler%2Frustc_ast_lowering%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c75409d5e423d0ba21a44eb7c2bf11df6bcf6072/compiler%2Frustc_ast_lowering%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast_lowering%2Fsrc%2Flib.rs?ref=c75409d5e423d0ba21a44eb7c2bf11df6bcf6072", "patch": "@@ -1917,14 +1917,15 @@ impl<'a, 'hir> LoweringContext<'a, 'hir> {\n     fn lower_generic_param(&mut self, param: &GenericParam) -> hir::GenericParam<'hir> {\n         let (name, kind) = match param.kind {\n             GenericParamKind::Lifetime => {\n-                let param_name = if param.ident.name == kw::StaticLifetime\n-                    || param.ident.name == kw::UnderscoreLifetime\n-                {\n-                    ParamName::Error\n-                } else {\n-                    let ident = self.lower_ident(param.ident);\n-                    ParamName::Plain(ident)\n-                };\n+                // AST resolution emitted an error on those parameters, so we lower them using\n+                // `ParamName::Error`.\n+                let param_name =\n+                    if let Some(LifetimeRes::Error) = self.resolver.get_lifetime_res(param.id) {\n+                        ParamName::Error\n+                    } else {\n+                        let ident = self.lower_ident(param.ident);\n+                        ParamName::Plain(ident)\n+                    };\n                 let kind =\n                     hir::GenericParamKind::Lifetime { kind: hir::LifetimeParamKind::Explicit };\n \n@@ -1949,10 +1950,6 @@ impl<'a, 'hir> LoweringContext<'a, 'hir> {\n                 )\n             }\n         };\n-        let name = match name {\n-            hir::ParamName::Plain(ident) => hir::ParamName::Plain(self.lower_ident(ident)),\n-            name => name,\n-        };\n \n         let hir_id = self.lower_node_id(param.id);\n         self.lower_attrs(hir_id, &param.attrs);"}, {"sha": "06778b6c5514f8fdad74ed5d788ab9ba3ec18115", "filename": "compiler/rustc_resolve/src/late.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/c75409d5e423d0ba21a44eb7c2bf11df6bcf6072/compiler%2Frustc_resolve%2Fsrc%2Flate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c75409d5e423d0ba21a44eb7c2bf11df6bcf6072/compiler%2Frustc_resolve%2Fsrc%2Flate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Flate.rs?ref=c75409d5e423d0ba21a44eb7c2bf11df6bcf6072", "patch": "@@ -1939,6 +1939,9 @@ impl<'a: 'ast, 'b, 'ast> LateResolutionVisitor<'a, 'b, 'ast> {\n                             param.ident,\n                             orig_is_param,\n                         );\n+                        // Record lifetime res, so lowering knows there is something fishy.\n+                        self.record_lifetime_res(param.id, LifetimeRes::Error);\n+                        continue;\n                     }\n                     Entry::Vacant(entry) => {\n                         entry.insert(true);\n@@ -1966,6 +1969,8 @@ impl<'a: 'ast, 'b, 'ast> LateResolutionVisitor<'a, 'b, 'ast> {\n                 )\n                 .span_label(param.ident.span, \"`'_` is a reserved lifetime name\")\n                 .emit();\n+                // Record lifetime res, so lowering knows there is something fishy.\n+                self.record_lifetime_res(param.id, LifetimeRes::Error);\n                 continue;\n             }\n \n@@ -1979,6 +1984,8 @@ impl<'a: 'ast, 'b, 'ast> LateResolutionVisitor<'a, 'b, 'ast> {\n                 )\n                 .span_label(param.ident.span, \"'static is a reserved lifetime name\")\n                 .emit();\n+                // Record lifetime res, so lowering knows there is something fishy.\n+                self.record_lifetime_res(param.id, LifetimeRes::Error);\n                 continue;\n             }\n "}, {"sha": "4cf8b4401925da6652f15080cd6a7b3699d3ba8c", "filename": "src/test/ui/regions/regions-name-duplicated.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/c75409d5e423d0ba21a44eb7c2bf11df6bcf6072/src%2Ftest%2Fui%2Fregions%2Fregions-name-duplicated.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c75409d5e423d0ba21a44eb7c2bf11df6bcf6072/src%2Ftest%2Fui%2Fregions%2Fregions-name-duplicated.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fregions%2Fregions-name-duplicated.rs?ref=c75409d5e423d0ba21a44eb7c2bf11df6bcf6072", "patch": "@@ -1,6 +1,5 @@\n struct Foo<'a, 'a> {\n     //~^ ERROR lifetime name `'a` declared twice\n-    //~| ERROR parameter `'a` is never used [E0392]\n     x: &'a isize,\n }\n "}, {"sha": "303aa3389998be1aad837b149e5a39be38d46fa2", "filename": "src/test/ui/regions/regions-name-duplicated.stderr", "status": "modified", "additions": 2, "deletions": 11, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/c75409d5e423d0ba21a44eb7c2bf11df6bcf6072/src%2Ftest%2Fui%2Fregions%2Fregions-name-duplicated.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c75409d5e423d0ba21a44eb7c2bf11df6bcf6072/src%2Ftest%2Fui%2Fregions%2Fregions-name-duplicated.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fregions%2Fregions-name-duplicated.stderr?ref=c75409d5e423d0ba21a44eb7c2bf11df6bcf6072", "patch": "@@ -6,15 +6,6 @@ LL | struct Foo<'a, 'a> {\n    |            |\n    |            first declared here\n \n-error[E0392]: parameter `'a` is never used\n-  --> $DIR/regions-name-duplicated.rs:1:12\n-   |\n-LL | struct Foo<'a, 'a> {\n-   |            ^^ unused parameter\n-   |\n-   = help: consider removing `'a`, referring to it in a field, or using a marker such as `PhantomData`\n-\n-error: aborting due to 2 previous errors\n+error: aborting due to previous error\n \n-Some errors have detailed explanations: E0263, E0392.\n-For more information about an error, try `rustc --explain E0263`.\n+For more information about this error, try `rustc --explain E0263`."}]}