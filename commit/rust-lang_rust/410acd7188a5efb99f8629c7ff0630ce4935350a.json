{"sha": "410acd7188a5efb99f8629c7ff0630ce4935350a", "node_id": "C_kwDOAAsO6NoAKDQxMGFjZDcxODhhNWVmYjk5Zjg2MjljN2ZmMDYzMGNlNDkzNTM1MGE", "commit": {"author": {"name": "hecatia-elegua", "email": "108802164+hecatia-elegua@users.noreply.github.com", "date": "2023-04-05T17:28:55Z"}, "committer": {"name": "hecatia-elegua", "email": "108802164+hecatia-elegua@users.noreply.github.com", "date": "2023-04-05T17:28:55Z"}, "message": "Add doc(alias)-based field completion", "tree": {"sha": "da5ce4a45db28c89470fcc8dc3dd75d42f87c88f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/da5ce4a45db28c89470fcc8dc3dd75d42f87c88f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/410acd7188a5efb99f8629c7ff0630ce4935350a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/410acd7188a5efb99f8629c7ff0630ce4935350a", "html_url": "https://github.com/rust-lang/rust/commit/410acd7188a5efb99f8629c7ff0630ce4935350a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/410acd7188a5efb99f8629c7ff0630ce4935350a/comments", "author": {"login": "hecatia-elegua", "id": 108802164, "node_id": "U_kgDOBnwwdA", "avatar_url": "https://avatars.githubusercontent.com/u/108802164?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hecatia-elegua", "html_url": "https://github.com/hecatia-elegua", "followers_url": "https://api.github.com/users/hecatia-elegua/followers", "following_url": "https://api.github.com/users/hecatia-elegua/following{/other_user}", "gists_url": "https://api.github.com/users/hecatia-elegua/gists{/gist_id}", "starred_url": "https://api.github.com/users/hecatia-elegua/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hecatia-elegua/subscriptions", "organizations_url": "https://api.github.com/users/hecatia-elegua/orgs", "repos_url": "https://api.github.com/users/hecatia-elegua/repos", "events_url": "https://api.github.com/users/hecatia-elegua/events{/privacy}", "received_events_url": "https://api.github.com/users/hecatia-elegua/received_events", "type": "User", "site_admin": false}, "committer": {"login": "hecatia-elegua", "id": 108802164, "node_id": "U_kgDOBnwwdA", "avatar_url": "https://avatars.githubusercontent.com/u/108802164?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hecatia-elegua", "html_url": "https://github.com/hecatia-elegua", "followers_url": "https://api.github.com/users/hecatia-elegua/followers", "following_url": "https://api.github.com/users/hecatia-elegua/following{/other_user}", "gists_url": "https://api.github.com/users/hecatia-elegua/gists{/gist_id}", "starred_url": "https://api.github.com/users/hecatia-elegua/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hecatia-elegua/subscriptions", "organizations_url": "https://api.github.com/users/hecatia-elegua/orgs", "repos_url": "https://api.github.com/users/hecatia-elegua/repos", "events_url": "https://api.github.com/users/hecatia-elegua/events{/privacy}", "received_events_url": "https://api.github.com/users/hecatia-elegua/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "da9c0bd0a704340a075f87edfaab1e6ee33fe247", "url": "https://api.github.com/repos/rust-lang/rust/commits/da9c0bd0a704340a075f87edfaab1e6ee33fe247", "html_url": "https://github.com/rust-lang/rust/commit/da9c0bd0a704340a075f87edfaab1e6ee33fe247"}], "stats": {"total": 53, "additions": 40, "deletions": 13}, "files": [{"sha": "333a3338753b1c7827b599a66709873c10b90389", "filename": "crates/ide-completion/src/completions.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/410acd7188a5efb99f8629c7ff0630ce4935350a/crates%2Fide-completion%2Fsrc%2Fcompletions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/410acd7188a5efb99f8629c7ff0630ce4935350a/crates%2Fide-completion%2Fsrc%2Fcompletions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-completion%2Fsrc%2Fcompletions.rs?ref=410acd7188a5efb99f8629c7ff0630ce4935350a", "patch": "@@ -430,8 +430,9 @@ impl Completions {\n             Visible::Editable => true,\n             Visible::No => return,\n         };\n+        let doc_aliases = ctx.doc_aliases(&field);\n         let item = render_field(\n-            RenderContext::new(ctx).private_editable(is_private_editable),\n+            RenderContext::new(ctx).private_editable(is_private_editable).doc_aliases(doc_aliases),\n             dot_access,\n             receiver,\n             field,"}, {"sha": "f9bc13f7d2eb117aec63c9576445fd4924dba8a7", "filename": "crates/ide-completion/src/context.rs", "status": "modified", "additions": 10, "deletions": 2, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/410acd7188a5efb99f8629c7ff0630ce4935350a/crates%2Fide-completion%2Fsrc%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/410acd7188a5efb99f8629c7ff0630ce4935350a/crates%2Fide-completion%2Fsrc%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-completion%2Fsrc%2Fcontext.rs?ref=410acd7188a5efb99f8629c7ff0630ce4935350a", "patch": "@@ -441,6 +441,14 @@ impl<'a> CompletionContext<'a> {\n         self.is_visible_impl(&vis, &attrs, item.krate(self.db))\n     }\n \n+    pub(crate) fn doc_aliases<I>(&self, item: &I) -> Vec<SmolStr>\n+    where\n+        I: hir::HasAttrs + Copy,\n+    {\n+        let attrs = item.attrs(self.db);\n+        attrs.doc_aliases().collect()\n+    }\n+\n     /// Check if an item is `#[doc(hidden)]`.\n     pub(crate) fn is_item_hidden(&self, item: &hir::ItemInNs) -> bool {\n         let attrs = item.attrs(self.db);\n@@ -499,7 +507,7 @@ impl<'a> CompletionContext<'a> {\n             if self.is_scope_def_hidden(def) {\n                 return;\n             }\n-            let doc_aliases = self.doc_aliases(def);\n+            let doc_aliases = self.doc_aliases_in_scope(def);\n             f(name, def, doc_aliases);\n         });\n     }\n@@ -547,7 +555,7 @@ impl<'a> CompletionContext<'a> {\n         self.krate != defining_crate && attrs.has_doc_hidden()\n     }\n \n-    fn doc_aliases(&self, scope_def: ScopeDef) -> Vec<SmolStr> {\n+    fn doc_aliases_in_scope(&self, scope_def: ScopeDef) -> Vec<SmolStr> {\n         if let Some(attrs) = scope_def.attrs(self.db) {\n             attrs.doc_aliases().collect()\n         } else {"}, {"sha": "ab27b8c0a9ff9913732d9e51bc84a7a72b88bdec", "filename": "crates/ide-completion/src/item.rs", "status": "modified", "additions": 7, "deletions": 5, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/410acd7188a5efb99f8629c7ff0630ce4935350a/crates%2Fide-completion%2Fsrc%2Fitem.rs", "raw_url": "https://github.com/rust-lang/rust/raw/410acd7188a5efb99f8629c7ff0630ce4935350a/crates%2Fide-completion%2Fsrc%2Fitem.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-completion%2Fsrc%2Fitem.rs?ref=410acd7188a5efb99f8629c7ff0630ce4935350a", "patch": "@@ -4,6 +4,7 @@ use std::fmt;\n \n use hir::{Documentation, Mutability};\n use ide_db::{imports::import_assets::LocatedImport, SnippetCap, SymbolKind};\n+use itertools::Itertools;\n use smallvec::SmallVec;\n use stdx::{impl_from, never};\n use syntax::{SmolStr, TextRange, TextSize};\n@@ -353,7 +354,7 @@ impl CompletionItem {\n             relevance: CompletionRelevance::default(),\n             ref_match: None,\n             imports_to_add: Default::default(),\n-            doc_aliases: None,\n+            doc_aliases: vec![],\n         }\n     }\n \n@@ -386,7 +387,7 @@ pub(crate) struct Builder {\n     source_range: TextRange,\n     imports_to_add: SmallVec<[LocatedImport; 1]>,\n     trait_name: Option<SmolStr>,\n-    doc_aliases: Option<SmolStr>,\n+    doc_aliases: Vec<SmolStr>,\n     label: SmolStr,\n     insert_text: Option<String>,\n     is_snippet: bool,\n@@ -418,7 +419,8 @@ impl Builder {\n         let mut lookup = self.lookup.unwrap_or_else(|| label.clone());\n         let insert_text = self.insert_text.unwrap_or_else(|| label.to_string());\n \n-        if let Some(doc_aliases) = self.doc_aliases {\n+        if !self.doc_aliases.is_empty() {\n+            let doc_aliases = self.doc_aliases.into_iter().join(\", \");\n             label = SmolStr::from(format!(\"{label} (alias {doc_aliases})\"));\n             lookup = SmolStr::from(format!(\"{lookup} {doc_aliases}\"));\n         }\n@@ -464,8 +466,8 @@ impl Builder {\n         self.trait_name = Some(trait_name);\n         self\n     }\n-    pub(crate) fn doc_aliases(&mut self, doc_aliases: SmolStr) -> &mut Builder {\n-        self.doc_aliases = Some(doc_aliases);\n+    pub(crate) fn doc_aliases(&mut self, doc_aliases: Vec<SmolStr>) -> &mut Builder {\n+        self.doc_aliases = doc_aliases;\n         self\n     }\n     pub(crate) fn insert_text(&mut self, insert_text: impl Into<String>) -> &mut Builder {"}, {"sha": "62a357e085a67c5e3e7a1a9ceccbfdfca87c34e8", "filename": "crates/ide-completion/src/render.rs", "status": "modified", "additions": 2, "deletions": 5, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/410acd7188a5efb99f8629c7ff0630ce4935350a/crates%2Fide-completion%2Fsrc%2Frender.rs", "raw_url": "https://github.com/rust-lang/rust/raw/410acd7188a5efb99f8629c7ff0630ce4935350a/crates%2Fide-completion%2Fsrc%2Frender.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-completion%2Fsrc%2Frender.rs?ref=410acd7188a5efb99f8629c7ff0630ce4935350a", "patch": "@@ -152,6 +152,7 @@ pub(crate) fn render_field(\n             }\n         }\n     }\n+    item.doc_aliases(ctx.doc_aliases);\n     item.build()\n }\n \n@@ -361,11 +362,7 @@ fn render_resolution_simple_(\n         item.add_import(import_to_add);\n     }\n \n-    let doc_aliases = ctx.doc_aliases;\n-    if !doc_aliases.is_empty() {\n-        let doc_aliases = doc_aliases.into_iter().join(\", \").into();\n-        item.doc_aliases(doc_aliases);\n-    }\n+    item.doc_aliases(ctx.doc_aliases);\n     item\n }\n "}, {"sha": "5f53e5b6a9bc31af86ccaade197253490f0ae5b6", "filename": "crates/ide-completion/src/tests/special.rs", "status": "modified", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/410acd7188a5efb99f8629c7ff0630ce4935350a/crates%2Fide-completion%2Fsrc%2Ftests%2Fspecial.rs", "raw_url": "https://github.com/rust-lang/rust/raw/410acd7188a5efb99f8629c7ff0630ce4935350a/crates%2Fide-completion%2Fsrc%2Ftests%2Fspecial.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-completion%2Fsrc%2Ftests%2Fspecial.rs?ref=410acd7188a5efb99f8629c7ff0630ce4935350a", "patch": "@@ -1086,3 +1086,22 @@ fn here_we_go() {\n         \"#]],\n     );\n }\n+\n+#[test]\n+fn completes_field_name_via_doc_alias_in_fn_body() {\n+    check(\n+        r#\"\n+struct Foo {\n+    #[doc(alias = \"qux\")]\n+    bar: u8\n+};\n+\n+fn here_we_go() {\n+    let foo = Foo { q$0 }\n+}\n+\"#,\n+        expect![[r#\"\n+            fd bar (alias qux) u8\n+        \"#]],\n+    );\n+}"}]}