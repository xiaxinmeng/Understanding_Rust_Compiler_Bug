{"sha": "ea3ab731a3c762829e3f2bec5bfbaa3a3a84689f", "node_id": "MDY6Q29tbWl0NzI0NzEyOmVhM2FiNzMxYTNjNzYyODI5ZTNmMmJlYzViZmJhYTNhM2E4NDY4OWY=", "commit": {"author": {"name": "Brian Koropoff", "email": "bkoropoff@gmail.com", "date": "2014-10-04T21:04:10Z"}, "committer": {"name": "Brian Koropoff", "email": "bkoropoff@gmail.com", "date": "2014-10-05T07:23:33Z"}, "message": "Track kind of closure in upvar categorization\n\nKeep track of the kind of closure responsible for an upvar", "tree": {"sha": "f4b630cc34a2a7bb48989732b6991ff335f9ad44", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f4b630cc34a2a7bb48989732b6991ff335f9ad44"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ea3ab731a3c762829e3f2bec5bfbaa3a3a84689f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ea3ab731a3c762829e3f2bec5bfbaa3a3a84689f", "html_url": "https://github.com/rust-lang/rust/commit/ea3ab731a3c762829e3f2bec5bfbaa3a3a84689f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ea3ab731a3c762829e3f2bec5bfbaa3a3a84689f/comments", "author": {"login": "bkoropoff", "id": 2101303, "node_id": "MDQ6VXNlcjIxMDEzMDM=", "avatar_url": "https://avatars.githubusercontent.com/u/2101303?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bkoropoff", "html_url": "https://github.com/bkoropoff", "followers_url": "https://api.github.com/users/bkoropoff/followers", "following_url": "https://api.github.com/users/bkoropoff/following{/other_user}", "gists_url": "https://api.github.com/users/bkoropoff/gists{/gist_id}", "starred_url": "https://api.github.com/users/bkoropoff/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bkoropoff/subscriptions", "organizations_url": "https://api.github.com/users/bkoropoff/orgs", "repos_url": "https://api.github.com/users/bkoropoff/repos", "events_url": "https://api.github.com/users/bkoropoff/events{/privacy}", "received_events_url": "https://api.github.com/users/bkoropoff/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bkoropoff", "id": 2101303, "node_id": "MDQ6VXNlcjIxMDEzMDM=", "avatar_url": "https://avatars.githubusercontent.com/u/2101303?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bkoropoff", "html_url": "https://github.com/bkoropoff", "followers_url": "https://api.github.com/users/bkoropoff/followers", "following_url": "https://api.github.com/users/bkoropoff/following{/other_user}", "gists_url": "https://api.github.com/users/bkoropoff/gists{/gist_id}", "starred_url": "https://api.github.com/users/bkoropoff/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bkoropoff/subscriptions", "organizations_url": "https://api.github.com/users/bkoropoff/orgs", "repos_url": "https://api.github.com/users/bkoropoff/repos", "events_url": "https://api.github.com/users/bkoropoff/events{/privacy}", "received_events_url": "https://api.github.com/users/bkoropoff/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "20f4c45bade89f0a8df5297811af3d9f8b91d075", "url": "https://api.github.com/repos/rust-lang/rust/commits/20f4c45bade89f0a8df5297811af3d9f8b91d075", "html_url": "https://github.com/rust-lang/rust/commit/20f4c45bade89f0a8df5297811af3d9f8b91d075"}], "stats": {"total": 94, "additions": 61, "deletions": 33}, "files": [{"sha": "cd67169ff5690ce358a0e7c83d7ae15e4cb8e930", "filename": "src/librustc/middle/borrowck/gather_loans/gather_moves.rs", "status": "modified", "additions": 6, "deletions": 7, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/ea3ab731a3c762829e3f2bec5bfbaa3a3a84689f/src%2Flibrustc%2Fmiddle%2Fborrowck%2Fgather_loans%2Fgather_moves.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ea3ab731a3c762829e3f2bec5bfbaa3a3a84689f/src%2Flibrustc%2Fmiddle%2Fborrowck%2Fgather_loans%2Fgather_moves.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fborrowck%2Fgather_loans%2Fgather_moves.rs?ref=ea3ab731a3c762829e3f2bec5bfbaa3a3a84689f", "patch": "@@ -133,16 +133,15 @@ fn check_and_get_illegal_move_origin(bccx: &BorrowckCtxt,\n         mc::cat_deref(_, _, mc::BorrowedPtr(..)) |\n         mc::cat_deref(_, _, mc::Implicit(..)) |\n         mc::cat_deref(_, _, mc::UnsafePtr(..)) |\n-        mc::cat_upvar(..) | mc::cat_static_item |\n-        mc::cat_copied_upvar(mc::CopiedUpvar { onceness: ast::Many, .. }) => {\n+        mc::cat_upvar(..) | mc::cat_static_item => {\n             Some(cmt.clone())\n         }\n \n-        // Can move out of captured upvars only if the destination closure\n-        // type is 'once'. 1-shot stack closures emit the copied_upvar form\n-        // (see mem_categorization.rs).\n-        mc::cat_copied_upvar(mc::CopiedUpvar { onceness: ast::Once, .. }) => {\n-            None\n+        mc::cat_copied_upvar(mc::CopiedUpvar { kind: kind, .. }) => {\n+            match kind.onceness() {\n+                ast::Once => None,\n+                ast::Many => Some(cmt.clone())\n+            }\n         }\n \n         mc::cat_rvalue(..) |"}, {"sha": "29677cf897144d4c620fa8a88c630022012151eb", "filename": "src/librustc/middle/borrowck/gather_loans/move_error.rs", "status": "modified", "additions": 9, "deletions": 2, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/ea3ab731a3c762829e3f2bec5bfbaa3a3a84689f/src%2Flibrustc%2Fmiddle%2Fborrowck%2Fgather_loans%2Fmove_error.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ea3ab731a3c762829e3f2bec5bfbaa3a3a84689f/src%2Flibrustc%2Fmiddle%2Fborrowck%2Fgather_loans%2Fmove_error.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fborrowck%2Fgather_loans%2Fmove_error.rs?ref=ea3ab731a3c762829e3f2bec5bfbaa3a3a84689f", "patch": "@@ -115,8 +115,15 @@ fn report_cannot_move_out_of(bccx: &BorrowckCtxt, move_from: mc::cmt) {\n         mc::cat_deref(_, _, mc::BorrowedPtr(..)) |\n         mc::cat_deref(_, _, mc::Implicit(..)) |\n         mc::cat_deref(_, _, mc::UnsafePtr(..)) |\n-        mc::cat_upvar(..) | mc::cat_static_item |\n-        mc::cat_copied_upvar(mc::CopiedUpvar { onceness: ast::Many, .. }) => {\n+        mc::cat_upvar(..) | mc::cat_static_item => {\n+            bccx.span_err(\n+                move_from.span,\n+                format!(\"cannot move out of {}\",\n+                        bccx.cmt_to_string(&*move_from)).as_slice());\n+        }\n+\n+        mc::cat_copied_upvar(mc::CopiedUpvar { kind: kind, .. })\n+            if kind.onceness() == ast::Many => {\n             bccx.span_err(\n                 move_from.span,\n                 format!(\"cannot move out of {}\","}, {"sha": "f30a370d068526cf5831e9792a8e439321159bf0", "filename": "src/librustc/middle/borrowck/gather_loans/restrictions.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ea3ab731a3c762829e3f2bec5bfbaa3a3a84689f/src%2Flibrustc%2Fmiddle%2Fborrowck%2Fgather_loans%2Frestrictions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ea3ab731a3c762829e3f2bec5bfbaa3a3a84689f/src%2Flibrustc%2Fmiddle%2Fborrowck%2Fgather_loans%2Frestrictions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fborrowck%2Fgather_loans%2Frestrictions.rs?ref=ea3ab731a3c762829e3f2bec5bfbaa3a3a84689f", "patch": "@@ -72,7 +72,7 @@ impl<'a, 'tcx> RestrictionsContext<'a, 'tcx> {\n                 SafeIf(lp.clone(), vec![lp])\n             }\n \n-            mc::cat_upvar(upvar_id, _) => {\n+            mc::cat_upvar(upvar_id, _, _) => {\n                 // R-Variable, captured into closure\n                 let lp = Rc::new(LpUpvar(upvar_id));\n                 SafeIf(lp.clone(), vec![lp])"}, {"sha": "710193188eed31c3493bbe7b3f69bd878c649c3d", "filename": "src/librustc/middle/borrowck/mod.rs", "status": "modified", "additions": 8, "deletions": 4, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/ea3ab731a3c762829e3f2bec5bfbaa3a3a84689f/src%2Flibrustc%2Fmiddle%2Fborrowck%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ea3ab731a3c762829e3f2bec5bfbaa3a3a84689f/src%2Flibrustc%2Fmiddle%2Fborrowck%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fborrowck%2Fmod.rs?ref=ea3ab731a3c762829e3f2bec5bfbaa3a3a84689f", "patch": "@@ -354,18 +354,22 @@ pub fn opt_loan_path(cmt: &mc::cmt) -> Option<Rc<LoanPath>> {\n \n     match cmt.cat {\n         mc::cat_rvalue(..) |\n-        mc::cat_static_item |\n-        mc::cat_copied_upvar(mc::CopiedUpvar { onceness: ast::Many, .. }) => {\n+        mc::cat_static_item => {\n+            None\n+        }\n+\n+        mc::cat_copied_upvar(mc::CopiedUpvar { kind: kind, .. })\n+            if kind.onceness() == ast::Many => {\n             None\n         }\n \n         mc::cat_local(id) => {\n             Some(Rc::new(LpVar(id)))\n         }\n \n-        mc::cat_upvar(ty::UpvarId {var_id: id, closure_expr_id: proc_id}, _) |\n+        mc::cat_upvar(ty::UpvarId {var_id: id, closure_expr_id: proc_id}, _, _) |\n         mc::cat_copied_upvar(mc::CopiedUpvar { upvar_id: id,\n-                                               onceness: _,\n+                                               kind: _,\n                                                capturing_proc: proc_id }) => {\n             let upvar_id = ty::UpvarId{ var_id: id, closure_expr_id: proc_id };\n             Some(Rc::new(LpUpvar(upvar_id)))"}, {"sha": "207722eba00e4cd7a06d1de259708ae01e033967", "filename": "src/librustc/middle/mem_categorization.rs", "status": "modified", "additions": 34, "deletions": 16, "changes": 50, "blob_url": "https://github.com/rust-lang/rust/blob/ea3ab731a3c762829e3f2bec5bfbaa3a3a84689f/src%2Flibrustc%2Fmiddle%2Fmem_categorization.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ea3ab731a3c762829e3f2bec5bfbaa3a3a84689f/src%2Flibrustc%2Fmiddle%2Fmem_categorization.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fmem_categorization.rs?ref=ea3ab731a3c762829e3f2bec5bfbaa3a3a84689f", "patch": "@@ -83,7 +83,7 @@ pub enum categorization {\n     cat_rvalue(ty::Region),            // temporary val, argument is its scope\n     cat_static_item,\n     cat_copied_upvar(CopiedUpvar),     // upvar copied into proc env\n-    cat_upvar(ty::UpvarId, ty::UpvarBorrow), // by ref upvar from stack closure\n+    cat_upvar(ty::UpvarId, ty::UpvarBorrow, Option<ty::UnboxedClosureKind>), // by ref upvar from stack or unboxed closure\n     cat_local(ast::NodeId),            // local variable\n     cat_deref(cmt, uint, PointerKind), // deref of a ptr\n     cat_interior(cmt, InteriorKind),   // something interior: field, tuple, etc\n@@ -93,10 +93,27 @@ pub enum categorization {\n     // (*1) downcast is only required if the enum has more than one variant\n }\n \n+#[deriving(Clone, PartialEq)]\n+pub enum CopiedUpvarKind {\n+    Boxed(ast::Onceness),\n+    Unboxed(ty::UnboxedClosureKind)\n+}\n+\n+impl CopiedUpvarKind {\n+    pub fn onceness(&self) -> ast::Onceness {\n+        match *self {\n+            Boxed(onceness) => onceness,\n+            Unboxed(ty::FnUnboxedClosureKind) |\n+            Unboxed(ty::FnMutUnboxedClosureKind) => ast::Many,\n+            Unboxed(ty::FnOnceUnboxedClosureKind) => ast::Once\n+        }\n+    }\n+}\n+\n #[deriving(Clone, PartialEq)]\n pub struct CopiedUpvar {\n     pub upvar_id: ast::NodeId,\n-    pub onceness: ast::Onceness,\n+    pub kind: CopiedUpvarKind,\n     pub capturing_proc: ast::NodeId,\n }\n \n@@ -571,14 +588,14 @@ impl<'t,'tcx,TYPER:Typer<'tcx>> MemCategorizationContext<'t,TYPER> {\n \n                       };\n                       if var_is_refd {\n-                          self.cat_upvar(id, span, var_id, fn_node_id)\n+                          self.cat_upvar(id, span, var_id, fn_node_id, None)\n                       } else {\n                           Ok(Rc::new(cmt_ {\n                               id:id,\n                               span:span,\n                               cat:cat_copied_upvar(CopiedUpvar {\n                                   upvar_id: var_id,\n-                                  onceness: closure_ty.onceness,\n+                                  kind: Boxed(closure_ty.onceness),\n                                   capturing_proc: fn_node_id,\n                               }),\n                               mutbl: MutabilityCategory::from_local(self.tcx(), var_id),\n@@ -591,20 +608,15 @@ impl<'t,'tcx,TYPER:Typer<'tcx>> MemCategorizationContext<'t,TYPER> {\n                                                  .unboxed_closures()\n                                                  .borrow();\n                       let kind = unboxed_closures.get(&closure_id).kind;\n-                      let onceness = match kind {\n-                          ty::FnUnboxedClosureKind |\n-                          ty::FnMutUnboxedClosureKind => ast::Many,\n-                          ty::FnOnceUnboxedClosureKind => ast::Once,\n-                      };\n                       if self.typer.capture_mode(fn_node_id) == ast::CaptureByRef {\n-                          self.cat_upvar(id, span, var_id, fn_node_id)\n+                          self.cat_upvar(id, span, var_id, fn_node_id, Some(kind))\n                       } else {\n                           Ok(Rc::new(cmt_ {\n                               id: id,\n                               span: span,\n                               cat: cat_copied_upvar(CopiedUpvar {\n                                   upvar_id: var_id,\n-                                  onceness: onceness,\n+                                  kind: Unboxed(kind),\n                                   capturing_proc: fn_node_id,\n                               }),\n                               mutbl: MutabilityCategory::from_local(self.tcx(), var_id),\n@@ -638,7 +650,8 @@ impl<'t,'tcx,TYPER:Typer<'tcx>> MemCategorizationContext<'t,TYPER> {\n                  id: ast::NodeId,\n                  span: Span,\n                  var_id: ast::NodeId,\n-                 fn_node_id: ast::NodeId)\n+                 fn_node_id: ast::NodeId,\n+                 kind: Option<ty::UnboxedClosureKind>)\n                  -> McResult<cmt> {\n         /*!\n          * Upvars through a closure are in fact indirect\n@@ -666,7 +679,7 @@ impl<'t,'tcx,TYPER:Typer<'tcx>> MemCategorizationContext<'t,TYPER> {\n         let base_cmt = Rc::new(cmt_ {\n             id:id,\n             span:span,\n-            cat:cat_upvar(upvar_id, upvar_borrow),\n+            cat:cat_upvar(upvar_id, upvar_borrow, kind),\n             mutbl:McImmutable,\n             ty:upvar_ty,\n         });\n@@ -1287,16 +1300,21 @@ impl cmt_ {\n                 b.freely_aliasable(ctxt)\n             }\n \n-            cat_copied_upvar(CopiedUpvar {onceness: ast::Once, ..}) |\n             cat_rvalue(..) |\n             cat_local(..) |\n             cat_upvar(..) |\n             cat_deref(_, _, UnsafePtr(..)) => { // yes, it's aliasable, but...\n                 None\n             }\n \n-            cat_copied_upvar(CopiedUpvar {onceness: ast::Many, ..}) => {\n-                Some(AliasableOther)\n+            cat_copied_upvar(CopiedUpvar {kind: kind, capturing_proc: id, ..}) => {\n+                match kind {\n+                    Boxed(ast::Once) |\n+                    Unboxed(ty::FnOnceUnboxedClosureKind) |\n+                    Unboxed(ty::FnMutUnboxedClosureKind) => None,\n+                    Boxed(_) => Some(AliasableOther),\n+                    Unboxed(_) => Some(AliasableClosure(id))\n+                }\n             }\n \n             cat_static_item(..) => {"}, {"sha": "f533079be69b3ee77b3836ccd859cb38ad6de4f1", "filename": "src/librustc/middle/typeck/check/regionck.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/ea3ab731a3c762829e3f2bec5bfbaa3a3a84689f/src%2Flibrustc%2Fmiddle%2Ftypeck%2Fcheck%2Fregionck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ea3ab731a3c762829e3f2bec5bfbaa3a3a84689f/src%2Flibrustc%2Fmiddle%2Ftypeck%2Fcheck%2Fregionck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftypeck%2Fcheck%2Fregionck.rs?ref=ea3ab731a3c762829e3f2bec5bfbaa3a3a84689f", "patch": "@@ -1552,7 +1552,7 @@ fn link_reborrowed_region(rcx: &Rcx,\n \n     // Detect references to an upvar `x`:\n     let cause = match ref_cmt.cat {\n-        mc::cat_upvar(ref upvar_id, _) => {\n+        mc::cat_upvar(ref upvar_id, _, _) => {\n             let mut upvar_borrow_map =\n                 rcx.fcx.inh.upvar_borrow_map.borrow_mut();\n             match upvar_borrow_map.find_mut(upvar_id) {\n@@ -1686,7 +1686,7 @@ fn adjust_upvar_borrow_kind_for_mut(rcx: &Rcx,\n             mc::cat_deref(base, _, mc::BorrowedPtr(..)) |\n             mc::cat_deref(base, _, mc::Implicit(..)) => {\n                 match base.cat {\n-                    mc::cat_upvar(ref upvar_id, _) => {\n+                    mc::cat_upvar(ref upvar_id, _, _) => {\n                         // if this is an implicit deref of an\n                         // upvar, then we need to modify the\n                         // borrow_kind of the upvar to make sure it\n@@ -1739,7 +1739,7 @@ fn adjust_upvar_borrow_kind_for_unique(rcx: &Rcx, cmt: mc::cmt) {\n             mc::cat_deref(base, _, mc::BorrowedPtr(..)) |\n             mc::cat_deref(base, _, mc::Implicit(..)) => {\n                 match base.cat {\n-                    mc::cat_upvar(ref upvar_id, _) => {\n+                    mc::cat_upvar(ref upvar_id, _, _) => {\n                         // if this is an implicit deref of an\n                         // upvar, then we need to modify the\n                         // borrow_kind of the upvar to make sure it"}]}