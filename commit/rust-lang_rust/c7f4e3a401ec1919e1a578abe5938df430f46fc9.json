{"sha": "c7f4e3a401ec1919e1a578abe5938df430f46fc9", "node_id": "MDY6Q29tbWl0NzI0NzEyOmM3ZjRlM2E0MDFlYzE5MTllMWE1NzhhYmU1OTM4ZGY0MzBmNDZmYzk=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-01-26T18:12:16Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-01-27T19:57:18Z"}, "message": "show jemalloc", "tree": {"sha": "35954f48b7c50ba6e13fbd0bc4a66c7807225fca", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/35954f48b7c50ba6e13fbd0bc4a66c7807225fca"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c7f4e3a401ec1919e1a578abe5938df430f46fc9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c7f4e3a401ec1919e1a578abe5938df430f46fc9", "html_url": "https://github.com/rust-lang/rust/commit/c7f4e3a401ec1919e1a578abe5938df430f46fc9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c7f4e3a401ec1919e1a578abe5938df430f46fc9/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "09b5dc8e02317c14cff80890f2d4591843322f47", "url": "https://api.github.com/repos/rust-lang/rust/commits/09b5dc8e02317c14cff80890f2d4591843322f47", "html_url": "https://github.com/rust-lang/rust/commit/09b5dc8e02317c14cff80890f2d4591843322f47"}], "stats": {"total": 74, "additions": 73, "deletions": 1}, "files": [{"sha": "c8d29e3b7a2edfaa981d36f098f438576e8bfbe6", "filename": "Cargo.lock", "status": "modified", "additions": 39, "deletions": 0, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/c7f4e3a401ec1919e1a578abe5938df430f46fc9/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/c7f4e3a401ec1919e1a578abe5938df430f46fc9/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=c7f4e3a401ec1919e1a578abe5938df430f46fc9", "patch": "@@ -380,6 +380,11 @@ name = \"fnv\"\n version = \"1.0.6\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n \n+[[package]]\n+name = \"fs_extra\"\n+version = \"1.1.0\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+\n [[package]]\n name = \"fsevent\"\n version = \"0.2.17\"\n@@ -551,6 +556,34 @@ name = \"itoa\"\n version = \"0.4.3\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n \n+[[package]]\n+name = \"jemalloc-ctl\"\n+version = \"0.2.0\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+dependencies = [\n+ \"jemalloc-sys 0.1.8 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"libc 0.2.48 (registry+https://github.com/rust-lang/crates.io-index)\",\n+]\n+\n+[[package]]\n+name = \"jemalloc-sys\"\n+version = \"0.1.8\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+dependencies = [\n+ \"cc 1.0.28 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"fs_extra 1.1.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"libc 0.2.48 (registry+https://github.com/rust-lang/crates.io-index)\",\n+]\n+\n+[[package]]\n+name = \"jemallocator\"\n+version = \"0.1.9\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+dependencies = [\n+ \"jemalloc-sys 0.1.8 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"libc 0.2.48 (registry+https://github.com/rust-lang/crates.io-index)\",\n+]\n+\n [[package]]\n name = \"join_to_string\"\n version = \"0.1.3\"\n@@ -920,6 +953,8 @@ dependencies = [\n  \"fst 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"insta 0.5.2 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"itertools 0.8.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"jemalloc-ctl 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"jemallocator 0.1.9 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"join_to_string 0.1.3 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"log 0.4.6 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"parking_lot 0.7.1 (registry+https://github.com/rust-lang/crates.io-index)\",\n@@ -1866,6 +1901,7 @@ dependencies = [\n \"checksum filetime 0.2.4 (registry+https://github.com/rust-lang/crates.io-index)\" = \"a2df5c1a8c4be27e7707789dc42ae65976e60b394afd293d1419ab915833e646\"\n \"checksum flexi_logger 0.10.5 (registry+https://github.com/rust-lang/crates.io-index)\" = \"bbd731387787f54fa333fa426e173fe42ea3d1123636b2b27ad802025fc5d182\"\n \"checksum fnv 1.0.6 (registry+https://github.com/rust-lang/crates.io-index)\" = \"2fad85553e09a6f881f739c29f0b00b0f01357c743266d478b68951ce23285f3\"\n+\"checksum fs_extra 1.1.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"5f2a4a2034423744d2cc7ca2068453168dcdb82c438419e639a26bd87839c674\"\n \"checksum fsevent 0.2.17 (registry+https://github.com/rust-lang/crates.io-index)\" = \"c4bbbf71584aeed076100b5665ac14e3d85eeb31fdbb45fbd41ef9a682b5ec05\"\n \"checksum fsevent-sys 0.1.6 (registry+https://github.com/rust-lang/crates.io-index)\" = \"1a772d36c338d07a032d5375a36f15f9a7043bf0cb8ce7cee658e037c6032874\"\n \"checksum fst 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)\" = \"db72126ca7dff566cdbbdd54af44668c544897d9d3862b198141f176f1238bdf\"\n@@ -1885,6 +1921,9 @@ dependencies = [\n \"checksum iovec 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)\" = \"dbe6e417e7d0975db6512b90796e8ce223145ac4e33c377e4a42882a0e88bb08\"\n \"checksum itertools 0.8.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"5b8467d9c1cebe26feb08c640139247fac215782d35371ade9a2136ed6085358\"\n \"checksum itoa 0.4.3 (registry+https://github.com/rust-lang/crates.io-index)\" = \"1306f3464951f30e30d12373d31c79fbd52d236e5e896fd92f96ec7babbbe60b\"\n+\"checksum jemalloc-ctl 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"4e93b0f37e7d735c6b610176d5b1bde8e1621ff3f6f7ac23cdfa4e7f7d0111b5\"\n+\"checksum jemalloc-sys 0.1.8 (registry+https://github.com/rust-lang/crates.io-index)\" = \"bfc62c8e50e381768ce8ee0428ee53741929f7ebd73e4d83f669bcf7693e00ae\"\n+\"checksum jemallocator 0.1.9 (registry+https://github.com/rust-lang/crates.io-index)\" = \"9f0cd42ac65f758063fea55126b0148b1ce0a6354ff78e07a4d6806bc65c4ab3\"\n \"checksum join_to_string 0.1.3 (registry+https://github.com/rust-lang/crates.io-index)\" = \"4dc7a5290e8c2606ce2be49f456d50f69173cb96d1541e4f66e34ac8b331a98f\"\n \"checksum kernel32-sys 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)\" = \"7507624b29483431c0ba2d82aece8ca6cdba9382bff4ddd0f7490560c056098d\"\n \"checksum lazy_static 1.2.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"a374c89b9db55895453a74c1e38861d9deec0b01b405a82516e9d5de4820dea1\""}, {"sha": "ad9dd20882f045586d0ae01eccc8c74970e366b7", "filename": "crates/ra_ide_api/Cargo.toml", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/c7f4e3a401ec1919e1a578abe5938df430f46fc9/crates%2Fra_ide_api%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/c7f4e3a401ec1919e1a578abe5938df430f46fc9/crates%2Fra_ide_api%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2FCargo.toml?ref=c7f4e3a401ec1919e1a578abe5938df430f46fc9", "patch": "@@ -14,6 +14,8 @@ fst = \"0.3.1\"\n rustc-hash = \"1.0\"\n parking_lot = \"0.7.0\"\n unicase = \"2.2.0\"\n+jemallocator = \"0.1.9\"\n+jemalloc-ctl = \"0.2.0\"\n \n ra_syntax = { path = \"../ra_syntax\" }\n ra_ide_api_light = { path = \"../ra_ide_api_light\" }"}, {"sha": "dc531e068d248be3ae19a803217aef606e6fb382", "filename": "crates/ra_ide_api/src/lib.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/c7f4e3a401ec1919e1a578abe5938df430f46fc9/crates%2Fra_ide_api%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c7f4e3a401ec1919e1a578abe5938df430f46fc9/crates%2Fra_ide_api%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2Fsrc%2Flib.rs?ref=c7f4e3a401ec1919e1a578abe5938df430f46fc9", "patch": "@@ -59,6 +59,11 @@ pub use ra_db::{\n     Canceled, CrateGraph, CrateId, FileId, FilePosition, FileRange, SourceRootId\n };\n \n+// We use jemalloc mainly to get heap usage statistics, actual performance\n+// differnece is not measures.\n+#[global_allocator]\n+static ALLOC: jemallocator::Jemalloc = jemallocator::Jemalloc;\n+\n pub type Cancelable<T> = Result<T, Canceled>;\n \n #[derive(Default)]"}, {"sha": "686ab97d28bc6d9de1e70ce55c52f08651fca65c", "filename": "crates/ra_ide_api/src/status.rs", "status": "modified", "additions": 27, "deletions": 1, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/c7f4e3a401ec1919e1a578abe5938df430f46fc9/crates%2Fra_ide_api%2Fsrc%2Fstatus.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c7f4e3a401ec1919e1a578abe5938df430f46fc9/crates%2Fra_ide_api%2Fsrc%2Fstatus.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2Fsrc%2Fstatus.rs?ref=c7f4e3a401ec1919e1a578abe5938df430f46fc9", "patch": "@@ -30,11 +30,12 @@ pub(crate) fn status(db: &RootDatabase) -> String {\n         interner.len()\n     };\n     format!(\n-        \"{}\\n{}\\n{}\\nn_defs {}\\nGC {:?} seconds ago\",\n+        \"{}\\n{}\\n{}\\nn_defs {}\\n\\njemalloc: {}\\nGC {:?} seconds ago\",\n         files_stats,\n         symbols_stats,\n         syntax_tree_stats,\n         n_defs,\n+        MemoryStats::current(),\n         db.last_gc.elapsed().as_secs(),\n     )\n }\n@@ -126,6 +127,31 @@ impl FromIterator<TableEntry<SourceRootId, Arc<SymbolIndex>>> for LibrarySymbols\n     }\n }\n \n+struct MemoryStats {\n+    allocated: Bytes,\n+    resident: Bytes,\n+}\n+\n+impl MemoryStats {\n+    fn current() -> MemoryStats {\n+        jemalloc_ctl::epoch().unwrap();\n+        MemoryStats {\n+            allocated: Bytes(jemalloc_ctl::stats::allocated().unwrap()),\n+            resident: Bytes(jemalloc_ctl::stats::resident().unwrap()),\n+        }\n+    }\n+}\n+\n+impl fmt::Display for MemoryStats {\n+    fn fmt(&self, fmt: &mut fmt::Formatter) -> fmt::Result {\n+        write!(\n+            fmt,\n+            \"{} allocated {} resident\",\n+            self.allocated, self.resident,\n+        )\n+    }\n+}\n+\n #[derive(Default)]\n struct Bytes(usize);\n "}]}