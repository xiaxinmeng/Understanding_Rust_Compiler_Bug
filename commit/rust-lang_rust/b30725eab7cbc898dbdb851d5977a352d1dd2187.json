{"sha": "b30725eab7cbc898dbdb851d5977a352d1dd2187", "node_id": "C_kwDOAAsO6NoAKGIzMDcyNWVhYjdjYmM4OThkYmRiODUxZDU5NzdhMzUyZDFkZDIxODc", "commit": {"author": {"name": "Jacob Hoffman-Andrews", "email": "github@hoffman-andrews.com", "date": "2022-01-23T21:04:17Z"}, "committer": {"name": "Jacob Hoffman-Andrews", "email": "github@hoffman-andrews.com", "date": "2022-01-24T01:17:58Z"}, "message": "Update theme on pageshow event\n\nWhen a user goes forward or back, the page may be rendered from the\nback/forward cache (https://web.dev/bfcache/) rather than from scratch. If\nthey have changed theme in the meantime, that means seeing an incorrect\ntheme on the page they went forward or back to. The `pageshow` event\nfires on such navigations, so we can update the theme based on that event.", "tree": {"sha": "9a05506967de6c93f4161043cd836bbf122bbbf4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9a05506967de6c93f4161043cd836bbf122bbbf4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b30725eab7cbc898dbdb851d5977a352d1dd2187", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b30725eab7cbc898dbdb851d5977a352d1dd2187", "html_url": "https://github.com/rust-lang/rust/commit/b30725eab7cbc898dbdb851d5977a352d1dd2187", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b30725eab7cbc898dbdb851d5977a352d1dd2187/comments", "author": {"login": "jsha", "id": 220205, "node_id": "MDQ6VXNlcjIyMDIwNQ==", "avatar_url": "https://avatars.githubusercontent.com/u/220205?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jsha", "html_url": "https://github.com/jsha", "followers_url": "https://api.github.com/users/jsha/followers", "following_url": "https://api.github.com/users/jsha/following{/other_user}", "gists_url": "https://api.github.com/users/jsha/gists{/gist_id}", "starred_url": "https://api.github.com/users/jsha/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jsha/subscriptions", "organizations_url": "https://api.github.com/users/jsha/orgs", "repos_url": "https://api.github.com/users/jsha/repos", "events_url": "https://api.github.com/users/jsha/events{/privacy}", "received_events_url": "https://api.github.com/users/jsha/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jsha", "id": 220205, "node_id": "MDQ6VXNlcjIyMDIwNQ==", "avatar_url": "https://avatars.githubusercontent.com/u/220205?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jsha", "html_url": "https://github.com/jsha", "followers_url": "https://api.github.com/users/jsha/followers", "following_url": "https://api.github.com/users/jsha/following{/other_user}", "gists_url": "https://api.github.com/users/jsha/gists{/gist_id}", "starred_url": "https://api.github.com/users/jsha/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jsha/subscriptions", "organizations_url": "https://api.github.com/users/jsha/orgs", "repos_url": "https://api.github.com/users/jsha/repos", "events_url": "https://api.github.com/users/jsha/events{/privacy}", "received_events_url": "https://api.github.com/users/jsha/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "84322efad553c7a79c80189f2d1b9197c1aa005f", "url": "https://api.github.com/repos/rust-lang/rust/commits/84322efad553c7a79c80189f2d1b9197c1aa005f", "html_url": "https://github.com/rust-lang/rust/commit/84322efad553c7a79c80189f2d1b9197c1aa005f"}], "stats": {"total": 31, "additions": 25, "deletions": 6}, "files": [{"sha": "06bb34eb11573c70165dcd4f8a8a8584e7154377", "filename": "src/librustdoc/html/static/js/storage.js", "status": "modified", "additions": 25, "deletions": 6, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/b30725eab7cbc898dbdb851d5977a352d1dd2187/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fstorage.js", "raw_url": "https://github.com/rust-lang/rust/raw/b30725eab7cbc898dbdb851d5977a352d1dd2187/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fstorage.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fstorage.js?ref=b30725eab7cbc898dbdb851d5977a352d1dd2187", "patch": "@@ -216,6 +216,15 @@ var updateSystemTheme = (function() {\n     };\n })();\n \n+function switchToSavedTheme() {\n+    switchTheme(\n+        window.currentTheme,\n+        window.mainTheme,\n+        getSettingValue(\"theme\") || \"light\",\n+        false\n+    );\n+}\n+\n if (getSettingValue(\"use-system-theme\") !== \"false\" && window.matchMedia) {\n     // update the preferred dark theme if the user is already using a dark theme\n     // See https://github.com/rust-lang/rust/pull/77809#issuecomment-707875732\n@@ -228,10 +237,20 @@ if (getSettingValue(\"use-system-theme\") !== \"false\" && window.matchMedia) {\n     // call the function to initialize the theme at least once!\n     updateSystemTheme();\n } else {\n-    switchTheme(\n-        window.currentTheme,\n-        window.mainTheme,\n-        getSettingValue(\"theme\") || \"light\",\n-        false\n-    );\n+    switchToSavedTheme();\n }\n+\n+// If we navigate away (for example to a settings page), and then use the back or\n+// forward button to get back to a page, the theme may have changed in the meantime.\n+// But scripts may not be re-loaded in such a case due to the bfcache\n+// (https://web.dev/bfcache/). The \"pageshow\" event triggers on such navigations.\n+// Use that opportunity to update the theme.\n+// We use a setTimeout with a 0 timeout here to put the change on the event queue.\n+// For some reason, if we try to change the theme while the `pageshow` event is\n+// running, it sometimes fails to take effect. The problem manifests on Chrome,\n+// specifically when talking to a remote website with no caching.\n+window.addEventListener(\"pageshow\", function(ev) {\n+    if (ev.persisted) {\n+        setTimeout(switchToSavedTheme, 0);\n+    }\n+});"}]}