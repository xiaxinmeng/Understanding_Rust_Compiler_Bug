{"sha": "c6e2ba43bbfef80d4ecabbc9edd5be9d058f6db9", "node_id": "MDY6Q29tbWl0NzI0NzEyOmM2ZTJiYTQzYmJmZWY4MGQ0ZWNhYmJjOWVkZDViZTlkMDU4ZjZkYjk=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-05-11T22:27:50Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-05-11T22:27:50Z"}, "message": "Merge #8806\n\n8806: fix: Strip delimiter from fn-like macro invocations r=jonas-schievink a=jonas-schievink\n\nThis broke in https://github.com/rust-analyzer/rust-analyzer/pull/8796 (again), the fix is easy though\r\n\r\nbors r+\n\nCo-authored-by: Jonas Schievink <jonasschievink@gmail.com>", "tree": {"sha": "3fba6b5419e7b39dd922387d12c90e3111845b11", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3fba6b5419e7b39dd922387d12c90e3111845b11"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c6e2ba43bbfef80d4ecabbc9edd5be9d058f6db9", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgmwTmCRBK7hj4Ov3rIwAAdogIAEaeow745WdCD0YSrhCbYaLN\nZ5dnRAAmuwbjdAUXVWuLFt9lcQ1iJBCWnePB0hlxEgOwHHXsbURwCOXwowUiZPlu\n4rc3WIGFpEAwSKVXEBZ73Gt1E2WBYxMJgTay4P3IONYstM2UgfHFNxfYtP7x610d\nzvBrSx/Ed3EBJYsxu7ToQ2oS+ZctpnY6bh/OuXk8VC4LNGOtZGvHEQ2Dvjv316e8\npu78OdqF2YuxYiK+9cctuXaqsr+RelTMFikP1ngqtU+yUVjjWu6osxBq2OsqpqhX\nmbp+O3SIBTu11Lvoo5CslP8kVCDQsintHNFiJcm22EKYVJgry3BxyoD7HNatOa8=\n=B9Qk\n-----END PGP SIGNATURE-----\n", "payload": "tree 3fba6b5419e7b39dd922387d12c90e3111845b11\nparent acde43f7c945e4f6728b1a3614d517894f6c5579\nparent bda68e23328ca62a71da348a13c4d13cc8f991f3\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1620772070 +0000\ncommitter GitHub <noreply@github.com> 1620772070 +0000\n\nMerge #8806\n\n8806: fix: Strip delimiter from fn-like macro invocations r=jonas-schievink a=jonas-schievink\n\nThis broke in https://github.com/rust-analyzer/rust-analyzer/pull/8796 (again), the fix is easy though\r\n\r\nbors r+\n\nCo-authored-by: Jonas Schievink <jonasschievink@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c6e2ba43bbfef80d4ecabbc9edd5be9d058f6db9", "html_url": "https://github.com/rust-lang/rust/commit/c6e2ba43bbfef80d4ecabbc9edd5be9d058f6db9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c6e2ba43bbfef80d4ecabbc9edd5be9d058f6db9/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "acde43f7c945e4f6728b1a3614d517894f6c5579", "url": "https://api.github.com/repos/rust-lang/rust/commits/acde43f7c945e4f6728b1a3614d517894f6c5579", "html_url": "https://github.com/rust-lang/rust/commit/acde43f7c945e4f6728b1a3614d517894f6c5579"}, {"sha": "bda68e23328ca62a71da348a13c4d13cc8f991f3", "url": "https://api.github.com/repos/rust-lang/rust/commits/bda68e23328ca62a71da348a13c4d13cc8f991f3", "html_url": "https://github.com/rust-lang/rust/commit/bda68e23328ca62a71da348a13c4d13cc8f991f3"}], "stats": {"total": 35, "additions": 33, "deletions": 2}, "files": [{"sha": "860aa049ba0b531858ae7c4d8b4ada07be2fedcd", "filename": "crates/hir_expand/src/input.rs", "status": "modified", "additions": 29, "deletions": 2, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/c6e2ba43bbfef80d4ecabbc9edd5be9d058f6db9/crates%2Fhir_expand%2Fsrc%2Finput.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c6e2ba43bbfef80d4ecabbc9edd5be9d058f6db9/crates%2Fhir_expand%2Fsrc%2Finput.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_expand%2Fsrc%2Finput.rs?ref=c6e2ba43bbfef80d4ecabbc9edd5be9d058f6db9", "patch": "@@ -1,8 +1,9 @@\n //! Macro input conditioning.\n \n+use parser::SyntaxKind;\n use syntax::{\n     ast::{self, AttrsOwner},\n-    AstNode, SyntaxNode,\n+    AstNode, SyntaxElement, SyntaxNode,\n };\n \n use crate::{\n@@ -19,7 +20,33 @@ pub(crate) fn process_macro_input(\n     let loc: MacroCallLoc = db.lookup_intern_macro(id);\n \n     match loc.kind {\n-        MacroCallKind::FnLike { .. } => node,\n+        MacroCallKind::FnLike { .. } => {\n+            if !loc.def.is_proc_macro() {\n+                // MBE macros expect the parentheses as part of their input.\n+                return node;\n+            }\n+\n+            // The input includes the `(` + `)` delimiter tokens, so remove them before passing this\n+            // to the macro.\n+            let node = node.clone_for_update();\n+            if let Some(SyntaxElement::Token(tkn)) = node.first_child_or_token() {\n+                if matches!(\n+                    tkn.kind(),\n+                    SyntaxKind::L_BRACK | SyntaxKind::L_PAREN | SyntaxKind::L_CURLY\n+                ) {\n+                    tkn.detach();\n+                }\n+            }\n+            if let Some(SyntaxElement::Token(tkn)) = node.last_child_or_token() {\n+                if matches!(\n+                    tkn.kind(),\n+                    SyntaxKind::R_BRACK | SyntaxKind::R_PAREN | SyntaxKind::R_CURLY\n+                ) {\n+                    tkn.detach();\n+                }\n+            }\n+            node\n+        }\n         MacroCallKind::Derive { derive_attr_index, .. } => {\n             let item = match ast::Item::cast(node.clone()) {\n                 Some(item) => item,"}, {"sha": "88cb16ca4d13fe36a4a4e211e1f5d77b86b59d09", "filename": "crates/hir_expand/src/lib.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/c6e2ba43bbfef80d4ecabbc9edd5be9d058f6db9/crates%2Fhir_expand%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c6e2ba43bbfef80d4ecabbc9edd5be9d058f6db9/crates%2Fhir_expand%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_expand%2Fsrc%2Flib.rs?ref=c6e2ba43bbfef80d4ecabbc9edd5be9d058f6db9", "patch": "@@ -272,6 +272,10 @@ impl MacroDefId {\n         };\n         Either::Left(*id)\n     }\n+\n+    pub fn is_proc_macro(&self) -> bool {\n+        matches!(self.kind, MacroDefKind::ProcMacro(..))\n+    }\n }\n \n #[derive(Debug, Clone, Copy, PartialEq, Eq, Hash)]"}]}