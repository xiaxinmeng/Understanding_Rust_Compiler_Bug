{"sha": "433aae93e4ef866a1fdfefad136b32ed89acd3e7", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQzM2FhZTkzZTRlZjg2NmExZmRmZWZhZDEzNmIzMmVkODlhY2QzZTc=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-02-14T19:59:05Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-02-14T19:59:05Z"}, "message": "Auto merge of #69115 - ehuss:update-books, r=Dylan-DPC\n\nUpdate books.\n\nThis required some changes in how the books are tested due to some changes in rust-lang/book.  It uses new syntax that is not compatible with bare `rustdoc --test`.  This changes it so that it uses rustbook to run the tests, which is essentially the same as `mdbook test`.\n\n## reference\n\n7 commits in 11e893fc1357bc688418ddf1087c2b7aa25d154d..64239df6d173562b9deb4f012e4c3e6e960c4754\n2020-01-18 21:24:08 +0100 to 2020-02-10 19:05:13 +0100\n- Update for nested receivers. (rust-lang-nursery/reference#724)\n- clarify note re. leading `::` in 2018 (rust-lang-nursery/reference#752)\n- Update macro-ambiguity.md (rust-lang-nursery/reference#754)\n- typo fix: add missing `by` (rust-lang-nursery/reference#753)\n- fix `TypeParamBounds` link on trait objects (rust-lang-nursery/reference#749)\n- reorganize docs on references (rust-lang-nursery/reference#745)\n- add MacroRepOp usage for ? (rust-lang-nursery/reference#744)\n\n## book\n\n49 commits in 87dd6843678575f8dda962f239d14ef4be14b352..6fb3705e5230311b096d47f7e2c91f9ce24393d0\n2020-01-20 15:20:40 -0500 to 2020-02-12 13:48:57 -0500\n- Fix nomicon links. (rust-lang/book#2253)\n- Update to Rust 1.41.0 (rust-lang/book#2244)\n- Listing 19-6: use ptr.add instead of ptr.offset (rust-lang/book#2201)\n- Remove unneeded mutable reference\n- Clarify deref coercion explanation\n- Fix typo in link to 1.30 book\n- Acknowledge Murphy's Law\n- Clarify that buffer overread is UB in C\n- Change from \"must\" to \"idiomatic\" about comments\n- Fancy quotes\n- Make HashMap types match previous example; add fwd ref to ch 13\n- Tweak wording to array clarification\n- Merge remote-tracking branch 'origin/pr/2236'\n- Update all our crates (rust-lang/book#2235)\n- Reword git caveat\n- Merge remote-tracking branch 'origin/pr/2234'\n- Merge remote-tracking branch 'origin/pr/2230'\n- println! is a macro (rust-lang/book#2224)\n- Update a translated version link (rust-lang/book#2221)\n- move `Macro invocation` from section on tuple to section on mac\u2026 (rust-lang/book#2206)\n- Do not limit `Self` usage in trait implementation (rust-lang/book#2197)\n- Merge remote-tracking branch 'origin/pr/2191'\n- Fix wrapping\n- Merge remote-tracking branch 'origin/pr/2187'\n- Updated appendix 07 to reflect deprecation of rustup install (rust-lang/book#2181)\n- Make links to the Nomicon consistent\n- Merge remote-tracking branch 'origin/pr/2180'\n- Merge remote-tracking branch 'origin/pr/2175'\n- Merge remote-tracking branch 'origin/pr/2171'\n- Merge remote-tracking branch 'origin/pr/2170'\n- Clarify and make consistent the explanation of unions\n- Merge remote-tracking branch 'origin/pr/2166'\n- Handle dev or test in the Finished output line\n- Link to macros by example rather than macros (rust-lang/book#2164)\n- Merge remote-tracking branch 'origin/pr/2147'\n- Fix parens (rust-lang/book#2132)\n- Clarify type inference with closures requires calling the closures\n- Update link to French translation (rust-lang/book#2119)\n- Merge remote-tracking branch 'origin/pr/2108'\n- Add an explicit cross reference to data type\n- Merge remote-tracking branch 'origin/pr/2105'\n- ch15-02-deref: Improve explanation on immut-to-mut (rust-lang/book#2030)\n- Remove unnecessary quotes\n- Make markdown link identifier match\n- Remove extra newline\n- Merge remote-tracking branch 'origin/pr/2004'\n- Extract code and output; script formatting and updating them (rust-lang/book#2231)\n- Switch \"Finally\" to \"Next\" to reflect new chapters having been\u2026 (rust-lang/book#2098)\n- ch19-06 added curly braces to macro output (rust-lang/book#2050)\n\n## rust-by-example\n\n2 commits in 1c2bd024d13f8011307e13386cf1fea2180352b5..32facd5522ddbbf37baf01e4e4b6562bc55c071a\n2020-01-20 12:18:36 -0300 to 2020-02-11 09:25:06 -0300\n- Add missing `dyn` in code sample (rust-lang/rust-by-example#1306)\n- Improve grammar in a few sections (rust-lang/rust-by-example#1305)\n\n## edition-guide\n\n1 commits in 1a2390247ad6d08160e0dd74f40a01a9578659c2..37f9e6848411188a1062ead1bd8ebe4b8aa16899\n2019-12-29 10:40:55 -0800 to 2020-02-10 14:36:14 +0100\n- Fixed typo (rust-lang-nursery/edition-guide#196)\n\n## embedded-book\n\n4 commits in 4d78994915af1bde9a95c04a8c27d8dca066232a..b2e1092bf67bd4d7686c4553f186edbb7f5f92db\n2020-01-14 08:25:25 +0000 to 2020-01-30 08:45:46 +0000\n- Make typestate initialization notes correct  (rust-embedded/book#224)\n- Mention discovery book more prominently  (rust-embedded/book#219)\n- Replace nursery links with rust-lang links  (rust-embedded/book#222)\n- Add a Glossary appendix page  (rust-embedded/book#223)", "tree": {"sha": "e60f29b88aeb77c1a26809ec9b73434aad2002b3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e60f29b88aeb77c1a26809ec9b73434aad2002b3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/433aae93e4ef866a1fdfefad136b32ed89acd3e7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/433aae93e4ef866a1fdfefad136b32ed89acd3e7", "html_url": "https://github.com/rust-lang/rust/commit/433aae93e4ef866a1fdfefad136b32ed89acd3e7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/433aae93e4ef866a1fdfefad136b32ed89acd3e7/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "35071e3e2e74f6f780bc851500b9316e3e82062a", "url": "https://api.github.com/repos/rust-lang/rust/commits/35071e3e2e74f6f780bc851500b9316e3e82062a", "html_url": "https://github.com/rust-lang/rust/commit/35071e3e2e74f6f780bc851500b9316e3e82062a"}, {"sha": "1e1b6ad1084783b4d6b21e9c6e79f114991f3dab", "url": "https://api.github.com/repos/rust-lang/rust/commits/1e1b6ad1084783b4d6b21e9c6e79f114991f3dab", "html_url": "https://github.com/rust-lang/rust/commit/1e1b6ad1084783b4d6b21e9c6e79f114991f3dab"}], "stats": {"total": 131, "additions": 95, "deletions": 36}, "files": [{"sha": "43561fa4f2fc1fa8d04ef2fc5e3fcb5a847f9dd3", "filename": "src/bootstrap/test.rs", "status": "modified", "additions": 58, "deletions": 24, "changes": 82, "blob_url": "https://github.com/rust-lang/rust/blob/433aae93e4ef866a1fdfefad136b32ed89acd3e7/src%2Fbootstrap%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/433aae93e4ef866a1fdfefad136b32ed89acd3e7/src%2Fbootstrap%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Ftest.rs?ref=433aae93e4ef866a1fdfefad136b32ed89acd3e7", "patch": "@@ -1264,28 +1264,75 @@ impl Step for Compiletest {\n     }\n }\n \n-#[derive(Debug, Copy, Clone, PartialEq, Eq, Hash)]\n-struct DocTest {\n+#[derive(Debug, Clone, PartialEq, Eq, Hash)]\n+struct BookTest {\n     compiler: Compiler,\n-    path: &'static str,\n+    path: PathBuf,\n     name: &'static str,\n     is_ext_doc: bool,\n }\n \n-impl Step for DocTest {\n+impl Step for BookTest {\n     type Output = ();\n     const ONLY_HOSTS: bool = true;\n \n     fn should_run(run: ShouldRun<'_>) -> ShouldRun<'_> {\n         run.never()\n     }\n \n-    /// Runs `rustdoc --test` for all documentation in `src/doc`.\n+    /// Runs the documentation tests for a book in `src/doc`.\n     ///\n-    /// This will run all tests in our markdown documentation (e.g., the book)\n-    /// located in `src/doc`. The `rustdoc` that's run is the one that sits next to\n-    /// `compiler`.\n+    /// This uses the `rustdoc` that sits next to `compiler`.\n     fn run(self, builder: &Builder<'_>) {\n+        // External docs are different from local because:\n+        // - Some books need pre-processing by mdbook before being tested.\n+        // - They need to save their state to toolstate.\n+        // - They are only tested on the \"checktools\" builders.\n+        //\n+        // The local docs are tested by default, and we don't want to pay the\n+        // cost of building mdbook, so they use `rustdoc --test` directly.\n+        // Also, the unstable book is special because SUMMARY.md is generated,\n+        // so it is easier to just run `rustdoc` on its files.\n+        if self.is_ext_doc {\n+            self.run_ext_doc(builder);\n+        } else {\n+            self.run_local_doc(builder);\n+        }\n+    }\n+}\n+\n+impl BookTest {\n+    /// This runs the equivalent of `mdbook test` (via the rustbook wrapper)\n+    /// which in turn runs `rustdoc --test` on each file in the book.\n+    fn run_ext_doc(self, builder: &Builder<'_>) {\n+        let compiler = self.compiler;\n+\n+        builder.ensure(compile::Std { compiler, target: compiler.host });\n+\n+        // mdbook just executes a binary named \"rustdoc\", so we need to update\n+        // PATH so that it points to our rustdoc.\n+        let mut rustdoc_path = builder.rustdoc(compiler);\n+        rustdoc_path.pop();\n+        let old_path = env::var_os(\"PATH\").unwrap_or_default();\n+        let new_path = env::join_paths(iter::once(rustdoc_path).chain(env::split_paths(&old_path)))\n+            .expect(\"could not add rustdoc to PATH\");\n+\n+        let mut rustbook_cmd = builder.tool_cmd(Tool::Rustbook);\n+        let path = builder.src.join(&self.path);\n+        rustbook_cmd.env(\"PATH\", new_path).arg(\"test\").arg(path);\n+        builder.add_rust_test_threads(&mut rustbook_cmd);\n+        builder.info(&format!(\"Testing rustbook {}\", self.path.display()));\n+        let _time = util::timeit(&builder);\n+        let toolstate = if try_run(builder, &mut rustbook_cmd) {\n+            ToolState::TestPass\n+        } else {\n+            ToolState::TestFail\n+        };\n+        builder.save_toolstate(self.name, toolstate);\n+    }\n+\n+    /// This runs `rustdoc --test` on all `.md` files in the path.\n+    fn run_local_doc(self, builder: &Builder<'_>) {\n         let compiler = self.compiler;\n \n         builder.ensure(compile::Std { compiler, target: compiler.host });\n@@ -1294,7 +1341,6 @@ impl Step for DocTest {\n         // tests for all files that end in `*.md`\n         let mut stack = vec![builder.src.join(self.path)];\n         let _time = util::timeit(&builder);\n-\n         let mut files = Vec::new();\n         while let Some(p) = stack.pop() {\n             if p.is_dir() {\n@@ -1306,25 +1352,13 @@ impl Step for DocTest {\n                 continue;\n             }\n \n-            // The nostarch directory in the book is for no starch, and so isn't\n-            // guaranteed to builder. We don't care if it doesn't build, so skip it.\n-            if p.to_str().map_or(false, |p| p.contains(\"nostarch\")) {\n-                continue;\n-            }\n-\n             files.push(p);\n         }\n \n         files.sort();\n \n-        let mut toolstate = ToolState::TestPass;\n         for file in files {\n-            if !markdown_test(builder, compiler, &file) {\n-                toolstate = ToolState::TestFail;\n-            }\n-        }\n-        if self.is_ext_doc {\n-            builder.save_toolstate(self.name, toolstate);\n+            markdown_test(builder, compiler, &file);\n         }\n     }\n }\n@@ -1353,9 +1387,9 @@ macro_rules! test_book {\n                 }\n \n                 fn run(self, builder: &Builder<'_>) {\n-                    builder.ensure(DocTest {\n+                    builder.ensure(BookTest {\n                         compiler: self.compiler,\n-                        path: $path,\n+                        path: PathBuf::from($path),\n                         name: $book_name,\n                         is_ext_doc: !$default,\n                     });"}, {"sha": "6fb3705e5230311b096d47f7e2c91f9ce24393d0", "filename": "src/doc/book", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": null, "raw_url": null, "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Fbook?ref=433aae93e4ef866a1fdfefad136b32ed89acd3e7", "patch": "@@ -1 +1 @@\n-Subproject commit 87dd6843678575f8dda962f239d14ef4be14b352\n+Subproject commit 6fb3705e5230311b096d47f7e2c91f9ce24393d0"}, {"sha": "37f9e6848411188a1062ead1bd8ebe4b8aa16899", "filename": "src/doc/edition-guide", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": null, "raw_url": null, "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Fedition-guide?ref=433aae93e4ef866a1fdfefad136b32ed89acd3e7", "patch": "@@ -1 +1 @@\n-Subproject commit 1a2390247ad6d08160e0dd74f40a01a9578659c2\n+Subproject commit 37f9e6848411188a1062ead1bd8ebe4b8aa16899"}, {"sha": "b2e1092bf67bd4d7686c4553f186edbb7f5f92db", "filename": "src/doc/embedded-book", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": null, "raw_url": null, "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Fembedded-book?ref=433aae93e4ef866a1fdfefad136b32ed89acd3e7", "patch": "@@ -1 +1 @@\n-Subproject commit 4d78994915af1bde9a95c04a8c27d8dca066232a\n+Subproject commit b2e1092bf67bd4d7686c4553f186edbb7f5f92db"}, {"sha": "64239df6d173562b9deb4f012e4c3e6e960c4754", "filename": "src/doc/reference", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": null, "raw_url": null, "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Freference?ref=433aae93e4ef866a1fdfefad136b32ed89acd3e7", "patch": "@@ -1 +1 @@\n-Subproject commit 11e893fc1357bc688418ddf1087c2b7aa25d154d\n+Subproject commit 64239df6d173562b9deb4f012e4c3e6e960c4754"}, {"sha": "32facd5522ddbbf37baf01e4e4b6562bc55c071a", "filename": "src/doc/rust-by-example", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": null, "raw_url": null, "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Frust-by-example?ref=433aae93e4ef866a1fdfefad136b32ed89acd3e7", "patch": "@@ -1 +1 @@\n-Subproject commit 1c2bd024d13f8011307e13386cf1fea2180352b5\n+Subproject commit 32facd5522ddbbf37baf01e4e4b6562bc55c071a"}, {"sha": "ba30c107667edbab1b3bdcb47d3b24b7bc26e184", "filename": "src/doc/rustdoc/book.toml", "status": "added", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/433aae93e4ef866a1fdfefad136b32ed89acd3e7/src%2Fdoc%2Frustdoc%2Fbook.toml", "raw_url": "https://github.com/rust-lang/rust/raw/433aae93e4ef866a1fdfefad136b32ed89acd3e7/src%2Fdoc%2Frustdoc%2Fbook.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Frustdoc%2Fbook.toml?ref=433aae93e4ef866a1fdfefad136b32ed89acd3e7", "patch": "@@ -0,0 +1,4 @@\n+[book]\n+authors = [\"The Rust Project Developers\"]\n+src = \"src\"\n+title = \"The rustdoc book\""}, {"sha": "01f324f0c5a0a653057e5c6690d39c274d7bb6a6", "filename": "src/tools/rustbook/src/main.rs", "status": "modified", "additions": 27, "deletions": 7, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/433aae93e4ef866a1fdfefad136b32ed89acd3e7/src%2Ftools%2Frustbook%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/433aae93e4ef866a1fdfefad136b32ed89acd3e7/src%2Ftools%2Frustbook%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Frustbook%2Fsrc%2Fmain.rs?ref=433aae93e4ef866a1fdfefad136b32ed89acd3e7", "patch": "@@ -25,6 +25,11 @@ fn main() {\n                 .arg_from_usage(d_message)\n                 .arg_from_usage(dir_message),\n         )\n+        .subcommand(\n+            SubCommand::with_name(\"test\")\n+                .about(\"Tests that a book's Rust code samples compile\")\n+                .arg_from_usage(dir_message),\n+        )\n         .subcommand(\n             SubCommand::with_name(\"linkcheck\")\n                 .about(\"Run linkcheck with mdBook 3\")\n@@ -36,13 +41,12 @@ fn main() {\n     match matches.subcommand() {\n         (\"build\", Some(sub_matches)) => {\n             if let Err(e) = build(sub_matches) {\n-                eprintln!(\"Error: {}\", e);\n-\n-                for cause in e.iter().skip(1) {\n-                    eprintln!(\"\\tCaused By: {}\", cause);\n-                }\n-\n-                ::std::process::exit(101);\n+                handle_error(e);\n+            }\n+        }\n+        (\"test\", Some(sub_matches)) => {\n+            if let Err(e) = test(sub_matches) {\n+                handle_error(e);\n             }\n         }\n         (\"linkcheck\", Some(sub_matches)) => {\n@@ -148,6 +152,12 @@ pub fn build(args: &ArgMatches<'_>) -> Result3<()> {\n     Ok(())\n }\n \n+fn test(args: &ArgMatches<'_>) -> Result3<()> {\n+    let book_dir = get_book_dir(args);\n+    let mut book = MDBook::load(&book_dir)?;\n+    book.test(vec![])\n+}\n+\n fn get_book_dir(args: &ArgMatches<'_>) -> PathBuf {\n     if let Some(dir) = args.value_of(\"dir\") {\n         // Check if path is relative from current dir, or absolute...\n@@ -157,3 +167,13 @@ fn get_book_dir(args: &ArgMatches<'_>) -> PathBuf {\n         env::current_dir().unwrap()\n     }\n }\n+\n+fn handle_error(error: mdbook::errors::Error) -> ! {\n+    eprintln!(\"Error: {}\", error);\n+\n+    for cause in error.iter().skip(1) {\n+        eprintln!(\"\\tCaused By: {}\", cause);\n+    }\n+\n+    ::std::process::exit(101);\n+}"}, {"sha": "be1e598d8d4feec83795fca5f4358a17d2a36086", "filename": "src/tools/tidy/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/433aae93e4ef866a1fdfefad136b32ed89acd3e7/src%2Ftools%2Ftidy%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/433aae93e4ef866a1fdfefad136b32ed89acd3e7/src%2Ftools%2Ftidy%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Flib.rs?ref=433aae93e4ef866a1fdfefad136b32ed89acd3e7", "patch": "@@ -58,6 +58,7 @@ fn filter_dirs(path: &Path) -> bool {\n         \"src/tools/rls\",\n         \"src/tools/rust-installer\",\n         \"src/tools/rustfmt\",\n+        \"src/doc/book\",\n         // Filter RLS output directories\n         \"target/rls\",\n     ];"}]}