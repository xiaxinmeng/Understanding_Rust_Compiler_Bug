{"sha": "609784711a0a3cb399299d65b58463253541b2da", "node_id": "C_kwDOAAsO6NoAKDYwOTc4NDcxMWEwYTNjYjM5OTI5OWQ2NWI1ODQ2MzI1MzU0MWIyZGE", "commit": {"author": {"name": "bjorn3", "email": "bjorn3@users.noreply.github.com", "date": "2022-02-10T17:27:18Z"}, "committer": {"name": "bjorn3", "email": "bjorn3@users.noreply.github.com", "date": "2022-02-10T17:27:18Z"}, "message": "Unconditionally update symbols\n\nAll paths to an ArchiveBuilder::build call update_symbols first.", "tree": {"sha": "4093e73a48960507569b54fa381b3f18180e8fbf", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4093e73a48960507569b54fa381b3f18180e8fbf"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/609784711a0a3cb399299d65b58463253541b2da", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/609784711a0a3cb399299d65b58463253541b2da", "html_url": "https://github.com/rust-lang/rust/commit/609784711a0a3cb399299d65b58463253541b2da", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/609784711a0a3cb399299d65b58463253541b2da/comments", "author": {"login": "bjorn3", "id": 17426603, "node_id": "MDQ6VXNlcjE3NDI2NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/17426603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bjorn3", "html_url": "https://github.com/bjorn3", "followers_url": "https://api.github.com/users/bjorn3/followers", "following_url": "https://api.github.com/users/bjorn3/following{/other_user}", "gists_url": "https://api.github.com/users/bjorn3/gists{/gist_id}", "starred_url": "https://api.github.com/users/bjorn3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bjorn3/subscriptions", "organizations_url": "https://api.github.com/users/bjorn3/orgs", "repos_url": "https://api.github.com/users/bjorn3/repos", "events_url": "https://api.github.com/users/bjorn3/events{/privacy}", "received_events_url": "https://api.github.com/users/bjorn3/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bjorn3", "id": 17426603, "node_id": "MDQ6VXNlcjE3NDI2NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/17426603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bjorn3", "html_url": "https://github.com/bjorn3", "followers_url": "https://api.github.com/users/bjorn3/followers", "following_url": "https://api.github.com/users/bjorn3/following{/other_user}", "gists_url": "https://api.github.com/users/bjorn3/gists{/gist_id}", "starred_url": "https://api.github.com/users/bjorn3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bjorn3/subscriptions", "organizations_url": "https://api.github.com/users/bjorn3/orgs", "repos_url": "https://api.github.com/users/bjorn3/repos", "events_url": "https://api.github.com/users/bjorn3/events{/privacy}", "received_events_url": "https://api.github.com/users/bjorn3/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "203b622a6590d6469e37ce827a62d5931cc837f2", "url": "https://api.github.com/repos/rust-lang/rust/commits/203b622a6590d6469e37ce827a62d5931cc837f2", "html_url": "https://github.com/rust-lang/rust/commit/203b622a6590d6469e37ce827a62d5931cc837f2"}], "stats": {"total": 23, "additions": 1, "deletions": 22}, "files": [{"sha": "a099e8b3a6af3a07806d1c5e3b33996941adc1f1", "filename": "compiler/rustc_codegen_cranelift/src/archive.rs", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/609784711a0a3cb399299d65b58463253541b2da/compiler%2Frustc_codegen_cranelift%2Fsrc%2Farchive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/609784711a0a3cb399299d65b58463253541b2da/compiler%2Frustc_codegen_cranelift%2Fsrc%2Farchive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Farchive.rs?ref=609784711a0a3cb399299d65b58463253541b2da", "patch": "@@ -105,8 +105,6 @@ impl<'a> ArchiveBuilder<'a> for ArArchiveBuilder<'a> {\n         Ok(())\n     }\n \n-    fn update_symbols(&mut self) {}\n-\n     fn build(mut self) {\n         enum BuilderKind {\n             Bsd(ar::Builder<File>),"}, {"sha": "fac532f3e9c83a1f2dad6c48a27faecd64a25d2c", "filename": "compiler/rustc_codegen_gcc/src/archive.rs", "status": "modified", "additions": 0, "deletions": 3, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/609784711a0a3cb399299d65b58463253541b2da/compiler%2Frustc_codegen_gcc%2Fsrc%2Farchive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/609784711a0a3cb399299d65b58463253541b2da/compiler%2Frustc_codegen_gcc%2Fsrc%2Farchive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_gcc%2Fsrc%2Farchive.rs?ref=609784711a0a3cb399299d65b58463253541b2da", "patch": "@@ -113,9 +113,6 @@ impl<'a> ArchiveBuilder<'a> for ArArchiveBuilder<'a> {\n         Ok(())\n     }\n \n-    fn update_symbols(&mut self) {\n-    }\n-\n     fn build(mut self) {\n         use std::process::Command;\n "}, {"sha": "21bd1dae7ac47161ccfbfe42c981b396a3b3933d", "filename": "compiler/rustc_codegen_llvm/src/back/archive.rs", "status": "modified", "additions": 1, "deletions": 10, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/609784711a0a3cb399299d65b58463253541b2da/compiler%2Frustc_codegen_llvm%2Fsrc%2Fback%2Farchive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/609784711a0a3cb399299d65b58463253541b2da/compiler%2Frustc_codegen_llvm%2Fsrc%2Fback%2Farchive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fback%2Farchive.rs?ref=609784711a0a3cb399299d65b58463253541b2da", "patch": "@@ -27,7 +27,6 @@ pub struct LlvmArchiveBuilder<'a> {\n     config: ArchiveConfig<'a>,\n     removals: Vec<String>,\n     additions: Vec<Addition>,\n-    should_update_symbols: bool,\n     src_archive: Option<Option<ArchiveRO>>,\n }\n \n@@ -75,7 +74,6 @@ impl<'a> ArchiveBuilder<'a> for LlvmArchiveBuilder<'a> {\n             config,\n             removals: Vec::new(),\n             additions: Vec::new(),\n-            should_update_symbols: false,\n             src_archive: None,\n         }\n     }\n@@ -129,12 +127,6 @@ impl<'a> ArchiveBuilder<'a> for LlvmArchiveBuilder<'a> {\n             .push(Addition::File { path: file.to_path_buf(), name_in_archive: name.to_owned() });\n     }\n \n-    /// Indicate that the next call to `build` should update all symbols in\n-    /// the archive (equivalent to running 'ar s' over it).\n-    fn update_symbols(&mut self) {\n-        self.should_update_symbols = true;\n-    }\n-\n     /// Combine the provided files, rlibs, and native libraries into a single\n     /// `Archive`.\n     fn build(mut self) {\n@@ -313,7 +305,6 @@ impl<'a> LlvmArchiveBuilder<'a> {\n         let mut members = Vec::new();\n \n         let dst = CString::new(self.config.dst.to_str().unwrap())?;\n-        let should_update_symbols = self.should_update_symbols;\n \n         unsafe {\n             if let Some(archive) = self.src_archive() {\n@@ -385,7 +376,7 @@ impl<'a> LlvmArchiveBuilder<'a> {\n                 dst.as_ptr(),\n                 members.len() as libc::size_t,\n                 members.as_ptr() as *const &_,\n-                should_update_symbols,\n+                true,\n                 kind,\n             );\n             let ret = if r.into_result().is_err() {"}, {"sha": "a2f74b9421468105e76a59d75c645a5034b9a6be", "filename": "compiler/rustc_codegen_ssa/src/back/archive.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/609784711a0a3cb399299d65b58463253541b2da/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Farchive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/609784711a0a3cb399299d65b58463253541b2da/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Farchive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Farchive.rs?ref=609784711a0a3cb399299d65b58463253541b2da", "patch": "@@ -51,7 +51,6 @@ pub trait ArchiveBuilder<'a> {\n     fn add_archive<F>(&mut self, archive: &Path, skip: F) -> io::Result<()>\n     where\n         F: FnMut(&str) -> bool + 'static;\n-    fn update_symbols(&mut self);\n \n     fn build(self);\n "}, {"sha": "e53c98421176c69eb22dc361494361bb66463584", "filename": "compiler/rustc_codegen_ssa/src/back/link.rs", "status": "modified", "additions": 0, "deletions": 6, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/609784711a0a3cb399299d65b58463253541b2da/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/609784711a0a3cb399299d65b58463253541b2da/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs?ref=609784711a0a3cb399299d65b58463253541b2da", "patch": "@@ -371,10 +371,6 @@ fn link_rlib<'a, B: ArchiveBuilder<'a>>(\n         }\n     }\n \n-    // After adding all files to the archive, we need to update the\n-    // symbol table of the archive.\n-    ab.update_symbols();\n-\n     return Ok(ab);\n }\n \n@@ -503,7 +499,6 @@ fn link_staticlib<'a, B: ArchiveBuilder<'a>>(\n         sess.fatal(&e);\n     }\n \n-    ab.update_symbols();\n     ab.build();\n \n     if !all_native_libs.is_empty() {\n@@ -2304,7 +2299,6 @@ fn add_upstream_rust_crates<'a, B: ArchiveBuilder<'a>>(\n \n         sess.prof.generic_activity_with_arg(\"link_altering_rlib\", name).run(|| {\n             let mut archive = <B as ArchiveBuilder>::new(sess, &dst, Some(cratepath));\n-            archive.update_symbols();\n \n             let mut any_objects = false;\n             for f in archive.src_files() {"}]}