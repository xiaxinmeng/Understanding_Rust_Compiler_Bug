{"sha": "44738ee336f72e683b2c24dac22b919567ec03a7", "node_id": "C_kwDOAAsO6NoAKDQ0NzM4ZWUzMzZmNzJlNjgzYjJjMjRkYWMyMmI5MTk1NjdlYzAzYTc", "commit": {"author": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-09-09T19:42:25Z"}, "committer": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-09-09T19:42:52Z"}, "message": "Be careful about expr_ty_adjusted when noting block tail type", "tree": {"sha": "4c518f795c4477af48e6270109f41908648a36b9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4c518f795c4477af48e6270109f41908648a36b9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/44738ee336f72e683b2c24dac22b919567ec03a7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/44738ee336f72e683b2c24dac22b919567ec03a7", "html_url": "https://github.com/rust-lang/rust/commit/44738ee336f72e683b2c24dac22b919567ec03a7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/44738ee336f72e683b2c24dac22b919567ec03a7/comments", "author": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "98f3001eecbe4cbd091c10ffab45b4c164bb507b", "url": "https://api.github.com/repos/rust-lang/rust/commits/98f3001eecbe4cbd091c10ffab45b4c164bb507b", "html_url": "https://github.com/rust-lang/rust/commit/98f3001eecbe4cbd091c10ffab45b4c164bb507b"}], "stats": {"total": 48, "additions": 44, "deletions": 4}, "files": [{"sha": "e05383d18f0f6d866b37b123881f95a9b6475a3b", "filename": "compiler/rustc_trait_selection/src/traits/error_reporting/suggestions.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/44738ee336f72e683b2c24dac22b919567ec03a7/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/44738ee336f72e683b2c24dac22b919567ec03a7/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs?ref=44738ee336f72e683b2c24dac22b919567ec03a7", "patch": "@@ -2713,12 +2713,13 @@ impl<'a, 'tcx> InferCtxtExt<'tcx> for InferCtxt<'a, 'tcx> {\n                         Some(t) if t.hir_owner == parent_id => t,\n                         _ => self.tcx.typeck(parent_id),\n                     };\n-                    let ty = typeck_results.expr_ty_adjusted(expr);\n-                    let span = expr.peel_blocks().span;\n+                    let expr = expr.peel_blocks();\n+                    let ty = typeck_results.expr_ty_adjusted_opt(expr).unwrap_or(tcx.ty_error());\n+                    let span = expr.span;\n                     if Some(span) != err.span.primary_span() {\n                         err.span_label(\n                             span,\n-                            &if ty.references_error() {\n+                            if ty.references_error() {\n                                 String::new()\n                             } else {\n                                 format!(\"this tail expression is of type `{:?}`\", ty)"}, {"sha": "759d79493a9cf6e89803649b6d4676be1605b5df", "filename": "src/test/ui/expr/malformed_closure/ruby_style_closure.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/44738ee336f72e683b2c24dac22b919567ec03a7/src%2Ftest%2Fui%2Fexpr%2Fmalformed_closure%2Fruby_style_closure.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/44738ee336f72e683b2c24dac22b919567ec03a7/src%2Ftest%2Fui%2Fexpr%2Fmalformed_closure%2Fruby_style_closure.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fexpr%2Fmalformed_closure%2Fruby_style_closure.stderr?ref=44738ee336f72e683b2c24dac22b919567ec03a7", "patch": "@@ -14,7 +14,7 @@ LL |       let p = Some(45).and_then({\n LL | |\n LL | |         |x| println!(\"doubling {}\", x);\n LL | |         Some(x * 2)\n-   | |         -----------\n+   | |         ----------- this tail expression is of type `std::option::Option<_>`\n LL | |\n LL | |     });\n    | |_____^ expected an `FnOnce<({integer},)>` closure, found `Option<_>`"}, {"sha": "d18a4a21f0a518b25534451faa880f53f37e779b", "filename": "src/test/ui/suggestions/issue-101623.rs", "status": "added", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/44738ee336f72e683b2c24dac22b919567ec03a7/src%2Ftest%2Fui%2Fsuggestions%2Fissue-101623.rs", "raw_url": "https://github.com/rust-lang/rust/raw/44738ee336f72e683b2c24dac22b919567ec03a7/src%2Ftest%2Fui%2Fsuggestions%2Fissue-101623.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsuggestions%2Fissue-101623.rs?ref=44738ee336f72e683b2c24dac22b919567ec03a7", "patch": "@@ -0,0 +1,25 @@\n+pub struct Stuff {\n+    inner: *mut (),\n+}\n+\n+pub struct Wrap<T>(T);\n+\n+fn fun<T>(t: T) -> Wrap<T> {\n+    todo!()\n+}\n+\n+pub trait Trait<'de> {\n+    fn do_stuff(_: Wrap<&'de mut Self>);\n+}\n+\n+impl<'a> Trait<'a> for () {\n+    fn do_stuff(_: Wrap<&'a mut Self>) {}\n+}\n+\n+fn fun2(t: &mut Stuff) -> () {\n+    let Stuff { inner, .. } = t;\n+    Trait::do_stuff({ fun(&mut *inner) });\n+    //~^ ERROR the trait bound `*mut (): Trait<'_>` is not satisfied\n+}\n+\n+fn main() {}"}, {"sha": "361483cc08db2bdcddb1e865e2b2f074d8f0af97", "filename": "src/test/ui/suggestions/issue-101623.stderr", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/44738ee336f72e683b2c24dac22b919567ec03a7/src%2Ftest%2Fui%2Fsuggestions%2Fissue-101623.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/44738ee336f72e683b2c24dac22b919567ec03a7/src%2Ftest%2Fui%2Fsuggestions%2Fissue-101623.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsuggestions%2Fissue-101623.stderr?ref=44738ee336f72e683b2c24dac22b919567ec03a7", "patch": "@@ -0,0 +1,14 @@\n+error[E0277]: the trait bound `*mut (): Trait<'_>` is not satisfied\n+  --> $DIR/issue-101623.rs:21:21\n+   |\n+LL |     Trait::do_stuff({ fun(&mut *inner) });\n+   |     --------------- ^^----------------^^\n+   |     |               |\n+   |     |               the trait `Trait<'_>` is not implemented for `*mut ()`\n+   |     required by a bound introduced by this call\n+   |\n+   = help: the trait `Trait<'a>` is implemented for `()`\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0277`."}]}