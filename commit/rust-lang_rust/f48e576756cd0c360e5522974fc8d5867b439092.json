{"sha": "f48e576756cd0c360e5522974fc8d5867b439092", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY0OGU1NzY3NTZjZDBjMzYwZTU1MjI5NzRmYzhkNTg2N2I0MzkwOTI=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-01-08T05:05:06Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-01-08T05:05:06Z"}, "message": "Auto merge of #67733 - pietroalbini:gha-2, r=alexcrichton\n\nGitHub Actions: preparations, part 2\n\nThis PR adds the second batch of commits in preparation for GitHub Actions:\n\n* Removed hardcoded Azure Pipelines variables from `publish_toolstate.sh`\n* Fixed a bug in `shared.sh`'s GitHub Actions support\n* Fixed binutils missing from MSYS2 on Windows 2019 (GitHub Actions-specific)\n* Fixed wrong sysroot in macOS 10.15 onwards (GitHub Actions-specific)\n\nThis PR does **not** yet add any builders on GitHub Actions.\n\nr? @alexcrichton", "tree": {"sha": "445807ee0228898ec13ce7b56c9f8672b537e07f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/445807ee0228898ec13ce7b56c9f8672b537e07f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f48e576756cd0c360e5522974fc8d5867b439092", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f48e576756cd0c360e5522974fc8d5867b439092", "html_url": "https://github.com/rust-lang/rust/commit/f48e576756cd0c360e5522974fc8d5867b439092", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f48e576756cd0c360e5522974fc8d5867b439092/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7e393b5b3b543d355ae16c1940cf98b6c7fcb8aa", "url": "https://api.github.com/repos/rust-lang/rust/commits/7e393b5b3b543d355ae16c1940cf98b6c7fcb8aa", "html_url": "https://github.com/rust-lang/rust/commit/7e393b5b3b543d355ae16c1940cf98b6c7fcb8aa"}, {"sha": "39ddbeb87470071113d03fa7dfc34164180c76d6", "url": "https://api.github.com/repos/rust-lang/rust/commits/39ddbeb87470071113d03fa7dfc34164180c76d6", "html_url": "https://github.com/rust-lang/rust/commit/39ddbeb87470071113d03fa7dfc34164180c76d6"}], "stats": {"total": 23, "additions": 18, "deletions": 5}, "files": [{"sha": "fb828477f98b76e6baaea12f6e911d3baeb5e3b8", "filename": "src/ci/publish_toolstate.sh", "status": "modified", "additions": 6, "deletions": 3, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/f48e576756cd0c360e5522974fc8d5867b439092/src%2Fci%2Fpublish_toolstate.sh", "raw_url": "https://github.com/rust-lang/rust/raw/f48e576756cd0c360e5522974fc8d5867b439092/src%2Fci%2Fpublish_toolstate.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fpublish_toolstate.sh?ref=f48e576756cd0c360e5522974fc8d5867b439092", "patch": "@@ -1,6 +1,9 @@\n-#!/bin/sh\n+#!/bin/bash\n \n-set -eu\n+set -euo pipefail\n+IFS=$'\\n\\t'\n+\n+source \"$(cd \"$(dirname \"$0\")\" && pwd)/../shared.sh\"\n \n # The following lines are also found in src/bootstrap/toolstate.rs,\n # so if updating here, please also update that file.\n@@ -21,7 +24,7 @@ cd rust-toolstate\n FAILURE=1\n for RETRY_COUNT in 1 2 3 4 5; do\n     #  The purpose is to publish the new \"current\" toolstate in the toolstate repo.\n-    \"$BUILD_SOURCESDIRECTORY/src/tools/publish_toolstate.py\" \"$GIT_COMMIT\" \\\n+    \"$(ciCheckoutPath)/src/tools/publish_toolstate.py\" \"$GIT_COMMIT\" \\\n         \"$GIT_COMMIT_MSG\" \\\n         \"$MESSAGE_FILE\" \\\n         \"$TOOLSTATE_REPO_ACCESS_TOKEN\""}, {"sha": "e16a4814197b31159b53040c4c950b59d222cf18", "filename": "src/ci/scripts/install-clang.sh", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/f48e576756cd0c360e5522974fc8d5867b439092/src%2Fci%2Fscripts%2Finstall-clang.sh", "raw_url": "https://github.com/rust-lang/rust/raw/f48e576756cd0c360e5522974fc8d5867b439092/src%2Fci%2Fscripts%2Finstall-clang.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fscripts%2Finstall-clang.sh?ref=f48e576756cd0c360e5522974fc8d5867b439092", "patch": "@@ -14,6 +14,15 @@ if isMacOS; then\n     ciCommandSetEnv CC \"$(pwd)/clang+llvm-9.0.0-x86_64-darwin-apple/bin/clang\"\n     ciCommandSetEnv CXX \"$(pwd)/clang+llvm-9.0.0-x86_64-darwin-apple/bin/clang++\"\n \n+    # macOS 10.15 onwards doesn't have libraries in /usr/include anymore: those\n+    # are now located deep into the filesystem, under Xcode's own files. The\n+    # native clang is configured to use the correct path, but our custom one\n+    # doesn't. This sets the SDKROOT environment variable to the SDK so that\n+    # our own clang can figure out the correct include path on its own.\n+    if ! [[ -d \"/usr/include\" ]]; then\n+        ciCommandSetEnv SDKROOT \"$(xcrun --sdk macosx --show-sdk-path)\"\n+    fi\n+\n     # Configure `AR` specifically so rustbuild doesn't try to infer it as\n     # `clang-ar` by accident.\n     ciCommandSetEnv AR \"ar\""}, {"sha": "843a2bf2d5e55a488e8c97ca952bb1ae0e9edc71", "filename": "src/ci/scripts/install-msys2-packages.sh", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/f48e576756cd0c360e5522974fc8d5867b439092/src%2Fci%2Fscripts%2Finstall-msys2-packages.sh", "raw_url": "https://github.com/rust-lang/rust/raw/f48e576756cd0c360e5522974fc8d5867b439092/src%2Fci%2Fscripts%2Finstall-msys2-packages.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fscripts%2Finstall-msys2-packages.sh?ref=f48e576756cd0c360e5522974fc8d5867b439092", "patch": "@@ -6,7 +6,8 @@ IFS=$'\\n\\t'\n source \"$(cd \"$(dirname \"$0\")\" && pwd)/../shared.sh\"\n \n if isWindows; then\n-    pacman -S --noconfirm --needed base-devel ca-certificates make diffutils tar\n+    pacman -S --noconfirm --needed base-devel ca-certificates make diffutils tar \\\n+        binutils\n \n     # Make sure we use the native python interpreter instead of some msys equivalent\n     # one way or another. The msys interpreters seem to have weird path conversions"}, {"sha": "0bfd7ff26cf0ee5c2aab9c70f2d660310f450263", "filename": "src/ci/shared.sh", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f48e576756cd0c360e5522974fc8d5867b439092/src%2Fci%2Fshared.sh", "raw_url": "https://github.com/rust-lang/rust/raw/f48e576756cd0c360e5522974fc8d5867b439092/src%2Fci%2Fshared.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fshared.sh?ref=f48e576756cd0c360e5522974fc8d5867b439092", "patch": "@@ -99,7 +99,7 @@ function ciCommandAddPath {\n     if isAzurePipelines; then\n         echo \"##vso[task.prependpath]${path}\"\n     elif isGitHubActions; then\n-        echo \"::add-path::${value}\"\n+        echo \"::add-path::${path}\"\n     else\n         echo \"ciCommandAddPath only works inside CI!\"\n         exit 1"}]}