{"sha": "57393be6fba9bc6f09aa4ba6587da9633edac675", "node_id": "C_kwDOAAsO6NoAKDU3MzkzYmU2ZmJhOWJjNmYwOWFhNGJhNjU4N2RhOTYzM2VkYWM2NzU", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2023-04-12T20:04:35Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-04-12T20:04:35Z"}, "message": "Rollup merge of #110135 - compiler-errors:revert-108031, r=davidtwco\n\nRevert \"Don't recover lifetimes/labels containing emojis as character literals\"\n\nReverts PR #108031 per https://github.com/rust-lang/rust/pull/109754#issuecomment-1490452045\n\nFixes (doesnt close until beta backported) #109746\n\nThis reverts commit e3f9db5fc319c6d8eee5d47d216ea6a426070c41.\nThis reverts commit 98b82aedba3f3f581e89df54352914b27f42c6f7.\nThis reverts commit 380fa264132ad481e73cbbf0f3a0feefd99a1d78.", "tree": {"sha": "98d101c709c0e1349bbc9d90edd4cb5ab021709b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/98d101c709c0e1349bbc9d90edd4cb5ab021709b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/57393be6fba9bc6f09aa4ba6587da9633edac675", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkNw7TCRBK7hj4Ov3rIwAAsAcIABmiPS4TkdbIvcVHt2+fMvBl\neZj3TUQfaYdzg5x3lL5V0cWnxmEG5oSvPY7Sb1wTCAINlAVInEA5EW5jNIgh9GuQ\nHcdL0mgT+PeKZLasImNLjTlB3HIVnGEgeRPOO8HRq8BmvJzp08O1NfI4hiXaEFFH\nd2+Px4Y6K5OlwZRx35h1JBOO8oyKvpEl+/K634REe8+tTndeInOH3WYCMRhsOg3n\nQQhWwEiw/Qz899iS+mw4JTUMYL7h6CS6XCVmn5/+kVVQsMtzWIRQbkM+X3SqI1M/\nFYlVgj+s0eYNOID2w0N7lUHTiZW5LHU15dAunh3WE2A6wkGEbC3eYHc5n3E2mEE=\n=djLd\n-----END PGP SIGNATURE-----\n", "payload": "tree 98d101c709c0e1349bbc9d90edd4cb5ab021709b\nparent 5d6aeb9799c4e459807f36f9acfdfe56016c87be\nparent a047064d6b0ddf82443e5e478d4dae3d0db6f379\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1681329875 +0200\ncommitter GitHub <noreply@github.com> 1681329875 +0200\n\nRollup merge of #110135 - compiler-errors:revert-108031, r=davidtwco\n\nRevert \"Don't recover lifetimes/labels containing emojis as character literals\"\n\nReverts PR #108031 per https://github.com/rust-lang/rust/pull/109754#issuecomment-1490452045\n\nFixes (doesnt close until beta backported) #109746\n\nThis reverts commit e3f9db5fc319c6d8eee5d47d216ea6a426070c41.\nThis reverts commit 98b82aedba3f3f581e89df54352914b27f42c6f7.\nThis reverts commit 380fa264132ad481e73cbbf0f3a0feefd99a1d78.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/57393be6fba9bc6f09aa4ba6587da9633edac675", "html_url": "https://github.com/rust-lang/rust/commit/57393be6fba9bc6f09aa4ba6587da9633edac675", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/57393be6fba9bc6f09aa4ba6587da9633edac675/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5d6aeb9799c4e459807f36f9acfdfe56016c87be", "url": "https://api.github.com/repos/rust-lang/rust/commits/5d6aeb9799c4e459807f36f9acfdfe56016c87be", "html_url": "https://github.com/rust-lang/rust/commit/5d6aeb9799c4e459807f36f9acfdfe56016c87be"}, {"sha": "a047064d6b0ddf82443e5e478d4dae3d0db6f379", "url": "https://api.github.com/repos/rust-lang/rust/commits/a047064d6b0ddf82443e5e478d4dae3d0db6f379", "html_url": "https://github.com/rust-lang/rust/commit/a047064d6b0ddf82443e5e478d4dae3d0db6f379"}], "stats": {"total": 195, "additions": 17, "deletions": 178}, "files": [{"sha": "3bd1958a08a284349b593f75f9ffc07f1b0b6f8c", "filename": "compiler/rustc_errors/src/lib.rs", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/57393be6fba9bc6f09aa4ba6587da9633edac675/compiler%2Frustc_errors%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/57393be6fba9bc6f09aa4ba6587da9633edac675/compiler%2Frustc_errors%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_errors%2Fsrc%2Flib.rs?ref=57393be6fba9bc6f09aa4ba6587da9633edac675", "patch": "@@ -475,8 +475,6 @@ pub enum StashKey {\n     /// When an invalid lifetime e.g. `'2` should be reinterpreted\n     /// as a char literal in the parser\n     LifetimeIsChar,\n-    /// When an invalid lifetime e.g. `'\ud83d\udc31` contains emoji.\n-    LifetimeContainsEmoji,\n     /// Maybe there was a typo where a comma was forgotten before\n     /// FRU syntax\n     MaybeFruTypo,"}, {"sha": "b3f4b5cd5e5a0dda101ebfcb30d0a6dda3886e5c", "filename": "compiler/rustc_lexer/src/lib.rs", "status": "modified", "additions": 10, "deletions": 33, "changes": 43, "blob_url": "https://github.com/rust-lang/rust/blob/57393be6fba9bc6f09aa4ba6587da9633edac675/compiler%2Frustc_lexer%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/57393be6fba9bc6f09aa4ba6587da9633edac675/compiler%2Frustc_lexer%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_lexer%2Fsrc%2Flib.rs?ref=57393be6fba9bc6f09aa4ba6587da9633edac675", "patch": "@@ -95,7 +95,7 @@ pub enum TokenKind {\n     Literal { kind: LiteralKind, suffix_start: u32 },\n \n     /// \"'a\"\n-    Lifetime { starts_with_number: bool, contains_emoji: bool },\n+    Lifetime { starts_with_number: bool },\n \n     // One-char tokens:\n     /// \";\"\n@@ -632,13 +632,7 @@ impl Cursor<'_> {\n             // If the first symbol is valid for identifier, it can be a lifetime.\n             // Also check if it's a number for a better error reporting (so '0 will\n             // be reported as invalid lifetime and not as unterminated char literal).\n-            // We also have to account for potential `'\ud83d\udc31` emojis to avoid reporting\n-            // it as an unterminated char literal.\n-            is_id_start(self.first())\n-                || self.first().is_digit(10)\n-                // FIXME(#108019): `unic-emoji-char` seems to have data tables only up to Unicode\n-                // 5.0, but Unicode is already newer than this.\n-                || unic_emoji_char::is_emoji(self.first())\n+            is_id_start(self.first()) || self.first().is_digit(10)\n         };\n \n         if !can_be_a_lifetime {\n@@ -651,33 +645,16 @@ impl Cursor<'_> {\n             return Literal { kind, suffix_start };\n         }\n \n-        // Either a lifetime or a character literal.\n+        // Either a lifetime or a character literal with\n+        // length greater than 1.\n \n         let starts_with_number = self.first().is_digit(10);\n-        let mut contains_emoji = false;\n \n-        // FIXME(#108019): `unic-emoji-char` seems to have data tables only up to Unicode\n-        // 5.0, but Unicode is already newer than this.\n-        if unic_emoji_char::is_emoji(self.first()) {\n-            contains_emoji = true;\n-        } else {\n-            // Skip the literal contents.\n-            // First symbol can be a number (which isn't a valid identifier start),\n-            // so skip it without any checks.\n-            self.bump();\n-        }\n-        self.eat_while(|c| {\n-            if is_id_continue(c) {\n-                true\n-            // FIXME(#108019): `unic-emoji-char` seems to have data tables only up to Unicode\n-            // 5.0, but Unicode is already newer than this.\n-            } else if unic_emoji_char::is_emoji(c) {\n-                contains_emoji = true;\n-                true\n-            } else {\n-                false\n-            }\n-        });\n+        // Skip the literal contents.\n+        // First symbol can be a number (which isn't a valid identifier start),\n+        // so skip it without any checks.\n+        self.bump();\n+        self.eat_while(is_id_continue);\n \n         // Check if after skipping literal contents we've met a closing\n         // single quote (which means that user attempted to create a\n@@ -687,7 +664,7 @@ impl Cursor<'_> {\n             let kind = Char { terminated: true };\n             Literal { kind, suffix_start: self.pos_within_token() }\n         } else {\n-            Lifetime { starts_with_number, contains_emoji }\n+            Lifetime { starts_with_number }\n         }\n     }\n "}, {"sha": "e4c1787f2ccef043e002d228346c72b8a2958655", "filename": "compiler/rustc_lexer/src/tests.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/57393be6fba9bc6f09aa4ba6587da9633edac675/compiler%2Frustc_lexer%2Fsrc%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/57393be6fba9bc6f09aa4ba6587da9633edac675/compiler%2Frustc_lexer%2Fsrc%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_lexer%2Fsrc%2Ftests.rs?ref=57393be6fba9bc6f09aa4ba6587da9633edac675", "patch": "@@ -235,7 +235,7 @@ fn lifetime() {\n     check_lexing(\n         \"'abc\",\n         expect![[r#\"\n-            Token { kind: Lifetime { starts_with_number: false, contains_emoji: false }, len: 4 }\n+            Token { kind: Lifetime { starts_with_number: false }, len: 4 }\n         \"#]],\n     );\n }"}, {"sha": "9e856c9f2120c2363bb9b936f690cfa1b24c56af", "filename": "compiler/rustc_parse/src/lexer/mod.rs", "status": "modified", "additions": 2, "deletions": 7, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/57393be6fba9bc6f09aa4ba6587da9633edac675/compiler%2Frustc_parse%2Fsrc%2Flexer%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/57393be6fba9bc6f09aa4ba6587da9633edac675/compiler%2Frustc_parse%2Fsrc%2Flexer%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse%2Fsrc%2Flexer%2Fmod.rs?ref=57393be6fba9bc6f09aa4ba6587da9633edac675", "patch": "@@ -223,21 +223,16 @@ impl<'a> StringReader<'a> {\n                     };\n                     token::Literal(token::Lit { kind, symbol, suffix })\n                 }\n-                rustc_lexer::TokenKind::Lifetime { starts_with_number, contains_emoji } => {\n+                rustc_lexer::TokenKind::Lifetime { starts_with_number } => {\n                     // Include the leading `'` in the real identifier, for macro\n                     // expansion purposes. See #12512 for the gory details of why\n                     // this is necessary.\n                     let lifetime_name = self.str_from(start);\n                     if starts_with_number {\n                         let span = self.mk_sp(start, self.pos);\n-                        let mut diag = self.sess.struct_err(\"lifetimes or labels cannot start with a number\");\n+                        let mut diag = self.sess.struct_err(\"lifetimes cannot start with a number\");\n                         diag.set_span(span);\n                         diag.stash(span, StashKey::LifetimeIsChar);\n-                    } else if contains_emoji {\n-                        let span = self.mk_sp(start, self.pos);\n-                        let mut diag = self.sess.struct_err(\"lifetimes or labels cannot contain emojis\");\n-                        diag.set_span(span);\n-                        diag.stash(span, StashKey::LifetimeContainsEmoji);\n                     }\n                     let ident = Symbol::intern(lifetime_name);\n                     token::Lifetime(ident)"}, {"sha": "f0f86224560100121aad9e2e19551fd0e61bad4b", "filename": "tests/ui/lexer/issue-108019-bad-emoji-recovery.rs", "status": "removed", "additions": 0, "deletions": 45, "changes": 45, "blob_url": "https://github.com/rust-lang/rust/blob/5d6aeb9799c4e459807f36f9acfdfe56016c87be/tests%2Fui%2Flexer%2Fissue-108019-bad-emoji-recovery.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5d6aeb9799c4e459807f36f9acfdfe56016c87be/tests%2Fui%2Flexer%2Fissue-108019-bad-emoji-recovery.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Flexer%2Fissue-108019-bad-emoji-recovery.rs?ref=5d6aeb9799c4e459807f36f9acfdfe56016c87be", "patch": "@@ -1,45 +0,0 @@\n-#![allow(unused_labels)]\n-\n-// FIXME(#108019): outdated Unicode table\n-// fn foo() {\n-//     '\ud83e\udd7a loop {\n-//         break\n-//     }\n-// }\n-\n-fn bar() {\n-    '\ud83d\udc31 loop {\n-    //~^ ERROR labeled expression must be followed by `:`\n-    //~| ERROR lifetimes or labels cannot contain emojis\n-        break\n-    }\n-}\n-\n-fn qux() {\n-    'a\ud83d\udc31 loop {\n-    //~^ ERROR labeled expression must be followed by `:`\n-    //~| ERROR lifetimes or labels cannot contain emojis\n-        break\n-    }\n-}\n-\n-fn quux() {\n-    '1\ud83d\udc31 loop {\n-    //~^ ERROR labeled expression must be followed by `:`\n-    //~| ERROR lifetimes or labels cannot start with a number\n-        break\n-    }\n-}\n-\n-fn x<'\ud83d\udc31>() -> &'\ud83d\udc31 () {\n-    //~^ ERROR lifetimes or labels cannot contain emojis\n-    //~| ERROR lifetimes or labels cannot contain emojis\n-    &()\n-}\n-\n-fn y() {\n-    'a\ud83d\udc31: loop {}\n-    //~^ ERROR lifetimes or labels cannot contain emojis\n-}\n-\n-fn main() {}"}, {"sha": "be77ffdea349f4296042f760e99923935573e7d8", "filename": "tests/ui/lexer/issue-108019-bad-emoji-recovery.stderr", "status": "removed", "additions": 0, "deletions": 86, "changes": 86, "blob_url": "https://github.com/rust-lang/rust/blob/5d6aeb9799c4e459807f36f9acfdfe56016c87be/tests%2Fui%2Flexer%2Fissue-108019-bad-emoji-recovery.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/5d6aeb9799c4e459807f36f9acfdfe56016c87be/tests%2Fui%2Flexer%2Fissue-108019-bad-emoji-recovery.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Flexer%2Fissue-108019-bad-emoji-recovery.stderr?ref=5d6aeb9799c4e459807f36f9acfdfe56016c87be", "patch": "@@ -1,86 +0,0 @@\n-error: labeled expression must be followed by `:`\n-  --> $DIR/issue-108019-bad-emoji-recovery.rs:11:5\n-   |\n-LL |       '\ud83d\udc31 loop {\n-   |       ^--- help: add `:` after the label\n-   |       |\n-   |  _____the label\n-   | |\n-LL | |\n-LL | |\n-LL | |         break\n-LL | |     }\n-   | |_____^\n-   |\n-   = note: labels are used before loops and blocks, allowing e.g., `break 'label` to them\n-\n-error: labeled expression must be followed by `:`\n-  --> $DIR/issue-108019-bad-emoji-recovery.rs:19:5\n-   |\n-LL |       'a\ud83d\udc31 loop {\n-   |       ^---- help: add `:` after the label\n-   |       |\n-   |  _____the label\n-   | |\n-LL | |\n-LL | |\n-LL | |         break\n-LL | |     }\n-   | |_____^\n-   |\n-   = note: labels are used before loops and blocks, allowing e.g., `break 'label` to them\n-\n-error: labeled expression must be followed by `:`\n-  --> $DIR/issue-108019-bad-emoji-recovery.rs:27:5\n-   |\n-LL |       '1\ud83d\udc31 loop {\n-   |       ^---- help: add `:` after the label\n-   |       |\n-   |  _____the label\n-   | |\n-LL | |\n-LL | |\n-LL | |         break\n-LL | |     }\n-   | |_____^\n-   |\n-   = note: labels are used before loops and blocks, allowing e.g., `break 'label` to them\n-\n-error: lifetimes or labels cannot contain emojis\n-  --> $DIR/issue-108019-bad-emoji-recovery.rs:11:5\n-   |\n-LL |     '\ud83d\udc31 loop {\n-   |     ^^^\n-\n-error: lifetimes or labels cannot contain emojis\n-  --> $DIR/issue-108019-bad-emoji-recovery.rs:19:5\n-   |\n-LL |     'a\ud83d\udc31 loop {\n-   |     ^^^^\n-\n-error: lifetimes or labels cannot start with a number\n-  --> $DIR/issue-108019-bad-emoji-recovery.rs:27:5\n-   |\n-LL |     '1\ud83d\udc31 loop {\n-   |     ^^^^\n-\n-error: lifetimes or labels cannot contain emojis\n-  --> $DIR/issue-108019-bad-emoji-recovery.rs:34:6\n-   |\n-LL | fn x<'\ud83d\udc31>() -> &'\ud83d\udc31 () {\n-   |      ^^^\n-\n-error: lifetimes or labels cannot contain emojis\n-  --> $DIR/issue-108019-bad-emoji-recovery.rs:34:16\n-   |\n-LL | fn x<'\ud83d\udc31>() -> &'\ud83d\udc31 () {\n-   |                 ^^^\n-\n-error: lifetimes or labels cannot contain emojis\n-  --> $DIR/issue-108019-bad-emoji-recovery.rs:41:5\n-   |\n-LL |     'a\ud83d\udc31: loop {}\n-   |     ^^^^\n-\n-error: aborting due to 9 previous errors\n-"}, {"sha": "2d82354c62cca706fa9c17c35ed5b5f7e3575034", "filename": "tests/ui/parser/numeric-lifetime.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/57393be6fba9bc6f09aa4ba6587da9633edac675/tests%2Fui%2Fparser%2Fnumeric-lifetime.rs", "raw_url": "https://github.com/rust-lang/rust/raw/57393be6fba9bc6f09aa4ba6587da9633edac675/tests%2Fui%2Fparser%2Fnumeric-lifetime.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fparser%2Fnumeric-lifetime.rs?ref=57393be6fba9bc6f09aa4ba6587da9633edac675", "patch": "@@ -1,6 +1,6 @@\n struct S<'1> { s: &'1 usize }\n-//~^ ERROR lifetimes or labels cannot start with a number\n-//~| ERROR lifetimes or labels cannot start with a number\n+//~^ ERROR lifetimes cannot start with a number\n+//~| ERROR lifetimes cannot start with a number\n fn main() {\n     // verify that the parse error doesn't stop type checking\n     let x: usize = \"\";"}, {"sha": "7c1bcb7263171d9b0d06d98feef52bae6501593f", "filename": "tests/ui/parser/numeric-lifetime.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/57393be6fba9bc6f09aa4ba6587da9633edac675/tests%2Fui%2Fparser%2Fnumeric-lifetime.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/57393be6fba9bc6f09aa4ba6587da9633edac675/tests%2Fui%2Fparser%2Fnumeric-lifetime.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fparser%2Fnumeric-lifetime.stderr?ref=57393be6fba9bc6f09aa4ba6587da9633edac675", "patch": "@@ -6,13 +6,13 @@ LL |     let x: usize = \"\";\n    |            |\n    |            expected due to this\n \n-error: lifetimes or labels cannot start with a number\n+error: lifetimes cannot start with a number\n   --> $DIR/numeric-lifetime.rs:1:10\n    |\n LL | struct S<'1> { s: &'1 usize }\n    |          ^^\n \n-error: lifetimes or labels cannot start with a number\n+error: lifetimes cannot start with a number\n   --> $DIR/numeric-lifetime.rs:1:20\n    |\n LL | struct S<'1> { s: &'1 usize }"}]}