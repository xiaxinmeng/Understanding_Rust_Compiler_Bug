{"sha": "7f55fc33f08a7ec5df0d06b4b0543bc864e60640", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdmNTVmYzMzZjA4YTdlYzVkZjBkMDZiNGIwNTQzYmM4NjRlNjA2NDA=", "commit": {"author": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2013-06-19T02:52:05Z"}, "committer": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2013-06-19T02:52:05Z"}, "message": "std: Work around some failing 'run' tests when valgrinding. #7224\n\nUnder valgrind on 64->32 cross compiles the dynamic linker is emitting\nsome error messages on stderr, which interferes with the tests that\nare checking stderr.", "tree": {"sha": "d8b84b09faa330265850b263701d57e8dc775f9e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d8b84b09faa330265850b263701d57e8dc775f9e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7f55fc33f08a7ec5df0d06b4b0543bc864e60640", "comment_count": 1, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7f55fc33f08a7ec5df0d06b4b0543bc864e60640", "html_url": "https://github.com/rust-lang/rust/commit/7f55fc33f08a7ec5df0d06b4b0543bc864e60640", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7f55fc33f08a7ec5df0d06b4b0543bc864e60640/comments", "author": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "committer": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "04b1dbabf567f530c20e44d5e97967dae3aabd17", "url": "https://api.github.com/repos/rust-lang/rust/commits/04b1dbabf567f530c20e44d5e97967dae3aabd17", "html_url": "https://github.com/rust-lang/rust/commit/04b1dbabf567f530c20e44d5e97967dae3aabd17"}], "stats": {"total": 37, "additions": 32, "deletions": 5}, "files": [{"sha": "7a96bf35218be7f95ee518ba39afe095150f6a23", "filename": "src/libstd/run.rs", "status": "modified", "additions": 25, "deletions": 5, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/7f55fc33f08a7ec5df0d06b4b0543bc864e60640/src%2Flibstd%2Frun.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7f55fc33f08a7ec5df0d06b4b0543bc864e60640/src%2Flibstd%2Frun.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Frun.rs?ref=7f55fc33f08a7ec5df0d06b4b0543bc864e60640", "patch": "@@ -915,7 +915,7 @@ priv fn waitpid(pid: pid_t) -> int {\n #[cfg(test)]\n mod tests {\n     use io;\n-    use libc::{c_int};\n+    use libc::{c_int, uintptr_t};\n     use option::{Option, None, Some};\n     use os;\n     use path::Path;\n@@ -958,7 +958,10 @@ mod tests {\n \n         assert_eq!(status, 0);\n         assert_eq!(output_str.trim().to_owned(), ~\"hello\");\n-        assert_eq!(error, ~[]);\n+        // FIXME #7224\n+        if !running_on_valgrind() {\n+            assert_eq!(error, ~[]);\n+        }\n     }\n \n     #[test]\n@@ -1043,7 +1046,10 @@ mod tests {\n \n         assert_eq!(status, 0);\n         assert_eq!(output_str.trim().to_owned(), ~\"hello\");\n-        assert_eq!(error, ~[]);\n+        // FIXME #7224\n+        if !running_on_valgrind() {\n+            assert_eq!(error, ~[]);\n+        }\n     }\n \n     #[test]\n@@ -1057,14 +1063,20 @@ mod tests {\n \n         assert_eq!(status, 0);\n         assert_eq!(output_str.trim().to_owned(), ~\"hello\");\n-        assert_eq!(error, ~[]);\n+        // FIXME #7224\n+        if !running_on_valgrind() {\n+            assert_eq!(error, ~[]);\n+        }\n \n         let run::ProcessOutput {status, output, error}\n             = prog.finish_with_output();\n \n         assert_eq!(status, 0);\n         assert_eq!(output, ~[]);\n-        assert_eq!(error, ~[]);\n+        // FIXME #7224\n+        if !running_on_valgrind() {\n+            assert_eq!(error, ~[]);\n+        }\n     }\n \n     #[test]\n@@ -1169,4 +1181,12 @@ mod tests {\n \n         assert!(output.contains(\"RUN_TEST_NEW_ENV=123\"));\n     }\n+\n+    fn running_on_valgrind() -> bool {\n+        unsafe { rust_running_on_valgrind() != 0 }\n+    }\n+\n+    extern {\n+        fn rust_running_on_valgrind() -> uintptr_t;\n+    }\n }"}, {"sha": "3bd5e09e0073c61bef2eba668da267eb535d3743", "filename": "src/rt/rust_builtin.cpp", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/7f55fc33f08a7ec5df0d06b4b0543bc864e60640/src%2Frt%2Frust_builtin.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/7f55fc33f08a7ec5df0d06b4b0543bc864e60640/src%2Frt%2Frust_builtin.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_builtin.cpp?ref=7f55fc33f08a7ec5df0d06b4b0543bc864e60640", "patch": "@@ -17,6 +17,7 @@\n #include \"sync/timer.h\"\n #include \"sync/rust_thread.h\"\n #include \"rust_abi.h\"\n+#include \"vg/valgrind.h\"\n \n #include <time.h>\n \n@@ -930,6 +931,11 @@ rust_begin_unwind(uintptr_t token) {\n #endif\n }\n \n+extern \"C\" CDECL uintptr_t\n+rust_running_on_valgrind() {\n+    return RUNNING_ON_VALGRIND;\n+}\n+\n //\n // Local Variables:\n // mode: C++"}, {"sha": "ba7ada04a2754fe78fd5f388432fc3b3644dec3b", "filename": "src/rt/rustrt.def.in", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7f55fc33f08a7ec5df0d06b4b0543bc864e60640/src%2Frt%2Frustrt.def.in", "raw_url": "https://github.com/rust-lang/rust/raw/7f55fc33f08a7ec5df0d06b4b0543bc864e60640/src%2Frt%2Frustrt.def.in", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frustrt.def.in?ref=7f55fc33f08a7ec5df0d06b4b0543bc864e60640", "patch": "@@ -239,3 +239,4 @@ rust_valgrind_stack_deregister\n rust_take_env_lock\n rust_drop_env_lock\n rust_update_log_settings\n+rust_running_on_valgrind\n\\ No newline at end of file"}]}