{"sha": "bf39d86e0f34c439306f9dff9d01ca15792b5fd5", "node_id": "C_kwDOAAsO6NoAKGJmMzlkODZlMGYzNGM0MzkzMDZmOWRmZjlkMDFjYTE1NzkyYjVmZDU", "commit": {"author": {"name": "Michael Woerister", "email": "michaelwoerister@posteo", "date": "2021-10-19T09:46:51Z"}, "committer": {"name": "Michael Woerister", "email": "michaelwoerister@posteo", "date": "2021-10-19T11:57:35Z"}, "message": "Erase late-bound regions before computing vtable debuginfo name.", "tree": {"sha": "22fdfcd4304100b1900582d3e43ed61d748c25ae", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/22fdfcd4304100b1900582d3e43ed61d748c25ae"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bf39d86e0f34c439306f9dff9d01ca15792b5fd5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bf39d86e0f34c439306f9dff9d01ca15792b5fd5", "html_url": "https://github.com/rust-lang/rust/commit/bf39d86e0f34c439306f9dff9d01ca15792b5fd5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bf39d86e0f34c439306f9dff9d01ca15792b5fd5/comments", "author": {"login": "michaelwoerister", "id": 1825894, "node_id": "MDQ6VXNlcjE4MjU4OTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1825894?v=4", "gravatar_id": "", "url": "https://api.github.com/users/michaelwoerister", "html_url": "https://github.com/michaelwoerister", "followers_url": "https://api.github.com/users/michaelwoerister/followers", "following_url": "https://api.github.com/users/michaelwoerister/following{/other_user}", "gists_url": "https://api.github.com/users/michaelwoerister/gists{/gist_id}", "starred_url": "https://api.github.com/users/michaelwoerister/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/michaelwoerister/subscriptions", "organizations_url": "https://api.github.com/users/michaelwoerister/orgs", "repos_url": "https://api.github.com/users/michaelwoerister/repos", "events_url": "https://api.github.com/users/michaelwoerister/events{/privacy}", "received_events_url": "https://api.github.com/users/michaelwoerister/received_events", "type": "User", "site_admin": false}, "committer": {"login": "michaelwoerister", "id": 1825894, "node_id": "MDQ6VXNlcjE4MjU4OTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1825894?v=4", "gravatar_id": "", "url": "https://api.github.com/users/michaelwoerister", "html_url": "https://github.com/michaelwoerister", "followers_url": "https://api.github.com/users/michaelwoerister/followers", "following_url": "https://api.github.com/users/michaelwoerister/following{/other_user}", "gists_url": "https://api.github.com/users/michaelwoerister/gists{/gist_id}", "starred_url": "https://api.github.com/users/michaelwoerister/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/michaelwoerister/subscriptions", "organizations_url": "https://api.github.com/users/michaelwoerister/orgs", "repos_url": "https://api.github.com/users/michaelwoerister/repos", "events_url": "https://api.github.com/users/michaelwoerister/events{/privacy}", "received_events_url": "https://api.github.com/users/michaelwoerister/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cd8b56f528631b128f36605b28ae06e36377dc68", "url": "https://api.github.com/repos/rust-lang/rust/commits/cd8b56f528631b128f36605b28ae06e36377dc68", "html_url": "https://github.com/rust-lang/rust/commit/cd8b56f528631b128f36605b28ae06e36377dc68"}], "stats": {"total": 21, "additions": 14, "deletions": 7}, "files": [{"sha": "accb54e464553292fcd567093f4743a4fa453122", "filename": "compiler/rustc_codegen_ssa/src/debuginfo/type_names.rs", "status": "modified", "additions": 4, "deletions": 7, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/bf39d86e0f34c439306f9dff9d01ca15792b5fd5/compiler%2Frustc_codegen_ssa%2Fsrc%2Fdebuginfo%2Ftype_names.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bf39d86e0f34c439306f9dff9d01ca15792b5fd5/compiler%2Frustc_codegen_ssa%2Fsrc%2Fdebuginfo%2Ftype_names.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fdebuginfo%2Ftype_names.rs?ref=bf39d86e0f34c439306f9dff9d01ca15792b5fd5", "patch": "@@ -480,14 +480,11 @@ pub fn compute_debuginfo_vtable_name<'tcx>(\n     }\n \n     if let Some(trait_ref) = trait_ref {\n-        push_item_name(tcx, trait_ref.skip_binder().def_id, true, &mut vtable_name);\n+        let trait_ref =\n+            tcx.normalize_erasing_late_bound_regions(ty::ParamEnv::reveal_all(), trait_ref);\n+        push_item_name(tcx, trait_ref.def_id, true, &mut vtable_name);\n         visited.clear();\n-        push_generic_params_internal(\n-            tcx,\n-            trait_ref.skip_binder().substs,\n-            &mut vtable_name,\n-            &mut visited,\n-        );\n+        push_generic_params_internal(tcx, trait_ref.substs, &mut vtable_name, &mut visited);\n     } else {\n         vtable_name.push_str(\"_\");\n     }"}, {"sha": "5f68da2b6b044c86e6dc04ddaa690276ea658bc9", "filename": "src/test/codegen/debug-vtable.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/bf39d86e0f34c439306f9dff9d01ca15792b5fd5/src%2Ftest%2Fcodegen%2Fdebug-vtable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bf39d86e0f34c439306f9dff9d01ca15792b5fd5/src%2Ftest%2Fcodegen%2Fdebug-vtable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fdebug-vtable.rs?ref=bf39d86e0f34c439306f9dff9d01ca15792b5fd5", "patch": "@@ -18,6 +18,9 @@\n // MSVC-LABEL: !DIGlobalVariable(name: \"impl$<debug_vtable::Foo, _>::vtable$\"\n // CHECK: !DISubrange(count: 3\n \n+// NONMSVC-LABEL: !DIGlobalVariable(name: \"<debug_vtable::bar::{closure#0} as core::ops::function::FnOnce<(core::option::Option<&dyn core::ops::function::Fn<(), Output=()>>)>>::{vtable}\"\n+// MSVC-LABEL: !DIGlobalVariable(name: \"impl$<debug_vtable::bar::closure$0, core::ops::function::FnOnce<tuple$<enum$<core::option::Option<ref$<dyn$<core::ops::function::Fn<tuple$<>,assoc$<Output,tuple$<> > > > > >, {{.*}}, {{.*}}, Some> > > >::vtable$\"\n+\n #![crate_type = \"lib\"]\n \n pub struct Foo;\n@@ -45,3 +48,10 @@ pub fn foo(x: &Foo) -> (u32, (u64, i8), &dyn Send) {\n     let z: &dyn SomeTraitWithGenerics<u64, i8> = x;\n     (y.method1(), z.method1(), x as &dyn Send)\n }\n+\n+// Constructing the debuginfo name for the FnOnce vtable below initially caused an ICE on MSVC\n+// because the trait type contains a late bound region that needed to be erased before the type\n+// layout for the niche enum `Option<&dyn Fn()>` could can be computed.\n+pub fn bar() -> Box<dyn FnOnce(Option<&dyn Fn()>)> {\n+    Box::new(|_x: Option<&dyn Fn()>| {})\n+}"}]}