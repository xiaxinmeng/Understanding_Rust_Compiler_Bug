{"sha": "e07826b1991bbb34da71c99d2f08d11ed8c84885", "node_id": "MDY6Q29tbWl0NzI0NzEyOmUwNzgyNmIxOTkxYmJiMzRkYTcxYzk5ZDJmMDhkMTFlZDhjODQ4ODU=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-06-26T16:52:53Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-06-26T16:52:53Z"}, "message": "Merge #5017\n\n5017: Add custom cargo runners support. r=matklad a=vsrs\n\nThis PR adds an option to delegate actual cargo commands building to another extension. For example, to use a different manager like [cross](https://github.com/rust-embedded/cross).\r\n\r\nhttps://github.com/vsrs/cross-rust-analyzer is an example of such extension. I'll publish it after the rust-analyzer release with this functionality.\r\n\r\nFixes https://github.com/rust-analyzer/rust-analyzer/issues/4902\n\nCo-authored-by: vsrs <vit@conrlab.com>", "tree": {"sha": "33707ec570f04f070d39a19eb80c700788adfee5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/33707ec570f04f070d39a19eb80c700788adfee5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e07826b1991bbb34da71c99d2f08d11ed8c84885", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJe9iflCRBK7hj4Ov3rIwAAdHIIAHjwOX95TYTIzZTY0OTiF7Ep\ngPgmifH5AgvemAfh3SMdbnmNpeG2NOlBDcNhsL0tg/d49DgAkzfRqX6O73Xf7wgd\nEUaqRpx5N4Wdhu4Xs3pK7WsL4CnV8pxh+awl9VxKqs9535iOgmeJ7vWnHgwkSAuE\ne2nre7kG3afVvRJ+nQNCBfwt/BweeFfkb3L5C1VXpO70QRJlyVej2365AA0nFtKP\ngTCGB/PFXcUNbhOQxrg0mUMcpFtICfzOZBKhBk/c0Mg8nZB0pR/3Bksl67xV2bPh\n0xSSQBtWdIz6VBJaD1LIy/Ap/0PpLXc4HJE/m9wNbe9gHj8tj+AAJzc2t8TKPok=\n=ohIf\n-----END PGP SIGNATURE-----\n", "payload": "tree 33707ec570f04f070d39a19eb80c700788adfee5\nparent 7e4d26be22d5fa69261fb35e98c4e19692f3287d\nparent 2791f37a045962535c7b8691a942a7e739d75cad\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1593190373 +0000\ncommitter GitHub <noreply@github.com> 1593190373 +0000\n\nMerge #5017\n\n5017: Add custom cargo runners support. r=matklad a=vsrs\n\nThis PR adds an option to delegate actual cargo commands building to another extension. For example, to use a different manager like [cross](https://github.com/rust-embedded/cross).\r\n\r\nhttps://github.com/vsrs/cross-rust-analyzer is an example of such extension. I'll publish it after the rust-analyzer release with this functionality.\r\n\r\nFixes https://github.com/rust-analyzer/rust-analyzer/issues/4902\n\nCo-authored-by: vsrs <vit@conrlab.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e07826b1991bbb34da71c99d2f08d11ed8c84885", "html_url": "https://github.com/rust-lang/rust/commit/e07826b1991bbb34da71c99d2f08d11ed8c84885", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e07826b1991bbb34da71c99d2f08d11ed8c84885/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7e4d26be22d5fa69261fb35e98c4e19692f3287d", "url": "https://api.github.com/repos/rust-lang/rust/commits/7e4d26be22d5fa69261fb35e98c4e19692f3287d", "html_url": "https://github.com/rust-lang/rust/commit/7e4d26be22d5fa69261fb35e98c4e19692f3287d"}, {"sha": "2791f37a045962535c7b8691a942a7e739d75cad", "url": "https://api.github.com/repos/rust-lang/rust/commits/2791f37a045962535c7b8691a942a7e739d75cad", "html_url": "https://github.com/rust-lang/rust/commit/2791f37a045962535c7b8691a942a7e739d75cad"}], "stats": {"total": 187, "additions": 104, "deletions": 83}, "files": [{"sha": "f542a490a95d067d22b0d939ce9a0dc02a3380ab", "filename": "editors/code/package.json", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/e07826b1991bbb34da71c99d2f08d11ed8c84885/editors%2Fcode%2Fpackage.json", "raw_url": "https://github.com/rust-lang/rust/raw/e07826b1991bbb34da71c99d2f08d11ed8c84885/editors%2Fcode%2Fpackage.json", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fpackage.json?ref=e07826b1991bbb34da71c99d2f08d11ed8c84885", "patch": "@@ -336,6 +336,14 @@\n                     \"default\": null,\n                     \"description\": \"List of features to activate. Defaults to `rust-analyzer.cargo.features`.\"\n                 },\n+                \"rust-analyzer.cargoRunner\": {\n+                    \"type\": [\n+                        \"null\",\n+                        \"string\"\n+                    ],\n+                    \"default\": null,\n+                    \"description\": \"Custom cargo runner extension ID.\"\n+                },\n                 \"rust-analyzer.inlayHints.enable\": {\n                     \"type\": \"boolean\",\n                     \"default\": true,"}, {"sha": "8c9d7802fffe0fd4b2ead84880816165fb6d2870", "filename": "editors/code/src/commands.ts", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/e07826b1991bbb34da71c99d2f08d11ed8c84885/editors%2Fcode%2Fsrc%2Fcommands.ts", "raw_url": "https://github.com/rust-lang/rust/raw/e07826b1991bbb34da71c99d2f08d11ed8c84885/editors%2Fcode%2Fsrc%2Fcommands.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fcommands.ts?ref=e07826b1991bbb34da71c99d2f08d11ed8c84885", "patch": "@@ -394,7 +394,7 @@ export function run(ctx: Ctx): Cmd {\n \n         item.detail = 'rerun';\n         prevRunnable = item;\n-        const task = createTask(item.runnable);\n+        const task = await createTask(item.runnable, ctx.config);\n         return await vscode.tasks.executeTask(task);\n     };\n }\n@@ -404,7 +404,7 @@ export function runSingle(ctx: Ctx): Cmd {\n         const editor = ctx.activeRustEditor;\n         if (!editor) return;\n \n-        const task = createTask(runnable);\n+        const task = await createTask(runnable, ctx.config);\n         task.group = vscode.TaskGroup.Build;\n         task.presentationOptions = {\n             reveal: vscode.TaskRevealKind.Always,"}, {"sha": "fc95a7de6b8514960dc50fd12ee61ea2e35444df", "filename": "editors/code/src/config.ts", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/e07826b1991bbb34da71c99d2f08d11ed8c84885/editors%2Fcode%2Fsrc%2Fconfig.ts", "raw_url": "https://github.com/rust-lang/rust/raw/e07826b1991bbb34da71c99d2f08d11ed8c84885/editors%2Fcode%2Fsrc%2Fconfig.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fconfig.ts?ref=e07826b1991bbb34da71c99d2f08d11ed8c84885", "patch": "@@ -110,6 +110,10 @@ export class Config {\n         };\n     }\n \n+    get cargoRunner() {\n+        return this.get<string | undefined>(\"cargoRunner\");\n+    }\n+\n     get debug() {\n         // \"/rustc/<id>\" used by suggestions only.\n         const { [\"/rustc/<id>\"]: _, ...sourceFileMap } = this.get<Record<string, string>>(\"debug.sourceFileMap\");"}, {"sha": "5ceab8b44e2a3f445a4f90b3af833a01f14e311c", "filename": "editors/code/src/main.ts", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e07826b1991bbb34da71c99d2f08d11ed8c84885/editors%2Fcode%2Fsrc%2Fmain.ts", "raw_url": "https://github.com/rust-lang/rust/raw/e07826b1991bbb34da71c99d2f08d11ed8c84885/editors%2Fcode%2Fsrc%2Fmain.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fmain.ts?ref=e07826b1991bbb34da71c99d2f08d11ed8c84885", "patch": "@@ -114,7 +114,7 @@ export async function activate(context: vscode.ExtensionContext) {\n     ctx.registerCommand('applyActionGroup', commands.applyActionGroup);\n     ctx.registerCommand('gotoLocation', commands.gotoLocation);\n \n-    ctx.pushCleanup(activateTaskProvider(workspaceFolder));\n+    ctx.pushCleanup(activateTaskProvider(workspaceFolder, ctx.config));\n \n     activateInlayHints(ctx);\n "}, {"sha": "766b0511269842180fa2f4bef1719a2b2f2abb67", "filename": "editors/code/src/run.ts", "status": "modified", "additions": 18, "deletions": 40, "changes": 58, "blob_url": "https://github.com/rust-lang/rust/blob/e07826b1991bbb34da71c99d2f08d11ed8c84885/editors%2Fcode%2Fsrc%2Frun.ts", "raw_url": "https://github.com/rust-lang/rust/raw/e07826b1991bbb34da71c99d2f08d11ed8c84885/editors%2Fcode%2Fsrc%2Frun.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Frun.ts?ref=e07826b1991bbb34da71c99d2f08d11ed8c84885", "patch": "@@ -1,10 +1,11 @@\n import * as vscode from 'vscode';\n import * as lc from 'vscode-languageclient';\n import * as ra from './lsp_ext';\n-import * as toolchain from \"./toolchain\";\n+import * as tasks from './tasks';\n \n import { Ctx } from './ctx';\n import { makeDebugConfig } from './debug';\n+import { Config } from './config';\n \n const quickPickButtons = [{ iconPath: new vscode.ThemeIcon(\"save\"), tooltip: \"Save as a launch.json configurtation.\" }];\n \n@@ -95,52 +96,29 @@ export class RunnableQuickPick implements vscode.QuickPickItem {\n     }\n }\n \n-interface CargoTaskDefinition extends vscode.TaskDefinition {\n-    type: 'cargo';\n-    label: string;\n-    command: string;\n-    args: string[];\n-    env?: { [key: string]: string };\n-}\n-\n-export function createTask(runnable: ra.Runnable): vscode.Task {\n-    const TASK_SOURCE = 'Rust';\n+export async function createTask(runnable: ra.Runnable, config: Config): Promise<vscode.Task> {\n+    if (runnable.kind !== \"cargo\") {\n+        // rust-analyzer supports only one kind, \"cargo\"\n+        // do not use tasks.TASK_TYPE here, these are completely different meanings.\n \n-    let command;\n-    switch (runnable.kind) {\n-        case \"cargo\": command = toolchain.getPathForExecutable(\"cargo\");\n+        throw `Unexpected runnable kind: ${runnable.kind}`;\n     }\n+\n     const args = [...runnable.args.cargoArgs]; // should be a copy!\n     if (runnable.args.executableArgs.length > 0) {\n         args.push('--', ...runnable.args.executableArgs);\n     }\n-    const definition: CargoTaskDefinition = {\n-        type: 'cargo',\n-        label: runnable.label,\n-        command,\n-        args,\n+    const definition: tasks.CargoTaskDefinition = {\n+        type: tasks.TASK_TYPE,\n+        command: args[0], // run, test, etc...\n+        args: args.slice(1),\n+        cwd: runnable.args.workspaceRoot,\n         env: Object.assign({}, process.env as { [key: string]: string }, { \"RUST_BACKTRACE\": \"short\" }),\n     };\n \n-    const execOption: vscode.ShellExecutionOptions = {\n-        cwd: runnable.args.workspaceRoot || '.',\n-        env: definition.env,\n-    };\n-    const exec = new vscode.ShellExecution(\n-        definition.command,\n-        definition.args,\n-        execOption,\n-    );\n-\n-    const f = vscode.workspace.workspaceFolders![0];\n-    const t = new vscode.Task(\n-        definition,\n-        f,\n-        definition.label,\n-        TASK_SOURCE,\n-        exec,\n-        ['$rustc'],\n-    );\n-    t.presentationOptions.clear = true;\n-    return t;\n+    const target = vscode.workspace.workspaceFolders![0]; // safe, see main activate()\n+    const cargoTask = await tasks.buildCargoTask(target, definition, runnable.label, args, config.cargoRunner, true);\n+    cargoTask.presentationOptions.clear = true;\n+\n+    return cargoTask;\n }"}, {"sha": "14abbd5b794a0de462dc612a5d31c74a7be2459c", "filename": "editors/code/src/tasks.ts", "status": "modified", "additions": 71, "deletions": 40, "changes": 111, "blob_url": "https://github.com/rust-lang/rust/blob/e07826b1991bbb34da71c99d2f08d11ed8c84885/editors%2Fcode%2Fsrc%2Ftasks.ts", "raw_url": "https://github.com/rust-lang/rust/raw/e07826b1991bbb34da71c99d2f08d11ed8c84885/editors%2Fcode%2Fsrc%2Ftasks.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Ftasks.ts?ref=e07826b1991bbb34da71c99d2f08d11ed8c84885", "patch": "@@ -1,11 +1,14 @@\n import * as vscode from 'vscode';\n import * as toolchain from \"./toolchain\";\n+import { Config } from './config';\n+import { log } from './util';\n \n // This ends up as the `type` key in tasks.json. RLS also uses `cargo` and\n // our configuration should be compatible with it so use the same key.\n-const TASK_TYPE = 'cargo';\n+export const TASK_TYPE = 'cargo';\n+export const TASK_SOURCE = 'rust';\n \n-interface CargoTaskDefinition extends vscode.TaskDefinition {\n+export interface CargoTaskDefinition extends vscode.TaskDefinition {\n     command?: string;\n     args?: string[];\n     cwd?: string;\n@@ -14,73 +17,101 @@ interface CargoTaskDefinition extends vscode.TaskDefinition {\n \n class CargoTaskProvider implements vscode.TaskProvider {\n     private readonly target: vscode.WorkspaceFolder;\n+    private readonly config: Config;\n \n-    constructor(target: vscode.WorkspaceFolder) {\n+    constructor(target: vscode.WorkspaceFolder, config: Config) {\n         this.target = target;\n+        this.config = config;\n     }\n \n-    provideTasks(): vscode.Task[] {\n+    async provideTasks(): Promise<vscode.Task[]> {\n         // Detect Rust tasks. Currently we do not do any actual detection\n         // of tasks (e.g. aliases in .cargo/config) and just return a fixed\n         // set of tasks that always exist. These tasks cannot be removed in\n         // tasks.json - only tweaked.\n \n-        const cargoPath = toolchain.cargoPath();\n-\n-        return [\n+        const defs = [\n             { command: 'build', group: vscode.TaskGroup.Build },\n             { command: 'check', group: vscode.TaskGroup.Build },\n             { command: 'test', group: vscode.TaskGroup.Test },\n             { command: 'clean', group: vscode.TaskGroup.Clean },\n             { command: 'run', group: undefined },\n-        ]\n-            .map(({ command, group }) => {\n-                const vscodeTask = new vscode.Task(\n-                    // The contents of this object end up in the tasks.json entries.\n-                    {\n-                        type: TASK_TYPE,\n-                        command,\n-                    },\n-                    // The scope of the task - workspace or specific folder (global\n-                    // is not supported).\n-                    this.target,\n-                    // The task name, and task source. These are shown in the UI as\n-                    // `${source}: ${name}`, e.g. `rust: cargo build`.\n-                    `cargo ${command}`,\n-                    'rust',\n-                    // What to do when this command is executed.\n-                    new vscode.ShellExecution(cargoPath, [command]),\n-                    // Problem matchers.\n-                    ['$rustc'],\n-                );\n-                vscodeTask.group = group;\n-                return vscodeTask;\n-            });\n+        ];\n+\n+        const tasks: vscode.Task[] = [];\n+        for (const def of defs) {\n+            const vscodeTask = await buildCargoTask(this.target, { type: TASK_TYPE, command: def.command }, `cargo ${def.command}`, [def.command], this.config.cargoRunner);\n+            vscodeTask.group = def.group;\n+            tasks.push(vscodeTask);\n+        }\n+\n+        return tasks;\n     }\n \n-    resolveTask(task: vscode.Task): vscode.Task | undefined {\n+    async resolveTask(task: vscode.Task): Promise<vscode.Task | undefined> {\n         // VSCode calls this for every cargo task in the user's tasks.json,\n         // we need to inform VSCode how to execute that command by creating\n         // a ShellExecution for it.\n \n         const definition = task.definition as CargoTaskDefinition;\n \n-        if (definition.type === 'cargo' && definition.command) {\n+        if (definition.type === TASK_TYPE && definition.command) {\n             const args = [definition.command].concat(definition.args ?? []);\n \n-            return new vscode.Task(\n-                definition,\n-                task.name,\n-                'rust',\n-                new vscode.ShellExecution('cargo', args, definition),\n-            );\n+            return await buildCargoTask(this.target, definition, task.name, args, this.config.cargoRunner);\n         }\n \n         return undefined;\n     }\n }\n \n-export function activateTaskProvider(target: vscode.WorkspaceFolder): vscode.Disposable {\n-    const provider = new CargoTaskProvider(target);\n+export async function buildCargoTask(\n+    target: vscode.WorkspaceFolder,\n+    definition: CargoTaskDefinition,\n+    name: string,\n+    args: string[],\n+    customRunner?: string,\n+    throwOnError: boolean = false\n+): Promise<vscode.Task> {\n+\n+    let exec: vscode.ShellExecution | undefined = undefined;\n+\n+    if (customRunner) {\n+        const runnerCommand = `${customRunner}.buildShellExecution`;\n+        try {\n+            const runnerArgs = { kind: TASK_TYPE, args, cwd: definition.cwd, env: definition.env };\n+            const customExec = await vscode.commands.executeCommand(runnerCommand, runnerArgs);\n+            if (customExec) {\n+                if (customExec instanceof vscode.ShellExecution) {\n+                    exec = customExec;\n+                } else {\n+                    log.debug(\"Invalid cargo ShellExecution\", customExec);\n+                    throw \"Invalid cargo ShellExecution.\";\n+                }\n+            }\n+            // fallback to default processing\n+\n+        } catch (e) {\n+            if (throwOnError) throw `Cargo runner '${customRunner}' failed! ${e}`;\n+            // fallback to default processing\n+        }\n+    }\n+\n+    if (!exec) {\n+        exec = new vscode.ShellExecution(toolchain.cargoPath(), args, definition);\n+    }\n+\n+    return new vscode.Task(\n+        definition,\n+        target,\n+        name,\n+        TASK_SOURCE,\n+        exec,\n+        ['$rustc']\n+    );\n+}\n+\n+export function activateTaskProvider(target: vscode.WorkspaceFolder, config: Config): vscode.Disposable {\n+    const provider = new CargoTaskProvider(target, config);\n     return vscode.tasks.registerTaskProvider(TASK_TYPE, provider);\n }"}]}