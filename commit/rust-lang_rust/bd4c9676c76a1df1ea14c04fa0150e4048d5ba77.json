{"sha": "bd4c9676c76a1df1ea14c04fa0150e4048d5ba77", "node_id": "MDY6Q29tbWl0NzI0NzEyOmJkNGM5Njc2Yzc2YTFkZjFlYTE0YzA0ZmEwMTUwZTQwNDhkNWJhNzc=", "commit": {"author": {"name": "Aaron Hill", "email": "aa1ronham@gmail.com", "date": "2021-09-16T00:32:03Z"}, "committer": {"name": "Aaron Hill", "email": "aa1ronham@gmail.com", "date": "2021-09-16T00:36:28Z"}, "message": "Fix linting when trailing macro expands to a trailing semi\n\nWhen a macro is used in the trailing expression position of a block\n(e.g. `fn foo() { my_macro!() }`), we currently parse it as an\nexpression, rather than a statement. As a result, we ended up\nusing the `NodeId` of the containing statement as our `lint_node_id`,\neven though we don't normally do this for macro calls.\n\nIf such a macro expands to an expression with a `#[cfg]` attribute,\nthen the trailing statement can get removed entirely. This lead to\nan ICE, since we were usng the `NodeId` of the expression to emit\na lint.\n\nThs commit makes us skip updating `lint_node_id` when handling\na macro in trailing expression position. This will cause us to\nlint at the closest parent of the macro call.", "tree": {"sha": "45c728d240f87e915b5e0fbfa771bc890fbbc074", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/45c728d240f87e915b5e0fbfa771bc890fbbc074"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bd4c9676c76a1df1ea14c04fa0150e4048d5ba77", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE7J9Gc3TfBwj2K399tAh+UQ6YsWQFAmFCkY0ACgkQtAh+UQ6Y\nsWQHdhAAuAhfKJcbLpBeldQdS2XSCEjQ4rsfk/L+3EBgp1zHxC58jfvCC/+K+N5r\nr6XCA20+Sj03sTiSj6QTvhQfvp3qwue9Agw9dUC7lVmMLGxhuJ3tcz83/N9lAy2M\nYQ4GaLI8XvkDxJTsmDP2O0POtWLrsYr3rBQxciRhPrQ46OW9x1u2GmJwnBqk3q8L\nAYwX6qNDp+xZgAvtNjBh+CM0l2L+MJMhfzC0IHHYZ3ka8XilOSTCx75rrgOFYzLT\nMV89oeuR/0OCk6oWICVKaxWfNqFM7v+tEyv2KDA5q1IL+2aJ9s8nTssyQ579YEUF\n+ujDZt6fz96lWUk4dM0da8XmUmZK2ndwUWVbl5Zwy0YNVV3ynydKF40uM57hfony\nqd1DgbXRlIB2MrYDfqpYFgqLCFBHCi4Kby1EBxCH/f91KKfJ5na5/U7WlQ2hH8A/\nF6cSJwRwyQKdr8QHu2nETu4bAckBh1zzwoqf966RZ9U0SifoDRK2FrDqAcT8LUAt\n5zmQeXUG4Rka1sku1Uon7PdR7i62LhAvEp5fJwntfYKJqTvTVso2Ts+INmcrxbLu\nfWyG8oFS90qn/Vbja3laVpQ5VMkGiuQpUqWqSw4MCRed+F48bDUVk7OUxP8Usk5J\nTlaG+05dfVZJxsSs3FuPJhyNh6tCCgh2BHFQAwH8usqQjw4cnzo=\n=XTNA\n-----END PGP SIGNATURE-----", "payload": "tree 45c728d240f87e915b5e0fbfa771bc890fbbc074\nparent 2c7bc5e33c25e29058cbafefe680da8d5e9220e9\nauthor Aaron Hill <aa1ronham@gmail.com> 1631752323 -0500\ncommitter Aaron Hill <aa1ronham@gmail.com> 1631752588 -0500\n\nFix linting when trailing macro expands to a trailing semi\n\nWhen a macro is used in the trailing expression position of a block\n(e.g. `fn foo() { my_macro!() }`), we currently parse it as an\nexpression, rather than a statement. As a result, we ended up\nusing the `NodeId` of the containing statement as our `lint_node_id`,\neven though we don't normally do this for macro calls.\n\nIf such a macro expands to an expression with a `#[cfg]` attribute,\nthen the trailing statement can get removed entirely. This lead to\nan ICE, since we were usng the `NodeId` of the expression to emit\na lint.\n\nThs commit makes us skip updating `lint_node_id` when handling\na macro in trailing expression position. This will cause us to\nlint at the closest parent of the macro call.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bd4c9676c76a1df1ea14c04fa0150e4048d5ba77", "html_url": "https://github.com/rust-lang/rust/commit/bd4c9676c76a1df1ea14c04fa0150e4048d5ba77", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bd4c9676c76a1df1ea14c04fa0150e4048d5ba77/comments", "author": {"login": "Aaron1011", "id": 1408859, "node_id": "MDQ6VXNlcjE0MDg4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1408859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Aaron1011", "html_url": "https://github.com/Aaron1011", "followers_url": "https://api.github.com/users/Aaron1011/followers", "following_url": "https://api.github.com/users/Aaron1011/following{/other_user}", "gists_url": "https://api.github.com/users/Aaron1011/gists{/gist_id}", "starred_url": "https://api.github.com/users/Aaron1011/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Aaron1011/subscriptions", "organizations_url": "https://api.github.com/users/Aaron1011/orgs", "repos_url": "https://api.github.com/users/Aaron1011/repos", "events_url": "https://api.github.com/users/Aaron1011/events{/privacy}", "received_events_url": "https://api.github.com/users/Aaron1011/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Aaron1011", "id": 1408859, "node_id": "MDQ6VXNlcjE0MDg4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1408859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Aaron1011", "html_url": "https://github.com/Aaron1011", "followers_url": "https://api.github.com/users/Aaron1011/followers", "following_url": "https://api.github.com/users/Aaron1011/following{/other_user}", "gists_url": "https://api.github.com/users/Aaron1011/gists{/gist_id}", "starred_url": "https://api.github.com/users/Aaron1011/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Aaron1011/subscriptions", "organizations_url": "https://api.github.com/users/Aaron1011/orgs", "repos_url": "https://api.github.com/users/Aaron1011/repos", "events_url": "https://api.github.com/users/Aaron1011/events{/privacy}", "received_events_url": "https://api.github.com/users/Aaron1011/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2c7bc5e33c25e29058cbafefe680da8d5e9220e9", "url": "https://api.github.com/repos/rust-lang/rust/commits/2c7bc5e33c25e29058cbafefe680da8d5e9220e9", "html_url": "https://github.com/rust-lang/rust/commit/2c7bc5e33c25e29058cbafefe680da8d5e9220e9"}], "stats": {"total": 49, "additions": 43, "deletions": 6}, "files": [{"sha": "d32593f34adefc750c68f8a9ed4f1b20f5f8a29c", "filename": "compiler/rustc_expand/src/expand.rs", "status": "modified", "additions": 9, "deletions": 6, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/bd4c9676c76a1df1ea14c04fa0150e4048d5ba77/compiler%2Frustc_expand%2Fsrc%2Fexpand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bd4c9676c76a1df1ea14c04fa0150e4048d5ba77/compiler%2Frustc_expand%2Fsrc%2Fexpand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_expand%2Fsrc%2Fexpand.rs?ref=bd4c9676c76a1df1ea14c04fa0150e4048d5ba77", "patch": "@@ -1386,14 +1386,17 @@ impl<'a, 'b> MutVisitor for InvocationCollector<'a, 'b> {\n         // `SEMICOLON_IN_EXPRESSIONS_FROM_MACROS` lint if needed.\n         // See #78991 for an investigation of treating macros in this position\n         // as statements, rather than expressions, during parsing.\n-        if let StmtKind::Expr(expr) = &stmt.kind {\n-            if matches!(**expr, ast::Expr { kind: ast::ExprKind::MacCall(..), .. }) {\n+        let res = match &stmt.kind {\n+            StmtKind::Expr(expr)\n+                if matches!(**expr, ast::Expr { kind: ast::ExprKind::MacCall(..), .. }) =>\n+            {\n                 self.cx.current_expansion.is_trailing_mac = true;\n+                // Don't use `assign_id` for this statement - it may get removed\n+                // entirely due to a `#[cfg]` on the contained expression\n+                noop_flat_map_stmt(stmt, self)\n             }\n-        }\n-\n-        let res = assign_id!(self, &mut stmt.id, || noop_flat_map_stmt(stmt, self));\n-\n+            _ => assign_id!(self, &mut stmt.id, || noop_flat_map_stmt(stmt, self)),\n+        };\n         self.cx.current_expansion.is_trailing_mac = false;\n         res\n     }"}, {"sha": "f8e847563915e97b4e8475bf6ebdd285b5ecd782", "filename": "src/test/ui/macros/lint-trailing-macro-call.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/bd4c9676c76a1df1ea14c04fa0150e4048d5ba77/src%2Ftest%2Fui%2Fmacros%2Flint-trailing-macro-call.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bd4c9676c76a1df1ea14c04fa0150e4048d5ba77/src%2Ftest%2Fui%2Fmacros%2Flint-trailing-macro-call.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmacros%2Flint-trailing-macro-call.rs?ref=bd4c9676c76a1df1ea14c04fa0150e4048d5ba77", "patch": "@@ -0,0 +1,16 @@\n+// check-pass\n+//\n+// Ensures that we properly lint\n+// a removed 'expression' resulting from a macro\n+// in trailing expression position\n+\n+macro_rules! expand_it {\n+    () => {\n+        #[cfg(FALSE)] 25; //~  WARN trailing semicolon in macro\n+                          //~| WARN this was previously\n+    }\n+}\n+\n+fn main() {\n+    expand_it!()\n+}"}, {"sha": "a98a559c8afaded3aee9a1c917a384f0112718ab", "filename": "src/test/ui/macros/lint-trailing-macro-call.stderr", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/bd4c9676c76a1df1ea14c04fa0150e4048d5ba77/src%2Ftest%2Fui%2Fmacros%2Flint-trailing-macro-call.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/bd4c9676c76a1df1ea14c04fa0150e4048d5ba77/src%2Ftest%2Fui%2Fmacros%2Flint-trailing-macro-call.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmacros%2Flint-trailing-macro-call.stderr?ref=bd4c9676c76a1df1ea14c04fa0150e4048d5ba77", "patch": "@@ -0,0 +1,18 @@\n+warning: trailing semicolon in macro used in expression position\n+  --> $DIR/lint-trailing-macro-call.rs:9:25\n+   |\n+LL |         #[cfg(FALSE)] 25;\n+   |                         ^\n+...\n+LL |     expand_it!()\n+   |     ------------ in this macro invocation\n+   |\n+   = note: `#[warn(semicolon_in_expressions_from_macros)]` on by default\n+   = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n+   = note: for more information, see issue #79813 <https://github.com/rust-lang/rust/issues/79813>\n+   = note: macro invocations at the end of a block are treated as expressions\n+   = note: to ignore the value produced by the macro, add a semicolon after the invocation of `expand_it`\n+   = note: this warning originates in the macro `expand_it` (in Nightly builds, run with -Z macro-backtrace for more info)\n+\n+warning: 1 warning emitted\n+"}]}