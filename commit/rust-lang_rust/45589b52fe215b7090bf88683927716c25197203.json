{"sha": "45589b52fe215b7090bf88683927716c25197203", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQ1NTg5YjUyZmUyMTViNzA5MGJmODg2ODM5Mjc3MTZjMjUxOTcyMDM=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2020-04-08T02:35:51Z"}, "committer": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2020-04-09T02:55:05Z"}, "message": "track_caller: support on FFI imports", "tree": {"sha": "a9c93838a514a2fb0459d32c62fe1d2f21e95e0c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a9c93838a514a2fb0459d32c62fe1d2f21e95e0c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/45589b52fe215b7090bf88683927716c25197203", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/45589b52fe215b7090bf88683927716c25197203", "html_url": "https://github.com/rust-lang/rust/commit/45589b52fe215b7090bf88683927716c25197203", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/45589b52fe215b7090bf88683927716c25197203/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f6c729d4a09552ae04205a79a3cecb670ed587a0", "url": "https://api.github.com/repos/rust-lang/rust/commits/f6c729d4a09552ae04205a79a3cecb670ed587a0", "html_url": "https://github.com/rust-lang/rust/commit/f6c729d4a09552ae04205a79a3cecb670ed587a0"}], "stats": {"total": 93, "additions": 52, "deletions": 41}, "files": [{"sha": "8d9982131c33e0ec5ade815553c0289b1e686dcb", "filename": "src/librustc_error_codes/error_codes.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/45589b52fe215b7090bf88683927716c25197203/src%2Flibrustc_error_codes%2Ferror_codes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/45589b52fe215b7090bf88683927716c25197203/src%2Flibrustc_error_codes%2Ferror_codes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_error_codes%2Ferror_codes.rs?ref=45589b52fe215b7090bf88683927716c25197203", "patch": "@@ -416,7 +416,6 @@ E0734: include_str!(\"./error_codes/E0734.md\"),\n E0735: include_str!(\"./error_codes/E0735.md\"),\n E0736: include_str!(\"./error_codes/E0736.md\"),\n E0737: include_str!(\"./error_codes/E0737.md\"),\n-E0738: include_str!(\"./error_codes/E0738.md\"),\n E0739: include_str!(\"./error_codes/E0739.md\"),\n E0740: include_str!(\"./error_codes/E0740.md\"),\n E0741: include_str!(\"./error_codes/E0741.md\"),\n@@ -614,4 +613,5 @@ E0751: include_str!(\"./error_codes/E0751.md\"),\n     E0722, // Malformed `#[optimize]` attribute\n     E0724, // `#[ffi_returns_twice]` is only allowed in foreign functions\n     E0726, // non-explicit (not `'_`) elided lifetime in unsupported position\n+//  E0738, // Removed; errored on `#[track_caller] fn`s in `extern \"Rust\" { ... }`.\n }"}, {"sha": "8f31b701e495e7d609135e2dee50035d72f7c59b", "filename": "src/librustc_error_codes/error_codes/E0738.md", "status": "removed", "additions": 0, "deletions": 11, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/f6c729d4a09552ae04205a79a3cecb670ed587a0/src%2Flibrustc_error_codes%2Ferror_codes%2FE0738.md", "raw_url": "https://github.com/rust-lang/rust/raw/f6c729d4a09552ae04205a79a3cecb670ed587a0/src%2Flibrustc_error_codes%2Ferror_codes%2FE0738.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_error_codes%2Ferror_codes%2FE0738.md?ref=f6c729d4a09552ae04205a79a3cecb670ed587a0", "patch": "@@ -1,11 +0,0 @@\n-`#[track_caller]` cannot be used to annotate foreign functions.\n-\n-Erroneous example:\n-\n-```compile_fail,E0738\n-#![feature(track_caller)]\n-extern \"Rust\" {\n-    #[track_caller]\n-    fn bar();\n-}\n-```"}, {"sha": "3f2c02f6c461bb96887a08af0097d4501c90a4d0", "filename": "src/librustc_passes/check_attr.rs", "status": "modified", "additions": 1, "deletions": 11, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/45589b52fe215b7090bf88683927716c25197203/src%2Flibrustc_passes%2Fcheck_attr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/45589b52fe215b7090bf88683927716c25197203/src%2Flibrustc_passes%2Fcheck_attr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_passes%2Fcheck_attr.rs?ref=45589b52fe215b7090bf88683927716c25197203", "patch": "@@ -151,17 +151,7 @@ impl CheckAttrVisitor<'tcx> {\n                 .emit();\n                 false\n             }\n-            Target::ForeignFn => {\n-                struct_span_err!(\n-                    self.tcx.sess,\n-                    *attr_span,\n-                    E0738,\n-                    \"`#[track_caller]` is not supported on foreign functions\",\n-                )\n-                .emit();\n-                false\n-            }\n-            Target::Fn | Target::Method(..) => true,\n+            Target::Fn | Target::Method(..) | Target::ForeignFn => true,\n             _ => {\n                 struct_span_err!(\n                     self.tcx.sess,"}, {"sha": "9f6a69a51c0ceca41873815d6a28172e7ae86e52", "filename": "src/test/ui/rfc-2091-track-caller/error-extern-fn.rs", "status": "removed", "additions": 0, "deletions": 9, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/f6c729d4a09552ae04205a79a3cecb670ed587a0/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ferror-extern-fn.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f6c729d4a09552ae04205a79a3cecb670ed587a0/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ferror-extern-fn.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ferror-extern-fn.rs?ref=f6c729d4a09552ae04205a79a3cecb670ed587a0", "patch": "@@ -1,9 +0,0 @@\n-#![feature(track_caller)]\n-#![allow(dead_code)]\n-\n-extern \"Rust\" {\n-    #[track_caller] //~ ERROR: `#[track_caller]` is not supported on foreign functions\n-    fn bar();\n-}\n-\n-fn main() {}"}, {"sha": "b03f5fbbdb20e1bf5ba06f205d61a3f2fd5d6c55", "filename": "src/test/ui/rfc-2091-track-caller/error-extern-fn.stderr", "status": "removed", "additions": 0, "deletions": 9, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/f6c729d4a09552ae04205a79a3cecb670ed587a0/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ferror-extern-fn.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/f6c729d4a09552ae04205a79a3cecb670ed587a0/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ferror-extern-fn.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ferror-extern-fn.stderr?ref=f6c729d4a09552ae04205a79a3cecb670ed587a0", "patch": "@@ -1,9 +0,0 @@\n-error[E0738]: `#[track_caller]` is not supported on foreign functions\n-  --> $DIR/error-extern-fn.rs:5:5\n-   |\n-LL |     #[track_caller]\n-   |     ^^^^^^^^^^^^^^^\n-\n-error: aborting due to previous error\n-\n-For more information about this error, try `rustc --explain E0738`."}, {"sha": "23c17d743c43c217ff5db5be31d108a52c08427e", "filename": "src/test/ui/rfc-2091-track-caller/track-caller-ffi.rs", "status": "added", "additions": 50, "deletions": 0, "changes": 50, "blob_url": "https://github.com/rust-lang/rust/blob/45589b52fe215b7090bf88683927716c25197203/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ftrack-caller-ffi.rs", "raw_url": "https://github.com/rust-lang/rust/raw/45589b52fe215b7090bf88683927716c25197203/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ftrack-caller-ffi.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frfc-2091-track-caller%2Ftrack-caller-ffi.rs?ref=45589b52fe215b7090bf88683927716c25197203", "patch": "@@ -0,0 +1,50 @@\n+// run-pass\n+\n+#![feature(track_caller)]\n+\n+use std::panic::Location;\n+\n+extern \"Rust\" {\n+    #[track_caller]\n+    fn rust_track_caller_ffi_test_tracked() -> &'static Location<'static>;\n+    fn rust_track_caller_ffi_test_untracked() -> &'static Location<'static>;\n+}\n+\n+fn rust_track_caller_ffi_test_nested_tracked() -> &'static Location<'static> {\n+    unsafe { rust_track_caller_ffi_test_tracked() }\n+}\n+\n+mod provides {\n+    use std::panic::Location;\n+    #[track_caller] // UB if we did not have this!\n+    #[no_mangle]\n+    fn rust_track_caller_ffi_test_tracked() -> &'static Location<'static> {\n+        Location::caller()\n+    }\n+    #[no_mangle]\n+    fn rust_track_caller_ffi_test_untracked() -> &'static Location<'static> {\n+        Location::caller()\n+    }\n+}\n+\n+fn main() {\n+    let location = Location::caller();\n+    assert_eq!(location.file(), file!());\n+    assert_eq!(location.line(), 31);\n+    assert_eq!(location.column(), 20);\n+\n+    let tracked = unsafe { rust_track_caller_ffi_test_tracked() };\n+    assert_eq!(tracked.file(), file!());\n+    assert_eq!(tracked.line(), 36);\n+    assert_eq!(tracked.column(), 28);\n+\n+    let untracked = unsafe { rust_track_caller_ffi_test_untracked() };\n+    assert_eq!(untracked.file(), file!());\n+    assert_eq!(untracked.line(), 26);\n+    assert_eq!(untracked.column(), 9);\n+\n+    let contained = rust_track_caller_ffi_test_nested_tracked();\n+    assert_eq!(contained.file(), file!());\n+    assert_eq!(contained.line(), 14);\n+    assert_eq!(contained.column(), 14);\n+}"}]}