{"sha": "eacfb2b265fc108a0b024e6afacaf3f28fd0235e", "node_id": "MDY6Q29tbWl0NzI0NzEyOmVhY2ZiMmIyNjVmYzEwOGEwYjAyNGU2YWZhY2FmM2YyOGZkMDIzNWU=", "commit": {"author": {"name": "David Wood", "email": "david@davidtw.co", "date": "2020-09-15T13:38:41Z"}, "committer": {"name": "David Wood", "email": "david@davidtw.co", "date": "2020-10-02T12:54:25Z"}, "message": "resolve: prohibit anon const non-static lifetimes\n\nThis commit modifies name resolution to emit an error when non-static\nlifetimes are used in anonymous constants when the `min_const_generics`\nfeature is enabled.\n\nSigned-off-by: David Wood <david@davidtw.co>", "tree": {"sha": "55b8ef76f8e9385ddbfab3d0fc4c15f6bb6067d1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/55b8ef76f8e9385ddbfab3d0fc4c15f6bb6067d1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/eacfb2b265fc108a0b024e6afacaf3f28fd0235e", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEfgm2/wUjk9OnjxlyJZLnbIc4H9kFAl93IwEACgkQJZLnbIc4\nH9n0XhAAoZsc6nqgDxkGVs5wmUh3F+QptdeFk5sjbp0ZrecWSFBQPtrk8vq3VB0z\noM0w+mi7z3owya4cEcx+kNa6aCV8TojVKhkz0IVmbqNKowQ73Ee41aLUVgLUXT0N\nweqyHxVxIlbXr19sjN4PIwwaFGq64IpRsWPak3is4ZWNvGRpWDV1i1ewimSY37+r\nVhPEXBSkW1CMQXVqzfy6apIVXDxi1FaAgHQCfvqafjUwOuaKICWfcrUeA9tEt3Pb\nzdWfz/59DGtvBsEbi1UFCGAgxZ8ASHH1Rv5AuHMr0Ckv+Ji/EnvRBynzlZQwSOri\nvF92/PNDdty18cQz27smU8fGZNhixcJFB5le8mmmnKABpXJsa3NGE//srs5LWYFJ\nRsSSrYUAPhIHKMyorCiq9VGLDbbc41L4UiyAXXZGtmRXOWDu10Q8WEUySY9jRL4N\n3RDwW6cZPvp3/RrXpupIGr+H4d6GYDovGt4YBdaXN82dH22tLXUklbUvd0gQFASp\n6ZqJ06JqZZWqph7eSEU3YnmViAZVQRn4sse8O8NQk+55Ypc49gDvpCJItcJKo/fO\nA2Qdhoqg7em/U1OCiAhRsey609aVqraMwU8X9RFSYM9mmUwuJyAXwyC6S012KgHN\n0/jlb3T00DQ9o/LKGMAgic4NJGf8vjV2zD+fCRwxSDDjI0W9Qas=\n=51HQ\n-----END PGP SIGNATURE-----", "payload": "tree 55b8ef76f8e9385ddbfab3d0fc4c15f6bb6067d1\nparent 154f1f544dd68f7b53ff8d9952811e855f4c2d7c\nauthor David Wood <david@davidtw.co> 1600177121 +0100\ncommitter David Wood <david@davidtw.co> 1601643265 +0100\n\nresolve: prohibit anon const non-static lifetimes\n\nThis commit modifies name resolution to emit an error when non-static\nlifetimes are used in anonymous constants when the `min_const_generics`\nfeature is enabled.\n\nSigned-off-by: David Wood <david@davidtw.co>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/eacfb2b265fc108a0b024e6afacaf3f28fd0235e", "html_url": "https://github.com/rust-lang/rust/commit/eacfb2b265fc108a0b024e6afacaf3f28fd0235e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/eacfb2b265fc108a0b024e6afacaf3f28fd0235e/comments", "author": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "committer": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "154f1f544dd68f7b53ff8d9952811e855f4c2d7c", "url": "https://api.github.com/repos/rust-lang/rust/commits/154f1f544dd68f7b53ff8d9952811e855f4c2d7c", "html_url": "https://github.com/rust-lang/rust/commit/154f1f544dd68f7b53ff8d9952811e855f4c2d7c"}], "stats": {"total": 81, "additions": 81, "deletions": 0}, "files": [{"sha": "521ea7ad184f979bcc4c48cbd98e35d7fc15c0e3", "filename": "compiler/rustc_resolve/src/late/diagnostics.rs", "status": "modified", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/eacfb2b265fc108a0b024e6afacaf3f28fd0235e/compiler%2Frustc_resolve%2Fsrc%2Flate%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eacfb2b265fc108a0b024e6afacaf3f28fd0235e/compiler%2Frustc_resolve%2Fsrc%2Flate%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Flate%2Fdiagnostics.rs?ref=eacfb2b265fc108a0b024e6afacaf3f28fd0235e", "patch": "@@ -16,6 +16,7 @@ use rustc_hir::def::{self, CtorKind, DefKind};\n use rustc_hir::def_id::{DefId, CRATE_DEF_INDEX, LOCAL_CRATE};\n use rustc_hir::PrimTy;\n use rustc_session::config::nightly_options;\n+use rustc_session::parse::feature_err;\n use rustc_span::hygiene::MacroKind;\n use rustc_span::symbol::{kw, sym, Ident, Symbol};\n use rustc_span::{BytePos, Span, DUMMY_SP};\n@@ -1599,4 +1600,32 @@ impl<'tcx> LifetimeContext<'_, 'tcx> {\n             _ => {}\n         }\n     }\n+\n+    /// Non-static lifetimes are prohibited in anonymous constants under `min_const_generics` so\n+    /// this function will emit an error if `min_const_generics` is enabled, the body identified by\n+    /// `body_id` is an anonymous constant and `lifetime_ref` is non-static.\n+    crate fn maybe_emit_forbidden_non_static_lifetime_error(\n+        &self,\n+        body_id: hir::BodyId,\n+        lifetime_ref: &'tcx hir::Lifetime,\n+    ) {\n+        let is_anon_const = matches!(\n+            self.tcx.def_kind(self.tcx.hir().body_owner_def_id(body_id)),\n+            hir::def::DefKind::AnonConst\n+        );\n+        let is_allowed_lifetime = matches!(\n+            lifetime_ref.name,\n+            hir::LifetimeName::Implicit | hir::LifetimeName::Static | hir::LifetimeName::Underscore\n+        );\n+\n+        if self.tcx.features().min_const_generics && is_anon_const && !is_allowed_lifetime {\n+            feature_err(\n+                &self.tcx.sess.parse_sess,\n+                sym::const_generics,\n+                lifetime_ref.span,\n+                \"a non-static lifetime is not allowed in a `const`\",\n+            )\n+            .emit();\n+        }\n+    }\n }"}, {"sha": "072fb509b192a8e130ba328edabfd5092007fc11", "filename": "compiler/rustc_resolve/src/late/lifetimes.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/eacfb2b265fc108a0b024e6afacaf3f28fd0235e/compiler%2Frustc_resolve%2Fsrc%2Flate%2Flifetimes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eacfb2b265fc108a0b024e6afacaf3f28fd0235e/compiler%2Frustc_resolve%2Fsrc%2Flate%2Flifetimes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Flate%2Flifetimes.rs?ref=eacfb2b265fc108a0b024e6afacaf3f28fd0235e", "patch": "@@ -1777,6 +1777,10 @@ impl<'a, 'tcx> LifetimeContext<'a, 'tcx> {\n         let result = loop {\n             match *scope {\n                 Scope::Body { id, s } => {\n+                    // Non-static lifetimes are prohibited in anonymous constants under\n+                    // `min_const_generics`.\n+                    self.maybe_emit_forbidden_non_static_lifetime_error(id, lifetime_ref);\n+\n                     outermost_body = Some(id);\n                     scope = s;\n                 }"}, {"sha": "02944e2bff2f5e6c64961c54d81c15f2cd4f04a6", "filename": "src/test/ui/const-generics/min_const_generics/forbid-non-static-lifetimes.rs", "status": "added", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/eacfb2b265fc108a0b024e6afacaf3f28fd0235e/src%2Ftest%2Fui%2Fconst-generics%2Fmin_const_generics%2Fforbid-non-static-lifetimes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eacfb2b265fc108a0b024e6afacaf3f28fd0235e/src%2Ftest%2Fui%2Fconst-generics%2Fmin_const_generics%2Fforbid-non-static-lifetimes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconst-generics%2Fmin_const_generics%2Fforbid-non-static-lifetimes.rs?ref=eacfb2b265fc108a0b024e6afacaf3f28fd0235e", "patch": "@@ -0,0 +1,27 @@\n+#![feature(min_const_generics)]\n+\n+// This test checks that non-static lifetimes are prohibited under `min_const_generics`. It\n+// currently emits an error with `min_const_generics`. This will ICE under `const_generics`.\n+\n+fn test<const N: usize>() {}\n+\n+fn issue_75323_and_74447_1<'a>() -> &'a () {\n+    test::<{ let _: &'a (); 3 },>();\n+   //~^ ERROR a non-static lifetime is not allowed in a `const`\n+    &()\n+}\n+\n+fn issue_75323_and_74447_2() {\n+    test::<{ let _: &(); 3 },>();\n+}\n+\n+fn issue_75323_and_74447_3() {\n+    test::<{ let _: &'static (); 3 },>();\n+}\n+\n+fn issue_73375<'a>() {\n+    [(); (|_: &'a u8| (), 0).1];\n+    //~^ ERROR a non-static lifetime is not allowed in a `const`\n+}\n+\n+fn main() {}"}, {"sha": "cdfd491e39541bcf34742c12824e39f90b02c1ca", "filename": "src/test/ui/const-generics/min_const_generics/forbid-non-static-lifetimes.stderr", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/eacfb2b265fc108a0b024e6afacaf3f28fd0235e/src%2Ftest%2Fui%2Fconst-generics%2Fmin_const_generics%2Fforbid-non-static-lifetimes.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/eacfb2b265fc108a0b024e6afacaf3f28fd0235e/src%2Ftest%2Fui%2Fconst-generics%2Fmin_const_generics%2Fforbid-non-static-lifetimes.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconst-generics%2Fmin_const_generics%2Fforbid-non-static-lifetimes.stderr?ref=eacfb2b265fc108a0b024e6afacaf3f28fd0235e", "patch": "@@ -0,0 +1,21 @@\n+error[E0658]: a non-static lifetime is not allowed in a `const`\n+  --> $DIR/forbid-non-static-lifetimes.rs:9:22\n+   |\n+LL |     test::<{ let _: &'a (); 3 },>();\n+   |                      ^^\n+   |\n+   = note: see issue #44580 <https://github.com/rust-lang/rust/issues/44580> for more information\n+   = help: add `#![feature(const_generics)]` to the crate attributes to enable\n+\n+error[E0658]: a non-static lifetime is not allowed in a `const`\n+  --> $DIR/forbid-non-static-lifetimes.rs:23:16\n+   |\n+LL |     [(); (|_: &'a u8| (), 0).1];\n+   |                ^^\n+   |\n+   = note: see issue #44580 <https://github.com/rust-lang/rust/issues/44580> for more information\n+   = help: add `#![feature(const_generics)]` to the crate attributes to enable\n+\n+error: aborting due to 2 previous errors\n+\n+For more information about this error, try `rustc --explain E0658`."}]}