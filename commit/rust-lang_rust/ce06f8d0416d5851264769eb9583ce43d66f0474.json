{"sha": "ce06f8d0416d5851264769eb9583ce43d66f0474", "node_id": "MDY6Q29tbWl0NzI0NzEyOmNlMDZmOGQwNDE2ZDU4NTEyNjQ3NjllYjk1ODNjZTQzZDY2ZjA0NzQ=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-06-26T10:06:34Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-06-26T10:06:34Z"}, "message": "Merge #5072 #5073\n\n5072: Cleanup r=matklad a=matklad\n\n\n\nbors r+\n\ud83e\udd16\n\n5073: `iterate_method_candidates`: Address review comments r=jonas-schievink a=jonas-schievink\n\nbors r+\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>\nCo-authored-by: Jonas Schievink <jonas.schievink@ferrous-systems.com>", "tree": {"sha": "cb59686b7c78406e7e3b704ac3ca132ecb697574", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/cb59686b7c78406e7e3b704ac3ca132ecb697574"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ce06f8d0416d5851264769eb9583ce43d66f0474", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJe9ciqCRBK7hj4Ov3rIwAAdHIIAE1bMJfbGmfgG6R6uydIkwzK\npIaWFgR8jjZ4xAql17lfLvApNpMcmfEep2BKzjMf81XwGelh2NZyPOs0ELGHyINH\nklL5WuNrYq3EG1mIvnG0n0qyGlmS/UpwrgZ+Il7w8tMFvox3n0Jdnmj0rNFiBULK\nRjJpTf5kRcul4gDW/Jduxgt83XcirZ0vmw02VWAd+NxzMhnaJ8iRzLSgPqA0aRsT\nHk1Wzcb6iXiBfxqq7+DTHp0ftP/qttOE6GmNGSntjWP5gfPVRO48ZNWJ21GDMFIp\nU3zgfdSeBCV0dQKgiNbE11c5RJwZd2EzcDYLCk2AxlWQpHbm7aW+us0NrpsFAlE=\n=/8PU\n-----END PGP SIGNATURE-----\n", "payload": "tree cb59686b7c78406e7e3b704ac3ca132ecb697574\nparent 38cd1b70e8d4b8f57ac2ae0702cf4728764094d9\nparent 12831b74af457ddfc06ebeb929e350574e2f35d5\nparent c4413064277090764653d20db9b94ea16dfcb494\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1593165994 +0000\ncommitter GitHub <noreply@github.com> 1593165994 +0000\n\nMerge #5072 #5073\n\n5072: Cleanup r=matklad a=matklad\n\n\n\nbors r+\n\ud83e\udd16\n\n5073: `iterate_method_candidates`: Address review comments r=jonas-schievink a=jonas-schievink\n\nbors r+\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>\nCo-authored-by: Jonas Schievink <jonas.schievink@ferrous-systems.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ce06f8d0416d5851264769eb9583ce43d66f0474", "html_url": "https://github.com/rust-lang/rust/commit/ce06f8d0416d5851264769eb9583ce43d66f0474", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ce06f8d0416d5851264769eb9583ce43d66f0474/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "38cd1b70e8d4b8f57ac2ae0702cf4728764094d9", "url": "https://api.github.com/repos/rust-lang/rust/commits/38cd1b70e8d4b8f57ac2ae0702cf4728764094d9", "html_url": "https://github.com/rust-lang/rust/commit/38cd1b70e8d4b8f57ac2ae0702cf4728764094d9"}, {"sha": "12831b74af457ddfc06ebeb929e350574e2f35d5", "url": "https://api.github.com/repos/rust-lang/rust/commits/12831b74af457ddfc06ebeb929e350574e2f35d5", "html_url": "https://github.com/rust-lang/rust/commit/12831b74af457ddfc06ebeb929e350574e2f35d5"}, {"sha": "c4413064277090764653d20db9b94ea16dfcb494", "url": "https://api.github.com/repos/rust-lang/rust/commits/c4413064277090764653d20db9b94ea16dfcb494", "html_url": "https://github.com/rust-lang/rust/commit/c4413064277090764653d20db9b94ea16dfcb494"}], "stats": {"total": 63, "additions": 35, "deletions": 28}, "files": [{"sha": "c19519cf11cdfcc07b27a5e023b59649cb3943ea", "filename": "crates/ra_hir_ty/src/method_resolution.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/ce06f8d0416d5851264769eb9583ce43d66f0474/crates%2Fra_hir_ty%2Fsrc%2Fmethod_resolution.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ce06f8d0416d5851264769eb9583ce43d66f0474/crates%2Fra_hir_ty%2Fsrc%2Fmethod_resolution.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_ty%2Fsrc%2Fmethod_resolution.rs?ref=ce06f8d0416d5851264769eb9583ce43d66f0474", "patch": "@@ -281,14 +281,15 @@ pub fn iterate_method_candidates<T>(\n         name,\n         mode,\n         &mut |ty, item| {\n+            assert!(slot.is_none());\n             slot = callback(ty, item);\n             slot.is_some()\n         },\n     );\n     slot\n }\n \n-pub fn iterate_method_candidates_impl(\n+fn iterate_method_candidates_impl(\n     ty: &Canonical<Ty>,\n     db: &dyn HirDatabase,\n     env: Arc<TraitEnvironment>,"}, {"sha": "1cf50b677fc6f997337a434154caafcab0a94a3f", "filename": "crates/rust-analyzer/src/diagnostics.rs", "status": "modified", "additions": 14, "deletions": 8, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/ce06f8d0416d5851264769eb9583ce43d66f0474/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ce06f8d0416d5851264769eb9583ce43d66f0474/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics.rs?ref=ce06f8d0416d5851264769eb9583ce43d66f0474", "patch": "@@ -3,7 +3,6 @@ pub(crate) mod to_proto;\n \n use std::{collections::HashMap, mem, sync::Arc};\n \n-use lsp_types::{Diagnostic, Range};\n use ra_ide::FileId;\n use rustc_hash::FxHashSet;\n \n@@ -19,15 +18,15 @@ pub struct DiagnosticsConfig {\n \n #[derive(Debug, Default, Clone)]\n pub(crate) struct DiagnosticCollection {\n-    pub(crate) native: HashMap<FileId, Vec<Diagnostic>>,\n-    pub(crate) check: HashMap<FileId, Vec<Diagnostic>>,\n+    pub(crate) native: HashMap<FileId, Vec<lsp_types::Diagnostic>>,\n+    pub(crate) check: HashMap<FileId, Vec<lsp_types::Diagnostic>>,\n     pub(crate) check_fixes: CheckFixes,\n     changes: FxHashSet<FileId>,\n }\n \n #[derive(Debug, Clone)]\n pub(crate) struct Fix {\n-    pub(crate) range: Range,\n+    pub(crate) range: lsp_types::Range,\n     pub(crate) action: lsp_ext::CodeAction,\n }\n \n@@ -40,7 +39,7 @@ impl DiagnosticCollection {\n     pub(crate) fn add_check_diagnostic(\n         &mut self,\n         file_id: FileId,\n-        diagnostic: Diagnostic,\n+        diagnostic: lsp_types::Diagnostic,\n         fixes: Vec<lsp_ext::CodeAction>,\n     ) {\n         let diagnostics = self.check.entry(file_id).or_default();\n@@ -59,12 +58,19 @@ impl DiagnosticCollection {\n         self.changes.insert(file_id);\n     }\n \n-    pub(crate) fn set_native_diagnostics(&mut self, file_id: FileId, diagnostics: Vec<Diagnostic>) {\n+    pub(crate) fn set_native_diagnostics(\n+        &mut self,\n+        file_id: FileId,\n+        diagnostics: Vec<lsp_types::Diagnostic>,\n+    ) {\n         self.native.insert(file_id, diagnostics);\n         self.changes.insert(file_id);\n     }\n \n-    pub(crate) fn diagnostics_for(&self, file_id: FileId) -> impl Iterator<Item = &Diagnostic> {\n+    pub(crate) fn diagnostics_for(\n+        &self,\n+        file_id: FileId,\n+    ) -> impl Iterator<Item = &lsp_types::Diagnostic> {\n         let native = self.native.get(&file_id).into_iter().flatten();\n         let check = self.check.get(&file_id).into_iter().flatten();\n         native.chain(check)\n@@ -78,7 +84,7 @@ impl DiagnosticCollection {\n     }\n }\n \n-fn are_diagnostics_equal(left: &Diagnostic, right: &Diagnostic) -> bool {\n+fn are_diagnostics_equal(left: &lsp_types::Diagnostic, right: &lsp_types::Diagnostic) -> bool {\n     left.source == right.source\n         && left.severity == right.severity\n         && left.range == right.range"}, {"sha": "3eed118a9bbb759be5025b023b5ba31333905004", "filename": "crates/rust-analyzer/src/diagnostics/to_proto.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/ce06f8d0416d5851264769eb9583ce43d66f0474/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Fto_proto.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ce06f8d0416d5851264769eb9583ce43d66f0474/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Fto_proto.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Fto_proto.rs?ref=ce06f8d0416d5851264769eb9583ce43d66f0474", "patch": "@@ -167,9 +167,9 @@ fn map_rust_child_diagnostic(\n \n #[derive(Debug)]\n pub(crate) struct MappedRustDiagnostic {\n-    pub location: Location,\n-    pub diagnostic: Diagnostic,\n-    pub fixes: Vec<lsp_ext::CodeAction>,\n+    pub(crate) location: Location,\n+    pub(crate) diagnostic: Diagnostic,\n+    pub(crate) fixes: Vec<lsp_ext::CodeAction>,\n }\n \n /// Converts a Rust root diagnostic to LSP form"}, {"sha": "4da09408317cb920cc885bc45da8a6bf513697d2", "filename": "crates/rust-analyzer/src/global_state.rs", "status": "modified", "additions": 7, "deletions": 5, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/ce06f8d0416d5851264769eb9583ce43d66f0474/crates%2Frust-analyzer%2Fsrc%2Fglobal_state.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ce06f8d0416d5851264769eb9583ce43d66f0474/crates%2Frust-analyzer%2Fsrc%2Fglobal_state.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fglobal_state.rs?ref=ce06f8d0416d5851264769eb9583ce43d66f0474", "patch": "@@ -195,11 +195,7 @@ impl Drop for GlobalState {\n \n impl GlobalStateSnapshot {\n     pub(crate) fn url_to_file_id(&self, url: &Url) -> Result<FileId> {\n-        let path = from_proto::abs_path(url)?;\n-        let path = path.into();\n-        let res =\n-            self.vfs.read().0.file_id(&path).ok_or_else(|| format!(\"file not found: {}\", path))?;\n-        Ok(res)\n+        url_to_file_id(&self.vfs.read().0, url)\n     }\n \n     pub(crate) fn file_id_to_url(&self, id: FileId) -> Url {\n@@ -239,3 +235,9 @@ pub(crate) fn file_id_to_url(vfs: &vfs::Vfs, id: FileId) -> Url {\n     let path = path.as_path().unwrap();\n     url_from_abs_path(&path)\n }\n+\n+pub(crate) fn url_to_file_id(vfs: &vfs::Vfs, url: &Url) -> Result<FileId> {\n+    let path = from_proto::vfs_path(url)?;\n+    let res = vfs.file_id(&path).ok_or_else(|| format!(\"file not found: {}\", path))?;\n+    Ok(res)\n+}"}, {"sha": "8fc816cbd57bcc86052b0ccf8364bbd6c848554e", "filename": "crates/rust-analyzer/src/main_loop.rs", "status": "modified", "additions": 9, "deletions": 11, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/ce06f8d0416d5851264769eb9583ce43d66f0474/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ce06f8d0416d5851264769eb9583ce43d66f0474/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs?ref=ce06f8d0416d5851264769eb9583ce43d66f0474", "patch": "@@ -16,7 +16,7 @@ use crate::{\n     config::Config,\n     dispatch::{NotificationDispatcher, RequestDispatcher},\n     from_proto,\n-    global_state::{file_id_to_url, GlobalState, Status},\n+    global_state::{file_id_to_url, url_to_file_id, GlobalState, Status},\n     handlers, lsp_ext,\n     lsp_utils::{apply_document_changes, is_canceled, notification_is, notification_new},\n     Result,\n@@ -200,18 +200,16 @@ impl GlobalState {\n                         &workspace_root,\n                     );\n                     for diag in diagnostics {\n-                        let path = from_proto::vfs_path(&diag.location.uri)?;\n-                        let file_id = match self.vfs.read().0.file_id(&path) {\n-                            Some(file) => FileId(file.0),\n-                            None => {\n-                                log::error!(\n-                                    \"File with cargo diagnostic not found in VFS: {}\",\n-                                    path\n-                                );\n-                                return Ok(());\n+                        match url_to_file_id(&self.vfs.read().0, &diag.location.uri) {\n+                            Ok(file_id) => self.diagnostics.add_check_diagnostic(\n+                                file_id,\n+                                diag.diagnostic,\n+                                diag.fixes,\n+                            ),\n+                            Err(err) => {\n+                                log::error!(\"File with cargo diagnostic not found in VFS: {}\", err);\n                             }\n                         };\n-                        self.diagnostics.add_check_diagnostic(file_id, diag.diagnostic, diag.fixes)\n                     }\n                 }\n "}]}