{"sha": "74dfc1ddd9d6a9f541bc526c3401b92bcd16bd2b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjc0ZGZjMWRkZDlkNmE5ZjU0MWJjNTI2YzM0MDFiOTJiY2QxNmJkMmI=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-03-15T19:58:49Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-03-15T19:58:49Z"}, "message": "Auto merge of #31887 - SimonSapin:quiet-test, r=alexcrichton\n\nShorter output for `rustc --test` binaries.\n\nUntil now, a program created with `rustc --test` prints at least one line per test. This can be very verbose, especially with [data-driven tests](https://internals.rust-lang.org/t/test-and-external-test-harnesses/3145) when hundreds or thousands of tests is not rare.\n\nThis changes the default output to one character per test (except metrics and benchmarks results which have additional data to show):\n\n```\n     Running target/debug/wpt-75c594dc1e6e6187\n\nrunning 314 tests\n..............................................................................\n..............................................................................\n..............................................................................\n..............................................................................\n..\ntest result: ok. 314 passed; 0 failed; 0 ignored; 0 measured\n```\n\n<s>The previous behavior is available by passing `--verbose` to the test program. Maybe `cargo test --verbose` could be changed to do that?</s> **Edit:** the default is now unchanged, `-q` or `--quiet` enables the new output.", "tree": {"sha": "d950290c3d93779e86005b4dcafa2194912a5aad", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d950290c3d93779e86005b4dcafa2194912a5aad"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/74dfc1ddd9d6a9f541bc526c3401b92bcd16bd2b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/74dfc1ddd9d6a9f541bc526c3401b92bcd16bd2b", "html_url": "https://github.com/rust-lang/rust/commit/74dfc1ddd9d6a9f541bc526c3401b92bcd16bd2b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/74dfc1ddd9d6a9f541bc526c3401b92bcd16bd2b/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1efa752ea694f7ae125cdaf7911ad44b8e6b0e33", "url": "https://api.github.com/repos/rust-lang/rust/commits/1efa752ea694f7ae125cdaf7911ad44b8e6b0e33", "html_url": "https://github.com/rust-lang/rust/commit/1efa752ea694f7ae125cdaf7911ad44b8e6b0e33"}, {"sha": "d23fd711eb1af9ba505e239552fd691c32807a31", "url": "https://api.github.com/repos/rust-lang/rust/commits/d23fd711eb1af9ba505e239552fd691c32807a31", "html_url": "https://github.com/rust-lang/rust/commit/d23fd711eb1af9ba505e239552fd691c32807a31"}], "stats": {"total": 61, "additions": 44, "deletions": 17}, "files": [{"sha": "33ec974c52739358b33a2e462969a6f5c0f735b0", "filename": "src/compiletest/common.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/74dfc1ddd9d6a9f541bc526c3401b92bcd16bd2b/src%2Fcompiletest%2Fcommon.rs", "raw_url": "https://github.com/rust-lang/rust/raw/74dfc1ddd9d6a9f541bc526c3401b92bcd16bd2b/src%2Fcompiletest%2Fcommon.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcompiletest%2Fcommon.rs?ref=74dfc1ddd9d6a9f541bc526c3401b92bcd16bd2b", "patch": "@@ -155,5 +155,8 @@ pub struct Config {\n     pub lldb_python_dir: Option<String>,\n \n     // Explain what's going on\n-    pub verbose: bool\n+    pub verbose: bool,\n+\n+    // Print one character per test instead of one line\n+    pub quiet: bool,\n }"}, {"sha": "cf467e60fe38ae8c8e42c497cf20cc9b5e08ff10", "filename": "src/compiletest/compiletest.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/74dfc1ddd9d6a9f541bc526c3401b92bcd16bd2b/src%2Fcompiletest%2Fcompiletest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/74dfc1ddd9d6a9f541bc526c3401b92bcd16bd2b/src%2Fcompiletest%2Fcompiletest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcompiletest%2Fcompiletest.rs?ref=74dfc1ddd9d6a9f541bc526c3401b92bcd16bd2b", "patch": "@@ -77,6 +77,7 @@ pub fn parse_config(args: Vec<String> ) -> Config {\n           optopt(\"\", \"host-rustcflags\", \"flags to pass to rustc for host\", \"FLAGS\"),\n           optopt(\"\", \"target-rustcflags\", \"flags to pass to rustc for target\", \"FLAGS\"),\n           optflag(\"\", \"verbose\", \"run tests verbosely, showing all output\"),\n+          optflag(\"\", \"quiet\", \"print one character per test instead of one line\"),\n           optopt(\"\", \"logfile\", \"file to log test execution to\", \"FILE\"),\n           optopt(\"\", \"target\", \"the target to build for\", \"TARGET\"),\n           optopt(\"\", \"host\", \"the host to build for\", \"HOST\"),\n@@ -151,6 +152,7 @@ pub fn parse_config(args: Vec<String> ) -> Config {\n             !opt_str2(matches.opt_str(\"adb-test-dir\")).is_empty(),\n         lldb_python_dir: matches.opt_str(\"lldb-python-dir\"),\n         verbose: matches.opt_present(\"verbose\"),\n+        quiet: matches.opt_present(\"quiet\"),\n     }\n }\n \n@@ -184,6 +186,7 @@ pub fn log_config(config: &Config) {\n     logv(c, format!(\"adb_device_status: {}\",\n                     config.adb_device_status));\n     logv(c, format!(\"verbose: {}\", config.verbose));\n+    logv(c, format!(\"quiet: {}\", config.quiet));\n     logv(c, format!(\"\\n\"));\n }\n \n@@ -247,6 +250,7 @@ pub fn test_opts(config: &Config) -> test::TestOpts {\n     test::TestOpts {\n         filter: config.filter.clone(),\n         run_ignored: config.run_ignored,\n+        quiet: config.quiet,\n         logfile: config.logfile.clone(),\n         run_tests: true,\n         bench_benchmarks: true,"}, {"sha": "d076aa2b0088c61c052752f94002bf3f76a32f6a", "filename": "src/libtest/lib.rs", "status": "modified", "additions": 34, "deletions": 16, "changes": 50, "blob_url": "https://github.com/rust-lang/rust/blob/74dfc1ddd9d6a9f541bc526c3401b92bcd16bd2b/src%2Flibtest%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/74dfc1ddd9d6a9f541bc526c3401b92bcd16bd2b/src%2Flibtest%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibtest%2Flib.rs?ref=74dfc1ddd9d6a9f541bc526c3401b92bcd16bd2b", "patch": "@@ -106,7 +106,7 @@ impl fmt::Display for TestName {\n     }\n }\n \n-#[derive(Clone, Copy)]\n+#[derive(Clone, Copy, PartialEq, Eq)]\n enum NamePadding {\n     PadNone,\n     PadOnRight,\n@@ -298,6 +298,7 @@ pub struct TestOpts {\n     pub logfile: Option<PathBuf>,\n     pub nocapture: bool,\n     pub color: ColorConfig,\n+    pub quiet: bool,\n }\n \n impl TestOpts {\n@@ -311,6 +312,7 @@ impl TestOpts {\n             logfile: None,\n             nocapture: false,\n             color: AutoColor,\n+            quiet: false,\n         }\n     }\n }\n@@ -328,6 +330,7 @@ fn optgroups() -> Vec<getopts::OptGroup> {\n                           of stdout\", \"PATH\"),\n       getopts::optflag(\"\", \"nocapture\", \"don't capture stdout/stderr of each \\\n                                          task, allow printing directly\"),\n+      getopts::optflag(\"q\", \"quiet\", \"Display one character per test instead of one line\"),\n       getopts::optopt(\"\", \"color\", \"Configure coloring of output:\n             auto   = colorize if stdout is a tty and tests are run on serially (default);\n             always = always colorize output;\n@@ -385,6 +388,7 @@ pub fn parse_opts(args: &[String]) -> Option<OptRes> {\n     };\n \n     let run_ignored = matches.opt_present(\"ignored\");\n+    let quiet = matches.opt_present(\"quiet\");\n \n     let logfile = matches.opt_str(\"logfile\");\n     let logfile = logfile.map(|s| PathBuf::from(&s));\n@@ -417,6 +421,7 @@ pub fn parse_opts(args: &[String]) -> Option<OptRes> {\n         logfile: logfile,\n         nocapture: nocapture,\n         color: color,\n+        quiet: quiet,\n     };\n \n     Some(Ok(test_opts))\n@@ -448,6 +453,7 @@ struct ConsoleTestState<T> {\n     log_out: Option<File>,\n     out: OutputLocation<T>,\n     use_color: bool,\n+    quiet: bool,\n     total: usize,\n     passed: usize,\n     failed: usize,\n@@ -473,6 +479,7 @@ impl<T: Write> ConsoleTestState<T> {\n             out: out,\n             log_out: log_out,\n             use_color: use_color(opts),\n+            quiet: opts.quiet,\n             total: 0,\n             passed: 0,\n             failed: 0,\n@@ -485,15 +492,15 @@ impl<T: Write> ConsoleTestState<T> {\n     }\n \n     pub fn write_ok(&mut self) -> io::Result<()> {\n-        self.write_pretty(\"ok\", term::color::GREEN)\n+        self.write_short_result(\"ok\", \".\", term::color::GREEN)\n     }\n \n     pub fn write_failed(&mut self) -> io::Result<()> {\n-        self.write_pretty(\"FAILED\", term::color::RED)\n+        self.write_short_result(\"FAILED\", \"F\", term::color::RED)\n     }\n \n     pub fn write_ignored(&mut self) -> io::Result<()> {\n-        self.write_pretty(\"ignored\", term::color::YELLOW)\n+        self.write_short_result(\"ignored\", \"i\", term::color::YELLOW)\n     }\n \n     pub fn write_metric(&mut self) -> io::Result<()> {\n@@ -504,6 +511,16 @@ impl<T: Write> ConsoleTestState<T> {\n         self.write_pretty(\"bench\", term::color::CYAN)\n     }\n \n+    pub fn write_short_result(&mut self, verbose: &str, quiet: &str, color: term::color::Color)\n+                              -> io::Result<()> {\n+        if self.quiet {\n+            self.write_pretty(quiet, color)\n+        } else {\n+            try!(self.write_pretty(verbose, color));\n+            self.write_plain(\"\\n\")\n+        }\n+    }\n+\n     pub fn write_pretty(&mut self, word: &str, color: term::color::Color) -> io::Result<()> {\n         match self.out {\n             Pretty(ref mut term) => {\n@@ -547,28 +564,28 @@ impl<T: Write> ConsoleTestState<T> {\n     }\n \n     pub fn write_test_start(&mut self, test: &TestDesc, align: NamePadding) -> io::Result<()> {\n-        let name = test.padded_name(self.max_name_len, align);\n-        self.write_plain(&format!(\"test {} ... \", name))\n+        if self.quiet && align != PadOnRight {\n+            Ok(())\n+        } else {\n+            let name = test.padded_name(self.max_name_len, align);\n+            self.write_plain(&format!(\"test {} ... \", name))\n+        }\n     }\n \n     pub fn write_result(&mut self, result: &TestResult) -> io::Result<()> {\n-        try!(match *result {\n+        match *result {\n             TrOk => self.write_ok(),\n             TrFailed => self.write_failed(),\n             TrIgnored => self.write_ignored(),\n             TrMetrics(ref mm) => {\n                 try!(self.write_metric());\n-                self.write_plain(&format!(\": {}\", mm.fmt_metrics()))\n+                self.write_plain(&format!(\": {}\\n\", mm.fmt_metrics()))\n             }\n             TrBench(ref bs) => {\n                 try!(self.write_bench());\n-\n-                try!(self.write_plain(&format!(\": {}\", fmt_bench_samples(bs))));\n-\n-                Ok(())\n+                self.write_plain(&format!(\": {}\\n\", fmt_bench_samples(bs)))\n             }\n-        });\n-        self.write_plain(\"\\n\")\n+        }\n     }\n \n     pub fn write_log(&mut self, test: &TestDesc, result: &TestResult) -> io::Result<()> {\n@@ -626,9 +643,9 @@ impl<T: Write> ConsoleTestState<T> {\n         try!(self.write_plain(\"\\ntest result: \"));\n         if success {\n             // There's no parallelism at this point so it's safe to use color\n-            try!(self.write_ok());\n+            try!(self.write_pretty(\"ok\", term::color::GREEN));\n         } else {\n-            try!(self.write_failed());\n+            try!(self.write_pretty(\"FAILED\", term::color::RED));\n         }\n         let s = format!(\". {} passed; {} failed; {} ignored; {} measured\\n\\n\",\n                         self.passed,\n@@ -755,6 +772,7 @@ fn should_sort_failures_before_printing_them() {\n         log_out: None,\n         out: Raw(Vec::new()),\n         use_color: false,\n+        quiet: false,\n         total: 0,\n         passed: 0,\n         failed: 0,"}, {"sha": "fc9b65c47a9fe56e6fab734bad209228136d5a19", "filename": "src/test/run-make/test-harness/Makefile", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/74dfc1ddd9d6a9f541bc526c3401b92bcd16bd2b/src%2Ftest%2Frun-make%2Ftest-harness%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/74dfc1ddd9d6a9f541bc526c3401b92bcd16bd2b/src%2Ftest%2Frun-make%2Ftest-harness%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Ftest-harness%2FMakefile?ref=74dfc1ddd9d6a9f541bc526c3401b92bcd16bd2b", "patch": "@@ -5,3 +5,5 @@ all:\n \t$(RUSTC) --test test-ignore-cfg.rs --cfg ignorecfg\n \t$(call RUN,test-ignore-cfg) | grep 'shouldnotignore ... ok'\n \t$(call RUN,test-ignore-cfg) | grep 'shouldignore ... ignored'\n+\t$(call RUN,test-ignore-cfg --quiet) | grep \"^i\\.$$\"\n+\t$(call RUN,test-ignore-cfg --quiet) | grep -v 'should'"}]}