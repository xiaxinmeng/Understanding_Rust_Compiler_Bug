{"sha": "6d062809cb2cb19df1b2cf84ec0c73c1cd8f3c71", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZkMDYyODA5Y2IyY2IxOWRmMWIyY2Y4NGVjMGM3M2MxY2Q4ZjNjNzE=", "commit": {"author": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2016-10-12T17:54:41Z"}, "committer": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2016-10-12T22:15:33Z"}, "message": "Get rid of double indirection in string interner by using `Rc<str>`", "tree": {"sha": "e6dcf254a86e965448c9f532a80c03a4346234f2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e6dcf254a86e965448c9f532a80c03a4346234f2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6d062809cb2cb19df1b2cf84ec0c73c1cd8f3c71", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6d062809cb2cb19df1b2cf84ec0c73c1cd8f3c71", "html_url": "https://github.com/rust-lang/rust/commit/6d062809cb2cb19df1b2cf84ec0c73c1cd8f3c71", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6d062809cb2cb19df1b2cf84ec0c73c1cd8f3c71/comments", "author": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "committer": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ef3a6a8ee6e0c38def279df77885fc8b995d9635", "url": "https://api.github.com/repos/rust-lang/rust/commits/ef3a6a8ee6e0c38def279df77885fc8b995d9635", "html_url": "https://github.com/rust-lang/rust/commit/ef3a6a8ee6e0c38def279df77885fc8b995d9635"}], "stats": {"total": 59, "additions": 21, "deletions": 38}, "files": [{"sha": "89da45e549fb791a7779ebfa959cb770f1d1b9d3", "filename": "src/librustc_trans/debuginfo/metadata.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/6d062809cb2cb19df1b2cf84ec0c73c1cd8f3c71/src%2Flibrustc_trans%2Fdebuginfo%2Fmetadata.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6d062809cb2cb19df1b2cf84ec0c73c1cd8f3c71/src%2Flibrustc_trans%2Fdebuginfo%2Fmetadata.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Fdebuginfo%2Fmetadata.rs?ref=6d062809cb2cb19df1b2cf84ec0c73c1cd8f3c71", "patch": "@@ -128,7 +128,7 @@ impl<'tcx> TypeMap<'tcx> {\n \n     // Get the string representation of a UniqueTypeId. This method will fail if\n     // the id is unknown.\n-    fn get_unique_type_id_as_string(&self, unique_type_id: UniqueTypeId) -> Rc<String> {\n+    fn get_unique_type_id_as_string(&self, unique_type_id: UniqueTypeId) -> Rc<str> {\n         let UniqueTypeId(interner_key) = unique_type_id;\n         self.unique_id_interner.get(interner_key)\n     }\n@@ -299,7 +299,7 @@ impl<'tcx> TypeMap<'tcx> {\n         // Trim to size before storing permanently\n         unique_type_id.shrink_to_fit();\n \n-        let key = self.unique_id_interner.intern(unique_type_id);\n+        let key = self.unique_id_interner.intern(&unique_type_id);\n         self.type_to_unique_id.insert(type_, UniqueTypeId(key));\n \n         return UniqueTypeId(key);\n@@ -367,7 +367,7 @@ impl<'tcx> TypeMap<'tcx> {\n         let enum_variant_type_id = format!(\"{}::{}\",\n                                            &self.get_unique_type_id_as_string(enum_type_id),\n                                            variant_name);\n-        let interner_key = self.unique_id_interner.intern(enum_variant_type_id);\n+        let interner_key = self.unique_id_interner.intern(&enum_variant_type_id);\n         UniqueTypeId(interner_key)\n     }\n }"}, {"sha": "9adcef5ee7d69365478048942d22b8374d50f94f", "filename": "src/libsyntax/parse/token.rs", "status": "modified", "additions": 3, "deletions": 10, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/6d062809cb2cb19df1b2cf84ec0c73c1cd8f3c71/src%2Flibsyntax%2Fparse%2Ftoken.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6d062809cb2cb19df1b2cf84ec0c73c1cd8f3c71/src%2Flibsyntax%2Fparse%2Ftoken.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fparse%2Ftoken.rs?ref=6d062809cb2cb19df1b2cf84ec0c73c1cd8f3c71", "patch": "@@ -478,27 +478,20 @@ pub fn clear_ident_interner() {\n /// somehow.\n #[derive(Clone, PartialEq, Hash, PartialOrd, Eq, Ord)]\n pub struct InternedString {\n-    string: Rc<String>,\n+    string: Rc<str>,\n }\n \n impl InternedString {\n     #[inline]\n     pub fn new(string: &'static str) -> InternedString {\n         InternedString {\n-            string: Rc::new(string.to_owned()),\n-        }\n-    }\n-\n-    #[inline]\n-    fn new_from_rc_str(string: Rc<String>) -> InternedString {\n-        InternedString {\n-            string: string,\n+            string: Rc::__from_str(string),\n         }\n     }\n \n     #[inline]\n     pub fn new_from_name(name: ast::Name) -> InternedString {\n-        with_ident_interner(|interner| InternedString::new_from_rc_str(interner.get(name)))\n+        with_ident_interner(|interner| InternedString { string: interner.get(name) })\n     }\n }\n "}, {"sha": "f56c6cedcd18678e4971d48d96b8392a0c6280a0", "filename": "src/libsyntax/util/interner.rs", "status": "modified", "additions": 15, "deletions": 25, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/6d062809cb2cb19df1b2cf84ec0c73c1cd8f3c71/src%2Flibsyntax%2Futil%2Finterner.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6d062809cb2cb19df1b2cf84ec0c73c1cd8f3c71/src%2Flibsyntax%2Futil%2Finterner.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Futil%2Finterner.rs?ref=6d062809cb2cb19df1b2cf84ec0c73c1cd8f3c71", "patch": "@@ -14,23 +14,13 @@\n \n use ast::Name;\n \n-use std::borrow::Borrow;\n use std::collections::HashMap;\n use std::rc::Rc;\n \n-#[derive(PartialEq, Eq, Hash)]\n-struct RcStr(Rc<String>);\n-\n-impl Borrow<str> for RcStr {\n-    fn borrow(&self) -> &str {\n-        &self.0\n-    }\n-}\n-\n #[derive(Default)]\n pub struct Interner {\n-    names: HashMap<RcStr, Name>,\n-    strings: Vec<Rc<String>>,\n+    names: HashMap<Rc<str>, Name>,\n+    strings: Vec<Rc<str>>,\n }\n \n /// When traits can extend traits, we should extend index<Name,T> to get []\n@@ -47,22 +37,22 @@ impl Interner {\n         this\n     }\n \n-    pub fn intern<T: Borrow<str> + Into<String>>(&mut self, string: T) -> Name {\n-        if let Some(&name) = self.names.get(string.borrow()) {\n+    pub fn intern(&mut self, string: &str) -> Name {\n+        if let Some(&name) = self.names.get(string) {\n             return name;\n         }\n \n         let name = Name(self.strings.len() as u32);\n-        let string = Rc::new(string.into());\n+        let string = Rc::__from_str(string);\n         self.strings.push(string.clone());\n-        self.names.insert(RcStr(string), name);\n+        self.names.insert(string, name);\n         name\n     }\n \n     pub fn gensym(&mut self, string: &str) -> Name {\n         let gensym = Name(self.strings.len() as u32);\n         // leave out of `names` to avoid colliding\n-        self.strings.push(Rc::new(string.to_owned()));\n+        self.strings.push(Rc::__from_str(string));\n         gensym\n     }\n \n@@ -75,7 +65,7 @@ impl Interner {\n         gensym\n     }\n \n-    pub fn get(&self, name: Name) -> Rc<String> {\n+    pub fn get(&self, name: Name) -> Rc<str> {\n         self.strings[name.0 as usize].clone()\n     }\n \n@@ -109,13 +99,13 @@ mod tests {\n         assert_eq!(i.gensym(\"dog\"), Name(4));\n         // gensym tests again with gensym_copy:\n         assert_eq!(i.gensym_copy(Name(2)), Name(5));\n-        assert_eq!(*i.get(Name(5)), \"zebra\");\n+        assert_eq!(&*i.get(Name(5)), \"zebra\");\n         assert_eq!(i.gensym_copy(Name(2)), Name(6));\n-        assert_eq!(*i.get(Name(6)), \"zebra\");\n-        assert_eq!(*i.get(Name(0)), \"dog\");\n-        assert_eq!(*i.get(Name(1)), \"cat\");\n-        assert_eq!(*i.get(Name(2)), \"zebra\");\n-        assert_eq!(*i.get(Name(3)), \"zebra\");\n-        assert_eq!(*i.get(Name(4)), \"dog\");\n+        assert_eq!(&*i.get(Name(6)), \"zebra\");\n+        assert_eq!(&*i.get(Name(0)), \"dog\");\n+        assert_eq!(&*i.get(Name(1)), \"cat\");\n+        assert_eq!(&*i.get(Name(2)), \"zebra\");\n+        assert_eq!(&*i.get(Name(3)), \"zebra\");\n+        assert_eq!(&*i.get(Name(4)), \"dog\");\n     }\n }"}]}