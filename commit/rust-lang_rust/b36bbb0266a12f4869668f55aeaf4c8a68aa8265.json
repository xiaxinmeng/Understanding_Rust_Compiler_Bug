{"sha": "b36bbb0266a12f4869668f55aeaf4c8a68aa8265", "node_id": "C_kwDOAAsO6NoAKGIzNmJiYjAyNjZhMTJmNDg2OTY2OGY1NWFlYWY0YzhhNjhhYTgyNjU", "commit": {"author": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2023-03-14T01:08:48Z"}, "committer": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2023-03-14T16:19:57Z"}, "message": "Don't codegen impossible to satisfy impls", "tree": {"sha": "ecef360f7954bd864db93c863259c1ed47011110", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ecef360f7954bd864db93c863259c1ed47011110"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b36bbb0266a12f4869668f55aeaf4c8a68aa8265", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b36bbb0266a12f4869668f55aeaf4c8a68aa8265", "html_url": "https://github.com/rust-lang/rust/commit/b36bbb0266a12f4869668f55aeaf4c8a68aa8265", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b36bbb0266a12f4869668f55aeaf4c8a68aa8265/comments", "author": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f1b1ed7e18f1fbe5226a96626827c625985f8285", "url": "https://api.github.com/repos/rust-lang/rust/commits/f1b1ed7e18f1fbe5226a96626827c625985f8285", "html_url": "https://github.com/rust-lang/rust/commit/f1b1ed7e18f1fbe5226a96626827c625985f8285"}], "stats": {"total": 28, "additions": 28, "deletions": 0}, "files": [{"sha": "aff27e5664b75127fe1542d8b662d7ef45dfadb9", "filename": "compiler/rustc_monomorphize/src/collector.rs", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/b36bbb0266a12f4869668f55aeaf4c8a68aa8265/compiler%2Frustc_monomorphize%2Fsrc%2Fcollector.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b36bbb0266a12f4869668f55aeaf4c8a68aa8265/compiler%2Frustc_monomorphize%2Fsrc%2Fcollector.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_monomorphize%2Fsrc%2Fcollector.rs?ref=b36bbb0266a12f4869668f55aeaf4c8a68aa8265", "patch": "@@ -1326,6 +1326,21 @@ fn create_mono_items_for_default_impls<'tcx>(\n         return;\n     }\n \n+    // Unlike 'lazy' monomorphization that begins by collecting items transitively\n+    // called by `main` or other global items, when eagerly monomorphizing impl\n+    // items, we never actually check that the predicates of this impl are satisfied\n+    // in a empty reveal-all param env (i.e. with no assumptions).\n+    //\n+    // Even though this impl has no substitutions, because we don't consider higher-\n+    // ranked predicates such as `for<'a> &'a mut [u8]: Copy` to be trivially false,\n+    // we must now check that the impl has no impossible-to-satisfy predicates.\n+    if tcx.subst_and_check_impossible_predicates((\n+        item.owner_id.to_def_id(),\n+        &InternalSubsts::identity_for_item(tcx, item.owner_id.to_def_id()),\n+    )) {\n+        return;\n+    }\n+\n     let Some(trait_ref) = tcx.impl_trait_ref(item.owner_id) else {\n         return;\n     };"}, {"sha": "1ea32ed2c4fac33d8ba2ce6d3809953f473c49c8", "filename": "tests/ui/codegen/mono-impossible.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/b36bbb0266a12f4869668f55aeaf4c8a68aa8265/tests%2Fui%2Fcodegen%2Fmono-impossible.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b36bbb0266a12f4869668f55aeaf4c8a68aa8265/tests%2Fui%2Fcodegen%2Fmono-impossible.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcodegen%2Fmono-impossible.rs?ref=b36bbb0266a12f4869668f55aeaf4c8a68aa8265", "patch": "@@ -0,0 +1,13 @@\n+// compile-flags: -Clink-dead-code=on --crate-type=lib\n+// build-pass\n+\n+// Make sure that we don't monomorphize the impossible method `<() as Visit>::visit`,\n+// which does not hold under a reveal-all param env.\n+\n+pub trait Visit {\n+    fn visit() {}\n+}\n+\n+pub trait Array<'a> {}\n+\n+impl Visit for () where (): for<'a> Array<'a> {}"}]}