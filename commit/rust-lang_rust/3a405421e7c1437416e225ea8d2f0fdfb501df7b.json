{"sha": "3a405421e7c1437416e225ea8d2f0fdfb501df7b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjNhNDA1NDIxZTdjMTQzNzQxNmUyMjVlYThkMmYwZmRmYjUwMWRmN2I=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2019-08-24T20:46:17Z"}, "committer": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2019-08-24T21:05:04Z"}, "message": "parse_top_pat: silence leading vert gating sometimes.", "tree": {"sha": "807ad098380196eaf00764e90854aaa7486277ff", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/807ad098380196eaf00764e90854aaa7486277ff"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3a405421e7c1437416e225ea8d2f0fdfb501df7b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3a405421e7c1437416e225ea8d2f0fdfb501df7b", "html_url": "https://github.com/rust-lang/rust/commit/3a405421e7c1437416e225ea8d2f0fdfb501df7b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3a405421e7c1437416e225ea8d2f0fdfb501df7b/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a9ef8592e47808539ffd9237c22ce5518aa7b188", "url": "https://api.github.com/repos/rust-lang/rust/commits/a9ef8592e47808539ffd9237c22ce5518aa7b188", "html_url": "https://github.com/rust-lang/rust/commit/a9ef8592e47808539ffd9237c22ce5518aa7b188"}], "stats": {"total": 116, "additions": 80, "deletions": 36}, "files": [{"sha": "724edbcfaed7964f6fcac360245911f632683b62", "filename": "src/libsyntax/parse/parser/pat.rs", "status": "modified", "additions": 15, "deletions": 3, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/3a405421e7c1437416e225ea8d2f0fdfb501df7b/src%2Flibsyntax%2Fparse%2Fparser%2Fpat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3a405421e7c1437416e225ea8d2f0fdfb501df7b/src%2Flibsyntax%2Fparse%2Fparser%2Fpat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fparse%2Fparser%2Fpat.rs?ref=3a405421e7c1437416e225ea8d2f0fdfb501df7b", "patch": "@@ -46,11 +46,23 @@ impl<'a> Parser<'a> {\n     /// Corresponds to `top_pat` in RFC 2535 and allows or-pattern at the top level.\n     pub(super) fn parse_top_pat(&mut self, gate_or: GateOr) -> PResult<'a, P<Pat>> {\n         // Allow a '|' before the pats (RFCs 1925, 2530, and 2535).\n-        if self.eat_or_separator() && gate_or == GateOr::Yes {\n-            self.sess.gated_spans.or_patterns.borrow_mut().push(self.prev_span);\n+        let gated_leading_vert = self.eat_or_separator() && gate_or == GateOr::Yes;\n+\n+        // Parse the possibly-or-pattern.\n+        let pat = self.parse_pat_with_or(None, gate_or, TopLevel::Yes)?;\n+\n+        // If we parsed a leading `|` which should be gated,\n+        // and no other gated or-pattern has been parsed thus far,\n+        // then we should really gate the leading `|`.\n+        // This complicated procedure is done purely for diagnostics UX.\n+        if gated_leading_vert {\n+            let mut or_pattern_spans = self.sess.gated_spans.or_patterns.borrow_mut();\n+            if or_pattern_spans.is_empty() {\n+                or_pattern_spans.push(self.prev_span);\n+            }\n         }\n \n-        self.parse_pat_with_or(None, gate_or, TopLevel::Yes)\n+        Ok(pat)\n     }\n \n     /// Parses a pattern, that may be a or-pattern (e.g. `Foo | Bar` in `Some(Foo | Bar)`)."}, {"sha": "de8e1bba5576cbbf14fbcd1fe2ff4d810513ea6b", "filename": "src/test/ui/or-patterns/feature-gate-or_patterns-leading-for.rs", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/3a405421e7c1437416e225ea8d2f0fdfb501df7b/src%2Ftest%2Fui%2For-patterns%2Ffeature-gate-or_patterns-leading-for.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3a405421e7c1437416e225ea8d2f0fdfb501df7b/src%2Ftest%2Fui%2For-patterns%2Ffeature-gate-or_patterns-leading-for.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2For-patterns%2Ffeature-gate-or_patterns-leading-for.rs?ref=3a405421e7c1437416e225ea8d2f0fdfb501df7b", "patch": "@@ -0,0 +1,8 @@\n+// Test feature gating for a sole leading `|` in `let`.\n+\n+fn main() {}\n+\n+#[cfg(FALSE)]\n+fn gated_leading_vert_in_let() {\n+    for | A in 0 {} //~ ERROR or-patterns syntax is experimental\n+}"}, {"sha": "83804d564f3e4a71f1b20b4cc252a477983e5fba", "filename": "src/test/ui/or-patterns/feature-gate-or_patterns-leading-for.stderr", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/3a405421e7c1437416e225ea8d2f0fdfb501df7b/src%2Ftest%2Fui%2For-patterns%2Ffeature-gate-or_patterns-leading-for.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/3a405421e7c1437416e225ea8d2f0fdfb501df7b/src%2Ftest%2Fui%2For-patterns%2Ffeature-gate-or_patterns-leading-for.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2For-patterns%2Ffeature-gate-or_patterns-leading-for.stderr?ref=3a405421e7c1437416e225ea8d2f0fdfb501df7b", "patch": "@@ -0,0 +1,12 @@\n+error[E0658]: or-patterns syntax is experimental\n+  --> $DIR/feature-gate-or_patterns-leading-for.rs:7:11\n+   |\n+LL |     for | A in 0 {}\n+   |           ^\n+   |\n+   = note: for more information, see https://github.com/rust-lang/rust/issues/54883\n+   = help: add `#![feature(or_patterns)]` to the crate attributes to enable\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0658`."}, {"sha": "a4ea4e25d861e56fe7bdd68a458284e9375089a9", "filename": "src/test/ui/or-patterns/feature-gate-or_patterns-leading-let.rs", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/3a405421e7c1437416e225ea8d2f0fdfb501df7b/src%2Ftest%2Fui%2For-patterns%2Ffeature-gate-or_patterns-leading-let.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3a405421e7c1437416e225ea8d2f0fdfb501df7b/src%2Ftest%2Fui%2For-patterns%2Ffeature-gate-or_patterns-leading-let.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2For-patterns%2Ffeature-gate-or_patterns-leading-let.rs?ref=3a405421e7c1437416e225ea8d2f0fdfb501df7b", "patch": "@@ -0,0 +1,8 @@\n+// Test feature gating for a sole leading `|` in `let`.\n+\n+fn main() {}\n+\n+#[cfg(FALSE)]\n+fn gated_leading_vert_in_let() {\n+    let | A; //~ ERROR or-patterns syntax is experimental\n+}"}, {"sha": "f7954ad7a8ce11010986e0be652b94c248c25662", "filename": "src/test/ui/or-patterns/feature-gate-or_patterns-leading-let.stderr", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/3a405421e7c1437416e225ea8d2f0fdfb501df7b/src%2Ftest%2Fui%2For-patterns%2Ffeature-gate-or_patterns-leading-let.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/3a405421e7c1437416e225ea8d2f0fdfb501df7b/src%2Ftest%2Fui%2For-patterns%2Ffeature-gate-or_patterns-leading-let.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2For-patterns%2Ffeature-gate-or_patterns-leading-let.stderr?ref=3a405421e7c1437416e225ea8d2f0fdfb501df7b", "patch": "@@ -0,0 +1,12 @@\n+error[E0658]: or-patterns syntax is experimental\n+  --> $DIR/feature-gate-or_patterns-leading-let.rs:7:11\n+   |\n+LL |     let | A;\n+   |           ^\n+   |\n+   = note: for more information, see https://github.com/rust-lang/rust/issues/54883\n+   = help: add `#![feature(or_patterns)]` to the crate attributes to enable\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0658`."}, {"sha": "8b18082fca7df7b04885455d4b200f966af9dc06", "filename": "src/test/ui/or-patterns/feature-gate-or_patterns-leading.stderr", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/3a405421e7c1437416e225ea8d2f0fdfb501df7b/src%2Ftest%2Fui%2For-patterns%2Ffeature-gate-or_patterns-leading.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/3a405421e7c1437416e225ea8d2f0fdfb501df7b/src%2Ftest%2Fui%2For-patterns%2Ffeature-gate-or_patterns-leading.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2For-patterns%2Ffeature-gate-or_patterns-leading.stderr?ref=3a405421e7c1437416e225ea8d2f0fdfb501df7b", "patch": "@@ -0,0 +1,12 @@\n+error[E0658]: or-patterns syntax is experimental\n+  --> $DIR/feature-gate-or_patterns-leading.rs:7:11\n+   |\n+LL |     let | A;\n+   |           ^\n+   |\n+   = note: for more information, see https://github.com/rust-lang/rust/issues/54883\n+   = help: add `#![feature(or_patterns)]` to the crate attributes to enable\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0658`."}, {"sha": "e638838147a4dd9137d7f2f501cdb67405ee7e3b", "filename": "src/test/ui/or-patterns/feature-gate-or_patterns.rs", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/3a405421e7c1437416e225ea8d2f0fdfb501df7b/src%2Ftest%2Fui%2For-patterns%2Ffeature-gate-or_patterns.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3a405421e7c1437416e225ea8d2f0fdfb501df7b/src%2Ftest%2Fui%2For-patterns%2Ffeature-gate-or_patterns.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2For-patterns%2Ffeature-gate-or_patterns.rs?ref=3a405421e7c1437416e225ea8d2f0fdfb501df7b", "patch": "@@ -26,10 +26,8 @@ fn or_patterns() {\n     // Gated:\n \n     let | A | B; //~ ERROR or-patterns syntax is experimental\n-    //~^ ERROR or-patterns syntax is experimental\n     let A | B; //~ ERROR or-patterns syntax is experimental\n     for | A | B in 0 {} //~ ERROR or-patterns syntax is experimental\n-    //~^ ERROR or-patterns syntax is experimental\n     for A | B in 0 {} //~ ERROR or-patterns syntax is experimental\n     fn fun((A | B): _) {} //~ ERROR or-patterns syntax is experimental\n     let _ = |(A | B): u8| (); //~ ERROR or-patterns syntax is experimental"}, {"sha": "aae6644dac2e076ee01242ea526a921add8b1f52", "filename": "src/test/ui/or-patterns/feature-gate-or_patterns.stderr", "status": "modified", "additions": 13, "deletions": 31, "changes": 44, "blob_url": "https://github.com/rust-lang/rust/blob/3a405421e7c1437416e225ea8d2f0fdfb501df7b/src%2Ftest%2Fui%2For-patterns%2Ffeature-gate-or_patterns.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/3a405421e7c1437416e225ea8d2f0fdfb501df7b/src%2Ftest%2Fui%2For-patterns%2Ffeature-gate-or_patterns.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2For-patterns%2Ffeature-gate-or_patterns.stderr?ref=3a405421e7c1437416e225ea8d2f0fdfb501df7b", "patch": "@@ -7,15 +7,6 @@ LL |         Some(0 | 1 | 2) => {}\n    = note: for more information, see https://github.com/rust-lang/rust/issues/54883\n    = help: add `#![feature(or_patterns)]` to the crate attributes to enable\n \n-error[E0658]: or-patterns syntax is experimental\n-  --> $DIR/feature-gate-or_patterns.rs:28:9\n-   |\n-LL |     let | A | B;\n-   |         ^\n-   |\n-   = note: for more information, see https://github.com/rust-lang/rust/issues/54883\n-   = help: add `#![feature(or_patterns)]` to the crate attributes to enable\n-\n error[E0658]: or-patterns syntax is experimental\n   --> $DIR/feature-gate-or_patterns.rs:28:11\n    |\n@@ -26,7 +17,7 @@ LL |     let | A | B;\n    = help: add `#![feature(or_patterns)]` to the crate attributes to enable\n \n error[E0658]: or-patterns syntax is experimental\n-  --> $DIR/feature-gate-or_patterns.rs:30:9\n+  --> $DIR/feature-gate-or_patterns.rs:29:9\n    |\n LL |     let A | B;\n    |         ^^^^^\n@@ -35,16 +26,7 @@ LL |     let A | B;\n    = help: add `#![feature(or_patterns)]` to the crate attributes to enable\n \n error[E0658]: or-patterns syntax is experimental\n-  --> $DIR/feature-gate-or_patterns.rs:31:9\n-   |\n-LL |     for | A | B in 0 {}\n-   |         ^\n-   |\n-   = note: for more information, see https://github.com/rust-lang/rust/issues/54883\n-   = help: add `#![feature(or_patterns)]` to the crate attributes to enable\n-\n-error[E0658]: or-patterns syntax is experimental\n-  --> $DIR/feature-gate-or_patterns.rs:31:11\n+  --> $DIR/feature-gate-or_patterns.rs:30:11\n    |\n LL |     for | A | B in 0 {}\n    |           ^^^^^\n@@ -53,7 +35,7 @@ LL |     for | A | B in 0 {}\n    = help: add `#![feature(or_patterns)]` to the crate attributes to enable\n \n error[E0658]: or-patterns syntax is experimental\n-  --> $DIR/feature-gate-or_patterns.rs:33:9\n+  --> $DIR/feature-gate-or_patterns.rs:31:9\n    |\n LL |     for A | B in 0 {}\n    |         ^^^^^\n@@ -62,7 +44,7 @@ LL |     for A | B in 0 {}\n    = help: add `#![feature(or_patterns)]` to the crate attributes to enable\n \n error[E0658]: or-patterns syntax is experimental\n-  --> $DIR/feature-gate-or_patterns.rs:34:13\n+  --> $DIR/feature-gate-or_patterns.rs:32:13\n    |\n LL |     fn fun((A | B): _) {}\n    |             ^^^^^\n@@ -71,7 +53,7 @@ LL |     fn fun((A | B): _) {}\n    = help: add `#![feature(or_patterns)]` to the crate attributes to enable\n \n error[E0658]: or-patterns syntax is experimental\n-  --> $DIR/feature-gate-or_patterns.rs:35:15\n+  --> $DIR/feature-gate-or_patterns.rs:33:15\n    |\n LL |     let _ = |(A | B): u8| ();\n    |               ^^^^^\n@@ -80,7 +62,7 @@ LL |     let _ = |(A | B): u8| ();\n    = help: add `#![feature(or_patterns)]` to the crate attributes to enable\n \n error[E0658]: or-patterns syntax is experimental\n-  --> $DIR/feature-gate-or_patterns.rs:36:10\n+  --> $DIR/feature-gate-or_patterns.rs:34:10\n    |\n LL |     let (A | B);\n    |          ^^^^^\n@@ -89,7 +71,7 @@ LL |     let (A | B);\n    = help: add `#![feature(or_patterns)]` to the crate attributes to enable\n \n error[E0658]: or-patterns syntax is experimental\n-  --> $DIR/feature-gate-or_patterns.rs:37:10\n+  --> $DIR/feature-gate-or_patterns.rs:35:10\n    |\n LL |     let (A | B,);\n    |          ^^^^^\n@@ -98,7 +80,7 @@ LL |     let (A | B,);\n    = help: add `#![feature(or_patterns)]` to the crate attributes to enable\n \n error[E0658]: or-patterns syntax is experimental\n-  --> $DIR/feature-gate-or_patterns.rs:38:11\n+  --> $DIR/feature-gate-or_patterns.rs:36:11\n    |\n LL |     let A(B | C);\n    |           ^^^^^\n@@ -107,7 +89,7 @@ LL |     let A(B | C);\n    = help: add `#![feature(or_patterns)]` to the crate attributes to enable\n \n error[E0658]: or-patterns syntax is experimental\n-  --> $DIR/feature-gate-or_patterns.rs:39:14\n+  --> $DIR/feature-gate-or_patterns.rs:37:14\n    |\n LL |     let E::V(B | C);\n    |              ^^^^^\n@@ -116,7 +98,7 @@ LL |     let E::V(B | C);\n    = help: add `#![feature(or_patterns)]` to the crate attributes to enable\n \n error[E0658]: or-patterns syntax is experimental\n-  --> $DIR/feature-gate-or_patterns.rs:40:17\n+  --> $DIR/feature-gate-or_patterns.rs:38:17\n    |\n LL |     let S { f1: B | C, f2 };\n    |                 ^^^^^\n@@ -125,7 +107,7 @@ LL |     let S { f1: B | C, f2 };\n    = help: add `#![feature(or_patterns)]` to the crate attributes to enable\n \n error[E0658]: or-patterns syntax is experimental\n-  --> $DIR/feature-gate-or_patterns.rs:41:20\n+  --> $DIR/feature-gate-or_patterns.rs:39:20\n    |\n LL |     let E::V { f1: B | C, f2 };\n    |                    ^^^^^\n@@ -134,7 +116,7 @@ LL |     let E::V { f1: B | C, f2 };\n    = help: add `#![feature(or_patterns)]` to the crate attributes to enable\n \n error[E0658]: or-patterns syntax is experimental\n-  --> $DIR/feature-gate-or_patterns.rs:42:10\n+  --> $DIR/feature-gate-or_patterns.rs:40:10\n    |\n LL |     let [A | B];\n    |          ^^^^^\n@@ -187,6 +169,6 @@ LL | accept_pat!([p | q]);\n    = note: for more information, see https://github.com/rust-lang/rust/issues/54883\n    = help: add `#![feature(or_patterns)]` to the crate attributes to enable\n \n-error: aborting due to 21 previous errors\n+error: aborting due to 19 previous errors\n \n For more information about this error, try `rustc --explain E0658`."}]}