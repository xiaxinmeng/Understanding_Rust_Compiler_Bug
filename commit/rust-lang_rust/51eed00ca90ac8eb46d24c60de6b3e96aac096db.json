{"sha": "51eed00ca90ac8eb46d24c60de6b3e96aac096db", "node_id": "C_kwDOAAsO6NoAKDUxZWVkMDBjYTkwYWM4ZWI0NmQyNGM2MGRlNmIzZTk2YWFjMDk2ZGI", "commit": {"author": {"name": "Dylan DPC", "email": "99973273+Dylan-DPC@users.noreply.github.com", "date": "2022-08-12T15:09:10Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-08-12T15:09:10Z"}, "message": "Rollup merge of #100030 - WaffleLapkin:nice_pointer_sis, r=scottmcm\n\ncleanup code w/ pointers in std a little\n\nUse pointer methods (`byte_add`, `null_mut`, etc) to make code in std a little nicer.", "tree": {"sha": "d306eb844e5d3d87520ac104fb0fe6a08f4bd0b4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d306eb844e5d3d87520ac104fb0fe6a08f4bd0b4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/51eed00ca90ac8eb46d24c60de6b3e96aac096db", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJi9m0WCRBK7hj4Ov3rIwAAe2IIABWDJPXH+5zWYVTHb7hBNoou\nN1w8esNzPEWYuKoWnIfuhUZX/uaO818PW4p5omISZ2bDQ8M5IaB+ualQOxf+6faK\nYgOVevZ4oQB/GvKUmwVJ18FAbBodgNKcrZSzsiFmHyxQ3/SLNiYerqv1xo+s6ISL\nTfN+qYUEffkVBnVCUbAyT++FEpYMza4TsCJLVmi2VYQuvkeoOpvq6OkjQDqL0OUg\nFFuP8IQ2mEpAjJvBY9JdnGiJWWgyQQLmmpZY8Ph7m07rnP0iY18Q3EQwpaoPsxuB\nOeaCmVi77j9WA8QA0d0bLv91XceRR4S7G7QwWSfrdzGYRlmUOPCfB01zQdDNMRE=\n=hP+q\n-----END PGP SIGNATURE-----\n", "payload": "tree d306eb844e5d3d87520ac104fb0fe6a08f4bd0b4\nparent a8c799a6a042392f293614da160e67700a363263\nparent d52ed8234e8a9b8f3b988b63dae44e82827fcbda\nauthor Dylan DPC <99973273+Dylan-DPC@users.noreply.github.com> 1660316950 +0530\ncommitter GitHub <noreply@github.com> 1660316950 +0530\n\nRollup merge of #100030 - WaffleLapkin:nice_pointer_sis, r=scottmcm\n\ncleanup code w/ pointers in std a little\n\nUse pointer methods (`byte_add`, `null_mut`, etc) to make code in std a little nicer.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/51eed00ca90ac8eb46d24c60de6b3e96aac096db", "html_url": "https://github.com/rust-lang/rust/commit/51eed00ca90ac8eb46d24c60de6b3e96aac096db", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/51eed00ca90ac8eb46d24c60de6b3e96aac096db/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a8c799a6a042392f293614da160e67700a363263", "url": "https://api.github.com/repos/rust-lang/rust/commits/a8c799a6a042392f293614da160e67700a363263", "html_url": "https://github.com/rust-lang/rust/commit/a8c799a6a042392f293614da160e67700a363263"}, {"sha": "d52ed8234e8a9b8f3b988b63dae44e82827fcbda", "url": "https://api.github.com/repos/rust-lang/rust/commits/d52ed8234e8a9b8f3b988b63dae44e82827fcbda", "html_url": "https://github.com/rust-lang/rust/commit/d52ed8234e8a9b8f3b988b63dae44e82827fcbda"}], "stats": {"total": 59, "additions": 33, "deletions": 26}, "files": [{"sha": "6756eecd0e0f8ca6bc446b899595a56de3ef6b1a", "filename": "library/core/src/alloc/global.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/51eed00ca90ac8eb46d24c60de6b3e96aac096db/library%2Fcore%2Fsrc%2Falloc%2Fglobal.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51eed00ca90ac8eb46d24c60de6b3e96aac096db/library%2Fcore%2Fsrc%2Falloc%2Fglobal.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Falloc%2Fglobal.rs?ref=51eed00ca90ac8eb46d24c60de6b3e96aac096db", "patch": "@@ -74,7 +74,7 @@ use crate::ptr;\n ///         {\n ///             return null_mut();\n ///         };\n-///         (self.arena.get() as *mut u8).add(allocated)\n+///         self.arena.get().cast::<u8>().add(allocated)\n ///     }\n ///     unsafe fn dealloc(&self, _ptr: *mut u8, _layout: Layout) {}\n /// }"}, {"sha": "c25b159c533a19ae0f951745301db71fbc18ac77", "filename": "library/core/src/ptr/const_ptr.rs", "status": "modified", "additions": 9, "deletions": 8, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/51eed00ca90ac8eb46d24c60de6b3e96aac096db/library%2Fcore%2Fsrc%2Fptr%2Fconst_ptr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51eed00ca90ac8eb46d24c60de6b3e96aac096db/library%2Fcore%2Fsrc%2Fptr%2Fconst_ptr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fptr%2Fconst_ptr.rs?ref=51eed00ca90ac8eb46d24c60de6b3e96aac096db", "patch": "@@ -1267,20 +1267,21 @@ impl<T: ?Sized> *const T {\n     /// Accessing adjacent `u8` as `u16`\n     ///\n     /// ```\n-    /// # fn foo(n: usize) {\n-    /// # use std::mem::align_of;\n+    /// use std::mem::align_of;\n+    ///\n     /// # unsafe {\n-    /// let x = [5u8, 6u8, 7u8, 8u8, 9u8];\n-    /// let ptr = x.as_ptr().add(n) as *const u8;\n+    /// let x = [5_u8, 6, 7, 8, 9];\n+    /// let ptr = x.as_ptr();\n     /// let offset = ptr.align_offset(align_of::<u16>());\n-    /// if offset < x.len() - n - 1 {\n-    ///     let u16_ptr = ptr.add(offset) as *const u16;\n-    ///     assert_ne!(*u16_ptr, 500);\n+    ///\n+    /// if offset < x.len() - 1 {\n+    ///     let u16_ptr = ptr.add(offset).cast::<u16>();\n+    ///     assert!(*u16_ptr == u16::from_ne_bytes([5, 6]) || *u16_ptr == u16::from_ne_bytes([6, 7]));\n     /// } else {\n     ///     // while the pointer can be aligned via `offset`, it would point\n     ///     // outside the allocation\n     /// }\n-    /// # } }\n+    /// # }\n     /// ```\n     #[stable(feature = \"align_offset\", since = \"1.36.0\")]\n     #[rustc_const_unstable(feature = \"const_align_offset\", issue = \"90962\")]"}, {"sha": "fff06b458c7c132a43580491672863369bb4b5f5", "filename": "library/core/src/ptr/mut_ptr.rs", "status": "modified", "additions": 11, "deletions": 8, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/51eed00ca90ac8eb46d24c60de6b3e96aac096db/library%2Fcore%2Fsrc%2Fptr%2Fmut_ptr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51eed00ca90ac8eb46d24c60de6b3e96aac096db/library%2Fcore%2Fsrc%2Fptr%2Fmut_ptr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fptr%2Fmut_ptr.rs?ref=51eed00ca90ac8eb46d24c60de6b3e96aac096db", "patch": "@@ -1545,20 +1545,23 @@ impl<T: ?Sized> *mut T {\n     /// Accessing adjacent `u8` as `u16`\n     ///\n     /// ```\n-    /// # fn foo(n: usize) {\n-    /// # use std::mem::align_of;\n+    /// use std::mem::align_of;\n+    ///\n     /// # unsafe {\n-    /// let x = [5u8, 6u8, 7u8, 8u8, 9u8];\n-    /// let ptr = x.as_ptr().add(n) as *const u8;\n+    /// let mut x = [5_u8, 6, 7, 8, 9];\n+    /// let ptr = x.as_mut_ptr();\n     /// let offset = ptr.align_offset(align_of::<u16>());\n-    /// if offset < x.len() - n - 1 {\n-    ///     let u16_ptr = ptr.add(offset) as *const u16;\n-    ///     assert_ne!(*u16_ptr, 500);\n+    ///\n+    /// if offset < x.len() - 1 {\n+    ///     let u16_ptr = ptr.add(offset).cast::<u16>();\n+    ///     *u16_ptr = 0;\n+    ///\n+    ///     assert!(x == [0, 0, 7, 8, 9] || x == [5, 0, 0, 8, 9]);\n     /// } else {\n     ///     // while the pointer can be aligned via `offset`, it would point\n     ///     // outside the allocation\n     /// }\n-    /// # } }\n+    /// # }\n     /// ```\n     #[stable(feature = \"align_offset\", since = \"1.36.0\")]\n     #[rustc_const_unstable(feature = \"const_align_offset\", issue = \"90962\")]"}, {"sha": "f43b780ec9a900a18f202d2e8e3cf55a574894d1", "filename": "library/core/src/slice/iter.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/51eed00ca90ac8eb46d24c60de6b3e96aac096db/library%2Fcore%2Fsrc%2Fslice%2Fiter.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51eed00ca90ac8eb46d24c60de6b3e96aac096db/library%2Fcore%2Fsrc%2Fslice%2Fiter.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fslice%2Fiter.rs?ref=51eed00ca90ac8eb46d24c60de6b3e96aac096db", "patch": "@@ -92,7 +92,7 @@ impl<'a, T> Iter<'a, T> {\n             assume(!ptr.is_null());\n \n             let end = if mem::size_of::<T>() == 0 {\n-                (ptr as *const u8).wrapping_add(slice.len()) as *const T\n+                ptr.wrapping_byte_add(slice.len())\n             } else {\n                 ptr.add(slice.len())\n             };\n@@ -228,7 +228,7 @@ impl<'a, T> IterMut<'a, T> {\n             assume(!ptr.is_null());\n \n             let end = if mem::size_of::<T>() == 0 {\n-                (ptr as *mut u8).wrapping_add(slice.len()) as *mut T\n+                ptr.wrapping_byte_add(slice.len())\n             } else {\n                 ptr.add(slice.len())\n             };"}, {"sha": "d874f08317f6142c27d86d010b39569d42b5fab5", "filename": "library/core/tests/const_ptr.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/51eed00ca90ac8eb46d24c60de6b3e96aac096db/library%2Fcore%2Ftests%2Fconst_ptr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51eed00ca90ac8eb46d24c60de6b3e96aac096db/library%2Fcore%2Ftests%2Fconst_ptr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Ftests%2Fconst_ptr.rs?ref=51eed00ca90ac8eb46d24c60de6b3e96aac096db", "patch": "@@ -3,7 +3,7 @@ const DATA: [u16; 2] = [u16::from_ne_bytes([0x01, 0x23]), u16::from_ne_bytes([0x\n \n const fn unaligned_ptr() -> *const u16 {\n     // Since DATA.as_ptr() is aligned to two bytes, adding 1 byte to that produces an unaligned *const u16\n-    unsafe { (DATA.as_ptr() as *const u8).add(1) as *const u16 }\n+    unsafe { DATA.as_ptr().byte_add(1) }\n }\n \n #[test]\n@@ -67,7 +67,7 @@ fn write() {\n     const fn write_unaligned() -> [u16; 2] {\n         let mut two_aligned = [0u16; 2];\n         unsafe {\n-            let unaligned_ptr = (two_aligned.as_mut_ptr() as *mut u8).add(1) as *mut u16;\n+            let unaligned_ptr = two_aligned.as_mut_ptr().byte_add(1);\n             ptr::write_unaligned(unaligned_ptr, u16::from_ne_bytes([0x23, 0x45]));\n         }\n         two_aligned\n@@ -91,7 +91,7 @@ fn mut_ptr_write() {\n     const fn write_unaligned() -> [u16; 2] {\n         let mut two_aligned = [0u16; 2];\n         unsafe {\n-            let unaligned_ptr = (two_aligned.as_mut_ptr() as *mut u8).add(1) as *mut u16;\n+            let unaligned_ptr = two_aligned.as_mut_ptr().byte_add(1);\n             unaligned_ptr.write_unaligned(u16::from_ne_bytes([0x23, 0x45]));\n         }\n         two_aligned"}, {"sha": "df9b1073a0994d533e97ba18e54fd8afff623e95", "filename": "library/core/tests/lib.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/51eed00ca90ac8eb46d24c60de6b3e96aac096db/library%2Fcore%2Ftests%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51eed00ca90ac8eb46d24c60de6b3e96aac096db/library%2Fcore%2Ftests%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Ftests%2Flib.rs?ref=51eed00ca90ac8eb46d24c60de6b3e96aac096db", "patch": "@@ -14,6 +14,7 @@\n #![feature(const_maybe_uninit_assume_init_read)]\n #![feature(const_nonnull_new)]\n #![feature(const_num_from_num)]\n+#![feature(const_pointer_byte_offsets)]\n #![feature(const_ptr_as_ref)]\n #![feature(const_ptr_read)]\n #![feature(const_ptr_write)]\n@@ -74,6 +75,7 @@\n #![feature(never_type)]\n #![feature(unwrap_infallible)]\n #![feature(result_into_ok_or_err)]\n+#![feature(pointer_byte_offsets)]\n #![feature(portable_simd)]\n #![feature(ptr_metadata)]\n #![feature(once_cell)]"}, {"sha": "66fa1efbf103f26115a00c5e78bbf8edb433a1f3", "filename": "library/std/src/sys/sgx/abi/usercalls/alloc.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/51eed00ca90ac8eb46d24c60de6b3e96aac096db/library%2Fstd%2Fsrc%2Fsys%2Fsgx%2Fabi%2Fusercalls%2Falloc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51eed00ca90ac8eb46d24c60de6b3e96aac096db/library%2Fstd%2Fsrc%2Fsys%2Fsgx%2Fabi%2Fusercalls%2Falloc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Fsgx%2Fabi%2Fusercalls%2Falloc.rs?ref=51eed00ca90ac8eb46d24c60de6b3e96aac096db", "patch": "@@ -115,7 +115,7 @@ pub unsafe trait UserSafe {\n     /// * the pointer is null.\n     /// * the pointed-to range is not in user memory.\n     unsafe fn check_ptr(ptr: *const Self) {\n-        let is_aligned = |p| -> bool { 0 == (p as usize) & (Self::align_of() - 1) };\n+        let is_aligned = |p: *const u8| -> bool { 0 == p.addr() & (Self::align_of() - 1) };\n \n         assert!(is_aligned(ptr as *const u8));\n         assert!(is_user_range(ptr as _, mem::size_of_val(unsafe { &*ptr })));"}, {"sha": "d715ae45401e654d88c251a0db98e2c1e6038196", "filename": "library/std/src/sys/unsupported/alloc.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/51eed00ca90ac8eb46d24c60de6b3e96aac096db/library%2Fstd%2Fsrc%2Fsys%2Funsupported%2Falloc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51eed00ca90ac8eb46d24c60de6b3e96aac096db/library%2Fstd%2Fsrc%2Fsys%2Funsupported%2Falloc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Funsupported%2Falloc.rs?ref=51eed00ca90ac8eb46d24c60de6b3e96aac096db", "patch": "@@ -1,22 +1,23 @@\n use crate::alloc::{GlobalAlloc, Layout, System};\n+use crate::ptr::null_mut;\n \n #[stable(feature = \"alloc_system_type\", since = \"1.28.0\")]\n unsafe impl GlobalAlloc for System {\n     #[inline]\n     unsafe fn alloc(&self, _layout: Layout) -> *mut u8 {\n-        0 as *mut u8\n+        null_mut()\n     }\n \n     #[inline]\n     unsafe fn alloc_zeroed(&self, _layout: Layout) -> *mut u8 {\n-        0 as *mut u8\n+        null_mut()\n     }\n \n     #[inline]\n     unsafe fn dealloc(&self, _ptr: *mut u8, _layout: Layout) {}\n \n     #[inline]\n     unsafe fn realloc(&self, _ptr: *mut u8, _layout: Layout, _new_size: usize) -> *mut u8 {\n-        0 as *mut u8\n+        null_mut()\n     }\n }"}]}