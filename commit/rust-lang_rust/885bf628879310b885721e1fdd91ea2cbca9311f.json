{"sha": "885bf628879310b885721e1fdd91ea2cbca9311f", "node_id": "C_kwDOAAsO6NoAKDg4NWJmNjI4ODc5MzEwYjg4NTcyMWUxZmRkOTFlYTJjYmNhOTMxMWY", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-01-26T03:10:52Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-01-26T03:10:52Z"}, "message": "Auto merge of #105582 - saethlin:instcombine-assert-inhabited, r=cjgillot\n\nInstCombine away intrinsic validity assertions\n\nThis optimization (currently) fires 246 times on the standard library. It seems to fire hardly at all on the big crates in the benchmark suite. Interesting.", "tree": {"sha": "eab86e1cccf55fb17843111cd9d66186de95db78", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/eab86e1cccf55fb17843111cd9d66186de95db78"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/885bf628879310b885721e1fdd91ea2cbca9311f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/885bf628879310b885721e1fdd91ea2cbca9311f", "html_url": "https://github.com/rust-lang/rust/commit/885bf628879310b885721e1fdd91ea2cbca9311f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/885bf628879310b885721e1fdd91ea2cbca9311f/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2a17174ee639f8e0a3cee307d5685d38beb474ba", "url": "https://api.github.com/repos/rust-lang/rust/commits/2a17174ee639f8e0a3cee307d5685d38beb474ba", "html_url": "https://github.com/rust-lang/rust/commit/2a17174ee639f8e0a3cee307d5685d38beb474ba"}, {"sha": "5bfad5cc858d3b59d30da6d411449883581ff510", "url": "https://api.github.com/repos/rust-lang/rust/commits/5bfad5cc858d3b59d30da6d411449883581ff510", "html_url": "https://github.com/rust-lang/rust/commit/5bfad5cc858d3b59d30da6d411449883581ff510"}], "stats": {"total": 292, "additions": 276, "deletions": 16}, "files": [{"sha": "b1adaa193b333b1e906281d961b4eb8e5f4ef096", "filename": "compiler/rustc_codegen_cranelift/src/intrinsics/mod.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/885bf628879310b885721e1fdd91ea2cbca9311f/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fintrinsics%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/885bf628879310b885721e1fdd91ea2cbca9311f/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fintrinsics%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fintrinsics%2Fmod.rs?ref=885bf628879310b885721e1fdd91ea2cbca9311f", "patch": "@@ -21,6 +21,7 @@ mod simd;\n pub(crate) use cpuid::codegen_cpuid_call;\n pub(crate) use llvm::codegen_llvm_intrinsic_call;\n \n+use rustc_middle::ty::layout::HasParamEnv;\n use rustc_middle::ty::print::with_no_trimmed_paths;\n use rustc_middle::ty::subst::SubstsRef;\n use rustc_span::symbol::{kw, sym, Symbol};\n@@ -659,7 +660,9 @@ fn codegen_regular_intrinsic_call<'tcx>(\n                 return;\n             }\n \n-            if intrinsic == sym::assert_zero_valid && !fx.tcx.permits_zero_init(layout) {\n+            if intrinsic == sym::assert_zero_valid\n+                && !fx.tcx.permits_zero_init(fx.param_env().and(layout))\n+            {\n                 with_no_trimmed_paths!({\n                     crate::base::codegen_panic(\n                         fx,\n@@ -674,7 +677,7 @@ fn codegen_regular_intrinsic_call<'tcx>(\n             }\n \n             if intrinsic == sym::assert_mem_uninitialized_valid\n-                && !fx.tcx.permits_uninit_init(layout)\n+                && !fx.tcx.permits_uninit_init(fx.param_env().and(layout))\n             {\n                 with_no_trimmed_paths!({\n                     crate::base::codegen_panic("}, {"sha": "c73f415ad8f20adfce7ab6c4d25e4303d86320f7", "filename": "compiler/rustc_codegen_ssa/src/mir/block.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/885bf628879310b885721e1fdd91ea2cbca9311f/compiler%2Frustc_codegen_ssa%2Fsrc%2Fmir%2Fblock.rs", "raw_url": "https://github.com/rust-lang/rust/raw/885bf628879310b885721e1fdd91ea2cbca9311f/compiler%2Frustc_codegen_ssa%2Fsrc%2Fmir%2Fblock.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fmir%2Fblock.rs?ref=885bf628879310b885721e1fdd91ea2cbca9311f", "patch": "@@ -678,8 +678,8 @@ impl<'a, 'tcx, Bx: BuilderMethods<'a, 'tcx>> FunctionCx<'a, 'tcx, Bx> {\n             let layout = bx.layout_of(ty);\n             let do_panic = match intrinsic {\n                 Inhabited => layout.abi.is_uninhabited(),\n-                ZeroValid => !bx.tcx().permits_zero_init(layout),\n-                MemUninitializedValid => !bx.tcx().permits_uninit_init(layout),\n+                ZeroValid => !bx.tcx().permits_zero_init(bx.param_env().and(layout)),\n+                MemUninitializedValid => !bx.tcx().permits_uninit_init(bx.param_env().and(layout)),\n             };\n             Some(if do_panic {\n                 let msg_str = with_no_visible_paths!({"}, {"sha": "f87e4fbc1a17809105391a98722d7f881e72e071", "filename": "compiler/rustc_const_eval/src/interpret/intrinsics.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/885bf628879310b885721e1fdd91ea2cbca9311f/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Fintrinsics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/885bf628879310b885721e1fdd91ea2cbca9311f/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Fintrinsics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Fintrinsics.rs?ref=885bf628879310b885721e1fdd91ea2cbca9311f", "patch": "@@ -447,7 +447,7 @@ impl<'mir, 'tcx: 'mir, M: Machine<'mir, 'tcx>> InterpCx<'mir, 'tcx, M> {\n                 }\n \n                 if intrinsic_name == sym::assert_zero_valid {\n-                    let should_panic = !self.tcx.permits_zero_init(layout);\n+                    let should_panic = !self.tcx.permits_zero_init(self.param_env.and(layout));\n \n                     if should_panic {\n                         M::abort(\n@@ -461,7 +461,7 @@ impl<'mir, 'tcx: 'mir, M: Machine<'mir, 'tcx>> InterpCx<'mir, 'tcx, M> {\n                 }\n \n                 if intrinsic_name == sym::assert_mem_uninitialized_valid {\n-                    let should_panic = !self.tcx.permits_uninit_init(layout);\n+                    let should_panic = !self.tcx.permits_uninit_init(self.param_env.and(layout));\n \n                     if should_panic {\n                         M::abort("}, {"sha": "51624a0c6c817bb4a5327cd3cf1e744a75329772", "filename": "compiler/rustc_const_eval/src/lib.rs", "status": "modified", "additions": 8, "deletions": 3, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/885bf628879310b885721e1fdd91ea2cbca9311f/compiler%2Frustc_const_eval%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/885bf628879310b885721e1fdd91ea2cbca9311f/compiler%2Frustc_const_eval%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Flib.rs?ref=885bf628879310b885721e1fdd91ea2cbca9311f", "patch": "@@ -58,7 +58,12 @@ pub fn provide(providers: &mut Providers) {\n         let (param_env, value) = param_env_and_value.into_parts();\n         const_eval::deref_mir_constant(tcx, param_env, value)\n     };\n-    providers.permits_uninit_init =\n-        |tcx, ty| util::might_permit_raw_init(tcx, ty, InitKind::UninitMitigated0x01Fill);\n-    providers.permits_zero_init = |tcx, ty| util::might_permit_raw_init(tcx, ty, InitKind::Zero);\n+    providers.permits_uninit_init = |tcx, param_env_and_ty| {\n+        let (param_env, ty) = param_env_and_ty.into_parts();\n+        util::might_permit_raw_init(tcx, param_env, ty, InitKind::UninitMitigated0x01Fill)\n+    };\n+    providers.permits_zero_init = |tcx, param_env_and_ty| {\n+        let (param_env, ty) = param_env_and_ty.into_parts();\n+        util::might_permit_raw_init(tcx, param_env, ty, InitKind::Zero)\n+    };\n }"}, {"sha": "48961b7aac64588486695ddc2ba4b61d4a036117", "filename": "compiler/rustc_const_eval/src/util/might_permit_raw_init.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/885bf628879310b885721e1fdd91ea2cbca9311f/compiler%2Frustc_const_eval%2Fsrc%2Futil%2Fmight_permit_raw_init.rs", "raw_url": "https://github.com/rust-lang/rust/raw/885bf628879310b885721e1fdd91ea2cbca9311f/compiler%2Frustc_const_eval%2Fsrc%2Futil%2Fmight_permit_raw_init.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Futil%2Fmight_permit_raw_init.rs?ref=885bf628879310b885721e1fdd91ea2cbca9311f", "patch": "@@ -20,13 +20,14 @@ use crate::interpret::{InterpCx, MemoryKind, OpTy};\n /// to the full uninit check).\n pub fn might_permit_raw_init<'tcx>(\n     tcx: TyCtxt<'tcx>,\n+    param_env: ParamEnv<'tcx>,\n     ty: TyAndLayout<'tcx>,\n     kind: InitKind,\n ) -> bool {\n     if tcx.sess.opts.unstable_opts.strict_init_checks {\n         might_permit_raw_init_strict(ty, tcx, kind)\n     } else {\n-        let layout_cx = LayoutCx { tcx, param_env: ParamEnv::reveal_all() };\n+        let layout_cx = LayoutCx { tcx, param_env };\n         might_permit_raw_init_lax(ty, &layout_cx, kind)\n     }\n }"}, {"sha": "b1e0d380d04bc21f0ef19cf85f8ec3618b6eed5f", "filename": "compiler/rustc_middle/src/query/mod.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/885bf628879310b885721e1fdd91ea2cbca9311f/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/885bf628879310b885721e1fdd91ea2cbca9311f/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs?ref=885bf628879310b885721e1fdd91ea2cbca9311f", "patch": "@@ -2116,12 +2116,12 @@ rustc_queries! {\n         separate_provide_extern\n     }\n \n-    query permits_uninit_init(key: TyAndLayout<'tcx>) -> bool {\n-        desc { \"checking to see if `{}` permits being left uninit\", key.ty }\n+    query permits_uninit_init(key: ty::ParamEnvAnd<'tcx, TyAndLayout<'tcx>>) -> bool {\n+        desc { \"checking to see if `{}` permits being left uninit\", key.value.ty }\n     }\n \n-    query permits_zero_init(key: TyAndLayout<'tcx>) -> bool {\n-        desc { \"checking to see if `{}` permits being left zeroed\", key.ty }\n+    query permits_zero_init(key: ty::ParamEnvAnd<'tcx, TyAndLayout<'tcx>>) -> bool {\n+        desc { \"checking to see if `{}` permits being left zeroed\", key.value.ty }\n     }\n \n     query compare_impl_const("}, {"sha": "2de886a3e817fd3631520137bec368ee74885b78", "filename": "compiler/rustc_middle/src/ty/structural_impls.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/885bf628879310b885721e1fdd91ea2cbca9311f/compiler%2Frustc_middle%2Fsrc%2Fty%2Fstructural_impls.rs", "raw_url": "https://github.com/rust-lang/rust/raw/885bf628879310b885721e1fdd91ea2cbca9311f/compiler%2Frustc_middle%2Fsrc%2Fty%2Fstructural_impls.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fstructural_impls.rs?ref=885bf628879310b885721e1fdd91ea2cbca9311f", "patch": "@@ -11,6 +11,7 @@ use crate::ty::{self, AliasTy, InferConst, Lift, Term, TermKind, Ty, TyCtxt};\n use rustc_data_structures::functor::IdFunctor;\n use rustc_hir::def::Namespace;\n use rustc_index::vec::{Idx, IndexVec};\n+use rustc_target::abi::TyAndLayout;\n \n use std::fmt;\n use std::mem::ManuallyDrop;\n@@ -853,3 +854,9 @@ impl<'tcx> TypeSuperVisitable<'tcx> for ty::UnevaluatedConst<'tcx> {\n         self.substs.visit_with(visitor)\n     }\n }\n+\n+impl<'tcx> TypeVisitable<'tcx> for TyAndLayout<'tcx, Ty<'tcx>> {\n+    fn visit_with<V: TypeVisitor<'tcx>>(&self, visitor: &mut V) -> ControlFlow<V::BreakTy> {\n+        visitor.visit_ty(self.ty)\n+    }\n+}"}, {"sha": "e1faa7a08d939425e0de3777b992099c66f9db7a", "filename": "compiler/rustc_mir_transform/src/instcombine.rs", "status": "modified", "additions": 84, "deletions": 2, "changes": 86, "blob_url": "https://github.com/rust-lang/rust/blob/885bf628879310b885721e1fdd91ea2cbca9311f/compiler%2Frustc_mir_transform%2Fsrc%2Finstcombine.rs", "raw_url": "https://github.com/rust-lang/rust/raw/885bf628879310b885721e1fdd91ea2cbca9311f/compiler%2Frustc_mir_transform%2Fsrc%2Finstcombine.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_transform%2Fsrc%2Finstcombine.rs?ref=885bf628879310b885721e1fdd91ea2cbca9311f", "patch": "@@ -6,7 +6,8 @@ use rustc_middle::mir::{\n     BinOp, Body, Constant, ConstantKind, LocalDecls, Operand, Place, ProjectionElem, Rvalue,\n     SourceInfo, Statement, StatementKind, Terminator, TerminatorKind, UnOp,\n };\n-use rustc_middle::ty::{self, TyCtxt};\n+use rustc_middle::ty::{self, layout::TyAndLayout, ParamEnv, ParamEnvAnd, SubstsRef, Ty, TyCtxt};\n+use rustc_span::symbol::{sym, Symbol};\n \n pub struct InstCombine;\n \n@@ -16,7 +17,11 @@ impl<'tcx> MirPass<'tcx> for InstCombine {\n     }\n \n     fn run_pass(&self, tcx: TyCtxt<'tcx>, body: &mut Body<'tcx>) {\n-        let ctx = InstCombineContext { tcx, local_decls: &body.local_decls };\n+        let ctx = InstCombineContext {\n+            tcx,\n+            local_decls: &body.local_decls,\n+            param_env: tcx.param_env_reveal_all_normalized(body.source.def_id()),\n+        };\n         for block in body.basic_blocks.as_mut() {\n             for statement in block.statements.iter_mut() {\n                 match statement.kind {\n@@ -33,13 +38,18 @@ impl<'tcx> MirPass<'tcx> for InstCombine {\n                 &mut block.terminator.as_mut().unwrap(),\n                 &mut block.statements,\n             );\n+            ctx.combine_intrinsic_assert(\n+                &mut block.terminator.as_mut().unwrap(),\n+                &mut block.statements,\n+            );\n         }\n     }\n }\n \n struct InstCombineContext<'tcx, 'a> {\n     tcx: TyCtxt<'tcx>,\n     local_decls: &'a LocalDecls<'tcx>,\n+    param_env: ParamEnv<'tcx>,\n }\n \n impl<'tcx> InstCombineContext<'tcx, '_> {\n@@ -200,4 +210,76 @@ impl<'tcx> InstCombineContext<'tcx, '_> {\n         });\n         terminator.kind = TerminatorKind::Goto { target: destination_block };\n     }\n+\n+    fn combine_intrinsic_assert(\n+        &self,\n+        terminator: &mut Terminator<'tcx>,\n+        _statements: &mut Vec<Statement<'tcx>>,\n+    ) {\n+        let TerminatorKind::Call { func, target, .. } = &mut terminator.kind  else { return; };\n+        let Some(target_block) = target else { return; };\n+        let func_ty = func.ty(self.local_decls, self.tcx);\n+        let Some((intrinsic_name, substs)) = resolve_rust_intrinsic(self.tcx, func_ty) else {\n+            return;\n+        };\n+        // The intrinsics we are interested in have one generic parameter\n+        if substs.is_empty() {\n+            return;\n+        }\n+        let ty = substs.type_at(0);\n+\n+        // Check this is a foldable intrinsic before we query the layout of our generic parameter\n+        let Some(assert_panics) = intrinsic_assert_panics(intrinsic_name) else { return; };\n+        let Ok(layout) = self.tcx.layout_of(self.param_env.and(ty)) else { return; };\n+        if assert_panics(self.tcx, self.param_env.and(layout)) {\n+            // If we know the assert panics, indicate to later opts that the call diverges\n+            *target = None;\n+        } else {\n+            // If we know the assert does not panic, turn the call into a Goto\n+            terminator.kind = TerminatorKind::Goto { target: *target_block };\n+        }\n+    }\n+}\n+\n+fn intrinsic_assert_panics<'tcx>(\n+    intrinsic_name: Symbol,\n+) -> Option<fn(TyCtxt<'tcx>, ParamEnvAnd<'tcx, TyAndLayout<'tcx>>) -> bool> {\n+    fn inhabited_predicate<'tcx>(\n+        _tcx: TyCtxt<'tcx>,\n+        param_env_and_layout: ParamEnvAnd<'tcx, TyAndLayout<'tcx>>,\n+    ) -> bool {\n+        let (_param_env, layout) = param_env_and_layout.into_parts();\n+        layout.abi.is_uninhabited()\n+    }\n+    fn zero_valid_predicate<'tcx>(\n+        tcx: TyCtxt<'tcx>,\n+        param_env_and_layout: ParamEnvAnd<'tcx, TyAndLayout<'tcx>>,\n+    ) -> bool {\n+        !tcx.permits_zero_init(param_env_and_layout)\n+    }\n+    fn mem_uninitialized_valid_predicate<'tcx>(\n+        tcx: TyCtxt<'tcx>,\n+        param_env_and_layout: ParamEnvAnd<'tcx, TyAndLayout<'tcx>>,\n+    ) -> bool {\n+        !tcx.permits_uninit_init(param_env_and_layout)\n+    }\n+\n+    match intrinsic_name {\n+        sym::assert_inhabited => Some(inhabited_predicate),\n+        sym::assert_zero_valid => Some(zero_valid_predicate),\n+        sym::assert_mem_uninitialized_valid => Some(mem_uninitialized_valid_predicate),\n+        _ => None,\n+    }\n+}\n+\n+fn resolve_rust_intrinsic<'tcx>(\n+    tcx: TyCtxt<'tcx>,\n+    func_ty: Ty<'tcx>,\n+) -> Option<(Symbol, SubstsRef<'tcx>)> {\n+    if let ty::FnDef(def_id, substs) = *func_ty.kind() {\n+        if tcx.is_intrinsic(def_id) {\n+            return Some((tcx.item_name(def_id), substs));\n+        }\n+    }\n+    None\n }"}, {"sha": "8ff64c1ea159c0d0ed3f7fe00d26f65f1bf99d82", "filename": "tests/mir-opt/intrinsic_asserts.generic.InstCombine.diff", "status": "added", "additions": 42, "deletions": 0, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/885bf628879310b885721e1fdd91ea2cbca9311f/tests%2Fmir-opt%2Fintrinsic_asserts.generic.InstCombine.diff", "raw_url": "https://github.com/rust-lang/rust/raw/885bf628879310b885721e1fdd91ea2cbca9311f/tests%2Fmir-opt%2Fintrinsic_asserts.generic.InstCombine.diff", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Fintrinsic_asserts.generic.InstCombine.diff?ref=885bf628879310b885721e1fdd91ea2cbca9311f", "patch": "@@ -0,0 +1,42 @@\n+- // MIR for `generic` before InstCombine\n++ // MIR for `generic` after InstCombine\n+  \n+  fn generic() -> () {\n+      let mut _0: ();                      // return place in scope 0 at $DIR/intrinsic_asserts.rs:+0:21: +0:21\n+      let _1: ();                          // in scope 0 at $DIR/intrinsic_asserts.rs:+1:5: +1:46\n+      let _2: ();                          // in scope 0 at $DIR/intrinsic_asserts.rs:+2:5: +2:47\n+      let _3: ();                          // in scope 0 at $DIR/intrinsic_asserts.rs:+3:5: +3:60\n+  \n+      bb0: {\n+          StorageLive(_1);                 // scope 0 at $DIR/intrinsic_asserts.rs:+1:5: +1:46\n+          _1 = assert_inhabited::<T>() -> bb1; // scope 0 at $DIR/intrinsic_asserts.rs:+1:5: +1:46\n+                                           // mir::Constant\n+                                           // + span: $DIR/intrinsic_asserts.rs:25:5: 25:44\n+                                           // + literal: Const { ty: extern \"rust-intrinsic\" fn() {assert_inhabited::<T>}, val: Value(<ZST>) }\n+      }\n+  \n+      bb1: {\n+          StorageDead(_1);                 // scope 0 at $DIR/intrinsic_asserts.rs:+1:46: +1:47\n+          StorageLive(_2);                 // scope 0 at $DIR/intrinsic_asserts.rs:+2:5: +2:47\n+          _2 = assert_zero_valid::<T>() -> bb2; // scope 0 at $DIR/intrinsic_asserts.rs:+2:5: +2:47\n+                                           // mir::Constant\n+                                           // + span: $DIR/intrinsic_asserts.rs:26:5: 26:45\n+                                           // + literal: Const { ty: extern \"rust-intrinsic\" fn() {assert_zero_valid::<T>}, val: Value(<ZST>) }\n+      }\n+  \n+      bb2: {\n+          StorageDead(_2);                 // scope 0 at $DIR/intrinsic_asserts.rs:+2:47: +2:48\n+          StorageLive(_3);                 // scope 0 at $DIR/intrinsic_asserts.rs:+3:5: +3:60\n+          _3 = assert_mem_uninitialized_valid::<T>() -> bb3; // scope 0 at $DIR/intrinsic_asserts.rs:+3:5: +3:60\n+                                           // mir::Constant\n+                                           // + span: $DIR/intrinsic_asserts.rs:27:5: 27:58\n+                                           // + literal: Const { ty: extern \"rust-intrinsic\" fn() {assert_mem_uninitialized_valid::<T>}, val: Value(<ZST>) }\n+      }\n+  \n+      bb3: {\n+          StorageDead(_3);                 // scope 0 at $DIR/intrinsic_asserts.rs:+3:60: +3:61\n+          nop;                             // scope 0 at $DIR/intrinsic_asserts.rs:+0:21: +4:2\n+          return;                          // scope 0 at $DIR/intrinsic_asserts.rs:+4:2: +4:2\n+      }\n+  }\n+  "}, {"sha": "ddc01590315c55a37d9c07a43beeb5b4edacd62b", "filename": "tests/mir-opt/intrinsic_asserts.panics.InstCombine.diff", "status": "added", "additions": 47, "deletions": 0, "changes": 47, "blob_url": "https://github.com/rust-lang/rust/blob/885bf628879310b885721e1fdd91ea2cbca9311f/tests%2Fmir-opt%2Fintrinsic_asserts.panics.InstCombine.diff", "raw_url": "https://github.com/rust-lang/rust/raw/885bf628879310b885721e1fdd91ea2cbca9311f/tests%2Fmir-opt%2Fintrinsic_asserts.panics.InstCombine.diff", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Fintrinsic_asserts.panics.InstCombine.diff?ref=885bf628879310b885721e1fdd91ea2cbca9311f", "patch": "@@ -0,0 +1,47 @@\n+- // MIR for `panics` before InstCombine\n++ // MIR for `panics` after InstCombine\n+  \n+  fn panics() -> () {\n+      let mut _0: ();                      // return place in scope 0 at $DIR/intrinsic_asserts.rs:+0:17: +0:17\n+      let _1: ();                          // in scope 0 at $DIR/intrinsic_asserts.rs:+1:5: +1:50\n+      let _2: ();                          // in scope 0 at $DIR/intrinsic_asserts.rs:+2:5: +2:49\n+      let _3: ();                          // in scope 0 at $DIR/intrinsic_asserts.rs:+3:5: +3:62\n+  \n+      bb0: {\n+          StorageLive(_1);                 // scope 0 at $DIR/intrinsic_asserts.rs:+1:5: +1:50\n+-         _1 = assert_inhabited::<Never>() -> bb1; // scope 0 at $DIR/intrinsic_asserts.rs:+1:5: +1:50\n++         _1 = assert_inhabited::<Never>(); // scope 0 at $DIR/intrinsic_asserts.rs:+1:5: +1:50\n+                                           // mir::Constant\n+                                           // + span: $DIR/intrinsic_asserts.rs:17:5: 17:48\n+                                           // + literal: Const { ty: extern \"rust-intrinsic\" fn() {assert_inhabited::<Never>}, val: Value(<ZST>) }\n+      }\n+  \n+      bb1: {\n+          StorageDead(_1);                 // scope 0 at $DIR/intrinsic_asserts.rs:+1:50: +1:51\n+          StorageLive(_2);                 // scope 0 at $DIR/intrinsic_asserts.rs:+2:5: +2:49\n+-         _2 = assert_zero_valid::<&u8>() -> bb2; // scope 0 at $DIR/intrinsic_asserts.rs:+2:5: +2:49\n++         _2 = assert_zero_valid::<&u8>(); // scope 0 at $DIR/intrinsic_asserts.rs:+2:5: +2:49\n+                                           // mir::Constant\n+                                           // + span: $DIR/intrinsic_asserts.rs:18:5: 18:47\n+                                           // + user_ty: UserType(0)\n+                                           // + literal: Const { ty: extern \"rust-intrinsic\" fn() {assert_zero_valid::<&u8>}, val: Value(<ZST>) }\n+      }\n+  \n+      bb2: {\n+          StorageDead(_2);                 // scope 0 at $DIR/intrinsic_asserts.rs:+2:49: +2:50\n+          StorageLive(_3);                 // scope 0 at $DIR/intrinsic_asserts.rs:+3:5: +3:62\n+-         _3 = assert_mem_uninitialized_valid::<&u8>() -> bb3; // scope 0 at $DIR/intrinsic_asserts.rs:+3:5: +3:62\n++         _3 = assert_mem_uninitialized_valid::<&u8>(); // scope 0 at $DIR/intrinsic_asserts.rs:+3:5: +3:62\n+                                           // mir::Constant\n+                                           // + span: $DIR/intrinsic_asserts.rs:19:5: 19:60\n+                                           // + user_ty: UserType(1)\n+                                           // + literal: Const { ty: extern \"rust-intrinsic\" fn() {assert_mem_uninitialized_valid::<&u8>}, val: Value(<ZST>) }\n+      }\n+  \n+      bb3: {\n+          StorageDead(_3);                 // scope 0 at $DIR/intrinsic_asserts.rs:+3:62: +3:63\n+          nop;                             // scope 0 at $DIR/intrinsic_asserts.rs:+0:17: +4:2\n+          return;                          // scope 0 at $DIR/intrinsic_asserts.rs:+4:2: +4:2\n+      }\n+  }\n+  "}, {"sha": "568fbf1a0d6591060937e16b79fa3e45f19a26a4", "filename": "tests/mir-opt/intrinsic_asserts.removable.InstCombine.diff", "status": "added", "additions": 45, "deletions": 0, "changes": 45, "blob_url": "https://github.com/rust-lang/rust/blob/885bf628879310b885721e1fdd91ea2cbca9311f/tests%2Fmir-opt%2Fintrinsic_asserts.removable.InstCombine.diff", "raw_url": "https://github.com/rust-lang/rust/raw/885bf628879310b885721e1fdd91ea2cbca9311f/tests%2Fmir-opt%2Fintrinsic_asserts.removable.InstCombine.diff", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Fintrinsic_asserts.removable.InstCombine.diff?ref=885bf628879310b885721e1fdd91ea2cbca9311f", "patch": "@@ -0,0 +1,45 @@\n+- // MIR for `removable` before InstCombine\n++ // MIR for `removable` after InstCombine\n+  \n+  fn removable() -> () {\n+      let mut _0: ();                      // return place in scope 0 at $DIR/intrinsic_asserts.rs:+0:20: +0:20\n+      let _1: ();                          // in scope 0 at $DIR/intrinsic_asserts.rs:+1:5: +1:47\n+      let _2: ();                          // in scope 0 at $DIR/intrinsic_asserts.rs:+2:5: +2:48\n+      let _3: ();                          // in scope 0 at $DIR/intrinsic_asserts.rs:+3:5: +3:61\n+  \n+      bb0: {\n+          StorageLive(_1);                 // scope 0 at $DIR/intrinsic_asserts.rs:+1:5: +1:47\n+-         _1 = assert_inhabited::<()>() -> bb1; // scope 0 at $DIR/intrinsic_asserts.rs:+1:5: +1:47\n+-                                          // mir::Constant\n+-                                          // + span: $DIR/intrinsic_asserts.rs:7:5: 7:45\n+-                                          // + literal: Const { ty: extern \"rust-intrinsic\" fn() {assert_inhabited::<()>}, val: Value(<ZST>) }\n++         goto -> bb1;                     // scope 0 at $DIR/intrinsic_asserts.rs:+1:5: +1:47\n+      }\n+  \n+      bb1: {\n+          StorageDead(_1);                 // scope 0 at $DIR/intrinsic_asserts.rs:+1:47: +1:48\n+          StorageLive(_2);                 // scope 0 at $DIR/intrinsic_asserts.rs:+2:5: +2:48\n+-         _2 = assert_zero_valid::<u8>() -> bb2; // scope 0 at $DIR/intrinsic_asserts.rs:+2:5: +2:48\n+-                                          // mir::Constant\n+-                                          // + span: $DIR/intrinsic_asserts.rs:8:5: 8:46\n+-                                          // + literal: Const { ty: extern \"rust-intrinsic\" fn() {assert_zero_valid::<u8>}, val: Value(<ZST>) }\n++         goto -> bb2;                     // scope 0 at $DIR/intrinsic_asserts.rs:+2:5: +2:48\n+      }\n+  \n+      bb2: {\n+          StorageDead(_2);                 // scope 0 at $DIR/intrinsic_asserts.rs:+2:48: +2:49\n+          StorageLive(_3);                 // scope 0 at $DIR/intrinsic_asserts.rs:+3:5: +3:61\n+-         _3 = assert_mem_uninitialized_valid::<u8>() -> bb3; // scope 0 at $DIR/intrinsic_asserts.rs:+3:5: +3:61\n+-                                          // mir::Constant\n+-                                          // + span: $DIR/intrinsic_asserts.rs:9:5: 9:59\n+-                                          // + literal: Const { ty: extern \"rust-intrinsic\" fn() {assert_mem_uninitialized_valid::<u8>}, val: Value(<ZST>) }\n++         goto -> bb3;                     // scope 0 at $DIR/intrinsic_asserts.rs:+3:5: +3:61\n+      }\n+  \n+      bb3: {\n+          StorageDead(_3);                 // scope 0 at $DIR/intrinsic_asserts.rs:+3:61: +3:62\n+          nop;                             // scope 0 at $DIR/intrinsic_asserts.rs:+0:20: +4:2\n+          return;                          // scope 0 at $DIR/intrinsic_asserts.rs:+4:2: +4:2\n+      }\n+  }\n+  "}, {"sha": "8fb99cdf6e041168dcffe1e37bda6cff0bada48f", "filename": "tests/mir-opt/intrinsic_asserts.rs", "status": "added", "additions": 28, "deletions": 0, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/885bf628879310b885721e1fdd91ea2cbca9311f/tests%2Fmir-opt%2Fintrinsic_asserts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/885bf628879310b885721e1fdd91ea2cbca9311f/tests%2Fmir-opt%2Fintrinsic_asserts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Fintrinsic_asserts.rs?ref=885bf628879310b885721e1fdd91ea2cbca9311f", "patch": "@@ -0,0 +1,28 @@\n+#![crate_type = \"lib\"]\n+#![feature(core_intrinsics)]\n+\n+// All these assertions pass, so all the intrinsic calls should be deleted.\n+// EMIT_MIR intrinsic_asserts.removable.InstCombine.diff\n+pub fn removable() {\n+    core::intrinsics::assert_inhabited::<()>();\n+    core::intrinsics::assert_zero_valid::<u8>();\n+    core::intrinsics::assert_mem_uninitialized_valid::<u8>();\n+}\n+\n+enum Never {}\n+\n+// These assertions all diverge, so their target blocks should become None.\n+// EMIT_MIR intrinsic_asserts.panics.InstCombine.diff\n+pub fn panics() {\n+    core::intrinsics::assert_inhabited::<Never>();\n+    core::intrinsics::assert_zero_valid::<&u8>();\n+    core::intrinsics::assert_mem_uninitialized_valid::<&u8>();\n+}\n+\n+// Whether or not these asserts pass isn't known, so they shouldn't be modified.\n+// EMIT_MIR intrinsic_asserts.generic.InstCombine.diff\n+pub fn generic<T>() {\n+    core::intrinsics::assert_inhabited::<T>();\n+    core::intrinsics::assert_zero_valid::<T>();\n+    core::intrinsics::assert_mem_uninitialized_valid::<T>();\n+}"}]}