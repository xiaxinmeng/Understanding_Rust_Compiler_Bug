{"sha": "9f6ca7482ca885bca14ba6870ed39a783ab939b5", "node_id": "C_kwDOAAsO6NoAKDlmNmNhNzQ4MmNhODg1YmNhMTRiYTY4NzBlZDM5YTc4M2FiOTM5YjU", "commit": {"author": {"name": "Marcel Hellwig", "email": "github@cookiesoft.de", "date": "2021-11-10T11:00:46Z"}, "committer": {"name": "Marcel Hellwig", "email": "github@cookiesoft.de", "date": "2021-11-11T07:04:02Z"}, "message": "Shorten Span of unused macro lints\n\nThe span has been recuded to the actual ident, instead of linting the\n*whole* macro.", "tree": {"sha": "90356289373246ea69baeff4594e686c64f7ca1a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/90356289373246ea69baeff4594e686c64f7ca1a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9f6ca7482ca885bca14ba6870ed39a783ab939b5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9f6ca7482ca885bca14ba6870ed39a783ab939b5", "html_url": "https://github.com/rust-lang/rust/commit/9f6ca7482ca885bca14ba6870ed39a783ab939b5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9f6ca7482ca885bca14ba6870ed39a783ab939b5/comments", "author": {"login": "hellow554", "id": 921462, "node_id": "MDQ6VXNlcjkyMTQ2Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/921462?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hellow554", "html_url": "https://github.com/hellow554", "followers_url": "https://api.github.com/users/hellow554/followers", "following_url": "https://api.github.com/users/hellow554/following{/other_user}", "gists_url": "https://api.github.com/users/hellow554/gists{/gist_id}", "starred_url": "https://api.github.com/users/hellow554/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hellow554/subscriptions", "organizations_url": "https://api.github.com/users/hellow554/orgs", "repos_url": "https://api.github.com/users/hellow554/repos", "events_url": "https://api.github.com/users/hellow554/events{/privacy}", "received_events_url": "https://api.github.com/users/hellow554/received_events", "type": "User", "site_admin": false}, "committer": {"login": "hellow554", "id": 921462, "node_id": "MDQ6VXNlcjkyMTQ2Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/921462?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hellow554", "html_url": "https://github.com/hellow554", "followers_url": "https://api.github.com/users/hellow554/followers", "following_url": "https://api.github.com/users/hellow554/following{/other_user}", "gists_url": "https://api.github.com/users/hellow554/gists{/gist_id}", "starred_url": "https://api.github.com/users/hellow554/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hellow554/subscriptions", "organizations_url": "https://api.github.com/users/hellow554/orgs", "repos_url": "https://api.github.com/users/hellow554/repos", "events_url": "https://api.github.com/users/hellow554/events{/privacy}", "received_events_url": "https://api.github.com/users/hellow554/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9dbbbb12c0b796f35cbf5a518ac12846c969a214", "url": "https://api.github.com/repos/rust-lang/rust/commits/9dbbbb12c0b796f35cbf5a518ac12846c969a214", "html_url": "https://github.com/rust-lang/rust/commit/9dbbbb12c0b796f35cbf5a518ac12846c969a214"}], "stats": {"total": 103, "additions": 41, "deletions": 62}, "files": [{"sha": "3cf9d324a38da9d2272d4d6c07321d95d5e57330", "filename": "compiler/rustc_resolve/src/build_reduced_graph.rs", "status": "modified", "additions": 4, "deletions": 10, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/9f6ca7482ca885bca14ba6870ed39a783ab939b5/compiler%2Frustc_resolve%2Fsrc%2Fbuild_reduced_graph.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9f6ca7482ca885bca14ba6870ed39a783ab939b5/compiler%2Frustc_resolve%2Fsrc%2Fbuild_reduced_graph.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Fbuild_reduced_graph.rs?ref=9f6ca7482ca885bca14ba6870ed39a783ab939b5", "patch": "@@ -1194,15 +1194,9 @@ impl<'a, 'b> BuildReducedGraphVisitor<'a, 'b> {\n     // Mark the given macro as unused unless its name starts with `_`.\n     // Macro uses will remove items from this set, and the remaining\n     // items will be reported as `unused_macros`.\n-    fn insert_unused_macro(\n-        &mut self,\n-        ident: Ident,\n-        def_id: LocalDefId,\n-        node_id: NodeId,\n-        span: Span,\n-    ) {\n+    fn insert_unused_macro(&mut self, ident: Ident, def_id: LocalDefId, node_id: NodeId) {\n         if !ident.as_str().starts_with('_') {\n-            self.r.unused_macros.insert(def_id, (node_id, span));\n+            self.r.unused_macros.insert(def_id, (node_id, ident));\n         }\n     }\n \n@@ -1246,7 +1240,7 @@ impl<'a, 'b> BuildReducedGraphVisitor<'a, 'b> {\n                 self.r.define(module, ident, MacroNS, (res, vis, span, expansion, IsMacroExport));\n             } else {\n                 self.r.check_reserved_macro_name(ident, res);\n-                self.insert_unused_macro(ident, def_id, item.id, span);\n+                self.insert_unused_macro(ident, def_id, item.id);\n             }\n             self.r.visibilities.insert(def_id, vis);\n             self.r.arenas.alloc_macro_rules_scope(MacroRulesScope::Binding(\n@@ -1267,7 +1261,7 @@ impl<'a, 'b> BuildReducedGraphVisitor<'a, 'b> {\n                 _ => self.resolve_visibility(&item.vis),\n             };\n             if vis != ty::Visibility::Public {\n-                self.insert_unused_macro(ident, def_id, item.id, span);\n+                self.insert_unused_macro(ident, def_id, item.id);\n             }\n             self.r.define(module, ident, MacroNS, (res, vis, span, expansion));\n             self.r.visibilities.insert(def_id, vis);"}, {"sha": "f5bea83bdcf654f68aa8d109151ae573039ad1b7", "filename": "compiler/rustc_resolve/src/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/9f6ca7482ca885bca14ba6870ed39a783ab939b5/compiler%2Frustc_resolve%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9f6ca7482ca885bca14ba6870ed39a783ab939b5/compiler%2Frustc_resolve%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Flib.rs?ref=9f6ca7482ca885bca14ba6870ed39a783ab939b5", "patch": "@@ -988,7 +988,7 @@ pub struct Resolver<'a> {\n     non_macro_attr: Lrc<SyntaxExtension>,\n     local_macro_def_scopes: FxHashMap<LocalDefId, Module<'a>>,\n     ast_transform_scopes: FxHashMap<LocalExpnId, Module<'a>>,\n-    unused_macros: FxHashMap<LocalDefId, (NodeId, Span)>,\n+    unused_macros: FxHashMap<LocalDefId, (NodeId, Ident)>,\n     proc_macro_stubs: FxHashSet<LocalDefId>,\n     /// Traces collected during macro resolution and validated when it's complete.\n     single_segment_macro_resolutions:"}, {"sha": "31fd9b989e1c81827e523e30c52c8ad71018989f", "filename": "compiler/rustc_resolve/src/macros.rs", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/9f6ca7482ca885bca14ba6870ed39a783ab939b5/compiler%2Frustc_resolve%2Fsrc%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9f6ca7482ca885bca14ba6870ed39a783ab939b5/compiler%2Frustc_resolve%2Fsrc%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Fmacros.rs?ref=9f6ca7482ca885bca14ba6870ed39a783ab939b5", "patch": "@@ -315,8 +315,13 @@ impl<'a> ResolverExpand for Resolver<'a> {\n     }\n \n     fn check_unused_macros(&mut self) {\n-        for (_, &(node_id, span)) in self.unused_macros.iter() {\n-            self.lint_buffer.buffer_lint(UNUSED_MACROS, node_id, span, \"unused macro definition\");\n+        for (_, &(node_id, ident)) in self.unused_macros.iter() {\n+            self.lint_buffer.buffer_lint(\n+                UNUSED_MACROS,\n+                node_id,\n+                ident.span,\n+                &format!(\"unused macro definition: `{}`\", ident.as_str()),\n+            );\n         }\n     }\n "}, {"sha": "b2e6d1aeb3f500243149f1d05819d4d134e76a15", "filename": "src/test/ui/lint/unused/issue-70041.stderr", "status": "modified", "additions": 4, "deletions": 7, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/9f6ca7482ca885bca14ba6870ed39a783ab939b5/src%2Ftest%2Fui%2Flint%2Funused%2Fissue-70041.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/9f6ca7482ca885bca14ba6870ed39a783ab939b5/src%2Ftest%2Fui%2Flint%2Funused%2Fissue-70041.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Funused%2Fissue-70041.stderr?ref=9f6ca7482ca885bca14ba6870ed39a783ab939b5", "patch": "@@ -1,11 +1,8 @@\n-warning: unused macro definition\n-  --> $DIR/issue-70041.rs:4:1\n+warning: unused macro definition: `regex`\n+  --> $DIR/issue-70041.rs:4:14\n    |\n-LL | / macro_rules! regex {\n-LL | |\n-LL | |     () => {};\n-LL | | }\n-   | |_^\n+LL | macro_rules! regex {\n+   |              ^^^^^\n    |\n    = note: `#[warn(unused_macros)]` on by default\n "}, {"sha": "59db35b4111830cdd7f47f06ec70dfac7fff7fdc", "filename": "src/test/ui/lint/unused/unused-macro-rules.stderr", "status": "modified", "additions": 12, "deletions": 23, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/9f6ca7482ca885bca14ba6870ed39a783ab939b5/src%2Ftest%2Fui%2Flint%2Funused%2Funused-macro-rules.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/9f6ca7482ca885bca14ba6870ed39a783ab939b5/src%2Ftest%2Fui%2Flint%2Funused%2Funused-macro-rules.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Funused%2Funused-macro-rules.stderr?ref=9f6ca7482ca885bca14ba6870ed39a783ab939b5", "patch": "@@ -1,37 +1,26 @@\n-error: unused macro definition\n-  --> $DIR/unused-macro-rules.rs:4:1\n+error: unused macro definition: `unused`\n+  --> $DIR/unused-macro-rules.rs:4:14\n    |\n-LL | / macro_rules! unused {\n-LL | |     () => {};\n-LL | | }\n-   | |_^\n+LL | macro_rules! unused {\n+   |              ^^^^^^\n    |\n note: the lint level is defined here\n   --> $DIR/unused-macro-rules.rs:1:9\n    |\n LL | #![deny(unused_macros)]\n    |         ^^^^^^^^^^^^^\n \n-error: unused macro definition\n-  --> $DIR/unused-macro-rules.rs:11:9\n+error: unused macro definition: `m`\n+  --> $DIR/unused-macro-rules.rs:11:22\n    |\n-LL | /         macro_rules! m {\n-LL | |             () => {};\n-LL | |         }\n-   | |_________^\n-...\n-LL |   create_macro!();\n-   |   --------------- in this macro invocation\n-   |\n-   = note: this error originates in the macro `create_macro` (in Nightly builds, run with -Z macro-backtrace for more info)\n+LL |         macro_rules! m {\n+   |                      ^\n \n-error: unused macro definition\n-  --> $DIR/unused-macro-rules.rs:24:5\n+error: unused macro definition: `unused`\n+  --> $DIR/unused-macro-rules.rs:24:18\n    |\n-LL | /     macro_rules! unused {\n-LL | |         () => {};\n-LL | |     }\n-   | |_____^\n+LL |     macro_rules! unused {\n+   |                  ^^^^^^\n    |\n note: the lint level is defined here\n   --> $DIR/unused-macro-rules.rs:23:12"}, {"sha": "1a73279ed6dbdcc517f3a6c3acd613511ecdbd7e", "filename": "src/test/ui/lint/unused/unused-macro.stderr", "status": "modified", "additions": 12, "deletions": 18, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/9f6ca7482ca885bca14ba6870ed39a783ab939b5/src%2Ftest%2Fui%2Flint%2Funused%2Funused-macro.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/9f6ca7482ca885bca14ba6870ed39a783ab939b5/src%2Ftest%2Fui%2Flint%2Funused%2Funused-macro.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Funused%2Funused-macro.stderr?ref=9f6ca7482ca885bca14ba6870ed39a783ab939b5", "patch": "@@ -1,38 +1,32 @@\n-error: unused macro definition\n-  --> $DIR/unused-macro.rs:5:1\n+error: unused macro definition: `unused`\n+  --> $DIR/unused-macro.rs:5:7\n    |\n-LL | / macro unused {\n-LL | |     () => {}\n-LL | | }\n-   | |_^\n+LL | macro unused {\n+   |       ^^^^^^\n    |\n note: the lint level is defined here\n   --> $DIR/unused-macro.rs:2:9\n    |\n LL | #![deny(unused_macros)]\n    |         ^^^^^^^^^^^^^\n \n-error: unused macro definition\n-  --> $DIR/unused-macro.rs:15:5\n+error: unused macro definition: `unused`\n+  --> $DIR/unused-macro.rs:15:11\n    |\n-LL | /     macro unused {\n-LL | |         () => {}\n-LL | |     }\n-   | |_____^\n+LL |     macro unused {\n+   |           ^^^^^^\n    |\n note: the lint level is defined here\n   --> $DIR/unused-macro.rs:14:12\n    |\n LL |     #[deny(unused_macros)]\n    |            ^^^^^^^^^^^^^\n \n-error: unused macro definition\n-  --> $DIR/unused-macro.rs:21:5\n+error: unused macro definition: `unused`\n+  --> $DIR/unused-macro.rs:21:22\n    |\n-LL | /     pub(crate) macro unused {\n-LL | |         () => {}\n-LL | |     }\n-   | |_____^\n+LL |     pub(crate) macro unused {\n+   |                      ^^^^^^\n \n error: aborting due to 3 previous errors\n "}, {"sha": "69bfb4f3cbfbc5b4b77743a81c49f30897a8fd46", "filename": "src/test/ui/proc-macro/issue-39889.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/9f6ca7482ca885bca14ba6870ed39a783ab939b5/src%2Ftest%2Fui%2Fproc-macro%2Fissue-39889.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9f6ca7482ca885bca14ba6870ed39a783ab939b5/src%2Ftest%2Fui%2Fproc-macro%2Fissue-39889.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fproc-macro%2Fissue-39889.rs?ref=9f6ca7482ca885bca14ba6870ed39a783ab939b5", "patch": "@@ -1,6 +1,6 @@\n // run-pass\n \n-#![allow(dead_code)]\n+#![allow(dead_code, unused_macros)]\n // aux-build:issue-39889.rs\n \n extern crate issue_39889;"}]}