{"sha": "5bd9ce5cd4f455a113d41bdf481606fc7545e618", "node_id": "MDY6Q29tbWl0NzI0NzEyOjViZDljZTVjZDRmNDU1YTExM2Q0MWJkZjQ4MTYwNmZjNzU0NWU2MTg=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2020-10-04T13:45:43Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-10-04T13:45:43Z"}, "message": "Rollup merge of #77504 - Amanieu:select_simd_bitmask, r=ecstatic-morse\n\nSupport vectors with fewer than 8 elements for simd_select_bitmask\n\nResolves the issue raised here: https://github.com/rust-lang/stdarch/issues/310#issuecomment-693730094", "tree": {"sha": "daf9a8d1d7ae175d27d98789b5f6ec9ab110122c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/daf9a8d1d7ae175d27d98789b5f6ec9ab110122c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5bd9ce5cd4f455a113d41bdf481606fc7545e618", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfedIHCRBK7hj4Ov3rIwAAdHIIABqIpwIrp3g2N07JZMUCFmw6\nkLTjs1ctIt8Oms7Er/BMFkvnfZY8avqp2POYUbAI+FaQv7i64DJsQD960BQOQXzD\nKnRwNTGg2mignK7zVnJukMPqmG/Fvifvjc2zx8bO73At/y6Jw40utWxmTPqw8RO0\nUnevmiYe57xnv7flBk56vTpfLxIajT80XSZ33Y11zADk69PL3jiXgBTaOZZZfYMs\nUV2oSCIAXFZcO6ZCSoii0YR6FPcjTzFLV8FvQCVkspBLHFVCZm5p8lugsJcnYPbJ\nC/2yAg6eWLsDEnla8osMQPa71haj+ZSjHXpSJyWYp0hXTMbiH0ruz6x/BmC24X8=\n=L4jV\n-----END PGP SIGNATURE-----\n", "payload": "tree daf9a8d1d7ae175d27d98789b5f6ec9ab110122c\nparent 80953177ede031b953b5d3fb77051809f8ef4deb\nparent e41a14412e207aac5f7d686d395bc6a23f643dc9\nauthor Jonas Schievink <jonasschievink@gmail.com> 1601819143 +0200\ncommitter GitHub <noreply@github.com> 1601819143 +0200\n\nRollup merge of #77504 - Amanieu:select_simd_bitmask, r=ecstatic-morse\n\nSupport vectors with fewer than 8 elements for simd_select_bitmask\n\nResolves the issue raised here: https://github.com/rust-lang/stdarch/issues/310#issuecomment-693730094\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5bd9ce5cd4f455a113d41bdf481606fc7545e618", "html_url": "https://github.com/rust-lang/rust/commit/5bd9ce5cd4f455a113d41bdf481606fc7545e618", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5bd9ce5cd4f455a113d41bdf481606fc7545e618/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "80953177ede031b953b5d3fb77051809f8ef4deb", "url": "https://api.github.com/repos/rust-lang/rust/commits/80953177ede031b953b5d3fb77051809f8ef4deb", "html_url": "https://github.com/rust-lang/rust/commit/80953177ede031b953b5d3fb77051809f8ef4deb"}, {"sha": "e41a14412e207aac5f7d686d395bc6a23f643dc9", "url": "https://api.github.com/repos/rust-lang/rust/commits/e41a14412e207aac5f7d686d395bc6a23f643dc9", "html_url": "https://github.com/rust-lang/rust/commit/e41a14412e207aac5f7d686d395bc6a23f643dc9"}], "stats": {"total": 45, "additions": 37, "deletions": 8}, "files": [{"sha": "e76e86f56510ba02ef77c1fa81990bfafe93c670", "filename": "compiler/rustc_codegen_llvm/src/intrinsic.rs", "status": "modified", "additions": 7, "deletions": 3, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/5bd9ce5cd4f455a113d41bdf481606fc7545e618/compiler%2Frustc_codegen_llvm%2Fsrc%2Fintrinsic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bd9ce5cd4f455a113d41bdf481606fc7545e618/compiler%2Frustc_codegen_llvm%2Fsrc%2Fintrinsic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fintrinsic.rs?ref=5bd9ce5cd4f455a113d41bdf481606fc7545e618", "patch": "@@ -793,14 +793,18 @@ fn generic_simd_intrinsic(\n         require_simd!(arg_tys[1], \"argument\");\n         let v_len = arg_tys[1].simd_size(tcx);\n         require!(\n-            m_len == v_len,\n+            // Allow masks for vectors with fewer than 8 elements to be\n+            // represented with a u8 or i8.\n+            m_len == v_len || (m_len == 8 && v_len < 8),\n             \"mismatched lengths: mask length `{}` != other vector length `{}`\",\n             m_len,\n             v_len\n         );\n         let i1 = bx.type_i1();\n-        let i1xn = bx.type_vector(i1, m_len);\n-        let m_i1s = bx.bitcast(args[0].immediate(), i1xn);\n+        let im = bx.type_ix(v_len);\n+        let i1xn = bx.type_vector(i1, v_len);\n+        let m_im = bx.trunc(args[0].immediate(), im);\n+        let m_i1s = bx.bitcast(m_im, i1xn);\n         return Ok(bx.select(m_i1s, args[1].immediate(), args[2].immediate()));\n     }\n "}, {"sha": "7d68af49e2868a8d76c38be186921451c784d739", "filename": "src/test/ui/simd-intrinsic/simd-intrinsic-generic-select.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/5bd9ce5cd4f455a113d41bdf481606fc7545e618/src%2Ftest%2Fui%2Fsimd-intrinsic%2Fsimd-intrinsic-generic-select.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bd9ce5cd4f455a113d41bdf481606fc7545e618/src%2Ftest%2Fui%2Fsimd-intrinsic%2Fsimd-intrinsic-generic-select.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsimd-intrinsic%2Fsimd-intrinsic-generic-select.rs?ref=5bd9ce5cd4f455a113d41bdf481606fc7545e618", "patch": "@@ -49,8 +49,8 @@ fn main() {\n         simd_select(m4, 0u32, 1u32);\n         //~^ ERROR found non-SIMD `u32`\n \n-        simd_select_bitmask(0u8, x, x);\n-        //~^ ERROR mask length `8` != other vector length `4`\n+        simd_select_bitmask(0u16, x, x);\n+        //~^ ERROR mask length `16` != other vector length `4`\n         //\n         simd_select_bitmask(0u8, 1u32, 2u32);\n         //~^ ERROR found non-SIMD `u32`"}, {"sha": "a1ef0bb8ee03bbef2acb06f6db314ec0837b8891", "filename": "src/test/ui/simd-intrinsic/simd-intrinsic-generic-select.stderr", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/5bd9ce5cd4f455a113d41bdf481606fc7545e618/src%2Ftest%2Fui%2Fsimd-intrinsic%2Fsimd-intrinsic-generic-select.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/5bd9ce5cd4f455a113d41bdf481606fc7545e618/src%2Ftest%2Fui%2Fsimd-intrinsic%2Fsimd-intrinsic-generic-select.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsimd-intrinsic%2Fsimd-intrinsic-generic-select.stderr?ref=5bd9ce5cd4f455a113d41bdf481606fc7545e618", "patch": "@@ -22,11 +22,11 @@ error[E0511]: invalid monomorphization of `simd_select` intrinsic: expected SIMD\n LL |         simd_select(m4, 0u32, 1u32);\n    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n-error[E0511]: invalid monomorphization of `simd_select_bitmask` intrinsic: mismatched lengths: mask length `8` != other vector length `4`\n+error[E0511]: invalid monomorphization of `simd_select_bitmask` intrinsic: mismatched lengths: mask length `16` != other vector length `4`\n   --> $DIR/simd-intrinsic-generic-select.rs:52:9\n    |\n-LL |         simd_select_bitmask(0u8, x, x);\n-   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+LL |         simd_select_bitmask(0u16, x, x);\n+   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n error[E0511]: invalid monomorphization of `simd_select_bitmask` intrinsic: expected SIMD argument type, found non-SIMD `u32`\n   --> $DIR/simd-intrinsic-generic-select.rs:55:9"}, {"sha": "b850cf9750a1f665767945c7fcfe53336cd57f8a", "filename": "src/test/ui/simd/simd-intrinsic-generic-select.rs", "status": "modified", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/5bd9ce5cd4f455a113d41bdf481606fc7545e618/src%2Ftest%2Fui%2Fsimd%2Fsimd-intrinsic-generic-select.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bd9ce5cd4f455a113d41bdf481606fc7545e618/src%2Ftest%2Fui%2Fsimd%2Fsimd-intrinsic-generic-select.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsimd%2Fsimd-intrinsic-generic-select.rs?ref=5bd9ce5cd4f455a113d41bdf481606fc7545e618", "patch": "@@ -167,4 +167,29 @@ fn main() {\n         let e = u32x8(8, 9, 10, 11, 4, 5, 6, 7);\n         assert_eq!(r, e);\n     }\n+\n+    unsafe {\n+        let a = u32x4(0, 1, 2, 3);\n+        let b = u32x4(4, 5, 6, 7);\n+\n+        let r: u32x4 = simd_select_bitmask(0u8, a, b);\n+        let e = b;\n+        assert_eq!(r, e);\n+\n+        let r: u32x4 = simd_select_bitmask(0xfu8, a, b);\n+        let e = a;\n+        assert_eq!(r, e);\n+\n+        let r: u32x4 = simd_select_bitmask(0b0101u8, a, b);\n+        let e = u32x4(0, 5, 2, 7);\n+        assert_eq!(r, e);\n+\n+        let r: u32x4 = simd_select_bitmask(0b1010u8, a, b);\n+        let e = u32x4(4, 1, 6, 3);\n+        assert_eq!(r, e);\n+\n+        let r: u32x4 = simd_select_bitmask(0b1100u8, a, b);\n+        let e = u32x4(4, 5, 2, 3);\n+        assert_eq!(r, e);\n+    }\n }"}]}