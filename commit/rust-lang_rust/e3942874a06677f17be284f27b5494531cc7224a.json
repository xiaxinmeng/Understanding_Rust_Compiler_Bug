{"sha": "e3942874a06677f17be284f27b5494531cc7224a", "node_id": "C_kwDOAAsO6NoAKGUzOTQyODc0YTA2Njc3ZjE3YmUyODRmMjdiNTQ5NDUzMWNjNzIyNGE", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume.gomez@huawei.com", "date": "2022-02-05T13:45:29Z"}, "committer": {"name": "Guillaume Gomez", "email": "guillaume.gomez@huawei.com", "date": "2022-02-07T15:50:45Z"}, "message": "Fix horizontal trim for block doc comments", "tree": {"sha": "340a39399b22a43040b0c72ddb3dabae22395acd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/340a39399b22a43040b0c72ddb3dabae22395acd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e3942874a06677f17be284f27b5494531cc7224a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e3942874a06677f17be284f27b5494531cc7224a", "html_url": "https://github.com/rust-lang/rust/commit/e3942874a06677f17be284f27b5494531cc7224a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e3942874a06677f17be284f27b5494531cc7224a/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a00e130dae74a213338e2b095ec855156d8f3d8a", "url": "https://api.github.com/repos/rust-lang/rust/commits/a00e130dae74a213338e2b095ec855156d8f3d8a", "html_url": "https://github.com/rust-lang/rust/commit/a00e130dae74a213338e2b095ec855156d8f3d8a"}], "stats": {"total": 44, "additions": 38, "deletions": 6}, "files": [{"sha": "f51b0086dc8b6d6be5b784c677f93c067505428c", "filename": "compiler/rustc_ast/src/util/comments.rs", "status": "modified", "additions": 11, "deletions": 5, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/e3942874a06677f17be284f27b5494531cc7224a/compiler%2Frustc_ast%2Fsrc%2Futil%2Fcomments.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e3942874a06677f17be284f27b5494531cc7224a/compiler%2Frustc_ast%2Fsrc%2Futil%2Fcomments.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast%2Fsrc%2Futil%2Fcomments.rs?ref=e3942874a06677f17be284f27b5494531cc7224a", "patch": "@@ -43,15 +43,16 @@ pub fn beautify_doc_string(data: Symbol, kind: CommentKind) -> Symbol {\n         if i != 0 || j != lines.len() { Some((i, j)) } else { None }\n     }\n \n-    fn get_horizontal_trim(lines: &[&str], kind: CommentKind) -> Option<usize> {\n+    fn get_horizontal_trim<'a>(lines: &'a [&str], kind: CommentKind) -> Option<String> {\n         let mut i = usize::MAX;\n         let mut first = true;\n \n         // In case we have doc comments like `/**` or `/*!`, we want to remove stars if they are\n         // present. However, we first need to strip the empty lines so they don't get in the middle\n         // when we try to compute the \"horizontal trim\".\n         let lines = if kind == CommentKind::Block {\n-            let mut i = 0;\n+            // Whatever happens, we skip the first line.\n+            let mut i = if lines[0].trim_start().starts_with('*') { 0 } else { 1 };\n             let mut j = lines.len();\n \n             while i < j && lines[i].trim().is_empty() {\n@@ -84,7 +85,7 @@ pub fn beautify_doc_string(data: Symbol, kind: CommentKind) -> Symbol {\n                 return None;\n             }\n         }\n-        Some(i)\n+        if lines.is_empty() { None } else { Some(lines[0][..i].into()) }\n     }\n \n     let data_s = data.as_str();\n@@ -102,8 +103,13 @@ pub fn beautify_doc_string(data: Symbol, kind: CommentKind) -> Symbol {\n             changes = true;\n             // remove a \"[ \\t]*\\*\" block from each line, if possible\n             for line in lines.iter_mut() {\n-                if horizontal + 1 < line.len() {\n-                    *line = &line[horizontal + 1..];\n+                if let Some(tmp) = line.strip_prefix(&horizontal) {\n+                    *line = tmp;\n+                    if kind == CommentKind::Block\n+                        && (*line == \"*\" || line.starts_with(\"* \") || line.starts_with(\"**\"))\n+                    {\n+                        *line = &line[1..];\n+                    }\n                 }\n             }\n         }"}, {"sha": "0b8772947e6e95850e9c41e6cfc030ac803d57d6", "filename": "compiler/rustc_ast/src/util/comments/tests.rs", "status": "modified", "additions": 27, "deletions": 1, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/e3942874a06677f17be284f27b5494531cc7224a/compiler%2Frustc_ast%2Fsrc%2Futil%2Fcomments%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e3942874a06677f17be284f27b5494531cc7224a/compiler%2Frustc_ast%2Fsrc%2Futil%2Fcomments%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast%2Fsrc%2Futil%2Fcomments%2Ftests.rs?ref=e3942874a06677f17be284f27b5494531cc7224a", "patch": "@@ -24,7 +24,7 @@ fn test_block_doc_comment_3() {\n     create_default_session_globals_then(|| {\n         let comment = \"\\n let a: *i32;\\n *a = 5;\\n\";\n         let stripped = beautify_doc_string(Symbol::intern(comment), CommentKind::Block);\n-        assert_eq!(stripped.as_str(), \" let a: *i32;\\n *a = 5;\");\n+        assert_eq!(stripped.as_str(), \"let a: *i32;\\n*a = 5;\");\n     })\n }\n \n@@ -41,3 +41,29 @@ fn test_line_doc_comment() {\n         assert_eq!(stripped.as_str(), \"!test\");\n     })\n }\n+\n+#[test]\n+fn test_doc_blocks() {\n+    create_default_session_globals_then(|| {\n+        let stripped = beautify_doc_string(\n+            Symbol::intern(\n+                \" # Returns\n+     *\n+     \",\n+            ),\n+            CommentKind::Block,\n+        );\n+        assert_eq!(stripped.as_str(), \" # Returns\\n\\n\");\n+\n+        let stripped = beautify_doc_string(\n+            Symbol::intern(\n+                \"\n+     * # Returns\n+     *\n+     \",\n+            ),\n+            CommentKind::Block,\n+        );\n+        assert_eq!(stripped.as_str(), \" # Returns\\n\\n\");\n+    })\n+}"}]}