{"sha": "df4821698e867a468c9237af30cd5bc4a7bc2773", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRmNDgyMTY5OGU4NjdhNDY4YzkyMzdhZjMwY2Q1YmM0YTdiYzI3NzM=", "commit": {"author": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2016-02-26T18:20:56Z"}, "committer": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2016-02-26T18:20:56Z"}, "message": "Permit `pub` items in blocks", "tree": {"sha": "8e3234f41b280485ed386c4d9cf94382337b2e39", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8e3234f41b280485ed386c4d9cf94382337b2e39"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/df4821698e867a468c9237af30cd5bc4a7bc2773", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/df4821698e867a468c9237af30cd5bc4a7bc2773", "html_url": "https://github.com/rust-lang/rust/commit/df4821698e867a468c9237af30cd5bc4a7bc2773", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/df4821698e867a468c9237af30cd5bc4a7bc2773/comments", "author": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "committer": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f59fd4642534e80a61982ce3e10c147d97054212", "url": "https://api.github.com/repos/rust-lang/rust/commits/f59fd4642534e80a61982ce3e10c147d97054212", "html_url": "https://github.com/rust-lang/rust/commit/f59fd4642534e80a61982ce3e10c147d97054212"}], "stats": {"total": 141, "additions": 20, "deletions": 121}, "files": [{"sha": "0b0753ac327e8ec0f768397a45ec31b7c759e223", "filename": "src/librustc_privacy/lib.rs", "status": "modified", "additions": 2, "deletions": 62, "changes": 64, "blob_url": "https://github.com/rust-lang/rust/blob/df4821698e867a468c9237af30cd5bc4a7bc2773/src%2Flibrustc_privacy%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/df4821698e867a468c9237af30cd5bc4a7bc2773/src%2Flibrustc_privacy%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_privacy%2Flib.rs?ref=df4821698e867a468c9237af30cd5bc4a7bc2773", "patch": "@@ -1129,35 +1129,12 @@ impl<'a, 'tcx, 'v> Visitor<'v> for PrivacyVisitor<'a, 'tcx> {\n \n struct SanePrivacyVisitor<'a, 'tcx: 'a> {\n     tcx: &'a ty::ctxt<'tcx>,\n-    in_block: bool,\n }\n \n impl<'a, 'tcx, 'v> Visitor<'v> for SanePrivacyVisitor<'a, 'tcx> {\n-    /// We want to visit items in the context of their containing\n-    /// module and so forth, so supply a crate for doing a deep walk.\n-    fn visit_nested_item(&mut self, item: hir::ItemId) {\n-        self.visit_item(self.tcx.map.expect_item(item.id))\n-    }\n-\n     fn visit_item(&mut self, item: &hir::Item) {\n         self.check_sane_privacy(item);\n-        if self.in_block {\n-            self.check_all_inherited(item);\n-        }\n-\n-        let orig_in_block = self.in_block;\n-\n-        // Modules turn privacy back on, otherwise we inherit\n-        self.in_block = if let hir::ItemMod(..) = item.node { false } else { orig_in_block };\n-\n         intravisit::walk_item(self, item);\n-        self.in_block = orig_in_block;\n-    }\n-\n-    fn visit_block(&mut self, b: &'v hir::Block) {\n-        let orig_in_block = replace(&mut self.in_block, true);\n-        intravisit::walk_block(self, b);\n-        self.in_block = orig_in_block;\n     }\n }\n \n@@ -1206,40 +1183,6 @@ impl<'a, 'tcx> SanePrivacyVisitor<'a, 'tcx> {\n             hir::ItemUse(..) | hir::ItemTy(..) => {}\n         }\n     }\n-\n-    /// When inside of something like a function or a method, visibility has no\n-    /// control over anything so this forbids any mention of any visibility\n-    fn check_all_inherited(&self, item: &hir::Item) {\n-        let check_inherited = |sp, vis| {\n-            if vis != hir::Inherited {\n-                span_err!(self.tcx.sess, sp, E0447,\n-                          \"visibility has no effect inside functions or block expressions\");\n-            }\n-        };\n-\n-        check_inherited(item.span, item.vis);\n-        match item.node {\n-            hir::ItemImpl(_, _, _, _, _, ref impl_items) => {\n-                for impl_item in impl_items {\n-                    check_inherited(impl_item.span, impl_item.vis);\n-                }\n-            }\n-            hir::ItemForeignMod(ref fm) => {\n-                for fi in &fm.items {\n-                    check_inherited(fi.span, fi.vis);\n-                }\n-            }\n-            hir::ItemStruct(ref vdata, _) => {\n-                for f in vdata.fields() {\n-                    check_inherited(f.span, f.node.kind.visibility());\n-                }\n-            }\n-            hir::ItemDefaultImpl(..) | hir::ItemEnum(..) | hir::ItemTrait(..) |\n-            hir::ItemConst(..) | hir::ItemStatic(..) | hir::ItemFn(..) |\n-            hir::ItemMod(..) | hir::ItemExternCrate(..) |\n-            hir::ItemUse(..) | hir::ItemTy(..) => {}\n-        }\n-    }\n }\n \n ///////////////////////////////////////////////////////////////////////////////\n@@ -1823,11 +1766,8 @@ pub fn check_crate(tcx: &ty::ctxt,\n \n     // Sanity check to make sure that all privacy usage and controls are\n     // reasonable.\n-    let mut visitor = SanePrivacyVisitor {\n-        tcx: tcx,\n-        in_block: false,\n-    };\n-    intravisit::walk_crate(&mut visitor, krate);\n+    let mut visitor = SanePrivacyVisitor { tcx: tcx };\n+    krate.visit_all_items(&mut visitor);\n \n     // Figure out who everyone's parent is\n     let mut visitor = ParentVisitor {"}, {"sha": "063848f62aa9ee9f23c5cd100fd0ce657586cd36", "filename": "src/test/compile-fail/privacy-sanity.rs", "status": "modified", "additions": 18, "deletions": 32, "changes": 50, "blob_url": "https://github.com/rust-lang/rust/blob/df4821698e867a468c9237af30cd5bc4a7bc2773/src%2Ftest%2Fcompile-fail%2Fprivacy-sanity.rs", "raw_url": "https://github.com/rust-lang/rust/raw/df4821698e867a468c9237af30cd5bc4a7bc2773/src%2Ftest%2Fcompile-fail%2Fprivacy-sanity.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fprivacy-sanity.rs?ref=df4821698e867a468c9237af30cd5bc4a7bc2773", "patch": "@@ -40,74 +40,60 @@ pub extern \"C\" { //~ ERROR unnecessary visibility qualifier\n \n const MAIN: u8 = {\n     trait MarkerTr {}\n-    pub trait Tr { //~ ERROR visibility has no effect inside functions or block\n+    pub trait Tr {\n         fn f();\n         const C: u8;\n         type T;\n     }\n-    pub struct S { //~ ERROR visibility has no effect inside functions or block\n-        pub a: u8 //~ ERROR visibility has no effect inside functions or block\n+    pub struct S {\n+        pub a: u8\n     }\n-    struct Ts(pub u8); //~ ERROR visibility has no effect inside functions or block\n+    struct Ts(pub u8);\n \n     pub impl MarkerTr for .. {} //~ ERROR unnecessary visibility qualifier\n-    //~^ ERROR visibility has no effect inside functions or block\n     pub impl Tr for S {  //~ ERROR unnecessary visibility qualifier\n-    //~^ ERROR visibility has no effect inside functions or block\n         pub fn f() {} //~ ERROR unnecessary visibility qualifier\n-        //~^ ERROR visibility has no effect inside functions or block\n         pub const C: u8 = 0; //~ ERROR unnecessary visibility qualifier\n-        //~^ ERROR visibility has no effect inside functions or block\n         pub type T = u8; //~ ERROR unnecessary visibility qualifier\n-        //~^ ERROR visibility has no effect inside functions or block\n     }\n     pub impl S { //~ ERROR unnecessary visibility qualifier\n-    //~^ ERROR visibility has no effect inside functions or block\n-        pub fn f() {} //~ ERROR visibility has no effect inside functions or block\n-        pub const C: u8 = 0; //~ ERROR visibility has no effect inside functions or block\n-        // pub type T = u8; // ERROR visibility has no effect inside functions or block\n+        pub fn f() {}\n+        pub const C: u8 = 0;\n+        // pub type T = u8;\n     }\n     pub extern \"C\" { //~ ERROR unnecessary visibility qualifier\n-    //~^ ERROR visibility has no effect inside functions or block\n-        pub fn f(); //~ ERROR visibility has no effect inside functions or block\n-        pub static St: u8; //~ ERROR visibility has no effect inside functions or block\n+        pub fn f();\n+        pub static St: u8;\n     }\n \n     0\n };\n \n fn main() {\n     trait MarkerTr {}\n-    pub trait Tr { //~ ERROR visibility has no effect inside functions or block\n+    pub trait Tr {\n         fn f();\n         const C: u8;\n         type T;\n     }\n-    pub struct S { //~ ERROR visibility has no effect inside functions or block\n-        pub a: u8 //~ ERROR visibility has no effect inside functions or block\n+    pub struct S {\n+        pub a: u8\n     }\n-    struct Ts(pub u8); //~ ERROR visibility has no effect inside functions or block\n+    struct Ts(pub u8);\n \n     pub impl MarkerTr for .. {} //~ ERROR unnecessary visibility qualifier\n-    //~^ ERROR visibility has no effect inside functions or block\n     pub impl Tr for S {  //~ ERROR unnecessary visibility qualifier\n-    //~^ ERROR visibility has no effect inside functions or block\n         pub fn f() {} //~ ERROR unnecessary visibility qualifier\n-        //~^ ERROR visibility has no effect inside functions or block\n         pub const C: u8 = 0; //~ ERROR unnecessary visibility qualifier\n-        //~^ ERROR visibility has no effect inside functions or block\n         pub type T = u8; //~ ERROR unnecessary visibility qualifier\n-        //~^ ERROR visibility has no effect inside functions or block\n     }\n     pub impl S { //~ ERROR unnecessary visibility qualifier\n-    //~^ ERROR visibility has no effect inside functions or block\n-        pub fn f() {} //~ ERROR visibility has no effect inside functions or block\n-        pub const C: u8 = 0; //~ ERROR visibility has no effect inside functions or block\n-        // pub type T = u8; // ERROR visibility has no effect inside functions or block\n+        pub fn f() {}\n+        pub const C: u8 = 0;\n+        // pub type T = u8;\n     }\n     pub extern \"C\" { //~ ERROR unnecessary visibility qualifier\n-    //~^ ERROR visibility has no effect inside functions or block\n-        pub fn f(); //~ ERROR visibility has no effect inside functions or block\n-        pub static St: u8; //~ ERROR visibility has no effect inside functions or block\n+        pub fn f();\n+        pub static St: u8;\n     }\n }"}, {"sha": "113393490cb6de18fb5c3c60dcdcaeca9a530a01", "filename": "src/test/compile-fail/unnecessary-private.rs", "status": "removed", "additions": 0, "deletions": 27, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/f59fd4642534e80a61982ce3e10c147d97054212/src%2Ftest%2Fcompile-fail%2Funnecessary-private.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f59fd4642534e80a61982ce3e10c147d97054212/src%2Ftest%2Fcompile-fail%2Funnecessary-private.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Funnecessary-private.rs?ref=f59fd4642534e80a61982ce3e10c147d97054212", "patch": "@@ -1,27 +0,0 @@\n-// Copyright 2013-2014 The Rust Project Developers. See the COPYRIGHT\n-// file at the top-level directory of this distribution and at\n-// http://rust-lang.org/COPYRIGHT.\n-//\n-// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n-// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n-// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n-// option. This file may not be copied, modified, or distributed\n-// except according to those terms.\n-\n-fn main() {\n-    pub use std::usize; //~ ERROR: visibility has no effect\n-    pub struct A; //~ ERROR: visibility has no effect\n-    pub enum B {} //~ ERROR: visibility has no effect\n-    pub trait C { //~ ERROR: visibility has no effect\n-        fn foo(&self) {}\n-    }\n-    impl A {\n-        pub fn foo(&self) {} //~ ERROR: visibility has no effect\n-    }\n-\n-    struct D {\n-        pub foo: isize, //~ ERROR: visibility has no effect\n-    }\n-    pub fn foo() {} //~ ERROR: visibility has no effect\n-    pub mod bar {} //~ ERROR: visibility has no effect\n-}"}]}