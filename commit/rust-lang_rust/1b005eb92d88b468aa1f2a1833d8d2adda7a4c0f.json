{"sha": "1b005eb92d88b468aa1f2a1833d8d2adda7a4c0f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFiMDA1ZWI5MmQ4OGI0NjhhYTFmMmExODMzZDhkMmFkZGE3YTRjMGY=", "commit": {"author": {"name": "bjorn3", "email": "bjorn3@users.noreply.github.com", "date": "2019-08-09T13:19:06Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-08-09T13:19:06Z"}, "message": "Merge pull request #660 from bjorn3/libtest\n\nLibtest support", "tree": {"sha": "8c4aadc479cc9d31fbbd8e4bfd89d037ee3bd22d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8c4aadc479cc9d31fbbd8e4bfd89d037ee3bd22d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1b005eb92d88b468aa1f2a1833d8d2adda7a4c0f", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJdTXLKCRBK7hj4Ov3rIwAAdHIIABQSCiR4Fvh2VEaKUzI9qRJh\n4qvxXyGO00b+q/kWUzhl+aG8WGRl45QxO++mQM5jzdAlB3MuSr9ysXBozdnl3oCf\nFo1rjtCeU8CzSTsmVuESnZ/trqv0D6irPxKsEWWaZKnUxG1fncXWbUk6qU5tkKxV\njmnET4v58nGX7+2w76ljnLJbD2xJcENw+xCGCJWRdortkf8oKfGFxdoSl4VyDEH+\nQWG7MgL52UlC1vdS2PJpg2RRVTI6sFSaGW/tdv9UuwYCQfJs5m8535ndcDXcgRex\nkYqv7oMyhShY7onjH4YbMOn8t6O5nDln6tDRVFAjQJQFJtKd5tS+PlXWCFf/Nco=\n=huDa\n-----END PGP SIGNATURE-----\n", "payload": "tree 8c4aadc479cc9d31fbbd8e4bfd89d037ee3bd22d\nparent e7a507863c281d571995e10f1e97beca42cb89ac\nparent 82e31e25c01a7a90e572506f2050d7fe0d9bbd3f\nauthor bjorn3 <bjorn3@users.noreply.github.com> 1565356746 +0200\ncommitter GitHub <noreply@github.com> 1565356746 +0200\n\nMerge pull request #660 from bjorn3/libtest\n\nLibtest support"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1b005eb92d88b468aa1f2a1833d8d2adda7a4c0f", "html_url": "https://github.com/rust-lang/rust/commit/1b005eb92d88b468aa1f2a1833d8d2adda7a4c0f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1b005eb92d88b468aa1f2a1833d8d2adda7a4c0f/comments", "author": {"login": "bjorn3", "id": 17426603, "node_id": "MDQ6VXNlcjE3NDI2NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/17426603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bjorn3", "html_url": "https://github.com/bjorn3", "followers_url": "https://api.github.com/users/bjorn3/followers", "following_url": "https://api.github.com/users/bjorn3/following{/other_user}", "gists_url": "https://api.github.com/users/bjorn3/gists{/gist_id}", "starred_url": "https://api.github.com/users/bjorn3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bjorn3/subscriptions", "organizations_url": "https://api.github.com/users/bjorn3/orgs", "repos_url": "https://api.github.com/users/bjorn3/repos", "events_url": "https://api.github.com/users/bjorn3/events{/privacy}", "received_events_url": "https://api.github.com/users/bjorn3/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e7a507863c281d571995e10f1e97beca42cb89ac", "url": "https://api.github.com/repos/rust-lang/rust/commits/e7a507863c281d571995e10f1e97beca42cb89ac", "html_url": "https://github.com/rust-lang/rust/commit/e7a507863c281d571995e10f1e97beca42cb89ac"}, {"sha": "82e31e25c01a7a90e572506f2050d7fe0d9bbd3f", "url": "https://api.github.com/repos/rust-lang/rust/commits/82e31e25c01a7a90e572506f2050d7fe0d9bbd3f", "html_url": "https://github.com/rust-lang/rust/commit/82e31e25c01a7a90e572506f2050d7fe0d9bbd3f"}], "stats": {"total": 119, "additions": 114, "deletions": 5}, "files": [{"sha": "d00d779cb28ae36785853d92483dd26daf467b38", "filename": ".gitignore", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/1b005eb92d88b468aa1f2a1833d8d2adda7a4c0f/.gitignore", "raw_url": "https://github.com/rust-lang/rust/raw/1b005eb92d88b468aa1f2a1833d8d2adda7a4c0f/.gitignore", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.gitignore?ref=1b005eb92d88b468aa1f2a1833d8d2adda7a4c0f", "patch": "@@ -7,5 +7,6 @@ perf.data.old\n /build_sysroot/sysroot\n /build_sysroot/sysroot_src\n /build_sysroot/Cargo.lock\n+/build_sysroot/test_target/Cargo.lock\n /rust\n /regex"}, {"sha": "7776f1bd38309ca918f3a0d45fde903124287b06", "filename": "build_sysroot/Cargo.toml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1b005eb92d88b468aa1f2a1833d8d2adda7a4c0f/build_sysroot%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/1b005eb92d88b468aa1f2a1833d8d2adda7a4c0f/build_sysroot%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/build_sysroot%2FCargo.toml?ref=1b005eb92d88b468aa1f2a1833d8d2adda7a4c0f", "patch": "@@ -7,7 +7,7 @@ version = \"0.0.0\"\n core = { path = \"./sysroot_src/src/libcore\" }\n compiler_builtins = \"0.1\"\n alloc = { path = \"./sysroot_src/src/liballoc\" }\n-std = { path = \"./sysroot_src/src/libstd\" }\n+std = { path = \"./sysroot_src/src/libstd\", features = [\"panic_unwind\"] }\n \n alloc_system = { path = \"./alloc_system\" }\n "}, {"sha": "4e58858f133daf416d6b5055867eaf50d791a0c5", "filename": "build_sysroot/build_sysroot.sh", "status": "modified", "additions": 13, "deletions": 1, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/1b005eb92d88b468aa1f2a1833d8d2adda7a4c0f/build_sysroot%2Fbuild_sysroot.sh", "raw_url": "https://github.com/rust-lang/rust/raw/1b005eb92d88b468aa1f2a1833d8d2adda7a4c0f/build_sysroot%2Fbuild_sysroot.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/build_sysroot%2Fbuild_sysroot.sh?ref=1b005eb92d88b468aa1f2a1833d8d2adda7a4c0f", "patch": "@@ -12,7 +12,8 @@ popd >/dev/null\n # Cleanup for previous run\n #     v Clean target dir except for build scripts and incremental cache\n rm -r target/*/{debug,release}/{build,deps,examples,libsysroot*,native} || true\n-rm Cargo.lock 2>/dev/null || true\n+rm -r sysroot_src/src/{libcore,libtest}/target/$TARGET_TRIPLE/$sysroot_channel/ || true\n+rm Cargo.lock test_target/Cargo.lock 2>/dev/null || true\n rm -r sysroot 2>/dev/null || true\n \n # Build libs\n@@ -28,3 +29,14 @@ fi\n # Copy files to sysroot\n mkdir -p sysroot/lib/rustlib/$TARGET_TRIPLE/lib/\n cp target/$TARGET_TRIPLE/$sysroot_channel/deps/*.rlib sysroot/lib/rustlib/$TARGET_TRIPLE/lib/\n+\n+if [[ \"$1\" == \"--release\" ]]; then\n+    channel='release'\n+    RUSTFLAGS=\"$RUSTFLAGS -Zmir-opt-level=3\" cargo build --target $TARGET_TRIPLE --release --manifest-path ./sysroot_src/src/libtest/Cargo.toml\n+else\n+    channel='debug'\n+    cargo build --target $TARGET_TRIPLE --manifest-path ./sysroot_src/src/libtest/Cargo.toml\n+fi\n+\n+# Copy files to sysroot\n+cp sysroot_src/src/libtest/target/$TARGET_TRIPLE/$sysroot_channel/deps/*.rlib sysroot/lib/rustlib/$TARGET_TRIPLE/lib/"}, {"sha": "de035f52f33f6c199ce8616b1e762680f33ee0e4", "filename": "patches/0017-Fix-libtest-compilation.patch", "status": "added", "additions": 49, "deletions": 0, "changes": 49, "blob_url": "https://github.com/rust-lang/rust/blob/1b005eb92d88b468aa1f2a1833d8d2adda7a4c0f/patches%2F0017-Fix-libtest-compilation.patch", "raw_url": "https://github.com/rust-lang/rust/raw/1b005eb92d88b468aa1f2a1833d8d2adda7a4c0f/patches%2F0017-Fix-libtest-compilation.patch", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/patches%2F0017-Fix-libtest-compilation.patch?ref=1b005eb92d88b468aa1f2a1833d8d2adda7a4c0f", "patch": "@@ -0,0 +1,49 @@\n+From a25405f1fc4a168c9c370524be48aff8c8ebc529 Mon Sep 17 00:00:00 2001\n+From: bjorn3 <bjorn3@users.noreply.github.com>\n+Date: Wed, 12 Jun 2019 18:07:23 +0200\n+Subject: [PATCH] Fix libtest compilation\n+\n+---\n+ src/libtest/lib.rs | 11 +++++------\n+ 1 file changed, 5 insertions(+), 6 deletions(-)\n+\n+diff --git a/src/libtest/lib.rs b/src/libtest/lib.rs\n+index 810a98e..4fdde0e 100644\n+--- a/src/libtest/lib.rs\n++++ b/src/libtest/lib.rs\n+@@ -1441,11 +1441,11 @@ pub fn run_test(\n+         return;\n+     }\n+ \n+-    fn run_test_inner(\n++    fn run_test_inner<F: FnOnce() + Send + 'static>(\n+         desc: TestDesc,\n+         monitor_ch: Sender<MonitorMsg>,\n+         nocapture: bool,\n+-        testfn: Box<dyn FnOnce() + Send>,\n++        testfn: F,\n+         concurrency: Concurrent,\n+     ) {\n+         // Buffer for capturing standard I/O\n+@@ -1500,15 +1500,14 @@ pub fn run_test(\n+                 (benchfn.clone())(harness)\n+             });\n+         }\n+-        DynTestFn(f) => {\n+-            let cb = move || __rust_begin_short_backtrace(f);\n+-            run_test_inner(desc, monitor_ch, opts.nocapture, Box::new(cb), concurrency)\n++        DynTestFn(_f) => {\n++            unimplemented!();\n+         }\n+         StaticTestFn(f) => run_test_inner(\n+             desc,\n+             monitor_ch,\n+             opts.nocapture,\n+-            Box::new(move || __rust_begin_short_backtrace(f)),\n++            move || __rust_begin_short_backtrace(f),\n+             concurrency,\n+         ),\n+     }\n+-- \n+2.11.0\n+"}, {"sha": "19cead46ff718891c0d75ec1e76e44999adbe0c9", "filename": "patches/0018-test-Force-single-thread-mode.patch", "status": "added", "additions": 34, "deletions": 0, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/1b005eb92d88b468aa1f2a1833d8d2adda7a4c0f/patches%2F0018-test-Force-single-thread-mode.patch", "raw_url": "https://github.com/rust-lang/rust/raw/1b005eb92d88b468aa1f2a1833d8d2adda7a4c0f/patches%2F0018-test-Force-single-thread-mode.patch", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/patches%2F0018-test-Force-single-thread-mode.patch?ref=1b005eb92d88b468aa1f2a1833d8d2adda7a4c0f", "patch": "@@ -0,0 +1,34 @@\n+From e275a6ac96bedda2d57296914f2bb736e1e4154c Mon Sep 17 00:00:00 2001\n+From: bjorn3 <bjorn3@users.noreply.github.com>\n+Date: Fri, 9 Aug 2019 13:16:55 +0200\n+Subject: [PATCH] [test] Force single thread mode\n+\n+---\n+ src/libtest/lib.rs | 11 +----------\n+ 1 file changed, 1 insertion(+), 10 deletions(-)\n+\n+diff --git a/src/libtest/lib.rs b/src/libtest/lib.rs\n+index 8d74d9a..c7a3c23 100644\n+--- a/src/libtest/lib.rs\n++++ b/src/libtest/lib.rs\n+@@ -1419,16 +1419,7 @@ pub fn run_test(\n+                 .unwrap();\n+         };\n+ \n+-        // If the platform is single-threaded we're just going to run\n+-        // the test synchronously, regardless of the concurrency\n+-        // level.\n+-        let supports_threads = !cfg!(target_os = \"emscripten\") && !cfg!(target_arch = \"wasm32\");\n+-        if concurrency == Concurrent::Yes && supports_threads {\n+-            let cfg = thread::Builder::new().name(name.as_slice().to_owned());\n+-            cfg.spawn(runtest).unwrap();\n+-        } else {\n+-            runtest();\n+-        }\n++        runtest();\n+     }\n+ \n+     match testfn {\n+-- \n+2.20.1\n+"}, {"sha": "5beabfb5ee2f4371587af6e371322858fc96144e", "filename": "src/intrinsics.rs", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/1b005eb92d88b468aa1f2a1833d8d2adda7a4c0f/src%2Fintrinsics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1b005eb92d88b468aa1f2a1833d8d2adda7a4c0f/src%2Fintrinsics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fintrinsics.rs?ref=1b005eb92d88b468aa1f2a1833d8d2adda7a4c0f", "patch": "@@ -1011,6 +1011,20 @@ pub fn codegen_intrinsic_call<'a, 'tcx: 'a>(\n         simd_fmax, (c x, c y) {\n             simd_flt_binop!(fx, intrinsic, fmax(x, y) -> ret);\n         };\n+\n+        try, (v f, v data, v _local_ptr) {\n+            // FIXME once unwinding is supported, change this to actually catch panics\n+            let f_sig = fx.bcx.func.import_signature(Signature {\n+                call_conv: cranelift::codegen::isa::CallConv::SystemV,\n+                params: vec![AbiParam::new(fx.bcx.func.dfg.value_type(data))],\n+                returns: vec![],\n+            });\n+\n+            fx.bcx.ins().call_indirect(f_sig, f, &[data]);\n+\n+            let ret_val = CValue::const_val(fx, ret.layout().ty, 0);\n+            ret.write_cvalue(fx, ret_val);\n+        };\n     }\n \n     if let Some((_, dest)) = destination {"}, {"sha": "8d1f41537197a7e74a79e66c9648963d3d100c03", "filename": "test.sh", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/1b005eb92d88b468aa1f2a1833d8d2adda7a4c0f/test.sh", "raw_url": "https://github.com/rust-lang/rust/raw/1b005eb92d88b468aa1f2a1833d8d2adda7a4c0f/test.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/test.sh?ref=1b005eb92d88b468aa1f2a1833d8d2adda7a4c0f", "patch": "@@ -58,9 +58,8 @@ echo \"[TEST] rust-lang/regex example shootout-regex-dna\"\n cat examples/regexdna-input.txt | ../cargo.sh run --example shootout-regex-dna > res.txt\n diff -u res.txt examples/regexdna-output.txt\n \n-# FIXME compile libtest\n-# echo \"[TEST] rust-lang/regex standalone tests\"\n-# ../cargo.sh test\n+echo \"[TEST] rust-lang/regex standalone tests\"\n+../cargo.sh test --tests -- --exclude-should-panic --test-threads 1 -Zunstable-options\n popd\n \n COMPILE_MOD_BENCH_INLINE=\"$RUSTC example/mod_bench.rs --crate-type bin -Zmir-opt-level=3 -O --crate-name mod_bench_inline\""}]}