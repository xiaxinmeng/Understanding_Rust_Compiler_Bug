{"sha": "72de69e04641823c8e8fb1eafa8f4bd53c77f867", "node_id": "C_kwDOAAsO6NoAKDcyZGU2OWUwNDY0MTgyM2M4ZThmYjFlYWZhOGY0YmQ1M2M3N2Y4Njc", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2023-04-29T13:51:17Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-04-29T13:51:17Z"}, "message": "Rollup merge of #110979 - jyn514:windows-locking, r=ChrisDenton\n\nwindows: kill rust-analyzer-proc-macro-srv before deleting stage0 directory\n\nThis fixes the following recurring error on windows:\n```\nTraceback (most recent call last):\n  File \"C:\\Users\\jyn\\src\\rust\\x.py\", line 29, in <module>\n    bootstrap.main()\n  File \"C:\\Users\\jyn\\src\\rust\\src\\bootstrap\\bootstrap.py\", line 963, in main\n    bootstrap(args)\n  File \"C:\\Users\\jyn\\src\\rust\\src\\bootstrap\\bootstrap.py\", line 927, in bootstrap\n    build.download_toolchain()\n  File \"C:\\Users\\jyn\\src\\rust\\src\\bootstrap\\bootstrap.py\", line 437, in download_toolchain\n    shutil.rmtree(bin_root)\n  File \"C:\\Users\\jyn\\AppData\\Local\\Programs\\Python\\Python311\\Lib\\shutil.py\", line 759, in rmtree\n    return _rmtree_unsafe(path, onerror)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\jyn\\AppData\\Local\\Programs\\Python\\Python311\\Lib\\shutil.py\", line 617, in _rmtree_unsafe\n    _rmtree_unsafe(fullname, onerror)\n  File \"C:\\Users\\jyn\\AppData\\Local\\Programs\\Python\\Python311\\Lib\\shutil.py\", line 622, in _rmtree_unsafe\n    onerror(os.unlink, fullname, sys.exc_info())\n  File \"C:\\Users\\jyn\\AppData\\Local\\Programs\\Python\\Python311\\Lib\\shutil.py\", line 620, in _rmtree_unsafe\n    os.unlink(fullname)\nPermissionError: [WinError 5] Access is denied: 'C:\\\\Users\\\\jyn\\\\src\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage0\\\\bin\\\\rust-analyzer-proc-macro-srv.exe'\n```\n\nFixes https://github.com/rust-lang/rust/issues/107018.\n\nr? ```@ChrisDenton```", "tree": {"sha": "d2a535801a009d669229671d4a672b3f90487c17", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d2a535801a009d669229671d4a672b3f90487c17"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/72de69e04641823c8e8fb1eafa8f4bd53c77f867", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkTSDVCRBK7hj4Ov3rIwAAM7cIADAEbuqQWQDDnyF3M0hIGBLa\nfcp0lvgLbkR4cIL02QlQul5vOpjbjhHnoDK0NTzlGVgYkrwyGCtPUnJIz8G+urPz\njDg9tl7kx+XZ1D92US8Gt2KaiujRnp5IUvsCTow9yW0skWB8yjyLDQgv0jsQAFEM\n74FCZN/5YAiYg3owe91OMMATEgmX3sn6mcmRNK6dgwviZlCTC7bzWJFVjR7DqwQL\n0+ngCmm4FTYRqAVKjoNdhoS7dXeLlfuaFhaF/C0QD9VWln+/7obNKYJh7KO4cDA+\n4ZTL48zPywTgwEsPlXeCijaGBVVqOFdxUBp+QJ1kgJCugMxp+wRjFMG8+gvFdl4=\n=HEm2\n-----END PGP SIGNATURE-----\n", "payload": "tree d2a535801a009d669229671d4a672b3f90487c17\nparent 39ed894926c4e1bc40667e54175d405ad8c4e41c\nparent 500c19c8ee2ed864fc21ac98d152e0ed19e849ea\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1682776277 +0200\ncommitter GitHub <noreply@github.com> 1682776277 +0200\n\nRollup merge of #110979 - jyn514:windows-locking, r=ChrisDenton\n\nwindows: kill rust-analyzer-proc-macro-srv before deleting stage0 directory\n\nThis fixes the following recurring error on windows:\n```\nTraceback (most recent call last):\n  File \"C:\\Users\\jyn\\src\\rust\\x.py\", line 29, in <module>\n    bootstrap.main()\n  File \"C:\\Users\\jyn\\src\\rust\\src\\bootstrap\\bootstrap.py\", line 963, in main\n    bootstrap(args)\n  File \"C:\\Users\\jyn\\src\\rust\\src\\bootstrap\\bootstrap.py\", line 927, in bootstrap\n    build.download_toolchain()\n  File \"C:\\Users\\jyn\\src\\rust\\src\\bootstrap\\bootstrap.py\", line 437, in download_toolchain\n    shutil.rmtree(bin_root)\n  File \"C:\\Users\\jyn\\AppData\\Local\\Programs\\Python\\Python311\\Lib\\shutil.py\", line 759, in rmtree\n    return _rmtree_unsafe(path, onerror)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\jyn\\AppData\\Local\\Programs\\Python\\Python311\\Lib\\shutil.py\", line 617, in _rmtree_unsafe\n    _rmtree_unsafe(fullname, onerror)\n  File \"C:\\Users\\jyn\\AppData\\Local\\Programs\\Python\\Python311\\Lib\\shutil.py\", line 622, in _rmtree_unsafe\n    onerror(os.unlink, fullname, sys.exc_info())\n  File \"C:\\Users\\jyn\\AppData\\Local\\Programs\\Python\\Python311\\Lib\\shutil.py\", line 620, in _rmtree_unsafe\n    os.unlink(fullname)\nPermissionError: [WinError 5] Access is denied: 'C:\\\\Users\\\\jyn\\\\src\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\stage0\\\\bin\\\\rust-analyzer-proc-macro-srv.exe'\n```\n\nFixes https://github.com/rust-lang/rust/issues/107018.\n\nr? ```@ChrisDenton```\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/72de69e04641823c8e8fb1eafa8f4bd53c77f867", "html_url": "https://github.com/rust-lang/rust/commit/72de69e04641823c8e8fb1eafa8f4bd53c77f867", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/72de69e04641823c8e8fb1eafa8f4bd53c77f867/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "39ed894926c4e1bc40667e54175d405ad8c4e41c", "url": "https://api.github.com/repos/rust-lang/rust/commits/39ed894926c4e1bc40667e54175d405ad8c4e41c", "html_url": "https://github.com/rust-lang/rust/commit/39ed894926c4e1bc40667e54175d405ad8c4e41c"}, {"sha": "500c19c8ee2ed864fc21ac98d152e0ed19e849ea", "url": "https://api.github.com/repos/rust-lang/rust/commits/500c19c8ee2ed864fc21ac98d152e0ed19e849ea", "html_url": "https://github.com/rust-lang/rust/commit/500c19c8ee2ed864fc21ac98d152e0ed19e849ea"}], "stats": {"total": 35, "additions": 29, "deletions": 6}, "files": [{"sha": "ff261ab9832737cb347092c497bbc7fc775e2079", "filename": "src/bootstrap/bootstrap.py", "status": "modified", "additions": 29, "deletions": 6, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/72de69e04641823c8e8fb1eafa8f4bd53c77f867/src%2Fbootstrap%2Fbootstrap.py", "raw_url": "https://github.com/rust-lang/rust/raw/72de69e04641823c8e8fb1eafa8f4bd53c77f867/src%2Fbootstrap%2Fbootstrap.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbootstrap.py?ref=72de69e04641823c8e8fb1eafa8f4bd53c77f867", "patch": "@@ -19,7 +19,10 @@\n except ImportError:\n     lzma = None\n \n-if sys.platform == 'win32':\n+def platform_is_win32():\n+    return sys.platform == 'win32'\n+\n+if platform_is_win32():\n     EXE_SUFFIX = \".exe\"\n else:\n     EXE_SUFFIX = \"\"\n@@ -78,15 +81,14 @@ def _download(path, url, probably_big, verbose, exception):\n     if probably_big or verbose:\n         print(\"downloading {}\".format(url))\n \n-    platform_is_win32 = sys.platform == 'win32'\n     try:\n         if probably_big or verbose:\n             option = \"-#\"\n         else:\n             option = \"-s\"\n         # If curl is not present on Win32, we should not sys.exit\n         #   but raise `CalledProcessError` or `OSError` instead\n-        require([\"curl\", \"--version\"], exception=platform_is_win32)\n+        require([\"curl\", \"--version\"], exception=platform_is_win32())\n         with open(path, \"wb\") as outfile:\n             run([\"curl\", option,\n                 \"-L\", # Follow redirect.\n@@ -99,8 +101,8 @@ def _download(path, url, probably_big, verbose, exception):\n             )\n     except (subprocess.CalledProcessError, OSError, RuntimeError):\n         # see http://serverfault.com/questions/301128/how-to-download\n-        if platform_is_win32:\n-            run([\"PowerShell.exe\", \"/nologo\", \"-Command\",\n+        if platform_is_win32():\n+            run_powershell([\n                  \"[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12;\",\n                  \"(New-Object System.Net.WebClient).DownloadFile('{}', '{}')\".format(url, path)],\n                 verbose=verbose,\n@@ -174,6 +176,10 @@ def run(args, verbose=False, exception=False, is_bootstrap=False, **kwargs):\n         else:\n             sys.exit(err)\n \n+def run_powershell(script, *args, **kwargs):\n+    \"\"\"Run a powershell script\"\"\"\n+    run([\"PowerShell.exe\", \"/nologo\", \"-Command\"] + script, *args, **kwargs)\n+\n \n def require(cmd, exit=True, exception=False):\n     '''Run a command, returning its output.\n@@ -229,7 +235,7 @@ def default_build_triple(verbose):\n                 print(\"pre-installed rustc not detected: {}\".format(e))\n                 print(\"falling back to auto-detect\")\n \n-    required = sys.platform != 'win32'\n+    required = not platform_is_win32()\n     ostype = require([\"uname\", \"-s\"], exit=required)\n     cputype = require(['uname', '-m'], exit=required)\n \n@@ -434,6 +440,23 @@ def download_toolchain(self):\n                 (not os.path.exists(self.rustc()) or\n                  self.program_out_of_date(self.rustc_stamp(), key)):\n             if os.path.exists(bin_root):\n+                # HACK: On Windows, we can't delete rust-analyzer-proc-macro-server while it's\n+                # running. Kill it.\n+                if platform_is_win32():\n+                    print(\"Killing rust-analyzer-proc-macro-srv before deleting stage0 toolchain\")\n+                    regex =  '{}\\\\\\\\(host|{})\\\\\\\\stage0\\\\\\\\libexec'.format(\n+                        os.path.basename(self.build_dir),\n+                        self.build\n+                    )\n+                    script = (\n+                        # NOTE: can't use `taskkill` or `Get-Process -Name` because they error if\n+                        # the server isn't running.\n+                        'Get-Process | ' +\n+                        'Where-Object {$_.Name -eq \"rust-analyzer-proc-macro-srv\"} |' +\n+                        'Where-Object {{$_.Path -match \"{}\"}} |'.format(regex) +\n+                        'Stop-Process'\n+                    )\n+                    run_powershell([script])\n                 shutil.rmtree(bin_root)\n             tarball_suffix = '.tar.gz' if lzma is None else '.tar.xz'\n             filename = \"rust-std-{}-{}{}\".format("}]}