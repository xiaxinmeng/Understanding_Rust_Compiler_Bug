{"sha": "bf96d46fee1242ad701cb037a03c9575e84221b1", "node_id": "MDY6Q29tbWl0NzI0NzEyOmJmOTZkNDZmZWUxMjQyYWQ3MDFjYjAzN2EwM2M5NTc1ZTg0MjIxYjE=", "commit": {"author": {"name": "Leander Tentrup", "email": "leander.tentrup@gmail.com", "date": "2020-04-06T21:00:09Z"}, "committer": {"name": "Leander Tentrup", "email": "leander.tentrup@gmail.com", "date": "2020-04-06T21:00:09Z"}, "message": "Simplify HTML highlighter and add test case for highlight_injection logic", "tree": {"sha": "bd01242f4e504b25d07a3d193b6715443f7b2b86", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bd01242f4e504b25d07a3d193b6715443f7b2b86"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bf96d46fee1242ad701cb037a03c9575e84221b1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bf96d46fee1242ad701cb037a03c9575e84221b1", "html_url": "https://github.com/rust-lang/rust/commit/bf96d46fee1242ad701cb037a03c9575e84221b1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bf96d46fee1242ad701cb037a03c9575e84221b1/comments", "author": {"login": "ltentrup", "id": 201808, "node_id": "MDQ6VXNlcjIwMTgwOA==", "avatar_url": "https://avatars.githubusercontent.com/u/201808?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ltentrup", "html_url": "https://github.com/ltentrup", "followers_url": "https://api.github.com/users/ltentrup/followers", "following_url": "https://api.github.com/users/ltentrup/following{/other_user}", "gists_url": "https://api.github.com/users/ltentrup/gists{/gist_id}", "starred_url": "https://api.github.com/users/ltentrup/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ltentrup/subscriptions", "organizations_url": "https://api.github.com/users/ltentrup/orgs", "repos_url": "https://api.github.com/users/ltentrup/repos", "events_url": "https://api.github.com/users/ltentrup/events{/privacy}", "received_events_url": "https://api.github.com/users/ltentrup/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ltentrup", "id": 201808, "node_id": "MDQ6VXNlcjIwMTgwOA==", "avatar_url": "https://avatars.githubusercontent.com/u/201808?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ltentrup", "html_url": "https://github.com/ltentrup", "followers_url": "https://api.github.com/users/ltentrup/followers", "following_url": "https://api.github.com/users/ltentrup/following{/other_user}", "gists_url": "https://api.github.com/users/ltentrup/gists{/gist_id}", "starred_url": "https://api.github.com/users/ltentrup/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ltentrup/subscriptions", "organizations_url": "https://api.github.com/users/ltentrup/orgs", "repos_url": "https://api.github.com/users/ltentrup/repos", "events_url": "https://api.github.com/users/ltentrup/events{/privacy}", "received_events_url": "https://api.github.com/users/ltentrup/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "bb45aca9093ffe61cf444d538b3de737117c9a64", "url": "https://api.github.com/repos/rust-lang/rust/commits/bb45aca9093ffe61cf444d538b3de737117c9a64", "html_url": "https://github.com/rust-lang/rust/commit/bb45aca9093ffe61cf444d538b3de737117c9a64"}], "stats": {"total": 156, "additions": 97, "deletions": 59}, "files": [{"sha": "6ec13bd80fbfb188b874add97e889120a1265f82", "filename": "crates/ra_ide/src/snapshots/highlight_injection.html", "status": "added", "additions": 39, "deletions": 0, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/bf96d46fee1242ad701cb037a03c9575e84221b1/crates%2Fra_ide%2Fsrc%2Fsnapshots%2Fhighlight_injection.html", "raw_url": "https://github.com/rust-lang/rust/raw/bf96d46fee1242ad701cb037a03c9575e84221b1/crates%2Fra_ide%2Fsrc%2Fsnapshots%2Fhighlight_injection.html", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fsnapshots%2Fhighlight_injection.html?ref=bf96d46fee1242ad701cb037a03c9575e84221b1", "patch": "@@ -0,0 +1,39 @@\n+\n+<style>\n+body                { margin: 0; }\n+pre                 { color: #DCDCCC; background: #3F3F3F; font-size: 22px; padding: 0.4em; }\n+\n+.lifetime           { color: #DFAF8F; font-style: italic; }\n+.comment            { color: #7F9F7F; }\n+.struct, .enum      { color: #7CB8BB; }\n+.enum_variant       { color: #BDE0F3; }\n+.string_literal     { color: #CC9393; }\n+.field              { color: #94BFF3; }\n+.function           { color: #93E0E3; }\n+.parameter          { color: #94BFF3; }\n+.text               { color: #DCDCCC; }\n+.type               { color: #7CB8BB; }\n+.builtin_type       { color: #8CD0D3; }\n+.type_param         { color: #DFAF8F; }\n+.attribute          { color: #94BFF3; }\n+.numeric_literal    { color: #BFEBBF; }\n+.macro              { color: #94BFF3; }\n+.module             { color: #AFD8AF; }\n+.variable           { color: #DCDCCC; }\n+.mutable            { text-decoration: underline; }\n+\n+.keyword            { color: #F0DFAF; font-weight: bold; }\n+.keyword.unsafe     { color: #BC8383; font-weight: bold; }\n+.control            { font-style: italic; }\n+</style>\n+<pre><code><span class=\"keyword\">fn</span> <span class=\"function declaration\">fixture</span>(<span class=\"variable declaration\">ra_fixture</span>: &<span class=\"builtin_type\">str</span>) {}\n+\n+<span class=\"keyword\">fn</span> <span class=\"function declaration\">main</span>() {\n+    <span class=\"function\">fixture</span>(<span class=\"string_literal\">r#\"</span>\n+        <span class=\"keyword\">trait</span> <span class=\"trait declaration\">Foo</span> {\n+            <span class=\"keyword\">fn</span> <span class=\"function declaration\">foo</span>() {\n+                <span class=\"macro\">println!</span>(<span class=\"string_literal\">\"2 + 2 = {}\"</span>, <span class=\"numeric_literal\">4</span>);\n+            }\n+        }<span class=\"string_literal\">\"#</span>\n+    );\n+}</code></pre>\n\\ No newline at end of file"}, {"sha": "214dcbb620c32e725336dbbfe3caade697cd63ea", "filename": "crates/ra_ide/src/snapshots/highlighting.html", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/bf96d46fee1242ad701cb037a03c9575e84221b1/crates%2Fra_ide%2Fsrc%2Fsnapshots%2Fhighlighting.html", "raw_url": "https://github.com/rust-lang/rust/raw/bf96d46fee1242ad701cb037a03c9575e84221b1/crates%2Fra_ide%2Fsrc%2Fsnapshots%2Fhighlighting.html", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fsnapshots%2Fhighlighting.html?ref=bf96d46fee1242ad701cb037a03c9575e84221b1", "patch": "@@ -26,7 +26,7 @@\n .keyword.unsafe     { color: #BC8383; font-weight: bold; }\n .control            { font-style: italic; }\n </style>\n-<pre><code><span class=\"attribute\">#</span><span class=\"attribute\">[</span><span class=\"attribute\">derive</span><span class=\"attribute\">(</span><span class=\"attribute\">Clone</span><span class=\"attribute\">,</span><span class=\"attribute\"> </span><span class=\"attribute\">Debug</span><span class=\"attribute\">)</span><span class=\"attribute\">]</span>\n+<pre><code><span class=\"attribute\">#[derive(Clone, Debug)]</span>\n <span class=\"keyword\">struct</span> <span class=\"struct declaration\">Foo</span> {\n     <span class=\"keyword\">pub</span> <span class=\"field declaration\">x</span>: <span class=\"builtin_type\">i32</span>,\n     <span class=\"keyword\">pub</span> <span class=\"field declaration\">y</span>: <span class=\"builtin_type\">i32</span>,\n@@ -36,19 +36,19 @@\n     <span class=\"function\">foo</span>::&lt;<span class=\"lifetime\">'a</span>, <span class=\"builtin_type\">i32</span>&gt;()\n }\n \n-<span class=\"macro\">macro_rules</span><span class=\"macro\">!</span> def_fn {\n+<span class=\"macro\">macro_rules!</span> def_fn {\n     ($($tt:tt)*) =&gt; {$($tt)*}\n }\n \n-<span class=\"macro\">def_fn</span><span class=\"macro\">!</span> {\n+<span class=\"macro\">def_fn!</span> {\n     <span class=\"keyword\">fn</span> <span class=\"function declaration\">bar</span>() -&gt; <span class=\"builtin_type\">u32</span> {\n         <span class=\"numeric_literal\">100</span>\n     }\n }\n \n <span class=\"comment\">// comment</span>\n <span class=\"keyword\">fn</span> <span class=\"function declaration\">main</span>() {\n-    <span class=\"macro\">println</span><span class=\"macro\">!</span>(<span class=\"string_literal\">\"Hello, {}!\"</span>, <span class=\"numeric_literal\">92</span>);\n+    <span class=\"macro\">println!</span>(<span class=\"string_literal\">\"Hello, {}!\"</span>, <span class=\"numeric_literal\">92</span>);\n \n     <span class=\"keyword\">let</span> <span class=\"keyword\">mut</span> <span class=\"variable declaration mutable\">vec</span> = Vec::new();\n     <span class=\"keyword control\">if</span> <span class=\"keyword\">true</span> {\n@@ -73,7 +73,7 @@\n <span class=\"keyword\">impl</span>&lt;<span class=\"type_param declaration\">T</span>&gt; <span class=\"enum\">Option</span>&lt;<span class=\"type_param\">T</span>&gt; {\n     <span class=\"keyword\">fn</span> <span class=\"function declaration\">and</span>&lt;<span class=\"type_param declaration\">U</span>&gt;(<span class=\"keyword\">self</span>, <span class=\"variable declaration\">other</span>: <span class=\"enum\">Option</span>&lt;<span class=\"type_param\">U</span>&gt;) -&gt; <span class=\"enum\">Option</span>&lt;(<span class=\"type_param\">T</span>, <span class=\"type_param\">U</span>)&gt; {\n         <span class=\"keyword control\">match</span> <span class=\"variable\">other</span> {\n-            <span class=\"enum_variant\">None</span> =&gt; <span class=\"macro\">unimplemented</span><span class=\"macro\">!</span>(),\n+            <span class=\"enum_variant\">None</span> =&gt; <span class=\"macro\">unimplemented!</span>(),\n             <span class=\"variable declaration\">Nope</span> =&gt; <span class=\"variable\">Nope</span>,\n         }\n     }"}, {"sha": "7d908f987aafcbaacc62773fb3fcb35578d9ceab", "filename": "crates/ra_ide/src/syntax_highlighting.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/bf96d46fee1242ad701cb037a03c9575e84221b1/crates%2Fra_ide%2Fsrc%2Fsyntax_highlighting.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bf96d46fee1242ad701cb037a03c9575e84221b1/crates%2Fra_ide%2Fsrc%2Fsyntax_highlighting.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fsyntax_highlighting.rs?ref=bf96d46fee1242ad701cb037a03c9575e84221b1", "patch": "@@ -174,7 +174,13 @@ pub(crate) fn highlight(\n     }\n \n     assert_eq!(res.len(), 1, \"after DFS traversal, the stack should only contain a single element\");\n-    res.pop().unwrap()\n+    let res = res.pop().unwrap();\n+    // Check that ranges are sorted and disjoint\n+    assert!(res\n+        .iter()\n+        .zip(res.iter().skip(1))\n+        .all(|(left, right)| left.range.end() <= right.range.start()));\n+    res\n }\n \n fn macro_call_range(macro_call: &ast::MacroCall) -> Option<TextRange> {"}, {"sha": "4496529a101e77fdff2e6e9d451a19d17e832c85", "filename": "crates/ra_ide/src/syntax_highlighting/html.rs", "status": "modified", "additions": 25, "deletions": 41, "changes": 66, "blob_url": "https://github.com/rust-lang/rust/blob/bf96d46fee1242ad701cb037a03c9575e84221b1/crates%2Fra_ide%2Fsrc%2Fsyntax_highlighting%2Fhtml.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bf96d46fee1242ad701cb037a03c9575e84221b1/crates%2Fra_ide%2Fsrc%2Fsyntax_highlighting%2Fhtml.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fsyntax_highlighting%2Fhtml.rs?ref=bf96d46fee1242ad701cb037a03c9575e84221b1", "patch": "@@ -1,9 +1,9 @@\n //! Renders a bit of code as HTML.\n \n use ra_db::SourceDatabase;\n-use ra_syntax::AstNode;\n+use ra_syntax::{AstNode, TextUnit};\n \n-use crate::{FileId, HighlightedRange, RootDatabase};\n+use crate::{FileId, RootDatabase};\n \n use super::highlight;\n \n@@ -21,51 +21,35 @@ pub(crate) fn highlight_as_html(db: &RootDatabase, file_id: FileId, rainbow: boo\n         )\n     }\n \n-    let mut ranges = highlight(db, file_id, None);\n-    ranges.sort_by_key(|it| it.range.start());\n-    // quick non-optimal heuristic to intersect token ranges and highlighted ranges\n-    let mut frontier = 0;\n-    let mut could_intersect: Vec<&HighlightedRange> = Vec::new();\n-\n+    let ranges = highlight(db, file_id, None);\n+    let text = parse.tree().syntax().to_string();\n+    let mut prev_pos = TextUnit::from(0);\n     let mut buf = String::new();\n     buf.push_str(&STYLE);\n     buf.push_str(\"<pre><code>\");\n-    let tokens = parse.tree().syntax().descendants_with_tokens().filter_map(|it| it.into_token());\n-    for token in tokens {\n-        could_intersect.retain(|it| token.text_range().start() <= it.range.end());\n-        while let Some(r) = ranges.get(frontier) {\n-            if r.range.start() <= token.text_range().end() {\n-                could_intersect.push(r);\n-                frontier += 1;\n-            } else {\n-                break;\n-            }\n-        }\n-        let text = html_escape(&token.text());\n-        let ranges = could_intersect\n-            .iter()\n-            .filter(|it| token.text_range().is_subrange(&it.range))\n-            .collect::<Vec<_>>();\n-        if ranges.is_empty() {\n+    for range in &ranges {\n+        if range.range.start() > prev_pos {\n+            let curr = &text[prev_pos.to_usize()..range.range.start().to_usize()];\n+            let text = html_escape(curr);\n             buf.push_str(&text);\n-        } else {\n-            let classes = ranges\n-                .iter()\n-                .map(|it| it.highlight.to_string().replace('.', \" \"))\n-                .collect::<Vec<_>>()\n-                .join(\" \");\n-            let binding_hash = ranges.first().and_then(|x| x.binding_hash);\n-            let color = match (rainbow, binding_hash) {\n-                (true, Some(hash)) => format!(\n-                    \" data-binding-hash=\\\"{}\\\" style=\\\"color: {};\\\"\",\n-                    hash,\n-                    rainbowify(hash)\n-                ),\n-                _ => \"\".into(),\n-            };\n-            buf.push_str(&format!(\"<span class=\\\"{}\\\"{}>{}</span>\", classes, color, text));\n         }\n+        let curr = &text[range.range.start().to_usize()..range.range.end().to_usize()];\n+\n+        let class = range.highlight.to_string().replace('.', \" \");\n+        let color = match (rainbow, range.binding_hash) {\n+            (true, Some(hash)) => {\n+                format!(\" data-binding-hash=\\\"{}\\\" style=\\\"color: {};\\\"\", hash, rainbowify(hash))\n+            }\n+            _ => \"\".into(),\n+        };\n+        buf.push_str(&format!(\"<span class=\\\"{}\\\"{}>{}</span>\", class, color, html_escape(curr)));\n+\n+        prev_pos = range.range.end();\n     }\n+    // Add the remaining (non-highlighted) text\n+    let curr = &text[prev_pos.to_usize()..];\n+    let text = html_escape(curr);\n+    buf.push_str(&text);\n     buf.push_str(\"</code></pre>\");\n     buf\n }"}, {"sha": "110887c2ac4230aa21eec5b056788eae676f8323", "filename": "crates/ra_ide/src/syntax_highlighting/tests.rs", "status": "modified", "additions": 21, "deletions": 12, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/bf96d46fee1242ad701cb037a03c9575e84221b1/crates%2Fra_ide%2Fsrc%2Fsyntax_highlighting%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bf96d46fee1242ad701cb037a03c9575e84221b1/crates%2Fra_ide%2Fsrc%2Fsyntax_highlighting%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fsyntax_highlighting%2Ftests.rs?ref=bf96d46fee1242ad701cb037a03c9575e84221b1", "patch": "@@ -134,16 +134,25 @@ fn test_ranges() {\n \n #[test]\n fn test_flattening() {\n-    let (analysis, file_id) = single_file(r#\"#[cfg(feature = \"foo\")]\"#);\n-\n-    let highlights = analysis.highlight(file_id).unwrap();\n-\n-    // The source code snippet contains 2 nested highlights:\n-    // 1) Attribute spanning the whole string\n-    // 2) The string \"foo\"\n-    // The resulting flattening splits the attribute range:\n-    assert_eq!(highlights.len(), 3);\n-    assert_eq!(&highlights[0].highlight.to_string(), \"attribute\");\n-    assert_eq!(&highlights[1].highlight.to_string(), \"string_literal\");\n-    assert_eq!(&highlights[2].highlight.to_string(), \"attribute\");\n+    let (analysis, file_id) = single_file(\n+        r##\"\n+fn fixture(ra_fixture: &str) {}\n+\n+fn main() {\n+    fixture(r#\"\n+        trait Foo {\n+            fn foo() {\n+                println!(\"2 + 2 = {}\", 4);\n+            }\n+        }\"#\n+    );\n+}\"##\n+        .trim(),\n+    );\n+\n+    let dst_file = project_dir().join(\"crates/ra_ide/src/snapshots/highlight_injection.html\");\n+    let actual_html = &analysis.highlight_as_html(file_id, false).unwrap();\n+    let expected_html = &read_text(&dst_file);\n+    fs::write(dst_file, &actual_html).unwrap();\n+    assert_eq_text!(expected_html, actual_html);\n }"}]}