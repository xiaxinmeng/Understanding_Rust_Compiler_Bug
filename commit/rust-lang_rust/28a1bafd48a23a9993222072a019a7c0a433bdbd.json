{"sha": "28a1bafd48a23a9993222072a019a7c0a433bdbd", "node_id": "C_kwDOAAsO6NoAKDI4YTFiYWZkNDhhMjNhOTk5MzIyMjA3MmEwMTlhN2MwYTQzM2JkYmQ", "commit": {"author": {"name": "Michael Howell", "email": "michael@notriddle.com", "date": "2022-10-23T21:48:16Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-10-23T21:48:16Z"}, "message": "Rollup merge of #103254 - fmease:fix-24183, r=GuillaumeGomez\n\nrustdoc: do not filter out cross-crate `Self: Sized` bounds\n\nAll type parameters **except `Self`** are implicitly `Sized` ([via](https://doc.rust-lang.org/nightly/std/marker/trait.Sized.html)). Previously, we disregarded the exception of `Self` and omitted cross-crate `Sized` bounds of *any* type parameter *including* `Self` when rendering.\nFrom now on, we *do* render cross-crate `Self: Sized` bounds.\n\nMost notably, in `std` we now finally properly render the `Sized` bound of the `Clone` trait as well as the `Self: Sized` bound on `Iterator::map`.\n\nFixes #24183.\n\n``@rustbot`` label T-rustdoc A-cross-crate-reexports\nr? rustdoc", "tree": {"sha": "d2be585b9cc7acb6b4e25dcdbc965d0415e1dcfe", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d2be585b9cc7acb6b4e25dcdbc965d0415e1dcfe"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/28a1bafd48a23a9993222072a019a7c0a433bdbd", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjVbagCRBK7hj4Ov3rIwAAEEsIAJuRcq6ueHakt+qU4mBVh0Gw\nm3/TxSrDq6SZuBNeROzUVYHX7hWWjzRxeQxJcDexHEg6aHfYjDtXcnvar1UZ9Z9U\n/bw0kX1mOdzXmUWuySheNShSFboenhiqG4wfVtsRO8IdkdLY1vnmNc4ymTMZE0Kz\nl+6ktzJCuo6EPdvmcYriwoB49Jym3RTmF0IQ+tnZdHe5Bwhjc9IzhptLnIrORUMj\nyfag2KKCjJBA8KH1+d9DWQp9NfDkP0InJr0bX9/uWTmP5/aSJcf9lMP6AO9UBEbW\nClp0K+r42zRncUQ/6gD+zZuAVfrDG+en6p2jABebibQBCaPQspd6hRcvRR+3qCA=\n=V10m\n-----END PGP SIGNATURE-----\n", "payload": "tree d2be585b9cc7acb6b4e25dcdbc965d0415e1dcfe\nparent 3df030d4418e011dbd5a4947157bcd14ba75e189\nparent f543770de26849fee46d7974ba9212e402c22151\nauthor Michael Howell <michael@notriddle.com> 1666561696 -0700\ncommitter GitHub <noreply@github.com> 1666561696 -0700\n\nRollup merge of #103254 - fmease:fix-24183, r=GuillaumeGomez\n\nrustdoc: do not filter out cross-crate `Self: Sized` bounds\n\nAll type parameters **except `Self`** are implicitly `Sized` ([via](https://doc.rust-lang.org/nightly/std/marker/trait.Sized.html)). Previously, we disregarded the exception of `Self` and omitted cross-crate `Sized` bounds of *any* type parameter *including* `Self` when rendering.\nFrom now on, we *do* render cross-crate `Self: Sized` bounds.\n\nMost notably, in `std` we now finally properly render the `Sized` bound of the `Clone` trait as well as the `Self: Sized` bound on `Iterator::map`.\n\nFixes #24183.\n\n``@rustbot`` label T-rustdoc A-cross-crate-reexports\nr? rustdoc\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/28a1bafd48a23a9993222072a019a7c0a433bdbd", "html_url": "https://github.com/rust-lang/rust/commit/28a1bafd48a23a9993222072a019a7c0a433bdbd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/28a1bafd48a23a9993222072a019a7c0a433bdbd/comments", "author": {"login": "notriddle", "id": 1593513, "node_id": "MDQ6VXNlcjE1OTM1MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/1593513?v=4", "gravatar_id": "", "url": "https://api.github.com/users/notriddle", "html_url": "https://github.com/notriddle", "followers_url": "https://api.github.com/users/notriddle/followers", "following_url": "https://api.github.com/users/notriddle/following{/other_user}", "gists_url": "https://api.github.com/users/notriddle/gists{/gist_id}", "starred_url": "https://api.github.com/users/notriddle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/notriddle/subscriptions", "organizations_url": "https://api.github.com/users/notriddle/orgs", "repos_url": "https://api.github.com/users/notriddle/repos", "events_url": "https://api.github.com/users/notriddle/events{/privacy}", "received_events_url": "https://api.github.com/users/notriddle/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3df030d4418e011dbd5a4947157bcd14ba75e189", "url": "https://api.github.com/repos/rust-lang/rust/commits/3df030d4418e011dbd5a4947157bcd14ba75e189", "html_url": "https://github.com/rust-lang/rust/commit/3df030d4418e011dbd5a4947157bcd14ba75e189"}, {"sha": "f543770de26849fee46d7974ba9212e402c22151", "url": "https://api.github.com/repos/rust-lang/rust/commits/f543770de26849fee46d7974ba9212e402c22151", "html_url": "https://github.com/rust-lang/rust/commit/f543770de26849fee46d7974ba9212e402c22151"}], "stats": {"total": 74, "additions": 56, "deletions": 18}, "files": [{"sha": "d86a26826416423a7b63a0a0232d2473db3d4f09", "filename": "src/librustdoc/clean/mod.rs", "status": "modified", "additions": 23, "deletions": 18, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/28a1bafd48a23a9993222072a019a7c0a433bdbd/src%2Flibrustdoc%2Fclean%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/28a1bafd48a23a9993222072a019a7c0a433bdbd/src%2Flibrustdoc%2Fclean%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Fmod.rs?ref=28a1bafd48a23a9993222072a019a7c0a433bdbd", "patch": "@@ -774,31 +774,36 @@ fn clean_ty_generics<'tcx>(\n     let mut where_predicates =\n         where_predicates.into_iter().flat_map(|p| clean_predicate(*p, cx)).collect::<Vec<_>>();\n \n-    // Type parameters have a Sized bound by default unless removed with\n-    // ?Sized. Scan through the predicates and mark any type parameter with\n-    // a Sized bound, removing the bounds as we find them.\n+    // In the surface language, all type parameters except `Self` have an\n+    // implicit `Sized` bound unless removed with `?Sized`.\n+    // However, in the list of where-predicates below, `Sized` appears like a\n+    // normal bound: It's either present (the type is sized) or\n+    // absent (the type is unsized) but never *maybe* (i.e. `?Sized`).\n     //\n-    // Note that associated types also have a sized bound by default, but we\n+    // This is unsuitable for rendering.\n+    // Thus, as a first step remove all `Sized` bounds that should be implicit.\n+    //\n+    // Note that associated types also have an implicit `Sized` bound but we\n     // don't actually know the set of associated types right here so that's\n-    // handled in cleaning associated types\n+    // handled when cleaning associated types.\n     let mut sized_params = FxHashSet::default();\n-    where_predicates.retain(|pred| match *pred {\n-        WherePredicate::BoundPredicate { ty: Generic(ref g), ref bounds, .. } => {\n-            if bounds.iter().any(|b| b.is_sized_bound(cx)) {\n-                sized_params.insert(*g);\n-                false\n-            } else {\n-                true\n-            }\n+    where_predicates.retain(|pred| {\n+        if let WherePredicate::BoundPredicate { ty: Generic(g), bounds, .. } = pred\n+        && *g != kw::SelfUpper\n+        && bounds.iter().any(|b| b.is_sized_bound(cx))\n+        {\n+            sized_params.insert(*g);\n+            false\n+        } else {\n+            true\n         }\n-        _ => true,\n     });\n \n-    // Run through the type parameters again and insert a ?Sized\n-    // unbound for any we didn't find to be Sized.\n+    // As a final step, go through the type parameters again and insert a\n+    // `?Sized` bound for each one we didn't find to be `Sized`.\n     for tp in &stripped_params {\n-        if matches!(tp.kind, types::GenericParamDefKind::Type { .. })\n-            && !sized_params.contains(&tp.name)\n+        if let types::GenericParamDefKind::Type { .. } = tp.kind\n+        && !sized_params.contains(&tp.name)\n         {\n             where_predicates.push(WherePredicate::BoundPredicate {\n                 ty: Type::Generic(tp.name),"}, {"sha": "e7a13acc6f864bd7cc41de40033c6d556ac275e6", "filename": "src/test/rustdoc/inline_cross/auxiliary/issue-24183.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/28a1bafd48a23a9993222072a019a7c0a433bdbd/src%2Ftest%2Frustdoc%2Finline_cross%2Fauxiliary%2Fissue-24183.rs", "raw_url": "https://github.com/rust-lang/rust/raw/28a1bafd48a23a9993222072a019a7c0a433bdbd/src%2Ftest%2Frustdoc%2Finline_cross%2Fauxiliary%2Fissue-24183.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Finline_cross%2Fauxiliary%2Fissue-24183.rs?ref=28a1bafd48a23a9993222072a019a7c0a433bdbd", "patch": "@@ -0,0 +1,14 @@\n+#![crate_type = \"lib\"]\n+\n+pub trait U/*: ?Sized */ {\n+    fn modified(self) -> Self\n+    where\n+        Self: Sized\n+    {\n+        self\n+    }\n+\n+    fn touch(&self)/* where Self: ?Sized */{}\n+}\n+\n+pub trait S: Sized {}"}, {"sha": "6955a961499ba5a4f73b891f2b77debb6957443b", "filename": "src/test/rustdoc/inline_cross/issue-24183.method_no_where_self_sized.html", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/28a1bafd48a23a9993222072a019a7c0a433bdbd/src%2Ftest%2Frustdoc%2Finline_cross%2Fissue-24183.method_no_where_self_sized.html", "raw_url": "https://github.com/rust-lang/rust/raw/28a1bafd48a23a9993222072a019a7c0a433bdbd/src%2Ftest%2Frustdoc%2Finline_cross%2Fissue-24183.method_no_where_self_sized.html", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Finline_cross%2Fissue-24183.method_no_where_self_sized.html?ref=28a1bafd48a23a9993222072a019a7c0a433bdbd", "patch": "@@ -0,0 +1 @@\n+<h4 class=\"code-header\">fn <a href=\"#method.touch\" class=\"fnname\">touch</a>(&amp;self)</h4>\n\\ No newline at end of file"}, {"sha": "d11b6955f3c0f796d9fd46281404f909c2bc156c", "filename": "src/test/rustdoc/inline_cross/issue-24183.rs", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/28a1bafd48a23a9993222072a019a7c0a433bdbd/src%2Ftest%2Frustdoc%2Finline_cross%2Fissue-24183.rs", "raw_url": "https://github.com/rust-lang/rust/raw/28a1bafd48a23a9993222072a019a7c0a433bdbd/src%2Ftest%2Frustdoc%2Finline_cross%2Fissue-24183.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Finline_cross%2Fissue-24183.rs?ref=28a1bafd48a23a9993222072a019a7c0a433bdbd", "patch": "@@ -0,0 +1,18 @@\n+#![crate_type = \"lib\"]\n+#![crate_name = \"usr\"]\n+\n+// aux-crate:issue_24183=issue-24183.rs\n+// edition: 2021\n+\n+// @has usr/trait.U.html\n+// @has - '//*[@class=\"item-decl\"]' \"pub trait U {\"\n+// @has - '//*[@id=\"method.modified\"]' \\\n+// \"fn modified(self) -> Self\\\n+// where \\\n+//     Self: Sized\"\n+// @snapshot method_no_where_self_sized - '//*[@id=\"method.touch\"]/*[@class=\"code-header\"]'\n+pub use issue_24183::U;\n+\n+// @has usr/trait.S.html\n+// @has - '//*[@class=\"item-decl\"]' 'pub trait S: Sized {'\n+pub use issue_24183::S;"}]}