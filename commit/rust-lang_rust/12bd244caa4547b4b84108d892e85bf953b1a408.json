{"sha": "12bd244caa4547b4b84108d892e85bf953b1a408", "node_id": "MDY6Q29tbWl0NzI0NzEyOjEyYmQyNDRjYWE0NTQ3YjRiODQxMDhkODkyZTg1YmY5NTNiMWE0MDg=", "commit": {"author": {"name": "Philipp Hansch", "email": "dev@phansch.net", "date": "2020-12-21T10:09:49Z"}, "committer": {"name": "Philipp Hansch", "email": "dev@phansch.net", "date": "2020-12-21T10:09:49Z"}, "message": "Don't trigger large_enum_variant in external macros", "tree": {"sha": "69bdc399fd7948637bdf6b9594ffc926cc51a07a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/69bdc399fd7948637bdf6b9594ffc926cc51a07a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/12bd244caa4547b4b84108d892e85bf953b1a408", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEE6VFioMHrom999LRAK0OZxL9Ny94FAl/gdI4ACgkQK0OZxL9N\ny94/GxAAra33NbLG+EICSw2H2pV5sJB4BetCnRF01dzK72kbGJYyWys45USnMH0i\n2ESfQZm4jgUHsYWWt8QXhlengfKOAuDcLaef4Ll67XIiMGpwvJ1OG4Wfn8vkJgun\na/QFUNxYSqjOAgtEXy6OsQj/8IZl4qqEwYgl4AiM1cFYxIgv9jFjifA7X36yYgTf\nAAJHR0iwHXyLq6tHHsTbj5Exdxl4l16v9Qx/a4BFJCxlqen9T14NE4kvfC5ldoCK\n0HDXipwQnLh+o4usskAgrtzbmzRcvH74cA7f6jW3BfKbstgSkX9F9+gsvUUokJYZ\n55OynuF4vAunGgpxiFFVba8ODiZDaZo+W3aQPfAQG1W8olK10L6LVvmV1PT+VYpk\nde/p3HfkwGfQcGAEY+hk9kJAJWUpuvTrQpEHFpZKz8VGew7cgKmsxW4Qf+/u6zTK\nNoaIYgYwncHO0gL4eTx68oIsaH8avXYz/oF/2upHUy+HjzTsutL0JZW9ZK0YCGCX\nQ1pRQ039oinHYgCo/eF2/7AeYs0foawQNA7C5vYE/W9dhmNuM9N+5fjqvd2prJ6s\nbYG4CH26Mp7jCb9D7rN0PnGJNKWJBKV6lQ/OvofsRudgTTFt+7n9EZ9+bH6+LgJ5\n4IFepYOZ6FkhPBiyIGkLdkZ7ejdOk5yTAVQ9vxJygnMF9QU5tks=\n=5cLg\n-----END PGP SIGNATURE-----", "payload": "tree 69bdc399fd7948637bdf6b9594ffc926cc51a07a\nparent 4911ab124c481430672a3833b37075e6435ec34d\nauthor Philipp Hansch <dev@phansch.net> 1608545389 +0100\ncommitter Philipp Hansch <dev@phansch.net> 1608545389 +0100\n\nDon't trigger large_enum_variant in external macros\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/12bd244caa4547b4b84108d892e85bf953b1a408", "html_url": "https://github.com/rust-lang/rust/commit/12bd244caa4547b4b84108d892e85bf953b1a408", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/12bd244caa4547b4b84108d892e85bf953b1a408/comments", "author": {"login": "phansch", "id": 2042399, "node_id": "MDQ6VXNlcjIwNDIzOTk=", "avatar_url": "https://avatars.githubusercontent.com/u/2042399?v=4", "gravatar_id": "", "url": "https://api.github.com/users/phansch", "html_url": "https://github.com/phansch", "followers_url": "https://api.github.com/users/phansch/followers", "following_url": "https://api.github.com/users/phansch/following{/other_user}", "gists_url": "https://api.github.com/users/phansch/gists{/gist_id}", "starred_url": "https://api.github.com/users/phansch/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/phansch/subscriptions", "organizations_url": "https://api.github.com/users/phansch/orgs", "repos_url": "https://api.github.com/users/phansch/repos", "events_url": "https://api.github.com/users/phansch/events{/privacy}", "received_events_url": "https://api.github.com/users/phansch/received_events", "type": "User", "site_admin": false}, "committer": {"login": "phansch", "id": 2042399, "node_id": "MDQ6VXNlcjIwNDIzOTk=", "avatar_url": "https://avatars.githubusercontent.com/u/2042399?v=4", "gravatar_id": "", "url": "https://api.github.com/users/phansch", "html_url": "https://github.com/phansch", "followers_url": "https://api.github.com/users/phansch/followers", "following_url": "https://api.github.com/users/phansch/following{/other_user}", "gists_url": "https://api.github.com/users/phansch/gists{/gist_id}", "starred_url": "https://api.github.com/users/phansch/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/phansch/subscriptions", "organizations_url": "https://api.github.com/users/phansch/orgs", "repos_url": "https://api.github.com/users/phansch/repos", "events_url": "https://api.github.com/users/phansch/events{/privacy}", "received_events_url": "https://api.github.com/users/phansch/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4911ab124c481430672a3833b37075e6435ec34d", "url": "https://api.github.com/repos/rust-lang/rust/commits/4911ab124c481430672a3833b37075e6435ec34d", "html_url": "https://github.com/rust-lang/rust/commit/4911ab124c481430672a3833b37075e6435ec34d"}], "stats": {"total": 41, "additions": 31, "deletions": 10}, "files": [{"sha": "ad9b4f357a74dbbe8a489176075d158c0b45cb38", "filename": "clippy_lints/src/large_enum_variant.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/12bd244caa4547b4b84108d892e85bf953b1a408/clippy_lints%2Fsrc%2Flarge_enum_variant.rs", "raw_url": "https://github.com/rust-lang/rust/raw/12bd244caa4547b4b84108d892e85bf953b1a408/clippy_lints%2Fsrc%2Flarge_enum_variant.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flarge_enum_variant.rs?ref=12bd244caa4547b4b84108d892e85bf953b1a408", "patch": "@@ -4,6 +4,7 @@ use crate::utils::{snippet_opt, span_lint_and_then};\n use rustc_errors::Applicability;\n use rustc_hir::{Item, ItemKind, VariantData};\n use rustc_lint::{LateContext, LateLintPass};\n+use rustc_middle::lint::in_external_macro;\n use rustc_session::{declare_tool_lint, impl_lint_pass};\n use rustc_target::abi::LayoutOf;\n \n@@ -58,6 +59,9 @@ impl_lint_pass!(LargeEnumVariant => [LARGE_ENUM_VARIANT]);\n \n impl<'tcx> LateLintPass<'tcx> for LargeEnumVariant {\n     fn check_item(&mut self, cx: &LateContext<'_>, item: &Item<'_>) {\n+        if in_external_macro(cx.tcx.sess, item.span) {\n+            return;\n+        }\n         let did = cx.tcx.hir().local_def_id(item.hir_id);\n         if let ItemKind::Enum(ref def, _) = item.kind {\n             let ty = cx.tcx.type_of(did);"}, {"sha": "1832482346820af414a29bddccd0992cbf7442a2", "filename": "tests/ui/auxiliary/macro_rules.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/12bd244caa4547b4b84108d892e85bf953b1a408/tests%2Fui%2Fauxiliary%2Fmacro_rules.rs", "raw_url": "https://github.com/rust-lang/rust/raw/12bd244caa4547b4b84108d892e85bf953b1a408/tests%2Fui%2Fauxiliary%2Fmacro_rules.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fauxiliary%2Fmacro_rules.rs?ref=12bd244caa4547b4b84108d892e85bf953b1a408", "patch": "@@ -84,3 +84,13 @@ macro_rules! as_conv {\n         0u32 as u64\n     };\n }\n+\n+#[macro_export]\n+macro_rules! large_enum_variant {\n+    () => {\n+        enum LargeEnumInMacro {\n+            A(i32),\n+            B([i32; 8000]),\n+        }\n+    };\n+}"}, {"sha": "d22fee3f27b05818c3ed86e1127c010726bb7afa", "filename": "tests/ui/large_enum_variant.rs", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/12bd244caa4547b4b84108d892e85bf953b1a408/tests%2Fui%2Flarge_enum_variant.rs", "raw_url": "https://github.com/rust-lang/rust/raw/12bd244caa4547b4b84108d892e85bf953b1a408/tests%2Fui%2Flarge_enum_variant.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Flarge_enum_variant.rs?ref=12bd244caa4547b4b84108d892e85bf953b1a408", "patch": "@@ -1,7 +1,12 @@\n+// aux-build:macro_rules.rs\n+\n #![allow(dead_code)]\n #![allow(unused_variables)]\n #![warn(clippy::large_enum_variant)]\n \n+#[macro_use]\n+extern crate macro_rules;\n+\n enum LargeEnum {\n     A(i32),\n     B([i32; 8000]),\n@@ -51,4 +56,6 @@ enum LargeEnumOk {\n     LargeB([i32; 8001]),\n }\n \n-fn main() {}\n+fn main() {\n+    large_enum_variant!();\n+}"}, {"sha": "d39a4d462aabde949de878d8821d11950cecfc73", "filename": "tests/ui/large_enum_variant.stderr", "status": "modified", "additions": 9, "deletions": 9, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/12bd244caa4547b4b84108d892e85bf953b1a408/tests%2Fui%2Flarge_enum_variant.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/12bd244caa4547b4b84108d892e85bf953b1a408/tests%2Fui%2Flarge_enum_variant.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Flarge_enum_variant.stderr?ref=12bd244caa4547b4b84108d892e85bf953b1a408", "patch": "@@ -1,12 +1,12 @@\n error: large size difference between variants\n-  --> $DIR/large_enum_variant.rs:7:5\n+  --> $DIR/large_enum_variant.rs:12:5\n    |\n LL |     B([i32; 8000]),\n    |     ^^^^^^^^^^^^^^ this variant is 32000 bytes\n    |\n    = note: `-D clippy::large-enum-variant` implied by `-D warnings`\n note: and the second-largest variant is 4 bytes:\n-  --> $DIR/large_enum_variant.rs:6:5\n+  --> $DIR/large_enum_variant.rs:11:5\n    |\n LL |     A(i32),\n    |     ^^^^^^\n@@ -16,13 +16,13 @@ LL |     B(Box<[i32; 8000]>),\n    |       ^^^^^^^^^^^^^^^^\n \n error: large size difference between variants\n-  --> $DIR/large_enum_variant.rs:31:5\n+  --> $DIR/large_enum_variant.rs:36:5\n    |\n LL |     ContainingLargeEnum(LargeEnum),\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ this variant is 32004 bytes\n    |\n note: and the second-largest variant is 8 bytes:\n-  --> $DIR/large_enum_variant.rs:30:5\n+  --> $DIR/large_enum_variant.rs:35:5\n    |\n LL |     VariantOk(i32, u32),\n    |     ^^^^^^^^^^^^^^^^^^^\n@@ -32,30 +32,30 @@ LL |     ContainingLargeEnum(Box<LargeEnum>),\n    |                         ^^^^^^^^^^^^^^\n \n error: large size difference between variants\n-  --> $DIR/large_enum_variant.rs:41:5\n+  --> $DIR/large_enum_variant.rs:46:5\n    |\n LL |     StructLikeLarge { x: [i32; 8000], y: i32 },\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ this variant is 32004 bytes\n    |\n note: and the second-largest variant is 8 bytes:\n-  --> $DIR/large_enum_variant.rs:40:5\n+  --> $DIR/large_enum_variant.rs:45:5\n    |\n LL |     VariantOk(i32, u32),\n    |     ^^^^^^^^^^^^^^^^^^^\n help: consider boxing the large fields to reduce the total size of the enum\n-  --> $DIR/large_enum_variant.rs:41:5\n+  --> $DIR/large_enum_variant.rs:46:5\n    |\n LL |     StructLikeLarge { x: [i32; 8000], y: i32 },\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n error: large size difference between variants\n-  --> $DIR/large_enum_variant.rs:46:5\n+  --> $DIR/large_enum_variant.rs:51:5\n    |\n LL |     StructLikeLarge2 { x: [i32; 8000] },\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ this variant is 32000 bytes\n    |\n note: and the second-largest variant is 8 bytes:\n-  --> $DIR/large_enum_variant.rs:45:5\n+  --> $DIR/large_enum_variant.rs:50:5\n    |\n LL |     VariantOk(i32, u32),\n    |     ^^^^^^^^^^^^^^^^^^^"}]}