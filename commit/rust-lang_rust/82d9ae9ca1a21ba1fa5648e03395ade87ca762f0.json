{"sha": "82d9ae9ca1a21ba1fa5648e03395ade87ca762f0", "node_id": "C_kwDOAAsO6NoAKDgyZDlhZTljYTFhMjFiYTFmYTU2NDhlMDMzOTVhZGU4N2NhNzYyZjA", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-07-20T16:58:16Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-07-20T16:58:16Z"}, "message": "Rollup merge of #99355 - compiler-errors:macro-metavar-less-than-zero, r=petrochenkov\n\nbetter error for bad depth parameter on macro metavar expr\n\nFixes #99060", "tree": {"sha": "b972e0cf3a52235ae9a80bc2dbd45b26d99124a8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b972e0cf3a52235ae9a80bc2dbd45b26d99124a8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/82d9ae9ca1a21ba1fa5648e03395ade87ca762f0", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJi2DQpCRBK7hj4Ov3rIwAAV9EIAHjVZ6X6H3MZ3VWII0xraAOG\n5pgRY+WAm+EAlqx3qyjatIMGV4iV64S58S6hfDqh6PHefyCkAOdeuEr5XR5MWZ1h\n99qd4XtzkWe0JwkjYnp3W3CSau4VMO2sSRfSR4u1WnuvByBAEa/8vIVRtWJVBEpW\nnIOyKXkYY0lesx950RM7ToHJWCCKZJ4cO2JNuS/DsHQrybJjwsbQVrYfVLfi21Ow\ncMjtq6S+B/bqBiI0DKpW4xKXwhVEawMc9V0kvsYMbDKGMK3ucBd0CUKlavHeFiAZ\nOUNZImY3OuaPjbUysAu+16VpEQcHGYfxTTm/c52ZNjFkbcHNq3nEdDZ5G0zULcM=\n=unmX\n-----END PGP SIGNATURE-----\n", "payload": "tree b972e0cf3a52235ae9a80bc2dbd45b26d99124a8\nparent 43f6366da4b5a39284d7224eb3a195fb4b9f698a\nparent dd109c8c10ddcb3924adbcdd27baf6f525824d52\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1658336296 +0200\ncommitter GitHub <noreply@github.com> 1658336296 +0200\n\nRollup merge of #99355 - compiler-errors:macro-metavar-less-than-zero, r=petrochenkov\n\nbetter error for bad depth parameter on macro metavar expr\n\nFixes #99060\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/82d9ae9ca1a21ba1fa5648e03395ade87ca762f0", "html_url": "https://github.com/rust-lang/rust/commit/82d9ae9ca1a21ba1fa5648e03395ade87ca762f0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/82d9ae9ca1a21ba1fa5648e03395ade87ca762f0/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "43f6366da4b5a39284d7224eb3a195fb4b9f698a", "url": "https://api.github.com/repos/rust-lang/rust/commits/43f6366da4b5a39284d7224eb3a195fb4b9f698a", "html_url": "https://github.com/rust-lang/rust/commit/43f6366da4b5a39284d7224eb3a195fb4b9f698a"}, {"sha": "dd109c8c10ddcb3924adbcdd27baf6f525824d52", "url": "https://api.github.com/repos/rust-lang/rust/commits/dd109c8c10ddcb3924adbcdd27baf6f525824d52", "html_url": "https://github.com/rust-lang/rust/commit/dd109c8c10ddcb3924adbcdd27baf6f525824d52"}], "stats": {"total": 48, "additions": 39, "deletions": 9}, "files": [{"sha": "3037855ae28a6b6c7ea6d742bf9678a07b387c4b", "filename": "compiler/rustc_expand/src/mbe/transcribe.rs", "status": "modified", "additions": 12, "deletions": 1, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/82d9ae9ca1a21ba1fa5648e03395ade87ca762f0/compiler%2Frustc_expand%2Fsrc%2Fmbe%2Ftranscribe.rs", "raw_url": "https://github.com/rust-lang/rust/raw/82d9ae9ca1a21ba1fa5648e03395ade87ca762f0/compiler%2Frustc_expand%2Fsrc%2Fmbe%2Ftranscribe.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_expand%2Fsrc%2Fmbe%2Ftranscribe.rs?ref=82d9ae9ca1a21ba1fa5648e03395ade87ca762f0", "patch": "@@ -512,7 +512,18 @@ fn out_of_bounds_err<'a>(\n     span: Span,\n     ty: &str,\n ) -> DiagnosticBuilder<'a, ErrorGuaranteed> {\n-    cx.struct_span_err(span, &format!(\"{ty} depth must be less than {max}\"))\n+    let msg = if max == 0 {\n+        format!(\n+            \"meta-variable expression `{ty}` with depth parameter \\\n+             must be called inside of a macro repetition\"\n+        )\n+    } else {\n+        format!(\n+            \"depth parameter on meta-variable expression `{ty}` \\\n+             must be less than {max}\"\n+        )\n+    };\n+    cx.struct_span_err(span, &msg)\n }\n \n fn transcribe_metavar_expr<'a>("}, {"sha": "b7fb947854f04fe0ffb7c23e94b73931d028256f", "filename": "src/test/ui/macros/meta-variable-depth-outside-repeat.rs", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/82d9ae9ca1a21ba1fa5648e03395ade87ca762f0/src%2Ftest%2Fui%2Fmacros%2Fmeta-variable-depth-outside-repeat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/82d9ae9ca1a21ba1fa5648e03395ade87ca762f0/src%2Ftest%2Fui%2Fmacros%2Fmeta-variable-depth-outside-repeat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmacros%2Fmeta-variable-depth-outside-repeat.rs?ref=82d9ae9ca1a21ba1fa5648e03395ade87ca762f0", "patch": "@@ -0,0 +1,12 @@\n+#![feature(macro_metavar_expr)]\n+\n+macro_rules! metavar {\n+    ( $i:expr ) => {\n+        ${length(0)}\n+        //~^ ERROR meta-variable expression `length` with depth parameter must be called inside of a macro repetition\n+    };\n+}\n+\n+const _: i32 = metavar!(0);\n+\n+fn main() {}"}, {"sha": "fad150cadfca6ccd3c1f760dffa6bc5992b325ea", "filename": "src/test/ui/macros/meta-variable-depth-outside-repeat.stderr", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/82d9ae9ca1a21ba1fa5648e03395ade87ca762f0/src%2Ftest%2Fui%2Fmacros%2Fmeta-variable-depth-outside-repeat.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/82d9ae9ca1a21ba1fa5648e03395ade87ca762f0/src%2Ftest%2Fui%2Fmacros%2Fmeta-variable-depth-outside-repeat.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmacros%2Fmeta-variable-depth-outside-repeat.stderr?ref=82d9ae9ca1a21ba1fa5648e03395ade87ca762f0", "patch": "@@ -0,0 +1,8 @@\n+error: meta-variable expression `length` with depth parameter must be called inside of a macro repetition\n+  --> $DIR/meta-variable-depth-outside-repeat.rs:5:10\n+   |\n+LL |         ${length(0)}\n+   |          ^^^^^^^^^^^\n+\n+error: aborting due to previous error\n+"}, {"sha": "6a0d68bd6b16a73ffb060d55f71ea384cc8a7803", "filename": "src/test/ui/macros/rfc-3086-metavar-expr/out-of-bounds-arguments.rs", "status": "modified", "additions": 4, "deletions": 5, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/82d9ae9ca1a21ba1fa5648e03395ade87ca762f0/src%2Ftest%2Fui%2Fmacros%2Frfc-3086-metavar-expr%2Fout-of-bounds-arguments.rs", "raw_url": "https://github.com/rust-lang/rust/raw/82d9ae9ca1a21ba1fa5648e03395ade87ca762f0/src%2Ftest%2Fui%2Fmacros%2Frfc-3086-metavar-expr%2Fout-of-bounds-arguments.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmacros%2Frfc-3086-metavar-expr%2Fout-of-bounds-arguments.rs?ref=82d9ae9ca1a21ba1fa5648e03395ade87ca762f0", "patch": "@@ -5,7 +5,7 @@ macro_rules! a {\n         (\n             ${count(foo, 0)},\n             ${count(foo, 10)},\n-            //~^ ERROR count depth must be less than 4\n+            //~^ ERROR depth parameter on meta-variable expression `count` must be less than 4\n         )\n     };\n }\n@@ -17,7 +17,7 @@ macro_rules! b {\n                 ${ignore(foo)}\n                 ${index(0)},\n                 ${index(10)},\n-                //~^ ERROR index depth must be less than 3\n+                //~^ ERROR depth parameter on meta-variable expression `index` must be less than 3\n             )* )* )*\n         )\n     };\n@@ -30,15 +30,14 @@ macro_rules! c {\n                 ${ignore(foo)}\n                 ${length(0)}\n                 ${length(10)}\n-                //~^ ERROR length depth must be less than 2\n+                //~^ ERROR depth parameter on meta-variable expression `length` must be less than 2\n             )* )*\n         )\n     };\n }\n \n-\n fn main() {\n     a!( { [ (a) ] [ (b c) ] } );\n     b!( { [ a b ] } );\n-    c!( { a } );\n+    c!({ a });\n }"}, {"sha": "236122b6465b2cdfe9f8ab960d1187c2a89a9c1d", "filename": "src/test/ui/macros/rfc-3086-metavar-expr/out-of-bounds-arguments.stderr", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/82d9ae9ca1a21ba1fa5648e03395ade87ca762f0/src%2Ftest%2Fui%2Fmacros%2Frfc-3086-metavar-expr%2Fout-of-bounds-arguments.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/82d9ae9ca1a21ba1fa5648e03395ade87ca762f0/src%2Ftest%2Fui%2Fmacros%2Frfc-3086-metavar-expr%2Fout-of-bounds-arguments.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmacros%2Frfc-3086-metavar-expr%2Fout-of-bounds-arguments.stderr?ref=82d9ae9ca1a21ba1fa5648e03395ade87ca762f0", "patch": "@@ -1,16 +1,16 @@\n-error: count depth must be less than 4\n+error: depth parameter on meta-variable expression `count` must be less than 4\n   --> $DIR/out-of-bounds-arguments.rs:7:14\n    |\n LL |             ${count(foo, 10)},\n    |              ^^^^^^^^^^^^^^^^\n \n-error: index depth must be less than 3\n+error: depth parameter on meta-variable expression `index` must be less than 3\n   --> $DIR/out-of-bounds-arguments.rs:19:18\n    |\n LL |                 ${index(10)},\n    |                  ^^^^^^^^^^^\n \n-error: length depth must be less than 2\n+error: depth parameter on meta-variable expression `length` must be less than 2\n   --> $DIR/out-of-bounds-arguments.rs:32:18\n    |\n LL |                 ${length(10)}"}]}