{"sha": "dd35e2f79bd19f331ca8a0644400af99e5a598ae", "node_id": "C_kwDOAAsO6NoAKGRkMzVlMmY3OWJkMTlmMzMxY2E4YTA2NDQ0MDBhZjk5ZTVhNTk4YWU", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-09-04T16:55:45Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-09-04T16:55:45Z"}, "message": "Rollup merge of #101388 - compiler-errors:issue-101376, r=fee1-dead\n\nDon't delay invalid LHS bug unless it will be covered by an error in `check_overloaded_binop`\n\nFixes #101376", "tree": {"sha": "a257d3ccb7bc15afb23778039df7ed89c0a78813", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a257d3ccb7bc15afb23778039df7ed89c0a78813"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/dd35e2f79bd19f331ca8a0644400af99e5a598ae", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjFNiRCRBK7hj4Ov3rIwAA2i8IAH0zlhXJN6SpiKkNx2gXNzxG\nMEFL6leDSpItxsinLnutlXY52DmKoGfOniYEn5YR6U3YDI3l92Xaj6f+9s5Dx4y5\nU9WLadNS3ZfWLRTN58TRvL/6BU4Q3//4PcpurYtLVqM0pwdq3/XPZj7PiL8s+0WQ\n1RyIDLTmMFZe+HxP9Xt9LJMfkEsn44PoCeDcfr0zlRaXMbeJKxUlfoeP8iuHI66E\nOz5Ma6pDvuZHosXfnl4g3W9vkp8aKDL0u88EFDUyeAYP22Q+pAB7hkr8H5xDXCSf\nVq0ifPSSxnzDqPDEvdqF/QG7cRoyNnvdmiBv0TDJMgXgRiCqWVfmBKdBaYCs5N0=\n=jW2t\n-----END PGP SIGNATURE-----\n", "payload": "tree a257d3ccb7bc15afb23778039df7ed89c0a78813\nparent 8f8a36d1c2795dcdab29d12a73cc49fd252ecc34\nparent 98f4b20abc9ad5ff77874119bbec305f4c7c6226\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1662310545 +0200\ncommitter GitHub <noreply@github.com> 1662310545 +0200\n\nRollup merge of #101388 - compiler-errors:issue-101376, r=fee1-dead\n\nDon't delay invalid LHS bug unless it will be covered by an error in `check_overloaded_binop`\n\nFixes #101376\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/dd35e2f79bd19f331ca8a0644400af99e5a598ae", "html_url": "https://github.com/rust-lang/rust/commit/dd35e2f79bd19f331ca8a0644400af99e5a598ae", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/dd35e2f79bd19f331ca8a0644400af99e5a598ae/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8f8a36d1c2795dcdab29d12a73cc49fd252ecc34", "url": "https://api.github.com/repos/rust-lang/rust/commits/8f8a36d1c2795dcdab29d12a73cc49fd252ecc34", "html_url": "https://github.com/rust-lang/rust/commit/8f8a36d1c2795dcdab29d12a73cc49fd252ecc34"}, {"sha": "98f4b20abc9ad5ff77874119bbec305f4c7c6226", "url": "https://api.github.com/repos/rust-lang/rust/commits/98f4b20abc9ad5ff77874119bbec305f4c7c6226", "html_url": "https://github.com/rust-lang/rust/commit/98f4b20abc9ad5ff77874119bbec305f4c7c6226"}], "stats": {"total": 60, "additions": 57, "deletions": 3}, "files": [{"sha": "0d9dbb5bc11c24ece1ef00c329fff37c1cf5a55f", "filename": "compiler/rustc_typeck/src/check/op.rs", "status": "modified", "additions": 22, "deletions": 3, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/dd35e2f79bd19f331ca8a0644400af99e5a598ae/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dd35e2f79bd19f331ca8a0644400af99e5a598ae/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fop.rs?ref=dd35e2f79bd19f331ca8a0644400af99e5a598ae", "patch": "@@ -57,9 +57,28 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                     )\n                     .is_ok()\n                 {\n-                    // Suppress this error, since we already emitted\n-                    // a deref suggestion in check_overloaded_binop\n-                    err.downgrade_to_delayed_bug();\n+                    // If LHS += RHS is an error, but *LHS += RHS is successful, then we will have\n+                    // emitted a better suggestion during error handling in check_overloaded_binop.\n+                    if self\n+                        .lookup_op_method(\n+                            lhs_ty,\n+                            Some(rhs_ty),\n+                            Some(rhs),\n+                            Op::Binary(op, IsAssign::Yes),\n+                            expected,\n+                        )\n+                        .is_err()\n+                    {\n+                        err.downgrade_to_delayed_bug();\n+                    } else {\n+                        // Otherwise, it's valid to suggest dereferencing the LHS here.\n+                        err.span_suggestion_verbose(\n+                            lhs.span.shrink_to_lo(),\n+                            \"consider dereferencing the left-hand side of this operation\",\n+                            \"*\",\n+                            Applicability::MaybeIncorrect,\n+                        );\n+                    }\n                 }\n             }\n         });"}, {"sha": "c979d76b4f4161a90ed637c969528ade1875cc51", "filename": "src/test/ui/typeck/assign-non-lval-needs-deref.rs", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/dd35e2f79bd19f331ca8a0644400af99e5a598ae/src%2Ftest%2Fui%2Ftypeck%2Fassign-non-lval-needs-deref.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dd35e2f79bd19f331ca8a0644400af99e5a598ae/src%2Ftest%2Fui%2Ftypeck%2Fassign-non-lval-needs-deref.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftypeck%2Fassign-non-lval-needs-deref.rs?ref=dd35e2f79bd19f331ca8a0644400af99e5a598ae", "patch": "@@ -0,0 +1,19 @@\n+// issue #101376\n+\n+use std::ops::AddAssign;\n+struct Foo;\n+\n+impl AddAssign<()> for Foo {\n+    fn add_assign(&mut self, _: ()) {}\n+}\n+\n+impl AddAssign<()> for &mut Foo {\n+    fn add_assign(&mut self, _: ()) {}\n+}\n+\n+fn main() {\n+    (&mut Foo) += ();\n+    //~^ ERROR invalid left-hand side of assignment\n+    //~| NOTE cannot assign to this expression\n+    //~| HELP consider dereferencing the left-hand side of this operation\n+}"}, {"sha": "ee83b1453213174c3a6ce07e8c8bd6e05a753959", "filename": "src/test/ui/typeck/assign-non-lval-needs-deref.stderr", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/dd35e2f79bd19f331ca8a0644400af99e5a598ae/src%2Ftest%2Fui%2Ftypeck%2Fassign-non-lval-needs-deref.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/dd35e2f79bd19f331ca8a0644400af99e5a598ae/src%2Ftest%2Fui%2Ftypeck%2Fassign-non-lval-needs-deref.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftypeck%2Fassign-non-lval-needs-deref.stderr?ref=dd35e2f79bd19f331ca8a0644400af99e5a598ae", "patch": "@@ -0,0 +1,16 @@\n+error[E0067]: invalid left-hand side of assignment\n+  --> $DIR/assign-non-lval-needs-deref.rs:15:16\n+   |\n+LL |     (&mut Foo) += ();\n+   |     ---------- ^^\n+   |     |\n+   |     cannot assign to this expression\n+   |\n+help: consider dereferencing the left-hand side of this operation\n+   |\n+LL |     *(&mut Foo) += ();\n+   |     +\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0067`."}]}