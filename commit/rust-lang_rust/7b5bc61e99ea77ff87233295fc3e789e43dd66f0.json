{"sha": "7b5bc61e99ea77ff87233295fc3e789e43dd66f0", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdiNWJjNjFlOTllYTc3ZmY4NzIzMzI5NWZjM2U3ODllNDNkZDY2ZjA=", "commit": {"author": {"name": "Dylan DPC", "email": "dylan.dpc@gmail.com", "date": "2020-05-14T16:21:59Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-05-14T16:21:59Z"}, "message": "Rollup merge of #72194 - doctorn:dispatch-from-dyn-ice, r=estebank\n\nDon't ICE on missing `Unsize` impl\n\nPreviously code of the form\n\n```rust\n#![feature(unsize, dispatch_from_dyn)]\n\nuse std::marker::Unsize;\nuse std::ops::DispatchFromDyn;\n\npub struct Foo<'a, T: ?Sized> {\n    _inner: &'a &'a T,\n}\n\nimpl<'a, T: ?Sized + Unsize<U>, U: ?Sized> DispatchFromDyn<Foo<'a, U>> for Foo<'a, T> {}\n```\n\nwould generate an ICE due to the missing `Unsize` impl being run through the `suggest_change_mut` suggestion. This PR adds an early exit and a pointer to the appropriate docs regarding `Unsize` instead:\n\n```\nerror[E0277]: the trait bound `&'a T: std::marker::Unsize<&'a U>` is not satisfied\n  --> src/test/ui/issues/issue-71036.rs:11:1\n   |\n11 | impl<'a, T: ?Sized + Unsize<U>, U: ?Sized> DispatchFromDyn<Foo<'a, U>> for Foo<'a, T> {}\n   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ the trait `std::marker::Unsize<&'a U>` is not implemented for `&'a T`\n   |\n   = note: all implementations of `Unsize` are provided automatically by the compiler, see <https://doc.rust-lang.org/stable/std/marker/trait.Unsize.html> for more information\n   = note: required because of the requirements on the impl of `std::ops::DispatchFromDyn<&'a &'a U>` for `&'a &'a T`\n\nerror: aborting due to previous error\n\nFor more information about this error, try `rustc --explain E0277`.\n```\n\nr? @estebank\n\nResolves #71036", "tree": {"sha": "b64230280cd4a445e65ae665e0097b548e9c3989", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b64230280cd4a445e65ae665e0097b548e9c3989"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7b5bc61e99ea77ff87233295fc3e789e43dd66f0", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJevXAnCRBK7hj4Ov3rIwAAdHIIACfCUM0klVsRt2HWkJVVNTTk\nm0P5GEEKD24ffOnURWhAbk3GSmLXf1Gtin8x/v/PXYOt/eT45sPSUjjUbvU99J7s\n/Sz0bb8n+2v3CIE8RmsX0YgzA7/+Ly38gqlrgKpGDnX7eZoP7piwRjalFO2hsmWP\nbbn/6gLbLb4qyCMLYpSJvkjMpqBQqvlQZvWJJ5hUDN1YGfL6PaEGmU9rpvVFeVG2\nch67lIEn+clz4k1qf78yk1OzdPpKUB9aG+CrEd+mpQocJcTzXknVbPRuZleWvQjI\nTRINSX88CjWvqforwvy6gy8MP47yQowuG68uApE0MyQfYNj3XcULQ0HH12ALs/I=\n=H+RS\n-----END PGP SIGNATURE-----\n", "payload": "tree b64230280cd4a445e65ae665e0097b548e9c3989\nparent d7f5e56498bffa50813fbdd34623501c8f5b0a5c\nparent f6aa161936887bf4a0aaebbd5cfc743132a1ab0b\nauthor Dylan DPC <dylan.dpc@gmail.com> 1589473319 +0200\ncommitter GitHub <noreply@github.com> 1589473319 +0200\n\nRollup merge of #72194 - doctorn:dispatch-from-dyn-ice, r=estebank\n\nDon't ICE on missing `Unsize` impl\n\nPreviously code of the form\n\n```rust\n#![feature(unsize, dispatch_from_dyn)]\n\nuse std::marker::Unsize;\nuse std::ops::DispatchFromDyn;\n\npub struct Foo<'a, T: ?Sized> {\n    _inner: &'a &'a T,\n}\n\nimpl<'a, T: ?Sized + Unsize<U>, U: ?Sized> DispatchFromDyn<Foo<'a, U>> for Foo<'a, T> {}\n```\n\nwould generate an ICE due to the missing `Unsize` impl being run through the `suggest_change_mut` suggestion. This PR adds an early exit and a pointer to the appropriate docs regarding `Unsize` instead:\n\n```\nerror[E0277]: the trait bound `&'a T: std::marker::Unsize<&'a U>` is not satisfied\n  --> src/test/ui/issues/issue-71036.rs:11:1\n   |\n11 | impl<'a, T: ?Sized + Unsize<U>, U: ?Sized> DispatchFromDyn<Foo<'a, U>> for Foo<'a, T> {}\n   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ the trait `std::marker::Unsize<&'a U>` is not implemented for `&'a T`\n   |\n   = note: all implementations of `Unsize` are provided automatically by the compiler, see <https://doc.rust-lang.org/stable/std/marker/trait.Unsize.html> for more information\n   = note: required because of the requirements on the impl of `std::ops::DispatchFromDyn<&'a &'a U>` for `&'a &'a T`\n\nerror: aborting due to previous error\n\nFor more information about this error, try `rustc --explain E0277`.\n```\n\nr? @estebank\n\nResolves #71036\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7b5bc61e99ea77ff87233295fc3e789e43dd66f0", "html_url": "https://github.com/rust-lang/rust/commit/7b5bc61e99ea77ff87233295fc3e789e43dd66f0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7b5bc61e99ea77ff87233295fc3e789e43dd66f0/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d7f5e56498bffa50813fbdd34623501c8f5b0a5c", "url": "https://api.github.com/repos/rust-lang/rust/commits/d7f5e56498bffa50813fbdd34623501c8f5b0a5c", "html_url": "https://github.com/rust-lang/rust/commit/d7f5e56498bffa50813fbdd34623501c8f5b0a5c"}, {"sha": "f6aa161936887bf4a0aaebbd5cfc743132a1ab0b", "url": "https://api.github.com/repos/rust-lang/rust/commits/f6aa161936887bf4a0aaebbd5cfc743132a1ab0b", "html_url": "https://github.com/rust-lang/rust/commit/f6aa161936887bf4a0aaebbd5cfc743132a1ab0b"}], "stats": {"total": 58, "additions": 52, "deletions": 6}, "files": [{"sha": "5a63a693652ea11cfff0a1fb5757964f12cbd674", "filename": "src/librustc_trait_selection/traits/error_reporting/mod.rs", "status": "modified", "additions": 23, "deletions": 6, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/7b5bc61e99ea77ff87233295fc3e789e43dd66f0/src%2Flibrustc_trait_selection%2Ftraits%2Ferror_reporting%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7b5bc61e99ea77ff87233295fc3e789e43dd66f0/src%2Flibrustc_trait_selection%2Ftraits%2Ferror_reporting%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trait_selection%2Ftraits%2Ferror_reporting%2Fmod.rs?ref=7b5bc61e99ea77ff87233295fc3e789e43dd66f0", "patch": "@@ -283,6 +283,8 @@ impl<'a, 'tcx> InferCtxtExt<'tcx> for InferCtxt<'a, 'tcx> {\n                             .unwrap_or(false);\n                         let is_from = format!(\"{}\", trait_ref.print_only_trait_path())\n                             .starts_with(\"std::convert::From<\");\n+                        let is_unsize =\n+                            { Some(trait_ref.def_id()) == self.tcx.lang_items().unsize_trait() };\n                         let (message, note) = if is_try && is_from {\n                             (\n                                 Some(format!(\n@@ -405,6 +407,17 @@ impl<'a, 'tcx> InferCtxtExt<'tcx> for InferCtxt<'a, 'tcx> {\n                             return;\n                         }\n \n+                        if is_unsize {\n+                            // If the obligation failed due to a missing implementation of the\n+                            // `Unsize` trait, give a pointer to why that might be the case\n+                            err.note(\n+                                \"all implementations of `Unsize` are provided \\\n+                                automatically by the compiler, see \\\n+                                <https://doc.rust-lang.org/stable/std/marker/trait.Unsize.html> \\\n+                                for more information\",\n+                            );\n+                        }\n+\n                         // Try to report a help message\n                         if !trait_ref.has_infer_types_or_consts()\n                             && self.predicate_can_apply(obligation.param_env, trait_ref)\n@@ -427,12 +440,16 @@ impl<'a, 'tcx> InferCtxtExt<'tcx> for InferCtxt<'a, 'tcx> {\n                                 let impl_candidates = self.find_similar_impl_candidates(trait_ref);\n                                 self.report_similar_impl_candidates(impl_candidates, &mut err);\n                             }\n-                            self.suggest_change_mut(\n-                                &obligation,\n-                                &mut err,\n-                                &trait_ref,\n-                                points_at_arg,\n-                            );\n+                            // Changing mutability doesn't make a difference to whether we have\n+                            // an `Unsize` impl (Fixes ICE in #71036)\n+                            if !is_unsize {\n+                                self.suggest_change_mut(\n+                                    &obligation,\n+                                    &mut err,\n+                                    &trait_ref,\n+                                    points_at_arg,\n+                                );\n+                            }\n                         }\n \n                         // If this error is due to `!: Trait` not implemented but `(): Trait` is"}, {"sha": "01d1cff42e4ba3ec87044ced7b80c5692990e66d", "filename": "src/test/ui/issues/issue-71036.rs", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/7b5bc61e99ea77ff87233295fc3e789e43dd66f0/src%2Ftest%2Fui%2Fissues%2Fissue-71036.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7b5bc61e99ea77ff87233295fc3e789e43dd66f0/src%2Ftest%2Fui%2Fissues%2Fissue-71036.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-71036.rs?ref=7b5bc61e99ea77ff87233295fc3e789e43dd66f0", "patch": "@@ -0,0 +1,17 @@\n+#![feature(unsize, dispatch_from_dyn)]\n+\n+use std::marker::Unsize;\n+use std::ops::DispatchFromDyn;\n+\n+#[allow(unused)]\n+struct Foo<'a, T: ?Sized> {\n+    _inner: &'a &'a T,\n+}\n+\n+impl<'a, T: ?Sized + Unsize<U>, U: ?Sized> DispatchFromDyn<Foo<'a, U>> for Foo<'a, T> {}\n+//~^ ERROR the trait bound `&'a T: std::marker::Unsize<&'a U>` is not satisfied\n+//~| NOTE the trait `std::marker::Unsize<&'a U>` is not implemented for `&'a T`\n+//~| NOTE all implementations of `Unsize` are provided automatically by the compiler\n+//~| NOTE required because of the requirements on the impl\n+\n+fn main() {}"}, {"sha": "57cf24689454ec50e18dc119764553110b8e93b4", "filename": "src/test/ui/issues/issue-71036.stderr", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/7b5bc61e99ea77ff87233295fc3e789e43dd66f0/src%2Ftest%2Fui%2Fissues%2Fissue-71036.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/7b5bc61e99ea77ff87233295fc3e789e43dd66f0/src%2Ftest%2Fui%2Fissues%2Fissue-71036.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-71036.stderr?ref=7b5bc61e99ea77ff87233295fc3e789e43dd66f0", "patch": "@@ -0,0 +1,12 @@\n+error[E0277]: the trait bound `&'a T: std::marker::Unsize<&'a U>` is not satisfied\n+  --> $DIR/issue-71036.rs:11:1\n+   |\n+LL | impl<'a, T: ?Sized + Unsize<U>, U: ?Sized> DispatchFromDyn<Foo<'a, U>> for Foo<'a, T> {}\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ the trait `std::marker::Unsize<&'a U>` is not implemented for `&'a T`\n+   |\n+   = note: all implementations of `Unsize` are provided automatically by the compiler, see <https://doc.rust-lang.org/stable/std/marker/trait.Unsize.html> for more information\n+   = note: required because of the requirements on the impl of `std::ops::DispatchFromDyn<&'a &'a U>` for `&'a &'a T`\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0277`."}]}