{"sha": "178652a2988d9ecd478a4116237e1d7ea6b777f7", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE3ODY1MmEyOTg4ZDllY2Q0NzhhNDExNjIzN2UxZDdlYTZiNzc3Zjc=", "commit": {"author": {"name": "David Wood", "email": "david@davidtw.co", "date": "2018-03-20T02:06:38Z"}, "committer": {"name": "David Wood", "email": "david@davidtw.co", "date": "2018-03-21T19:02:53Z"}, "message": "Add support to rustbuild for a 'rustc docs' component tarball", "tree": {"sha": "eb89d7ac57661da392eb2ae306f2e4cf2dbcfd5c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/eb89d7ac57661da392eb2ae306f2e4cf2dbcfd5c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/178652a2988d9ecd478a4116237e1d7ea6b777f7", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEWwgxPGhT5b/6kagXAXYLT59T8VQFAlqyrF0ACgkQAXYLT59T\n8VSb3w//YA8A93Y1/lHW2zqf/q83o/B+ZgKo8RLgZYwaYNAtDVq6Y314WGlOj1Cr\n1OM42e5Ou4De8pb82ChX7LlBk0k8xCaRBKGA0ZH/2AayTm2eV8p7t7q3mcqh1h6P\ncls9JPRlklLB+bMuwjxYZ0u3X4PIoPeqA12tiZHAAseZCbRhQldf3JpgfH4BgDh7\n3+6ALkLt+Soh/z54WASK8+NWL8lRlzKvDo1OVbYaISIqGvDeKEINhG9zVxH3pVcp\nV9T8224RZPR60vyKIP//Q8qFJWSWdfdPJq89cRasLcRtO77VbmR+Or31Dp5Vhc9B\n8WNXeeJZa/6SwUtVmIaYs59eKNPfIQY+XR9iBIXYvSVrYAetJtqWipTqIexs478j\nvWJmEBHfCVCRrVb/2yojyxDKqFeuYIl9bndjg3atb1UHv37yk/8In5phFA+zSeBg\nuvEPGFxYHescCx764FIAlxdpePuneCuKG9IwxEGsU/Qtg3Wf6H9ApBl/c8L1P2El\n6nc87cORyR6WzcUFYU1EezKD6CY8anL+KJR3gX04VTGq7tt2AaUWpmwVr6XSrqCX\nnVpq78ipRTLFHhrdUw9AoZRAEDNJycY2qTpd/mX1J+AKW9sMsfYW8I1Q5DxPwjZL\nHh4Y3o3CmiqYjAGhKMlOtY6we4JspmLlgg9ntKq3BG3xS0cKdOM=\n=HFc4\n-----END PGP SIGNATURE-----", "payload": "tree eb89d7ac57661da392eb2ae306f2e4cf2dbcfd5c\nparent a04b88d1941644df01fa5e31dd43e0f57c13d938\nauthor David Wood <david@davidtw.co> 1521511598 +0000\ncommitter David Wood <david@davidtw.co> 1521658973 +0000\n\nAdd support to rustbuild for a 'rustc docs' component tarball\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/178652a2988d9ecd478a4116237e1d7ea6b777f7", "html_url": "https://github.com/rust-lang/rust/commit/178652a2988d9ecd478a4116237e1d7ea6b777f7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/178652a2988d9ecd478a4116237e1d7ea6b777f7/comments", "author": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "committer": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a04b88d1941644df01fa5e31dd43e0f57c13d938", "url": "https://api.github.com/repos/rust-lang/rust/commits/a04b88d1941644df01fa5e31dd43e0f57c13d938", "html_url": "https://github.com/rust-lang/rust/commit/a04b88d1941644df01fa5e31dd43e0f57c13d938"}], "stats": {"total": 219, "additions": 178, "deletions": 41}, "files": [{"sha": "9f779da6f65b38be1041aa79631ea1603d09c578", "filename": "src/bootstrap/builder.rs", "status": "modified", "additions": 7, "deletions": 5, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/178652a2988d9ecd478a4116237e1d7ea6b777f7/src%2Fbootstrap%2Fbuilder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/178652a2988d9ecd478a4116237e1d7ea6b777f7/src%2Fbootstrap%2Fbuilder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuilder.rs?ref=178652a2988d9ecd478a4116237e1d7ea6b777f7", "patch": "@@ -316,11 +316,13 @@ impl<'a> Builder<'a> {\n                 test::Rustfmt, test::Miri, test::Clippy, test::RustdocJS, test::RustdocTheme),\n             Kind::Bench => describe!(test::Crate, test::CrateLibrustc),\n             Kind::Doc => describe!(doc::UnstableBook, doc::UnstableBookGen, doc::TheBook,\n-                doc::Standalone, doc::Std, doc::Test, doc::Rustc, doc::ErrorIndex, doc::Nomicon,\n-                doc::Reference, doc::Rustdoc, doc::RustByExample, doc::CargoBook),\n-            Kind::Dist => describe!(dist::Docs, dist::Mingw, dist::Rustc, dist::DebuggerScripts,\n-                dist::Std, dist::Analysis, dist::Src, dist::PlainSourceTarball, dist::Cargo,\n-                dist::Rls, dist::Rustfmt, dist::Extended, dist::HashSign),\n+                doc::Standalone, doc::Std, doc::Test, doc::WhitelistedRustc, doc::Rustc,\n+                doc::ErrorIndex, doc::Nomicon, doc::Reference, doc::Rustdoc, doc::RustByExample,\n+                doc::CargoBook),\n+            Kind::Dist => describe!(dist::Docs, dist::RustcDocs, dist::Mingw, dist::Rustc,\n+                dist::DebuggerScripts, dist::Std, dist::Analysis, dist::Src,\n+                dist::PlainSourceTarball, dist::Cargo, dist::Rls, dist::Rustfmt, dist::Extended,\n+                dist::HashSign),\n             Kind::Install => describe!(install::Docs, install::Std, install::Cargo, install::Rls,\n                 install::Rustfmt, install::Analysis, install::Src, install::Rustc),\n         }"}, {"sha": "e25a7e185258653306f124168c33d8e78ebcb85e", "filename": "src/bootstrap/dist.rs", "status": "modified", "additions": 62, "deletions": 7, "changes": 69, "blob_url": "https://github.com/rust-lang/rust/blob/178652a2988d9ecd478a4116237e1d7ea6b777f7/src%2Fbootstrap%2Fdist.rs", "raw_url": "https://github.com/rust-lang/rust/raw/178652a2988d9ecd478a4116237e1d7ea6b777f7/src%2Fbootstrap%2Fdist.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fdist.rs?ref=178652a2988d9ecd478a4116237e1d7ea6b777f7", "patch": "@@ -102,7 +102,7 @@ impl Step for Docs {\n \n         let dst = image.join(\"share/doc/rust/html\");\n         t!(fs::create_dir_all(&dst));\n-        let src = build.out.join(host).join(\"doc\");\n+        let src = build.doc_out(host);\n         cp_r(&src, &dst);\n \n         let mut cmd = rust_installer(builder);\n@@ -120,14 +120,69 @@ impl Step for Docs {\n         build.run(&mut cmd);\n         t!(fs::remove_dir_all(&image));\n \n-        // As part of this step, *also* copy the docs directory to a directory which\n-        // buildbot typically uploads.\n-        if host == build.build {\n-            let dst = distdir(build).join(\"doc\").join(build.rust_package_vers());\n-            t!(fs::create_dir_all(&dst));\n-            cp_r(&src, &dst);\n+        distdir(build).join(format!(\"{}-{}.tar.gz\", name, host))\n+    }\n+}\n+\n+#[derive(Debug, Copy, Clone, Hash, PartialEq, Eq)]\n+pub struct RustcDocs {\n+    pub stage: u32,\n+    pub host: Interned<String>,\n+}\n+\n+impl Step for RustcDocs {\n+    type Output = PathBuf;\n+    const DEFAULT: bool = true;\n+\n+    fn should_run(run: ShouldRun) -> ShouldRun {\n+        run.path(\"src/librustc\")\n+    }\n+\n+    fn make_run(run: RunConfig) {\n+        run.builder.ensure(RustcDocs {\n+            stage: run.builder.top_stage,\n+            host: run.target,\n+        });\n+    }\n+\n+    /// Builds the `rustc-docs` installer component.\n+    fn run(self, builder: &Builder) -> PathBuf {\n+        let build = builder.build;\n+        let host = self.host;\n+\n+        let name = pkgname(build, \"rustc-docs\");\n+\n+        println!(\"Dist compiler docs ({})\", host);\n+        if !build.config.compiler_docs {\n+            println!(\"\\tskipping - compiler docs disabled\");\n+            return distdir(build).join(format!(\"{}-{}.tar.gz\", name, host));\n         }\n \n+        builder.default_doc(None);\n+\n+        let image = tmpdir(build).join(format!(\"{}-{}-image\", name, host));\n+        let _ = fs::remove_dir_all(&image);\n+\n+        let dst = image.join(\"share/doc/rustc/html\");\n+        t!(fs::create_dir_all(&dst));\n+        let src = build.compiler_doc_out(host);\n+        cp_r(&src, &dst);\n+\n+        let mut cmd = rust_installer(builder);\n+        cmd.arg(\"generate\")\n+           .arg(\"--product-name=Rustc-Documentation\")\n+           .arg(\"--rel-manifest-dir=rustlib\")\n+           .arg(\"--success-message=Rustc-documentation-is-installed.\")\n+           .arg(\"--image-dir\").arg(&image)\n+           .arg(\"--work-dir\").arg(&tmpdir(build))\n+           .arg(\"--output-dir\").arg(&distdir(build))\n+           .arg(format!(\"--package-name={}-{}\", name, host))\n+           .arg(\"--component-name=rustc-docs\")\n+           .arg(\"--legacy-manifest-dirs=rustlib,cargo\")\n+           .arg(\"--bulk-dirs=share/doc/rustc/html\");\n+        build.run(&mut cmd);\n+        t!(fs::remove_dir_all(&image));\n+\n         distdir(build).join(format!(\"{}-{}.tar.gz\", name, host))\n     }\n }"}, {"sha": "ca45adb4649afbb221d2de1a4f37a2ac2910e220", "filename": "src/bootstrap/doc.rs", "status": "modified", "additions": 104, "deletions": 29, "changes": 133, "blob_url": "https://github.com/rust-lang/rust/blob/178652a2988d9ecd478a4116237e1d7ea6b777f7/src%2Fbootstrap%2Fdoc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/178652a2988d9ecd478a4116237e1d7ea6b777f7/src%2Fbootstrap%2Fdoc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fdoc.rs?ref=178652a2988d9ecd478a4116237e1d7ea6b777f7", "patch": "@@ -483,21 +483,17 @@ impl Step for Std {\n         let mut cargo = builder.cargo(compiler, Mode::Libstd, target, \"doc\");\n         compile::std_cargo(builder, &compiler, target, &mut cargo);\n \n-        // We don't want to build docs for internal std dependencies unless\n-        // in compiler-docs mode. When not in that mode, we whitelist the crates\n-        // for which docs must be built.\n-        if !build.config.compiler_docs {\n-            cargo.arg(\"--no-deps\");\n-            for krate in &[\"alloc\", \"core\", \"std\", \"std_unicode\"] {\n-                cargo.arg(\"-p\").arg(krate);\n-                // Create all crate output directories first to make sure rustdoc uses\n-                // relative links.\n-                // FIXME: Cargo should probably do this itself.\n-                t!(fs::create_dir_all(out_dir.join(krate)));\n-            }\n+        // Keep a whitelist so we do not build internal stdlib crates, these will be\n+        // build by the rustc step later if enabled.\n+        cargo.arg(\"--no-deps\");\n+        for krate in &[\"alloc\", \"core\", \"std\", \"std_unicode\"] {\n+            cargo.arg(\"-p\").arg(krate);\n+            // Create all crate output directories first to make sure rustdoc uses\n+            // relative links.\n+            // FIXME: Cargo should probably do this itself.\n+            t!(fs::create_dir_all(out_dir.join(krate)));\n         }\n \n-\n         build.run(&mut cargo);\n         cp_r(&my_out, &out);\n     }\n@@ -563,6 +559,81 @@ impl Step for Test {\n     }\n }\n \n+#[derive(Debug, Copy, Clone, Hash, PartialEq, Eq)]\n+pub struct WhitelistedRustc {\n+    stage: u32,\n+    target: Interned<String>,\n+}\n+\n+impl Step for WhitelistedRustc {\n+    type Output = ();\n+    const DEFAULT: bool = true;\n+    const ONLY_HOSTS: bool = true;\n+\n+    fn should_run(run: ShouldRun) -> ShouldRun {\n+        let builder = run.builder;\n+        run.krate(\"rustc-main\").default_condition(builder.build.config.docs)\n+    }\n+\n+    fn make_run(run: RunConfig) {\n+        run.builder.ensure(WhitelistedRustc {\n+            stage: run.builder.top_stage,\n+            target: run.target,\n+        });\n+    }\n+\n+    /// Generate whitelisted compiler crate documentation.\n+    ///\n+    /// This will generate all documentation for crates that are whitelisted\n+    /// to be included in the standard documentation. This documentation is\n+    /// included in the standard Rust documentation, so we should always\n+    /// document it and symlink to merge with the rest of the std and test\n+    /// documentation. We don't build other compiler documentation\n+    /// here as we want to be able to keep it separate from the standard\n+    /// documentation. This is largely just a wrapper around `cargo doc`.\n+    fn run(self, builder: &Builder) {\n+        let build = builder.build;\n+        let stage = self.stage;\n+        let target = self.target;\n+        println!(\"Documenting stage{} whitelisted compiler ({})\", stage, target);\n+        let out = build.doc_out(target);\n+        t!(fs::create_dir_all(&out));\n+        let compiler = builder.compiler(stage, build.build);\n+        let rustdoc = builder.rustdoc(compiler.host);\n+        let compiler = if build.force_use_stage1(compiler, target) {\n+            builder.compiler(1, compiler.host)\n+        } else {\n+            compiler\n+        };\n+\n+        // Build libstd docs so that we generate relative links\n+        builder.ensure(Std { stage, target });\n+\n+        builder.ensure(compile::Rustc { compiler, target });\n+        let out_dir = build.stage_out(compiler, Mode::Librustc)\n+                           .join(target).join(\"doc\");\n+\n+        // See docs in std above for why we symlink\n+        let my_out = build.crate_doc_out(target);\n+        build.clear_if_dirty(&my_out, &rustdoc);\n+        t!(symlink_dir_force(&my_out, &out_dir));\n+\n+        let mut cargo = builder.cargo(compiler, Mode::Librustc, target, \"doc\");\n+        compile::rustc_cargo(build, &mut cargo);\n+\n+        // We don't want to build docs for internal compiler dependencies in this\n+        // step (there is another step for that). Therefore, we whitelist the crates\n+        // for which docs must be built.\n+        cargo.arg(\"--no-deps\");\n+        for krate in &[\"proc_macro\"] {\n+            cargo.arg(\"-p\").arg(krate);\n+        }\n+\n+        build.run(&mut cargo);\n+        cp_r(&my_out, &out);\n+    }\n+}\n+\n #[derive(Debug, Copy, Clone, Hash, PartialEq, Eq)]\n pub struct Rustc {\n     stage: u32,\n@@ -586,16 +657,18 @@ impl Step for Rustc {\n         });\n     }\n \n-    /// Generate all compiler documentation.\n+    /// Generate compiler documentation.\n     ///\n-    /// This will generate all documentation for the compiler libraries and their\n-    /// dependencies. This is largely just a wrapper around `cargo doc`.\n+    /// This will generate all documentation for compiler and dependencies.\n+    /// Compiler documentation is distributed separately, so we make sure\n+    /// we do not merge it with the other documentation from std, test and\n+    /// proc_macros. This is largely just a wrapper around `cargo doc`.\n     fn run(self, builder: &Builder) {\n         let build = builder.build;\n         let stage = self.stage;\n         let target = self.target;\n         println!(\"Documenting stage{} compiler ({})\", stage, target);\n-        let out = build.doc_out(target);\n+        let out = build.compiler_doc_out(target);\n         t!(fs::create_dir_all(&out));\n         let compiler = builder.compiler(stage, build.build);\n         let rustdoc = builder.rustdoc(compiler.host);\n@@ -605,6 +678,11 @@ impl Step for Rustc {\n             compiler\n         };\n \n+        if !build.config.compiler_docs {\n+            println!(\"\\tskipping - compiler docs disabled\");\n+            return;\n+        }\n+\n         // Build libstd docs so that we generate relative links\n         builder.ensure(Std { stage, target });\n \n@@ -613,25 +691,22 @@ impl Step for Rustc {\n                            .join(target).join(\"doc\");\n \n         // See docs in std above for why we symlink\n+        //\n+        // This step must happen after other documentation steps. This\n+        // invariant ensures that compiler documentation is not included\n+        // in the standard documentation tarballs but that all the\n+        // documentation from the standard documentation tarballs is included\n+        // in the compiler documentation tarball.\n         let my_out = build.crate_doc_out(target);\n         build.clear_if_dirty(&my_out, &rustdoc);\n         t!(symlink_dir_force(&my_out, &out_dir));\n \n         let mut cargo = builder.cargo(compiler, Mode::Librustc, target, \"doc\");\n         compile::rustc_cargo(build, &mut cargo);\n \n-        if build.config.compiler_docs {\n-            // src/rustc/Cargo.toml contains a bin crate called rustc which\n-            // would otherwise overwrite the docs for the real rustc lib crate.\n-            cargo.arg(\"-p\").arg(\"rustc_driver\");\n-        } else {\n-            // Like with libstd above if compiler docs aren't enabled then we're not\n-            // documenting internal dependencies, so we have a whitelist.\n-            cargo.arg(\"--no-deps\");\n-            for krate in &[\"proc_macro\"] {\n-                cargo.arg(\"-p\").arg(krate);\n-            }\n-        }\n+        // src/rustc/Cargo.toml contains a bin crate called rustc which\n+        // would otherwise overwrite the docs for the real rustc lib crate.\n+        cargo.arg(\"-p\").arg(\"rustc_driver\");\n \n         build.run(&mut cargo);\n         cp_r(&my_out, &out);"}, {"sha": "b2c8ac24d72d8cd752482158d2ada042f8fff929", "filename": "src/bootstrap/lib.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/178652a2988d9ecd478a4116237e1d7ea6b777f7/src%2Fbootstrap%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/178652a2988d9ecd478a4116237e1d7ea6b777f7/src%2Fbootstrap%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Flib.rs?ref=178652a2988d9ecd478a4116237e1d7ea6b777f7", "patch": "@@ -511,6 +511,11 @@ impl Build {\n         self.out.join(&*target).join(\"doc\")\n     }\n \n+    /// Output directory for all documentation for a target\n+    fn compiler_doc_out(&self, target: Interned<String>) -> PathBuf {\n+        self.out.join(&*target).join(\"compiler-doc\")\n+    }\n+\n     /// Output directory for some generated md crate documentation for a target (temporary)\n     fn md_doc_out(&self, target: Interned<String>) -> Interned<PathBuf> {\n         INTERNER.intern_path(self.out.join(&*target).join(\"md-doc\"))"}]}