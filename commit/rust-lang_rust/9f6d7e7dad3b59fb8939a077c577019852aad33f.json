{"sha": "9f6d7e7dad3b59fb8939a077c577019852aad33f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjlmNmQ3ZTdkYWQzYjU5ZmI4OTM5YTA3N2M1NzcwMTk4NTJhYWQzM2Y=", "commit": {"author": {"name": "Camille GILLOT", "email": "gillot.camille@gmail.com", "date": "2021-05-20T18:17:45Z"}, "committer": {"name": "Camille GILLOT", "email": "gillot.camille@gmail.com", "date": "2021-07-06T17:26:02Z"}, "message": "Correct comments about untracked accesses.", "tree": {"sha": "2b096193cf9b19bf9b5f8419afc4c998126f51d0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2b096193cf9b19bf9b5f8419afc4c998126f51d0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9f6d7e7dad3b59fb8939a077c577019852aad33f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9f6d7e7dad3b59fb8939a077c577019852aad33f", "html_url": "https://github.com/rust-lang/rust/commit/9f6d7e7dad3b59fb8939a077c577019852aad33f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9f6d7e7dad3b59fb8939a077c577019852aad33f/comments", "author": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "committer": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "071a047dc7815d4cf8fa3056106d56c0fdc9607a", "url": "https://api.github.com/repos/rust-lang/rust/commits/071a047dc7815d4cf8fa3056106d56c0fdc9607a", "html_url": "https://github.com/rust-lang/rust/commit/071a047dc7815d4cf8fa3056106d56c0fdc9607a"}], "stats": {"total": 44, "additions": 23, "deletions": 21}, "files": [{"sha": "0e924d644353ce22b9a9c930a9956a2599e86d3f", "filename": "compiler/rustc_metadata/src/rmeta/encoder.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/9f6d7e7dad3b59fb8939a077c577019852aad33f/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fencoder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9f6d7e7dad3b59fb8939a077c577019852aad33f/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fencoder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fencoder.rs?ref=9f6d7e7dad3b59fb8939a077c577019852aad33f", "patch": "@@ -445,7 +445,7 @@ impl<'a, 'tcx> EncodeContext<'a, 'tcx> {\n     }\n \n     fn encode_def_path_table(&mut self) {\n-        let table = self.tcx.hir().definitions().def_path_table();\n+        let table = self.tcx.resolutions(()).definitions.def_path_table();\n         if self.is_proc_macro {\n             for def_index in std::iter::once(CRATE_DEF_INDEX)\n                 .chain(self.tcx.hir().krate().proc_macros.iter().map(|p| p.owner.local_def_index))\n@@ -1062,7 +1062,7 @@ impl EncodeContext<'a, 'tcx> {\n \n         let data = ModData {\n             reexports,\n-            expansion: tcx.hir().definitions().expansion_that_defined(local_def_id),\n+            expansion: tcx.resolutions(()).definitions.expansion_that_defined(local_def_id),\n         };\n \n         record!(self.tables.kind[def_id] <- EntryKind::Mod(self.lazy(data)));\n@@ -1759,7 +1759,7 @@ impl EncodeContext<'a, 'tcx> {\n             .map(|(trait_def_id, mut impls)| {\n                 // Bring everything into deterministic order for hashing\n                 impls.sort_by_cached_key(|&(index, _)| {\n-                    tcx.hir().definitions().def_path_hash(LocalDefId { local_def_index: index })\n+                    tcx.hir().def_path_hash(LocalDefId { local_def_index: index })\n                 });\n \n                 TraitImpls {"}, {"sha": "6f799ea940b05c04bbc9c76a5a90c7b0550610ba", "filename": "compiler/rustc_middle/src/hir/map/mod.rs", "status": "modified", "additions": 14, "deletions": 12, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/9f6d7e7dad3b59fb8939a077c577019852aad33f/compiler%2Frustc_middle%2Fsrc%2Fhir%2Fmap%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9f6d7e7dad3b59fb8939a077c577019852aad33f/compiler%2Frustc_middle%2Fsrc%2Fhir%2Fmap%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fhir%2Fmap%2Fmod.rs?ref=9f6d7e7dad3b59fb8939a077c577019852aad33f", "patch": "@@ -9,7 +9,7 @@ use rustc_data_structures::stable_hasher::{HashStable, StableHasher};\n use rustc_data_structures::svh::Svh;\n use rustc_hir::def::{DefKind, Res};\n use rustc_hir::def_id::{CrateNum, DefId, LocalDefId, CRATE_DEF_INDEX, LOCAL_CRATE};\n-use rustc_hir::definitions::{DefKey, DefPath, Definitions};\n+use rustc_hir::definitions::{DefKey, DefPath, DefPathHash};\n use rustc_hir::intravisit;\n use rustc_hir::intravisit::Visitor;\n use rustc_hir::itemlikevisit::ItemLikeVisitor;\n@@ -154,14 +154,8 @@ impl<'hir> Map<'hir> {\n         self.tcx.hir_crate(())\n     }\n \n-    #[inline]\n-    pub fn definitions(&self) -> &'hir Definitions {\n-        // Accessing the definitions is ok, since all its contents are tracked by the query system.\n-        &self.tcx.untracked_resolutions.definitions\n-    }\n-\n     pub fn def_key(&self, def_id: LocalDefId) -> DefKey {\n-        // Accessing the definitions is ok, since all its contents are tracked by the query system.\n+        // Accessing the DefKey is ok, since it is part of DefPathHash.\n         self.tcx.untracked_resolutions.definitions.def_key(def_id)\n     }\n \n@@ -170,10 +164,16 @@ impl<'hir> Map<'hir> {\n     }\n \n     pub fn def_path(&self, def_id: LocalDefId) -> DefPath {\n-        // Accessing the definitions is ok, since all its contents are tracked by the query system.\n+        // Accessing the DefPath is ok, since it is part of DefPathHash.\n         self.tcx.untracked_resolutions.definitions.def_path(def_id)\n     }\n \n+    #[inline]\n+    pub fn def_path_hash(self, def_id: LocalDefId) -> DefPathHash {\n+        // Accessing the DefPathHash is ok, it is incr. comp. stable.\n+        self.tcx.untracked_resolutions.definitions.def_path_hash(def_id)\n+    }\n+\n     #[inline]\n     pub fn local_def_id(&self, hir_id: HirId) -> LocalDefId {\n         self.opt_local_def_id(hir_id).unwrap_or_else(|| {\n@@ -187,18 +187,20 @@ impl<'hir> Map<'hir> {\n \n     #[inline]\n     pub fn opt_local_def_id(&self, hir_id: HirId) -> Option<LocalDefId> {\n-        // Accessing the definitions is ok, since all its contents are tracked by the query system.\n+        // FIXME(#85914) is this access safe for incr. comp.?\n         self.tcx.untracked_resolutions.definitions.opt_hir_id_to_local_def_id(hir_id)\n     }\n \n     #[inline]\n     pub fn local_def_id_to_hir_id(&self, def_id: LocalDefId) -> HirId {\n-        // Accessing the definitions is ok, since all its contents are tracked by the query system.\n+        // FIXME(#85914) is this access safe for incr. comp.?\n         self.tcx.untracked_resolutions.definitions.local_def_id_to_hir_id(def_id)\n     }\n \n     pub fn iter_local_def_id(&self) -> impl Iterator<Item = LocalDefId> + '_ {\n-        // Accessing the definitions is ok, since all its contents are tracked by the query system.\n+        // Create a dependency to the crate to be sure we reexcute this when the amount of\n+        // definitions change.\n+        self.tcx.ensure().hir_crate(());\n         self.tcx.untracked_resolutions.definitions.iter_local_def_id()\n     }\n "}, {"sha": "1afeb4a138f9da1334d428a90bf007684ad4186f", "filename": "compiler/rustc_middle/src/ty/context.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/9f6d7e7dad3b59fb8939a077c577019852aad33f/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9f6d7e7dad3b59fb8939a077c577019852aad33f/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs?ref=9f6d7e7dad3b59fb8939a077c577019852aad33f", "patch": "@@ -1240,9 +1240,9 @@ impl<'tcx> TyCtxt<'tcx> {\n     }\n \n     pub fn def_key(self, id: DefId) -> rustc_hir::definitions::DefKey {\n-        // Accessing the definitions is ok, since all its contents are tracked by the query system.\n+        // Accessing the DefKey is ok, since it is part of DefPathHash.\n         if let Some(id) = id.as_local() {\n-            self.hir().def_key(id)\n+            self.untracked_resolutions.definitions.def_key(id)\n         } else {\n             self.untracked_resolutions.cstore.def_key(id)\n         }\n@@ -1254,17 +1254,17 @@ impl<'tcx> TyCtxt<'tcx> {\n     /// Note that if `id` is not local to this crate, the result will\n     ///  be a non-local `DefPath`.\n     pub fn def_path(self, id: DefId) -> rustc_hir::definitions::DefPath {\n-        // Accessing the definitions is ok, since all its contents are tracked by the query system.\n+        // Accessing the DefPath is ok, since it is part of DefPathHash.\n         if let Some(id) = id.as_local() {\n-            self.hir().def_path(id)\n+            self.untracked_resolutions.definitions.def_path(id)\n         } else {\n             self.untracked_resolutions.cstore.def_path(id)\n         }\n     }\n \n     #[inline]\n     pub fn def_path_hash(self, def_id: DefId) -> rustc_hir::definitions::DefPathHash {\n-        // Accessing the definitions is ok, since all its contents are tracked by the query system.\n+        // Accessing the DefPathHash is ok, it is incr. comp. stable.\n         if let Some(def_id) = def_id.as_local() {\n             self.untracked_resolutions.definitions.def_path_hash(def_id)\n         } else {"}, {"sha": "fa48df3ed45c63e2ba1fe338de8e8f2dae996155", "filename": "compiler/rustc_query_impl/src/stats.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/9f6d7e7dad3b59fb8939a077c577019852aad33f/compiler%2Frustc_query_impl%2Fsrc%2Fstats.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9f6d7e7dad3b59fb8939a077c577019852aad33f/compiler%2Frustc_query_impl%2Fsrc%2Fstats.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_query_impl%2Fsrc%2Fstats.rs?ref=9f6d7e7dad3b59fb8939a077c577019852aad33f", "patch": "@@ -108,7 +108,7 @@ pub fn print_stats(tcx: TyCtxt<'_>) {\n         queries.iter().filter(|q| q.local_def_id_keys.is_some()).collect();\n     def_id_density.sort_by_key(|q| q.local_def_id_keys.unwrap());\n     eprintln!(\"\\nLocal DefId density:\");\n-    let total = tcx.hir().definitions().def_index_count() as f64;\n+    let total = tcx.resolutions(()).definitions.def_index_count() as f64;\n     for q in def_id_density.iter().rev() {\n         let local = q.local_def_id_keys.unwrap();\n         eprintln!(\"   {} - {} = ({}%)\", q.name, local, (local as f64 * 100.0) / total);"}]}