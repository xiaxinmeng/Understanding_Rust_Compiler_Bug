{"sha": "235f96005cb3c94f4f3d185e7c3d4ffaa08685aa", "node_id": "MDY6Q29tbWl0NzI0NzEyOjIzNWY5NjAwNWNiM2M5NGY0ZjNkMTg1ZTdjM2Q0ZmZhYTA4Njg1YWE=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-01-18T08:27:06Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-01-18T08:27:06Z"}, "message": "Auto merge of #3669 - avborhanian:extra_results_files, r=oli-obk\n\nCheck for results files missing tests\n\nAddresses #3572.\n\nBasically iterates over all the files, and if it sees any files that don't have a matching rs file, it throws an error.", "tree": {"sha": "362b52fa089ba91fb8c3c9f2ab4c794ebe6a3028", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/362b52fa089ba91fb8c3c9f2ab4c794ebe6a3028"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/235f96005cb3c94f4f3d185e7c3d4ffaa08685aa", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/235f96005cb3c94f4f3d185e7c3d4ffaa08685aa", "html_url": "https://github.com/rust-lang/rust/commit/235f96005cb3c94f4f3d185e7c3d4ffaa08685aa", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/235f96005cb3c94f4f3d185e7c3d4ffaa08685aa/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f48e605ec4cb68870ee0138a463fa77323d2cd6f", "url": "https://api.github.com/repos/rust-lang/rust/commits/f48e605ec4cb68870ee0138a463fa77323d2cd6f", "html_url": "https://github.com/rust-lang/rust/commit/f48e605ec4cb68870ee0138a463fa77323d2cd6f"}, {"sha": "38b3a4ec6309429a6ea4acced6dc2d5e1d745622", "url": "https://api.github.com/repos/rust-lang/rust/commits/38b3a4ec6309429a6ea4acced6dc2d5e1d745622", "html_url": "https://github.com/rust-lang/rust/commit/38b3a4ec6309429a6ea4acced6dc2d5e1d745622"}], "stats": {"total": 54, "additions": 54, "deletions": 0}, "files": [{"sha": "558e001d3d10bdacbfc7349220786aa5bb1a057d", "filename": "tests/missing-test-files.rs", "status": "added", "additions": 54, "deletions": 0, "changes": 54, "blob_url": "https://github.com/rust-lang/rust/blob/235f96005cb3c94f4f3d185e7c3d4ffaa08685aa/tests%2Fmissing-test-files.rs", "raw_url": "https://github.com/rust-lang/rust/raw/235f96005cb3c94f4f3d185e7c3d4ffaa08685aa/tests%2Fmissing-test-files.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmissing-test-files.rs?ref=235f96005cb3c94f4f3d185e7c3d4ffaa08685aa", "patch": "@@ -0,0 +1,54 @@\n+use std::fs::{self, DirEntry};\n+use std::path::Path;\n+\n+#[test]\n+fn test_missing_tests() {\n+    let missing_files = explore_directory(Path::new(\"./tests\"));\n+    if !missing_files.is_empty() {\n+        assert!(\n+            false,\n+            format!(\n+                \"Didn't see a test file for the following files:\\n\\n{}\\n\",\n+                missing_files\n+                    .iter()\n+                    .map(|s| format!(\"\\t{}\", s))\n+                    .collect::<Vec<_>>()\n+                    .join(\"\\n\")\n+            )\n+        );\n+    }\n+}\n+\n+/*\n+Test for missing files.\n+\n+Since rs files are alphabetically before stderr/stdout, we can sort by the full name\n+and iter in that order. If we've seen the file stem for the first time and it's not\n+a rust file, it means the rust file has to be missing.\n+*/\n+fn explore_directory(dir: &Path) -> Vec<String> {\n+    let mut missing_files: Vec<String> = Vec::new();\n+    let mut current_file = String::new();\n+    let mut files: Vec<DirEntry> = fs::read_dir(dir).unwrap().filter_map(Result::ok).collect();\n+    files.sort_by_key(|e| e.path());\n+    for entry in &files {\n+        let path = entry.path();\n+        if path.is_dir() {\n+            missing_files.extend(explore_directory(&path));\n+        } else {\n+            let file_stem = path.file_stem().unwrap().to_str().unwrap().to_string();\n+            if let Some(ext) = path.extension() {\n+                match ext.to_str().unwrap() {\n+                    \"rs\" => current_file = file_stem.clone(),\n+                    \"stderr\" | \"stdout\" => {\n+                        if file_stem != current_file {\n+                            missing_files.push(path.to_str().unwrap().to_string());\n+                        }\n+                    },\n+                    _ => continue,\n+                };\n+            }\n+        }\n+    }\n+    missing_files\n+}"}]}