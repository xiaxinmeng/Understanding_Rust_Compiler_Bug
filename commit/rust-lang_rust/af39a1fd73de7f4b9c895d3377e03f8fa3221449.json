{"sha": "af39a1fd73de7f4b9c895d3377e03f8fa3221449", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFmMzlhMWZkNzNkZTdmNGI5Yzg5NWQzMzc3ZTAzZjhmYTMyMjE0NDk=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-05-11T09:24:45Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-05-11T09:24:45Z"}, "message": "Auto merge of #60717 - varkor:impl-const-generic, r=matthewjasper\n\nFix a bug preventing const parameters from being used in const generic impls\n\nFixes https://github.com/rust-lang/rust/issues/60712.", "tree": {"sha": "1dca4bf55864e9c2fc95391236b26b737a07d834", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1dca4bf55864e9c2fc95391236b26b737a07d834"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/af39a1fd73de7f4b9c895d3377e03f8fa3221449", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/af39a1fd73de7f4b9c895d3377e03f8fa3221449", "html_url": "https://github.com/rust-lang/rust/commit/af39a1fd73de7f4b9c895d3377e03f8fa3221449", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/af39a1fd73de7f4b9c895d3377e03f8fa3221449/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b8e0d0a2aa4f18d76a701150fccb67533f377368", "url": "https://api.github.com/repos/rust-lang/rust/commits/b8e0d0a2aa4f18d76a701150fccb67533f377368", "html_url": "https://github.com/rust-lang/rust/commit/b8e0d0a2aa4f18d76a701150fccb67533f377368"}, {"sha": "b3207d531d01c1dc6c1f3d4e7b1c20a1546fe108", "url": "https://api.github.com/repos/rust-lang/rust/commits/b3207d531d01c1dc6c1f3d4e7b1c20a1546fe108", "html_url": "https://github.com/rust-lang/rust/commit/b3207d531d01c1dc6c1f3d4e7b1c20a1546fe108"}], "stats": {"total": 35, "additions": 34, "deletions": 1}, "files": [{"sha": "da47ccf38a0263416dba53b6d62585b2d90a1955", "filename": "src/librustc_typeck/astconv.rs", "status": "modified", "additions": 12, "deletions": 1, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/af39a1fd73de7f4b9c895d3377e03f8fa3221449/src%2Flibrustc_typeck%2Fastconv.rs", "raw_url": "https://github.com/rust-lang/rust/raw/af39a1fd73de7f4b9c895d3377e03f8fa3221449/src%2Flibrustc_typeck%2Fastconv.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fastconv.rs?ref=af39a1fd73de7f4b9c895d3377e03f8fa3221449", "patch": "@@ -1902,7 +1902,18 @@ impl<'o, 'gcx: 'tcx, 'tcx> dyn AstConv<'gcx, 'tcx> + 'o {\n             ty,\n         };\n \n-        let expr = &tcx.hir().body(ast_const.body).value;\n+        let mut expr = &tcx.hir().body(ast_const.body).value;\n+\n+        // Unwrap a block, so that e.g. `{ P }` is recognised as a parameter. Const arguments\n+        // currently have to be wrapped in curly brackets, so it's necessary to special-case.\n+        if let ExprKind::Block(block, _) = &expr.node {\n+            if block.stmts.is_empty() {\n+                if let Some(trailing) = &block.expr {\n+                    expr = &trailing;\n+                }\n+            }\n+        }\n+\n         if let ExprKind::Path(ref qpath) = expr.node {\n             if let hir::QPath::Resolved(_, ref path) = qpath {\n                 if let Res::Def(DefKind::ConstParam, def_id) = path.res {"}, {"sha": "7a0c0f2be5d7ac6cc1a54715d21d3e77fe9db9b3", "filename": "src/test/ui/const-generics/impl-const-generic-struct.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/af39a1fd73de7f4b9c895d3377e03f8fa3221449/src%2Ftest%2Fui%2Fconst-generics%2Fimpl-const-generic-struct.rs", "raw_url": "https://github.com/rust-lang/rust/raw/af39a1fd73de7f4b9c895d3377e03f8fa3221449/src%2Ftest%2Fui%2Fconst-generics%2Fimpl-const-generic-struct.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconst-generics%2Fimpl-const-generic-struct.rs?ref=af39a1fd73de7f4b9c895d3377e03f8fa3221449", "patch": "@@ -0,0 +1,16 @@\n+// run-pass\n+\n+#![feature(const_generics)]\n+//~^ WARN the feature `const_generics` is incomplete and may cause the compiler to crash\n+\n+struct S<const X: u32>;\n+\n+impl<const X: u32> S<{X}> {\n+    fn x() -> u32 {\n+        X\n+    }\n+}\n+\n+fn main() {\n+    assert_eq!(S::<19>::x(), 19);\n+}"}, {"sha": "d443e060a9747aa5285de3926f7793f33cff05e6", "filename": "src/test/ui/const-generics/impl-const-generic-struct.stderr", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/af39a1fd73de7f4b9c895d3377e03f8fa3221449/src%2Ftest%2Fui%2Fconst-generics%2Fimpl-const-generic-struct.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/af39a1fd73de7f4b9c895d3377e03f8fa3221449/src%2Ftest%2Fui%2Fconst-generics%2Fimpl-const-generic-struct.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconst-generics%2Fimpl-const-generic-struct.stderr?ref=af39a1fd73de7f4b9c895d3377e03f8fa3221449", "patch": "@@ -0,0 +1,6 @@\n+warning: the feature `const_generics` is incomplete and may cause the compiler to crash\n+  --> $DIR/impl-const-generic-struct.rs:3:12\n+   |\n+LL | #![feature(const_generics)]\n+   |            ^^^^^^^^^^^^^^\n+"}]}