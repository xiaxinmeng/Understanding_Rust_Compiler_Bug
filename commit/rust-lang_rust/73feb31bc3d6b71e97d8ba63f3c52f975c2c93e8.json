{"sha": "73feb31bc3d6b71e97d8ba63f3c52f975c2c93e8", "node_id": "MDY6Q29tbWl0NzI0NzEyOjczZmViMzFiYzNkNmI3MWU5N2Q4YmE2M2YzYzUyZjk3NWMyYzkzZTg=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-12-19T12:28:00Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-12-19T12:28:00Z"}, "message": "Auto merge of #6471 - phansch:fix-bless, r=flip1995\n\nFix blessing of new reference files\n\nAdding of new reference files wasn't handled correctly. It was trying to\nread a file that didn't exist yet.\n\nInstead of unwrapping, we now treat a missing reference file as empty\n(`Vec::new`). This makes the following conditional work. We then also\nhave to re-read the reference file after it was being copied. This\nsecond read is technically the same as in the old shell script, but\nwasn't really obvious there. The shell script did a `-s` test which\nreads the file as well.\n\nchangelog: internal: Fix `cargo dev bless` when new reference files are added", "tree": {"sha": "6035879ac45e514c16d19c29891573e402e97f6d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6035879ac45e514c16d19c29891573e402e97f6d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/73feb31bc3d6b71e97d8ba63f3c52f975c2c93e8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/73feb31bc3d6b71e97d8ba63f3c52f975c2c93e8", "html_url": "https://github.com/rust-lang/rust/commit/73feb31bc3d6b71e97d8ba63f3c52f975c2c93e8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/73feb31bc3d6b71e97d8ba63f3c52f975c2c93e8/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0718eeb64849b00e8f0a5cc4f96603b61ff8c049", "url": "https://api.github.com/repos/rust-lang/rust/commits/0718eeb64849b00e8f0a5cc4f96603b61ff8c049", "html_url": "https://github.com/rust-lang/rust/commit/0718eeb64849b00e8f0a5cc4f96603b61ff8c049"}, {"sha": "dfb4ea588c2af7633b2d01d2dfa3d6ffc7d07ee7", "url": "https://api.github.com/repos/rust-lang/rust/commits/dfb4ea588c2af7633b2d01d2dfa3d6ffc7d07ee7", "html_url": "https://github.com/rust-lang/rust/commit/dfb4ea588c2af7633b2d01d2dfa3d6ffc7d07ee7"}], "stats": {"total": 5, "additions": 4, "deletions": 1}, "files": [{"sha": "645098e4cfcd2703c2e6db29522257b637825033", "filename": "clippy_dev/src/bless.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/73feb31bc3d6b71e97d8ba63f3c52f975c2c93e8/clippy_dev%2Fsrc%2Fbless.rs", "raw_url": "https://github.com/rust-lang/rust/raw/73feb31bc3d6b71e97d8ba63f3c52f975c2c93e8/clippy_dev%2Fsrc%2Fbless.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_dev%2Fsrc%2Fbless.rs?ref=73feb31bc3d6b71e97d8ba63f3c52f975c2c93e8", "patch": "@@ -46,13 +46,16 @@ fn update_reference_file(reference_file_path: PathBuf) {\n     }\n \n     let test_output_file = fs::read(&test_output_path).expect(\"Unable to read test output file\");\n-    let reference_file = fs::read(&reference_file_path).expect(\"Unable to read reference file\");\n+    let reference_file = fs::read(&reference_file_path).unwrap_or_default();\n \n     if test_output_file != reference_file {\n         // If a test run caused an output file to change, update the reference file\n         println!(\"updating {}\", &relative_reference_file_path.display());\n         fs::copy(test_output_path, &reference_file_path).expect(\"Could not update reference file\");\n \n+        // We need to re-read the file now because it was potentially updated from copying\n+        let reference_file = fs::read(&reference_file_path).unwrap_or_default();\n+\n         if reference_file.is_empty() {\n             // If we copied over an empty output file, we remove the now empty reference file\n             println!(\"removing {}\", &relative_reference_file_path.display());"}]}