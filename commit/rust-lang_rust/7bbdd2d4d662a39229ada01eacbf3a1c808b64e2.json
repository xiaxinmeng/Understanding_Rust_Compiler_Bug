{"sha": "7bbdd2d4d662a39229ada01eacbf3a1c808b64e2", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdiYmRkMmQ0ZDY2MmEzOTIyOWFkYTAxZWFjYmYzYTFjODA4YjY0ZTI=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2020-03-15T01:28:48Z"}, "committer": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2020-04-17T18:36:46Z"}, "message": "Adjust mir-opt test and make it drop something", "tree": {"sha": "d6af8dd6974c0c7c030b7a9a295e58dab735d86d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d6af8dd6974c0c7c030b7a9a295e58dab735d86d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7bbdd2d4d662a39229ada01eacbf3a1c808b64e2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7bbdd2d4d662a39229ada01eacbf3a1c808b64e2", "html_url": "https://github.com/rust-lang/rust/commit/7bbdd2d4d662a39229ada01eacbf3a1c808b64e2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7bbdd2d4d662a39229ada01eacbf3a1c808b64e2/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "50c1c295ee730fa5fbc3baf4b57ceceedfbb20f2", "url": "https://api.github.com/repos/rust-lang/rust/commits/50c1c295ee730fa5fbc3baf4b57ceceedfbb20f2", "html_url": "https://github.com/rust-lang/rust/commit/50c1c295ee730fa5fbc3baf4b57ceceedfbb20f2"}], "stats": {"total": 86, "additions": 57, "deletions": 29}, "files": [{"sha": "97994b465b54ca618aed20c0cec6af8143959ffc", "filename": "src/librustc_ty/needs_drop.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/7bbdd2d4d662a39229ada01eacbf3a1c808b64e2/src%2Flibrustc_ty%2Fneeds_drop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7bbdd2d4d662a39229ada01eacbf3a1c808b64e2/src%2Flibrustc_ty%2Fneeds_drop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_ty%2Fneeds_drop.rs?ref=7bbdd2d4d662a39229ada01eacbf3a1c808b64e2", "patch": "@@ -99,13 +99,13 @@ where\n                         }\n                     }\n \n-                    ty::Generator(def_id, substs, _) => {\n+                    ty::Generator(_, substs, _) => {\n                         let substs = substs.as_generator();\n-                        for upvar_ty in substs.upvar_tys(def_id, tcx) {\n+                        for upvar_ty in substs.upvar_tys() {\n                             queue_type(self, upvar_ty);\n                         }\n \n-                        let witness = substs.witness(def_id, tcx);\n+                        let witness = substs.witness();\n                         let interior_tys = match &witness.kind {\n                             ty::GeneratorWitness(tys) => tcx.erase_late_bound_regions(tys),\n                             _ => bug!(),"}, {"sha": "0cfc2c28cb2aba25a8015aa1419cc44d8abacdcb", "filename": "src/test/mir-opt/generator-drop-cleanup.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7bbdd2d4d662a39229ada01eacbf3a1c808b64e2/src%2Ftest%2Fmir-opt%2Fgenerator-drop-cleanup.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7bbdd2d4d662a39229ada01eacbf3a1c808b64e2/src%2Ftest%2Fmir-opt%2Fgenerator-drop-cleanup.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fgenerator-drop-cleanup.rs?ref=7bbdd2d4d662a39229ada01eacbf3a1c808b64e2", "patch": "@@ -6,6 +6,7 @@\n // EMIT_MIR rustc.main-{{closure}}.generator_drop.0.mir\n fn main() {\n     let gen = || {\n+        let _s = String::new();\n         yield;\n     };\n }"}, {"sha": "8cc90d01c34b849862824be176860d7592b0e8e7", "filename": "src/test/mir-opt/generator-drop-cleanup/rustc.main-{{closure}}.generator_drop.0.mir", "status": "modified", "additions": 53, "deletions": 26, "changes": 79, "blob_url": "https://github.com/rust-lang/rust/blob/7bbdd2d4d662a39229ada01eacbf3a1c808b64e2/src%2Ftest%2Fmir-opt%2Fgenerator-drop-cleanup%2Frustc.main-%7B%7Bclosure%7D%7D.generator_drop.0.mir", "raw_url": "https://github.com/rust-lang/rust/raw/7bbdd2d4d662a39229ada01eacbf3a1c808b64e2/src%2Ftest%2Fmir-opt%2Fgenerator-drop-cleanup%2Frustc.main-%7B%7Bclosure%7D%7D.generator_drop.0.mir", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fgenerator-drop-cleanup%2Frustc.main-%7B%7Bclosure%7D%7D.generator_drop.0.mir?ref=7bbdd2d4d662a39229ada01eacbf3a1c808b64e2", "patch": "@@ -1,53 +1,80 @@\n // MIR for `main::{{closure}}#0` 0 generator_drop\n-// generator_layout = GeneratorLayout { field_tys: [], variant_fields: [[], [], [], []], storage_conflicts: BitMatrix { num_rows: 0, num_columns: 0, words: [], marker: PhantomData } }\n+// generator_layout = GeneratorLayout { field_tys: [std::string::String], variant_fields: [[], [], [], [_0]], storage_conflicts: BitMatrix { num_rows: 1, num_columns: 1, words: [1], marker: PhantomData } }\n \n-fn main::{{closure}}#0(_1: *mut [generator@$DIR/generator-drop-cleanup.rs:8:15: 10:6 {()}]) -> () {\n-    let mut _0: ();                      // return place in scope 0 at $DIR/generator-drop-cleanup.rs:8:15: 10:6\n-    let mut _2: ();                      // in scope 0 at $DIR/generator-drop-cleanup.rs:8:15: 10:6\n-    let _3: ();                          // in scope 0 at $DIR/generator-drop-cleanup.rs:9:9: 9:14\n-    let mut _4: ();                      // in scope 0 at $DIR/generator-drop-cleanup.rs:9:9: 9:14\n-    let mut _5: ();                      // in scope 0 at $DIR/generator-drop-cleanup.rs:8:18: 8:18\n-    let mut _6: ();                      // in scope 0 at $DIR/generator-drop-cleanup.rs:8:15: 10:6\n-    let mut _7: isize;                   // in scope 0 at $DIR/generator-drop-cleanup.rs:8:15: 10:6\n+fn main::{{closure}}#0(_1: *mut [generator@$DIR/generator-drop-cleanup.rs:8:15: 11:6 {std::string::String, ()}]) -> () {\n+    let mut _0: ();                      // return place in scope 0 at $DIR/generator-drop-cleanup.rs:8:15: 11:6\n+    let mut _2: ();                      // in scope 0 at $DIR/generator-drop-cleanup.rs:8:15: 11:6\n+    let _3: std::string::String;         // in scope 0 at $DIR/generator-drop-cleanup.rs:9:13: 9:15\n+    let _4: ();                          // in scope 0 at $DIR/generator-drop-cleanup.rs:10:9: 10:14\n+    let mut _5: ();                      // in scope 0 at $DIR/generator-drop-cleanup.rs:10:9: 10:14\n+    let mut _7: ();                      // in scope 0 at $DIR/generator-drop-cleanup.rs:8:18: 8:18\n+    let mut _8: ();                      // in scope 0 at $DIR/generator-drop-cleanup.rs:8:15: 11:6\n+    let mut _9: isize;                   // in scope 0 at $DIR/generator-drop-cleanup.rs:8:15: 11:6\n+    scope 1 {\n+        debug _s => (((*_1) as variant#3).0: std::string::String); // in scope 1 at $DIR/generator-drop-cleanup.rs:9:13: 9:15\n+    }\n+    scope 2 {\n+        let mut _6: std::vec::Vec<u8>;   // in scope 2 at $DIR/generator-drop-cleanup.rs:9:18: 9:31\n+        scope 3 {\n+        }\n+    }\n \n     bb0: {\n-        _7 = discriminant((*_1));        // bb0[0]: scope 0 at $DIR/generator-drop-cleanup.rs:8:15: 10:6\n-        switchInt(move _7) -> [0u32: bb4, 3u32: bb7, otherwise: bb8]; // bb0[1]: scope 0 at $DIR/generator-drop-cleanup.rs:8:15: 10:6\n+        _9 = discriminant((*_1));        // bb0[0]: scope 0 at $DIR/generator-drop-cleanup.rs:8:15: 11:6\n+        switchInt(move _9) -> [0u32: bb7, 3u32: bb11, otherwise: bb12]; // bb0[1]: scope 0 at $DIR/generator-drop-cleanup.rs:8:15: 11:6\n     }\n \n-    bb1: {\n-        StorageDead(_4);                 // bb1[0]: scope 0 at $DIR/generator-drop-cleanup.rs:9:13: 9:14\n-        StorageDead(_3);                 // bb1[1]: scope 0 at $DIR/generator-drop-cleanup.rs:9:14: 9:15\n-        goto -> bb5;                     // bb1[2]: scope 0 at $DIR/generator-drop-cleanup.rs:10:5: 10:6\n+    bb1 (cleanup): {\n+        resume;                          // bb1[0]: scope 0 at $DIR/generator-drop-cleanup.rs:8:15: 11:6\n     }\n \n-    bb2: {\n-        return;                          // bb2[0]: scope 0 at $DIR/generator-drop-cleanup.rs:8:15: 10:6\n+    bb2 (cleanup): {\n+        nop;                             // bb2[0]: scope 0 at $DIR/generator-drop-cleanup.rs:11:5: 11:6\n+        goto -> bb8;                     // bb2[1]: scope 0 at $DIR/generator-drop-cleanup.rs:11:5: 11:6\n     }\n \n     bb3: {\n-        return;                          // bb3[0]: scope 0 at $DIR/generator-drop-cleanup.rs:8:15: 10:6\n+        StorageDead(_5);                 // bb3[0]: scope 1 at $DIR/generator-drop-cleanup.rs:10:13: 10:14\n+        StorageDead(_4);                 // bb3[1]: scope 1 at $DIR/generator-drop-cleanup.rs:10:14: 10:15\n+        drop((((*_1) as variant#3).0: std::string::String)) -> [return: bb4, unwind: bb2]; // bb3[2]: scope 0 at $DIR/generator-drop-cleanup.rs:11:5: 11:6\n     }\n \n     bb4: {\n-        goto -> bb6;                     // bb4[0]: scope 0 at $DIR/generator-drop-cleanup.rs:8:15: 10:6\n+        nop;                             // bb4[0]: scope 0 at $DIR/generator-drop-cleanup.rs:11:5: 11:6\n+        goto -> bb9;                     // bb4[1]: scope 0 at $DIR/generator-drop-cleanup.rs:11:5: 11:6\n     }\n \n     bb5: {\n-        goto -> bb2;                     // bb5[0]: scope 0 at $DIR/generator-drop-cleanup.rs:10:5: 10:6\n+        return;                          // bb5[0]: scope 0 at $DIR/generator-drop-cleanup.rs:8:15: 11:6\n     }\n \n     bb6: {\n-        goto -> bb3;                     // bb6[0]: scope 0 at $DIR/generator-drop-cleanup.rs:8:15: 10:6\n+        return;                          // bb6[0]: scope 0 at $DIR/generator-drop-cleanup.rs:8:15: 11:6\n     }\n \n     bb7: {\n-        StorageLive(_3);                 // bb7[0]: scope 0 at $DIR/generator-drop-cleanup.rs:8:15: 10:6\n-        StorageLive(_4);                 // bb7[1]: scope 0 at $DIR/generator-drop-cleanup.rs:8:15: 10:6\n-        goto -> bb1;                     // bb7[2]: scope 0 at $DIR/generator-drop-cleanup.rs:8:15: 10:6\n+        goto -> bb10;                    // bb7[0]: scope 0 at $DIR/generator-drop-cleanup.rs:8:15: 11:6\n+    }\n+\n+    bb8 (cleanup): {\n+        goto -> bb1;                     // bb8[0]: scope 0 at $DIR/generator-drop-cleanup.rs:11:5: 11:6\n+    }\n+\n+    bb9: {\n+        goto -> bb5;                     // bb9[0]: scope 0 at $DIR/generator-drop-cleanup.rs:11:5: 11:6\n+    }\n+\n+    bb10: {\n+        goto -> bb6;                     // bb10[0]: scope 0 at $DIR/generator-drop-cleanup.rs:8:15: 11:6\n+    }\n+\n+    bb11: {\n+        StorageLive(_4);                 // bb11[0]: scope 0 at $DIR/generator-drop-cleanup.rs:8:15: 11:6\n+        StorageLive(_5);                 // bb11[1]: scope 0 at $DIR/generator-drop-cleanup.rs:8:15: 11:6\n+        goto -> bb3;                     // bb11[2]: scope 0 at $DIR/generator-drop-cleanup.rs:8:15: 11:6\n     }\n \n-    bb8: {\n-        return;                          // bb8[0]: scope 0 at $DIR/generator-drop-cleanup.rs:8:15: 10:6\n+    bb12: {\n+        return;                          // bb12[0]: scope 0 at $DIR/generator-drop-cleanup.rs:8:15: 11:6\n     }\n }"}]}