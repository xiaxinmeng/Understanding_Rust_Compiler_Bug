{"sha": "fb2c27d73f3528da5585bc7e49254164e0a2a5a2", "node_id": "C_kwDOAAsO6NoAKGZiMmMyN2Q3M2YzNTI4ZGE1NTg1YmM3ZTQ5MjU0MTY0ZTBhMmE1YTI", "commit": {"author": {"name": "Matthew Maurer", "email": "mmaurer@google.com", "date": "2022-12-28T22:31:31Z"}, "committer": {"name": "Matthew Maurer", "email": "mmaurer@google.com", "date": "2022-12-29T18:21:07Z"}, "message": "CFI: Monomorphize transparent ADTs before typeid\n\nMonomorphise `#[repr(transparent)]` parameterized ADTs before turning\nthem into an Itanium mangled String.\n\n`#[repr(transparent)]` ADTs currently use the single field to represent\nthem in their CFI type ID to ensure that they are compatible. However,\nif that type involves a type parameter instantiated at the ADT level, as\nin `ManuallyDrop`, this will currently ICE as the `Parameter` type\ncannot be mangled. Since this happens at lowering time, it should always\nbe concrete after substitution.\n\nFixes #106230", "tree": {"sha": "dc51f9bf040feec6a3fa60c6ac57135920050181", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/dc51f9bf040feec6a3fa60c6ac57135920050181"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fb2c27d73f3528da5585bc7e49254164e0a2a5a2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fb2c27d73f3528da5585bc7e49254164e0a2a5a2", "html_url": "https://github.com/rust-lang/rust/commit/fb2c27d73f3528da5585bc7e49254164e0a2a5a2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fb2c27d73f3528da5585bc7e49254164e0a2a5a2/comments", "author": {"login": "maurer", "id": 136037, "node_id": "MDQ6VXNlcjEzNjAzNw==", "avatar_url": "https://avatars.githubusercontent.com/u/136037?v=4", "gravatar_id": "", "url": "https://api.github.com/users/maurer", "html_url": "https://github.com/maurer", "followers_url": "https://api.github.com/users/maurer/followers", "following_url": "https://api.github.com/users/maurer/following{/other_user}", "gists_url": "https://api.github.com/users/maurer/gists{/gist_id}", "starred_url": "https://api.github.com/users/maurer/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/maurer/subscriptions", "organizations_url": "https://api.github.com/users/maurer/orgs", "repos_url": "https://api.github.com/users/maurer/repos", "events_url": "https://api.github.com/users/maurer/events{/privacy}", "received_events_url": "https://api.github.com/users/maurer/received_events", "type": "User", "site_admin": false}, "committer": {"login": "maurer", "id": 136037, "node_id": "MDQ6VXNlcjEzNjAzNw==", "avatar_url": "https://avatars.githubusercontent.com/u/136037?v=4", "gravatar_id": "", "url": "https://api.github.com/users/maurer", "html_url": "https://github.com/maurer", "followers_url": "https://api.github.com/users/maurer/followers", "following_url": "https://api.github.com/users/maurer/following{/other_user}", "gists_url": "https://api.github.com/users/maurer/gists{/gist_id}", "starred_url": "https://api.github.com/users/maurer/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/maurer/subscriptions", "organizations_url": "https://api.github.com/users/maurer/orgs", "repos_url": "https://api.github.com/users/maurer/repos", "events_url": "https://api.github.com/users/maurer/events{/privacy}", "received_events_url": "https://api.github.com/users/maurer/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "270c94e484e19764a2832ef918c95224eb3f17c7", "url": "https://api.github.com/repos/rust-lang/rust/commits/270c94e484e19764a2832ef918c95224eb3f17c7", "html_url": "https://github.com/rust-lang/rust/commit/270c94e484e19764a2832ef918c95224eb3f17c7"}], "stats": {"total": 27, "additions": 23, "deletions": 4}, "files": [{"sha": "e9b85705086b55fc81aea67c4faf66436da0ce56", "filename": "compiler/rustc_symbol_mangling/src/typeid/typeid_itanium_cxx_abi.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/fb2c27d73f3528da5585bc7e49254164e0a2a5a2/compiler%2Frustc_symbol_mangling%2Fsrc%2Ftypeid%2Ftypeid_itanium_cxx_abi.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fb2c27d73f3528da5585bc7e49254164e0a2a5a2/compiler%2Frustc_symbol_mangling%2Fsrc%2Ftypeid%2Ftypeid_itanium_cxx_abi.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_symbol_mangling%2Fsrc%2Ftypeid%2Ftypeid_itanium_cxx_abi.rs?ref=fb2c27d73f3528da5585bc7e49254164e0a2a5a2", "patch": "@@ -164,6 +164,7 @@ fn encode_const<'tcx>(\n \n /// Encodes a FnSig using the Itanium C++ ABI with vendor extended type qualifiers and types for\n /// Rust types that are not used at the FFI boundary.\n+#[instrument(level = \"trace\", skip(tcx, dict))]\n fn encode_fnsig<'tcx>(\n     tcx: TyCtxt<'tcx>,\n     fn_sig: &FnSig<'tcx>,\n@@ -653,6 +654,7 @@ fn encode_ty<'tcx>(\n // Transforms a ty:Ty for being encoded and used in the substitution dictionary. It transforms all\n // c_void types into unit types unconditionally, and generalizes all pointers if\n // TransformTyOptions::GENERALIZE_POINTERS option is set.\n+#[instrument(level = \"trace\", skip(tcx))]\n fn transform_ty<'tcx>(tcx: TyCtxt<'tcx>, ty: Ty<'tcx>, options: TransformTyOptions) -> Ty<'tcx> {\n     let mut ty = ty;\n \n@@ -698,7 +700,7 @@ fn transform_ty<'tcx>(tcx: TyCtxt<'tcx>, ty: Ty<'tcx>, options: TransformTyOptio\n                     !is_zst\n                 });\n                 if let Some(field) = field {\n-                    let ty0 = tcx.type_of(field.did);\n+                    let ty0 = tcx.bound_type_of(field.did).subst(tcx, substs);\n                     // Generalize any repr(transparent) user-defined type that is either a pointer\n                     // or reference, and either references itself or any other type that contains or\n                     // references itself, to avoid a reference cycle.\n@@ -827,6 +829,7 @@ fn transform_substs<'tcx>(\n \n /// Returns a type metadata identifier for the specified FnAbi using the Itanium C++ ABI with vendor\n /// extended type qualifiers and types for Rust types that are not used at the FFI boundary.\n+#[instrument(level = \"trace\", skip(tcx))]\n pub fn typeid_for_fnabi<'tcx>(\n     tcx: TyCtxt<'tcx>,\n     fn_abi: &FnAbi<'tcx, Ty<'tcx>>,"}, {"sha": "b9c33914360ba08c6b9144c556fdde42ccf70de5", "filename": "src/test/codegen/sanitizer-cfi-emit-type-metadata-id-itanium-cxx-abi.rs", "status": "modified", "additions": 19, "deletions": 3, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/fb2c27d73f3528da5585bc7e49254164e0a2a5a2/src%2Ftest%2Fcodegen%2Fsanitizer-cfi-emit-type-metadata-id-itanium-cxx-abi.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fb2c27d73f3528da5585bc7e49254164e0a2a5a2/src%2Ftest%2Fcodegen%2Fsanitizer-cfi-emit-type-metadata-id-itanium-cxx-abi.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fsanitizer-cfi-emit-type-metadata-id-itanium-cxx-abi.rs?ref=fb2c27d73f3528da5585bc7e49254164e0a2a5a2", "patch": "@@ -131,6 +131,13 @@ pub struct Type13<'a> {\n     member3: &'a Type13<'a>,\n }\n \n+// Helper type to allow `Type14<Bar>` to be a unique ID\n+pub struct Bar;\n+\n+// repr(transparent) parameterized type\n+#[repr(transparent)]\n+pub struct Type14<T>(T);\n+\n pub fn foo0(_: ()) { }\n // CHECK: define{{.*}}foo0{{.*}}!type ![[TYPE0:[0-9]+]]\n pub fn foo1(_: c_void, _: ()) { }\n@@ -425,6 +432,12 @@ pub fn foo145(_: Type13, _: Type13) { }\n // CHECK: define{{.*}}foo145{{.*}}!type ![[TYPE145:[0-9]+]]\n pub fn foo146(_: Type13, _: Type13, _: Type13) { }\n // CHECK: define{{.*}}foo146{{.*}}!type ![[TYPE146:[0-9]+]]\n+pub fn foo147(_: Type14<Bar>) { }\n+// CHECK: define{{.*}}foo147{{.*}}!type ![[TYPE147:[0-9]+]]\n+pub fn foo148(_: Type14<Bar>, _: Type14<Bar>) { }\n+// CHECK: define{{.*}}foo148{{.*}}!type ![[TYPE148:[0-9]+]]\n+pub fn foo149(_: Type14<Bar>, _: Type14<Bar>, _: Type14<Bar>) { }\n+// CHECK: define{{.*}}foo149{{.*}}!type ![[TYPE149:[0-9]+]]\n \n // CHECK: ![[TYPE0]] = !{i64 0, !\"_ZTSFvvE\"}\n // CHECK: ![[TYPE1]] = !{i64 0, !\"_ZTSFvvvE\"}\n@@ -570,6 +583,9 @@ pub fn foo146(_: Type13, _: Type13, _: Type13) { }\n // CHECK: ![[TYPE141]] = !{i64 0, !\"_ZTSFvu{{[0-9]+}}NtC{{[[:print:]]+}}_51sanitizer_cfi_emit_type_metadata_id_itanium_cxx_abi3FooE\"}\n // CHECK: ![[TYPE142]] = !{i64 0, !\"_ZTSFvu{{[0-9]+}}NtC{{[[:print:]]+}}_51sanitizer_cfi_emit_type_metadata_id_itanium_cxx_abi3FooS_E\"}\n // CHECK: ![[TYPE143]] = !{i64 0, !\"_ZTSFvu{{[0-9]+}}NtC{{[[:print:]]+}}_51sanitizer_cfi_emit_type_metadata_id_itanium_cxx_abi3FooS_S_E\"}\n-// CHECK: ![[TYPE144]] = !{i64 0, !\"_ZTSFvu3refIu3refIvEEE\"}\n-// CHECK: ![[TYPE145]] = !{i64 0, !\"_ZTSFvu3refIu3refIvEES0_E\"}\n-// CHECK: ![[TYPE146]] = !{i64 0, !\"_ZTSFvu3refIu3refIvEES0_S0_E\"}\n+// CHECK: ![[TYPE144]] = !{i64 0, !\"_ZTSFvu3refIvEE\"}\n+// CHECK: ![[TYPE145]] = !{i64 0, !\"_ZTSFvu3refIvES_E\"}\n+// CHECK: ![[TYPE146]] = !{i64 0, !\"_ZTSFvu3refIvES_S_E\"}\n+// CHECK: ![[TYPE147]] = !{i64 0, !\"_ZTSFvu{{[0-9]+}}NtC{{[[:print:]]+}}_51sanitizer_cfi_emit_type_metadata_id_itanium_cxx_abi3BarE\n+// CHECK: ![[TYPE148]] = !{i64 0, !\"_ZTSFvu{{[0-9]+}}NtC{{[[:print:]]+}}_51sanitizer_cfi_emit_type_metadata_id_itanium_cxx_abi3BarS_E\n+// CHECK: ![[TYPE149]] = !{i64 0, !\"_ZTSFvu{{[0-9]+}}NtC{{[[:print:]]+}}_51sanitizer_cfi_emit_type_metadata_id_itanium_cxx_abi3BarS_S_E"}]}