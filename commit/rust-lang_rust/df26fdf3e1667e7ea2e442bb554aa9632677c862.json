{"sha": "df26fdf3e1667e7ea2e442bb554aa9632677c862", "node_id": "C_kwDOAAsO6NoAKGRmMjZmZGYzZTE2NjdlN2VhMmU0NDJiYjU1NGFhOTYzMjY3N2M4NjI", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-06-26T17:47:03Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-06-26T17:47:03Z"}, "message": "Rollup merge of #98297 - GuillaumeGomez:help-pocket-menu, r=notriddle\n\nTransform help popup into a pocket menu\n\nJust like we moved the settings menu into a \"pocket menu\", it's doing the same to the help popup.\n\nYou can test it [here](https://rustdoc.crud.net/imperio/help-pocket-menu/doc/foo/index.html) and here is a screenshot:\n\n![Screenshot from 2022-06-20 20-58-29](https://user-images.githubusercontent.com/3050060/174663718-538e9d11-3bf9-48b2-8909-f9bfe75af135.png)\n\nr? ``````````@jsha``````````", "tree": {"sha": "b2ba1a0e668507a38c9c3d6bc0036452ba32002a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b2ba1a0e668507a38c9c3d6bc0036452ba32002a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/df26fdf3e1667e7ea2e442bb554aa9632677c862", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJiuJuXCRBK7hj4Ov3rIwAAkHIIAA2/F6D1br4GZtLrI9odE7gC\nkGlajqv+ffTsyrbUjRUspJJNpGSsxHU/7JDiMP7wiD3uOiiVWEc7zbqtYZjqpima\n5qEwIQ5gLMAfPvcICdylDZBWQkQ0Z4nK3jRzeUQO8RZvVMIj3pJqWyVVcHLUi7wz\nBn/ialOwNZl1M8WGISy/K0n2c/P9+0jLRtWD6TFPLzID0uHn+GIi6/HSi8vtccIr\n7dD4FwEXRsTp0aLJsH+6EJz1xBn38qe/2394vI7csTLuTCvWyykl38evNXwVym/K\nexuUm1ydXgsBo/ajvZwy8EWP2cG55PhTqgzkcmnpgh4nF4bUDSUHEpAsaNZxAGU=\n=Hvm6\n-----END PGP SIGNATURE-----\n", "payload": "tree b2ba1a0e668507a38c9c3d6bc0036452ba32002a\nparent e8a2e265b520e7bf72b4335a7d1185484366f0cf\nparent e4b2b41290f6b49441b5b9c8e013458bc23caeeb\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1656265623 +0200\ncommitter GitHub <noreply@github.com> 1656265623 +0200\n\nRollup merge of #98297 - GuillaumeGomez:help-pocket-menu, r=notriddle\n\nTransform help popup into a pocket menu\n\nJust like we moved the settings menu into a \"pocket menu\", it's doing the same to the help popup.\n\nYou can test it [here](https://rustdoc.crud.net/imperio/help-pocket-menu/doc/foo/index.html) and here is a screenshot:\n\n![Screenshot from 2022-06-20 20-58-29](https://user-images.githubusercontent.com/3050060/174663718-538e9d11-3bf9-48b2-8909-f9bfe75af135.png)\n\nr? ``````````@jsha``````````\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/df26fdf3e1667e7ea2e442bb554aa9632677c862", "html_url": "https://github.com/rust-lang/rust/commit/df26fdf3e1667e7ea2e442bb554aa9632677c862", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/df26fdf3e1667e7ea2e442bb554aa9632677c862/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e8a2e265b520e7bf72b4335a7d1185484366f0cf", "url": "https://api.github.com/repos/rust-lang/rust/commits/e8a2e265b520e7bf72b4335a7d1185484366f0cf", "html_url": "https://github.com/rust-lang/rust/commit/e8a2e265b520e7bf72b4335a7d1185484366f0cf"}, {"sha": "e4b2b41290f6b49441b5b9c8e013458bc23caeeb", "url": "https://api.github.com/repos/rust-lang/rust/commits/e4b2b41290f6b49441b5b9c8e013458bc23caeeb", "html_url": "https://github.com/rust-lang/rust/commit/e4b2b41290f6b49441b5b9c8e013458bc23caeeb"}], "stats": {"total": 432, "additions": 248, "deletions": 184}, "files": [{"sha": "5d0756d30fb53e52907844fd9e7980bfe19f660a", "filename": "src/librustdoc/html/static/css/rustdoc.css", "status": "modified", "additions": 41, "deletions": 33, "changes": 74, "blob_url": "https://github.com/rust-lang/rust/blob/df26fdf3e1667e7ea2e442bb554aa9632677c862/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Frustdoc.css", "raw_url": "https://github.com/rust-lang/rust/raw/df26fdf3e1667e7ea2e442bb554aa9632677c862/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Frustdoc.css", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Frustdoc.css?ref=df26fdf3e1667e7ea2e442bb554aa9632677c862", "patch": "@@ -983,60 +983,69 @@ table,\n \tfont-weight: normal;\n }\n \n-body.blur > :not(#help) {\n-\tfilter: blur(8px);\n-\t-webkit-filter: blur(8px);\n-\topacity: .7;\n+.popover {\n+\tfont-size: 1rem;\n+\tposition: absolute;\n+\tright: 0;\n+\tz-index: 2;\n+\tdisplay: block;\n+\tmargin-top: 7px;\n+\tborder-radius: 3px;\n+\tborder: 1px solid;\n+\tfont-size: 1rem;\n }\n \n-#help {\n-\twidth: 100%;\n-\theight: 100vh;\n-\tposition: fixed;\n-\ttop: 0;\n-\tleft: 0;\n-\tdisplay: flex;\n-\tjustify-content: center;\n-\talign-items: center;\n+/* This rule is to draw the little arrow connecting the settings menu to the gear icon. */\n+.popover::before {\n+\tcontent: '';\n+\tposition: absolute;\n+\tright: 11px;\n+\tborder: solid;\n+\tborder-width: 1px 1px 0 0;\n+\tdisplay: inline-block;\n+\tpadding: 4px;\n+\ttransform: rotate(-45deg);\n+\ttop: -5px;\n }\n-#help > div {\n-\tflex: 0 0 auto;\n-\tbox-shadow: 0 0 6px rgba(0,0,0,.2);\n-\twidth: 550px;\n-\theight: auto;\n-\tborder: 1px solid;\n+\n+#help-button .popover {\n+\tmax-width: 600px;\n }\n-#help dt {\n+\n+#help-button .popover::before {\n+\tright: 48px;\n+}\n+\n+#help-button dt {\n \tfloat: left;\n \tclear: left;\n \tdisplay: block;\n \tmargin-right: 0.5rem;\n }\n-#help span.top, #help span.bottom {\n+#help-button span.top, #help-button span.bottom {\n \ttext-align: center;\n \tdisplay: block;\n \tfont-size: 1.125rem;\n-\n }\n-#help span.top {\n+#help-button span.top {\n \ttext-align: center;\n \tdisplay: block;\n \tmargin: 10px 0;\n \tborder-bottom: 1px solid;\n \tpadding-bottom: 4px;\n \tmargin-bottom: 6px;\n }\n-#help span.bottom {\n+#help-button span.bottom {\n \tclear: both;\n \tborder-top: 1px solid;\n }\n-#help dd { margin: 5px 35px; }\n-#help .infos { padding-left: 0; }\n-#help h1, #help h2 { margin-top: 0; }\n-#help > div div {\n+.side-by-side {\n+\ttext-align: initial;\n+}\n+.side-by-side > div {\n \twidth: 50%;\n \tfloat: left;\n-\tpadding: 0 20px 20px 17px;;\n+\tpadding: 0 20px 20px 17px;\n }\n \n .item-info .stab {\n@@ -1391,7 +1400,7 @@ pre.rust {\n #copy-path {\n \theight: 34px;\n }\n-#settings-menu > a, #help-button, #copy-path {\n+#settings-menu > a, #help-button > button, #copy-path {\n \tpadding: 5px;\n \twidth: 33px;\n \tborder: 1px solid;\n@@ -1401,9 +1410,8 @@ pre.rust {\n #settings-menu {\n \tpadding: 0;\n }\n-#settings-menu > a {\n+#settings-menu > a, #help-button > button {\n \tpadding: 5px;\n-\twidth: 100%;\n \theight: 100%;\n \tdisplay: block;\n }\n@@ -1420,7 +1428,7 @@ pre.rust {\n \tanimation: rotating 2s linear infinite;\n }\n \n-#help-button {\n+#help-button > button {\n \tfont-family: \"Fira Sans\", Arial, sans-serif;\n \ttext-align: center;\n \t/* Rare exception to specifying font sizes in rem. Since this is acting"}, {"sha": "e531e6ce6bbdeee1b6c74cf8690b7777df689ed9", "filename": "src/librustdoc/html/static/css/settings.css", "status": "modified", "additions": 0, "deletions": 21, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/df26fdf3e1667e7ea2e442bb554aa9632677c862/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Fsettings.css", "raw_url": "https://github.com/rust-lang/rust/raw/df26fdf3e1667e7ea2e442bb554aa9632677c862/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Fsettings.css", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Fsettings.css?ref=df26fdf3e1667e7ea2e442bb554aa9632677c862", "patch": "@@ -86,27 +86,6 @@ input:checked + .slider:before {\n \tdisplay: block;\n }\n \n-div#settings {\n-\tposition: absolute;\n-\tright: 0;\n-\tz-index: 1;\n-\tdisplay: block;\n-\tmargin-top: 7px;\n-\tborder-radius: 3px;\n-\tborder: 1px solid;\n-}\n #settings .setting-line {\n \tmargin: 1.2em 0.6em;\n }\n-/* This rule is to draw the little arrow connecting the settings menu to the gear icon. */\n-div#settings::before {\n-\tcontent: '';\n-\tposition: absolute;\n-\tright: 11px;\n-\tborder: solid;\n-\tborder-width: 1px 1px 0 0;\n-\tdisplay: inline-block;\n-\tpadding: 4px;\n-\ttransform: rotate(-45deg);\n-\ttop: -5px;\n-}"}, {"sha": "b7d0db1f0020f09c291182ee6b4316ff40b743f7", "filename": "src/librustdoc/html/static/css/themes/ayu.css", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/df26fdf3e1667e7ea2e442bb554aa9632677c862/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Fthemes%2Fayu.css", "raw_url": "https://github.com/rust-lang/rust/raw/df26fdf3e1667e7ea2e442bb554aa9632677c862/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Fthemes%2Fayu.css", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Fthemes%2Fayu.css?ref=df26fdf3e1667e7ea2e442bb554aa9632677c862", "patch": "@@ -5,7 +5,7 @@ Original by Dempfi (https://github.com/dempfi/ayu)\n \n /* General structure and fonts */\n \n-body, #settings-menu #settings, #settings-menu #settings::before {\n+body, .popover, .popover::before {\n \tbackground-color: #0f1419;\n \tcolor: #c5c5c5;\n }\n@@ -567,7 +567,7 @@ kbd {\n \tbox-shadow: inset 0 -1px 0 #5c6773;\n }\n \n-#settings-menu > a, #help-button {\n+#settings-menu > a, #help-button > button {\n \tborder-color: #5c6773;\n \tbackground-color: #0f1419;\n \tcolor: #fff;\n@@ -577,7 +577,8 @@ kbd {\n \tfilter: invert(100);\n }\n \n-#settings-menu #settings, #settings-menu #settings::before {\n+.popover, .popover::before,\n+#help-button span.top, #help-button span.bottom {\n \tborder-color: #5c6773;\n }\n \n@@ -592,7 +593,7 @@ kbd {\n }\n \n #settings-menu > a:hover, #settings-menu > a:focus,\n-#help-button:hover, #help-button:focus {\n+#help-button > button:hover, #help-button > button:focus {\n \tborder-color: #e0e0e0;\n }\n "}, {"sha": "eb64ef3e7710bbdb4a192d321ce1c0dd5d861f4e", "filename": "src/librustdoc/html/static/css/themes/dark.css", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/df26fdf3e1667e7ea2e442bb554aa9632677c862/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Fthemes%2Fdark.css", "raw_url": "https://github.com/rust-lang/rust/raw/df26fdf3e1667e7ea2e442bb554aa9632677c862/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Fthemes%2Fdark.css", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Fthemes%2Fdark.css?ref=df26fdf3e1667e7ea2e442bb554aa9632677c862", "patch": "@@ -1,4 +1,4 @@\n-body, #settings-menu #settings, #settings-menu #settings::before {\n+body, .popover, .popover::before {\n \tbackground-color: #353535;\n \tcolor: #ddd;\n }\n@@ -442,18 +442,19 @@ kbd {\n \tbox-shadow: inset 0 -1px 0 #c6cbd1;\n }\n \n-#settings-menu > a, #help-button {\n+#settings-menu > a, #help-button > button {\n \tborder-color: #e0e0e0;\n \tbackground: #f0f0f0;\n \tcolor: #000;\n }\n \n #settings-menu > a:hover, #settings-menu > a:focus,\n-#help-button:hover, #help-button:focus {\n+#help-button > button:hover, #help-button > button:focus {\n \tborder-color: #ffb900;\n }\n \n-#settings-menu #settings, #settings-menu #settings::before {\n+.popover, .popover::before,\n+#help-button span.top, #help-button span.bottom {\n \tborder-color: #d2d2d2;\n }\n "}, {"sha": "00cdf83589716c5a98d48201c7a02a1aebcd690d", "filename": "src/librustdoc/html/static/css/themes/light.css", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/df26fdf3e1667e7ea2e442bb554aa9632677c862/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Fthemes%2Flight.css", "raw_url": "https://github.com/rust-lang/rust/raw/df26fdf3e1667e7ea2e442bb554aa9632677c862/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Fthemes%2Flight.css", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Fthemes%2Flight.css?ref=df26fdf3e1667e7ea2e442bb554aa9632677c862", "patch": "@@ -1,6 +1,6 @@\n /* General structure and fonts */\n \n-body, #settings-menu #settings, #settings-menu #settings::before {\n+body, .popover, .popover::before {\n \tbackground-color: white;\n \tcolor: black;\n }\n@@ -427,17 +427,18 @@ kbd {\n \tbox-shadow: inset 0 -1px 0 #c6cbd1;\n }\n \n-#settings-menu > a, #help-button {\n+#settings-menu > a, #help-button > button {\n \tborder-color: #e0e0e0;\n \tbackground-color: #fff;\n }\n \n #settings-menu > a:hover, #settings-menu > a:focus,\n-#help-button:hover, #help-button:focus {\n+#help-button > button:hover, #help-button > button:focus {\n \tborder-color: #717171;\n }\n \n-#settings-menu #settings, #settings-menu #settings::before {\n+.popover, .popover::before,\n+#help-button span.top, #help-button span.bottom {\n \tborder-color: #DDDDDD;\n }\n "}, {"sha": "70dbfd444254070184ee241350caeaf3ce7b83bb", "filename": "src/librustdoc/html/static/js/main.js", "status": "modified", "additions": 103, "deletions": 74, "changes": 177, "blob_url": "https://github.com/rust-lang/rust/blob/df26fdf3e1667e7ea2e442bb554aa9632677c862/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fmain.js", "raw_url": "https://github.com/rust-lang/rust/raw/df26fdf3e1667e7ea2e442bb554aa9632677c862/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fmain.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fmain.js?ref=df26fdf3e1667e7ea2e442bb554aa9632677c862", "patch": "@@ -63,6 +63,24 @@ function showMain() {\n     removeClass(document.getElementById(MAIN_ID), \"hidden\");\n }\n \n+function elemIsInParent(elem, parent) {\n+    while (elem && elem !== document.body) {\n+        if (elem === parent) {\n+            return true;\n+        }\n+        elem = elem.parentElement;\n+    }\n+    return false;\n+}\n+\n+function blurHandler(event, parentElem, hideCallback) {\n+    if (!elemIsInParent(document.activeElement, parentElem) &&\n+        !elemIsInParent(event.relatedTarget, parentElem)\n+    ) {\n+        hideCallback();\n+    }\n+}\n+\n (function() {\n     window.rootPath = getVar(\"root-path\");\n     window.currentCrate = getVar(\"current-crate\");\n@@ -104,20 +122,21 @@ const MAIN_ID = \"main-content\";\n const SETTINGS_BUTTON_ID = \"settings-menu\";\n const ALTERNATIVE_DISPLAY_ID = \"alternative-display\";\n const NOT_DISPLAYED_ID = \"not-displayed\";\n+const HELP_BUTTON_ID = \"help-button\";\n \n function getSettingsButton() {\n     return document.getElementById(SETTINGS_BUTTON_ID);\n }\n \n+function getHelpButton() {\n+    return document.getElementById(HELP_BUTTON_ID);\n+}\n+\n // Returns the current URL without any query parameter or hash.\n function getNakedUrl() {\n     return window.location.href.split(\"?\")[0].split(\"#\")[0];\n }\n \n-window.hideSettings = () => {\n-    // Does nothing by default.\n-};\n-\n /**\n  * This function inserts `newNode` after `referenceNode`. It doesn't work if `referenceNode`\n  * doesn't have a parent node.\n@@ -381,55 +400,16 @@ function loadCss(cssFileName) {\n         openParentDetails(document.getElementById(id));\n     }\n \n-    function getHelpElement(build) {\n-        if (build) {\n-            buildHelperPopup();\n-        }\n-        return document.getElementById(\"help\");\n-    }\n-\n-    /**\n-     * Show the help popup.\n-     *\n-     * @param {boolean} display    - Whether to show or hide the popup\n-     * @param {Event}   ev         - The event that triggered this call\n-     * @param {Element} [help]     - The help element if it already exists\n-     */\n-    function displayHelp(display, ev, help) {\n-        if (display) {\n-            help = help ? help : getHelpElement(true);\n-            if (hasClass(help, \"hidden\")) {\n-                ev.preventDefault();\n-                removeClass(help, \"hidden\");\n-                addClass(document.body, \"blur\");\n-            }\n-        } else {\n-            // No need to build the help popup if we want to hide it in case it hasn't been\n-            // built yet...\n-            help = help ? help : getHelpElement(false);\n-            if (help && !hasClass(help, \"hidden\")) {\n-                ev.preventDefault();\n-                addClass(help, \"hidden\");\n-                removeClass(document.body, \"blur\");\n-            }\n-        }\n-    }\n-\n     function handleEscape(ev) {\n         searchState.clearInputTimeout();\n-        const help = getHelpElement(false);\n-        if (help && !hasClass(help, \"hidden\")) {\n-            displayHelp(false, ev, help);\n-        } else {\n-            switchDisplayedElement(null);\n-            if (browserSupportsHistoryApi()) {\n-                history.replaceState(null, window.currentCrate + \" - Rust\",\n-                    getNakedUrl() + window.location.hash);\n-            }\n-            ev.preventDefault();\n+        switchDisplayedElement(null);\n+        if (browserSupportsHistoryApi()) {\n+            history.replaceState(null, window.currentCrate + \" - Rust\",\n+                getNakedUrl() + window.location.hash);\n         }\n+        ev.preventDefault();\n         searchState.defocus();\n-        window.hideSettings();\n+        window.hidePopoverMenus();\n     }\n \n     const disableShortcuts = getSettingValue(\"disable-shortcuts\") === \"true\";\n@@ -453,7 +433,6 @@ function loadCss(cssFileName) {\n \n             case \"s\":\n             case \"S\":\n-                displayHelp(false, ev);\n                 ev.preventDefault();\n                 searchState.focus();\n                 break;\n@@ -465,7 +444,7 @@ function loadCss(cssFileName) {\n                 break;\n \n             case \"?\":\n-                displayHelp(true, ev);\n+                showHelp();\n                 break;\n \n             default:\n@@ -796,9 +775,6 @@ function loadCss(cssFileName) {\n             elem.addEventListener(\"click\", f);\n         }\n     }\n-    handleClick(\"help-button\", ev => {\n-        displayHelp(true, ev);\n-    });\n     handleClick(MAIN_ID, () => {\n         hideSidebar();\n     });\n@@ -842,24 +818,16 @@ function loadCss(cssFileName) {\n         });\n     }\n \n-    let buildHelperPopup = () => {\n-        const popup = document.createElement(\"aside\");\n-        addClass(popup, \"hidden\");\n-        popup.id = \"help\";\n-\n-        popup.addEventListener(\"click\", ev => {\n-            if (ev.target === popup) {\n-                // Clicked the blurred zone outside the help popup; dismiss help.\n-                displayHelp(false, ev);\n-            }\n-        });\n+    function helpBlurHandler(event) {\n+        blurHandler(event, getHelpButton(), window.hidePopoverMenus);\n+    }\n \n+    function buildHelpMenu() {\n         const book_info = document.createElement(\"span\");\n         book_info.className = \"top\";\n         book_info.innerHTML = \"You can find more information in \\\n             <a href=\\\"https://doc.rust-lang.org/rustdoc/\\\">the rustdoc book</a>.\";\n \n-        const container = document.createElement(\"div\");\n         const shortcuts = [\n             [\"?\", \"Show this help dialog\"],\n             [\"S\", \"Focus the search field\"],\n@@ -895,24 +863,85 @@ function loadCss(cssFileName) {\n         addClass(div_infos, \"infos\");\n         div_infos.innerHTML = \"<h2>Search Tricks</h2>\" + infos;\n \n-        container.appendChild(book_info);\n-        container.appendChild(div_shortcuts);\n-        container.appendChild(div_infos);\n-\n         const rustdoc_version = document.createElement(\"span\");\n         rustdoc_version.className = \"bottom\";\n         const rustdoc_version_code = document.createElement(\"code\");\n         rustdoc_version_code.innerText = \"rustdoc \" + getVar(\"rustdoc-version\");\n         rustdoc_version.appendChild(rustdoc_version_code);\n \n+        const container = document.createElement(\"div\");\n+        container.className = \"popover\";\n+        container.style.display = \"none\";\n+\n+        const side_by_side = document.createElement(\"div\");\n+        side_by_side.className = \"side-by-side\";\n+        side_by_side.appendChild(div_shortcuts);\n+        side_by_side.appendChild(div_infos);\n+\n+        container.appendChild(book_info);\n+        container.appendChild(side_by_side);\n         container.appendChild(rustdoc_version);\n \n-        popup.appendChild(container);\n-        insertAfter(popup, document.querySelector(\"main\"));\n-        // So that it's only built once and then it'll do nothing when called!\n-        buildHelperPopup = () => {};\n+        const help_button = getHelpButton();\n+        help_button.appendChild(container);\n+\n+        container.onblur = helpBlurHandler;\n+        container.onclick = event => {\n+            event.preventDefault();\n+        };\n+        help_button.onblur = helpBlurHandler;\n+        help_button.children[0].onblur = helpBlurHandler;\n+\n+        return container;\n+    }\n+\n+    /**\n+     * Hide all the popover menus.\n+     */\n+    window.hidePopoverMenus = function() {\n+        onEachLazy(document.querySelectorAll(\".search-container .popover\"), elem => {\n+            elem.style.display = \"none\";\n+        });\n     };\n \n+    /**\n+     * Returns the help menu element (not the button).\n+     *\n+     * @param {boolean} buildNeeded - If this argument is `false`, the help menu element won't be\n+     *                                built if it doesn't exist.\n+     *\n+     * @return {HTMLElement}\n+     */\n+    function getHelpMenu(buildNeeded) {\n+        let menu = getHelpButton().querySelector(\".popover\");\n+        if (!menu && buildNeeded) {\n+            menu = buildHelpMenu();\n+        }\n+        return menu;\n+    }\n+\n+    /**\n+     * Show the help popup menu.\n+     */\n+    function showHelp() {\n+        const menu = getHelpMenu(true);\n+        if (menu.style.display === \"none\") {\n+            menu.style.display = \"\";\n+        }\n+    }\n+\n+    document.querySelector(`#${HELP_BUTTON_ID} > button`).addEventListener(\"click\", event => {\n+        const target = event.target;\n+        if (target.tagName !== \"BUTTON\" || target.parentElement.id !== HELP_BUTTON_ID) {\n+            return;\n+        }\n+        const menu = getHelpMenu(true);\n+        const shouldShowHelp = menu.style.display === \"none\";\n+        if (shouldShowHelp) {\n+            showHelp();\n+        }\n+    });\n+\n     setMobileTopbar();\n     addSidebarItems();\n     addSidebarCrates();"}, {"sha": "797b931afc643b82d7b5744df52275d5ed9fcff2", "filename": "src/librustdoc/html/static/js/settings.js", "status": "modified", "additions": 12, "deletions": 28, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/df26fdf3e1667e7ea2e442bb554aa9632677c862/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsettings.js", "raw_url": "https://github.com/rust-lang/rust/raw/df26fdf3e1667e7ea2e442bb554aa9632677c862/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsettings.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsettings.js?ref=df26fdf3e1667e7ea2e442bb554aa9632677c862", "patch": "@@ -1,6 +1,6 @@\n // Local js definitions:\n /* global getSettingValue, getVirtualKey, updateLocalStorage, updateSystemTheme */\n-/* global addClass, removeClass, onEach, onEachLazy */\n+/* global addClass, removeClass, onEach, onEachLazy, blurHandler, elemIsInParent */\n /* global MAIN_ID, getVar, getSettingsButton */\n \n \"use strict\";\n@@ -209,6 +209,7 @@\n         const innerHTML = `<div class=\"settings\">${buildSettingsPageSections(settings)}</div>`;\n         const el = document.createElement(elementKind);\n         el.id = \"settings\";\n+        el.className = \"popover\";\n         el.innerHTML = innerHTML;\n \n         if (isSettingsPage) {\n@@ -226,23 +227,8 @@\n         settingsMenu.style.display = \"\";\n     }\n \n-    function elemIsInParent(elem, parent) {\n-        while (elem && elem !== document.body) {\n-            if (elem === parent) {\n-                return true;\n-            }\n-            elem = elem.parentElement;\n-        }\n-        return false;\n-    }\n-\n-    function blurHandler(event) {\n-        const settingsButton = getSettingsButton();\n-        if (!elemIsInParent(document.activeElement, settingsButton) &&\n-            !elemIsInParent(event.relatedTarget, settingsButton)\n-        ) {\n-            window.hideSettings();\n-        }\n+    function settingsBlurHandler(event) {\n+        blurHandler(event, getSettingsButton(), window.hidePopoverMenus);\n     }\n \n     if (isSettingsPage) {\n@@ -254,26 +240,24 @@\n         // We replace the existing \"onclick\" callback.\n         const settingsButton = getSettingsButton();\n         const settingsMenu = document.getElementById(\"settings\");\n-        window.hideSettings = function() {\n-            settingsMenu.style.display = \"none\";\n-        };\n         settingsButton.onclick = function(event) {\n             if (elemIsInParent(event.target, settingsMenu)) {\n                 return;\n             }\n             event.preventDefault();\n-            if (settingsMenu.style.display !== \"none\") {\n-                window.hideSettings();\n-            } else {\n+            const shouldDisplaySettings = settingsMenu.style.display === \"none\";\n+\n+            window.hidePopoverMenus();\n+            if (shouldDisplaySettings) {\n                 displaySettings();\n             }\n         };\n-        settingsButton.onblur = blurHandler;\n-        settingsButton.querySelector(\"a\").onblur = blurHandler;\n+        settingsButton.onblur = settingsBlurHandler;\n+        settingsButton.querySelector(\"a\").onblur = settingsBlurHandler;\n         onEachLazy(settingsMenu.querySelectorAll(\"input\"), el => {\n-            el.onblur = blurHandler;\n+            el.onblur = settingsBlurHandler;\n         });\n-        settingsMenu.onblur = blurHandler;\n+        settingsMenu.onblur = settingsBlurHandler;\n     }\n \n     // We now wait a bit for the web browser to end re-computing the DOM..."}, {"sha": "dfb3e4e6a2ccd5a93479bb2f3ae6a51a40bf663c", "filename": "src/librustdoc/html/templates/page.html", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/df26fdf3e1667e7ea2e442bb554aa9632677c862/src%2Flibrustdoc%2Fhtml%2Ftemplates%2Fpage.html", "raw_url": "https://github.com/rust-lang/rust/raw/df26fdf3e1667e7ea2e442bb554aa9632677c862/src%2Flibrustdoc%2Fhtml%2Ftemplates%2Fpage.html", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Ftemplates%2Fpage.html?ref=df26fdf3e1667e7ea2e442bb554aa9632677c862", "patch": "@@ -119,7 +119,9 @@ <h2 class=\"location\"></h2>\n                                 spellcheck=\"false\" {# -#}\n                                 placeholder=\"Click or press \u2018S\u2019 to search, \u2018?\u2019 for more options\u2026\" {# -#}\n                                 type=\"search\"> {#- -#}\n-                            <button type=\"button\" id=\"help-button\" title=\"help\">?</button> {#- -#}\n+                            <div id=\"help-button\" title=\"help\" tabindex=\"-1\"> {#- -#}\n+                                <button type=\"button\">?</button> {#- -#}\n+                            </div> {#- -#}\n                             <div id=\"settings-menu\" tabindex=\"-1\">\n                                 <a href=\"{{page.root_path|safe}}settings.html\" title=\"settings\"> {#- -#}\n                                     <img width=\"22\" height=\"22\" alt=\"Change settings\" {# -#}"}, {"sha": "d083b0ae0c9319e8af6b6fb746eb8638b778f572", "filename": "src/test/rustdoc-gui/escape-key.goml", "status": "modified", "additions": 0, "deletions": 12, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/df26fdf3e1667e7ea2e442bb554aa9632677c862/src%2Ftest%2Frustdoc-gui%2Fescape-key.goml", "raw_url": "https://github.com/rust-lang/rust/raw/df26fdf3e1667e7ea2e442bb554aa9632677c862/src%2Ftest%2Frustdoc-gui%2Fescape-key.goml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-gui%2Fescape-key.goml?ref=df26fdf3e1667e7ea2e442bb554aa9632677c862", "patch": "@@ -21,25 +21,13 @@ wait-for: \"#alternative-display #search\"\n assert-attribute: (\"#main-content\", {\"class\": \"content hidden\"})\n assert-document-property: ({\"URL\": \"index.html?search=test\"}, ENDS_WITH)\n \n-// Now let's check that when the help popup is displayed and we press Escape, it doesn't\n-// hide the search results too.\n-click: \"#help-button\"\n-assert-document-property: ({\"URL\": \"index.html?search=test\"}, [ENDS_WITH])\n-assert-attribute: (\"#help\", {\"class\": \"\"})\n-press-key: \"Escape\"\n-wait-for: \"#alternative-display #search\"\n-assert-attribute: (\"#help\", {\"class\": \"hidden\"})\n-assert-attribute: (\"#main-content\", {\"class\": \"content hidden\"})\n-assert-document-property: ({\"URL\": \"index.html?search=test\"}, [ENDS_WITH])\n-\n // Check that Escape hides the search results when a search result is focused.\n focus: \".search-input\"\n assert: \".search-input:focus\"\n press-key: \"ArrowDown\"\n assert-false: \".search-input:focus\"\n assert: \"#results a:focus\"\n press-key: \"Escape\"\n-assert-attribute: (\"#help\", {\"class\": \"hidden\"})\n wait-for: \"#not-displayed #search\"\n assert-false: \"#alternative-display #search\"\n assert-attribute: (\"#main-content\", {\"class\": \"content\"})"}, {"sha": "ba2986e969a3506d0adf8601fa8b31cd736a6b29", "filename": "src/test/rustdoc-gui/pocket-menu.goml", "status": "added", "additions": 72, "deletions": 0, "changes": 72, "blob_url": "https://github.com/rust-lang/rust/blob/df26fdf3e1667e7ea2e442bb554aa9632677c862/src%2Ftest%2Frustdoc-gui%2Fpocket-menu.goml", "raw_url": "https://github.com/rust-lang/rust/raw/df26fdf3e1667e7ea2e442bb554aa9632677c862/src%2Ftest%2Frustdoc-gui%2Fpocket-menu.goml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-gui%2Fpocket-menu.goml?ref=df26fdf3e1667e7ea2e442bb554aa9632677c862", "patch": "@@ -0,0 +1,72 @@\n+// This test ensures that the \"pocket menus\" are working as expected.\n+goto: file://|DOC_PATH|/test_docs/index.html\n+// First we check that the help menu doesn't exist yet.\n+assert-false: \"#help-button .popover\"\n+// Then we display the help menu.\n+click: \"#help-button\"\n+assert: \"#help-button .popover\"\n+assert-css: (\"#help-button .popover\", {\"display\": \"block\"})\n+\n+// Now we click somewhere else on the page to ensure it is handling the blur event\n+// correctly.\n+click: \".sidebar\"\n+assert-css: (\"#help-button .popover\", {\"display\": \"none\"})\n+\n+// Now we will check that we cannot have two \"pocket menus\" displayed at the same time.\n+click: \"#help-button\"\n+assert-css: (\"#help-button .popover\", {\"display\": \"block\"})\n+click: \"#settings-menu\"\n+assert-css: (\"#help-button .popover\", {\"display\": \"none\"})\n+assert-css: (\"#settings-menu .popover\", {\"display\": \"block\"})\n+\n+// Now the other way.\n+click: \"#help-button\"\n+assert-css: (\"#help-button .popover\", {\"display\": \"block\"})\n+assert-css: (\"#settings-menu .popover\", {\"display\": \"none\"})\n+\n+// We check the borders color now:\n+\n+// Ayu theme\n+local-storage: {\n+    \"rustdoc-theme\": \"ayu\",\n+    \"rustdoc-use-system-theme\": \"false\",\n+}\n+reload:\n+\n+click: \"#help-button\"\n+assert-css: (\n+    \"#help-button .popover\",\n+    {\"display\": \"block\", \"border-color\": \"rgb(92, 103, 115)\"},\n+)\n+compare-elements-css: (\"#help-button .popover\", \"#help-button .top\", [\"border-color\"])\n+compare-elements-css: (\"#help-button .popover\", \"#help-button .bottom\", [\"border-color\"])\n+\n+// Dark theme\n+local-storage: {\n+    \"rustdoc-theme\": \"dark\",\n+    \"rustdoc-use-system-theme\": \"false\",\n+}\n+reload:\n+\n+click: \"#help-button\"\n+assert-css: (\n+    \"#help-button .popover\",\n+    {\"display\": \"block\", \"border-color\": \"rgb(210, 210, 210)\"},\n+)\n+compare-elements-css: (\"#help-button .popover\", \"#help-button .top\", [\"border-color\"])\n+compare-elements-css: (\"#help-button .popover\", \"#help-button .bottom\", [\"border-color\"])\n+\n+// Light theme\n+local-storage: {\n+    \"rustdoc-theme\": \"light\",\n+    \"rustdoc-use-system-theme\": \"false\",\n+}\n+reload:\n+\n+click: \"#help-button\"\n+assert-css: (\n+    \"#help-button .popover\",\n+    {\"display\": \"block\", \"border-color\": \"rgb(221, 221, 221)\"},\n+)\n+compare-elements-css: (\"#help-button .popover\", \"#help-button .top\", [\"border-color\"])\n+compare-elements-css: (\"#help-button .popover\", \"#help-button .bottom\", [\"border-color\"])"}, {"sha": "1f20a0eaa9982d21630b0fcad056e01356bacabf", "filename": "src/test/rustdoc-gui/shortcuts.goml", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/df26fdf3e1667e7ea2e442bb554aa9632677c862/src%2Ftest%2Frustdoc-gui%2Fshortcuts.goml", "raw_url": "https://github.com/rust-lang/rust/raw/df26fdf3e1667e7ea2e442bb554aa9632677c862/src%2Ftest%2Frustdoc-gui%2Fshortcuts.goml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-gui%2Fshortcuts.goml?ref=df26fdf3e1667e7ea2e442bb554aa9632677c862", "patch": "@@ -8,7 +8,6 @@ press-key: \"Escape\"\n assert-false: \"input.search-input:focus\"\n // We now check for the help popup.\n press-key: \"?\"\n-assert-css: (\"#help\", {\"display\": \"flex\"})\n-assert-false: \"#help.hidden\"\n+assert-css: (\"#help-button .popover\", {\"display\": \"block\"})\n press-key: \"Escape\"\n-assert-css: (\"#help.hidden\", {\"display\": \"none\"})\n+assert-css: (\"#help-button .popover\", {\"display\": \"none\"})"}]}