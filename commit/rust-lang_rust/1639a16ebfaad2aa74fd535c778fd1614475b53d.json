{"sha": "1639a16ebfaad2aa74fd535c778fd1614475b53d", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE2MzlhMTZlYmZhYWQyYWE3NGZkNTM1Yzc3OGZkMTYxNDQ3NWI1M2Q=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-06-10T00:39:25Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-06-10T00:39:25Z"}, "message": "Auto merge of #85910 - cjgillot:no-meta-version, r=Aaron1011\n\nDrop metadata_encoding_version.\n\nPart of #85153\n\nr? `@Aaron1011`", "tree": {"sha": "8944f45d0051f62fc82843035f7261ffacabfcbe", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8944f45d0051f62fc82843035f7261ffacabfcbe"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1639a16ebfaad2aa74fd535c778fd1614475b53d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1639a16ebfaad2aa74fd535c778fd1614475b53d", "html_url": "https://github.com/rust-lang/rust/commit/1639a16ebfaad2aa74fd535c778fd1614475b53d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1639a16ebfaad2aa74fd535c778fd1614475b53d/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "eab201df7028ebb6812c0b1a01702ac6ecfcceed", "url": "https://api.github.com/repos/rust-lang/rust/commits/eab201df7028ebb6812c0b1a01702ac6ecfcceed", "html_url": "https://github.com/rust-lang/rust/commit/eab201df7028ebb6812c0b1a01702ac6ecfcceed"}, {"sha": "4e3b220b02dafe2cad7d8cfdc604caf436e820c7", "url": "https://api.github.com/repos/rust-lang/rust/commits/4e3b220b02dafe2cad7d8cfdc604caf436e820c7", "html_url": "https://github.com/rust-lang/rust/commit/4e3b220b02dafe2cad7d8cfdc604caf436e820c7"}], "stats": {"total": 22, "additions": 9, "deletions": 13}, "files": [{"sha": "de110c55a4b2c6e374a8fa15fd61470543846117", "filename": "Cargo.lock", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/1639a16ebfaad2aa74fd535c778fd1614475b53d/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/1639a16ebfaad2aa74fd535c778fd1614475b53d/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=1639a16ebfaad2aa74fd535c778fd1614475b53d", "patch": "@@ -3693,6 +3693,7 @@ dependencies = [\n  \"rustc_incremental\",\n  \"rustc_index\",\n  \"rustc_llvm\",\n+ \"rustc_metadata\",\n  \"rustc_middle\",\n  \"rustc_serialize\",\n  \"rustc_session\","}, {"sha": "6aadaf8a7cadcea9ce47d930099a987a4c9b8d43", "filename": "compiler/rustc_codegen_cranelift/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/1639a16ebfaad2aa74fd535c778fd1614475b53d/compiler%2Frustc_codegen_cranelift%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1639a16ebfaad2aa74fd535c778fd1614475b53d/compiler%2Frustc_codegen_cranelift%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Flib.rs?ref=1639a16ebfaad2aa74fd535c778fd1614475b53d", "patch": "@@ -14,6 +14,7 @@ extern crate rustc_fs_util;\n extern crate rustc_hir;\n extern crate rustc_incremental;\n extern crate rustc_index;\n+extern crate rustc_metadata;\n extern crate rustc_session;\n extern crate rustc_span;\n extern crate rustc_target;"}, {"sha": "db24bf65eb5a2e015620822b67b81592feeff024", "filename": "compiler/rustc_codegen_cranelift/src/metadata.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1639a16ebfaad2aa74fd535c778fd1614475b53d/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fmetadata.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1639a16ebfaad2aa74fd535c778fd1614475b53d/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fmetadata.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fmetadata.rs?ref=1639a16ebfaad2aa74fd535c778fd1614475b53d", "patch": "@@ -10,7 +10,7 @@ pub(crate) fn write_metadata<O: WriteMetadata>(tcx: TyCtxt<'_>, object: &mut O)\n     use std::io::Write;\n \n     let metadata = tcx.encode_metadata();\n-    let mut compressed = tcx.metadata_encoding_version();\n+    let mut compressed = rustc_metadata::METADATA_HEADER.to_vec();\n     FrameEncoder::new(&mut compressed).write_all(&metadata.raw_data).unwrap();\n \n     object.add_rustc_section("}, {"sha": "d0eb6913accde06efb58127b23ca33a71673dc62", "filename": "compiler/rustc_codegen_llvm/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/1639a16ebfaad2aa74fd535c778fd1614475b53d/compiler%2Frustc_codegen_llvm%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/1639a16ebfaad2aa74fd535c778fd1614475b53d/compiler%2Frustc_codegen_llvm%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2FCargo.toml?ref=1639a16ebfaad2aa74fd535c778fd1614475b53d", "patch": "@@ -27,6 +27,7 @@ rustc_hir = { path = \"../rustc_hir\" }\n rustc_incremental = { path = \"../rustc_incremental\" }\n rustc_index = { path = \"../rustc_index\" }\n rustc_llvm = { path = \"../rustc_llvm\" }\n+rustc_metadata = { path = \"../rustc_metadata\" }\n rustc_session = { path = \"../rustc_session\" }\n rustc_serialize = { path = \"../rustc_serialize\" }\n rustc_target = { path = \"../rustc_target\" }"}, {"sha": "cc3cbea4def5e1bf20876b3eaf24baa539d64aee", "filename": "compiler/rustc_codegen_llvm/src/base.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1639a16ebfaad2aa74fd535c778fd1614475b53d/compiler%2Frustc_codegen_llvm%2Fsrc%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1639a16ebfaad2aa74fd535c778fd1614475b53d/compiler%2Frustc_codegen_llvm%2Fsrc%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fbase.rs?ref=1639a16ebfaad2aa74fd535c778fd1614475b53d", "patch": "@@ -63,7 +63,7 @@ pub fn write_compressed_metadata<'tcx>(\n     let section_name = if tcx.sess.target.is_like_osx { \"__DATA,.rustc\" } else { \".rustc\" };\n \n     let (metadata_llcx, metadata_llmod) = (&*llvm_module.llcx, llvm_module.llmod());\n-    let mut compressed = tcx.metadata_encoding_version();\n+    let mut compressed = rustc_metadata::METADATA_HEADER.to_vec();\n     FrameEncoder::new(&mut compressed).write_all(&metadata.raw_data).unwrap();\n \n     let llmeta = common::bytes_in_context(metadata_llcx, &compressed);"}, {"sha": "2c9bad7e5cedb326da042688f939998a06a9f140", "filename": "compiler/rustc_metadata/src/lib.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1639a16ebfaad2aa74fd535c778fd1614475b53d/compiler%2Frustc_metadata%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1639a16ebfaad2aa74fd535c778fd1614475b53d/compiler%2Frustc_metadata%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_metadata%2Fsrc%2Flib.rs?ref=1639a16ebfaad2aa74fd535c778fd1614475b53d", "patch": "@@ -29,3 +29,5 @@ mod rmeta;\n pub mod creader;\n pub mod dynamic_lib;\n pub mod locator;\n+\n+pub use rmeta::METADATA_HEADER;"}, {"sha": "9a97835d9c000e403be89c998b243b3feafb0104", "filename": "compiler/rustc_metadata/src/rmeta/decoder/cstore_impl.rs", "status": "modified", "additions": 1, "deletions": 5, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/1639a16ebfaad2aa74fd535c778fd1614475b53d/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fdecoder%2Fcstore_impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1639a16ebfaad2aa74fd535c778fd1614475b53d/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fdecoder%2Fcstore_impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fdecoder%2Fcstore_impl.rs?ref=1639a16ebfaad2aa74fd535c778fd1614475b53d", "patch": "@@ -1,7 +1,7 @@\n use crate::creader::{CStore, LoadedMacro};\n use crate::foreign_modules;\n use crate::native_libs;\n-use crate::rmeta::{self, encoder};\n+use crate::rmeta::encoder;\n \n use rustc_ast as ast;\n use rustc_ast::expand::allocator::AllocatorKind;\n@@ -536,10 +536,6 @@ impl CrateStore for CStore {\n         encoder::encode_metadata(tcx)\n     }\n \n-    fn metadata_encoding_version(&self) -> &[u8] {\n-        rmeta::METADATA_HEADER\n-    }\n-\n     fn allocator_kind(&self) -> Option<AllocatorKind> {\n         self.allocator_kind()\n     }"}, {"sha": "99ea0cc8f2f1634374efff7691f739ce8bf4b994", "filename": "compiler/rustc_metadata/src/rmeta/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1639a16ebfaad2aa74fd535c778fd1614475b53d/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1639a16ebfaad2aa74fd535c778fd1614475b53d/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fmod.rs?ref=1639a16ebfaad2aa74fd535c778fd1614475b53d", "patch": "@@ -52,7 +52,7 @@ const METADATA_VERSION: u8 = 5;\n /// This header is followed by the position of the `CrateRoot`,\n /// which is encoded as a 32-bit big-endian unsigned integer,\n /// and further followed by the rustc version string.\n-crate const METADATA_HEADER: &[u8; 8] = &[b'r', b'u', b's', b't', 0, 0, 0, METADATA_VERSION];\n+pub const METADATA_HEADER: &[u8] = &[b'r', b'u', b's', b't', 0, 0, 0, METADATA_VERSION];\n \n /// Additional metadata for a `Lazy<T>` where `T` may not be `Sized`,\n /// e.g. for `Lazy<[T]>`, this is the length (count of `T` values)."}, {"sha": "a7ab43d106c4a45d9a567435569b714876985344", "filename": "compiler/rustc_middle/src/middle/cstore.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/1639a16ebfaad2aa74fd535c778fd1614475b53d/compiler%2Frustc_middle%2Fsrc%2Fmiddle%2Fcstore.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1639a16ebfaad2aa74fd535c778fd1614475b53d/compiler%2Frustc_middle%2Fsrc%2Fmiddle%2Fcstore.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fmiddle%2Fcstore.rs?ref=1639a16ebfaad2aa74fd535c778fd1614475b53d", "patch": "@@ -215,7 +215,6 @@ pub trait CrateStore {\n \n     // utility functions\n     fn encode_metadata(&self, tcx: TyCtxt<'_>) -> EncodedMetadata;\n-    fn metadata_encoding_version(&self) -> &[u8];\n     fn allocator_kind(&self) -> Option<AllocatorKind>;\n }\n "}, {"sha": "d13cbdd122854a8c9bd7c6004b2a9702e2263ae8", "filename": "compiler/rustc_middle/src/ty/context.rs", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/1639a16ebfaad2aa74fd535c778fd1614475b53d/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1639a16ebfaad2aa74fd535c778fd1614475b53d/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs?ref=1639a16ebfaad2aa74fd535c778fd1614475b53d", "patch": "@@ -1288,10 +1288,6 @@ impl<'tcx> TyCtxt<'tcx> {\n         )\n     }\n \n-    pub fn metadata_encoding_version(self) -> Vec<u8> {\n-        self.cstore.metadata_encoding_version().to_vec()\n-    }\n-\n     pub fn encode_metadata(self) -> EncodedMetadata {\n         let _prof_timer = self.prof.verbose_generic_activity(\"generate_crate_metadata\");\n         self.cstore.encode_metadata(self)"}]}