{"sha": "bc56920757c248229c341fb90d44fe3d4767c491", "node_id": "C_kwDOAAsO6NoAKGJjNTY5MjA3NTdjMjQ4MjI5YzM0MWZiOTBkNDRmZTNkNDc2N2M0OTE", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2022-04-07T18:05:21Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-04-07T18:05:21Z"}, "message": "Merge #11931\n\n11931: fix: flyimport: omit types when completing where-clause r=jonas-schievink a=jonas-schievink\n\nFixes https://github.com/rust-analyzer/rust-analyzer/issues/11918\r\n\r\nbors r+\n\nCo-authored-by: Jonas Schievink <jonas.schievink@ferrous-systems.com>", "tree": {"sha": "e048dda89549542f73559dd81f777515802819d3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e048dda89549542f73559dd81f777515802819d3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bc56920757c248229c341fb90d44fe3d4767c491", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJiTyfhCRBK7hj4Ov3rIwAAe1wIAF/q3W01gG93Qf5kOwhpGz4n\nURznIV3PM3NdI6nZHqX8Q4knEJi7AnqYlbrscFuXmG9q57Zmai7PEQB2lycS/CAA\n9x2SNHydNSLNZfNrAXXipBzVa+pGqFo2gNaXXe9wMJr5/sKm8YrrPBYmTekiZiMo\nFNbAIyJHu8Bo3DjYlsvwVQLg35+zNjEOMzEd2sBysw+rMdR+lo+/ya/EJr0GPVMa\nvuxLwWXUKlOa6+/PhMXcj6q7mqIK/6Hk3B213OyQHbOguD5DZSe49VEWW1klNE3K\nLD5+XUvIL7HXoU0x7D7OjHLDTk/Ux1q9FbwWA1oJ8ddxSD1yMSyGZMEmykewzOw=\n=Cocy\n-----END PGP SIGNATURE-----\n", "payload": "tree e048dda89549542f73559dd81f777515802819d3\nparent b8ed4a388ce8fbd317b1e94233f9e7ae36ea043b\nparent 99d91bc550d1c12e4e5e23d47b71338f5a62b902\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1649354721 +0000\ncommitter GitHub <noreply@github.com> 1649354721 +0000\n\nMerge #11931\n\n11931: fix: flyimport: omit types when completing where-clause r=jonas-schievink a=jonas-schievink\n\nFixes https://github.com/rust-analyzer/rust-analyzer/issues/11918\r\n\r\nbors r+\n\nCo-authored-by: Jonas Schievink <jonas.schievink@ferrous-systems.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bc56920757c248229c341fb90d44fe3d4767c491", "html_url": "https://github.com/rust-lang/rust/commit/bc56920757c248229c341fb90d44fe3d4767c491", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bc56920757c248229c341fb90d44fe3d4767c491/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b8ed4a388ce8fbd317b1e94233f9e7ae36ea043b", "url": "https://api.github.com/repos/rust-lang/rust/commits/b8ed4a388ce8fbd317b1e94233f9e7ae36ea043b", "html_url": "https://github.com/rust-lang/rust/commit/b8ed4a388ce8fbd317b1e94233f9e7ae36ea043b"}, {"sha": "99d91bc550d1c12e4e5e23d47b71338f5a62b902", "url": "https://api.github.com/repos/rust-lang/rust/commits/99d91bc550d1c12e4e5e23d47b71338f5a62b902", "html_url": "https://github.com/rust-lang/rust/commit/99d91bc550d1c12e4e5e23d47b71338f5a62b902"}], "stats": {"total": 30, "additions": 28, "deletions": 2}, "files": [{"sha": "fb857aeccda19052826532d62c0ef87ccc297d0d", "filename": "crates/ide_completion/src/completions/flyimport.rs", "status": "modified", "additions": 9, "deletions": 2, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/bc56920757c248229c341fb90d44fe3d4767c491/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fflyimport.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bc56920757c248229c341fb90d44fe3d4767c491/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fflyimport.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fflyimport.rs?ref=bc56920757c248229c341fb90d44fe3d4767c491", "patch": "@@ -1,5 +1,5 @@\n //! See [`import_on_the_fly`].\n-use hir::ItemInNs;\n+use hir::{ItemInNs, ModuleDef};\n use ide_db::imports::{\n     import_assets::{ImportAssets, ImportCandidate, LocatedImport},\n     insert_use::ImportScope,\n@@ -9,6 +9,7 @@ use syntax::{AstNode, SyntaxNode, T};\n \n use crate::{\n     context::{CompletionContext, PathKind},\n+    patterns::ImmediateLocation,\n     render::{render_resolution_with_import, RenderContext},\n };\n \n@@ -170,7 +171,13 @@ pub(crate) fn import_on_the_fly(acc: &mut Completions, ctx: &CompletionContext)\n             (PathKind::Pat, ItemInNs::Types(_)) => true,\n             (PathKind::Pat, ItemInNs::Values(def)) => matches!(def, hir::ModuleDef::Const(_)),\n \n-            (PathKind::Type, ItemInNs::Types(_)) => true,\n+            (PathKind::Type, ItemInNs::Types(ty)) => {\n+                if matches!(ctx.completion_location, Some(ImmediateLocation::TypeBound)) {\n+                    matches!(ty, ModuleDef::Trait(_))\n+                } else {\n+                    true\n+                }\n+            }\n             (PathKind::Type, ItemInNs::Values(_)) => false,\n \n             (PathKind::Attr { .. }, ItemInNs::Macros(mac)) => mac.is_attr(ctx.db),"}, {"sha": "41e6cf7aeeb06c3949dfddb79dce861ab8bb1938", "filename": "crates/ide_completion/src/tests/flyimport.rs", "status": "modified", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/bc56920757c248229c341fb90d44fe3d4767c491/crates%2Fide_completion%2Fsrc%2Ftests%2Fflyimport.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bc56920757c248229c341fb90d44fe3d4767c491/crates%2Fide_completion%2Fsrc%2Ftests%2Fflyimport.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Ftests%2Fflyimport.rs?ref=bc56920757c248229c341fb90d44fe3d4767c491", "patch": "@@ -1170,3 +1170,22 @@ struct Foo;\n \"#,\n     );\n }\n+\n+#[test]\n+fn flyimport_in_type_bound_omits_types() {\n+    check(\n+        r#\"\n+mod module {\n+    pub struct CompletemeStruct;\n+    pub type CompletemeType = ();\n+    pub enum CompletemeEnum {}\n+    pub trait CompletemeTrait {}\n+}\n+\n+fn f<T>() where T: Comp$0\n+\"#,\n+        expect![[r#\"\n+            tt CompletemeTrait (use module::CompletemeTrait)\n+        \"#]],\n+    );\n+}"}]}