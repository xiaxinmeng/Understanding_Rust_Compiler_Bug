{"sha": "84f962a89bac3948ed116f1ad04c2f4793fb69ea", "node_id": "C_kwDOAAsO6NoAKDg0Zjk2MmE4OWJhYzM5NDhlZDExNmYxYWQwNGMyZjQ3OTNmYjY5ZWE", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-12-20T10:35:48Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-12-20T10:35:48Z"}, "message": "Auto merge of #91924 - Aaron1011:serialize-adt-def, r=michaelwoerister\n\nFully serialize AdtDef\n\nThis avoids needing to invoke the `adt_def` query during\nthe decoding of another query's result.\n\nSplit out from https://github.com/rust-lang/rust/pull/91919\nSee https://github.com/rust-lang/rust/issues/91696#issuecomment-993043710", "tree": {"sha": "d1475e91627525d0278296204551d21df84a0be8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d1475e91627525d0278296204551d21df84a0be8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/84f962a89bac3948ed116f1ad04c2f4793fb69ea", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/84f962a89bac3948ed116f1ad04c2f4793fb69ea", "html_url": "https://github.com/rust-lang/rust/commit/84f962a89bac3948ed116f1ad04c2f4793fb69ea", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/84f962a89bac3948ed116f1ad04c2f4793fb69ea/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "60f3bd78eeac87ad474916d36d29ed7e5084b25b", "url": "https://api.github.com/repos/rust-lang/rust/commits/60f3bd78eeac87ad474916d36d29ed7e5084b25b", "html_url": "https://github.com/rust-lang/rust/commit/60f3bd78eeac87ad474916d36d29ed7e5084b25b"}, {"sha": "00ce6dc7187a1d572c19d3939fa5876ea6bbcbb1", "url": "https://api.github.com/repos/rust-lang/rust/commits/00ce6dc7187a1d572c19d3939fa5876ea6bbcbb1", "html_url": "https://github.com/rust-lang/rust/commit/00ce6dc7187a1d572c19d3939fa5876ea6bbcbb1"}], "stats": {"total": 51, "additions": 23, "deletions": 28}, "files": [{"sha": "a936852f4e7af96787ff9d89a863dd1b3cd59223", "filename": "compiler/rustc_middle/src/arena.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/84f962a89bac3948ed116f1ad04c2f4793fb69ea/compiler%2Frustc_middle%2Fsrc%2Farena.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84f962a89bac3948ed116f1ad04c2f4793fb69ea/compiler%2Frustc_middle%2Fsrc%2Farena.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Farena.rs?ref=84f962a89bac3948ed116f1ad04c2f4793fb69ea", "patch": "@@ -9,7 +9,7 @@ macro_rules! arena_types {\n             [] layout: rustc_target::abi::Layout,\n             [] fn_abi: rustc_target::abi::call::FnAbi<'tcx, rustc_middle::ty::Ty<'tcx>>,\n             // AdtDef are interned and compared by address\n-            [] adt_def: rustc_middle::ty::AdtDef,\n+            [decode] adt_def: rustc_middle::ty::AdtDef,\n             [] steal_thir: rustc_data_structures::steal::Steal<rustc_middle::thir::Thir<'tcx>>,\n             [] steal_mir: rustc_data_structures::steal::Steal<rustc_middle::mir::Body<'tcx>>,\n             [decode] mir: rustc_middle::mir::Body<'tcx>,"}, {"sha": "ad3f61d07843adb27647b2992203f3ade1a2c681", "filename": "compiler/rustc_middle/src/query/mod.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/84f962a89bac3948ed116f1ad04c2f4793fb69ea/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84f962a89bac3948ed116f1ad04c2f4793fb69ea/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs?ref=84f962a89bac3948ed116f1ad04c2f4793fb69ea", "patch": "@@ -522,6 +522,7 @@ rustc_queries! {\n     }\n     query adt_def(key: DefId) -> &'tcx ty::AdtDef {\n         desc { |tcx| \"computing ADT definition for `{}`\", tcx.def_path_str(key) }\n+        cache_on_disk_if { key.is_local() }\n         separate_provide_extern\n     }\n     query adt_destructor(key: DefId) -> Option<ty::Destructor> {"}, {"sha": "5cde54c9328d16295b29259ce1c0c9b0d7cdd10d", "filename": "compiler/rustc_middle/src/ty/adt.rs", "status": "modified", "additions": 10, "deletions": 13, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/84f962a89bac3948ed116f1ad04c2f4793fb69ea/compiler%2Frustc_middle%2Fsrc%2Fty%2Fadt.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84f962a89bac3948ed116f1ad04c2f4793fb69ea/compiler%2Frustc_middle%2Fsrc%2Fty%2Fadt.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fadt.rs?ref=84f962a89bac3948ed116f1ad04c2f4793fb69ea", "patch": "@@ -11,7 +11,6 @@ use rustc_hir::def::{CtorKind, DefKind, Res};\n use rustc_hir::def_id::DefId;\n use rustc_index::vec::{Idx, IndexVec};\n use rustc_query_system::ich::StableHashingContext;\n-use rustc_serialize::{self, Encodable, Encoder};\n use rustc_session::DataTypeKind;\n use rustc_span::symbol::sym;\n use rustc_target::abi::VariantIdx;\n@@ -20,7 +19,7 @@ use std::cell::RefCell;\n use std::cmp::Ordering;\n use std::hash::{Hash, Hasher};\n use std::ops::Range;\n-use std::{ptr, str};\n+use std::str;\n \n use super::{\n     Destructor, FieldDef, GenericPredicates, ReprOptions, Ty, TyCtxt, VariantDef, VariantDiscr,\n@@ -30,7 +29,7 @@ use super::{\n pub struct AdtSizedConstraint<'tcx>(pub &'tcx [Ty<'tcx>]);\n \n bitflags! {\n-    #[derive(HashStable)]\n+    #[derive(HashStable, TyEncodable, TyDecodable)]\n     pub struct AdtFlags: u32 {\n         const NO_ADT_FLAGS        = 0;\n         /// Indicates whether the ADT is an enum.\n@@ -88,6 +87,7 @@ bitflags! {\n ///\n /// where `x` here represents the `DefId` of `S.x`. Then, the `DefId`\n /// can be used with [`TyCtxt::type_of()`] to get the type of the field.\n+#[derive(TyEncodable, TyDecodable)]\n pub struct AdtDef {\n     /// The `DefId` of the struct, enum or union item.\n     pub did: DefId,\n@@ -113,26 +113,23 @@ impl Ord for AdtDef {\n     }\n }\n \n+/// There should be only one AdtDef for each `did`, therefore\n+/// it is fine to implement `PartialEq` only based on `did`.\n impl PartialEq for AdtDef {\n-    // `AdtDef`s are always interned, and this is part of `TyS` equality.\n     #[inline]\n     fn eq(&self, other: &Self) -> bool {\n-        ptr::eq(self, other)\n+        self.did == other.did\n     }\n }\n \n impl Eq for AdtDef {}\n \n+/// There should be only one AdtDef for each `did`, therefore\n+/// it is fine to implement `Hash` only based on `did`.\n impl Hash for AdtDef {\n     #[inline]\n     fn hash<H: Hasher>(&self, s: &mut H) {\n-        (self as *const AdtDef).hash(s)\n-    }\n-}\n-\n-impl<S: Encoder> Encodable<S> for AdtDef {\n-    fn encode(&self, s: &mut S) -> Result<(), S::Error> {\n-        self.did.encode(s)\n+        self.did.hash(s)\n     }\n }\n \n@@ -161,7 +158,7 @@ impl<'a> HashStable<StableHashingContext<'a>> for AdtDef {\n     }\n }\n \n-#[derive(Copy, Clone, Debug, Eq, PartialEq, Hash)]\n+#[derive(Copy, Clone, Debug, Eq, PartialEq, Hash, TyEncodable, TyDecodable)]\n pub enum AdtKind {\n     Struct,\n     Union,"}, {"sha": "db37d98614e0992f4925b1938151e5a399f88f57", "filename": "compiler/rustc_middle/src/ty/codec.rs", "status": "modified", "additions": 4, "deletions": 10, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/84f962a89bac3948ed116f1ad04c2f4793fb69ea/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcodec.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84f962a89bac3948ed116f1ad04c2f4793fb69ea/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcodec.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcodec.rs?ref=84f962a89bac3948ed116f1ad04c2f4793fb69ea", "patch": "@@ -16,7 +16,6 @@ use crate::thir;\n use crate::ty::subst::SubstsRef;\n use crate::ty::{self, List, Ty, TyCtxt};\n use rustc_data_structures::fx::FxHashMap;\n-use rustc_hir::def_id::DefId;\n use rustc_serialize::{Decodable, Decoder, Encodable, Encoder};\n use rustc_span::Span;\n use std::hash::Hash;\n@@ -160,7 +159,8 @@ encodable_via_deref! {\n     &'tcx mir::Body<'tcx>,\n     &'tcx mir::UnsafetyCheckResult,\n     &'tcx mir::BorrowCheckResult<'tcx>,\n-    &'tcx mir::coverage::CodeRegion\n+    &'tcx mir::coverage::CodeRegion,\n+    &'tcx ty::AdtDef\n }\n \n pub trait TyDecoder<'tcx>: Decoder {\n@@ -312,13 +312,6 @@ macro_rules! impl_decodable_via_ref {\n     }\n }\n \n-impl<'tcx, D: TyDecoder<'tcx>> RefDecodable<'tcx, D> for ty::AdtDef {\n-    fn decode(decoder: &mut D) -> Result<&'tcx Self, D::Error> {\n-        let def_id = <DefId as Decodable<D>>::decode(decoder)?;\n-        Ok(decoder.tcx().adt_def(def_id))\n-    }\n-}\n-\n impl<'tcx, D: TyDecoder<'tcx>> RefDecodable<'tcx, D> for ty::List<Ty<'tcx>> {\n     fn decode(decoder: &mut D) -> Result<&'tcx Self, D::Error> {\n         let len = decoder.read_usize()?;\n@@ -403,7 +396,8 @@ impl_decodable_via_ref! {\n     &'tcx mir::UnsafetyCheckResult,\n     &'tcx mir::BorrowCheckResult<'tcx>,\n     &'tcx mir::coverage::CodeRegion,\n-    &'tcx ty::List<ty::BoundVariableKind>\n+    &'tcx ty::List<ty::BoundVariableKind>,\n+    &'tcx ty::AdtDef\n }\n \n #[macro_export]"}, {"sha": "caa7008f1085e056740f8c3c9235a257f17427cb", "filename": "compiler/rustc_middle/src/ty/context.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/84f962a89bac3948ed116f1ad04c2f4793fb69ea/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84f962a89bac3948ed116f1ad04c2f4793fb69ea/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs?ref=84f962a89bac3948ed116f1ad04c2f4793fb69ea", "patch": "@@ -112,6 +112,7 @@ pub struct CtxtInterners<'tcx> {\n     const_allocation: InternedSet<'tcx, Allocation>,\n     bound_variable_kinds: InternedSet<'tcx, List<ty::BoundVariableKind>>,\n     layout: InternedSet<'tcx, Layout>,\n+    adt_def: InternedSet<'tcx, AdtDef>,\n }\n \n impl<'tcx> CtxtInterners<'tcx> {\n@@ -132,6 +133,7 @@ impl<'tcx> CtxtInterners<'tcx> {\n             const_allocation: Default::default(),\n             bound_variable_kinds: Default::default(),\n             layout: Default::default(),\n+            adt_def: Default::default(),\n         }\n     }\n \n@@ -1078,7 +1080,7 @@ impl<'tcx> TyCtxt<'tcx> {\n         variants: IndexVec<VariantIdx, ty::VariantDef>,\n         repr: ReprOptions,\n     ) -> &'tcx ty::AdtDef {\n-        self.arena.alloc(ty::AdtDef::new(self, did, kind, variants, repr))\n+        self.intern_adt_def(ty::AdtDef::new(self, did, kind, variants, repr))\n     }\n \n     /// Allocates a read-only byte or string literal for `mir::interpret`.\n@@ -2057,6 +2059,7 @@ direct_interners! {\n     const_: mk_const(Const<'tcx>),\n     const_allocation: intern_const_alloc(Allocation),\n     layout: intern_layout(Layout),\n+    adt_def: intern_adt_def(AdtDef),\n }\n \n macro_rules! slice_interners {"}, {"sha": "f5a4a4ae24c469dea90bf83ea3036c5705ee030a", "filename": "compiler/rustc_middle/src/ty/mod.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/84f962a89bac3948ed116f1ad04c2f4793fb69ea/compiler%2Frustc_middle%2Fsrc%2Fty%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/84f962a89bac3948ed116f1ad04c2f4793fb69ea/compiler%2Frustc_middle%2Fsrc%2Fty%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fmod.rs?ref=84f962a89bac3948ed116f1ad04c2f4793fb69ea", "patch": "@@ -1472,7 +1472,7 @@ pub struct Destructor {\n }\n \n bitflags! {\n-    #[derive(HashStable)]\n+    #[derive(HashStable, TyEncodable, TyDecodable)]\n     pub struct VariantFlags: u32 {\n         const NO_VARIANT_FLAGS        = 0;\n         /// Indicates whether the field list of this variant is `#[non_exhaustive]`.\n@@ -1484,7 +1484,7 @@ bitflags! {\n }\n \n /// Definition of a variant -- a struct's fields or an enum variant.\n-#[derive(Debug, HashStable)]\n+#[derive(Debug, HashStable, TyEncodable, TyDecodable)]\n pub struct VariantDef {\n     /// `DefId` that identifies the variant itself.\n     /// If this variant belongs to a struct or union, then this is a copy of its `DefId`.\n@@ -1586,7 +1586,7 @@ pub enum VariantDiscr {\n     Relative(u32),\n }\n \n-#[derive(Debug, HashStable)]\n+#[derive(Debug, HashStable, TyEncodable, TyDecodable)]\n pub struct FieldDef {\n     pub did: DefId,\n     #[stable_hasher(project(name))]"}]}