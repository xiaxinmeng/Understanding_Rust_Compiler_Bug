{"sha": "4f2e540520e66287f6fe17fa1b55bb3984c4ccb4", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRmMmU1NDA1MjBlNjYyODdmNmZlMTdmYTFiNTViYjM5ODRjNGNjYjQ=", "commit": {"author": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2020-06-23T20:10:17Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-06-23T20:10:17Z"}, "message": "Rollup merge of #73630 - estebank:fn-item-e0308, r=davidtwco\n\nProvide context on E0308 involving fn items\n\nFix #73487.", "tree": {"sha": "8fe72e368bc779f020e7612ef0e4f71912cf7178", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8fe72e368bc779f020e7612ef0e4f71912cf7178"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4f2e540520e66287f6fe17fa1b55bb3984c4ccb4", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJe8mGpCRBK7hj4Ov3rIwAAdHIIAEFGC+f10nAtGi/YSPSiByZt\ndU3TDVKhWX08EnpbVtNu44AhTVQLo8E6hvc6MyOfGSjmvhrRC/XOhiVqBholy9At\nyyeLXEBJ8bFrXEqY2F5ziwSw1ZKNu6282widNhWbRyKLFNgATNCXS60tv1QC4D6b\nag6NFpSQZXDQaVNHNZiNanKL2ZIwPFaRQgdFGbFovJPRZBCPJw57UO07EsfMHAhn\nZwklaT1mHFLoJzQVGG1zIbcoZ4gwqmIEv7I4jF5VbEpaIlfxow01AdpFcKJLBAQO\nzUyuOxzD8ZnbBMx0RQgB+8YfeJM7VJup0jyUdFl1q6FSOs5fjOKed46grorVGnY=\n=7qad\n-----END PGP SIGNATURE-----\n", "payload": "tree 8fe72e368bc779f020e7612ef0e4f71912cf7178\nparent f7d5687eba4784046004916f178e60b4c0c06fbf\nparent 6e8aa1ff27297694e5092f19f5e2d6d244d076a7\nauthor Manish Goregaokar <manishsmail@gmail.com> 1592943017 -0700\ncommitter GitHub <noreply@github.com> 1592943017 -0700\n\nRollup merge of #73630 - estebank:fn-item-e0308, r=davidtwco\n\nProvide context on E0308 involving fn items\n\nFix #73487.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4f2e540520e66287f6fe17fa1b55bb3984c4ccb4", "html_url": "https://github.com/rust-lang/rust/commit/4f2e540520e66287f6fe17fa1b55bb3984c4ccb4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4f2e540520e66287f6fe17fa1b55bb3984c4ccb4/comments", "author": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f7d5687eba4784046004916f178e60b4c0c06fbf", "url": "https://api.github.com/repos/rust-lang/rust/commits/f7d5687eba4784046004916f178e60b4c0c06fbf", "html_url": "https://github.com/rust-lang/rust/commit/f7d5687eba4784046004916f178e60b4c0c06fbf"}, {"sha": "6e8aa1ff27297694e5092f19f5e2d6d244d076a7", "url": "https://api.github.com/repos/rust-lang/rust/commits/6e8aa1ff27297694e5092f19f5e2d6d244d076a7", "html_url": "https://github.com/rust-lang/rust/commit/6e8aa1ff27297694e5092f19f5e2d6d244d076a7"}], "stats": {"total": 105, "additions": 94, "deletions": 11}, "files": [{"sha": "7fdcbd31df3c5085663428ea3fb2c1cafaeff250", "filename": "src/librustc_infer/infer/error_reporting/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/4f2e540520e66287f6fe17fa1b55bb3984c4ccb4/src%2Flibrustc_infer%2Finfer%2Ferror_reporting%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4f2e540520e66287f6fe17fa1b55bb3984c4ccb4/src%2Flibrustc_infer%2Finfer%2Ferror_reporting%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_infer%2Finfer%2Ferror_reporting%2Fmod.rs?ref=4f2e540520e66287f6fe17fa1b55bb3984c4ccb4", "patch": "@@ -1256,7 +1256,7 @@ impl<'a, 'tcx> InferCtxt<'a, 'tcx> {\n             (ty::FnDef(did1, substs1), ty::FnPtr(sig2)) => {\n                 let sig1 = self.tcx.fn_sig(*did1).subst(self.tcx, substs1);\n                 let mut values = self.cmp_fn_sig(&sig1, sig2);\n-                values.0.push_normal(format!(\n+                values.0.push_highlighted(format!(\n                     \" {{{}}}\",\n                     self.tcx.def_path_str_with_substs(*did1, substs1)\n                 ));"}, {"sha": "85c073ca3003439aec9fd2e5a057e11e2239aa0e", "filename": "src/librustc_typeck/check/demand.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/4f2e540520e66287f6fe17fa1b55bb3984c4ccb4/src%2Flibrustc_typeck%2Fcheck%2Fdemand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4f2e540520e66287f6fe17fa1b55bb3984c4ccb4/src%2Flibrustc_typeck%2Fcheck%2Fdemand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fdemand.rs?ref=4f2e540520e66287f6fe17fa1b55bb3984c4ccb4", "patch": "@@ -34,6 +34,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         }\n         self.suggest_boxing_when_appropriate(err, expr, expected, expr_ty);\n         self.suggest_missing_await(err, expr, expected, expr_ty);\n+        self.note_need_for_fn_pointer(err, expected, expr_ty);\n     }\n \n     // Requires that the two types unify, and prints an error message if"}, {"sha": "0325782e69d516a17d127c8ad2bc2b835723e9d4", "filename": "src/librustc_typeck/check/mod.rs", "status": "modified", "additions": 37, "deletions": 0, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/4f2e540520e66287f6fe17fa1b55bb3984c4ccb4/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4f2e540520e66287f6fe17fa1b55bb3984c4ccb4/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs?ref=4f2e540520e66287f6fe17fa1b55bb3984c4ccb4", "patch": "@@ -5362,6 +5362,43 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         }\n     }\n \n+    fn note_need_for_fn_pointer(\n+        &self,\n+        err: &mut DiagnosticBuilder<'_>,\n+        expected: Ty<'tcx>,\n+        found: Ty<'tcx>,\n+    ) {\n+        let (sig, did, substs) = match (&expected.kind, &found.kind) {\n+            (ty::FnDef(did1, substs1), ty::FnDef(did2, substs2)) => {\n+                let sig1 = self.tcx.fn_sig(*did1).subst(self.tcx, substs1);\n+                let sig2 = self.tcx.fn_sig(*did2).subst(self.tcx, substs2);\n+                if sig1 != sig2 {\n+                    return;\n+                }\n+                err.note(\n+                    \"different `fn` items always have unique types, even if their signatures are \\\n+                     the same\",\n+                );\n+                (sig1, *did1, substs1)\n+            }\n+            (ty::FnDef(did, substs), ty::FnPtr(sig2)) => {\n+                let sig1 = self.tcx.fn_sig(*did).subst(self.tcx, substs);\n+                if sig1 != *sig2 {\n+                    return;\n+                }\n+                (sig1, *did, substs)\n+            }\n+            _ => return,\n+        };\n+        err.help(&format!(\"change the expected type to be function pointer `{}`\", sig));\n+        err.help(&format!(\n+            \"if the expected type is due to type inference, cast the expected `fn` to a function \\\n+             pointer: `{} as {}`\",\n+            self.tcx.def_path_str_with_substs(did, substs),\n+            sig\n+        ));\n+    }\n+\n     /// A common error is to add an extra semicolon:\n     ///\n     /// ```"}, {"sha": "abae40162a0fcacdfc6f58397fc0fa8622f60204", "filename": "src/test/ui/fn/fn-item-type.rs", "status": "modified", "additions": 28, "deletions": 6, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/4f2e540520e66287f6fe17fa1b55bb3984c4ccb4/src%2Ftest%2Fui%2Ffn%2Ffn-item-type.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4f2e540520e66287f6fe17fa1b55bb3984c4ccb4/src%2Ftest%2Fui%2Ffn%2Ffn-item-type.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffn%2Ffn-item-type.rs?ref=4f2e540520e66287f6fe17fa1b55bb3984c4ccb4", "patch": "@@ -12,22 +12,44 @@ impl<T> Foo for T { /* `foo` is still default here */ }\n fn main() {\n     eq(foo::<u8>, bar::<u8>);\n     //~^ ERROR mismatched types\n-    //~|  expected fn item `fn(_) -> _ {foo::<u8>}`\n-    //~|  found fn item `fn(_) -> _ {bar::<u8>}`\n-    //~|  expected fn item, found a different fn item\n+    //~| expected fn item `fn(_) -> _ {foo::<u8>}`\n+    //~| found fn item `fn(_) -> _ {bar::<u8>}`\n+    //~| expected fn item, found a different fn item\n+    //~| different `fn` items always have unique types, even if their signatures are the same\n+    //~| change the expected type to be function pointer\n+    //~| if the expected type is due to type inference, cast the expected `fn` to a function pointer\n \n     eq(foo::<u8>, foo::<i8>);\n     //~^ ERROR mismatched types\n     //~| expected `u8`, found `i8`\n+    //~| different `fn` items always have unique types, even if their signatures are the same\n+    //~| change the expected type to be function pointer\n+    //~| if the expected type is due to type inference, cast the expected `fn` to a function pointer\n \n     eq(bar::<String>, bar::<Vec<u8>>);\n     //~^ ERROR mismatched types\n-    //~|  expected fn item `fn(_) -> _ {bar::<std::string::String>}`\n-    //~|  found fn item `fn(_) -> _ {bar::<std::vec::Vec<u8>>}`\n-    //~|  expected struct `std::string::String`, found struct `std::vec::Vec`\n+    //~| expected fn item `fn(_) -> _ {bar::<std::string::String>}`\n+    //~| found fn item `fn(_) -> _ {bar::<std::vec::Vec<u8>>}`\n+    //~| expected struct `std::string::String`, found struct `std::vec::Vec`\n+    //~| different `fn` items always have unique types, even if their signatures are the same\n+    //~| change the expected type to be function pointer\n+    //~| if the expected type is due to type inference, cast the expected `fn` to a function pointer\n \n     // Make sure we distinguish between trait methods correctly.\n     eq(<u8 as Foo>::foo, <u16 as Foo>::foo);\n     //~^ ERROR mismatched types\n     //~| expected `u8`, found `u16`\n+    //~| different `fn` items always have unique types, even if their signatures are the same\n+    //~| change the expected type to be function pointer\n+    //~| if the expected type is due to type inference, cast the expected `fn` to a function pointer\n+\n+    eq(foo::<u8>, bar::<u8> as fn(isize) -> isize);\n+    //~^ ERROR mismatched types\n+    //~| expected fn item `fn(_) -> _ {foo::<u8>}`\n+    //~| found fn pointer `fn(_) -> _`\n+    //~| expected fn item, found fn pointer\n+    //~| change the expected type to be function pointer\n+    //~| if the expected type is due to type inference, cast the expected `fn` to a function pointer\n+\n+    eq(foo::<u8> as fn(isize) -> isize, bar::<u8>); // ok!\n }"}, {"sha": "bfa9efa219f4c8aa71c2df4a1a00e8e0820f74d8", "filename": "src/test/ui/fn/fn-item-type.stderr", "status": "modified", "additions": 27, "deletions": 4, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/4f2e540520e66287f6fe17fa1b55bb3984c4ccb4/src%2Ftest%2Fui%2Ffn%2Ffn-item-type.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/4f2e540520e66287f6fe17fa1b55bb3984c4ccb4/src%2Ftest%2Fui%2Ffn%2Ffn-item-type.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffn%2Ffn-item-type.stderr?ref=4f2e540520e66287f6fe17fa1b55bb3984c4ccb4", "patch": "@@ -6,34 +6,57 @@ LL |     eq(foo::<u8>, bar::<u8>);\n    |\n    = note: expected fn item `fn(_) -> _ {foo::<u8>}`\n               found fn item `fn(_) -> _ {bar::<u8>}`\n+   = note: different `fn` items always have unique types, even if their signatures are the same\n+   = help: change the expected type to be function pointer `fn(isize) -> isize`\n+   = help: if the expected type is due to type inference, cast the expected `fn` to a function pointer: `foo::<u8> as fn(isize) -> isize`\n \n error[E0308]: mismatched types\n-  --> $DIR/fn-item-type.rs:19:19\n+  --> $DIR/fn-item-type.rs:22:19\n    |\n LL |     eq(foo::<u8>, foo::<i8>);\n    |                   ^^^^^^^^^ expected `u8`, found `i8`\n    |\n    = note: expected fn item `fn(_) -> _ {foo::<u8>}`\n               found fn item `fn(_) -> _ {foo::<i8>}`\n+   = note: different `fn` items always have unique types, even if their signatures are the same\n+   = help: change the expected type to be function pointer `fn(isize) -> isize`\n+   = help: if the expected type is due to type inference, cast the expected `fn` to a function pointer: `foo::<u8> as fn(isize) -> isize`\n \n error[E0308]: mismatched types\n-  --> $DIR/fn-item-type.rs:23:23\n+  --> $DIR/fn-item-type.rs:29:23\n    |\n LL |     eq(bar::<String>, bar::<Vec<u8>>);\n    |                       ^^^^^^^^^^^^^^ expected struct `std::string::String`, found struct `std::vec::Vec`\n    |\n    = note: expected fn item `fn(_) -> _ {bar::<std::string::String>}`\n               found fn item `fn(_) -> _ {bar::<std::vec::Vec<u8>>}`\n+   = note: different `fn` items always have unique types, even if their signatures are the same\n+   = help: change the expected type to be function pointer `fn(isize) -> isize`\n+   = help: if the expected type is due to type inference, cast the expected `fn` to a function pointer: `bar::<std::string::String> as fn(isize) -> isize`\n \n error[E0308]: mismatched types\n-  --> $DIR/fn-item-type.rs:30:26\n+  --> $DIR/fn-item-type.rs:39:26\n    |\n LL |     eq(<u8 as Foo>::foo, <u16 as Foo>::foo);\n    |                          ^^^^^^^^^^^^^^^^^ expected `u8`, found `u16`\n    |\n    = note: expected fn item `fn() {<u8 as Foo>::foo}`\n               found fn item `fn() {<u16 as Foo>::foo}`\n+   = note: different `fn` items always have unique types, even if their signatures are the same\n+   = help: change the expected type to be function pointer `fn()`\n+   = help: if the expected type is due to type inference, cast the expected `fn` to a function pointer: `<u8 as Foo>::foo as fn()`\n \n-error: aborting due to 4 previous errors\n+error[E0308]: mismatched types\n+  --> $DIR/fn-item-type.rs:46:19\n+   |\n+LL |     eq(foo::<u8>, bar::<u8> as fn(isize) -> isize);\n+   |                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ expected fn item, found fn pointer\n+   |\n+   = note: expected fn item `fn(_) -> _ {foo::<u8>}`\n+           found fn pointer `fn(_) -> _`\n+   = help: change the expected type to be function pointer `fn(isize) -> isize`\n+   = help: if the expected type is due to type inference, cast the expected `fn` to a function pointer: `foo::<u8> as fn(isize) -> isize`\n+\n+error: aborting due to 5 previous errors\n \n For more information about this error, try `rustc --explain E0308`."}]}