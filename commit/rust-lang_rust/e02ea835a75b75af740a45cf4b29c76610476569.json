{"sha": "e02ea835a75b75af740a45cf4b29c76610476569", "node_id": "MDY6Q29tbWl0NzI0NzEyOmUwMmVhODM1YTc1Yjc1YWY3NDBhNDVjZjRiMjljNzY2MTA0NzY1Njk=", "commit": {"author": {"name": "Dylan MacKenzie", "email": "ecstaticmorse@gmail.com", "date": "2020-09-30T01:52:00Z"}, "committer": {"name": "Dylan MacKenzie", "email": "ecstaticmorse@gmail.com", "date": "2020-09-30T02:20:33Z"}, "message": "Don't stop const-checking after erroneous trait bound", "tree": {"sha": "fda7d547d8ad0888089c7e1f540f2dfd6c517d99", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fda7d547d8ad0888089c7e1f540f2dfd6c517d99"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e02ea835a75b75af740a45cf4b29c76610476569", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e02ea835a75b75af740a45cf4b29c76610476569", "html_url": "https://github.com/rust-lang/rust/commit/e02ea835a75b75af740a45cf4b29c76610476569", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e02ea835a75b75af740a45cf4b29c76610476569/comments", "author": {"login": "ecstatic-morse", "id": 29463364, "node_id": "MDQ6VXNlcjI5NDYzMzY0", "avatar_url": "https://avatars.githubusercontent.com/u/29463364?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ecstatic-morse", "html_url": "https://github.com/ecstatic-morse", "followers_url": "https://api.github.com/users/ecstatic-morse/followers", "following_url": "https://api.github.com/users/ecstatic-morse/following{/other_user}", "gists_url": "https://api.github.com/users/ecstatic-morse/gists{/gist_id}", "starred_url": "https://api.github.com/users/ecstatic-morse/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ecstatic-morse/subscriptions", "organizations_url": "https://api.github.com/users/ecstatic-morse/orgs", "repos_url": "https://api.github.com/users/ecstatic-morse/repos", "events_url": "https://api.github.com/users/ecstatic-morse/events{/privacy}", "received_events_url": "https://api.github.com/users/ecstatic-morse/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ecstatic-morse", "id": 29463364, "node_id": "MDQ6VXNlcjI5NDYzMzY0", "avatar_url": "https://avatars.githubusercontent.com/u/29463364?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ecstatic-morse", "html_url": "https://github.com/ecstatic-morse", "followers_url": "https://api.github.com/users/ecstatic-morse/followers", "following_url": "https://api.github.com/users/ecstatic-morse/following{/other_user}", "gists_url": "https://api.github.com/users/ecstatic-morse/gists{/gist_id}", "starred_url": "https://api.github.com/users/ecstatic-morse/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ecstatic-morse/subscriptions", "organizations_url": "https://api.github.com/users/ecstatic-morse/orgs", "repos_url": "https://api.github.com/users/ecstatic-morse/repos", "events_url": "https://api.github.com/users/ecstatic-morse/events{/privacy}", "received_events_url": "https://api.github.com/users/ecstatic-morse/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "879d3794d3140fcadc213688be32b21407497aa8", "url": "https://api.github.com/repos/rust-lang/rust/commits/879d3794d3140fcadc213688be32b21407497aa8", "html_url": "https://github.com/rust-lang/rust/commit/879d3794d3140fcadc213688be32b21407497aa8"}], "stats": {"total": 23, "additions": 17, "deletions": 6}, "files": [{"sha": "6d1125e352e0ca90b5e4e3732fd106b07c5c77bf", "filename": "compiler/rustc_mir/src/transform/check_consts/ops.rs", "status": "modified", "additions": 9, "deletions": 2, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/e02ea835a75b75af740a45cf4b29c76610476569/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fcheck_consts%2Fops.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e02ea835a75b75af740a45cf4b29c76610476569/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fcheck_consts%2Fops.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fcheck_consts%2Fops.rs?ref=e02ea835a75b75af740a45cf4b29c76610476569", "patch": "@@ -598,9 +598,16 @@ pub mod ty {\n     }\n \n     #[derive(Debug)]\n-    pub struct TraitBound;\n+    pub struct TraitBound(pub mir::LocalKind);\n     impl NonConstOp for TraitBound {\n-        const STOPS_CONST_CHECKING: bool = true;\n+        fn importance(&self) -> DiagnosticImportance {\n+            match self.0 {\n+                mir::LocalKind::Var | mir::LocalKind::Temp => DiagnosticImportance::Secondary,\n+                mir::LocalKind::ReturnPointer | mir::LocalKind::Arg => {\n+                    DiagnosticImportance::Primary\n+                }\n+            }\n+        }\n \n         fn status_in_item(&self, ccx: &ConstCx<'_, '_>) -> Status {\n             mcf_status_in_item(ccx)"}, {"sha": "a2dff46982b8ef027d845040efaf9e01570d08f8", "filename": "compiler/rustc_mir/src/transform/check_consts/validation.rs", "status": "modified", "additions": 8, "deletions": 4, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/e02ea835a75b75af740a45cf4b29c76610476569/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fcheck_consts%2Fvalidation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e02ea835a75b75af740a45cf4b29c76610476569/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fcheck_consts%2Fvalidation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fcheck_consts%2Fvalidation.rs?ref=e02ea835a75b75af740a45cf4b29c76610476569", "patch": "@@ -364,11 +364,11 @@ impl Validator<'mir, 'tcx> {\n                         match pred.skip_binder() {\n                             ty::ExistentialPredicate::AutoTrait(_)\n                             | ty::ExistentialPredicate::Projection(_) => {\n-                                self.check_op(ops::ty::TraitBound)\n+                                self.check_op(ops::ty::TraitBound(kind))\n                             }\n                             ty::ExistentialPredicate::Trait(trait_ref) => {\n                                 if Some(trait_ref.def_id) != self.tcx.lang_items().sized_trait() {\n-                                    self.check_op(ops::ty::TraitBound)\n+                                    self.check_op(ops::ty::TraitBound(kind))\n                                 }\n                             }\n                         }\n@@ -413,15 +413,19 @@ impl Validator<'mir, 'tcx> {\n                                 let def = generics.type_param(p, tcx);\n                                 let span = tcx.def_span(def.def_id);\n \n+                                // These are part of the function signature, so treat them like\n+                                // arguments when determining importance.\n+                                let kind = LocalKind::Arg;\n+\n                                 if constness == hir::Constness::Const {\n-                                    self.check_op_spanned(ops::ty::TraitBound, span);\n+                                    self.check_op_spanned(ops::ty::TraitBound(kind), span);\n                                 } else if !tcx.features().const_fn\n                                     || self.ccx.is_const_stable_const_fn()\n                                 {\n                                     // HACK: We shouldn't need the conditional above, but trait\n                                     // bounds on containing impl blocks are wrongly being marked as\n                                     // \"not-const\".\n-                                    self.check_op_spanned(ops::ty::TraitBound, span);\n+                                    self.check_op_spanned(ops::ty::TraitBound(kind), span);\n                                 }\n                             }\n                             // other kinds of bounds are either tautologies"}]}