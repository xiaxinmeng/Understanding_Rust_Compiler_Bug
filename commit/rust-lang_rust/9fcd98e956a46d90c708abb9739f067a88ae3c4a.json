{"sha": "9fcd98e956a46d90c708abb9739f067a88ae3c4a", "node_id": "MDY6Q29tbWl0NzI0NzEyOjlmY2Q5OGU5NTZhNDZkOTBjNzA4YWJiOTczOWYwNjdhODhhZTNjNGE=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-11-18T11:23:24Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-11-18T11:23:24Z"}, "message": "Add ra_ide_api::expand\n\nThis module should handle all tricky bits with mapping macro-expanded\nHirFileId to original files the user actually can see in the editor", "tree": {"sha": "ffc9afa4bd6f436e51eaa3de9758916a1bdc7124", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ffc9afa4bd6f436e51eaa3de9758916a1bdc7124"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9fcd98e956a46d90c708abb9739f067a88ae3c4a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9fcd98e956a46d90c708abb9739f067a88ae3c4a", "html_url": "https://github.com/rust-lang/rust/commit/9fcd98e956a46d90c708abb9739f067a88ae3c4a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9fcd98e956a46d90c708abb9739f067a88ae3c4a/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6d8ca870b3d8a12e7b2460532712f9a6daf80afb", "url": "https://api.github.com/repos/rust-lang/rust/commits/6d8ca870b3d8a12e7b2460532712f9a6daf80afb", "html_url": "https://github.com/rust-lang/rust/commit/6d8ca870b3d8a12e7b2460532712f9a6daf80afb"}], "stats": {"total": 124, "additions": 69, "deletions": 55}, "files": [{"sha": "291b5ee40ac9d838610be5b671b137849452b4f7", "filename": "crates/ra_ide_api/src/display/navigation_target.rs", "status": "modified", "additions": 21, "deletions": 33, "changes": 54, "blob_url": "https://github.com/rust-lang/rust/blob/9fcd98e956a46d90c708abb9739f067a88ae3c4a/crates%2Fra_ide_api%2Fsrc%2Fdisplay%2Fnavigation_target.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9fcd98e956a46d90c708abb9739f067a88ae3c4a/crates%2Fra_ide_api%2Fsrc%2Fdisplay%2Fnavigation_target.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2Fsrc%2Fdisplay%2Fnavigation_target.rs?ref=9fcd98e956a46d90c708abb9739f067a88ae3c4a", "patch": "@@ -9,8 +9,9 @@ use ra_syntax::{\n     SyntaxNode, TextRange,\n };\n \n+use crate::{db::RootDatabase, expand::original_range, FileSymbol};\n+\n use super::short_label::ShortLabel;\n-use crate::{db::RootDatabase, FileSymbol};\n \n /// `NavigationTarget` represents and element in the editor's UI which you can\n /// click on to navigate to a particular piece of code.\n@@ -79,13 +80,12 @@ impl NavigationTarget {\n     pub(crate) fn from_module_to_decl(db: &RootDatabase, module: hir::Module) -> NavigationTarget {\n         let name = module.name(db).map(|it| it.to_string().into()).unwrap_or_default();\n         if let Some(src) = module.declaration_source(db) {\n-            let (file_id, text_range) =\n-                find_range_from_node(db, src.as_ref().map(|it| it.syntax()));\n+            let frange = original_range(db, src.as_ref().map(|it| it.syntax()));\n             return NavigationTarget::from_syntax(\n-                file_id,\n+                frange.file_id,\n                 name,\n                 None,\n-                text_range,\n+                frange.range,\n                 src.ast.syntax(),\n                 src.ast.doc_comment_text(),\n                 src.ast.short_label(),\n@@ -149,14 +149,14 @@ impl NavigationTarget {\n         //FIXME: use `_` instead of empty string\n         let name = node.name().map(|it| it.text().clone()).unwrap_or_default();\n         let focus_range =\n-            node.name().map(|it| find_range_from_node(db, Source::new(file_id, it.syntax())).1);\n-        let (file_id, full_range) = find_range_from_node(db, Source::new(file_id, node.syntax()));\n+            node.name().map(|it| original_range(db, Source::new(file_id, it.syntax())).range);\n+        let frange = original_range(db, Source::new(file_id, node.syntax()));\n \n         NavigationTarget::from_syntax(\n-            file_id,\n+            frange.file_id,\n             name,\n             focus_range,\n-            full_range,\n+            frange.range,\n             node.syntax(),\n             docs,\n             description,\n@@ -234,26 +234,26 @@ impl ToNav for hir::Module {\n         let name = self.name(db).map(|it| it.to_string().into()).unwrap_or_default();\n         match &src.ast {\n             ModuleSource::SourceFile(node) => {\n-                let (file_id, text_range) = find_range_from_node(db, src.with_ast(node.syntax()));\n+                let frange = original_range(db, src.with_ast(node.syntax()));\n \n                 NavigationTarget::from_syntax(\n-                    file_id,\n+                    frange.file_id,\n                     name,\n                     None,\n-                    text_range,\n+                    frange.range,\n                     node.syntax(),\n                     None,\n                     None,\n                 )\n             }\n             ModuleSource::Module(node) => {\n-                let (file_id, text_range) = find_range_from_node(db, src.with_ast(node.syntax()));\n+                let frange = original_range(db, src.with_ast(node.syntax()));\n \n                 NavigationTarget::from_syntax(\n-                    file_id,\n+                    frange.file_id,\n                     name,\n                     None,\n-                    text_range,\n+                    frange.range,\n                     node.syntax(),\n                     node.doc_comment_text(),\n                     node.short_label(),\n@@ -266,13 +266,13 @@ impl ToNav for hir::Module {\n impl ToNav for hir::ImplBlock {\n     fn to_nav(&self, db: &RootDatabase) -> NavigationTarget {\n         let src = self.source(db);\n-        let (file_id, text_range) = find_range_from_node(db, src.as_ref().map(|it| it.syntax()));\n+        let frange = original_range(db, src.as_ref().map(|it| it.syntax()));\n \n         NavigationTarget::from_syntax(\n-            file_id,\n+            frange.file_id,\n             \"impl\".into(),\n             None,\n-            text_range,\n+            frange.range,\n             src.ast.syntax(),\n             None,\n             None,\n@@ -293,12 +293,12 @@ impl ToNav for hir::StructField {\n                 it.short_label(),\n             ),\n             FieldSource::Pos(it) => {\n-                let (file_id, text_range) = find_range_from_node(db, src.with_ast(it.syntax()));\n+                let frange = original_range(db, src.with_ast(it.syntax()));\n                 NavigationTarget::from_syntax(\n-                    file_id,\n+                    frange.file_id,\n                     \"\".into(),\n                     None,\n-                    text_range,\n+                    frange.range,\n                     it.syntax(),\n                     None,\n                     None,\n@@ -362,18 +362,6 @@ impl ToNav for hir::Local {\n     }\n }\n \n-fn find_range_from_node(db: &RootDatabase, node: Source<&SyntaxNode>) -> (FileId, TextRange) {\n-    let text_range = node.ast.text_range();\n-    let (file_id, text_range) = node\n-        .file_id\n-        .expansion_info(db)\n-        .and_then(|expansion_info| expansion_info.find_range(text_range))\n-        .unwrap_or((node.file_id, text_range));\n-\n-    // FIXME: handle recursive macro generated macro\n-    (file_id.original_file(db), text_range)\n-}\n-\n pub(crate) fn docs_from_symbol(db: &RootDatabase, symbol: &FileSymbol) -> Option<String> {\n     let parse = db.parse(symbol.file_id);\n     let node = symbol.ptr.to_node(parse.tree().syntax());"}, {"sha": "5f1fb9a1269e6c7fe1a1c6ce782cc4908d2fdb95", "filename": "crates/ra_ide_api/src/expand.rs", "status": "added", "additions": 42, "deletions": 0, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/9fcd98e956a46d90c708abb9739f067a88ae3c4a/crates%2Fra_ide_api%2Fsrc%2Fexpand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9fcd98e956a46d90c708abb9739f067a88ae3c4a/crates%2Fra_ide_api%2Fsrc%2Fexpand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2Fsrc%2Fexpand.rs?ref=9fcd98e956a46d90c708abb9739f067a88ae3c4a", "patch": "@@ -0,0 +1,42 @@\n+//! Utilities to work with files, produced by macros.\n+use std::iter::successors;\n+\n+use hir::Source;\n+use ra_db::FileId;\n+use ra_syntax::{ast, AstNode, SyntaxNode, SyntaxToken};\n+\n+use crate::{db::RootDatabase, FileRange};\n+\n+pub(crate) fn original_range(db: &RootDatabase, node: Source<&SyntaxNode>) -> FileRange {\n+    let text_range = node.ast.text_range();\n+    let (file_id, range) = node\n+        .file_id\n+        .expansion_info(db)\n+        .and_then(|expansion_info| expansion_info.find_range(text_range))\n+        .unwrap_or((node.file_id, text_range));\n+\n+    // FIXME: handle recursive macro generated macro\n+    FileRange { file_id: file_id.original_file(db), range }\n+}\n+\n+pub(crate) fn descend_into_macros(\n+    db: &RootDatabase,\n+    file_id: FileId,\n+    token: SyntaxToken,\n+) -> Source<SyntaxToken> {\n+    let src = Source::new(file_id.into(), token);\n+\n+    successors(Some(src), |token| {\n+        let macro_call = token.ast.ancestors().find_map(ast::MacroCall::cast)?;\n+        let tt = macro_call.token_tree()?;\n+        if !token.ast.text_range().is_subrange(&tt.syntax().text_range()) {\n+            return None;\n+        }\n+        let source_analyzer =\n+            hir::SourceAnalyzer::new(db, token.with_ast(token.ast.parent()).as_ref(), None);\n+        let exp = source_analyzer.expand(db, &macro_call)?;\n+        exp.map_token_down(db, token.as_ref())\n+    })\n+    .last()\n+    .unwrap()\n+}"}, {"sha": "1a8db0ea07289884671efff9cdb64c50f68c74e5", "filename": "crates/ra_ide_api/src/goto_definition.rs", "status": "modified", "additions": 5, "deletions": 22, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/9fcd98e956a46d90c708abb9739f067a88ae3c4a/crates%2Fra_ide_api%2Fsrc%2Fgoto_definition.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9fcd98e956a46d90c708abb9739f067a88ae3c4a/crates%2Fra_ide_api%2Fsrc%2Fgoto_definition.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2Fsrc%2Fgoto_definition.rs?ref=9fcd98e956a46d90c708abb9739f067a88ae3c4a", "patch": "@@ -1,16 +1,15 @@\n //! FIXME: write short doc here\n \n-use std::iter::successors;\n-\n use hir::{db::AstDatabase, Source};\n use ra_syntax::{\n     ast::{self, DocCommentsOwner},\n-    match_ast, AstNode, SyntaxNode, SyntaxToken,\n+    match_ast, AstNode, SyntaxNode,\n };\n \n use crate::{\n     db::RootDatabase,\n     display::{ShortLabel, ToNav},\n+    expand::descend_into_macros,\n     references::{classify_name_ref, NameKind::*},\n     FilePosition, NavigationTarget, RangeInfo,\n };\n@@ -19,7 +18,9 @@ pub(crate) fn goto_definition(\n     db: &RootDatabase,\n     position: FilePosition,\n ) -> Option<RangeInfo<Vec<NavigationTarget>>> {\n-    let token = descend_into_macros(db, position)?;\n+    let file = db.parse_or_expand(position.file_id.into())?;\n+    let token = file.token_at_offset(position.offset).filter(|it| !it.kind().is_trivia()).next()?;\n+    let token = descend_into_macros(db, position.file_id, token);\n \n     let res = match_ast! {\n         match (token.ast.parent()) {\n@@ -39,24 +40,6 @@ pub(crate) fn goto_definition(\n     Some(res)\n }\n \n-fn descend_into_macros(db: &RootDatabase, position: FilePosition) -> Option<Source<SyntaxToken>> {\n-    let file = db.parse_or_expand(position.file_id.into())?;\n-    let token = file.token_at_offset(position.offset).filter(|it| !it.kind().is_trivia()).next()?;\n-\n-    successors(Some(Source::new(position.file_id.into(), token)), |token| {\n-        let macro_call = token.ast.ancestors().find_map(ast::MacroCall::cast)?;\n-        let tt = macro_call.token_tree()?;\n-        if !token.ast.text_range().is_subrange(&tt.syntax().text_range()) {\n-            return None;\n-        }\n-        let source_analyzer =\n-            hir::SourceAnalyzer::new(db, token.with_ast(token.ast.parent()).as_ref(), None);\n-        let exp = source_analyzer.expand(db, &macro_call)?;\n-        exp.map_token_down(db, token.as_ref())\n-    })\n-    .last()\n-}\n-\n #[derive(Debug)]\n pub(crate) enum ReferenceResult {\n     Exact(NavigationTarget),"}, {"sha": "110ddcd6265020d7d753a0f5db40e6f825d7cfcf", "filename": "crates/ra_ide_api/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/9fcd98e956a46d90c708abb9739f067a88ae3c4a/crates%2Fra_ide_api%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9fcd98e956a46d90c708abb9739f067a88ae3c4a/crates%2Fra_ide_api%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2Fsrc%2Flib.rs?ref=9fcd98e956a46d90c708abb9739f067a88ae3c4a", "patch": "@@ -41,6 +41,7 @@ mod matching_brace;\n mod display;\n mod inlay_hints;\n mod wasm_shims;\n+mod expand;\n \n #[cfg(test)]\n mod marks;"}]}