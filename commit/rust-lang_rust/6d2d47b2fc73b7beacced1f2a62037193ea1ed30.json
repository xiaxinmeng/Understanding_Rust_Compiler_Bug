{"sha": "6d2d47b2fc73b7beacced1f2a62037193ea1ed30", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZkMmQ0N2IyZmM3M2I3YmVhY2NlZDFmMmE2MjAzNzE5M2VhMWVkMzA=", "commit": {"author": {"name": "Stuart Pernsteiner", "email": "spernsteiner@mozilla.com", "date": "2014-09-05T21:30:36Z"}, "committer": {"name": "Stuart Pernsteiner", "email": "spernsteiner@mozilla.com", "date": "2014-09-05T21:30:36Z"}, "message": "don't use `ld -r` with `-C codegen-units=1`", "tree": {"sha": "c88f402339467ddad0625255f499de617d21d069", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c88f402339467ddad0625255f499de617d21d069"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6d2d47b2fc73b7beacced1f2a62037193ea1ed30", "comment_count": 5, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6d2d47b2fc73b7beacced1f2a62037193ea1ed30", "html_url": "https://github.com/rust-lang/rust/commit/6d2d47b2fc73b7beacced1f2a62037193ea1ed30", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6d2d47b2fc73b7beacced1f2a62037193ea1ed30/comments", "author": {"login": "spernsteiner", "id": 3031136, "node_id": "MDQ6VXNlcjMwMzExMzY=", "avatar_url": "https://avatars.githubusercontent.com/u/3031136?v=4", "gravatar_id": "", "url": "https://api.github.com/users/spernsteiner", "html_url": "https://github.com/spernsteiner", "followers_url": "https://api.github.com/users/spernsteiner/followers", "following_url": "https://api.github.com/users/spernsteiner/following{/other_user}", "gists_url": "https://api.github.com/users/spernsteiner/gists{/gist_id}", "starred_url": "https://api.github.com/users/spernsteiner/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/spernsteiner/subscriptions", "organizations_url": "https://api.github.com/users/spernsteiner/orgs", "repos_url": "https://api.github.com/users/spernsteiner/repos", "events_url": "https://api.github.com/users/spernsteiner/events{/privacy}", "received_events_url": "https://api.github.com/users/spernsteiner/received_events", "type": "User", "site_admin": false}, "committer": {"login": "spernsteiner", "id": 3031136, "node_id": "MDQ6VXNlcjMwMzExMzY=", "avatar_url": "https://avatars.githubusercontent.com/u/3031136?v=4", "gravatar_id": "", "url": "https://api.github.com/users/spernsteiner", "html_url": "https://github.com/spernsteiner", "followers_url": "https://api.github.com/users/spernsteiner/followers", "following_url": "https://api.github.com/users/spernsteiner/following{/other_user}", "gists_url": "https://api.github.com/users/spernsteiner/gists{/gist_id}", "starred_url": "https://api.github.com/users/spernsteiner/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/spernsteiner/subscriptions", "organizations_url": "https://api.github.com/users/spernsteiner/orgs", "repos_url": "https://api.github.com/users/spernsteiner/repos", "events_url": "https://api.github.com/users/spernsteiner/events{/privacy}", "received_events_url": "https://api.github.com/users/spernsteiner/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4d9a4786163a9a9831bf4e283b4e408be03a169b", "url": "https://api.github.com/repos/rust-lang/rust/commits/4d9a4786163a9a9831bf4e283b4e408be03a169b", "html_url": "https://github.com/rust-lang/rust/commit/4d9a4786163a9a9831bf4e283b4e408be03a169b"}], "stats": {"total": 12, "additions": 12, "deletions": 0}, "files": [{"sha": "627d455f06e11f90297619675e0658783417a00d", "filename": "src/librustc/back/write.rs", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/6d2d47b2fc73b7beacced1f2a62037193ea1ed30/src%2Flibrustc%2Fback%2Fwrite.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6d2d47b2fc73b7beacced1f2a62037193ea1ed30/src%2Flibrustc%2Fback%2Fwrite.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fback%2Fwrite.rs?ref=6d2d47b2fc73b7beacced1f2a62037193ea1ed30", "patch": "@@ -476,6 +476,9 @@ pub fn run_passes(sess: &Session,\n         sess.fatal(\"can't perform LTO when using multiple codegen units\");\n     }\n \n+    // Sanity check\n+    assert!(trans.modules.len() == sess.opts.cg.codegen_units);\n+\n     unsafe {\n         configure_llvm(sess);\n     }\n@@ -607,6 +610,15 @@ pub fn run_passes(sess: &Session,\n     };\n \n     let link_obj = |output_path: &Path| {\n+        // Running `ld -r` on a single input is kind of pointless.\n+        if sess.opts.cg.codegen_units == 1 {\n+            fs::copy(&crate_output.with_extension(\"0.o\"),\n+                     output_path).unwrap();\n+            // Leave the .0.o file around, to mimic the behavior of the normal\n+            // code path.\n+            return;\n+        }\n+\n         // Some builds of MinGW GCC will pass --force-exe-suffix to ld, which\n         // will automatically add a .exe extension if the extension is not\n         // already .exe or .dll.  To ensure consistent behavior on Windows, we"}]}