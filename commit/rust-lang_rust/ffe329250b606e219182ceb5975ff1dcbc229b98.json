{"sha": "ffe329250b606e219182ceb5975ff1dcbc229b98", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZmZTMyOTI1MGI2MDZlMjE5MTgyY2ViNTk3NWZmMWRjYmMyMjliOTg=", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2020-05-30T21:08:51Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-05-30T21:08:51Z"}, "message": "Rollup merge of #72666 - ivanloz:profile_emit_flag, r=matthewjasper\n\nAdd -Z profile-emit=<path> for Gcov gcda output.\n\nAdds a -Z flag to control the file path that the Gcov gcda output is\nwritten to during runtime. This flag expects a path and filename, e.g.\n-Z profile-emit=gcov/out/lib.gcda.\n\nThis works similar to GCC/Clang's -fprofile-dir flag which allows\ncontrol over the output path for gcda coverage files.", "tree": {"sha": "bd12528db4b72a6ed1594df6f1fc9358c7ce0999", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bd12528db4b72a6ed1594df6f1fc9358c7ce0999"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ffe329250b606e219182ceb5975ff1dcbc229b98", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJe0stkCRBK7hj4Ov3rIwAAdHIIAEl2DnUxvBNuDyF267aF6e/3\nwemNiUwyiwp0rvZEHzJimEMDeurGAQpd+0oVSPikiK0yv1aIc8IBbdmmrQ6KuWJO\ndVMM9sw/utq5EfWvMZKOyWFdPdgyy4XGH+sKeS1nO5A2fyllHpP93C3HP4L8JysI\nR0Gf/TWJs/Ym/Z5pQ9SOSoDdTDvcSEBnqLN+SiR7MkTdS8m0QL7VYLSa3EPqkS8t\nYdy+OPo008LZ6wtylrH4EgG3nXHXc/zMlwxc26pN14ObIpqlteBRsDsyddGWSLcH\nxf8hGJ0w7bGn6BFbRN/6uTiAzQqz4E/c/ZWvuEkQ4JA4T+wkNAOILWLSJhEwGi4=\n=U0nD\n-----END PGP SIGNATURE-----\n", "payload": "tree bd12528db4b72a6ed1594df6f1fc9358c7ce0999\nparent 320de71cdd016201d9ec6b1a214befccb36e0de5\nparent 0c1ef853bb6ff87c2179b5e41b7e044b6c5b79cb\nauthor Ralf Jung <post@ralfj.de> 1590872931 +0200\ncommitter GitHub <noreply@github.com> 1590872931 +0200\n\nRollup merge of #72666 - ivanloz:profile_emit_flag, r=matthewjasper\n\nAdd -Z profile-emit=<path> for Gcov gcda output.\n\nAdds a -Z flag to control the file path that the Gcov gcda output is\nwritten to during runtime. This flag expects a path and filename, e.g.\n-Z profile-emit=gcov/out/lib.gcda.\n\nThis works similar to GCC/Clang's -fprofile-dir flag which allows\ncontrol over the output path for gcda coverage files.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ffe329250b606e219182ceb5975ff1dcbc229b98", "html_url": "https://github.com/rust-lang/rust/commit/ffe329250b606e219182ceb5975ff1dcbc229b98", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ffe329250b606e219182ceb5975ff1dcbc229b98/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "320de71cdd016201d9ec6b1a214befccb36e0de5", "url": "https://api.github.com/repos/rust-lang/rust/commits/320de71cdd016201d9ec6b1a214befccb36e0de5", "html_url": "https://github.com/rust-lang/rust/commit/320de71cdd016201d9ec6b1a214befccb36e0de5"}, {"sha": "0c1ef853bb6ff87c2179b5e41b7e044b6c5b79cb", "url": "https://api.github.com/repos/rust-lang/rust/commits/0c1ef853bb6ff87c2179b5e41b7e044b6c5b79cb", "html_url": "https://github.com/rust-lang/rust/commit/0c1ef853bb6ff87c2179b5e41b7e044b6c5b79cb"}], "stats": {"total": 15, "additions": 11, "deletions": 4}, "files": [{"sha": "333eb805221ff0fda5ec6b462fde4dd76a60c0b2", "filename": "src/librustc_codegen_llvm/debuginfo/metadata.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ffe329250b606e219182ceb5975ff1dcbc229b98/src%2Flibrustc_codegen_llvm%2Fdebuginfo%2Fmetadata.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ffe329250b606e219182ceb5975ff1dcbc229b98/src%2Flibrustc_codegen_llvm%2Fdebuginfo%2Fmetadata.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fdebuginfo%2Fmetadata.rs?ref=ffe329250b606e219182ceb5975ff1dcbc229b98", "patch": "@@ -959,16 +959,16 @@ pub fn compile_unit_metadata(\n         if tcx.sess.opts.debugging_opts.profile {\n             let cu_desc_metadata =\n                 llvm::LLVMRustMetadataAsValue(debug_context.llcontext, unit_metadata);\n+            let default_gcda_path = &tcx.output_filenames(LOCAL_CRATE).with_extension(\"gcda\");\n+            let gcda_path =\n+                tcx.sess.opts.debugging_opts.profile_emit.as_ref().unwrap_or(default_gcda_path);\n \n             let gcov_cu_info = [\n                 path_to_mdstring(\n                     debug_context.llcontext,\n                     &tcx.output_filenames(LOCAL_CRATE).with_extension(\"gcno\"),\n                 ),\n-                path_to_mdstring(\n-                    debug_context.llcontext,\n-                    &tcx.output_filenames(LOCAL_CRATE).with_extension(\"gcda\"),\n-                ),\n+                path_to_mdstring(debug_context.llcontext, &gcda_path),\n                 cu_desc_metadata,\n             ];\n             let gcov_metadata = llvm::LLVMMDNodeInContext("}, {"sha": "91a4bc2b86856ce6d9c65387534f0218abfca173", "filename": "src/librustc_interface/tests.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/ffe329250b606e219182ceb5975ff1dcbc229b98/src%2Flibrustc_interface%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ffe329250b606e219182ceb5975ff1dcbc229b98/src%2Flibrustc_interface%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_interface%2Ftests.rs?ref=ffe329250b606e219182ceb5975ff1dcbc229b98", "patch": "@@ -557,6 +557,7 @@ fn test_debugging_options_tracking_hash() {\n     tracked!(plt, Some(true));\n     tracked!(print_fuel, Some(\"abc\".to_string()));\n     tracked!(profile, true);\n+    tracked!(profile_emit, Some(PathBuf::from(\"abc\")));\n     tracked!(relro_level, Some(RelroLevel::Full));\n     tracked!(report_delayed_bugs, true);\n     tracked!(run_dsymutil, false);"}, {"sha": "a38e7f063d79ae88daa355432f9d89c72c8381a4", "filename": "src/librustc_session/options.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/ffe329250b606e219182ceb5975ff1dcbc229b98/src%2Flibrustc_session%2Foptions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ffe329250b606e219182ceb5975ff1dcbc229b98/src%2Flibrustc_session%2Foptions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_session%2Foptions.rs?ref=ffe329250b606e219182ceb5975ff1dcbc229b98", "patch": "@@ -955,6 +955,9 @@ options! {DebuggingOptions, DebuggingSetter, basic_debugging_options,\n         \"print layout information for each type encountered (default: no)\"),\n     profile: bool = (false, parse_bool, [TRACKED],\n         \"insert profiling code (default: no)\"),\n+    profile_emit: Option<PathBuf> = (None, parse_opt_pathbuf, [TRACKED],\n+        \"file path to emit profiling data at runtime when using 'profile' \\\n+        (default based on relative source path)\"),\n     query_dep_graph: bool = (false, parse_bool, [UNTRACKED],\n         \"enable queries of the dependency graph for regression testing (default: no)\"),\n     query_stats: bool = (false, parse_bool, [UNTRACKED],"}, {"sha": "04d382b475ed298111d1e614f045a0589706140f", "filename": "src/test/run-make-fulldeps/profile/Makefile", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/ffe329250b606e219182ceb5975ff1dcbc229b98/src%2Ftest%2Frun-make-fulldeps%2Fprofile%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/ffe329250b606e219182ceb5975ff1dcbc229b98/src%2Ftest%2Frun-make-fulldeps%2Fprofile%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fprofile%2FMakefile?ref=ffe329250b606e219182ceb5975ff1dcbc229b98", "patch": "@@ -7,3 +7,6 @@ all:\n \t$(call RUN,test) || exit 1\n \t[ -e \"$(TMPDIR)/test.gcno\" ] || (echo \"No .gcno file\"; exit 1)\n \t[ -e \"$(TMPDIR)/test.gcda\" ] || (echo \"No .gcda file\"; exit 1)\n+\t$(RUSTC) -g -Z profile -Z profile-emit=$(TMPDIR)/abc/abc.gcda test.rs\n+\t$(call RUN,test) || exit 1\n+\t[ -e \"$(TMPDIR)/abc/abc.gcda\" ] || (echo \"gcda file not emitted to defined path\"; exit 1)"}]}