{"sha": "04006d8e3b5043131ec56a5f3605b1edcb33194d", "node_id": "C_kwDOAAsO6NoAKDA0MDA2ZDhlM2I1MDQzMTMxZWM1NmE1ZjM2MDViMWVkY2IzMzE5NGQ", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-09-27T05:00:59Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-09-27T05:00:59Z"}, "message": "Auto merge of #89182 - GuillaumeGomez:boostrap-explicit-request, r=Mark-Simulacrum\n\nSimplify explicit request check and allow to run \"doc src/librustdoc\" even without config set\n\nOriginally I wanted to allow the command `doc src/librustdoc` to work when passed explicitly but then `@Mark-Simulacrum` recommended me to generalize it, so here we are!\n\nr? `@Mark-Simulacrum`", "tree": {"sha": "7a0890f41364094a01eac4b24f97da71802c8e1f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7a0890f41364094a01eac4b24f97da71802c8e1f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/04006d8e3b5043131ec56a5f3605b1edcb33194d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/04006d8e3b5043131ec56a5f3605b1edcb33194d", "html_url": "https://github.com/rust-lang/rust/commit/04006d8e3b5043131ec56a5f3605b1edcb33194d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/04006d8e3b5043131ec56a5f3605b1edcb33194d/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c81c3ea321cfa9e760ba197da667584c234e9272", "url": "https://api.github.com/repos/rust-lang/rust/commits/c81c3ea321cfa9e760ba197da667584c234e9272", "html_url": "https://github.com/rust-lang/rust/commit/c81c3ea321cfa9e760ba197da667584c234e9272"}, {"sha": "10bef56fff02ff1da8a0993f33e6d226882c5ccd", "url": "https://api.github.com/repos/rust-lang/rust/commits/10bef56fff02ff1da8a0993f33e6d226882c5ccd", "html_url": "https://github.com/rust-lang/rust/commit/10bef56fff02ff1da8a0993f33e6d226882c5ccd"}], "stats": {"total": 47, "additions": 30, "deletions": 17}, "files": [{"sha": "1f2109879d121bc452264f42afbf8f60dae5fecf", "filename": "src/bootstrap/builder.rs", "status": "modified", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/04006d8e3b5043131ec56a5f3605b1edcb33194d/src%2Fbootstrap%2Fbuilder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/04006d8e3b5043131ec56a5f3605b1edcb33194d/src%2Fbootstrap%2Fbuilder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuilder.rs?ref=04006d8e3b5043131ec56a5f3605b1edcb33194d", "patch": "@@ -1617,6 +1617,22 @@ impl<'a> Builder<'a> {\n         // Only execute if it's supposed to run as default\n         if desc.default && should_run.is_really_default() { self.ensure(step) } else { None }\n     }\n+\n+    /// Checks if any of the \"should_run\" paths is in the `Builder` paths.\n+    pub(crate) fn was_invoked_explicitly<S: Step>(&'a self) -> bool {\n+        let desc = StepDescription::from::<S>();\n+        let should_run = (desc.should_run)(ShouldRun::new(self));\n+\n+        for path in &self.paths {\n+            if should_run.paths.iter().any(|s| s.has(path))\n+                && !desc.is_excluded(self, &PathSet::Suite(path.clone()))\n+            {\n+                return true;\n+            }\n+        }\n+\n+        false\n+    }\n }\n \n #[cfg(test)]"}, {"sha": "6f2470b706a64ff8d16b979376181196ce976230", "filename": "src/bootstrap/doc.rs", "status": "modified", "additions": 14, "deletions": 17, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/04006d8e3b5043131ec56a5f3605b1edcb33194d/src%2Fbootstrap%2Fdoc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/04006d8e3b5043131ec56a5f3605b1edcb33194d/src%2Fbootstrap%2Fdoc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fdoc.rs?ref=04006d8e3b5043131ec56a5f3605b1edcb33194d", "patch": "@@ -102,18 +102,10 @@ fn open(builder: &Builder<'_>, path: impl AsRef<Path>) {\n // Used for deciding whether a particular step is one requested by the user on\n // the `x.py doc` command line, which determines whether `--open` will open that\n // page.\n-fn components_simplified(path: &PathBuf) -> Vec<&str> {\n+pub(crate) fn components_simplified(path: &PathBuf) -> Vec<&str> {\n     path.iter().map(|component| component.to_str().unwrap_or(\"???\")).collect()\n }\n \n-fn is_explicit_request(builder: &Builder<'_>, path: &str) -> bool {\n-    builder\n-        .paths\n-        .iter()\n-        .map(components_simplified)\n-        .any(|requested| requested.iter().copied().eq(path.split('/')))\n-}\n-\n #[derive(Debug, Copy, Clone, Hash, PartialEq, Eq)]\n pub struct UnstableBook {\n     target: TargetSelection,\n@@ -248,7 +240,7 @@ impl Step for TheBook {\n             invoke_rustdoc(builder, compiler, target, path);\n         }\n \n-        if is_explicit_request(builder, \"src/doc/book\") {\n+        if builder.was_invoked_explicitly::<Self>() {\n             let out = builder.doc_out(target);\n             let index = out.join(\"book\").join(\"index.html\");\n             open(builder, &index);\n@@ -408,7 +400,7 @@ impl Step for Standalone {\n \n         // We open doc/index.html as the default if invoked as `x.py doc --open`\n         // with no particular explicit doc requested (e.g. library/core).\n-        if builder.paths.is_empty() || is_explicit_request(builder, \"src/doc\") {\n+        if builder.paths.is_empty() || builder.was_invoked_explicitly::<Self>() {\n             let index = out.join(\"index.html\");\n             open(builder, &index);\n         }\n@@ -553,7 +545,6 @@ impl Step for Rustc {\n     fn run(self, builder: &Builder<'_>) {\n         let stage = self.stage;\n         let target = self.target;\n-        let mut is_explicit_request = false;\n         builder.info(&format!(\"Documenting stage{} compiler ({})\", stage, target));\n \n         let paths = builder\n@@ -562,15 +553,14 @@ impl Step for Rustc {\n             .map(components_simplified)\n             .filter_map(|path| {\n                 if path.get(0) == Some(&\"compiler\") {\n-                    is_explicit_request = true;\n                     path.get(1).map(|p| p.to_owned())\n                 } else {\n                     None\n                 }\n             })\n             .collect::<Vec<_>>();\n \n-        if !builder.config.compiler_docs && !is_explicit_request {\n+        if !builder.config.compiler_docs && !builder.was_invoked_explicitly::<Self>() {\n             builder.info(\"\\tskipping - compiler/librustdoc docs disabled\");\n             return;\n         }\n@@ -700,15 +690,22 @@ macro_rules! tool_doc {\n             fn run(self, builder: &Builder<'_>) {\n                 let stage = self.stage;\n                 let target = self.target;\n-                builder.info(&format!(\"Documenting stage{} {} ({})\", stage, stringify!($tool).to_lowercase(), target));\n+                builder.info(\n+                    &format!(\n+                        \"Documenting stage{} {} ({})\",\n+                        stage,\n+                        stringify!($tool).to_lowercase(),\n+                        target,\n+                    ),\n+                );\n \n                 // This is the intended out directory for compiler documentation.\n                 let out = builder.compiler_doc_out(target);\n                 t!(fs::create_dir_all(&out));\n \n                 let compiler = builder.compiler(stage, builder.config.build);\n \n-                if !builder.config.compiler_docs {\n+                if !builder.config.compiler_docs && !builder.was_invoked_explicitly::<Self>() {\n                     builder.info(\"\\tskipping - compiler/tool docs disabled\");\n                     return;\n                 }\n@@ -913,7 +910,7 @@ impl Step for RustcBook {\n             name: INTERNER.intern_str(\"rustc\"),\n             src: INTERNER.intern_path(out_base),\n         });\n-        if is_explicit_request(builder, \"src/doc/rustc\") {\n+        if builder.was_invoked_explicitly::<Self>() {\n             let out = builder.doc_out(self.target);\n             let index = out.join(\"rustc\").join(\"index.html\");\n             open(builder, &index);"}]}