{"sha": "a2aa3d6e49d472b2218d81ec6ef34e2a2e6ad883", "node_id": "MDY6Q29tbWl0NzI0NzEyOmEyYWEzZDZlNDlkNDcyYjIyMThkODFlYzZlZjM0ZTJhMmU2YWQ4ODM=", "commit": {"author": {"name": "Dylan DPC", "email": "dylan.dpc@gmail.com", "date": "2020-12-04T02:30:37Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-12-04T02:30:37Z"}, "message": "Rollup merge of #79664 - vn-ki:move-memkind-heap, r=oli-obk\n\nmove interpret::MemoryKind::Heap to const eval\n\nr? ``@oli-obk``", "tree": {"sha": "9bbb8811f9651e6de0966774492b4bfbc0a0e425", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9bbb8811f9651e6de0966774492b4bfbc0a0e425"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a2aa3d6e49d472b2218d81ec6ef34e2a2e6ad883", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfyZ9OCRBK7hj4Ov3rIwAAdHIIAEXxfz6sUhxsfxjuMKYouLe5\nya8H9phSqtauzsN3k3G/6wJ/hpje3MF+wUUQ4+MYcGkxZF7a9ljfxDEIc8/3mQsZ\n54REcjYUOR3thjl83LLQwVDvC4WV2Qu0cVAByH0GRIKkMj2WwPwiE6NhcVk4nONw\nP9A0TPOK9y1HCRXIj0fdmKIa2S2tDpSAZyhbE5n55j1RK3exdUf/nQU1c8+dIxny\nwRB/mZ+Vh1UPFy86M2PXwbX2lDq7ASXfVwTA7cOsSLcsgquOgI1r/LW/6l94Tk1r\ntL7yF/POfZqzkFAXIcKIgyOY8ISpnAkY6HDAAm85JWDo7g0adKCBgKt7tbxH/fM=\n=sJTX\n-----END PGP SIGNATURE-----\n", "payload": "tree 9bbb8811f9651e6de0966774492b4bfbc0a0e425\nparent 0fbbe9466262ae28b129b0bda8f78c7d302e3c5e\nparent ff0ebd27a4436729b68cdf5180cfbb0c16c803a0\nauthor Dylan DPC <dylan.dpc@gmail.com> 1607049037 +0100\ncommitter GitHub <noreply@github.com> 1607049037 +0100\n\nRollup merge of #79664 - vn-ki:move-memkind-heap, r=oli-obk\n\nmove interpret::MemoryKind::Heap to const eval\n\nr? ``@oli-obk``\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a2aa3d6e49d472b2218d81ec6ef34e2a2e6ad883", "html_url": "https://github.com/rust-lang/rust/commit/a2aa3d6e49d472b2218d81ec6ef34e2a2e6ad883", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a2aa3d6e49d472b2218d81ec6ef34e2a2e6ad883/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0fbbe9466262ae28b129b0bda8f78c7d302e3c5e", "url": "https://api.github.com/repos/rust-lang/rust/commits/0fbbe9466262ae28b129b0bda8f78c7d302e3c5e", "html_url": "https://github.com/rust-lang/rust/commit/0fbbe9466262ae28b129b0bda8f78c7d302e3c5e"}, {"sha": "ff0ebd27a4436729b68cdf5180cfbb0c16c803a0", "url": "https://api.github.com/repos/rust-lang/rust/commits/ff0ebd27a4436729b68cdf5180cfbb0c16c803a0", "html_url": "https://github.com/rust-lang/rust/commit/ff0ebd27a4436729b68cdf5180cfbb0c16c803a0"}], "stats": {"total": 69, "additions": 48, "deletions": 21}, "files": [{"sha": "187f6fab5181f70f2417b11ec8575619fd0e507a", "filename": "compiler/rustc_mir/src/const_eval/machine.rs", "status": "modified", "additions": 26, "deletions": 1, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/a2aa3d6e49d472b2218d81ec6ef34e2a2e6ad883/compiler%2Frustc_mir%2Fsrc%2Fconst_eval%2Fmachine.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a2aa3d6e49d472b2218d81ec6ef34e2a2e6ad883/compiler%2Frustc_mir%2Fsrc%2Fconst_eval%2Fmachine.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Fconst_eval%2Fmachine.rs?ref=a2aa3d6e49d472b2218d81ec6ef34e2a2e6ad883", "patch": "@@ -7,6 +7,7 @@ use std::collections::hash_map::Entry;\n use std::hash::Hash;\n \n use rustc_data_structures::fx::FxHashMap;\n+use std::fmt;\n \n use rustc_ast::Mutability;\n use rustc_hir::def_id::DefId;\n@@ -179,6 +180,28 @@ impl<K: Hash + Eq, V> interpret::AllocMap<K, V> for FxHashMap<K, V> {\n crate type CompileTimeEvalContext<'mir, 'tcx> =\n     InterpCx<'mir, 'tcx, CompileTimeInterpreter<'mir, 'tcx>>;\n \n+#[derive(Debug, PartialEq, Eq, Copy, Clone)]\n+pub enum MemoryKind {\n+    Heap,\n+}\n+\n+impl fmt::Display for MemoryKind {\n+    fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {\n+        match self {\n+            MemoryKind::Heap => write!(f, \"heap allocation\"),\n+        }\n+    }\n+}\n+\n+impl interpret::MayLeak for MemoryKind {\n+    #[inline(always)]\n+    fn may_leak(self) -> bool {\n+        match self {\n+            MemoryKind::Heap => false,\n+        }\n+    }\n+}\n+\n impl interpret::MayLeak for ! {\n     #[inline(always)]\n     fn may_leak(self) -> bool {\n@@ -222,6 +245,8 @@ impl<'mir, 'tcx: 'mir> CompileTimeEvalContext<'mir, 'tcx> {\n impl<'mir, 'tcx> interpret::Machine<'mir, 'tcx> for CompileTimeInterpreter<'mir, 'tcx> {\n     compile_time_machine!(<'mir, 'tcx>);\n \n+    type MemoryKind = MemoryKind;\n+\n     type MemoryExtra = MemoryExtra;\n \n     fn find_mir_or_eval_fn(\n@@ -317,7 +342,7 @@ impl<'mir, 'tcx> interpret::Machine<'mir, 'tcx> for CompileTimeInterpreter<'mir,\n                 let ptr = ecx.memory.allocate(\n                     Size::from_bytes(size as u64),\n                     align,\n-                    interpret::MemoryKind::ConstHeap,\n+                    interpret::MemoryKind::Machine(MemoryKind::Heap),\n                 );\n                 ecx.write_scalar(Scalar::Ptr(ptr), dest)?;\n             }"}, {"sha": "01d58c47e3ab9f52141a8a12197cb396f967eed4", "filename": "compiler/rustc_mir/src/interpret/intern.rs", "status": "modified", "additions": 16, "deletions": 11, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/a2aa3d6e49d472b2218d81ec6ef34e2a2e6ad883/compiler%2Frustc_mir%2Fsrc%2Finterpret%2Fintern.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a2aa3d6e49d472b2218d81ec6ef34e2a2e6ad883/compiler%2Frustc_mir%2Fsrc%2Finterpret%2Fintern.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Finterpret%2Fintern.rs?ref=a2aa3d6e49d472b2218d81ec6ef34e2a2e6ad883", "patch": "@@ -25,19 +25,20 @@ use rustc_target::abi::Size;\n use rustc_ast::Mutability;\n \n use super::{AllocId, Allocation, InterpCx, MPlaceTy, Machine, MemoryKind, Scalar, ValueVisitor};\n+use crate::const_eval;\n \n-pub trait CompileTimeMachine<'mir, 'tcx> = Machine<\n+pub trait CompileTimeMachine<'mir, 'tcx, T> = Machine<\n     'mir,\n     'tcx,\n-    MemoryKind = !,\n+    MemoryKind = T,\n     PointerTag = (),\n     ExtraFnVal = !,\n     FrameExtra = (),\n     AllocExtra = (),\n-    MemoryMap = FxHashMap<AllocId, (MemoryKind<!>, Allocation)>,\n+    MemoryMap = FxHashMap<AllocId, (MemoryKind<T>, Allocation)>,\n >;\n \n-struct InternVisitor<'rt, 'mir, 'tcx, M: CompileTimeMachine<'mir, 'tcx>> {\n+struct InternVisitor<'rt, 'mir, 'tcx, M: CompileTimeMachine<'mir, 'tcx, const_eval::MemoryKind>> {\n     /// The ectx from which we intern.\n     ecx: &'rt mut InterpCx<'mir, 'tcx, M>,\n     /// Previously encountered safe references.\n@@ -74,7 +75,7 @@ struct IsStaticOrFn;\n /// `immutable` things might become mutable if `ty` is not frozen.\n /// `ty` can be `None` if there is no potential interior mutability\n /// to account for (e.g. for vtables).\n-fn intern_shallow<'rt, 'mir, 'tcx, M: CompileTimeMachine<'mir, 'tcx>>(\n+fn intern_shallow<'rt, 'mir, 'tcx, M: CompileTimeMachine<'mir, 'tcx, const_eval::MemoryKind>>(\n     ecx: &'rt mut InterpCx<'mir, 'tcx, M>,\n     leftover_allocations: &'rt mut FxHashSet<AllocId>,\n     alloc_id: AllocId,\n@@ -105,7 +106,7 @@ fn intern_shallow<'rt, 'mir, 'tcx, M: CompileTimeMachine<'mir, 'tcx>>(\n     // changes in this function.\n     match kind {\n         MemoryKind::Stack\n-        | MemoryKind::ConstHeap\n+        | MemoryKind::Machine(const_eval::MemoryKind::Heap)\n         | MemoryKind::Vtable\n         | MemoryKind::CallerLocation => {}\n     }\n@@ -141,7 +142,9 @@ fn intern_shallow<'rt, 'mir, 'tcx, M: CompileTimeMachine<'mir, 'tcx>>(\n     None\n }\n \n-impl<'rt, 'mir, 'tcx, M: CompileTimeMachine<'mir, 'tcx>> InternVisitor<'rt, 'mir, 'tcx, M> {\n+impl<'rt, 'mir, 'tcx, M: CompileTimeMachine<'mir, 'tcx, const_eval::MemoryKind>>\n+    InternVisitor<'rt, 'mir, 'tcx, M>\n+{\n     fn intern_shallow(\n         &mut self,\n         alloc_id: AllocId,\n@@ -152,8 +155,8 @@ impl<'rt, 'mir, 'tcx, M: CompileTimeMachine<'mir, 'tcx>> InternVisitor<'rt, 'mir\n     }\n }\n \n-impl<'rt, 'mir, 'tcx: 'mir, M: CompileTimeMachine<'mir, 'tcx>> ValueVisitor<'mir, 'tcx, M>\n-    for InternVisitor<'rt, 'mir, 'tcx, M>\n+impl<'rt, 'mir, 'tcx: 'mir, M: CompileTimeMachine<'mir, 'tcx, const_eval::MemoryKind>>\n+    ValueVisitor<'mir, 'tcx, M> for InternVisitor<'rt, 'mir, 'tcx, M>\n {\n     type V = MPlaceTy<'tcx>;\n \n@@ -290,7 +293,7 @@ pub enum InternKind {\n /// Any errors here would anyway be turned into `const_err` lints, whereas validation failures\n /// are hard errors.\n #[tracing::instrument(skip(ecx))]\n-pub fn intern_const_alloc_recursive<M: CompileTimeMachine<'mir, 'tcx>>(\n+pub fn intern_const_alloc_recursive<M: CompileTimeMachine<'mir, 'tcx, const_eval::MemoryKind>>(\n     ecx: &mut InterpCx<'mir, 'tcx, M>,\n     intern_kind: InternKind,\n     ret: MPlaceTy<'tcx>,\n@@ -421,7 +424,9 @@ where\n     Ok(())\n }\n \n-impl<'mir, 'tcx: 'mir, M: super::intern::CompileTimeMachine<'mir, 'tcx>> InterpCx<'mir, 'tcx, M> {\n+impl<'mir, 'tcx: 'mir, M: super::intern::CompileTimeMachine<'mir, 'tcx, !>>\n+    InterpCx<'mir, 'tcx, M>\n+{\n     /// A helper function that allocates memory for the layout given and gives you access to mutate\n     /// it. Once your own mutation code is done, the backing `Allocation` is removed from the\n     /// current `Memory` and returned."}, {"sha": "0bba02737722931910c8e5ce2bf5be59ee2cf359", "filename": "compiler/rustc_mir/src/interpret/machine.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/a2aa3d6e49d472b2218d81ec6ef34e2a2e6ad883/compiler%2Frustc_mir%2Fsrc%2Finterpret%2Fmachine.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a2aa3d6e49d472b2218d81ec6ef34e2a2e6ad883/compiler%2Frustc_mir%2Fsrc%2Finterpret%2Fmachine.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Finterpret%2Fmachine.rs?ref=a2aa3d6e49d472b2218d81ec6ef34e2a2e6ad883", "patch": "@@ -366,9 +366,9 @@ pub macro compile_time_machine(<$mir: lifetime, $tcx: lifetime>) {\n     type PointerTag = ();\n     type ExtraFnVal = !;\n \n-    type MemoryKind = !;\n-    type MemoryMap = rustc_data_structures::fx::FxHashMap<AllocId, (MemoryKind<!>, Allocation)>;\n-    const GLOBAL_KIND: Option<!> = None; // no copying of globals from `tcx` to machine memory\n+    type MemoryMap =\n+        rustc_data_structures::fx::FxHashMap<AllocId, (MemoryKind<Self::MemoryKind>, Allocation)>;\n+    const GLOBAL_KIND: Option<Self::MemoryKind> = None; // no copying of globals from `tcx` to machine memory\n \n     type AllocExtra = ();\n     type FrameExtra = ();\n@@ -407,7 +407,7 @@ pub macro compile_time_machine(<$mir: lifetime, $tcx: lifetime>) {\n         _memory_extra: &Self::MemoryExtra,\n         _id: AllocId,\n         alloc: Cow<'b, Allocation>,\n-        _kind: Option<MemoryKind<!>>,\n+        _kind: Option<MemoryKind<Self::MemoryKind>>,\n     ) -> (Cow<'b, Allocation<Self::PointerTag>>, Self::PointerTag) {\n         // We do not use a tag so we can just cheaply forward the allocation\n         (alloc, ())"}, {"sha": "f3e373813ca537c3e40bcccb63b2410f254bcea1", "filename": "compiler/rustc_mir/src/interpret/memory.rs", "status": "modified", "additions": 0, "deletions": 5, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/a2aa3d6e49d472b2218d81ec6ef34e2a2e6ad883/compiler%2Frustc_mir%2Fsrc%2Finterpret%2Fmemory.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a2aa3d6e49d472b2218d81ec6ef34e2a2e6ad883/compiler%2Frustc_mir%2Fsrc%2Finterpret%2Fmemory.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Finterpret%2Fmemory.rs?ref=a2aa3d6e49d472b2218d81ec6ef34e2a2e6ad883", "patch": "@@ -27,9 +27,6 @@ use crate::util::pretty;\n pub enum MemoryKind<T> {\n     /// Stack memory. Error if deallocated except during a stack pop.\n     Stack,\n-    /// Heap memory.\n-    /// FIXME: this variant should be in const_eval\n-    ConstHeap,\n     /// Memory backing vtables. Error if ever deallocated.\n     Vtable,\n     /// Memory allocated by `caller_location` intrinsic. Error if ever deallocated.\n@@ -43,7 +40,6 @@ impl<T: MayLeak> MayLeak for MemoryKind<T> {\n     fn may_leak(self) -> bool {\n         match self {\n             MemoryKind::Stack => false,\n-            MemoryKind::ConstHeap => false,\n             MemoryKind::Vtable => true,\n             MemoryKind::CallerLocation => true,\n             MemoryKind::Machine(k) => k.may_leak(),\n@@ -55,7 +51,6 @@ impl<T: fmt::Display> fmt::Display for MemoryKind<T> {\n     fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {\n         match self {\n             MemoryKind::Stack => write!(f, \"stack variable\"),\n-            MemoryKind::ConstHeap => write!(f, \"heap allocation\"),\n             MemoryKind::Vtable => write!(f, \"vtable\"),\n             MemoryKind::CallerLocation => write!(f, \"caller location\"),\n             MemoryKind::Machine(m) => write!(f, \"{}\", m),"}, {"sha": "1d949e020ed5ced7a7a4bc6f88c249707c18a9cd", "filename": "compiler/rustc_mir/src/transform/const_prop.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a2aa3d6e49d472b2218d81ec6ef34e2a2e6ad883/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fconst_prop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a2aa3d6e49d472b2218d81ec6ef34e2a2e6ad883/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fconst_prop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fconst_prop.rs?ref=a2aa3d6e49d472b2218d81ec6ef34e2a2e6ad883", "patch": "@@ -180,6 +180,8 @@ impl<'mir, 'tcx> ConstPropMachine<'mir, 'tcx> {\n impl<'mir, 'tcx> interpret::Machine<'mir, 'tcx> for ConstPropMachine<'mir, 'tcx> {\n     compile_time_machine!(<'mir, 'tcx>);\n \n+    type MemoryKind = !;\n+\n     type MemoryExtra = ();\n \n     fn find_mir_or_eval_fn("}]}