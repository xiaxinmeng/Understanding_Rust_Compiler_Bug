{"sha": "3df879f139b0a40f400c23cb495eaf776b325047", "node_id": "MDY6Q29tbWl0NzI0NzEyOjNkZjg3OWYxMzliMGE0MGY0MDBjMjNjYjQ5NWVhZjc3NmIzMjUwNDc=", "commit": {"author": {"name": "Benjamin Coenen", "email": "5719034+bnjjj@users.noreply.github.com", "date": "2020-06-21T17:14:08Z"}, "committer": {"name": "Benjamin Coenen", "email": "5719034+bnjjj@users.noreply.github.com", "date": "2020-06-21T17:14:08Z"}, "message": "don't complete top level attrs inside nested attrs and add better labels #4899\n\nSigned-off-by: Benjamin Coenen <5719034+bnjjj@users.noreply.github.com>", "tree": {"sha": "d4b3ee2869b6410b02577087aea915961ea3a05c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d4b3ee2869b6410b02577087aea915961ea3a05c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3df879f139b0a40f400c23cb495eaf776b325047", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3df879f139b0a40f400c23cb495eaf776b325047", "html_url": "https://github.com/rust-lang/rust/commit/3df879f139b0a40f400c23cb495eaf776b325047", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3df879f139b0a40f400c23cb495eaf776b325047/comments", "author": {"login": "bnjjj", "id": 5719034, "node_id": "MDQ6VXNlcjU3MTkwMzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/5719034?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bnjjj", "html_url": "https://github.com/bnjjj", "followers_url": "https://api.github.com/users/bnjjj/followers", "following_url": "https://api.github.com/users/bnjjj/following{/other_user}", "gists_url": "https://api.github.com/users/bnjjj/gists{/gist_id}", "starred_url": "https://api.github.com/users/bnjjj/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bnjjj/subscriptions", "organizations_url": "https://api.github.com/users/bnjjj/orgs", "repos_url": "https://api.github.com/users/bnjjj/repos", "events_url": "https://api.github.com/users/bnjjj/events{/privacy}", "received_events_url": "https://api.github.com/users/bnjjj/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bnjjj", "id": 5719034, "node_id": "MDQ6VXNlcjU3MTkwMzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/5719034?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bnjjj", "html_url": "https://github.com/bnjjj", "followers_url": "https://api.github.com/users/bnjjj/followers", "following_url": "https://api.github.com/users/bnjjj/following{/other_user}", "gists_url": "https://api.github.com/users/bnjjj/gists{/gist_id}", "starred_url": "https://api.github.com/users/bnjjj/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bnjjj/subscriptions", "organizations_url": "https://api.github.com/users/bnjjj/orgs", "repos_url": "https://api.github.com/users/bnjjj/repos", "events_url": "https://api.github.com/users/bnjjj/events{/privacy}", "received_events_url": "https://api.github.com/users/bnjjj/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3f26c5758d7beb1207ed187b71fe9fa6fcaa03ec", "url": "https://api.github.com/repos/rust-lang/rust/commits/3f26c5758d7beb1207ed187b71fe9fa6fcaa03ec", "html_url": "https://github.com/rust-lang/rust/commit/3f26c5758d7beb1207ed187b71fe9fa6fcaa03ec"}], "stats": {"total": 121, "additions": 105, "deletions": 16}, "files": [{"sha": "443b3b87d13f2040a82fa3bc55cee2cf03e0355e", "filename": "crates/ra_ide/src/completion/complete_attribute.rs", "status": "modified", "additions": 105, "deletions": 16, "changes": 121, "blob_url": "https://github.com/rust-lang/rust/blob/3df879f139b0a40f400c23cb495eaf776b325047/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fcomplete_attribute.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3df879f139b0a40f400c23cb495eaf776b325047/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fcomplete_attribute.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fcompletion%2Fcomplete_attribute.rs?ref=3df879f139b0a40f400c23cb495eaf776b325047", "patch": "@@ -42,6 +42,10 @@ fn complete_attribute_start(acc: &mut Completions, ctx: &CompletionContext, attr\n         )\n         .kind(CompletionItemKind::Attribute);\n \n+        if let Some(lookup) = attr_completion.lookup {\n+            item = item.lookup_by(lookup);\n+        }\n+\n         match (attr_completion.snippet, ctx.config.snippet_cap) {\n             (Some(snippet), Some(cap)) => {\n                 item = item.insert_snippet(cap, snippet);\n@@ -57,114 +61,160 @@ fn complete_attribute_start(acc: &mut Completions, ctx: &CompletionContext, attr\n \n struct AttrCompletion {\n     label: &'static str,\n+    lookup: Option<&'static str>,\n     snippet: Option<&'static str>,\n     should_be_inner: bool,\n }\n \n const ATTRIBUTES: &[AttrCompletion] = &[\n     AttrCompletion {\n-        label: \"allow(\u2026)\", snippet: Some(\"allow(${0:lint})\"), should_be_inner: false\n+        label: \"allow(\u2026)\",\n+        snippet: Some(\"allow(${0:lint})\"),\n+        should_be_inner: false,\n+        lookup: Some(\"allow\"),\n     },\n     AttrCompletion {\n         label: \"cfg_attr(\u2026)\",\n         snippet: Some(\"cfg_attr(${1:predicate}, ${0:attr})\"),\n         should_be_inner: false,\n+        lookup: Some(\"cfg_attr\"),\n     },\n     AttrCompletion {\n         label: \"cfg(\u2026)\",\n         snippet: Some(\"cfg(${0:predicate})\"),\n         should_be_inner: false,\n+        lookup: Some(\"cfg\"),\n+    },\n+    AttrCompletion {\n+        label: \"deny(\u2026)\",\n+        snippet: Some(\"deny(${0:lint})\"),\n+        should_be_inner: false,\n+        lookup: Some(\"deny\"),\n     },\n-    AttrCompletion { label: \"deny(\u2026)\", snippet: Some(\"deny(${0:lint})\"), should_be_inner: false },\n     AttrCompletion {\n         label: r#\"deprecated = \"\u2026\"\"#,\n         snippet: Some(r#\"deprecated = \"${0:reason}\"\"#),\n         should_be_inner: false,\n+        lookup: Some(\"deprecated\"),\n     },\n     AttrCompletion {\n         label: \"derive(\u2026)\",\n         snippet: Some(r#\"derive(${0:Debug})\"#),\n         should_be_inner: false,\n+        lookup: Some(\"derive\"),\n     },\n     AttrCompletion {\n         label: r#\"doc = \"\u2026\"\"#,\n         snippet: Some(r#\"doc = \"${0:docs}\"\"#),\n         should_be_inner: false,\n+        lookup: Some(\"doc\"),\n     },\n     AttrCompletion {\n         label: \"feature(\u2026)\",\n         snippet: Some(\"feature(${0:flag})\"),\n         should_be_inner: true,\n+        lookup: Some(\"feature\"),\n     },\n     AttrCompletion {\n         label: \"forbid(\u2026)\",\n         snippet: Some(\"forbid(${0:lint})\"),\n         should_be_inner: false,\n+        lookup: Some(\"forbid\"),\n     },\n     // FIXME: resolve through macro resolution?\n-    AttrCompletion { label: \"global_allocator\", snippet: None, should_be_inner: true },\n+    AttrCompletion {\n+        label: \"global_allocator\",\n+        snippet: None,\n+        should_be_inner: true,\n+        lookup: None,\n+    },\n     AttrCompletion {\n         label: \"ignore(\u2026)\",\n         snippet: Some(\"ignore(${0:lint})\"),\n         should_be_inner: false,\n+        lookup: Some(\"ignore\"),\n     },\n     AttrCompletion {\n         label: \"inline(\u2026)\",\n         snippet: Some(\"inline(${0:lint})\"),\n         should_be_inner: false,\n+        lookup: Some(\"inline\"),\n     },\n     AttrCompletion {\n         label: r#\"link_name = \"\u2026\"\"#,\n         snippet: Some(r#\"link_name = \"${0:symbol_name}\"\"#),\n         should_be_inner: false,\n+        lookup: Some(\"link_name\"),\n     },\n-    AttrCompletion { label: \"link\", snippet: None, should_be_inner: false },\n-    AttrCompletion { label: \"macro_export\", snippet: None, should_be_inner: false },\n-    AttrCompletion { label: \"macro_use\", snippet: None, should_be_inner: false },\n+    AttrCompletion { label: \"link\", snippet: None, should_be_inner: false, lookup: None },\n+    AttrCompletion { label: \"macro_export\", snippet: None, should_be_inner: false, lookup: None },\n+    AttrCompletion { label: \"macro_use\", snippet: None, should_be_inner: false, lookup: None },\n     AttrCompletion {\n         label: r#\"must_use = \"\u2026\"\"#,\n         snippet: Some(r#\"must_use = \"${0:reason}\"\"#),\n         should_be_inner: false,\n+        lookup: Some(\"must_use\"),\n     },\n-    AttrCompletion { label: \"no_mangle\", snippet: None, should_be_inner: false },\n-    AttrCompletion { label: \"no_std\", snippet: None, should_be_inner: true },\n-    AttrCompletion { label: \"non_exhaustive\", snippet: None, should_be_inner: false },\n-    AttrCompletion { label: \"panic_handler\", snippet: None, should_be_inner: true },\n+    AttrCompletion { label: \"no_mangle\", snippet: None, should_be_inner: false, lookup: None },\n+    AttrCompletion { label: \"no_std\", snippet: None, should_be_inner: true, lookup: None },\n+    AttrCompletion { label: \"non_exhaustive\", snippet: None, should_be_inner: false, lookup: None },\n+    AttrCompletion { label: \"panic_handler\", snippet: None, should_be_inner: true, lookup: None },\n     AttrCompletion {\n         label: \"path = \\\"\u2026\\\"\",\n         snippet: Some(\"path =\\\"${0:path}\\\"\"),\n         should_be_inner: false,\n+        lookup: Some(\"path\"),\n+    },\n+    AttrCompletion { label: \"proc_macro\", snippet: None, should_be_inner: false, lookup: None },\n+    AttrCompletion {\n+        label: \"proc_macro_attribute\",\n+        snippet: None,\n+        should_be_inner: false,\n+        lookup: None,\n     },\n-    AttrCompletion { label: \"proc_macro\", snippet: None, should_be_inner: false },\n-    AttrCompletion { label: \"proc_macro_attribute\", snippet: None, should_be_inner: false },\n     AttrCompletion {\n         label: \"proc_macro_derive(\u2026)\",\n         snippet: Some(\"proc_macro_derive(${0:Trait})\"),\n         should_be_inner: false,\n+        lookup: Some(\"proc_macro_derive\"),\n     },\n     AttrCompletion {\n         label: \"recursion_limit = \u2026\",\n         snippet: Some(\"recursion_limit = ${0:128}\"),\n         should_be_inner: true,\n+        lookup: Some(\"recursion_limit\"),\n+    },\n+    AttrCompletion {\n+        label: \"repr(\u2026)\",\n+        snippet: Some(\"repr(${0:C})\"),\n+        should_be_inner: false,\n+        lookup: Some(\"repr\"),\n     },\n-    AttrCompletion { label: \"repr(\u2026)\", snippet: Some(\"repr(${0:C})\"), should_be_inner: false },\n     AttrCompletion {\n         label: \"should_panic(\u2026)\",\n         snippet: Some(r#\"should_panic(expected = \"${0:reason}\")\"#),\n         should_be_inner: false,\n+        lookup: Some(\"should_panic\"),\n     },\n     AttrCompletion {\n         label: r#\"target_feature = \"\u2026\"\"#,\n         snippet: Some(\"target_feature = \\\"${0:feature}\\\"\"),\n         should_be_inner: false,\n+        lookup: Some(\"target_feature\"),\n+    },\n+    AttrCompletion { label: \"test\", snippet: None, should_be_inner: false, lookup: None },\n+    AttrCompletion { label: \"used\", snippet: None, should_be_inner: false, lookup: None },\n+    AttrCompletion {\n+        label: \"warn(\u2026)\",\n+        snippet: Some(\"warn(${0:lint})\"),\n+        should_be_inner: false,\n+        lookup: Some(\"warn\"),\n     },\n-    AttrCompletion { label: \"test\", snippet: None, should_be_inner: false },\n-    AttrCompletion { label: \"used\", snippet: None, should_be_inner: false },\n-    AttrCompletion { label: \"warn(\u2026)\", snippet: Some(\"warn(${0:lint})\"), should_be_inner: false },\n     AttrCompletion {\n         label: r#\"windows_subsystem = \"\u2026\"\"#,\n         snippet: Some(r#\"windows_subsystem = \"${0:subsystem}\"\"#),\n         should_be_inner: true,\n+        lookup: Some(\"windows_subsystem\"),\n     },\n ];\n \n@@ -457,69 +507,79 @@ mod tests {\n                 delete: 19..19,\n                 insert: \"allow(${0:lint})\",\n                 kind: Attribute,\n+                lookup: \"allow\",\n             },\n             CompletionItem {\n                 label: \"cfg(\u2026)\",\n                 source_range: 19..19,\n                 delete: 19..19,\n                 insert: \"cfg(${0:predicate})\",\n                 kind: Attribute,\n+                lookup: \"cfg\",\n             },\n             CompletionItem {\n                 label: \"cfg_attr(\u2026)\",\n                 source_range: 19..19,\n                 delete: 19..19,\n                 insert: \"cfg_attr(${1:predicate}, ${0:attr})\",\n                 kind: Attribute,\n+                lookup: \"cfg_attr\",\n             },\n             CompletionItem {\n                 label: \"deny(\u2026)\",\n                 source_range: 19..19,\n                 delete: 19..19,\n                 insert: \"deny(${0:lint})\",\n                 kind: Attribute,\n+                lookup: \"deny\",\n             },\n             CompletionItem {\n                 label: \"deprecated = \\\"\u2026\\\"\",\n                 source_range: 19..19,\n                 delete: 19..19,\n                 insert: \"deprecated = \\\"${0:reason}\\\"\",\n                 kind: Attribute,\n+                lookup: \"deprecated\",\n             },\n             CompletionItem {\n                 label: \"derive(\u2026)\",\n                 source_range: 19..19,\n                 delete: 19..19,\n                 insert: \"derive(${0:Debug})\",\n                 kind: Attribute,\n+                lookup: \"derive\",\n             },\n             CompletionItem {\n                 label: \"doc = \\\"\u2026\\\"\",\n                 source_range: 19..19,\n                 delete: 19..19,\n                 insert: \"doc = \\\"${0:docs}\\\"\",\n                 kind: Attribute,\n+                lookup: \"doc\",\n             },\n             CompletionItem {\n                 label: \"forbid(\u2026)\",\n                 source_range: 19..19,\n                 delete: 19..19,\n                 insert: \"forbid(${0:lint})\",\n                 kind: Attribute,\n+                lookup: \"forbid\",\n             },\n             CompletionItem {\n                 label: \"ignore(\u2026)\",\n                 source_range: 19..19,\n                 delete: 19..19,\n                 insert: \"ignore(${0:lint})\",\n                 kind: Attribute,\n+                lookup: \"ignore\",\n             },\n             CompletionItem {\n                 label: \"inline(\u2026)\",\n                 source_range: 19..19,\n                 delete: 19..19,\n                 insert: \"inline(${0:lint})\",\n                 kind: Attribute,\n+                lookup: \"inline\",\n             },\n             CompletionItem {\n                 label: \"link\",\n@@ -534,6 +594,7 @@ mod tests {\n                 delete: 19..19,\n                 insert: \"link_name = \\\"${0:symbol_name}\\\"\",\n                 kind: Attribute,\n+                lookup: \"link_name\",\n             },\n             CompletionItem {\n                 label: \"macro_export\",\n@@ -555,6 +616,7 @@ mod tests {\n                 delete: 19..19,\n                 insert: \"must_use = \\\"${0:reason}\\\"\",\n                 kind: Attribute,\n+                lookup: \"must_use\",\n             },\n             CompletionItem {\n                 label: \"no_mangle\",\n@@ -576,6 +638,7 @@ mod tests {\n                 delete: 19..19,\n                 insert: \"path =\\\"${0:path}\\\"\",\n                 kind: Attribute,\n+                lookup: \"path\",\n             },\n             CompletionItem {\n                 label: \"proc_macro\",\n@@ -597,27 +660,31 @@ mod tests {\n                 delete: 19..19,\n                 insert: \"proc_macro_derive(${0:Trait})\",\n                 kind: Attribute,\n+                lookup: \"proc_macro_derive\",\n             },\n             CompletionItem {\n                 label: \"repr(\u2026)\",\n                 source_range: 19..19,\n                 delete: 19..19,\n                 insert: \"repr(${0:C})\",\n                 kind: Attribute,\n+                lookup: \"repr\",\n             },\n             CompletionItem {\n                 label: \"should_panic(\u2026)\",\n                 source_range: 19..19,\n                 delete: 19..19,\n                 insert: \"should_panic(expected = \\\"${0:reason}\\\")\",\n                 kind: Attribute,\n+                lookup: \"should_panic\",\n             },\n             CompletionItem {\n                 label: \"target_feature = \\\"\u2026\\\"\",\n                 source_range: 19..19,\n                 delete: 19..19,\n                 insert: \"target_feature = \\\"${0:feature}\\\"\",\n                 kind: Attribute,\n+                lookup: \"target_feature\",\n             },\n             CompletionItem {\n                 label: \"test\",\n@@ -639,6 +706,7 @@ mod tests {\n                 delete: 19..19,\n                 insert: \"warn(${0:lint})\",\n                 kind: Attribute,\n+                lookup: \"warn\",\n             },\n         ]\n         \"###\n@@ -675,62 +743,71 @@ mod tests {\n                 delete: 20..20,\n                 insert: \"allow(${0:lint})\",\n                 kind: Attribute,\n+                lookup: \"allow\",\n             },\n             CompletionItem {\n                 label: \"cfg(\u2026)\",\n                 source_range: 20..20,\n                 delete: 20..20,\n                 insert: \"cfg(${0:predicate})\",\n                 kind: Attribute,\n+                lookup: \"cfg\",\n             },\n             CompletionItem {\n                 label: \"cfg_attr(\u2026)\",\n                 source_range: 20..20,\n                 delete: 20..20,\n                 insert: \"cfg_attr(${1:predicate}, ${0:attr})\",\n                 kind: Attribute,\n+                lookup: \"cfg_attr\",\n             },\n             CompletionItem {\n                 label: \"deny(\u2026)\",\n                 source_range: 20..20,\n                 delete: 20..20,\n                 insert: \"deny(${0:lint})\",\n                 kind: Attribute,\n+                lookup: \"deny\",\n             },\n             CompletionItem {\n                 label: \"deprecated = \\\"\u2026\\\"\",\n                 source_range: 20..20,\n                 delete: 20..20,\n                 insert: \"deprecated = \\\"${0:reason}\\\"\",\n                 kind: Attribute,\n+                lookup: \"deprecated\",\n             },\n             CompletionItem {\n                 label: \"derive(\u2026)\",\n                 source_range: 20..20,\n                 delete: 20..20,\n                 insert: \"derive(${0:Debug})\",\n                 kind: Attribute,\n+                lookup: \"derive\",\n             },\n             CompletionItem {\n                 label: \"doc = \\\"\u2026\\\"\",\n                 source_range: 20..20,\n                 delete: 20..20,\n                 insert: \"doc = \\\"${0:docs}\\\"\",\n                 kind: Attribute,\n+                lookup: \"doc\",\n             },\n             CompletionItem {\n                 label: \"feature(\u2026)\",\n                 source_range: 20..20,\n                 delete: 20..20,\n                 insert: \"feature(${0:flag})\",\n                 kind: Attribute,\n+                lookup: \"feature\",\n             },\n             CompletionItem {\n                 label: \"forbid(\u2026)\",\n                 source_range: 20..20,\n                 delete: 20..20,\n                 insert: \"forbid(${0:lint})\",\n                 kind: Attribute,\n+                lookup: \"forbid\",\n             },\n             CompletionItem {\n                 label: \"global_allocator\",\n@@ -745,13 +822,15 @@ mod tests {\n                 delete: 20..20,\n                 insert: \"ignore(${0:lint})\",\n                 kind: Attribute,\n+                lookup: \"ignore\",\n             },\n             CompletionItem {\n                 label: \"inline(\u2026)\",\n                 source_range: 20..20,\n                 delete: 20..20,\n                 insert: \"inline(${0:lint})\",\n                 kind: Attribute,\n+                lookup: \"inline\",\n             },\n             CompletionItem {\n                 label: \"link\",\n@@ -766,6 +845,7 @@ mod tests {\n                 delete: 20..20,\n                 insert: \"link_name = \\\"${0:symbol_name}\\\"\",\n                 kind: Attribute,\n+                lookup: \"link_name\",\n             },\n             CompletionItem {\n                 label: \"macro_export\",\n@@ -787,6 +867,7 @@ mod tests {\n                 delete: 20..20,\n                 insert: \"must_use = \\\"${0:reason}\\\"\",\n                 kind: Attribute,\n+                lookup: \"must_use\",\n             },\n             CompletionItem {\n                 label: \"no_mangle\",\n@@ -822,6 +903,7 @@ mod tests {\n                 delete: 20..20,\n                 insert: \"path =\\\"${0:path}\\\"\",\n                 kind: Attribute,\n+                lookup: \"path\",\n             },\n             CompletionItem {\n                 label: \"proc_macro\",\n@@ -843,34 +925,39 @@ mod tests {\n                 delete: 20..20,\n                 insert: \"proc_macro_derive(${0:Trait})\",\n                 kind: Attribute,\n+                lookup: \"proc_macro_derive\",\n             },\n             CompletionItem {\n                 label: \"recursion_limit = \u2026\",\n                 source_range: 20..20,\n                 delete: 20..20,\n                 insert: \"recursion_limit = ${0:128}\",\n                 kind: Attribute,\n+                lookup: \"recursion_limit\",\n             },\n             CompletionItem {\n                 label: \"repr(\u2026)\",\n                 source_range: 20..20,\n                 delete: 20..20,\n                 insert: \"repr(${0:C})\",\n                 kind: Attribute,\n+                lookup: \"repr\",\n             },\n             CompletionItem {\n                 label: \"should_panic(\u2026)\",\n                 source_range: 20..20,\n                 delete: 20..20,\n                 insert: \"should_panic(expected = \\\"${0:reason}\\\")\",\n                 kind: Attribute,\n+                lookup: \"should_panic\",\n             },\n             CompletionItem {\n                 label: \"target_feature = \\\"\u2026\\\"\",\n                 source_range: 20..20,\n                 delete: 20..20,\n                 insert: \"target_feature = \\\"${0:feature}\\\"\",\n                 kind: Attribute,\n+                lookup: \"target_feature\",\n             },\n             CompletionItem {\n                 label: \"test\",\n@@ -892,13 +979,15 @@ mod tests {\n                 delete: 20..20,\n                 insert: \"warn(${0:lint})\",\n                 kind: Attribute,\n+                lookup: \"warn\",\n             },\n             CompletionItem {\n                 label: \"windows_subsystem = \\\"\u2026\\\"\",\n                 source_range: 20..20,\n                 delete: 20..20,\n                 insert: \"windows_subsystem = \\\"${0:subsystem}\\\"\",\n                 kind: Attribute,\n+                lookup: \"windows_subsystem\",\n             },\n         ]\n         \"###"}]}