{"sha": "3557d62ee919dc544d74ba23c8574ead448a40d5", "node_id": "MDY6Q29tbWl0NzI0NzEyOjM1NTdkNjJlZTkxOWRjNTQ0ZDc0YmEyM2M4NTc0ZWFkNDQ4YTQwZDU=", "commit": {"author": {"name": "llogiq", "email": "bogusandre@gmail.com", "date": "2015-06-01T20:52:16Z"}, "committer": {"name": "llogiq", "email": "bogusandre@gmail.com", "date": "2015-06-01T20:52:16Z"}, "message": "Merge pull request #82 from Manishearth/collapsible_if\n\nFixed block check, also added macro test to collapsible_if and \u2026", "tree": {"sha": "c2584249be8099d2cbba5abba499b3e555ebe902", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c2584249be8099d2cbba5abba499b3e555ebe902"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3557d62ee919dc544d74ba23c8574ead448a40d5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3557d62ee919dc544d74ba23c8574ead448a40d5", "html_url": "https://github.com/rust-lang/rust/commit/3557d62ee919dc544d74ba23c8574ead448a40d5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3557d62ee919dc544d74ba23c8574ead448a40d5/comments", "author": {"login": "llogiq", "id": 4200835, "node_id": "MDQ6VXNlcjQyMDA4MzU=", "avatar_url": "https://avatars.githubusercontent.com/u/4200835?v=4", "gravatar_id": "", "url": "https://api.github.com/users/llogiq", "html_url": "https://github.com/llogiq", "followers_url": "https://api.github.com/users/llogiq/followers", "following_url": "https://api.github.com/users/llogiq/following{/other_user}", "gists_url": "https://api.github.com/users/llogiq/gists{/gist_id}", "starred_url": "https://api.github.com/users/llogiq/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/llogiq/subscriptions", "organizations_url": "https://api.github.com/users/llogiq/orgs", "repos_url": "https://api.github.com/users/llogiq/repos", "events_url": "https://api.github.com/users/llogiq/events{/privacy}", "received_events_url": "https://api.github.com/users/llogiq/received_events", "type": "User", "site_admin": false}, "committer": {"login": "llogiq", "id": 4200835, "node_id": "MDQ6VXNlcjQyMDA4MzU=", "avatar_url": "https://avatars.githubusercontent.com/u/4200835?v=4", "gravatar_id": "", "url": "https://api.github.com/users/llogiq", "html_url": "https://github.com/llogiq", "followers_url": "https://api.github.com/users/llogiq/followers", "following_url": "https://api.github.com/users/llogiq/following{/other_user}", "gists_url": "https://api.github.com/users/llogiq/gists{/gist_id}", "starred_url": "https://api.github.com/users/llogiq/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/llogiq/subscriptions", "organizations_url": "https://api.github.com/users/llogiq/orgs", "repos_url": "https://api.github.com/users/llogiq/repos", "events_url": "https://api.github.com/users/llogiq/events{/privacy}", "received_events_url": "https://api.github.com/users/llogiq/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9aec247ff3aaa86ae4278fea590f7695a6928794", "url": "https://api.github.com/repos/rust-lang/rust/commits/9aec247ff3aaa86ae4278fea590f7695a6928794", "html_url": "https://github.com/rust-lang/rust/commit/9aec247ff3aaa86ae4278fea590f7695a6928794"}, {"sha": "e8ca19da244e2dce17c599fd35565f6e47ff19e9", "url": "https://api.github.com/repos/rust-lang/rust/commits/e8ca19da244e2dce17c599fd35565f6e47ff19e9", "html_url": "https://github.com/rust-lang/rust/commit/e8ca19da244e2dce17c599fd35565f6e47ff19e9"}], "stats": {"total": 109, "additions": 67, "deletions": 42}, "files": [{"sha": "5ee8745c33e0db89ea5a1cf5cc30820e84a7add1", "filename": "src/attrs.rs", "status": "modified", "additions": 12, "deletions": 5, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/3557d62ee919dc544d74ba23c8574ead448a40d5/src%2Fattrs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3557d62ee919dc544d74ba23c8574ead448a40d5/src%2Fattrs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fattrs.rs?ref=3557d62ee919dc544d74ba23c8574ead448a40d5", "patch": "@@ -4,8 +4,9 @@ use rustc::plugin::Registry;\n use rustc::lint::*;\n use syntax::ast::*;\n use syntax::ptr::P;\n-use syntax::codemap::Span;\n+use syntax::codemap::{Span, ExpnInfo};\n use syntax::parse::token::InternedString;\n+use utils::in_macro;\n \n declare_lint! { pub INLINE_ALWAYS, Warn,\n     \"#[inline(always)] is usually a bad idea.\"}\n@@ -20,19 +21,25 @@ impl LintPass for AttrPass {\n     }\n     \n     fn check_item(&mut self, cx: &Context, item: &Item) {\n-\t\tcheck_attrs(cx, &item.ident, &item.attrs)\n+\t\tcx.sess().codemap().with_expn_info(item.span.expn_id, \n+\t\t\t|info| check_attrs(cx, info, &item.ident, &item.attrs))\n \t}\n     \n     fn check_impl_item(&mut self, cx: &Context, item: &ImplItem) { \n-\t\tcheck_attrs(cx, &item.ident, &item.attrs)\n+\t\tcx.sess().codemap().with_expn_info(item.span.expn_id, \n+\t\t\t|info| check_attrs(cx, info, &item.ident, &item.attrs))\n \t}\n         \n \tfn check_trait_item(&mut self, cx: &Context, item: &TraitItem) {\n-\t\tcheck_attrs(cx, &item.ident, &item.attrs)\n+\t\tcx.sess().codemap().with_expn_info(item.span.expn_id, \n+\t\t\t|info| check_attrs(cx, info, &item.ident, &item.attrs))\n \t}\n }\n \n-fn check_attrs(cx: &Context, ident: &Ident, attrs: &[Attribute]) {\n+fn check_attrs(cx: &Context, info: Option<&ExpnInfo>, ident: &Ident, \n+\t\tattrs: &[Attribute]) {\n+\tif in_macro(cx, info) { return; }\n+\t\t\t\n \tfor attr in attrs {\n \t\tif let MetaList(ref inline, ref values) = attr.node.value.node {\n \t\t\tif values.len() != 1 || inline != &\"inline\" { continue; }"}, {"sha": "85c1b25a673b9b7b2602cb128793612ac3bd3870", "filename": "src/collapsible_if.rs", "status": "modified", "additions": 34, "deletions": 26, "changes": 60, "blob_url": "https://github.com/rust-lang/rust/blob/3557d62ee919dc544d74ba23c8574ead448a40d5/src%2Fcollapsible_if.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3557d62ee919dc544d74ba23c8574ead448a40d5/src%2Fcollapsible_if.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcollapsible_if.rs?ref=3557d62ee919dc544d74ba23c8574ead448a40d5", "patch": "@@ -17,8 +17,9 @@ use rustc::lint::*;\n use rustc::middle::def::*;\n use syntax::ast::*;\n use syntax::ptr::P;\n-use syntax::codemap::{Span, Spanned};\n+use syntax::codemap::{Span, Spanned, ExpnInfo};\n use syntax::print::pprust::expr_to_string;\n+use utils::in_macro;\n \n declare_lint! {\n     pub COLLAPSIBLE_IF,\n@@ -34,20 +35,23 @@ impl LintPass for CollapsibleIf {\n         lint_array!(COLLAPSIBLE_IF)\n     }\n     \n-    fn check_expr(&mut self, cx: &Context, e: &Expr) {\n-        if let ExprIf(ref check, ref then_block, None) = e.node {\n-            let expr = check_block(then_block);\n-            let expr = match expr {\n-                Some(e) => e,\n-                None => return\n-            };\n-            if let ExprIf(ref check_inner, _, None) = expr.node {\n-                let (check, check_inner) = (check_to_string(check), check_to_string(check_inner));\n-                cx.span_lint(COLLAPSIBLE_IF, e.span,\n-                             &format!(\"This if statement can be collapsed. Try: if {} && {}\", check, check_inner));\n-            }\n-\t\t    }\n-    }\n+\tfn check_expr(&mut self, cx: &Context, expr: &Expr) {\n+\t\tcx.sess().codemap().with_expn_info(expr.span.expn_id, \n+\t\t\t|info| check_expr_expd(cx, expr, info))\n+\t}\n+}\n+\n+fn check_expr_expd(cx: &Context, e: &Expr, info: Option<&ExpnInfo>) {\n+\tif in_macro(cx, info) { return; }\n+\t\n+\tif let ExprIf(ref check, ref then, None) = e.node {\n+\t\tif let Some(&Expr{ node: ExprIf(ref check_inner, _, None), ..}) = \n+\t\t\t\tsingle_stmt_of_block(then) {\n+\t\t\tcx.span_lint(COLLAPSIBLE_IF, e.span, &format!(\n+\t\t\t\t\"This if statement can be collapsed. Try: if {} && {}\\n{:?}\", \n+\t\t\t\tcheck_to_string(check), check_to_string(check_inner), e));\n+\t\t}\n+\t}\n }\n \n fn requires_brackets(e: &Expr) -> bool {\n@@ -65,16 +69,20 @@ fn check_to_string(e: &Expr) -> String {\n     }\n }\n \n-fn check_block(b: &Block) -> Option<&P<Expr>> {\n-    if b.stmts.len() == 1 && b.expr.is_none() {\n-        let stmt = &b.stmts[0];\n-        return match stmt.node {\n-            StmtExpr(ref e, _) => Some(e),\n-            _ => None\n-        };\n-    }\n-    if let Some(ref e) = b.expr {\n-        return Some(e);\n+fn single_stmt_of_block(block: &Block) -> Option<&Expr> {\n+    if block.stmts.len() == 1 && block.expr.is_none() {\n+        if let StmtExpr(ref expr, _) = block.stmts[0].node {\n+            single_stmt_of_expr(expr)\n+        } else { None }\n+    } else {\n+        if block.stmts.is_empty() {\n+            if let Some(ref p) = block.expr { Some(&*p) } else { None }\n+        } else { None }\n     }\n-    None\n+}\n+\n+fn single_stmt_of_expr(expr: &Expr) -> Option<&Expr> {\n+    if let ExprBlock(ref block) = expr.node {\n+        single_stmt_of_block(block)\n+    } else { Some(expr) }\n }"}, {"sha": "06922ef5674808cd8998f5dbbcb574bb956bf174", "filename": "src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/3557d62ee919dc544d74ba23c8574ead448a40d5/src%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3557d62ee919dc544d74ba23c8574ead448a40d5/src%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flib.rs?ref=3557d62ee919dc544d74ba23c8574ead448a40d5", "patch": "@@ -26,6 +26,7 @@ pub mod mut_mut;\n pub mod len_zero;\n pub mod attrs;\n pub mod collapsible_if;\n+pub mod utils;\n \n #[plugin_registrar]\n pub fn plugin_registrar(reg: &mut Registry) {"}, {"sha": "202b5600dbe46008ca67d9404cfc018b769cd15c", "filename": "src/mut_mut.rs", "status": "modified", "additions": 1, "deletions": 10, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/3557d62ee919dc544d74ba23c8574ead448a40d5/src%2Fmut_mut.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3557d62ee919dc544d74ba23c8574ead448a40d5/src%2Fmut_mut.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fmut_mut.rs?ref=3557d62ee919dc544d74ba23c8574ead448a40d5", "patch": "@@ -3,6 +3,7 @@ use syntax::ast::*;\n use rustc::lint::{Context, LintPass, LintArray, Lint};\n use rustc::middle::ty::{expr_ty, sty, ty_ptr, ty_rptr, mt};\n use syntax::codemap::{BytePos, ExpnInfo, MacroFormat, Span};\n+use utils::in_macro;\n \n declare_lint!(pub MUT_MUT, Warn,\n               \"Warn on usage of double-mut refs, e.g. '&mut &mut ...'\");\n@@ -51,16 +52,6 @@ fn check_expr_expd(cx: &Context, expr: &Expr, info: Option<&ExpnInfo>) {\n \t})\n }\n \n-fn in_macro(cx: &Context, opt_info: Option<&ExpnInfo>) -> bool {\n-\topt_info.map_or(false, |info| {\n-\t\tinfo.callee.span.map_or(true, |span| {\n-\t\t\tcx.sess().codemap().span_to_snippet(span).ok().map_or(true, |code| \n-\t\t\t\t!code.starts_with(\"macro_rules\")\n-\t\t\t)\n-\t\t})\n-\t})\n-}\n-\n fn unwrap_mut(ty : &Ty) -> Option<&Ty> {\n \tmatch ty.node {\n \t\tTyPtr(MutTy{ ty: ref pty, mutbl: MutMutable }) => Option::Some(pty),"}, {"sha": "c67ded3d93d9e2dec2651a905f326810b8060eee", "filename": "src/utils.rs", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/3557d62ee919dc544d74ba23c8574ead448a40d5/src%2Futils.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3557d62ee919dc544d74ba23c8574ead448a40d5/src%2Futils.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Futils.rs?ref=3557d62ee919dc544d74ba23c8574ead448a40d5", "patch": "@@ -0,0 +1,12 @@\n+use rustc::lint::Context;\n+use syntax::codemap::ExpnInfo;\n+\n+pub fn in_macro(cx: &Context, opt_info: Option<&ExpnInfo>) -> bool {\n+\topt_info.map_or(false, |info| {\n+\t\tinfo.callee.span.map_or(true, |span| {\n+\t\t\tcx.sess().codemap().span_to_snippet(span).ok().map_or(true, |code| \n+\t\t\t\t!code.starts_with(\"macro_rules\")\n+\t\t\t)\n+\t\t})\n+\t})\n+}"}, {"sha": "7b7ff13f24badea9479aaa8816270b96c1155713", "filename": "tests/compile-fail/collapsible_if.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/3557d62ee919dc544d74ba23c8574ead448a40d5/tests%2Fcompile-fail%2Fcollapsible_if.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3557d62ee919dc544d74ba23c8574ead448a40d5/tests%2Fcompile-fail%2Fcollapsible_if.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Fcollapsible_if.rs?ref=3557d62ee919dc544d74ba23c8574ead448a40d5", "patch": "@@ -34,4 +34,10 @@ fn main() {\n         }\n     }\n \n+\tif x == \"hello\" {\n+\t\tprint!(\"Hello \");\n+\t\tif y == \"world\" {\n+\t\t\tprintln!(\"world!\")\n+\t\t}\n+\t}\n }"}, {"sha": "04f3fc16b1b69e8ca8a7054852ebd3b46fef420e", "filename": "tests/compile-test.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/3557d62ee919dc544d74ba23c8574ead448a40d5/tests%2Fcompile-test.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3557d62ee919dc544d74ba23c8574ead448a40d5/tests%2Fcompile-test.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-test.rs?ref=3557d62ee919dc544d74ba23c8574ead448a40d5", "patch": "@@ -5,7 +5,7 @@ use std::path::PathBuf;\n fn run_mode(mode: &'static str) {\n     let mut config = compiletest::default_config();\n     let cfg_mode = mode.parse().ok().expect(\"Invalid mode\");\n-    config.target_rustcflags = Some(\"-l regex_macros -L target/debug/\".to_string());\n+    config.target_rustcflags = Some(\"-L target/debug/\".to_string());\n \n     config.mode = cfg_mode;\n     config.src_base = PathBuf::from(format!(\"tests/{}\", mode));"}]}