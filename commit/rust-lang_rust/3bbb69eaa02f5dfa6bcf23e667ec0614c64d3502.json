{"sha": "3bbb69eaa02f5dfa6bcf23e667ec0614c64d3502", "node_id": "C_kwDOAAsO6NoAKDNiYmI2OWVhYTAyZjVkZmE2YmNmMjNlNjY3ZWMwNjE0YzY0ZDM1MDI", "commit": {"author": {"name": "Jonas Schievink", "email": "Jonas.Schievink@sony.com", "date": "2023-05-08T14:04:20Z"}, "committer": {"name": "Jonas Schievink", "email": "Jonas.Schievink@sony.com", "date": "2023-05-08T15:06:48Z"}, "message": "Fix miscompilation when adding default method to `Future`", "tree": {"sha": "b82557e0f9f7952388aa7716234d79ef71b83beb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b82557e0f9f7952388aa7716234d79ef71b83beb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3bbb69eaa02f5dfa6bcf23e667ec0614c64d3502", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3bbb69eaa02f5dfa6bcf23e667ec0614c64d3502", "html_url": "https://github.com/rust-lang/rust/commit/3bbb69eaa02f5dfa6bcf23e667ec0614c64d3502", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3bbb69eaa02f5dfa6bcf23e667ec0614c64d3502/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c86e7fb60f5343041fd0c27d4affaf3261115666", "url": "https://api.github.com/repos/rust-lang/rust/commits/c86e7fb60f5343041fd0c27d4affaf3261115666", "html_url": "https://github.com/rust-lang/rust/commit/c86e7fb60f5343041fd0c27d4affaf3261115666"}], "stats": {"total": 25, "additions": 11, "deletions": 14}, "files": [{"sha": "eb3c21163ab2aef6ac4434429ee8c8b80ad34f6c", "filename": "compiler/rustc_ty_utils/src/instance.rs", "status": "modified", "additions": 11, "deletions": 14, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/3bbb69eaa02f5dfa6bcf23e667ec0614c64d3502/compiler%2Frustc_ty_utils%2Fsrc%2Finstance.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3bbb69eaa02f5dfa6bcf23e667ec0614c64d3502/compiler%2Frustc_ty_utils%2Fsrc%2Finstance.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ty_utils%2Fsrc%2Finstance.rs?ref=3bbb69eaa02f5dfa6bcf23e667ec0614c64d3502", "patch": "@@ -194,21 +194,18 @@ fn resolve_associated_item<'tcx>(\n             })\n         }\n         traits::ImplSource::Future(future_data) => {\n-            if cfg!(debug_assertions) && tcx.item_name(trait_item_id) != sym::poll {\n-                // For compiler developers who'd like to add new items to `Future`,\n-                // you either need to generate a shim body, or perhaps return\n-                // `InstanceDef::Item` pointing to a trait default method body if\n-                // it is given a default implementation by the trait.\n-                span_bug!(\n-                    tcx.def_span(future_data.generator_def_id),\n-                    \"no definition for `{trait_ref}::{}` for built-in async generator type\",\n-                    tcx.item_name(trait_item_id)\n-                )\n+            if Some(trait_item_id) == tcx.lang_items().future_poll_fn() {\n+                // `Future::poll` is generated by the compiler.\n+                Some(Instance {\n+                    def: ty::InstanceDef::Item(future_data.generator_def_id),\n+                    substs: future_data.substs,\n+                })\n+            } else {\n+                // All other methods are default methods of the `Future` trait.\n+                // (this assumes that `ImplSource::Future` is only used for methods on `Future`)\n+                debug_assert!(tcx.impl_defaultness(trait_item_id).has_value());\n+                Some(Instance::new(trait_item_id, rcvr_substs))\n             }\n-            Some(Instance {\n-                def: ty::InstanceDef::Item(future_data.generator_def_id),\n-                substs: future_data.substs,\n-            })\n         }\n         traits::ImplSource::Closure(closure_data) => {\n             if cfg!(debug_assertions)"}]}