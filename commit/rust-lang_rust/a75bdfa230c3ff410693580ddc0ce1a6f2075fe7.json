{"sha": "a75bdfa230c3ff410693580ddc0ce1a6f2075fe7", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE3NWJkZmEyMzBjM2ZmNDEwNjkzNTgwZGRjMGNlMWE2ZjIwNzVmZTc=", "commit": {"author": {"name": "Yuki Okushi", "email": "huyuumi.dev@gmail.com", "date": "2020-08-11T07:23:52Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-08-11T07:23:52Z"}, "message": "Rollup merge of #75347 - fusion-engineering-forks:rustdoc-nat-sort, r=GuillaumeGomez\n\nRustdoc: Fix natural ordering to look at all numbers.\n\nThe old implementation only looks at numbers at the end, but not in other places in a name: `u8` and `u16` got sorted properly, but `u8_bla` and `u16_bla` did not.\n\n![image](https://user-images.githubusercontent.com/783247/89740226-28e8b180-da87-11ea-885d-77a7c8a6ba00.png)", "tree": {"sha": "1e30e3f58f3b4d1b66130e2adc9f897f90a8958c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1e30e3f58f3b4d1b66130e2adc9f897f90a8958c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a75bdfa230c3ff410693580ddc0ce1a6f2075fe7", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfMkeICRBK7hj4Ov3rIwAAdHIIABHpqZyS590+G5txqkm/euVv\ngZ1eV4ypZlUFNDwhi9D/bdy55wpOc/5RI4WVL2wssUh7i3yuVOf3iIwR2ON22evW\nJ4i5s3d2Q6YQf2Uw1fr7JsMalxUbpNmn7XzO4/QpkeeoF2NMpqgB06oHOVt9a1z/\nHQ/PHAL4EbEPqdQEBpVHfK6Z2Fjh1kJA3fOWCrZgzBRau8XjEMQf4DOIEzc/oOQR\nRQpoq9zwprp+ri47wY1K6C0Nh3W0JdoIPxRi8vrHb6RKSSRX1T70OL58lqhexs1i\n1d908u7UziYkpctDXFv1yQgetcjrsqwkYRUGg4TC1apCKn8JfOphldKozu8lQug=\n=6t9J\n-----END PGP SIGNATURE-----\n", "payload": "tree 1e30e3f58f3b4d1b66130e2adc9f897f90a8958c\nparent f50f1c79b8e8fd287d5a8679c8604f5b6929c606\nparent 8c705f83dbe1d8daef8ee0735abf8583a66f7732\nauthor Yuki Okushi <huyuumi.dev@gmail.com> 1597130632 +0900\ncommitter GitHub <noreply@github.com> 1597130632 +0900\n\nRollup merge of #75347 - fusion-engineering-forks:rustdoc-nat-sort, r=GuillaumeGomez\n\nRustdoc: Fix natural ordering to look at all numbers.\n\nThe old implementation only looks at numbers at the end, but not in other places in a name: `u8` and `u16` got sorted properly, but `u8_bla` and `u16_bla` did not.\n\n![image](https://user-images.githubusercontent.com/783247/89740226-28e8b180-da87-11ea-885d-77a7c8a6ba00.png)\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a75bdfa230c3ff410693580ddc0ce1a6f2075fe7", "html_url": "https://github.com/rust-lang/rust/commit/a75bdfa230c3ff410693580ddc0ce1a6f2075fe7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a75bdfa230c3ff410693580ddc0ce1a6f2075fe7/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f50f1c79b8e8fd287d5a8679c8604f5b6929c606", "url": "https://api.github.com/repos/rust-lang/rust/commits/f50f1c79b8e8fd287d5a8679c8604f5b6929c606", "html_url": "https://github.com/rust-lang/rust/commit/f50f1c79b8e8fd287d5a8679c8604f5b6929c606"}, {"sha": "8c705f83dbe1d8daef8ee0735abf8583a66f7732", "url": "https://api.github.com/repos/rust-lang/rust/commits/8c705f83dbe1d8daef8ee0735abf8583a66f7732", "html_url": "https://github.com/rust-lang/rust/commit/8c705f83dbe1d8daef8ee0735abf8583a66f7732"}], "stats": {"total": 92, "additions": 63, "deletions": 29}, "files": [{"sha": "363575396928649a963020ac37e5222f2ef68fde", "filename": "src/librustdoc/html/render/mod.rs", "status": "modified", "additions": 36, "deletions": 18, "changes": 54, "blob_url": "https://github.com/rust-lang/rust/blob/a75bdfa230c3ff410693580ddc0ce1a6f2075fe7/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a75bdfa230c3ff410693580ddc0ce1a6f2075fe7/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs?ref=a75bdfa230c3ff410693580ddc0ce1a6f2075fe7", "patch": "@@ -1903,23 +1903,41 @@ fn document_non_exhaustive(w: &mut Buffer, item: &clean::Item) {\n     }\n }\n \n-fn name_key(name: &str) -> (&str, u64, usize) {\n-    let end = name.bytes().rposition(|b| b.is_ascii_digit()).map_or(name.len(), |i| i + 1);\n-\n-    // find number at end\n-    let split = name[0..end].bytes().rposition(|b| !b.is_ascii_digit()).map_or(0, |i| i + 1);\n-\n-    // count leading zeroes\n-    let after_zeroes =\n-        name[split..end].bytes().position(|b| b != b'0').map_or(name.len(), |extra| split + extra);\n-\n-    // sort leading zeroes last\n-    let num_zeroes = after_zeroes - split;\n-\n-    match name[split..end].parse() {\n-        Ok(n) => (&name[..split], n, num_zeroes),\n-        Err(_) => (name, 0, num_zeroes),\n+/// Compare two strings treating multi-digit numbers as single units (i.e. natural sort order).\n+pub fn compare_names(mut lhs: &str, mut rhs: &str) -> Ordering {\n+    /// Takes a non-numeric and a numeric part from the given &str.\n+    fn take_parts<'a>(s: &mut &'a str) -> (&'a str, &'a str) {\n+        let i = s.find(|c: char| c.is_ascii_digit());\n+        let (a, b) = s.split_at(i.unwrap_or(s.len()));\n+        let i = b.find(|c: char| !c.is_ascii_digit());\n+        let (b, c) = b.split_at(i.unwrap_or(b.len()));\n+        *s = c;\n+        (a, b)\n+    }\n+\n+    while !lhs.is_empty() || !rhs.is_empty() {\n+        let (la, lb) = take_parts(&mut lhs);\n+        let (ra, rb) = take_parts(&mut rhs);\n+        // First process the non-numeric part.\n+        match la.cmp(ra) {\n+            Ordering::Equal => (),\n+            x => return x,\n+        }\n+        // Then process the numeric part, if both sides have one (and they fit in a u64).\n+        if let (Ok(ln), Ok(rn)) = (lb.parse::<u64>(), rb.parse::<u64>()) {\n+            match ln.cmp(&rn) {\n+                Ordering::Equal => (),\n+                x => return x,\n+            }\n+        }\n+        // Then process the numeric part again, but this time as strings.\n+        match lb.cmp(rb) {\n+            Ordering::Equal => (),\n+            x => return x,\n+        }\n     }\n+\n+    Ordering::Equal\n }\n \n fn item_module(w: &mut Buffer, cx: &Context, item: &clean::Item, items: &[clean::Item]) {\n@@ -1962,7 +1980,7 @@ fn item_module(w: &mut Buffer, cx: &Context, item: &clean::Item, items: &[clean:\n         }\n         let lhs = i1.name.as_ref().map_or(\"\", |s| &**s);\n         let rhs = i2.name.as_ref().map_or(\"\", |s| &**s);\n-        name_key(lhs).cmp(&name_key(rhs))\n+        compare_names(lhs, rhs)\n     }\n \n     if cx.shared.sort_modules_alphabetically {\n@@ -2395,7 +2413,7 @@ fn compare_impl<'a, 'b>(lhs: &'a &&Impl, rhs: &'b &&Impl) -> Ordering {\n     let rhs = format!(\"{}\", rhs.inner_impl().print());\n \n     // lhs and rhs are formatted as HTML, which may be unnecessary\n-    name_key(&lhs).cmp(&name_key(&rhs))\n+    compare_names(&lhs, &rhs)\n }\n \n fn item_trait(w: &mut Buffer, cx: &Context, it: &clean::Item, t: &clean::Trait, cache: &Cache) {"}, {"sha": "abf5f05fe58ab71e7f553f4a276278efbf6a1088", "filename": "src/librustdoc/html/render/tests.rs", "status": "modified", "additions": 27, "deletions": 11, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/a75bdfa230c3ff410693580ddc0ce1a6f2075fe7/src%2Flibrustdoc%2Fhtml%2Frender%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a75bdfa230c3ff410693580ddc0ce1a6f2075fe7/src%2Flibrustdoc%2Fhtml%2Frender%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Ftests.rs?ref=a75bdfa230c3ff410693580ddc0ce1a6f2075fe7", "patch": "@@ -1,24 +1,40 @@\n use super::*;\n \n #[test]\n-fn test_name_key() {\n-    assert_eq!(name_key(\"0\"), (\"\", 0, 1));\n-    assert_eq!(name_key(\"123\"), (\"\", 123, 0));\n-    assert_eq!(name_key(\"Fruit\"), (\"Fruit\", 0, 0));\n-    assert_eq!(name_key(\"Fruit0\"), (\"Fruit\", 0, 1));\n-    assert_eq!(name_key(\"Fruit0000\"), (\"Fruit\", 0, 4));\n-    assert_eq!(name_key(\"Fruit01\"), (\"Fruit\", 1, 1));\n-    assert_eq!(name_key(\"Fruit10\"), (\"Fruit\", 10, 0));\n-    assert_eq!(name_key(\"Fruit123\"), (\"Fruit\", 123, 0));\n+fn test_compare_names() {\n+    for &(a, b) in &[\n+        (\"hello\", \"world\"),\n+        (\"\", \"world\"),\n+        (\"123\", \"hello\"),\n+        (\"123\", \"\"),\n+        (\"123test\", \"123\"),\n+        (\"hello\", \"\"),\n+        (\"hello\", \"hello\"),\n+        (\"hello123\", \"hello123\"),\n+        (\"hello123\", \"hello12\"),\n+        (\"hello12\", \"hello123\"),\n+        (\"hello01abc\", \"hello01xyz\"),\n+        (\"hello0abc\", \"hello0\"),\n+        (\"hello0\", \"hello0abc\"),\n+        (\"01\", \"1\"),\n+    ] {\n+        assert_eq!(compare_names(a, b), a.cmp(b), \"{:?} - {:?}\", a, b);\n+    }\n+    assert_eq!(compare_names(\"u8\", \"u16\"), Ordering::Less);\n+    assert_eq!(compare_names(\"u32\", \"u16\"), Ordering::Greater);\n+    assert_eq!(compare_names(\"u8_to_f64\", \"u16_to_f64\"), Ordering::Less);\n+    assert_eq!(compare_names(\"u32_to_f64\", \"u16_to_f64\"), Ordering::Greater);\n+    assert_eq!(compare_names(\"u16_to_f64\", \"u16_to_f64\"), Ordering::Equal);\n+    assert_eq!(compare_names(\"u16_to_f32\", \"u16_to_f64\"), Ordering::Less);\n }\n \n #[test]\n fn test_name_sorting() {\n     let names = [\n-        \"Apple\", \"Banana\", \"Fruit\", \"Fruit0\", \"Fruit00\", \"Fruit1\", \"Fruit01\", \"Fruit2\", \"Fruit02\",\n+        \"Apple\", \"Banana\", \"Fruit\", \"Fruit0\", \"Fruit00\", \"Fruit01\", \"Fruit1\", \"Fruit02\", \"Fruit2\",\n         \"Fruit20\", \"Fruit30x\", \"Fruit100\", \"Pear\",\n     ];\n     let mut sorted = names.to_owned();\n-    sorted.sort_by_key(|&s| name_key(s));\n+    sorted.sort_by(|&l, r| compare_names(l, r));\n     assert_eq!(names, sorted);\n }"}]}