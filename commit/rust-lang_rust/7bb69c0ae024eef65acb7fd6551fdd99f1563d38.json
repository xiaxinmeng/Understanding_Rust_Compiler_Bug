{"sha": "7bb69c0ae024eef65acb7fd6551fdd99f1563d38", "node_id": "C_kwDOAAsO6NoAKDdiYjY5YzBhZTAyNGVlZjY1YWNiN2ZkNjU1MWZkZDk5ZjE1NjNkMzg", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-01-31T15:17:38Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-01-31T15:17:38Z"}, "message": "Auto merge of #8369 - Jarcho:ptr_arg_8366, r=flip1995\n\nDon't lint `ptr_arg` for `&mut _` types in trait items\n\nfixes #8366\n\nchangelog: Don't lint `ptr_arg` for `&mut _` types in trait items", "tree": {"sha": "4e43652f959bdcd92d9db71067947bb2bb5b9fba", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4e43652f959bdcd92d9db71067947bb2bb5b9fba"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7bb69c0ae024eef65acb7fd6551fdd99f1563d38", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7bb69c0ae024eef65acb7fd6551fdd99f1563d38", "html_url": "https://github.com/rust-lang/rust/commit/7bb69c0ae024eef65acb7fd6551fdd99f1563d38", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7bb69c0ae024eef65acb7fd6551fdd99f1563d38/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0ed8ca45f4180ad26cc42e6181ec47f86553f91b", "url": "https://api.github.com/repos/rust-lang/rust/commits/0ed8ca45f4180ad26cc42e6181ec47f86553f91b", "html_url": "https://github.com/rust-lang/rust/commit/0ed8ca45f4180ad26cc42e6181ec47f86553f91b"}, {"sha": "66bb7263b50f47878784902b5a208b7b26b74bc1", "url": "https://api.github.com/repos/rust-lang/rust/commits/66bb7263b50f47878784902b5a208b7b26b74bc1", "html_url": "https://github.com/rust-lang/rust/commit/66bb7263b50f47878784902b5a208b7b26b74bc1"}], "stats": {"total": 26, "additions": 20, "deletions": 6}, "files": [{"sha": "77bf5f002f7c90e596fe84e562037405d2b3c2da", "filename": "clippy_lints/src/ptr.rs", "status": "modified", "additions": 14, "deletions": 6, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/7bb69c0ae024eef65acb7fd6551fdd99f1563d38/clippy_lints%2Fsrc%2Fptr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7bb69c0ae024eef65acb7fd6551fdd99f1563d38/clippy_lints%2Fsrc%2Fptr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fptr.rs?ref=7bb69c0ae024eef65acb7fd6551fdd99f1563d38", "patch": "@@ -153,7 +153,9 @@ impl<'tcx> LateLintPass<'tcx> for Ptr {\n                 cx.tcx.fn_sig(item.def_id).skip_binder().inputs(),\n                 sig.decl.inputs,\n                 &[],\n-            ) {\n+            )\n+            .filter(|arg| arg.mutability() == Mutability::Not)\n+            {\n                 span_lint_and_sugg(\n                     cx,\n                     PTR_ARG,\n@@ -170,10 +172,10 @@ impl<'tcx> LateLintPass<'tcx> for Ptr {\n     fn check_body(&mut self, cx: &LateContext<'tcx>, body: &'tcx Body<'_>) {\n         let hir = cx.tcx.hir();\n         let mut parents = hir.parent_iter(body.value.hir_id);\n-        let (item_id, decl) = match parents.next() {\n+        let (item_id, decl, is_trait_item) = match parents.next() {\n             Some((_, Node::Item(i))) => {\n                 if let ItemKind::Fn(sig, ..) = &i.kind {\n-                    (i.def_id, sig.decl)\n+                    (i.def_id, sig.decl, false)\n                 } else {\n                     return;\n                 }\n@@ -185,14 +187,14 @@ impl<'tcx> LateLintPass<'tcx> for Ptr {\n                     return;\n                 }\n                 if let ImplItemKind::Fn(sig, _) = &i.kind {\n-                    (i.def_id, sig.decl)\n+                    (i.def_id, sig.decl, false)\n                 } else {\n                     return;\n                 }\n             },\n             Some((_, Node::TraitItem(i))) => {\n                 if let TraitItemKind::Fn(sig, _) = &i.kind {\n-                    (i.def_id, sig.decl)\n+                    (i.def_id, sig.decl, true)\n                 } else {\n                     return;\n                 }\n@@ -202,7 +204,9 @@ impl<'tcx> LateLintPass<'tcx> for Ptr {\n \n         check_mut_from_ref(cx, decl);\n         let sig = cx.tcx.fn_sig(item_id).skip_binder();\n-        let lint_args: Vec<_> = check_fn_args(cx, sig.inputs(), decl.inputs, body.params).collect();\n+        let lint_args: Vec<_> = check_fn_args(cx, sig.inputs(), decl.inputs, body.params)\n+            .filter(|arg| !is_trait_item || arg.mutability() == Mutability::Not)\n+            .collect();\n         let results = check_ptr_arg_usage(cx, body, &lint_args);\n \n         for (result, args) in results.iter().zip(lint_args.iter()).filter(|(r, _)| !r.skip) {\n@@ -318,6 +322,10 @@ impl PtrArg<'_> {\n             self.deref_ty.argless_str(),\n         )\n     }\n+\n+    fn mutability(&self) -> Mutability {\n+        self.ref_prefix.mutability\n+    }\n }\n \n struct RefPrefix {"}, {"sha": "00b99da2631c630aa1ef6e227e50c4c7f678f027", "filename": "tests/ui/ptr_arg.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/7bb69c0ae024eef65acb7fd6551fdd99f1563d38/tests%2Fui%2Fptr_arg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7bb69c0ae024eef65acb7fd6551fdd99f1563d38/tests%2Fui%2Fptr_arg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fptr_arg.rs?ref=7bb69c0ae024eef65acb7fd6551fdd99f1563d38", "patch": "@@ -180,3 +180,9 @@ fn dyn_fn_requires_vec(v: &Vec<u32>, f: &dyn Fn(&Vec<u32>)) {\n // No error for types behind an alias (#7699)\n type A = Vec<u8>;\n fn aliased(a: &A) {}\n+\n+// Issue #8366\n+pub trait Trait {\n+    fn f(v: &mut Vec<i32>);\n+    fn f2(v: &mut Vec<i32>) {}\n+}"}]}