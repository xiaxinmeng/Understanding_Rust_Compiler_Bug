{"sha": "a35734c172ba95a6d8758c7c5bb6601bcd3a5485", "node_id": "C_kwDOAAsO6NoAKGEzNTczNGMxNzJiYTk1YTZkODc1OGM3YzViYjY2MDFiY2QzYTU0ODU", "commit": {"author": {"name": "kraktus", "email": "kraktus@users.noreply.github.com", "date": "2022-09-16T19:38:56Z"}, "committer": {"name": "kraktus", "email": "kraktus@users.noreply.github.com", "date": "2022-10-02T13:03:48Z"}, "message": "revert `manual_assert` suggestion refactor\n\nBecause `Sugg` helper does not simplify multiple negations", "tree": {"sha": "45806018747cbcfe9e86e7fe33344353066c7c0f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/45806018747cbcfe9e86e7fe33344353066c7c0f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a35734c172ba95a6d8758c7c5bb6601bcd3a5485", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a35734c172ba95a6d8758c7c5bb6601bcd3a5485", "html_url": "https://github.com/rust-lang/rust/commit/a35734c172ba95a6d8758c7c5bb6601bcd3a5485", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a35734c172ba95a6d8758c7c5bb6601bcd3a5485/comments", "author": {"login": "kraktus", "id": 56031107, "node_id": "MDQ6VXNlcjU2MDMxMTA3", "avatar_url": "https://avatars.githubusercontent.com/u/56031107?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kraktus", "html_url": "https://github.com/kraktus", "followers_url": "https://api.github.com/users/kraktus/followers", "following_url": "https://api.github.com/users/kraktus/following{/other_user}", "gists_url": "https://api.github.com/users/kraktus/gists{/gist_id}", "starred_url": "https://api.github.com/users/kraktus/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kraktus/subscriptions", "organizations_url": "https://api.github.com/users/kraktus/orgs", "repos_url": "https://api.github.com/users/kraktus/repos", "events_url": "https://api.github.com/users/kraktus/events{/privacy}", "received_events_url": "https://api.github.com/users/kraktus/received_events", "type": "User", "site_admin": false}, "committer": {"login": "kraktus", "id": 56031107, "node_id": "MDQ6VXNlcjU2MDMxMTA3", "avatar_url": "https://avatars.githubusercontent.com/u/56031107?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kraktus", "html_url": "https://github.com/kraktus", "followers_url": "https://api.github.com/users/kraktus/followers", "following_url": "https://api.github.com/users/kraktus/following{/other_user}", "gists_url": "https://api.github.com/users/kraktus/gists{/gist_id}", "starred_url": "https://api.github.com/users/kraktus/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kraktus/subscriptions", "organizations_url": "https://api.github.com/users/kraktus/orgs", "repos_url": "https://api.github.com/users/kraktus/repos", "events_url": "https://api.github.com/users/kraktus/events{/privacy}", "received_events_url": "https://api.github.com/users/kraktus/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2c04c1a188124402e85d78bc78c4e07bf87014d0", "url": "https://api.github.com/repos/rust-lang/rust/commits/2c04c1a188124402e85d78bc78c4e07bf87014d0", "html_url": "https://github.com/rust-lang/rust/commit/2c04c1a188124402e85d78bc78c4e07bf87014d0"}], "stats": {"total": 27, "additions": 15, "deletions": 12}, "files": [{"sha": "cbc9c4ca6ad04bb842afa4a9ee339ab84febdf4d", "filename": "clippy_lints/src/manual_assert.rs", "status": "modified", "additions": 7, "deletions": 4, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/a35734c172ba95a6d8758c7c5bb6601bcd3a5485/clippy_lints%2Fsrc%2Fmanual_assert.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a35734c172ba95a6d8758c7c5bb6601bcd3a5485/clippy_lints%2Fsrc%2Fmanual_assert.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmanual_assert.rs?ref=a35734c172ba95a6d8758c7c5bb6601bcd3a5485", "patch": "@@ -4,7 +4,7 @@ use clippy_utils::macros::{root_macro_call, FormatArgsExpn};\n use clippy_utils::source::snippet_with_applicability;\n use clippy_utils::{peel_blocks_with_stmt, span_extract_comment, sugg};\n use rustc_errors::Applicability;\n-use rustc_hir::{Expr, ExprKind};\n+use rustc_hir::{Expr, ExprKind, UnOp};\n use rustc_lint::{LateContext, LateLintPass};\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n use rustc_span::sym;\n@@ -55,9 +55,12 @@ impl<'tcx> LateLintPass<'tcx> for ManualAssert {\n                 if !comments.is_empty() {\n                     comments += \"\\n\";\n                 }\n-                // we need to negate the <cond> expression because `assert!` panics when <cond> is `false`, wherease original pattern panicked when evaluating to `true`\n-                let cond_sugg = !sugg::Sugg::hir_with_applicability(cx, cond, \"..\", &mut applicability);\n-                let sugg = format!(\"assert!({cond_sugg}, {format_args_snip});\");\n+                let (cond, not) = match cond.kind {\n+                     ExprKind::Unary(UnOp::Not, e) => (e, \"\"),\n+                     _ => (cond, \"!\"),\n+                 };\n+                let cond_sugg = sugg::Sugg::hir_with_applicability(cx, cond, \"..\", &mut applicability).maybe_par();\n+                let sugg = format!(\"assert!({not}{cond_sugg}, {format_args_snip});\");\n                 // we show to the user the suggestion without the comments, but when applicating the fix, include the comments in the block\n                 span_lint_and_then(\n                     cx,"}, {"sha": "81e38e1bf7959f128a13dc0c1778afd4278666c9", "filename": "tests/ui/manual_assert.edition2018.fixed", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/a35734c172ba95a6d8758c7c5bb6601bcd3a5485/tests%2Fui%2Fmanual_assert.edition2018.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/a35734c172ba95a6d8758c7c5bb6601bcd3a5485/tests%2Fui%2Fmanual_assert.edition2018.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmanual_assert.edition2018.fixed?ref=a35734c172ba95a6d8758c7c5bb6601bcd3a5485", "patch": "@@ -28,8 +28,8 @@ fn main() {\n     {\n         panic!(\"qaqaq{:?}\", a);\n     }\n-    assert!(!(!a.is_empty()), \"qaqaq{:?}\", a);\n-    assert!(!(!a.is_empty()), \"qwqwq\");\n+    assert!(a.is_empty(), \"qaqaq{:?}\", a);\n+    assert!(a.is_empty(), \"qwqwq\");\n     if a.len() == 3 {\n         println!(\"qwq\");\n         println!(\"qwq\");"}, {"sha": "e71bf428382c1ceed65f9c414a2c5ff1d71eb545", "filename": "tests/ui/manual_assert.edition2018.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/a35734c172ba95a6d8758c7c5bb6601bcd3a5485/tests%2Fui%2Fmanual_assert.edition2018.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/a35734c172ba95a6d8758c7c5bb6601bcd3a5485/tests%2Fui%2Fmanual_assert.edition2018.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmanual_assert.edition2018.stderr?ref=a35734c172ba95a6d8758c7c5bb6601bcd3a5485", "patch": "@@ -9,7 +9,7 @@ LL | |     }\n    = note: `-D clippy::manual-assert` implied by `-D warnings`\n help: try instead\n    |\n-LL |     assert!(!(!a.is_empty()), \"qaqaq{:?}\", a);\n+LL |     assert!(a.is_empty(), \"qaqaq{:?}\", a);\n    |\n \n error: only a `panic!` in `if`-then statement\n@@ -22,7 +22,7 @@ LL | |     }\n    |\n help: try instead\n    |\n-LL |     assert!(!(!a.is_empty()), \"qwqwq\");\n+LL |     assert!(a.is_empty(), \"qwqwq\");\n    |\n \n error: only a `panic!` in `if`-then statement"}, {"sha": "81e38e1bf7959f128a13dc0c1778afd4278666c9", "filename": "tests/ui/manual_assert.edition2021.fixed", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/a35734c172ba95a6d8758c7c5bb6601bcd3a5485/tests%2Fui%2Fmanual_assert.edition2021.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/a35734c172ba95a6d8758c7c5bb6601bcd3a5485/tests%2Fui%2Fmanual_assert.edition2021.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmanual_assert.edition2021.fixed?ref=a35734c172ba95a6d8758c7c5bb6601bcd3a5485", "patch": "@@ -28,8 +28,8 @@ fn main() {\n     {\n         panic!(\"qaqaq{:?}\", a);\n     }\n-    assert!(!(!a.is_empty()), \"qaqaq{:?}\", a);\n-    assert!(!(!a.is_empty()), \"qwqwq\");\n+    assert!(a.is_empty(), \"qaqaq{:?}\", a);\n+    assert!(a.is_empty(), \"qwqwq\");\n     if a.len() == 3 {\n         println!(\"qwq\");\n         println!(\"qwq\");"}, {"sha": "e71bf428382c1ceed65f9c414a2c5ff1d71eb545", "filename": "tests/ui/manual_assert.edition2021.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/a35734c172ba95a6d8758c7c5bb6601bcd3a5485/tests%2Fui%2Fmanual_assert.edition2021.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/a35734c172ba95a6d8758c7c5bb6601bcd3a5485/tests%2Fui%2Fmanual_assert.edition2021.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmanual_assert.edition2021.stderr?ref=a35734c172ba95a6d8758c7c5bb6601bcd3a5485", "patch": "@@ -9,7 +9,7 @@ LL | |     }\n    = note: `-D clippy::manual-assert` implied by `-D warnings`\n help: try instead\n    |\n-LL |     assert!(!(!a.is_empty()), \"qaqaq{:?}\", a);\n+LL |     assert!(a.is_empty(), \"qaqaq{:?}\", a);\n    |\n \n error: only a `panic!` in `if`-then statement\n@@ -22,7 +22,7 @@ LL | |     }\n    |\n help: try instead\n    |\n-LL |     assert!(!(!a.is_empty()), \"qwqwq\");\n+LL |     assert!(a.is_empty(), \"qwqwq\");\n    |\n \n error: only a `panic!` in `if`-then statement"}]}