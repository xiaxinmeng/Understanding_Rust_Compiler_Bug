{"sha": "2f84cb34c11b4a6127b687ae6c353f33e3edeee7", "node_id": "C_kwDOAAsO6NoAKDJmODRjYjM0YzExYjRhNjEyN2I2ODdhZTZjMzUzZjMzZTNlZGVlZTc", "commit": {"author": {"name": "Ben Kimock", "email": "kimockb@gmail.com", "date": "2022-07-08T18:48:26Z"}, "committer": {"name": "Ben Kimock", "email": "kimockb@gmail.com", "date": "2022-07-17T20:53:14Z"}, "message": "Pass through isatty if the host is also unix", "tree": {"sha": "3b4dc0965f37f41c3b82016ae0f6599e839c05d0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3b4dc0965f37f41c3b82016ae0f6599e839c05d0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2f84cb34c11b4a6127b687ae6c353f33e3edeee7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2f84cb34c11b4a6127b687ae6c353f33e3edeee7", "html_url": "https://github.com/rust-lang/rust/commit/2f84cb34c11b4a6127b687ae6c353f33e3edeee7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2f84cb34c11b4a6127b687ae6c353f33e3edeee7/comments", "author": {"login": "saethlin", "id": 12105168, "node_id": "MDQ6VXNlcjEyMTA1MTY4", "avatar_url": "https://avatars.githubusercontent.com/u/12105168?v=4", "gravatar_id": "", "url": "https://api.github.com/users/saethlin", "html_url": "https://github.com/saethlin", "followers_url": "https://api.github.com/users/saethlin/followers", "following_url": "https://api.github.com/users/saethlin/following{/other_user}", "gists_url": "https://api.github.com/users/saethlin/gists{/gist_id}", "starred_url": "https://api.github.com/users/saethlin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/saethlin/subscriptions", "organizations_url": "https://api.github.com/users/saethlin/orgs", "repos_url": "https://api.github.com/users/saethlin/repos", "events_url": "https://api.github.com/users/saethlin/events{/privacy}", "received_events_url": "https://api.github.com/users/saethlin/received_events", "type": "User", "site_admin": false}, "committer": {"login": "saethlin", "id": 12105168, "node_id": "MDQ6VXNlcjEyMTA1MTY4", "avatar_url": "https://avatars.githubusercontent.com/u/12105168?v=4", "gravatar_id": "", "url": "https://api.github.com/users/saethlin", "html_url": "https://github.com/saethlin", "followers_url": "https://api.github.com/users/saethlin/followers", "following_url": "https://api.github.com/users/saethlin/following{/other_user}", "gists_url": "https://api.github.com/users/saethlin/gists{/gist_id}", "starred_url": "https://api.github.com/users/saethlin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/saethlin/subscriptions", "organizations_url": "https://api.github.com/users/saethlin/orgs", "repos_url": "https://api.github.com/users/saethlin/repos", "events_url": "https://api.github.com/users/saethlin/events{/privacy}", "received_events_url": "https://api.github.com/users/saethlin/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "86911fd8f610eb59e0f90909323f48229965c06c", "url": "https://api.github.com/repos/rust-lang/rust/commits/86911fd8f610eb59e0f90909323f48229965c06c", "html_url": "https://github.com/rust-lang/rust/commit/86911fd8f610eb59e0f90909323f48229965c06c"}], "stats": {"total": 69, "additions": 63, "deletions": 6}, "files": [{"sha": "57dfd6f1810c2a8f5ccdcb154cd5d53f93d72b43", "filename": "src/shims/unix/foreign_items.rs", "status": "modified", "additions": 2, "deletions": 6, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/2f84cb34c11b4a6127b687ae6c353f33e3edeee7/src%2Fshims%2Funix%2Fforeign_items.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f84cb34c11b4a6127b687ae6c353f33e3edeee7/src%2Fshims%2Funix%2Fforeign_items.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fshims%2Funix%2Fforeign_items.rs?ref=2f84cb34c11b4a6127b687ae6c353f33e3edeee7", "patch": "@@ -440,12 +440,8 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n             // Miscellaneous\n             \"isatty\" => {\n                 let [fd] = this.check_shim(abi, Abi::C { unwind: false }, link_name, args)?;\n-                this.read_scalar(fd)?.to_i32()?;\n-                // \"returns 1 if fd is an open file descriptor referring to a terminal; otherwise 0 is returned, and errno is set to indicate the error\"\n-                // FIXME: we just say nothing is a terminal.\n-                let enotty = this.eval_libc(\"ENOTTY\")?;\n-                this.set_last_error(enotty)?;\n-                this.write_null(dest)?;\n+                let result = this.isatty(fd)?;\n+                this.write_scalar(Scalar::from_i32(result), dest)?;\n             }\n             \"pthread_atfork\" => {\n                 let [prepare, parent, child] = this.check_shim(abi, Abi::C { unwind: false }, link_name, args)?;"}, {"sha": "3fdf82ebc6a743427013f973df3b68adaf8a607f", "filename": "src/shims/unix/fs.rs", "status": "modified", "additions": 61, "deletions": 0, "changes": 61, "blob_url": "https://github.com/rust-lang/rust/blob/2f84cb34c11b4a6127b687ae6c353f33e3edeee7/src%2Fshims%2Funix%2Ffs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f84cb34c11b4a6127b687ae6c353f33e3edeee7/src%2Fshims%2Funix%2Ffs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fshims%2Funix%2Ffs.rs?ref=2f84cb34c11b4a6127b687ae6c353f33e3edeee7", "patch": "@@ -50,6 +50,9 @@ trait FileDescriptor: std::fmt::Debug {\n     ) -> InterpResult<'tcx, io::Result<i32>>;\n \n     fn dup(&mut self) -> io::Result<Box<dyn FileDescriptor>>;\n+\n+    #[cfg(unix)]\n+    fn as_unix_host_fd(&self) -> Option<i32>;\n }\n \n impl FileDescriptor for FileHandle {\n@@ -114,6 +117,12 @@ impl FileDescriptor for FileHandle {\n         let duplicated = self.file.try_clone()?;\n         Ok(Box::new(FileHandle { file: duplicated, writable: self.writable }))\n     }\n+\n+    #[cfg(unix)]\n+    fn as_unix_host_fd(&self) -> Option<i32> {\n+        use std::os::unix::io::AsRawFd;\n+        Some(self.file.as_raw_fd())\n+    }\n }\n \n impl FileDescriptor for io::Stdin {\n@@ -159,6 +168,11 @@ impl FileDescriptor for io::Stdin {\n     fn dup(&mut self) -> io::Result<Box<dyn FileDescriptor>> {\n         Ok(Box::new(io::stdin()))\n     }\n+\n+    #[cfg(unix)]\n+    fn as_unix_host_fd(&self) -> Option<i32> {\n+        Some(libc::STDIN_FILENO)\n+    }\n }\n \n impl FileDescriptor for io::Stdout {\n@@ -209,6 +223,11 @@ impl FileDescriptor for io::Stdout {\n     fn dup(&mut self) -> io::Result<Box<dyn FileDescriptor>> {\n         Ok(Box::new(io::stdout()))\n     }\n+\n+    #[cfg(unix)]\n+    fn as_unix_host_fd(&self) -> Option<i32> {\n+        Some(libc::STDOUT_FILENO)\n+    }\n }\n \n impl FileDescriptor for io::Stderr {\n@@ -252,6 +271,11 @@ impl FileDescriptor for io::Stderr {\n     fn dup(&mut self) -> io::Result<Box<dyn FileDescriptor>> {\n         Ok(Box::new(io::stderr()))\n     }\n+\n+    #[cfg(unix)]\n+    fn as_unix_host_fd(&self) -> Option<i32> {\n+        Some(libc::STDERR_FILENO)\n+    }\n }\n \n #[derive(Debug)]\n@@ -297,6 +321,11 @@ impl FileDescriptor for DummyOutput {\n     fn dup<'tcx>(&mut self) -> io::Result<Box<dyn FileDescriptor>> {\n         Ok(Box::new(DummyOutput))\n     }\n+\n+    #[cfg(unix)]\n+    fn as_unix_host_fd(&self) -> Option<i32> {\n+        None\n+    }\n }\n \n #[derive(Debug)]\n@@ -1660,6 +1689,38 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n             }\n         }\n     }\n+\n+    #[cfg_attr(not(unix), allow(unused))]\n+    fn isatty(&mut self, miri_fd: &OpTy<'tcx, Tag>) -> InterpResult<'tcx, i32> {\n+        let this = self.eval_context_mut();\n+        #[cfg(unix)]\n+        {\n+            let miri_fd = this.read_scalar(miri_fd)?.to_i32()?;\n+            if let Some(host_fd) =\n+                this.machine.file_handler.handles.get(&miri_fd).and_then(|fd| fd.as_unix_host_fd())\n+            {\n+                // \"returns 1 if fd is an open file descriptor referring to a terminal;\n+                // otherwise 0 is returned, and errno is set to indicate the error\"\n+                // SAFETY: isatty has no preconditions\n+                let is_tty = unsafe { libc::isatty(host_fd) };\n+                if is_tty == 0 {\n+                    let errno = std::io::Error::last_os_error()\n+                        .raw_os_error()\n+                        .map(Scalar::from_i32)\n+                        .unwrap();\n+                    this.set_last_error(errno)?;\n+                }\n+                return Ok(is_tty);\n+            }\n+        }\n+        // We are attemping to use a Unix interface on a non-Unix platform, or we are on a Unix\n+        // platform and the passed file descriptor is not open.\n+        // FIXME: It should be possible to emulate this at least on Windows by using\n+        // GetConsoleMode.\n+        let enotty = this.eval_libc(\"ENOTTY\")?;\n+        this.set_last_error(enotty)?;\n+        Ok(0)\n+    }\n }\n \n /// Extracts the number of seconds and nanoseconds elapsed between `time` and the unix epoch when"}]}