{"sha": "971aa2bd6218fb6c843db965f7da70586865171d", "node_id": "MDY6Q29tbWl0NzI0NzEyOjk3MWFhMmJkNjIxOGZiNmM4NDNkYjk2NWY3ZGE3MDU4Njg2NTE3MWQ=", "commit": {"author": {"name": "Michael Woerister", "email": "michaelwoerister@posteo", "date": "2020-01-03T09:40:15Z"}, "committer": {"name": "Michael Woerister", "email": "michaelwoerister@posteo", "date": "2020-01-03T09:40:15Z"}, "message": "Attempt to fix intermittent failures of pgo-branch-weights test.", "tree": {"sha": "47442cc7d043a0823cb3084869dd18ebb2af42a7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/47442cc7d043a0823cb3084869dd18ebb2af42a7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/971aa2bd6218fb6c843db965f7da70586865171d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/971aa2bd6218fb6c843db965f7da70586865171d", "html_url": "https://github.com/rust-lang/rust/commit/971aa2bd6218fb6c843db965f7da70586865171d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/971aa2bd6218fb6c843db965f7da70586865171d/comments", "author": {"login": "michaelwoerister", "id": 1825894, "node_id": "MDQ6VXNlcjE4MjU4OTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1825894?v=4", "gravatar_id": "", "url": "https://api.github.com/users/michaelwoerister", "html_url": "https://github.com/michaelwoerister", "followers_url": "https://api.github.com/users/michaelwoerister/followers", "following_url": "https://api.github.com/users/michaelwoerister/following{/other_user}", "gists_url": "https://api.github.com/users/michaelwoerister/gists{/gist_id}", "starred_url": "https://api.github.com/users/michaelwoerister/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/michaelwoerister/subscriptions", "organizations_url": "https://api.github.com/users/michaelwoerister/orgs", "repos_url": "https://api.github.com/users/michaelwoerister/repos", "events_url": "https://api.github.com/users/michaelwoerister/events{/privacy}", "received_events_url": "https://api.github.com/users/michaelwoerister/received_events", "type": "User", "site_admin": false}, "committer": {"login": "michaelwoerister", "id": 1825894, "node_id": "MDQ6VXNlcjE4MjU4OTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1825894?v=4", "gravatar_id": "", "url": "https://api.github.com/users/michaelwoerister", "html_url": "https://github.com/michaelwoerister", "followers_url": "https://api.github.com/users/michaelwoerister/followers", "following_url": "https://api.github.com/users/michaelwoerister/following{/other_user}", "gists_url": "https://api.github.com/users/michaelwoerister/gists{/gist_id}", "starred_url": "https://api.github.com/users/michaelwoerister/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/michaelwoerister/subscriptions", "organizations_url": "https://api.github.com/users/michaelwoerister/orgs", "repos_url": "https://api.github.com/users/michaelwoerister/repos", "events_url": "https://api.github.com/users/michaelwoerister/events{/privacy}", "received_events_url": "https://api.github.com/users/michaelwoerister/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0a58f5864659ddfe1d95c122abaa75c88220aed0", "url": "https://api.github.com/repos/rust-lang/rust/commits/0a58f5864659ddfe1d95c122abaa75c88220aed0", "html_url": "https://github.com/rust-lang/rust/commit/0a58f5864659ddfe1d95c122abaa75c88220aed0"}], "stats": {"total": 30, "additions": 19, "deletions": 11}, "files": [{"sha": "c13297b3a61410fa1f1890ed385d0a8d72b99b04", "filename": "src/test/run-make-fulldeps/pgo-branch-weights/Makefile", "status": "modified", "additions": 19, "deletions": 11, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/971aa2bd6218fb6c843db965f7da70586865171d/src%2Ftest%2Frun-make-fulldeps%2Fpgo-branch-weights%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/971aa2bd6218fb6c843db965f7da70586865171d/src%2Ftest%2Frun-make-fulldeps%2Fpgo-branch-weights%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fpgo-branch-weights%2FMakefile?ref=971aa2bd6218fb6c843db965f7da70586865171d", "patch": "@@ -15,21 +15,29 @@ ifdef IS_MSVC\n COMMON_FLAGS=-Cpanic=abort\n endif\n \n+# For some very small programs GNU ld seems to not properly handle\n+# instrumentation sections correctly. Neither Gold nor LLD have that problem.\n+ifeq ($(UNAME),Linux)\n+ifneq (,$(findstring x86,$(TARGET)))\n+COMMON_FLAGS=-Clink-args=-fuse-ld=gold\n+endif\n+endif\n+\n+\n all:\n \t# We don't compile `opaque` with either optimizations or instrumentation.\n-\t# We don't compile `opaque` with either optimizations or instrumentation.\n-\t$(RUSTC) $(COMMON_FLAGS) opaque.rs\n+\t$(RUSTC) $(COMMON_FLAGS) opaque.rs || exit 1\n \t# Compile the test program with instrumentation\n-\tmkdir -p \"$(TMPDIR)\"/prof_data_dir\n+\tmkdir -p \"$(TMPDIR)/prof_data_dir\" || exit 1\n \t$(RUSTC) $(COMMON_FLAGS) interesting.rs \\\n-\t\t-Cprofile-generate=\"$(TMPDIR)\"/prof_data_dir -O -Ccodegen-units=1\n-\t$(RUSTC) $(COMMON_FLAGS) main.rs -Cprofile-generate=\"$(TMPDIR)\"/prof_data_dir -O\n+\t\t-Cprofile-generate=\"$(TMPDIR)/prof_data_dir\" -O -Ccodegen-units=1 || exit 1\n+\t$(RUSTC) $(COMMON_FLAGS) main.rs -Cprofile-generate=\"$(TMPDIR)/prof_data_dir\" -O || exit 1\n \t# The argument below generates to the expected branch weights\n \t$(call RUN,main aaaaaaaaaaaa2bbbbbbbbbbbb2bbbbbbbbbbbbbbbbcc) || exit 1\n-\t\"$(LLVM_BIN_DIR)\"/llvm-profdata merge \\\n-\t\t-o \"$(TMPDIR)\"/prof_data_dir/merged.profdata \\\n-\t\t\"$(TMPDIR)\"/prof_data_dir\n+\t\"$(LLVM_BIN_DIR)/llvm-profdata\" merge \\\n+\t\t-o \"$(TMPDIR)/prof_data_dir/merged.profdata\" \\\n+\t\t\"$(TMPDIR)/prof_data_dir\" || exit 1\n \t$(RUSTC) $(COMMON_FLAGS) interesting.rs \\\n-\t\t-Cprofile-use=\"$(TMPDIR)\"/prof_data_dir/merged.profdata -O \\\n-\t\t-Ccodegen-units=1 --emit=llvm-ir\n-\tcat \"$(TMPDIR)\"/interesting.ll | \"$(LLVM_FILECHECK)\" filecheck-patterns.txt\n+\t\t-Cprofile-use=\"$(TMPDIR)/prof_data_dir/merged.profdata\" -O \\\n+\t\t-Ccodegen-units=1 --emit=llvm-ir || exit 1\n+\tcat \"$(TMPDIR)/interesting.ll\" | \"$(LLVM_FILECHECK)\" filecheck-patterns.txt"}]}