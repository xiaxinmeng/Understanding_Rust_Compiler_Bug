{"sha": "0d018a57556d5031601721b2386767f8566243e8", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBkMDE4YTU3NTU2ZDUwMzE2MDE3MjFiMjM4Njc2N2Y4NTY2MjQzZTg=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2020-03-20T15:02:46Z"}, "committer": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2020-03-20T16:39:29Z"}, "message": "expand_include: set `.directory` to dir of included file.", "tree": {"sha": "44354fdf2526f43f8a1d0f64e532f33249184c95", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/44354fdf2526f43f8a1d0f64e532f33249184c95"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0d018a57556d5031601721b2386767f8566243e8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0d018a57556d5031601721b2386767f8566243e8", "html_url": "https://github.com/rust-lang/rust/commit/0d018a57556d5031601721b2386767f8566243e8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0d018a57556d5031601721b2386767f8566243e8/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f4c675c476c18b1a11041193f2f59d695b126bc8", "url": "https://api.github.com/repos/rust-lang/rust/commits/f4c675c476c18b1a11041193f2f59d695b126bc8", "html_url": "https://github.com/rust-lang/rust/commit/f4c675c476c18b1a11041193f2f59d695b126bc8"}], "stats": {"total": 26, "additions": 25, "deletions": 1}, "files": [{"sha": "718498f04b94ed56fbc63665559eb8cddb3a0367", "filename": "src/librustc_builtin_macros/source_util.rs", "status": "modified", "additions": 12, "deletions": 1, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/0d018a57556d5031601721b2386767f8566243e8/src%2Flibrustc_builtin_macros%2Fsource_util.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0d018a57556d5031601721b2386767f8566243e8/src%2Flibrustc_builtin_macros%2Fsource_util.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_builtin_macros%2Fsource_util.rs?ref=0d018a57556d5031601721b2386767f8566243e8", "patch": "@@ -4,13 +4,15 @@ use rustc_ast::token;\n use rustc_ast::tokenstream::TokenStream;\n use rustc_ast_pretty::pprust;\n use rustc_expand::base::{self, *};\n+use rustc_expand::module::DirectoryOwnership;\n use rustc_expand::panictry;\n use rustc_parse::{self, new_sub_parser_from_file, parser::Parser};\n use rustc_session::lint::builtin::INCOMPLETE_INCLUDE;\n use rustc_span::symbol::Symbol;\n use rustc_span::{self, Pos, Span};\n \n use smallvec::SmallVec;\n+use std::rc::Rc;\n \n use rustc_data_structures::sync::Lrc;\n \n@@ -101,7 +103,7 @@ pub fn expand_include<'cx>(\n         None => return DummyResult::any(sp),\n     };\n     // The file will be added to the code map by the parser\n-    let file = match cx.resolve_path(file, sp) {\n+    let mut file = match cx.resolve_path(file, sp) {\n         Ok(f) => f,\n         Err(mut err) => {\n             err.emit();\n@@ -110,6 +112,15 @@ pub fn expand_include<'cx>(\n     };\n     let p = new_sub_parser_from_file(cx.parse_sess(), &file, None, sp);\n \n+    // If in the included file we have e.g., `mod bar;`,\n+    // then the path of `bar.rs` should be relative to the directory of `file`.\n+    // See https://github.com/rust-lang/rust/pull/69838/files#r395217057 for a discussion.\n+    // `MacroExpander::fully_expand_fragment` later restores, so \"stack discipline\" is maintained.\n+    file.pop();\n+    cx.current_expansion.directory_ownership = DirectoryOwnership::Owned { relative: None };\n+    let mod_path = cx.current_expansion.module.mod_path.clone();\n+    cx.current_expansion.module = Rc::new(ModuleData { mod_path, directory: file });\n+\n     struct ExpandResult<'a> {\n         p: Parser<'a>,\n     }"}, {"sha": "ec12f8c5cb442ee72def5fa4e2e4a593d5f2795a", "filename": "src/test/ui/macros/issue-69838-dir/bar.rs", "status": "added", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/0d018a57556d5031601721b2386767f8566243e8/src%2Ftest%2Fui%2Fmacros%2Fissue-69838-dir%2Fbar.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0d018a57556d5031601721b2386767f8566243e8/src%2Ftest%2Fui%2Fmacros%2Fissue-69838-dir%2Fbar.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmacros%2Fissue-69838-dir%2Fbar.rs?ref=0d018a57556d5031601721b2386767f8566243e8", "patch": "@@ -0,0 +1,3 @@\n+// ignore-test -- this is an auxiliary file as part of another test.\n+\n+pub fn i_am_in_bar() {}"}, {"sha": "9900b8fd5092cfdd36ccc3cf931e5ea520d3eec7", "filename": "src/test/ui/macros/issue-69838-dir/included.rs", "status": "added", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/0d018a57556d5031601721b2386767f8566243e8/src%2Ftest%2Fui%2Fmacros%2Fissue-69838-dir%2Fincluded.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0d018a57556d5031601721b2386767f8566243e8/src%2Ftest%2Fui%2Fmacros%2Fissue-69838-dir%2Fincluded.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmacros%2Fissue-69838-dir%2Fincluded.rs?ref=0d018a57556d5031601721b2386767f8566243e8", "patch": "@@ -0,0 +1,3 @@\n+// ignore-test -- this is an auxiliary file as part of another test.\n+\n+pub mod bar;"}, {"sha": "2a4e97f0ef5f18c084e55e69468bd4cb845025bd", "filename": "src/test/ui/macros/issue-69838-mods-relative-to-included-path.rs", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/0d018a57556d5031601721b2386767f8566243e8/src%2Ftest%2Fui%2Fmacros%2Fissue-69838-mods-relative-to-included-path.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0d018a57556d5031601721b2386767f8566243e8/src%2Ftest%2Fui%2Fmacros%2Fissue-69838-mods-relative-to-included-path.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmacros%2Fissue-69838-mods-relative-to-included-path.rs?ref=0d018a57556d5031601721b2386767f8566243e8", "patch": "@@ -0,0 +1,7 @@\n+// check-pass\n+\n+include!(\"issue-69838-dir/included.rs\");\n+\n+fn main() {\n+    bar::i_am_in_bar();\n+}"}]}