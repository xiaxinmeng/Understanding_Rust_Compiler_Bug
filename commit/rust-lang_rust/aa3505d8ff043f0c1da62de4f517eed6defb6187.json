{"sha": "aa3505d8ff043f0c1da62de4f517eed6defb6187", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFhMzUwNWQ4ZmYwNDNmMGMxZGE2MmRlNGY1MTdlZWQ2ZGVmYjYxODc=", "commit": {"author": {"name": "Erick Tryzelaar", "email": "erick.tryzelaar@gmail.com", "date": "2013-03-02T04:35:55Z"}, "committer": {"name": "Erick Tryzelaar", "email": "erick.tryzelaar@gmail.com", "date": "2013-03-02T04:35:55Z"}, "message": "Merge remote-tracking branch 'remotes/origin/incoming' into incoming", "tree": {"sha": "d0f82e2e5dd7b3dfeeb8b593ed0d76393e41ff05", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d0f82e2e5dd7b3dfeeb8b593ed0d76393e41ff05"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/aa3505d8ff043f0c1da62de4f517eed6defb6187", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/aa3505d8ff043f0c1da62de4f517eed6defb6187", "html_url": "https://github.com/rust-lang/rust/commit/aa3505d8ff043f0c1da62de4f517eed6defb6187", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/aa3505d8ff043f0c1da62de4f517eed6defb6187/comments", "author": {"login": "erickt", "id": 84711, "node_id": "MDQ6VXNlcjg0NzEx", "avatar_url": "https://avatars.githubusercontent.com/u/84711?v=4", "gravatar_id": "", "url": "https://api.github.com/users/erickt", "html_url": "https://github.com/erickt", "followers_url": "https://api.github.com/users/erickt/followers", "following_url": "https://api.github.com/users/erickt/following{/other_user}", "gists_url": "https://api.github.com/users/erickt/gists{/gist_id}", "starred_url": "https://api.github.com/users/erickt/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/erickt/subscriptions", "organizations_url": "https://api.github.com/users/erickt/orgs", "repos_url": "https://api.github.com/users/erickt/repos", "events_url": "https://api.github.com/users/erickt/events{/privacy}", "received_events_url": "https://api.github.com/users/erickt/received_events", "type": "User", "site_admin": false}, "committer": {"login": "erickt", "id": 84711, "node_id": "MDQ6VXNlcjg0NzEx", "avatar_url": "https://avatars.githubusercontent.com/u/84711?v=4", "gravatar_id": "", "url": "https://api.github.com/users/erickt", "html_url": "https://github.com/erickt", "followers_url": "https://api.github.com/users/erickt/followers", "following_url": "https://api.github.com/users/erickt/following{/other_user}", "gists_url": "https://api.github.com/users/erickt/gists{/gist_id}", "starred_url": "https://api.github.com/users/erickt/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/erickt/subscriptions", "organizations_url": "https://api.github.com/users/erickt/orgs", "repos_url": "https://api.github.com/users/erickt/repos", "events_url": "https://api.github.com/users/erickt/events{/privacy}", "received_events_url": "https://api.github.com/users/erickt/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "85fecd0ba77066e604cec9d3866b76edc626b5d3", "url": "https://api.github.com/repos/rust-lang/rust/commits/85fecd0ba77066e604cec9d3866b76edc626b5d3", "html_url": "https://github.com/rust-lang/rust/commit/85fecd0ba77066e604cec9d3866b76edc626b5d3"}, {"sha": "0fd1b58f236b4fe653d164836e94feebb2972931", "url": "https://api.github.com/repos/rust-lang/rust/commits/0fd1b58f236b4fe653d164836e94feebb2972931", "html_url": "https://github.com/rust-lang/rust/commit/0fd1b58f236b4fe653d164836e94feebb2972931"}], "stats": {"total": 536, "additions": 370, "deletions": 166}, "files": [{"sha": "238207f12b63e9516df30ffaea15b693e662bff7", "filename": "src/libcore/comm.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibcore%2Fcomm.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibcore%2Fcomm.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fcomm.rs?ref=aa3505d8ff043f0c1da62de4f517eed6defb6187", "patch": "@@ -17,8 +17,8 @@ use vec;\n \n use pipes::{recv, try_recv, wait_many, peek, PacketHeader};\n \n-// NOTE Making this public exposes some plumbing from pipes. Needs\n-// some refactoring\n+// FIXME #5160: Making this public exposes some plumbing from\n+// pipes. Needs some refactoring\n pub use pipes::Selectable;\n \n /// A trait for things that can send multiple messages."}, {"sha": "3e514ce249ffb8b277e762085da0a85a6c6af9e5", "filename": "src/libcore/core.rc", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibcore%2Fcore.rc", "raw_url": "https://github.com/rust-lang/rust/raw/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibcore%2Fcore.rc", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fcore.rc?ref=aa3505d8ff043f0c1da62de4f517eed6defb6187", "patch": "@@ -1,4 +1,4 @@\n-// Copyright 2012 The Rust Project Developers. See the COPYRIGHT\n+// Copyright 2012-2013 The Rust Project Developers. See the COPYRIGHT\n // file at the top-level directory of this distribution and at\n // http://rust-lang.org/COPYRIGHT.\n //\n@@ -41,7 +41,7 @@ Implicitly, all crates behave as if they included the following prologue:\n        url = \"https://github.com/mozilla/rust/tree/master/src/libcore\")];\n \n #[comment = \"The Rust core library\"];\n-#[license = \"MIT\"];\n+#[license = \"MIT/ASL2\"];\n #[crate_type = \"lib\"];\n \n "}, {"sha": "50fc1b03ccc2e9f6d6571643c12bdff34187a8b0", "filename": "src/libcore/num/strconv.rs", "status": "modified", "additions": 3, "deletions": 4, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibcore%2Fnum%2Fstrconv.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibcore%2Fnum%2Fstrconv.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fnum%2Fstrconv.rs?ref=aa3505d8ff043f0c1da62de4f517eed6defb6187", "patch": "@@ -478,17 +478,16 @@ pub pure fn from_str_bytes_common<T:NumCast+Zero+One+Ord+Copy+Div<T,T>+\n         }\n     }\n \n-    // XXX: Bytevector constant from str\n     if special {\n-        if buf == str::to_bytes(\"inf\") || buf == str::to_bytes(\"+inf\") {\n+        if buf == str::inf_buf || buf == str::positive_inf_buf {\n             return NumStrConv::inf();\n-        } else if buf == str::to_bytes(\"-inf\") {\n+        } else if buf == str::negative_inf_buf {\n             if negative {\n                 return NumStrConv::neg_inf();\n             } else {\n                 return None;\n             }\n-        } else if buf == str::to_bytes(\"NaN\") {\n+        } else if buf == str::nan_buf {\n             return NumStrConv::NaN();\n         }\n     }"}, {"sha": "7dfc52c458aedcd17b738bd8cd17edddbad7e4f1", "filename": "src/libcore/str.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibcore%2Fstr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibcore%2Fstr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fstr.rs?ref=aa3505d8ff043f0c1da62de4f517eed6defb6187", "patch": "@@ -1832,6 +1832,13 @@ const tag_five_b: uint = 248u;\n const max_five_b: uint = 67108864u;\n const tag_six_b: uint = 252u;\n \n+// Constants used for converting strs to floats\n+pub const inf_buf: [u8*3] = ['i' as u8, 'n' as u8, 'f' as u8];\n+pub const positive_inf_buf: [u8*4] = ['+' as u8, 'i' as u8,\n+                                      'n' as u8, 'f' as u8];\n+pub const negative_inf_buf: [u8*4] = ['-' as u8, 'i' as u8,\n+                                      'n' as u8, 'f' as u8];\n+pub const nan_buf: [u8*3] = ['N' as u8, 'a' as u8, 'N' as u8];\n \n /**\n  * Work with the byte buffer of a string."}, {"sha": "c16a7cf8d3ebed4ad6bcbf7f39ba4cf5c77f5ac4", "filename": "src/libfuzzer/fuzzer.rc", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibfuzzer%2Ffuzzer.rc", "raw_url": "https://github.com/rust-lang/rust/raw/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibfuzzer%2Ffuzzer.rc", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibfuzzer%2Ffuzzer.rc?ref=aa3505d8ff043f0c1da62de4f517eed6defb6187", "patch": "@@ -1,4 +1,4 @@\n-// Copyright 2012 The Rust Project Developers. See the COPYRIGHT\n+// Copyright 2012-2013 The Rust Project Developers. See the COPYRIGHT\n // file at the top-level directory of this distribution and at\n // http://rust-lang.org/COPYRIGHT.\n //\n@@ -15,7 +15,7 @@\n        url = \"https://github.com/mozilla/rust/tree/master/src/libfuzzer\")];\n \n #[comment = \"The Rust fuzzer library\"];\n-#[license = \"MIT\"];\n+#[license = \"MIT/ASL2\"];\n #[crate_type = \"lib\"];\n #[no_core];\n "}, {"sha": "e60f2bfaa5018f49c38439fbfb493b2c6be2a3e1", "filename": "src/librust/rust.rc", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibrust%2Frust.rc", "raw_url": "https://github.com/rust-lang/rust/raw/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibrust%2Frust.rc", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrust%2Frust.rc?ref=aa3505d8ff043f0c1da62de4f517eed6defb6187", "patch": "@@ -17,6 +17,7 @@\n        uuid = \"4a24da33-5cc8-4037-9352-2cbe9bd9d27c\",\n        url = \"https://github.com/mozilla/rust/tree/master/src/rust\")];\n \n+#[license = \"MIT/ASL2\"];\n #[crate_type = \"lib\"];\n \n extern mod core(vers = \"0.6\");"}, {"sha": "d5cb2f8726d1786a2d81d7014d75781940280a98", "filename": "src/librustc/middle/astencode.rs", "status": "modified", "additions": 11, "deletions": 3, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibrustc%2Fmiddle%2Fastencode.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibrustc%2Fmiddle%2Fastencode.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fastencode.rs?ref=aa3505d8ff043f0c1da62de4f517eed6defb6187", "patch": "@@ -451,9 +451,17 @@ impl tr for ast::def {\n \n impl tr for ty::AutoAdjustment {\n     fn tr(&self, xcx: @ExtendedDecodeContext) -> ty::AutoAdjustment {\n-        ty::AutoAdjustment {\n-            autoderefs: self.autoderefs,\n-            autoref: self.autoref.map(|ar| ar.tr(xcx)),\n+        match self {\n+            &ty::AutoAddEnv(r, s) => {\n+                ty::AutoAddEnv(r.tr(xcx), s)\n+            }\n+\n+            &ty::AutoDerefRef(ref adr) => {\n+                ty::AutoDerefRef(ty::AutoDerefRef {\n+                    autoderefs: adr.autoderefs,\n+                    autoref: adr.autoref.map(|ar| ar.tr(xcx)),\n+                })\n+            }\n         }\n     }\n }"}, {"sha": "ab343456ef463efc4d04c457eb95622099bdeb3e", "filename": "src/librustc/middle/borrowck/gather_loans.rs", "status": "modified", "additions": 14, "deletions": 4, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibrustc%2Fmiddle%2Fborrowck%2Fgather_loans.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibrustc%2Fmiddle%2Fborrowck%2Fgather_loans.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fborrowck%2Fgather_loans.rs?ref=aa3505d8ff043f0c1da62de4f517eed6defb6187", "patch": "@@ -299,17 +299,27 @@ pub impl GatherLoanCtxt {\n                expr_repr(self.tcx(), expr), adjustment);\n         let _i = indenter();\n \n-        match adjustment.autoref {\n-            None => {\n+        match *adjustment {\n+            ty::AutoAddEnv(*) => {\n+                debug!(\"autoaddenv -- no autoref\");\n+                return;\n+            }\n+\n+            ty::AutoDerefRef(\n+                ty::AutoDerefRef {\n+                    autoref: None, _ }) => {\n                 debug!(\"no autoref\");\n                 return;\n             }\n \n-            Some(ref autoref) => {\n+            ty::AutoDerefRef(\n+                ty::AutoDerefRef {\n+                    autoref: Some(ref autoref),\n+                    autoderefs: autoderefs}) => {\n                 let mcx = &mem_categorization_ctxt {\n                     tcx: self.tcx(),\n                     method_map: self.bccx.method_map};\n-                let mut cmt = mcx.cat_expr_autoderefd(expr, adjustment);\n+                let mut cmt = mcx.cat_expr_autoderefd(expr, autoderefs);\n                 debug!(\"after autoderef, cmt=%s\", self.bccx.cmt_to_repr(cmt));\n \n                 match autoref.kind {"}, {"sha": "e0f3aad4bc25ec16ed80b90326873d9c9d19f024", "filename": "src/librustc/middle/borrowck/mod.rs", "status": "modified", "additions": 14, "deletions": 3, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibrustc%2Fmiddle%2Fborrowck%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibrustc%2Fmiddle%2Fborrowck%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fborrowck%2Fmod.rs?ref=aa3505d8ff043f0c1da62de4f517eed6defb6187", "patch": "@@ -480,9 +480,20 @@ pub impl BorrowckCtxt {\n     }\n \n     fn cat_expr_autoderefd(&self, expr: @ast::expr,\n-                           adj: @ty::AutoAdjustment)\n-                        -> cmt {\n-        cat_expr_autoderefd(self.tcx, self.method_map, expr, adj)\n+                           adj: @ty::AutoAdjustment) -> cmt {\n+        match *adj {\n+            ty::AutoAddEnv(*) => {\n+                // no autoderefs\n+                cat_expr_unadjusted(self.tcx, self.method_map, expr)\n+            }\n+\n+            ty::AutoDerefRef(\n+                ty::AutoDerefRef {\n+                    autoderefs: autoderefs, _}) => {\n+                cat_expr_autoderefd(self.tcx, self.method_map, expr,\n+                                    autoderefs)\n+            }\n+        }\n     }\n \n     fn cat_def(&self,"}, {"sha": "7a6a434c41fdddb40fff3571305ed5589f9b5dc7", "filename": "src/librustc/middle/mem_categorization.rs", "status": "modified", "additions": 28, "deletions": 18, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibrustc%2Fmiddle%2Fmem_categorization.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibrustc%2Fmiddle%2Fmem_categorization.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fmem_categorization.rs?ref=aa3505d8ff043f0c1da62de4f517eed6defb6187", "patch": "@@ -241,12 +241,12 @@ pub fn cat_expr_autoderefd(\n     tcx: ty::ctxt,\n     method_map: typeck::method_map,\n     expr: @ast::expr,\n-    adj: @ty::AutoAdjustment) -> cmt {\n-\n+    autoderefs: uint) -> cmt\n+{\n     let mcx = &mem_categorization_ctxt {\n         tcx: tcx, method_map: method_map\n     };\n-    return mcx.cat_expr_autoderefd(expr, adj);\n+    return mcx.cat_expr_autoderefd(expr, autoderefs);\n }\n \n pub fn cat_def(\n@@ -361,28 +361,38 @@ pub impl mem_categorization_ctxt {\n                 self.cat_expr_unadjusted(expr)\n             }\n \n-            Some(adjustment) => {\n-                match adjustment.autoref {\n-                    Some(_) => {\n-                        // Equivalent to &*expr or something similar.\n-                        // This is an rvalue, effectively.\n-                        let expr_ty = ty::expr_ty(self.tcx, expr);\n-                        self.cat_rvalue(expr, expr_ty)\n-                    }\n-                    None => {\n-                        // Equivalent to *expr or something similar.\n-                        self.cat_expr_autoderefd(expr, adjustment)\n-                    }\n-                }\n+            Some(@ty::AutoAddEnv(*)) => {\n+                // Convert a bare fn to a closure by adding NULL env.\n+                // Result is an rvalue.\n+                let expr_ty = ty::expr_ty_adjusted(self.tcx, expr);\n+                self.cat_rvalue(expr, expr_ty)\n+            }\n+\n+            Some(\n+                @ty::AutoDerefRef(\n+                    ty::AutoDerefRef {\n+                        autoref: Some(_), _})) => {\n+                // Equivalent to &*expr or something similar.\n+                // Result is an rvalue.\n+                let expr_ty = ty::expr_ty_adjusted(self.tcx, expr);\n+                self.cat_rvalue(expr, expr_ty)\n+            }\n+\n+            Some(\n+                @ty::AutoDerefRef(\n+                    ty::AutoDerefRef {\n+                        autoref: None, autoderefs: autoderefs})) => {\n+                // Equivalent to *expr or something similar.\n+                self.cat_expr_autoderefd(expr, autoderefs)\n             }\n         }\n     }\n \n     fn cat_expr_autoderefd(&self,\n                            expr: @ast::expr,\n-                           adjustment: &ty::AutoAdjustment) -> cmt {\n+                           autoderefs: uint) -> cmt {\n         let mut cmt = self.cat_expr_unadjusted(expr);\n-        for uint::range(1, adjustment.autoderefs+1) |deref| {\n+        for uint::range(1, autoderefs+1) |deref| {\n             cmt = self.cat_deref(expr, cmt, deref);\n         }\n         return cmt;"}, {"sha": "b9f35af37e01c93bd20fec16a19123abbed3a0fa", "filename": "src/librustc/middle/moves.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibrustc%2Fmiddle%2Fmoves.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibrustc%2Fmiddle%2Fmoves.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fmoves.rs?ref=aa3505d8ff043f0c1da62de4f517eed6defb6187", "patch": "@@ -410,7 +410,9 @@ pub impl VisitContext {\n         // those adjustments is to take a reference, then it's only\n         // reading the underlying expression, not moving it.\n         let comp_mode = match self.tcx.adjustments.find(&expr.id) {\n-            Some(adj) if adj.autoref.is_some() => Read,\n+            Some(@ty::AutoDerefRef(\n+                ty::AutoDerefRef {\n+                    autoref: Some(_), _})) => Read,\n             _ => expr_mode.component_mode(expr)\n         };\n "}, {"sha": "12864f12abd99d71a2db5bd0be0bdad7f819f559", "filename": "src/librustc/middle/trans/callee.rs", "status": "modified", "additions": 23, "deletions": 6, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcallee.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcallee.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcallee.rs?ref=aa3505d8ff043f0c1da62de4f517eed6defb6187", "patch": "@@ -39,6 +39,7 @@ use middle::trans::inline;\n use middle::trans::meth;\n use middle::trans::monomorphize;\n use middle::trans::type_of;\n+use middle::ty::ty_to_str;\n use middle::ty;\n use middle::typeck;\n use util::common::indenter;\n@@ -94,10 +95,25 @@ pub fn trans(bcx: block, expr: @ast::expr) -> Callee {\n     }\n \n     // any other expressions are closures:\n-    return closure_callee(&expr::trans_to_datum(bcx, expr));\n-\n-    fn closure_callee(db: &DatumBlock) -> Callee {\n-        return Callee {bcx: db.bcx, data: Closure(db.datum)};\n+    return datum_callee(bcx, expr);\n+\n+    fn datum_callee(bcx: block, expr: @ast::expr) -> Callee {\n+        let DatumBlock {bcx, datum} = expr::trans_to_datum(bcx, expr);\n+        match ty::get(datum.ty).sty {\n+            ty::ty_bare_fn(*) => {\n+                let llval = datum.to_appropriate_llval(bcx);\n+                return Callee {bcx: bcx, data: Fn(FnData {llfn: llval})};\n+            }\n+            ty::ty_closure(*) => {\n+                return Callee {bcx: bcx, data: Closure(datum)};\n+            }\n+            _ => {\n+                bcx.tcx().sess.span_bug(\n+                    expr.span,\n+                    fmt!(\"Type of callee is neither bare-fn nor closure: %s\",\n+                         bcx.ty_to_str(datum.ty)));\n+            }\n+        }\n     }\n \n     fn fn_callee(bcx: block, fd: FnData) -> Callee {\n@@ -129,7 +145,7 @@ pub fn trans(bcx: block, expr: @ast::expr) -> Callee {\n             ast::def_binding(*) |\n             ast::def_upvar(*) |\n             ast::def_self(*) => {\n-                closure_callee(&expr::trans_to_datum(bcx, ref_expr))\n+                datum_callee(bcx, ref_expr)\n             }\n             ast::def_mod(*) | ast::def_foreign_mod(*) |\n             ast::def_const(*) | ast::def_ty(*) | ast::def_prim_ty(*) |\n@@ -392,7 +408,6 @@ pub fn trans_lang_call_with_type_params(bcx: block,\n                                                     fty);\n                     let mut llfnty = type_of::type_of(callee.bcx.ccx(),\n                                                       substituted);\n-                    llfnty = lib::llvm::struct_tys(llfnty)[0];\n                     new_llval = PointerCast(callee.bcx, fn_data.llfn, llfnty);\n                 }\n                 _ => fail!()\n@@ -715,6 +730,8 @@ pub fn trans_arg_expr(bcx: block,\n                     }\n \n                     ast::by_copy => {\n+                        debug!(\"by copy arg with type %s, storing to scratch\",\n+                               bcx.ty_to_str(arg_datum.ty));\n                         let scratch = scratch_datum(bcx, arg_datum.ty, false);\n \n                         arg_datum.store_to_datum(bcx, arg_expr.id,"}, {"sha": "c2a7abe747bbcd8d432db576cb56eaf79e6a6f8f", "filename": "src/librustc/middle/trans/common.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcommon.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcommon.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcommon.rs?ref=aa3505d8ff043f0c1da62de4f517eed6defb6187", "patch": "@@ -1344,6 +1344,12 @@ pub fn expr_ty(bcx: block, ex: @ast::expr) -> ty::t {\n     node_id_type(bcx, ex.id)\n }\n \n+pub fn expr_ty_adjusted(bcx: block, ex: @ast::expr) -> ty::t {\n+    let tcx = bcx.tcx();\n+    let t = ty::expr_ty_adjusted(tcx, ex);\n+    monomorphize_type(bcx, t)\n+}\n+\n pub fn node_id_type_params(bcx: block, id: ast::node_id) -> ~[ty::t] {\n     let tcx = bcx.tcx();\n     let params = ty::node_id_to_type_params(tcx, id);"}, {"sha": "7fe2bd605e9ff182c1d3a1b4c61af6310259eeaa", "filename": "src/librustc/middle/trans/expr.rs", "status": "modified", "additions": 94, "deletions": 43, "changes": 137, "blob_url": "https://github.com/rust-lang/rust/blob/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibrustc%2Fmiddle%2Ftrans%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibrustc%2Fmiddle%2Ftrans%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fexpr.rs?ref=aa3505d8ff043f0c1da62de4f517eed6defb6187", "patch": "@@ -144,7 +144,8 @@ use middle::trans::tvec;\n use middle::trans::type_of;\n use middle::ty;\n use middle::ty::struct_mutable_fields;\n-use middle::ty::{AutoPtr, AutoBorrowVec, AutoBorrowVecRef, AutoBorrowFn};\n+use middle::ty::{AutoPtr, AutoBorrowVec, AutoBorrowVecRef, AutoBorrowFn,\n+                 AutoDerefRef, AutoAddEnv};\n use util::common::indenter;\n use util::ppaux::ty_to_str;\n \n@@ -197,7 +198,14 @@ pub fn trans_to_datum(bcx: block, expr: @ast::expr) -> DatumBlock {\n         None => {\n             trans_to_datum_unadjusted(bcx, expr)\n         }\n-        Some(adj) => {\n+        Some(@AutoAddEnv(*)) => {\n+            let mut bcx = bcx;\n+            let mut datum = unpack_datum!(bcx, {\n+                trans_to_datum_unadjusted(bcx, expr)\n+            });\n+            add_env(bcx, expr, datum)\n+        }\n+        Some(@AutoDerefRef(ref adj)) => {\n             let mut bcx = bcx;\n             let mut datum = unpack_datum!(bcx, {\n                 trans_to_datum_unadjusted(bcx, expr)\n@@ -266,6 +274,25 @@ pub fn trans_to_datum(bcx: block, expr: @ast::expr) -> DatumBlock {\n         DatumBlock {bcx: bcx, datum: scratch}\n     }\n \n+    fn add_env(bcx: block, expr: @ast::expr, datum: Datum) -> DatumBlock {\n+        // This is not the most efficient thing possible; since closures\n+        // are two words it'd be better if this were compiled in\n+        // 'dest' mode, but I can't find a nice way to structure the\n+        // code and keep it DRY that accommodates that use case at the\n+        // moment.\n+\n+        let tcx = bcx.tcx();\n+        let closure_ty = expr_ty_adjusted(bcx, expr);\n+        debug!(\"add_env(closure_ty=%s)\", ty_to_str(tcx, closure_ty));\n+        let scratch = scratch_datum(bcx, closure_ty, false);\n+        let llfn = GEPi(bcx, scratch.val, [0u, abi::fn_field_code]);\n+        assert datum.appropriate_mode() == ByValue;\n+        Store(bcx, datum.to_appropriate_llval(bcx), llfn);\n+        let llenv = GEPi(bcx, scratch.val, [0u, abi::fn_field_box]);\n+        Store(bcx, base::null_env_ptr(bcx), llenv);\n+        DatumBlock {bcx: bcx, datum: scratch}\n+    }\n+\n     fn auto_slice_and_ref(bcx: block, datum: Datum) -> DatumBlock {\n         let DatumBlock { bcx, datum } = auto_slice(bcx, datum);\n         auto_ref(bcx, datum)\n@@ -420,6 +447,9 @@ fn trans_rvalue_datum_unadjusted(bcx: block, expr: @ast::expr) -> DatumBlock {\n     trace_span!(bcx, expr.span, @shorten(bcx.expr_to_str(expr)));\n \n     match expr.node {\n+        ast::expr_path(_) => {\n+            return trans_def_datum_unadjusted(bcx, expr, bcx.def(expr.id));\n+        }\n         ast::expr_vstore(contents, ast::expr_vstore_box) |\n         ast::expr_vstore(contents, ast::expr_vstore_mut_box) => {\n             return tvec::trans_uniq_or_managed_vstore(bcx, heap_managed,\n@@ -685,22 +715,13 @@ fn trans_def_dps_unadjusted(bcx: block, ref_expr: @ast::expr,\n     };\n \n     match def {\n-        ast::def_fn(did, _) | ast::def_static_method(did, None, _) => {\n-            let fn_data = callee::trans_fn_ref(bcx, did, ref_expr.id);\n-            return fn_data_to_datum(bcx, did, fn_data, lldest);\n-        }\n-        ast::def_static_method(impl_did, Some(trait_did), _) => {\n-            let fn_data = meth::trans_static_method_callee(bcx, impl_did,\n-                                                           trait_did,\n-                                                           ref_expr.id);\n-            return fn_data_to_datum(bcx, impl_did, fn_data, lldest);\n-        }\n         ast::def_variant(tid, vid) => {\n             let variant_info = ty::enum_variant_with_id(ccx.tcx, tid, vid);\n             if variant_info.args.len() > 0u {\n                 // N-ary variant.\n                 let fn_data = callee::trans_fn_ref(bcx, vid, ref_expr.id);\n-                return fn_data_to_datum(bcx, vid, fn_data, lldest);\n+                Store(bcx, fn_data.llfn, lldest);\n+                return bcx;\n             } else if !ty::enum_is_univariant(ccx.tcx, tid) {\n                 // Nullary variant.\n                 let lldiscrimptr = GEPi(bcx, lldest, [0u, 0u]);\n@@ -725,6 +746,66 @@ fn trans_def_dps_unadjusted(bcx: block, ref_expr: @ast::expr,\n     }\n }\n \n+fn trans_def_datum_unadjusted(bcx: block,\n+                              ref_expr: @ast::expr,\n+                              def: ast::def) -> DatumBlock\n+{\n+    let _icx = bcx.insn_ctxt(\"trans_def_datum_unadjusted\");\n+\n+    match def {\n+        ast::def_fn(did, _) | ast::def_static_method(did, None, _) => {\n+            let fn_data = callee::trans_fn_ref(bcx, did, ref_expr.id);\n+            return fn_data_to_datum(bcx, ref_expr, did, fn_data);\n+        }\n+        ast::def_static_method(impl_did, Some(trait_did), _) => {\n+            let fn_data = meth::trans_static_method_callee(bcx, impl_did,\n+                                                           trait_did,\n+                                                           ref_expr.id);\n+            return fn_data_to_datum(bcx, ref_expr, impl_did, fn_data);\n+        }\n+        _ => {\n+            bcx.tcx().sess.span_bug(ref_expr.span, fmt!(\n+                \"Non-DPS def %? referened by %s\",\n+                def, bcx.node_id_to_str(ref_expr.id)));\n+        }\n+    }\n+\n+    fn fn_data_to_datum(bcx: block,\n+                        ref_expr: @ast::expr,\n+                        def_id: ast::def_id,\n+                        fn_data: callee::FnData) -> DatumBlock {\n+        /*!\n+        *\n+        * Translates a reference to a top-level fn item into a rust\n+        * value.  This is just a fn pointer.\n+        */\n+\n+        let is_extern = {\n+            let fn_tpt = ty::lookup_item_type(bcx.tcx(), def_id);\n+            ty::ty_fn_purity(fn_tpt.ty) == ast::extern_fn\n+        };\n+        let (rust_ty, llval) = if is_extern {\n+            let rust_ty = ty::mk_ptr(\n+                bcx.tcx(),\n+                ty::mt {\n+                    ty: ty::mk_mach_uint(bcx.tcx(), ast::ty_u8),\n+                    mutbl: ast::m_imm\n+                }); // *u8\n+            (rust_ty, PointerCast(bcx, fn_data.llfn, T_ptr(T_i8())))\n+        } else {\n+            let fn_ty = expr_ty(bcx, ref_expr);\n+            (fn_ty, fn_data.llfn)\n+        };\n+        return DatumBlock {\n+            bcx: bcx,\n+            datum: Datum {val: llval,\n+                          ty: rust_ty,\n+                          mode: ByValue,\n+                          source: RevokeClean}\n+        };\n+    }\n+}\n+\n fn trans_lvalue_unadjusted(bcx: block, expr: @ast::expr) -> DatumBlock {\n     /*!\n      *\n@@ -1012,36 +1093,6 @@ pub fn trans_local_var(bcx: block, def: ast::def) -> Datum {\n     }\n }\n \n-fn fn_data_to_datum(bcx: block,\n-                    def_id: ast::def_id,\n-                    fn_data: callee::FnData,\n-                    lldest: ValueRef) -> block {\n-    //!\n-    //\n-    // Translates a reference to a top-level fn item into a rust\n-    // value.  This is generally a Rust closure pair: (fn ptr, env)\n-    // where the environment is NULL.  However, extern functions for\n-    // interfacing with C are represted as just the fn ptr with type\n-    // *u8.\n-    //\n-    // Strictly speaking, references to extern fns ought to be\n-    // RvalueDatumExprs, but it's not worth the complexity to avoid the\n-    // extra stack slot that LLVM probably optimizes away anyhow.\n-\n-    let fn_tpt = ty::lookup_item_type(bcx.tcx(), def_id);\n-    if ty::ty_fn_purity(fn_tpt.ty) == ast::extern_fn {\n-        let val = PointerCast(bcx, fn_data.llfn, T_ptr(T_i8()));\n-        Store(bcx, val, lldest);\n-        return bcx;\n-    }\n-\n-    let llfn = GEPi(bcx, lldest, [0u, abi::fn_field_code]);\n-    Store(bcx, fn_data.llfn, llfn);\n-    let llenv = GEPi(bcx, lldest, [0u, abi::fn_field_box]);\n-    Store(bcx, base::null_env_ptr(bcx), llenv);\n-    return bcx;\n-}\n-\n // The optional node ID here is the node ID of the path identifying the enum\n // variant in use. If none, this cannot possibly an enum variant (so, if it\n // is and `node_id_opt` is none, this function fails)."}, {"sha": "fdb5e94559f9cdab4f18bc186ad6453ebd66cb99", "filename": "src/librustc/middle/trans/type_of.rs", "status": "modified", "additions": 5, "deletions": 6, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibrustc%2Fmiddle%2Ftrans%2Ftype_of.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibrustc%2Fmiddle%2Ftrans%2Ftype_of.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Ftype_of.rs?ref=aa3505d8ff043f0c1da62de4f517eed6defb6187", "patch": "@@ -134,8 +134,7 @@ pub fn sizing_type_of(cx: @CrateContext, t: ty::t) -> TypeRef {\n             T_struct(~[T_ptr(T_i8()), T_ptr(T_i8())])\n         }\n \n-        // FIXME(#4804) Bare fn repr\n-        ty::ty_bare_fn(*) => T_struct(~[T_ptr(T_i8()), T_ptr(T_i8())]),\n+        ty::ty_bare_fn(*) => T_ptr(T_i8()),\n         ty::ty_closure(*) => T_struct(~[T_ptr(T_i8()), T_ptr(T_i8())]),\n         ty::ty_trait(_, _, vstore) => T_opaque_trait(cx, vstore),\n \n@@ -173,7 +172,9 @@ pub fn sizing_type_of(cx: @CrateContext, t: ty::t) -> TypeRef {\n         ty::ty_enum(def_id, _) => T_struct(enum_body_types(cx, def_id, t)),\n \n         ty::ty_self | ty::ty_infer(*) | ty::ty_param(*) | ty::ty_err(*) => {\n-            cx.tcx.sess.bug(~\"fictitious type in sizing_type_of()\")\n+            cx.tcx.sess.bug(\n+                fmt!(\"fictitious type %? in sizing_type_of()\",\n+                     ty::get(t).sty))\n         }\n     };\n \n@@ -270,9 +271,7 @@ pub fn type_of(cx: @CrateContext, t: ty::t) -> TypeRef {\n         T_struct(~[T_struct(tys)])\n       }\n \n-      // FIXME(#4804) Bare fn repr\n-      // ty::ty_bare_fn(_) => T_ptr(type_of_fn_from_ty(cx, t)),\n-      ty::ty_bare_fn(_) => T_fn_pair(cx, type_of_fn_from_ty(cx, t)),\n+      ty::ty_bare_fn(_) => T_ptr(type_of_fn_from_ty(cx, t)),\n       ty::ty_closure(_) => T_fn_pair(cx, type_of_fn_from_ty(cx, t)),\n       ty::ty_trait(_, _, vstore) => T_opaque_trait(cx, vstore),\n       ty::ty_type => T_ptr(cx.tydesc_type),"}, {"sha": "cabda54eeea0027cd30f2f59c87ffdfe4cf21812", "filename": "src/librustc/middle/ty.rs", "status": "modified", "additions": 32, "deletions": 6, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibrustc%2Fmiddle%2Fty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibrustc%2Fmiddle%2Fty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fty.rs?ref=aa3505d8ff043f0c1da62de4f517eed6defb6187", "patch": "@@ -172,7 +172,14 @@ impl cmp::Eq for region_variance {\n \n #[auto_encode]\n #[auto_decode]\n-pub struct AutoAdjustment {\n+pub enum AutoAdjustment {\n+    AutoAddEnv(ty::Region, ast::Sigil),\n+    AutoDerefRef(AutoDerefRef)\n+}\n+\n+#[auto_encode]\n+#[auto_decode]\n+pub struct AutoDerefRef {\n     autoderefs: uint,\n     autoref: Option<AutoRef>\n }\n@@ -198,7 +205,7 @@ pub enum AutoRefKind {\n     AutoBorrowVecRef,\n \n     /// Convert from @fn()/~fn() to &fn()\n-    AutoBorrowFn,\n+    AutoBorrowFn\n }\n \n // Stores information about provided methods (a.k.a. default methods) in\n@@ -1475,7 +1482,6 @@ pub fn type_is_structural(ty: t) -> bool {\n     match get(ty).sty {\n       ty_rec(_) | ty_struct(*) | ty_tup(_) | ty_enum(*) |\n       ty_closure(_) |\n-      ty_bare_fn(_) | // FIXME(#4804) Bare fn repr\n       ty_trait(*) |\n       ty_evec(_, vstore_fixed(_)) | ty_estr(vstore_fixed(_)) |\n       ty_evec(_, vstore_slice(_)) | ty_estr(vstore_slice(_))\n@@ -1585,7 +1591,7 @@ pub pure fn type_is_scalar(ty: t) -> bool {\n     match get(ty).sty {\n       ty_nil | ty_bool | ty_int(_) | ty_float(_) | ty_uint(_) |\n       ty_infer(IntVar(_)) | ty_infer(FloatVar(_)) | ty_type |\n-      ty_ptr(_) => true,\n+      ty_bare_fn(*) | ty_ptr(_) => true,\n       _ => false\n     }\n }\n@@ -2882,7 +2888,25 @@ pub fn expr_ty_adjusted(cx: ctxt, expr: @ast::expr) -> t {\n     return match cx.adjustments.find(&expr.id) {\n         None => unadjusted_ty,\n \n-        Some(adj) => {\n+        Some(@AutoAddEnv(r, s)) => {\n+            match ty::get(unadjusted_ty).sty {\n+                ty::ty_bare_fn(ref b) => {\n+                    ty::mk_closure(\n+                        cx,\n+                        ty::ClosureTy {purity: b.purity,\n+                                       sigil: s,\n+                                       onceness: ast::Many,\n+                                       region: r,\n+                                       sig: copy b.sig})\n+                }\n+                ref b => {\n+                    cx.sess.bug(\n+                        fmt!(\"add_env adjustment on non-bare-fn: %?\", b));\n+                }\n+            }\n+        }\n+\n+        Some(@AutoDerefRef(ref adj)) => {\n             let mut adjusted_ty = unadjusted_ty;\n \n             for uint::range(0, adj.autoderefs) |i| {\n@@ -3064,9 +3088,11 @@ pub fn expr_kind(tcx: ctxt,\n     match expr.node {\n         ast::expr_path(*) => {\n             match resolve_expr(tcx, expr) {\n-                ast::def_fn(*) | ast::def_static_method(*) |\n                 ast::def_variant(*) | ast::def_struct(*) => RvalueDpsExpr,\n \n+                // Fn pointers are just scalar values.\n+                ast::def_fn(*) | ast::def_static_method(*) => RvalueDatumExpr,\n+\n                 // Note: there is actually a good case to be made that\n                 // def_args, particularly those of immediate type, ought to\n                 // considered rvalues."}, {"sha": "63d09d88f52a54096b8183e5f0715d20653b6342", "filename": "src/librustc/middle/typeck/check/method.rs", "status": "modified", "additions": 10, "deletions": 8, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibrustc%2Fmiddle%2Ftypeck%2Fcheck%2Fmethod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibrustc%2Fmiddle%2Ftypeck%2Fcheck%2Fmethod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftypeck%2Fcheck%2Fmethod.rs?ref=aa3505d8ff043f0c1da62de4f517eed6defb6187", "patch": "@@ -799,26 +799,28 @@ pub impl LookupContext {\n                 let region = self.infcx().next_region_var(self.expr.span,\n                                                           self.expr.id);\n                 (ty::mk_rptr(tcx, region, self_mt),\n-                 ty::AutoAdjustment {\n+                 ty::AutoDerefRef(ty::AutoDerefRef {\n                      autoderefs: autoderefs+1,\n                      autoref: Some(ty::AutoRef {kind: AutoPtr,\n                                                 region: region,\n-                                                mutbl: self_mt.mutbl})})\n+                                                mutbl: self_mt.mutbl})}))\n             }\n             ty::ty_evec(self_mt, vstore_slice(_))\n             if self_mt.mutbl == m_mutbl => {\n                 let region = self.infcx().next_region_var(self.expr.span,\n                                                           self.expr.id);\n                 (ty::mk_evec(tcx, self_mt, vstore_slice(region)),\n-                 ty::AutoAdjustment {\n+                 ty::AutoDerefRef(ty::AutoDerefRef {\n                     autoderefs: autoderefs,\n                     autoref: Some(ty::AutoRef {kind: AutoBorrowVec,\n                                                region: region,\n-                                               mutbl: self_mt.mutbl})})\n+                                               mutbl: self_mt.mutbl})}))\n             }\n             _ => {\n-                (self_ty, ty::AutoAdjustment {autoderefs: autoderefs,\n-                                              autoref: None})\n+                (self_ty,\n+                 ty::AutoDerefRef(ty::AutoDerefRef {\n+                     autoderefs: autoderefs,\n+                     autoref: None}))\n             }\n         };\n     }\n@@ -947,14 +949,14 @@ pub impl LookupContext {\n                 Some(mme) => {\n                     self.fcx.write_adjustment(\n                         self.self_expr.id,\n-                        @ty::AutoAdjustment {\n+                        @ty::AutoDerefRef(ty::AutoDerefRef {\n                             autoderefs: autoderefs,\n                             autoref: Some(ty::AutoRef {\n                                 kind: kind,\n                                 region: region,\n                                 mutbl: *mutbl,\n                             }),\n-                        });\n+                        }));\n                     return Some(mme);\n                 }\n             }"}, {"sha": "9ca8268171b0b59515c117627cee3d284da74ca3", "filename": "src/librustc/middle/typeck/check/mod.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibrustc%2Fmiddle%2Ftypeck%2Fcheck%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibrustc%2Fmiddle%2Ftypeck%2Fcheck%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftypeck%2Fcheck%2Fmod.rs?ref=aa3505d8ff043f0c1da62de4f517eed6defb6187", "patch": "@@ -749,7 +749,9 @@ pub impl FnCtxt {\n         if derefs == 0 { return; }\n         self.write_adjustment(\n             node_id,\n-            @ty::AutoAdjustment { autoderefs: derefs, autoref: None }\n+            @ty::AutoDerefRef(ty::AutoDerefRef {\n+                autoderefs: derefs,\n+                autoref: None })\n         );\n     }\n "}, {"sha": "1f2dfe7192fb525e6c0895b0f2c1c8ebabaa2b18", "filename": "src/librustc/middle/typeck/check/regionck.rs", "status": "modified", "additions": 36, "deletions": 16, "changes": 52, "blob_url": "https://github.com/rust-lang/rust/blob/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibrustc%2Fmiddle%2Ftypeck%2Fcheck%2Fregionck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibrustc%2Fmiddle%2Ftypeck%2Fcheck%2Fregionck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftypeck%2Fcheck%2Fregionck.rs?ref=aa3505d8ff043f0c1da62de4f517eed6defb6187", "patch": "@@ -184,8 +184,13 @@ pub fn visit_expr(expr: @ast::expr, &&rcx: @mut Rcx, v: rvt) {\n     debug!(\"visit_expr(e=%s)\", rcx.fcx.expr_to_str(expr));\n \n     for rcx.fcx.inh.adjustments.find(&expr.id).each |adjustment| {\n-        for adjustment.autoref.each |autoref| {\n-            guarantor::for_autoref(rcx, expr, *adjustment, autoref);\n+        match *adjustment {\n+            @ty::AutoDerefRef(\n+                ty::AutoDerefRef {\n+                    autoderefs: autoderefs, autoref: Some(ref autoref)}) => {\n+                guarantor::for_autoref(rcx, expr, autoderefs, autoref);\n+            }\n+            _ => {}\n         }\n     }\n \n@@ -329,9 +334,11 @@ pub fn constrain_auto_ref(rcx: @mut Rcx, expr: @ast::expr) {\n \n     let adjustment = rcx.fcx.inh.adjustments.find(&expr.id);\n     let region = match adjustment {\n-        Some(@ty::AutoAdjustment { autoref: Some(ref auto_ref), _ }) => {\n+        Some(@ty::AutoDerefRef(\n+            ty::AutoDerefRef {\n+                autoref: Some(ref auto_ref), _})) => {\n             auto_ref.region\n-        },\n+        }\n         _ => { return; }\n     };\n \n@@ -563,7 +570,7 @@ pub mod guarantor {\n \n     pub fn for_autoref(rcx: @mut Rcx,\n                        expr: @ast::expr,\n-                       adjustment: &ty::AutoAdjustment,\n+                       autoderefs: uint,\n                        autoref: &ty::AutoRef) {\n         /*!\n          *\n@@ -578,7 +585,7 @@ pub mod guarantor {\n \n         let mut expr_ct = categorize_unadjusted(rcx, expr);\n         expr_ct = apply_autoderefs(\n-            rcx, expr, adjustment.autoderefs, expr_ct);\n+            rcx, expr, autoderefs, expr_ct);\n         for expr_ct.cat.guarantor.each |g| {\n             infallibly_mk_subr(rcx, true, expr.span, autoref.region, *g);\n         }\n@@ -723,19 +730,32 @@ pub mod guarantor {\n         let mut expr_ct = categorize_unadjusted(rcx, expr);\n         debug!(\"before adjustments, cat=%?\", expr_ct.cat);\n \n-        for rcx.fcx.inh.adjustments.find(&expr.id).each |adjustment| {\n-            debug!(\"adjustment=%?\", adjustment);\n+        match rcx.fcx.inh.adjustments.find(&expr.id) {\n+            Some(@ty::AutoAddEnv(*)) => {\n+                // This is basically an rvalue, not a pointer, no regions\n+                // involved.\n+                expr_ct.cat = ExprCategorization {\n+                    guarantor: None,\n+                    pointer: NotPointer\n+                };\n+            }\n+\n+            Some(@ty::AutoDerefRef(ref adjustment)) => {\n+                debug!(\"adjustment=%?\", adjustment);\n \n-            expr_ct = apply_autoderefs(\n-                rcx, expr, adjustment.autoderefs, expr_ct);\n+                expr_ct = apply_autoderefs(\n+                    rcx, expr, adjustment.autoderefs, expr_ct);\n \n-            for adjustment.autoref.each |autoref| {\n-                // If there is an autoref, then the result of this\n-                // expression will be some sort of borrowed pointer.\n-                expr_ct.cat.guarantor = None;\n-                expr_ct.cat.pointer = BorrowedPointer(autoref.region);\n-                debug!(\"autoref, cat=%?\", expr_ct.cat);\n+                for adjustment.autoref.each |autoref| {\n+                    // If there is an autoref, then the result of this\n+                    // expression will be some sort of borrowed pointer.\n+                    expr_ct.cat.guarantor = None;\n+                    expr_ct.cat.pointer = BorrowedPointer(autoref.region);\n+                    debug!(\"autoref, cat=%?\", expr_ct.cat);\n+                }\n             }\n+\n+            None => {}\n         }\n \n         debug!(\"result=%?\", expr_ct.cat);"}, {"sha": "e5aca315dd1c9ad2c9e1351d10b7b12d8c1bfe76", "filename": "src/librustc/middle/typeck/check/writeback.rs", "status": "modified", "additions": 21, "deletions": 3, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibrustc%2Fmiddle%2Ftypeck%2Fcheck%2Fwriteback.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibrustc%2Fmiddle%2Ftypeck%2Fcheck%2Fwriteback.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftypeck%2Fcheck%2Fwriteback.rs?ref=aa3505d8ff043f0c1da62de4f517eed6defb6187", "patch": "@@ -79,7 +79,24 @@ fn resolve_type_vars_for_node(wbcx: @mut WbCtxt, sp: span, id: ast::node_id)\n     // Resolve any borrowings for the node with id `id`\n     match fcx.inh.adjustments.find(&id) {\n         None => (),\n-        Some(adj) => {\n+\n+        Some(@ty::AutoAddEnv(r, s)) => {\n+            match resolve_region(fcx.infcx(), r, resolve_all | force_all) {\n+                Err(e) => {\n+                    // This should not, I think, happen:\n+                    fcx.ccx.tcx.sess.span_err(\n+                        sp, fmt!(\"cannot resolve bound for closure: %s\",\n+                                 infer::fixup_err_to_str(e)));\n+                }\n+                Ok(r1) => {\n+                    let resolved_adj = @ty::AutoAddEnv(r1, s);\n+                    debug!(\"Adjustments for node %d: %?\", id, resolved_adj);\n+                    fcx.tcx().adjustments.insert(id, resolved_adj);\n+                }\n+            }\n+        }\n+\n+        Some(@ty::AutoDerefRef(adj)) => {\n             let resolved_autoref = match adj.autoref {\n                 Some(ref autoref) => {\n                     match resolve_region(fcx.infcx(), autoref.region,\n@@ -99,9 +116,10 @@ fn resolve_type_vars_for_node(wbcx: @mut WbCtxt, sp: span, id: ast::node_id)\n                 None => None\n             };\n \n-            let resolved_adj = @ty::AutoAdjustment {\n+            let resolved_adj = @ty::AutoDerefRef(ty::AutoDerefRef {\n+                autoderefs: adj.autoderefs,\n                 autoref: resolved_autoref,\n-                ..*adj};\n+            });\n             debug!(\"Adjustments for node %d: %?\", id, resolved_adj);\n             fcx.tcx().adjustments.insert(id, resolved_adj);\n         }"}, {"sha": "9ee0b8481760c60969689e509f02890fb5219029", "filename": "src/librustc/middle/typeck/infer/coercion.rs", "status": "modified", "additions": 12, "deletions": 10, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibrustc%2Fmiddle%2Ftypeck%2Finfer%2Fcoercion.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibrustc%2Fmiddle%2Ftypeck%2Finfer%2Fcoercion.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftypeck%2Finfer%2Fcoercion.rs?ref=aa3505d8ff043f0c1da62de4f517eed6defb6187", "patch": "@@ -67,7 +67,7 @@ we may want to adjust precisely when coercions occur.\n use core::prelude::*;\n \n use middle::ty::{TyVar, AutoPtr, AutoBorrowVec, AutoBorrowFn};\n-use middle::ty::{AutoAdjustment, AutoRef};\n+use middle::ty::{AutoAdjustment, AutoDerefRef, AutoRef};\n use middle::ty::{vstore_slice, vstore_box, vstore_uniq, vstore_fixed};\n use middle::ty::{mt};\n use middle::ty;\n@@ -206,14 +206,14 @@ pub impl Coerce {\n                                      r_borrow,\n                                      mt {ty: inner_ty, mutbl: mt_b.mutbl});\n         if_ok!(sub.tys(a_borrowed, b));\n-        Ok(Some(@AutoAdjustment {\n+        Ok(Some(@AutoDerefRef(AutoDerefRef {\n             autoderefs: 1,\n             autoref: Some(AutoRef {\n                 kind: AutoPtr,\n                 region: r_borrow,\n                 mutbl: mt_b.mutbl\n             })\n-        }))\n+        })))\n     }\n \n     fn coerce_borrowed_string(&self,\n@@ -236,14 +236,14 @@ pub impl Coerce {\n         let r_a = self.infcx.next_region_var_nb(self.span);\n         let a_borrowed = ty::mk_estr(self.infcx.tcx, vstore_slice(r_a));\n         if_ok!(self.subtype(a_borrowed, b));\n-        Ok(Some(@AutoAdjustment {\n+        Ok(Some(@AutoDerefRef(AutoDerefRef {\n             autoderefs: 0,\n             autoref: Some(AutoRef {\n                 kind: AutoBorrowVec,\n                 region: r_a,\n                 mutbl: m_imm\n             })\n-        }))\n+        })))\n     }\n \n     fn coerce_borrowed_vector(&self,\n@@ -269,14 +269,14 @@ pub impl Coerce {\n                                      mt {ty: ty_inner, mutbl: mt_b.mutbl},\n                                      vstore_slice(r_borrow));\n         if_ok!(sub.tys(a_borrowed, b));\n-        Ok(Some(@AutoAdjustment {\n+        Ok(Some(@AutoDerefRef(AutoDerefRef {\n             autoderefs: 0,\n             autoref: Some(AutoRef {\n                 kind: AutoBorrowVec,\n                 region: r_borrow,\n                 mutbl: mt_b.mutbl\n             })\n-        }))\n+        })))\n     }\n \n     fn coerce_borrowed_fn(&self,\n@@ -309,14 +309,14 @@ pub impl Coerce {\n             });\n \n         if_ok!(self.subtype(a_borrowed, b));\n-        Ok(Some(@AutoAdjustment {\n+        Ok(Some(@AutoDerefRef(AutoDerefRef {\n             autoderefs: 0,\n             autoref: Some(AutoRef {\n                 kind: AutoBorrowFn,\n                 region: r_borrow,\n                 mutbl: m_imm\n             })\n-        }))\n+        })))\n     }\n \n     fn coerce_from_bare_fn(&self,\n@@ -347,10 +347,12 @@ pub impl Coerce {\n \n         // for now, bare fn and closures have the same\n         // representation\n+        let adj = @ty::AutoAddEnv(fn_ty_b.region, fn_ty_b.sigil);\n         let a_closure = ty::mk_closure(\n             self.infcx.tcx,\n             ty::ClosureTy {sig: copy fn_ty_a.sig, ..fn_ty_b});\n-        self.subtype(a_closure, b)\n+        if_ok!(self.subtype(a_closure, b));\n+        Ok(Some(adj))\n     }\n \n     fn coerce_unsafe_ptr(&self,"}, {"sha": "140b52f03aaf5440c816aab3335b4ec28024a347", "filename": "src/librustc/rustc.rc", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibrustc%2Frustc.rc", "raw_url": "https://github.com/rust-lang/rust/raw/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibrustc%2Frustc.rc", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Frustc.rc?ref=aa3505d8ff043f0c1da62de4f517eed6defb6187", "patch": "@@ -1,4 +1,4 @@\n-// Copyright 2012 The Rust Project Developers. See the COPYRIGHT\n+// Copyright 2012-2013 The Rust Project Developers. See the COPYRIGHT\n // file at the top-level directory of this distribution and at\n // http://rust-lang.org/COPYRIGHT.\n //\n@@ -15,7 +15,7 @@\n        url = \"https://github.com/mozilla/rust/tree/master/src/rustc\")];\n \n #[comment = \"The Rust compiler\"];\n-#[license = \"MIT\"];\n+#[license = \"MIT/ASL2\"];\n #[crate_type = \"lib\"];\n \n #[legacy_modes];"}, {"sha": "fc0ea4ce396089e7ac096489876d522f16df96f8", "filename": "src/librustdoc/rustdoc.rc", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibrustdoc%2Frustdoc.rc", "raw_url": "https://github.com/rust-lang/rust/raw/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibrustdoc%2Frustdoc.rc", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Frustdoc.rc?ref=aa3505d8ff043f0c1da62de4f517eed6defb6187", "patch": "@@ -1,4 +1,4 @@\n-// Copyright 2012 The Rust Project Developers. See the COPYRIGHT\n+// Copyright 2012-2013 The Rust Project Developers. See the COPYRIGHT\n // file at the top-level directory of this distribution and at\n // http://rust-lang.org/COPYRIGHT.\n //\n@@ -16,7 +16,7 @@\n        url = \"https://github.com/mozilla/rust/tree/master/src/rustdoc\")];\n \n #[comment = \"The Rust documentation generator\"];\n-#[license = \"MIT\"];\n+#[license = \"MIT/ASL2\"];\n #[crate_type = \"lib\"];\n \n #[no_core];"}, {"sha": "56375ca5bfb35d64953b3d973fe4280bc228191d", "filename": "src/librusti/rusti.rc", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibrusti%2Frusti.rc", "raw_url": "https://github.com/rust-lang/rust/raw/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibrusti%2Frusti.rc", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrusti%2Frusti.rc?ref=aa3505d8ff043f0c1da62de4f517eed6defb6187", "patch": "@@ -1,4 +1,4 @@\n-// Copyright 2012 The Rust Project Developers. See the COPYRIGHT\n+// Copyright 2012-2013 The Rust Project Developers. See the COPYRIGHT\n // file at the top-level directory of this distribution and at\n // http://rust-lang.org/COPYRIGHT.\n //\n@@ -15,6 +15,7 @@\n        uuid = \"7fb5bf52-7d45-4fee-8325-5ad3311149fc\",\n        url = \"https://github.com/mozilla/rust/tree/master/src/rusti\")];\n \n+#[license = \"MIT/ASL2\"];\n #[crate_type = \"lib\"];\n \n #[no_core];"}, {"sha": "b58b5977f97ed541a68483762df37cd5b09f1ae7", "filename": "src/librustpkg/rustpkg.rc", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibrustpkg%2Frustpkg.rc", "raw_url": "https://github.com/rust-lang/rust/raw/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibrustpkg%2Frustpkg.rc", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustpkg%2Frustpkg.rc?ref=aa3505d8ff043f0c1da62de4f517eed6defb6187", "patch": "@@ -1,4 +1,4 @@\n-// Copyright 2012 The Rust Project Developers. See the COPYRIGHT\n+// Copyright 2012-2013 The Rust Project Developers. See the COPYRIGHT\n // file at the top-level directory of this distribution and at\n // http://rust-lang.org/COPYRIGHT.\n //\n@@ -15,6 +15,7 @@\n        uuid = \"25de5e6e-279e-4a20-845c-4cabae92daaf\",\n        url = \"https://github.com/mozilla/rust/tree/master/src/librustpkg\")];\n \n+#[license = \"MIT/ASL2\"];\n #[crate_type = \"lib\"];\n #[no_core];\n #[allow(vecs_implicitly_copyable,"}, {"sha": "2f6c4e3f1904b5337928d3320140400a844ec303", "filename": "src/libstd/std.rc", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibstd%2Fstd.rc", "raw_url": "https://github.com/rust-lang/rust/raw/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibstd%2Fstd.rc", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fstd.rc?ref=aa3505d8ff043f0c1da62de4f517eed6defb6187", "patch": "@@ -1,4 +1,4 @@\n-// Copyright 2012 The Rust Project Developers. See the COPYRIGHT\n+// Copyright 2012-2013 The Rust Project Developers. See the COPYRIGHT\n // file at the top-level directory of this distribution and at\n // http://rust-lang.org/COPYRIGHT.\n //\n@@ -23,7 +23,7 @@ not required in or otherwise suitable for the core library.\n        url = \"https://github.com/mozilla/rust/tree/master/src/libstd\")];\n \n #[comment = \"The Rust standard library\"];\n-#[license = \"MIT\"];\n+#[license = \"MIT/ASL2\"];\n #[crate_type = \"lib\"];\n \n #[allow(vecs_implicitly_copyable)];"}, {"sha": "0e2f3c2c8562fa32bfce5adb933b261acce766a2", "filename": "src/libsyntax/ext/auto_encode.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibsyntax%2Fext%2Fauto_encode.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibsyntax%2Fext%2Fauto_encode.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fauto_encode.rs?ref=aa3505d8ff043f0c1da62de4f517eed6defb6187", "patch": "@@ -469,8 +469,8 @@ fn mk_impl(\n     let ty = cx.ty_path(\n         span,\n         ~[ident],\n-        generics.ty_params.map(\n-            |tp| cx.ty_path(span, ~[tp.ident], ~[])).to_vec()\n+        opt_vec::take_vec(generics.ty_params.map(\n+            |tp| cx.ty_path(span, ~[tp.ident], ~[])))\n     );\n \n     let generics = ast::Generics {"}, {"sha": "3b885b7a7b976faa4ee55b2158e8e2432f7453af", "filename": "src/libsyntax/ext/pipes/ast_builder.rs", "status": "modified", "additions": 6, "deletions": 4, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibsyntax%2Fext%2Fpipes%2Fast_builder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibsyntax%2Fext%2Fpipes%2Fast_builder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fpipes%2Fast_builder.rs?ref=aa3505d8ff043f0c1da62de4f517eed6defb6187", "patch": "@@ -434,13 +434,15 @@ impl ext_ctxt_ast_builder for ext_ctxt {\n     }\n \n     fn ty_vars(&self, ty_params: &OptVec<ast::TyParam>) -> ~[@ast::Ty] {\n-        ty_params.map(|p| self.ty_path_ast_builder(\n-            path(~[p.ident], dummy_sp()))).to_vec()\n+        opt_vec::take_vec(\n+            ty_params.map(|p| self.ty_path_ast_builder(\n+                path(~[p.ident], dummy_sp()))))\n     }\n \n     fn ty_vars_global(&self,\n                       ty_params: &OptVec<ast::TyParam>) -> ~[@ast::Ty] {\n-        ty_params.map(|p| self.ty_path_ast_builder(\n-            path(~[p.ident], dummy_sp()))).to_vec()\n+        opt_vec::take_vec(\n+            ty_params.map(|p| self.ty_path_ast_builder(\n+                path(~[p.ident], dummy_sp()))))\n     }\n }"}, {"sha": "16db384bb062c52255bb232dcef57de681d9a0e9", "filename": "src/libsyntax/opt_vec.rs", "status": "modified", "additions": 13, "deletions": 5, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibsyntax%2Fopt_vec.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibsyntax%2Fopt_vec.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fopt_vec.rs?ref=aa3505d8ff043f0c1da62de4f517eed6defb6187", "patch": "@@ -31,6 +31,14 @@ pub fn with<T>(+t: T) -> OptVec<T> {\n     Vec(~[t])\n }\n \n+pub fn from<T>(+t: ~[T]) -> OptVec<T> {\n+    if t.len() == 0 {\n+        Empty\n+    } else {\n+        Vec(t)\n+    }\n+}\n+\n impl<T> OptVec<T> {\n     fn push(&mut self, +t: T) {\n         match *self {\n@@ -70,12 +78,12 @@ impl<T> OptVec<T> {\n             Vec(ref v) => v.len()\n         }\n     }\n+}\n \n-    pure fn to_vec(self) -> ~[T] {\n-        match self {\n-            Empty => ~[],\n-            Vec(v) => v\n-        }\n+pub fn take_vec<T>(+v: OptVec<T>) -> ~[T] {\n+    match v {\n+        Empty => ~[],\n+        Vec(v) => v\n     }\n }\n "}, {"sha": "127af5b73ac8ae2ade5ef549ee991324449b6009", "filename": "src/libsyntax/parse/parser.rs", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibsyntax%2Fparse%2Fparser.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibsyntax%2Fparse%2Fparser.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fparse%2Fparser.rs?ref=aa3505d8ff043f0c1da62de4f517eed6defb6187", "patch": "@@ -1195,7 +1195,7 @@ pub impl Parser {\n                         &token::RBRACKET,\n                         seq_sep_trailing_allowed(token::COMMA),\n                         |p| p.parse_expr()\n-                    ).to_vec();\n+                    );\n                     ex = expr_vec(~[first_expr] + remaining_exprs, mutbl);\n                 } else {\n                     // Vector with one element.\n@@ -1478,7 +1478,7 @@ pub impl Parser {\n                                 &ket,\n                                 seq_sep_none(),\n                                 |p| p.parse_token_tree()\n-                            ).to_vec(),\n+                            ),\n                             // the close delimiter:\n                             ~[parse_any_tt_tok(&self)]\n                         )\n@@ -2806,7 +2806,7 @@ pub impl Parser {\n         let result = self.parse_seq_to_gt(\n             Some(token::COMMA),\n             |p| p.parse_ty(false));\n-        result.to_vec()\n+        opt_vec::take_vec(result)\n     }\n \n     fn parse_fn_decl(parse_arg_fn: fn(&Parser) -> arg_or_capture_item)\n@@ -2908,7 +2908,7 @@ pub impl Parser {\n                         &token::RPAREN,\n                         sep,\n                         parse_arg_fn\n-                    ).to_vec();\n+                    );\n                 }\n                 token::RPAREN => {\n                     args_or_capture_items = ~[];\n@@ -2928,7 +2928,7 @@ pub impl Parser {\n                 &token::RPAREN,\n                 sep,\n                 parse_arg_fn\n-            ).to_vec();\n+            );\n         }\n \n         self.expect(&token::RPAREN);\n@@ -3130,7 +3130,7 @@ pub impl Parser {\n             ket,\n             seq_sep_none(),\n             |p| p.parse_trait_ref()\n-        ).to_vec()\n+        )\n     }\n \n     fn parse_item_struct() -> item_info {"}, {"sha": "f6e358e535f66639633caeb5a7c8e311ae82587a", "filename": "src/libsyntax/syntax.rc", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibsyntax%2Fsyntax.rc", "raw_url": "https://github.com/rust-lang/rust/raw/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Flibsyntax%2Fsyntax.rc", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fsyntax.rc?ref=aa3505d8ff043f0c1da62de4f517eed6defb6187", "patch": "@@ -1,4 +1,4 @@\n-// Copyright 2012 The Rust Project Developers. See the COPYRIGHT\n+// Copyright 2012-2013 The Rust Project Developers. See the COPYRIGHT\n // file at the top-level directory of this distribution and at\n // http://rust-lang.org/COPYRIGHT.\n //\n@@ -14,6 +14,7 @@\n \n \n \n+#[license = \"MIT/ASL2\"];\n #[crate_type = \"lib\"];\n \n #[legacy_modes];"}, {"sha": "9f39e1433fc632045d98f5c0ef88d95ab3df8aef", "filename": "src/rt/rust_upcall.cpp", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Frt%2Frust_upcall.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Frt%2Frust_upcall.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_upcall.cpp?ref=aa3505d8ff043f0c1da62de4f517eed6defb6187", "patch": "@@ -120,7 +120,7 @@ upcall_fail(char const *expr,\n             size_t line) {\n     rust_task *task = rust_try_get_current_task();\n     if (task == NULL) {\n-        // NOTE: Need to think about what to do here\n+        // FIXME #5161: Need to think about what to do here\n         printf(\"failure outside of a task\");\n         abort();\n     }"}, {"sha": "31acfa81100d3d149e2be195e5f2b33db4a81ec4", "filename": "src/snapshots.txt", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Fsnapshots.txt", "raw_url": "https://github.com/rust-lang/rust/raw/aa3505d8ff043f0c1da62de4f517eed6defb6187/src%2Fsnapshots.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fsnapshots.txt?ref=aa3505d8ff043f0c1da62de4f517eed6defb6187", "patch": "@@ -1,5 +1,5 @@\n S 2013-02-27 a6d9689\n-  freebsd-x86_64 d33b5ebbf3335f6a8a5cc23572f630ad66539830\n+  freebsd-x86_64 683f329fe589af854f9a375405468691d98015ac\n   linux-i386 22f5c2a91941735007ed804586fc0f0e82fc3601\n   linux-x86_64 328fb144edbed8cabb8c2c6306304e3d8460ef60\n   macos-i386 5dda51347f9aba4c70a0890d3ec084d98a49c015"}]}