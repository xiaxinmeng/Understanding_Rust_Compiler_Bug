{"sha": "5b9289215e0afb73efbf882e8d6f0af461fc99f2", "node_id": "C_kwDOAAsO6NoAKDViOTI4OTIxNWUwYWZiNzNlZmJmODgyZThkNmYwYWY0NjFmYzk5ZjI", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-11-21T13:11:12Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-11-21T13:11:12Z"}, "message": "Rollup merge of #104628 - alex-pinkus:revert-android-ndk-upgrade, r=pietroalbini\n\nRevert \"Update CI to use Android NDK r25b\"\n\nThis reverts commit bf7f1ca316a249cf99d722d79a0db12fef687142 (pull request #102332).\n\nThe relevant discussion can be found in #103673, where it was agreed that more time is needed to warn the community of the upcoming breakage.\n\nThis PR is for the `master` branch, where a conflict was recently introduced due to 6d8160261ff3aee3b6eaacc37ac96cafff530980. The conflict is in `cc_detect.rs`, where the code that corrects the target triple was moved to a new function called `ndk_compiler()`. This puts the old logic in the `ndk_compiler` function, and assumes that it works properly in the other location where that code is being called. I would appreciate review from ``@pietroalbini`` to understand how we can test that the reverted logic is also suitable for the additional use case (seems to be related to setting `cc` and `cxx`). I've confirmed already that with these changes I can compile for `armv7-linux-androideabi`, `aarch64-linux-android`, `i686-linux-android`, and `x86_64-linux-android` using `x.py`.\n\nA separate revert for the `beta` branch will be required, since the original change has already made it to beta. The beta revert is available at https://github.com/alex-pinkus/rust/commit/3fa0d94674fbe37090ebe44ac1f06e2233f3121e, but I'm not sure of the process for staging that PR.", "tree": {"sha": "4794afab68078b80105749b4f5a81d12468f7927", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4794afab68078b80105749b4f5a81d12468f7927"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5b9289215e0afb73efbf882e8d6f0af461fc99f2", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJje3jwCRBK7hj4Ov3rIwAAFAoIAJZkazKzkecr//zWLovSL5Fj\n+q8M5KskT1l4Z7QsxaDi1kPf/HvvylqnFIZX4L13udAllqPxNivoA0rNgIFN1t2M\ni8g9JkYAeeDK/xjZpO/F/xMupP66ZZaRUzUX2QhOqO6BScHNgDdluXG9mYSn9DPK\nIX9rXu6GQB4mXbSs33h9LvVXuCnbzjiEzqfIVcjyFi5ieekZaITx8gd3JFSWauj1\njI3afNExSPskjChK0ugxZ/vB/wwyfQGsKpansOxOrHaXmlryma+uYyQwjniuKQdU\nz1k07TkXyeumyHasqCsNFzKIl1wRgLqaSJt+4G8I83HKcJXFPCh16mGnMXKNKXg=\n=R/27\n-----END PGP SIGNATURE-----\n", "payload": "tree 4794afab68078b80105749b4f5a81d12468f7927\nparent ed22bdc18f466f03737b4cdd8dba6d5524fb5389\nparent 6f1c7b24705d8e744ddea9b445cb70e0a0d328cb\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1669036272 +0100\ncommitter GitHub <noreply@github.com> 1669036272 +0100\n\nRollup merge of #104628 - alex-pinkus:revert-android-ndk-upgrade, r=pietroalbini\n\nRevert \"Update CI to use Android NDK r25b\"\n\nThis reverts commit bf7f1ca316a249cf99d722d79a0db12fef687142 (pull request #102332).\n\nThe relevant discussion can be found in #103673, where it was agreed that more time is needed to warn the community of the upcoming breakage.\n\nThis PR is for the `master` branch, where a conflict was recently introduced due to 6d8160261ff3aee3b6eaacc37ac96cafff530980. The conflict is in `cc_detect.rs`, where the code that corrects the target triple was moved to a new function called `ndk_compiler()`. This puts the old logic in the `ndk_compiler` function, and assumes that it works properly in the other location where that code is being called. I would appreciate review from ``@pietroalbini`` to understand how we can test that the reverted logic is also suitable for the additional use case (seems to be related to setting `cc` and `cxx`). I've confirmed already that with these changes I can compile for `armv7-linux-androideabi`, `aarch64-linux-android`, `i686-linux-android`, and `x86_64-linux-android` using `x.py`.\n\nA separate revert for the `beta` branch will be required, since the original change has already made it to beta. The beta revert is available at https://github.com/alex-pinkus/rust/commit/3fa0d94674fbe37090ebe44ac1f06e2233f3121e, but I'm not sure of the process for staging that PR.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5b9289215e0afb73efbf882e8d6f0af461fc99f2", "html_url": "https://github.com/rust-lang/rust/commit/5b9289215e0afb73efbf882e8d6f0af461fc99f2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5b9289215e0afb73efbf882e8d6f0af461fc99f2/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ed22bdc18f466f03737b4cdd8dba6d5524fb5389", "url": "https://api.github.com/repos/rust-lang/rust/commits/ed22bdc18f466f03737b4cdd8dba6d5524fb5389", "html_url": "https://github.com/rust-lang/rust/commit/ed22bdc18f466f03737b4cdd8dba6d5524fb5389"}, {"sha": "6f1c7b24705d8e744ddea9b445cb70e0a0d328cb", "url": "https://api.github.com/repos/rust-lang/rust/commits/6f1c7b24705d8e744ddea9b445cb70e0a0d328cb", "html_url": "https://github.com/rust-lang/rust/commit/6f1c7b24705d8e744ddea9b445cb70e0a0d328cb"}], "stats": {"total": 71, "additions": 42, "deletions": 29}, "files": [{"sha": "7128d542acfe9d0609c165c3c7b074bd904c2d0c", "filename": "src/bootstrap/cc_detect.rs", "status": "modified", "additions": 6, "deletions": 18, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/5b9289215e0afb73efbf882e8d6f0af461fc99f2/src%2Fbootstrap%2Fcc_detect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5b9289215e0afb73efbf882e8d6f0af461fc99f2/src%2Fbootstrap%2Fcc_detect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcc_detect.rs?ref=5b9289215e0afb73efbf882e8d6f0af461fc99f2", "patch": "@@ -47,8 +47,6 @@ fn cc2ar(cc: &Path, target: TargetSelection) -> Option<PathBuf> {\n         Some(PathBuf::from(\"ar\"))\n     } else if target.contains(\"vxworks\") {\n         Some(PathBuf::from(\"wr-ar\"))\n-    } else if target.contains(\"android\") {\n-        Some(cc.parent().unwrap().join(PathBuf::from(\"llvm-ar\")))\n     } else {\n         let parent = cc.parent().unwrap();\n         let file = cc.file_name().unwrap().to_str().unwrap();\n@@ -221,22 +219,12 @@ fn set_compiler(\n }\n \n pub(crate) fn ndk_compiler(compiler: Language, triple: &str, ndk: &Path) -> PathBuf {\n-    let mut triple_iter = triple.split(\"-\");\n-    let triple_translated = if let Some(arch) = triple_iter.next() {\n-        let arch_new = match arch {\n-            \"arm\" | \"armv7\" | \"armv7neon\" | \"thumbv7\" | \"thumbv7neon\" => \"armv7a\",\n-            other => other,\n-        };\n-        std::iter::once(arch_new).chain(triple_iter).collect::<Vec<&str>>().join(\"-\")\n-    } else {\n-        triple.to_string()\n-    };\n-\n-    // API 19 is the earliest API level supported by NDK r25b but AArch64 and x86_64 support\n-    // begins at API level 21.\n-    let api_level =\n-        if triple.contains(\"aarch64\") || triple.contains(\"x86_64\") { \"21\" } else { \"19\" };\n-    let compiler = format!(\"{}{}-{}\", triple_translated, api_level, compiler.clang());\n+    let triple_translated = triple\n+        .replace(\"armv7neon\", \"arm\")\n+        .replace(\"armv7\", \"arm\")\n+        .replace(\"thumbv7neon\", \"arm\")\n+        .replace(\"thumbv7\", \"arm\");\n+    let compiler = format!(\"{}-{}\", triple_translated, compiler.clang());\n     ndk.join(\"bin\").join(compiler)\n }\n "}, {"sha": "7a875c960e13312d77d11983c0f4bab304b4c554", "filename": "src/ci/docker/host-x86_64/arm-android/Dockerfile", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/5b9289215e0afb73efbf882e8d6f0af461fc99f2/src%2Fci%2Fdocker%2Fhost-x86_64%2Farm-android%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/5b9289215e0afb73efbf882e8d6f0af461fc99f2/src%2Fci%2Fdocker%2Fhost-x86_64%2Farm-android%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Farm-android%2FDockerfile?ref=5b9289215e0afb73efbf882e8d6f0af461fc99f2", "patch": "@@ -6,7 +6,7 @@ RUN sh /scripts/android-base-apt-get.sh\n \n COPY scripts/android-ndk.sh /scripts/\n RUN . /scripts/android-ndk.sh && \\\n-    download_ndk android-ndk-r25b-linux.zip\n+    download_and_make_toolchain android-ndk-r15c-linux-x86_64.zip arm 14\n \n RUN dpkg --add-architecture i386 && \\\n     apt-get update && \\\n@@ -30,7 +30,7 @@ ENV PATH=$PATH:/android/sdk/platform-tools\n \n ENV TARGETS=arm-linux-androideabi\n \n-ENV RUST_CONFIGURE_ARGS --arm-linux-androideabi-ndk=/android/ndk/toolchains/llvm/prebuilt/linux-x86_64/\n+ENV RUST_CONFIGURE_ARGS --arm-linux-androideabi-ndk=/android/ndk/arm-14\n \n ENV SCRIPT python3 ../x.py --stage 2 test --host='' --target $TARGETS\n "}, {"sha": "2328db4ab8b1d126dd774a67a744afb990bde1e0", "filename": "src/ci/docker/host-x86_64/dist-android/Dockerfile", "status": "modified", "additions": 14, "deletions": 7, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/5b9289215e0afb73efbf882e8d6f0af461fc99f2/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-android%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/5b9289215e0afb73efbf882e8d6f0af461fc99f2/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-android%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-android%2FDockerfile?ref=5b9289215e0afb73efbf882e8d6f0af461fc99f2", "patch": "@@ -6,7 +6,14 @@ RUN sh /scripts/android-base-apt-get.sh\n # ndk\n COPY scripts/android-ndk.sh /scripts/\n RUN . /scripts/android-ndk.sh && \\\n-    download_ndk android-ndk-r25b-linux.zip\n+    download_ndk android-ndk-r15c-linux-x86_64.zip && \\\n+    make_standalone_toolchain arm 14 && \\\n+    make_standalone_toolchain x86 14 && \\\n+    make_standalone_toolchain arm 21 && \\\n+    make_standalone_toolchain x86 21 && \\\n+    make_standalone_toolchain arm64 21 && \\\n+    make_standalone_toolchain x86_64 21 && \\\n+    remove_ndk\n \n # env\n ENV TARGETS=arm-linux-androideabi\n@@ -19,12 +26,12 @@ ENV TARGETS=$TARGETS,x86_64-linux-android\n ENV RUST_CONFIGURE_ARGS \\\n       --enable-extended \\\n       --enable-profiler \\\n-      --arm-linux-androideabi-ndk=/android/ndk/toolchains/llvm/prebuilt/linux-x86_64/ \\\n-      --armv7-linux-androideabi-ndk=/android/ndk/toolchains/llvm/prebuilt/linux-x86_64/ \\\n-      --thumbv7neon-linux-androideabi-ndk=/android/ndk/toolchains/llvm/prebuilt/linux-x86_64/ \\\n-      --i686-linux-android-ndk=/android/ndk/toolchains/llvm/prebuilt/linux-x86_64/ \\\n-      --aarch64-linux-android-ndk=/android/ndk/toolchains/llvm/prebuilt/linux-x86_64/ \\\n-      --x86_64-linux-android-ndk=/android/ndk/toolchains/llvm/prebuilt/linux-x86_64/ \\\n+      --arm-linux-androideabi-ndk=/android/ndk/arm-14 \\\n+      --armv7-linux-androideabi-ndk=/android/ndk/arm-14 \\\n+      --thumbv7neon-linux-androideabi-ndk=/android/ndk/arm-14 \\\n+      --i686-linux-android-ndk=/android/ndk/x86-14 \\\n+      --aarch64-linux-android-ndk=/android/ndk/arm64-21 \\\n+      --x86_64-linux-android-ndk=/android/ndk/x86_64-21 \\\n       --disable-docs\n \n ENV SCRIPT python3 ../x.py dist --host='' --target $TARGETS"}, {"sha": "ba70c62ea3081a96725e3c942e9b21b3d46100f7", "filename": "src/ci/docker/scripts/android-ndk.sh", "status": "modified", "additions": 20, "deletions": 2, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/5b9289215e0afb73efbf882e8d6f0af461fc99f2/src%2Fci%2Fdocker%2Fscripts%2Fandroid-ndk.sh", "raw_url": "https://github.com/rust-lang/rust/raw/5b9289215e0afb73efbf882e8d6f0af461fc99f2/src%2Fci%2Fdocker%2Fscripts%2Fandroid-ndk.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fscripts%2Fandroid-ndk.sh?ref=5b9289215e0afb73efbf882e8d6f0af461fc99f2", "patch": "@@ -4,10 +4,28 @@ set -ex\n URL=https://dl.google.com/android/repository\n \n download_ndk() {\n-    mkdir /android/\n-    cd /android\n+    mkdir -p /android/ndk\n+    cd /android/ndk\n     curl -fO $URL/$1\n     unzip -q $1\n     rm $1\n     mv android-ndk-* ndk\n }\n+\n+make_standalone_toolchain() {\n+    # See https://developer.android.com/ndk/guides/standalone_toolchain.htm\n+    python3 /android/ndk/ndk/build/tools/make_standalone_toolchain.py \\\n+        --install-dir /android/ndk/$1-$2 \\\n+        --arch $1 \\\n+        --api $2\n+}\n+\n+remove_ndk() {\n+    rm -rf /android/ndk/ndk\n+}\n+\n+download_and_make_toolchain() {\n+    download_ndk $1 && \\\n+    make_standalone_toolchain $2 $3 && \\\n+    remove_ndk\n+}"}]}