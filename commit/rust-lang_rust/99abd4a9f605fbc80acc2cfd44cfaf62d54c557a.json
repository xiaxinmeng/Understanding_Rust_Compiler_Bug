{"sha": "99abd4a9f605fbc80acc2cfd44cfaf62d54c557a", "node_id": "C_kwDOAAsO6NoAKDk5YWJkNGE5ZjYwNWZiYzgwYWNjMmNmZDQ0Y2ZhZjYyZDU0YzU1N2E", "commit": {"author": {"name": "Jason Newcomb", "email": "jsnewcomb@pm.me", "date": "2022-08-08T02:22:17Z"}, "committer": {"name": "Jason Newcomb", "email": "jsnewcomb@pm.me", "date": "2022-08-08T02:22:17Z"}, "message": "Fix ICE when reading literals with weird proc-macro spans", "tree": {"sha": "31e115df59a8313865c2925b6b4d64bd1c407628", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/31e115df59a8313865c2925b6b4d64bd1c407628"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/99abd4a9f605fbc80acc2cfd44cfaf62d54c557a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/99abd4a9f605fbc80acc2cfd44cfaf62d54c557a", "html_url": "https://github.com/rust-lang/rust/commit/99abd4a9f605fbc80acc2cfd44cfaf62d54c557a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/99abd4a9f605fbc80acc2cfd44cfaf62d54c557a/comments", "author": {"login": "Jarcho", "id": 7761774, "node_id": "MDQ6VXNlcjc3NjE3NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/7761774?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Jarcho", "html_url": "https://github.com/Jarcho", "followers_url": "https://api.github.com/users/Jarcho/followers", "following_url": "https://api.github.com/users/Jarcho/following{/other_user}", "gists_url": "https://api.github.com/users/Jarcho/gists{/gist_id}", "starred_url": "https://api.github.com/users/Jarcho/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Jarcho/subscriptions", "organizations_url": "https://api.github.com/users/Jarcho/orgs", "repos_url": "https://api.github.com/users/Jarcho/repos", "events_url": "https://api.github.com/users/Jarcho/events{/privacy}", "received_events_url": "https://api.github.com/users/Jarcho/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Jarcho", "id": 7761774, "node_id": "MDQ6VXNlcjc3NjE3NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/7761774?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Jarcho", "html_url": "https://github.com/Jarcho", "followers_url": "https://api.github.com/users/Jarcho/followers", "following_url": "https://api.github.com/users/Jarcho/following{/other_user}", "gists_url": "https://api.github.com/users/Jarcho/gists{/gist_id}", "starred_url": "https://api.github.com/users/Jarcho/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Jarcho/subscriptions", "organizations_url": "https://api.github.com/users/Jarcho/orgs", "repos_url": "https://api.github.com/users/Jarcho/repos", "events_url": "https://api.github.com/users/Jarcho/events{/privacy}", "received_events_url": "https://api.github.com/users/Jarcho/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5721ca9a13562f5168c6ba9f43dc19bb76c6f7bb", "url": "https://api.github.com/repos/rust-lang/rust/commits/5721ca9a13562f5168c6ba9f43dc19bb76c6f7bb", "html_url": "https://github.com/rust-lang/rust/commit/5721ca9a13562f5168c6ba9f43dc19bb76c6f7bb"}], "stats": {"total": 54, "additions": 34, "deletions": 20}, "files": [{"sha": "80098d9766c67b47c0e2e9604cbd76ac6e9ac3ce", "filename": "clippy_utils/src/numeric_literal.rs", "status": "modified", "additions": 6, "deletions": 4, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/99abd4a9f605fbc80acc2cfd44cfaf62d54c557a/clippy_utils%2Fsrc%2Fnumeric_literal.rs", "raw_url": "https://github.com/rust-lang/rust/raw/99abd4a9f605fbc80acc2cfd44cfaf62d54c557a/clippy_utils%2Fsrc%2Fnumeric_literal.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_utils%2Fsrc%2Fnumeric_literal.rs?ref=99abd4a9f605fbc80acc2cfd44cfaf62d54c557a", "patch": "@@ -223,10 +223,12 @@ impl<'a> NumericLiteral<'a> {\n \n fn split_suffix<'a>(src: &'a str, lit_kind: &LitKind) -> (&'a str, Option<&'a str>) {\n     debug_assert!(lit_kind.is_numeric());\n-    lit_suffix_length(lit_kind).map_or((src, None), |suffix_length| {\n-        let (unsuffixed, suffix) = src.split_at(src.len() - suffix_length);\n-        (unsuffixed, Some(suffix))\n-    })\n+    lit_suffix_length(lit_kind)\n+        .and_then(|suffix_length| src.len().checked_sub(suffix_length))\n+        .map_or((src, None), |split_pos| {\n+            let (unsuffixed, suffix) = src.split_at(split_pos);\n+            (unsuffixed, Some(suffix))\n+        })\n }\n \n fn lit_suffix_length(lit_kind: &LitKind) -> Option<usize> {"}, {"sha": "becb9562a8497212ebcadc13412f904ab39b36a9", "filename": "tests/ui/mistyped_literal_suffix.fixed", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/99abd4a9f605fbc80acc2cfd44cfaf62d54c557a/tests%2Fui%2Fmistyped_literal_suffix.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/99abd4a9f605fbc80acc2cfd44cfaf62d54c557a/tests%2Fui%2Fmistyped_literal_suffix.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmistyped_literal_suffix.fixed?ref=99abd4a9f605fbc80acc2cfd44cfaf62d54c557a", "patch": "@@ -1,4 +1,5 @@\n // run-rustfix\n+// aux-build: proc_macro_with_span.rs\n \n #![allow(\n     dead_code,\n@@ -9,6 +10,9 @@\n     clippy::unusual_byte_groupings\n )]\n \n+extern crate proc_macro_with_span;\n+use proc_macro_with_span::with_span;\n+\n fn main() {\n     let fail14 = 2_i32;\n     let fail15 = 4_i64;\n@@ -40,4 +44,6 @@ fn main() {\n     let ok38 = 124_64.0;\n \n     let _ = 1.123_45E1_f32;\n+\n+    let _ = with_span!(1 2_u32);\n }"}, {"sha": "ee841bcd7e4e995ba5b350d81df461ae2db6aaec", "filename": "tests/ui/mistyped_literal_suffix.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/99abd4a9f605fbc80acc2cfd44cfaf62d54c557a/tests%2Fui%2Fmistyped_literal_suffix.rs", "raw_url": "https://github.com/rust-lang/rust/raw/99abd4a9f605fbc80acc2cfd44cfaf62d54c557a/tests%2Fui%2Fmistyped_literal_suffix.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmistyped_literal_suffix.rs?ref=99abd4a9f605fbc80acc2cfd44cfaf62d54c557a", "patch": "@@ -1,4 +1,5 @@\n // run-rustfix\n+// aux-build: proc_macro_with_span.rs\n \n #![allow(\n     dead_code,\n@@ -9,6 +10,9 @@\n     clippy::unusual_byte_groupings\n )]\n \n+extern crate proc_macro_with_span;\n+use proc_macro_with_span::with_span;\n+\n fn main() {\n     let fail14 = 2_32;\n     let fail15 = 4_64;\n@@ -40,4 +44,6 @@ fn main() {\n     let ok38 = 124_64.0;\n \n     let _ = 1.12345E1_32;\n+\n+    let _ = with_span!(1 2_u32);\n }"}, {"sha": "ef8e6a33d28f59a8c65009cdd19b573aa153c6ec", "filename": "tests/ui/mistyped_literal_suffix.stderr", "status": "modified", "additions": 16, "deletions": 16, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/99abd4a9f605fbc80acc2cfd44cfaf62d54c557a/tests%2Fui%2Fmistyped_literal_suffix.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/99abd4a9f605fbc80acc2cfd44cfaf62d54c557a/tests%2Fui%2Fmistyped_literal_suffix.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmistyped_literal_suffix.stderr?ref=99abd4a9f605fbc80acc2cfd44cfaf62d54c557a", "patch": "@@ -1,97 +1,97 @@\n error: mistyped literal suffix\n-  --> $DIR/mistyped_literal_suffix.rs:13:18\n+  --> $DIR/mistyped_literal_suffix.rs:17:18\n    |\n LL |     let fail14 = 2_32;\n    |                  ^^^^ help: did you mean to write: `2_i32`\n    |\n    = note: `#[deny(clippy::mistyped_literal_suffixes)]` on by default\n \n error: mistyped literal suffix\n-  --> $DIR/mistyped_literal_suffix.rs:14:18\n+  --> $DIR/mistyped_literal_suffix.rs:18:18\n    |\n LL |     let fail15 = 4_64;\n    |                  ^^^^ help: did you mean to write: `4_i64`\n \n error: mistyped literal suffix\n-  --> $DIR/mistyped_literal_suffix.rs:15:18\n+  --> $DIR/mistyped_literal_suffix.rs:19:18\n    |\n LL |     let fail16 = 7_8; //\n    |                  ^^^ help: did you mean to write: `7_i8`\n \n error: mistyped literal suffix\n-  --> $DIR/mistyped_literal_suffix.rs:16:18\n+  --> $DIR/mistyped_literal_suffix.rs:20:18\n    |\n LL |     let fail17 = 23_16; //\n    |                  ^^^^^ help: did you mean to write: `23_i16`\n \n error: mistyped literal suffix\n-  --> $DIR/mistyped_literal_suffix.rs:19:18\n+  --> $DIR/mistyped_literal_suffix.rs:23:18\n    |\n LL |     let fail20 = 2__8; //\n    |                  ^^^^ help: did you mean to write: `2_i8`\n \n error: mistyped literal suffix\n-  --> $DIR/mistyped_literal_suffix.rs:20:18\n+  --> $DIR/mistyped_literal_suffix.rs:24:18\n    |\n LL |     let fail21 = 4___16; //\n    |                  ^^^^^^ help: did you mean to write: `4_i16`\n \n error: mistyped literal suffix\n-  --> $DIR/mistyped_literal_suffix.rs:23:18\n+  --> $DIR/mistyped_literal_suffix.rs:27:18\n    |\n LL |     let fail25 = 1E2_32;\n    |                  ^^^^^^ help: did you mean to write: `1E2_f32`\n \n error: mistyped literal suffix\n-  --> $DIR/mistyped_literal_suffix.rs:24:18\n+  --> $DIR/mistyped_literal_suffix.rs:28:18\n    |\n LL |     let fail26 = 43E7_64;\n    |                  ^^^^^^^ help: did you mean to write: `43E7_f64`\n \n error: mistyped literal suffix\n-  --> $DIR/mistyped_literal_suffix.rs:25:18\n+  --> $DIR/mistyped_literal_suffix.rs:29:18\n    |\n LL |     let fail27 = 243E17_32;\n    |                  ^^^^^^^^^ help: did you mean to write: `243E17_f32`\n \n error: mistyped literal suffix\n-  --> $DIR/mistyped_literal_suffix.rs:26:18\n+  --> $DIR/mistyped_literal_suffix.rs:30:18\n    |\n LL |     let fail28 = 241251235E723_64;\n    |                  ^^^^^^^^^^^^^^^^ help: did you mean to write: `241_251_235E723_f64`\n \n error: mistyped literal suffix\n-  --> $DIR/mistyped_literal_suffix.rs:30:18\n+  --> $DIR/mistyped_literal_suffix.rs:34:18\n    |\n LL |     let fail30 = 127_8; // should be i8\n    |                  ^^^^^ help: did you mean to write: `127_i8`\n \n error: mistyped literal suffix\n-  --> $DIR/mistyped_literal_suffix.rs:31:18\n+  --> $DIR/mistyped_literal_suffix.rs:35:18\n    |\n LL |     let fail31 = 240_8; // should be u8\n    |                  ^^^^^ help: did you mean to write: `240_u8`\n \n error: mistyped literal suffix\n-  --> $DIR/mistyped_literal_suffix.rs:33:18\n+  --> $DIR/mistyped_literal_suffix.rs:37:18\n    |\n LL |     let fail33 = 0x1234_16;\n    |                  ^^^^^^^^^ help: did you mean to write: `0x1234_i16`\n \n error: mistyped literal suffix\n-  --> $DIR/mistyped_literal_suffix.rs:34:18\n+  --> $DIR/mistyped_literal_suffix.rs:38:18\n    |\n LL |     let fail34 = 0xABCD_16;\n    |                  ^^^^^^^^^ help: did you mean to write: `0xABCD_u16`\n \n error: mistyped literal suffix\n-  --> $DIR/mistyped_literal_suffix.rs:36:18\n+  --> $DIR/mistyped_literal_suffix.rs:40:18\n    |\n LL |     let fail36 = 0xFFFF_FFFF_FFFF_FFFF_64; // u64\n    |                  ^^^^^^^^^^^^^^^^^^^^^^^^ help: did you mean to write: `0xFFFF_FFFF_FFFF_FFFF_u64`\n \n error: mistyped literal suffix\n-  --> $DIR/mistyped_literal_suffix.rs:42:13\n+  --> $DIR/mistyped_literal_suffix.rs:46:13\n    |\n LL |     let _ = 1.12345E1_32;\n    |             ^^^^^^^^^^^^ help: did you mean to write: `1.123_45E1_f32`"}]}