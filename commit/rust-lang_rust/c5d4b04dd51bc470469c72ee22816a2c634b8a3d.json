{"sha": "c5d4b04dd51bc470469c72ee22816a2c634b8a3d", "node_id": "C_kwDOAAsO6NoAKGM1ZDRiMDRkZDUxYmM0NzA0NjljNzJlZTIyODE2YTJjNjM0YjhhM2Q", "commit": {"author": {"name": "Samuel \"Sam\" Tardieu", "email": "sam@rfc1149.net", "date": "2023-05-10T19:06:36Z"}, "committer": {"name": "Samuel \"Sam\" Tardieu", "email": "sam@rfc1149.net", "date": "2023-05-10T19:19:24Z"}, "message": "needless_bool: do not simplify code if it loses comments", "tree": {"sha": "9d080e9bec26b13f4d38d56dbff4b4707d179590", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9d080e9bec26b13f4d38d56dbff4b4707d179590"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c5d4b04dd51bc470469c72ee22816a2c634b8a3d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c5d4b04dd51bc470469c72ee22816a2c634b8a3d", "html_url": "https://github.com/rust-lang/rust/commit/c5d4b04dd51bc470469c72ee22816a2c634b8a3d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c5d4b04dd51bc470469c72ee22816a2c634b8a3d/comments", "author": {"login": "samueltardieu", "id": 44656, "node_id": "MDQ6VXNlcjQ0NjU2", "avatar_url": "https://avatars.githubusercontent.com/u/44656?v=4", "gravatar_id": "", "url": "https://api.github.com/users/samueltardieu", "html_url": "https://github.com/samueltardieu", "followers_url": "https://api.github.com/users/samueltardieu/followers", "following_url": "https://api.github.com/users/samueltardieu/following{/other_user}", "gists_url": "https://api.github.com/users/samueltardieu/gists{/gist_id}", "starred_url": "https://api.github.com/users/samueltardieu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/samueltardieu/subscriptions", "organizations_url": "https://api.github.com/users/samueltardieu/orgs", "repos_url": "https://api.github.com/users/samueltardieu/repos", "events_url": "https://api.github.com/users/samueltardieu/events{/privacy}", "received_events_url": "https://api.github.com/users/samueltardieu/received_events", "type": "User", "site_admin": false}, "committer": {"login": "samueltardieu", "id": 44656, "node_id": "MDQ6VXNlcjQ0NjU2", "avatar_url": "https://avatars.githubusercontent.com/u/44656?v=4", "gravatar_id": "", "url": "https://api.github.com/users/samueltardieu", "html_url": "https://github.com/samueltardieu", "followers_url": "https://api.github.com/users/samueltardieu/followers", "following_url": "https://api.github.com/users/samueltardieu/following{/other_user}", "gists_url": "https://api.github.com/users/samueltardieu/gists{/gist_id}", "starred_url": "https://api.github.com/users/samueltardieu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/samueltardieu/subscriptions", "organizations_url": "https://api.github.com/users/samueltardieu/orgs", "repos_url": "https://api.github.com/users/samueltardieu/repos", "events_url": "https://api.github.com/users/samueltardieu/events{/privacy}", "received_events_url": "https://api.github.com/users/samueltardieu/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1407c7627e91e8d4472749ac9ea45d9f8a3aaab6", "url": "https://api.github.com/repos/rust-lang/rust/commits/1407c7627e91e8d4472749ac9ea45d9f8a3aaab6", "html_url": "https://github.com/rust-lang/rust/commit/1407c7627e91e8d4472749ac9ea45d9f8a3aaab6"}], "stats": {"total": 43, "additions": 28, "deletions": 15}, "files": [{"sha": "62af42a3961f8383c1bd1e6dd203cdf66f788ab1", "filename": "clippy_lints/src/needless_bool.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/c5d4b04dd51bc470469c72ee22816a2c634b8a3d/clippy_lints%2Fsrc%2Fneedless_bool.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c5d4b04dd51bc470469c72ee22816a2c634b8a3d/clippy_lints%2Fsrc%2Fneedless_bool.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fneedless_bool.rs?ref=c5d4b04dd51bc470469c72ee22816a2c634b8a3d", "patch": "@@ -146,7 +146,7 @@ fn is_parent_stmt(cx: &LateContext<'_>, id: HirId) -> bool {\n impl<'tcx> LateLintPass<'tcx> for NeedlessBool {\n     fn check_expr(&mut self, cx: &LateContext<'tcx>, e: &'tcx Expr<'_>) {\n         use self::Expression::{Bool, RetBool};\n-        if e.span.from_expansion() {\n+        if e.span.from_expansion() || !span_extract_comment(cx.tcx.sess.source_map(), e.span).is_empty() {\n             return;\n         }\n         if let Some(higher::If {\n@@ -209,8 +209,7 @@ impl<'tcx> LateLintPass<'tcx> for NeedlessBool {\n             }\n             if let Some((lhs_a, a)) = fetch_assign(then) &&\n                 let Some((lhs_b, b)) = fetch_assign(r#else) &&\n-                SpanlessEq::new(cx).eq_expr(lhs_a, lhs_b) &&\n-                span_extract_comment(cx.tcx.sess.source_map(), e.span).is_empty()\n+                SpanlessEq::new(cx).eq_expr(lhs_a, lhs_b)\n             {\n                 let mut applicability = Applicability::MachineApplicable;\n                 let cond = Sugg::hir_with_applicability(cx, cond, \"..\", &mut applicability);"}, {"sha": "bf1911881c8a9434e5c6086edf60ea338da4547d", "filename": "tests/ui/needless_bool/fixable.fixed", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/c5d4b04dd51bc470469c72ee22816a2c634b8a3d/tests%2Fui%2Fneedless_bool%2Ffixable.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/c5d4b04dd51bc470469c72ee22816a2c634b8a3d/tests%2Fui%2Fneedless_bool%2Ffixable.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fneedless_bool%2Ffixable.fixed?ref=c5d4b04dd51bc470469c72ee22816a2c634b8a3d", "patch": "@@ -63,6 +63,13 @@ fn main() {\n     needless_bool2(x);\n     needless_bool3(x);\n     needless_bool_condition();\n+\n+    if a == b {\n+        true\n+    } else {\n+        // Do not lint as this comment might be important\n+        false\n+    };\n }\n \n fn bool_ret3(x: bool) -> bool {"}, {"sha": "a6c465d4fbd11c16b41cde966c0757a0a104d402", "filename": "tests/ui/needless_bool/fixable.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/c5d4b04dd51bc470469c72ee22816a2c634b8a3d/tests%2Fui%2Fneedless_bool%2Ffixable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c5d4b04dd51bc470469c72ee22816a2c634b8a3d/tests%2Fui%2Fneedless_bool%2Ffixable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fneedless_bool%2Ffixable.rs?ref=c5d4b04dd51bc470469c72ee22816a2c634b8a3d", "patch": "@@ -99,6 +99,13 @@ fn main() {\n     needless_bool2(x);\n     needless_bool3(x);\n     needless_bool_condition();\n+\n+    if a == b {\n+        true\n+    } else {\n+        // Do not lint as this comment might be important\n+        false\n+    };\n }\n \n fn bool_ret3(x: bool) -> bool {"}, {"sha": "fa906374fb3ba1d503a4cddf469e967e672e5c6b", "filename": "tests/ui/needless_bool/fixable.stderr", "status": "modified", "additions": 12, "deletions": 12, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/c5d4b04dd51bc470469c72ee22816a2c634b8a3d/tests%2Fui%2Fneedless_bool%2Ffixable.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c5d4b04dd51bc470469c72ee22816a2c634b8a3d/tests%2Fui%2Fneedless_bool%2Ffixable.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fneedless_bool%2Ffixable.stderr?ref=c5d4b04dd51bc470469c72ee22816a2c634b8a3d", "patch": "@@ -91,7 +91,7 @@ LL | |     };\n    | |_____^ help: you can reduce it to: `a < b`\n \n error: this if-then-else expression returns a bool literal\n-  --> $DIR/fixable.rs:105:5\n+  --> $DIR/fixable.rs:112:5\n    |\n LL | /     if x {\n LL | |         return true;\n@@ -101,7 +101,7 @@ LL | |     };\n    | |_____^ help: you can reduce it to: `return x`\n \n error: this if-then-else expression returns a bool literal\n-  --> $DIR/fixable.rs:113:5\n+  --> $DIR/fixable.rs:120:5\n    |\n LL | /     if x {\n LL | |         return false;\n@@ -111,7 +111,7 @@ LL | |     };\n    | |_____^ help: you can reduce it to: `return !x`\n \n error: this if-then-else expression returns a bool literal\n-  --> $DIR/fixable.rs:121:5\n+  --> $DIR/fixable.rs:128:5\n    |\n LL | /     if x && y {\n LL | |         return true;\n@@ -121,7 +121,7 @@ LL | |     };\n    | |_____^ help: you can reduce it to: `return x && y`\n \n error: this if-then-else expression returns a bool literal\n-  --> $DIR/fixable.rs:129:5\n+  --> $DIR/fixable.rs:136:5\n    |\n LL | /     if x && y {\n LL | |         return false;\n@@ -131,33 +131,33 @@ LL | |     };\n    | |_____^ help: you can reduce it to: `return !(x && y)`\n \n error: equality checks against true are unnecessary\n-  --> $DIR/fixable.rs:137:8\n+  --> $DIR/fixable.rs:144:8\n    |\n LL |     if x == true {};\n    |        ^^^^^^^^^ help: try simplifying it as shown: `x`\n    |\n    = note: `-D clippy::bool-comparison` implied by `-D warnings`\n \n error: equality checks against false can be replaced by a negation\n-  --> $DIR/fixable.rs:141:8\n+  --> $DIR/fixable.rs:148:8\n    |\n LL |     if x == false {};\n    |        ^^^^^^^^^^ help: try simplifying it as shown: `!x`\n \n error: equality checks against true are unnecessary\n-  --> $DIR/fixable.rs:151:8\n+  --> $DIR/fixable.rs:158:8\n    |\n LL |     if x == true {};\n    |        ^^^^^^^^^ help: try simplifying it as shown: `x`\n \n error: equality checks against false can be replaced by a negation\n-  --> $DIR/fixable.rs:152:8\n+  --> $DIR/fixable.rs:159:8\n    |\n LL |     if x == false {};\n    |        ^^^^^^^^^^ help: try simplifying it as shown: `!x`\n \n error: this if-then-else expression returns a bool literal\n-  --> $DIR/fixable.rs:161:12\n+  --> $DIR/fixable.rs:168:12\n    |\n LL |       } else if returns_bool() {\n    |  ____________^\n@@ -168,7 +168,7 @@ LL | |     };\n    | |_____^ help: you can reduce it to: `{ !returns_bool() }`\n \n error: this if-then-else expression returns a bool literal\n-  --> $DIR/fixable.rs:174:5\n+  --> $DIR/fixable.rs:181:5\n    |\n LL | /     if unsafe { no(4) } & 1 != 0 {\n LL | |         true\n@@ -178,13 +178,13 @@ LL | |     };\n    | |_____^ help: you can reduce it to: `(unsafe { no(4) } & 1 != 0)`\n \n error: this if-then-else expression returns a bool literal\n-  --> $DIR/fixable.rs:179:30\n+  --> $DIR/fixable.rs:186:30\n    |\n LL |     let _brackets_unneeded = if unsafe { no(4) } & 1 != 0 { true } else { false };\n    |                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: you can reduce it to: `unsafe { no(4) } & 1 != 0`\n \n error: this if-then-else expression returns a bool literal\n-  --> $DIR/fixable.rs:182:9\n+  --> $DIR/fixable.rs:189:9\n    |\n LL |         if unsafe { no(4) } & 1 != 0 { true } else { false }\n    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: you can reduce it to: `(unsafe { no(4) } & 1 != 0)`"}]}