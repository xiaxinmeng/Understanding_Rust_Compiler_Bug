{"sha": "2f611da1d66ae98b53358bcb7739884524b7e18d", "node_id": "MDY6Q29tbWl0NzI0NzEyOjJmNjExZGExZDY2YWU5OGI1MzM1OGJjYjc3Mzk4ODQ1MjRiN2UxOGQ=", "commit": {"author": {"name": "Dylan DPC", "email": "dylan.dpc@gmail.com", "date": "2021-03-24T00:52:28Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-03-24T00:52:28Z"}, "message": "Rollup merge of #83313 - cjgillot:assert, r=michaelwoerister\n\nOnly enable assert_dep_graph when query-dep-graph is enabled.\n\nThis is a debugging option. The only effect should be on rustc tests.\n\nr? ``@michaelwoerister``", "tree": {"sha": "1d50eac4a06f1667e6eb2f16f2a49437802b1880", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1d50eac4a06f1667e6eb2f16f2a49437802b1880"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2f611da1d66ae98b53358bcb7739884524b7e18d", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgWo1MCRBK7hj4Ov3rIwAAdHIIAERe938DkotIfF66cdKsHdc5\nTudlae/0t4wGa8ZV7zP2xio942h1z8HsZ6K3LLLW8Hp+SLr+VLOLPL3lfpNPqTzX\nS4sq4DEVSIlQ4iLTDJZ26FjbCfeRSzNxUDkGnD9WY6OM3VM7z9XK4fTRT0jKt5Oi\nqhaaXgIrflD4TrXd/x/o71boFi74ruxFCpFIDKAbqQ+YryDmZocnqWJntygCCMBP\nEF6JreacOE1ofszsyJ9b4btVxiJlQHgdhhOcg7DGBJr0n+cqC0tDOmyEbjZltEVE\nDteQBgZQiU7IjXac1WOcqJd130ch3eG8bM3isjwQZbTV4/y8z75VV9/2PTMMM7M=\n=Ao3Y\n-----END PGP SIGNATURE-----\n", "payload": "tree 1d50eac4a06f1667e6eb2f16f2a49437802b1880\nparent f134ca3864f8c66d6dd01e576ce9b0125eb58210\nparent 31447f6f087e2654d2927f04488303500bec3280\nauthor Dylan DPC <dylan.dpc@gmail.com> 1616547148 +0100\ncommitter GitHub <noreply@github.com> 1616547148 +0100\n\nRollup merge of #83313 - cjgillot:assert, r=michaelwoerister\n\nOnly enable assert_dep_graph when query-dep-graph is enabled.\n\nThis is a debugging option. The only effect should be on rustc tests.\n\nr? ``@michaelwoerister``\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2f611da1d66ae98b53358bcb7739884524b7e18d", "html_url": "https://github.com/rust-lang/rust/commit/2f611da1d66ae98b53358bcb7739884524b7e18d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2f611da1d66ae98b53358bcb7739884524b7e18d/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f134ca3864f8c66d6dd01e576ce9b0125eb58210", "url": "https://api.github.com/repos/rust-lang/rust/commits/f134ca3864f8c66d6dd01e576ce9b0125eb58210", "html_url": "https://github.com/rust-lang/rust/commit/f134ca3864f8c66d6dd01e576ce9b0125eb58210"}, {"sha": "31447f6f087e2654d2927f04488303500bec3280", "url": "https://api.github.com/repos/rust-lang/rust/commits/31447f6f087e2654d2927f04488303500bec3280", "html_url": "https://github.com/rust-lang/rust/commit/31447f6f087e2654d2927f04488303500bec3280"}], "stats": {"total": 78, "additions": 77, "deletions": 1}, "files": [{"sha": "a080b0ce3395c71af79e5e4e9c095d86b65fb298", "filename": "compiler/rustc_incremental/src/assert_dep_graph.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/2f611da1d66ae98b53358bcb7739884524b7e18d/compiler%2Frustc_incremental%2Fsrc%2Fassert_dep_graph.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f611da1d66ae98b53358bcb7739884524b7e18d/compiler%2Frustc_incremental%2Fsrc%2Fassert_dep_graph.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_incremental%2Fsrc%2Fassert_dep_graph.rs?ref=2f611da1d66ae98b53358bcb7739884524b7e18d", "patch": "@@ -57,6 +57,10 @@ pub fn assert_dep_graph(tcx: TyCtxt<'_>) {\n             dump_graph(tcx);\n         }\n \n+        if !tcx.sess.opts.debugging_opts.query_dep_graph {\n+            return;\n+        }\n+\n         // if the `rustc_attrs` feature is not enabled, then the\n         // attributes we are interested in cannot be present anyway, so\n         // skip the walk."}, {"sha": "cb089a728eee0201dc8dd4d10f22ef40697459c4", "filename": "compiler/rustc_incremental/src/persist/dirty_clean.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/2f611da1d66ae98b53358bcb7739884524b7e18d/compiler%2Frustc_incremental%2Fsrc%2Fpersist%2Fdirty_clean.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f611da1d66ae98b53358bcb7739884524b7e18d/compiler%2Frustc_incremental%2Fsrc%2Fpersist%2Fdirty_clean.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_incremental%2Fsrc%2Fpersist%2Fdirty_clean.rs?ref=2f611da1d66ae98b53358bcb7739884524b7e18d", "patch": "@@ -148,6 +148,10 @@ impl Assertion {\n }\n \n pub fn check_dirty_clean_annotations(tcx: TyCtxt<'_>) {\n+    if !tcx.sess.opts.debugging_opts.query_dep_graph {\n+        return;\n+    }\n+\n     // can't add `#[rustc_dirty]` etc without opting in to this feature\n     if !tcx.features().rustc_attrs {\n         return;"}, {"sha": "85add83f88bf72f734b99be2c04929b4624ad933", "filename": "compiler/rustc_passes/src/check_attr.rs", "status": "modified", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/2f611da1d66ae98b53358bcb7739884524b7e18d/compiler%2Frustc_passes%2Fsrc%2Fcheck_attr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f611da1d66ae98b53358bcb7739884524b7e18d/compiler%2Frustc_passes%2Fsrc%2Fcheck_attr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fcheck_attr.rs?ref=2f611da1d66ae98b53358bcb7739884524b7e18d", "patch": "@@ -99,6 +99,12 @@ impl CheckAttrVisitor<'tcx> {\n                 self.check_naked(hir_id, attr, span, target)\n             } else if self.tcx.sess.check_name(attr, sym::rustc_legacy_const_generics) {\n                 self.check_rustc_legacy_const_generics(&attr, span, target, item)\n+            } else if self.tcx.sess.check_name(attr, sym::rustc_clean)\n+                || self.tcx.sess.check_name(attr, sym::rustc_dirty)\n+                || self.tcx.sess.check_name(attr, sym::rustc_if_this_changed)\n+                || self.tcx.sess.check_name(attr, sym::rustc_then_this_would_need)\n+            {\n+                self.check_rustc_dirty_clean(&attr)\n             } else {\n                 // lint-only checks\n                 if self.tcx.sess.check_name(attr, sym::cold) {\n@@ -1012,6 +1018,20 @@ impl CheckAttrVisitor<'tcx> {\n         }\n     }\n \n+    /// Checks that the dep-graph debugging attributes are only present when the query-dep-graph\n+    /// option is passed to the compiler.\n+    fn check_rustc_dirty_clean(&self, attr: &Attribute) -> bool {\n+        if self.tcx.sess.opts.debugging_opts.query_dep_graph {\n+            true\n+        } else {\n+            self.tcx\n+                .sess\n+                .struct_span_err(attr.span, \"attribute requires -Z query-dep-graph to be enabled\")\n+                .emit();\n+            false\n+        }\n+    }\n+\n     /// Checks if `#[link_section]` is applied to a function or static.\n     fn check_link_section(&self, hir_id: HirId, attr: &Attribute, span: &Span, target: Target) {\n         match target {"}, {"sha": "4f5f6169f36bf6d4d60ade5f535a12f525759aed", "filename": "src/test/incremental/ich_nested_items.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/2f611da1d66ae98b53358bcb7739884524b7e18d/src%2Ftest%2Fincremental%2Fich_nested_items.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f611da1d66ae98b53358bcb7739884524b7e18d/src%2Ftest%2Fincremental%2Fich_nested_items.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fincremental%2Fich_nested_items.rs?ref=2f611da1d66ae98b53358bcb7739884524b7e18d", "patch": "@@ -3,6 +3,7 @@\n \n // revisions: cfail1 cfail2\n // build-pass (FIXME(62277): could be check-pass?)\n+// compile-flags: -Z query-dep-graph\n \n #![crate_type = \"rlib\"]\n #![feature(rustc_attrs)]"}, {"sha": "1fb0f8aa84d11245360575117a4826cf275c64c5", "filename": "src/test/incremental/ich_resolve_results.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/2f611da1d66ae98b53358bcb7739884524b7e18d/src%2Ftest%2Fincremental%2Fich_resolve_results.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f611da1d66ae98b53358bcb7739884524b7e18d/src%2Ftest%2Fincremental%2Fich_resolve_results.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fincremental%2Fich_resolve_results.rs?ref=2f611da1d66ae98b53358bcb7739884524b7e18d", "patch": "@@ -2,6 +2,7 @@\n // `use` to something different.\n \n // revisions: rpass1 rpass2 rpass3\n+// compile-flags: -Z query-dep-graph\n \n #![feature(rustc_attrs)]\n "}, {"sha": "37728af95164f4861bea8b6d6cc5878dfd4bf6b0", "filename": "src/test/incremental/spans_significant_w_panic.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/2f611da1d66ae98b53358bcb7739884524b7e18d/src%2Ftest%2Fincremental%2Fspans_significant_w_panic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f611da1d66ae98b53358bcb7739884524b7e18d/src%2Ftest%2Fincremental%2Fspans_significant_w_panic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fincremental%2Fspans_significant_w_panic.rs?ref=2f611da1d66ae98b53358bcb7739884524b7e18d", "patch": "@@ -3,7 +3,7 @@\n \n // revisions:rpass1 rpass2\n \n-// compile-flags: -C overflow-checks=on\n+// compile-flags: -C overflow-checks=on -Z query-dep-graph\n \n #![feature(rustc_attrs)]\n "}, {"sha": "1026efc1b1dbe15e51d8af4eeb21ae9c4354bd15", "filename": "src/test/ui/dep-graph/dep-graph-check-attr.rs", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/2f611da1d66ae98b53358bcb7739884524b7e18d/src%2Ftest%2Fui%2Fdep-graph%2Fdep-graph-check-attr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f611da1d66ae98b53358bcb7739884524b7e18d/src%2Ftest%2Fui%2Fdep-graph%2Fdep-graph-check-attr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fdep-graph%2Fdep-graph-check-attr.rs?ref=2f611da1d66ae98b53358bcb7739884524b7e18d", "patch": "@@ -0,0 +1,20 @@\n+// Test that using rustc_clean/dirty/if_this_changed/then_this_would_need\n+// are forbidden when `-Z query-dep-graph` is not enabled.\n+\n+#![feature(rustc_attrs)]\n+#![allow(dead_code)]\n+#![allow(unused_variables)]\n+\n+#[rustc_dirty(hir_owner)] //~ ERROR attribute requires -Z query-dep-graph\n+fn main() {}\n+\n+#[rustc_if_this_changed(hir_owner)] //~ ERROR attribute requires -Z query-dep-graph\n+struct Foo<T> {\n+    f: T,\n+}\n+\n+#[rustc_clean(hir_owner)] //~ ERROR attribute requires -Z query-dep-graph\n+type TypeAlias<T> = Foo<T>;\n+\n+#[rustc_then_this_would_need(variances_of)] //~ ERROR attribute requires -Z query-dep-graph\n+trait Use<T> {}"}, {"sha": "945a4237c1298380e88cc2f0287f58e8cb9470a3", "filename": "src/test/ui/dep-graph/dep-graph-check-attr.stderr", "status": "added", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/2f611da1d66ae98b53358bcb7739884524b7e18d/src%2Ftest%2Fui%2Fdep-graph%2Fdep-graph-check-attr.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2f611da1d66ae98b53358bcb7739884524b7e18d/src%2Ftest%2Fui%2Fdep-graph%2Fdep-graph-check-attr.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fdep-graph%2Fdep-graph-check-attr.stderr?ref=2f611da1d66ae98b53358bcb7739884524b7e18d", "patch": "@@ -0,0 +1,26 @@\n+error: attribute requires -Z query-dep-graph to be enabled\n+  --> $DIR/dep-graph-check-attr.rs:8:1\n+   |\n+LL | #[rustc_dirty(hir_owner)]\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: attribute requires -Z query-dep-graph to be enabled\n+  --> $DIR/dep-graph-check-attr.rs:11:1\n+   |\n+LL | #[rustc_if_this_changed(hir_owner)]\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: attribute requires -Z query-dep-graph to be enabled\n+  --> $DIR/dep-graph-check-attr.rs:16:1\n+   |\n+LL | #[rustc_clean(hir_owner)]\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: attribute requires -Z query-dep-graph to be enabled\n+  --> $DIR/dep-graph-check-attr.rs:19:1\n+   |\n+LL | #[rustc_then_this_would_need(variances_of)]\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: aborting due to 4 previous errors\n+"}]}