{"sha": "02e2a57f262256fda9a8e3c89cfb18fe6b64ee01", "node_id": "MDY6Q29tbWl0NzI0NzEyOjAyZTJhNTdmMjYyMjU2ZmRhOWE4ZTNjODljZmIxOGZlNmI2NGVlMDE=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2019-08-14T20:56:24Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-08-14T20:56:24Z"}, "message": "Rollup merge of #63509 - estebank:async-span, r=Centril\n\nPoint at the right enclosing scope when using `await` in non-async fn\n\nFix #63398.", "tree": {"sha": "053fbbf777a5263ad6ec504b631fd64919ab0b53", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/053fbbf777a5263ad6ec504b631fd64919ab0b53"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/02e2a57f262256fda9a8e3c89cfb18fe6b64ee01", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJdVHV4CRBK7hj4Ov3rIwAAdHIIADMLou2ifJfgbmgT85VmSWm2\nFM7YExBkNtrxZ3mXiuE13c4TpmgNBNHpYdinCkToz/C8Y2mEwv1gYOiObjgA5uHM\nIP73Y2P0nR4sPEx0orcIhT1ezoCZUKxt+Bn3vRpRwwQUMgbxXTmtH2G9UIgMxwB2\nrFRnc11Ymc6223JJVRh330SLEJ+MnUpMkwlBkxc9A5jlGCdTysq/Q+CV7m+rMprz\n4KW+N2+g9zIlGHxqIS0XFa9Iq00iZiyRpO6s71bkac1dWdRM8AG1mFkVYQnEj8D0\njH0HxiXYQSslTbpmT7pn65213JdkoyX+FYCkeJS62QjqWlZdvbB2ir3znOyA9sw=\n=Y7Uz\n-----END PGP SIGNATURE-----\n", "payload": "tree 053fbbf777a5263ad6ec504b631fd64919ab0b53\nparent d2d49d238f66ad3e9aea12d2cdac8f4bc2af4ce9\nparent 25d507f497885cd26f1dba8c8e8158c12d02bd6c\nauthor Mazdak Farrokhzad <twingoow@gmail.com> 1565816184 +0200\ncommitter GitHub <noreply@github.com> 1565816184 +0200\n\nRollup merge of #63509 - estebank:async-span, r=Centril\n\nPoint at the right enclosing scope when using `await` in non-async fn\n\nFix #63398.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/02e2a57f262256fda9a8e3c89cfb18fe6b64ee01", "html_url": "https://github.com/rust-lang/rust/commit/02e2a57f262256fda9a8e3c89cfb18fe6b64ee01", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/02e2a57f262256fda9a8e3c89cfb18fe6b64ee01/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d2d49d238f66ad3e9aea12d2cdac8f4bc2af4ce9", "url": "https://api.github.com/repos/rust-lang/rust/commits/d2d49d238f66ad3e9aea12d2cdac8f4bc2af4ce9", "html_url": "https://github.com/rust-lang/rust/commit/d2d49d238f66ad3e9aea12d2cdac8f4bc2af4ce9"}, {"sha": "25d507f497885cd26f1dba8c8e8158c12d02bd6c", "url": "https://api.github.com/repos/rust-lang/rust/commits/25d507f497885cd26f1dba8c8e8158c12d02bd6c", "html_url": "https://github.com/rust-lang/rust/commit/25d507f497885cd26f1dba8c8e8158c12d02bd6c"}], "stats": {"total": 28, "additions": 27, "deletions": 1}, "files": [{"sha": "e3a5400942d1a625363e06698b7654f77d340c1c", "filename": "src/librustc/hir/lowering/expr.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/02e2a57f262256fda9a8e3c89cfb18fe6b64ee01/src%2Flibrustc%2Fhir%2Flowering%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/02e2a57f262256fda9a8e3c89cfb18fe6b64ee01/src%2Flibrustc%2Fhir%2Flowering%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fhir%2Flowering%2Fexpr.rs?ref=02e2a57f262256fda9a8e3c89cfb18fe6b64ee01", "patch": "@@ -677,6 +677,7 @@ impl LoweringContext<'_> {\n         let fn_decl = self.lower_fn_decl(decl, None, false, None);\n \n         self.with_new_scopes(|this| {\n+            let prev = this.current_item;\n             this.current_item = Some(fn_decl_span);\n             let mut generator_kind = None;\n             let body_id = this.lower_fn_body(decl, |this| {\n@@ -690,8 +691,10 @@ impl LoweringContext<'_> {\n                 generator_kind,\n                 movability,\n             );\n+            let capture_clause = this.lower_capture_clause(capture_clause);\n+            this.current_item = prev;\n             hir::ExprKind::Closure(\n-                this.lower_capture_clause(capture_clause),\n+                capture_clause,\n                 fn_decl,\n                 body_id,\n                 fn_decl_span,"}, {"sha": "838911d9b6e8fc88ee845b805cabcdf7057f1026", "filename": "src/test/ui/async-await/issues/non-async-enclosing-span.rs", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/02e2a57f262256fda9a8e3c89cfb18fe6b64ee01/src%2Ftest%2Fui%2Fasync-await%2Fissues%2Fnon-async-enclosing-span.rs", "raw_url": "https://github.com/rust-lang/rust/raw/02e2a57f262256fda9a8e3c89cfb18fe6b64ee01/src%2Ftest%2Fui%2Fasync-await%2Fissues%2Fnon-async-enclosing-span.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasync-await%2Fissues%2Fnon-async-enclosing-span.rs?ref=02e2a57f262256fda9a8e3c89cfb18fe6b64ee01", "patch": "@@ -0,0 +1,12 @@\n+// edition:2018\n+#![feature(async_await)]\n+\n+async fn do_the_thing() -> u8 {\n+    8\n+}\n+// #63398: point at the enclosing scope and not the previously seen closure\n+fn main() {  //~ NOTE this is not `async`\n+    let x = move || {};\n+    let y = do_the_thing().await; //~ ERROR `await` is only allowed inside `async` functions\n+    //~^ NOTE only allowed inside `async` functions and blocks\n+}"}, {"sha": "f492c1a8045b53892c8ef0fa9c28cef2e9cd906d", "filename": "src/test/ui/async-await/issues/non-async-enclosing-span.stderr", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/02e2a57f262256fda9a8e3c89cfb18fe6b64ee01/src%2Ftest%2Fui%2Fasync-await%2Fissues%2Fnon-async-enclosing-span.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/02e2a57f262256fda9a8e3c89cfb18fe6b64ee01/src%2Ftest%2Fui%2Fasync-await%2Fissues%2Fnon-async-enclosing-span.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasync-await%2Fissues%2Fnon-async-enclosing-span.stderr?ref=02e2a57f262256fda9a8e3c89cfb18fe6b64ee01", "patch": "@@ -0,0 +1,11 @@\n+error[E0728]: `await` is only allowed inside `async` functions and blocks\n+  --> $DIR/non-async-enclosing-span.rs:10:13\n+   |\n+LL | fn main() {\n+   |    ---- this is not `async`\n+LL |     let x = move || {};\n+LL |     let y = do_the_thing().await;\n+   |             ^^^^^^^^^^^^^^^^^^^^ only allowed inside `async` functions and blocks\n+\n+error: aborting due to previous error\n+"}]}