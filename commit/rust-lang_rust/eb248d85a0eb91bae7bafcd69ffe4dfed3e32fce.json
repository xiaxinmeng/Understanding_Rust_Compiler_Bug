{"sha": "eb248d85a0eb91bae7bafcd69ffe4dfed3e32fce", "node_id": "MDY6Q29tbWl0NzI0NzEyOmViMjQ4ZDg1YTBlYjkxYmFlN2JhZmNkNjlmZmU0ZGZlZDNlMzJmY2U=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-04-07T15:58:22Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-04-07T15:58:22Z"}, "message": "Merge #8402\n\n8402: Remove Ty::substs{_mut} r=flodiebold a=flodiebold\n\nAlmost all uses actually only care about ADT substs, so it's better to be explicit. The methods were a bad abstraction anyway since they already didn't include the inner types of e.g. `TyKind::Ref` anymore.\n\nCo-authored-by: Florian Diebold <flodiebold@gmail.com>", "tree": {"sha": "ad4255c4ba560c9e2d4fd0f404e91cfd1e71234b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ad4255c4ba560c9e2d4fd0f404e91cfd1e71234b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/eb248d85a0eb91bae7bafcd69ffe4dfed3e32fce", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgbdaeCRBK7hj4Ov3rIwAAdHIIAKq4LxKltOQykydFlnh1c5h0\nNAOUWCXGoAqroHCCnf1n8DSVtGSoiqQ4my4p0nwGpycPz6zPAATDBG42Id/Muqw4\n4iaYJd+F1+70s1c/EC/jXInWqjxhirHeTRjR1EMohUn79VFiFr6A3ZWfsqeuPZjS\nHbv7sZALLFVmlCDfgYuQ6mVuat6HbYRpGQ7iAIwrjUk88E4DqCCyZsUXQSJsV1kl\nPmoAhzUj7pGwpA0KR2aj843j7eTLBVdTJdNK1vtK875dcDGwzX1pjuMnbOJoqGPG\nqR/jcehIf7z8zz+zWkEIMiJw6Fb6CL7wsNiw2/vSNydlQrpRdsQYSTlmAeiqJ6s=\n=gm/4\n-----END PGP SIGNATURE-----\n", "payload": "tree ad4255c4ba560c9e2d4fd0f404e91cfd1e71234b\nparent 062c8eb7cacb38a550889201aaa8b633ede29bb2\nparent 92dcc53f94455e8933d76a8ba20642ceb069362d\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1617811102 +0000\ncommitter GitHub <noreply@github.com> 1617811102 +0000\n\nMerge #8402\n\n8402: Remove Ty::substs{_mut} r=flodiebold a=flodiebold\n\nAlmost all uses actually only care about ADT substs, so it's better to be explicit. The methods were a bad abstraction anyway since they already didn't include the inner types of e.g. `TyKind::Ref` anymore.\n\nCo-authored-by: Florian Diebold <flodiebold@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/eb248d85a0eb91bae7bafcd69ffe4dfed3e32fce", "html_url": "https://github.com/rust-lang/rust/commit/eb248d85a0eb91bae7bafcd69ffe4dfed3e32fce", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/eb248d85a0eb91bae7bafcd69ffe4dfed3e32fce/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "062c8eb7cacb38a550889201aaa8b633ede29bb2", "url": "https://api.github.com/repos/rust-lang/rust/commits/062c8eb7cacb38a550889201aaa8b633ede29bb2", "html_url": "https://github.com/rust-lang/rust/commit/062c8eb7cacb38a550889201aaa8b633ede29bb2"}, {"sha": "92dcc53f94455e8933d76a8ba20642ceb069362d", "url": "https://api.github.com/repos/rust-lang/rust/commits/92dcc53f94455e8933d76a8ba20642ceb069362d", "html_url": "https://github.com/rust-lang/rust/commit/92dcc53f94455e8933d76a8ba20642ceb069362d"}], "stats": {"total": 97, "additions": 45, "deletions": 52}, "files": [{"sha": "13aaa408a2c177f69636005cff743570733ffaee", "filename": "crates/hir/src/lib.rs", "status": "modified", "additions": 18, "deletions": 8, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/eb248d85a0eb91bae7bafcd69ffe4dfed3e32fce/crates%2Fhir%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eb248d85a0eb91bae7bafcd69ffe4dfed3e32fce/crates%2Fhir%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir%2Fsrc%2Flib.rs?ref=eb248d85a0eb91bae7bafcd69ffe4dfed3e32fce", "patch": "@@ -1972,9 +1972,9 @@ impl Type {\n     pub fn type_parameters(&self) -> impl Iterator<Item = Type> + '_ {\n         self.ty\n             .strip_references()\n-            .substs()\n+            .as_adt()\n             .into_iter()\n-            .flat_map(|substs| substs.iter(&Interner))\n+            .flat_map(|(_, substs)| substs.iter(&Interner))\n             .filter_map(|arg| arg.ty(&Interner).cloned())\n             .map(move |ty| self.derived(ty))\n     }\n@@ -2115,18 +2115,22 @@ impl Type {\n         fn walk_type(db: &dyn HirDatabase, type_: &Type, cb: &mut impl FnMut(Type)) {\n             let ty = type_.ty.strip_references();\n             match ty.kind(&Interner) {\n-                TyKind::Adt(..) => {\n+                TyKind::Adt(_, substs) => {\n                     cb(type_.derived(ty.clone()));\n+                    walk_substs(db, type_, &substs, cb);\n                 }\n-                TyKind::AssociatedType(..) => {\n+                TyKind::AssociatedType(_, substs) => {\n                     if let Some(_) = ty.associated_type_parent_trait(db) {\n                         cb(type_.derived(ty.clone()));\n                     }\n+                    walk_substs(db, type_, &substs, cb);\n                 }\n-                TyKind::OpaqueType(..) => {\n+                TyKind::OpaqueType(_, subst) => {\n                     if let Some(bounds) = ty.impl_trait_bounds(db) {\n                         walk_bounds(db, &type_.derived(ty.clone()), &bounds, cb);\n                     }\n+\n+                    walk_substs(db, type_, subst, cb);\n                 }\n                 TyKind::Alias(AliasTy::Opaque(opaque_ty)) => {\n                     if let Some(bounds) = ty.impl_trait_bounds(db) {\n@@ -2156,11 +2160,17 @@ impl Type {\n                     walk_type(db, &type_.derived(ty.clone()), cb);\n                 }\n \n+                TyKind::FnDef(_, substs)\n+                | TyKind::Tuple(_, substs)\n+                | TyKind::Closure(.., substs) => {\n+                    walk_substs(db, type_, &substs, cb);\n+                }\n+                TyKind::Function(hir_ty::FnPointer { substitution, .. }) => {\n+                    walk_substs(db, type_, &substitution.0, cb);\n+                }\n+\n                 _ => {}\n             }\n-            if let Some(substs) = ty.substs() {\n-                walk_substs(db, type_, &substs, cb);\n-            }\n         }\n \n         walk_type(db, self, &mut cb);"}, {"sha": "847d2537d2f05f73c5f41f11737df9507907dcdd", "filename": "crates/hir/src/source_analyzer.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/eb248d85a0eb91bae7bafcd69ffe4dfed3e32fce/crates%2Fhir%2Fsrc%2Fsource_analyzer.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eb248d85a0eb91bae7bafcd69ffe4dfed3e32fce/crates%2Fhir%2Fsrc%2Fsource_analyzer.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir%2Fsrc%2Fsource_analyzer.rs?ref=eb248d85a0eb91bae7bafcd69ffe4dfed3e32fce", "patch": "@@ -20,7 +20,7 @@ use hir_def::{\n use hir_expand::{hygiene::Hygiene, name::AsName, HirFileId, InFile};\n use hir_ty::{\n     diagnostics::{record_literal_missing_fields, record_pattern_missing_fields},\n-    InferenceResult, Interner, Substitution, TyLoweringContext,\n+    InferenceResult, Interner, Substitution, TyExt, TyLoweringContext,\n };\n use syntax::{\n     ast::{self, AstNode},\n@@ -306,7 +306,7 @@ impl SourceAnalyzer {\n         let infer = self.infer.as_ref()?;\n \n         let expr_id = self.expr_id(db, &literal.clone().into())?;\n-        let substs = infer.type_of_expr[expr_id].substs()?;\n+        let substs = infer.type_of_expr[expr_id].as_adt()?.1;\n \n         let (variant, missing_fields, _exhaustive) =\n             record_literal_missing_fields(db, infer, expr_id, &body[expr_id])?;\n@@ -324,7 +324,7 @@ impl SourceAnalyzer {\n         let infer = self.infer.as_ref()?;\n \n         let pat_id = self.pat_id(&pattern.clone().into())?;\n-        let substs = infer.type_of_pat[pat_id].substs()?;\n+        let substs = infer.type_of_pat[pat_id].as_adt()?.1;\n \n         let (variant, missing_fields, _exhaustive) =\n             record_pattern_missing_fields(db, infer, pat_id, &body[pat_id])?;"}, {"sha": "9841988c55f9c3fe564740c12c273b3bb1069d40", "filename": "crates/hir_ty/src/infer/expr.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/eb248d85a0eb91bae7bafcd69ffe4dfed3e32fce/crates%2Fhir_ty%2Fsrc%2Finfer%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eb248d85a0eb91bae7bafcd69ffe4dfed3e32fce/crates%2Fhir_ty%2Fsrc%2Finfer%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Finfer%2Fexpr.rs?ref=eb248d85a0eb91bae7bafcd69ffe4dfed3e32fce", "patch": "@@ -412,7 +412,10 @@ impl<'a> InferenceContext<'a> {\n \n                 self.unify(&ty, &expected.ty);\n \n-                let substs = ty.substs().cloned().unwrap_or_else(|| Substitution::empty(&Interner));\n+                let substs = ty\n+                    .as_adt()\n+                    .map(|(_, s)| s.clone())\n+                    .unwrap_or_else(|| Substitution::empty(&Interner));\n                 let field_types = def_id.map(|it| self.db.field_types(it)).unwrap_or_default();\n                 let variant_data = def_id.map(|it| it.variant_data(self.db.upcast()));\n                 for field in fields.iter() {"}, {"sha": "f88d5c5d343c2cb02c1b1dfdf4cafe0604d91a2a", "filename": "crates/hir_ty/src/infer/pat.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/eb248d85a0eb91bae7bafcd69ffe4dfed3e32fce/crates%2Fhir_ty%2Fsrc%2Finfer%2Fpat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eb248d85a0eb91bae7bafcd69ffe4dfed3e32fce/crates%2Fhir_ty%2Fsrc%2Finfer%2Fpat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Finfer%2Fpat.rs?ref=eb248d85a0eb91bae7bafcd69ffe4dfed3e32fce", "patch": "@@ -33,7 +33,8 @@ impl<'a> InferenceContext<'a> {\n         }\n         self.unify(&ty, expected);\n \n-        let substs = ty.substs().cloned().unwrap_or_else(|| Substitution::empty(&Interner));\n+        let substs =\n+            ty.as_adt().map(|(_, s)| s.clone()).unwrap_or_else(|| Substitution::empty(&Interner));\n \n         let field_tys = def.map(|it| self.db.field_types(it)).unwrap_or_default();\n         let (pre, post) = match ellipsis {\n@@ -74,7 +75,8 @@ impl<'a> InferenceContext<'a> {\n \n         self.unify(&ty, expected);\n \n-        let substs = ty.substs().cloned().unwrap_or_else(|| Substitution::empty(&Interner));\n+        let substs =\n+            ty.as_adt().map(|(_, s)| s.clone()).unwrap_or_else(|| Substitution::empty(&Interner));\n \n         let field_tys = def.map(|it| self.db.field_types(it)).unwrap_or_default();\n         for subpat in subpats {"}, {"sha": "84645c43556cde327a11f7df055a92c4bb36a04e", "filename": "crates/hir_ty/src/lib.rs", "status": "modified", "additions": 0, "deletions": 28, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/eb248d85a0eb91bae7bafcd69ffe4dfed3e32fce/crates%2Fhir_ty%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eb248d85a0eb91bae7bafcd69ffe4dfed3e32fce/crates%2Fhir_ty%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Flib.rs?ref=eb248d85a0eb91bae7bafcd69ffe4dfed3e32fce", "patch": "@@ -198,34 +198,6 @@ impl Ty {\n             _ => false,\n         }\n     }\n-\n-    /// Returns the type parameters of this type if it has some (i.e. is an ADT\n-    /// or function); so if `self` is `Option<u32>`, this returns the `u32`.\n-    pub fn substs(&self) -> Option<&Substitution> {\n-        match self.kind(&Interner) {\n-            TyKind::Adt(_, substs)\n-            | TyKind::FnDef(_, substs)\n-            | TyKind::Tuple(_, substs)\n-            | TyKind::OpaqueType(_, substs)\n-            | TyKind::AssociatedType(_, substs)\n-            | TyKind::Closure(.., substs) => Some(substs),\n-            TyKind::Function(FnPointer { substitution: substs, .. }) => Some(&substs.0),\n-            _ => None,\n-        }\n-    }\n-\n-    fn substs_mut(&mut self) -> Option<&mut Substitution> {\n-        match self.interned_mut() {\n-            TyKind::Adt(_, substs)\n-            | TyKind::FnDef(_, substs)\n-            | TyKind::Tuple(_, substs)\n-            | TyKind::OpaqueType(_, substs)\n-            | TyKind::AssociatedType(_, substs)\n-            | TyKind::Closure(.., substs) => Some(substs),\n-            TyKind::Function(FnPointer { substitution: substs, .. }) => Some(&mut substs.0),\n-            _ => None,\n-        }\n-    }\n }\n \n #[derive(Copy, Clone, PartialEq, Eq, Debug, Hash)]"}, {"sha": "91116dcda3b526d089309d095443d363943a6a61", "filename": "crates/hir_ty/src/walk.rs", "status": "modified", "additions": 16, "deletions": 10, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/eb248d85a0eb91bae7bafcd69ffe4dfed3e32fce/crates%2Fhir_ty%2Fsrc%2Fwalk.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eb248d85a0eb91bae7bafcd69ffe4dfed3e32fce/crates%2Fhir_ty%2Fsrc%2Fwalk.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Fwalk.rs?ref=eb248d85a0eb91bae7bafcd69ffe4dfed3e32fce", "patch": "@@ -162,13 +162,15 @@ impl TypeWalk for Ty {\n             TyKind::Function(fn_pointer) => {\n                 fn_pointer.substitution.0.walk(f);\n             }\n-            _ => {\n-                if let Some(substs) = self.substs() {\n-                    for t in substs.iter(&Interner) {\n-                        t.walk(f);\n-                    }\n-                }\n+            TyKind::Adt(_, substs)\n+            | TyKind::FnDef(_, substs)\n+            | TyKind::Tuple(_, substs)\n+            | TyKind::OpaqueType(_, substs)\n+            | TyKind::AssociatedType(_, substs)\n+            | TyKind::Closure(.., substs) => {\n+                substs.walk(f);\n             }\n+            _ => {}\n         }\n         f(self);\n     }\n@@ -199,11 +201,15 @@ impl TypeWalk for Ty {\n             TyKind::Function(fn_pointer) => {\n                 fn_pointer.substitution.0.walk_mut_binders(f, binders.shifted_in());\n             }\n-            _ => {\n-                if let Some(substs) = self.substs_mut() {\n-                    substs.walk_mut_binders(f, binders);\n-                }\n+            TyKind::Adt(_, substs)\n+            | TyKind::FnDef(_, substs)\n+            | TyKind::Tuple(_, substs)\n+            | TyKind::OpaqueType(_, substs)\n+            | TyKind::AssociatedType(_, substs)\n+            | TyKind::Closure(.., substs) => {\n+                substs.walk_mut_binders(f, binders);\n             }\n+            _ => {}\n         }\n         f(self, binders);\n     }"}]}