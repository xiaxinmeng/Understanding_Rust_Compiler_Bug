{"sha": "20661f18df695058224427fb84d21a0eeec8c657", "node_id": "MDY6Q29tbWl0NzI0NzEyOjIwNjYxZjE4ZGY2OTUwNTgyMjQ0MjdmYjg0ZDIxYTBlZWVjOGM2NTc=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2019-08-14T04:09:11Z"}, "committer": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2019-08-16T17:24:15Z"}, "message": "Simplify pre-expansion gating in general.", "tree": {"sha": "bc93ded4fe7c9b66e36b8329860700badedb4d1e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bc93ded4fe7c9b66e36b8329860700badedb4d1e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/20661f18df695058224427fb84d21a0eeec8c657", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/20661f18df695058224427fb84d21a0eeec8c657", "html_url": "https://github.com/rust-lang/rust/commit/20661f18df695058224427fb84d21a0eeec8c657", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/20661f18df695058224427fb84d21a0eeec8c657/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4087fc583e543f2801bf2e8c3b8051b31d26a078", "url": "https://api.github.com/repos/rust-lang/rust/commits/4087fc583e543f2801bf2e8c3b8051b31d26a078", "html_url": "https://github.com/rust-lang/rust/commit/4087fc583e543f2801bf2e8c3b8051b31d26a078"}], "stats": {"total": 42, "additions": 10, "deletions": 32}, "files": [{"sha": "1a87a903156d2482c93db88f7d85ec9232b83932", "filename": "src/libsyntax/feature_gate.rs", "status": "modified", "additions": 10, "deletions": 32, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/20661f18df695058224427fb84d21a0eeec8c657/src%2Flibsyntax%2Ffeature_gate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/20661f18df695058224427fb84d21a0eeec8c657/src%2Flibsyntax%2Ffeature_gate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Ffeature_gate.rs?ref=20661f18df695058224427fb84d21a0eeec8c657", "patch": "@@ -30,7 +30,6 @@ use crate::tokenstream::TokenTree;\n \n use errors::{Applicability, DiagnosticBuilder, Handler};\n use rustc_data_structures::fx::FxHashMap;\n-use rustc_data_structures::sync::Lock;\n use rustc_target::spec::abi::Abi;\n use syntax_pos::{Span, DUMMY_SP, MultiSpan};\n use log::debug;\n@@ -2422,10 +2421,6 @@ pub fn get_features(span_handler: &Handler, krate_attrs: &[ast::Attribute],\n     features\n }\n \n-fn for_each_in_lock<T>(vec: &Lock<Vec<T>>, f: impl Fn(&T)) {\n-    vec.borrow().iter().for_each(f);\n-}\n-\n pub fn check_crate(krate: &ast::Crate,\n                    sess: &ParseSess,\n                    features: &Features,\n@@ -2438,33 +2433,16 @@ pub fn check_crate(krate: &ast::Crate,\n         plugin_attributes,\n     };\n \n-    for_each_in_lock(&sess.param_attr_spans, |span| gate_feature!(\n-        &ctx,\n-        param_attrs,\n-        *span,\n-        \"attributes on function parameters are unstable\"\n-    ));\n-\n-    for_each_in_lock(&sess.let_chains_spans, |span| gate_feature!(\n-        &ctx,\n-        let_chains,\n-        *span,\n-        \"`let` expressions in this position are experimental\"\n-    ));\n-\n-    for_each_in_lock(&sess.async_closure_spans, |span| gate_feature!(\n-        &ctx,\n-        async_closure,\n-        *span,\n-        \"async closures are unstable\"\n-    ));\n-\n-    for_each_in_lock(&sess.yield_spans, |span| gate_feature!(\n-        &ctx,\n-        generators,\n-        *span,\n-        \"yield syntax is experimental\"\n-    ));\n+    macro_rules! gate_all {\n+        ($spans:ident, $gate:ident, $msg:literal) => {\n+            for span in &*sess.$spans.borrow() { gate_feature!(&ctx, $gate, *span, $msg); }\n+        }\n+    }\n+\n+    gate_all!(param_attr_spans, param_attrs, \"attributes on function parameters are unstable\");\n+    gate_all!(let_chains_spans, let_chains, \"`let` expressions in this position are experimental\");\n+    gate_all!(async_closure_spans, async_closure, \"async closures are unstable\");\n+    gate_all!(yield_spans, generators, \"yield syntax is experimental\");\n \n     let visitor = &mut PostExpansionVisitor {\n         context: &ctx,"}]}