{"sha": "5074a7e13012a7c9ab2c0d2a29a84c141fb1e5a2", "node_id": "MDY6Q29tbWl0NzI0NzEyOjUwNzRhN2UxMzAxMmE3YzlhYjJjMGQyYTI5YTg0YzE0MWZiMWU1YTI=", "commit": {"author": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2018-05-16T15:22:48Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2018-05-16T15:22:48Z"}, "message": "Rollup merge of #50669 - QuietMisdreavus:deprecated-attrs, r=GuillaumeGomez\n\nrustdoc: deprecate `#![doc(passes, plugins, no_default_passes)]`\n\nCloses https://github.com/rust-lang/rust/issues/48164\n\nBlocked on https://github.com/rust-lang/rust/pull/50541 - this includes those changes, which were necessary to create the UI test\n\ncc https://github.com/rust-lang/rust/issues/44136\n\nTurns out, there were special attributes to mess with rustdoc passes and plugins! Who knew! Since we deprecated the CLI flags for this functionality, it makes sense that we do the same for the attributes.\n\nThis PR also introduces a `#![doc(document_private_items)]` attribute, to match the `--document-private-items` flag introduced in https://github.com/rust-lang/rust/pull/44138 when the passes/plugins flags were deprecated.\n\nI haven't done a search to see whether these attributes are being used at all, but if the flags were any indication, i don't expect to see any users of these.", "tree": {"sha": "236359e0f5ac550c3ab71c189c958afbdcd2dc72", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/236359e0f5ac550c3ab71c189c958afbdcd2dc72"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5074a7e13012a7c9ab2c0d2a29a84c141fb1e5a2", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJa/EzICRBK7hj4Ov3rIwAAdHIIABFxC6gn76apoGPvPDsPo//5\nrYAWPxOhq7MgHuXciMzZx42tK0mB7YBhH6Uya1b7LG/2l+wzTDZOOtIpwJFe3mkf\nlv0c0TfSUiQzGAvrH+1tarhlE+6Yb0FVvW1uMjgowvmkrSxEzimMghU7rdAuroNC\nlCh/jYsoKry1+6bl5/fInSxTYAtCRZ0HXnnxDyVZWqxw/UVKi9KH6iVNEkUqTfho\nt5zy3mqKu6N60XqCwHMFvjTgHXirg9vAAZqF6ZRWnk3P5k8+C6aRTFIRFJn4u2Bo\nxSZezfy78ZyUgki9QwtXZ+NrLRYS+VQJ7GAK9lxUwJb1PHcdb//16GnRtQDIagw=\n=qH1S\n-----END PGP SIGNATURE-----\n", "payload": "tree 236359e0f5ac550c3ab71c189c958afbdcd2dc72\nparent 5cc6fd35c17717cf9b09e02c6d3d4cd9bf4c6846\nparent 10ac9950249f19e6ea02410cb955764b998d1912\nauthor kennytm <kennytm@gmail.com> 1526484168 +0800\ncommitter GitHub <noreply@github.com> 1526484168 +0800\n\nRollup merge of #50669 - QuietMisdreavus:deprecated-attrs, r=GuillaumeGomez\n\nrustdoc: deprecate `#![doc(passes, plugins, no_default_passes)]`\n\nCloses https://github.com/rust-lang/rust/issues/48164\n\nBlocked on https://github.com/rust-lang/rust/pull/50541 - this includes those changes, which were necessary to create the UI test\n\ncc https://github.com/rust-lang/rust/issues/44136\n\nTurns out, there were special attributes to mess with rustdoc passes and plugins! Who knew! Since we deprecated the CLI flags for this functionality, it makes sense that we do the same for the attributes.\n\nThis PR also introduces a `#![doc(document_private_items)]` attribute, to match the `--document-private-items` flag introduced in https://github.com/rust-lang/rust/pull/44138 when the passes/plugins flags were deprecated.\n\nI haven't done a search to see whether these attributes are being used at all, but if the flags were any indication, i don't expect to see any users of these.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5074a7e13012a7c9ab2c0d2a29a84c141fb1e5a2", "html_url": "https://github.com/rust-lang/rust/commit/5074a7e13012a7c9ab2c0d2a29a84c141fb1e5a2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5074a7e13012a7c9ab2c0d2a29a84c141fb1e5a2/comments", "author": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5cc6fd35c17717cf9b09e02c6d3d4cd9bf4c6846", "url": "https://api.github.com/repos/rust-lang/rust/commits/5cc6fd35c17717cf9b09e02c6d3d4cd9bf4c6846", "html_url": "https://github.com/rust-lang/rust/commit/5cc6fd35c17717cf9b09e02c6d3d4cd9bf4c6846"}, {"sha": "10ac9950249f19e6ea02410cb955764b998d1912", "url": "https://api.github.com/repos/rust-lang/rust/commits/10ac9950249f19e6ea02410cb955764b998d1912", "html_url": "https://github.com/rust-lang/rust/commit/10ac9950249f19e6ea02410cb955764b998d1912"}], "stats": {"total": 60, "additions": 58, "deletions": 2}, "files": [{"sha": "a14a27d5d619347aacf6c8f765fbab3ad3e9b8c2", "filename": "src/librustdoc/lib.rs", "status": "modified", "additions": 32, "deletions": 2, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/5074a7e13012a7c9ab2c0d2a29a84c141fb1e5a2/src%2Flibrustdoc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5074a7e13012a7c9ab2c0d2a29a84c141fb1e5a2/src%2Flibrustdoc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Flib.rs?ref=5074a7e13012a7c9ab2c0d2a29a84c141fb1e5a2", "patch": "@@ -654,25 +654,55 @@ where R: 'static + Send,\n \n         krate.version = crate_version;\n \n+        let diag = core::new_handler(error_format, None);\n+\n+        fn report_deprecated_attr(name: &str, diag: &errors::Handler) {\n+            let mut msg = diag.struct_warn(&format!(\"the `#![doc({})]` attribute is \\\n+                                                     considered deprecated\", name));\n+            msg.warn(\"please see https://github.com/rust-lang/rust/issues/44136\");\n+\n+            if name == \"no_default_passes\" {\n+                msg.help(\"you may want to use `#![doc(document_private_items)]`\");\n+            }\n+\n+            msg.emit();\n+        }\n+\n         // Process all of the crate attributes, extracting plugin metadata along\n         // with the passes which we are supposed to run.\n         for attr in krate.module.as_ref().unwrap().attrs.lists(\"doc\") {\n             let name = attr.name().map(|s| s.as_str());\n             let name = name.as_ref().map(|s| &s[..]);\n             if attr.is_word() {\n                 if name == Some(\"no_default_passes\") {\n+                    report_deprecated_attr(\"no_default_passes\", &diag);\n                     default_passes = false;\n                 }\n             } else if let Some(value) = attr.value_str() {\n                 let sink = match name {\n-                    Some(\"passes\") => &mut passes,\n-                    Some(\"plugins\") => &mut plugins,\n+                    Some(\"passes\") => {\n+                        report_deprecated_attr(\"passes = \\\"...\\\"\", &diag);\n+                        &mut passes\n+                    },\n+                    Some(\"plugins\") => {\n+                        report_deprecated_attr(\"plugins = \\\"...\\\"\", &diag);\n+                        &mut plugins\n+                    },\n                     _ => continue,\n                 };\n                 for p in value.as_str().split_whitespace() {\n                     sink.push(p.to_string());\n                 }\n             }\n+\n+            if attr.is_word() && name == Some(\"document_private_items\") {\n+                default_passes = false;\n+\n+                passes = vec![\n+                    String::from(\"collapse-docs\"),\n+                    String::from(\"unindent-comments\"),\n+                ];\n+            }\n         }\n \n         if default_passes {"}, {"sha": "dd2e05aeeb4dd610aa9aca466efbbab66bf5fef7", "filename": "src/test/rustdoc-ui/deprecated-attrs.rs", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/5074a7e13012a7c9ab2c0d2a29a84c141fb1e5a2/src%2Ftest%2Frustdoc-ui%2Fdeprecated-attrs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5074a7e13012a7c9ab2c0d2a29a84c141fb1e5a2/src%2Ftest%2Frustdoc-ui%2Fdeprecated-attrs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fdeprecated-attrs.rs?ref=5074a7e13012a7c9ab2c0d2a29a84c141fb1e5a2", "patch": "@@ -0,0 +1,17 @@\n+// Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// compile-pass\n+\n+#![doc(no_default_passes, passes = \"collapse-docs unindent-comments\")]\n+\n+struct SomeStruct;\n+\n+pub struct OtherStruct;"}, {"sha": "77ba4b2a2b67e2be186e1251b29a89ce445d4ca9", "filename": "src/test/rustdoc-ui/deprecated-attrs.stderr", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/5074a7e13012a7c9ab2c0d2a29a84c141fb1e5a2/src%2Ftest%2Frustdoc-ui%2Fdeprecated-attrs.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/5074a7e13012a7c9ab2c0d2a29a84c141fb1e5a2/src%2Ftest%2Frustdoc-ui%2Fdeprecated-attrs.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fdeprecated-attrs.stderr?ref=5074a7e13012a7c9ab2c0d2a29a84c141fb1e5a2", "patch": "@@ -0,0 +1,9 @@\n+warning: the `#![doc(no_default_passes)]` attribute is considered deprecated\n+  |\n+  = warning: please see https://github.com/rust-lang/rust/issues/44136\n+  = help: you may want to use `#![doc(document_private_items)]`\n+\n+warning: the `#![doc(passes = \"...\")]` attribute is considered deprecated\n+  |\n+  = warning: please see https://github.com/rust-lang/rust/issues/44136\n+"}]}