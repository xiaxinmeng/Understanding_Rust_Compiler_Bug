{"sha": "7f945b2b5b0d8123d6031bb655d2a9fe5c71ee01", "node_id": "C_kwDOAAsO6NoAKDdmOTQ1YjJiNWIwZDgxMjNkNjAzMWJiNjU1ZDJhOWZlNWM3MWVlMDE", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2022-04-12T15:00:55Z"}, "committer": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2022-04-12T15:09:26Z"}, "message": "add simd_arith_offset intrinsics", "tree": {"sha": "a86eebc84a3a8abce854c9d96c76f46afe2a2f86", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a86eebc84a3a8abce854c9d96c76f46afe2a2f86"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7f945b2b5b0d8123d6031bb655d2a9fe5c71ee01", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7f945b2b5b0d8123d6031bb655d2a9fe5c71ee01", "html_url": "https://github.com/rust-lang/rust/commit/7f945b2b5b0d8123d6031bb655d2a9fe5c71ee01", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7f945b2b5b0d8123d6031bb655d2a9fe5c71ee01/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "de392c7d31602ddf0fae1143c5ad822a1abe89df", "url": "https://api.github.com/repos/rust-lang/rust/commits/de392c7d31602ddf0fae1143c5ad822a1abe89df", "html_url": "https://github.com/rust-lang/rust/commit/de392c7d31602ddf0fae1143c5ad822a1abe89df"}], "stats": {"total": 23, "additions": 23, "deletions": 0}, "files": [{"sha": "cf9cf1b70aaa7b4f672cc973b13554fe3f84ba0d", "filename": "compiler/rustc_codegen_llvm/src/intrinsic.rs", "status": "modified", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/7f945b2b5b0d8123d6031bb655d2a9fe5c71ee01/compiler%2Frustc_codegen_llvm%2Fsrc%2Fintrinsic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7f945b2b5b0d8123d6031bb655d2a9fe5c71ee01/compiler%2Frustc_codegen_llvm%2Fsrc%2Fintrinsic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fintrinsic.rs?ref=7f945b2b5b0d8123d6031bb655d2a9fe5c71ee01", "patch": "@@ -1839,6 +1839,27 @@ unsupported {} from `{}` with element `{}` of size `{}` to `{}`\"#,\n         simd_neg: Int => neg, Float => fneg;\n     }\n \n+    if name == sym::simd_arith_offset {\n+        // This also checks that the first operand is a ptr type.\n+        let pointee = in_elem.builtin_deref(true).unwrap_or_else(|| {\n+            span_bug!(span, \"must be called with a vector of pointer types as first argument\")\n+        });\n+        let layout = bx.layout_of(pointee.ty);\n+        let ptrs = args[0].immediate();\n+        // The second argument must be a ptr-sized integer.\n+        // (We don't care about the signedness, this is wrapping anyway.)\n+        let (_offsets_len, offsets_elem) = arg_tys[1].simd_size_and_type(bx.tcx());\n+        if !matches!(offsets_elem.kind(), ty::Int(ty::IntTy::Isize) | ty::Uint(ty::UintTy::Usize)) {\n+            span_bug!(\n+                span,\n+                \"must be called with a vector of pointer-sized integers as second argument\"\n+            );\n+        }\n+        let offsets = args[1].immediate();\n+\n+        return Ok(bx.gep(bx.backend_type(layout), ptrs, &[offsets]));\n+    }\n+\n     if name == sym::simd_saturating_add || name == sym::simd_saturating_sub {\n         let lhs = args[0].immediate();\n         let rhs = args[1].immediate();"}, {"sha": "1070cb1cd9ed8daba760c0326ff1c40f1643af69", "filename": "compiler/rustc_span/src/symbol.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7f945b2b5b0d8123d6031bb655d2a9fe5c71ee01/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7f945b2b5b0d8123d6031bb655d2a9fe5c71ee01/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs?ref=7f945b2b5b0d8123d6031bb655d2a9fe5c71ee01", "patch": "@@ -1245,6 +1245,7 @@ symbols! {\n         simd,\n         simd_add,\n         simd_and,\n+        simd_arith_offset,\n         simd_as,\n         simd_bitmask,\n         simd_cast,"}, {"sha": "8bad238f5976da1a0351b2957448416151103bbb", "filename": "compiler/rustc_typeck/src/check/intrinsic.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7f945b2b5b0d8123d6031bb655d2a9fe5c71ee01/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fintrinsic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7f945b2b5b0d8123d6031bb655d2a9fe5c71ee01/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fintrinsic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fintrinsic.rs?ref=7f945b2b5b0d8123d6031bb655d2a9fe5c71ee01", "patch": "@@ -437,6 +437,7 @@ pub fn check_platform_intrinsic_type(tcx: TyCtxt<'_>, it: &hir::ForeignItem<'_>)\n         | sym::simd_fpow\n         | sym::simd_saturating_add\n         | sym::simd_saturating_sub => (1, vec![param(0), param(0)], param(0)),\n+        sym::simd_arith_offset => (2, vec![param(0), param(1)], param(0)),\n         sym::simd_neg\n         | sym::simd_fsqrt\n         | sym::simd_fsin"}]}