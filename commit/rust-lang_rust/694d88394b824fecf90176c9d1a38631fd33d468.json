{"sha": "694d88394b824fecf90176c9d1a38631fd33d468", "node_id": "MDY6Q29tbWl0NzI0NzEyOjY5NGQ4ODM5NGI4MjRmZWNmOTAxNzZjOWQxYTM4NjMxZmQzM2Q0Njg=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2016-03-29T15:24:02Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2016-03-29T15:24:02Z"}, "message": "mk: Fix cross-host builds\n\nThe change in b20e748 had the unintended consequence of breaking cross-host\nbuilds as we apparently relied on the incorrect definition of this variable in\nthe makefiles. That change, however, was required to get tests passing so we\ncouldn't just revert it.\n\nThis commit fixes the underlying bug by leaving the \"more correct\" definition of\n`LD_LIBRARY_PATH_ENV_TARGETDIR` (also fixing it with a hardcoded reference to\n`CFG_BUILD`) and updating the `RPATH_VAR` definition below. Turned out we\nalready had special-casing logic for passing `--cfg stage1` during the\nwell-we-print-this-as-stage0 build of a cross-host. That logic was just updated\nto pull from a different variable as opposed to relying on the definition of\nthat variable to accommodate this.\n\nCloses #32568", "tree": {"sha": "3dade567c48212b20953a6012b77f160e90183c9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3dade567c48212b20953a6012b77f160e90183c9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/694d88394b824fecf90176c9d1a38631fd33d468", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/694d88394b824fecf90176c9d1a38631fd33d468", "html_url": "https://github.com/rust-lang/rust/commit/694d88394b824fecf90176c9d1a38631fd33d468", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/694d88394b824fecf90176c9d1a38631fd33d468/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a11129701c873d96fe0816e4c8b55510efebe96e", "url": "https://api.github.com/repos/rust-lang/rust/commits/a11129701c873d96fe0816e4c8b55510efebe96e", "html_url": "https://github.com/rust-lang/rust/commit/a11129701c873d96fe0816e4c8b55510efebe96e"}], "stats": {"total": 14, "additions": 5, "deletions": 9}, "files": [{"sha": "a32658ddcefdc86d76699e31e2f1714e57fe80fb", "filename": "mk/main.mk", "status": "modified", "additions": 5, "deletions": 9, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/694d88394b824fecf90176c9d1a38631fd33d468/mk%2Fmain.mk", "raw_url": "https://github.com/rust-lang/rust/raw/694d88394b824fecf90176c9d1a38631fd33d468/mk%2Fmain.mk", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/mk%2Fmain.mk?ref=694d88394b824fecf90176c9d1a38631fd33d468", "patch": "@@ -493,7 +493,7 @@ endif\n LD_LIBRARY_PATH_ENV_HOSTDIR$(1)_T_$(2)_H_$(3) := \\\n     $$(CURDIR)/$$(HLIB$(1)_H_$(3)):$$(CFG_LLVM_INST_DIR_$(3))/lib\n LD_LIBRARY_PATH_ENV_TARGETDIR$(1)_T_$(2)_H_$(3) := \\\n-    $$(CURDIR)/$$(TLIB$(1)_T_$(2)_H_$(CFG_BUILD))\n+    $$(CURDIR)/$$(TLIB$(1)_T_$(2)_H_$(3))\n \n HOST_RPATH_VAR$(1)_T_$(2)_H_$(3) := \\\n   $$(LD_LIBRARY_PATH_ENV_NAME$(1)_T_$(2)_H_$(3))=$$(LD_LIBRARY_PATH_ENV_HOSTDIR$(1)_T_$(2)_H_$(3)):$$$$$$(LD_LIBRARY_PATH_ENV_NAME$(1)_T_$(2)_H_$(3))\n@@ -506,18 +506,14 @@ RPATH_VAR$(1)_T_$(2)_H_$(3) := $$(HOST_RPATH_VAR$(1)_T_$(2)_H_$(3))\n # if you're building a cross config, the host->* parts are\n # effectively stage1, since it uses the just-built stage0.\n #\n-# This logic is similar to how the LD_LIBRARY_PATH variable must\n-# change be slightly different when doing cross compilations.\n-# The build doesn't copy over all target libraries into\n-# a new directory, so we need to point the library path at\n-# the build directory where all the target libraries came\n-# from (the stage0 build host). Otherwise the relative rpaths\n-# inside of the rustc binary won't get resolved correctly.\n+# Also be sure to use the right rpath because we're loading libraries from the\n+# CFG_BUILD's stage1 directory for our target, so switch this one instance of\n+# `RPATH_VAR` to get the bootstrap working.\n ifeq ($(1),0)\n ifneq ($(strip $(CFG_BUILD)),$(strip $(3)))\n CFGFLAG$(1)_T_$(2)_H_$(3) = stage1\n \n-RPATH_VAR$(1)_T_$(2)_H_$(3) := $$(TARGET_RPATH_VAR$(1)_T_$(2)_H_$(3))\n+RPATH_VAR$(1)_T_$(2)_H_$(3) := $$(TARGET_RPATH_VAR1_T_$(2)_H_$$(CFG_BUILD))\n endif\n endif\n "}]}