{"sha": "565de58dd705e6b4dc1adda0f96b102360276ef5", "node_id": "C_kwDOAAsO6NoAKDU2NWRlNThkZDcwNWU2YjRkYzFhZGRhMGY5NmIxMDIzNjAyNzZlZjU", "commit": {"author": {"name": "Josh Stone", "email": "jistone@redhat.com", "date": "2023-02-28T18:25:05Z"}, "committer": {"name": "Josh Stone", "email": "jistone@redhat.com", "date": "2023-02-28T20:02:14Z"}, "message": "Skip test `download_ci_llvm` with modified LLVM", "tree": {"sha": "6b22efdbead9b13062cf477ddfb320da503fadca", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6b22efdbead9b13062cf477ddfb320da503fadca"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/565de58dd705e6b4dc1adda0f96b102360276ef5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/565de58dd705e6b4dc1adda0f96b102360276ef5", "html_url": "https://github.com/rust-lang/rust/commit/565de58dd705e6b4dc1adda0f96b102360276ef5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/565de58dd705e6b4dc1adda0f96b102360276ef5/comments", "author": {"login": "cuviper", "id": 36186, "node_id": "MDQ6VXNlcjM2MTg2", "avatar_url": "https://avatars.githubusercontent.com/u/36186?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cuviper", "html_url": "https://github.com/cuviper", "followers_url": "https://api.github.com/users/cuviper/followers", "following_url": "https://api.github.com/users/cuviper/following{/other_user}", "gists_url": "https://api.github.com/users/cuviper/gists{/gist_id}", "starred_url": "https://api.github.com/users/cuviper/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cuviper/subscriptions", "organizations_url": "https://api.github.com/users/cuviper/orgs", "repos_url": "https://api.github.com/users/cuviper/repos", "events_url": "https://api.github.com/users/cuviper/events{/privacy}", "received_events_url": "https://api.github.com/users/cuviper/received_events", "type": "User", "site_admin": false}, "committer": {"login": "cuviper", "id": 36186, "node_id": "MDQ6VXNlcjM2MTg2", "avatar_url": "https://avatars.githubusercontent.com/u/36186?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cuviper", "html_url": "https://github.com/cuviper", "followers_url": "https://api.github.com/users/cuviper/followers", "following_url": "https://api.github.com/users/cuviper/following{/other_user}", "gists_url": "https://api.github.com/users/cuviper/gists{/gist_id}", "starred_url": "https://api.github.com/users/cuviper/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cuviper/subscriptions", "organizations_url": "https://api.github.com/users/cuviper/orgs", "repos_url": "https://api.github.com/users/cuviper/repos", "events_url": "https://api.github.com/users/cuviper/events{/privacy}", "received_events_url": "https://api.github.com/users/cuviper/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "313f04f4fff32ecf376c8af0e5d80e196f2bc056", "url": "https://api.github.com/repos/rust-lang/rust/commits/313f04f4fff32ecf376c8af0e5d80e196f2bc056", "html_url": "https://github.com/rust-lang/rust/commit/313f04f4fff32ecf376c8af0e5d80e196f2bc056"}], "stats": {"total": 26, "additions": 17, "deletions": 9}, "files": [{"sha": "5a105007f21fce4a26b27fb7ad46346ed6c98b09", "filename": "src/bootstrap/config/tests.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/565de58dd705e6b4dc1adda0f96b102360276ef5/src%2Fbootstrap%2Fconfig%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/565de58dd705e6b4dc1adda0f96b102360276ef5/src%2Fbootstrap%2Fconfig%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fconfig%2Ftests.rs?ref=565de58dd705e6b4dc1adda0f96b102360276ef5", "patch": "@@ -11,6 +11,11 @@ fn parse(config: &str) -> Config {\n \n #[test]\n fn download_ci_llvm() {\n+    if crate::native::is_ci_llvm_modified(&parse(\"\")) {\n+        eprintln!(\"Detected LLVM as non-available: running in CI and modified LLVM in this change\");\n+        return;\n+    }\n+\n     let parse_llvm = |s| parse(s).llvm_from_ci;\n     let if_available = parse_llvm(\"llvm.download-ci-llvm = \\\"if-available\\\"\");\n "}, {"sha": "31b22228934d16e607ae75e326fcb9957ce9d49d", "filename": "src/bootstrap/native.rs", "status": "modified", "additions": 12, "deletions": 9, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/565de58dd705e6b4dc1adda0f96b102360276ef5/src%2Fbootstrap%2Fnative.rs", "raw_url": "https://github.com/rust-lang/rust/raw/565de58dd705e6b4dc1adda0f96b102360276ef5/src%2Fbootstrap%2Fnative.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fnative.rs?ref=565de58dd705e6b4dc1adda0f96b102360276ef5", "patch": "@@ -216,21 +216,24 @@ pub(crate) fn is_ci_llvm_available(config: &Config, asserts: bool) -> bool {\n         }\n     }\n \n-    if CiEnv::is_ci() {\n+    if is_ci_llvm_modified(config) {\n+        eprintln!(\"Detected LLVM as non-available: running in CI and modified LLVM in this change\");\n+        return false;\n+    }\n+\n+    true\n+}\n+\n+/// Returns true if we're running in CI with modified LLVM (and thus can't download it)\n+pub(crate) fn is_ci_llvm_modified(config: &Config) -> bool {\n+    CiEnv::is_ci() && {\n         // We assume we have access to git, so it's okay to unconditionally pass\n         // `true` here.\n         let llvm_sha = detect_llvm_sha(config, true);\n         let head_sha = output(config.git().arg(\"rev-parse\").arg(\"HEAD\"));\n         let head_sha = head_sha.trim();\n-        if llvm_sha == head_sha {\n-            eprintln!(\n-                \"Detected LLVM as non-available: running in CI and modified LLVM in this change\"\n-            );\n-            return false;\n-        }\n+        llvm_sha == head_sha\n     }\n-\n-    true\n }\n \n #[derive(Debug, Copy, Clone, Hash, PartialEq, Eq)]"}]}