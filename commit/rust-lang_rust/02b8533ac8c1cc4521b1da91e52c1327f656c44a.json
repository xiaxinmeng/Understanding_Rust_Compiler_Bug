{"sha": "02b8533ac8c1cc4521b1da91e52c1327f656c44a", "node_id": "MDY6Q29tbWl0NzI0NzEyOjAyYjg1MzNhYzhjMWNjNDUyMWIxZGE5MWU1MmMxMzI3ZjY1NmM0NGE=", "commit": {"author": {"name": "Philipp Hansch", "email": "dev@phansch.net", "date": "2019-03-24T13:06:47Z"}, "committer": {"name": "Philipp Hansch", "email": "dev@phansch.net", "date": "2019-03-24T16:04:40Z"}, "message": "Add a way to track Rustfix UI test coverage\n\nThis came out of the first Rustfix WG meeting.\n\nOne of the goals is to enable Rustfix tests for all UI tests that\ntrigger lints with `MachineApplicable` suggestions. In order to do that\nwe first want to create a tracking issue that lists all files with\nmissing `// run-rustfix` headers.\n\nThis PR adds a `--rustfix-coverage` flag to `./x.py` and compiletest to\nlist the files with the missing headers in `/tmp/rustfix_missing_coverage.txt`.\n\nFrom that file we can create the tracking issue and at some point also\nenforce the `// run-rustfix` flag on UI tests with `MachineApplicable`\nlints.", "tree": {"sha": "ff71c7e73d919de241203795d7f82d5bdda16860", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ff71c7e73d919de241203795d7f82d5bdda16860"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/02b8533ac8c1cc4521b1da91e52c1327f656c44a", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEvUKv4zqIn2RHUgCKtvoGpuDiZlsFAlyXqpoACgkQtvoGpuDi\nZlsP2Q//YYkCBODMfh4/mWjDgp2kuEtg4Yz43zvP6CYFTaI3zBMd7gQd/kkUHovN\n1vWwTbAr7EKyGipggJ2XUxTDjrGrqyRYKO2D6FVp1zs95weefyTo9PQHNtKSMAOa\nD+1I7wNfrIslGK9/PYXkApUB0Rv4PMjAU6YyV9aNVvbZlgPS3Yn/CuRZzBsLU5c/\nt6eH+6LmAqdLbzqDhXBocS4cR43CcHVkuu5isQXv/EyBQrU+KnwD1vwBvvHatZ6Q\nf0JYhxqczjVGiVKu4ZOLuHO0MfjLbs1K/umM/2JlvMa0RJvO34ECnnlhcXj/ic9B\n/y2XfBnFPga6GEth/ZJakaVwChc7qV9QU10NkMIlkNLyGcLuMYcGMVelJZ93NeQs\nHtcrRRULFepfl1T2YIPlIAu9hhIlCUQAvh1qyXNrz44UEmWu+V4lx8BTvnMNImOg\nc+psJ4pod9jHF5nhboMyo9PIlV7Zq8YdQsr5/j0WpfNooTIzMQ2SU+FM0TpVsqgs\n/41Qwj1GizMyIekzZi1wkTQB6YcZTiWIdSs19t0jY3+plFI8KwLtQJ9mTr6PlDKk\nU6c+RdCbuQEDe6H6rjgVzgef65GvJq3DXhVFGmnIkUFgJYEggmOQB8/gJ2lT5JqW\n1ho2dPdvOhDu2T8S8phY22RPmJF6Q+0y9sHGiegbqdpWQZ7jhT0=\n=MXk4\n-----END PGP SIGNATURE-----", "payload": "tree ff71c7e73d919de241203795d7f82d5bdda16860\nparent fb5ed488ff1a251db895c545592488a67be67112\nauthor Philipp Hansch <dev@phansch.net> 1553432807 +0100\ncommitter Philipp Hansch <dev@phansch.net> 1553443480 +0100\n\nAdd a way to track Rustfix UI test coverage\n\nThis came out of the first Rustfix WG meeting.\n\nOne of the goals is to enable Rustfix tests for all UI tests that\ntrigger lints with `MachineApplicable` suggestions. In order to do that\nwe first want to create a tracking issue that lists all files with\nmissing `// run-rustfix` headers.\n\nThis PR adds a `--rustfix-coverage` flag to `./x.py` and compiletest to\nlist the files with the missing headers in `/tmp/rustfix_missing_coverage.txt`.\n\nFrom that file we can create the tracking issue and at some point also\nenforce the `// run-rustfix` flag on UI tests with `MachineApplicable`\nlints.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/02b8533ac8c1cc4521b1da91e52c1327f656c44a", "html_url": "https://github.com/rust-lang/rust/commit/02b8533ac8c1cc4521b1da91e52c1327f656c44a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/02b8533ac8c1cc4521b1da91e52c1327f656c44a/comments", "author": {"login": "phansch", "id": 2042399, "node_id": "MDQ6VXNlcjIwNDIzOTk=", "avatar_url": "https://avatars.githubusercontent.com/u/2042399?v=4", "gravatar_id": "", "url": "https://api.github.com/users/phansch", "html_url": "https://github.com/phansch", "followers_url": "https://api.github.com/users/phansch/followers", "following_url": "https://api.github.com/users/phansch/following{/other_user}", "gists_url": "https://api.github.com/users/phansch/gists{/gist_id}", "starred_url": "https://api.github.com/users/phansch/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/phansch/subscriptions", "organizations_url": "https://api.github.com/users/phansch/orgs", "repos_url": "https://api.github.com/users/phansch/repos", "events_url": "https://api.github.com/users/phansch/events{/privacy}", "received_events_url": "https://api.github.com/users/phansch/received_events", "type": "User", "site_admin": false}, "committer": {"login": "phansch", "id": 2042399, "node_id": "MDQ6VXNlcjIwNDIzOTk=", "avatar_url": "https://avatars.githubusercontent.com/u/2042399?v=4", "gravatar_id": "", "url": "https://api.github.com/users/phansch", "html_url": "https://github.com/phansch", "followers_url": "https://api.github.com/users/phansch/followers", "following_url": "https://api.github.com/users/phansch/following{/other_user}", "gists_url": "https://api.github.com/users/phansch/gists{/gist_id}", "starred_url": "https://api.github.com/users/phansch/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/phansch/subscriptions", "organizations_url": "https://api.github.com/users/phansch/orgs", "repos_url": "https://api.github.com/users/phansch/repos", "events_url": "https://api.github.com/users/phansch/events{/privacy}", "received_events_url": "https://api.github.com/users/phansch/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "fb5ed488ff1a251db895c545592488a67be67112", "url": "https://api.github.com/repos/rust-lang/rust/commits/fb5ed488ff1a251db895c545592488a67be67112", "html_url": "https://github.com/rust-lang/rust/commit/fb5ed488ff1a251db895c545592488a67be67112"}], "stats": {"total": 67, "additions": 66, "deletions": 1}, "files": [{"sha": "23719378c840af4ca4cf5ba10e9799be1b78fd6d", "filename": "src/bootstrap/flags.rs", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/02b8533ac8c1cc4521b1da91e52c1327f656c44a/src%2Fbootstrap%2Fflags.rs", "raw_url": "https://github.com/rust-lang/rust/raw/02b8533ac8c1cc4521b1da91e52c1327f656c44a/src%2Fbootstrap%2Fflags.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fflags.rs?ref=02b8533ac8c1cc4521b1da91e52c1327f656c44a", "patch": "@@ -56,6 +56,7 @@ pub enum Subcommand {\n         rustc_args: Vec<String>,\n         fail_fast: bool,\n         doc_tests: DocTests,\n+        rustfix_coverage: bool,\n     },\n     Bench {\n         paths: Vec<PathBuf>,\n@@ -188,6 +189,12 @@ To learn more about a subcommand, run `./x.py <subcommand> -h`\"\n                     \"mode describing what file the actual ui output will be compared to\",\n                     \"COMPARE MODE\",\n                 );\n+                opts.optflag(\n+                    \"\",\n+                    \"rustfix-coverage\",\n+                    \"enable this to generate a Rustfix coverage file, which is saved in \\\n+                        `/tmp/rustfix_missing_coverage.txt`\",\n+                );\n             }\n             \"bench\" => {\n                 opts.optmulti(\"\", \"test-args\", \"extra arguments\", \"ARGS\");\n@@ -363,6 +370,7 @@ Arguments:\n                 test_args: matches.opt_strs(\"test-args\"),\n                 rustc_args: matches.opt_strs(\"rustc-args\"),\n                 fail_fast: !matches.opt_present(\"no-fail-fast\"),\n+                rustfix_coverage: matches.opt_present(\"rustfix-coverage\"),\n                 doc_tests: if matches.opt_present(\"doc\") {\n                     DocTests::Only\n                 } else if matches.opt_present(\"no-doc\") {\n@@ -467,6 +475,13 @@ impl Subcommand {\n         }\n     }\n \n+    pub fn rustfix_coverage(&self) -> bool {\n+        match *self {\n+            Subcommand::Test { rustfix_coverage, .. } => rustfix_coverage,\n+            _ => false,\n+        }\n+    }\n+\n     pub fn compare_mode(&self) -> Option<&str> {\n         match *self {\n             Subcommand::Test {"}, {"sha": "41c73f307b6d0586c51add86c2bed48c9eacb585", "filename": "src/bootstrap/test.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/02b8533ac8c1cc4521b1da91e52c1327f656c44a/src%2Fbootstrap%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/02b8533ac8c1cc4521b1da91e52c1327f656c44a/src%2Fbootstrap%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Ftest.rs?ref=02b8533ac8c1cc4521b1da91e52c1327f656c44a", "patch": "@@ -1284,6 +1284,10 @@ impl Step for Compiletest {\n             cmd.arg(\"--android-cross-path\").arg(\"\");\n         }\n \n+        if builder.config.cmd.rustfix_coverage() {\n+            cmd.arg(\"--rustfix-coverage\");\n+        }\n+\n         builder.ci_env.force_coloring_in_ci(&mut cmd);\n \n         let _folder = builder.fold_output(|| format!(\"test_{}\", suite));"}, {"sha": "fe0c4f14940ada0cdfcc554e90ec142d592d0dd9", "filename": "src/tools/compiletest/src/common.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/02b8533ac8c1cc4521b1da91e52c1327f656c44a/src%2Ftools%2Fcompiletest%2Fsrc%2Fcommon.rs", "raw_url": "https://github.com/rust-lang/rust/raw/02b8533ac8c1cc4521b1da91e52c1327f656c44a/src%2Ftools%2Fcompiletest%2Fsrc%2Fcommon.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fcommon.rs?ref=02b8533ac8c1cc4521b1da91e52c1327f656c44a", "patch": "@@ -245,6 +245,11 @@ pub struct Config {\n     /// mode describing what file the actual ui output will be compared to\n     pub compare_mode: Option<CompareMode>,\n \n+    /// If true, this will generate a coverage file with UI test files that run `MachineApplicable`\n+    /// lints but are missing `run-rustfix` annotations. The generated coverage file is created in\n+    /// `/tmp/rustfix_missing_coverage.txt`\n+    pub rustfix_coverage: bool,\n+\n     // Configuration for various run-make tests frobbing things like C compilers\n     // or querying about various LLVM component information.\n     pub cc: String,"}, {"sha": "1045ea1bf0c96d9c91038aec742d173b49a8192d", "filename": "src/tools/compiletest/src/main.rs", "status": "modified", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/02b8533ac8c1cc4521b1da91e52c1327f656c44a/src%2Ftools%2Fcompiletest%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/02b8533ac8c1cc4521b1da91e52c1327f656c44a/src%2Ftools%2Fcompiletest%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fmain.rs?ref=02b8533ac8c1cc4521b1da91e52c1327f656c44a", "patch": "@@ -233,6 +233,12 @@ pub fn parse_config(args: Vec<String>) -> Config {\n             \"mode describing what file the actual ui output will be compared to\",\n             \"COMPARE MODE\",\n         )\n+        .optflag(\n+            \"\",\n+            \"rustfix-coverage\",\n+            \"enable this to generate a Rustfix coverage file, which is saved in \\\n+                `/tmp/rustfix_missing_coverage.txt`\",\n+        )\n         .optflag(\"h\", \"help\", \"show this message\");\n \n     let (argv0, args_) = args.split_first().unwrap();\n@@ -336,6 +342,7 @@ pub fn parse_config(args: Vec<String>) -> Config {\n         color,\n         remote_test_client: matches.opt_str(\"remote-test-client\").map(PathBuf::from),\n         compare_mode: matches.opt_str(\"compare-mode\").map(CompareMode::parse),\n+        rustfix_coverage: matches.opt_present(\"rustfix-coverage\"),\n \n         cc: matches.opt_str(\"cc\").unwrap(),\n         cxx: matches.opt_str(\"cxx\").unwrap(),\n@@ -475,6 +482,18 @@ pub fn run_tests(config: &Config) {\n         let _ = fs::remove_dir_all(\"tmp/partitioning-tests\");\n     }\n \n+    // If we want to collect rustfix coverage information,\n+    // we first make sure that the coverage file does not exist.\n+    // It will be created later on.\n+    if config.rustfix_coverage {\n+        let coverage_file_path = Path::new(\"/tmp/rustfix_missing_coverage.txt\");\n+        if coverage_file_path.exists() {\n+            if let Err(e) = fs::remove_file(coverage_file_path) {\n+                panic!(\"Could not delete {} due to {}\", coverage_file_path.display(), e)\n+            }\n+        }\n+    }\n+\n     let opts = test_opts(config);\n     let tests = make_tests(config);\n     // sadly osx needs some file descriptor limits raised for running tests in"}, {"sha": "0ca656bb13328c39f0666ccc51aa79ae9fae11e4", "filename": "src/tools/compiletest/src/runtest.rs", "status": "modified", "additions": 23, "deletions": 1, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/02b8533ac8c1cc4521b1da91e52c1327f656c44a/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/02b8533ac8c1cc4521b1da91e52c1327f656c44a/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs?ref=02b8533ac8c1cc4521b1da91e52c1327f656c44a", "patch": "@@ -19,7 +19,7 @@ use std::collections::{HashMap, HashSet, VecDeque};\n use std::env;\n use std::ffi::{OsStr, OsString};\n use std::fmt;\n-use std::fs::{self, create_dir_all, File};\n+use std::fs::{self, create_dir_all, File, OpenOptions};\n use std::hash::{Hash, Hasher};\n use std::io::prelude::*;\n use std::io::{self, BufReader};\n@@ -2818,6 +2818,28 @@ impl<'test> TestCx<'test> {\n \n         if self.config.compare_mode.is_some() {\n             // don't test rustfix with nll right now\n+        } else if self.config.rustfix_coverage {\n+            // Find out which tests have `MachineApplicable` suggestions but are missing\n+            // `run-rustfix` or `run-rustfix-only-machine-applicable` headers\n+            let suggestions = get_suggestions_from_json(\n+                &proc_res.stderr,\n+                &HashSet::new(),\n+                Filter::MachineApplicableOnly\n+            ).unwrap();\n+            if suggestions.len() > 0\n+                && !self.props.run_rustfix\n+                && !self.props.rustfix_only_machine_applicable {\n+                    let coverage_file_path = Path::new(\"/tmp/rustfix_missing_coverage.txt\");\n+                    let mut file = OpenOptions::new()\n+                        .create(true)\n+                        .append(true)\n+                        .open(coverage_file_path)\n+                        .expect(\"could not create or open file\");\n+\n+                    if let Err(_) = writeln!(file, \"{}\", self.testpaths.file.display()) {\n+                        panic!(\"couldn't write to {}\", coverage_file_path.display());\n+                    }\n+            }\n         } else if self.props.run_rustfix {\n             // Apply suggestions from rustc to the code itself\n             let unfixed_code = self"}]}