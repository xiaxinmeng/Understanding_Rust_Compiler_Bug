{"sha": "478d530af4879ae2ef829cf19370f9b518a98c11", "node_id": "C_kwDOAAsO6NoAKDQ3OGQ1MzBhZjQ4NzlhZTJlZjgyOWNmMTkzNzBmOWI1MThhOThjMTE", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2023-03-02T06:24:01Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-03-02T06:24:01Z"}, "message": "Rollup merge of #108585 - djkoloski:parallel_fuchsia_test_runner, r=tmandry\n\nRun compiler test suite in parallel on Fuchsia\n\nThis also adds file locking around calls to `pm publish` as these calls are not thread-safe.", "tree": {"sha": "59d148b6a064858c2ba7318f7e7f556c0a1fdfb7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/59d148b6a064858c2ba7318f7e7f556c0a1fdfb7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/478d530af4879ae2ef829cf19370f9b518a98c11", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkAEEBCRBK7hj4Ov3rIwAA+9IIAGjw99yDi4zik7CjwCj7istQ\nFSIoRMZUDmq8PPnBLLXzcp8wsDmLyT0sx6dy9LT0SUtcbpicSu1/Vk8Zk6ag2e0j\nD+ZeXh18Fp/ueR9o12kL9oRipxkK/w4GFBPcFGbITJYcib9iPfpGDf+9kSB83a3H\nWliPOalOUL8gCiUjpiIGdDwnhhl2Oty5dVz5hTYogrsOyq479q41lsO/CoBPfIK3\nqtwDV+5SIXqKJ2YoTnkqaLEcBBvwCBF+iZWT1JNh5YPd0nC9aTabGcvsc/jA9VuA\nM4TLBF+q2NDhkgG2VNfOwesJ+LIHgIvHrMe/uCJXHUZ0doiGp0tY1SxkbPad7es=\n=IZY6\n-----END PGP SIGNATURE-----\n", "payload": "tree 59d148b6a064858c2ba7318f7e7f556c0a1fdfb7\nparent 91dafebc91f9ef46e98ba4e592e8b1f6fb6a2145\nparent c9f1a541b36772800482c0b9de198caa1d6d6b2e\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1677738241 +0100\ncommitter GitHub <noreply@github.com> 1677738241 +0100\n\nRollup merge of #108585 - djkoloski:parallel_fuchsia_test_runner, r=tmandry\n\nRun compiler test suite in parallel on Fuchsia\n\nThis also adds file locking around calls to `pm publish` as these calls are not thread-safe.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/478d530af4879ae2ef829cf19370f9b518a98c11", "html_url": "https://github.com/rust-lang/rust/commit/478d530af4879ae2ef829cf19370f9b518a98c11", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/478d530af4879ae2ef829cf19370f9b518a98c11/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "91dafebc91f9ef46e98ba4e592e8b1f6fb6a2145", "url": "https://api.github.com/repos/rust-lang/rust/commits/91dafebc91f9ef46e98ba4e592e8b1f6fb6a2145", "html_url": "https://github.com/rust-lang/rust/commit/91dafebc91f9ef46e98ba4e592e8b1f6fb6a2145"}, {"sha": "c9f1a541b36772800482c0b9de198caa1d6d6b2e", "url": "https://api.github.com/repos/rust-lang/rust/commits/c9f1a541b36772800482c0b9de198caa1d6d6b2e", "html_url": "https://github.com/rust-lang/rust/commit/c9f1a541b36772800482c0b9de198caa1d6d6b2e"}], "stats": {"total": 46, "additions": 28, "deletions": 18}, "files": [{"sha": "e7d1d9781d5c43acc9581f057961827726cef35c", "filename": "src/ci/docker/scripts/fuchsia-test-runner.py", "status": "modified", "additions": 26, "deletions": 13, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/478d530af4879ae2ef829cf19370f9b518a98c11/src%2Fci%2Fdocker%2Fscripts%2Ffuchsia-test-runner.py", "raw_url": "https://github.com/rust-lang/rust/raw/478d530af4879ae2ef829cf19370f9b518a98c11/src%2Fci%2Fdocker%2Fscripts%2Ffuchsia-test-runner.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fscripts%2Ffuchsia-test-runner.py?ref=478d530af4879ae2ef829cf19370f9b518a98c11", "patch": "@@ -9,6 +9,7 @@\n \n import argparse\n from dataclasses import dataclass\n+import fcntl\n import glob\n import hashlib\n import json\n@@ -146,6 +147,9 @@ def host_arch_triple(self):\n     def zxdb_script_path(self):\n         return os.path.join(self.tmp_dir(), \"zxdb_script\")\n \n+    def pm_lockfile_path(self):\n+        return os.path.join(self.tmp_dir(), \"pm.lock\")\n+\n     def log_info(self, msg):\n         print(msg)\n \n@@ -460,6 +464,9 @@ def start(self):\n             stderr=self.subprocess_output(),\n         )\n \n+        # Create lockfiles\n+        open(self.pm_lockfile_path(), 'a').close()\n+\n         # Write to file\n         self.write_to_file()\n \n@@ -676,19 +683,25 @@ def log(msg):\n             log(\"Publishing package to repo...\")\n \n             # Publish package to repo\n-            subprocess.check_call(\n-                [\n-                    self.tool_path(\"pm\"),\n-                    \"publish\",\n-                    \"-a\",\n-                    \"-repo\",\n-                    self.repo_dir(),\n-                    \"-f\",\n-                    far_path,\n-                ],\n-                stdout=log_file,\n-                stderr=log_file,\n-            )\n+            with open(self.pm_lockfile_path(), 'w') as pm_lockfile:\n+                fcntl.lockf(pm_lockfile.fileno(), fcntl.LOCK_EX)\n+                subprocess.check_call(\n+                    [\n+                        self.tool_path(\"pm\"),\n+                        \"publish\",\n+                        \"-a\",\n+                        \"-repo\",\n+                        self.repo_dir(),\n+                        \"-f\",\n+                        far_path,\n+                    ],\n+                    stdout=log_file,\n+                    stderr=log_file,\n+                )\n+                # This lock should be released automatically when the pm\n+                # lockfile is closed, but we'll be polite and unlock it now\n+                # since the spec leaves some wiggle room.\n+                fcntl.lockf(pm_lockfile.fileno(), fcntl.LOCK_UN)\n \n             log(\"Running ffx test...\")\n "}, {"sha": "4d97b8c6cb90b4d7c144a04498803cffe579ece9", "filename": "src/doc/rustc/src/platform-support/fuchsia.md", "status": "modified", "additions": 2, "deletions": 5, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/478d530af4879ae2ef829cf19370f9b518a98c11/src%2Fdoc%2Frustc%2Fsrc%2Fplatform-support%2Ffuchsia.md", "raw_url": "https://github.com/rust-lang/rust/raw/478d530af4879ae2ef829cf19370f9b518a98c11/src%2Fdoc%2Frustc%2Fsrc%2Fplatform-support%2Ffuchsia.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Frustc%2Fsrc%2Fplatform-support%2Ffuchsia.md?ref=478d530af4879ae2ef829cf19370f9b518a98c11", "patch": "@@ -716,7 +716,7 @@ run the full `tests/ui` test suite:\n     --stage=2                                                                 \\\n     test tests/ui                                                             \\\n     --target x86_64-unknown-fuchsia                                           \\\n-    --run=always --jobs 1                                                     \\\n+    --run=always                                                              \\\n     --test-args --target-rustcflags                                           \\\n     --test-args -Lnative=${SDK_PATH}/arch/{x64|arm64}/sysroot/lib             \\\n     --test-args --target-rustcflags                                           \\\n@@ -728,9 +728,6 @@ run the full `tests/ui` test suite:\n )\n ```\n \n-*Note: The test suite cannot be run in parallel at the moment, so `x.py`\n-must be run with `--jobs 1` to ensure only one test runs at a time.*\n-\n By default, `x.py` compiles test binaries with `panic=unwind`. If you built your\n Rust toolchain with `-Cpanic=abort`, you need to tell `x.py` to compile test\n binaries with `panic=abort` as well:\n@@ -907,7 +904,7 @@ through our `x.py` invocation. The full invocation is:\n     --stage=2                                                                 \\\n     test tests/${TEST}                                                        \\\n     --target x86_64-unknown-fuchsia                                           \\\n-    --run=always --jobs 1                                                     \\\n+    --run=always                                                              \\\n     --test-args --target-rustcflags                                           \\\n     --test-args -Lnative=${SDK_PATH}/arch/{x64|arm64}/sysroot/lib             \\\n     --test-args --target-rustcflags                                           \\"}]}