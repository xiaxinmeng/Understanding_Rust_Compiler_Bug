{"sha": "03c26f9b74644ee325b8d87db872675cce7cdab7", "node_id": "MDY6Q29tbWl0NzI0NzEyOjAzYzI2ZjliNzQ2NDRlZTMyNWI4ZDg3ZGI4NzI2NzVjY2U3Y2RhYjc=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2019-07-11T02:33:19Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-07-11T02:33:19Z"}, "message": "Rollup merge of #62519 - pnkfelix:add-test-for-30786, r=pnkfelix\n\nRegression test for HRTB bug (issue 30786).\n\nClose #30786.", "tree": {"sha": "dbb8248559cb3d03adde04b5f264f4dffecbed62", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/dbb8248559cb3d03adde04b5f264f4dffecbed62"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/03c26f9b74644ee325b8d87db872675cce7cdab7", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJdJp/vCRBK7hj4Ov3rIwAAdHIIAFu/z98zMJ3Df9l0DqiN4lRX\nIAwYGdYb2fOn9zR8MRCi7OHhcK0hcD/DGuMdS/cm3MWnRLpRwfbhIiNvW93Gu49k\niR+ChxGSHEQi4RStAvS8CM9oT7ap8E+vvTXtg+0uvLvbWBrfCfwFmT8rPtXfMjl+\nS60k1M/fKdCU7R7t+ZPFpTj8st99g6k/TpLU3n4w6IRNIWqqPflegOxJMKJYHg07\nP5eFITvMQ0u9klbV/QkNpfedITZXfCaMZWsoyoqdpO/m7Kj/PD1wbYXcsDc/WyqU\nZOYTiEa+5b+hSyIrinpyLUVt7MVibUi0WsWfGq/TR7NxJEYG1sJe/dw+/UBpKFo=\n=Kq8Y\n-----END PGP SIGNATURE-----\n", "payload": "tree dbb8248559cb3d03adde04b5f264f4dffecbed62\nparent 7697b2927f7eb161412487727a063e228862aa74\nparent fa0809d3cdacae8638fd7beea2e85310902e21d3\nauthor Mazdak Farrokhzad <twingoow@gmail.com> 1562812399 +0200\ncommitter GitHub <noreply@github.com> 1562812399 +0200\n\nRollup merge of #62519 - pnkfelix:add-test-for-30786, r=pnkfelix\n\nRegression test for HRTB bug (issue 30786).\n\nClose #30786.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/03c26f9b74644ee325b8d87db872675cce7cdab7", "html_url": "https://github.com/rust-lang/rust/commit/03c26f9b74644ee325b8d87db872675cce7cdab7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/03c26f9b74644ee325b8d87db872675cce7cdab7/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7697b2927f7eb161412487727a063e228862aa74", "url": "https://api.github.com/repos/rust-lang/rust/commits/7697b2927f7eb161412487727a063e228862aa74", "html_url": "https://github.com/rust-lang/rust/commit/7697b2927f7eb161412487727a063e228862aa74"}, {"sha": "fa0809d3cdacae8638fd7beea2e85310902e21d3", "url": "https://api.github.com/repos/rust-lang/rust/commits/fa0809d3cdacae8638fd7beea2e85310902e21d3", "html_url": "https://github.com/rust-lang/rust/commit/fa0809d3cdacae8638fd7beea2e85310902e21d3"}], "stats": {"total": 140, "additions": 140, "deletions": 0}, "files": [{"sha": "9a4f87728224515de44b7db4362ce1270264abe0", "filename": "src/test/ui/hrtb/issue-30786.migrate.stderr", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/03c26f9b74644ee325b8d87db872675cce7cdab7/src%2Ftest%2Fui%2Fhrtb%2Fissue-30786.migrate.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/03c26f9b74644ee325b8d87db872675cce7cdab7/src%2Ftest%2Fui%2Fhrtb%2Fissue-30786.migrate.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fhrtb%2Fissue-30786.migrate.stderr?ref=03c26f9b74644ee325b8d87db872675cce7cdab7", "patch": "@@ -0,0 +1,11 @@\n+error: implementation of `Stream` is not general enough\n+  --> $DIR/issue-30786.rs:107:22\n+   |\n+LL |     let map = source.map(|x: &_| x);\n+   |                      ^^^\n+   |\n+   = note: `Stream` would have to be implemented for the type `&'0 mut Map<Repeat, [closure@$DIR/issue-30786.rs:107:26: 107:35]>`, for any lifetime `'0`\n+   = note: but `Stream` is actually implemented for the type `&'1 mut Map<Repeat, [closure@$DIR/issue-30786.rs:107:26: 107:35]>`, for some specific lifetime `'1`\n+\n+error: aborting due to previous error\n+"}, {"sha": "5c865d76851d388fcf1a7fc482a99ef546564b11", "filename": "src/test/ui/hrtb/issue-30786.nll.stderr", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/03c26f9b74644ee325b8d87db872675cce7cdab7/src%2Ftest%2Fui%2Fhrtb%2Fissue-30786.nll.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/03c26f9b74644ee325b8d87db872675cce7cdab7/src%2Ftest%2Fui%2Fhrtb%2Fissue-30786.nll.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fhrtb%2Fissue-30786.nll.stderr?ref=03c26f9b74644ee325b8d87db872675cce7cdab7", "patch": "@@ -0,0 +1,14 @@\n+error: higher-ranked subtype error\n+  --> $DIR/issue-30786.rs:111:18\n+   |\n+LL |     let filter = map.filter(|x: &_| true);\n+   |                  ^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: higher-ranked subtype error\n+  --> $DIR/issue-30786.rs:113:17\n+   |\n+LL |     let count = filter.count(); // Assert that we still have a valid stream.\n+   |                 ^^^^^^^^^^^^^^\n+\n+error: aborting due to 2 previous errors\n+"}, {"sha": "321b83c3459d0c9a0d648400a2be19a97d7f987e", "filename": "src/test/ui/hrtb/issue-30786.rs", "status": "added", "additions": 115, "deletions": 0, "changes": 115, "blob_url": "https://github.com/rust-lang/rust/blob/03c26f9b74644ee325b8d87db872675cce7cdab7/src%2Ftest%2Fui%2Fhrtb%2Fissue-30786.rs", "raw_url": "https://github.com/rust-lang/rust/raw/03c26f9b74644ee325b8d87db872675cce7cdab7/src%2Ftest%2Fui%2Fhrtb%2Fissue-30786.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fhrtb%2Fissue-30786.rs?ref=03c26f9b74644ee325b8d87db872675cce7cdab7", "patch": "@@ -0,0 +1,115 @@\n+// rust-lang/rust#30786: the use of `for<'b> &'b mut A: Stream<Item=T`\n+// should act as assertion that item does not borrow from its stream;\n+// but an earlier buggy rustc allowed `.map(|x: &_| x)` which does\n+// have such an item.\n+//\n+// This tests double-checks that we do not allow such behavior to leak\n+// through again.\n+\n+// revisions: migrate nll\n+\n+// Since we are testing nll (and migration) explicitly as a separate\n+// revisions, don't worry about the --compare-mode=nll on this test.\n+\n+// ignore-compare-mode-nll\n+\n+//[nll]compile-flags: -Z borrowck=mir\n+\n+pub trait Stream {\n+    type Item;\n+    fn next(self) -> Option<Self::Item>;\n+}\n+\n+// Example stream\n+pub struct Repeat(u64);\n+\n+impl<'a> Stream for &'a mut Repeat {\n+    type Item = &'a u64;\n+    fn next(self) -> Option<Self::Item> {\n+        Some(&self.0)\n+    }\n+}\n+\n+pub struct Map<S, F> {\n+    stream: S,\n+    func: F,\n+}\n+\n+impl<'a, A, F, T> Stream for &'a mut Map<A, F>\n+where &'a mut A: Stream,\n+      F: FnMut(<&'a mut A as Stream>::Item) -> T,\n+{\n+    type Item = T;\n+    fn next(self) -> Option<T> {\n+        match self.stream.next() {\n+            Some(item) => Some((self.func)(item)),\n+            None => None,\n+        }\n+    }\n+}\n+\n+pub struct Filter<S, F> {\n+    stream: S,\n+    func: F,\n+}\n+\n+impl<'a, A, F, T> Stream for &'a mut Filter<A, F>\n+where for<'b> &'b mut A: Stream<Item=T>, // <---- BAD\n+      F: FnMut(&T) -> bool,\n+{\n+    type Item = <&'a mut A as Stream>::Item;\n+    fn next(self) -> Option<Self::Item> {\n+        while let Some(item) = self.stream.next() {\n+            if (self.func)(&item) {\n+                return Some(item);\n+            }\n+        }\n+        None\n+    }\n+}\n+\n+pub trait StreamExt where for<'b> &'b mut Self: Stream {\n+    fn map<F>(self, func: F) -> Map<Self, F>\n+    where Self: Sized,\n+    for<'a> &'a mut Map<Self, F>: Stream,\n+    {\n+        Map {\n+            func: func,\n+            stream: self,\n+        }\n+    }\n+\n+    fn filter<F>(self, func: F) -> Filter<Self, F>\n+    where Self: Sized,\n+    for<'a> &'a mut Filter<Self, F>: Stream,\n+    {\n+        Filter {\n+            func: func,\n+            stream: self,\n+        }\n+    }\n+\n+    fn count(mut self) -> usize\n+    where Self: Sized,\n+    {\n+        let mut count = 0;\n+        while let Some(_) = self.next() {\n+            count += 1;\n+        }\n+        count\n+    }\n+}\n+\n+impl<T> StreamExt for T where for<'a> &'a mut T: Stream { }\n+\n+fn main() {\n+    let source = Repeat(10);\n+    let map = source.map(|x: &_| x);\n+    //[migrate]~^ ERROR implementation of `Stream` is not general enough\n+    //[migrate]~| NOTE  `Stream` would have to be implemented for the type `&'0 mut Map\n+    //[migrate]~| NOTE  but `Stream` is actually implemented for the type `&'1\n+    let filter = map.filter(|x: &_| true);\n+    //[nll]~^ ERROR higher-ranked subtype error\n+    let count = filter.count(); // Assert that we still have a valid stream.\n+    //[nll]~^ ERROR higher-ranked subtype error\n+}"}]}