{"sha": "016f69f459d1b3819aa7c9d632a0dc78c7764406", "node_id": "MDY6Q29tbWl0NzI0NzEyOjAxNmY2OWY0NTlkMWIzODE5YWE3YzlkNjMyYTBkYzc4Yzc3NjQ0MDY=", "commit": {"author": {"name": "Nicholas Nethercote", "email": "nnethercote@mozilla.com", "date": "2016-10-19T01:06:46Z"}, "committer": {"name": "Nicholas Nethercote", "email": "nnethercote@mozilla.com", "date": "2016-10-19T03:00:48Z"}, "message": "Optimize `write_metadata`.\n\n`write_metadata` currently generates metadata unnecessarily in some\ncases, and also compresses it unnecessarily in some cases. This commit\nfixes that. It speeds up three of the rustc-benchmarks by 1--4%.", "tree": {"sha": "e54526dc2c31523cc8ddf0decc5c509705706b3d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e54526dc2c31523cc8ddf0decc5c509705706b3d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/016f69f459d1b3819aa7c9d632a0dc78c7764406", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/016f69f459d1b3819aa7c9d632a0dc78c7764406", "html_url": "https://github.com/rust-lang/rust/commit/016f69f459d1b3819aa7c9d632a0dc78c7764406", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/016f69f459d1b3819aa7c9d632a0dc78c7764406/comments", "author": {"login": "nnethercote", "id": 1940286, "node_id": "MDQ6VXNlcjE5NDAyODY=", "avatar_url": "https://avatars.githubusercontent.com/u/1940286?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nnethercote", "html_url": "https://github.com/nnethercote", "followers_url": "https://api.github.com/users/nnethercote/followers", "following_url": "https://api.github.com/users/nnethercote/following{/other_user}", "gists_url": "https://api.github.com/users/nnethercote/gists{/gist_id}", "starred_url": "https://api.github.com/users/nnethercote/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nnethercote/subscriptions", "organizations_url": "https://api.github.com/users/nnethercote/orgs", "repos_url": "https://api.github.com/users/nnethercote/repos", "events_url": "https://api.github.com/users/nnethercote/events{/privacy}", "received_events_url": "https://api.github.com/users/nnethercote/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nnethercote", "id": 1940286, "node_id": "MDQ6VXNlcjE5NDAyODY=", "avatar_url": "https://avatars.githubusercontent.com/u/1940286?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nnethercote", "html_url": "https://github.com/nnethercote", "followers_url": "https://api.github.com/users/nnethercote/followers", "following_url": "https://api.github.com/users/nnethercote/following{/other_user}", "gists_url": "https://api.github.com/users/nnethercote/gists{/gist_id}", "starred_url": "https://api.github.com/users/nnethercote/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nnethercote/subscriptions", "organizations_url": "https://api.github.com/users/nnethercote/orgs", "repos_url": "https://api.github.com/users/nnethercote/repos", "events_url": "https://api.github.com/users/nnethercote/events{/privacy}", "received_events_url": "https://api.github.com/users/nnethercote/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1d3dfa5301f59e86547a4034fb654c4efb47ac0e", "url": "https://api.github.com/repos/rust-lang/rust/commits/1d3dfa5301f59e86547a4034fb654c4efb47ac0e", "html_url": "https://github.com/rust-lang/rust/commit/1d3dfa5301f59e86547a4034fb654c4efb47ac0e"}], "stats": {"total": 32, "additions": 26, "deletions": 6}, "files": [{"sha": "02aa7c069f9b3d478a2fc1ba5d38ca37fb85115c", "filename": "src/librustc_trans/base.rs", "status": "modified", "additions": 26, "deletions": 6, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/016f69f459d1b3819aa7c9d632a0dc78c7764406/src%2Flibrustc_trans%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/016f69f459d1b3819aa7c9d632a0dc78c7764406/src%2Flibrustc_trans%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Fbase.rs?ref=016f69f459d1b3819aa7c9d632a0dc78c7764406", "patch": "@@ -1250,12 +1250,27 @@ fn write_metadata(cx: &SharedCrateContext,\n                   reachable_ids: &NodeSet) -> Vec<u8> {\n     use flate;\n \n-    let any_library = cx.sess()\n-                        .crate_types\n-                        .borrow()\n-                        .iter()\n-                        .any(|ty| *ty != config::CrateTypeExecutable);\n-    if !any_library {\n+    #[derive(PartialEq, Eq, PartialOrd, Ord)]\n+    enum MetadataKind {\n+        None,\n+        Uncompressed,\n+        Compressed\n+    }\n+\n+    let kind = cx.sess().crate_types.borrow().iter().map(|ty| {\n+        match *ty {\n+            config::CrateTypeExecutable |\n+            config::CrateTypeStaticlib |\n+            config::CrateTypeCdylib => MetadataKind::None,\n+\n+            config::CrateTypeRlib => MetadataKind::Uncompressed,\n+\n+            config::CrateTypeDylib |\n+            config::CrateTypeProcMacro => MetadataKind::Compressed,\n+        }\n+    }).max().unwrap();\n+\n+    if kind == MetadataKind::None {\n         return Vec::new();\n     }\n \n@@ -1265,6 +1280,11 @@ fn write_metadata(cx: &SharedCrateContext,\n                                           cx.link_meta(),\n                                           reachable_ids,\n                                           cx.mir_map());\n+    if kind == MetadataKind::Uncompressed {\n+        return metadata;\n+    }\n+\n+    assert!(kind == MetadataKind::Compressed);\n     let mut compressed = cstore.metadata_encoding_version().to_vec();\n     compressed.extend_from_slice(&flate::deflate_bytes(&metadata));\n "}]}