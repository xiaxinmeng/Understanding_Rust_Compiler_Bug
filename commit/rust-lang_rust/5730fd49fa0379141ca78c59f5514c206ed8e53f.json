{"sha": "5730fd49fa0379141ca78c59f5514c206ed8e53f", "node_id": "C_kwDOAAsO6NoAKDU3MzBmZDQ5ZmEwMzc5MTQxY2E3OGM1OWY1NTE0YzIwNmVkOGU1M2Y", "commit": {"author": {"name": "Alex Macleod", "email": "alex@macleod.io", "date": "2022-05-20T12:39:15Z"}, "committer": {"name": "Alex Macleod", "email": "alex@macleod.io", "date": "2022-05-20T12:39:15Z"}, "message": "Lint indirect usages in `disallowed_methods`", "tree": {"sha": "2d0d1fa4619d0543470eef01c47cc6bcb971962c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2d0d1fa4619d0543470eef01c47cc6bcb971962c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5730fd49fa0379141ca78c59f5514c206ed8e53f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5730fd49fa0379141ca78c59f5514c206ed8e53f", "html_url": "https://github.com/rust-lang/rust/commit/5730fd49fa0379141ca78c59f5514c206ed8e53f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5730fd49fa0379141ca78c59f5514c206ed8e53f/comments", "author": {"login": "Alexendoo", "id": 1830331, "node_id": "MDQ6VXNlcjE4MzAzMzE=", "avatar_url": "https://avatars.githubusercontent.com/u/1830331?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Alexendoo", "html_url": "https://github.com/Alexendoo", "followers_url": "https://api.github.com/users/Alexendoo/followers", "following_url": "https://api.github.com/users/Alexendoo/following{/other_user}", "gists_url": "https://api.github.com/users/Alexendoo/gists{/gist_id}", "starred_url": "https://api.github.com/users/Alexendoo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Alexendoo/subscriptions", "organizations_url": "https://api.github.com/users/Alexendoo/orgs", "repos_url": "https://api.github.com/users/Alexendoo/repos", "events_url": "https://api.github.com/users/Alexendoo/events{/privacy}", "received_events_url": "https://api.github.com/users/Alexendoo/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Alexendoo", "id": 1830331, "node_id": "MDQ6VXNlcjE4MzAzMzE=", "avatar_url": "https://avatars.githubusercontent.com/u/1830331?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Alexendoo", "html_url": "https://github.com/Alexendoo", "followers_url": "https://api.github.com/users/Alexendoo/followers", "following_url": "https://api.github.com/users/Alexendoo/following{/other_user}", "gists_url": "https://api.github.com/users/Alexendoo/gists{/gist_id}", "starred_url": "https://api.github.com/users/Alexendoo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Alexendoo/subscriptions", "organizations_url": "https://api.github.com/users/Alexendoo/orgs", "repos_url": "https://api.github.com/users/Alexendoo/repos", "events_url": "https://api.github.com/users/Alexendoo/events{/privacy}", "received_events_url": "https://api.github.com/users/Alexendoo/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6f26383f8ec8dfe89858876eac127161d148eb13", "url": "https://api.github.com/repos/rust-lang/rust/commits/6f26383f8ec8dfe89858876eac127161d148eb13", "html_url": "https://github.com/rust-lang/rust/commit/6f26383f8ec8dfe89858876eac127161d148eb13"}], "stats": {"total": 40, "additions": 36, "deletions": 4}, "files": [{"sha": "53973ab792a91a50cb55da6c89e8e8d6cbdd5c69", "filename": "clippy_lints/src/disallowed_methods.rs", "status": "modified", "additions": 11, "deletions": 3, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/5730fd49fa0379141ca78c59f5514c206ed8e53f/clippy_lints%2Fsrc%2Fdisallowed_methods.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5730fd49fa0379141ca78c59f5514c206ed8e53f/clippy_lints%2Fsrc%2Fdisallowed_methods.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fdisallowed_methods.rs?ref=5730fd49fa0379141ca78c59f5514c206ed8e53f", "patch": "@@ -1,7 +1,7 @@\n use clippy_utils::diagnostics::span_lint_and_then;\n-use clippy_utils::fn_def_id;\n+use clippy_utils::{fn_def_id, get_parent_expr, path_def_id};\n \n-use rustc_hir::{def::Res, def_id::DefIdMap, Expr};\n+use rustc_hir::{def::Res, def_id::DefIdMap, Expr, ExprKind};\n use rustc_lint::{LateContext, LateLintPass};\n use rustc_session::{declare_tool_lint, impl_lint_pass};\n \n@@ -84,7 +84,15 @@ impl<'tcx> LateLintPass<'tcx> for DisallowedMethods {\n     }\n \n     fn check_expr(&mut self, cx: &LateContext<'tcx>, expr: &'tcx Expr<'_>) {\n-        let def_id = match fn_def_id(cx, expr) {\n+        let uncalled_path = if let Some(parent) = get_parent_expr(cx, expr)\n+            && let ExprKind::Call(receiver, _) = parent.kind\n+            && receiver.hir_id == expr.hir_id\n+        {\n+            None\n+        } else {\n+            path_def_id(cx, expr)\n+        };\n+        let def_id = match uncalled_path.or_else(|| fn_def_id(cx, expr)) {\n             Some(def_id) => def_id,\n             None => return,\n         };"}, {"sha": "3397fa1ec69278b088ee7adf767b7bca8490e566", "filename": "tests/ui-toml/toml_disallowed_methods/conf_disallowed_methods.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/5730fd49fa0379141ca78c59f5514c206ed8e53f/tests%2Fui-toml%2Ftoml_disallowed_methods%2Fconf_disallowed_methods.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5730fd49fa0379141ca78c59f5514c206ed8e53f/tests%2Fui-toml%2Ftoml_disallowed_methods%2Fconf_disallowed_methods.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui-toml%2Ftoml_disallowed_methods%2Fconf_disallowed_methods.rs?ref=5730fd49fa0379141ca78c59f5514c206ed8e53f", "patch": "@@ -14,4 +14,10 @@ fn main() {\n \n     let _ = 2.0f32.clamp(3.0f32, 4.0f32);\n     let _ = 2.0f64.clamp(3.0f64, 4.0f64);\n+\n+    let indirect: fn(&str) -> Result<Regex, regex::Error> = Regex::new;\n+    let re = indirect(\".\").unwrap();\n+\n+    let in_call = Box::new(f32::clamp);\n+    let in_method_call = [\"^\", \"$\"].into_iter().map(Regex::new);\n }"}, {"sha": "5cbb567546c085583c8a454eff057902fcfa5bd7", "filename": "tests/ui-toml/toml_disallowed_methods/conf_disallowed_methods.stderr", "status": "modified", "additions": 19, "deletions": 1, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/5730fd49fa0379141ca78c59f5514c206ed8e53f/tests%2Fui-toml%2Ftoml_disallowed_methods%2Fconf_disallowed_methods.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/5730fd49fa0379141ca78c59f5514c206ed8e53f/tests%2Fui-toml%2Ftoml_disallowed_methods%2Fconf_disallowed_methods.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui-toml%2Ftoml_disallowed_methods%2Fconf_disallowed_methods.stderr?ref=5730fd49fa0379141ca78c59f5514c206ed8e53f", "patch": "@@ -32,5 +32,23 @@ error: use of a disallowed method `f32::clamp`\n LL |     let _ = 2.0f32.clamp(3.0f32, 4.0f32);\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n-error: aborting due to 5 previous errors\n+error: use of a disallowed method `regex::Regex::new`\n+  --> $DIR/conf_disallowed_methods.rs:18:61\n+   |\n+LL |     let indirect: fn(&str) -> Result<Regex, regex::Error> = Regex::new;\n+   |                                                             ^^^^^^^^^^\n+\n+error: use of a disallowed method `f32::clamp`\n+  --> $DIR/conf_disallowed_methods.rs:21:28\n+   |\n+LL |     let in_call = Box::new(f32::clamp);\n+   |                            ^^^^^^^^^^\n+\n+error: use of a disallowed method `regex::Regex::new`\n+  --> $DIR/conf_disallowed_methods.rs:22:53\n+   |\n+LL |     let in_method_call = [\"^\", \"$\"].into_iter().map(Regex::new);\n+   |                                                     ^^^^^^^^^^\n+\n+error: aborting due to 8 previous errors\n "}]}