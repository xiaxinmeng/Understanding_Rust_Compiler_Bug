{"sha": "3436699ed6249e655bd8da4fd4630b646db2f93f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjM0MzY2OTllZDYyNDllNjU1YmQ4ZGE0ZmQ0NjMwYjY0NmRiMmY5M2Y=", "commit": {"author": {"name": "llogiq", "email": "bogusandre@gmail.com", "date": "2016-06-05T19:04:03Z"}, "committer": {"name": "llogiq", "email": "bogusandre@gmail.com", "date": "2016-06-05T19:04:03Z"}, "message": "Merge pull request #984 from Manishearth/fix-swap\n\n Fix wrong suggestion with `MANUAL_SWAP` and slices", "tree": {"sha": "0ab1f4588e55e4c2e1d074fab2b610df507b924c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0ab1f4588e55e4c2e1d074fab2b610df507b924c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3436699ed6249e655bd8da4fd4630b646db2f93f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3436699ed6249e655bd8da4fd4630b646db2f93f", "html_url": "https://github.com/rust-lang/rust/commit/3436699ed6249e655bd8da4fd4630b646db2f93f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3436699ed6249e655bd8da4fd4630b646db2f93f/comments", "author": {"login": "llogiq", "id": 4200835, "node_id": "MDQ6VXNlcjQyMDA4MzU=", "avatar_url": "https://avatars.githubusercontent.com/u/4200835?v=4", "gravatar_id": "", "url": "https://api.github.com/users/llogiq", "html_url": "https://github.com/llogiq", "followers_url": "https://api.github.com/users/llogiq/followers", "following_url": "https://api.github.com/users/llogiq/following{/other_user}", "gists_url": "https://api.github.com/users/llogiq/gists{/gist_id}", "starred_url": "https://api.github.com/users/llogiq/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/llogiq/subscriptions", "organizations_url": "https://api.github.com/users/llogiq/orgs", "repos_url": "https://api.github.com/users/llogiq/repos", "events_url": "https://api.github.com/users/llogiq/events{/privacy}", "received_events_url": "https://api.github.com/users/llogiq/received_events", "type": "User", "site_admin": false}, "committer": {"login": "llogiq", "id": 4200835, "node_id": "MDQ6VXNlcjQyMDA4MzU=", "avatar_url": "https://avatars.githubusercontent.com/u/4200835?v=4", "gravatar_id": "", "url": "https://api.github.com/users/llogiq", "html_url": "https://github.com/llogiq", "followers_url": "https://api.github.com/users/llogiq/followers", "following_url": "https://api.github.com/users/llogiq/following{/other_user}", "gists_url": "https://api.github.com/users/llogiq/gists{/gist_id}", "starred_url": "https://api.github.com/users/llogiq/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/llogiq/subscriptions", "organizations_url": "https://api.github.com/users/llogiq/orgs", "repos_url": "https://api.github.com/users/llogiq/repos", "events_url": "https://api.github.com/users/llogiq/events{/privacy}", "received_events_url": "https://api.github.com/users/llogiq/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d325775468a9aca2f472637d17e206e6309b95a9", "url": "https://api.github.com/repos/rust-lang/rust/commits/d325775468a9aca2f472637d17e206e6309b95a9", "html_url": "https://github.com/rust-lang/rust/commit/d325775468a9aca2f472637d17e206e6309b95a9"}, {"sha": "7bc7c675f2fe1fc9176cd45baa3361037b487dec", "url": "https://api.github.com/repos/rust-lang/rust/commits/7bc7c675f2fe1fc9176cd45baa3361037b487dec", "html_url": "https://github.com/rust-lang/rust/commit/7bc7c675f2fe1fc9176cd45baa3361037b487dec"}], "stats": {"total": 138, "additions": 97, "deletions": 41}, "files": [{"sha": "877b9037d378d1181426eb725848277161ad6637", "filename": "clippy_lints/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/3436699ed6249e655bd8da4fd4630b646db2f93f/clippy_lints%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/3436699ed6249e655bd8da4fd4630b646db2f93f/clippy_lints%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2FCargo.toml?ref=3436699ed6249e655bd8da4fd4630b646db2f93f", "patch": "@@ -16,6 +16,7 @@ license = \"MPL-2.0\"\n keywords = [\"clippy\", \"lint\", \"plugin\"]\n \n [dependencies]\n+matches = \"0.1.2\"\n regex-syntax = \"0.3.0\"\n semver = \"0.2.1\"\n toml = \"0.1\""}, {"sha": "b8f1bb71ad95c57e61e275359ae13216d99f3390", "filename": "clippy_lints/src/block_in_if_condition.rs", "status": "modified", "additions": 1, "deletions": 4, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/3436699ed6249e655bd8da4fd4630b646db2f93f/clippy_lints%2Fsrc%2Fblock_in_if_condition.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3436699ed6249e655bd8da4fd4630b646db2f93f/clippy_lints%2Fsrc%2Fblock_in_if_condition.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fblock_in_if_condition.rs?ref=3436699ed6249e655bd8da4fd4630b646db2f93f", "patch": "@@ -47,10 +47,7 @@ impl<'v> Visitor<'v> for ExVisitor<'v> {\n             let complex = {\n                 if block.stmts.is_empty() {\n                     if let Some(ref ex) = block.expr {\n-                        match ex.node {\n-                            ExprBlock(_) => true,\n-                            _ => false,\n-                        }\n+                        matches!(ex.node, ExprBlock(_))\n                     } else {\n                         false\n                     }"}, {"sha": "b941d9a7fca42c9ca8f244875001ca532934ff61", "filename": "clippy_lints/src/derive.rs", "status": "modified", "additions": 2, "deletions": 4, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/3436699ed6249e655bd8da4fd4630b646db2f93f/clippy_lints%2Fsrc%2Fderive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3436699ed6249e655bd8da4fd4630b646db2f93f/clippy_lints%2Fsrc%2Fderive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fderive.rs?ref=3436699ed6249e655bd8da4fd4630b646db2f93f", "patch": "@@ -70,9 +70,7 @@ impl LintPass for Derive {\n \n impl LateLintPass for Derive {\n     fn check_item(&mut self, cx: &LateContext, item: &Item) {\n-        if_let_chain! {[\n-            let ItemImpl(_, _, _, Some(ref trait_ref), _, _) = item.node\n-        ], {\n+        if let ItemImpl(_, _, _, Some(ref trait_ref), _, _) = item.node {\n             let ty = cx.tcx.lookup_item_type(cx.tcx.map.local_def_id(item.id)).ty;\n             let is_automatically_derived = item.attrs.iter().any(is_automatically_derived);\n \n@@ -81,7 +79,7 @@ impl LateLintPass for Derive {\n             if !is_automatically_derived {\n                 check_copy_clone(cx, item, trait_ref, ty);\n             }\n-        }}\n+        }\n     }\n }\n "}, {"sha": "857e11b0bd355e8ebdf938c24fc4b5e5e456b8cc", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/3436699ed6249e655bd8da4fd4630b646db2f93f/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3436699ed6249e655bd8da4fd4630b646db2f93f/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=3436699ed6249e655bd8da4fd4630b646db2f93f", "patch": "@@ -42,6 +42,9 @@ extern crate rustc_plugin;\n extern crate rustc_const_eval;\n extern crate rustc_const_math;\n \n+#[macro_use]\n+extern crate matches as matches_macro;\n+\n macro_rules! declare_restriction_lint {\n     { pub $name:tt, $description:tt } => {\n         declare_lint! { pub $name, Allow, $description }"}, {"sha": "c37fbba9250d4dd8e76713dfc56d5c669e00a389", "filename": "clippy_lints/src/methods.rs", "status": "modified", "additions": 4, "deletions": 9, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/3436699ed6249e655bd8da4fd4630b646db2f93f/clippy_lints%2Fsrc%2Fmethods.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3436699ed6249e655bd8da4fd4630b646db2f93f/clippy_lints%2Fsrc%2Fmethods.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmethods.rs?ref=3436699ed6249e655bd8da4fd4630b646db2f93f", "patch": "@@ -1023,11 +1023,7 @@ impl OutType {\n             (&OutType::Bool, &hir::Return(ref ty)) if is_bool(ty) => true,\n             (&OutType::Any, &hir::Return(ref ty)) if ty.node != hir::TyTup(vec![].into()) => true,\n             (&OutType::Ref, &hir::Return(ref ty)) => {\n-                if let hir::TyRptr(_, _) = ty.node {\n-                    true\n-                } else {\n-                    false\n-                }\n+                matches!(ty.node, hir::TyRptr(_, _))\n             }\n             _ => false,\n         }\n@@ -1036,11 +1032,10 @@ impl OutType {\n \n fn is_bool(ty: &hir::Ty) -> bool {\n     if let hir::TyPath(None, ref p) = ty.node {\n-        if match_path(p, &[\"bool\"]) {\n-            return true;\n-        }\n+        match_path(p, &[\"bool\"])\n+    } else {\n+        false\n     }\n-    false\n }\n \n fn is_copy<'a, 'ctx>(cx: &LateContext<'a, 'ctx>, ty: ty::Ty<'ctx>, item: &hir::Item) -> bool {"}, {"sha": "53f4c972644832a11ee857ceed84ffbd0da1146f", "filename": "clippy_lints/src/misc.rs", "status": "modified", "additions": 3, "deletions": 14, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/3436699ed6249e655bd8da4fd4630b646db2f93f/clippy_lints%2Fsrc%2Fmisc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3436699ed6249e655bd8da4fd4630b646db2f93f/clippy_lints%2Fsrc%2Fmisc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmisc.rs?ref=3436699ed6249e655bd8da4fd4630b646db2f93f", "patch": "@@ -189,11 +189,7 @@ fn is_allowed(cx: &LateContext, expr: &Expr) -> bool {\n }\n \n fn is_float(cx: &LateContext, expr: &Expr) -> bool {\n-    if let ty::TyFloat(_) = walk_ptrs_ty(cx.tcx.expr_ty(expr)).sty {\n-        true\n-    } else {\n-        false\n-    }\n+    matches!(walk_ptrs_ty(cx.tcx.expr_ty(expr)).sty, ty::TyFloat(_))\n }\n \n /// **What it does:** This lint checks for conversions to owned values just for the sake of a comparison.\n@@ -283,11 +279,7 @@ fn check_to_owned(cx: &LateContext, expr: &Expr, other: &Expr, left: bool, op: S\n \n fn is_str_arg(cx: &LateContext, args: &[P<Expr>]) -> bool {\n     args.len() == 1 &&\n-    if let ty::TyStr = walk_ptrs_ty(cx.tcx.expr_ty(&args[0])).sty {\n-        true\n-    } else {\n-        false\n-    }\n+        matches!(walk_ptrs_ty(cx.tcx.expr_ty(&args[0])).sty, ty::TyStr)\n }\n \n /// **What it does:** This lint checks for getting the remainder of a division by one.\n@@ -449,10 +441,7 @@ fn is_used(cx: &LateContext, expr: &Expr) -> bool {\n fn in_attributes_expansion(cx: &LateContext, expr: &Expr) -> bool {\n     cx.sess().codemap().with_expn_info(expr.span.expn_id, |info_opt| {\n         info_opt.map_or(false, |info| {\n-            match info.callee.format {\n-                ExpnFormat::MacroAttribute(_) => true,\n-                _ => false,\n-            }\n+            matches!(info.callee.format, ExpnFormat::MacroAttribute(_))\n         })\n     })\n }"}, {"sha": "5a3adfee409d1f92382083d6a1753437656140d6", "filename": "clippy_lints/src/swap.rs", "status": "modified", "additions": 42, "deletions": 9, "changes": 51, "blob_url": "https://github.com/rust-lang/rust/blob/3436699ed6249e655bd8da4fd4630b646db2f93f/clippy_lints%2Fsrc%2Fswap.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3436699ed6249e655bd8da4fd4630b646db2f93f/clippy_lints%2Fsrc%2Fswap.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fswap.rs?ref=3436699ed6249e655bd8da4fd4630b646db2f93f", "patch": "@@ -1,7 +1,8 @@\n-use rustc::lint::*;\n use rustc::hir::*;\n+use rustc::lint::*;\n+use rustc::ty;\n use syntax::codemap::mk_sp;\n-use utils::{differing_macro_contexts, snippet_opt, span_lint_and_then, SpanlessEq};\n+use utils::{differing_macro_contexts, match_type, paths, snippet, snippet_opt, span_lint_and_then, walk_ptrs_ty, SpanlessEq};\n \n /// **What it does:** This lints manual swapping.\n ///\n@@ -79,10 +80,40 @@ fn check_manual_swap(cx: &LateContext, block: &Block) {\n             SpanlessEq::new(cx).ignore_fn().eq_expr(tmp_init, lhs1),\n             SpanlessEq::new(cx).ignore_fn().eq_expr(rhs1, lhs2)\n         ], {\n-            let (what, lhs, rhs) = if let (Some(first), Some(second)) = (snippet_opt(cx, lhs1.span), snippet_opt(cx, rhs1.span)) {\n-                (format!(\" `{}` and `{}`\", first, second), first, second)\n+            fn check_for_slice<'a>(cx: &LateContext, lhs1: &'a Expr, lhs2: &'a Expr) -> Option<(&'a Expr, &'a Expr, &'a Expr)> {\n+                if let ExprIndex(ref lhs1, ref idx1) = lhs1.node {\n+                    if let ExprIndex(ref lhs2, ref idx2) = lhs2.node {\n+                        if SpanlessEq::new(cx).ignore_fn().eq_expr(lhs1, lhs2) {\n+                            let ty = walk_ptrs_ty(cx.tcx.expr_ty(lhs1));\n+\n+                            if matches!(ty.sty, ty::TySlice(_)) ||\n+                                matches!(ty.sty, ty::TyArray(_, _)) ||\n+                                match_type(cx, ty, &paths::VEC) ||\n+                                match_type(cx, ty, &paths::VEC_DEQUE) {\n+                                    return Some((lhs1, idx1, idx2));\n+                            }\n+                        }\n+                    }\n+                }\n+\n+                None\n+            }\n+\n+            let (replace, what, sugg) = if let Some((slice, idx1, idx2)) = check_for_slice(cx, lhs1, lhs2) {\n+                if let Some(slice) = snippet_opt(cx, slice.span) {\n+                    (false,\n+                     format!(\" elements of `{}`\", slice),\n+                     format!(\"{}.swap({}, {})\",slice,  snippet(cx, idx1.span, \"..\"), snippet(cx, idx2.span, \"..\")))\n+                } else {\n+                    (false, \"\".to_owned(), \"\".to_owned())\n+                }\n             } else {\n-                (\"\".to_owned(), \"\".to_owned(), \"\".to_owned())\n+                 if let (Some(first), Some(second)) = (snippet_opt(cx, lhs1.span), snippet_opt(cx, rhs1.span)) {\n+                    (true, format!(\" `{}` and `{}`\", first, second),\n+                     format!(\"std::mem::swap(&mut {}, &mut {})\", first, second))\n+                } else {\n+                    (true, \"\".to_owned(), \"\".to_owned())\n+                }\n             };\n \n             let span = mk_sp(w[0].span.lo, second.span.hi);\n@@ -92,10 +123,12 @@ fn check_manual_swap(cx: &LateContext, block: &Block) {\n                                span,\n                                &format!(\"this looks like you are swapping{} manually\", what),\n                                |db| {\n-                                   if !what.is_empty() {\n-                                       db.span_suggestion(span, \"try\",\n-                                                          format!(\"std::mem::swap(&mut {}, &mut {})\", lhs, rhs));\n-                                       db.note(\"or maybe you should use `std::mem::replace`?\");\n+                                   if !sugg.is_empty() {\n+                                       db.span_suggestion(span, \"try\", sugg);\n+\n+                                       if replace {\n+                                           db.note(\"or maybe you should use `std::mem::replace`?\");\n+                                       }\n                                    }\n                                });\n         }}"}, {"sha": "c41354675566ea721b3a1e4374cee2163db2e05b", "filename": "tests/compile-fail/swap.rs", "status": "modified", "additions": 41, "deletions": 1, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/3436699ed6249e655bd8da4fd4630b646db2f93f/tests%2Fcompile-fail%2Fswap.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3436699ed6249e655bd8da4fd4630b646db2f93f/tests%2Fcompile-fail%2Fswap.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Fswap.rs?ref=3436699ed6249e655bd8da4fd4630b646db2f93f", "patch": "@@ -2,11 +2,51 @@\n #![plugin(clippy)]\n \n #![deny(clippy)]\n-#![allow(unused_assignments)]\n+#![allow(blacklisted_name, unused_assignments)]\n \n struct Foo(u32);\n \n+fn array() {\n+    let mut foo = [1, 2];\n+    let temp = foo[0];\n+    foo[0] = foo[1];\n+    foo[1] = temp;\n+    //~^^^ ERROR this looks like you are swapping elements of `foo` manually\n+    //~| HELP try\n+    //~| SUGGESTION foo.swap(0, 1);\n+\n+    foo.swap(0, 1);\n+}\n+\n+fn slice() {\n+    let foo = &mut [1, 2];\n+    let temp = foo[0];\n+    foo[0] = foo[1];\n+    foo[1] = temp;\n+    //~^^^ ERROR this looks like you are swapping elements of `foo` manually\n+    //~| HELP try\n+    //~| SUGGESTION foo.swap(0, 1);\n+\n+    foo.swap(0, 1);\n+}\n+\n+fn vec() {\n+    let mut foo = vec![1, 2];\n+    let temp = foo[0];\n+    foo[0] = foo[1];\n+    foo[1] = temp;\n+    //~^^^ ERROR this looks like you are swapping elements of `foo` manually\n+    //~| HELP try\n+    //~| SUGGESTION foo.swap(0, 1);\n+\n+    foo.swap(0, 1);\n+}\n+\n fn main() {\n+    array();\n+    slice();\n+    vec();\n+\n     let mut a = 42;\n     let mut b = 1337;\n "}]}