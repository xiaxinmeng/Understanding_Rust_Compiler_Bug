{"sha": "b23de51dcbd8f50094a716c0d99b44fdfa68e474", "node_id": "MDY6Q29tbWl0NzI0NzEyOmIyM2RlNTFkY2JkOGY1MDA5NGE3MTZjMGQ5OWI0NGZkZmE2OGU0NzQ=", "commit": {"author": {"name": "Caleb Zulawski", "email": "caleb.zulawski@gmail.com", "date": "2021-08-03T03:33:09Z"}, "committer": {"name": "Caleb Zulawski", "email": "caleb.zulawski@gmail.com", "date": "2021-08-03T03:33:09Z"}, "message": "Allow generic SIMD array element type", "tree": {"sha": "8bb4357d3869c97a0bcf597c19a36dbfeb9db1ce", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8bb4357d3869c97a0bcf597c19a36dbfeb9db1ce"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b23de51dcbd8f50094a716c0d99b44fdfa68e474", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b23de51dcbd8f50094a716c0d99b44fdfa68e474", "html_url": "https://github.com/rust-lang/rust/commit/b23de51dcbd8f50094a716c0d99b44fdfa68e474", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b23de51dcbd8f50094a716c0d99b44fdfa68e474/comments", "author": {"login": "calebzulawski", "id": 563826, "node_id": "MDQ6VXNlcjU2MzgyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/563826?v=4", "gravatar_id": "", "url": "https://api.github.com/users/calebzulawski", "html_url": "https://github.com/calebzulawski", "followers_url": "https://api.github.com/users/calebzulawski/followers", "following_url": "https://api.github.com/users/calebzulawski/following{/other_user}", "gists_url": "https://api.github.com/users/calebzulawski/gists{/gist_id}", "starred_url": "https://api.github.com/users/calebzulawski/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/calebzulawski/subscriptions", "organizations_url": "https://api.github.com/users/calebzulawski/orgs", "repos_url": "https://api.github.com/users/calebzulawski/repos", "events_url": "https://api.github.com/users/calebzulawski/events{/privacy}", "received_events_url": "https://api.github.com/users/calebzulawski/received_events", "type": "User", "site_admin": false}, "committer": {"login": "calebzulawski", "id": 563826, "node_id": "MDQ6VXNlcjU2MzgyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/563826?v=4", "gravatar_id": "", "url": "https://api.github.com/users/calebzulawski", "html_url": "https://github.com/calebzulawski", "followers_url": "https://api.github.com/users/calebzulawski/followers", "following_url": "https://api.github.com/users/calebzulawski/following{/other_user}", "gists_url": "https://api.github.com/users/calebzulawski/gists{/gist_id}", "starred_url": "https://api.github.com/users/calebzulawski/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/calebzulawski/subscriptions", "organizations_url": "https://api.github.com/users/calebzulawski/orgs", "repos_url": "https://api.github.com/users/calebzulawski/repos", "events_url": "https://api.github.com/users/calebzulawski/events{/privacy}", "received_events_url": "https://api.github.com/users/calebzulawski/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e3b1c12becebd21d88ca9f4364d7db8d1d380c18", "url": "https://api.github.com/repos/rust-lang/rust/commits/e3b1c12becebd21d88ca9f4364d7db8d1d380c18", "html_url": "https://github.com/rust-lang/rust/commit/e3b1c12becebd21d88ca9f4364d7db8d1d380c18"}], "stats": {"total": 77, "additions": 62, "deletions": 15}, "files": [{"sha": "ba99e0c03d8e2d4895b2de7787f94892337cfd8a", "filename": "compiler/rustc_typeck/src/check/check.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/b23de51dcbd8f50094a716c0d99b44fdfa68e474/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fcheck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b23de51dcbd8f50094a716c0d99b44fdfa68e474/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fcheck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fcheck.rs?ref=b23de51dcbd8f50094a716c0d99b44fdfa68e474", "patch": "@@ -1220,6 +1220,7 @@ pub fn check_simd(tcx: TyCtxt<'_>, sp: Span, def_id: LocalDefId) {\n             match e.kind() {\n                 ty::Param(_) => (), // pass struct<T>(T, T, T, T) through, let monomorphization catch errors\n                 ty::Int(_) | ty::Uint(_) | ty::Float(_) | ty::RawPtr(_) => (), // struct(u8, u8, u8, u8) is ok\n+                ty::Array(t, _) if matches!(t.kind(), ty::Param(_)) => (), // pass struct<T>([T; N]) through, let monomorphization catch errors\n                 ty::Array(t, _clen)\n                     if matches!(\n                         t.kind(),"}, {"sha": "fa9d35ee4df854b5c207085c9e4c014faaa25fe2", "filename": "src/test/ui/simd/simd-generics.rs", "status": "modified", "additions": 43, "deletions": 15, "changes": 58, "blob_url": "https://github.com/rust-lang/rust/blob/b23de51dcbd8f50094a716c0d99b44fdfa68e474/src%2Ftest%2Fui%2Fsimd%2Fsimd-generics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b23de51dcbd8f50094a716c0d99b44fdfa68e474/src%2Ftest%2Fui%2Fsimd%2Fsimd-generics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsimd%2Fsimd-generics.rs?ref=b23de51dcbd8f50094a716c0d99b44fdfa68e474", "patch": "@@ -10,7 +10,15 @@ struct f32x4(f32, f32, f32, f32);\n \n #[repr(simd)]\n #[derive(Copy, Clone)]\n-struct S<const N: usize>([f32; N]);\n+struct A<const N: usize>([f32; N]);\n+\n+#[repr(simd)]\n+#[derive(Copy, Clone)]\n+struct B<T>([T; 4]);\n+\n+#[repr(simd)]\n+#[derive(Copy, Clone)]\n+struct C<T, const N: usize>([T; N]);\n \n \n extern \"platform-intrinsic\" {\n@@ -29,7 +37,23 @@ impl ops::Add for f32x4 {\n     }\n }\n \n-impl ops::Add for S<4> {\n+impl ops::Add for A<4> {\n+    type Output = Self;\n+\n+    fn add(self, rhs: Self) -> Self {\n+        unsafe { simd_add(self, rhs) }\n+    }\n+}\n+\n+impl ops::Add for B<f32> {\n+    type Output = Self;\n+\n+    fn add(self, rhs: Self) -> Self {\n+        unsafe { simd_add(self, rhs) }\n+    }\n+}\n+\n+impl ops::Add for C<f32, 4> {\n     type Output = Self;\n \n     fn add(self, rhs: Self) -> Self {\n@@ -39,19 +63,23 @@ impl ops::Add for S<4> {\n \n \n pub fn main() {\n-    let lr = f32x4(1.0f32, 2.0f32, 3.0f32, 4.0f32);\n+    let x = [1.0f32, 2.0f32, 3.0f32, 4.0f32];\n+    let y = [2.0f32, 4.0f32, 6.0f32, 8.0f32];\n \n     // lame-o\n-    let f32x4(x, y, z, w) = add(lr, lr);\n-    assert_eq!(x, 2.0f32);\n-    assert_eq!(y, 4.0f32);\n-    assert_eq!(z, 6.0f32);\n-    assert_eq!(w, 8.0f32);\n-\n-    let lr2 = S::<4>([1.0f32, 2.0f32, 3.0f32, 4.0f32]);\n-    let [x, y, z, w] = add(lr2, lr2).0;\n-    assert_eq!(x, 2.0f32);\n-    assert_eq!(y, 4.0f32);\n-    assert_eq!(z, 6.0f32);\n-    assert_eq!(w, 8.0f32);\n+    let a = f32x4(1.0f32, 2.0f32, 3.0f32, 4.0f32);\n+    let f32x4(a0, a1, a2, a3) = add(a, a);\n+    assert_eq!(a0, 2.0f32);\n+    assert_eq!(a1, 4.0f32);\n+    assert_eq!(a2, 6.0f32);\n+    assert_eq!(a3, 8.0f32);\n+\n+    let a = A(x);\n+    assert_eq!(add(a, a).0, y);\n+\n+    let b = B(x);\n+    assert_eq!(add(b, b).0, y);\n+\n+    let c = C(x);\n+    assert_eq!(add(c, c).0, y);\n }"}, {"sha": "0bc73b155801eb5830b453785b98cbfe4b9eba20", "filename": "src/test/ui/simd/simd-type-generic-monomorphisation-non-primitive.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/b23de51dcbd8f50094a716c0d99b44fdfa68e474/src%2Ftest%2Fui%2Fsimd%2Fsimd-type-generic-monomorphisation-non-primitive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b23de51dcbd8f50094a716c0d99b44fdfa68e474/src%2Ftest%2Fui%2Fsimd%2Fsimd-type-generic-monomorphisation-non-primitive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsimd%2Fsimd-type-generic-monomorphisation-non-primitive.rs?ref=b23de51dcbd8f50094a716c0d99b44fdfa68e474", "patch": "@@ -0,0 +1,14 @@\n+// build-fail\n+\n+#![feature(repr_simd)]\n+\n+struct E;\n+\n+// error-pattern:monomorphising SIMD type `S<E>` with a non-primitive-scalar (integer/float/pointer) element type `E`\n+\n+#[repr(simd)]\n+struct S<T>([T; 4]);\n+\n+fn main() {\n+    let _v: Option<S<E>> = None;\n+}"}, {"sha": "9e8f06b824ccf3bd8caa02c8b006e56d9a5315ba", "filename": "src/test/ui/simd/simd-type-generic-monomorphisation-non-primitive.stderr", "status": "added", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/b23de51dcbd8f50094a716c0d99b44fdfa68e474/src%2Ftest%2Fui%2Fsimd%2Fsimd-type-generic-monomorphisation-non-primitive.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/b23de51dcbd8f50094a716c0d99b44fdfa68e474/src%2Ftest%2Fui%2Fsimd%2Fsimd-type-generic-monomorphisation-non-primitive.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsimd%2Fsimd-type-generic-monomorphisation-non-primitive.stderr?ref=b23de51dcbd8f50094a716c0d99b44fdfa68e474", "patch": "@@ -0,0 +1,4 @@\n+error: monomorphising SIMD type `S<E>` with a non-primitive-scalar (integer/float/pointer) element type `E`\n+\n+error: aborting due to previous error\n+"}]}