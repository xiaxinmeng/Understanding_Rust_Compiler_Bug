{"sha": "950de7c3c355398a9c15812b74376e252cb176db", "node_id": "C_kwDOAAsO6NoAKDk1MGRlN2MzYzM1NTM5OGE5YzE1ODEyYjc0Mzc2ZTI1MmNiMTc2ZGI", "commit": {"author": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2022-08-09T12:31:17Z"}, "committer": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2022-08-09T12:31:17Z"}, "message": "Use `--keep-going` cargo flag when building build scripts", "tree": {"sha": "ebc6db5a9a9e45e234f4f8768f0f3bb3cd132b5d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ebc6db5a9a9e45e234f4f8768f0f3bb3cd132b5d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/950de7c3c355398a9c15812b74376e252cb176db", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/950de7c3c355398a9c15812b74376e252cb176db", "html_url": "https://github.com/rust-lang/rust/commit/950de7c3c355398a9c15812b74376e252cb176db", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/950de7c3c355398a9c15812b74376e252cb176db/comments", "author": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e1e93c44389d822514e89ab4f2f31be30a7126d6", "url": "https://api.github.com/repos/rust-lang/rust/commits/e1e93c44389d822514e89ab4f2f31be30a7126d6", "html_url": "https://github.com/rust-lang/rust/commit/e1e93c44389d822514e89ab4f2f31be30a7126d6"}], "stats": {"total": 35, "additions": 29, "deletions": 6}, "files": [{"sha": "4b00479a4c9c27242a53396d435881bf5c57c2bc", "filename": "crates/project-model/src/build_scripts.rs", "status": "modified", "additions": 13, "deletions": 2, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/950de7c3c355398a9c15812b74376e252cb176db/crates%2Fproject-model%2Fsrc%2Fbuild_scripts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/950de7c3c355398a9c15812b74376e252cb176db/crates%2Fproject-model%2Fsrc%2Fbuild_scripts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproject-model%2Fsrc%2Fbuild_scripts.rs?ref=950de7c3c355398a9c15812b74376e252cb176db", "patch": "@@ -12,6 +12,7 @@ use cargo_metadata::{camino::Utf8Path, Message};\n use la_arena::ArenaMap;\n use paths::AbsPathBuf;\n use rustc_hash::FxHashMap;\n+use semver::Version;\n use serde::Deserialize;\n \n use crate::{cfg_flag::CfgFlag, CargoConfig, CargoWorkspace, Package};\n@@ -38,7 +39,7 @@ pub(crate) struct BuildScriptOutput {\n }\n \n impl WorkspaceBuildScripts {\n-    fn build_command(config: &CargoConfig) -> Command {\n+    fn build_command(config: &CargoConfig, toolchain: &Option<Version>) -> Command {\n         if let Some([program, args @ ..]) = config.run_build_script_command.as_deref() {\n             let mut cmd = Command::new(program);\n             cmd.args(args);\n@@ -70,15 +71,25 @@ impl WorkspaceBuildScripts {\n             }\n         }\n \n+        const RUST_1_62: Version = Version::new(1, 62, 0);\n+\n+        match toolchain {\n+            Some(v) if v >= &RUST_1_62 => {\n+                cmd.args(&[\"-Z\", \"unstable-options\", \"--keep-going\"]).env(\"RUSTC_BOOTSTRAP\", \"1\");\n+            }\n+            _ => (),\n+        }\n+\n         cmd\n     }\n \n     pub(crate) fn run(\n         config: &CargoConfig,\n         workspace: &CargoWorkspace,\n         progress: &dyn Fn(String),\n+        toolchain: &Option<Version>,\n     ) -> io::Result<WorkspaceBuildScripts> {\n-        let mut cmd = Self::build_command(config);\n+        let mut cmd = Self::build_command(config, toolchain);\n \n         if config.wrap_rustc_in_build_scripts {\n             // Setup RUSTC_WRAPPER to point to `rust-analyzer` binary itself. We use"}, {"sha": "8d0fa757c2e176baf6c0904927bfe252a9e4772d", "filename": "crates/project-model/src/tests.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/950de7c3c355398a9c15812b74376e252cb176db/crates%2Fproject-model%2Fsrc%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/950de7c3c355398a9c15812b74376e252cb176db/crates%2Fproject-model%2Fsrc%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproject-model%2Fsrc%2Ftests.rs?ref=950de7c3c355398a9c15812b74376e252cb176db", "patch": "@@ -28,6 +28,7 @@ fn load_cargo_with_overrides(file: &str, cfg_overrides: CfgOverrides) -> CrateGr\n         rustc: None,\n         rustc_cfg: Vec::new(),\n         cfg_overrides,\n+        toolchain: None,\n     };\n     to_crate_graph(project_workspace)\n }"}, {"sha": "daabb299f76cb0f18f454e3012dafc711d8e0c59", "filename": "crates/project-model/src/workspace.rs", "status": "modified", "additions": 14, "deletions": 4, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/950de7c3c355398a9c15812b74376e252cb176db/crates%2Fproject-model%2Fsrc%2Fworkspace.rs", "raw_url": "https://github.com/rust-lang/rust/raw/950de7c3c355398a9c15812b74376e252cb176db/crates%2Fproject-model%2Fsrc%2Fworkspace.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproject-model%2Fsrc%2Fworkspace.rs?ref=950de7c3c355398a9c15812b74376e252cb176db", "patch": "@@ -12,6 +12,7 @@ use base_db::{\n use cfg::{CfgDiff, CfgOptions};\n use paths::{AbsPath, AbsPathBuf};\n use rustc_hash::{FxHashMap, FxHashSet};\n+use semver::Version;\n use stdx::always;\n \n use crate::{\n@@ -77,6 +78,7 @@ pub enum ProjectWorkspace {\n         /// different target.\n         rustc_cfg: Vec<CfgFlag>,\n         cfg_overrides: CfgOverrides,\n+        toolchain: Option<Version>,\n     },\n     /// Project workspace was manually specified using a `rust-project.json` file.\n     Json { project: ProjectJson, sysroot: Option<Sysroot>, rustc_cfg: Vec<CfgFlag> },\n@@ -105,6 +107,7 @@ impl fmt::Debug for ProjectWorkspace {\n                 rustc,\n                 rustc_cfg,\n                 cfg_overrides,\n+                toolchain,\n             } => f\n                 .debug_struct(\"Cargo\")\n                 .field(\"root\", &cargo.workspace_root().file_name())\n@@ -116,6 +119,7 @@ impl fmt::Debug for ProjectWorkspace {\n                 )\n                 .field(\"n_rustc_cfg\", &rustc_cfg.len())\n                 .field(\"n_cfg_overrides\", &cfg_overrides.len())\n+                .field(\"toolchain\", &toolchain)\n                 .finish(),\n             ProjectWorkspace::Json { project, sysroot, rustc_cfg } => {\n                 let mut debug_struct = f.debug_struct(\"Json\");\n@@ -160,6 +164,9 @@ impl ProjectWorkspace {\n                     cmd.arg(\"--version\");\n                     cmd\n                 })?;\n+                let toolchain = cargo_version\n+                    .get(\"cargo \".len()..)\n+                    .and_then(|it| Version::parse(it.split_whitespace().next()?).ok());\n \n                 let meta = CargoWorkspace::fetch_metadata(\n                     &cargo_toml,\n@@ -169,9 +176,9 @@ impl ProjectWorkspace {\n                 )\n                 .with_context(|| {\n                     format!(\n-                        \"Failed to read Cargo metadata from Cargo.toml file {}, {}\",\n+                        \"Failed to read Cargo metadata from Cargo.toml file {}, {:?}\",\n                         cargo_toml.display(),\n-                        cargo_version\n+                        toolchain\n                     )\n                 })?;\n                 let cargo = CargoWorkspace::new(meta);\n@@ -219,6 +226,7 @@ impl ProjectWorkspace {\n                     rustc,\n                     rustc_cfg,\n                     cfg_overrides,\n+                    toolchain,\n                 }\n             }\n         };\n@@ -271,8 +279,8 @@ impl ProjectWorkspace {\n         progress: &dyn Fn(String),\n     ) -> Result<WorkspaceBuildScripts> {\n         match self {\n-            ProjectWorkspace::Cargo { cargo, .. } => {\n-                WorkspaceBuildScripts::run(config, cargo, progress).with_context(|| {\n+            ProjectWorkspace::Cargo { cargo, toolchain, .. } => {\n+                WorkspaceBuildScripts::run(config, cargo, progress, toolchain).with_context(|| {\n                     format!(\"Failed to run build scripts for {}\", &cargo.workspace_root().display())\n                 })\n             }\n@@ -320,6 +328,7 @@ impl ProjectWorkspace {\n                 rustc_cfg: _,\n                 cfg_overrides: _,\n                 build_scripts,\n+                toolchain: _,\n             } => {\n                 cargo\n                     .packages()\n@@ -425,6 +434,7 @@ impl ProjectWorkspace {\n                 rustc_cfg,\n                 cfg_overrides,\n                 build_scripts,\n+                toolchain: _,\n             } => cargo_to_crate_graph(\n                 rustc_cfg.clone(),\n                 cfg_overrides,"}, {"sha": "ceb2a6d703d959ad819f422ae27d0e807f1d25d9", "filename": "crates/rust-analyzer/src/reload.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/950de7c3c355398a9c15812b74376e252cb176db/crates%2Frust-analyzer%2Fsrc%2Freload.rs", "raw_url": "https://github.com/rust-lang/rust/raw/950de7c3c355398a9c15812b74376e252cb176db/crates%2Frust-analyzer%2Fsrc%2Freload.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Freload.rs?ref=950de7c3c355398a9c15812b74376e252cb176db", "patch": "@@ -219,6 +219,7 @@ impl GlobalState {\n                     cfg_overrides,\n \n                     build_scripts: _,\n+                    toolchain: _,\n                 } => Some((cargo, sysroot, rustc, rustc_cfg, cfg_overrides)),\n                 _ => None,\n             };"}]}