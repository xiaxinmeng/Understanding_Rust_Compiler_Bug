{"sha": "1165176840db39af8503b1d6ed0746586b6fd0d4", "node_id": "MDY6Q29tbWl0NzI0NzEyOjExNjUxNzY4NDBkYjM5YWY4NTAzYjFkNmVkMDc0NjU4NmI2ZmQwZDQ=", "commit": {"author": {"name": "Phil Hansch", "email": "dev@phansch.net", "date": "2019-11-28T09:19:05Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-11-28T09:19:05Z"}, "message": "Rollup merge of #4842 - timbodeit:comparison-chain-false-positive-4827, r=flip1995\n\n[comparison_chain] #4827 Check `core::cmp::Ord` is implemented\n\nOnly emit `comparison_chain` lint, if `cmp` is actually available on the type being compared. Don't emit lint in cases where only `PartialOrd` is implemented.\n\nI haven't yet fully understood [Adjustments](https://doc.rust-lang.org/nightly/nightly-rustc/rustc/ty/adjustment/struct.Adjustment.html). I would appreciate, if someone could double check whether my usage of [expr_ty](https://doc.rust-lang.org/nightly/nightly-rustc/rustc/ty/struct.TypeckTables.html#method.expr_ty) in `clippy_lints/src/comparison_chain.rs:91` is correct or if there are cases where using [expr_ty_adjusted](https://doc.rust-lang.org/nightly/nightly-rustc/rustc/ty/struct.TypeckTables.html#method.expr_ty_adjusted) would lead to a different result when used with `utils::implements_trait`.\n\n---\n\nfixes #4827\nchangelog: [comparison_chain] Check `core::cmp::Ord` is implemented", "tree": {"sha": "ae96b9d0337b29e6f9a14b290a7fe0cbf713e1c2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ae96b9d0337b29e6f9a14b290a7fe0cbf713e1c2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1165176840db39af8503b1d6ed0746586b6fd0d4", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJd35EJCRBK7hj4Ov3rIwAAdHIIAEVyJOpqCwXFDYVBIW3KO8JO\nGJN2k7Or2iC6m7weCgCPbYhjVOOdGFtg/RzIZXHK8RpSj7LO70Tv6ajhdiEmQvNH\nAyTx6kNBwXfMbs2DFlIRoTNS6127L9zACUawzTi4ItANiL5/IwPJ9zJEScJfzakW\n8qQXDY5LZ7BgDh7IbQ6OQU9uzEodZyTEKSyBERk+mZVUhLZliOcNMp6r0YGI/P9G\nrnzbmh1MB0FtODxdTtwZ5wj3kpkQcCpKx8Yzq3gW7o0LeGRFOxu6lhV/f8xBqIPG\nO7NDSOJvZtLx5fDBPbXmQoIQohF7PImI0joofrbEsDRnQuOJGAxV4nq3wjc7/j8=\n=aAZl\n-----END PGP SIGNATURE-----\n", "payload": "tree ae96b9d0337b29e6f9a14b290a7fe0cbf713e1c2\nparent 6686892cbfaac39f517714a9d8d1234d08038125\nparent fff9a8ea9c56d5075c23d9d5b2d8b0838eee0da3\nauthor Phil Hansch <dev@phansch.net> 1574932745 +0100\ncommitter GitHub <noreply@github.com> 1574932745 +0100\n\nRollup merge of #4842 - timbodeit:comparison-chain-false-positive-4827, r=flip1995\n\n[comparison_chain] #4827 Check `core::cmp::Ord` is implemented\n\nOnly emit `comparison_chain` lint, if `cmp` is actually available on the type being compared. Don't emit lint in cases where only `PartialOrd` is implemented.\n\nI haven't yet fully understood [Adjustments](https://doc.rust-lang.org/nightly/nightly-rustc/rustc/ty/adjustment/struct.Adjustment.html). I would appreciate, if someone could double check whether my usage of [expr_ty](https://doc.rust-lang.org/nightly/nightly-rustc/rustc/ty/struct.TypeckTables.html#method.expr_ty) in `clippy_lints/src/comparison_chain.rs:91` is correct or if there are cases where using [expr_ty_adjusted](https://doc.rust-lang.org/nightly/nightly-rustc/rustc/ty/struct.TypeckTables.html#method.expr_ty_adjusted) would lead to a different result when used with `utils::implements_trait`.\n\n---\n\nfixes #4827\nchangelog: [comparison_chain] Check `core::cmp::Ord` is implemented\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1165176840db39af8503b1d6ed0746586b6fd0d4", "html_url": "https://github.com/rust-lang/rust/commit/1165176840db39af8503b1d6ed0746586b6fd0d4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1165176840db39af8503b1d6ed0746586b6fd0d4/comments", "author": {"login": "phansch", "id": 2042399, "node_id": "MDQ6VXNlcjIwNDIzOTk=", "avatar_url": "https://avatars.githubusercontent.com/u/2042399?v=4", "gravatar_id": "", "url": "https://api.github.com/users/phansch", "html_url": "https://github.com/phansch", "followers_url": "https://api.github.com/users/phansch/followers", "following_url": "https://api.github.com/users/phansch/following{/other_user}", "gists_url": "https://api.github.com/users/phansch/gists{/gist_id}", "starred_url": "https://api.github.com/users/phansch/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/phansch/subscriptions", "organizations_url": "https://api.github.com/users/phansch/orgs", "repos_url": "https://api.github.com/users/phansch/repos", "events_url": "https://api.github.com/users/phansch/events{/privacy}", "received_events_url": "https://api.github.com/users/phansch/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6686892cbfaac39f517714a9d8d1234d08038125", "url": "https://api.github.com/repos/rust-lang/rust/commits/6686892cbfaac39f517714a9d8d1234d08038125", "html_url": "https://github.com/rust-lang/rust/commit/6686892cbfaac39f517714a9d8d1234d08038125"}, {"sha": "fff9a8ea9c56d5075c23d9d5b2d8b0838eee0da3", "url": "https://api.github.com/repos/rust-lang/rust/commits/fff9a8ea9c56d5075c23d9d5b2d8b0838eee0da3", "html_url": "https://github.com/rust-lang/rust/commit/fff9a8ea9c56d5075c23d9d5b2d8b0838eee0da3"}], "stats": {"total": 115, "additions": 113, "deletions": 2}, "files": [{"sha": "087bceaffd98326e9f71565e7f3d548895759e15", "filename": "clippy_lints/src/comparison_chain.rs", "status": "modified", "additions": 11, "deletions": 1, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/1165176840db39af8503b1d6ed0746586b6fd0d4/clippy_lints%2Fsrc%2Fcomparison_chain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1165176840db39af8503b1d6ed0746586b6fd0d4/clippy_lints%2Fsrc%2Fcomparison_chain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fcomparison_chain.rs?ref=1165176840db39af8503b1d6ed0746586b6fd0d4", "patch": "@@ -1,4 +1,6 @@\n-use crate::utils::{if_sequence, parent_node_is_if_expr, span_help_and_lint, SpanlessEq};\n+use crate::utils::{\n+    get_trait_def_id, if_sequence, implements_trait, parent_node_is_if_expr, paths, span_help_and_lint, SpanlessEq,\n+};\n use rustc::hir::*;\n use rustc::lint::{LateContext, LateLintPass, LintArray, LintPass};\n use rustc::{declare_lint_pass, declare_tool_lint};\n@@ -84,6 +86,14 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for ComparisonChain {\n                 {\n                     return;\n                 }\n+\n+                // Check that the type being compared implements `core::cmp::Ord`\n+                let ty = cx.tables.expr_ty(lhs1);\n+                let is_ord = get_trait_def_id(cx, &paths::ORD).map_or(false, |id| implements_trait(cx, ty, id, &[]));\n+\n+                if !is_ord {\n+                    return;\n+                }\n             } else {\n                 // We only care about comparison chains\n                 return;"}, {"sha": "9c2128469de9ded7afeaf9571882f4e3be171383", "filename": "tests/ui/comparison_chain.rs", "status": "modified", "additions": 61, "deletions": 0, "changes": 61, "blob_url": "https://github.com/rust-lang/rust/blob/1165176840db39af8503b1d6ed0746586b6fd0d4/tests%2Fui%2Fcomparison_chain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1165176840db39af8503b1d6ed0746586b6fd0d4/tests%2Fui%2Fcomparison_chain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcomparison_chain.rs?ref=1165176840db39af8503b1d6ed0746586b6fd0d4", "patch": "@@ -76,4 +76,65 @@ fn f(x: u8, y: u8, z: u8) {\n     }\n }\n \n+#[allow(clippy::float_cmp)]\n+fn g(x: f64, y: f64, z: f64) {\n+    // Ignored: f64 doesn't implement Ord\n+    if x > y {\n+        a()\n+    } else if x < y {\n+        b()\n+    }\n+\n+    // Ignored: f64 doesn't implement Ord\n+    if x > y {\n+        a()\n+    } else if x < y {\n+        b()\n+    } else {\n+        c()\n+    }\n+\n+    // Ignored: f64 doesn't implement Ord\n+    if x > y {\n+        a()\n+    } else if y > x {\n+        b()\n+    } else {\n+        c()\n+    }\n+\n+    // Ignored: f64 doesn't implement Ord\n+    if x > 1.0 {\n+        a()\n+    } else if x < 1.0 {\n+        b()\n+    } else if x == 1.0 {\n+        c()\n+    }\n+}\n+\n+fn h<T: Ord>(x: T, y: T, z: T) {\n+    if x > y {\n+        a()\n+    } else if x < y {\n+        b()\n+    }\n+\n+    if x > y {\n+        a()\n+    } else if x < y {\n+        b()\n+    } else {\n+        c()\n+    }\n+\n+    if x > y {\n+        a()\n+    } else if y > x {\n+        b()\n+    } else {\n+        c()\n+    }\n+}\n+\n fn main() {}"}, {"sha": "69db88b03b5b55d30251dad120febb2fecf7be65", "filename": "tests/ui/comparison_chain.stderr", "status": "modified", "additions": 41, "deletions": 1, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/1165176840db39af8503b1d6ed0746586b6fd0d4/tests%2Fui%2Fcomparison_chain.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/1165176840db39af8503b1d6ed0746586b6fd0d4/tests%2Fui%2Fcomparison_chain.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcomparison_chain.stderr?ref=1165176840db39af8503b1d6ed0746586b6fd0d4", "patch": "@@ -53,5 +53,45 @@ LL | |     }\n    |\n    = help: Consider rewriting the `if` chain to use `cmp` and `match`.\n \n-error: aborting due to 4 previous errors\n+error: `if` chain can be rewritten with `match`\n+  --> $DIR/comparison_chain.rs:117:5\n+   |\n+LL | /     if x > y {\n+LL | |         a()\n+LL | |     } else if x < y {\n+LL | |         b()\n+LL | |     }\n+   | |_____^\n+   |\n+   = help: Consider rewriting the `if` chain to use `cmp` and `match`.\n+\n+error: `if` chain can be rewritten with `match`\n+  --> $DIR/comparison_chain.rs:123:5\n+   |\n+LL | /     if x > y {\n+LL | |         a()\n+LL | |     } else if x < y {\n+LL | |         b()\n+LL | |     } else {\n+LL | |         c()\n+LL | |     }\n+   | |_____^\n+   |\n+   = help: Consider rewriting the `if` chain to use `cmp` and `match`.\n+\n+error: `if` chain can be rewritten with `match`\n+  --> $DIR/comparison_chain.rs:131:5\n+   |\n+LL | /     if x > y {\n+LL | |         a()\n+LL | |     } else if y > x {\n+LL | |         b()\n+LL | |     } else {\n+LL | |         c()\n+LL | |     }\n+   | |_____^\n+   |\n+   = help: Consider rewriting the `if` chain to use `cmp` and `match`.\n+\n+error: aborting due to 7 previous errors\n "}]}