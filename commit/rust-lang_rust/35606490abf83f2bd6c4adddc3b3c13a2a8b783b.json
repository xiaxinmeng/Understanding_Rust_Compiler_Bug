{"sha": "35606490abf83f2bd6c4adddc3b3c13a2a8b783b", "node_id": "C_kwDOAAsO6NoAKDM1NjA2NDkwYWJmODNmMmJkNmM0YWRkZGMzYjNjMTNhMmE4Yjc4M2I", "commit": {"author": {"name": "Dan Gohman", "email": "dev@sunfishcode.online", "date": "2022-03-03T19:07:23Z"}, "committer": {"name": "Dan Gohman", "email": "dev@sunfishcode.online", "date": "2022-03-03T19:20:49Z"}, "message": "Use `HandleOrNull` and `HandleOrInvalid` in the Windows FFI bindings.\n\nUse the new `HandleOrNull` and `HandleOrInvalid` types that were introduced\nas part of [I/O safety] in a few functions in the Windows FFI bindings.\n\nThis factors out an `unsafe` block and two `unsafe` function calls in the\nWindows implementation code.\n\nAnd, it helps test `HandleOrNull` and `HandleOrInvalid`, which indeed turned\nup a bug: `OwnedHandle` also needs to be `#[repr(transparent)]`, as it's\nused inside of `HandleOrNull` and `HandleOrInvalid` which are also\n`#[repr(transparent)]`.\n\n[I/O safety]: https://github.com/rust-lang/rust/issues/87074", "tree": {"sha": "46637ce27c8e03ce767ef469c157add997a4fc09", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/46637ce27c8e03ce767ef469c157add997a4fc09"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/35606490abf83f2bd6c4adddc3b3c13a2a8b783b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/35606490abf83f2bd6c4adddc3b3c13a2a8b783b", "html_url": "https://github.com/rust-lang/rust/commit/35606490abf83f2bd6c4adddc3b3c13a2a8b783b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/35606490abf83f2bd6c4adddc3b3c13a2a8b783b/comments", "author": {"login": "sunfishcode", "id": 4503403, "node_id": "MDQ6VXNlcjQ1MDM0MDM=", "avatar_url": "https://avatars.githubusercontent.com/u/4503403?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sunfishcode", "html_url": "https://github.com/sunfishcode", "followers_url": "https://api.github.com/users/sunfishcode/followers", "following_url": "https://api.github.com/users/sunfishcode/following{/other_user}", "gists_url": "https://api.github.com/users/sunfishcode/gists{/gist_id}", "starred_url": "https://api.github.com/users/sunfishcode/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sunfishcode/subscriptions", "organizations_url": "https://api.github.com/users/sunfishcode/orgs", "repos_url": "https://api.github.com/users/sunfishcode/repos", "events_url": "https://api.github.com/users/sunfishcode/events{/privacy}", "received_events_url": "https://api.github.com/users/sunfishcode/received_events", "type": "User", "site_admin": false}, "committer": {"login": "sunfishcode", "id": 4503403, "node_id": "MDQ6VXNlcjQ1MDM0MDM=", "avatar_url": "https://avatars.githubusercontent.com/u/4503403?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sunfishcode", "html_url": "https://github.com/sunfishcode", "followers_url": "https://api.github.com/users/sunfishcode/followers", "following_url": "https://api.github.com/users/sunfishcode/following{/other_user}", "gists_url": "https://api.github.com/users/sunfishcode/gists{/gist_id}", "starred_url": "https://api.github.com/users/sunfishcode/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sunfishcode/subscriptions", "organizations_url": "https://api.github.com/users/sunfishcode/orgs", "repos_url": "https://api.github.com/users/sunfishcode/repos", "events_url": "https://api.github.com/users/sunfishcode/events{/privacy}", "received_events_url": "https://api.github.com/users/sunfishcode/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "32cbc7630b2d6b7141e2588f91380c1a58cf0016", "url": "https://api.github.com/repos/rust-lang/rust/commits/32cbc7630b2d6b7141e2588f91380c1a58cf0016", "html_url": "https://github.com/rust-lang/rust/commit/32cbc7630b2d6b7141e2588f91380c1a58cf0016"}], "stats": {"total": 39, "additions": 22, "deletions": 17}, "files": [{"sha": "14b94d8dcdf92e889d2921362eee551949229365", "filename": "library/std/src/os/windows/io/handle.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/35606490abf83f2bd6c4adddc3b3c13a2a8b783b/library%2Fstd%2Fsrc%2Fos%2Fwindows%2Fio%2Fhandle.rs", "raw_url": "https://github.com/rust-lang/rust/raw/35606490abf83f2bd6c4adddc3b3c13a2a8b783b/library%2Fstd%2Fsrc%2Fos%2Fwindows%2Fio%2Fhandle.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fos%2Fwindows%2Fio%2Fhandle.rs?ref=35606490abf83f2bd6c4adddc3b3c13a2a8b783b", "patch": "@@ -59,6 +59,7 @@ pub struct BorrowedHandle<'handle> {\n /// [`RegCloseKey`]: https://docs.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regclosekey\n ///\n /// [here]: https://devblogs.microsoft.com/oldnewthing/20040302-00/?p=40443\n+#[repr(transparent)]\n #[unstable(feature = \"io_safety\", issue = \"87074\")]\n pub struct OwnedHandle {\n     handle: RawHandle,"}, {"sha": "9b61b2476d5bbdd55c811b00d9493b098215cb5b", "filename": "library/std/src/sys/windows/c.rs", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/35606490abf83f2bd6c4adddc3b3c13a2a8b783b/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/35606490abf83f2bd6c4adddc3b3c13a2a8b783b/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fc.rs?ref=35606490abf83f2bd6c4adddc3b3c13a2a8b783b", "patch": "@@ -6,6 +6,7 @@\n \n use crate::mem;\n use crate::os::raw::{c_char, c_int, c_long, c_longlong, c_uint, c_ulong, c_ushort};\n+use crate::os::windows::io::{BorrowedHandle, HandleOrInvalid, HandleOrNull};\n use crate::ptr;\n use core::ffi::NonZero_c_ulong;\n \n@@ -886,7 +887,7 @@ extern \"system\" {\n         lpParameter: LPVOID,\n         dwCreationFlags: DWORD,\n         lpThreadId: LPDWORD,\n-    ) -> HANDLE;\n+    ) -> HandleOrNull;\n     pub fn WaitForSingleObject(hHandle: HANDLE, dwMilliseconds: DWORD) -> DWORD;\n     pub fn SwitchToThread() -> BOOL;\n     pub fn Sleep(dwMilliseconds: DWORD);\n@@ -950,14 +951,14 @@ extern \"system\" {\n         dwOptions: DWORD,\n     ) -> BOOL;\n     pub fn ReadFile(\n-        hFile: HANDLE,\n+        hFile: BorrowedHandle<'_>,\n         lpBuffer: LPVOID,\n         nNumberOfBytesToRead: DWORD,\n         lpNumberOfBytesRead: LPDWORD,\n         lpOverlapped: LPOVERLAPPED,\n     ) -> BOOL;\n     pub fn WriteFile(\n-        hFile: HANDLE,\n+        hFile: BorrowedHandle<'_>,\n         lpBuffer: LPVOID,\n         nNumberOfBytesToWrite: DWORD,\n         lpNumberOfBytesWritten: LPDWORD,\n@@ -981,7 +982,7 @@ extern \"system\" {\n         dwCreationDisposition: DWORD,\n         dwFlagsAndAttributes: DWORD,\n         hTemplateFile: HANDLE,\n-    ) -> HANDLE;\n+    ) -> HandleOrInvalid;\n \n     pub fn FindFirstFileW(fileName: LPCWSTR, findFileData: LPWIN32_FIND_DATAW) -> HANDLE;\n     pub fn FindNextFileW(findFile: HANDLE, findFileData: LPWIN32_FIND_DATAW) -> BOOL;"}, {"sha": "d6c40a15329a96a9091aa9c6936d1fed7e1ad79c", "filename": "library/std/src/sys/windows/fs.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/35606490abf83f2bd6c4adddc3b3c13a2a8b783b/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Ffs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/35606490abf83f2bd6c4adddc3b3c13a2a8b783b/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Ffs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Ffs.rs?ref=35606490abf83f2bd6c4adddc3b3c13a2a8b783b", "patch": "@@ -1,5 +1,6 @@\n use crate::os::windows::prelude::*;\n \n+use crate::convert::TryInto;\n use crate::ffi::OsString;\n use crate::fmt;\n use crate::io::{self, Error, IoSlice, IoSliceMut, ReadBuf, SeekFrom};\n@@ -294,10 +295,10 @@ impl File {\n                 ptr::null_mut(),\n             )\n         };\n-        if handle == c::INVALID_HANDLE_VALUE {\n-            Err(Error::last_os_error())\n+        if let Ok(handle) = handle.try_into() {\n+            Ok(File { handle: Handle::from_inner(handle) })\n         } else {\n-            unsafe { Ok(File { handle: Handle::from_raw_handle(handle) }) }\n+            Err(Error::last_os_error())\n         }\n     }\n "}, {"sha": "e5c9567957bc1db5c5e52c9eb0bd5fde8de807aa", "filename": "library/std/src/sys/windows/handle.rs", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/35606490abf83f2bd6c4adddc3b3c13a2a8b783b/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fhandle.rs", "raw_url": "https://github.com/rust-lang/rust/raw/35606490abf83f2bd6c4adddc3b3c13a2a8b783b/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fhandle.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fhandle.rs?ref=35606490abf83f2bd6c4adddc3b3c13a2a8b783b", "patch": "@@ -78,7 +78,7 @@ impl Handle {\n         let len = cmp::min(buf.len(), <c::DWORD>::MAX as usize) as c::DWORD;\n         let res = cvt(unsafe {\n             c::ReadFile(\n-                self.as_raw_handle(),\n+                self.as_handle(),\n                 buf.as_mut_ptr() as c::LPVOID,\n                 len,\n                 &mut read,\n@@ -116,7 +116,7 @@ impl Handle {\n             overlapped.Offset = offset as u32;\n             overlapped.OffsetHigh = (offset >> 32) as u32;\n             cvt(c::ReadFile(\n-                self.as_raw_handle(),\n+                self.as_handle(),\n                 buf.as_mut_ptr() as c::LPVOID,\n                 len,\n                 &mut read,\n@@ -135,7 +135,7 @@ impl Handle {\n         let len = cmp::min(buf.remaining(), <c::DWORD>::MAX as usize) as c::DWORD;\n         let res = cvt(unsafe {\n             c::ReadFile(\n-                self.as_raw_handle(),\n+                self.as_handle(),\n                 buf.unfilled_mut().as_mut_ptr() as c::LPVOID,\n                 len,\n                 &mut read,\n@@ -171,7 +171,7 @@ impl Handle {\n         let len = cmp::min(buf.len(), <c::DWORD>::MAX as usize) as c::DWORD;\n         let mut amt = 0;\n         let res = cvt(c::ReadFile(\n-            self.as_raw_handle(),\n+            self.as_handle(),\n             buf.as_ptr() as c::LPVOID,\n             len,\n             &mut amt,\n@@ -225,7 +225,7 @@ impl Handle {\n         let len = cmp::min(buf.len(), <c::DWORD>::MAX as usize) as c::DWORD;\n         cvt(unsafe {\n             c::WriteFile(\n-                self.as_raw_handle(),\n+                self.as_handle(),\n                 buf.as_ptr() as c::LPVOID,\n                 len,\n                 &mut amt,\n@@ -252,7 +252,7 @@ impl Handle {\n             overlapped.Offset = offset as u32;\n             overlapped.OffsetHigh = (offset >> 32) as u32;\n             cvt(c::WriteFile(\n-                self.as_raw_handle(),\n+                self.as_handle(),\n                 buf.as_ptr() as c::LPVOID,\n                 len,\n                 &mut written,"}, {"sha": "bd304dc57371dda02bfc4250f71f279e5f7ad318", "filename": "library/std/src/sys/windows/thread.rs", "status": "modified", "additions": 6, "deletions": 4, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/35606490abf83f2bd6c4adddc3b3c13a2a8b783b/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fthread.rs", "raw_url": "https://github.com/rust-lang/rust/raw/35606490abf83f2bd6c4adddc3b3c13a2a8b783b/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fthread.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fthread.rs?ref=35606490abf83f2bd6c4adddc3b3c13a2a8b783b", "patch": "@@ -1,11 +1,13 @@\n+use crate::convert::TryInto;\n use crate::ffi::CStr;\n use crate::io;\n use crate::num::NonZeroUsize;\n-use crate::os::windows::io::{AsRawHandle, FromRawHandle};\n+use crate::os::windows::io::AsRawHandle;\n use crate::ptr;\n use crate::sys::c;\n use crate::sys::handle::Handle;\n use crate::sys::stack_overflow;\n+use crate::sys_common::FromInner;\n use crate::time::Duration;\n \n use libc::c_void;\n@@ -40,13 +42,13 @@ impl Thread {\n             ptr::null_mut(),\n         );\n \n-        return if ret as usize == 0 {\n+        return if let Ok(handle) = ret.try_into() {\n+            Ok(Thread { handle: Handle::from_inner(handle) })\n+        } else {\n             // The thread failed to start and as a result p was not consumed. Therefore, it is\n             // safe to reconstruct the box so that it gets deallocated.\n             drop(Box::from_raw(p));\n             Err(io::Error::last_os_error())\n-        } else {\n-            Ok(Thread { handle: Handle::from_raw_handle(ret) })\n         };\n \n         extern \"system\" fn thread_start(main: *mut c_void) -> c::DWORD {"}]}