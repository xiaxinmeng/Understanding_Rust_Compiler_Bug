{"sha": "fb17671eb07fc9f68c17b7494e402591fe08b299", "node_id": "C_kwDOAAsO6NoAKGZiMTc2NzFlYjA3ZmM5ZjY4YzE3Yjc0OTRlNDAyNTkxZmUwOGIyOTk", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-09-28T17:09:34Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-09-28T17:09:34Z"}, "message": "Auto merge of #7734 - Manishearth:doc-unsafe-trait, r=camsteffen\n\nMake `doc_unsafe` warn on unsafe traits as well\n\nFixes #7732\n\nchangelog: Make [`doc_unsafe`] warn on unsafe traits as well", "tree": {"sha": "d9a28b332c183b30b7967a1e30baefd660f93b6f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d9a28b332c183b30b7967a1e30baefd660f93b6f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fb17671eb07fc9f68c17b7494e402591fe08b299", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fb17671eb07fc9f68c17b7494e402591fe08b299", "html_url": "https://github.com/rust-lang/rust/commit/fb17671eb07fc9f68c17b7494e402591fe08b299", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fb17671eb07fc9f68c17b7494e402591fe08b299/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9fc4b92eb2831b5175a4720aff593252a716a2fa", "url": "https://api.github.com/repos/rust-lang/rust/commits/9fc4b92eb2831b5175a4720aff593252a716a2fa", "html_url": "https://github.com/rust-lang/rust/commit/9fc4b92eb2831b5175a4720aff593252a716a2fa"}, {"sha": "53c534d11b289c8587128929306ad50cd3fe02f9", "url": "https://api.github.com/repos/rust-lang/rust/commits/53c534d11b289c8587128929306ad50cd3fe02f9", "html_url": "https://github.com/rust-lang/rust/commit/53c534d11b289c8587128929306ad50cd3fe02f9"}], "stats": {"total": 50, "additions": 43, "deletions": 7}, "files": [{"sha": "55d2265125e0c229ec92477f65214fd49328072a", "filename": "clippy_lints/src/doc.rs", "status": "modified", "additions": 11, "deletions": 1, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/fb17671eb07fc9f68c17b7494e402591fe08b299/clippy_lints%2Fsrc%2Fdoc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fb17671eb07fc9f68c17b7494e402591fe08b299/clippy_lints%2Fsrc%2Fdoc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fdoc.rs?ref=fb17671eb07fc9f68c17b7494e402591fe08b299", "patch": "@@ -236,7 +236,17 @@ impl<'tcx> LateLintPass<'tcx> for DocMarkdown {\n             hir::ItemKind::Impl(ref impl_) => {\n                 self.in_trait_impl = impl_.of_trait.is_some();\n             },\n-            _ => {},\n+            hir::ItemKind::Trait(_, unsafety, ..) => {\n+                if !headers.safety && unsafety == hir::Unsafety::Unsafe {\n+                    span_lint(\n+                        cx,\n+                        MISSING_SAFETY_DOC,\n+                        item.span,\n+                        \"docs for unsafe trait missing `# Safety` section\",\n+                    );\n+                }\n+            },\n+            _ => (),\n         }\n     }\n "}, {"sha": "9ff3b5e5ef50f3acfe90090ab43c447283bda8b1", "filename": "tests/ui/def_id_nocore.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/fb17671eb07fc9f68c17b7494e402591fe08b299/tests%2Fui%2Fdef_id_nocore.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fb17671eb07fc9f68c17b7494e402591fe08b299/tests%2Fui%2Fdef_id_nocore.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fdef_id_nocore.rs?ref=fb17671eb07fc9f68c17b7494e402591fe08b299", "patch": "@@ -3,6 +3,7 @@\n \n #![feature(no_core, lang_items, start)]\n #![no_core]\n+#![allow(clippy::missing_safety_doc)]\n \n #[link(name = \"c\")]\n extern \"C\" {}"}, {"sha": "6210d7c6cfd80c1d32369494f3010694b606dc65", "filename": "tests/ui/def_id_nocore.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/fb17671eb07fc9f68c17b7494e402591fe08b299/tests%2Fui%2Fdef_id_nocore.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/fb17671eb07fc9f68c17b7494e402591fe08b299/tests%2Fui%2Fdef_id_nocore.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fdef_id_nocore.stderr?ref=fb17671eb07fc9f68c17b7494e402591fe08b299", "patch": "@@ -1,5 +1,5 @@\n error: methods called `as_*` usually take `self` by reference or `self` by mutable reference\n-  --> $DIR/def_id_nocore.rs:26:19\n+  --> $DIR/def_id_nocore.rs:27:19\n    |\n LL |     pub fn as_ref(self) -> &'static str {\n    |                   ^^^^"}, {"sha": "8f823f1672ba2d30e868414cdf87104a39caa175", "filename": "tests/ui/doc_unsafe.rs", "status": "modified", "additions": 19, "deletions": 2, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/fb17671eb07fc9f68c17b7494e402591fe08b299/tests%2Fui%2Fdoc_unsafe.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fb17671eb07fc9f68c17b7494e402591fe08b299/tests%2Fui%2Fdoc_unsafe.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fdoc_unsafe.rs?ref=fb17671eb07fc9f68c17b7494e402591fe08b299", "patch": "@@ -34,16 +34,25 @@ mod private_mod {\n \n pub use private_mod::republished;\n \n-pub trait UnsafeTrait {\n+pub trait SafeTraitUnsafeMethods {\n     unsafe fn woefully_underdocumented(self);\n \n     /// # Safety\n     unsafe fn at_least_somewhat_documented(self);\n }\n \n+pub unsafe trait UnsafeTrait {\n+    fn method();\n+}\n+\n+/// # Safety\n+pub unsafe trait DocumentedUnsafeTrait {\n+    fn method2();\n+}\n+\n pub struct Struct;\n \n-impl UnsafeTrait for Struct {\n+impl SafeTraitUnsafeMethods for Struct {\n     unsafe fn woefully_underdocumented(self) {\n         // all is well\n     }\n@@ -53,6 +62,14 @@ impl UnsafeTrait for Struct {\n     }\n }\n \n+unsafe impl UnsafeTrait for Struct {\n+    fn method() {}\n+}\n+\n+unsafe impl DocumentedUnsafeTrait for Struct {\n+    fn method2() {}\n+}\n+\n impl Struct {\n     pub unsafe fn more_undocumented_unsafe() -> Self {\n         unimplemented!();"}, {"sha": "34ca37a6efdc0197c9b115dd6ccb81980f41557a", "filename": "tests/ui/doc_unsafe.stderr", "status": "modified", "additions": 11, "deletions": 3, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/fb17671eb07fc9f68c17b7494e402591fe08b299/tests%2Fui%2Fdoc_unsafe.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/fb17671eb07fc9f68c17b7494e402591fe08b299/tests%2Fui%2Fdoc_unsafe.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fdoc_unsafe.stderr?ref=fb17671eb07fc9f68c17b7494e402591fe08b299", "patch": "@@ -22,16 +22,24 @@ error: unsafe function's docs miss `# Safety` section\n LL |     unsafe fn woefully_underdocumented(self);\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n+error: docs for unsafe trait missing `# Safety` section\n+  --> $DIR/doc_unsafe.rs:44:1\n+   |\n+LL | / pub unsafe trait UnsafeTrait {\n+LL | |     fn method();\n+LL | | }\n+   | |_^\n+\n error: unsafe function's docs miss `# Safety` section\n-  --> $DIR/doc_unsafe.rs:57:5\n+  --> $DIR/doc_unsafe.rs:74:5\n    |\n LL | /     pub unsafe fn more_undocumented_unsafe() -> Self {\n LL | |         unimplemented!();\n LL | |     }\n    | |_____^\n \n error: unsafe function's docs miss `# Safety` section\n-  --> $DIR/doc_unsafe.rs:73:9\n+  --> $DIR/doc_unsafe.rs:90:9\n    |\n LL | /         pub unsafe fn whee() {\n LL | |             unimplemented!()\n@@ -43,5 +51,5 @@ LL |   very_unsafe!();\n    |\n    = note: this error originates in the macro `very_unsafe` (in Nightly builds, run with -Z macro-backtrace for more info)\n \n-error: aborting due to 5 previous errors\n+error: aborting due to 6 previous errors\n "}]}