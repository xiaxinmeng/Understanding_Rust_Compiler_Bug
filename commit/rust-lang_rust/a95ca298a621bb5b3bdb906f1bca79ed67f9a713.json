{"sha": "a95ca298a621bb5b3bdb906f1bca79ed67f9a713", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE5NWNhMjk4YTYyMWJiNWIzYmRiOTA2ZjFiY2E3OWVkNjdmOWE3MTM=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2019-04-16T03:14:25Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-04-16T03:14:25Z"}, "message": "Rollup merge of #59993 - euclio:unused-ref-field, r=estebank\n\ninclude mode in unused binding suggestion span\n\nFixes #54180.", "tree": {"sha": "263e89e00ecb8cd3ddd658fd11986d3fafeba6fe", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/263e89e00ecb8cd3ddd658fd11986d3fafeba6fe"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a95ca298a621bb5b3bdb906f1bca79ed67f9a713", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJctUiRCRBK7hj4Ov3rIwAAdHIIAIqPYfQeVso/5QQ2YXJdKuDr\nqHrk0oj8LZdZjhqT1kXNWrlrnkhC0Yfs2m+XzzSvkZWbtzWOrK5K4ptCln1LGw9u\nuYnZpedNCd4zWGUWfOAscu97DNIuMpRcdNuV17rvUvlkNmXRK4eBw3Hdi0p2pHg2\nNfjOceU7ks0f/drDW+AjBr28G4x5e0+oXTl6fTXSXt56AyuOuaGXzoNEa4CPoWhB\npDCiPcUviLyWdoX3ifoRFB+TN/x3G7Emgu4bQIzKGtl6gJizqsL6hO1R5xemRAK2\nxHJZrw+NmwAs5zvp6ohk8LLzfnjr2kZ+8YU1oF2sDipGdXqgJiogvWbGnQ4Yl2o=\n=81MJ\n-----END PGP SIGNATURE-----\n", "payload": "tree 263e89e00ecb8cd3ddd658fd11986d3fafeba6fe\nparent 426e747b7e64d6b1c1d3bf76a974f2d60e2552f3\nparent 74560f3ab36bb4f7f3aef3c66a3e9717f9ee1978\nauthor Mazdak Farrokhzad <twingoow@gmail.com> 1555384465 +0200\ncommitter GitHub <noreply@github.com> 1555384465 +0200\n\nRollup merge of #59993 - euclio:unused-ref-field, r=estebank\n\ninclude mode in unused binding suggestion span\n\nFixes #54180.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a95ca298a621bb5b3bdb906f1bca79ed67f9a713", "html_url": "https://github.com/rust-lang/rust/commit/a95ca298a621bb5b3bdb906f1bca79ed67f9a713", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a95ca298a621bb5b3bdb906f1bca79ed67f9a713/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "426e747b7e64d6b1c1d3bf76a974f2d60e2552f3", "url": "https://api.github.com/repos/rust-lang/rust/commits/426e747b7e64d6b1c1d3bf76a974f2d60e2552f3", "html_url": "https://github.com/rust-lang/rust/commit/426e747b7e64d6b1c1d3bf76a974f2d60e2552f3"}, {"sha": "74560f3ab36bb4f7f3aef3c66a3e9717f9ee1978", "url": "https://api.github.com/repos/rust-lang/rust/commits/74560f3ab36bb4f7f3aef3c66a3e9717f9ee1978", "html_url": "https://github.com/rust-lang/rust/commit/74560f3ab36bb4f7f3aef3c66a3e9717f9ee1978"}], "stats": {"total": 124, "additions": 119, "deletions": 5}, "files": [{"sha": "b8cde936bded30c44ec1ea9b1443fbdedaa8fad4", "filename": "src/librustc/middle/liveness.rs", "status": "modified", "additions": 12, "deletions": 5, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/a95ca298a621bb5b3bdb906f1bca79ed67f9a713/src%2Flibrustc%2Fmiddle%2Fliveness.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a95ca298a621bb5b3bdb906f1bca79ed67f9a713/src%2Flibrustc%2Fmiddle%2Fliveness.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fliveness.rs?ref=a95ca298a621bb5b3bdb906f1bca79ed67f9a713", "patch": "@@ -1626,11 +1626,18 @@ impl<'a, 'tcx> Liveness<'a, 'tcx> {\n                     );\n \n                     if self.ir.variable_is_shorthand(var) {\n-                        err.multipart_suggestion(\n-                            \"try ignoring the field\",\n-                            spans.iter().map(|span| (*span, format!(\"{}: _\", name))).collect(),\n-                            Applicability::MachineApplicable\n-                        );\n+                        if let Node::Binding(pat) = self.ir.tcx.hir().get_by_hir_id(hir_id) {\n+                            // Handle `ref` and `ref mut`.\n+                            let spans = spans.iter()\n+                                .map(|_span| (pat.span, format!(\"{}: _\", name)))\n+                                .collect();\n+\n+                            err.multipart_suggestion(\n+                                \"try ignoring the field\",\n+                                spans,\n+                                Applicability::MachineApplicable,\n+                            );\n+                        }\n                     } else {\n                         err.multipart_suggestion(\n                             \"consider prefixing with an underscore\","}, {"sha": "1350b7ca6996cf25540de6906be07b14a801067e", "filename": "src/test/ui/lint/issue-54180-unused-ref-field.fixed", "status": "added", "additions": 34, "deletions": 0, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/a95ca298a621bb5b3bdb906f1bca79ed67f9a713/src%2Ftest%2Fui%2Flint%2Fissue-54180-unused-ref-field.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/a95ca298a621bb5b3bdb906f1bca79ed67f9a713/src%2Ftest%2Fui%2Flint%2Fissue-54180-unused-ref-field.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Fissue-54180-unused-ref-field.fixed?ref=a95ca298a621bb5b3bdb906f1bca79ed67f9a713", "patch": "@@ -0,0 +1,34 @@\n+// run-rustfix\n+\n+#![deny(unused)]\n+\n+pub struct S {\n+    pub f1: i32,\n+}\n+\n+pub struct Point {\n+    pub x: i32,\n+    pub y: i32,\n+}\n+\n+pub enum E {\n+    Variant { field: String }\n+}\n+\n+pub fn foo(arg: &E) {\n+    match arg {\n+        E::Variant { field: _ } => (), //~ ERROR unused variable\n+    }\n+}\n+\n+fn main() {\n+    let s = S { f1: 123 };\n+    let S { f1: _ } = s; //~ ERROR unused variable\n+\n+    let points = vec![Point { x: 1, y: 2 }];\n+    let _: i32 = points.iter().map(|Point { x: _, y }| y).sum(); //~ ERROR unused variable\n+\n+    match (Point { x: 1, y: 2 }) {\n+        Point { y, x: _ } => y, //~ ERROR unused variable\n+    };\n+}"}, {"sha": "7b3392b609a0aa4630e8bea070dbbb4198e41814", "filename": "src/test/ui/lint/issue-54180-unused-ref-field.rs", "status": "added", "additions": 34, "deletions": 0, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/a95ca298a621bb5b3bdb906f1bca79ed67f9a713/src%2Ftest%2Fui%2Flint%2Fissue-54180-unused-ref-field.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a95ca298a621bb5b3bdb906f1bca79ed67f9a713/src%2Ftest%2Fui%2Flint%2Fissue-54180-unused-ref-field.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Fissue-54180-unused-ref-field.rs?ref=a95ca298a621bb5b3bdb906f1bca79ed67f9a713", "patch": "@@ -0,0 +1,34 @@\n+// run-rustfix\n+\n+#![deny(unused)]\n+\n+pub struct S {\n+    pub f1: i32,\n+}\n+\n+pub struct Point {\n+    pub x: i32,\n+    pub y: i32,\n+}\n+\n+pub enum E {\n+    Variant { field: String }\n+}\n+\n+pub fn foo(arg: &E) {\n+    match arg {\n+        E::Variant { ref field } => (), //~ ERROR unused variable\n+    }\n+}\n+\n+fn main() {\n+    let s = S { f1: 123 };\n+    let S { ref f1 } = s; //~ ERROR unused variable\n+\n+    let points = vec![Point { x: 1, y: 2 }];\n+    let _: i32 = points.iter().map(|Point { x, y }| y).sum(); //~ ERROR unused variable\n+\n+    match (Point { x: 1, y: 2 }) {\n+        Point { y, ref mut x } => y, //~ ERROR unused variable\n+    };\n+}"}, {"sha": "9f47554a1a65e310f8f29741f0df7499ca814c75", "filename": "src/test/ui/lint/issue-54180-unused-ref-field.stderr", "status": "added", "additions": 39, "deletions": 0, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/a95ca298a621bb5b3bdb906f1bca79ed67f9a713/src%2Ftest%2Fui%2Flint%2Fissue-54180-unused-ref-field.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/a95ca298a621bb5b3bdb906f1bca79ed67f9a713/src%2Ftest%2Fui%2Flint%2Fissue-54180-unused-ref-field.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Fissue-54180-unused-ref-field.stderr?ref=a95ca298a621bb5b3bdb906f1bca79ed67f9a713", "patch": "@@ -0,0 +1,39 @@\n+error: unused variable: `field`\n+  --> $DIR/issue-54180-unused-ref-field.rs:20:26\n+   |\n+LL |         E::Variant { ref field } => (),\n+   |                      ----^^^^^\n+   |                      |\n+   |                      help: try ignoring the field: `field: _`\n+   |\n+note: lint level defined here\n+  --> $DIR/issue-54180-unused-ref-field.rs:3:9\n+   |\n+LL | #![deny(unused)]\n+   |         ^^^^^^\n+   = note: #[deny(unused_variables)] implied by #[deny(unused)]\n+\n+error: unused variable: `x`\n+  --> $DIR/issue-54180-unused-ref-field.rs:29:45\n+   |\n+LL |     let _: i32 = points.iter().map(|Point { x, y }| y).sum();\n+   |                                             ^ help: try ignoring the field: `x: _`\n+\n+error: unused variable: `f1`\n+  --> $DIR/issue-54180-unused-ref-field.rs:26:17\n+   |\n+LL |     let S { ref f1 } = s;\n+   |             ----^^\n+   |             |\n+   |             help: try ignoring the field: `f1: _`\n+\n+error: unused variable: `x`\n+  --> $DIR/issue-54180-unused-ref-field.rs:32:28\n+   |\n+LL |         Point { y, ref mut x } => y,\n+   |                    --------^\n+   |                    |\n+   |                    help: try ignoring the field: `x: _`\n+\n+error: aborting due to 4 previous errors\n+"}]}