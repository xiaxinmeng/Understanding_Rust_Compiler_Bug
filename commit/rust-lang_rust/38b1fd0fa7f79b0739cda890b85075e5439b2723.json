{"sha": "38b1fd0fa7f79b0739cda890b85075e5439b2723", "node_id": "MDY6Q29tbWl0NzI0NzEyOjM4YjFmZDBmYTdmNzliMDczOWNkYTg5MGI4NTA3NWU1NDM5YjI3MjM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-04-01T05:48:16Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-04-01T05:48:16Z"}, "message": "Auto merge of #7002 - mgacek8:issue6983_wrong_self_convention_inside_trait_impls, r=phansch\n\nwrong_self_convention: fix FP inside trait impl for `to_*` method taking `&self`\n\nfixes #6983\nchangelog: `wrong_self_convention`: fix FP inside trait impl for `to_*` method taking `&self`", "tree": {"sha": "b6806cebd46f6a560f47e7bf19e4c2f73e0e87b7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b6806cebd46f6a560f47e7bf19e4c2f73e0e87b7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/38b1fd0fa7f79b0739cda890b85075e5439b2723", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/38b1fd0fa7f79b0739cda890b85075e5439b2723", "html_url": "https://github.com/rust-lang/rust/commit/38b1fd0fa7f79b0739cda890b85075e5439b2723", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/38b1fd0fa7f79b0739cda890b85075e5439b2723/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "75d73e95a090586852b725bf8f52962edd4442ea", "url": "https://api.github.com/repos/rust-lang/rust/commits/75d73e95a090586852b725bf8f52962edd4442ea", "html_url": "https://github.com/rust-lang/rust/commit/75d73e95a090586852b725bf8f52962edd4442ea"}, {"sha": "6966c78be74ec7dea5cbbb18f1ec10771bf4b728", "url": "https://api.github.com/repos/rust-lang/rust/commits/6966c78be74ec7dea5cbbb18f1ec10771bf4b728", "html_url": "https://github.com/rust-lang/rust/commit/6966c78be74ec7dea5cbbb18f1ec10771bf4b728"}], "stats": {"total": 98, "additions": 81, "deletions": 17}, "files": [{"sha": "fa6323b56e1db55e2d738c9f9c7d6bfd5711d049", "filename": "clippy_lints/src/methods/mod.rs", "status": "modified", "additions": 9, "deletions": 1, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/38b1fd0fa7f79b0739cda890b85075e5439b2723/clippy_lints%2Fsrc%2Fmethods%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/38b1fd0fa7f79b0739cda890b85075e5439b2723/clippy_lints%2Fsrc%2Fmethods%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmethods%2Fmod.rs?ref=38b1fd0fa7f79b0739cda890b85075e5439b2723", "patch": "@@ -206,6 +206,13 @@ declare_clippy_lint! {\n     /// |`to_`  | not `_mut` |`self`                 | `Copy`       |\n     /// |`to_`  | not `_mut` |`&self`                | not `Copy`   |\n     ///\n+    /// Note: Clippy doesn't trigger methods with `to_` prefix in:\n+    /// - Traits definition.\n+    /// Clippy can not tell if a type that implements a trait is `Copy` or not.\n+    /// - Traits implementation, when `&self` is taken.\n+    /// The method signature is controlled by the trait and often `&self` is required for all types that implement the trait\n+    /// (see e.g. the `std::string::ToString` trait).\n+    ///\n     /// Please find more info here:\n     /// https://rust-lang.github.io/api-guidelines/naming.html#ad-hoc-conversions-follow-as_-to_-into_-conventions-c-conv\n     ///\n@@ -1772,7 +1779,6 @@ impl<'tcx> LateLintPass<'tcx> for Methods {\n         let self_ty = cx.tcx.type_of(item.def_id);\n \n         let implements_trait = matches!(item.kind, hir::ItemKind::Impl(hir::Impl { of_trait: Some(_), .. }));\n-\n         if_chain! {\n             if let hir::ImplItemKind::Fn(ref sig, id) = impl_item.kind;\n             if let Some(first_arg) = iter_input_pats(&sig.decl, cx.tcx.hir().body(id)).next();\n@@ -1824,6 +1830,7 @@ impl<'tcx> LateLintPass<'tcx> for Methods {\n                     self_ty,\n                     first_arg_ty,\n                     first_arg.pat.span,\n+                    implements_trait,\n                     false\n                 );\n             }\n@@ -1893,6 +1900,7 @@ impl<'tcx> LateLintPass<'tcx> for Methods {\n                     self_ty,\n                     first_arg_ty,\n                     first_arg_span,\n+                    false,\n                     true\n                 );\n             }"}, {"sha": "1e0de249a91f1792c8f5c132ad9cd3f710f8a2ee", "filename": "clippy_lints/src/methods/wrong_self_convention.rs", "status": "modified", "additions": 25, "deletions": 7, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/38b1fd0fa7f79b0739cda890b85075e5439b2723/clippy_lints%2Fsrc%2Fmethods%2Fwrong_self_convention.rs", "raw_url": "https://github.com/rust-lang/rust/raw/38b1fd0fa7f79b0739cda890b85075e5439b2723/clippy_lints%2Fsrc%2Fmethods%2Fwrong_self_convention.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmethods%2Fwrong_self_convention.rs?ref=38b1fd0fa7f79b0739cda890b85075e5439b2723", "patch": "@@ -21,8 +21,10 @@ const CONVENTIONS: [(&[Convention], &[SelfKind]); 9] = [\n \n     // Conversion using `to_` can use borrowed (non-Copy types) or owned (Copy types).\n     // Source: https://rust-lang.github.io/api-guidelines/naming.html#ad-hoc-conversions-follow-as_-to_-into_-conventions-c-conv\n-    (&[Convention::StartsWith(\"to_\"), Convention::NotEndsWith(\"_mut\"), Convention::IsSelfTypeCopy(false), Convention::ImplementsTrait(false)], &[SelfKind::Ref]),\n-    (&[Convention::StartsWith(\"to_\"), Convention::NotEndsWith(\"_mut\"), Convention::IsSelfTypeCopy(true), Convention::ImplementsTrait(false)], &[SelfKind::Value]),\n+    (&[Convention::StartsWith(\"to_\"), Convention::NotEndsWith(\"_mut\"), Convention::IsSelfTypeCopy(false), \n+    Convention::IsTraitItem(false)], &[SelfKind::Ref]),\n+    (&[Convention::StartsWith(\"to_\"), Convention::NotEndsWith(\"_mut\"), Convention::IsSelfTypeCopy(true), \n+    Convention::IsTraitItem(false), Convention::ImplementsTrait(false)], &[SelfKind::Value]),\n ];\n \n enum Convention {\n@@ -32,18 +34,27 @@ enum Convention {\n     NotEndsWith(&'static str),\n     IsSelfTypeCopy(bool),\n     ImplementsTrait(bool),\n+    IsTraitItem(bool),\n }\n \n impl Convention {\n     #[must_use]\n-    fn check<'tcx>(&self, cx: &LateContext<'tcx>, self_ty: &'tcx TyS<'tcx>, other: &str, is_trait_def: bool) -> bool {\n+    fn check<'tcx>(\n+        &self,\n+        cx: &LateContext<'tcx>,\n+        self_ty: &'tcx TyS<'tcx>,\n+        other: &str,\n+        implements_trait: bool,\n+        is_trait_item: bool,\n+    ) -> bool {\n         match *self {\n             Self::Eq(this) => this == other,\n             Self::StartsWith(this) => other.starts_with(this) && this != other,\n             Self::EndsWith(this) => other.ends_with(this) && this != other,\n-            Self::NotEndsWith(this) => !Self::EndsWith(this).check(cx, self_ty, other, is_trait_def),\n+            Self::NotEndsWith(this) => !Self::EndsWith(this).check(cx, self_ty, other, implements_trait, is_trait_item),\n             Self::IsSelfTypeCopy(is_true) => is_true == is_copy(cx, self_ty),\n-            Self::ImplementsTrait(is_true) => is_true == is_trait_def,\n+            Self::ImplementsTrait(is_true) => is_true == implements_trait,\n+            Self::IsTraitItem(is_true) => is_true == is_trait_item,\n         }\n     }\n }\n@@ -60,19 +71,25 @@ impl fmt::Display for Convention {\n             },\n             Self::ImplementsTrait(is_true) => {\n                 let (negation, s_suffix) = if is_true { (\"\", \"s\") } else { (\" does not\", \"\") };\n-                format!(\"Method{} implement{} a trait\", negation, s_suffix).fmt(f)\n+                format!(\"method{} implement{} a trait\", negation, s_suffix).fmt(f)\n+            },\n+            Self::IsTraitItem(is_true) => {\n+                let suffix = if is_true { \" is\" } else { \" is not\" };\n+                format!(\"method{} a trait item\", suffix).fmt(f)\n             },\n         }\n     }\n }\n \n+#[allow(clippy::too_many_arguments)]\n pub(super) fn check<'tcx>(\n     cx: &LateContext<'tcx>,\n     item_name: &str,\n     is_pub: bool,\n     self_ty: &'tcx TyS<'tcx>,\n     first_arg_ty: &'tcx TyS<'tcx>,\n     first_arg_span: Span,\n+    implements_trait: bool,\n     is_trait_item: bool,\n ) {\n     let lint = if is_pub {\n@@ -83,7 +100,7 @@ pub(super) fn check<'tcx>(\n     if let Some((conventions, self_kinds)) = &CONVENTIONS.iter().find(|(convs, _)| {\n         convs\n             .iter()\n-            .all(|conv| conv.check(cx, self_ty, item_name, is_trait_item))\n+            .all(|conv| conv.check(cx, self_ty, item_name, implements_trait, is_trait_item))\n     }) {\n         if !self_kinds.iter().any(|k| k.matches(cx, self_ty, first_arg_ty)) {\n             let suggestion = {\n@@ -99,6 +116,7 @@ pub(super) fn check<'tcx>(\n                         .filter_map(|conv| {\n                             if (cut_ends_with_conv && matches!(conv, Convention::NotEndsWith(_)))\n                                 || matches!(conv, Convention::ImplementsTrait(_))\n+                                || matches!(conv, Convention::IsTraitItem(_))\n                             {\n                                 None\n                             } else {"}, {"sha": "cdfbdb8b0db3e54c263b0033091ec363be665b35", "filename": "tests/ui/wrong_self_convention.rs", "status": "modified", "additions": 2, "deletions": 7, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/38b1fd0fa7f79b0739cda890b85075e5439b2723/tests%2Fui%2Fwrong_self_convention.rs", "raw_url": "https://github.com/rust-lang/rust/raw/38b1fd0fa7f79b0739cda890b85075e5439b2723/tests%2Fui%2Fwrong_self_convention.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fwrong_self_convention.rs?ref=38b1fd0fa7f79b0739cda890b85075e5439b2723", "patch": "@@ -165,15 +165,10 @@ mod issue6307 {\n }\n \n mod issue6727 {\n-    trait ToU64 {\n-        fn to_u64(self) -> u64;\n-        fn to_u64_v2(&self) -> u64;\n-    }\n-\n     #[derive(Clone, Copy)]\n     struct FooCopy;\n \n-    impl ToU64 for FooCopy {\n+    impl FooCopy {\n         fn to_u64(self) -> u64 {\n             1\n         }\n@@ -185,7 +180,7 @@ mod issue6727 {\n \n     struct FooNoCopy;\n \n-    impl ToU64 for FooNoCopy {\n+    impl FooNoCopy {\n         // trigger lint\n         fn to_u64(self) -> u64 {\n             2"}, {"sha": "29f5ba8269545998683319c7d931b0deadca167f", "filename": "tests/ui/wrong_self_convention.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/38b1fd0fa7f79b0739cda890b85075e5439b2723/tests%2Fui%2Fwrong_self_convention.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/38b1fd0fa7f79b0739cda890b85075e5439b2723/tests%2Fui%2Fwrong_self_convention.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fwrong_self_convention.stderr?ref=38b1fd0fa7f79b0739cda890b85075e5439b2723", "patch": "@@ -176,15 +176,15 @@ LL |         fn from_i32(self);\n    = help: consider choosing a less ambiguous name\n \n error: methods with the following characteristics: (`to_*` and `self` type is `Copy`) usually take `self` by value\n-  --> $DIR/wrong_self_convention.rs:181:22\n+  --> $DIR/wrong_self_convention.rs:176:22\n    |\n LL |         fn to_u64_v2(&self) -> u64 {\n    |                      ^^^^^\n    |\n    = help: consider choosing a less ambiguous name\n \n error: methods with the following characteristics: (`to_*` and `self` type is not `Copy`) usually take `self` by reference\n-  --> $DIR/wrong_self_convention.rs:190:19\n+  --> $DIR/wrong_self_convention.rs:185:19\n    |\n LL |         fn to_u64(self) -> u64 {\n    |                   ^^^^"}, {"sha": "8b42aa59e1323ecb3552a56be6475bdad8bd2a6f", "filename": "tests/ui/wrong_self_convention2.rs", "status": "added", "additions": 32, "deletions": 0, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/38b1fd0fa7f79b0739cda890b85075e5439b2723/tests%2Fui%2Fwrong_self_convention2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/38b1fd0fa7f79b0739cda890b85075e5439b2723/tests%2Fui%2Fwrong_self_convention2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fwrong_self_convention2.rs?ref=38b1fd0fa7f79b0739cda890b85075e5439b2723", "patch": "@@ -0,0 +1,32 @@\n+// edition:2018\n+#![warn(clippy::wrong_self_convention)]\n+#![warn(clippy::wrong_pub_self_convention)]\n+#![allow(dead_code)]\n+\n+fn main() {}\n+\n+mod issue6983 {\n+    pub struct Thing;\n+    pub trait Trait {\n+        fn to_thing(&self) -> Thing;\n+    }\n+\n+    impl Trait for u8 {\n+        // don't trigger, e.g. `ToString` from `std` requires `&self`\n+        fn to_thing(&self) -> Thing {\n+            Thing\n+        }\n+    }\n+\n+    trait ToU64 {\n+        fn to_u64(self) -> u64;\n+    }\n+\n+    struct FooNoCopy;\n+    // trigger lint\n+    impl ToU64 for FooNoCopy {\n+        fn to_u64(self) -> u64 {\n+            2\n+        }\n+    }\n+}"}, {"sha": "0ca1a390974a0ca63c7644880fd59c09ea26f68a", "filename": "tests/ui/wrong_self_convention2.stderr", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/38b1fd0fa7f79b0739cda890b85075e5439b2723/tests%2Fui%2Fwrong_self_convention2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/38b1fd0fa7f79b0739cda890b85075e5439b2723/tests%2Fui%2Fwrong_self_convention2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fwrong_self_convention2.stderr?ref=38b1fd0fa7f79b0739cda890b85075e5439b2723", "patch": "@@ -0,0 +1,11 @@\n+error: methods with the following characteristics: (`to_*` and `self` type is not `Copy`) usually take `self` by reference\n+  --> $DIR/wrong_self_convention2.rs:28:19\n+   |\n+LL |         fn to_u64(self) -> u64 {\n+   |                   ^^^^\n+   |\n+   = note: `-D clippy::wrong-self-convention` implied by `-D warnings`\n+   = help: consider choosing a less ambiguous name\n+\n+error: aborting due to previous error\n+"}]}