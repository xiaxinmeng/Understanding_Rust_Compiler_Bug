{"sha": "6ff482bde5d22a3a0171edb3245327f43cf9b593", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZmZjQ4MmJkZTVkMjJhM2EwMTcxZWRiMzI0NTMyN2Y0M2NmOWI1OTM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-03-31T03:20:33Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-03-31T03:20:33Z"}, "message": "Auto merge of #83666 - Amanieu:instrprof-order, r=tmandry\n\nRun LLVM coverage instrumentation passes before optimization passes\n\nThis matches the behavior of Clang and allows us to remove several\nhacks which were needed to ensure functions weren't optimized away\nbefore reaching the instrumentation pass.\n\nFixes #83429\n\ncc `@richkadel`\n\nr? `@tmandry`", "tree": {"sha": "e785cd9af3f92d4bd0ebc38bc7f0f33ba3d3a009", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e785cd9af3f92d4bd0ebc38bc7f0f33ba3d3a009"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6ff482bde5d22a3a0171edb3245327f43cf9b593", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6ff482bde5d22a3a0171edb3245327f43cf9b593", "html_url": "https://github.com/rust-lang/rust/commit/6ff482bde5d22a3a0171edb3245327f43cf9b593", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6ff482bde5d22a3a0171edb3245327f43cf9b593/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "65b44b0320e88f5a0608126c36b02be1b840700f", "url": "https://api.github.com/repos/rust-lang/rust/commits/65b44b0320e88f5a0608126c36b02be1b840700f", "html_url": "https://github.com/rust-lang/rust/commit/65b44b0320e88f5a0608126c36b02be1b840700f"}, {"sha": "cad9b6b695e86c7c23482876d2f6fefd64451ab3", "url": "https://api.github.com/repos/rust-lang/rust/commits/cad9b6b695e86c7c23482876d2f6fefd64451ab3", "html_url": "https://github.com/rust-lang/rust/commit/cad9b6b695e86c7c23482876d2f6fefd64451ab3"}], "stats": {"total": 89, "additions": 29, "deletions": 60}, "files": [{"sha": "085935b94df5024100d84c88e794a97c40bf5b53", "filename": "compiler/rustc_codegen_llvm/src/back/write.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/6ff482bde5d22a3a0171edb3245327f43cf9b593/compiler%2Frustc_codegen_llvm%2Fsrc%2Fback%2Fwrite.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6ff482bde5d22a3a0171edb3245327f43cf9b593/compiler%2Frustc_codegen_llvm%2Fsrc%2Fback%2Fwrite.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fback%2Fwrite.rs?ref=6ff482bde5d22a3a0171edb3245327f43cf9b593", "patch": "@@ -548,6 +548,15 @@ pub(crate) unsafe fn optimize(\n                     llvm::LLVMRustAddPass(fpm, find_pass(\"lint\").unwrap());\n                     continue;\n                 }\n+                if pass_name == \"insert-gcov-profiling\" || pass_name == \"instrprof\" {\n+                    // Instrumentation must be inserted before optimization,\n+                    // otherwise LLVM may optimize some functions away which\n+                    // breaks llvm-cov.\n+                    //\n+                    // This mirrors what Clang does in lib/CodeGen/BackendUtil.cpp.\n+                    llvm::LLVMRustAddPass(mpm, find_pass(pass_name).unwrap());\n+                    continue;\n+                }\n \n                 if let Some(pass) = find_pass(pass_name) {\n                     extra_passes.push(pass);"}, {"sha": "6c2468b9ffe0b1c937d2a1fc53d5fb331d35668d", "filename": "compiler/rustc_middle/src/mir/mono.rs", "status": "modified", "additions": 1, "deletions": 8, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/6ff482bde5d22a3a0171edb3245327f43cf9b593/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmono.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6ff482bde5d22a3a0171edb3245327f43cf9b593/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmono.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmono.rs?ref=6ff482bde5d22a3a0171edb3245327f43cf9b593", "patch": "@@ -84,14 +84,7 @@ impl<'tcx> MonoItem<'tcx> {\n             .debugging_opts\n             .inline_in_all_cgus\n             .unwrap_or_else(|| tcx.sess.opts.optimize != OptLevel::No)\n-            && !tcx.sess.link_dead_code()\n-            && !tcx.sess.instrument_coverage();\n-        // Disabled for `-Z instrument-coverage` because some LLVM optimizations can sometimes\n-        // break coverage results. A test that failed at certain optimization levels is now\n-        // validated at that optimization level (via `compile-flags` directive):\n-        //   * `src/test/run-make-fulldeps/coverage/closure.rs` broke with `-C opt-level=2`, and\n-        //     also required disabling `internalize_symbols` in\n-        //     `rustc_mir/monomorphize/partitioning/mod.rs`\n+            && !tcx.sess.link_dead_code();\n \n         match *self {\n             MonoItem::Fn(ref instance) => {"}, {"sha": "dc2379fd92b834cba2dc31d3919230fbbede99f1", "filename": "compiler/rustc_mir/src/monomorphize/partitioning/mod.rs", "status": "modified", "additions": 1, "deletions": 7, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/6ff482bde5d22a3a0171edb3245327f43cf9b593/compiler%2Frustc_mir%2Fsrc%2Fmonomorphize%2Fpartitioning%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6ff482bde5d22a3a0171edb3245327f43cf9b593/compiler%2Frustc_mir%2Fsrc%2Fmonomorphize%2Fpartitioning%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Fmonomorphize%2Fpartitioning%2Fmod.rs?ref=6ff482bde5d22a3a0171edb3245327f43cf9b593", "patch": "@@ -196,13 +196,7 @@ pub fn partition<'tcx>(\n \n     // Next we try to make as many symbols \"internal\" as possible, so LLVM has\n     // more freedom to optimize.\n-    if !tcx.sess.link_dead_code() && !tcx.sess.instrument_coverage() {\n-        // Disabled for `-Z instrument-coverage` because some LLVM optimizations can sometimes\n-        // break coverage results. Tests that failed at certain optimization levels are now\n-        // validated at those optimization levels (via `compile-flags` directive); for example:\n-        //   * `src/test/run-make-fulldeps/coverage/async.rs` broke with `-C opt-level=1`\n-        //   * `src/test/run-make-fulldeps/coverage/closure.rs` broke with `-C opt-level=2`, and\n-        //     also required disabling `generate_gcu_internal_copies` in `rustc_middle/mir/mono.rs`\n+    if !tcx.sess.link_dead_code() {\n         let _prof_timer = tcx.prof.generic_activity(\"cgu_partitioning_internalize_symbols\");\n         partitioner.internalize_symbols(cx, &mut post_inlining);\n     }"}, {"sha": "0ef5f4d1c180c6bcc8cc560ccb6bc041b1454519", "filename": "compiler/rustc_typeck/src/collect.rs", "status": "modified", "additions": 1, "deletions": 11, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/6ff482bde5d22a3a0171edb3245327f43cf9b593/compiler%2Frustc_typeck%2Fsrc%2Fcollect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6ff482bde5d22a3a0171edb3245327f43cf9b593/compiler%2Frustc_typeck%2Fsrc%2Fcollect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcollect.rs?ref=6ff482bde5d22a3a0171edb3245327f43cf9b593", "patch": "@@ -2890,17 +2890,7 @@ fn codegen_fn_attrs(tcx: TyCtxt<'_>, id: DefId) -> CodegenFnAttrs {\n                     .emit();\n                     InlineAttr::None\n                 } else if list_contains_name(&items[..], sym::always) {\n-                    if tcx.sess.instrument_coverage() {\n-                        // Fixes Issue #82875. Forced inlining allows LLVM to discard functions\n-                        // marked with `#[inline(always)]`, which can break coverage reporting if\n-                        // that function was referenced from a coverage map.\n-                        //\n-                        // FIXME(#83429): Is there a better place, e.g., in codegen, to check and\n-                        // convert `Always` to `Hint`?\n-                        InlineAttr::Hint\n-                    } else {\n-                        InlineAttr::Always\n-                    }\n+                    InlineAttr::Always\n                 } else if list_contains_name(&items[..], sym::never) {\n                     InlineAttr::Never\n                 } else {"}, {"sha": "7d9121ee2f8347293d6accf1fa815c5ff39bf378", "filename": "src/test/run-make-fulldeps/coverage-llvmir/Makefile", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/6ff482bde5d22a3a0171edb3245327f43cf9b593/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-llvmir%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/6ff482bde5d22a3a0171edb3245327f43cf9b593/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-llvmir%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-llvmir%2FMakefile?ref=6ff482bde5d22a3a0171edb3245327f43cf9b593", "patch": "@@ -17,7 +17,7 @@ else\n \tCOMDAT_IF_SUPPORTED=, comdat\n endif\n \n-DEFINE_INTERNAL=define hidden\n+DEFINE_INTERNAL=define internal\n \n ifdef IS_WINDOWS\n \tLLVM_FILECHECK_OPTIONS=\\"}, {"sha": "7b38ffb87cba89b257125b6585d09100014763df", "filename": "src/test/run-make-fulldeps/coverage-reports/expected_show_coverage.generics.txt", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/6ff482bde5d22a3a0171edb3245327f43cf9b593/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2Fexpected_show_coverage.generics.txt", "raw_url": "https://github.com/rust-lang/rust/raw/6ff482bde5d22a3a0171edb3245327f43cf9b593/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2Fexpected_show_coverage.generics.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2Fexpected_show_coverage.generics.txt?ref=6ff482bde5d22a3a0171edb3245327f43cf9b593", "patch": "@@ -29,12 +29,12 @@\n    18|      2|        println!(\"BOOM times {}!!!\", self.strength);\n    19|      2|    }\n   ------------------\n-  | <generics::Firework<f64> as core::ops::drop::Drop>::drop:\n+  | <generics::Firework<i32> as core::ops::drop::Drop>::drop:\n   |   17|      1|    fn drop(&mut self) {\n   |   18|      1|        println!(\"BOOM times {}!!!\", self.strength);\n   |   19|      1|    }\n   ------------------\n-  | <generics::Firework<i32> as core::ops::drop::Drop>::drop:\n+  | <generics::Firework<f64> as core::ops::drop::Drop>::drop:\n   |   17|      1|    fn drop(&mut self) {\n   |   18|      1|        println!(\"BOOM times {}!!!\", self.strength);\n   |   19|      1|    }"}, {"sha": "cdcbd8fca948243c33c80a3c902b11bb84f6ecc3", "filename": "src/test/run-make-fulldeps/coverage-reports/expected_show_coverage.uses_crate.txt", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/6ff482bde5d22a3a0171edb3245327f43cf9b593/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2Fexpected_show_coverage.uses_crate.txt", "raw_url": "https://github.com/rust-lang/rust/raw/6ff482bde5d22a3a0171edb3245327f43cf9b593/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2Fexpected_show_coverage.uses_crate.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2Fexpected_show_coverage.uses_crate.txt?ref=6ff482bde5d22a3a0171edb3245327f43cf9b593", "patch": "@@ -36,12 +36,12 @@\n    22|      2|    println!(\"used_only_from_this_lib_crate_generic_function with {:?}\", arg);\n    23|      2|}\n   ------------------\n-  | used_crate::used_only_from_this_lib_crate_generic_function::<alloc::vec::Vec<i32>>:\n+  | used_crate::used_only_from_this_lib_crate_generic_function::<&str>:\n   |   21|      1|pub fn used_only_from_this_lib_crate_generic_function<T: Debug>(arg: T) {\n   |   22|      1|    println!(\"used_only_from_this_lib_crate_generic_function with {:?}\", arg);\n   |   23|      1|}\n   ------------------\n-  | used_crate::used_only_from_this_lib_crate_generic_function::<&str>:\n+  | used_crate::used_only_from_this_lib_crate_generic_function::<alloc::vec::Vec<i32>>:\n   |   21|      1|pub fn used_only_from_this_lib_crate_generic_function<T: Debug>(arg: T) {\n   |   22|      1|    println!(\"used_only_from_this_lib_crate_generic_function with {:?}\", arg);\n   |   23|      1|}"}, {"sha": "cc98956e3073af92156ac696e618b3697e84646c", "filename": "src/test/run-make-fulldeps/coverage-reports/expected_show_coverage.uses_inline_crate.txt", "status": "modified", "additions": 6, "deletions": 23, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/6ff482bde5d22a3a0171edb3245327f43cf9b593/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2Fexpected_show_coverage.uses_inline_crate.txt", "raw_url": "https://github.com/rust-lang/rust/raw/6ff482bde5d22a3a0171edb3245327f43cf9b593/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2Fexpected_show_coverage.uses_inline_crate.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2Fexpected_show_coverage.uses_inline_crate.txt?ref=6ff482bde5d22a3a0171edb3245327f43cf9b593", "patch": "@@ -30,29 +30,12 @@\n                    ^0\n    29|      1|    use_this_lib_crate();\n    30|      1|}\n-  ------------------\n-  | used_inline_crate::used_inline_function:\n-  |   20|      1|pub fn used_inline_function() {\n-  |   21|       |    // Initialize test constants in a way that cannot be determined at compile time, to ensure\n-  |   22|       |    // rustc and LLVM cannot optimize out statements (or coverage counters) downstream from\n-  |   23|       |    // dependent conditions.\n-  |   24|      1|    let is_true = std::env::args().len() == 1;\n-  |   25|      1|    let mut countdown = 0;\n-  |   26|      1|    if is_true {\n-  |   27|      1|        countdown = 10;\n-  |   28|      1|    }\n-  |                   ^0\n-  |   29|      1|    use_this_lib_crate();\n-  |   30|      1|}\n-  ------------------\n-  | Unexecuted instantiation: used_inline_crate::used_inline_function\n-  ------------------\n-   31|       |// Expect for above function:\n-   32|       |//\n-   33|       |// | Unexecuted instantiation: used_crate::used_only_from_bin_crate_generic_function::<_>\n-   34|       |//\n-   35|       |// With `#[inline(always)]` this function is instantiated twice, in both the library crate (which\n-   36|       |// does not use it) and the `uses_inline_crate` binary (which does use/call it).\n+   31|       |\n+   32|       |\n+   33|       |\n+   34|       |\n+   35|       |\n+   36|       |\n    37|       |\n    38|       |#[inline(always)]\n    39|      2|pub fn used_only_from_bin_crate_generic_function<T: Debug>(arg: T) {"}, {"sha": "4a052756d4e276d25a43d453a162eb565670c695", "filename": "src/test/run-make-fulldeps/coverage/lib/used_inline_crate.rs", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/6ff482bde5d22a3a0171edb3245327f43cf9b593/src%2Ftest%2Frun-make-fulldeps%2Fcoverage%2Flib%2Fused_inline_crate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6ff482bde5d22a3a0171edb3245327f43cf9b593/src%2Ftest%2Frun-make-fulldeps%2Fcoverage%2Flib%2Fused_inline_crate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fcoverage%2Flib%2Fused_inline_crate.rs?ref=6ff482bde5d22a3a0171edb3245327f43cf9b593", "patch": "@@ -28,12 +28,12 @@ pub fn used_inline_function() {\n     }\n     use_this_lib_crate();\n }\n-// Expect for above function:\n-//\n-// | Unexecuted instantiation: used_crate::used_only_from_bin_crate_generic_function::<_>\n-//\n-// With `#[inline(always)]` this function is instantiated twice, in both the library crate (which\n-// does not use it) and the `uses_inline_crate` binary (which does use/call it).\n+\n+\n+\n+\n+\n+\n \n #[inline(always)]\n pub fn used_only_from_bin_crate_generic_function<T: Debug>(arg: T) {"}]}