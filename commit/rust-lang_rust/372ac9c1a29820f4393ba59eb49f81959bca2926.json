{"sha": "372ac9c1a29820f4393ba59eb49f81959bca2926", "node_id": "C_kwDOAAsO6NoAKDM3MmFjOWMxYTI5ODIwZjQzOTNiYTU5ZWI0OWY4MTk1OWJjYTI5MjY", "commit": {"author": {"name": "mejrs", "email": "", "date": "2023-01-09T21:37:56Z"}, "committer": {"name": "David Tolnay", "email": "dtolnay@gmail.com", "date": "2023-01-11T22:40:13Z"}, "message": "Translate `Overlap` eagerly", "tree": {"sha": "4802ce61208354a920e434b697bfd203e4fdd573", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4802ce61208354a920e434b697bfd203e4fdd573"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/372ac9c1a29820f4393ba59eb49f81959bca2926", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEERijF2Cz/ZdaBZKeK+boUO5X/bYIFAmO/Os0ACgkQ+boUO5X/\nbYLOAA/+OTdq2w4/gPs51TCjHz34lQjDhcFyeaUH7d6rpxSYLYz5vn4MtKmFlFO7\nwt33PwoRviZklDLhcWK+WraXZeI9bgcHQjZxAT9V//eb32JKXNoC6sOSarZX0rcB\nHizQ4uyuSxF/RiC5abM0RcXKQ1+PtL9OdM9dOYYZySz2W0yWand2eX8K1Ygb8uGR\n5bRNYpx5zZyZZnr0ey83Kw/XI4XGiCeEq4ZgLKVb3oPh/hL6jCwo3NFd51P96G2P\n+uE7Sdz5fOnoquTu1ZUQ0KUhfTVyJwOoiqV5crM+wrEN9a0V5mI5740rRjmc76ie\npmZkZ2x67/M7m1uLnjq+CggDvl8R2mlOrIMZmJqinEk7o7JxdxtW7WARAYPtye9d\nVTcTpYjMXLOGQcX6URVrYL6o4n0ni4zSBPmOD8wf2BTrV/6IoUhI3NB1GdT75faQ\ndLAKDeecAD3m7H+EEsafijwTmbyP8XqN1R9skXkwQi7PLw4zI7sQPzDS4Fn9CRvY\nCzLjllWCZFi5iJvrixoQo5HcyhSNPSkDK2pKFd3aoDycED4yZIPuv+eReSgCRxLt\n+9rjHIZJssk3Tb6i2mOHLMGBJC1+DyC01GIc/LiwG4sge4opDBtDSiKiI2kG5Nrr\nBxfIdRuNUfxtVWIjt7BjHb2uiDxALpCLlYw3yFIO1w+6UJfvL3c=\n=dSJa\n-----END PGP SIGNATURE-----", "payload": "tree 4802ce61208354a920e434b697bfd203e4fdd573\nparent 3d260fa63c9730371b1898a73433499d2fc0b53e\nauthor mejrs <> 1673300276 +0100\ncommitter David Tolnay <dtolnay@gmail.com> 1673476813 -0800\n\nTranslate `Overlap` eagerly\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/372ac9c1a29820f4393ba59eb49f81959bca2926", "html_url": "https://github.com/rust-lang/rust/commit/372ac9c1a29820f4393ba59eb49f81959bca2926", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/372ac9c1a29820f4393ba59eb49f81959bca2926/comments", "author": {}, "committer": {"login": "dtolnay", "id": 1940490, "node_id": "MDQ6VXNlcjE5NDA0OTA=", "avatar_url": "https://avatars.githubusercontent.com/u/1940490?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dtolnay", "html_url": "https://github.com/dtolnay", "followers_url": "https://api.github.com/users/dtolnay/followers", "following_url": "https://api.github.com/users/dtolnay/following{/other_user}", "gists_url": "https://api.github.com/users/dtolnay/gists{/gist_id}", "starred_url": "https://api.github.com/users/dtolnay/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dtolnay/subscriptions", "organizations_url": "https://api.github.com/users/dtolnay/orgs", "repos_url": "https://api.github.com/users/dtolnay/repos", "events_url": "https://api.github.com/users/dtolnay/events{/privacy}", "received_events_url": "https://api.github.com/users/dtolnay/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3d260fa63c9730371b1898a73433499d2fc0b53e", "url": "https://api.github.com/repos/rust-lang/rust/commits/3d260fa63c9730371b1898a73433499d2fc0b53e", "html_url": "https://github.com/rust-lang/rust/commit/3d260fa63c9730371b1898a73433499d2fc0b53e"}], "stats": {"total": 31, "additions": 19, "deletions": 12}, "files": [{"sha": "801a5b31e02ffb1f5a7c0e88bd68831c21377df7", "filename": "compiler/rustc_error_messages/locales/en-US/mir_build.ftl", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/372ac9c1a29820f4393ba59eb49f81959bca2926/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fmir_build.ftl", "raw_url": "https://github.com/rust-lang/rust/raw/372ac9c1a29820f4393ba59eb49f81959bca2926/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fmir_build.ftl", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fmir_build.ftl?ref=372ac9c1a29820f4393ba59eb49f81959bca2926", "patch": "@@ -323,8 +323,6 @@ mir_build_overlapping_range_endpoints = multiple patterns overlap on their endpo\n     .range = ... with this range\n     .note = you likely meant to write mutually exclusive ranges\n \n-mir_build_overlapping_range = this range overlaps on `{$range}`...\n-\n mir_build_non_exhaustive_omitted_pattern = some variants are not matched explicitly\n     .help = ensure that all variants are matched explicitly by adding the suggested match arms\n     .note = the matched value is of type `{$scrut_ty}` and the `non_exhaustive_omitted_patterns` attribute was found"}, {"sha": "39b67d995fa36e1323b66c35b8c5dc54158ea1c1", "filename": "compiler/rustc_mir_build/src/errors.rs", "status": "modified", "additions": 15, "deletions": 4, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/372ac9c1a29820f4393ba59eb49f81959bca2926/compiler%2Frustc_mir_build%2Fsrc%2Ferrors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/372ac9c1a29820f4393ba59eb49f81959bca2926/compiler%2Frustc_mir_build%2Fsrc%2Ferrors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Ferrors.rs?ref=372ac9c1a29820f4393ba59eb49f81959bca2926", "patch": "@@ -677,17 +677,28 @@ pub struct OverlappingRangeEndpoints<'tcx> {\n     #[label(range)]\n     pub range: Span,\n     #[subdiagnostic]\n-    pub overlap: Overlap<'tcx>,\n+    pub overlap: Vec<Overlap<'tcx>>,\n }\n \n-#[derive(Subdiagnostic)]\n-#[label(mir_build_overlapping_range)]\n pub struct Overlap<'tcx> {\n-    #[primary_span]\n     pub span: Span,\n     pub range: Pat<'tcx>,\n }\n \n+impl<'tcx> AddToDiagnostic for Overlap<'tcx> {\n+    fn add_to_diagnostic_with<F>(self, diag: &mut Diagnostic, _: F)\n+    where\n+        F: Fn(&mut Diagnostic, SubdiagnosticMessage) -> SubdiagnosticMessage,\n+    {\n+        let Overlap { span, range } = self;\n+\n+        // FIXME(mejrs) unfortunately `#[derive(LintDiagnostic)]`\n+        // does not support `#[subdiagnostic(eager)]`...\n+        let message = format!(\"this range overlaps on `{range}`...\");\n+        diag.span_label(span, message);\n+    }\n+}\n+\n #[derive(LintDiagnostic)]\n #[diag(mir_build_non_exhaustive_omitted_pattern)]\n #[help]"}, {"sha": "17b3c475f83c78a3d4711e65092859da5d5d147b", "filename": "compiler/rustc_mir_build/src/thir/pattern/deconstruct_pat.rs", "status": "modified", "additions": 3, "deletions": 6, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/372ac9c1a29820f4393ba59eb49f81959bca2926/compiler%2Frustc_mir_build%2Fsrc%2Fthir%2Fpattern%2Fdeconstruct_pat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/372ac9c1a29820f4393ba59eb49f81959bca2926/compiler%2Frustc_mir_build%2Fsrc%2Fthir%2Fpattern%2Fdeconstruct_pat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fthir%2Fpattern%2Fdeconstruct_pat.rs?ref=372ac9c1a29820f4393ba59eb49f81959bca2926", "patch": "@@ -285,19 +285,16 @@ impl IntRange {\n             return;\n         }\n \n-        // Get the first overlap. We get only the first rather than all of them\n-        // because displaying multiple overlaps requires a way to eagerly translate\n-        // lintdiagnostics, but that doesn't exist.\n-        let overlap = pats\n+        let overlap: Vec<_> = pats\n             .filter_map(|pat| Some((pat.ctor().as_int_range()?, pat.span())))\n             .filter(|(range, _)| self.suspicious_intersection(range))\n             .map(|(range, span)| Overlap {\n                 range: self.intersection(&range).unwrap().to_pat(pcx.cx.tcx, pcx.ty),\n                 span,\n             })\n-            .next();\n+            .collect();\n \n-        if let Some(overlap) = overlap {\n+        if !overlap.is_empty() {\n             pcx.cx.tcx.emit_spanned_lint(\n                 lint::builtin::OVERLAPPING_RANGE_ENDPOINTS,\n                 hir_id,"}, {"sha": "ea0e8f6e49e0705d11f8b487429795113e500314", "filename": "tests/ui/pattern/usefulness/integer-ranges/overlapping_range_endpoints.stderr", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/372ac9c1a29820f4393ba59eb49f81959bca2926/tests%2Fui%2Fpattern%2Fusefulness%2Finteger-ranges%2Foverlapping_range_endpoints.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/372ac9c1a29820f4393ba59eb49f81959bca2926/tests%2Fui%2Fpattern%2Fusefulness%2Finteger-ranges%2Foverlapping_range_endpoints.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fpattern%2Fusefulness%2Finteger-ranges%2Foverlapping_range_endpoints.stderr?ref=372ac9c1a29820f4393ba59eb49f81959bca2926", "patch": "@@ -59,6 +59,7 @@ error: multiple patterns overlap on their endpoints\n LL |         0..=10 => {}\n    |         ------ this range overlaps on `10_u8`...\n LL |         20..=30 => {}\n+   |         ------- this range overlaps on `20_u8`...\n LL |         10..=20 => {}\n    |         ^^^^^^^ ... with this range\n    |"}]}