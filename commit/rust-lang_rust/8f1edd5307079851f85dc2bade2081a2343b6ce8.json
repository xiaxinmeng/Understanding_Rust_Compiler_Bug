{"sha": "8f1edd5307079851f85dc2bade2081a2343b6ce8", "node_id": "MDY6Q29tbWl0NzI0NzEyOjhmMWVkZDUzMDcwNzk4NTFmODVkYzJiYWRlMjA4MWEyMzQzYjZjZTg=", "commit": {"author": {"name": "Kevin Ballard", "email": "kevin@sb.org", "date": "2013-06-10T06:42:26Z"}, "committer": {"name": "Kevin Ballard", "email": "kevin@sb.org", "date": "2013-06-10T22:52:10Z"}, "message": "terminfo: Support more terminfo directory structures\n\nOS X's terminfo uses the hex representation of the first character of\nthe terminal name as the directory name.\n\nUbuntu seems to use /lib/terminfo instead of /usr/share/terminfo, at\nleast on the one machine I have access to.", "tree": {"sha": "795421ffa63b947f27ca4bf93d132112e4ab1d5d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/795421ffa63b947f27ca4bf93d132112e4ab1d5d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8f1edd5307079851f85dc2bade2081a2343b6ce8", "comment_count": 5, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8f1edd5307079851f85dc2bade2081a2343b6ce8", "html_url": "https://github.com/rust-lang/rust/commit/8f1edd5307079851f85dc2bade2081a2343b6ce8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8f1edd5307079851f85dc2bade2081a2343b6ce8/comments", "author": {"login": "lilyball", "id": 714, "node_id": "MDQ6VXNlcjcxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/714?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lilyball", "html_url": "https://github.com/lilyball", "followers_url": "https://api.github.com/users/lilyball/followers", "following_url": "https://api.github.com/users/lilyball/following{/other_user}", "gists_url": "https://api.github.com/users/lilyball/gists{/gist_id}", "starred_url": "https://api.github.com/users/lilyball/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lilyball/subscriptions", "organizations_url": "https://api.github.com/users/lilyball/orgs", "repos_url": "https://api.github.com/users/lilyball/repos", "events_url": "https://api.github.com/users/lilyball/events{/privacy}", "received_events_url": "https://api.github.com/users/lilyball/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lilyball", "id": 714, "node_id": "MDQ6VXNlcjcxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/714?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lilyball", "html_url": "https://github.com/lilyball", "followers_url": "https://api.github.com/users/lilyball/followers", "following_url": "https://api.github.com/users/lilyball/following{/other_user}", "gists_url": "https://api.github.com/users/lilyball/gists{/gist_id}", "starred_url": "https://api.github.com/users/lilyball/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lilyball/subscriptions", "organizations_url": "https://api.github.com/users/lilyball/orgs", "repos_url": "https://api.github.com/users/lilyball/repos", "events_url": "https://api.github.com/users/lilyball/events{/privacy}", "received_events_url": "https://api.github.com/users/lilyball/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1310212c27c1c294e1f907b05a225440c987a912", "url": "https://api.github.com/repos/rust-lang/rust/commits/1310212c27c1c294e1f907b05a225440c987a912", "html_url": "https://github.com/rust-lang/rust/commit/1310212c27c1c294e1f907b05a225440c987a912"}], "stats": {"total": 15, "additions": 13, "deletions": 2}, "files": [{"sha": "ecc99f74626c172d6ffaaab1d41664c85e813e04", "filename": "src/libextra/terminfo/searcher.rs", "status": "modified", "additions": 13, "deletions": 2, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/8f1edd5307079851f85dc2bade2081a2343b6ce8/src%2Flibextra%2Fterminfo%2Fsearcher.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8f1edd5307079851f85dc2bade2081a2343b6ce8/src%2Flibextra%2Fterminfo%2Fsearcher.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibextra%2Fterminfo%2Fsearcher.rs?ref=8f1edd5307079851f85dc2bade2081a2343b6ce8", "patch": "@@ -44,8 +44,13 @@ pub fn get_dbpath_for_term(term: &str) -> Option<~path> {\n                         dirs_to_search.push(path(i.to_owned()));\n                     }\n                 },\n-                // Found nothing, use the default path\n-                None => dirs_to_search.push(path(\"/usr/share/terminfo\"))\n+                // Found nothing, use the default paths\n+                // /usr/share/terminfo is the de facto location, but it seems\n+                // Ubuntu puts it in /lib/terminfo\n+                None => {\n+                    dirs_to_search.push(path(\"/usr/share/terminfo\"));\n+                    dirs_to_search.push(path(\"/lib/terminfo\"));\n+                }\n             }\n         }\n     };\n@@ -56,6 +61,11 @@ pub fn get_dbpath_for_term(term: &str) -> Option<~path> {\n         if os::path_exists(p) && os::path_exists(newp) {\n             return Some(newp);\n         }\n+        // on some installations the dir is named after the hex of the char (e.g. OS X)\n+        let newp = ~p.push_many(&[fmt!(\"%x\", first_char[0] as uint), term.to_owned()]);\n+        if os::path_exists(p) && os::path_exists(newp) {\n+            return Some(newp);\n+        }\n     }\n     None\n }\n@@ -72,6 +82,7 @@ pub fn open(term: &str) -> Result<@Reader, ~str> {\n #[ignore(reason = \"buildbots don't have ncurses installed and I can't mock everything I need\")]\n fn test_get_dbpath_for_term() {\n     // woefully inadequate test coverage\n+    // note: current tests won't work with non-standard terminfo hierarchies (e.g. OS X's)\n     use std::os::{setenv, unsetenv};\n     fn x(t: &str) -> ~str { get_dbpath_for_term(t).expect(\"no terminfo entry found\").to_str() };\n     assert!(x(\"screen\") == ~\"/usr/share/terminfo/s/screen\");"}]}