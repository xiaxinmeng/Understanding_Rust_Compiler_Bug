{"sha": "bd16825767d53dad8851e0e36c0d2c2392b1384c", "node_id": "MDY6Q29tbWl0NzI0NzEyOmJkMTY4MjU3NjdkNTNkYWQ4ODUxZTBlMzZjMGQyYzIzOTJiMTM4NGM=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-05-16T00:04:58Z"}, "committer": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-05-16T00:06:40Z"}, "message": "Allow `async {}` expressions in const contexts", "tree": {"sha": "09e584b79d8488a87235ee55b4449b52ac7c18c9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/09e584b79d8488a87235ee55b4449b52ac7c18c9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bd16825767d53dad8851e0e36c0d2c2392b1384c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bd16825767d53dad8851e0e36c0d2c2392b1384c", "html_url": "https://github.com/rust-lang/rust/commit/bd16825767d53dad8851e0e36c0d2c2392b1384c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bd16825767d53dad8851e0e36c0d2c2392b1384c/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8cf990c9b5c59f25c806fad9f4466f9d6509bbea", "url": "https://api.github.com/repos/rust-lang/rust/commits/8cf990c9b5c59f25c806fad9f4466f9d6509bbea", "html_url": "https://github.com/rust-lang/rust/commit/8cf990c9b5c59f25c806fad9f4466f9d6509bbea"}], "stats": {"total": 89, "additions": 70, "deletions": 19}, "files": [{"sha": "78ead47d1ba74dd1f1b76b5965a118ad4e4358cb", "filename": "compiler/rustc_feature/src/active.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/bd16825767d53dad8851e0e36c0d2c2392b1384c/compiler%2Frustc_feature%2Fsrc%2Factive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bd16825767d53dad8851e0e36c0d2c2392b1384c/compiler%2Frustc_feature%2Fsrc%2Factive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_feature%2Fsrc%2Factive.rs?ref=bd16825767d53dad8851e0e36c0d2c2392b1384c", "patch": "@@ -650,6 +650,9 @@ declare_features! (\n     /// Allows unsizing coercions in `const fn`.\n     (active, const_fn_unsize, \"1.53.0\", Some(64992), None),\n \n+    /// Allows `async {}` expressions in const contexts.\n+    (active, const_async_blocks, \"1.53.0\", None, None),\n+\n     /// Allows using imported `main` function\n     (active, imported_main, \"1.53.0\", Some(28937), None),\n "}, {"sha": "16f5f14f563a390f638c584ef25c1700be912a03", "filename": "compiler/rustc_mir/src/transform/check_consts/ops.rs", "status": "modified", "additions": 10, "deletions": 2, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/bd16825767d53dad8851e0e36c0d2c2392b1384c/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fcheck_consts%2Fops.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bd16825767d53dad8851e0e36c0d2c2392b1384c/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fcheck_consts%2Fops.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fcheck_consts%2Fops.rs?ref=bd16825767d53dad8851e0e36c0d2c2392b1384c", "patch": "@@ -141,12 +141,20 @@ impl NonConstOp for FnPtrCast {\n pub struct Generator(pub hir::GeneratorKind);\n impl NonConstOp for Generator {\n     fn status_in_item(&self, _: &ConstCx<'_, '_>) -> Status {\n-        Status::Forbidden\n+        if let hir::GeneratorKind::Async(hir::AsyncGeneratorKind::Block) = self.0 {\n+            Status::Unstable(sym::const_async_blocks)\n+        } else {\n+            Status::Forbidden\n+        }\n     }\n \n     fn build_error(&self, ccx: &ConstCx<'_, 'tcx>, span: Span) -> DiagnosticBuilder<'tcx> {\n         let msg = format!(\"{}s are not allowed in {}s\", self.0, ccx.const_kind());\n-        ccx.tcx.sess.struct_span_err(span, &msg)\n+        if let hir::GeneratorKind::Async(hir::AsyncGeneratorKind::Block) = self.0 {\n+            feature_err(&ccx.tcx.sess.parse_sess, sym::const_async_blocks, span, &msg)\n+        } else {\n+            ccx.tcx.sess.struct_span_err(span, &msg)\n+        }\n     }\n }\n "}, {"sha": "502d4cd3272e07df602168769dec03394fb4c157", "filename": "compiler/rustc_span/src/symbol.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/bd16825767d53dad8851e0e36c0d2c2392b1384c/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bd16825767d53dad8851e0e36c0d2c2392b1384c/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs?ref=bd16825767d53dad8851e0e36c0d2c2392b1384c", "patch": "@@ -374,6 +374,7 @@ symbols! {\n         conservative_impl_trait,\n         console,\n         const_allocate,\n+        const_async_blocks,\n         const_compare_raw_pointers,\n         const_constructor,\n         const_eval_limit,"}, {"sha": "78ec8aea7248c301c0e5bd9ccb1646367db8fc61", "filename": "src/test/ui/consts/async-block.rs", "status": "modified", "additions": 14, "deletions": 3, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/bd16825767d53dad8851e0e36c0d2c2392b1384c/src%2Ftest%2Fui%2Fconsts%2Fasync-block.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bd16825767d53dad8851e0e36c0d2c2392b1384c/src%2Ftest%2Fui%2Fconsts%2Fasync-block.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fasync-block.rs?ref=bd16825767d53dad8851e0e36c0d2c2392b1384c", "patch": "@@ -1,8 +1,19 @@\n-// From <https://github.com/rust-lang/rust/issues/77361>\n+// gate-test-const_async_blocks\n \n // edition:2018\n+// revisions: with_feature without_feature\n+\n+#![feature(rustc_attrs)]\n+#![cfg_attr(with_feature, feature(const_async_blocks))]\n+\n+use std::future::Future;\n \n+// From <https://github.com/rust-lang/rust/issues/77361>\n const _: i32 = { core::mem::ManuallyDrop::new(async { 0 }); 4 };\n-//~^ `async` block\n+//[without_feature]~^ `async` block\n+\n+static _FUT: &(dyn Future<Output = ()> + Sync) = &async {};\n+//[without_feature]~^ `async` block\n \n-fn main() {}\n+#[rustc_error]\n+fn main() {} //[with_feature]~ fatal error triggered by #[rustc_error]"}, {"sha": "99f470623ac32ce2835386a648f73b5ba8c31890", "filename": "src/test/ui/consts/async-block.stderr", "status": "removed", "additions": 0, "deletions": 8, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/8cf990c9b5c59f25c806fad9f4466f9d6509bbea/src%2Ftest%2Fui%2Fconsts%2Fasync-block.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/8cf990c9b5c59f25c806fad9f4466f9d6509bbea/src%2Ftest%2Fui%2Fconsts%2Fasync-block.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fasync-block.stderr?ref=8cf990c9b5c59f25c806fad9f4466f9d6509bbea", "patch": "@@ -1,8 +0,0 @@\n-error: `async` blocks are not allowed in constants\n-  --> $DIR/async-block.rs:5:47\n-   |\n-LL | const _: i32 = { core::mem::ManuallyDrop::new(async { 0 }); 4 };\n-   |                                               ^^^^^^^^^^^\n-\n-error: aborting due to previous error\n-"}, {"sha": "8c6364aeca60d15abb87415647cc2eca0cf9004e", "filename": "src/test/ui/consts/async-block.with_feature.stderr", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/bd16825767d53dad8851e0e36c0d2c2392b1384c/src%2Ftest%2Fui%2Fconsts%2Fasync-block.with_feature.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/bd16825767d53dad8851e0e36c0d2c2392b1384c/src%2Ftest%2Fui%2Fconsts%2Fasync-block.with_feature.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fasync-block.with_feature.stderr?ref=bd16825767d53dad8851e0e36c0d2c2392b1384c", "patch": "@@ -0,0 +1,8 @@\n+error: fatal error triggered by #[rustc_error]\n+  --> $DIR/async-block.rs:19:1\n+   |\n+LL | fn main() {}\n+   | ^^^^^^^^^\n+\n+error: aborting due to previous error\n+"}, {"sha": "93d0fbd395080f3c92a5d960e8ace446091de8f2", "filename": "src/test/ui/consts/async-block.without_feature.stderr", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/bd16825767d53dad8851e0e36c0d2c2392b1384c/src%2Ftest%2Fui%2Fconsts%2Fasync-block.without_feature.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/bd16825767d53dad8851e0e36c0d2c2392b1384c/src%2Ftest%2Fui%2Fconsts%2Fasync-block.without_feature.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fasync-block.without_feature.stderr?ref=bd16825767d53dad8851e0e36c0d2c2392b1384c", "patch": "@@ -0,0 +1,19 @@\n+error[E0658]: `async` blocks are not allowed in constants\n+  --> $DIR/async-block.rs:12:47\n+   |\n+LL | const _: i32 = { core::mem::ManuallyDrop::new(async { 0 }); 4 };\n+   |                                               ^^^^^^^^^^^\n+   |\n+   = help: add `#![feature(const_async_blocks)]` to the crate attributes to enable\n+\n+error[E0658]: `async` blocks are not allowed in statics\n+  --> $DIR/async-block.rs:15:51\n+   |\n+LL | static _FUT: &(dyn Future<Output = ()> + Sync) = &async {};\n+   |                                                   ^^^^^^^^\n+   |\n+   = help: add `#![feature(const_async_blocks)]` to the crate attributes to enable\n+\n+error: aborting due to 2 previous errors\n+\n+For more information about this error, try `rustc --explain E0658`."}, {"sha": "b6acdfa048fc3a109af00bbf1709d0f7b39c5b62", "filename": "src/test/ui/impl-trait/issues/issue-78721.stderr", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/bd16825767d53dad8851e0e36c0d2c2392b1384c/src%2Ftest%2Fui%2Fimpl-trait%2Fissues%2Fissue-78721.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/bd16825767d53dad8851e0e36c0d2c2392b1384c/src%2Ftest%2Fui%2Fimpl-trait%2Fissues%2Fissue-78721.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fimpl-trait%2Fissues%2Fissue-78721.stderr?ref=bd16825767d53dad8851e0e36c0d2c2392b1384c", "patch": "@@ -7,11 +7,13 @@ LL | #![feature(impl_trait_in_bindings)]\n    = note: `#[warn(incomplete_features)]` on by default\n    = note: see issue #63065 <https://github.com/rust-lang/rust/issues/63065> for more information\n \n-error: `async` blocks are not allowed in constants\n+error[E0658]: `async` blocks are not allowed in constants\n   --> $DIR/issue-78721.rs:8:57\n    |\n LL |         let f: impl core::future::Future<Output = u8> = async { 1 };\n    |                                                         ^^^^^^^^^^^\n+   |\n+   = help: add `#![feature(const_async_blocks)]` to the crate attributes to enable\n \n error[E0493]: destructors cannot be evaluated at compile-time\n   --> $DIR/issue-78721.rs:8:13\n@@ -24,4 +26,5 @@ LL |     }],\n \n error: aborting due to 2 previous errors; 1 warning emitted\n \n-For more information about this error, try `rustc --explain E0493`.\n+Some errors have detailed explanations: E0493, E0658.\n+For more information about an error, try `rustc --explain E0493`."}, {"sha": "f013547782e890b9f5faabe30b50ab526950538f", "filename": "src/test/ui/impl-trait/issues/issue-78722.full_tait.stderr", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/bd16825767d53dad8851e0e36c0d2c2392b1384c/src%2Ftest%2Fui%2Fimpl-trait%2Fissues%2Fissue-78722.full_tait.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/bd16825767d53dad8851e0e36c0d2c2392b1384c/src%2Ftest%2Fui%2Fimpl-trait%2Fissues%2Fissue-78722.full_tait.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fimpl-trait%2Fissues%2Fissue-78722.full_tait.stderr?ref=bd16825767d53dad8851e0e36c0d2c2392b1384c", "patch": "@@ -15,11 +15,13 @@ LL | #![feature(impl_trait_in_bindings)]\n    |\n    = note: see issue #63065 <https://github.com/rust-lang/rust/issues/63065> for more information\n \n-error: `async` blocks are not allowed in constants\n+error[E0658]: `async` blocks are not allowed in constants\n   --> $DIR/issue-78722.rs:17:20\n    |\n LL |         let f: F = async { 1 };\n    |                    ^^^^^^^^^^^\n+   |\n+   = help: add `#![feature(const_async_blocks)]` to the crate attributes to enable\n \n error[E0493]: destructors cannot be evaluated at compile-time\n   --> $DIR/issue-78722.rs:17:13\n@@ -32,4 +34,5 @@ LL |     }],\n \n error: aborting due to 2 previous errors; 2 warnings emitted\n \n-For more information about this error, try `rustc --explain E0493`.\n+Some errors have detailed explanations: E0493, E0658.\n+For more information about an error, try `rustc --explain E0493`."}, {"sha": "9425bc48d69745cbef048ba6cb25b0979d22912b", "filename": "src/test/ui/impl-trait/issues/issue-78722.min_tait.stderr", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/bd16825767d53dad8851e0e36c0d2c2392b1384c/src%2Ftest%2Fui%2Fimpl-trait%2Fissues%2Fissue-78722.min_tait.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/bd16825767d53dad8851e0e36c0d2c2392b1384c/src%2Ftest%2Fui%2Fimpl-trait%2Fissues%2Fissue-78722.min_tait.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fimpl-trait%2Fissues%2Fissue-78722.min_tait.stderr?ref=bd16825767d53dad8851e0e36c0d2c2392b1384c", "patch": "@@ -7,11 +7,13 @@ LL | #![feature(impl_trait_in_bindings)]\n    = note: `#[warn(incomplete_features)]` on by default\n    = note: see issue #63065 <https://github.com/rust-lang/rust/issues/63065> for more information\n \n-error: `async` blocks are not allowed in constants\n+error[E0658]: `async` blocks are not allowed in constants\n   --> $DIR/issue-78722.rs:17:20\n    |\n LL |         let f: F = async { 1 };\n    |                    ^^^^^^^^^^^\n+   |\n+   = help: add `#![feature(const_async_blocks)]` to the crate attributes to enable\n \n error[E0493]: destructors cannot be evaluated at compile-time\n   --> $DIR/issue-78722.rs:17:13\n@@ -24,4 +26,5 @@ LL |     }],\n \n error: aborting due to 2 previous errors; 1 warning emitted\n \n-For more information about this error, try `rustc --explain E0493`.\n+Some errors have detailed explanations: E0493, E0658.\n+For more information about an error, try `rustc --explain E0493`."}]}