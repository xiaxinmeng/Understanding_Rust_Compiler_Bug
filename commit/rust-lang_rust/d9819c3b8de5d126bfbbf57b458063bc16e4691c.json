{"sha": "d9819c3b8de5d126bfbbf57b458063bc16e4691c", "node_id": "C_kwDOAAsO6NoAKGQ5ODE5YzNiOGRlNWQxMjZiZmJiZjU3YjQ1ODA2M2JjMTZlNDY5MWM", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-03-30T15:25:37Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-03-30T15:25:37Z"}, "message": "Auto merge of #8584 - Alexendoo:map-unit-fn-context, r=Manishearth\n\nProvide suggestion context in map_unit_fn\n\nFixes #8569\n\nchangelog: Fix incorrect suggestion for `option_map_unit_fn` , `result_map_unit_fn`", "tree": {"sha": "dbc0c5e89d8bdf3cdd8beb9b615cf616994df821", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/dbc0c5e89d8bdf3cdd8beb9b615cf616994df821"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d9819c3b8de5d126bfbbf57b458063bc16e4691c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d9819c3b8de5d126bfbbf57b458063bc16e4691c", "html_url": "https://github.com/rust-lang/rust/commit/d9819c3b8de5d126bfbbf57b458063bc16e4691c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d9819c3b8de5d126bfbbf57b458063bc16e4691c/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6206086dd5a83477131094b1f0ef61b10e7ced42", "url": "https://api.github.com/repos/rust-lang/rust/commits/6206086dd5a83477131094b1f0ef61b10e7ced42", "html_url": "https://github.com/rust-lang/rust/commit/6206086dd5a83477131094b1f0ef61b10e7ced42"}, {"sha": "610db04222445e2e25c911dda9a0ae7e30df3cd9", "url": "https://api.github.com/repos/rust-lang/rust/commits/610db04222445e2e25c911dda9a0ae7e30df3cd9", "html_url": "https://github.com/rust-lang/rust/commit/610db04222445e2e25c911dda9a0ae7e30df3cd9"}], "stats": {"total": 59, "additions": 41, "deletions": 18}, "files": [{"sha": "f552d5c1afab9268f4448af24acbd7e881cd2a84", "filename": "clippy_lints/src/map_unit_fn.rs", "status": "modified", "additions": 10, "deletions": 13, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/d9819c3b8de5d126bfbbf57b458063bc16e4691c/clippy_lints%2Fsrc%2Fmap_unit_fn.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9819c3b8de5d126bfbbf57b458063bc16e4691c/clippy_lints%2Fsrc%2Fmap_unit_fn.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmap_unit_fn.rs?ref=d9819c3b8de5d126bfbbf57b458063bc16e4691c", "patch": "@@ -1,5 +1,5 @@\n use clippy_utils::diagnostics::span_lint_and_then;\n-use clippy_utils::source::snippet;\n+use clippy_utils::source::{snippet, snippet_with_applicability, snippet_with_context};\n use clippy_utils::ty::is_type_diagnostic_item;\n use clippy_utils::{iter_input_pats, method_chain_args};\n use if_chain::if_chain;\n@@ -217,36 +217,33 @@ fn lint_map_unit_fn(cx: &LateContext<'_>, stmt: &hir::Stmt<'_>, expr: &hir::Expr\n     let fn_arg = &map_args[1];\n \n     if is_unit_function(cx, fn_arg) {\n+        let mut applicability = Applicability::MachineApplicable;\n         let msg = suggestion_msg(\"function\", map_type);\n         let suggestion = format!(\n             \"if let {0}({binding}) = {1} {{ {2}({binding}) }}\",\n             variant,\n-            snippet(cx, var_arg.span, \"_\"),\n-            snippet(cx, fn_arg.span, \"_\"),\n+            snippet_with_applicability(cx, var_arg.span, \"_\", &mut applicability),\n+            snippet_with_applicability(cx, fn_arg.span, \"_\", &mut applicability),\n             binding = let_binding_name(cx, var_arg)\n         );\n \n         span_lint_and_then(cx, lint, expr.span, &msg, |diag| {\n-            diag.span_suggestion(stmt.span, \"try this\", suggestion, Applicability::MachineApplicable);\n+            diag.span_suggestion(stmt.span, \"try this\", suggestion, applicability);\n         });\n     } else if let Some((binding, closure_expr)) = unit_closure(cx, fn_arg) {\n         let msg = suggestion_msg(\"closure\", map_type);\n \n         span_lint_and_then(cx, lint, expr.span, &msg, |diag| {\n             if let Some(reduced_expr_span) = reduce_unit_expression(cx, closure_expr) {\n+                let mut applicability = Applicability::MachineApplicable;\n                 let suggestion = format!(\n                     \"if let {0}({1}) = {2} {{ {3} }}\",\n                     variant,\n-                    snippet(cx, binding.pat.span, \"_\"),\n-                    snippet(cx, var_arg.span, \"_\"),\n-                    snippet(cx, reduced_expr_span, \"_\")\n-                );\n-                diag.span_suggestion(\n-                    stmt.span,\n-                    \"try this\",\n-                    suggestion,\n-                    Applicability::MachineApplicable, // snippet\n+                    snippet_with_applicability(cx, binding.pat.span, \"_\", &mut applicability),\n+                    snippet_with_applicability(cx, var_arg.span, \"_\", &mut applicability),\n+                    snippet_with_context(cx, reduced_expr_span, var_arg.span.ctxt(), \"_\", &mut applicability).0,\n                 );\n+                diag.span_suggestion(stmt.span, \"try this\", suggestion, applicability);\n             } else {\n                 let suggestion = format!(\n                     \"if let {0}({1}) = {2} {{ ... }}\","}, {"sha": "1290bd8efebd287eda8df11864090b9202a229ba", "filename": "tests/ui/option_map_unit_fn_fixable.fixed", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/d9819c3b8de5d126bfbbf57b458063bc16e4691c/tests%2Fui%2Foption_map_unit_fn_fixable.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/d9819c3b8de5d126bfbbf57b458063bc16e4691c/tests%2Fui%2Foption_map_unit_fn_fixable.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Foption_map_unit_fn_fixable.fixed?ref=d9819c3b8de5d126bfbbf57b458063bc16e4691c", "patch": "@@ -80,6 +80,9 @@ fn option_map_unit_fn() {\n \n     if let Some(ref value) = x.field { do_nothing(value + captured) }\n \n-    if let Some(a) = option() { do_nothing(a) }}\n+    if let Some(a) = option() { do_nothing(a) }\n+\n+    if let Some(value) = option() { println!(\"{:?}\", value) }\n+}\n \n fn main() {}"}, {"sha": "f3e5b62c65b7f769bb0812d8460a2791b0a14c65", "filename": "tests/ui/option_map_unit_fn_fixable.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/d9819c3b8de5d126bfbbf57b458063bc16e4691c/tests%2Fui%2Foption_map_unit_fn_fixable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9819c3b8de5d126bfbbf57b458063bc16e4691c/tests%2Fui%2Foption_map_unit_fn_fixable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Foption_map_unit_fn_fixable.rs?ref=d9819c3b8de5d126bfbbf57b458063bc16e4691c", "patch": "@@ -80,6 +80,9 @@ fn option_map_unit_fn() {\n \n     x.field.map(|ref value| { do_nothing(value + captured) });\n \n-    option().map(do_nothing);}\n+    option().map(do_nothing);\n+\n+    option().map(|value| println!(\"{:?}\", value));\n+}\n \n fn main() {}"}, {"sha": "ab2a294a060f0c2507b81f1eedd6288e4b486f3d", "filename": "tests/ui/option_map_unit_fn_fixable.stderr", "status": "modified", "additions": 10, "deletions": 2, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/d9819c3b8de5d126bfbbf57b458063bc16e4691c/tests%2Fui%2Foption_map_unit_fn_fixable.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/d9819c3b8de5d126bfbbf57b458063bc16e4691c/tests%2Fui%2Foption_map_unit_fn_fixable.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Foption_map_unit_fn_fixable.stderr?ref=d9819c3b8de5d126bfbbf57b458063bc16e4691c", "patch": "@@ -139,10 +139,18 @@ LL |     x.field.map(|ref value| { do_nothing(value + captured) });\n error: called `map(f)` on an `Option` value where `f` is a function that returns the unit type `()`\n   --> $DIR/option_map_unit_fn_fixable.rs:83:5\n    |\n-LL |     option().map(do_nothing);}\n+LL |     option().map(do_nothing);\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^-\n    |     |\n    |     help: try this: `if let Some(a) = option() { do_nothing(a) }`\n \n-error: aborting due to 18 previous errors\n+error: called `map(f)` on an `Option` value where `f` is a closure that returns the unit type `()`\n+  --> $DIR/option_map_unit_fn_fixable.rs:85:5\n+   |\n+LL |     option().map(|value| println!(\"{:?}\", value));\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^-\n+   |     |\n+   |     help: try this: `if let Some(value) = option() { println!(\"{:?}\", value) }`\n+\n+error: aborting due to 19 previous errors\n "}, {"sha": "14c331f67e739c34ca722ff0776a83fbe88f5566", "filename": "tests/ui/result_map_unit_fn_fixable.fixed", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d9819c3b8de5d126bfbbf57b458063bc16e4691c/tests%2Fui%2Fresult_map_unit_fn_fixable.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/d9819c3b8de5d126bfbbf57b458063bc16e4691c/tests%2Fui%2Fresult_map_unit_fn_fixable.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fresult_map_unit_fn_fixable.fixed?ref=d9819c3b8de5d126bfbbf57b458063bc16e4691c", "patch": "@@ -75,6 +75,8 @@ fn result_map_unit_fn() {\n \n \n     if let Ok(ref value) = x.field { do_nothing(value + captured) }\n+\n+    if let Ok(value) = x.field { println!(\"{:?}\", value) }\n }\n \n fn main() {}"}, {"sha": "8b0fca9ece1a375d45e532a5eda015265db5a383", "filename": "tests/ui/result_map_unit_fn_fixable.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d9819c3b8de5d126bfbbf57b458063bc16e4691c/tests%2Fui%2Fresult_map_unit_fn_fixable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9819c3b8de5d126bfbbf57b458063bc16e4691c/tests%2Fui%2Fresult_map_unit_fn_fixable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fresult_map_unit_fn_fixable.rs?ref=d9819c3b8de5d126bfbbf57b458063bc16e4691c", "patch": "@@ -75,6 +75,8 @@ fn result_map_unit_fn() {\n \n \n     x.field.map(|ref value| { do_nothing(value + captured) });\n+\n+    x.field.map(|value| println!(\"{:?}\", value));\n }\n \n fn main() {}"}, {"sha": "782febd52644128e0e7e18e4c1f4316efbb33b9e", "filename": "tests/ui/result_map_unit_fn_fixable.stderr", "status": "modified", "additions": 9, "deletions": 1, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/d9819c3b8de5d126bfbbf57b458063bc16e4691c/tests%2Fui%2Fresult_map_unit_fn_fixable.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/d9819c3b8de5d126bfbbf57b458063bc16e4691c/tests%2Fui%2Fresult_map_unit_fn_fixable.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fresult_map_unit_fn_fixable.stderr?ref=d9819c3b8de5d126bfbbf57b458063bc16e4691c", "patch": "@@ -136,5 +136,13 @@ LL |     x.field.map(|ref value| { do_nothing(value + captured) });\n    |     |\n    |     help: try this: `if let Ok(ref value) = x.field { do_nothing(value + captured) }`\n \n-error: aborting due to 17 previous errors\n+error: called `map(f)` on an `Result` value where `f` is a closure that returns the unit type `()`\n+  --> $DIR/result_map_unit_fn_fixable.rs:79:5\n+   |\n+LL |     x.field.map(|value| println!(\"{:?}\", value));\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^-\n+   |     |\n+   |     help: try this: `if let Ok(value) = x.field { println!(\"{:?}\", value) }`\n+\n+error: aborting due to 18 previous errors\n "}]}