{"sha": "ee618e1e7590bf2cfd6431dafa0b6a9565bc91d3", "node_id": "MDY6Q29tbWl0NzI0NzEyOmVlNjE4ZTFlNzU5MGJmMmNmZDY0MzFkYWZhMGI2YTk1NjViYzkxZDM=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2013-12-10T17:28:20Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2013-12-12T03:37:26Z"}, "message": "Don't always modify the symbol table in rlibs\n\nTurns out that one some platforms the ar/ranlib tool will die with an assertion\nif the file being added doesn't actually have any symbols (or if it's just not\nan object file presumably).\n\nThis functionality is already all exercised on the bots, it just turns out that\nthe bots don't have an ar tool which dies in this situation, so it's difficult\nfor me to add a test.\n\nCloses #10907", "tree": {"sha": "445d1c7cd31db1787e78ebdcf6cf14f9ff1a07ec", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/445d1c7cd31db1787e78ebdcf6cf14f9ff1a07ec"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ee618e1e7590bf2cfd6431dafa0b6a9565bc91d3", "comment_count": 9, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ee618e1e7590bf2cfd6431dafa0b6a9565bc91d3", "html_url": "https://github.com/rust-lang/rust/commit/ee618e1e7590bf2cfd6431dafa0b6a9565bc91d3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ee618e1e7590bf2cfd6431dafa0b6a9565bc91d3/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "487e58cca24f6644d3d1f01558b6dcb8b1633699", "url": "https://api.github.com/repos/rust-lang/rust/commits/487e58cca24f6644d3d1f01558b6dcb8b1633699", "html_url": "https://github.com/rust-lang/rust/commit/487e58cca24f6644d3d1f01558b6dcb8b1633699"}], "stats": {"total": 20, "additions": 16, "deletions": 4}, "files": [{"sha": "c1916714bf28366126e81e7899fa67fe03e920b7", "filename": "src/librustc/back/archive.rs", "status": "modified", "additions": 9, "deletions": 2, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/ee618e1e7590bf2cfd6431dafa0b6a9565bc91d3/src%2Flibrustc%2Fback%2Farchive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee618e1e7590bf2cfd6431dafa0b6a9565bc91d3/src%2Flibrustc%2Fback%2Farchive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fback%2Farchive.rs?ref=ee618e1e7590bf2cfd6431dafa0b6a9565bc91d3", "patch": "@@ -103,15 +103,22 @@ impl Archive {\n     }\n \n     /// Adds an arbitrary file to this archive\n-    pub fn add_file(&mut self, file: &Path) {\n-        run_ar(self.sess, \"r\", None, [&self.dst, file]);\n+    pub fn add_file(&mut self, file: &Path, has_symbols: bool) {\n+        let cmd = if has_symbols {\"r\"} else {\"rS\"};\n+        run_ar(self.sess, cmd, None, [&self.dst, file]);\n     }\n \n     /// Removes a file from this archive\n     pub fn remove_file(&mut self, file: &str) {\n         run_ar(self.sess, \"d\", None, [&self.dst, &Path::new(file)]);\n     }\n \n+    /// Update all symbols in the archive (runs 'ar s' over it)\n+    pub fn update_symbols(&mut self) {\n+        run_ar(self.sess, \"s\", None, [&self.dst]);\n+    }\n+\n+    /// List all files in an archive\n     pub fn files(&self) -> ~[~str] {\n         let output = run_ar(self.sess, \"t\", None, [&self.dst]);\n         str::from_utf8(output.output).lines().map(|s| s.to_owned()).collect()"}, {"sha": "43a08d1c998c3c09fb6b5903b70e9e3e7c530afa", "filename": "src/librustc/back/link.rs", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/ee618e1e7590bf2cfd6431dafa0b6a9565bc91d3/src%2Flibrustc%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee618e1e7590bf2cfd6431dafa0b6a9565bc91d3/src%2Flibrustc%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fback%2Flink.rs?ref=ee618e1e7590bf2cfd6431dafa0b6a9565bc91d3", "patch": "@@ -982,16 +982,21 @@ fn link_rlib(sess: Session,\n             // contain the metadata in a separate file.\n             let metadata = obj_filename.with_filename(METADATA_FILENAME);\n             fs::File::create(&metadata).write(trans.metadata);\n-            a.add_file(&metadata);\n+            a.add_file(&metadata, false);\n             fs::unlink(&metadata);\n \n             // For LTO purposes, the bytecode of this library is also inserted\n             // into the archive.\n             let bc = obj_filename.with_extension(\"bc\");\n-            a.add_file(&bc);\n+            a.add_file(&bc, false);\n             if !sess.opts.save_temps {\n                 fs::unlink(&bc);\n             }\n+\n+            // Now that we've added files, some platforms need us to now update\n+            // the symbol table in the archive (because some platforms die when\n+            // adding files to the archive without symbols).\n+            a.update_symbols();\n         }\n \n         None => {}"}]}