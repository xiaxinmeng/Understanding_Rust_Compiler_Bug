{"sha": "8769f4ef2fe1efddd1f072485f97f568e7328f79", "node_id": "C_kwDOAAsO6NoAKDg3NjlmNGVmMmZlMWVmZGRkMWYwNzI0ODVmOTdmNTY4ZTczMjhmNzk", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-03-02T19:50:55Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-03-02T19:50:55Z"}, "message": "Auto merge of #92214 - ehuss:submodule-bg-exit, r=Mark-Simulacrum\n\nError if submodule fetch fails.\n\nIn CI, if fetching a submodule fails, the script would exit successfully. Later parts of the build will fail due to the missing files, but it is a bit confusing, and I think it would be better to error out earlier.\n\nThe reason is that in bash, `wait` without arguments will exit 0 even if a background job exits with an error. The solution here is to wait on each individual job, which will return the exit code of the job.\n\nThis was encountered in #92177.", "tree": {"sha": "bfa8292606af8819bf1ebd6a5d2c94f3e94ccf06", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bfa8292606af8819bf1ebd6a5d2c94f3e94ccf06"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8769f4ef2fe1efddd1f072485f97f568e7328f79", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8769f4ef2fe1efddd1f072485f97f568e7328f79", "html_url": "https://github.com/rust-lang/rust/commit/8769f4ef2fe1efddd1f072485f97f568e7328f79", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8769f4ef2fe1efddd1f072485f97f568e7328f79/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "08504c64aa7c4163a51c1982ed10075bb89cec0e", "url": "https://api.github.com/repos/rust-lang/rust/commits/08504c64aa7c4163a51c1982ed10075bb89cec0e", "html_url": "https://github.com/rust-lang/rust/commit/08504c64aa7c4163a51c1982ed10075bb89cec0e"}, {"sha": "43f83bc013270c7113cd75c27cc781df229c4645", "url": "https://api.github.com/repos/rust-lang/rust/commits/43f83bc013270c7113cd75c27cc781df229c4645", "html_url": "https://github.com/rust-lang/rust/commit/43f83bc013270c7113cd75c27cc781df229c4645"}], "stats": {"total": 39, "additions": 25, "deletions": 14}, "files": [{"sha": "ff3a8326315309a2232a9b5a9f74971175ab3d81", "filename": ".github/workflows/ci.yml", "status": "modified", "additions": 9, "deletions": 9, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/8769f4ef2fe1efddd1f072485f97f568e7328f79/.github%2Fworkflows%2Fci.yml", "raw_url": "https://github.com/rust-lang/rust/raw/8769f4ef2fe1efddd1f072485f97f568e7328f79/.github%2Fworkflows%2Fci.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.github%2Fworkflows%2Fci.yml?ref=8769f4ef2fe1efddd1f072485f97f568e7328f79", "patch": "@@ -104,6 +104,9 @@ jobs:\n       - name: disable git crlf conversion\n         run: src/ci/scripts/disable-git-crlf-conversion.sh\n         if: success() && !env.SKIP_JOB\n+      - name: checkout submodules\n+        run: src/ci/scripts/checkout-submodules.sh\n+        if: success() && !env.SKIP_JOB\n       - name: install MSYS2\n         run: src/ci/scripts/install-msys2.sh\n         if: success() && !env.SKIP_JOB\n@@ -119,9 +122,6 @@ jobs:\n       - name: disable git crlf conversion\n         run: src/ci/scripts/disable-git-crlf-conversion.sh\n         if: success() && !env.SKIP_JOB\n-      - name: checkout submodules\n-        run: src/ci/scripts/checkout-submodules.sh\n-        if: success() && !env.SKIP_JOB\n       - name: ensure line endings are correct\n         run: src/ci/scripts/verify-line-endings.sh\n         if: success() && !env.SKIP_JOB\n@@ -502,6 +502,9 @@ jobs:\n       - name: disable git crlf conversion\n         run: src/ci/scripts/disable-git-crlf-conversion.sh\n         if: success() && !env.SKIP_JOB\n+      - name: checkout submodules\n+        run: src/ci/scripts/checkout-submodules.sh\n+        if: success() && !env.SKIP_JOB\n       - name: install MSYS2\n         run: src/ci/scripts/install-msys2.sh\n         if: success() && !env.SKIP_JOB\n@@ -517,9 +520,6 @@ jobs:\n       - name: disable git crlf conversion\n         run: src/ci/scripts/disable-git-crlf-conversion.sh\n         if: success() && !env.SKIP_JOB\n-      - name: checkout submodules\n-        run: src/ci/scripts/checkout-submodules.sh\n-        if: success() && !env.SKIP_JOB\n       - name: ensure line endings are correct\n         run: src/ci/scripts/verify-line-endings.sh\n         if: success() && !env.SKIP_JOB\n@@ -615,6 +615,9 @@ jobs:\n       - name: disable git crlf conversion\n         run: src/ci/scripts/disable-git-crlf-conversion.sh\n         if: success() && !env.SKIP_JOB\n+      - name: checkout submodules\n+        run: src/ci/scripts/checkout-submodules.sh\n+        if: success() && !env.SKIP_JOB\n       - name: install MSYS2\n         run: src/ci/scripts/install-msys2.sh\n         if: success() && !env.SKIP_JOB\n@@ -630,9 +633,6 @@ jobs:\n       - name: disable git crlf conversion\n         run: src/ci/scripts/disable-git-crlf-conversion.sh\n         if: success() && !env.SKIP_JOB\n-      - name: checkout submodules\n-        run: src/ci/scripts/checkout-submodules.sh\n-        if: success() && !env.SKIP_JOB\n       - name: ensure line endings are correct\n         run: src/ci/scripts/verify-line-endings.sh\n         if: success() && !env.SKIP_JOB"}, {"sha": "5622422d50f52f7c38aaa1b794d3aa01d7b5fa70", "filename": "src/ci/github-actions/ci.yml", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/8769f4ef2fe1efddd1f072485f97f568e7328f79/src%2Fci%2Fgithub-actions%2Fci.yml", "raw_url": "https://github.com/rust-lang/rust/raw/8769f4ef2fe1efddd1f072485f97f568e7328f79/src%2Fci%2Fgithub-actions%2Fci.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fgithub-actions%2Fci.yml?ref=8769f4ef2fe1efddd1f072485f97f568e7328f79", "patch": "@@ -169,6 +169,10 @@ x--expand-yaml-anchors--remove:\n         run: src/ci/scripts/disable-git-crlf-conversion.sh\n         <<: *step\n \n+      - name: checkout submodules\n+        run: src/ci/scripts/checkout-submodules.sh\n+        <<: *step\n+\n       - name: install MSYS2\n         run: src/ci/scripts/install-msys2.sh\n         <<: *step\n@@ -194,10 +198,6 @@ x--expand-yaml-anchors--remove:\n         run: src/ci/scripts/disable-git-crlf-conversion.sh\n         <<: *step\n \n-      - name: checkout submodules\n-        run: src/ci/scripts/checkout-submodules.sh\n-        <<: *step\n-\n       - name: ensure line endings are correct\n         run: src/ci/scripts/verify-line-endings.sh\n         <<: *step"}, {"sha": "93af8c26111c2dde2720cfcb6aed0a46037c6919", "filename": "src/ci/init_repo.sh", "status": "modified", "additions": 12, "deletions": 1, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/8769f4ef2fe1efddd1f072485f97f568e7328f79/src%2Fci%2Finit_repo.sh", "raw_url": "https://github.com/rust-lang/rust/raw/8769f4ef2fe1efddd1f072485f97f568e7328f79/src%2Fci%2Finit_repo.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Finit_repo.sh?ref=8769f4ef2fe1efddd1f072485f97f568e7328f79", "patch": "@@ -43,6 +43,11 @@ function fetch_github_commit_archive {\n         curl -f -sSL -o $cached $2\"\n     mkdir $module\n     touch \"$module/.git\"\n+    # On Windows, the default behavior is to emulate symlinks by copying\n+    # files. However, that ends up being order-dependent while extracting,\n+    # which can cause a failure if the symlink comes first. This env var\n+    # causes tar to use real symlinks instead, which are allowed to dangle.\n+    export MSYS=winsymlinks:nativestrict\n     tar -C $module --strip-components=1 -xf $cached\n     rm $cached\n }\n@@ -62,6 +67,7 @@ for i in ${!modules[@]}; do\n         url=${urls[$i]}\n         url=${url/\\.git/}\n         fetch_github_commit_archive $module \"$url/archive/$commit.tar.gz\" &\n+        bg_pids[${i}]=$!\n         continue\n     else\n         use_git=\"$use_git $module\"\n@@ -70,4 +76,9 @@ done\n retry sh -c \"git submodule deinit -f $use_git && \\\n     git submodule sync && \\\n     git submodule update -j 16 --init --recursive $use_git\"\n-wait\n+STATUS=0\n+for pid in ${bg_pids[*]}\n+do\n+    wait $pid || STATUS=1\n+done\n+exit ${STATUS}"}]}