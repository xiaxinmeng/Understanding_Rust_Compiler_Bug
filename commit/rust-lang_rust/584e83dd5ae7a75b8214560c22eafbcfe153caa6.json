{"sha": "584e83dd5ae7a75b8214560c22eafbcfe153caa6", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU4NGU4M2RkNWFlN2E3NWI4MjE0NTYwYzIyZWFmYmNmZTE1M2NhYTY=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-07-29T13:58:19Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-07-29T13:58:19Z"}, "message": "Auto merge of #72049 - mati865:mingw-lld, r=petrochenkov\n\nMinGW: enable dllexport/dllimport\n\nFixes (only when using LLD) https://github.com/rust-lang/rust/issues/50176\nFixes https://github.com/rust-lang/rust/issues/72319\n\nThis makes `windows-gnu` on pair with `windows-msvc` when it comes to symbol exporting.\nFor MinGW it means both good things like correctly working dllimport/dllexport, ability to link with LLD and bad things like https://github.com/rust-lang/rust/issues/27438.\n\nNot sure but maybe this should land behind unstable compiler option (`-Z`) or environment variable?", "tree": {"sha": "eb24aacddc69ffba99306c244094deaaee69aef6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/eb24aacddc69ffba99306c244094deaaee69aef6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/584e83dd5ae7a75b8214560c22eafbcfe153caa6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/584e83dd5ae7a75b8214560c22eafbcfe153caa6", "html_url": "https://github.com/rust-lang/rust/commit/584e83dd5ae7a75b8214560c22eafbcfe153caa6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/584e83dd5ae7a75b8214560c22eafbcfe153caa6/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "06e7b93f6a2a3eeaf80fd6a9a3ef7b180bb5d778", "url": "https://api.github.com/repos/rust-lang/rust/commits/06e7b93f6a2a3eeaf80fd6a9a3ef7b180bb5d778", "html_url": "https://github.com/rust-lang/rust/commit/06e7b93f6a2a3eeaf80fd6a9a3ef7b180bb5d778"}, {"sha": "87abd656dabdb97758413b7f4be5bda9be71e26e", "url": "https://api.github.com/repos/rust-lang/rust/commits/87abd656dabdb97758413b7f4be5bda9be71e26e", "html_url": "https://github.com/rust-lang/rust/commit/87abd656dabdb97758413b7f4be5bda9be71e26e"}], "stats": {"total": 75, "additions": 61, "deletions": 14}, "files": [{"sha": "afdc8dc618794ace87da73a39736676f0141b0a9", "filename": "src/librustc_codegen_llvm/callee.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/584e83dd5ae7a75b8214560c22eafbcfe153caa6/src%2Flibrustc_codegen_llvm%2Fcallee.rs", "raw_url": "https://github.com/rust-lang/rust/raw/584e83dd5ae7a75b8214560c22eafbcfe153caa6/src%2Flibrustc_codegen_llvm%2Fcallee.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fcallee.rs?ref=584e83dd5ae7a75b8214560c22eafbcfe153caa6", "patch": "@@ -172,7 +172,12 @@ pub fn get_fn(cx: &CodegenCx<'ll, 'tcx>, instance: Instance<'tcx>) -> &'ll Value\n             }\n         }\n \n-        if cx.use_dll_storage_attrs && tcx.is_dllimport_foreign_item(instance_def_id) {\n+        // MinGW: For backward compatibility we rely on the linker to decide whether it\n+        // should use dllimport for functions.\n+        if cx.use_dll_storage_attrs\n+            && tcx.is_dllimport_foreign_item(instance_def_id)\n+            && tcx.sess.target.target.target_env != \"gnu\"\n+        {\n             unsafe {\n                 llvm::LLVMSetDLLStorageClass(llfn, llvm::DLLStorageClass::DllImport);\n             }"}, {"sha": "1288870f55f1f40ccb3b7dd24a23581e6723fa84", "filename": "src/librustc_codegen_llvm/consts.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/584e83dd5ae7a75b8214560c22eafbcfe153caa6/src%2Flibrustc_codegen_llvm%2Fconsts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/584e83dd5ae7a75b8214560c22eafbcfe153caa6/src%2Flibrustc_codegen_llvm%2Fconsts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fconsts.rs?ref=584e83dd5ae7a75b8214560c22eafbcfe153caa6", "patch": "@@ -287,7 +287,7 @@ impl CodegenCx<'ll, 'tcx> {\n             // argument validation.\n             debug_assert!(\n                 !(self.tcx.sess.opts.cg.linker_plugin_lto.enabled()\n-                    && self.tcx.sess.target.target.options.is_like_msvc\n+                    && self.tcx.sess.target.target.options.is_like_windows\n                     && self.tcx.sess.opts.cg.prefer_dynamic)\n             );\n "}, {"sha": "26707fdf8395af9f59015b7a078a8a1389e2869e", "filename": "src/librustc_codegen_llvm/context.rs", "status": "modified", "additions": 12, "deletions": 3, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/584e83dd5ae7a75b8214560c22eafbcfe153caa6/src%2Flibrustc_codegen_llvm%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/584e83dd5ae7a75b8214560c22eafbcfe153caa6/src%2Flibrustc_codegen_llvm%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fcontext.rs?ref=584e83dd5ae7a75b8214560c22eafbcfe153caa6", "patch": "@@ -217,7 +217,16 @@ impl<'ll, 'tcx> CodegenCx<'ll, 'tcx> {\n         // attributes in LLVM IR as well as native dependencies (in C these\n         // correspond to `__declspec(dllimport)`).\n         //\n-        // Whenever a dynamic library is built by MSVC it must have its public\n+        // LD (BFD) in MinGW mode can often correctly guess `dllexport` but\n+        // relying on that can result in issues like #50176.\n+        // LLD won't support that and expects symbols with proper attributes.\n+        // Because of that we make MinGW target emit dllexport just like MSVC.\n+        // When it comes to dllimport we use it for constants but for functions\n+        // rely on the linker to do the right thing. Opposed to dllexport this\n+        // task is easy for them (both LD and LLD) and allows us to easily use\n+        // symbols from static libraries in shared libraries.\n+        //\n+        // Whenever a dynamic library is built on Windows it must have its public\n         // interface specified by functions tagged with `dllexport` or otherwise\n         // they're not available to be linked against. This poses a few problems\n         // for the compiler, some of which are somewhat fundamental, but we use\n@@ -254,8 +263,8 @@ impl<'ll, 'tcx> CodegenCx<'ll, 'tcx> {\n         // this effect) by marking very little as `dllimport` and praying the\n         // linker will take care of everything. Fixing this problem will likely\n         // require adding a few attributes to Rust itself (feature gated at the\n-        // start) and then strongly recommending static linkage on MSVC!\n-        let use_dll_storage_attrs = tcx.sess.target.target.options.is_like_msvc;\n+        // start) and then strongly recommending static linkage on Windows!\n+        let use_dll_storage_attrs = tcx.sess.target.target.options.is_like_windows;\n \n         let check_overflow = tcx.sess.overflow_checks();\n "}, {"sha": "f9a782af24cda7c74b3cb725e69fecd296669db8", "filename": "src/librustc_codegen_ssa/back/linker.rs", "status": "modified", "additions": 21, "deletions": 2, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/584e83dd5ae7a75b8214560c22eafbcfe153caa6/src%2Flibrustc_codegen_ssa%2Fback%2Flinker.rs", "raw_url": "https://github.com/rust-lang/rust/raw/584e83dd5ae7a75b8214560c22eafbcfe153caa6/src%2Flibrustc_codegen_ssa%2Fback%2Flinker.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_ssa%2Fback%2Flinker.rs?ref=584e83dd5ae7a75b8214560c22eafbcfe153caa6", "patch": "@@ -523,8 +523,9 @@ impl<'a> Linker for GccLinker<'a> {\n             return;\n         }\n \n+        let is_windows = self.sess.target.target.options.is_like_windows;\n         let mut arg = OsString::new();\n-        let path = tmpdir.join(\"list\");\n+        let path = tmpdir.join(if is_windows { \"list.def\" } else { \"list\" });\n \n         debug!(\"EXPORTED SYMBOLS:\");\n \n@@ -540,6 +541,21 @@ impl<'a> Linker for GccLinker<'a> {\n             if let Err(e) = res {\n                 self.sess.fatal(&format!(\"failed to write lib.def file: {}\", e));\n             }\n+        } else if is_windows {\n+            let res: io::Result<()> = try {\n+                let mut f = BufWriter::new(File::create(&path)?);\n+\n+                // .def file similar to MSVC one but without LIBRARY section\n+                // because LD doesn't like when it's empty\n+                writeln!(f, \"EXPORTS\")?;\n+                for symbol in self.info.exports[&crate_type].iter() {\n+                    debug!(\"  _{}\", symbol);\n+                    writeln!(f, \"  {}\", symbol)?;\n+                }\n+            };\n+            if let Err(e) = res {\n+                self.sess.fatal(&format!(\"failed to write list.def file: {}\", e));\n+            }\n         } else {\n             // Write an LD version script\n             let res: io::Result<()> = try {\n@@ -573,7 +589,10 @@ impl<'a> Linker for GccLinker<'a> {\n             if !self.is_ld {\n                 arg.push(\"-Wl,\")\n             }\n-            arg.push(\"--version-script=\");\n+            // Both LD and LLD accept export list in *.def file form, there are no flags required\n+            if !is_windows {\n+                arg.push(\"--version-script=\")\n+            }\n         }\n \n         arg.push(&path);"}, {"sha": "b0fae566a5aef39b1b77c167951fccd877db58f0", "filename": "src/librustc_codegen_ssa/back/write.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/584e83dd5ae7a75b8214560c22eafbcfe153caa6/src%2Flibrustc_codegen_ssa%2Fback%2Fwrite.rs", "raw_url": "https://github.com/rust-lang/rust/raw/584e83dd5ae7a75b8214560c22eafbcfe153caa6/src%2Flibrustc_codegen_ssa%2Fback%2Fwrite.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_ssa%2Fback%2Fwrite.rs?ref=584e83dd5ae7a75b8214560c22eafbcfe153caa6", "patch": "@@ -1846,11 +1846,11 @@ fn msvc_imps_needed(tcx: TyCtxt<'_>) -> bool {\n     // something is wrong with commandline arg validation.\n     assert!(\n         !(tcx.sess.opts.cg.linker_plugin_lto.enabled()\n-            && tcx.sess.target.target.options.is_like_msvc\n+            && tcx.sess.target.target.options.is_like_windows\n             && tcx.sess.opts.cg.prefer_dynamic)\n     );\n \n-    tcx.sess.target.target.options.is_like_msvc &&\n+    tcx.sess.target.target.options.is_like_windows &&\n         tcx.sess.crate_types().iter().any(|ct| *ct == CrateType::Rlib) &&\n     // ThinLTO can't handle this workaround in all cases, so we don't\n     // emit the `__imp_` symbols. Instead we make them unnecessary by disallowing"}, {"sha": "e9077f40859097309703b30c8659d3ee8b8aef29", "filename": "src/librustc_session/session.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/584e83dd5ae7a75b8214560c22eafbcfe153caa6/src%2Flibrustc_session%2Fsession.rs", "raw_url": "https://github.com/rust-lang/rust/raw/584e83dd5ae7a75b8214560c22eafbcfe153caa6/src%2Flibrustc_session%2Fsession.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_session%2Fsession.rs?ref=584e83dd5ae7a75b8214560c22eafbcfe153caa6", "patch": "@@ -1294,19 +1294,19 @@ pub fn build_session(\n // commandline argument, you can do so here.\n fn validate_commandline_args_with_session_available(sess: &Session) {\n     // Since we don't know if code in an rlib will be linked to statically or\n-    // dynamically downstream, rustc generates `__imp_` symbols that help the\n-    // MSVC linker deal with this lack of knowledge (#27438). Unfortunately,\n+    // dynamically downstream, rustc generates `__imp_` symbols that help linkers\n+    // on Windows deal with this lack of knowledge (#27438). Unfortunately,\n     // these manually generated symbols confuse LLD when it tries to merge\n-    // bitcode during ThinLTO. Therefore we disallow dynamic linking on MSVC\n+    // bitcode during ThinLTO. Therefore we disallow dynamic linking on Windows\n     // when compiling for LLD ThinLTO. This way we can validly just not generate\n     // the `dllimport` attributes and `__imp_` symbols in that case.\n     if sess.opts.cg.linker_plugin_lto.enabled()\n         && sess.opts.cg.prefer_dynamic\n-        && sess.target.target.options.is_like_msvc\n+        && sess.target.target.options.is_like_windows\n     {\n         sess.err(\n             \"Linker plugin based LTO is not supported together with \\\n-                  `-C prefer-dynamic` when targeting MSVC\",\n+                  `-C prefer-dynamic` when targeting Windows-like targets\",\n         );\n     }\n "}, {"sha": "4a60059cc5441815bf4b3a03ca80c58cd32a0f39", "filename": "src/test/run-make-fulldeps/mingw-export-call-convention/Makefile", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/584e83dd5ae7a75b8214560c22eafbcfe153caa6/src%2Ftest%2Frun-make-fulldeps%2Fmingw-export-call-convention%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/584e83dd5ae7a75b8214560c22eafbcfe153caa6/src%2Ftest%2Frun-make-fulldeps%2Fmingw-export-call-convention%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fmingw-export-call-convention%2FMakefile?ref=584e83dd5ae7a75b8214560c22eafbcfe153caa6", "patch": "@@ -0,0 +1,9 @@\n+include ../tools.mk\n+\n+# only-windows-gnu\n+\n+all:\n+\t$(RUSTC) foo.rs\n+\t# FIXME: we should make sure __stdcall calling convention is used here\n+\t# but that only works with LLD right now\n+\tnm -g \"$(call IMPLIB,foo)\" | $(CGREP) bar"}, {"sha": "1fec00311ef06b526d4dfa9ef067fe419bc42898", "filename": "src/test/run-make-fulldeps/mingw-export-call-convention/foo.rs", "status": "added", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/584e83dd5ae7a75b8214560c22eafbcfe153caa6/src%2Ftest%2Frun-make-fulldeps%2Fmingw-export-call-convention%2Ffoo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/584e83dd5ae7a75b8214560c22eafbcfe153caa6/src%2Ftest%2Frun-make-fulldeps%2Fmingw-export-call-convention%2Ffoo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fmingw-export-call-convention%2Ffoo.rs?ref=584e83dd5ae7a75b8214560c22eafbcfe153caa6", "patch": "@@ -0,0 +1,4 @@\n+#![crate_type = \"cdylib\"]\n+\n+#[no_mangle]\n+pub extern \"system\" fn bar() {}"}, {"sha": "f9b6d3422959301014e6288243b71f64249aa3c2", "filename": "src/test/run-make-fulldeps/tools.mk", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/584e83dd5ae7a75b8214560c22eafbcfe153caa6/src%2Ftest%2Frun-make-fulldeps%2Ftools.mk", "raw_url": "https://github.com/rust-lang/rust/raw/584e83dd5ae7a75b8214560c22eafbcfe153caa6/src%2Ftest%2Frun-make-fulldeps%2Ftools.mk", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Ftools.mk?ref=584e83dd5ae7a75b8214560c22eafbcfe153caa6", "patch": "@@ -51,6 +51,7 @@ ifdef IS_MSVC\n STATICLIB = $(TMPDIR)/$(1).lib\n STATICLIB_GLOB = $(1)*.lib\n else\n+IMPLIB = $(TMPDIR)/lib$(1).dll.a\n STATICLIB = $(TMPDIR)/lib$(1).a\n STATICLIB_GLOB = lib$(1)*.a\n endif"}]}