{"sha": "4a4f0923aba9a30c470b3a3d958d546bbc793ed5", "node_id": "C_kwDOAAsO6NoAKDRhNGYwOTIzYWJhOWEzMGM0NzBiM2EzZDk1OGQ1NDZiYmM3OTNlZDU", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-12-09T17:40:32Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-12-09T17:40:32Z"}, "message": "Auto merge of #8096 - xFrednet:0000-remove-lintcheck-log-file, r=matthiaskrgr\n\nRemove lintcheck log and add `--filter` option to lintcheck\n\nThis PR removes the really outdated lintcheck log from this repo and adds a new `--filter` option to force warnings of a lint. This also ignores `allow` attributes. I believe that this is a good thing, as we'll see if suppressed false positives are also fixed by the changes.\n\n---\n\n#### Example:\n```sh\n$ cargo lintcheck --filter identity_op\n```\n\n#### Output\n```\nclippy 0.1.59 (460bef22a 2021-12-08)\n\n[..]/cargo-0.49.0/src/cargo/core/compiler/fingerprint.rs:1910:17 clippy::identity_op \"the operation is ineffective. Consider reducing it to `(ret[0] as usize)`\"\n[..]/cargo-0.49.0/src/cargo/util/hex.rs:8:9 clippy::identity_op \"the operation is ineffective. Consider reducing it to `num`\"\n[..]/libc-0.2.81/src/unix/linux_like/linux/mod.rs:2654:18 clippy::identity_op \"the operation is ineffective. Consider reducing it to `(dev & 0x00000000000000ff)`\"\n[..]/libc-0.2.81/src/unix/linux_like/linux/mod.rs:2665:16 clippy::identity_op \"the operation is ineffective. Consider reducing it to `(minor & 0x000000ff)`\"\n[..]/libc-0.2.81/src/unix/linux_like/mod.rs:1218:27 clippy::identity_op \"the operation is ineffective. Consider reducing it to `IPOPT_CONTROL`\"\n[..]/rayon-1.5.0/src/slice/quicksort.rs:588:17 clippy::identity_op \"the operation is ineffective. Consider reducing it to `len / 4`\"\n[..]/regex-1.3.2/src/dfa.rs:1380:14 clippy::identity_op \"the operation is ineffective. Consider reducing it to `(empty_flags.start as u8)`\"\n\nStats:\nclippy::identity_op 7\nICEs:\n```\nTwo of these lints are suppressed when lintcheck runs normally\n\n---\n\nchangelog: none\n\nr? `@matthiaskrgr` Feel free to reassign if you think that someone else would be a better reviewer :upside_down_face:", "tree": {"sha": "7b2045c555d2238bd9e051ba943100a3736e72e6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7b2045c555d2238bd9e051ba943100a3736e72e6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4a4f0923aba9a30c470b3a3d958d546bbc793ed5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4a4f0923aba9a30c470b3a3d958d546bbc793ed5", "html_url": "https://github.com/rust-lang/rust/commit/4a4f0923aba9a30c470b3a3d958d546bbc793ed5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4a4f0923aba9a30c470b3a3d958d546bbc793ed5/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5abecad00924f996c5a81ea0bc040609ac4b76c6", "url": "https://api.github.com/repos/rust-lang/rust/commits/5abecad00924f996c5a81ea0bc040609ac4b76c6", "html_url": "https://github.com/rust-lang/rust/commit/5abecad00924f996c5a81ea0bc040609ac4b76c6"}, {"sha": "e42f79c0a3eb64deb5445968a0bb7106df489ed2", "url": "https://api.github.com/repos/rust-lang/rust/commits/e42f79c0a3eb64deb5445968a0bb7106df489ed2", "html_url": "https://github.com/rust-lang/rust/commit/e42f79c0a3eb64deb5445968a0bb7106df489ed2"}], "stats": {"total": 3942, "additions": 68, "deletions": 3874}, "files": [{"sha": "e82a0ec4765bb25b5a284ffe75bce721e0d5cd1b", "filename": ".gitignore", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/4a4f0923aba9a30c470b3a3d958d546bbc793ed5/.gitignore", "raw_url": "https://github.com/rust-lang/rust/raw/4a4f0923aba9a30c470b3a3d958d546bbc793ed5/.gitignore", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.gitignore?ref=4a4f0923aba9a30c470b3a3d958d546bbc793ed5", "patch": "@@ -27,9 +27,11 @@ out\n # Generated by dogfood\n /target_recur/\n \n+# Generated by lintcheck\n+/lintcheck-logs\n+\n # gh pages docs\n util/gh-pages/lints.json\n-**/metadata_collection.json\n \n # rustfmt backups\n *.rs.bk"}, {"sha": "8f22bd656836c882fddbbdba867b8454f4aa6512", "filename": "lintcheck-logs/lintcheck_crates_logs.txt", "status": "removed", "additions": 0, "deletions": 3862, "changes": 3862, "blob_url": "https://github.com/rust-lang/rust/blob/5abecad00924f996c5a81ea0bc040609ac4b76c6/lintcheck-logs%2Flintcheck_crates_logs.txt", "raw_url": "https://github.com/rust-lang/rust/raw/5abecad00924f996c5a81ea0bc040609ac4b76c6/lintcheck-logs%2Flintcheck_crates_logs.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/lintcheck-logs%2Flintcheck_crates_logs.txt?ref=5abecad00924f996c5a81ea0bc040609ac4b76c6"}, {"sha": "9ece023927bac060041530b2d870d34b59ccad3f", "filename": "lintcheck/src/main.rs", "status": "modified", "additions": 65, "deletions": 11, "changes": 76, "blob_url": "https://github.com/rust-lang/rust/blob/4a4f0923aba9a30c470b3a3d958d546bbc793ed5/lintcheck%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4a4f0923aba9a30c470b3a3d958d546bbc793ed5/lintcheck%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/lintcheck%2Fsrc%2Fmain.rs?ref=4a4f0923aba9a30c470b3a3d958d546bbc793ed5", "patch": "@@ -264,6 +264,7 @@ impl Crate {\n         thread_limit: usize,\n         total_crates_to_lint: usize,\n         fix: bool,\n+        lint_filter: &Vec<String>,\n     ) -> Vec<ClippyWarning> {\n         // advance the atomic index by one\n         let index = target_dir_index.fetch_add(1, Ordering::SeqCst);\n@@ -288,9 +289,9 @@ impl Crate {\n         let shared_target_dir = clippy_project_root().join(\"target/lintcheck/shared_target_dir\");\n \n         let mut args = if fix {\n-            vec![\"--fix\", \"--allow-no-vcs\", \"--\", \"--cap-lints=warn\"]\n+            vec![\"--fix\", \"--allow-no-vcs\", \"--\"]\n         } else {\n-            vec![\"--\", \"--message-format=json\", \"--\", \"--cap-lints=warn\"]\n+            vec![\"--\", \"--message-format=json\", \"--\"]\n         };\n \n         if let Some(options) = &self.options {\n@@ -301,6 +302,13 @@ impl Crate {\n             args.extend(&[\"-Wclippy::pedantic\", \"-Wclippy::cargo\"])\n         }\n \n+        if lint_filter.is_empty() {\n+            args.push(\"--cap-lints=warn\");\n+        } else {\n+            args.push(\"--cap-lints=allow\");\n+            args.extend(lint_filter.iter().map(|filter| filter.as_str()))\n+        }\n+\n         let all_output = std::process::Command::new(&cargo_clippy_path)\n             // use the looping index to create individual target dirs\n             .env(\n@@ -360,14 +368,16 @@ impl Crate {\n \n #[derive(Debug)]\n struct LintcheckConfig {\n-    // max number of jobs to spawn (default 1)\n+    /// max number of jobs to spawn (default 1)\n     max_jobs: usize,\n-    // we read the sources to check from here\n+    /// we read the sources to check from here\n     sources_toml_path: PathBuf,\n-    // we save the clippy lint results here\n+    /// we save the clippy lint results here\n     lintcheck_results_path: PathBuf,\n-    // whether to just run --fix and not collect all the warnings\n+    /// whether to just run --fix and not collect all the warnings\n     fix: bool,\n+    /// A list of lint that this lintcheck run shound focus on\n+    lint_filter: Vec<String>,\n }\n \n impl LintcheckConfig {\n@@ -410,12 +420,26 @@ impl LintcheckConfig {\n             None => 1,\n         };\n         let fix: bool = clap_config.is_present(\"fix\");\n+        let lint_filter: Vec<String> = clap_config\n+            .values_of(\"filter\")\n+            .map(|iter| {\n+                iter.map(|lint_name| {\n+                    let mut filter = lint_name.replace('_', \"-\");\n+                    if !filter.starts_with(\"clippy::\") {\n+                        filter.insert_str(0, \"clippy::\");\n+                    }\n+                    filter\n+                })\n+                .collect()\n+            })\n+            .unwrap_or_default();\n \n         LintcheckConfig {\n             max_jobs,\n             sources_toml_path,\n             lintcheck_results_path,\n             fix,\n+            lint_filter,\n         }\n     }\n }\n@@ -682,6 +706,15 @@ pub fn main() {\n     let old_stats = read_stats_from_file(&config.lintcheck_results_path);\n \n     let counter = AtomicUsize::new(1);\n+    let lint_filter: Vec<String> = config\n+        .lint_filter\n+        .iter()\n+        .map(|filter| {\n+            let mut filter = filter.clone();\n+            filter.insert_str(0, \"--force-warn=\");\n+            filter\n+        })\n+        .collect();\n \n     let clippy_warnings: Vec<ClippyWarning> = if let Some(only_one_crate) = clap_config.value_of(\"only\") {\n         // if we don't have the specified crate in the .toml, throw an error\n@@ -705,7 +738,9 @@ pub fn main() {\n             .into_iter()\n             .map(|krate| krate.download_and_extract())\n             .filter(|krate| krate.name == only_one_crate)\n-            .flat_map(|krate| krate.run_clippy_lints(&cargo_clippy_path, &AtomicUsize::new(0), 1, 1, config.fix))\n+            .flat_map(|krate| {\n+                krate.run_clippy_lints(&cargo_clippy_path, &AtomicUsize::new(0), 1, 1, config.fix, &lint_filter)\n+            })\n             .collect()\n     } else {\n         if config.max_jobs > 1 {\n@@ -729,7 +764,14 @@ pub fn main() {\n                 .into_par_iter()\n                 .map(|krate| krate.download_and_extract())\n                 .flat_map(|krate| {\n-                    krate.run_clippy_lints(&cargo_clippy_path, &counter, num_cpus, num_crates, config.fix)\n+                    krate.run_clippy_lints(\n+                        &cargo_clippy_path,\n+                        &counter,\n+                        num_cpus,\n+                        num_crates,\n+                        config.fix,\n+                        &lint_filter,\n+                    )\n                 })\n                 .collect()\n         } else {\n@@ -738,7 +780,9 @@ pub fn main() {\n             crates\n                 .into_iter()\n                 .map(|krate| krate.download_and_extract())\n-                .flat_map(|krate| krate.run_clippy_lints(&cargo_clippy_path, &counter, 1, num_crates, config.fix))\n+                .flat_map(|krate| {\n+                    krate.run_clippy_lints(&cargo_clippy_path, &counter, 1, num_crates, config.fix, &lint_filter)\n+                })\n                 .collect()\n         }\n     };\n@@ -771,9 +815,10 @@ pub fn main() {\n         .for_each(|(cratename, msg)| text.push_str(&format!(\"{}: '{}'\", cratename, msg)));\n \n     println!(\"Writing logs to {}\", config.lintcheck_results_path.display());\n+    std::fs::create_dir_all(config.lintcheck_results_path.parent().unwrap()).unwrap();\n     write(&config.lintcheck_results_path, text).unwrap();\n \n-    print_stats(old_stats, new_stats);\n+    print_stats(old_stats, new_stats, &config.lint_filter);\n }\n \n /// read the previous stats from the lintcheck-log file\n@@ -806,7 +851,7 @@ fn read_stats_from_file(file_path: &Path) -> HashMap<String, usize> {\n }\n \n /// print how lint counts changed between runs\n-fn print_stats(old_stats: HashMap<String, usize>, new_stats: HashMap<&String, usize>) {\n+fn print_stats(old_stats: HashMap<String, usize>, new_stats: HashMap<&String, usize>, lint_filter: &Vec<String>) {\n     let same_in_both_hashmaps = old_stats\n         .iter()\n         .filter(|(old_key, old_val)| new_stats.get::<&String>(&old_key) == Some(old_val))\n@@ -845,6 +890,7 @@ fn print_stats(old_stats: HashMap<String, usize>, new_stats: HashMap<&String, us\n     old_stats_deduped\n         .iter()\n         .filter(|(old_key, _)| new_stats_deduped.get::<&String>(&old_key).is_none())\n+        .filter(|(old_key, _)| lint_filter.is_empty() || lint_filter.contains(old_key))\n         .for_each(|(old_key, old_value)| {\n             println!(\"{} {} => 0\", old_key, old_value);\n         });\n@@ -903,6 +949,14 @@ fn get_clap_config<'a>() -> ArgMatches<'a> {\n                 .long(\"--fix\")\n                 .help(\"runs cargo clippy --fix and checks if all suggestions apply\"),\n         )\n+        .arg(\n+            Arg::with_name(\"filter\")\n+                .long(\"--filter\")\n+                .takes_value(true)\n+                .multiple(true)\n+                .value_name(\"clippy_lint_name\")\n+                .help(\"apply a filter to only collect specified lints, this also overrides `allow` attributes\"),\n+        )\n         .get_matches()\n }\n "}]}