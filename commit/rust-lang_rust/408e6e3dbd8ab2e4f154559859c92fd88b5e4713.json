{"sha": "408e6e3dbd8ab2e4f154559859c92fd88b5e4713", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQwOGU2ZTNkYmQ4YWIyZTRmMTU0NTU5ODU5YzkyZmQ4OGI1ZTQ3MTM=", "commit": {"author": {"name": "Michael Woerister", "email": "michaelwoerister@posteo", "date": "2020-03-19T16:18:16Z"}, "committer": {"name": "Michael Woerister", "email": "michaelwoerister@posteo", "date": "2020-03-31T14:23:28Z"}, "message": "Add a test case for incremental + codegen-units interaction.", "tree": {"sha": "7965f3b2e5e16db2d953a6cbbf56e4ef7118c5d1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7965f3b2e5e16db2d953a6cbbf56e4ef7118c5d1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/408e6e3dbd8ab2e4f154559859c92fd88b5e4713", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/408e6e3dbd8ab2e4f154559859c92fd88b5e4713", "html_url": "https://github.com/rust-lang/rust/commit/408e6e3dbd8ab2e4f154559859c92fd88b5e4713", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/408e6e3dbd8ab2e4f154559859c92fd88b5e4713/comments", "author": {"login": "michaelwoerister", "id": 1825894, "node_id": "MDQ6VXNlcjE4MjU4OTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1825894?v=4", "gravatar_id": "", "url": "https://api.github.com/users/michaelwoerister", "html_url": "https://github.com/michaelwoerister", "followers_url": "https://api.github.com/users/michaelwoerister/followers", "following_url": "https://api.github.com/users/michaelwoerister/following{/other_user}", "gists_url": "https://api.github.com/users/michaelwoerister/gists{/gist_id}", "starred_url": "https://api.github.com/users/michaelwoerister/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/michaelwoerister/subscriptions", "organizations_url": "https://api.github.com/users/michaelwoerister/orgs", "repos_url": "https://api.github.com/users/michaelwoerister/repos", "events_url": "https://api.github.com/users/michaelwoerister/events{/privacy}", "received_events_url": "https://api.github.com/users/michaelwoerister/received_events", "type": "User", "site_admin": false}, "committer": {"login": "michaelwoerister", "id": 1825894, "node_id": "MDQ6VXNlcjE4MjU4OTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1825894?v=4", "gravatar_id": "", "url": "https://api.github.com/users/michaelwoerister", "html_url": "https://github.com/michaelwoerister", "followers_url": "https://api.github.com/users/michaelwoerister/followers", "following_url": "https://api.github.com/users/michaelwoerister/following{/other_user}", "gists_url": "https://api.github.com/users/michaelwoerister/gists{/gist_id}", "starred_url": "https://api.github.com/users/michaelwoerister/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/michaelwoerister/subscriptions", "organizations_url": "https://api.github.com/users/michaelwoerister/orgs", "repos_url": "https://api.github.com/users/michaelwoerister/repos", "events_url": "https://api.github.com/users/michaelwoerister/events{/privacy}", "received_events_url": "https://api.github.com/users/michaelwoerister/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1e5b4594e1aad47fccd855fa54dd40a84d07dbdf", "url": "https://api.github.com/repos/rust-lang/rust/commits/1e5b4594e1aad47fccd855fa54dd40a84d07dbdf", "html_url": "https://github.com/rust-lang/rust/commit/1e5b4594e1aad47fccd855fa54dd40a84d07dbdf"}], "stats": {"total": 54, "additions": 53, "deletions": 1}, "files": [{"sha": "ca2df19096e4d10f2d04fc7cb1565b8da60e1d8c", "filename": "src/test/codegen-units/partitioning/incremental-merging.rs", "status": "added", "additions": 42, "deletions": 0, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/408e6e3dbd8ab2e4f154559859c92fd88b5e4713/src%2Ftest%2Fcodegen-units%2Fpartitioning%2Fincremental-merging.rs", "raw_url": "https://github.com/rust-lang/rust/raw/408e6e3dbd8ab2e4f154559859c92fd88b5e4713/src%2Ftest%2Fcodegen-units%2Fpartitioning%2Fincremental-merging.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen-units%2Fpartitioning%2Fincremental-merging.rs?ref=408e6e3dbd8ab2e4f154559859c92fd88b5e4713", "patch": "@@ -0,0 +1,42 @@\n+// ignore-tidy-linelength\n+// We specify -C incremental here because we want to test the partitioning for\n+// incremental compilation\n+// compile-flags:-Zprint-mono-items=lazy -Cincremental=tmp/partitioning-tests/incremental-merging\n+// compile-flags:-Ccodegen-units=3\n+\n+#![crate_type = \"rlib\"]\n+\n+// This test makes sure that merging of CGUs works together with incremental\n+// compilation but at the same time does not modify names of CGUs that were not\n+// affected by merging.\n+//\n+// We expect CGUs `aaa` and `bbb` to be merged (because they are the smallest),\n+// while `ccc` and `ddd` are supposed to stay untouched.\n+\n+pub mod aaa {\n+    //~ MONO_ITEM fn incremental_merging::aaa[0]::foo[0] @@ incremental_merging-aaa--incremental_merging-bbb[External]\n+    pub fn foo(a: u64) -> u64 {\n+        a + 1\n+    }\n+}\n+\n+pub mod bbb {\n+    //~ MONO_ITEM fn incremental_merging::bbb[0]::foo[0] @@ incremental_merging-aaa--incremental_merging-bbb[External]\n+    pub fn foo(a: u64, b: u64) -> u64 {\n+        a + b + 1\n+    }\n+}\n+\n+pub mod ccc {\n+    //~ MONO_ITEM fn incremental_merging::ccc[0]::foo[0] @@ incremental_merging-ccc[External]\n+    pub fn foo(a: u64, b: u64, c: u64) -> u64 {\n+        a + b + c + 1\n+    }\n+}\n+\n+pub mod ddd {\n+    //~ MONO_ITEM fn incremental_merging::ddd[0]::foo[0] @@ incremental_merging-ddd[External]\n+    pub fn foo(a: u64, b: u64, c: u64, d: u64) -> u64 {\n+        a + b + c + d + 1\n+    }\n+}"}, {"sha": "295d96ce419760bf5a0d7b2eb281329a6a0a3dd9", "filename": "src/tools/compiletest/src/runtest.rs", "status": "modified", "additions": 11, "deletions": 1, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/408e6e3dbd8ab2e4f154559859c92fd88b5e4713/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/408e6e3dbd8ab2e4f154559859c92fd88b5e4713/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs?ref=408e6e3dbd8ab2e4f154559859c92fd88b5e4713", "patch": "@@ -2517,7 +2517,7 @@ impl<'test> TestCx<'test> {\n                     .filter(|s| !s.is_empty())\n                     .map(|s| {\n                         if cgu_has_crate_disambiguator {\n-                            remove_crate_disambiguator_from_cgu(s)\n+                            remove_crate_disambiguators_from_set_of_cgu_names(s)\n                         } else {\n                             s.to_string()\n                         }\n@@ -2567,6 +2567,16 @@ impl<'test> TestCx<'test> {\n \n             new_name\n         }\n+\n+        // The name of merged CGUs is constructed as the names of the original\n+        // CGUs joined with \"--\". This function splits such composite CGU names\n+        // and handles each component individually.\n+        fn remove_crate_disambiguators_from_set_of_cgu_names(cgus: &str) -> String {\n+            cgus.split(\"--\")\n+                .map(|cgu| remove_crate_disambiguator_from_cgu(cgu))\n+                .collect::<Vec<_>>()\n+                .join(\"--\")\n+        }\n     }\n \n     fn init_incremental_test(&self) {"}]}