{"sha": "0e0c8aef87fe78c797a455d34e7490254f3d22b2", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBlMGM4YWVmODdmZTc4Yzc5N2E0NTVkMzRlNzQ5MDI1NGYzZDIyYjI=", "commit": {"author": {"name": "Tavian Barnes", "email": "tavianator@tavianator.com", "date": "2021-08-31T18:11:42Z"}, "committer": {"name": "Tavian Barnes", "email": "tavianator@tavianator.com", "date": "2021-08-31T18:11:42Z"}, "message": "Use the return value of readdir_r() instead of errno\n\nPOSIX says:\n\n> If successful, the readdir_r() function shall return zero; otherwise,\n> an error number shall be returned to indicate the error.\n\nBut we were previously using errno instead of the return value.  This\nled to issue #86649.", "tree": {"sha": "b07f8bcfb4682e70ed99c268542897b1e884ee6a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b07f8bcfb4682e70ed99c268542897b1e884ee6a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0e0c8aef87fe78c797a455d34e7490254f3d22b2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0e0c8aef87fe78c797a455d34e7490254f3d22b2", "html_url": "https://github.com/rust-lang/rust/commit/0e0c8aef87fe78c797a455d34e7490254f3d22b2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0e0c8aef87fe78c797a455d34e7490254f3d22b2/comments", "author": {"login": "tavianator", "id": 1692591, "node_id": "MDQ6VXNlcjE2OTI1OTE=", "avatar_url": "https://avatars.githubusercontent.com/u/1692591?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tavianator", "html_url": "https://github.com/tavianator", "followers_url": "https://api.github.com/users/tavianator/followers", "following_url": "https://api.github.com/users/tavianator/following{/other_user}", "gists_url": "https://api.github.com/users/tavianator/gists{/gist_id}", "starred_url": "https://api.github.com/users/tavianator/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tavianator/subscriptions", "organizations_url": "https://api.github.com/users/tavianator/orgs", "repos_url": "https://api.github.com/users/tavianator/repos", "events_url": "https://api.github.com/users/tavianator/events{/privacy}", "received_events_url": "https://api.github.com/users/tavianator/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tavianator", "id": 1692591, "node_id": "MDQ6VXNlcjE2OTI1OTE=", "avatar_url": "https://avatars.githubusercontent.com/u/1692591?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tavianator", "html_url": "https://github.com/tavianator", "followers_url": "https://api.github.com/users/tavianator/followers", "following_url": "https://api.github.com/users/tavianator/following{/other_user}", "gists_url": "https://api.github.com/users/tavianator/gists{/gist_id}", "starred_url": "https://api.github.com/users/tavianator/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tavianator/subscriptions", "organizations_url": "https://api.github.com/users/tavianator/orgs", "repos_url": "https://api.github.com/users/tavianator/repos", "events_url": "https://api.github.com/users/tavianator/events{/privacy}", "received_events_url": "https://api.github.com/users/tavianator/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "76d18cfb8945f824c8777e04981e930d2037954e", "url": "https://api.github.com/repos/rust-lang/rust/commits/76d18cfb8945f824c8777e04981e930d2037954e", "html_url": "https://github.com/rust-lang/rust/commit/76d18cfb8945f824c8777e04981e930d2037954e"}], "stats": {"total": 5, "additions": 3, "deletions": 2}, "files": [{"sha": "6d7524a733afd85cac14a01793ee06047328f5fc", "filename": "library/std/src/sys/unix/fs.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/0e0c8aef87fe78c797a455d34e7490254f3d22b2/library%2Fstd%2Fsrc%2Fsys%2Funix%2Ffs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0e0c8aef87fe78c797a455d34e7490254f3d22b2/library%2Fstd%2Fsrc%2Fsys%2Funix%2Ffs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Funix%2Ffs.rs?ref=0e0c8aef87fe78c797a455d34e7490254f3d22b2", "patch": "@@ -506,15 +506,16 @@ impl Iterator for ReadDir {\n             let mut ret = DirEntry { entry: mem::zeroed(), dir: Arc::clone(&self.inner) };\n             let mut entry_ptr = ptr::null_mut();\n             loop {\n-                if readdir64_r(self.inner.dirp.0, &mut ret.entry, &mut entry_ptr) != 0 {\n+                let err = readdir64_r(self.inner.dirp.0, &mut ret.entry, &mut entry_ptr);\n+                if err != 0 {\n                     if entry_ptr.is_null() {\n                         // We encountered an error (which will be returned in this iteration), but\n                         // we also reached the end of the directory stream. The `end_of_stream`\n                         // flag is enabled to make sure that we return `None` in the next iteration\n                         // (instead of looping forever)\n                         self.end_of_stream = true;\n                     }\n-                    return Some(Err(Error::last_os_error()));\n+                    return Some(Err(Error::from_raw_os_error(err)));\n                 }\n                 if entry_ptr.is_null() {\n                     return None;"}]}