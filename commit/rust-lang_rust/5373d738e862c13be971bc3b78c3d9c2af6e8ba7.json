{"sha": "5373d738e862c13be971bc3b78c3d9c2af6e8ba7", "node_id": "C_kwDOAAsO6NoAKDUzNzNkNzM4ZTg2MmMxM2JlOTcxYmMzYjc4YzNkOWMyYWY2ZThiYTc", "commit": {"author": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-06-20T03:13:08Z"}, "committer": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-06-20T03:18:08Z"}, "message": "Mention formatting macros when encountering ArgumentV1::new in const", "tree": {"sha": "433655f7e293e88faad8f24b25e0d18c7693b498", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/433655f7e293e88faad8f24b25e0d18c7693b498"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5373d738e862c13be971bc3b78c3d9c2af6e8ba7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5373d738e862c13be971bc3b78c3d9c2af6e8ba7", "html_url": "https://github.com/rust-lang/rust/commit/5373d738e862c13be971bc3b78c3d9c2af6e8ba7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5373d738e862c13be971bc3b78c3d9c2af6e8ba7/comments", "author": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "611e7b9cea2b982b63de7f6697b2a9079b0bf188", "url": "https://api.github.com/repos/rust-lang/rust/commits/611e7b9cea2b982b63de7f6697b2a9079b0bf188", "html_url": "https://github.com/rust-lang/rust/commit/611e7b9cea2b982b63de7f6697b2a9079b0bf188"}], "stats": {"total": 113, "additions": 112, "deletions": 1}, "files": [{"sha": "0c587220cb77292bb2201584676a64a858bd1949", "filename": "compiler/rustc_const_eval/src/transform/check_consts/ops.rs", "status": "modified", "additions": 11, "deletions": 1, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/5373d738e862c13be971bc3b78c3d9c2af6e8ba7/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fops.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5373d738e862c13be971bc3b78c3d9c2af6e8ba7/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fops.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fops.rs?ref=5373d738e862c13be971bc3b78c3d9c2af6e8ba7", "patch": "@@ -10,7 +10,8 @@ use rustc_middle::mir;\n use rustc_middle::ty::print::with_no_trimmed_paths;\n use rustc_middle::ty::subst::{GenericArgKind, SubstsRef};\n use rustc_middle::ty::{\n-    suggest_constraining_type_param, Adt, Closure, FnDef, FnPtr, Param, TraitPredicate, Ty,\n+    suggest_constraining_type_param, Adt, Closure, DefIdTree, FnDef, FnPtr, Param, TraitPredicate,\n+    Ty,\n };\n use rustc_middle::ty::{Binder, BoundConstness, ImplPolarity, TraitRef};\n use rustc_session::parse::feature_err;\n@@ -300,6 +301,15 @@ impl<'tcx> NonConstOp<'tcx> for FnCallNonConst<'tcx> {\n                 diag_trait(&mut err, self_ty, tcx.lang_items().deref_trait().unwrap());\n                 err\n             }\n+            _ if tcx.opt_parent(callee) == tcx.get_diagnostic_item(sym::ArgumentV1Methods) => {\n+                struct_span_err!(\n+                    ccx.tcx.sess,\n+                    span,\n+                    E0015,\n+                    \"cannot call non-const formatting macro in {}s\",\n+                    ccx.const_kind(),\n+                )\n+            }\n             _ => struct_span_err!(\n                 ccx.tcx.sess,\n                 span,"}, {"sha": "631f3bb76bc06fa92a76220dd9e44b03e2e2571e", "filename": "compiler/rustc_span/src/symbol.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/5373d738e862c13be971bc3b78c3d9c2af6e8ba7/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5373d738e862c13be971bc3b78c3d9c2af6e8ba7/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs?ref=5373d738e862c13be971bc3b78c3d9c2af6e8ba7", "patch": "@@ -131,6 +131,7 @@ symbols! {\n         Arc,\n         Argument,\n         ArgumentV1,\n+        ArgumentV1Methods,\n         Arguments,\n         AsMut,\n         AsRef,"}, {"sha": "9e4a574818a14d704792e7323aed622519356216", "filename": "library/core/src/fmt/mod.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/5373d738e862c13be971bc3b78c3d9c2af6e8ba7/library%2Fcore%2Fsrc%2Ffmt%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5373d738e862c13be971bc3b78c3d9c2af6e8ba7/library%2Fcore%2Fsrc%2Ffmt%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Ffmt%2Fmod.rs?ref=5373d738e862c13be971bc3b78c3d9c2af6e8ba7", "patch": "@@ -320,6 +320,7 @@ macro_rules! arg_new {\n     };\n }\n \n+#[rustc_diagnostic_item = \"ArgumentV1Methods\"]\n impl<'a> ArgumentV1<'a> {\n     #[doc(hidden)]\n     #[unstable(feature = \"fmt_internals\", reason = \"internal to format_args!\", issue = \"none\")]"}, {"sha": "e43633da3ccb91dc592ddbee0140af3d878c42fe", "filename": "src/test/ui/consts/const-eval/format.rs", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/5373d738e862c13be971bc3b78c3d9c2af6e8ba7/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fformat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5373d738e862c13be971bc3b78c3d9c2af6e8ba7/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fformat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fformat.rs?ref=5373d738e862c13be971bc3b78c3d9c2af6e8ba7", "patch": "@@ -0,0 +1,21 @@\n+const fn failure() {\n+    panic!(\"{:?}\", 0);\n+    //~^ ERROR cannot call non-const formatting macro in constant functions\n+    //~| ERROR erroneous constant used\n+    //~| ERROR erroneous constant used\n+    //~| WARN this was previously accepted by the compiler\n+    //~| WARN this was previously accepted by the compiler\n+}\n+\n+const fn print() {\n+    println!(\"{:?}\", 0);\n+    //~^ ERROR cannot call non-const formatting macro in constant functions\n+    //~| ERROR `Arguments::<'a>::new_v1` is not yet stable as a const fn\n+    //~| ERROR cannot call non-const fn `_print` in constant functions\n+    //~| ERROR erroneous constant used\n+    //~| ERROR erroneous constant used\n+    //~| WARN this was previously accepted by the compiler\n+    //~| WARN this was previously accepted by the compiler\n+}\n+\n+fn main() {}"}, {"sha": "44f436ae4e3a9ac0c474c6bc208ccef4e943c14d", "filename": "src/test/ui/consts/const-eval/format.stderr", "status": "added", "additions": 78, "deletions": 0, "changes": 78, "blob_url": "https://github.com/rust-lang/rust/blob/5373d738e862c13be971bc3b78c3d9c2af6e8ba7/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fformat.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/5373d738e862c13be971bc3b78c3d9c2af6e8ba7/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fformat.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fformat.stderr?ref=5373d738e862c13be971bc3b78c3d9c2af6e8ba7", "patch": "@@ -0,0 +1,78 @@\n+error[E0015]: cannot call non-const formatting macro in constant functions\n+  --> $DIR/format.rs:2:20\n+   |\n+LL |     panic!(\"{:?}\", 0);\n+   |                    ^\n+   |\n+   = note: calls in constant functions are limited to constant functions, tuple structs and tuple variants\n+   = note: this error originates in the macro `$crate::const_format_args` (in Nightly builds, run with -Z macro-backtrace for more info)\n+\n+error[E0015]: cannot call non-const formatting macro in constant functions\n+  --> $DIR/format.rs:11:22\n+   |\n+LL |     println!(\"{:?}\", 0);\n+   |                      ^\n+   |\n+   = note: calls in constant functions are limited to constant functions, tuple structs and tuple variants\n+   = note: this error originates in the macro `$crate::format_args_nl` (in Nightly builds, run with -Z macro-backtrace for more info)\n+\n+error: `Arguments::<'a>::new_v1` is not yet stable as a const fn\n+  --> $DIR/format.rs:11:5\n+   |\n+LL |     println!(\"{:?}\", 0);\n+   |     ^^^^^^^^^^^^^^^^^^^\n+   |\n+   = help: add `#![feature(const_fmt_arguments_new)]` to the crate attributes to enable\n+   = note: this error originates in the macro `$crate::format_args_nl` (in Nightly builds, run with -Z macro-backtrace for more info)\n+\n+error[E0015]: cannot call non-const fn `_print` in constant functions\n+  --> $DIR/format.rs:11:5\n+   |\n+LL |     println!(\"{:?}\", 0);\n+   |     ^^^^^^^^^^^^^^^^^^^\n+   |\n+   = note: calls in constant functions are limited to constant functions, tuple structs and tuple variants\n+   = note: this error originates in the macro `println` (in Nightly builds, run with -Z macro-backtrace for more info)\n+\n+error: erroneous constant used\n+  --> $DIR/format.rs:2:12\n+   |\n+LL |     panic!(\"{:?}\", 0);\n+   |            ^^^^^^ referenced constant has errors\n+   |\n+   = note: `#[deny(const_err)]` on by default\n+   = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n+   = note: for more information, see issue #71800 <https://github.com/rust-lang/rust/issues/71800>\n+\n+error: erroneous constant used\n+  --> $DIR/format.rs:2:20\n+   |\n+LL |     panic!(\"{:?}\", 0);\n+   |                    ^ referenced constant has errors\n+   |\n+   = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n+   = note: for more information, see issue #71800 <https://github.com/rust-lang/rust/issues/71800>\n+   = note: this error originates in the macro `$crate::const_format_args` (in Nightly builds, run with -Z macro-backtrace for more info)\n+\n+error: erroneous constant used\n+  --> $DIR/format.rs:11:14\n+   |\n+LL |     println!(\"{:?}\", 0);\n+   |              ^^^^^^ referenced constant has errors\n+   |\n+   = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n+   = note: for more information, see issue #71800 <https://github.com/rust-lang/rust/issues/71800>\n+\n+error: erroneous constant used\n+  --> $DIR/format.rs:11:22\n+   |\n+LL |     println!(\"{:?}\", 0);\n+   |                      ^ referenced constant has errors\n+   |\n+   = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n+   = note: for more information, see issue #71800 <https://github.com/rust-lang/rust/issues/71800>\n+   = note: this error originates in the macro `$crate::format_args_nl` (in Nightly builds, run with -Z macro-backtrace for more info)\n+\n+error: aborting due to 8 previous errors\n+\n+For more information about this error, try `rustc --explain E0015`."}]}