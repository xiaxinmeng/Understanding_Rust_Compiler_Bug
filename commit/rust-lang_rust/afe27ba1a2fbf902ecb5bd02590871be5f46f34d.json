{"sha": "afe27ba1a2fbf902ecb5bd02590871be5f46f34d", "node_id": "C_kwDOAAsO6NoAKGFmZTI3YmExYTJmYmY5MDJlY2I1YmQwMjU5MDg3MWJlNWY0NmYzNGQ", "commit": {"author": {"name": "Samuel Tardieu", "email": "sam@rfc1149.net", "date": "2023-03-05T11:38:23Z"}, "committer": {"name": "Samuel Tardieu", "email": "sam@rfc1149.net", "date": "2023-03-16T17:59:14Z"}, "message": "Issue function modifiers in the right order in manual_async_fn lint", "tree": {"sha": "f239b2bd4f844761aa2bdb8d8057697b786234ca", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f239b2bd4f844761aa2bdb8d8057697b786234ca"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/afe27ba1a2fbf902ecb5bd02590871be5f46f34d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/afe27ba1a2fbf902ecb5bd02590871be5f46f34d", "html_url": "https://github.com/rust-lang/rust/commit/afe27ba1a2fbf902ecb5bd02590871be5f46f34d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/afe27ba1a2fbf902ecb5bd02590871be5f46f34d/comments", "author": {"login": "samueltardieu", "id": 44656, "node_id": "MDQ6VXNlcjQ0NjU2", "avatar_url": "https://avatars.githubusercontent.com/u/44656?v=4", "gravatar_id": "", "url": "https://api.github.com/users/samueltardieu", "html_url": "https://github.com/samueltardieu", "followers_url": "https://api.github.com/users/samueltardieu/followers", "following_url": "https://api.github.com/users/samueltardieu/following{/other_user}", "gists_url": "https://api.github.com/users/samueltardieu/gists{/gist_id}", "starred_url": "https://api.github.com/users/samueltardieu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/samueltardieu/subscriptions", "organizations_url": "https://api.github.com/users/samueltardieu/orgs", "repos_url": "https://api.github.com/users/samueltardieu/repos", "events_url": "https://api.github.com/users/samueltardieu/events{/privacy}", "received_events_url": "https://api.github.com/users/samueltardieu/received_events", "type": "User", "site_admin": false}, "committer": {"login": "samueltardieu", "id": 44656, "node_id": "MDQ6VXNlcjQ0NjU2", "avatar_url": "https://avatars.githubusercontent.com/u/44656?v=4", "gravatar_id": "", "url": "https://api.github.com/users/samueltardieu", "html_url": "https://github.com/samueltardieu", "followers_url": "https://api.github.com/users/samueltardieu/followers", "following_url": "https://api.github.com/users/samueltardieu/following{/other_user}", "gists_url": "https://api.github.com/users/samueltardieu/gists{/gist_id}", "starred_url": "https://api.github.com/users/samueltardieu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/samueltardieu/subscriptions", "organizations_url": "https://api.github.com/users/samueltardieu/orgs", "repos_url": "https://api.github.com/users/samueltardieu/repos", "events_url": "https://api.github.com/users/samueltardieu/events{/privacy}", "received_events_url": "https://api.github.com/users/samueltardieu/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "70e85d146fee03c09e28a02c9c18d56e74254f3c", "url": "https://api.github.com/repos/rust-lang/rust/commits/70e85d146fee03c09e28a02c9c18d56e74254f3c", "html_url": "https://github.com/rust-lang/rust/commit/70e85d146fee03c09e28a02c9c18d56e74254f3c"}], "stats": {"total": 79, "additions": 75, "deletions": 4}, "files": [{"sha": "af52090d8a47660c9e1b0819bc63861b30d9ac5e", "filename": "clippy_lints/src/manual_async_fn.rs", "status": "modified", "additions": 11, "deletions": 3, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/afe27ba1a2fbf902ecb5bd02590871be5f46f34d/clippy_lints%2Fsrc%2Fmanual_async_fn.rs", "raw_url": "https://github.com/rust-lang/rust/raw/afe27ba1a2fbf902ecb5bd02590871be5f46f34d/clippy_lints%2Fsrc%2Fmanual_async_fn.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmanual_async_fn.rs?ref=afe27ba1a2fbf902ecb5bd02590871be5f46f34d", "patch": "@@ -6,7 +6,7 @@ use rustc_errors::Applicability;\n use rustc_hir::intravisit::FnKind;\n use rustc_hir::{\n     AsyncGeneratorKind, Block, Body, Closure, Expr, ExprKind, FnDecl, FnRetTy, GeneratorKind, GenericArg, GenericBound,\n-    ItemKind, LifetimeName, Term, TraitRef, Ty, TyKind, TypeBindingKind,\n+    ImplItem, Item, ItemKind, LifetimeName, Node, Term, TraitRef, Ty, TyKind, TypeBindingKind,\n };\n use rustc_lint::{LateContext, LateLintPass};\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n@@ -46,7 +46,7 @@ impl<'tcx> LateLintPass<'tcx> for ManualAsyncFn {\n         decl: &'tcx FnDecl<'_>,\n         body: &'tcx Body<'_>,\n         span: Span,\n-        _: LocalDefId,\n+        def_id: LocalDefId,\n     ) {\n         if_chain! {\n             if let Some(header) = kind.header();\n@@ -60,6 +60,8 @@ impl<'tcx> LateLintPass<'tcx> for ManualAsyncFn {\n             if let ExprKind::Block(block, _) = body.value.kind;\n             if block.stmts.is_empty();\n             if let Some(closure_body) = desugared_async_block(cx, block);\n+            if let Node::Item(Item {vis_span, ..}) | Node::ImplItem(ImplItem {vis_span, ..}) =\n+                cx.tcx.hir().get_by_def_id(def_id);\n             then {\n                 let header_span = span.with_hi(ret_ty.span.hi());\n \n@@ -70,15 +72,21 @@ impl<'tcx> LateLintPass<'tcx> for ManualAsyncFn {\n                     \"this function can be simplified using the `async fn` syntax\",\n                     |diag| {\n                         if_chain! {\n+                            if let Some(vis_snip) = snippet_opt(cx, *vis_span);\n                             if let Some(header_snip) = snippet_opt(cx, header_span);\n                             if let Some(ret_pos) = position_before_rarrow(&header_snip);\n                             if let Some((ret_sugg, ret_snip)) = suggested_ret(cx, output);\n                             then {\n+                                let header_snip = if !vis_snip.is_empty() {\n+                                    format!(\"{} async {}\", vis_snip, &header_snip[vis_snip.len() + 1..ret_pos])\n+                                } else {\n+                                    format!(\"async {}\", &header_snip[..ret_pos])\n+                                };\n                                 let help = format!(\"make the function `async` and {ret_sugg}\");\n                                 diag.span_suggestion(\n                                     header_span,\n                                     help,\n-                                    format!(\"async {}{ret_snip}\", &header_snip[..ret_pos]),\n+                                    format!(\"{header_snip}{ret_snip}\"),\n                                     Applicability::MachineApplicable\n                                 );\n "}, {"sha": "5cc4a43af7e36ef6996a45a9d3a0510b29457b0d", "filename": "tests/ui/manual_async_fn.fixed", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/afe27ba1a2fbf902ecb5bd02590871be5f46f34d/tests%2Fui%2Fmanual_async_fn.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/afe27ba1a2fbf902ecb5bd02590871be5f46f34d/tests%2Fui%2Fmanual_async_fn.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmanual_async_fn.fixed?ref=afe27ba1a2fbf902ecb5bd02590871be5f46f34d", "patch": "@@ -107,4 +107,10 @@ mod issue_5765 {\n     }\n }\n \n+pub async fn issue_10450() -> i32 { 42 }\n+\n+pub(crate) async fn issue_10450_2() -> i32 { 42 }\n+\n+pub(self) async fn issue_10450_3() -> i32 { 42 }\n+\n fn main() {}"}, {"sha": "ba504b8a8231f1147de9eb6966e0974c375dd0d0", "filename": "tests/ui/manual_async_fn.rs", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/afe27ba1a2fbf902ecb5bd02590871be5f46f34d/tests%2Fui%2Fmanual_async_fn.rs", "raw_url": "https://github.com/rust-lang/rust/raw/afe27ba1a2fbf902ecb5bd02590871be5f46f34d/tests%2Fui%2Fmanual_async_fn.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmanual_async_fn.rs?ref=afe27ba1a2fbf902ecb5bd02590871be5f46f34d", "patch": "@@ -127,4 +127,16 @@ mod issue_5765 {\n     }\n }\n \n+pub fn issue_10450() -> impl Future<Output = i32> {\n+    async { 42 }\n+}\n+\n+pub(crate) fn issue_10450_2() -> impl Future<Output = i32> {\n+    async { 42 }\n+}\n+\n+pub(self) fn issue_10450_3() -> impl Future<Output = i32> {\n+    async { 42 }\n+}\n+\n fn main() {}"}, {"sha": "f5ee3eb7cccbaae20e84b4542989dd1550fd61aa", "filename": "tests/ui/manual_async_fn.stderr", "status": "modified", "additions": 46, "deletions": 1, "changes": 47, "blob_url": "https://github.com/rust-lang/rust/blob/afe27ba1a2fbf902ecb5bd02590871be5f46f34d/tests%2Fui%2Fmanual_async_fn.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/afe27ba1a2fbf902ecb5bd02590871be5f46f34d/tests%2Fui%2Fmanual_async_fn.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmanual_async_fn.stderr?ref=afe27ba1a2fbf902ecb5bd02590871be5f46f34d", "patch": "@@ -161,5 +161,50 @@ help: move the body of the async block to the enclosing function\n LL | fn explicit<'a, 'b>(_: &'a i32, _: &'b i32) -> impl Future<Output = i32> + 'a + 'b { 42 }\n    |                                                                                    ~~~~~~\n \n-error: aborting due to 10 previous errors\n+error: this function can be simplified using the `async fn` syntax\n+  --> $DIR/manual_async_fn.rs:130:1\n+   |\n+LL | pub fn issue_10450() -> impl Future<Output = i32> {\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+help: make the function `async` and return the output of the future directly\n+   |\n+LL | pub async fn issue_10450() -> i32 {\n+   | ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+help: move the body of the async block to the enclosing function\n+   |\n+LL | pub fn issue_10450() -> impl Future<Output = i32> { 42 }\n+   |                                                   ~~~~~~\n+\n+error: this function can be simplified using the `async fn` syntax\n+  --> $DIR/manual_async_fn.rs:134:1\n+   |\n+LL | pub(crate) fn issue_10450_2() -> impl Future<Output = i32> {\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+help: make the function `async` and return the output of the future directly\n+   |\n+LL | pub(crate) async fn issue_10450_2() -> i32 {\n+   | ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+help: move the body of the async block to the enclosing function\n+   |\n+LL | pub(crate) fn issue_10450_2() -> impl Future<Output = i32> { 42 }\n+   |                                                            ~~~~~~\n+\n+error: this function can be simplified using the `async fn` syntax\n+  --> $DIR/manual_async_fn.rs:138:1\n+   |\n+LL | pub(self) fn issue_10450_3() -> impl Future<Output = i32> {\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+help: make the function `async` and return the output of the future directly\n+   |\n+LL | pub(self) async fn issue_10450_3() -> i32 {\n+   | ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n+help: move the body of the async block to the enclosing function\n+   |\n+LL | pub(self) fn issue_10450_3() -> impl Future<Output = i32> { 42 }\n+   |                                                           ~~~~~~\n+\n+error: aborting due to 13 previous errors\n "}]}