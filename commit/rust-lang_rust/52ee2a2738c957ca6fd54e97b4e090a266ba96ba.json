{"sha": "52ee2a2738c957ca6fd54e97b4e090a266ba96ba", "node_id": "C_kwDOAAsO6NoAKDUyZWUyYTI3MzhjOTU3Y2E2ZmQ1NGU5N2I0ZTA5MGEyNjZiYTk2YmE", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-06-10T03:55:16Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-06-10T03:55:16Z"}, "message": "Auto merge of #95770 - nrc:read-buf-builder, r=joshtriplett\n\nstd::io: Modify some ReadBuf method signatures to return `&mut Self`\n\nThis allows using `ReadBuf` in a builder-like style and to setup a `ReadBuf` and\npass it to `read_buf` in a single expression, e.g.,\n\n```\n// With this PR:\nreader.read_buf(ReadBuf::uninit(buf).assume_init(init_len))?;\n\n// Previously:\nlet mut buf = ReadBuf::uninit(buf);\nbuf.assume_init(init_len);\nreader.read_buf(&mut buf)?;\n```\n\nr? `@sfackler`\n\ncc https://github.com/rust-lang/rust/issues/78485, https://github.com/rust-lang/rust/issues/94741", "tree": {"sha": "f7bcbf573947f0550f1d0004512fcc151bdf0c64", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f7bcbf573947f0550f1d0004512fcc151bdf0c64"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/52ee2a2738c957ca6fd54e97b4e090a266ba96ba", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/52ee2a2738c957ca6fd54e97b4e090a266ba96ba", "html_url": "https://github.com/rust-lang/rust/commit/52ee2a2738c957ca6fd54e97b4e090a266ba96ba", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/52ee2a2738c957ca6fd54e97b4e090a266ba96ba/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e9aff9c42cb94974dc80e3c5ae3d2727eaae9682", "url": "https://api.github.com/repos/rust-lang/rust/commits/e9aff9c42cb94974dc80e3c5ae3d2727eaae9682", "html_url": "https://github.com/rust-lang/rust/commit/e9aff9c42cb94974dc80e3c5ae3d2727eaae9682"}, {"sha": "a3c30e440a7a2cb36b6d8d405fdf7d5d50110903", "url": "https://api.github.com/repos/rust-lang/rust/commits/a3c30e440a7a2cb36b6d8d405fdf7d5d50110903", "html_url": "https://github.com/rust-lang/rust/commit/a3c30e440a7a2cb36b6d8d405fdf7d5d50110903"}], "stats": {"total": 18, "additions": 11, "deletions": 7}, "files": [{"sha": "78d1113f8375a2593ee06ca8c795fcd4034dc1d8", "filename": "library/std/src/io/readbuf.rs", "status": "modified", "additions": 11, "deletions": 7, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/52ee2a2738c957ca6fd54e97b4e090a266ba96ba/library%2Fstd%2Fsrc%2Fio%2Freadbuf.rs", "raw_url": "https://github.com/rust-lang/rust/raw/52ee2a2738c957ca6fd54e97b4e090a266ba96ba/library%2Fstd%2Fsrc%2Fio%2Freadbuf.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fio%2Freadbuf.rs?ref=52ee2a2738c957ca6fd54e97b4e090a266ba96ba", "patch": "@@ -166,8 +166,8 @@ impl<'a> ReadBuf<'a> {\n     ///\n     /// The number of initialized bytes is not changed, and the contents of the buffer are not modified.\n     #[inline]\n-    pub fn clear(&mut self) {\n-        self.set_filled(0); // The assertion in `set_filled` is optimized out\n+    pub fn clear(&mut self) -> &mut Self {\n+        self.set_filled(0) // The assertion in `set_filled` is optimized out\n     }\n \n     /// Increases the size of the filled region of the buffer.\n@@ -178,8 +178,8 @@ impl<'a> ReadBuf<'a> {\n     ///\n     /// Panics if the filled region of the buffer would become larger than the initialized region.\n     #[inline]\n-    pub fn add_filled(&mut self, n: usize) {\n-        self.set_filled(self.filled + n);\n+    pub fn add_filled(&mut self, n: usize) -> &mut Self {\n+        self.set_filled(self.filled + n)\n     }\n \n     /// Sets the size of the filled region of the buffer.\n@@ -193,10 +193,11 @@ impl<'a> ReadBuf<'a> {\n     ///\n     /// Panics if the filled region of the buffer would become larger than the initialized region.\n     #[inline]\n-    pub fn set_filled(&mut self, n: usize) {\n+    pub fn set_filled(&mut self, n: usize) -> &mut Self {\n         assert!(n <= self.initialized);\n \n         self.filled = n;\n+        self\n     }\n \n     /// Asserts that the first `n` unfilled bytes of the buffer are initialized.\n@@ -208,8 +209,9 @@ impl<'a> ReadBuf<'a> {\n     ///\n     /// The caller must ensure that the first `n` unfilled bytes of the buffer have already been initialized.\n     #[inline]\n-    pub unsafe fn assume_init(&mut self, n: usize) {\n+    pub unsafe fn assume_init(&mut self, n: usize) -> &mut Self {\n         self.initialized = cmp::max(self.initialized, self.filled + n);\n+        self\n     }\n \n     /// Appends data to the buffer, advancing the written position and possibly also the initialized position.\n@@ -227,7 +229,9 @@ impl<'a> ReadBuf<'a> {\n         }\n \n         // SAFETY: We just added the entire contents of buf to the filled section.\n-        unsafe { self.assume_init(buf.len()) }\n+        unsafe {\n+            self.assume_init(buf.len());\n+        }\n         self.add_filled(buf.len());\n     }\n "}]}