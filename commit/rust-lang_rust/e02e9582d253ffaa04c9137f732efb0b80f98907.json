{"sha": "e02e9582d253ffaa04c9137f732efb0b80f98907", "node_id": "C_kwDOAAsO6NoAKGUwMmU5NTgyZDI1M2ZmYWEwNGM5MTM3ZjczMmVmYjBiODBmOTg5MDc", "commit": {"author": {"name": "Jacob Bramley", "email": "jacob.bramley@arm.com", "date": "2022-01-19T14:51:59Z"}, "committer": {"name": "Jacob Bramley", "email": "jacob.bramley@arm.com", "date": "2022-01-24T16:50:10Z"}, "message": "Use error-on-mismatch policy for PAuth module flags.\n\nThis agrees with Clang, and avoids an error when using LTO with mixed\nC/Rust. LLVM considers different behaviour flags to be a mismatch,\neven when the flag value itself is the same.\n\nThis also makes the flag setting explicit for all uses of\nLLVMRustAddModuleFlag.", "tree": {"sha": "ce721b5714dd0b60c088c4e0f4534a8a4862e374", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ce721b5714dd0b60c088c4e0f4534a8a4862e374"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e02e9582d253ffaa04c9137f732efb0b80f98907", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e02e9582d253ffaa04c9137f732efb0b80f98907", "html_url": "https://github.com/rust-lang/rust/commit/e02e9582d253ffaa04c9137f732efb0b80f98907", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e02e9582d253ffaa04c9137f732efb0b80f98907/comments", "author": {"login": "jacobbramley", "id": 5206553, "node_id": "MDQ6VXNlcjUyMDY1NTM=", "avatar_url": "https://avatars.githubusercontent.com/u/5206553?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jacobbramley", "html_url": "https://github.com/jacobbramley", "followers_url": "https://api.github.com/users/jacobbramley/followers", "following_url": "https://api.github.com/users/jacobbramley/following{/other_user}", "gists_url": "https://api.github.com/users/jacobbramley/gists{/gist_id}", "starred_url": "https://api.github.com/users/jacobbramley/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jacobbramley/subscriptions", "organizations_url": "https://api.github.com/users/jacobbramley/orgs", "repos_url": "https://api.github.com/users/jacobbramley/repos", "events_url": "https://api.github.com/users/jacobbramley/events{/privacy}", "received_events_url": "https://api.github.com/users/jacobbramley/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jacobbramley", "id": 5206553, "node_id": "MDQ6VXNlcjUyMDY1NTM=", "avatar_url": "https://avatars.githubusercontent.com/u/5206553?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jacobbramley", "html_url": "https://github.com/jacobbramley", "followers_url": "https://api.github.com/users/jacobbramley/followers", "following_url": "https://api.github.com/users/jacobbramley/following{/other_user}", "gists_url": "https://api.github.com/users/jacobbramley/gists{/gist_id}", "starred_url": "https://api.github.com/users/jacobbramley/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jacobbramley/subscriptions", "organizations_url": "https://api.github.com/users/jacobbramley/orgs", "repos_url": "https://api.github.com/users/jacobbramley/repos", "events_url": "https://api.github.com/users/jacobbramley/events{/privacy}", "received_events_url": "https://api.github.com/users/jacobbramley/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7bc7be860f99f4a40d45b0f74e2d01b02e072357", "url": "https://api.github.com/repos/rust-lang/rust/commits/7bc7be860f99f4a40d45b0f74e2d01b02e072357", "html_url": "https://github.com/rust-lang/rust/commit/7bc7be860f99f4a40d45b0f74e2d01b02e072357"}], "stats": {"total": 86, "additions": 73, "deletions": 13}, "files": [{"sha": "8672459b5da3aae9191938309ca7e29808314256", "filename": "compiler/rustc_codegen_llvm/src/context.rs", "status": "modified", "additions": 24, "deletions": 7, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/e02e9582d253ffaa04c9137f732efb0b80f98907/compiler%2Frustc_codegen_llvm%2Fsrc%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e02e9582d253ffaa04c9137f732efb0b80f98907/compiler%2Frustc_codegen_llvm%2Fsrc%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fcontext.rs?ref=e02e9582d253ffaa04c9137f732efb0b80f98907", "patch": "@@ -215,16 +215,19 @@ pub unsafe fn create_module<'ll>(\n     // to ensure intrinsic calls don't use it.\n     if !sess.needs_plt() {\n         let avoid_plt = \"RtLibUseGOT\\0\".as_ptr().cast();\n-        llvm::LLVMRustAddModuleFlag(llmod, avoid_plt, 1);\n+        llvm::LLVMRustAddModuleFlag(llmod, llvm::LLVMModFlagBehavior::Warning, avoid_plt, 1);\n     }\n \n     if sess.is_sanitizer_cfi_enabled() {\n         // FIXME(rcvalle): Add support for non canonical jump tables.\n         let canonical_jump_tables = \"CFI Canonical Jump Tables\\0\".as_ptr().cast();\n-        // FIXME(rcvalle): Add it with Override behavior flag--LLVMRustAddModuleFlag adds it with\n-        // Warning behavior flag. Add support for specifying the behavior flag to\n-        // LLVMRustAddModuleFlag.\n-        llvm::LLVMRustAddModuleFlag(llmod, canonical_jump_tables, 1);\n+        // FIXME(rcvalle): Add it with Override behavior flag.\n+        llvm::LLVMRustAddModuleFlag(\n+            llmod,\n+            llvm::LLVMModFlagBehavior::Warning,\n+            canonical_jump_tables,\n+            1,\n+        );\n     }\n \n     // Control Flow Guard is currently only supported by the MSVC linker on Windows.\n@@ -233,11 +236,21 @@ pub unsafe fn create_module<'ll>(\n             CFGuard::Disabled => {}\n             CFGuard::NoChecks => {\n                 // Set `cfguard=1` module flag to emit metadata only.\n-                llvm::LLVMRustAddModuleFlag(llmod, \"cfguard\\0\".as_ptr() as *const _, 1)\n+                llvm::LLVMRustAddModuleFlag(\n+                    llmod,\n+                    llvm::LLVMModFlagBehavior::Warning,\n+                    \"cfguard\\0\".as_ptr() as *const _,\n+                    1,\n+                )\n             }\n             CFGuard::Checks => {\n                 // Set `cfguard=2` module flag to emit metadata and checks.\n-                llvm::LLVMRustAddModuleFlag(llmod, \"cfguard\\0\".as_ptr() as *const _, 2)\n+                llvm::LLVMRustAddModuleFlag(\n+                    llmod,\n+                    llvm::LLVMModFlagBehavior::Warning,\n+                    \"cfguard\\0\".as_ptr() as *const _,\n+                    2,\n+                )\n             }\n         }\n     }\n@@ -247,24 +260,28 @@ pub unsafe fn create_module<'ll>(\n \n         llvm::LLVMRustAddModuleFlag(\n             llmod,\n+            llvm::LLVMModFlagBehavior::Error,\n             \"branch-target-enforcement\\0\".as_ptr().cast(),\n             bti.into(),\n         );\n \n         llvm::LLVMRustAddModuleFlag(\n             llmod,\n+            llvm::LLVMModFlagBehavior::Error,\n             \"sign-return-address\\0\".as_ptr().cast(),\n             pac.is_some().into(),\n         );\n         let pac_opts = pac.unwrap_or(PacRet { leaf: false, key: PAuthKey::A });\n         llvm::LLVMRustAddModuleFlag(\n             llmod,\n+            llvm::LLVMModFlagBehavior::Error,\n             \"sign-return-address-all\\0\".as_ptr().cast(),\n             pac_opts.leaf.into(),\n         );\n         let is_bkey = if pac_opts.key == PAuthKey::A { false } else { true };\n         llvm::LLVMRustAddModuleFlag(\n             llmod,\n+            llvm::LLVMModFlagBehavior::Error,\n             \"sign-return-address-with-bkey\\0\".as_ptr().cast(),\n             is_bkey.into(),\n         );"}, {"sha": "28eb8e2a0a462de1e22b3fcb803d73cdc3cddf80", "filename": "compiler/rustc_codegen_llvm/src/debuginfo/mod.rs", "status": "modified", "additions": 13, "deletions": 2, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/e02e9582d253ffaa04c9137f732efb0b80f98907/compiler%2Frustc_codegen_llvm%2Fsrc%2Fdebuginfo%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e02e9582d253ffaa04c9137f732efb0b80f98907/compiler%2Frustc_codegen_llvm%2Fsrc%2Fdebuginfo%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fdebuginfo%2Fmod.rs?ref=e02e9582d253ffaa04c9137f732efb0b80f98907", "patch": "@@ -108,18 +108,29 @@ impl<'a, 'tcx> CrateDebugContext<'a, 'tcx> {\n             // This can be overridden using --llvm-opts -dwarf-version,N.\n             // Android has the same issue (#22398)\n             if let Some(version) = sess.target.dwarf_version {\n-                llvm::LLVMRustAddModuleFlag(self.llmod, \"Dwarf Version\\0\".as_ptr().cast(), version)\n+                llvm::LLVMRustAddModuleFlag(\n+                    self.llmod,\n+                    llvm::LLVMModFlagBehavior::Warning,\n+                    \"Dwarf Version\\0\".as_ptr().cast(),\n+                    version,\n+                )\n             }\n \n             // Indicate that we want CodeView debug information on MSVC\n             if sess.target.is_like_msvc {\n-                llvm::LLVMRustAddModuleFlag(self.llmod, \"CodeView\\0\".as_ptr().cast(), 1)\n+                llvm::LLVMRustAddModuleFlag(\n+                    self.llmod,\n+                    llvm::LLVMModFlagBehavior::Warning,\n+                    \"CodeView\\0\".as_ptr().cast(),\n+                    1,\n+                )\n             }\n \n             // Prevent bitcode readers from deleting the debug info.\n             let ptr = \"Debug Info Version\\0\".as_ptr();\n             llvm::LLVMRustAddModuleFlag(\n                 self.llmod,\n+                llvm::LLVMModFlagBehavior::Warning,\n                 ptr.cast(),\n                 llvm::LLVMRustDebugMetadataVersion(),\n             );"}, {"sha": "2b102188790389dc86445e6be4393ca049f62350", "filename": "compiler/rustc_codegen_llvm/src/llvm/ffi.rs", "status": "modified", "additions": 30, "deletions": 1, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/e02e9582d253ffaa04c9137f732efb0b80f98907/compiler%2Frustc_codegen_llvm%2Fsrc%2Fllvm%2Fffi.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e02e9582d253ffaa04c9137f732efb0b80f98907/compiler%2Frustc_codegen_llvm%2Fsrc%2Fllvm%2Fffi.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fllvm%2Fffi.rs?ref=e02e9582d253ffaa04c9137f732efb0b80f98907", "patch": "@@ -61,6 +61,26 @@ pub enum LLVMMachineType {\n     ARM = 0x01c0,\n }\n \n+/// LLVM's Module::ModFlagBehavior, defined in llvm/include/llvm/IR/Module.h.\n+///\n+/// When merging modules (e.g. during LTO), their metadata flags are combined. Conflicts are\n+/// resolved according to the merge behaviors specified here. Flags differing only in merge\n+/// behavior are still considered to be in conflict.\n+///\n+/// In order for Rust-C LTO to work, we must specify behaviors compatible with Clang. Notably,\n+/// 'Error' and 'Warning' cannot be mixed for a given flag.\n+#[derive(Copy, Clone, PartialEq)]\n+#[repr(C)]\n+pub enum LLVMModFlagBehavior {\n+    Error = 1,\n+    Warning = 2,\n+    Require = 3,\n+    Override = 4,\n+    Append = 5,\n+    AppendUnique = 6,\n+    Max = 7,\n+}\n+\n // Consts for the LLVM CallConv type, pre-cast to usize.\n \n /// LLVM CallingConv::ID. Should we wrap this?\n@@ -1895,7 +1915,16 @@ extern \"C\" {\n \n     pub fn LLVMRustIsRustLLVM() -> bool;\n \n-    pub fn LLVMRustAddModuleFlag(M: &Module, name: *const c_char, value: u32);\n+    /// Add LLVM module flags.\n+    ///\n+    /// In order for Rust-C LTO to work, module flags must be compatible with Clang. What\n+    /// \"compatible\" means depends on the merge behaviors involved.\n+    pub fn LLVMRustAddModuleFlag(\n+        M: &Module,\n+        merge_behavior: LLVMModFlagBehavior,\n+        name: *const c_char,\n+        value: u32,\n+    );\n \n     pub fn LLVMRustMetadataAsValue<'a>(C: &'a Context, MD: &'a Metadata) -> &'a Value;\n "}, {"sha": "dcd6327c92f6a38789a747473ac8ca6d11bc1b55", "filename": "compiler/rustc_llvm/llvm-wrapper/RustWrapper.cpp", "status": "modified", "additions": 6, "deletions": 3, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/e02e9582d253ffaa04c9137f732efb0b80f98907/compiler%2Frustc_llvm%2Fllvm-wrapper%2FRustWrapper.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/e02e9582d253ffaa04c9137f732efb0b80f98907/compiler%2Frustc_llvm%2Fllvm-wrapper%2FRustWrapper.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_llvm%2Fllvm-wrapper%2FRustWrapper.cpp?ref=e02e9582d253ffaa04c9137f732efb0b80f98907", "patch": "@@ -722,9 +722,12 @@ extern \"C\" bool LLVMRustIsRustLLVM() {\n #endif\n }\n \n-extern \"C\" void LLVMRustAddModuleFlag(LLVMModuleRef M, const char *Name,\n-                                      uint32_t Value) {\n-  unwrap(M)->addModuleFlag(Module::Warning, Name, Value);\n+extern \"C\" void LLVMRustAddModuleFlag(\n+    LLVMModuleRef M,\n+    Module::ModFlagBehavior MergeBehavior,\n+    const char *Name,\n+    uint32_t Value) {\n+  unwrap(M)->addModuleFlag(MergeBehavior, Name, Value);\n }\n \n extern \"C\" LLVMValueRef LLVMRustMetadataAsValue(LLVMContextRef C, LLVMMetadataRef MD) {"}]}