{"sha": "bd148d220e976330672c9f5b5a9720701079b8e8", "node_id": "MDY6Q29tbWl0NzI0NzEyOmJkMTQ4ZDIyMGU5NzYzMzA2NzJjOWY1YjVhOTcyMDcwMTA3OWI4ZTg=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-12-09T12:52:42Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-12-09T12:52:42Z"}, "message": "Auto merge of #38196 - rkruppe:llvm-archivewrapper-fwdcompat, r=alexcrichton\n\n[LLVM 4.0] rustllvm archive support\n\nError handling is being transitioned from ErrorOr<T> to Expected<T> which has a different API and requires explicitly handling all errors\n\ncc #37609", "tree": {"sha": "ab6b22f0a8108d0e6d616e9ba0a9ee28009dc27a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ab6b22f0a8108d0e6d616e9ba0a9ee28009dc27a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bd148d220e976330672c9f5b5a9720701079b8e8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bd148d220e976330672c9f5b5a9720701079b8e8", "html_url": "https://github.com/rust-lang/rust/commit/bd148d220e976330672c9f5b5a9720701079b8e8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bd148d220e976330672c9f5b5a9720701079b8e8/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "dedd9850841f20880b6318ce9cbe60e2b205b6a9", "url": "https://api.github.com/repos/rust-lang/rust/commits/dedd9850841f20880b6318ce9cbe60e2b205b6a9", "html_url": "https://github.com/rust-lang/rust/commit/dedd9850841f20880b6318ce9cbe60e2b205b6a9"}, {"sha": "25564dcda70eefa1359b105a51df198e409f5127", "url": "https://api.github.com/repos/rust-lang/rust/commits/25564dcda70eefa1359b105a51df198e409f5127", "html_url": "https://github.com/rust-lang/rust/commit/25564dcda70eefa1359b105a51df198e409f5127"}], "stats": {"total": 19, "additions": 19, "deletions": 0}, "files": [{"sha": "5adb05d608932d74444d1eff4f626761530fb52b", "filename": "src/rustllvm/ArchiveWrapper.cpp", "status": "modified", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/bd148d220e976330672c9f5b5a9720701079b8e8/src%2Frustllvm%2FArchiveWrapper.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/bd148d220e976330672c9f5b5a9720701079b8e8/src%2Frustllvm%2FArchiveWrapper.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustllvm%2FArchiveWrapper.cpp?ref=bd148d220e976330672c9f5b5a9720701079b8e8", "patch": "@@ -163,9 +163,20 @@ LLVMRustArchiveIteratorFree(LLVMRustArchiveIteratorRef rai) {\n \n extern \"C\" const char*\n LLVMRustArchiveChildName(LLVMRustArchiveChildConstRef child, size_t *size) {\n+#if LLVM_VERSION_GE(4, 0)\n+    Expected<StringRef> name_or_err = child->getName();\n+    if (!name_or_err) {\n+        // rustc_llvm currently doesn't use this error string, but it might be useful\n+        // in the future, and in the mean time this tells LLVM that the error was\n+        // not ignored and that it shouldn't abort the process.\n+        LLVMRustSetLastError(toString(name_or_err.takeError()).c_str());\n+        return NULL;\n+    }\n+#else\n     ErrorOr<StringRef> name_or_err = child->getName();\n     if (name_or_err.getError())\n         return NULL;\n+#endif\n     StringRef name = name_or_err.get();\n     *size = name.size();\n     return name.data();\n@@ -174,11 +185,19 @@ LLVMRustArchiveChildName(LLVMRustArchiveChildConstRef child, size_t *size) {\n extern \"C\" const char*\n LLVMRustArchiveChildData(LLVMRustArchiveChildRef child, size_t *size) {\n     StringRef buf;\n+#if LLVM_VERSION_GE(4, 0)\n+    Expected<StringRef> buf_or_err = child->getBuffer();\n+    if (!buf_or_err) {\n+      LLVMRustSetLastError(toString(buf_or_err.takeError()).c_str());\n+      return NULL;\n+    }\n+#else\n     ErrorOr<StringRef> buf_or_err = child->getBuffer();\n     if (buf_or_err.getError()) {\n       LLVMRustSetLastError(buf_or_err.getError().message().c_str());\n       return NULL;\n     }\n+#endif\n     buf = buf_or_err.get();\n     *size = buf.size();\n     return buf.data();"}]}