{"sha": "1c1c6eda94e9841d0a534ba012034b05173c6a13", "node_id": "C_kwDOAAsO6NoAKDFjMWM2ZWRhOTRlOTg0MWQwYTUzNGJhMDEyMDM0YjA1MTczYzZhMTM", "commit": {"author": {"name": "Jubilee", "email": "46493976+workingjubilee@users.noreply.github.com", "date": "2021-10-08T03:26:13Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-10-08T03:26:13Z"}, "message": "Rollup merge of #89288 - rusticstuff:lld_wrapper, r=Mark-Simulacrum\n\nWrapper for `-Z gcc-ld=lld` to invoke rust-lld with the correct flavor\n\nThis PR adds an `lld-wrapper` tool which is installed as `ld` and `ld64` in `lib\\rustlib\\<host_target>\\bin\\gcc-ld` directory and whose sole purpose is to invoke `rust-lld` in the parent directory with the correct flavor. Lld decides which flavor to use from either the first two commandline arguments or from the name of the executable (`ld` for GNU/ld flavor, `ld64` for Darwin/Macos/ld64 flavor and so on). Symbolic links could not be used as they are not supported by rustup and on Windows.\n\nThe wrapper replaces full copies of rust-lld which added some significant bloat. On UNIXish operating systems it exec rust-lld, on Windows it spawns it as a child process.\n\nFixes #88869.\n\nr? ```@Mark-Simulacrum```\ncc ```@nagisa``` ```@petrochenkov``` ```@1000teslas```", "tree": {"sha": "ae848f52e52239e79087c5c4a5eff245007967c6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ae848f52e52239e79087c5c4a5eff245007967c6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1c1c6eda94e9841d0a534ba012034b05173c6a13", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhX7pVCRBK7hj4Ov3rIwAArTEIAB+oAyXSd/jozl2LDLFF+LJK\nZkNNJXXb6ScACr2X7QRt18ODl5g/wiy3tqtf6O+J2RWLXdl4K4rds0raIHe17mWK\nDpEIazT+L5IUoRLv3JwBBLRSRs6B8/aCXt+K84pPoRC1r/1TtbIZ24S/2BpP2LSd\nz+VdjvZLq+RYl24Vsu9Fyv9s+L6TwoTHBq1hkBHZnfz1aK05DaAzOOcqSNTEEAxl\nzkDS9DU4I/DwY0keX1qYhZtPfsSmsnELFIKBearBKCZGVuJ6aQ50osIAgOXXWeZz\nkWJvue9UHHP2dhO6dPBde2jj8NiCTQ/O9ZED9r8iSx1kAlCGA7CFLTUXzhahsnY=\n=hyw2\n-----END PGP SIGNATURE-----\n", "payload": "tree ae848f52e52239e79087c5c4a5eff245007967c6\nparent 37f17bca7ccca0b393a58c87bb87bac18f371f61\nparent 6162fc0c809477529875b294a8ce37ff8737356c\nauthor Jubilee <46493976+workingjubilee@users.noreply.github.com> 1633663573 -0700\ncommitter GitHub <noreply@github.com> 1633663573 -0700\n\nRollup merge of #89288 - rusticstuff:lld_wrapper, r=Mark-Simulacrum\n\nWrapper for `-Z gcc-ld=lld` to invoke rust-lld with the correct flavor\n\nThis PR adds an `lld-wrapper` tool which is installed as `ld` and `ld64` in `lib\\rustlib\\<host_target>\\bin\\gcc-ld` directory and whose sole purpose is to invoke `rust-lld` in the parent directory with the correct flavor. Lld decides which flavor to use from either the first two commandline arguments or from the name of the executable (`ld` for GNU/ld flavor, `ld64` for Darwin/Macos/ld64 flavor and so on). Symbolic links could not be used as they are not supported by rustup and on Windows.\n\nThe wrapper replaces full copies of rust-lld which added some significant bloat. On UNIXish operating systems it exec rust-lld, on Windows it spawns it as a child process.\n\nFixes #88869.\n\nr? ```@Mark-Simulacrum```\ncc ```@nagisa``` ```@petrochenkov``` ```@1000teslas```\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1c1c6eda94e9841d0a534ba012034b05173c6a13", "html_url": "https://github.com/rust-lang/rust/commit/1c1c6eda94e9841d0a534ba012034b05173c6a13", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1c1c6eda94e9841d0a534ba012034b05173c6a13/comments", "author": {"login": "workingjubilee", "id": 46493976, "node_id": "MDQ6VXNlcjQ2NDkzOTc2", "avatar_url": "https://avatars.githubusercontent.com/u/46493976?v=4", "gravatar_id": "", "url": "https://api.github.com/users/workingjubilee", "html_url": "https://github.com/workingjubilee", "followers_url": "https://api.github.com/users/workingjubilee/followers", "following_url": "https://api.github.com/users/workingjubilee/following{/other_user}", "gists_url": "https://api.github.com/users/workingjubilee/gists{/gist_id}", "starred_url": "https://api.github.com/users/workingjubilee/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/workingjubilee/subscriptions", "organizations_url": "https://api.github.com/users/workingjubilee/orgs", "repos_url": "https://api.github.com/users/workingjubilee/repos", "events_url": "https://api.github.com/users/workingjubilee/events{/privacy}", "received_events_url": "https://api.github.com/users/workingjubilee/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "37f17bca7ccca0b393a58c87bb87bac18f371f61", "url": "https://api.github.com/repos/rust-lang/rust/commits/37f17bca7ccca0b393a58c87bb87bac18f371f61", "html_url": "https://github.com/rust-lang/rust/commit/37f17bca7ccca0b393a58c87bb87bac18f371f61"}, {"sha": "6162fc0c809477529875b294a8ce37ff8737356c", "url": "https://api.github.com/repos/rust-lang/rust/commits/6162fc0c809477529875b294a8ce37ff8737356c", "html_url": "https://github.com/rust-lang/rust/commit/6162fc0c809477529875b294a8ce37ff8737356c"}], "stats": {"total": 202, "additions": 189, "deletions": 13}, "files": [{"sha": "e45926f832c982036dc9285a415395e45ad5b38b", "filename": "Cargo.lock", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/1c1c6eda94e9841d0a534ba012034b05173c6a13/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/1c1c6eda94e9841d0a534ba012034b05173c6a13/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=1c1c6eda94e9841d0a534ba012034b05173c6a13", "patch": "@@ -1965,6 +1965,10 @@ dependencies = [\n  \"walkdir\",\n ]\n \n+[[package]]\n+name = \"lld-wrapper\"\n+version = \"0.1.0\"\n+\n [[package]]\n name = \"lock_api\"\n version = \"0.4.1\""}, {"sha": "42dd5d7ef432ee091c1f18ed1e78601c99d30806", "filename": "Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/1c1c6eda94e9841d0a534ba012034b05173c6a13/Cargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/1c1c6eda94e9841d0a534ba012034b05173c6a13/Cargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.toml?ref=1c1c6eda94e9841d0a534ba012034b05173c6a13", "patch": "@@ -36,6 +36,7 @@ members = [\n   \"src/tools/jsondocck\",\n   \"src/tools/html-checker\",\n   \"src/tools/bump-stage0\",\n+  \"src/tools/lld-wrapper\",\n ]\n \n exclude = ["}, {"sha": "4b189672226ea5984ee75c6f2780b12baac1df43", "filename": "src/bootstrap/compile.rs", "status": "modified", "additions": 8, "deletions": 8, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/1c1c6eda94e9841d0a534ba012034b05173c6a13/src%2Fbootstrap%2Fcompile.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1c1c6eda94e9841d0a534ba012034b05173c6a13/src%2Fbootstrap%2Fcompile.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcompile.rs?ref=1c1c6eda94e9841d0a534ba012034b05173c6a13", "patch": "@@ -1136,14 +1136,14 @@ impl Step for Assemble {\n             // for `-Z gcc-ld=lld`\n             let gcc_ld_dir = libdir_bin.join(\"gcc-ld\");\n             t!(fs::create_dir(&gcc_ld_dir));\n-            builder.copy(\n-                &lld_install.join(\"bin\").join(&src_exe),\n-                &gcc_ld_dir.join(exe(\"ld\", target_compiler.host)),\n-            );\n-            builder.copy(\n-                &lld_install.join(\"bin\").join(&src_exe),\n-                &gcc_ld_dir.join(exe(\"ld64\", target_compiler.host)),\n-            );\n+            for flavor in [\"ld\", \"ld64\"] {\n+                let lld_wrapper_exe = builder.ensure(crate::tool::LldWrapper {\n+                    compiler: build_compiler,\n+                    target: target_compiler.host,\n+                    flavor_feature: flavor,\n+                });\n+                builder.copy(&lld_wrapper_exe, &gcc_ld_dir.join(exe(flavor, target_compiler.host)));\n+            }\n         }\n \n         // Similarly, copy `llvm-dwp` into libdir for Split DWARF. Only copy it when the LLVM"}, {"sha": "d4875cfe1b066e31d74f4d1ed48fc67ace3d26d8", "filename": "src/bootstrap/dist.rs", "status": "modified", "additions": 8, "deletions": 5, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/1c1c6eda94e9841d0a534ba012034b05173c6a13/src%2Fbootstrap%2Fdist.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1c1c6eda94e9841d0a534ba012034b05173c6a13/src%2Fbootstrap%2Fdist.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fdist.rs?ref=1c1c6eda94e9841d0a534ba012034b05173c6a13", "patch": "@@ -409,11 +409,14 @@ impl Step for Rustc {\n                 let rust_lld = exe(\"rust-lld\", compiler.host);\n                 builder.copy(&src_dir.join(&rust_lld), &dst_dir.join(&rust_lld));\n                 // for `-Z gcc-ld=lld`\n-                let gcc_lld_dir = dst_dir.join(\"gcc-ld\");\n-                t!(fs::create_dir(&gcc_lld_dir));\n-                builder.copy(&src_dir.join(&rust_lld), &gcc_lld_dir.join(exe(\"ld\", compiler.host)));\n-                builder\n-                    .copy(&src_dir.join(&rust_lld), &gcc_lld_dir.join(exe(\"ld64\", compiler.host)));\n+                let gcc_lld_src_dir = src_dir.join(\"gcc-ld\");\n+                let gcc_lld_dst_dir = dst_dir.join(\"gcc-ld\");\n+                t!(fs::create_dir(&gcc_lld_dst_dir));\n+                for flavor in [\"ld\", \"ld64\"] {\n+                    let exe_name = exe(flavor, compiler.host);\n+                    builder\n+                        .copy(&gcc_lld_src_dir.join(&exe_name), &gcc_lld_dst_dir.join(&exe_name));\n+                }\n             }\n \n             // Copy over llvm-dwp if it's there"}, {"sha": "af6f4bb0e5fcba19c98240a9bdbf80cb8dcad5ef", "filename": "src/bootstrap/tool.rs", "status": "modified", "additions": 32, "deletions": 0, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/1c1c6eda94e9841d0a534ba012034b05173c6a13/src%2Fbootstrap%2Ftool.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1c1c6eda94e9841d0a534ba012034b05173c6a13/src%2Fbootstrap%2Ftool.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Ftool.rs?ref=1c1c6eda94e9841d0a534ba012034b05173c6a13", "patch": "@@ -664,6 +664,38 @@ impl Step for Cargo {\n     }\n }\n \n+#[derive(Debug, Copy, Clone, Hash, PartialEq, Eq)]\n+pub struct LldWrapper {\n+    pub compiler: Compiler,\n+    pub target: TargetSelection,\n+    pub flavor_feature: &'static str,\n+}\n+\n+impl Step for LldWrapper {\n+    type Output = PathBuf;\n+\n+    fn should_run(run: ShouldRun<'_>) -> ShouldRun<'_> {\n+        run.never()\n+    }\n+\n+    fn run(self, builder: &Builder<'_>) -> PathBuf {\n+        let src_exe = builder\n+            .ensure(ToolBuild {\n+                compiler: self.compiler,\n+                target: self.target,\n+                tool: \"lld-wrapper\",\n+                mode: Mode::ToolStd,\n+                path: \"src/tools/lld-wrapper\",\n+                is_optional_tool: false,\n+                source_type: SourceType::InTree,\n+                extra_features: vec![self.flavor_feature.to_owned()],\n+            })\n+            .expect(\"expected to build -- essential tool\");\n+\n+        src_exe\n+    }\n+}\n+\n macro_rules! tool_extended {\n     (($sel:ident, $builder:ident),\n        $($name:ident,"}, {"sha": "66a586fd6c35ed049f72f4f8d6c96d6fd93d62bd", "filename": "src/tools/lld-wrapper/Cargo.toml", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/1c1c6eda94e9841d0a534ba012034b05173c6a13/src%2Ftools%2Flld-wrapper%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/1c1c6eda94e9841d0a534ba012034b05173c6a13/src%2Ftools%2Flld-wrapper%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Flld-wrapper%2FCargo.toml?ref=1c1c6eda94e9841d0a534ba012034b05173c6a13", "patch": "@@ -0,0 +1,11 @@\n+[package]\n+name = \"lld-wrapper\"\n+version = \"0.1.0\"\n+edition = \"2021\"\n+license = \"MIT OR Apache-2.0\"\n+\n+[dependencies]\n+\n+[features]\n+ld = []\n+ld64 = []\n\\ No newline at end of file"}, {"sha": "1601bf1b34e9c44b76f26b9ad44b109019a23878", "filename": "src/tools/lld-wrapper/src/main.rs", "status": "added", "additions": 125, "deletions": 0, "changes": 125, "blob_url": "https://github.com/rust-lang/rust/blob/1c1c6eda94e9841d0a534ba012034b05173c6a13/src%2Ftools%2Flld-wrapper%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1c1c6eda94e9841d0a534ba012034b05173c6a13/src%2Ftools%2Flld-wrapper%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Flld-wrapper%2Fsrc%2Fmain.rs?ref=1c1c6eda94e9841d0a534ba012034b05173c6a13", "patch": "@@ -0,0 +1,125 @@\n+//! Script to invoke the bundled rust-lld with the correct flavor. The flavor is selected by\n+//! feature.\n+//!\n+//! lld supports multiple command line interfaces. If `-flavor <flavor>` are passed as the first\n+//! two arguments the `<flavor>` command line interface is used to process the remaining arguments.\n+//! If no `-flavor` argument is present the flavor is determined by the executable name.\n+//!\n+//! In Rust with `-Z gcc-ld=lld` we have gcc or clang invoke rust-lld. Since there is no way to\n+//! make gcc/clang pass `-flavor <flavor>` as the first two arguments in the linker invocation\n+//! and since Windows does not support symbolic links for files this wrapper is used in place of a\n+//! symblic link. It execs `../rust-lld -flavor ld` if the feature `ld` is enabled and\n+//! `../rust-lld -flavor ld64` if `ld64` is enabled. On Windows it spawns a `..\\rust-lld.exe`\n+//! child process.\n+\n+#[cfg(not(any(feature = \"ld\", feature = \"ld64\")))]\n+compile_error!(\"One of the features ld and ld64 must be enabled.\");\n+\n+#[cfg(all(feature = \"ld\", feature = \"ld64\"))]\n+compile_error!(\"Only one of the feature ld or ld64 can be enabled.\");\n+\n+#[cfg(feature = \"ld\")]\n+const FLAVOR: &str = \"ld\";\n+\n+#[cfg(feature = \"ld64\")]\n+const FLAVOR: &str = \"ld64\";\n+\n+use std::env;\n+use std::fmt::Display;\n+use std::path::{Path, PathBuf};\n+use std::process;\n+\n+trait ResultExt<T, E> {\n+    fn unwrap_or_exit_with(self, context: &str) -> T;\n+}\n+\n+impl<T, E> ResultExt<T, E> for Result<T, E>\n+where\n+    E: Display,\n+{\n+    fn unwrap_or_exit_with(self, context: &str) -> T {\n+        match self {\n+            Ok(t) => t,\n+            Err(e) => {\n+                eprintln!(\"lld-wrapper: {}: {}\", context, e);\n+                process::exit(1);\n+            }\n+        }\n+    }\n+}\n+\n+trait OptionExt<T> {\n+    fn unwrap_or_exit_with(self, context: &str) -> T;\n+}\n+\n+impl<T> OptionExt<T> for Option<T> {\n+    fn unwrap_or_exit_with(self, context: &str) -> T {\n+        match self {\n+            Some(t) => t,\n+            None => {\n+                eprintln!(\"lld-wrapper: {}\", context);\n+                process::exit(1);\n+            }\n+        }\n+    }\n+}\n+\n+/// Returns the path to rust-lld in the parent directory.\n+///\n+/// Exits if the parent directory cannot be determined.\n+fn get_rust_lld_path(current_exe_path: &Path) -> PathBuf {\n+    let mut rust_lld_exe_name = \"rust-lld\".to_owned();\n+    rust_lld_exe_name.push_str(env::consts::EXE_SUFFIX);\n+    let mut rust_lld_path = current_exe_path\n+        .parent()\n+        .unwrap_or_exit_with(\"directory containing current executable could not be determined\")\n+        .parent()\n+        .unwrap_or_exit_with(\"parent directory could not be determined\")\n+        .to_owned();\n+    rust_lld_path.push(rust_lld_exe_name);\n+    rust_lld_path\n+}\n+\n+/// Returns the command for invoking rust-lld with the correct flavor.\n+///\n+/// Exits on error.\n+fn get_rust_lld_command(current_exe_path: &Path) -> process::Command {\n+    let rust_lld_path = get_rust_lld_path(current_exe_path);\n+    let mut command = process::Command::new(rust_lld_path);\n+    command.arg(\"-flavor\");\n+    command.arg(FLAVOR);\n+    command.args(env::args_os().skip(1));\n+    command\n+}\n+\n+#[cfg(unix)]\n+fn exec_lld(mut command: process::Command) {\n+    use std::os::unix::prelude::CommandExt;\n+    Result::<(), _>::Err(command.exec()).unwrap_or_exit_with(\"could not exec rust-lld\");\n+    unreachable!(\"lld-wrapper: after exec without error\");\n+}\n+\n+#[cfg(not(unix))]\n+fn exec_lld(mut command: process::Command) {\n+    // Windows has no exec(), spawn a child process and wait for it\n+    let exit_status = command.status().unwrap_or_exit_with(\"error running rust-lld child process\");\n+    if !exit_status.success() {\n+        match exit_status.code() {\n+            Some(code) => {\n+                // return the original lld exit code\n+                process::exit(code)\n+            }\n+            None => {\n+                eprintln!(\"lld-wrapper: rust-lld child process exited with error: {}\", exit_status,);\n+                process::exit(1);\n+            }\n+        }\n+    }\n+}\n+\n+fn main() {\n+    let current_exe_path =\n+        env::current_exe().unwrap_or_exit_with(\"could not get the path of the current executable\");\n+\n+    exec_lld(get_rust_lld_command(current_exe_path.as_ref()));\n+}"}]}