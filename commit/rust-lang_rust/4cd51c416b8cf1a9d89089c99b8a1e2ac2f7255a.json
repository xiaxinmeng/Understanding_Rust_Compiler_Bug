{"sha": "4cd51c416b8cf1a9d89089c99b8a1e2ac2f7255a", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRjZDUxYzQxNmI4Y2YxYTlkODkwODljOTliOGExZTJhYzJmNzI1NWE=", "commit": {"author": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2013-05-06T23:29:54Z"}, "committer": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2013-05-07T19:08:00Z"}, "message": "rt: Move win32_require out of the rust_kernel type\n\nThis is only used on rust_rng, which I am trying to extricate from\nthe kernel.", "tree": {"sha": "5d507d561b6d473ad0d9fa15435f05d1ac7538b0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5d507d561b6d473ad0d9fa15435f05d1ac7538b0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4cd51c416b8cf1a9d89089c99b8a1e2ac2f7255a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4cd51c416b8cf1a9d89089c99b8a1e2ac2f7255a", "html_url": "https://github.com/rust-lang/rust/commit/4cd51c416b8cf1a9d89089c99b8a1e2ac2f7255a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4cd51c416b8cf1a9d89089c99b8a1e2ac2f7255a/comments", "author": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "committer": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "19d2ba33832d1fa1ba6485df7b481e9aa5e5bd02", "url": "https://api.github.com/repos/rust-lang/rust/commits/19d2ba33832d1fa1ba6485df7b481e9aa5e5bd02", "html_url": "https://github.com/rust-lang/rust/commit/19d2ba33832d1fa1ba6485df7b481e9aa5e5bd02"}], "stats": {"total": 49, "additions": 23, "deletions": 26}, "files": [{"sha": "bf48554696ebd3760bfb350f134a8d40730f5ab1", "filename": "src/rt/rust_kernel.cpp", "status": "modified", "additions": 0, "deletions": 19, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/4cd51c416b8cf1a9d89089c99b8a1e2ac2f7255a/src%2Frt%2Frust_kernel.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/4cd51c416b8cf1a9d89089c99b8a1e2ac2f7255a/src%2Frt%2Frust_kernel.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_kernel.cpp?ref=4cd51c416b8cf1a9d89089c99b8a1e2ac2f7255a", "patch": "@@ -257,25 +257,6 @@ rust_kernel::generate_task_id() {\n     return id;\n }\n \n-#ifdef __WIN32__\n-void\n-rust_kernel::win32_require(LPCTSTR fn, BOOL ok) {\n-    if (!ok) {\n-        LPTSTR buf;\n-        DWORD err = GetLastError();\n-        FormatMessage(FORMAT_MESSAGE_ALLOCATE_BUFFER |\n-                      FORMAT_MESSAGE_FROM_SYSTEM |\n-                      FORMAT_MESSAGE_IGNORE_INSERTS,\n-                      NULL, err,\n-                      MAKELANGID(LANG_NEUTRAL, SUBLANG_DEFAULT),\n-                      (LPTSTR) &buf, 0, NULL );\n-        KLOG_ERR_(dom, \"%s failed with error %ld: %s\", fn, err, buf);\n-        LocalFree((HLOCAL)buf);\n-        assert(ok);\n-    }\n-}\n-#endif\n-\n void\n rust_kernel::set_exit_status(int code) {\n     scoped_lock with(rval_lock);"}, {"sha": "4976dec149a0273148b8c3eaeaebbeec84b8052e", "filename": "src/rt/rust_kernel.h", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/4cd51c416b8cf1a9d89089c99b8a1e2ac2f7255a/src%2Frt%2Frust_kernel.h", "raw_url": "https://github.com/rust-lang/rust/raw/4cd51c416b8cf1a9d89089c99b8a1e2ac2f7255a/src%2Frt%2Frust_kernel.h", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_kernel.h?ref=4cd51c416b8cf1a9d89089c99b8a1e2ac2f7255a", "patch": "@@ -147,10 +147,6 @@ class rust_kernel {\n     void wait_for_schedulers();\n     int run();\n \n-#ifdef __WIN32__\n-    void win32_require(LPCTSTR fn, BOOL ok);\n-#endif\n-\n     rust_task_id generate_task_id();\n \n     void set_exit_status(int code);"}, {"sha": "d55f9b5f2bcd944315e847e4fcae6d4472e89ba6", "filename": "src/rt/rust_rng.cpp", "status": "modified", "additions": 23, "deletions": 3, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/4cd51c416b8cf1a9d89089c99b8a1e2ac2f7255a/src%2Frt%2Frust_rng.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/4cd51c416b8cf1a9d89089c99b8a1e2ac2f7255a/src%2Frt%2Frust_rng.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_rng.cpp?ref=4cd51c416b8cf1a9d89089c99b8a1e2ac2f7255a", "patch": "@@ -12,6 +12,26 @@\n #include \"rust_rng.h\"\n #include \"rust_util.h\"\n \n+\n+#ifdef __WIN32__\n+void\n+win32_require(LPCTSTR fn, BOOL ok) {\n+    if (!ok) {\n+        LPTSTR buf;\n+        DWORD err = GetLastError();\n+        FormatMessage(FORMAT_MESSAGE_ALLOCATE_BUFFER |\n+                      FORMAT_MESSAGE_FROM_SYSTEM |\n+                      FORMAT_MESSAGE_IGNORE_INSERTS,\n+                      NULL, err,\n+                      MAKELANGID(LANG_NEUTRAL, SUBLANG_DEFAULT),\n+                      (LPTSTR) &buf, 0, NULL );\n+        fprintf(stderr, \"%s failed with error %ld: %s\", fn, err, buf);\n+        LocalFree((HLOCAL)buf);\n+        abort();\n+    }\n+}\n+#endif\n+\n size_t\n rng_seed_size() {\n     randctx rctx;\n@@ -24,13 +44,13 @@ void\n rng_gen_seed(rust_kernel* kernel, uint8_t* dest, size_t size) {\n #ifdef __WIN32__\n     HCRYPTPROV hProv;\n-    kernel->win32_require\n+    win32_require\n         (_T(\"CryptAcquireContext\"),\n          CryptAcquireContext(&hProv, NULL, NULL, PROV_RSA_FULL,\n                              CRYPT_VERIFYCONTEXT|CRYPT_SILENT));\n-    kernel->win32_require\n+    win32_require\n         (_T(\"CryptGenRandom\"), CryptGenRandom(hProv, size, (BYTE*) dest));\n-    kernel->win32_require\n+    win32_require\n         (_T(\"CryptReleaseContext\"), CryptReleaseContext(hProv, 0));\n #else\n     int fd = open(\"/dev/urandom\", O_RDONLY);"}]}