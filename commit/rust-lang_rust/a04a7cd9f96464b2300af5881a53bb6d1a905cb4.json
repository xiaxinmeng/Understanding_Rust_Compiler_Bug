{"sha": "a04a7cd9f96464b2300af5881a53bb6d1a905cb4", "node_id": "C_kwDOAAsO6NoAKGEwNGE3Y2Q5Zjk2NDY0YjIzMDBhZjU4ODFhNTNiYjZkMWE5MDVjYjQ", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-10-07T09:36:51Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-10-07T09:36:51Z"}, "message": "Auto merge of #7779 - rust-lang:test_module, r=flip1995\n\nmake test module detection more strict\n\nI started with some small improvements to clippy_utils/src/lib.rs, but then found that our \"test\" module detection would also catch words containing \"test\" like e.g. \"attestation\". So I made this a bit more strict (splitting by `'_'` and checking for `test` or `tests`), adding a test case as I went.\n\n---\n\n*Please write a short comment explaining your change (or \"none\" for internal only changes)*\n\nchangelog: none", "tree": {"sha": "540e28ba2c0f5f6814639c99bbc555cc6ca096cb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/540e28ba2c0f5f6814639c99bbc555cc6ca096cb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a04a7cd9f96464b2300af5881a53bb6d1a905cb4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a04a7cd9f96464b2300af5881a53bb6d1a905cb4", "html_url": "https://github.com/rust-lang/rust/commit/a04a7cd9f96464b2300af5881a53bb6d1a905cb4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a04a7cd9f96464b2300af5881a53bb6d1a905cb4/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b7f3f7f6082679da2da9a0b3faf1b5adef3afd3b", "url": "https://api.github.com/repos/rust-lang/rust/commits/b7f3f7f6082679da2da9a0b3faf1b5adef3afd3b", "html_url": "https://github.com/rust-lang/rust/commit/b7f3f7f6082679da2da9a0b3faf1b5adef3afd3b"}, {"sha": "86811e9b1ba28abd8ba00ece1670c7cfd1284817", "url": "https://api.github.com/repos/rust-lang/rust/commits/86811e9b1ba28abd8ba00ece1670c7cfd1284817", "html_url": "https://github.com/rust-lang/rust/commit/86811e9b1ba28abd8ba00ece1670c7cfd1284817"}], "stats": {"total": 66, "additions": 39, "deletions": 27}, "files": [{"sha": "09eee78f0d1ffeb339cc1c11d6ff91dde1145281", "filename": "clippy_utils/src/lib.rs", "status": "modified", "additions": 16, "deletions": 26, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/a04a7cd9f96464b2300af5881a53bb6d1a905cb4/clippy_utils%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a04a7cd9f96464b2300af5881a53bb6d1a905cb4/clippy_utils%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_utils%2Fsrc%2Flib.rs?ref=a04a7cd9f96464b2300af5881a53bb6d1a905cb4", "patch": "@@ -251,11 +251,7 @@ pub fn is_lang_ctor(cx: &LateContext<'_>, qpath: &QPath<'_>, lang_item: LangItem\n /// Returns `true` if this `span` was expanded by any macro.\n #[must_use]\n pub fn in_macro(span: Span) -> bool {\n-    if span.from_expansion() {\n-        !matches!(span.ctxt().outer_expn_data().kind, ExpnKind::Desugaring(..))\n-    } else {\n-        false\n-    }\n+    span.from_expansion() && !matches!(span.ctxt().outer_expn_data().kind, ExpnKind::Desugaring(..))\n }\n \n pub fn is_unit_expr(expr: &Expr<'_>) -> bool {\n@@ -1285,10 +1281,9 @@ pub fn is_integer_const(cx: &LateContext<'_>, e: &Expr<'_>, value: u128) -> bool\n     }\n     let enclosing_body = cx.tcx.hir().local_def_id(cx.tcx.hir().enclosing_body_owner(e.hir_id));\n     if let Some((Constant::Int(v), _)) = constant(cx, cx.tcx.typeck(enclosing_body), e) {\n-        value == v\n-    } else {\n-        false\n+        return value == v;\n     }\n+    false\n }\n \n /// Checks whether the given expression is a constant literal of the given value.\n@@ -1315,7 +1310,7 @@ pub fn is_adjusted(cx: &LateContext<'_>, e: &Expr<'_>) -> bool {\n \n /// Returns the pre-expansion span if is this comes from an expansion of the\n /// macro `name`.\n-/// See also `is_direct_expn_of`.\n+/// See also [`is_direct_expn_of`].\n #[must_use]\n pub fn is_expn_of(mut span: Span, name: &str) -> Option<Span> {\n     loop {\n@@ -1338,13 +1333,13 @@ pub fn is_expn_of(mut span: Span, name: &str) -> Option<Span> {\n \n /// Returns the pre-expansion span if the span directly comes from an expansion\n /// of the macro `name`.\n-/// The difference with `is_expn_of` is that in\n-/// ```rust,ignore\n+/// The difference with [`is_expn_of`] is that in\n+/// ```rust\n+/// # macro_rules! foo { ($e:tt) => { $e } }; macro_rules! bar { ($e:expr) => { $e } }\n /// foo!(bar!(42));\n /// ```\n /// `42` is considered expanded from `foo!` and `bar!` by `is_expn_of` but only\n-/// `bar!` by\n-/// `is_direct_expn_of`.\n+/// from `bar!` by `is_direct_expn_of`.\n #[must_use]\n pub fn is_direct_expn_of(span: Span, name: &str) -> Option<Span> {\n     if span.from_expansion() {\n@@ -1467,11 +1462,9 @@ pub fn is_self(slf: &Param<'_>) -> bool {\n }\n \n pub fn is_self_ty(slf: &hir::Ty<'_>) -> bool {\n-    if_chain! {\n-        if let TyKind::Path(QPath::Resolved(None, path)) = slf.kind;\n-        if let Res::SelfTy(..) = path.res;\n-        then {\n-            return true\n+    if let TyKind::Path(QPath::Resolved(None, path)) = slf.kind {\n+        if let Res::SelfTy(..) = path.res {\n+            return true;\n         }\n     }\n     false\n@@ -2063,15 +2056,12 @@ macro_rules! unwrap_cargo_metadata {\n }\n \n pub fn is_hir_ty_cfg_dependant(cx: &LateContext<'_>, ty: &hir::Ty<'_>) -> bool {\n-    if_chain! {\n-        if let TyKind::Path(QPath::Resolved(_, path)) = ty.kind;\n-        if let Res::Def(_, def_id) = path.res;\n-        then {\n-            cx.tcx.has_attr(def_id, sym::cfg) || cx.tcx.has_attr(def_id, sym::cfg_attr)\n-        } else {\n-            false\n+    if let TyKind::Path(QPath::Resolved(_, path)) = ty.kind {\n+        if let Res::Def(_, def_id) = path.res {\n+            return cx.tcx.has_attr(def_id, sym::cfg) || cx.tcx.has_attr(def_id, sym::cfg_attr);\n         }\n     }\n+    false\n }\n \n /// Checks whether item either has `test` attribute applied, or\n@@ -2083,7 +2073,7 @@ pub fn is_test_module_or_function(tcx: TyCtxt<'_>, item: &Item<'_>) -> bool {\n         }\n     }\n \n-    matches!(item.kind, ItemKind::Mod(..)) && item.ident.name.as_str().contains(\"test\")\n+    matches!(item.kind, ItemKind::Mod(..)) && item.ident.name.as_str().split('_').any(|a| a == \"test\" || a == \"tests\")\n }\n \n macro_rules! op_utils {"}, {"sha": "98bc1e80731ff3934643d2c565f70ad241ddd7f1", "filename": "tests/ui/wildcard_imports.fixed", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/a04a7cd9f96464b2300af5881a53bb6d1a905cb4/tests%2Fui%2Fwildcard_imports.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/a04a7cd9f96464b2300af5881a53bb6d1a905cb4/tests%2Fui%2Fwildcard_imports.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fwildcard_imports.fixed?ref=a04a7cd9f96464b2300af5881a53bb6d1a905cb4", "patch": "@@ -230,4 +230,12 @@ mod super_imports {\n             let _ = foofoo();\n         }\n     }\n+\n+    mod attestation_should_be_replaced {\n+        use super::foofoo;\n+\n+        fn with_explicit() {\n+            let _ = foofoo();\n+        }\n+    }\n }"}, {"sha": "4ef61f9245b58f9420daded6c79a1d84e201edb9", "filename": "tests/ui/wildcard_imports.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/a04a7cd9f96464b2300af5881a53bb6d1a905cb4/tests%2Fui%2Fwildcard_imports.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a04a7cd9f96464b2300af5881a53bb6d1a905cb4/tests%2Fui%2Fwildcard_imports.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fwildcard_imports.rs?ref=a04a7cd9f96464b2300af5881a53bb6d1a905cb4", "patch": "@@ -231,4 +231,12 @@ mod super_imports {\n             let _ = foofoo();\n         }\n     }\n+\n+    mod attestation_should_be_replaced {\n+        use super::*;\n+\n+        fn with_explicit() {\n+            let _ = foofoo();\n+        }\n+    }\n }"}, {"sha": "d7af0c046e88694f34a1ff399931fe346cc8904c", "filename": "tests/ui/wildcard_imports.stderr", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/a04a7cd9f96464b2300af5881a53bb6d1a905cb4/tests%2Fui%2Fwildcard_imports.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/a04a7cd9f96464b2300af5881a53bb6d1a905cb4/tests%2Fui%2Fwildcard_imports.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fwildcard_imports.stderr?ref=a04a7cd9f96464b2300af5881a53bb6d1a905cb4", "patch": "@@ -122,5 +122,11 @@ error: usage of wildcard import\n LL |         use super::super::super_imports::*;\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: try: `super::super::super_imports::foofoo`\n \n-error: aborting due to 20 previous errors\n+error: usage of wildcard import\n+  --> $DIR/wildcard_imports.rs:236:13\n+   |\n+LL |         use super::*;\n+   |             ^^^^^^^^ help: try: `super::foofoo`\n+\n+error: aborting due to 21 previous errors\n "}]}