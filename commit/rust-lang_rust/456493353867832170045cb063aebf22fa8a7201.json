{"sha": "456493353867832170045cb063aebf22fa8a7201", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQ1NjQ5MzM1Mzg2NzgzMjE3MDA0NWNiMDYzYWViZjIyZmE4YTcyMDE=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-08-12T11:57:10Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-08-12T11:57:10Z"}, "message": "Auto merge of #43746 - eddyb:sound-thread-local, r=alexcrichton\n\nCheck #[thread_local] statics correctly in the compiler.\n\nFixes #43733 by introducing `#[allow_internal_unsafe]` analogous to `#[allow_internal_unstable]`, for letting a macro expand to `unsafe` blocks and functions even in `#![forbid(unsafe_code)]` crates.\n\nFixes #17954 by not letting references to `#[thread_local]` statics escape the function they're taken in - we can't just use a magical lifetime because Rust has *lifetime parametrism*, so if we added the often-proposed `'thread` lifetime, we'd have no way to check it in generic code.\nTo avoid potential edge cases in the compiler, the lifetime is actually that of a temporary at the same position, i.e. `&TLS_STATIC` has the same lifetime `&non_const_fn()` would.\n\nReferring to `#[thread_local]` `static`s at compile-time is banned now (as per PR discussion).\n\nAdditionally, to remove `unsafe impl Sync` from `std::thread::local::fast::Key`, `#[thread_local]` statics are now not required to implement `Sync`, as they are not shared between threads.", "tree": {"sha": "64b6b2185fc25409aa802596fa0ed3b0d4c6acb4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/64b6b2185fc25409aa802596fa0ed3b0d4c6acb4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/456493353867832170045cb063aebf22fa8a7201", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/456493353867832170045cb063aebf22fa8a7201", "html_url": "https://github.com/rust-lang/rust/commit/456493353867832170045cb063aebf22fa8a7201", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/456493353867832170045cb063aebf22fa8a7201/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "59f6b8338e866b022941ff78ccc82ccef73a52fd", "url": "https://api.github.com/repos/rust-lang/rust/commits/59f6b8338e866b022941ff78ccc82ccef73a52fd", "html_url": "https://github.com/rust-lang/rust/commit/59f6b8338e866b022941ff78ccc82ccef73a52fd"}, {"sha": "92892d3beb2ab858c6e73df0cf732d2c6f83a4aa", "url": "https://api.github.com/repos/rust-lang/rust/commits/92892d3beb2ab858c6e73df0cf732d2c6f83a4aa", "html_url": "https://github.com/rust-lang/rust/commit/92892d3beb2ab858c6e73df0cf732d2c6f83a4aa"}], "stats": {"total": 452, "additions": 378, "deletions": 74}, "files": [{"sha": "adf7d901be9c02bb9cdeb68c97e8471bd75ad972", "filename": "src/librustc/hir/lowering.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/456493353867832170045cb063aebf22fa8a7201/src%2Flibrustc%2Fhir%2Flowering.rs", "raw_url": "https://github.com/rust-lang/rust/raw/456493353867832170045cb063aebf22fa8a7201/src%2Flibrustc%2Fhir%2Flowering.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fhir%2Flowering.rs?ref=456493353867832170045cb063aebf22fa8a7201", "patch": "@@ -404,6 +404,7 @@ impl<'a> LoweringContext<'a> {\n                 format: codemap::CompilerDesugaring(Symbol::intern(reason)),\n                 span: Some(span),\n                 allow_internal_unstable: true,\n+                allow_internal_unsafe: false,\n             },\n         });\n         span.ctxt = SyntaxContext::empty().apply_mark(mark);"}, {"sha": "5533ab51895422b960f760c4077f1ea3da30dbb7", "filename": "src/librustc/middle/mem_categorization.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/456493353867832170045cb063aebf22fa8a7201/src%2Flibrustc%2Fmiddle%2Fmem_categorization.rs", "raw_url": "https://github.com/rust-lang/rust/raw/456493353867832170045cb063aebf22fa8a7201/src%2Flibrustc%2Fmiddle%2Fmem_categorization.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fmem_categorization.rs?ref=456493353867832170045cb063aebf22fa8a7201", "patch": "@@ -643,7 +643,13 @@ impl<'a, 'gcx, 'tcx> MemCategorizationContext<'a, 'gcx, 'tcx> {\n                 Ok(self.cat_rvalue_node(id, span, expr_ty))\n           }\n \n-          Def::Static(_, mutbl) => {\n+          Def::Static(def_id, mutbl) => {\n+            // `#[thread_local]` statics may not outlive the current function.\n+            for attr in &self.tcx.get_attrs(def_id)[..] {\n+                if attr.check_name(\"thread_local\") {\n+                    return Ok(self.cat_rvalue_node(id, span, expr_ty));\n+                }\n+            }\n               Ok(Rc::new(cmt_ {\n                   id:id,\n                   span:span,"}, {"sha": "78b07a33389e2bca110edd7143e412e503537a4b", "filename": "src/librustc_allocator/expand.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/456493353867832170045cb063aebf22fa8a7201/src%2Flibrustc_allocator%2Fexpand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/456493353867832170045cb063aebf22fa8a7201/src%2Flibrustc_allocator%2Fexpand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_allocator%2Fexpand.rs?ref=456493353867832170045cb063aebf22fa8a7201", "patch": "@@ -79,6 +79,7 @@ impl<'a> Folder for ExpandAllocatorDirectives<'a> {\n                 format: MacroAttribute(Symbol::intern(name)),\n                 span: None,\n                 allow_internal_unstable: true,\n+                allow_internal_unsafe: false,\n             }\n         });\n         let span = Span {"}, {"sha": "7767cf434032af2213236a6732792005478b9bd6", "filename": "src/librustc_lint/builtin.rs", "status": "modified", "additions": 17, "deletions": 8, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/456493353867832170045cb063aebf22fa8a7201/src%2Flibrustc_lint%2Fbuiltin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/456493353867832170045cb063aebf22fa8a7201/src%2Flibrustc_lint%2Fbuiltin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_lint%2Fbuiltin.rs?ref=456493353867832170045cb063aebf22fa8a7201", "patch": "@@ -195,24 +195,35 @@ impl LintPass for UnsafeCode {\n     }\n }\n \n+impl UnsafeCode {\n+    fn report_unsafe(&self, cx: &LateContext, span: Span, desc: &'static str) {\n+        // This comes from a macro that has #[allow_internal_unsafe].\n+        if span.allows_unsafe() {\n+            return;\n+        }\n+\n+        cx.span_lint(UNSAFE_CODE, span, desc);\n+    }\n+}\n+\n impl<'a, 'tcx> LateLintPass<'a, 'tcx> for UnsafeCode {\n     fn check_expr(&mut self, cx: &LateContext, e: &hir::Expr) {\n         if let hir::ExprBlock(ref blk) = e.node {\n             // Don't warn about generated blocks, that'll just pollute the output.\n             if blk.rules == hir::UnsafeBlock(hir::UserProvided) {\n-                cx.span_lint(UNSAFE_CODE, blk.span, \"usage of an `unsafe` block\");\n+                self.report_unsafe(cx, blk.span, \"usage of an `unsafe` block\");\n             }\n         }\n     }\n \n     fn check_item(&mut self, cx: &LateContext, it: &hir::Item) {\n         match it.node {\n             hir::ItemTrait(hir::Unsafety::Unsafe, ..) => {\n-                cx.span_lint(UNSAFE_CODE, it.span, \"declaration of an `unsafe` trait\")\n+                self.report_unsafe(cx, it.span, \"declaration of an `unsafe` trait\")\n             }\n \n             hir::ItemImpl(hir::Unsafety::Unsafe, ..) => {\n-                cx.span_lint(UNSAFE_CODE, it.span, \"implementation of an `unsafe` trait\")\n+                self.report_unsafe(cx, it.span, \"implementation of an `unsafe` trait\")\n             }\n \n             _ => return,\n@@ -228,12 +239,12 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for UnsafeCode {\n                 _: ast::NodeId) {\n         match fk {\n             FnKind::ItemFn(_, _, hir::Unsafety::Unsafe, ..) => {\n-                cx.span_lint(UNSAFE_CODE, span, \"declaration of an `unsafe` function\")\n+                self.report_unsafe(cx, span, \"declaration of an `unsafe` function\")\n             }\n \n             FnKind::Method(_, sig, ..) => {\n                 if sig.unsafety == hir::Unsafety::Unsafe {\n-                    cx.span_lint(UNSAFE_CODE, span, \"implementation of an `unsafe` method\")\n+                    self.report_unsafe(cx, span, \"implementation of an `unsafe` method\")\n                 }\n             }\n \n@@ -244,9 +255,7 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for UnsafeCode {\n     fn check_trait_item(&mut self, cx: &LateContext, item: &hir::TraitItem) {\n         if let hir::TraitItemKind::Method(ref sig, hir::TraitMethod::Required(_)) = item.node {\n             if sig.unsafety == hir::Unsafety::Unsafe {\n-                cx.span_lint(UNSAFE_CODE,\n-                             item.span,\n-                             \"declaration of an `unsafe` method\")\n+                self.report_unsafe(cx, item.span, \"declaration of an `unsafe` method\")\n             }\n         }\n     }"}, {"sha": "34170a6609c4674d4163d594fb230d5e16aa5e75", "filename": "src/librustc_mir/diagnostics.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/456493353867832170045cb063aebf22fa8a7201/src%2Flibrustc_mir%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/456493353867832170045cb063aebf22fa8a7201/src%2Flibrustc_mir%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fdiagnostics.rs?ref=456493353867832170045cb063aebf22fa8a7201", "patch": "@@ -442,4 +442,5 @@ static A : &'static u32 = &S.a; // ok!\n \n register_diagnostics! {\n     E0526, // shuffle indices are not constant\n+    E0625, // thread-local statics cannot be accessed at compile-time\n }"}, {"sha": "2ecffdf9fdf7c034a24f37c645fc87ed9e851c29", "filename": "src/librustc_mir/transform/qualify_consts.rs", "status": "modified", "additions": 19, "deletions": 1, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/456493353867832170045cb063aebf22fa8a7201/src%2Flibrustc_mir%2Ftransform%2Fqualify_consts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/456493353867832170045cb063aebf22fa8a7201/src%2Flibrustc_mir%2Ftransform%2Fqualify_consts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fqualify_consts.rs?ref=456493353867832170045cb063aebf22fa8a7201", "patch": "@@ -484,8 +484,20 @@ impl<'a, 'tcx> Visitor<'tcx> for Qualifier<'a, 'tcx, 'tcx> {\n                     }\n                 }\n             },\n-            Lvalue::Static(_) => {\n+            Lvalue::Static(ref global) => {\n                 self.add(Qualif::STATIC);\n+\n+                if self.mode != Mode::Fn {\n+                    for attr in &self.tcx.get_attrs(global.def_id)[..] {\n+                        if attr.check_name(\"thread_local\") {\n+                            span_err!(self.tcx.sess, self.span, E0625,\n+                                      \"thread-local statics cannot be \\\n+                                       accessed at compile-time\");\n+                            return;\n+                        }\n+                    }\n+                }\n+\n                 if self.mode == Mode::Const || self.mode == Mode::ConstFn {\n                     span_err!(self.tcx.sess, self.span, E0013,\n                               \"{}s cannot refer to statics, use \\\n@@ -998,6 +1010,12 @@ impl MirPass for QualifyAndPromoteConstants {\n \n         // Statics must be Sync.\n         if mode == Mode::Static {\n+            // `#[thread_local]` statics don't have to be `Sync`.\n+            for attr in &tcx.get_attrs(def_id)[..] {\n+                if attr.check_name(\"thread_local\") {\n+                    return;\n+                }\n+            }\n             let ty = mir.return_ty;\n             tcx.infer_ctxt().enter(|infcx| {\n                 let param_env = ty::ParamEnv::empty(Reveal::UserFacing);"}, {"sha": "aac21f2af0d963e4144989873a20dbddc0c1ec57", "filename": "src/librustc_plugin/registry.rs", "status": "modified", "additions": 18, "deletions": 4, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/456493353867832170045cb063aebf22fa8a7201/src%2Flibrustc_plugin%2Fregistry.rs", "raw_url": "https://github.com/rust-lang/rust/raw/456493353867832170045cb063aebf22fa8a7201/src%2Flibrustc_plugin%2Fregistry.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_plugin%2Fregistry.rs?ref=456493353867832170045cb063aebf22fa8a7201", "patch": "@@ -102,9 +102,19 @@ impl<'a> Registry<'a> {\n             panic!(\"user-defined macros may not be named `macro_rules`\");\n         }\n         self.syntax_exts.push((name, match extension {\n-            NormalTT(ext, _, allow_internal_unstable) => {\n+            NormalTT {\n+                expander,\n+                def_info: _,\n+                allow_internal_unstable,\n+                allow_internal_unsafe\n+            } => {\n                 let nid = ast::CRATE_NODE_ID;\n-                NormalTT(ext, Some((nid, self.krate_span)), allow_internal_unstable)\n+                NormalTT {\n+                    expander,\n+                    def_info: Some((nid, self.krate_span)),\n+                    allow_internal_unstable,\n+                    allow_internal_unsafe\n+                }\n             }\n             IdentTT(ext, _, allow_internal_unstable) => {\n                 IdentTT(ext, Some(self.krate_span), allow_internal_unstable)\n@@ -134,8 +144,12 @@ impl<'a> Registry<'a> {\n     /// It builds for you a `NormalTT` that calls `expander`,\n     /// and also takes care of interning the macro's name.\n     pub fn register_macro(&mut self, name: &str, expander: MacroExpanderFn) {\n-        self.register_syntax_extension(Symbol::intern(name),\n-                                       NormalTT(Box::new(expander), None, false));\n+        self.register_syntax_extension(Symbol::intern(name), NormalTT {\n+            expander: Box::new(expander),\n+            def_info: None,\n+            allow_internal_unstable: false,\n+            allow_internal_unsafe: false,\n+        });\n     }\n \n     /// Register a compiler lint pass."}, {"sha": "7572c4aa6802a423ce3d1b3eee1a2d54fed8b0a0", "filename": "src/librustc_resolve/macros.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/456493353867832170045cb063aebf22fa8a7201/src%2Flibrustc_resolve%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/456493353867832170045cb063aebf22fa8a7201/src%2Flibrustc_resolve%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_resolve%2Fmacros.rs?ref=456493353867832170045cb063aebf22fa8a7201", "patch": "@@ -313,7 +313,7 @@ impl<'a> base::Resolver for Resolver<'a> {\n     fn check_unused_macros(&self) {\n         for did in self.unused_macros.iter() {\n             let id_span = match *self.macro_map[did] {\n-                SyntaxExtension::NormalTT(_, isp, _) => isp,\n+                SyntaxExtension::NormalTT { def_info, .. } => def_info,\n                 SyntaxExtension::DeclMacro(.., osp) => osp,\n                 _ => None,\n             };"}, {"sha": "f95fc8a1b1a4515ff9fe9f28603b7a785b26a6d2", "filename": "src/libstd/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/456493353867832170045cb063aebf22fa8a7201/src%2Flibstd%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/456493353867832170045cb063aebf22fa8a7201/src%2Flibstd%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Flib.rs?ref=456493353867832170045cb063aebf22fa8a7201", "patch": "@@ -243,6 +243,7 @@\n #![feature(allocator_api)]\n #![feature(alloc_system)]\n #![feature(allocator_internals)]\n+#![feature(allow_internal_unsafe)]\n #![feature(allow_internal_unstable)]\n #![feature(asm)]\n #![feature(box_syntax)]"}, {"sha": "48f611a343941bb336300c56d0cd463acfffe2ad", "filename": "src/libstd/thread/local.rs", "status": "modified", "additions": 31, "deletions": 31, "changes": 62, "blob_url": "https://github.com/rust-lang/rust/blob/456493353867832170045cb063aebf22fa8a7201/src%2Flibstd%2Fthread%2Flocal.rs", "raw_url": "https://github.com/rust-lang/rust/raw/456493353867832170045cb063aebf22fa8a7201/src%2Flibstd%2Fthread%2Flocal.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fthread%2Flocal.rs?ref=456493353867832170045cb063aebf22fa8a7201", "patch": "@@ -91,13 +91,13 @@ pub struct LocalKey<T: 'static> {\n     //\n     // Note that the thunk is itself unsafe because the returned lifetime of the\n     // slot where data lives, `'static`, is not actually valid. The lifetime\n-    // here is actually `'thread`!\n+    // here is actually slightly shorter than the currently running thread!\n     //\n     // Although this is an extra layer of indirection, it should in theory be\n     // trivially devirtualizable by LLVM because the value of `inner` never\n     // changes and the constant should be readonly within a crate. This mainly\n     // only runs into problems when TLS statics are exported across crates.\n-    inner: fn() -> Option<&'static UnsafeCell<Option<T>>>,\n+    inner: unsafe fn() -> Option<&'static UnsafeCell<Option<T>>>,\n \n     // initialization routine to invoke to create a value\n     init: fn() -> T,\n@@ -157,12 +157,13 @@ macro_rules! thread_local {\n            issue = \"0\")]\n #[macro_export]\n #[allow_internal_unstable]\n+#[cfg_attr(not(stage0), allow_internal_unsafe)]\n macro_rules! __thread_local_inner {\n     ($(#[$attr:meta])* $vis:vis $name:ident, $t:ty, $init:expr) => {\n         $(#[$attr])* $vis static $name: $crate::thread::LocalKey<$t> = {\n             fn __init() -> $t { $init }\n \n-            fn __getit() -> $crate::option::Option<\n+            unsafe fn __getit() -> $crate::option::Option<\n                 &'static $crate::cell::UnsafeCell<\n                     $crate::option::Option<$t>>>\n             {\n@@ -178,7 +179,9 @@ macro_rules! __thread_local_inner {\n                 __KEY.get()\n             }\n \n-            $crate::thread::LocalKey::new(__getit, __init)\n+            unsafe {\n+                $crate::thread::LocalKey::new(__getit, __init)\n+            }\n         };\n     }\n }\n@@ -252,8 +255,8 @@ impl<T: 'static> LocalKey<T> {\n     #[unstable(feature = \"thread_local_internals\",\n                reason = \"recently added to create a key\",\n                issue = \"0\")]\n-    pub const fn new(inner: fn() -> Option<&'static UnsafeCell<Option<T>>>,\n-                     init: fn() -> T) -> LocalKey<T> {\n+    pub const unsafe fn new(inner: unsafe fn() -> Option<&'static UnsafeCell<Option<T>>>,\n+                            init: fn() -> T) -> LocalKey<T> {\n         LocalKey {\n             inner: inner,\n             init: init,\n@@ -391,6 +394,7 @@ pub mod fast {\n         }\n     }\n \n+    #[cfg(stage0)]\n     unsafe impl<T> ::marker::Sync for Key<T> { }\n \n     impl<T> Key<T> {\n@@ -402,14 +406,12 @@ pub mod fast {\n             }\n         }\n \n-        pub fn get(&'static self) -> Option<&'static UnsafeCell<Option<T>>> {\n-            unsafe {\n-                if mem::needs_drop::<T>() && self.dtor_running.get() {\n-                    return None\n-                }\n-                self.register_dtor();\n+        pub unsafe fn get(&self) -> Option<&'static UnsafeCell<Option<T>>> {\n+            if mem::needs_drop::<T>() && self.dtor_running.get() {\n+                return None\n             }\n-            Some(&self.inner)\n+            self.register_dtor();\n+            Some(&*(&self.inner as *const _))\n         }\n \n         unsafe fn register_dtor(&self) {\n@@ -478,26 +480,24 @@ pub mod os {\n             }\n         }\n \n-        pub fn get(&'static self) -> Option<&'static UnsafeCell<Option<T>>> {\n-            unsafe {\n-                let ptr = self.os.get() as *mut Value<T>;\n-                if !ptr.is_null() {\n-                    if ptr as usize == 1 {\n-                        return None\n-                    }\n-                    return Some(&(*ptr).value);\n+        pub unsafe fn get(&'static self) -> Option<&'static UnsafeCell<Option<T>>> {\n+            let ptr = self.os.get() as *mut Value<T>;\n+            if !ptr.is_null() {\n+                if ptr as usize == 1 {\n+                    return None\n                 }\n-\n-                // If the lookup returned null, we haven't initialized our own\n-                // local copy, so do that now.\n-                let ptr: Box<Value<T>> = box Value {\n-                    key: self,\n-                    value: UnsafeCell::new(None),\n-                };\n-                let ptr = Box::into_raw(ptr);\n-                self.os.set(ptr as *mut u8);\n-                Some(&(*ptr).value)\n+                return Some(&(*ptr).value);\n             }\n+\n+            // If the lookup returned null, we haven't initialized our own\n+            // local copy, so do that now.\n+            let ptr: Box<Value<T>> = box Value {\n+                key: self,\n+                value: UnsafeCell::new(None),\n+            };\n+            let ptr = Box::into_raw(ptr);\n+            self.os.set(ptr as *mut u8);\n+            Some(&(*ptr).value)\n         }\n     }\n "}, {"sha": "72b2552f64fc662295fc1108d21c04b89a98b4af", "filename": "src/libsyntax/ext/base.rs", "status": "modified", "additions": 11, "deletions": 5, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/456493353867832170045cb063aebf22fa8a7201/src%2Flibsyntax%2Fext%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/456493353867832170045cb063aebf22fa8a7201/src%2Flibsyntax%2Fext%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fbase.rs?ref=456493353867832170045cb063aebf22fa8a7201", "patch": "@@ -532,10 +532,16 @@ pub enum SyntaxExtension {\n     /// A normal, function-like syntax extension.\n     ///\n     /// `bytes!` is a `NormalTT`.\n-    ///\n-    /// The `bool` dictates whether the contents of the macro can\n-    /// directly use `#[unstable]` things (true == yes).\n-    NormalTT(Box<TTMacroExpander>, Option<(ast::NodeId, Span)>, bool),\n+    NormalTT {\n+        expander: Box<TTMacroExpander>,\n+        def_info: Option<(ast::NodeId, Span)>,\n+        /// Whether the contents of the macro can\n+        /// directly use `#[unstable]` things (true == yes).\n+        allow_internal_unstable: bool,\n+        /// Whether the contents of the macro can use `unsafe`\n+        /// without triggering the `unsafe_code` lint.\n+        allow_internal_unsafe: bool,\n+    },\n \n     /// A function-like syntax extension that has an extra ident before\n     /// the block.\n@@ -562,7 +568,7 @@ impl SyntaxExtension {\n     pub fn kind(&self) -> MacroKind {\n         match *self {\n             SyntaxExtension::DeclMacro(..) |\n-            SyntaxExtension::NormalTT(..) |\n+            SyntaxExtension::NormalTT { .. } |\n             SyntaxExtension::IdentTT(..) |\n             SyntaxExtension::ProcMacro(..) =>\n                 MacroKind::Bang,"}, {"sha": "38715f7275de5add9d39a947fa4a95dacb9b4dcb", "filename": "src/libsyntax/ext/derive.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/456493353867832170045cb063aebf22fa8a7201/src%2Flibsyntax%2Fext%2Fderive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/456493353867832170045cb063aebf22fa8a7201/src%2Flibsyntax%2Fext%2Fderive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fderive.rs?ref=456493353867832170045cb063aebf22fa8a7201", "patch": "@@ -64,6 +64,7 @@ pub fn add_derived_markers<T>(cx: &mut ExtCtxt, span: Span, traits: &[ast::Path]\n             format: ExpnFormat::MacroAttribute(Symbol::intern(&pretty_name)),\n             span: None,\n             allow_internal_unstable: true,\n+            allow_internal_unsafe: false,\n         },\n     });\n "}, {"sha": "9625602fa4a5a02bcdf96b1101ef922d648a2ff5", "filename": "src/libsyntax/ext/expand.rs", "status": "modified", "additions": 20, "deletions": 7, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/456493353867832170045cb063aebf22fa8a7201/src%2Flibsyntax%2Fext%2Fexpand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/456493353867832170045cb063aebf22fa8a7201/src%2Flibsyntax%2Fext%2Fexpand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fexpand.rs?ref=456493353867832170045cb063aebf22fa8a7201", "patch": "@@ -411,6 +411,7 @@ impl<'a, 'b> MacroExpander<'a, 'b> {\n                 format: MacroAttribute(Symbol::intern(&format!(\"{}\", attr.path))),\n                 span: None,\n                 allow_internal_unstable: false,\n+                allow_internal_unsafe: false,\n             }\n         });\n \n@@ -458,7 +459,9 @@ impl<'a, 'b> MacroExpander<'a, 'b> {\n         let path = &mac.node.path;\n \n         let ident = ident.unwrap_or_else(|| keywords::Invalid.ident());\n-        let validate_and_set_expn_info = |def_site_span, allow_internal_unstable| {\n+        let validate_and_set_expn_info = |def_site_span,\n+                                          allow_internal_unstable,\n+                                          allow_internal_unsafe| {\n             if ident.name != keywords::Invalid.name() {\n                 return Err(format!(\"macro {}! expects no ident argument, given '{}'\", path, ident));\n             }\n@@ -467,7 +470,8 @@ impl<'a, 'b> MacroExpander<'a, 'b> {\n                 callee: NameAndSpan {\n                     format: MacroBang(Symbol::intern(&format!(\"{}\", path))),\n                     span: def_site_span,\n-                    allow_internal_unstable: allow_internal_unstable,\n+                    allow_internal_unstable,\n+                    allow_internal_unsafe,\n                 },\n             });\n             Ok(())\n@@ -476,20 +480,26 @@ impl<'a, 'b> MacroExpander<'a, 'b> {\n         let opt_expanded = match *ext {\n             DeclMacro(ref expand, def_span) => {\n                 if let Err(msg) = validate_and_set_expn_info(def_span.map(|(_, s)| s),\n-                                                             false) {\n+                                                             false, false) {\n                     self.cx.span_err(path.span, &msg);\n                     return kind.dummy(span);\n                 }\n                 kind.make_from(expand.expand(self.cx, span, mac.node.stream()))\n             }\n \n-            NormalTT(ref expandfun, def_info, allow_internal_unstable) => {\n+            NormalTT {\n+                ref expander,\n+                def_info,\n+                allow_internal_unstable,\n+                allow_internal_unsafe\n+            } => {\n                 if let Err(msg) = validate_and_set_expn_info(def_info.map(|(_, s)| s),\n-                                                             allow_internal_unstable) {\n+                                                             allow_internal_unstable,\n+                                                             allow_internal_unsafe) {\n                     self.cx.span_err(path.span, &msg);\n                     return kind.dummy(span);\n                 }\n-                kind.make_from(expandfun.expand(self.cx, span, mac.node.stream()))\n+                kind.make_from(expander.expand(self.cx, span, mac.node.stream()))\n             }\n \n             IdentTT(ref expander, tt_span, allow_internal_unstable) => {\n@@ -504,7 +514,8 @@ impl<'a, 'b> MacroExpander<'a, 'b> {\n                     callee: NameAndSpan {\n                         format: MacroBang(Symbol::intern(&format!(\"{}\", path))),\n                         span: tt_span,\n-                        allow_internal_unstable: allow_internal_unstable,\n+                        allow_internal_unstable,\n+                        allow_internal_unsafe: false,\n                     }\n                 });\n \n@@ -540,6 +551,7 @@ impl<'a, 'b> MacroExpander<'a, 'b> {\n                         span: None,\n                         // FIXME probably want to follow macro_rules macros here.\n                         allow_internal_unstable: false,\n+                        allow_internal_unsafe: false,\n                     },\n                 });\n \n@@ -578,6 +590,7 @@ impl<'a, 'b> MacroExpander<'a, 'b> {\n                 format: MacroAttribute(pretty_name),\n                 span: None,\n                 allow_internal_unstable: false,\n+                allow_internal_unsafe: false,\n             }\n         };\n "}, {"sha": "7b3fe2bd993a9a6941232d00505a3cb4df39d448", "filename": "src/libsyntax/ext/tt/macro_rules.rs", "status": "modified", "additions": 9, "deletions": 3, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/456493353867832170045cb063aebf22fa8a7201/src%2Flibsyntax%2Fext%2Ftt%2Fmacro_rules.rs", "raw_url": "https://github.com/rust-lang/rust/raw/456493353867832170045cb063aebf22fa8a7201/src%2Flibsyntax%2Fext%2Ftt%2Fmacro_rules.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Ftt%2Fmacro_rules.rs?ref=456493353867832170045cb063aebf22fa8a7201", "patch": "@@ -269,7 +269,7 @@ pub fn compile(sess: &ParseSess, features: &RefCell<Features>, def: &ast::Item)\n         valid &= check_lhs_no_empty_seq(sess, &[lhs.clone()])\n     }\n \n-    let exp: Box<_> = Box::new(MacroRulesMacroExpander {\n+    let expander: Box<_> = Box::new(MacroRulesMacroExpander {\n         name: def.ident,\n         lhses: lhses,\n         rhses: rhses,\n@@ -278,9 +278,15 @@ pub fn compile(sess: &ParseSess, features: &RefCell<Features>, def: &ast::Item)\n \n     if body.legacy {\n         let allow_internal_unstable = attr::contains_name(&def.attrs, \"allow_internal_unstable\");\n-        NormalTT(exp, Some((def.id, def.span)), allow_internal_unstable)\n+        let allow_internal_unsafe = attr::contains_name(&def.attrs, \"allow_internal_unsafe\");\n+        NormalTT {\n+            expander,\n+            def_info: Some((def.id, def.span)),\n+            allow_internal_unstable,\n+            allow_internal_unsafe\n+        }\n     } else {\n-        SyntaxExtension::DeclMacro(exp, Some((def.id, def.span)))\n+        SyntaxExtension::DeclMacro(expander, Some((def.id, def.span)))\n     }\n }\n "}, {"sha": "46ee126b9d90132302dd4611736465b0d871c994", "filename": "src/libsyntax/feature_gate.rs", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/456493353867832170045cb063aebf22fa8a7201/src%2Flibsyntax%2Ffeature_gate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/456493353867832170045cb063aebf22fa8a7201/src%2Flibsyntax%2Ffeature_gate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Ffeature_gate.rs?ref=456493353867832170045cb063aebf22fa8a7201", "patch": "@@ -194,6 +194,14 @@ declare_features! (\n     // rustc internal\n     (active, allow_internal_unstable, \"1.0.0\", None),\n \n+    // Allows the use of #[allow_internal_unsafe]. This is an\n+    // attribute on macro_rules! and can't use the attribute handling\n+    // below (it has to be checked before expansion possibly makes\n+    // macros disappear).\n+    //\n+    // rustc internal\n+    (active, allow_internal_unsafe, \"1.0.0\", None),\n+\n     // #23121. Array patterns have some hazards yet.\n     (active, slice_patterns, \"1.0.0\", Some(23121)),\n \n@@ -735,6 +743,11 @@ pub const BUILTIN_ATTRIBUTES: &'static [(&'static str, AttributeType, AttributeG\n                                               EXPLAIN_ALLOW_INTERNAL_UNSTABLE,\n                                               cfg_fn!(allow_internal_unstable))),\n \n+    (\"allow_internal_unsafe\", Normal, Gated(Stability::Unstable,\n+                                            \"allow_internal_unsafe\",\n+                                            EXPLAIN_ALLOW_INTERNAL_UNSAFE,\n+                                            cfg_fn!(allow_internal_unsafe))),\n+\n     (\"fundamental\", Whitelisted, Gated(Stability::Unstable,\n                                        \"fundamental\",\n                                        \"the `#[fundamental]` attribute \\\n@@ -1045,6 +1058,8 @@ pub const EXPLAIN_TRACE_MACROS: &'static str =\n     \"`trace_macros` is not stable enough for use and is subject to change\";\n pub const EXPLAIN_ALLOW_INTERNAL_UNSTABLE: &'static str =\n     \"allow_internal_unstable side-steps feature gating and stability checks\";\n+pub const EXPLAIN_ALLOW_INTERNAL_UNSAFE: &'static str =\n+    \"allow_internal_unsafe side-steps the unsafe_code lint\";\n \n pub const EXPLAIN_CUSTOM_DERIVE: &'static str =\n     \"`#[derive]` for custom traits is deprecated and will be removed in the future.\";"}, {"sha": "430976e7d3ce4e98a29b25a0185a29daa6b03005", "filename": "src/libsyntax/std_inject.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/456493353867832170045cb063aebf22fa8a7201/src%2Flibsyntax%2Fstd_inject.rs", "raw_url": "https://github.com/rust-lang/rust/raw/456493353867832170045cb063aebf22fa8a7201/src%2Flibsyntax%2Fstd_inject.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fstd_inject.rs?ref=456493353867832170045cb063aebf22fa8a7201", "patch": "@@ -28,6 +28,7 @@ fn ignored_span(sp: Span) -> Span {\n             format: MacroAttribute(Symbol::intern(\"std_inject\")),\n             span: None,\n             allow_internal_unstable: true,\n+            allow_internal_unsafe: false,\n         }\n     });\n     Span { ctxt: SyntaxContext::empty().apply_mark(mark), ..sp }"}, {"sha": "c05e166e01331ef8a875bc12f3aec414f9ccc033", "filename": "src/libsyntax/test.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/456493353867832170045cb063aebf22fa8a7201/src%2Flibsyntax%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/456493353867832170045cb063aebf22fa8a7201/src%2Flibsyntax%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Ftest.rs?ref=456493353867832170045cb063aebf22fa8a7201", "patch": "@@ -291,6 +291,7 @@ fn generate_test_harness(sess: &ParseSess,\n             format: MacroAttribute(Symbol::intern(\"test\")),\n             span: None,\n             allow_internal_unstable: true,\n+            allow_internal_unsafe: false,\n         }\n     });\n "}, {"sha": "439538a8b5ee311305babf8a9b5fb569df77bbb8", "filename": "src/libsyntax_ext/lib.rs", "status": "modified", "additions": 12, "deletions": 2, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/456493353867832170045cb063aebf22fa8a7201/src%2Flibsyntax_ext%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/456493353867832170045cb063aebf22fa8a7201/src%2Flibsyntax_ext%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax_ext%2Flib.rs?ref=456493353867832170045cb063aebf22fa8a7201", "patch": "@@ -64,7 +64,12 @@ pub fn register_builtins(resolver: &mut syntax::ext::base::Resolver,\n     macro_rules! register {\n         ($( $name:ident: $f:expr, )*) => { $(\n             register(Symbol::intern(stringify!($name)),\n-                     NormalTT(Box::new($f as MacroExpanderFn), None, false));\n+                     NormalTT {\n+                        expander: Box::new($f as MacroExpanderFn),\n+                        def_info: None,\n+                        allow_internal_unstable: false,\n+                        allow_internal_unsafe: false,\n+                    });\n         )* }\n     }\n \n@@ -112,7 +117,12 @@ pub fn register_builtins(resolver: &mut syntax::ext::base::Resolver,\n \n     // format_args uses `unstable` things internally.\n     register(Symbol::intern(\"format_args\"),\n-             NormalTT(Box::new(format::expand_format_args), None, true));\n+             NormalTT {\n+                expander: Box::new(format::expand_format_args),\n+                def_info: None,\n+                allow_internal_unstable: true,\n+                allow_internal_unsafe: false,\n+            });\n \n     for (name, ext) in user_exts {\n         register(name, ext);"}, {"sha": "700386f68fee047e6b57a5f7fcf806fd6090fa0f", "filename": "src/libsyntax_ext/proc_macro_registrar.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/456493353867832170045cb063aebf22fa8a7201/src%2Flibsyntax_ext%2Fproc_macro_registrar.rs", "raw_url": "https://github.com/rust-lang/rust/raw/456493353867832170045cb063aebf22fa8a7201/src%2Flibsyntax_ext%2Fproc_macro_registrar.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax_ext%2Fproc_macro_registrar.rs?ref=456493353867832170045cb063aebf22fa8a7201", "patch": "@@ -368,6 +368,7 @@ fn mk_registrar(cx: &mut ExtCtxt,\n             format: MacroAttribute(Symbol::intern(\"proc_macro\")),\n             span: None,\n             allow_internal_unstable: true,\n+            allow_internal_unsafe: false,\n         }\n     });\n     let span = Span { ctxt: SyntaxContext::empty().apply_mark(mark), ..DUMMY_SP };"}, {"sha": "514cc26666e39444d130fb56f3b4d9738b462ed7", "filename": "src/libsyntax_pos/hygiene.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/456493353867832170045cb063aebf22fa8a7201/src%2Flibsyntax_pos%2Fhygiene.rs", "raw_url": "https://github.com/rust-lang/rust/raw/456493353867832170045cb063aebf22fa8a7201/src%2Flibsyntax_pos%2Fhygiene.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax_pos%2Fhygiene.rs?ref=456493353867832170045cb063aebf22fa8a7201", "patch": "@@ -310,6 +310,9 @@ pub struct NameAndSpan {\n     /// features internally without forcing the whole crate to opt-in\n     /// to them.\n     pub allow_internal_unstable: bool,\n+    /// Whether the macro is allowed to use `unsafe` internally\n+    /// even if the user crate has `#![forbid(unsafe_code)]`.\n+    pub allow_internal_unsafe: bool,\n     /// The span of the macro definition itself. The macro may not\n     /// have a sensible definition span (e.g. something defined\n     /// completely inside libsyntax) in which case this is None."}, {"sha": "e162bc26412f2c9f8e61a8c326d1eeae8bcf0a21", "filename": "src/libsyntax_pos/lib.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/456493353867832170045cb063aebf22fa8a7201/src%2Flibsyntax_pos%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/456493353867832170045cb063aebf22fa8a7201/src%2Flibsyntax_pos%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax_pos%2Flib.rs?ref=456493353867832170045cb063aebf22fa8a7201", "patch": "@@ -153,6 +153,16 @@ impl Span {\n         }\n     }\n \n+    /// Check if a span is \"internal\" to a macro in which `unsafe`\n+    /// can be used without triggering the `unsafe_code` lint\n+    //  (that is, a macro marked with `#[allow_internal_unsafe]`).\n+    pub fn allows_unsafe(&self) -> bool {\n+        match self.ctxt.outer().expn_info() {\n+            Some(info) => info.callee.allow_internal_unsafe,\n+            None => false,\n+        }\n+    }\n+\n     pub fn macro_backtrace(mut self) -> Vec<MacroBacktrace> {\n         let mut prev_span = DUMMY_SP;\n         let mut result = vec![];"}, {"sha": "590dc619f2f1aa3bc32f110f964cc82ba8dee167", "filename": "src/test/compile-fail/feature-gate-allow-internal-unsafe-nested-macro.rs", "status": "added", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/456493353867832170045cb063aebf22fa8a7201/src%2Ftest%2Fcompile-fail%2Ffeature-gate-allow-internal-unsafe-nested-macro.rs", "raw_url": "https://github.com/rust-lang/rust/raw/456493353867832170045cb063aebf22fa8a7201/src%2Ftest%2Fcompile-fail%2Ffeature-gate-allow-internal-unsafe-nested-macro.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Ffeature-gate-allow-internal-unsafe-nested-macro.rs?ref=456493353867832170045cb063aebf22fa8a7201", "patch": "@@ -0,0 +1,27 @@\n+// Copyright 2017 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// gate-test-allow_internal_unsafe\n+\n+#![allow(unused_macros)]\n+\n+macro_rules! bar {\n+    () => {\n+        // more layers don't help:\n+        #[allow_internal_unsafe] //~ ERROR allow_internal_unsafe side-steps\n+        macro_rules! baz {\n+            () => {}\n+        }\n+    }\n+}\n+\n+bar!();\n+\n+fn main() {}"}, {"sha": "4befe3ebc865ab73d401dfb1467e35aaf5f9e907", "filename": "src/test/compile-fail/issue-17954.rs", "status": "added", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/456493353867832170045cb063aebf22fa8a7201/src%2Ftest%2Fcompile-fail%2Fissue-17954.rs", "raw_url": "https://github.com/rust-lang/rust/raw/456493353867832170045cb063aebf22fa8a7201/src%2Ftest%2Fcompile-fail%2Fissue-17954.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fissue-17954.rs?ref=456493353867832170045cb063aebf22fa8a7201", "patch": "@@ -0,0 +1,25 @@\n+// Copyright 2017 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![feature(thread_local)]\n+\n+#[thread_local]\n+static FOO: u8 = 3;\n+\n+fn main() {\n+    let a = &FOO;\n+    //~^ ERROR borrowed value does not live long enough\n+    //~| does not live long enough\n+    //~| NOTE borrowed value must be valid for the static lifetime\n+\n+    std::thread::spawn(move || {\n+        println!(\"{}\", a);\n+    });\n+} //~ temporary value only lives until here"}, {"sha": "3dff34c2ebb1280f88565a202dff0213b9caaab9", "filename": "src/test/compile-fail/issue-43733-2.rs", "status": "added", "additions": 39, "deletions": 0, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/456493353867832170045cb063aebf22fa8a7201/src%2Ftest%2Fcompile-fail%2Fissue-43733-2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/456493353867832170045cb063aebf22fa8a7201/src%2Ftest%2Fcompile-fail%2Fissue-43733-2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fissue-43733-2.rs?ref=456493353867832170045cb063aebf22fa8a7201", "patch": "@@ -0,0 +1,39 @@\n+// Copyright 2017 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![feature(const_fn, drop_types_in_const)]\n+#![feature(cfg_target_thread_local, thread_local_internals)]\n+\n+// On platforms *without* `#[thread_local]`, use\n+// a custom non-`Sync` type to fake the same error.\n+#[cfg(not(target_thread_local))]\n+struct Key<T> {\n+    _data: std::cell::UnsafeCell<Option<T>>,\n+    _flag: std::cell::Cell<bool>,\n+}\n+\n+#[cfg(not(target_thread_local))]\n+impl<T> Key<T> {\n+    const fn new() -> Self {\n+        Key {\n+            _data: std::cell::UnsafeCell::new(None),\n+            _flag: std::cell::Cell::new(false),\n+        }\n+    }\n+}\n+\n+#[cfg(target_thread_local)]\n+use std::thread::__FastLocalKeyInner as Key;\n+\n+static __KEY: Key<()> = Key::new();\n+//~^ ERROR `std::cell::UnsafeCell<std::option::Option<()>>: std::marker::Sync` is not satisfied\n+//~| ERROR `std::cell::Cell<bool>: std::marker::Sync` is not satisfied\n+\n+fn main() {}"}, {"sha": "a4aad21a9f8325c659855bad3f93b90f6bf409c5", "filename": "src/test/compile-fail/issue-43733.rs", "status": "added", "additions": 41, "deletions": 0, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/456493353867832170045cb063aebf22fa8a7201/src%2Ftest%2Fcompile-fail%2Fissue-43733.rs", "raw_url": "https://github.com/rust-lang/rust/raw/456493353867832170045cb063aebf22fa8a7201/src%2Ftest%2Fcompile-fail%2Fissue-43733.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fissue-43733.rs?ref=456493353867832170045cb063aebf22fa8a7201", "patch": "@@ -0,0 +1,41 @@\n+// Copyright 2017 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![feature(const_fn, drop_types_in_const)]\n+#![feature(cfg_target_thread_local, thread_local_internals)]\n+\n+type Foo = std::cell::RefCell<String>;\n+\n+#[cfg(target_thread_local)]\n+static __KEY: std::thread::__FastLocalKeyInner<Foo> =\n+    std::thread::__FastLocalKeyInner::new();\n+\n+#[cfg(not(target_thread_local))]\n+static __KEY: std::thread::__OsLocalKeyInner<Foo> =\n+    std::thread::__OsLocalKeyInner::new();\n+\n+fn __getit() -> std::option::Option<\n+    &'static std::cell::UnsafeCell<\n+        std::option::Option<Foo>>>\n+{\n+    __KEY.get() //~ ERROR  invocation of unsafe method requires unsafe\n+}\n+\n+static FOO: std::thread::LocalKey<Foo> =\n+    std::thread::LocalKey::new(__getit, Default::default);\n+//~^ ERROR call to unsafe function requires unsafe\n+\n+fn main() {\n+    FOO.with(|foo| println!(\"{}\", foo.borrow()));\n+    std::thread::spawn(|| {\n+        FOO.with(|foo| *foo.borrow_mut() += \"foo\");\n+    }).join().unwrap();\n+    FOO.with(|foo| println!(\"{}\", foo.borrow()));\n+}"}, {"sha": "720e15991c05988c4284dcb13a1c74be159f5b6b", "filename": "src/test/compile-fail/thread-local-in-ctfe.rs", "status": "added", "additions": 38, "deletions": 0, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/456493353867832170045cb063aebf22fa8a7201/src%2Ftest%2Fcompile-fail%2Fthread-local-in-ctfe.rs", "raw_url": "https://github.com/rust-lang/rust/raw/456493353867832170045cb063aebf22fa8a7201/src%2Ftest%2Fcompile-fail%2Fthread-local-in-ctfe.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fthread-local-in-ctfe.rs?ref=456493353867832170045cb063aebf22fa8a7201", "patch": "@@ -0,0 +1,38 @@\n+// Copyright 2017 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![feature(const_fn, thread_local)]\n+\n+#[thread_local]\n+static A: u32 = 1;\n+\n+static B: u32 = A;\n+//~^ ERROR thread-local statics cannot be accessed at compile-time\n+//~| ERROR cannot refer to other statics by value\n+//~| WARN non-constant path in constant expression\n+\n+static C: &u32 = &A;\n+//~^ ERROR thread-local statics cannot be accessed at compile-time\n+\n+const D: u32 = A;\n+//~^ ERROR thread-local statics cannot be accessed at compile-time\n+//~| ERROR cannot refer to statics by value\n+//~| WARN non-constant path in constant expression\n+\n+const E: &u32 = &A;\n+//~^ ERROR thread-local statics cannot be accessed at compile-time\n+\n+const fn f() -> u32 {\n+    A\n+    //~^ ERROR thread-local statics cannot be accessed at compile-time\n+    //~| ERROR cannot refer to statics by value\n+}\n+\n+fn main() {}"}, {"sha": "8da2ae8b29abe48dbb00b44ff555709b74c67453", "filename": "src/test/run-pass-fulldeps/auxiliary/plugin_args.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/456493353867832170045cb063aebf22fa8a7201/src%2Ftest%2Frun-pass-fulldeps%2Fauxiliary%2Fplugin_args.rs", "raw_url": "https://github.com/rust-lang/rust/raw/456493353867832170045cb063aebf22fa8a7201/src%2Ftest%2Frun-pass-fulldeps%2Fauxiliary%2Fplugin_args.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass-fulldeps%2Fauxiliary%2Fplugin_args.rs?ref=456493353867832170045cb063aebf22fa8a7201", "patch": "@@ -48,5 +48,10 @@ impl TTMacroExpander for Expander {\n pub fn plugin_registrar(reg: &mut Registry) {\n     let args = reg.args().to_owned();\n     reg.register_syntax_extension(Symbol::intern(\"plugin_args\"),\n-        NormalTT(Box::new(Expander { args: args, }), None, false));\n+        NormalTT {\n+            expander: Box::new(Expander { args: args, }),\n+            def_info: None,\n+            allow_internal_unstable: false,\n+            allow_internal_unsafe: false,\n+        });\n }"}, {"sha": "e9457886be80d890a5e8287823777ab2508e1ed9", "filename": "src/test/run-pass/auxiliary/thread-local-extern-static.rs", "status": "modified", "additions": 7, "deletions": 4, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/456493353867832170045cb063aebf22fa8a7201/src%2Ftest%2Frun-pass%2Fauxiliary%2Fthread-local-extern-static.rs", "raw_url": "https://github.com/rust-lang/rust/raw/456493353867832170045cb063aebf22fa8a7201/src%2Ftest%2Frun-pass%2Fauxiliary%2Fthread-local-extern-static.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fauxiliary%2Fthread-local-extern-static.rs?ref=456493353867832170045cb063aebf22fa8a7201", "patch": "@@ -8,10 +8,13 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n-#![feature(thread_local)]\n-#![feature(cfg_target_thread_local)]\n+#![feature(cfg_target_thread_local, const_fn, thread_local)]\n #![crate_type = \"lib\"]\n \n+#[cfg(target_thread_local)]\n+use std::cell::Cell;\n+\n #[no_mangle]\n-#[cfg_attr(target_thread_local, thread_local)]\n-pub static FOO: u32 = 3;\n+#[cfg(target_thread_local)]\n+#[thread_local]\n+pub static FOO: Cell<u32> = Cell::new(3);"}, {"sha": "621607e5f6fa8ba99117ef4906d54702c9fed61e", "filename": "src/test/run-pass/issue-30756.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/456493353867832170045cb063aebf22fa8a7201/src%2Ftest%2Frun-pass%2Fissue-30756.rs", "raw_url": "https://github.com/rust-lang/rust/raw/456493353867832170045cb063aebf22fa8a7201/src%2Ftest%2Frun-pass%2Fissue-30756.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fissue-30756.rs?ref=456493353867832170045cb063aebf22fa8a7201", "patch": "@@ -8,7 +8,7 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n-#![deny(unsafe_code)]\n+#![forbid(unsafe_code)]\n \n thread_local!(static FOO: u8 = 1);\n "}, {"sha": "09c8b64776c7b9112ba9ca864b8892242de0b218", "filename": "src/test/run-pass/thread-local-extern-static.rs", "status": "modified", "additions": 13, "deletions": 5, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/456493353867832170045cb063aebf22fa8a7201/src%2Ftest%2Frun-pass%2Fthread-local-extern-static.rs", "raw_url": "https://github.com/rust-lang/rust/raw/456493353867832170045cb063aebf22fa8a7201/src%2Ftest%2Frun-pass%2Fthread-local-extern-static.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fthread-local-extern-static.rs?ref=456493353867832170045cb063aebf22fa8a7201", "patch": "@@ -11,18 +11,26 @@\n // ignore-windows\n // aux-build:thread-local-extern-static.rs\n \n-#![feature(thread_local)]\n-#![feature(cfg_target_thread_local)]\n+#![feature(cfg_target_thread_local, thread_local)]\n \n+#[cfg(target_thread_local)]\n extern crate thread_local_extern_static;\n \n+#[cfg(target_thread_local)]\n+use std::cell::Cell;\n+\n+#[cfg(target_thread_local)]\n extern {\n-    #[cfg_attr(target_thread_local, thread_local)]\n-    static FOO: u32;\n+    #[thread_local]\n+    static FOO: Cell<u32>;\n }\n \n+#[cfg(target_thread_local)]\n fn main() {\n     unsafe {\n-        assert_eq!(FOO, 3);\n+        assert_eq!(FOO.get(), 3);\n     }\n }\n+\n+#[cfg(not(target_thread_local))]\n+fn main() {}"}]}