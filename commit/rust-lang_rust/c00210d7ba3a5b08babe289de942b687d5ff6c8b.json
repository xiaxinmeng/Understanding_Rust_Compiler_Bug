{"sha": "c00210d7ba3a5b08babe289de942b687d5ff6c8b", "node_id": "MDY6Q29tbWl0NzI0NzEyOmMwMDIxMGQ3YmEzYTViMDhiYWJlMjg5ZGU5NDJiNjg3ZDVmZjZjOGI=", "commit": {"author": {"name": "Oliver S\u0336c\u0336h\u0336n\u0336e\u0336i\u0336d\u0336e\u0336r Scherer", "email": "github35764891676564198441@oli-obk.de", "date": "2018-12-03T11:42:31Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2018-12-03T11:42:31Z"}, "message": "Merge pull request #3478 from dtolnay/setlen\n\nRemove unsafe_vector_initialization lint", "tree": {"sha": "7e21aa7bae4004e8bfaedc6806040b3325f0c71b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7e21aa7bae4004e8bfaedc6806040b3325f0c71b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c00210d7ba3a5b08babe289de942b687d5ff6c8b", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJcBRanCRBK7hj4Ov3rIwAAdHIIAAkg2tDjngnukRDY0l2puh6x\nr/G+V0mL/sU8pPEPhyf+U6vmRbtn7vnZf/l0MeCpQDntTGCXzeTdTO0qd2Gq/t2h\nP9RFbXL7783ng43RzGphg63Y23HqggJOlkJSc6z9VgiorebaiNA5WqQaBckkcxtd\nqJc+6laX49eJH8NABsfJgUWG6YN3SYvZLaTaQyKneNINMSZspv0EazKJ5By2erF4\nEShCvxUiho/iQCKQyeOj0OK02U8LDgBgDToz2Y4IO56+y7PdqS1S0yFkYjwGFCg9\n1UCBVnbUOi4ZY5XYJ7uxcVwEhvOm15Xndxucc+ht7pna/uzr0Ji9/IPA3PvjMF0=\n=/2w4\n-----END PGP SIGNATURE-----\n", "payload": "tree 7e21aa7bae4004e8bfaedc6806040b3325f0c71b\nparent 13438b6866d8236b0a390ba034f76290ff938152\nparent e632a1946e1f5f943c46719692f6127fe2877747\nauthor Oliver S\u0336c\u0336h\u0336n\u0336e\u0336i\u0336d\u0336e\u0336r Scherer <github35764891676564198441@oli-obk.de> 1543837351 +0100\ncommitter GitHub <noreply@github.com> 1543837351 +0100\n\nMerge pull request #3478 from dtolnay/setlen\n\nRemove unsafe_vector_initialization lint"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c00210d7ba3a5b08babe289de942b687d5ff6c8b", "html_url": "https://github.com/rust-lang/rust/commit/c00210d7ba3a5b08babe289de942b687d5ff6c8b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c00210d7ba3a5b08babe289de942b687d5ff6c8b/comments", "author": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "13438b6866d8236b0a390ba034f76290ff938152", "url": "https://api.github.com/repos/rust-lang/rust/commits/13438b6866d8236b0a390ba034f76290ff938152", "html_url": "https://github.com/rust-lang/rust/commit/13438b6866d8236b0a390ba034f76290ff938152"}, {"sha": "e632a1946e1f5f943c46719692f6127fe2877747", "url": "https://api.github.com/repos/rust-lang/rust/commits/e632a1946e1f5f943c46719692f6127fe2877747", "html_url": "https://github.com/rust-lang/rust/commit/e632a1946e1f5f943c46719692f6127fe2877747"}], "stats": {"total": 136, "additions": 39, "deletions": 97}, "files": [{"sha": "0d83224e3f622cf4faccca24f1392e7311cd7420", "filename": "README.md", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/c00210d7ba3a5b08babe289de942b687d5ff6c8b/README.md", "raw_url": "https://github.com/rust-lang/rust/raw/c00210d7ba3a5b08babe289de942b687d5ff6c8b/README.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/README.md?ref=c00210d7ba3a5b08babe289de942b687d5ff6c8b", "patch": "@@ -7,7 +7,7 @@\n \n A collection of lints to catch common mistakes and improve your [Rust](https://github.com/rust-lang/rust) code.\n \n-[There are 290 lints included in this crate!](https://rust-lang.github.io/rust-clippy/master/index.html)\n+[There are 289 lints included in this crate!](https://rust-lang.github.io/rust-clippy/master/index.html)\n \n We have a bunch of lint categories to allow you to choose how much Clippy is supposed to ~~annoy~~ help you:\n "}, {"sha": "17bef09164b81f090dfa50d0a75fb7232461f90b", "filename": "clippy_lints/src/deprecated_lints.rs", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/c00210d7ba3a5b08babe289de942b687d5ff6c8b/clippy_lints%2Fsrc%2Fdeprecated_lints.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c00210d7ba3a5b08babe289de942b687d5ff6c8b/clippy_lints%2Fsrc%2Fdeprecated_lints.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fdeprecated_lints.rs?ref=c00210d7ba3a5b08babe289de942b687d5ff6c8b", "patch": "@@ -112,3 +112,14 @@ declare_deprecated_lint! {\n     pub IF_LET_REDUNDANT_PATTERN_MATCHING,\n     \"this lint has been changed to redundant_pattern_matching\"\n }\n+\n+/// **What it does:** Nothing. This lint has been deprecated.\n+///\n+/// **Deprecation reason:** This lint used to suggest replacing `let mut vec =\n+/// Vec::with_capacity(n); vec.set_len(n);` with `let vec = vec![0; n];`. The\n+/// replacement has very different performance characteristics so the lint is\n+/// deprecated.\n+declare_deprecated_lint! {\n+    pub UNSAFE_VECTOR_INITIALIZATION,\n+    \"the replacement suggested by this lint had substantially different behavior\"\n+}"}, {"sha": "326bf884e33e6b1da639214577dc14310fe83868", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/c00210d7ba3a5b08babe289de942b687d5ff6c8b/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c00210d7ba3a5b08babe289de942b687d5ff6c8b/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=c00210d7ba3a5b08babe289de942b687d5ff6c8b", "patch": "@@ -330,6 +330,10 @@ pub fn register_plugins(reg: &mut rustc_plugin::Registry<'_>, conf: &Conf) {\n         \"if_let_redundant_pattern_matching\",\n         \"this lint has been changed to redundant_pattern_matching\",\n     );\n+    store.register_removed(\n+        \"unsafe_vector_initialization\",\n+        \"the replacement suggested by this lint had substantially different behavior\",\n+    );\n     // end deprecated lints, do not remove this comment, it\u2019s used in `update_lints`\n \n     reg.register_late_lint_pass(box serde_api::Serde);\n@@ -727,7 +731,6 @@ pub fn register_plugins(reg: &mut rustc_plugin::Registry<'_>, conf: &Conf) {\n         returns::UNUSED_UNIT,\n         serde_api::SERDE_API_MISUSE,\n         slow_vector_initialization::SLOW_VECTOR_INITIALIZATION,\n-        slow_vector_initialization::UNSAFE_VECTOR_INITIALIZATION,\n         strings::STRING_LIT_AS_BYTES,\n         suspicious_trait_impl::SUSPICIOUS_ARITHMETIC_IMPL,\n         suspicious_trait_impl::SUSPICIOUS_OP_ASSIGN_IMPL,\n@@ -973,7 +976,6 @@ pub fn register_plugins(reg: &mut rustc_plugin::Registry<'_>, conf: &Conf) {\n         ranges::ITERATOR_STEP_BY_ZERO,\n         regex::INVALID_REGEX,\n         serde_api::SERDE_API_MISUSE,\n-        slow_vector_initialization::UNSAFE_VECTOR_INITIALIZATION,\n         suspicious_trait_impl::SUSPICIOUS_ARITHMETIC_IMPL,\n         suspicious_trait_impl::SUSPICIOUS_OP_ASSIGN_IMPL,\n         swap::ALMOST_SWAPPED,"}, {"sha": "0ec6fc0d0d16ae17f1104d8acab886ebf9109c03", "filename": "clippy_lints/src/slow_vector_initialization.rs", "status": "modified", "additions": 1, "deletions": 52, "changes": 53, "blob_url": "https://github.com/rust-lang/rust/blob/c00210d7ba3a5b08babe289de942b687d5ff6c8b/clippy_lints%2Fsrc%2Fslow_vector_initialization.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c00210d7ba3a5b08babe289de942b687d5ff6c8b/clippy_lints%2Fsrc%2Fslow_vector_initialization.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fslow_vector_initialization.rs?ref=c00210d7ba3a5b08babe289de942b687d5ff6c8b", "patch": "@@ -39,32 +39,12 @@ declare_clippy_lint! {\n     \"slow vector initialization\"\n }\n \n-/// **What it does:** Checks unsafe vector initialization\n-///\n-/// **Why is this bad?** Changing the length of a vector may expose uninitialized memory, which\n-/// can lead to memory safety issues\n-///\n-/// **Known problems:** None.\n-///\n-/// **Example:**\n-/// ```rust\n-/// let mut vec1 = Vec::with_capacity(len);\n-/// unsafe {\n-///     vec1.set_len(len);\n-/// }\n-/// ```\n-declare_clippy_lint! {\n-    pub UNSAFE_VECTOR_INITIALIZATION,\n-    correctness,\n-    \"unsafe vector initialization\"\n-}\n-\n #[derive(Copy, Clone, Default)]\n pub struct Pass;\n \n impl LintPass for Pass {\n     fn get_lints(&self) -> LintArray {\n-        lint_array!(SLOW_VECTOR_INITIALIZATION, UNSAFE_VECTOR_INITIALIZATION,)\n+        lint_array!(SLOW_VECTOR_INITIALIZATION,)\n     }\n }\n \n@@ -90,9 +70,6 @@ enum InitializationType<'tcx> {\n \n     /// Resize is a slow initialization with the form `vec.resize(.., 0)`\n     Resize(&'tcx Expr),\n-\n-    /// UnsafeSetLen is a slow initialization with the form `vec.set_len(..)`\n-    UnsafeSetLen(&'tcx Expr),\n }\n \n impl<'a, 'tcx> LateLintPass<'a, 'tcx> for Pass {\n@@ -188,14 +165,6 @@ impl Pass {\n         vec_alloc: &VecAllocation<'_>,\n     ) {\n         match initialization {\n-            InitializationType::UnsafeSetLen(e) => Self::emit_lint(\n-                cx,\n-                e,\n-                vec_alloc,\n-                \"unsafe vector initialization\",\n-                UNSAFE_VECTOR_INITIALIZATION,\n-            ),\n-\n             InitializationType::Extend(e) | InitializationType::Resize(e) => Self::emit_lint(\n                 cx,\n                 e,\n@@ -282,25 +251,6 @@ impl<'a, 'tcx> VectorInitializationVisitor<'a, 'tcx> {\n         }\n     }\n \n-    /// Checks if the given expression is using `set_len` to initialize the vector\n-    fn search_unsafe_set_len(&mut self, expr: &'tcx Expr) {\n-        if_chain! {\n-            if self.initialization_found;\n-            if let ExprKind::MethodCall(ref path, _, ref args) = expr.node;\n-            if let ExprKind::Path(ref qpath_subj) = args[0].node;\n-            if match_qpath(&qpath_subj, &[&self.vec_alloc.variable_name.to_string()]);\n-            if path.ident.name == \"set_len\";\n-            if let Some(ref len_arg) = args.get(1);\n-\n-            // Check that len expression is equals to `with_capacity` expression\n-            if SpanlessEq::new(self.cx).eq_expr(len_arg, self.vec_alloc.len_expr);\n-\n-            then {\n-                self.slow_expression = Some(InitializationType::UnsafeSetLen(expr));\n-            }\n-        }\n-    }\n-\n     /// Returns `true` if give expression is `repeat(0).take(...)`\n     fn is_repeat_take(&self, expr: &Expr) -> bool {\n         if_chain! {\n@@ -349,7 +299,6 @@ impl<'a, 'tcx> Visitor<'tcx> for VectorInitializationVisitor<'a, 'tcx> {\n                 StmtKind::Expr(ref expr, _) | StmtKind::Semi(ref expr, _) => {\n                     self.search_slow_extend_filling(expr);\n                     self.search_slow_resize_filling(expr);\n-                    self.search_unsafe_set_len(expr);\n                 },\n                 _ => (),\n             }"}, {"sha": "5364bf70ff091677bb99e64f04385fb0a08df195", "filename": "tests/ui/slow_vector_initialization.rs", "status": "modified", "additions": 0, "deletions": 9, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/c00210d7ba3a5b08babe289de942b687d5ff6c8b/tests%2Fui%2Fslow_vector_initialization.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c00210d7ba3a5b08babe289de942b687d5ff6c8b/tests%2Fui%2Fslow_vector_initialization.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fslow_vector_initialization.rs?ref=c00210d7ba3a5b08babe289de942b687d5ff6c8b", "patch": "@@ -13,7 +13,6 @@ fn main() {\n     resize_vector();\n     extend_vector();\n     mixed_extend_resize_vector();\n-    unsafe_vector();\n }\n \n fn extend_vector() {\n@@ -63,14 +62,6 @@ fn resize_vector() {\n     vec1.resize(10, 0);\n }\n \n-fn unsafe_vector() {\n-    let mut unsafe_vec: Vec<u8> = Vec::with_capacity(200);\n-\n-    unsafe {\n-        unsafe_vec.set_len(200);\n-    }\n-}\n-\n fn do_stuff(vec: &mut Vec<u8>) {\n \n }"}, {"sha": "f45c3b48b1b4f916698ac2840f8a38c5cb1ef56e", "filename": "tests/ui/slow_vector_initialization.stderr", "status": "modified", "additions": 22, "deletions": 33, "changes": 55, "blob_url": "https://github.com/rust-lang/rust/blob/c00210d7ba3a5b08babe289de942b687d5ff6c8b/tests%2Fui%2Fslow_vector_initialization.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c00210d7ba3a5b08babe289de942b687d5ff6c8b/tests%2Fui%2Fslow_vector_initialization.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fslow_vector_initialization.stderr?ref=c00210d7ba3a5b08babe289de942b687d5ff6c8b", "patch": "@@ -1,71 +1,60 @@\n error: slow zero-filling initialization\n-  --> $DIR/slow_vector_initialization.rs:23:5\n+  --> $DIR/slow_vector_initialization.rs:22:5\n    |\n-22 |     let mut vec1 = Vec::with_capacity(len);\n+21 |     let mut vec1 = Vec::with_capacity(len);\n    |                    ----------------------- help: consider replace allocation with: `vec![0; len]`\n-23 |     vec1.extend(repeat(0).take(len));\n+22 |     vec1.extend(repeat(0).take(len));\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |\n    = note: `-D clippy::slow-vector-initialization` implied by `-D warnings`\n \n error: slow zero-filling initialization\n-  --> $DIR/slow_vector_initialization.rs:27:5\n+  --> $DIR/slow_vector_initialization.rs:26:5\n    |\n-26 |     let mut vec2 = Vec::with_capacity(len - 10);\n+25 |     let mut vec2 = Vec::with_capacity(len - 10);\n    |                    ---------------------------- help: consider replace allocation with: `vec![0; len - 10]`\n-27 |     vec2.extend(repeat(0).take(len - 10));\n+26 |     vec2.extend(repeat(0).take(len - 10));\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n error: slow zero-filling initialization\n-  --> $DIR/slow_vector_initialization.rs:41:5\n+  --> $DIR/slow_vector_initialization.rs:40:5\n    |\n-40 |     let mut resized_vec = Vec::with_capacity(30);\n+39 |     let mut resized_vec = Vec::with_capacity(30);\n    |                           ---------------------- help: consider replace allocation with: `vec![0; 30]`\n-41 |     resized_vec.resize(30, 0);\n+40 |     resized_vec.resize(30, 0);\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^\n \n error: slow zero-filling initialization\n-  --> $DIR/slow_vector_initialization.rs:44:5\n+  --> $DIR/slow_vector_initialization.rs:43:5\n    |\n-43 |     let mut extend_vec = Vec::with_capacity(30);\n+42 |     let mut extend_vec = Vec::with_capacity(30);\n    |                          ---------------------- help: consider replace allocation with: `vec![0; 30]`\n-44 |     extend_vec.extend(repeat(0).take(30));\n+43 |     extend_vec.extend(repeat(0).take(30));\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n error: slow zero-filling initialization\n-  --> $DIR/slow_vector_initialization.rs:51:5\n+  --> $DIR/slow_vector_initialization.rs:50:5\n    |\n-50 |     let mut vec1 = Vec::with_capacity(len);\n+49 |     let mut vec1 = Vec::with_capacity(len);\n    |                    ----------------------- help: consider replace allocation with: `vec![0; len]`\n-51 |     vec1.resize(len, 0);\n+50 |     vec1.resize(len, 0);\n    |     ^^^^^^^^^^^^^^^^^^^\n \n error: slow zero-filling initialization\n-  --> $DIR/slow_vector_initialization.rs:59:5\n+  --> $DIR/slow_vector_initialization.rs:58:5\n    |\n-58 |     let mut vec3 = Vec::with_capacity(len - 10);\n+57 |     let mut vec3 = Vec::with_capacity(len - 10);\n    |                    ---------------------------- help: consider replace allocation with: `vec![0; len - 10]`\n-59 |     vec3.resize(len - 10, 0);\n+58 |     vec3.resize(len - 10, 0);\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^\n \n error: slow zero-filling initialization\n-  --> $DIR/slow_vector_initialization.rs:63:5\n+  --> $DIR/slow_vector_initialization.rs:62:5\n    |\n-62 |     vec1 = Vec::with_capacity(10);\n+61 |     vec1 = Vec::with_capacity(10);\n    |            ---------------------- help: consider replace allocation with: `vec![0; 10]`\n-63 |     vec1.resize(10, 0);\n+62 |     vec1.resize(10, 0);\n    |     ^^^^^^^^^^^^^^^^^^\n \n-error: unsafe vector initialization\n-  --> $DIR/slow_vector_initialization.rs:70:9\n-   |\n-67 |     let mut unsafe_vec: Vec<u8> = Vec::with_capacity(200);\n-   |                                   ----------------------- help: consider replace allocation with: `vec![0; 200]`\n-...\n-70 |         unsafe_vec.set_len(200);\n-   |         ^^^^^^^^^^^^^^^^^^^^^^^\n-   |\n-   = note: #[deny(clippy::unsafe_vector_initialization)] on by default\n-\n-error: aborting due to 8 previous errors\n+error: aborting due to 7 previous errors\n "}]}