{"sha": "ccfe7d889814cce1b24ad34097e0161b3436d30f", "node_id": "C_kwDOAAsO6NoAKGNjZmU3ZDg4OTgxNGNjZTFiMjRhZDM0MDk3ZTAxNjFiMzQzNmQzMGY", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2022-10-14T14:38:09Z"}, "committer": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2022-10-18T14:31:49Z"}, "message": "Add asm test suite", "tree": {"sha": "f4bb8a0d643274b1f0daadeeb82b46b76ddb5f6a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f4bb8a0d643274b1f0daadeeb82b46b76ddb5f6a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ccfe7d889814cce1b24ad34097e0161b3436d30f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ccfe7d889814cce1b24ad34097e0161b3436d30f", "html_url": "https://github.com/rust-lang/rust/commit/ccfe7d889814cce1b24ad34097e0161b3436d30f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ccfe7d889814cce1b24ad34097e0161b3436d30f/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b3198c72dbaa42fc1e238141ea68fcdf11041805", "url": "https://api.github.com/repos/rust-lang/rust/commits/b3198c72dbaa42fc1e238141ea68fcdf11041805", "html_url": "https://github.com/rust-lang/rust/commit/b3198c72dbaa42fc1e238141ea68fcdf11041805"}], "stats": {"total": 64, "additions": 41, "deletions": 23}, "files": [{"sha": "737d87a9069428f9744196696b06c0a3fa38ee1f", "filename": "test.sh", "status": "modified", "additions": 41, "deletions": 23, "changes": 64, "blob_url": "https://github.com/rust-lang/rust/blob/ccfe7d889814cce1b24ad34097e0161b3436d30f/test.sh", "raw_url": "https://github.com/rust-lang/rust/raw/ccfe7d889814cce1b24ad34097e0161b3436d30f/test.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/test.sh?ref=ccfe7d889814cce1b24ad34097e0161b3436d30f", "patch": "@@ -75,6 +75,11 @@ while [[ $# -gt 0 ]]; do\n             shift\n             ;;\n \n+        \"--asm-tests\")\n+            funcs+=(asm_tests)\n+            shift\n+            ;;\n+\n         \"--extended-tests\")\n             funcs+=(extended_sysroot_tests)\n             shift\n@@ -197,6 +202,40 @@ function std_tests() {\n     $RUSTC example/mod_bench.rs --crate-type bin --target $TARGET_TRIPLE\n }\n \n+function setup_rustc() {\n+    rust_toolchain=$(cat rust-toolchain | grep channel | sed 's/channel = \"\\(.*\\)\"/\\1/')\n+\n+    git clone https://github.com/rust-lang/rust.git || true\n+    cd rust\n+    git fetch\n+    git checkout $(rustc -V | cut -d' ' -f3 | tr -d '(')\n+    export RUSTFLAGS=\n+\n+    rm config.toml || true\n+\n+    cat > config.toml <<EOF\n+[rust]\n+codegen-backends = []\n+deny-warnings = false\n+\n+[build]\n+cargo = \"$(which cargo)\"\n+local-rebuild = true\n+rustc = \"$HOME/.rustup/toolchains/$rust_toolchain-$TARGET_TRIPLE/bin/rustc\"\n+EOF\n+\n+    rustc -V | cut -d' ' -f3 | tr -d '('\n+    git checkout $(rustc -V | cut -d' ' -f3 | tr -d '(') src/test\n+}\n+\n+function asm_tests() {\n+    setup_rustc\n+\n+    echo \"[TEST] rustc test suite\"\n+    RUSTC_ARGS=\"-Zpanic-abort-tests -Csymbol-mangling-version=v0 -Zcodegen-backend=\"$(pwd)\"/../target/\"$CHANNEL\"/librustc_codegen_gcc.\"$dylib_ext\" --sysroot \"$(pwd)\"/../build_sysroot/sysroot -Cpanic=abort\"\n+    COMPILETEST_FORCE_STAGE0=1 ./x.py test --run always --stage 0 src/test/assembly/asm --rustc-args \"$RUSTC_ARGS\"\n+}\n+\n # FIXME(antoyo): linker gives multiple definitions error on Linux\n #echo \"[BUILD] sysroot in release mode\"\n #./build_sysroot/build_sysroot.sh --release\n@@ -288,29 +327,7 @@ function test_rustc() {\n     echo\n     echo \"[TEST] rust-lang/rust\"\n \n-    rust_toolchain=$(cat rust-toolchain | grep channel | sed 's/channel = \"\\(.*\\)\"/\\1/')\n-\n-    git clone https://github.com/rust-lang/rust.git || true\n-    cd rust\n-    git fetch\n-    git checkout $(rustc -V | cut -d' ' -f3 | tr -d '(')\n-    export RUSTFLAGS=\n-\n-    rm config.toml || true\n-\n-    cat > config.toml <<EOF\n-[rust]\n-codegen-backends = []\n-deny-warnings = false\n-\n-[build]\n-cargo = \"$(which cargo)\"\n-local-rebuild = true\n-rustc = \"$HOME/.rustup/toolchains/$rust_toolchain-$TARGET_TRIPLE/bin/rustc\"\n-EOF\n-\n-    rustc -V | cut -d' ' -f3 | tr -d '('\n-    git checkout $(rustc -V | cut -d' ' -f3 | tr -d '(') src/test\n+    setup_rustc\n \n     for test in $(rg -i --files-with-matches \"//(\\[\\w+\\])?~|// error-pattern:|// build-fail|// run-fail|-Cllvm-args\" src/test/ui); do\n       rm $test\n@@ -380,6 +397,7 @@ function all() {\n     mini_tests\n     build_sysroot\n     std_tests\n+    asm_tests\n     test_libcore\n     extended_sysroot_tests\n     test_rustc"}]}