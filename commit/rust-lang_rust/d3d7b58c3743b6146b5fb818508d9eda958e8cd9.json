{"sha": "d3d7b58c3743b6146b5fb818508d9eda958e8cd9", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQzZDdiNThjMzc0M2I2MTQ2YjVmYjgxODUwOGQ5ZWRhOTU4ZThjZDk=", "commit": {"author": {"name": "Pietro Albini", "email": "pietro@pietroalbini.org", "date": "2019-09-03T09:33:29Z"}, "committer": {"name": "Pietro Albini", "email": "pietro@pietroalbini.org", "date": "2019-09-16T14:30:46Z"}, "message": "ci: ensure all tool maintainers are assignable on issues\n\nGitHub only allows people explicitly listed as collaborators on the\nrepository or who commented on the issue/PR to be assignees, failing to\ncreate the issue if non-assignable people are assigned.\n\nThis adds an extra check on CI to make sure all the people listed as\ntool maintainers can be assigned to toolstate issues. The check won't be\nexecuted on PR builds due to the lack of a valid token.", "tree": {"sha": "71fcf7d65e8247765c20bd5333a53cf16e99e3cd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/71fcf7d65e8247765c20bd5333a53cf16e99e3cd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d3d7b58c3743b6146b5fb818508d9eda958e8cd9", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEE1JbYPtLJAsc22U9xPgar6Auq8ZwFAl1/nJYACgkQPgar6Auq\n8ZxryBAAu7GTdWBgWODRsWQ35lVukSIpmGXIWF1JqrhB1ulXZAcSGK52vDpeooST\nUxA/ZL9V8saDEVGqv5Wlzb+rQfrO1PPrOJveZO6KVIZZI/J/DWMqCwqmlkO49f6P\nVvCsjWV2kURfJ76zzFJ8dhcLi2uDWkBgBwb/2h0HQHl/p04YauwIOv7WmoDqqgPc\nO4VOvubpLdGTp2DOtPYl244+lq/sc0Lipy3Ddq8ylLI6YfklIZUVSzo7y0ANEKKE\nTAIQU221Gg9V9e83wVko7nyFs4RUY6N6cPt6fTQGxYWAilyRyGWUdXxfEYTt9tIu\ng7naxkWpm6eNyLX1eKInTTCGXa9oczb2lWvaaOjUXLnX/4+ldp6npSWoz0N42/1N\nVznGhPilZk26ULsQmZuHeIfcDjXKRl+xNxktW09OjaAPQQi4AViOyKAmGAMS2BLH\nS/ftMYM9qX/wWV1qzbzFNEKxZr9LhZ5QCLQm20OPPeA1hSBWfTbZenVYpK3C8W/B\nTnasbOJF6opXCH201W36xvnUPLpPF5YzgWZlIgbAL9UV9AWFy+t2wznVHx/RW6ZM\n0Wc/dFFoFApTqEU44Y0NtMHG/NFNvht6PXPsNBueacmuRCyTrWf4BLYpDrsEa0RP\nhzwQ3udCWcIUee3aFtFgOQ4+5anQkxmH2lcFcHdVPVH5qkFhokk=\n=+cZG\n-----END PGP SIGNATURE-----", "payload": "tree 71fcf7d65e8247765c20bd5333a53cf16e99e3cd\nparent b6269f27d99d7da9e95f0b3fdc53193dc8c42fbe\nauthor Pietro Albini <pietro@pietroalbini.org> 1567503209 +0200\ncommitter Pietro Albini <pietro@pietroalbini.org> 1568644246 +0200\n\nci: ensure all tool maintainers are assignable on issues\n\nGitHub only allows people explicitly listed as collaborators on the\nrepository or who commented on the issue/PR to be assignees, failing to\ncreate the issue if non-assignable people are assigned.\n\nThis adds an extra check on CI to make sure all the people listed as\ntool maintainers can be assigned to toolstate issues. The check won't be\nexecuted on PR builds due to the lack of a valid token.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d3d7b58c3743b6146b5fb818508d9eda958e8cd9", "html_url": "https://github.com/rust-lang/rust/commit/d3d7b58c3743b6146b5fb818508d9eda958e8cd9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d3d7b58c3743b6146b5fb818508d9eda958e8cd9/comments", "author": {"login": "pietroalbini", "id": 2299951, "node_id": "MDQ6VXNlcjIyOTk5NTE=", "avatar_url": "https://avatars.githubusercontent.com/u/2299951?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pietroalbini", "html_url": "https://github.com/pietroalbini", "followers_url": "https://api.github.com/users/pietroalbini/followers", "following_url": "https://api.github.com/users/pietroalbini/following{/other_user}", "gists_url": "https://api.github.com/users/pietroalbini/gists{/gist_id}", "starred_url": "https://api.github.com/users/pietroalbini/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pietroalbini/subscriptions", "organizations_url": "https://api.github.com/users/pietroalbini/orgs", "repos_url": "https://api.github.com/users/pietroalbini/repos", "events_url": "https://api.github.com/users/pietroalbini/events{/privacy}", "received_events_url": "https://api.github.com/users/pietroalbini/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pietroalbini", "id": 2299951, "node_id": "MDQ6VXNlcjIyOTk5NTE=", "avatar_url": "https://avatars.githubusercontent.com/u/2299951?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pietroalbini", "html_url": "https://github.com/pietroalbini", "followers_url": "https://api.github.com/users/pietroalbini/followers", "following_url": "https://api.github.com/users/pietroalbini/following{/other_user}", "gists_url": "https://api.github.com/users/pietroalbini/gists{/gist_id}", "starred_url": "https://api.github.com/users/pietroalbini/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pietroalbini/subscriptions", "organizations_url": "https://api.github.com/users/pietroalbini/orgs", "repos_url": "https://api.github.com/users/pietroalbini/repos", "events_url": "https://api.github.com/users/pietroalbini/events{/privacy}", "received_events_url": "https://api.github.com/users/pietroalbini/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b6269f27d99d7da9e95f0b3fdc53193dc8c42fbe", "url": "https://api.github.com/repos/rust-lang/rust/commits/b6269f27d99d7da9e95f0b3fdc53193dc8c42fbe", "html_url": "https://github.com/rust-lang/rust/commit/b6269f27d99d7da9e95f0b3fdc53193dc8c42fbe"}], "stats": {"total": 67, "additions": 67, "deletions": 0}, "files": [{"sha": "da0a899ac85ebde298be443157621ef53187244c", "filename": "src/ci/azure-pipelines/steps/run.yml", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/d3d7b58c3743b6146b5fb818508d9eda958e8cd9/src%2Fci%2Fazure-pipelines%2Fsteps%2Frun.yml", "raw_url": "https://github.com/rust-lang/rust/raw/d3d7b58c3743b6146b5fb818508d9eda958e8cd9/src%2Fci%2Fazure-pipelines%2Fsteps%2Frun.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fazure-pipelines%2Fsteps%2Frun.yml?ref=d3d7b58c3743b6146b5fb818508d9eda958e8cd9", "patch": "@@ -147,8 +147,15 @@ steps:\n     git clone --depth=1 https://github.com/rust-lang-nursery/rust-toolstate.git\n     cd rust-toolstate\n     python2.7 \"$BUILD_SOURCESDIRECTORY/src/tools/publish_toolstate.py\" \"$(git rev-parse HEAD)\" \"$(git log --format=%s -n1 HEAD)\" \"\" \"\"\n+    # Only check maintainers if this build is supposed to publish toolstate.\n+    # Builds that are not supposed to publish don't have the access token.\n+    if [ -n \"${TOOLSTATE_PUBLISH+is_set}\" ]; then\n+      TOOLSTATE_VALIDATE_MAINTAINERS_REPO=rust-lang/rust python2.7 \"${BUILD_SOURCESDIRECTORY}/src/tools/publish_toolstate.py\"\n+    fi\n     cd ..\n     rm -rf rust-toolstate\n+  env:\n+    TOOLSTATE_REPO_ACCESS_TOKEN: $(TOOLSTATE_REPO_ACCESS_TOKEN)\n   condition: and(succeeded(), not(variables.SKIP_JOB), eq(variables['IMAGE'], 'mingw-check'))\n   displayName: Verify the publish_toolstate script works\n "}, {"sha": "bc00fbc90bf96d37f88f800a886c477ddfdf25f8", "filename": "src/tools/publish_toolstate.py", "status": "modified", "additions": 60, "deletions": 0, "changes": 60, "blob_url": "https://github.com/rust-lang/rust/blob/d3d7b58c3743b6146b5fb818508d9eda958e8cd9/src%2Ftools%2Fpublish_toolstate.py", "raw_url": "https://github.com/rust-lang/rust/raw/d3d7b58c3743b6146b5fb818508d9eda958e8cd9/src%2Ftools%2Fpublish_toolstate.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fpublish_toolstate.py?ref=d3d7b58c3743b6146b5fb818508d9eda958e8cd9", "patch": "@@ -7,6 +7,8 @@\n ## It is set as callback for `src/ci/docker/x86_64-gnu-tools/repo.sh` by the CI scripts\n ## when a new commit lands on `master` (i.e., after it passed all checks on `auto`).\n \n+from __future__ import print_function\n+\n import sys\n import re\n import os\n@@ -20,6 +22,8 @@\n     import urllib.request as urllib2\n \n # List of people to ping when the status of a tool or a book changed.\n+# These should be collaborators of the rust-lang/rust repository (with at least\n+# read privileges on it). CI will fail otherwise.\n MAINTAINERS = {\n     'miri': '@oli-obk @RalfJung @eddyb',\n     'clippy-driver': '@Manishearth @llogiq @mcarton @oli-obk @phansch @flip1995 @yaahc',\n@@ -52,6 +56,53 @@\n }\n \n \n+def validate_maintainers(repo, github_token):\n+    '''Ensure all maintainers are assignable on a GitHub repo'''\n+    next_link_re = re.compile(r'<([^>]+)>; rel=\"next\"')\n+\n+    # Load the list of assignable people in the GitHub repo\n+    assignable = []\n+    url = 'https://api.github.com/repos/%s/collaborators?per_page=100' % repo\n+    while url is not None:\n+        response = urllib2.urlopen(urllib2.Request(url, headers={\n+            'Authorization': 'token ' + github_token,\n+            # Properly load nested teams.\n+            'Accept': 'application/vnd.github.hellcat-preview+json',\n+        }))\n+        for user in json.loads(response.read()):\n+            assignable.append(user['login'])\n+        # Load the next page if available\n+        if 'Link' in response.headers:\n+            matches = next_link_re.match(response.headers['Link'])\n+            if matches is not None:\n+                url = matches.group(1)\n+            else:\n+                url = None\n+\n+    errors = False\n+    for tool, maintainers in MAINTAINERS.items():\n+        for maintainer in maintainers.split(' '):\n+            if maintainer.startswith('@'):\n+                maintainer = maintainer[1:]\n+            if maintainer not in assignable:\n+                errors = True\n+                print(\n+                    \"error: %s maintainer @%s is not assignable in the %s repo\"\n+                    % (tool, maintainer, repo),\n+                )\n+\n+    if errors:\n+        print()\n+        print(\"  To be assignable, a person needs to be explicitly listed as a\")\n+        print(\"  collaborator in the repository settings. The simple way to\")\n+        print(\"  fix this is to ask someone with 'admin' privileges on the repo\")\n+        print(\"  to add the person or whole team as a collaborator with 'read'\")\n+        print(\"  privileges. Those privileges don't grant any extra permissions\")\n+        print(\"  so it's safe to apply them.\")\n+        print()\n+        print(\"The build will fail due to this.\")\n+        exit(1)\n+\n def read_current_status(current_commit, path):\n     '''Reads build status of `current_commit` from content of `history/*.tsv`\n     '''\n@@ -200,6 +251,15 @@ def update_latest(\n \n \n if __name__ == '__main__':\n+    if 'TOOLSTATE_VALIDATE_MAINTAINERS_REPO' in os.environ:\n+        repo = os.environ['TOOLSTATE_VALIDATE_MAINTAINERS_REPO']\n+        if 'TOOLSTATE_REPO_ACCESS_TOKEN' in os.environ:\n+            github_token = os.environ['TOOLSTATE_REPO_ACCESS_TOKEN']\n+            validate_maintainers(repo, github_token)\n+        else:\n+            print('skipping toolstate maintainers validation since no GitHub token is present')\n+        exit(0)\n+\n     cur_commit = sys.argv[1]\n     cur_datetime = datetime.datetime.utcnow().strftime('%Y-%m-%dT%H:%M:%SZ')\n     cur_commit_msg = sys.argv[2]"}]}