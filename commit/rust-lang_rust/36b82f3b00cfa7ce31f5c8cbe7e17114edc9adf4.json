{"sha": "36b82f3b00cfa7ce31f5c8cbe7e17114edc9adf4", "node_id": "MDY6Q29tbWl0NzI0NzEyOjM2YjgyZjNiMDBjZmE3Y2UzMWY1YzhjYmU3ZTE3MTE0ZWRjOWFkZjQ=", "commit": {"author": {"name": "Nick Cameron", "email": "nrc@ncameron.org", "date": "2016-01-12T02:41:16Z"}, "committer": {"name": "Nick Cameron", "email": "nrc@ncameron.org", "date": "2016-01-12T02:41:16Z"}, "message": "Merge pull request #765 from DarkDrek/fix-#447-2\n\nFix #447 2. try", "tree": {"sha": "2a0b7c0ada0a56cdeb921299e9845c3b30b442a7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2a0b7c0ada0a56cdeb921299e9845c3b30b442a7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/36b82f3b00cfa7ce31f5c8cbe7e17114edc9adf4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/36b82f3b00cfa7ce31f5c8cbe7e17114edc9adf4", "html_url": "https://github.com/rust-lang/rust/commit/36b82f3b00cfa7ce31f5c8cbe7e17114edc9adf4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/36b82f3b00cfa7ce31f5c8cbe7e17114edc9adf4/comments", "author": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "bdcc815b188bd77226fdc78caf56e79ee2edcbb1", "url": "https://api.github.com/repos/rust-lang/rust/commits/bdcc815b188bd77226fdc78caf56e79ee2edcbb1", "html_url": "https://github.com/rust-lang/rust/commit/bdcc815b188bd77226fdc78caf56e79ee2edcbb1"}, {"sha": "20ccc7bf8e4c3b10e1c05631dc706d8402b2ebdb", "url": "https://api.github.com/repos/rust-lang/rust/commits/20ccc7bf8e4c3b10e1c05631dc706d8402b2ebdb", "html_url": "https://github.com/rust-lang/rust/commit/20ccc7bf8e4c3b10e1c05631dc706d8402b2ebdb"}], "stats": {"total": 158, "additions": 148, "deletions": 10}, "files": [{"sha": "54a6fb20fa88630aab58957e3d1fafdaa1c1294c", "filename": "src/expr.rs", "status": "modified", "additions": 64, "deletions": 4, "changes": 68, "blob_url": "https://github.com/rust-lang/rust/blob/36b82f3b00cfa7ce31f5c8cbe7e17114edc9adf4/src%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/36b82f3b00cfa7ce31f5c8cbe7e17114edc9adf4/src%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fexpr.rs?ref=36b82f3b00cfa7ce31f5c8cbe7e17114edc9adf4", "patch": "@@ -13,14 +13,15 @@ use std::borrow::Borrow;\n use std::mem::swap;\n use std::ops::Deref;\n use std::iter::ExactSizeIterator;\n+use std::fmt::Write;\n \n use {Indent, Spanned};\n use rewrite::{Rewrite, RewriteContext};\n use lists::{write_list, itemize_list, ListFormatting, SeparatorTactic, ListTactic,\n             DefinitiveListTactic, definitive_tactic, ListItem, format_fn_args};\n use string::{StringFormat, rewrite_string};\n-use utils::{span_after, extra_offset, last_line_width, wrap_str, binary_search, first_line_width,\n-            semicolon_for_stmt};\n+use utils::{span_after, span_before, extra_offset, last_line_width, wrap_str, binary_search,\n+            first_line_width, semicolon_for_stmt};\n use visitor::FmtVisitor;\n use config::{Config, StructLitStyle, MultilineStyle};\n use comment::{FindUncommented, rewrite_comment, contains_comment, recover_comment_removed};\n@@ -101,6 +102,7 @@ impl Rewrite for ast::Expr {\n                                 cond,\n                                 if_block,\n                                 else_block.as_ref().map(|e| &**e),\n+                                self.span,\n                                 None,\n                                 width,\n                                 offset,\n@@ -111,6 +113,7 @@ impl Rewrite for ast::Expr {\n                                 cond,\n                                 if_block,\n                                 else_block.as_ref().map(|e| &**e),\n+                                self.span,\n                                 Some(pat),\n                                 width,\n                                 offset,\n@@ -605,12 +608,33 @@ fn rewrite_label(label: Option<ast::Ident>) -> String {\n     }\n }\n \n+fn extract_comment(span: Span,\n+                   context: &RewriteContext,\n+                   offset: Indent,\n+                   width: usize)\n+                   -> Option<String> {\n+    let comment_str = context.snippet(span);\n+    if contains_comment(&comment_str) {\n+        let comment = try_opt!(rewrite_comment(comment_str.trim(),\n+                                               false,\n+                                               width,\n+                                               offset,\n+                                               context.config));\n+        Some(format!(\"\\n{indent}{}\\n{indent}\",\n+                     comment,\n+                     indent = offset.to_string(context.config)))\n+    } else {\n+        None\n+    }\n+}\n+\n // Rewrites if-else blocks. If let Some(_) = pat, the expression is\n // treated as an if-let-else expression.\n fn rewrite_if_else(context: &RewriteContext,\n                    cond: &ast::Expr,\n                    if_block: &ast::Block,\n                    else_block_opt: Option<&ast::Expr>,\n+                   span: Span,\n                    pat: Option<&ast::Pat>,\n                    width: usize,\n                    offset: Indent,\n@@ -635,7 +659,22 @@ fn rewrite_if_else(context: &RewriteContext,\n     }\n \n     let if_block_string = try_opt!(if_block.rewrite(context, width, offset));\n-    let mut result = format!(\"if {} {}\", pat_expr_string, if_block_string);\n+\n+    let between_if_cond = mk_sp(span_after(span, \"if\", context.codemap),\n+                                pat.map_or(cond.span.lo,\n+                                           |_| span_before(span, \"let\", context.codemap)));\n+    let between_if_cond_comment = extract_comment(between_if_cond, &context, offset, width);\n+\n+    let after_cond_comment = extract_comment(mk_sp(cond.span.hi, if_block.span.lo),\n+                                             context,\n+                                             offset,\n+                                             width);\n+\n+    let mut result = format!(\"if{}{}{}{}\",\n+                             between_if_cond_comment.as_ref().map_or(\" \", |str| &**str),\n+                             pat_expr_string,\n+                             after_cond_comment.as_ref().map_or(\" \", |str| &**str),\n+                             if_block_string);\n \n     if let Some(else_block) = else_block_opt {\n         let rewrite = match else_block.node {\n@@ -646,6 +685,7 @@ fn rewrite_if_else(context: &RewriteContext,\n                                 cond,\n                                 if_block,\n                                 else_block.as_ref().map(|e| &**e),\n+                                mk_sp(span_after(span, \"else\", context.codemap), span.hi),\n                                 Some(pat),\n                                 width,\n                                 offset,\n@@ -656,6 +696,7 @@ fn rewrite_if_else(context: &RewriteContext,\n                                 cond,\n                                 if_block,\n                                 else_block.as_ref().map(|e| &**e),\n+                                mk_sp(span_after(span, \"else\", context.codemap), span.hi),\n                                 None,\n                                 width,\n                                 offset,\n@@ -664,7 +705,26 @@ fn rewrite_if_else(context: &RewriteContext,\n             _ => else_block.rewrite(context, width, offset),\n         };\n \n-        result.push_str(\" else \");\n+        let between_if_else_block = mk_sp(if_block.span.hi,\n+                                          span_before(mk_sp(if_block.span.hi, else_block.span.lo),\n+                                                      \"else\",\n+                                                      context.codemap));\n+        let between_if_else_block_comment = extract_comment(between_if_else_block,\n+                                                            &context,\n+                                                            offset,\n+                                                            width);\n+\n+        let after_else = mk_sp(span_after(mk_sp(if_block.span.hi, else_block.span.lo),\n+                                          \"else\",\n+                                          context.codemap),\n+                               else_block.span.lo);\n+        let after_else_comment = extract_comment(after_else, &context, offset, width);\n+\n+        try_opt!(write!(&mut result,\n+                        \"{}else{}\",\n+                        between_if_else_block_comment.as_ref().map_or(\" \", |str| &**str),\n+                        after_else_comment.as_ref().map_or(\" \", |str| &**str))\n+                     .ok());\n         result.push_str(&&try_opt!(rewrite));\n     }\n "}, {"sha": "3b03ede2be34f98ca4dde1d3d3b2e3532cbf9ce9", "filename": "src/utils.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/36b82f3b00cfa7ce31f5c8cbe7e17114edc9adf4/src%2Futils.rs", "raw_url": "https://github.com/rust-lang/rust/raw/36b82f3b00cfa7ce31f5c8cbe7e17114edc9adf4/src%2Futils.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Futils.rs?ref=36b82f3b00cfa7ce31f5c8cbe7e17114edc9adf4", "patch": "@@ -38,6 +38,14 @@ pub fn span_after(original: Span, needle: &str, codemap: &CodeMap) -> BytePos {\n     original.lo + BytePos(offset as u32)\n }\n \n+#[inline]\n+pub fn span_before(original: Span, needle: &str, codemap: &CodeMap) -> BytePos {\n+    let snippet = codemap.span_to_snippet(original).unwrap();\n+    let offset = snippet.find_uncommented(needle).unwrap();\n+\n+    original.lo + BytePos(offset as u32)\n+}\n+\n #[inline]\n pub fn span_after_last(original: Span, needle: &str, codemap: &CodeMap) -> BytePos {\n     let snippet = codemap.span_to_snippet(original).unwrap();"}, {"sha": "cc713af3f18bdc14f7a8da5454ddff861008ce8c", "filename": "tests/source/issue-447.rs", "status": "added", "additions": 37, "deletions": 0, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/36b82f3b00cfa7ce31f5c8cbe7e17114edc9adf4/tests%2Fsource%2Fissue-447.rs", "raw_url": "https://github.com/rust-lang/rust/raw/36b82f3b00cfa7ce31f5c8cbe7e17114edc9adf4/tests%2Fsource%2Fissue-447.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fissue-447.rs?ref=36b82f3b00cfa7ce31f5c8cbe7e17114edc9adf4", "patch": "@@ -0,0 +1,37 @@\n+fn main() {\n+\tif /* shouldn't be dropped\n+\tshouldn't be dropped */\n+\t\n+\tcond /* shouldn't be dropped\n+\tshouldn't be dropped */\n+\t\n+\t{\n+\t} /* shouldn't be dropped\n+\tshouldn't be dropped */\n+\t\n+\telse /* shouldn't be dropped\n+\tshouldn't be dropped */\n+\t\n+\tif /* shouldn't be dropped\n+\tshouldn't be dropped */\n+\t\n+\tcond /* shouldn't be dropped\n+\tshouldn't be dropped */\n+\t\n+\t{\n+\t} /* shouldn't be dropped\n+\tshouldn't be dropped */\n+\t\n+\telse /* shouldn't be dropped\n+\tshouldn't be dropped */\n+\t\n+\t{\n+\t}\n+\t\n+\tif /* shouldn't be dropped\n+\tshouldn't be dropped */\n+\tlet Some(x) = y/* shouldn't be dropped\n+\tshouldn't be dropped */\n+\t{\n+\t}\n+}"}, {"sha": "646b37e46e2e80d4b1427cb32609d21d88a700f5", "filename": "tests/target/comment-not-disappear.rs", "status": "modified", "additions": 0, "deletions": 6, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/36b82f3b00cfa7ce31f5c8cbe7e17114edc9adf4/tests%2Ftarget%2Fcomment-not-disappear.rs", "raw_url": "https://github.com/rust-lang/rust/raw/36b82f3b00cfa7ce31f5c8cbe7e17114edc9adf4/tests%2Ftarget%2Fcomment-not-disappear.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fcomment-not-disappear.rs?ref=36b82f3b00cfa7ce31f5c8cbe7e17114edc9adf4", "patch": "@@ -28,12 +28,6 @@ fn foo() -> Vec<i32> {\n         .collect()\n }\n \n-fn d() {\n-    if true /* and ... */ {\n-        a();\n-    }\n-}\n-\n fn calc_page_len(prefix_len: usize, sofar: usize) -> usize {\n     2 // page type and flags\n     + 1 // stored depth"}, {"sha": "7e69c708eb7e71d64862d944df31fa42e960c32e", "filename": "tests/target/issue-447.rs", "status": "added", "additions": 39, "deletions": 0, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/36b82f3b00cfa7ce31f5c8cbe7e17114edc9adf4/tests%2Ftarget%2Fissue-447.rs", "raw_url": "https://github.com/rust-lang/rust/raw/36b82f3b00cfa7ce31f5c8cbe7e17114edc9adf4/tests%2Ftarget%2Fissue-447.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fissue-447.rs?ref=36b82f3b00cfa7ce31f5c8cbe7e17114edc9adf4", "patch": "@@ -0,0 +1,39 @@\n+fn main() {\n+    if\n+    // shouldn't be dropped\n+    // shouldn't be dropped\n+    cond\n+    // shouldn't be dropped\n+    // shouldn't be dropped\n+    {\n+    }\n+    // shouldn't be dropped\n+    // shouldn't be dropped\n+    else\n+    // shouldn't be dropped\n+    // shouldn't be dropped\n+    if\n+    // shouldn't be dropped\n+    // shouldn't be dropped\n+    cond\n+    // shouldn't be dropped\n+    // shouldn't be dropped\n+    {\n+    }\n+    // shouldn't be dropped\n+    // shouldn't be dropped\n+    else\n+    // shouldn't be dropped\n+    // shouldn't be dropped\n+    {\n+    }\n+\n+    if\n+    // shouldn't be dropped\n+    // shouldn't be dropped\n+    let Some(x) = y\n+    // shouldn't be dropped\n+    // shouldn't be dropped\n+    {\n+    }\n+}"}]}