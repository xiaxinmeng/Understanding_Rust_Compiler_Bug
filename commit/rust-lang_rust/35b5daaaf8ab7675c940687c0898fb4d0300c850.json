{"sha": "35b5daaaf8ab7675c940687c0898fb4d0300c850", "node_id": "C_kwDOAAsO6NoAKDM1YjVkYWFhZjhhYjc2NzVjOTQwNjg3YzA4OThmYjRkMDMwMGM4NTA", "commit": {"author": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2022-01-27T00:00:00Z"}, "committer": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2022-01-29T22:00:54Z"}, "message": "Check the number of arguments first in `is_recursive_call`", "tree": {"sha": "067a518fec04b7925f80e11f3cb9ab65ed88b171", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/067a518fec04b7925f80e11f3cb9ab65ed88b171"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/35b5daaaf8ab7675c940687c0898fb4d0300c850", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/35b5daaaf8ab7675c940687c0898fb4d0300c850", "html_url": "https://github.com/rust-lang/rust/commit/35b5daaaf8ab7675c940687c0898fb4d0300c850", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/35b5daaaf8ab7675c940687c0898fb4d0300c850/comments", "author": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a00e130dae74a213338e2b095ec855156d8f3d8a", "url": "https://api.github.com/repos/rust-lang/rust/commits/a00e130dae74a213338e2b095ec855156d8f3d8a", "html_url": "https://github.com/rust-lang/rust/commit/a00e130dae74a213338e2b095ec855156d8f3d8a"}], "stats": {"total": 14, "additions": 10, "deletions": 4}, "files": [{"sha": "bccff37987348807e262a65db548facc20dc7f92", "filename": "compiler/rustc_mir_build/src/lints.rs", "status": "modified", "additions": 10, "deletions": 4, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/35b5daaaf8ab7675c940687c0898fb4d0300c850/compiler%2Frustc_mir_build%2Fsrc%2Flints.rs", "raw_url": "https://github.com/rust-lang/rust/raw/35b5daaaf8ab7675c940687c0898fb4d0300c850/compiler%2Frustc_mir_build%2Fsrc%2Flints.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Flints.rs?ref=35b5daaaf8ab7675c940687c0898fb4d0300c850", "patch": "@@ -66,8 +66,14 @@ struct Search<'mir, 'tcx> {\n \n impl<'mir, 'tcx> Search<'mir, 'tcx> {\n     /// Returns `true` if `func` refers to the function we are searching in.\n-    fn is_recursive_call(&self, func: &Operand<'tcx>) -> bool {\n+    fn is_recursive_call(&self, func: &Operand<'tcx>, args: &[Operand<'tcx>]) -> bool {\n         let Search { tcx, body, trait_substs, .. } = *self;\n+        // Resolving function type to a specific instance that is being called is expensive.  To\n+        // avoid the cost we check the number of arguments first, which is sufficient to reject\n+        // most of calls as non-recursive.\n+        if args.len() != body.arg_count {\n+            return false;\n+        }\n         let caller = body.source.def_id();\n         let param_env = tcx.param_env(caller);\n \n@@ -141,8 +147,8 @@ impl<'mir, 'tcx> TriColorVisitor<&'mir Body<'tcx>> for Search<'mir, 'tcx> {\n     fn node_settled(&mut self, bb: BasicBlock) -> ControlFlow<Self::BreakVal> {\n         // When we examine a node for the last time, remember it if it is a recursive call.\n         let terminator = self.body[bb].terminator();\n-        if let TerminatorKind::Call { func, .. } = &terminator.kind {\n-            if self.is_recursive_call(func) {\n+        if let TerminatorKind::Call { func, args, .. } = &terminator.kind {\n+            if self.is_recursive_call(func, args) {\n                 self.reachable_recursive_calls.push(terminator.source_info.span);\n             }\n         }\n@@ -157,7 +163,7 @@ impl<'mir, 'tcx> TriColorVisitor<&'mir Body<'tcx>> for Search<'mir, 'tcx> {\n         }\n         // Don't traverse successors of recursive calls or false CFG edges.\n         match self.body[bb].terminator().kind {\n-            TerminatorKind::Call { ref func, .. } => self.is_recursive_call(func),\n+            TerminatorKind::Call { ref func, ref args, .. } => self.is_recursive_call(func, args),\n             TerminatorKind::FalseEdge { imaginary_target, .. } => imaginary_target == target,\n             _ => false,\n         }"}]}