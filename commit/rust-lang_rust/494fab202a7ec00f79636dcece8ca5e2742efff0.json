{"sha": "494fab202a7ec00f79636dcece8ca5e2742efff0", "node_id": "C_kwDOAAsO6NoAKDQ5NGZhYjIwMmE3ZWMwMGY3OTYzNmRjZWNlOGNhNWUyNzQyZWZmZjA", "commit": {"author": {"name": "ihciah", "email": "ihciah@gmail.com", "date": "2022-02-25T10:46:11Z"}, "committer": {"name": "ihciah", "email": "ihciah@gmail.com", "date": "2022-02-25T10:46:11Z"}, "message": "feat: support concat_bytes", "tree": {"sha": "7e8f7f8578591c38c589f2ae6eb72e4996ee57d7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7e8f7f8578591c38c589f2ae6eb72e4996ee57d7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/494fab202a7ec00f79636dcece8ca5e2742efff0", "comment_count": 0, "verification": {"verified": false, "reason": "unknown_key", "signature": "-----BEGIN PGP SIGNATURE-----\n\niHUEABYIAB0WIQRQNjK1aGhyuiyzFcWnIBi2UiMz0wUCYhizcwAKCRCnIBi2UiMz\n0zJ3AP9OCOg92bawVlxkkJapkQLIFfjLtJAl9T8/SKVcm0IDlAEAtAPNQc5GcDow\n44KaXIT5F71ICpaQgxppH3mQ6/T+UwQ=\n=zAHL\n-----END PGP SIGNATURE-----", "payload": "tree 7e8f7f8578591c38c589f2ae6eb72e4996ee57d7\nparent f6901c952ec3847ca522c69d4c854e9e0e51d5fe\nauthor ihciah <ihciah@gmail.com> 1645785971 +0800\ncommitter ihciah <ihciah@gmail.com> 1645785971 +0800\n\nfeat: support concat_bytes\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/494fab202a7ec00f79636dcece8ca5e2742efff0", "html_url": "https://github.com/rust-lang/rust/commit/494fab202a7ec00f79636dcece8ca5e2742efff0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/494fab202a7ec00f79636dcece8ca5e2742efff0/comments", "author": {"login": "ihciah", "id": 1707505, "node_id": "MDQ6VXNlcjE3MDc1MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/1707505?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ihciah", "html_url": "https://github.com/ihciah", "followers_url": "https://api.github.com/users/ihciah/followers", "following_url": "https://api.github.com/users/ihciah/following{/other_user}", "gists_url": "https://api.github.com/users/ihciah/gists{/gist_id}", "starred_url": "https://api.github.com/users/ihciah/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ihciah/subscriptions", "organizations_url": "https://api.github.com/users/ihciah/orgs", "repos_url": "https://api.github.com/users/ihciah/repos", "events_url": "https://api.github.com/users/ihciah/events{/privacy}", "received_events_url": "https://api.github.com/users/ihciah/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ihciah", "id": 1707505, "node_id": "MDQ6VXNlcjE3MDc1MDU=", "avatar_url": "https://avatars.githubusercontent.com/u/1707505?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ihciah", "html_url": "https://github.com/ihciah", "followers_url": "https://api.github.com/users/ihciah/followers", "following_url": "https://api.github.com/users/ihciah/following{/other_user}", "gists_url": "https://api.github.com/users/ihciah/gists{/gist_id}", "starred_url": "https://api.github.com/users/ihciah/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ihciah/subscriptions", "organizations_url": "https://api.github.com/users/ihciah/orgs", "repos_url": "https://api.github.com/users/ihciah/repos", "events_url": "https://api.github.com/users/ihciah/events{/privacy}", "received_events_url": "https://api.github.com/users/ihciah/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f6901c952ec3847ca522c69d4c854e9e0e51d5fe", "url": "https://api.github.com/repos/rust-lang/rust/commits/f6901c952ec3847ca522c69d4c854e9e0e51d5fe", "html_url": "https://github.com/rust-lang/rust/commit/f6901c952ec3847ca522c69d4c854e9e0e51d5fe"}], "stats": {"total": 94, "additions": 94, "deletions": 0}, "files": [{"sha": "919dd6c07f039a3c9977ec4870c4779fac429d98", "filename": "crates/hir_def/src/macro_expansion_tests/builtin_fn_macro.rs", "status": "modified", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/494fab202a7ec00f79636dcece8ca5e2742efff0/crates%2Fhir_def%2Fsrc%2Fmacro_expansion_tests%2Fbuiltin_fn_macro.rs", "raw_url": "https://github.com/rust-lang/rust/raw/494fab202a7ec00f79636dcece8ca5e2742efff0/crates%2Fhir_def%2Fsrc%2Fmacro_expansion_tests%2Fbuiltin_fn_macro.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fmacro_expansion_tests%2Fbuiltin_fn_macro.rs?ref=494fab202a7ec00f79636dcece8ca5e2742efff0", "patch": "@@ -313,6 +313,24 @@ fn main() { \"foor0bar\\nfalse\"; }\n     );\n }\n \n+#[test]\n+fn test_concat_bytes_expand() {\n+    check(\n+        r##\"\n+#[rustc_builtin_macro]\n+macro_rules! concat_bytes {}\n+\n+fn main() { concat_bytes!(b'A', b\"BC\", [68, b'E', 70]); }\n+\"##,\n+        expect![[r##\"\n+#[rustc_builtin_macro]\n+macro_rules! concat_bytes {}\n+\n+fn main() { [b'A', 66, 67, 68, b'E', 70]; }\n+\"##]],\n+    );\n+}\n+\n #[test]\n fn test_concat_with_captured_expr() {\n     check("}, {"sha": "bf6cc9989a6bfa6d873c2885bb8a8ba3f5d39e5a", "filename": "crates/hir_expand/src/builtin_fn_macro.rs", "status": "modified", "additions": 75, "deletions": 0, "changes": 75, "blob_url": "https://github.com/rust-lang/rust/blob/494fab202a7ec00f79636dcece8ca5e2742efff0/crates%2Fhir_expand%2Fsrc%2Fbuiltin_fn_macro.rs", "raw_url": "https://github.com/rust-lang/rust/raw/494fab202a7ec00f79636dcece8ca5e2742efff0/crates%2Fhir_expand%2Fsrc%2Fbuiltin_fn_macro.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_expand%2Fsrc%2Fbuiltin_fn_macro.rs?ref=494fab202a7ec00f79636dcece8ca5e2742efff0", "patch": "@@ -121,6 +121,7 @@ register_builtin! {\n     (compile_error, CompileError) => compile_error_expand,\n     (concat, Concat) => concat_expand,\n     (concat_idents, ConcatIdents) => concat_idents_expand,\n+    (concat_bytes, ConcatBytes) => concat_bytes_expand,\n     (include, Include) => include_expand,\n     (include_bytes, IncludeBytes) => include_bytes_expand,\n     (include_str, IncludeStr) => include_str_expand,\n@@ -359,6 +360,12 @@ fn unquote_str(lit: &tt::Literal) -> Option<String> {\n     token.value().map(|it| it.into_owned())\n }\n \n+fn unquote_byte_string(lit: &tt::Literal) -> Option<Vec<u8>> {\n+    let lit = ast::make::tokens::literal(&lit.to_string());\n+    let token = ast::ByteString::cast(lit)?;\n+    token.value().map(|it| it.into_owned())\n+}\n+\n fn compile_error_expand(\n     _db: &dyn AstDatabase,\n     _id: MacroCallId,\n@@ -422,6 +429,74 @@ fn concat_expand(\n     ExpandResult { value: ExpandedEager::new(quote!(#text)), err }\n }\n \n+fn concat_bytes_expand(\n+    _db: &dyn AstDatabase,\n+    _arg_id: MacroCallId,\n+    tt: &tt::Subtree,\n+) -> ExpandResult<ExpandedEager> {\n+    let mut bytes = Vec::new();\n+    let mut err = None;\n+    for (i, t) in tt.token_trees.iter().enumerate() {\n+        match t {\n+            tt::TokenTree::Leaf(tt::Leaf::Literal(lit)) => {\n+                let token = ast::make::tokens::literal(&lit.to_string());\n+                match token.kind() {\n+                    syntax::SyntaxKind::BYTE => bytes.push(token.text().to_string()),\n+                    syntax::SyntaxKind::BYTE_STRING => {\n+                        let components = unquote_byte_string(lit).unwrap_or_else(|| Vec::new());\n+                        components.into_iter().for_each(|x| bytes.push(x.to_string()));\n+                    }\n+                    _ => {\n+                        err.get_or_insert(mbe::ExpandError::UnexpectedToken.into());\n+                        break;\n+                    }\n+                }\n+            }\n+            tt::TokenTree::Leaf(tt::Leaf::Punct(punct)) if i % 2 == 1 && punct.char == ',' => (),\n+            tt::TokenTree::Subtree(tree)\n+                if tree.delimiter_kind() == Some(tt::DelimiterKind::Bracket) =>\n+            {\n+                if let Err(e) = concat_bytes_expand_subtree(tree, &mut bytes) {\n+                    err.get_or_insert(e);\n+                    break;\n+                }\n+            }\n+            _ => {\n+                err.get_or_insert(mbe::ExpandError::UnexpectedToken.into());\n+                break;\n+            }\n+        }\n+    }\n+    let ident = tt::Ident { text: bytes.join(\", \").into(), id: tt::TokenId::unspecified() };\n+    ExpandResult { value: ExpandedEager::new(quote!([#ident])), err }\n+}\n+\n+fn concat_bytes_expand_subtree(\n+    tree: &tt::Subtree,\n+    bytes: &mut Vec<String>,\n+) -> Result<(), ExpandError> {\n+    for (ti, tt) in tree.token_trees.iter().enumerate() {\n+        match tt {\n+            tt::TokenTree::Leaf(tt::Leaf::Literal(lit)) => {\n+                let lit = ast::make::tokens::literal(&lit.to_string());\n+                match lit.kind() {\n+                    syntax::SyntaxKind::BYTE | syntax::SyntaxKind::INT_NUMBER => {\n+                        bytes.push(lit.text().to_string())\n+                    }\n+                    _ => {\n+                        return Err(mbe::ExpandError::UnexpectedToken.into());\n+                    }\n+                }\n+            }\n+            tt::TokenTree::Leaf(tt::Leaf::Punct(punct)) if ti % 2 == 1 && punct.char == ',' => (),\n+            _ => {\n+                return Err(mbe::ExpandError::UnexpectedToken.into());\n+            }\n+        }\n+    }\n+    Ok(())\n+}\n+\n fn concat_idents_expand(\n     _db: &dyn AstDatabase,\n     _arg_id: MacroCallId,"}, {"sha": "7deec253da806f48d014815b8d0cee1762419ecd", "filename": "crates/hir_expand/src/name.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/494fab202a7ec00f79636dcece8ca5e2742efff0/crates%2Fhir_expand%2Fsrc%2Fname.rs", "raw_url": "https://github.com/rust-lang/rust/raw/494fab202a7ec00f79636dcece8ca5e2742efff0/crates%2Fhir_expand%2Fsrc%2Fname.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_expand%2Fsrc%2Fname.rs?ref=494fab202a7ec00f79636dcece8ca5e2742efff0", "patch": "@@ -233,6 +233,7 @@ pub mod known {\n         column,\n         compile_error,\n         concat_idents,\n+        concat_bytes,\n         concat,\n         const_format_args,\n         core_panic,"}]}