{"sha": "0604cf5fd8aacb5eee6a627066e11ca3b5f48cf2", "node_id": "C_kwDOAAsO6NoAKDA2MDRjZjVmZDhhYWNiNWVlZTZhNjI3MDY2ZTExY2EzYjVmNDhjZjI", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-01-06T22:15:14Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-01-06T22:15:14Z"}, "message": "Rollup merge of #92207 - tmiasko:delay-drop-elaboration-bug, r=jackh726\n\nDelay remaining `span_bug`s in drop elaboration\n\nThis follows changes from #67967 and converts remaining `span_bug`s into\ndelayed bugs, since for const items drop elaboration might be executed\non a MIR which failed borrowck.\n\nFixes #81708.\nFixes #91816.", "tree": {"sha": "0f8b3b00473e482adf9f1f9b6ba6859087de1438", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0f8b3b00473e482adf9f1f9b6ba6859087de1438"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0604cf5fd8aacb5eee6a627066e11ca3b5f48cf2", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJh12nzCRBK7hj4Ov3rIwAAufwIAFwZT6VrVp/qYWj3mAuWYeqW\nsIR0kn8KxVFXdXqKqiOujfCHVkSWD0KjbcffU++q30NaTaFhvfk6Re5pYMdVTQ6i\nTY9KcB+bb4FV4vUpBJvnQnWNVY8HmTcaIziAMNNpSJF2vAjCA990gVloABkz0sFU\nWiRH8gVwjvy9D7CCi5U9GrlkhiDEPQglcBIeSOz47GAhvCsiitMkgGx1rA3r3tOY\nfCv3VKgH6uZpplvd2evzjr4aoD07kug2G5dP/Iy7czEJPzq+GAiSFsnvBKG0icBK\nMBZxC4I3pLNfX/vlL1v7yVmm0+Q+4Pw0LGGxSGHuy9p3+Lapr3wt7r20dKFH5Wc=\n=qXWK\n-----END PGP SIGNATURE-----\n", "payload": "tree 0f8b3b00473e482adf9f1f9b6ba6859087de1438\nparent cdc5c1381def01cfbb9a94598bbb7ea080dcad05\nparent 0db192a48c0118081f6cd9eaa51bf9807e18b985\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1641507314 +0100\ncommitter GitHub <noreply@github.com> 1641507314 +0100\n\nRollup merge of #92207 - tmiasko:delay-drop-elaboration-bug, r=jackh726\n\nDelay remaining `span_bug`s in drop elaboration\n\nThis follows changes from #67967 and converts remaining `span_bug`s into\ndelayed bugs, since for const items drop elaboration might be executed\non a MIR which failed borrowck.\n\nFixes #81708.\nFixes #91816.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0604cf5fd8aacb5eee6a627066e11ca3b5f48cf2", "html_url": "https://github.com/rust-lang/rust/commit/0604cf5fd8aacb5eee6a627066e11ca3b5f48cf2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0604cf5fd8aacb5eee6a627066e11ca3b5f48cf2/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cdc5c1381def01cfbb9a94598bbb7ea080dcad05", "url": "https://api.github.com/repos/rust-lang/rust/commits/cdc5c1381def01cfbb9a94598bbb7ea080dcad05", "html_url": "https://github.com/rust-lang/rust/commit/cdc5c1381def01cfbb9a94598bbb7ea080dcad05"}, {"sha": "0db192a48c0118081f6cd9eaa51bf9807e18b985", "url": "https://api.github.com/repos/rust-lang/rust/commits/0db192a48c0118081f6cd9eaa51bf9807e18b985", "html_url": "https://github.com/rust-lang/rust/commit/0db192a48c0118081f6cd9eaa51bf9807e18b985"}], "stats": {"total": 97, "additions": 89, "deletions": 8}, "files": [{"sha": "7320b2738a76c2c0b222f162962f9a4f10937cb1", "filename": "compiler/rustc_mir_transform/src/elaborate_drops.rs", "status": "modified", "additions": 7, "deletions": 8, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/0604cf5fd8aacb5eee6a627066e11ca3b5f48cf2/compiler%2Frustc_mir_transform%2Fsrc%2Felaborate_drops.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0604cf5fd8aacb5eee6a627066e11ca3b5f48cf2/compiler%2Frustc_mir_transform%2Fsrc%2Felaborate_drops.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_transform%2Fsrc%2Felaborate_drops.rs?ref=0604cf5fd8aacb5eee6a627066e11ca3b5f48cf2", "patch": "@@ -316,12 +316,12 @@ impl<'b, 'tcx> ElaborateDropsCtxt<'b, 'tcx> {\n                 LookupResult::Parent(Some(parent)) => {\n                     let (_maybe_live, maybe_dead) = self.init_data.maybe_live_dead(parent);\n                     if maybe_dead {\n-                        span_bug!(\n+                        self.tcx.sess.delay_span_bug(\n                             terminator.source_info.span,\n-                            \"drop of untracked, uninitialized value {:?}, place {:?} ({:?})\",\n-                            bb,\n-                            place,\n-                            path\n+                            &format!(\n+                                \"drop of untracked, uninitialized value {:?}, place {:?} ({:?})\",\n+                                bb, place, path,\n+                            ),\n                         );\n                     }\n                     continue;\n@@ -368,10 +368,9 @@ impl<'b, 'tcx> ElaborateDropsCtxt<'b, 'tcx> {\n                             bb,\n                         ),\n                         LookupResult::Parent(..) => {\n-                            span_bug!(\n+                            self.tcx.sess.delay_span_bug(\n                                 terminator.source_info.span,\n-                                \"drop of untracked value {:?}\",\n-                                bb\n+                                &format!(\"drop of untracked value {:?}\", bb),\n                             );\n                         }\n                     }"}, {"sha": "c44dd51a5ec86522bacfbb1eb8fa4250de10c7dd", "filename": "src/test/ui/mir/drop-elaboration-after-borrowck-error.rs", "status": "added", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/0604cf5fd8aacb5eee6a627066e11ca3b5f48cf2/src%2Ftest%2Fui%2Fmir%2Fdrop-elaboration-after-borrowck-error.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0604cf5fd8aacb5eee6a627066e11ca3b5f48cf2/src%2Ftest%2Fui%2Fmir%2Fdrop-elaboration-after-borrowck-error.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmir%2Fdrop-elaboration-after-borrowck-error.rs?ref=0604cf5fd8aacb5eee6a627066e11ca3b5f48cf2", "patch": "@@ -0,0 +1,25 @@\n+// Regression test for issue 81708 and issue 91816 where running a drop\n+// elaboration on a MIR which failed borrowck lead to an ICE.\n+\n+static A: () = {\n+    let a: [String; 1];\n+    //~^ ERROR destructors cannot be evaluated at compile-time\n+    a[0] = String::new();\n+    //~^ ERROR destructors cannot be evaluated at compile-time\n+    //~| ERROR use of possibly-uninitialized variable\n+};\n+\n+struct B<T>([T; 1]);\n+\n+impl<T> B<T> {\n+    pub const fn f(mut self, other: T) -> Self {\n+        let _this = self;\n+        //~^ ERROR destructors cannot be evaluated at compile-time\n+        self.0[0] = other;\n+        //~^ ERROR destructors cannot be evaluated at compile-time\n+        //~| ERROR use of moved value\n+        self\n+    }\n+}\n+\n+fn main() {}"}, {"sha": "80d5fc7ec672c0df12754c3e0f8aa0a32b40d654", "filename": "src/test/ui/mir/drop-elaboration-after-borrowck-error.stderr", "status": "added", "additions": 57, "deletions": 0, "changes": 57, "blob_url": "https://github.com/rust-lang/rust/blob/0604cf5fd8aacb5eee6a627066e11ca3b5f48cf2/src%2Ftest%2Fui%2Fmir%2Fdrop-elaboration-after-borrowck-error.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/0604cf5fd8aacb5eee6a627066e11ca3b5f48cf2/src%2Ftest%2Fui%2Fmir%2Fdrop-elaboration-after-borrowck-error.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmir%2Fdrop-elaboration-after-borrowck-error.stderr?ref=0604cf5fd8aacb5eee6a627066e11ca3b5f48cf2", "patch": "@@ -0,0 +1,57 @@\n+error[E0493]: destructors cannot be evaluated at compile-time\n+  --> $DIR/drop-elaboration-after-borrowck-error.rs:7:5\n+   |\n+LL |     a[0] = String::new();\n+   |     ^^^^\n+   |     |\n+   |     statics cannot evaluate destructors\n+   |     value is dropped here\n+\n+error[E0493]: destructors cannot be evaluated at compile-time\n+  --> $DIR/drop-elaboration-after-borrowck-error.rs:5:9\n+   |\n+LL |     let a: [String; 1];\n+   |         ^ statics cannot evaluate destructors\n+...\n+LL | };\n+   | - value is dropped here\n+\n+error[E0381]: use of possibly-uninitialized variable: `a`\n+  --> $DIR/drop-elaboration-after-borrowck-error.rs:7:5\n+   |\n+LL |     a[0] = String::new();\n+   |     ^^^^ use of possibly-uninitialized `a`\n+\n+error[E0493]: destructors cannot be evaluated at compile-time\n+  --> $DIR/drop-elaboration-after-borrowck-error.rs:18:9\n+   |\n+LL |         self.0[0] = other;\n+   |         ^^^^^^^^^\n+   |         |\n+   |         constant functions cannot evaluate destructors\n+   |         value is dropped here\n+\n+error[E0493]: destructors cannot be evaluated at compile-time\n+  --> $DIR/drop-elaboration-after-borrowck-error.rs:16:13\n+   |\n+LL |         let _this = self;\n+   |             ^^^^^ constant functions cannot evaluate destructors\n+...\n+LL |     }\n+   |     - value is dropped here\n+\n+error[E0382]: use of moved value: `self.0`\n+  --> $DIR/drop-elaboration-after-borrowck-error.rs:18:9\n+   |\n+LL |     pub const fn f(mut self, other: T) -> Self {\n+   |                    -------- move occurs because `self` has type `B<T>`, which does not implement the `Copy` trait\n+LL |         let _this = self;\n+   |                     ---- value moved here\n+LL |\n+LL |         self.0[0] = other;\n+   |         ^^^^^^^^^ value used here after move\n+\n+error: aborting due to 6 previous errors\n+\n+Some errors have detailed explanations: E0381, E0382, E0493.\n+For more information about an error, try `rustc --explain E0381`."}]}