{"sha": "d022603a45358b7421d62161a685b8deb4f45e77", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQwMjI2MDNhNDUzNThiNzQyMWQ2MjE2MWE2ODViOGRlYjRmNDVlNzc=", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2020-06-01T18:53:45Z"}, "committer": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2020-06-01T18:53:45Z"}, "message": "test miri-unleash TLS accesses", "tree": {"sha": "30adff500be349d9cc9ca449f03cb82557c15d8e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/30adff500be349d9cc9ca449f03cb82557c15d8e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d022603a45358b7421d62161a685b8deb4f45e77", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d022603a45358b7421d62161a685b8deb4f45e77", "html_url": "https://github.com/rust-lang/rust/commit/d022603a45358b7421d62161a685b8deb4f45e77", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d022603a45358b7421d62161a685b8deb4f45e77/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d3cba254e464303a6495942f3a831c2bbd7f1768", "url": "https://api.github.com/repos/rust-lang/rust/commits/d3cba254e464303a6495942f3a831c2bbd7f1768", "html_url": "https://github.com/rust-lang/rust/commit/d3cba254e464303a6495942f3a831c2bbd7f1768"}], "stats": {"total": 73, "additions": 58, "deletions": 15}, "files": [{"sha": "1b3ede40f023a002b98182f4f07364035c1fecc0", "filename": "src/librustc_middle/mir/interpret/error.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/d022603a45358b7421d62161a685b8deb4f45e77/src%2Flibrustc_middle%2Fmir%2Finterpret%2Ferror.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d022603a45358b7421d62161a685b8deb4f45e77/src%2Flibrustc_middle%2Fmir%2Finterpret%2Ferror.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_middle%2Fmir%2Finterpret%2Ferror.rs?ref=d022603a45358b7421d62161a685b8deb4f45e77", "patch": "@@ -523,12 +523,12 @@ impl fmt::Display for UnsupportedOpInfo {\n         match self {\n             Unsupported(ref msg) => write!(f, \"{}\", msg),\n             ReadForeignStatic(did) => {\n-                write!(f, \"cannot read from foreign (extern) static {:?}\", did)\n+                write!(f, \"cannot read from foreign (extern) static ({:?})\", did)\n             }\n             NoMirFor(did) => write!(f, \"no MIR body is available for {:?}\", did),\n             ReadPointerAsBytes => write!(f, \"unable to turn pointer into raw bytes\",),\n             ReadBytesAsPointer => write!(f, \"unable to turn bytes into a pointer\"),\n-            ThreadLocalStatic(did) => write!(f, \"accessing thread local static {:?}\", did),\n+            ThreadLocalStatic(did) => write!(f, \"cannot access thread local static ({:?})\", did),\n         }\n     }\n }"}, {"sha": "92bd740e27aa61dc839259d14ba0041e55ad3004", "filename": "src/librustc_mir/transform/check_consts/ops.rs", "status": "modified", "additions": 0, "deletions": 5, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/d022603a45358b7421d62161a685b8deb4f45e77/src%2Flibrustc_mir%2Ftransform%2Fcheck_consts%2Fops.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d022603a45358b7421d62161a685b8deb4f45e77/src%2Flibrustc_mir%2Ftransform%2Fcheck_consts%2Fops.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fcheck_consts%2Fops.rs?ref=d022603a45358b7421d62161a685b8deb4f45e77", "patch": "@@ -12,9 +12,6 @@ use super::ConstCx;\n \n /// An operation that is not *always* allowed in a const context.\n pub trait NonConstOp: std::fmt::Debug {\n-    /// Whether this operation can be evaluated by miri.\n-    const IS_SUPPORTED_IN_MIRI: bool = true;\n-\n     /// Returns the `Symbol` corresponding to the feature gate that would enable this operation,\n     /// or `None` if such a feature gate does not exist.\n     fn feature_gate() -> Option<Symbol> {\n@@ -356,8 +353,6 @@ impl NonConstOp for StaticAccess {\n #[derive(Debug)]\n pub struct ThreadLocalAccess;\n impl NonConstOp for ThreadLocalAccess {\n-    const IS_SUPPORTED_IN_MIRI: bool = false;\n-\n     fn emit_error(&self, ccx: &ConstCx<'_, '_>, span: Span) {\n         struct_span_err!(\n             ccx.tcx.sess,"}, {"sha": "1137c813470be3412d6b2c339d5e5a7f6b1435af", "filename": "src/librustc_mir/transform/check_consts/validation.rs", "status": "modified", "additions": 1, "deletions": 5, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/d022603a45358b7421d62161a685b8deb4f45e77/src%2Flibrustc_mir%2Ftransform%2Fcheck_consts%2Fvalidation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d022603a45358b7421d62161a685b8deb4f45e77/src%2Flibrustc_mir%2Ftransform%2Fcheck_consts%2Fvalidation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fcheck_consts%2Fvalidation.rs?ref=d022603a45358b7421d62161a685b8deb4f45e77", "patch": "@@ -244,11 +244,7 @@ impl Validator<'mir, 'tcx> {\n             return;\n         }\n \n-        // If an operation is supported in miri it can be turned on with\n-        // `-Zunleash-the-miri-inside-of-you`.\n-        let is_unleashable = O::IS_SUPPORTED_IN_MIRI;\n-\n-        if is_unleashable && self.tcx.sess.opts.debugging_opts.unleash_the_miri_inside_of_you {\n+        if self.tcx.sess.opts.debugging_opts.unleash_the_miri_inside_of_you {\n             self.tcx.sess.miri_unleashed_feature(span, O::feature_gate());\n             return;\n         }"}, {"sha": "aa9b3144f401befa15cd15fb4b7e4d274087385d", "filename": "src/test/ui/consts/miri_unleashed/inline_asm.rs", "status": "modified", "additions": 9, "deletions": 2, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/d022603a45358b7421d62161a685b8deb4f45e77/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Finline_asm.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d022603a45358b7421d62161a685b8deb4f45e77/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Finline_asm.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Finline_asm.rs?ref=d022603a45358b7421d62161a685b8deb4f45e77", "patch": "@@ -1,15 +1,22 @@\n // compile-flags: -Zunleash-the-miri-inside-of-you\n // only-x86_64\n-#![feature(llvm_asm)]\n+#![feature(asm,llvm_asm)]\n #![allow(const_err)]\n \n fn main() {}\n \n // Make sure we catch executing inline assembly.\n-static TEST_BAD: () = {\n+static TEST_BAD1: () = {\n     unsafe { llvm_asm!(\"xor %eax, %eax\" ::: \"eax\"); }\n     //~^ ERROR could not evaluate static initializer\n     //~| NOTE inline assembly is not supported\n     //~| NOTE in this expansion of llvm_asm!\n     //~| NOTE in this expansion of llvm_asm!\n };\n+\n+// Make sure we catch executing inline assembly.\n+static TEST_BAD2: () = {\n+    unsafe { asm!(\"nop\"); }\n+    //~^ ERROR could not evaluate static initializer\n+    //~| NOTE inline assembly is not supported\n+};"}, {"sha": "d372b4a5d25c0a199804ab744bbff0aeedcc455d", "filename": "src/test/ui/consts/miri_unleashed/inline_asm.stderr", "status": "modified", "additions": 12, "deletions": 1, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/d022603a45358b7421d62161a685b8deb4f45e77/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Finline_asm.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/d022603a45358b7421d62161a685b8deb4f45e77/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Finline_asm.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Finline_asm.stderr?ref=d022603a45358b7421d62161a685b8deb4f45e77", "patch": "@@ -6,15 +6,26 @@ LL |     unsafe { llvm_asm!(\"xor %eax, %eax\" ::: \"eax\"); }\n    |\n    = note: this error originates in a macro (in Nightly builds, run with -Z macro-backtrace for more info)\n \n+error[E0080]: could not evaluate static initializer\n+  --> $DIR/inline_asm.rs:19:14\n+   |\n+LL |     unsafe { asm!(\"nop\"); }\n+   |              ^^^^^^^^^^^^ inline assembly is not supported\n+\n warning: skipping const checks\n    |\n help: skipping check that does not even have a feature gate\n   --> $DIR/inline_asm.rs:10:14\n    |\n LL |     unsafe { llvm_asm!(\"xor %eax, %eax\" ::: \"eax\"); }\n    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+help: skipping check that does not even have a feature gate\n+  --> $DIR/inline_asm.rs:19:14\n+   |\n+LL |     unsafe { asm!(\"nop\"); }\n+   |              ^^^^^^^^^^^^\n    = note: this warning originates in a macro (in Nightly builds, run with -Z macro-backtrace for more info)\n \n-error: aborting due to previous error; 1 warning emitted\n+error: aborting due to 2 previous errors; 1 warning emitted\n \n For more information about this error, try `rustc --explain E0080`."}, {"sha": "27cb80282352577340ee5fb60853bf452dc09761", "filename": "src/test/ui/consts/miri_unleashed/tls.rs", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/d022603a45358b7421d62161a685b8deb4f45e77/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Ftls.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d022603a45358b7421d62161a685b8deb4f45e77/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Ftls.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Ftls.rs?ref=d022603a45358b7421d62161a685b8deb4f45e77", "patch": "@@ -0,0 +1,17 @@\n+// compile-flags: -Zunleash-the-miri-inside-of-you\n+#![feature(thread_local)]\n+#![allow(const_err)]\n+\n+use std::thread;\n+\n+#[thread_local]\n+static A: u8 = 0;\n+\n+// Make sure we catch executing inline assembly.\n+static TEST_BAD: () = {\n+    unsafe { let _val = A; }\n+    //~^ ERROR could not evaluate static initializer\n+    //~| NOTE cannot access thread local static\n+};\n+\n+fn main() {}"}, {"sha": "d3e87f319acdeecbff43f5255950bd57b6f5a6b9", "filename": "src/test/ui/consts/miri_unleashed/tls.stderr", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/d022603a45358b7421d62161a685b8deb4f45e77/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Ftls.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/d022603a45358b7421d62161a685b8deb4f45e77/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Ftls.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fmiri_unleashed%2Ftls.stderr?ref=d022603a45358b7421d62161a685b8deb4f45e77", "patch": "@@ -0,0 +1,17 @@\n+error[E0080]: could not evaluate static initializer\n+  --> $DIR/tls.rs:12:25\n+   |\n+LL |     unsafe { let _val = A; }\n+   |                         ^ cannot access thread local static (DefId(0:4 ~ tls[317d]::A[0]))\n+\n+warning: skipping const checks\n+   |\n+help: skipping check that does not even have a feature gate\n+  --> $DIR/tls.rs:12:25\n+   |\n+LL |     unsafe { let _val = A; }\n+   |                         ^\n+\n+error: aborting due to previous error; 1 warning emitted\n+\n+For more information about this error, try `rustc --explain E0080`."}]}