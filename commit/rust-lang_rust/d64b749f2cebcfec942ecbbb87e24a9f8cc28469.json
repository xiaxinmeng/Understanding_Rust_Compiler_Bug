{"sha": "d64b749f2cebcfec942ecbbb87e24a9f8cc28469", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQ2NGI3NDlmMmNlYmNmZWM5NDJlY2JiYjg3ZTI0YTlmOGNjMjg0Njk=", "commit": {"author": {"name": "\u00d6mer Sinan A\u011facan", "email": "omeragacan@gmail.com", "date": "2021-01-28T17:22:33Z"}, "committer": {"name": "\u00d6mer Sinan A\u011facan", "email": "omeragacan@gmail.com", "date": "2021-02-10T12:44:41Z"}, "message": "Allow casting mut array ref to mut ptr\n\nWe now allow two new casts:\n\n- mut array reference to mut ptr. Example:\n\n      let mut x: [usize; 2] = [0, 0];\n      let p = &mut x as *mut usize;\n\n  We allow casting const array references to const pointers so not\n  allowing mut references to mut pointers was inconsistent.\n\n- mut array reference to const ptr. Example:\n\n      let mut x: [usize; 2] = [0, 0];\n      let p = &mut x as *const usize;\n\n  This was similarly inconsistent as we allow casting mut references to\n  const pointers.\n\nExisting test 'vector-cast-weirdness' updated to test both cases.\n\nFixes #24151", "tree": {"sha": "4beeddf028a59d62fbe674d92e0c680049e26ae2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4beeddf028a59d62fbe674d92e0c680049e26ae2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d64b749f2cebcfec942ecbbb87e24a9f8cc28469", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d64b749f2cebcfec942ecbbb87e24a9f8cc28469", "html_url": "https://github.com/rust-lang/rust/commit/d64b749f2cebcfec942ecbbb87e24a9f8cc28469", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d64b749f2cebcfec942ecbbb87e24a9f8cc28469/comments", "author": {"login": "osa1", "id": 448274, "node_id": "MDQ6VXNlcjQ0ODI3NA==", "avatar_url": "https://avatars.githubusercontent.com/u/448274?v=4", "gravatar_id": "", "url": "https://api.github.com/users/osa1", "html_url": "https://github.com/osa1", "followers_url": "https://api.github.com/users/osa1/followers", "following_url": "https://api.github.com/users/osa1/following{/other_user}", "gists_url": "https://api.github.com/users/osa1/gists{/gist_id}", "starred_url": "https://api.github.com/users/osa1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/osa1/subscriptions", "organizations_url": "https://api.github.com/users/osa1/orgs", "repos_url": "https://api.github.com/users/osa1/repos", "events_url": "https://api.github.com/users/osa1/events{/privacy}", "received_events_url": "https://api.github.com/users/osa1/received_events", "type": "User", "site_admin": false}, "committer": {"login": "osa1", "id": 448274, "node_id": "MDQ6VXNlcjQ0ODI3NA==", "avatar_url": "https://avatars.githubusercontent.com/u/448274?v=4", "gravatar_id": "", "url": "https://api.github.com/users/osa1", "html_url": "https://github.com/osa1", "followers_url": "https://api.github.com/users/osa1/followers", "following_url": "https://api.github.com/users/osa1/following{/other_user}", "gists_url": "https://api.github.com/users/osa1/gists{/gist_id}", "starred_url": "https://api.github.com/users/osa1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/osa1/subscriptions", "organizations_url": "https://api.github.com/users/osa1/orgs", "repos_url": "https://api.github.com/users/osa1/repos", "events_url": "https://api.github.com/users/osa1/events{/privacy}", "received_events_url": "https://api.github.com/users/osa1/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6523b721c3d8a92cf06aab04dd15ebe7fd5a9fb7", "url": "https://api.github.com/repos/rust-lang/rust/commits/6523b721c3d8a92cf06aab04dd15ebe7fd5a9fb7", "html_url": "https://github.com/rust-lang/rust/commit/6523b721c3d8a92cf06aab04dd15ebe7fd5a9fb7"}], "stats": {"total": 80, "additions": 55, "deletions": 25}, "files": [{"sha": "52b1ff3877da70fa2d43909b13f0aa08b3654fd0", "filename": "compiler/rustc_mir/src/borrow_check/type_check/mod.rs", "status": "modified", "additions": 24, "deletions": 15, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/d64b749f2cebcfec942ecbbb87e24a9f8cc28469/compiler%2Frustc_mir%2Fsrc%2Fborrow_check%2Ftype_check%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d64b749f2cebcfec942ecbbb87e24a9f8cc28469/compiler%2Frustc_mir%2Fsrc%2Fborrow_check%2Ftype_check%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Fborrow_check%2Ftype_check%2Fmod.rs?ref=d64b749f2cebcfec942ecbbb87e24a9f8cc28469", "patch": "@@ -2191,19 +2191,18 @@ impl<'a, 'tcx> TypeChecker<'a, 'tcx> {\n                     CastKind::Pointer(PointerCast::ArrayToPointer) => {\n                         let ty_from = op.ty(body, tcx);\n \n-                        let opt_ty_elem = match ty_from.kind() {\n-                            ty::RawPtr(ty::TypeAndMut {\n-                                mutbl: hir::Mutability::Not,\n-                                ty: array_ty,\n-                            }) => match array_ty.kind() {\n-                                ty::Array(ty_elem, _) => Some(ty_elem),\n-                                _ => None,\n-                            },\n+                        let opt_ty_elem_mut = match ty_from.kind() {\n+                            ty::RawPtr(ty::TypeAndMut { mutbl: array_mut, ty: array_ty }) => {\n+                                match array_ty.kind() {\n+                                    ty::Array(ty_elem, _) => Some((ty_elem, *array_mut)),\n+                                    _ => None,\n+                                }\n+                            }\n                             _ => None,\n                         };\n \n-                        let ty_elem = match opt_ty_elem {\n-                            Some(ty_elem) => ty_elem,\n+                        let (ty_elem, ty_mut) = match opt_ty_elem_mut {\n+                            Some(ty_elem_mut) => ty_elem_mut,\n                             None => {\n                                 span_mirbug!(\n                                     self,\n@@ -2215,11 +2214,10 @@ impl<'a, 'tcx> TypeChecker<'a, 'tcx> {\n                             }\n                         };\n \n-                        let ty_to = match ty.kind() {\n-                            ty::RawPtr(ty::TypeAndMut {\n-                                mutbl: hir::Mutability::Not,\n-                                ty: ty_to,\n-                            }) => ty_to,\n+                        let (ty_to, ty_to_mut) = match ty.kind() {\n+                            ty::RawPtr(ty::TypeAndMut { mutbl: ty_to_mut, ty: ty_to }) => {\n+                                (ty_to, *ty_to_mut)\n+                            }\n                             _ => {\n                                 span_mirbug!(\n                                     self,\n@@ -2231,6 +2229,17 @@ impl<'a, 'tcx> TypeChecker<'a, 'tcx> {\n                             }\n                         };\n \n+                        if ty_to_mut == Mutability::Mut && ty_mut == Mutability::Not {\n+                            span_mirbug!(\n+                                self,\n+                                rvalue,\n+                                \"ArrayToPointer cast from const {:?} to mut {:?}\",\n+                                ty,\n+                                ty_to\n+                            );\n+                            return;\n+                        }\n+\n                         if let Err(terr) = self.sub_types(\n                             ty_elem,\n                             ty_to,"}, {"sha": "16c344e8e2b9e2bc893bdf6051b112bf13292c90", "filename": "compiler/rustc_typeck/src/check/cast.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/d64b749f2cebcfec942ecbbb87e24a9f8cc28469/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fcast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d64b749f2cebcfec942ecbbb87e24a9f8cc28469/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fcast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fcast.rs?ref=d64b749f2cebcfec942ecbbb87e24a9f8cc28469", "patch": "@@ -765,9 +765,8 @@ impl<'a, 'tcx> CastCheck<'tcx> {\n         m_expr: ty::TypeAndMut<'tcx>,\n         m_cast: ty::TypeAndMut<'tcx>,\n     ) -> Result<CastKind, CastError> {\n-        // array-ptr-cast.\n-\n-        if m_expr.mutbl == hir::Mutability::Not && m_cast.mutbl == hir::Mutability::Not {\n+        // array-ptr-cast: allow mut-to-mut, mut-to-const, const-to-const\n+        if m_expr.mutbl == hir::Mutability::Mut || m_cast.mutbl == hir::Mutability::Not {\n             if let ty::Array(ety, _) = m_expr.ty.kind() {\n                 // Due to the limitations of LLVM global constants,\n                 // region pointers end up pointing at copies of"}, {"sha": "e8f2c71477a5fab5ce27c00d8216d441c7e1304c", "filename": "src/test/ui/array-slice-vec/vector-cast-weirdness.rs", "status": "modified", "additions": 12, "deletions": 2, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/d64b749f2cebcfec942ecbbb87e24a9f8cc28469/src%2Ftest%2Fui%2Farray-slice-vec%2Fvector-cast-weirdness.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d64b749f2cebcfec942ecbbb87e24a9f8cc28469/src%2Ftest%2Fui%2Farray-slice-vec%2Fvector-cast-weirdness.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Farray-slice-vec%2Fvector-cast-weirdness.rs?ref=d64b749f2cebcfec942ecbbb87e24a9f8cc28469", "patch": "@@ -1,7 +1,11 @@\n // Issue #14893. Tests that casts from vectors don't behave strangely in the\n // presence of the `_` type shorthand notation.\n+//\n // Update: after a change to the way casts are done, we have more type information\n // around and so the errors here are no longer exactly the same.\n+//\n+// Update: With PR #81479 some of the previously rejected cases are now allowed.\n+// New test cases added.\n \n struct X {\n     y: [u8; 2],\n@@ -12,13 +16,19 @@ fn main() {\n \n     // No longer a type mismatch - the `_` can be fully resolved by type inference.\n     let p1: *const u8 = &x1.y as *const _;\n+    let p1: *mut u8 = &x1.y as *mut _;\n+    //~^ ERROR: casting `&[u8; 2]` as `*mut u8` is invalid\n     let t1: *const [u8; 2] = &x1.y as *const _;\n+    let t1: *mut [u8; 2] = &x1.y as *mut _;\n+    //~^ ERROR: casting `&[u8; 2]` as `*mut [u8; 2]` is invalid\n     let h1: *const [u8; 2] = &x1.y as *const [u8; 2];\n+    let t1: *mut [u8; 2] = &x1.y as *mut [u8; 2];\n+    //~^ ERROR: casting `&[u8; 2]` as `*mut [u8; 2]` is invalid\n \n     let mut x1 = X { y: [0, 0] };\n \n-    // This is still an error since we don't allow casts from &mut [T; n] to *mut T.\n-    let p1: *mut u8 = &mut x1.y as *mut _;  //~ ERROR casting\n+    let p1: *mut u8 = &mut x1.y as *mut _;\n+    let p2: *const u8 = &mut x1.y as *const _;\n     let t1: *mut [u8; 2] = &mut x1.y as *mut _;\n     let h1: *mut [u8; 2] = &mut x1.y as *mut [u8; 2];\n }"}, {"sha": "6fdb1ac9e3059bb26d1dd77d2a08d23d50622726", "filename": "src/test/ui/array-slice-vec/vector-cast-weirdness.stderr", "status": "modified", "additions": 17, "deletions": 5, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/d64b749f2cebcfec942ecbbb87e24a9f8cc28469/src%2Ftest%2Fui%2Farray-slice-vec%2Fvector-cast-weirdness.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/d64b749f2cebcfec942ecbbb87e24a9f8cc28469/src%2Ftest%2Fui%2Farray-slice-vec%2Fvector-cast-weirdness.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Farray-slice-vec%2Fvector-cast-weirdness.stderr?ref=d64b749f2cebcfec942ecbbb87e24a9f8cc28469", "patch": "@@ -1,9 +1,21 @@\n-error[E0606]: casting `&mut [u8; 2]` as `*mut u8` is invalid\n-  --> $DIR/vector-cast-weirdness.rs:21:23\n+error[E0606]: casting `&[u8; 2]` as `*mut u8` is invalid\n+  --> $DIR/vector-cast-weirdness.rs:19:23\n    |\n-LL |     let p1: *mut u8 = &mut x1.y as *mut _;\n-   |                       ^^^^^^^^^^^^^^^^^^^\n+LL |     let p1: *mut u8 = &x1.y as *mut _;\n+   |                       ^^^^^^^^^^^^^^^\n \n-error: aborting due to previous error\n+error[E0606]: casting `&[u8; 2]` as `*mut [u8; 2]` is invalid\n+  --> $DIR/vector-cast-weirdness.rs:22:28\n+   |\n+LL |     let t1: *mut [u8; 2] = &x1.y as *mut _;\n+   |                            ^^^^^^^^^^^^^^^\n+\n+error[E0606]: casting `&[u8; 2]` as `*mut [u8; 2]` is invalid\n+  --> $DIR/vector-cast-weirdness.rs:25:28\n+   |\n+LL |     let t1: *mut [u8; 2] = &x1.y as *mut [u8; 2];\n+   |                            ^^^^^^^^^^^^^^^^^^^^^\n+\n+error: aborting due to 3 previous errors\n \n For more information about this error, try `rustc --explain E0606`."}]}