{"sha": "2b7ea14cc492fa010f8a914044faebd6c27333ab", "node_id": "MDY6Q29tbWl0NzI0NzEyOjJiN2VhMTRjYzQ5MmZhMDEwZjhhOTE0MDQ0ZmFlYmQ2YzI3MzMzYWI=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-08-13T16:52:49Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2016-08-13T16:52:49Z"}, "message": "Auto merge of #35414 - jupp0r:feature/test-threads-flag, r=alexcrichton\n\nAdd --test-threads option to test binaries\n\nThis change allows parallelism of test runs to be specified by a\ncommand line flag names --test-threads in addition to the existing\nenvironment variable RUST_TEST_THREADS. Fixes #25636.", "tree": {"sha": "c2bbadee72b041e075bd45645c3acd20fea27a22", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c2bbadee72b041e075bd45645c3acd20fea27a22"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2b7ea14cc492fa010f8a914044faebd6c27333ab", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2b7ea14cc492fa010f8a914044faebd6c27333ab", "html_url": "https://github.com/rust-lang/rust/commit/2b7ea14cc492fa010f8a914044faebd6c27333ab", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2b7ea14cc492fa010f8a914044faebd6c27333ab/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e64f68817d850ccbe642d7f067083bc655115d84", "url": "https://api.github.com/repos/rust-lang/rust/commits/e64f68817d850ccbe642d7f067083bc655115d84", "html_url": "https://github.com/rust-lang/rust/commit/e64f68817d850ccbe642d7f067083bc655115d84"}, {"sha": "6ca90942e744f79982a9b485e2367b0ecee14527", "url": "https://api.github.com/repos/rust-lang/rust/commits/6ca90942e744f79982a9b485e2367b0ecee14527", "html_url": "https://github.com/rust-lang/rust/commit/6ca90942e744f79982a9b485e2367b0ecee14527"}], "stats": {"total": 31, "additions": 26, "deletions": 5}, "files": [{"sha": "0eaf89a560fb84a1defe2357d3bbeff71c1845a0", "filename": "man/rustc.1", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/2b7ea14cc492fa010f8a914044faebd6c27333ab/man%2Frustc.1", "raw_url": "https://github.com/rust-lang/rust/raw/2b7ea14cc492fa010f8a914044faebd6c27333ab/man%2Frustc.1", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/man%2Frustc.1?ref=2b7ea14cc492fa010f8a914044faebd6c27333ab", "patch": "@@ -264,7 +264,8 @@ which link to the standard library.\n .TP\n \\fBRUST_TEST_THREADS\\fR\n The test framework Rust provides executes tests in parallel. This variable sets\n-the maximum number of threads used for this purpose.\n+the maximum number of threads used for this purpose. This setting is overridden\n+by the --test-threads option.\n \n .TP\n \\fBRUST_TEST_NOCAPTURE\\fR"}, {"sha": "850127d9f29505f72f0998f50e584346fd026dbd", "filename": "src/libtest/lib.rs", "status": "modified", "additions": 23, "deletions": 4, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/2b7ea14cc492fa010f8a914044faebd6c27333ab/src%2Flibtest%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2b7ea14cc492fa010f8a914044faebd6c27333ab/src%2Flibtest%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibtest%2Flib.rs?ref=2b7ea14cc492fa010f8a914044faebd6c27333ab", "patch": "@@ -303,6 +303,7 @@ pub struct TestOpts {\n     pub nocapture: bool,\n     pub color: ColorConfig,\n     pub quiet: bool,\n+    pub test_threads: Option<usize>,\n }\n \n impl TestOpts {\n@@ -317,6 +318,7 @@ impl TestOpts {\n             nocapture: false,\n             color: AutoColor,\n             quiet: false,\n+            test_threads: None,\n         }\n     }\n }\n@@ -334,6 +336,8 @@ fn optgroups() -> Vec<getopts::OptGroup> {\n                           of stdout\", \"PATH\"),\n       getopts::optflag(\"\", \"nocapture\", \"don't capture stdout/stderr of each \\\n                                          task, allow printing directly\"),\n+      getopts::optopt(\"\", \"test-threads\", \"Number of threads used for running tests \\\n+                                           in parallel\", \"n_threads\"),\n       getopts::optflag(\"q\", \"quiet\", \"Display one character per test instead of one line\"),\n       getopts::optopt(\"\", \"color\", \"Configure coloring of output:\n             auto   = colorize if stdout is a tty and tests are run on serially (default);\n@@ -349,7 +353,8 @@ The FILTER string is tested against the name of all tests, and only those\n tests whose names contain the filter are run.\n \n By default, all tests are run in parallel. This can be altered with the\n-RUST_TEST_THREADS environment variable when running tests (set it to 1).\n+--test-threads flag or the RUST_TEST_THREADS environment variable when running\n+tests (set it to 1).\n \n All tests have their standard output and standard error captured by default.\n This can be overridden with the --nocapture flag or setting RUST_TEST_NOCAPTURE\n@@ -408,6 +413,18 @@ pub fn parse_opts(args: &[String]) -> Option<OptRes> {\n         };\n     }\n \n+    let test_threads = match matches.opt_str(\"test-threads\") {\n+        Some(n_str) =>\n+            match n_str.parse::<usize>() {\n+                Ok(n) => Some(n),\n+                Err(e) =>\n+                    return Some(Err(format!(\"argument for --test-threads must be a number > 0 \\\n+                                             (error: {})\", e)))\n+            },\n+        None =>\n+            None,\n+    };\n+\n     let color = match matches.opt_str(\"color\").as_ref().map(|s| &**s) {\n         Some(\"auto\") | None => AutoColor,\n         Some(\"always\") => AlwaysColor,\n@@ -429,6 +446,7 @@ pub fn parse_opts(args: &[String]) -> Option<OptRes> {\n         nocapture: nocapture,\n         color: color,\n         quiet: quiet,\n+        test_threads: test_threads,\n     };\n \n     Some(Ok(test_opts))\n@@ -871,9 +889,10 @@ fn run_tests<F>(opts: &TestOpts, tests: Vec<TestDescAndFn>, mut callback: F) ->\n             }\n         });\n \n-    // It's tempting to just spawn all the tests at once, but since we have\n-    // many tests that run in other processes we would be making a big mess.\n-    let concurrency = get_concurrency();\n+    let concurrency = match opts.test_threads {\n+        Some(n) => n,\n+        None => get_concurrency(),\n+    };\n \n     let mut remaining = filtered_tests;\n     remaining.reverse();"}, {"sha": "90641b5c476d7bbd93412d4eeb878fa0f7295e52", "filename": "src/tools/compiletest/src/main.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/2b7ea14cc492fa010f8a914044faebd6c27333ab/src%2Ftools%2Fcompiletest%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2b7ea14cc492fa010f8a914044faebd6c27333ab/src%2Ftools%2Fcompiletest%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fmain.rs?ref=2b7ea14cc492fa010f8a914044faebd6c27333ab", "patch": "@@ -310,6 +310,7 @@ pub fn test_opts(config: &Config) -> test::TestOpts {\n             Err(_) => false\n         },\n         color: test::AutoColor,\n+        test_threads: None,\n     }\n }\n "}]}