{"sha": "c24a099e8b033470c12b2c5750b8dd76cf357477", "node_id": "MDY6Q29tbWl0NzI0NzEyOmMyNGEwOTllOGIwMzM0NzBjMTJiMmM1NzUwYjhkZDc2Y2YzNTc0Nzc=", "commit": {"author": {"name": "Daniel Silverstone", "email": "dsilvers@digital-scurf.org", "date": "2019-10-31T07:49:54Z"}, "committer": {"name": "Daniel Silverstone", "email": "dsilvers@digital-scurf.org", "date": "2019-10-31T07:49:54Z"}, "message": "rustdoc: Resolve module-level doc references more locally\n\nModule level docs should resolve intra-doc links as locally as\npossible.  As such, this commit alters the heuristic for finding\nintra-doc links such that we attempt to resolve names mentioned\nin *inner* documentation comments within the (sub-)module rather\nthat from the context of its parent.\n\nSigned-off-by: Daniel Silverstone <dsilvers@digital-scurf.org>", "tree": {"sha": "d8567429caa960bb6a4dd173313e4806466e84bb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d8567429caa960bb6a4dd173313e4806466e84bb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c24a099e8b033470c12b2c5750b8dd76cf357477", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQFPBAABCgA5FiEEbMzlsXMGvNwXnPlUww30OfKYfXQFAl26kiYbHGRzaWx2ZXJz\nQGRpZ2l0YWwtc2N1cmYub3JnAAoJEMMN9DnymH1004QH/2Wk2kVcX6YvzxoURZtW\nb5lnSIvapqvNWtgB/wGm5ZxqVbjg/UKodd4IOqDJcKWFwsvrs/AZV8QlBg8OkuM2\nTB24HYkD4LGQmT7l9nduLk2fuhyMBihN/rZJ5OtCgWaDDAe7I5ASCHeBqOoJd7Io\nUs/+lUl+pPk+lmgDlaEusYXmul2Q1QFnD1TWG/wsNCthZgLook1EVNlYzBnHR4zK\nSFvxJJ0i1KHO06m6GJHJomZL1LTMNubf0J/cKrHb1PHxS3Sm2WTgOaZwEd49f83k\nCw+2rLnSWGkoIJUNhfD9yMOlYobdnSxfa2bouqYDCsRv3CDq5NPb1D4ffRGK8tdT\nWrU=\n=V2L/\n-----END PGP SIGNATURE-----", "payload": "tree d8567429caa960bb6a4dd173313e4806466e84bb\nparent c553e8e8812c19809e70523064989e66c5cfd3f1\nauthor Daniel Silverstone <dsilvers@digital-scurf.org> 1572508194 +0000\ncommitter Daniel Silverstone <dsilvers@digital-scurf.org> 1572508194 +0000\n\nrustdoc: Resolve module-level doc references more locally\n\nModule level docs should resolve intra-doc links as locally as\npossible.  As such, this commit alters the heuristic for finding\nintra-doc links such that we attempt to resolve names mentioned\nin *inner* documentation comments within the (sub-)module rather\nthat from the context of its parent.\n\nSigned-off-by: Daniel Silverstone <dsilvers@digital-scurf.org>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c24a099e8b033470c12b2c5750b8dd76cf357477", "html_url": "https://github.com/rust-lang/rust/commit/c24a099e8b033470c12b2c5750b8dd76cf357477", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c24a099e8b033470c12b2c5750b8dd76cf357477/comments", "author": {"login": "kinnison", "id": 1469421, "node_id": "MDQ6VXNlcjE0Njk0MjE=", "avatar_url": "https://avatars.githubusercontent.com/u/1469421?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kinnison", "html_url": "https://github.com/kinnison", "followers_url": "https://api.github.com/users/kinnison/followers", "following_url": "https://api.github.com/users/kinnison/following{/other_user}", "gists_url": "https://api.github.com/users/kinnison/gists{/gist_id}", "starred_url": "https://api.github.com/users/kinnison/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kinnison/subscriptions", "organizations_url": "https://api.github.com/users/kinnison/orgs", "repos_url": "https://api.github.com/users/kinnison/repos", "events_url": "https://api.github.com/users/kinnison/events{/privacy}", "received_events_url": "https://api.github.com/users/kinnison/received_events", "type": "User", "site_admin": false}, "committer": {"login": "kinnison", "id": 1469421, "node_id": "MDQ6VXNlcjE0Njk0MjE=", "avatar_url": "https://avatars.githubusercontent.com/u/1469421?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kinnison", "html_url": "https://github.com/kinnison", "followers_url": "https://api.github.com/users/kinnison/followers", "following_url": "https://api.github.com/users/kinnison/following{/other_user}", "gists_url": "https://api.github.com/users/kinnison/gists{/gist_id}", "starred_url": "https://api.github.com/users/kinnison/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kinnison/subscriptions", "organizations_url": "https://api.github.com/users/kinnison/orgs", "repos_url": "https://api.github.com/users/kinnison/repos", "events_url": "https://api.github.com/users/kinnison/events{/privacy}", "received_events_url": "https://api.github.com/users/kinnison/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c553e8e8812c19809e70523064989e66c5cfd3f1", "url": "https://api.github.com/repos/rust-lang/rust/commits/c553e8e8812c19809e70523064989e66c5cfd3f1", "html_url": "https://github.com/rust-lang/rust/commit/c553e8e8812c19809e70523064989e66c5cfd3f1"}], "stats": {"total": 113, "additions": 109, "deletions": 4}, "files": [{"sha": "ab34f8daad7197bd1d64ba1573e8a3a68c76863f", "filename": "src/librustdoc/passes/collect_intra_doc_links.rs", "status": "modified", "additions": 21, "deletions": 4, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/c24a099e8b033470c12b2c5750b8dd76cf357477/src%2Flibrustdoc%2Fpasses%2Fcollect_intra_doc_links.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c24a099e8b033470c12b2c5750b8dd76cf357477/src%2Flibrustdoc%2Fpasses%2Fcollect_intra_doc_links.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fcollect_intra_doc_links.rs?ref=c24a099e8b033470c12b2c5750b8dd76cf357477", "patch": "@@ -322,9 +322,26 @@ impl<'a, 'tcx> DocFolder for LinkCollector<'a, 'tcx> {\n                     continue;\n                 }\n \n+                // In order to correctly resolve intra-doc-links we need to\n+                // pick a base AST node to work from.  If the documentation for\n+                // this module came from an inner comment (//!) then we anchor\n+                // our name resolution *inside* the module.  If, on the other\n+                // hand it was an outer comment (///) then we anchor the name\n+                // resolution in the parent module on the basis that the names\n+                // used are more likely to be intended to be parent names.  For\n+                // this, we set base_node to None for inner comments since\n+                // we've already pushed this node onto the resolution stack but\n+                // for outer comments we explicitly try and resolve against the\n+                // parent_node first.\n+                let base_node = if item.is_mod() && item.attrs.inner_docs {\n+                    None\n+                } else {\n+                    parent_node\n+                };\n+\n                 match kind {\n                     Some(ns @ ValueNS) => {\n-                        if let Ok(res) = self.resolve(path_str, ns, &current_item, parent_node) {\n+                        if let Ok(res) = self.resolve(path_str, ns, &current_item, base_node) {\n                             res\n                         } else {\n                             resolution_failure(cx, &item, path_str, &dox, link_range);\n@@ -335,7 +352,7 @@ impl<'a, 'tcx> DocFolder for LinkCollector<'a, 'tcx> {\n                         }\n                     }\n                     Some(ns @ TypeNS) => {\n-                        if let Ok(res) = self.resolve(path_str, ns, &current_item, parent_node) {\n+                        if let Ok(res) = self.resolve(path_str, ns, &current_item, base_node) {\n                             res\n                         } else {\n                             resolution_failure(cx, &item, path_str, &dox, link_range);\n@@ -348,10 +365,10 @@ impl<'a, 'tcx> DocFolder for LinkCollector<'a, 'tcx> {\n                         let candidates = PerNS {\n                             macro_ns: macro_resolve(cx, path_str).map(|res| (res, None)),\n                             type_ns: self\n-                                .resolve(path_str, TypeNS, &current_item, parent_node)\n+                                .resolve(path_str, TypeNS, &current_item, base_node)\n                                 .ok(),\n                             value_ns: self\n-                                .resolve(path_str, ValueNS, &current_item, parent_node)\n+                                .resolve(path_str, ValueNS, &current_item, base_node)\n                                 .ok()\n                                 .and_then(|(res, fragment)| {\n                                     // Constructors are picked up in the type namespace."}, {"sha": "200a29fc7eea373727d6f6b1e1c3e45d224b621e", "filename": "src/test/rustdoc/issue-55364.rs", "status": "added", "additions": 88, "deletions": 0, "changes": 88, "blob_url": "https://github.com/rust-lang/rust/blob/c24a099e8b033470c12b2c5750b8dd76cf357477/src%2Ftest%2Frustdoc%2Fissue-55364.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c24a099e8b033470c12b2c5750b8dd76cf357477/src%2Ftest%2Frustdoc%2Fissue-55364.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fissue-55364.rs?ref=c24a099e8b033470c12b2c5750b8dd76cf357477", "patch": "@@ -0,0 +1,88 @@\n+// ignore-tidy-linelength\n+\n+// First a module with inner documentation\n+\n+// @has issue_55364/subone/index.html\n+// These foo/bar links in the module's documentation should refer inside `subone`\n+// @has - '//section[@id=\"main\"]/div[@class=\"docblock\"]//a[@href=\"../../issue_55364/subone/fn.foo.html\"]' 'foo'\n+// @has - '//section[@id=\"main\"]/div[@class=\"docblock\"]//a[@href=\"../../issue_55364/subone/fn.bar.html\"]' 'bar'\n+pub mod subone {\n+    //! See either [foo] or [bar].\n+\n+    // This should refer to subone's `bar`\n+    // @has issue_55364/subone/fn.foo.html\n+    // @has - '//section[@id=\"main\"]/div[@class=\"docblock\"]//a[@href=\"../../issue_55364/subone/fn.bar.html\"]' 'bar'\n+    /// See [bar]\n+    pub fn foo() {}\n+    // This should refer to subone's `foo`\n+    // @has issue_55364/subone/fn.bar.html\n+    // @has - '//section[@id=\"main\"]/div[@class=\"docblock\"]//a[@href=\"../../issue_55364/subone/fn.foo.html\"]' 'foo'\n+    /// See [foo]\n+    pub fn bar() {}\n+}\n+\n+// A module with outer documentation\n+\n+// @has issue_55364/subtwo/index.html\n+// These foo/bar links in the module's documentation should not reference inside `subtwo`\n+// @!has - '//section[@id=\"main\"]/div[@class=\"docblock\"]//a[@href=\"../../issue_55364/subtwo/fn.foo.html\"]' 'foo'\n+// @!has - '//section[@id=\"main\"]/div[@class=\"docblock\"]//a[@href=\"../../issue_55364/subtwo/fn.bar.html\"]' 'bar'\n+// Instead it should be referencing the top level functions\n+// @has - '//section[@id=\"main\"]/div[@class=\"docblock\"]//a[@href=\"../../issue_55364/fn.foo.html\"]' 'foo'\n+// @has - '//section[@id=\"main\"]/div[@class=\"docblock\"]//a[@href=\"../../issue_55364/fn.bar.html\"]' 'bar'\n+// Though there should be such links later\n+// @has - '//section[@id=\"main\"]/table//tr[@class=\"module-item\"]/td/a[@class=\"fn\"][@href=\"fn.foo.html\"]' 'foo'\n+// @has - '//section[@id=\"main\"]/table//tr[@class=\"module-item\"]/td/a[@class=\"fn\"][@href=\"fn.bar.html\"]' 'bar'\n+/// See either [foo] or [bar].\n+pub mod subtwo {\n+\n+    // Despite the module's docs referring to the top level foo/bar,\n+    // this should refer to subtwo's `bar`\n+    // @has issue_55364/subtwo/fn.foo.html\n+    // @has - '//section[@id=\"main\"]/div[@class=\"docblock\"]//a[@href=\"../../issue_55364/subtwo/fn.bar.html\"]' 'bar'\n+    /// See [bar]\n+    pub fn foo() {}\n+    // Despite the module's docs referring to the top level foo/bar,\n+    // this should refer to subtwo's `foo`\n+    // @has issue_55364/subtwo/fn.bar.html\n+    // @has - '//section[@id=\"main\"]/div[@class=\"docblock\"]//a[@href=\"../../issue_55364/subtwo/fn.foo.html\"]' 'foo'\n+    /// See [foo]\n+    pub fn bar() {}\n+}\n+\n+// These are the function referred to by the module above with outer docs\n+\n+/// See [bar]\n+pub fn foo() {}\n+/// See [foo]\n+pub fn bar() {}\n+\n+// This module refers to the outer foo/bar by means of `super::`\n+\n+// @has issue_55364/subthree/index.html\n+// This module should also refer to the top level foo/bar\n+// @has - '//section[@id=\"main\"]/div[@class=\"docblock\"]//a[@href=\"../../issue_55364/fn.foo.html\"]' 'foo'\n+// @has - '//section[@id=\"main\"]/div[@class=\"docblock\"]//a[@href=\"../../issue_55364/fn.bar.html\"]' 'bar'\n+pub mod subthree {\n+    //! See either [foo][super::foo] or [bar][super::bar]\n+}\n+\n+// Next we go *deeper* - In order to ensure it's not just \"this or parent\"\n+// we test `crate::` and a `super::super::...` chain\n+// @has issue_55364/subfour/subfive/subsix/subseven/subeight/index.html\n+// @has - '//section[@id=\"main\"]/table//tr[@class=\"module-item\"]/td[@class=\"docblock-short\"]//a[@href=\"../../../../../../issue_55364/subone/fn.foo.html\"]' 'other foo'\n+// @has - '//section[@id=\"main\"]/table//tr[@class=\"module-item\"]/td[@class=\"docblock-short\"]//a[@href=\"../../../../../../issue_55364/subtwo/fn.bar.html\"]' 'other bar'\n+pub mod subfour {\n+    pub mod subfive {\n+        pub mod subsix {\n+            pub mod subseven {\n+                pub mod subeight {\n+                    /// See [other foo][crate::subone::foo]\n+                    pub fn foo() {}\n+                    /// See [other bar][super::super::super::super::super::subtwo::bar]\n+                    pub fn bar() {}\n+                }\n+            }\n+        }\n+    }\n+}"}]}