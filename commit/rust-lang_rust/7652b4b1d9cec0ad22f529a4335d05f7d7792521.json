{"sha": "7652b4b1d9cec0ad22f529a4335d05f7d7792521", "node_id": "MDY6Q29tbWl0NzI0NzEyOjc2NTJiNGIxZDljZWMwYWQyMmY1MjlhNDMzNWQwNWY3ZDc3OTI1MjE=", "commit": {"author": {"name": "Bastian Kauschke", "email": "bastian_kauschke@hotmail.de", "date": "2020-09-18T20:24:53Z"}, "committer": {"name": "Bastian Kauschke", "email": "bastian_kauschke@hotmail.de", "date": "2020-09-18T20:24:53Z"}, "message": "guard against `skip_binder` errors during FlagComputation", "tree": {"sha": "21129983e755e3a272a4c86c00202db93e9bc033", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/21129983e755e3a272a4c86c00202db93e9bc033"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7652b4b1d9cec0ad22f529a4335d05f7d7792521", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7652b4b1d9cec0ad22f529a4335d05f7d7792521", "html_url": "https://github.com/rust-lang/rust/commit/7652b4b1d9cec0ad22f529a4335d05f7d7792521", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7652b4b1d9cec0ad22f529a4335d05f7d7792521/comments", "author": {"login": "lcnr", "id": 29864074, "node_id": "MDQ6VXNlcjI5ODY0MDc0", "avatar_url": "https://avatars.githubusercontent.com/u/29864074?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lcnr", "html_url": "https://github.com/lcnr", "followers_url": "https://api.github.com/users/lcnr/followers", "following_url": "https://api.github.com/users/lcnr/following{/other_user}", "gists_url": "https://api.github.com/users/lcnr/gists{/gist_id}", "starred_url": "https://api.github.com/users/lcnr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lcnr/subscriptions", "organizations_url": "https://api.github.com/users/lcnr/orgs", "repos_url": "https://api.github.com/users/lcnr/repos", "events_url": "https://api.github.com/users/lcnr/events{/privacy}", "received_events_url": "https://api.github.com/users/lcnr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lcnr", "id": 29864074, "node_id": "MDQ6VXNlcjI5ODY0MDc0", "avatar_url": "https://avatars.githubusercontent.com/u/29864074?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lcnr", "html_url": "https://github.com/lcnr", "followers_url": "https://api.github.com/users/lcnr/followers", "following_url": "https://api.github.com/users/lcnr/following{/other_user}", "gists_url": "https://api.github.com/users/lcnr/gists{/gist_id}", "starred_url": "https://api.github.com/users/lcnr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lcnr/subscriptions", "organizations_url": "https://api.github.com/users/lcnr/orgs", "repos_url": "https://api.github.com/users/lcnr/repos", "events_url": "https://api.github.com/users/lcnr/events{/privacy}", "received_events_url": "https://api.github.com/users/lcnr/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "fd22e87afc9082522bc7b52e32d25d43c64594e6", "url": "https://api.github.com/repos/rust-lang/rust/commits/fd22e87afc9082522bc7b52e32d25d43c64594e6", "html_url": "https://github.com/rust-lang/rust/commit/fd22e87afc9082522bc7b52e32d25d43c64594e6"}], "stats": {"total": 68, "additions": 33, "deletions": 35}, "files": [{"sha": "b66c65f3b64685e5cb47b0783d93ca62efecfa6d", "filename": "compiler/rustc_middle/src/ty/context.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/7652b4b1d9cec0ad22f529a4335d05f7d7792521/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7652b4b1d9cec0ad22f529a4335d05f7d7792521/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs?ref=7652b4b1d9cec0ad22f529a4335d05f7d7792521", "patch": "@@ -134,7 +134,7 @@ impl<'tcx> CtxtInterners<'tcx> {\n     fn intern_predicate(&self, kind: PredicateKind<'tcx>) -> &'tcx PredicateInner<'tcx> {\n         self.predicate\n             .intern(kind, |kind| {\n-                let flags = super::flags::FlagComputation::for_predicate(&kind);\n+                let flags = super::flags::FlagComputation::for_predicate(kind);\n \n                 let predicate_struct = PredicateInner {\n                     kind,"}, {"sha": "8b97a87f214b83955fffc55fd2348464fd6ddc46", "filename": "compiler/rustc_middle/src/ty/flags.rs", "status": "modified", "additions": 32, "deletions": 34, "changes": 66, "blob_url": "https://github.com/rust-lang/rust/blob/7652b4b1d9cec0ad22f529a4335d05f7d7792521/compiler%2Frustc_middle%2Fsrc%2Fty%2Fflags.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7652b4b1d9cec0ad22f529a4335d05f7d7792521/compiler%2Frustc_middle%2Fsrc%2Fty%2Fflags.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fflags.rs?ref=7652b4b1d9cec0ad22f529a4335d05f7d7792521", "patch": "@@ -22,7 +22,7 @@ impl FlagComputation {\n         result\n     }\n \n-    pub fn for_predicate(kind: &ty::PredicateKind<'_>) -> FlagComputation {\n+    pub fn for_predicate(kind: ty::PredicateKind<'_>) -> FlagComputation {\n         let mut result = FlagComputation::new();\n         result.add_predicate_kind(kind);\n         result\n@@ -53,7 +53,14 @@ impl FlagComputation {\n \n     /// Adds the flags/depth from a set of types that appear within the current type, but within a\n     /// region binder.\n-    fn add_bound_computation(&mut self, computation: FlagComputation) {\n+    fn bound_computation<T, F>(&mut self, value: ty::Binder<T>, f: F)\n+    where\n+        F: FnOnce(&mut Self, T),\n+    {\n+        let mut computation = FlagComputation::new();\n+\n+        f(&mut computation, value.skip_binder());\n+\n         self.add_flags(computation.flags);\n \n         // The types that contributed to `computation` occurred within\n@@ -101,9 +108,7 @@ impl FlagComputation {\n             }\n \n             &ty::GeneratorWitness(ts) => {\n-                let mut computation = FlagComputation::new();\n-                computation.add_tys(ts.skip_binder());\n-                self.add_bound_computation(computation);\n+                self.bound_computation(ts, |flags, ts| flags.add_tys(ts));\n             }\n \n             &ty::Closure(_, substs) => {\n@@ -154,18 +159,21 @@ impl FlagComputation {\n                 self.add_substs(substs);\n             }\n \n-            &ty::Dynamic(ref obj, r) => {\n-                let mut computation = FlagComputation::new();\n-                for predicate in obj.skip_binder().iter() {\n-                    match predicate {\n-                        ty::ExistentialPredicate::Trait(tr) => computation.add_substs(tr.substs),\n-                        ty::ExistentialPredicate::Projection(p) => {\n-                            computation.add_existential_projection(&p);\n+            &ty::Dynamic(obj, r) => {\n+                self.bound_computation(obj, |computation, obj| {\n+                    for predicate in obj.iter() {\n+                        match predicate {\n+                            ty::ExistentialPredicate::Trait(tr) => {\n+                                computation.add_substs(tr.substs)\n+                            }\n+                            ty::ExistentialPredicate::Projection(p) => {\n+                                computation.add_existential_projection(&p);\n+                            }\n+                            ty::ExistentialPredicate::AutoTrait(_) => {}\n                         }\n-                        ty::ExistentialPredicate::AutoTrait(_) => {}\n                     }\n-                }\n-                self.add_bound_computation(computation);\n+                });\n+\n                 self.add_region(r);\n             }\n \n@@ -193,22 +201,21 @@ impl FlagComputation {\n                 self.add_substs(substs);\n             }\n \n-            &ty::FnPtr(f) => {\n-                self.add_fn_sig(f);\n-            }\n+            &ty::FnPtr(fn_sig) => self.bound_computation(fn_sig, |computation, fn_sig| {\n+                computation.add_tys(fn_sig.inputs());\n+                computation.add_ty(fn_sig.output());\n+            }),\n         }\n     }\n \n-    fn add_predicate_kind(&mut self, kind: &ty::PredicateKind<'_>) {\n+    fn add_predicate_kind(&mut self, kind: ty::PredicateKind<'_>) {\n         match kind {\n             ty::PredicateKind::ForAll(binder) => {\n-                let mut computation = FlagComputation::new();\n-\n-                computation.add_predicate_atom(binder.skip_binder());\n-\n-                self.add_bound_computation(computation);\n+                self.bound_computation(binder, |computation, atom| {\n+                    computation.add_predicate_atom(atom)\n+                });\n             }\n-            &ty::PredicateKind::Atom(atom) => self.add_predicate_atom(atom),\n+            ty::PredicateKind::Atom(atom) => self.add_predicate_atom(atom),\n         }\n     }\n \n@@ -264,15 +271,6 @@ impl FlagComputation {\n         }\n     }\n \n-    fn add_fn_sig(&mut self, fn_sig: ty::PolyFnSig<'_>) {\n-        let mut computation = FlagComputation::new();\n-\n-        computation.add_tys(fn_sig.skip_binder().inputs());\n-        computation.add_ty(fn_sig.skip_binder().output());\n-\n-        self.add_bound_computation(computation);\n-    }\n-\n     fn add_region(&mut self, r: ty::Region<'_>) {\n         self.add_flags(r.type_flags());\n         if let ty::ReLateBound(debruijn, _) = *r {"}]}