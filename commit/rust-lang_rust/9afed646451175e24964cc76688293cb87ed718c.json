{"sha": "9afed646451175e24964cc76688293cb87ed718c", "node_id": "MDY6Q29tbWl0NzI0NzEyOjlhZmVkNjQ2NDUxMTc1ZTI0OTY0Y2M3NjY4ODI5M2NiODdlZDcxOGM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-04-12T08:29:10Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-04-12T08:29:10Z"}, "message": "Auto merge of #49551 - scottmcm:deprecate-offset_to, r=KodrAus\n\nDeprecate offset_to; switch core&alloc to using offset_from instead\n\nBonus: might make code than uses `.len()` on slice iterators faster\n\ncc https://github.com/rust-lang/rust/issues/41079", "tree": {"sha": "ff518211ee157f47f822f7652c053251b34ccf2f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ff518211ee157f47f822f7652c053251b34ccf2f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9afed646451175e24964cc76688293cb87ed718c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9afed646451175e24964cc76688293cb87ed718c", "html_url": "https://github.com/rust-lang/rust/commit/9afed646451175e24964cc76688293cb87ed718c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9afed646451175e24964cc76688293cb87ed718c/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "252a459d373f40512ed9137d59e4b6bea5d6aaee", "url": "https://api.github.com/repos/rust-lang/rust/commits/252a459d373f40512ed9137d59e4b6bea5d6aaee", "html_url": "https://github.com/rust-lang/rust/commit/252a459d373f40512ed9137d59e4b6bea5d6aaee"}, {"sha": "b394165538bc52063f79a1820135cfefa19370e7", "url": "https://api.github.com/repos/rust-lang/rust/commits/b394165538bc52063f79a1820135cfefa19370e7", "html_url": "https://github.com/rust-lang/rust/commit/b394165538bc52063f79a1820135cfefa19370e7"}], "stats": {"total": 32, "additions": 19, "deletions": 13}, "files": [{"sha": "5ca394423427037407f74e364c49e7666627198c", "filename": "src/liballoc/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/9afed646451175e24964cc76688293cb87ed718c/src%2Fliballoc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9afed646451175e24964cc76688293cb87ed718c/src%2Fliballoc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fliballoc%2Flib.rs?ref=9afed646451175e24964cc76688293cb87ed718c", "patch": "@@ -99,11 +99,11 @@\n #![feature(lang_items)]\n #![feature(needs_allocator)]\n #![feature(nonzero)]\n-#![feature(offset_to)]\n #![feature(optin_builtin_traits)]\n #![feature(pattern)]\n #![feature(pin)]\n #![feature(ptr_internals)]\n+#![feature(ptr_offset_from)]\n #![feature(rustc_attrs)]\n #![feature(slice_get_slice)]\n #![feature(slice_rsplit)]"}, {"sha": "0f74743ca49a9e41c76a45d7bf44392933c80582", "filename": "src/liballoc/vec.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/9afed646451175e24964cc76688293cb87ed718c/src%2Fliballoc%2Fvec.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9afed646451175e24964cc76688293cb87ed718c/src%2Fliballoc%2Fvec.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fliballoc%2Fvec.rs?ref=9afed646451175e24964cc76688293cb87ed718c", "patch": "@@ -2394,9 +2394,10 @@ impl<T> Iterator for IntoIter<T> {\n \n     #[inline]\n     fn size_hint(&self) -> (usize, Option<usize>) {\n-        let exact = match self.ptr.offset_to(self.end) {\n-            Some(x) => x as usize,\n-            None => (self.end as usize).wrapping_sub(self.ptr as usize),\n+        let exact = if mem::size_of::<T>() == 0 {\n+            (self.end as usize).wrapping_sub(self.ptr as usize)\n+        } else {\n+            unsafe { self.end.offset_from(self.ptr) as usize }\n         };\n         (exact, Some(exact))\n     }"}, {"sha": "c1e150e9fb909906e41d4b35835b64c4df4e8b47", "filename": "src/libcore/ptr.rs", "status": "modified", "additions": 8, "deletions": 4, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/9afed646451175e24964cc76688293cb87ed718c/src%2Flibcore%2Fptr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9afed646451175e24964cc76688293cb87ed718c/src%2Flibcore%2Fptr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fptr.rs?ref=9afed646451175e24964cc76688293cb87ed718c", "patch": "@@ -677,6 +677,7 @@ impl<T: ?Sized> *const T {\n     ///\n     /// ```\n     /// #![feature(offset_to)]\n+    /// #![allow(deprecated)]\n     ///\n     /// fn main() {\n     ///     let a = [0; 5];\n@@ -689,14 +690,15 @@ impl<T: ?Sized> *const T {\n     /// }\n     /// ```\n     #[unstable(feature = \"offset_to\", issue = \"41079\")]\n+    #[rustc_deprecated(since = \"1.27.0\", reason = \"Replaced by `wrapping_offset_from`, with the \\\n+        opposite argument order.  If you're writing unsafe code, consider `offset_from`.\")]\n     #[inline]\n     pub fn offset_to(self, other: *const T) -> Option<isize> where T: Sized {\n         let size = mem::size_of::<T>();\n         if size == 0 {\n             None\n         } else {\n-            let diff = (other as isize).wrapping_sub(self as isize);\n-            Some(diff / size as isize)\n+            Some(other.wrapping_offset_from(self))\n         }\n     }\n \n@@ -1442,6 +1444,7 @@ impl<T: ?Sized> *mut T {\n     ///\n     /// ```\n     /// #![feature(offset_to)]\n+    /// #![allow(deprecated)]\n     ///\n     /// fn main() {\n     ///     let mut a = [0; 5];\n@@ -1454,14 +1457,15 @@ impl<T: ?Sized> *mut T {\n     /// }\n     /// ```\n     #[unstable(feature = \"offset_to\", issue = \"41079\")]\n+    #[rustc_deprecated(since = \"1.27.0\", reason = \"Replaced by `wrapping_offset_from`, with the \\\n+        opposite argument order.  If you're writing unsafe code, consider `offset_from`.\")]\n     #[inline]\n     pub fn offset_to(self, other: *const T) -> Option<isize> where T: Sized {\n         let size = mem::size_of::<T>();\n         if size == 0 {\n             None\n         } else {\n-            let diff = (other as isize).wrapping_sub(self as isize);\n-            Some(diff / size as isize)\n+            Some(other.wrapping_offset_from(self))\n         }\n     }\n "}, {"sha": "0a22028da81f4b3293015033eb8c8a535fdd497a", "filename": "src/libcore/slice/mod.rs", "status": "modified", "additions": 6, "deletions": 5, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/9afed646451175e24964cc76688293cb87ed718c/src%2Flibcore%2Fslice%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9afed646451175e24964cc76688293cb87ed718c/src%2Flibcore%2Fslice%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fslice%2Fmod.rs?ref=9afed646451175e24964cc76688293cb87ed718c", "patch": "@@ -1185,7 +1185,7 @@ macro_rules! iterator {\n \n             #[inline]\n             fn size_hint(&self) -> (usize, Option<usize>) {\n-                let exact = ptrdistance(self.ptr, self.end);\n+                let exact = unsafe { ptrdistance(self.ptr, self.end) };\n                 (exact, Some(exact))\n             }\n \n@@ -1593,10 +1593,11 @@ unsafe impl<'a, T> TrustedLen for IterMut<'a, T> {}\n // Return the number of elements of `T` from `start` to `end`.\n // Return the arithmetic difference if `T` is zero size.\n #[inline(always)]\n-fn ptrdistance<T>(start: *const T, end: *const T) -> usize {\n-    match start.offset_to(end) {\n-        Some(x) => x as usize,\n-        None => (end as usize).wrapping_sub(start as usize),\n+unsafe fn ptrdistance<T>(start: *const T, end: *const T) -> usize {\n+    if mem::size_of::<T>() == 0 {\n+        (end as usize).wrapping_sub(start as usize)\n+    } else {\n+        end.offset_from(start) as usize\n     }\n }\n "}]}