{"sha": "3c55af5b09877c22405ed345c2873b9c5b33a20a", "node_id": "C_kwDOAAsO6NoAKDNjNTVhZjViMDk4NzdjMjI0MDVlZDM0NWMyODczYjljNWIzM2EyMGE", "commit": {"author": {"name": "Gavin Li", "email": "gavinli@thegavinli.com", "date": "2022-12-04T05:54:38Z"}, "committer": {"name": "Gavin Li", "email": "gavinli@thegavinli.com", "date": "2022-12-07T21:12:29Z"}, "message": "Avoid heap allocation when truncating thread names\n\nEnsure that heap allocation does not occur in a thread until std::thread\nis ready. This fixes issues with custom allocators that call\nstd::thread::current(), since doing so prematurely initializes\nTHREAD_INFO and causes the following thread_info::set() to fail.", "tree": {"sha": "1398e7c1d82036775e30dfbc5f2822fc91dc2303", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1398e7c1d82036775e30dfbc5f2822fc91dc2303"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3c55af5b09877c22405ed345c2873b9c5b33a20a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3c55af5b09877c22405ed345c2873b9c5b33a20a", "html_url": "https://github.com/rust-lang/rust/commit/3c55af5b09877c22405ed345c2873b9c5b33a20a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3c55af5b09877c22405ed345c2873b9c5b33a20a/comments", "author": {"login": "gh2o", "id": 371529, "node_id": "MDQ6VXNlcjM3MTUyOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/371529?v=4", "gravatar_id": "", "url": "https://api.github.com/users/gh2o", "html_url": "https://github.com/gh2o", "followers_url": "https://api.github.com/users/gh2o/followers", "following_url": "https://api.github.com/users/gh2o/following{/other_user}", "gists_url": "https://api.github.com/users/gh2o/gists{/gist_id}", "starred_url": "https://api.github.com/users/gh2o/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/gh2o/subscriptions", "organizations_url": "https://api.github.com/users/gh2o/orgs", "repos_url": "https://api.github.com/users/gh2o/repos", "events_url": "https://api.github.com/users/gh2o/events{/privacy}", "received_events_url": "https://api.github.com/users/gh2o/received_events", "type": "User", "site_admin": false}, "committer": {"login": "gh2o", "id": 371529, "node_id": "MDQ6VXNlcjM3MTUyOQ==", "avatar_url": "https://avatars.githubusercontent.com/u/371529?v=4", "gravatar_id": "", "url": "https://api.github.com/users/gh2o", "html_url": "https://github.com/gh2o", "followers_url": "https://api.github.com/users/gh2o/followers", "following_url": "https://api.github.com/users/gh2o/following{/other_user}", "gists_url": "https://api.github.com/users/gh2o/gists{/gist_id}", "starred_url": "https://api.github.com/users/gh2o/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/gh2o/subscriptions", "organizations_url": "https://api.github.com/users/gh2o/orgs", "repos_url": "https://api.github.com/users/gh2o/repos", "events_url": "https://api.github.com/users/gh2o/events{/privacy}", "received_events_url": "https://api.github.com/users/gh2o/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2a39e45afba72fb2d456a02af4d290d16aebe621", "url": "https://api.github.com/repos/rust-lang/rust/commits/2a39e45afba72fb2d456a02af4d290d16aebe621", "html_url": "https://github.com/rust-lang/rust/commit/2a39e45afba72fb2d456a02af4d290d16aebe621"}], "stats": {"total": 19, "additions": 7, "deletions": 12}, "files": [{"sha": "6ecf5bdcf86d2bf792695eb1720f3c10c403eadf", "filename": "library/std/src/sys/unix/thread.rs", "status": "modified", "additions": 7, "deletions": 12, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/3c55af5b09877c22405ed345c2873b9c5b33a20a/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fthread.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3c55af5b09877c22405ed345c2873b9c5b33a20a/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fthread.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fthread.rs?ref=3c55af5b09877c22405ed345c2873b9c5b33a20a", "patch": "@@ -136,7 +136,7 @@ impl Thread {\n \n         unsafe {\n             // Available since glibc 2.12, musl 1.1.16, and uClibc 1.0.20.\n-            let name = truncate_cstr(name, TASK_COMM_LEN);\n+            let name = truncate_cstr::<{ TASK_COMM_LEN }>(name);\n             let res = libc::pthread_setname_np(libc::pthread_self(), name.as_ptr());\n             // We have no good way of propagating errors here, but in debug-builds let's check that this actually worked.\n             debug_assert_eq!(res, 0);\n@@ -153,7 +153,7 @@ impl Thread {\n     #[cfg(any(target_os = \"macos\", target_os = \"ios\", target_os = \"watchos\"))]\n     pub fn set_name(name: &CStr) {\n         unsafe {\n-            let name = truncate_cstr(name, libc::MAXTHREADNAMESIZE);\n+            let name = truncate_cstr::<{ libc::MAXTHREADNAMESIZE }>(name);\n             let res = libc::pthread_setname_np(name.as_ptr());\n             // We have no good way of propagating errors here, but in debug-builds let's check that this actually worked.\n             debug_assert_eq!(res, 0);\n@@ -285,17 +285,12 @@ impl Drop for Thread {\n }\n \n #[cfg(any(target_os = \"linux\", target_os = \"macos\", target_os = \"ios\", target_os = \"watchos\"))]\n-fn truncate_cstr(cstr: &CStr, max_with_nul: usize) -> crate::borrow::Cow<'_, CStr> {\n-    use crate::{borrow::Cow, ffi::CString};\n-\n-    if cstr.to_bytes_with_nul().len() > max_with_nul {\n-        let bytes = cstr.to_bytes()[..max_with_nul - 1].to_vec();\n-        // SAFETY: the non-nul bytes came straight from a CStr.\n-        // (CString will add the terminating nul.)\n-        Cow::Owned(unsafe { CString::from_vec_unchecked(bytes) })\n-    } else {\n-        Cow::Borrowed(cstr)\n+fn truncate_cstr<const MAX_WITH_NUL: usize>(cstr: &CStr) -> [libc::c_char; MAX_WITH_NUL] {\n+    let mut result = [0; MAX_WITH_NUL];\n+    for (src, dst) in cstr.to_bytes().iter().zip(&mut result[..MAX_WITH_NUL - 1]) {\n+        *dst = *src as libc::c_char;\n     }\n+    result\n }\n \n pub fn available_parallelism() -> io::Result<NonZeroUsize> {"}]}