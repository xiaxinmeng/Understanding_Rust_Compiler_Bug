{"sha": "48d54942f55078cd5866a96bd182bbaf2b81d0f6", "node_id": "C_kwDOAAsO6NoAKDQ4ZDU0OTQyZjU1MDc4Y2Q1ODY2YTk2YmQxODJiYmFmMmI4MWQwZjY", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-03-04T19:23:39Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-03-04T19:23:39Z"}, "message": "Auto merge of #8504 - xFrednet:8502-allow-lint-without-reason, r=flip1995\n\nAdd lint to detect `allow` attributes without reason\n\nI was considering putting this lint into the pedantic group. However, that would result in countless warnings for existing projects. Having it in restriction also seems good to me :upside_down_face: (And now I need sleep :zzz: )\n\n---\n\nchangelog: New lint [`allow_lint_without_reason`] (Requires the `lint_reasons` feature)\n\nCloses: rust-lang/rust-clippy#8502", "tree": {"sha": "c357a5c99c1bdc6cd876a8dae73551e0742437a5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c357a5c99c1bdc6cd876a8dae73551e0742437a5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/48d54942f55078cd5866a96bd182bbaf2b81d0f6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/48d54942f55078cd5866a96bd182bbaf2b81d0f6", "html_url": "https://github.com/rust-lang/rust/commit/48d54942f55078cd5866a96bd182bbaf2b81d0f6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/48d54942f55078cd5866a96bd182bbaf2b81d0f6/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "53189ad190f313cbad28f8138a04e734ac052cfc", "url": "https://api.github.com/repos/rust-lang/rust/commits/53189ad190f313cbad28f8138a04e734ac052cfc", "html_url": "https://github.com/rust-lang/rust/commit/53189ad190f313cbad28f8138a04e734ac052cfc"}, {"sha": "ab6ffb6371b78d1777b90c25a44163562ae53036", "url": "https://api.github.com/repos/rust-lang/rust/commits/ab6ffb6371b78d1777b90c25a44163562ae53036", "html_url": "https://github.com/rust-lang/rust/commit/ab6ffb6371b78d1777b90c25a44163562ae53036"}], "stats": {"total": 100, "additions": 99, "deletions": 1}, "files": [{"sha": "e7884818596c182b821598d4372c31f0ee194593", "filename": "CHANGELOG.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/48d54942f55078cd5866a96bd182bbaf2b81d0f6/CHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/48d54942f55078cd5866a96bd182bbaf2b81d0f6/CHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/CHANGELOG.md?ref=48d54942f55078cd5866a96bd182bbaf2b81d0f6", "patch": "@@ -3042,6 +3042,7 @@ Released 2018-09-13\n <!-- lint disable no-unused-definitions -->\n <!-- begin autogenerated links to lint list -->\n [`absurd_extreme_comparisons`]: https://rust-lang.github.io/rust-clippy/master/index.html#absurd_extreme_comparisons\n+[`allow_attributes_without_reason`]: https://rust-lang.github.io/rust-clippy/master/index.html#allow_attributes_without_reason\n [`almost_swapped`]: https://rust-lang.github.io/rust-clippy/master/index.html#almost_swapped\n [`approx_constant`]: https://rust-lang.github.io/rust-clippy/master/index.html#approx_constant\n [`as_conversions`]: https://rust-lang.github.io/rust-clippy/master/index.html#as_conversions"}, {"sha": "d0b03c0a9c276e644e89c6bfa22499cfdce7e052", "filename": "clippy_lints/src/attrs.rs", "status": "modified", "additions": 59, "deletions": 1, "changes": 60, "blob_url": "https://github.com/rust-lang/rust/blob/48d54942f55078cd5866a96bd182bbaf2b81d0f6/clippy_lints%2Fsrc%2Fattrs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/48d54942f55078cd5866a96bd182bbaf2b81d0f6/clippy_lints%2Fsrc%2Fattrs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fattrs.rs?ref=48d54942f55078cd5866a96bd182bbaf2b81d0f6", "patch": "@@ -255,7 +255,38 @@ declare_clippy_lint! {\n     \"usage of `cfg(operating_system)` instead of `cfg(target_os = \\\"operating_system\\\")`\"\n }\n \n+declare_clippy_lint! {\n+    /// ### What it does\n+    /// Checks for attributes that allow lints without a reason.\n+    ///\n+    /// (This requires the `lint_reasons` feature)\n+    ///\n+    /// ### Why is this bad?\n+    /// Allowing a lint should always have a reason. This reason should be documented to\n+    /// ensure that others understand the reasoning\n+    ///\n+    /// ### Example\n+    /// Bad:\n+    /// ```rust\n+    /// #![feature(lint_reasons)]\n+    ///\n+    /// #![allow(clippy::some_lint)]\n+    /// ```\n+    ///\n+    /// Good:\n+    /// ```rust\n+    /// #![feature(lint_reasons)]\n+    ///\n+    /// #![allow(clippy::some_lint, reason = \"False positive rust-lang/rust-clippy#1002020\")]\n+    /// ```\n+    #[clippy::version = \"1.61.0\"]\n+    pub ALLOW_ATTRIBUTES_WITHOUT_REASON,\n+    restriction,\n+    \"ensures that all `allow` and `expect` attributes have a reason\"\n+}\n+\n declare_lint_pass!(Attributes => [\n+    ALLOW_ATTRIBUTES_WITHOUT_REASON,\n     INLINE_ALWAYS,\n     DEPRECATED_SEMVER,\n     USELESS_ATTRIBUTE,\n@@ -269,6 +300,9 @@ impl<'tcx> LateLintPass<'tcx> for Attributes {\n                 if is_lint_level(ident.name) {\n                     check_clippy_lint_names(cx, ident.name, items);\n                 }\n+                if matches!(ident.name, sym::allow | sym::expect) {\n+                    check_lint_reason(cx, ident.name, items, attr);\n+                }\n                 if items.is_empty() || !attr.has_name(sym::deprecated) {\n                     return;\n                 }\n@@ -404,6 +438,30 @@ fn check_clippy_lint_names(cx: &LateContext<'_>, name: Symbol, items: &[NestedMe\n     }\n }\n \n+fn check_lint_reason(cx: &LateContext<'_>, name: Symbol, items: &[NestedMetaItem], attr: &'_ Attribute) {\n+    // Check for the feature\n+    if !cx.tcx.sess.features_untracked().lint_reasons {\n+        return;\n+    }\n+\n+    // Check if the reason is present\n+    if let Some(item) = items.last().and_then(NestedMetaItem::meta_item)\n+        && let MetaItemKind::NameValue(_) = &item.kind\n+        && item.path == sym::reason\n+    {\n+        return;\n+    }\n+\n+    span_lint_and_help(\n+        cx,\n+        ALLOW_ATTRIBUTES_WITHOUT_REASON,\n+        attr.span,\n+        &format!(\"`{}` attribute without specifying a reason\", name.as_str()),\n+        None,\n+        \"try adding a reason at the end with `, reason = \\\"..\\\"`\",\n+    );\n+}\n+\n fn is_relevant_item(cx: &LateContext<'_>, item: &Item<'_>) -> bool {\n     if let ItemKind::Fn(_, _, eid) = item.kind {\n         is_relevant_expr(cx, cx.tcx.typeck_body(eid), &cx.tcx.hir().body(eid).value)\n@@ -659,5 +717,5 @@ fn check_mismatched_target_os(cx: &EarlyContext<'_>, attr: &Attribute) {\n }\n \n fn is_lint_level(symbol: Symbol) -> bool {\n-    matches!(symbol, sym::allow | sym::warn | sym::deny | sym::forbid)\n+    matches!(symbol, sym::allow | sym::expect | sym::warn | sym::deny | sym::forbid)\n }"}, {"sha": "8bfa1dfe58534d7100b85430a8d30a158c8e47c9", "filename": "clippy_lints/src/lib.register_lints.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/48d54942f55078cd5866a96bd182bbaf2b81d0f6/clippy_lints%2Fsrc%2Flib.register_lints.rs", "raw_url": "https://github.com/rust-lang/rust/raw/48d54942f55078cd5866a96bd182bbaf2b81d0f6/clippy_lints%2Fsrc%2Flib.register_lints.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.register_lints.rs?ref=48d54942f55078cd5866a96bd182bbaf2b81d0f6", "patch": "@@ -44,6 +44,7 @@ store.register_lints(&[\n     assign_ops::ASSIGN_OP_PATTERN,\n     assign_ops::MISREFACTORED_ASSIGN_OP,\n     async_yields_async::ASYNC_YIELDS_ASYNC,\n+    attrs::ALLOW_ATTRIBUTES_WITHOUT_REASON,\n     attrs::BLANKET_CLIPPY_RESTRICTION_LINTS,\n     attrs::DEPRECATED_CFG_ATTR,\n     attrs::DEPRECATED_SEMVER,"}, {"sha": "4e30fc381975135ba3c678078173390dcb9e95a9", "filename": "clippy_lints/src/lib.register_restriction.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/48d54942f55078cd5866a96bd182bbaf2b81d0f6/clippy_lints%2Fsrc%2Flib.register_restriction.rs", "raw_url": "https://github.com/rust-lang/rust/raw/48d54942f55078cd5866a96bd182bbaf2b81d0f6/clippy_lints%2Fsrc%2Flib.register_restriction.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.register_restriction.rs?ref=48d54942f55078cd5866a96bd182bbaf2b81d0f6", "patch": "@@ -8,6 +8,7 @@ store.register_group(true, \"clippy::restriction\", Some(\"clippy_restriction\"), ve\n     LintId::of(as_conversions::AS_CONVERSIONS),\n     LintId::of(asm_syntax::INLINE_ASM_X86_ATT_SYNTAX),\n     LintId::of(asm_syntax::INLINE_ASM_X86_INTEL_SYNTAX),\n+    LintId::of(attrs::ALLOW_ATTRIBUTES_WITHOUT_REASON),\n     LintId::of(casts::FN_TO_NUMERIC_CAST_ANY),\n     LintId::of(create_dir::CREATE_DIR),\n     LintId::of(dbg_macro::DBG_MACRO),"}, {"sha": "1a0d4e886576e07695ecb5083bdf456b10163e0d", "filename": "tests/ui/allow_attributes_without_reason.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/48d54942f55078cd5866a96bd182bbaf2b81d0f6/tests%2Fui%2Fallow_attributes_without_reason.rs", "raw_url": "https://github.com/rust-lang/rust/raw/48d54942f55078cd5866a96bd182bbaf2b81d0f6/tests%2Fui%2Fallow_attributes_without_reason.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fallow_attributes_without_reason.rs?ref=48d54942f55078cd5866a96bd182bbaf2b81d0f6", "patch": "@@ -0,0 +1,14 @@\n+#![feature(lint_reasons)]\n+#![deny(clippy::allow_attributes_without_reason)]\n+\n+// These should trigger the lint\n+#[allow(dead_code)]\n+#[allow(dead_code, deprecated)]\n+// These should be fine\n+#[allow(dead_code, reason = \"This should be allowed\")]\n+#[warn(dyn_drop, reason = \"Warnings can also have reasons\")]\n+#[warn(deref_nullptr)]\n+#[deny(deref_nullptr)]\n+#[forbid(deref_nullptr)]\n+\n+fn main() {}"}, {"sha": "cd040a144aaca8c35c299a4f9dca1a9e507c08fe", "filename": "tests/ui/allow_attributes_without_reason.stderr", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/48d54942f55078cd5866a96bd182bbaf2b81d0f6/tests%2Fui%2Fallow_attributes_without_reason.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/48d54942f55078cd5866a96bd182bbaf2b81d0f6/tests%2Fui%2Fallow_attributes_without_reason.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fallow_attributes_without_reason.stderr?ref=48d54942f55078cd5866a96bd182bbaf2b81d0f6", "patch": "@@ -0,0 +1,23 @@\n+error: `allow` attribute without specifying a reason\n+  --> $DIR/allow_attributes_without_reason.rs:5:1\n+   |\n+LL | #[allow(dead_code)]\n+   | ^^^^^^^^^^^^^^^^^^^\n+   |\n+note: the lint level is defined here\n+  --> $DIR/allow_attributes_without_reason.rs:2:9\n+   |\n+LL | #![deny(clippy::allow_attributes_without_reason)]\n+   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   = help: try adding a reason at the end with `, reason = \"..\"`\n+\n+error: `allow` attribute without specifying a reason\n+  --> $DIR/allow_attributes_without_reason.rs:6:1\n+   |\n+LL | #[allow(dead_code, deprecated)]\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+   = help: try adding a reason at the end with `, reason = \"..\"`\n+\n+error: aborting due to 2 previous errors\n+"}]}