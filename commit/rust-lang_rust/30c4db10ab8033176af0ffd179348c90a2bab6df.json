{"sha": "30c4db10ab8033176af0ffd179348c90a2bab6df", "node_id": "C_kwDOAAsO6NoAKDMwYzRkYjEwYWI4MDMzMTc2YWYwZmZkMTc5MzQ4YzkwYTJiYWI2ZGY", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-07-19T22:36:08Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-07-19T22:36:08Z"}, "message": "Auto merge of #12789 - DorianListens:dscheidt/unused-param-overlapping, r=DorianListens\n\nfix: Prevent panic in Remove Unused Parameter assist\n\nInstead of calling `builder.delete` for every text range we find with\n`process_usage`, we now ensure that the ranges do not overlap before removing\nthem. If a range is fully contained by a prior one, it is dropped.\n\nfixes #12784", "tree": {"sha": "08cad251e28f97b7aa802b3f391fe93b1974025d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/08cad251e28f97b7aa802b3f391fe93b1974025d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/30c4db10ab8033176af0ffd179348c90a2bab6df", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/30c4db10ab8033176af0ffd179348c90a2bab6df", "html_url": "https://github.com/rust-lang/rust/commit/30c4db10ab8033176af0ffd179348c90a2bab6df", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/30c4db10ab8033176af0ffd179348c90a2bab6df/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7d20ff3ffbd30a89b7baa7cd996d4d60f0da6c55", "url": "https://api.github.com/repos/rust-lang/rust/commits/7d20ff3ffbd30a89b7baa7cd996d4d60f0da6c55", "html_url": "https://github.com/rust-lang/rust/commit/7d20ff3ffbd30a89b7baa7cd996d4d60f0da6c55"}, {"sha": "ffb6b23c75add6192a133b15be946cc2199ed971", "url": "https://api.github.com/repos/rust-lang/rust/commits/ffb6b23c75add6192a133b15be946cc2199ed971", "html_url": "https://github.com/rust-lang/rust/commit/ffb6b23c75add6192a133b15be946cc2199ed971"}], "stats": {"total": 41, "additions": 37, "deletions": 4}, "files": [{"sha": "928a5a386eb11c539e60bb3c83bc0d95b7f3c6fa", "filename": "crates/ide-assists/src/handlers/remove_unused_param.rs", "status": "modified", "additions": 37, "deletions": 4, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/30c4db10ab8033176af0ffd179348c90a2bab6df/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fremove_unused_param.rs", "raw_url": "https://github.com/rust-lang/rust/raw/30c4db10ab8033176af0ffd179348c90a2bab6df/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fremove_unused_param.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fremove_unused_param.rs?ref=30c4db10ab8033176af0ffd179348c90a2bab6df", "patch": "@@ -96,12 +96,20 @@ fn process_usages(\n ) {\n     let source_file = ctx.sema.parse(file_id);\n     builder.edit_file(file_id);\n-    for usage in references {\n-        if let Some(text_range) = process_usage(&source_file, usage, arg_to_remove, is_self_present)\n-        {\n-            builder.delete(text_range);\n+    let possible_ranges = references\n+        .into_iter()\n+        .filter_map(|usage| process_usage(&source_file, usage, arg_to_remove, is_self_present));\n+\n+    let mut ranges_to_delete: Vec<TextRange> = vec![];\n+    for range in possible_ranges {\n+        if !ranges_to_delete.iter().any(|it| it.contains_range(range)) {\n+            ranges_to_delete.push(range)\n         }\n     }\n+\n+    for range in ranges_to_delete {\n+        builder.delete(range)\n+    }\n }\n \n fn process_usage(\n@@ -370,6 +378,31 @@ fn main() {\n     S.f(92);\n     S::f(&S);\n }\n+\"#,\n+        )\n+    }\n+\n+    #[test]\n+    fn nested_call() {\n+        check_assist(\n+            remove_unused_param,\n+            r#\"\n+fn foo(x: i32, $0y: i32) -> i32 {\n+    x\n+}\n+\n+fn bar() {\n+    foo(1, foo(2, 3));\n+}\n+\"#,\n+            r#\"\n+fn foo(x: i32) -> i32 {\n+    x\n+}\n+\n+fn bar() {\n+    foo(1);\n+}\n \"#,\n         )\n     }"}]}