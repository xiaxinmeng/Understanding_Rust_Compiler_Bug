{"sha": "db5739ac55f3b27da778c7ffab0540990eb121a3", "node_id": "C_kwDOAAsO6NoAKGRiNTczOWFjNTVmM2IyN2RhNzc4YzdmZmFiMDU0MDk5MGViMTIxYTM", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-03-30T20:23:03Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-03-30T20:23:03Z"}, "message": "Auto merge of #8610 - SabrinaJewson:transmute-int-to-char-const, r=xFrednet\n\nDon't warn int-to-char transmutes in const contexts\n\nchangelog: Don't warn ``[`transmute_int_to_char`]`` in const contexts\n\nfixes: #8379", "tree": {"sha": "6bce36bbd7f7d11067fac341aee48aab46e3ae1e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6bce36bbd7f7d11067fac341aee48aab46e3ae1e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/db5739ac55f3b27da778c7ffab0540990eb121a3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/db5739ac55f3b27da778c7ffab0540990eb121a3", "html_url": "https://github.com/rust-lang/rust/commit/db5739ac55f3b27da778c7ffab0540990eb121a3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/db5739ac55f3b27da778c7ffab0540990eb121a3/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c0a5693abcd6311d17d13d47f0c36a58ad8a5484", "url": "https://api.github.com/repos/rust-lang/rust/commits/c0a5693abcd6311d17d13d47f0c36a58ad8a5484", "html_url": "https://github.com/rust-lang/rust/commit/c0a5693abcd6311d17d13d47f0c36a58ad8a5484"}, {"sha": "d6f05c6a89e7bbaafc2ca30f845de488cd5a8978", "url": "https://api.github.com/repos/rust-lang/rust/commits/d6f05c6a89e7bbaafc2ca30f845de488cd5a8978", "html_url": "https://github.com/rust-lang/rust/commit/d6f05c6a89e7bbaafc2ca30f845de488cd5a8978"}], "stats": {"total": 58, "additions": 32, "deletions": 26}, "files": [{"sha": "342f23f030cd06fa3bf3c55355f50f92c2ede39e", "filename": "clippy_lints/src/transmute/mod.rs", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/db5739ac55f3b27da778c7ffab0540990eb121a3/clippy_lints%2Fsrc%2Ftransmute%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/db5739ac55f3b27da778c7ffab0540990eb121a3/clippy_lints%2Fsrc%2Ftransmute%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Ftransmute%2Fmod.rs?ref=db5739ac55f3b27da778c7ffab0540990eb121a3", "patch": "@@ -410,9 +410,10 @@ impl<'tcx> LateLintPass<'tcx> for Transmute {\n             if let Some(def_id) = cx.qpath_res(qpath, path_expr.hir_id).opt_def_id();\n             if cx.tcx.is_diagnostic_item(sym::transmute, def_id);\n             then {\n-                // Avoid suggesting from/to bits and dereferencing raw pointers in const contexts.\n-                // See https://github.com/rust-lang/rust/issues/73736 for progress on making them `const fn`.\n-                // And see https://github.com/rust-lang/rust/issues/51911 for dereferencing raw pointers.\n+                // Avoid suggesting non-const operations in const contexts:\n+                // - from/to bits (https://github.com/rust-lang/rust/issues/73736)\n+                // - dereferencing raw pointers (https://github.com/rust-lang/rust/issues/51911)\n+                // - char conversions (https://github.com/rust-lang/rust/issues/89259)\n                 let const_context = in_constant(cx, e.hir_id);\n \n                 let from_ty = cx.typeck_results().expr_ty_adjusted(arg);\n@@ -427,7 +428,7 @@ impl<'tcx> LateLintPass<'tcx> for Transmute {\n                 let linted = wrong_transmute::check(cx, e, from_ty, to_ty)\n                     | crosspointer_transmute::check(cx, e, from_ty, to_ty)\n                     | transmute_ptr_to_ref::check(cx, e, from_ty, to_ty, arg, qpath)\n-                    | transmute_int_to_char::check(cx, e, from_ty, to_ty, arg)\n+                    | transmute_int_to_char::check(cx, e, from_ty, to_ty, arg, const_context)\n                     | transmute_ref_to_ref::check(cx, e, from_ty, to_ty, arg, const_context)\n                     | transmute_ptr_to_ptr::check(cx, e, from_ty, to_ty, arg)\n                     | transmute_int_to_bool::check(cx, e, from_ty, to_ty, arg)"}, {"sha": "9e1823c373bfdb4d641536bfd04b10157eda1b1c", "filename": "clippy_lints/src/transmute/transmute_int_to_char.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/db5739ac55f3b27da778c7ffab0540990eb121a3/clippy_lints%2Fsrc%2Ftransmute%2Ftransmute_int_to_char.rs", "raw_url": "https://github.com/rust-lang/rust/raw/db5739ac55f3b27da778c7ffab0540990eb121a3/clippy_lints%2Fsrc%2Ftransmute%2Ftransmute_int_to_char.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Ftransmute%2Ftransmute_int_to_char.rs?ref=db5739ac55f3b27da778c7ffab0540990eb121a3", "patch": "@@ -15,9 +15,10 @@ pub(super) fn check<'tcx>(\n     from_ty: Ty<'tcx>,\n     to_ty: Ty<'tcx>,\n     arg: &'tcx Expr<'_>,\n+    const_context: bool,\n ) -> bool {\n     match (&from_ty.kind(), &to_ty.kind()) {\n-        (ty::Int(ty::IntTy::I32) | ty::Uint(ty::UintTy::U32), &ty::Char) => {\n+        (ty::Int(ty::IntTy::I32) | ty::Uint(ty::UintTy::U32), &ty::Char) if !const_context => {\n             span_lint_and_then(\n                 cx,\n                 TRANSMUTE_INT_TO_CHAR,"}, {"sha": "54f9727d8ea30b8bf7a75c8027f76a8570906ec3", "filename": "tests/ui/transmute.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/db5739ac55f3b27da778c7ffab0540990eb121a3/tests%2Fui%2Ftransmute.rs", "raw_url": "https://github.com/rust-lang/rust/raw/db5739ac55f3b27da778c7ffab0540990eb121a3/tests%2Fui%2Ftransmute.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ftransmute.rs?ref=db5739ac55f3b27da778c7ffab0540990eb121a3", "patch": "@@ -73,6 +73,10 @@ fn crosspointer() {\n fn int_to_char() {\n     let _: char = unsafe { std::mem::transmute(0_u32) };\n     let _: char = unsafe { std::mem::transmute(0_i32) };\n+\n+    // These shouldn't warn\n+    const _: char = unsafe { std::mem::transmute(0_u32) };\n+    const _: char = unsafe { std::mem::transmute(0_i32) };\n }\n \n #[warn(clippy::transmute_int_to_bool)]"}, {"sha": "5c60fc2d5115d33b6de3c5fe4d7cb9f8b2250290", "filename": "tests/ui/transmute.stderr", "status": "modified", "additions": 21, "deletions": 21, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/db5739ac55f3b27da778c7ffab0540990eb121a3/tests%2Fui%2Ftransmute.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/db5739ac55f3b27da778c7ffab0540990eb121a3/tests%2Fui%2Ftransmute.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ftransmute.stderr?ref=db5739ac55f3b27da778c7ffab0540990eb121a3", "patch": "@@ -107,135 +107,135 @@ LL |     let _: char = unsafe { std::mem::transmute(0_i32) };\n    |                            ^^^^^^^^^^^^^^^^^^^^^^^^^^ help: consider using: `std::char::from_u32(0_i32 as u32).unwrap()`\n \n error: transmute from a `u8` to a `bool`\n-  --> $DIR/transmute.rs:80:28\n+  --> $DIR/transmute.rs:84:28\n    |\n LL |     let _: bool = unsafe { std::mem::transmute(0_u8) };\n    |                            ^^^^^^^^^^^^^^^^^^^^^^^^^ help: consider using: `0_u8 != 0`\n    |\n    = note: `-D clippy::transmute-int-to-bool` implied by `-D warnings`\n \n error: transmute from a `u32` to a `f32`\n-  --> $DIR/transmute.rs:86:31\n+  --> $DIR/transmute.rs:90:31\n    |\n LL |         let _: f32 = unsafe { std::mem::transmute(0_u32) };\n    |                               ^^^^^^^^^^^^^^^^^^^^^^^^^^ help: consider using: `f32::from_bits(0_u32)`\n    |\n    = note: `-D clippy::transmute-int-to-float` implied by `-D warnings`\n \n error: transmute from a `i32` to a `f32`\n-  --> $DIR/transmute.rs:87:31\n+  --> $DIR/transmute.rs:91:31\n    |\n LL |         let _: f32 = unsafe { std::mem::transmute(0_i32) };\n    |                               ^^^^^^^^^^^^^^^^^^^^^^^^^^ help: consider using: `f32::from_bits(0_i32 as u32)`\n \n error: transmute from a `u64` to a `f64`\n-  --> $DIR/transmute.rs:88:31\n+  --> $DIR/transmute.rs:92:31\n    |\n LL |         let _: f64 = unsafe { std::mem::transmute(0_u64) };\n    |                               ^^^^^^^^^^^^^^^^^^^^^^^^^^ help: consider using: `f64::from_bits(0_u64)`\n \n error: transmute from a `i64` to a `f64`\n-  --> $DIR/transmute.rs:89:31\n+  --> $DIR/transmute.rs:93:31\n    |\n LL |         let _: f64 = unsafe { std::mem::transmute(0_i64) };\n    |                               ^^^^^^^^^^^^^^^^^^^^^^^^^^ help: consider using: `f64::from_bits(0_i64 as u64)`\n \n error: transmute from a `u8` to a `[u8; 1]`\n-  --> $DIR/transmute.rs:109:30\n+  --> $DIR/transmute.rs:113:30\n    |\n LL |             let _: [u8; 1] = std::mem::transmute(0u8);\n    |                              ^^^^^^^^^^^^^^^^^^^^^^^^ help: consider using `to_ne_bytes()`: `0u8.to_ne_bytes()`\n    |\n    = note: `-D clippy::transmute-num-to-bytes` implied by `-D warnings`\n \n error: transmute from a `u32` to a `[u8; 4]`\n-  --> $DIR/transmute.rs:110:30\n+  --> $DIR/transmute.rs:114:30\n    |\n LL |             let _: [u8; 4] = std::mem::transmute(0u32);\n    |                              ^^^^^^^^^^^^^^^^^^^^^^^^^ help: consider using `to_ne_bytes()`: `0u32.to_ne_bytes()`\n \n error: transmute from a `u128` to a `[u8; 16]`\n-  --> $DIR/transmute.rs:111:31\n+  --> $DIR/transmute.rs:115:31\n    |\n LL |             let _: [u8; 16] = std::mem::transmute(0u128);\n    |                               ^^^^^^^^^^^^^^^^^^^^^^^^^^ help: consider using `to_ne_bytes()`: `0u128.to_ne_bytes()`\n \n error: transmute from a `i8` to a `[u8; 1]`\n-  --> $DIR/transmute.rs:112:30\n+  --> $DIR/transmute.rs:116:30\n    |\n LL |             let _: [u8; 1] = std::mem::transmute(0i8);\n    |                              ^^^^^^^^^^^^^^^^^^^^^^^^ help: consider using `to_ne_bytes()`: `0i8.to_ne_bytes()`\n \n error: transmute from a `i32` to a `[u8; 4]`\n-  --> $DIR/transmute.rs:113:30\n+  --> $DIR/transmute.rs:117:30\n    |\n LL |             let _: [u8; 4] = std::mem::transmute(0i32);\n    |                              ^^^^^^^^^^^^^^^^^^^^^^^^^ help: consider using `to_ne_bytes()`: `0i32.to_ne_bytes()`\n \n error: transmute from a `i128` to a `[u8; 16]`\n-  --> $DIR/transmute.rs:114:31\n+  --> $DIR/transmute.rs:118:31\n    |\n LL |             let _: [u8; 16] = std::mem::transmute(0i128);\n    |                               ^^^^^^^^^^^^^^^^^^^^^^^^^^ help: consider using `to_ne_bytes()`: `0i128.to_ne_bytes()`\n \n error: transmute from a `f32` to a `[u8; 4]`\n-  --> $DIR/transmute.rs:115:30\n+  --> $DIR/transmute.rs:119:30\n    |\n LL |             let _: [u8; 4] = std::mem::transmute(0.0f32);\n    |                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: consider using `to_ne_bytes()`: `0.0f32.to_ne_bytes()`\n \n error: transmute from a `f64` to a `[u8; 8]`\n-  --> $DIR/transmute.rs:116:30\n+  --> $DIR/transmute.rs:120:30\n    |\n LL |             let _: [u8; 8] = std::mem::transmute(0.0f64);\n    |                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: consider using `to_ne_bytes()`: `0.0f64.to_ne_bytes()`\n \n error: transmute from a `u8` to a `[u8; 1]`\n-  --> $DIR/transmute.rs:121:30\n+  --> $DIR/transmute.rs:125:30\n    |\n LL |             let _: [u8; 1] = std::mem::transmute(0u8);\n    |                              ^^^^^^^^^^^^^^^^^^^^^^^^ help: consider using `to_ne_bytes()`: `0u8.to_ne_bytes()`\n \n error: transmute from a `u32` to a `[u8; 4]`\n-  --> $DIR/transmute.rs:122:30\n+  --> $DIR/transmute.rs:126:30\n    |\n LL |             let _: [u8; 4] = std::mem::transmute(0u32);\n    |                              ^^^^^^^^^^^^^^^^^^^^^^^^^ help: consider using `to_ne_bytes()`: `0u32.to_ne_bytes()`\n \n error: transmute from a `u128` to a `[u8; 16]`\n-  --> $DIR/transmute.rs:123:31\n+  --> $DIR/transmute.rs:127:31\n    |\n LL |             let _: [u8; 16] = std::mem::transmute(0u128);\n    |                               ^^^^^^^^^^^^^^^^^^^^^^^^^^ help: consider using `to_ne_bytes()`: `0u128.to_ne_bytes()`\n \n error: transmute from a `i8` to a `[u8; 1]`\n-  --> $DIR/transmute.rs:124:30\n+  --> $DIR/transmute.rs:128:30\n    |\n LL |             let _: [u8; 1] = std::mem::transmute(0i8);\n    |                              ^^^^^^^^^^^^^^^^^^^^^^^^ help: consider using `to_ne_bytes()`: `0i8.to_ne_bytes()`\n \n error: transmute from a `i32` to a `[u8; 4]`\n-  --> $DIR/transmute.rs:125:30\n+  --> $DIR/transmute.rs:129:30\n    |\n LL |             let _: [u8; 4] = std::mem::transmute(0i32);\n    |                              ^^^^^^^^^^^^^^^^^^^^^^^^^ help: consider using `to_ne_bytes()`: `0i32.to_ne_bytes()`\n \n error: transmute from a `i128` to a `[u8; 16]`\n-  --> $DIR/transmute.rs:126:31\n+  --> $DIR/transmute.rs:130:31\n    |\n LL |             let _: [u8; 16] = std::mem::transmute(0i128);\n    |                               ^^^^^^^^^^^^^^^^^^^^^^^^^^ help: consider using `to_ne_bytes()`: `0i128.to_ne_bytes()`\n \n error: transmute from a `&[u8]` to a `&str`\n-  --> $DIR/transmute.rs:134:28\n+  --> $DIR/transmute.rs:138:28\n    |\n LL |     let _: &str = unsafe { std::mem::transmute(b) };\n    |                            ^^^^^^^^^^^^^^^^^^^^^^ help: consider using: `std::str::from_utf8(b).unwrap()`\n    |\n    = note: `-D clippy::transmute-bytes-to-str` implied by `-D warnings`\n \n error: transmute from a `&mut [u8]` to a `&mut str`\n-  --> $DIR/transmute.rs:135:32\n+  --> $DIR/transmute.rs:139:32\n    |\n LL |     let _: &mut str = unsafe { std::mem::transmute(mb) };\n    |                                ^^^^^^^^^^^^^^^^^^^^^^^ help: consider using: `std::str::from_utf8_mut(mb).unwrap()`"}]}