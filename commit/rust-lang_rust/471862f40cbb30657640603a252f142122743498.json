{"sha": "471862f40cbb30657640603a252f142122743498", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQ3MTg2MmY0MGNiYjMwNjU3NjQwNjAzYTI1MmYxNDIxMjI3NDM0OTg=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-08-24T09:30:56Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-08-24T09:30:56Z"}, "message": "auto merge of #16710 : dotdash/rust/mergefunc, r=thestinger\n\nFixes #9536 \r\n\r\n---\r\n\r\nFrom https://github.com/rust-lang/rust/issues/9536#issuecomment-45495670:\r\n\r\nI've built rustc with the aforementioned fix, once with MergeFunc being run early (that's what the patch for clang that comes  with LLVM does), and once with MergeFunc being run late (using `-C passes=mergefunc`). Here are some time/code size measurements I made with them:\r\n\r\nBuild command: `rustc -O -o /dev/null --emit asm .../lib.rs`\r\n\r\nCPU (user) times, best of three runs:\r\n\r\n Crate       | No MergeFunc | Early MergeFunc | Late MergeFunc\r\n-------------|--------------|-----------------|---------------\r\n core        |    5.380s    |    5.476s       |    5.364s\r\n collections |    1.884s    |    1.856s       |    1.892s\r\n native      |    7.200s    |    7.356s       |    7.108s\r\n rustc       | 3m23.584s    | 3m28.120s       | 3m21.820s\r\n std         |   13.888s    |   13.976s       |   13.848s\r\n syntax      |   48.992s    |   47.752s       |   48.372s\r\n\r\nSizes:\r\n\r\nCrate                                    | No MergeFunc |   Early MergeFunc   |    Late MergeFunc\r\n-----------------------------------------|-------------:|--------------------:|-------------------:\r\nlib                                      |  237037581   |  236005998 (-0.44%) |  234708744 (-0.98%)\r\nlibarena-063bff73-0.11.0-pre.so          |      60398   |      60393 (-0.01%) |      60394 (-0.01%)\r\nlibcollections-d412c0c4-0.11.0-pre.so    |     971566   |     971772 (+0.02%) |     971691 (+0.01%)\r\nlibdebug-1e940314-0.11.0-pre.so          |     181352   |     181514 (+0.09%) |     181363 (+0.01%)\r\nlibflate-92afea7e-0.11.0-pre.so          |     137837   |     137869 (+0.02%) |     137837 (+0.00%)\r\nlibfmt_macros-5125f3bd-0.11.0-pre.so     |     132733   |     134598 (+1.41%) |     132465 (-0.20%)\r\nlibgetopts-c94737d1-0.11.0-pre.so        |     158851   |     157427 (-0.90%) |     158272 (-0.36%)\r\nlibgraphviz-7b3cf89d-0.11.0-pre.so       |      53337   |      53178 (-0.30%) |      53337 (+0.00%)\r\nliblog-cd053230-0.11.0-pre.so            |      85993   |      86017 (+0.03%) |      85780 (-0.25%)\r\nlibnative-1fb5e2c0-0.11.0-pre.so         |     635785   |     639352 (+0.56%) |     621184 (-2.30%)\r\nlibregex-77385931-0.11.0-pre.so          |     450538   |     450741 (+0.05%) |     449504 (-0.23%)\r\nlibrustc-d252d482-0.11.0-pre.so          |   51583741   |   51227703 (-0.69%) |   50930784 (-1.27%)\r\nlibrustdoc-6ecbf63e-0.11.0-pre.so        |    4557104   |    4501896 (-1.21%) |    4394409 (-3.57%)\r\nlibserialize-0352aab7-0.11.0-pre.so      |    1126096   |    1115503 (-0.94%) |    1101734 (-2.16%)\r\nlibstd-59beb4f7-0.11.0-pre.so            |    4499529   |    4488879 (-0.24%) |    4477710 (-0.48%)\r\nlibsync-305341d2-0.11.0-pre.so           |     306767   |     312211 (+1.77%) |     304086 (-0.87%)\r\nlibsyntax-555559ea-0.11.0-pre.so         |    6699751   |    6632291 (-1.01%) |    6596232 (-1.55%)\r\nlibterm-4e4945a5-0.11.0-pre.so           |     389390   |     392689 (+0.85%) |     385525 (-0.99%)\r\nlibtest-a79f950d-0.11.0-pre.so           |     740161   |     730673 (-1.28%) |     734534 (-0.76%)\r\nlibtime-4bb3739b-0.11.0-pre.so           |     131518   |     132830 (+1.00%) |     131514 (-0.00%)\r\nrustlib                                  |  164131038   |  163594366 (-0.33%) |  162796293 (-0.81%)\r\nx86_64-unknown-linux-gnu                 |  164119867   |  163583195 (-0.33%) |  162785122 (-0.81%)\r\nlib                                      |  164115771   |  163579099 (-0.33%) |  162781026 (-0.81%)\r\nliballoc-1085c790-0.11.0-pre.rlib        |    1094410   |    1094444 (+0.00%) |    1094438 (+0.00%)\r\nlibarena-063bff73-0.11.0-pre.rlib        |     312324   |     312152 (-0.06%) |     312210 (-0.04%)\r\nlibarena-063bff73-0.11.0-pre.so          |      60394   |      60394 (+0.00%) |      60394 (+0.00%)\r\nlibcollections-d412c0c4-0.11.0-pre.rlib  |    7048646   |    7049094 (+0.01%) |    7048856 (+0.00%)\r\nlibcollections-d412c0c4-0.11.0-pre.so    |     971575   |     971771 (+0.02%) |     971681 (+0.01%)\r\nlibcompiler-rt.a                         |     573802   |     573802 (+0.00%) |     573802 (+0.00%)\r\nlibcore-c5ed6fb4-0.11.0-pre.rlib         |   24204746   |   24209820 (+0.02%) |   24187602 (-0.07%)\r\nlibdebug-1e940314-0.11.0-pre.rlib        |     876616   |     878488 (+0.21%) |     876746 (+0.01%)\r\nlibdebug-1e940314-0.11.0-pre.so          |     181352   |     181509 (+0.09%) |     181353 (+0.00%)\r\nlibflate-92afea7e-0.11.0-pre.rlib        |     175062   |     175074 (+0.01%) |     175082 (+0.01%)\r\nlibflate-92afea7e-0.11.0-pre.so          |     137837   |     137869 (+0.02%) |     137837 (+0.00%)\r\nlibfmt_macros-5125f3bd-0.11.0-pre.so     |     132724   |     134599 (+1.41%) |     132469 (-0.19%)\r\nlibfourcc-cc0e8bf1-0.11.0-pre.so         |     125828   |     126084 (+0.20%) |     125827 (-0.00%)\r\nlibgetopts-c94737d1-0.11.0-pre.rlib      |     864664   |     853040 (-1.34%) |     862548 (-0.24%)\r\nlibgetopts-c94737d1-0.11.0-pre.so        |     158855   |     157425 (-0.90%) |     158275 (-0.37%)\r\nlibglob-eafe1d22-0.11.0-pre.rlib         |     951370   |     944674 (-0.70%) |     946734 (-0.49%)\r\nlibglob-eafe1d22-0.11.0-pre.so           |     159130   |     157385 (-1.10%) |     156791 (-1.47%)\r\nlibgraphviz-7b3cf89d-0.11.0-pre.rlib     |     269600   |     269062 (-0.20%) |     269560 (-0.01%)\r\nlibgraphviz-7b3cf89d-0.11.0-pre.so       |      53334   |      53176 (-0.30%) |      53337 (+0.01%)\r\nlibgreen-ca0d0b80-0.11.0-pre.rlib        |    1374120   |    1389510 (+1.12%) |    1361696 (-0.90%)\r\nlibgreen-ca0d0b80-0.11.0-pre.so          |     372435   |     377929 (+1.48%) |     370991 (-0.39%)\r\nlibhexfloat-3b978f48-0.11.0-pre.so       |     131926   |     132166 (+0.18%) |     131935 (+0.01%)\r\nliblibc-4f9a876d-0.11.0-pre.rlib         |     617472   |     617472 (+0.00%) |     617472 (+0.00%)\r\nliblog-cd053230-0.11.0-pre.rlib          |     371190   |     371048 (-0.04%) |     370836 (-0.10%)\r\nliblog-cd053230-0.11.0-pre.so            |      85996   |      86020 (+0.03%) |      85781 (-0.25%)\r\nlibmorestack.a                           |       1388   |       1388 (+0.00%) |       1388 (+0.00%)\r\nlibnative-1fb5e2c0-0.11.0-pre.rlib       |    2233070   |    2264296 (+1.40%) |    2194920 (-1.71%)\r\nlibnative-1fb5e2c0-0.11.0-pre.so         |     635787   |     639341 (+0.56%) |     621184 (-2.30%)\r\nlibnum-ebe12db7-0.11.0-pre.rlib          |    2672318   |    2675292 (+0.11%) |    2669370 (-0.11%)\r\nlibnum-ebe12db7-0.11.0-pre.so            |     398924   |     399357 (+0.11%) |     395821 (-0.78%)\r\nlibrand-2ea8f361-0.11.0-pre.rlib         |    1691108   |    1691696 (+0.03%) |    1690264 (-0.05%)\r\nlibregex-77385931-0.11.0-pre.rlib        |    2007348   |    2006050 (-0.06%) |    2003804 (-0.18%)\r\nlibregex-77385931-0.11.0-pre.so          |     450520   |     450790 (+0.06%) |     449535 (-0.22%)\r\nlibregex_macros-a2216dec-0.11.0-pre.so   |     597208   |     569004 (-4.72%) |     568800 (-4.76%)\r\nlibrlibc-d1ece24e-0.11.0-pre.rlib        |      12394   |      12394 (+0.00%) |      12394 (+0.00%)\r\nlibrustc-d252d482-0.11.0-pre.so          |   51582383   |   51230320 (-0.68%) |   50930784 (-1.26%)\r\nlibrustdoc-6ecbf63e-0.11.0-pre.so        |    4557074   |    4501877 (-1.21%) |    4394506 (-3.57%)\r\nlibrustuv-ede8cb89-0.11.0-pre.rlib       |    4774956   |    4791366 (+0.34%) |    4732386 (-0.89%)\r\nlibrustuv-ede8cb89-0.11.0-pre.so         |    1401710   |    1400237 (-0.11%) |    1386869 (-1.06%)\r\nlibsemver-e49a2dee-0.11.0-pre.rlib       |     392704   |     392434 (-0.07%) |     392940 (+0.06%)\r\nlibsemver-e49a2dee-0.11.0-pre.so         |      71863   |      71847 (-0.02%) |      71860 (-0.00%)\r\nlibserialize-0352aab7-0.11.0-pre.rlib    |    8059698   |    8033972 (-0.32%) |    7989802 (-0.87%)\r\nlibserialize-0352aab7-0.11.0-pre.so      |    1126099   |    1115520 (-0.94%) |    1101721 (-2.16%)\r\nlibstd-59beb4f7-0.11.0-pre.rlib          |   18802728   |   18780212 (-0.12%) |   18743438 (-0.32%)\r\nlibstd-59beb4f7-0.11.0-pre.so            |    4499534   |    4488835 (-0.24%) |    4477677 (-0.49%)\r\nlibsync-305341d2-0.11.0-pre.rlib         |    1377062   |    1400190 (+1.68%) |    1369498 (-0.55%)\r\nlibsync-305341d2-0.11.0-pre.so           |     306762   |     312212 (+1.78%) |     304095 (-0.87%)\r\nlibsyntax-555559ea-0.11.0-pre.so         |    6703330   |    6632254 (-1.06%) |    6596295 (-1.60%)\r\nlibterm-4e4945a5-0.11.0-pre.rlib         |    1503928   |    1512648 (+0.58%) |    1495932 (-0.53%)\r\nlibterm-4e4945a5-0.11.0-pre.so           |     389380   |     392678 (+0.85%) |     385517 (-0.99%)\r\nlibtest-a79f950d-0.11.0-pre.rlib         |    3606962   |    3555410 (-1.43%) |    3589258 (-0.49%)\r\nlibtest-a79f950d-0.11.0-pre.so           |     740255   |     728398 (-1.60%) |     734521 (-0.77%)\r\nlibtime-4bb3739b-0.11.0-pre.rlib         |     847036   |     847178 (+0.02%) |     847194 (+0.02%)\r\nlibtime-4bb3739b-0.11.0-pre.so           |     131516   |     132829 (+1.00%) |     131518 (+0.00%)\r\nliburl-b8b5640c-0.11.0-pre.rlib          |     647764   |     647558 (-0.03%) |     646896 (-0.13%)\r\nliburl-b8b5640c-0.11.0-pre.so            |     146616   |     146621 (+0.00%) |     146531 (-0.06%)\r\nlibuuid-238d8f44-0.11.0-pre.rlib         |     359732   |     359682 (-0.01%) |     358936 (-0.22%)\r\nlibuuid-238d8f44-0.11.0-pre.so           |      77110   |      77110 (+0.00%) |      77023 (-0.11%)\r\ntotal                                    |  237081476   |  236049893 (-0.44%) |  234752639 (-0.98%)\r\n\r\n\r\nSo running MergeFunc early like in the clang patch isn't nearly as good as running it late. I also tried to enable usage of global aliases instead of just thunks when merging functions, but that crashes.", "tree": {"sha": "ed1c3bdbe099f37ad48d3559adfe5bcedd96c9fa", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ed1c3bdbe099f37ad48d3559adfe5bcedd96c9fa"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/471862f40cbb30657640603a252f142122743498", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/471862f40cbb30657640603a252f142122743498", "html_url": "https://github.com/rust-lang/rust/commit/471862f40cbb30657640603a252f142122743498", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/471862f40cbb30657640603a252f142122743498/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "16d538cba0cc5b5830e7c17663e985d13ece8e0c", "url": "https://api.github.com/repos/rust-lang/rust/commits/16d538cba0cc5b5830e7c17663e985d13ece8e0c", "html_url": "https://github.com/rust-lang/rust/commit/16d538cba0cc5b5830e7c17663e985d13ece8e0c"}, {"sha": "bbc66332fe8b966770290f784045b9757d66d126", "url": "https://api.github.com/repos/rust-lang/rust/commits/bbc66332fe8b966770290f784045b9757d66d126", "html_url": "https://github.com/rust-lang/rust/commit/bbc66332fe8b966770290f784045b9757d66d126"}], "stats": {"total": 7, "additions": 7, "deletions": 0}, "files": [{"sha": "9ce0e3a33577d715c99a1272857607c8bfbde33e", "filename": "src/librustc/back/link.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/471862f40cbb30657640603a252f142122743498/src%2Flibrustc%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/471862f40cbb30657640603a252f142122743498/src%2Flibrustc%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fback%2Flink.rs?ref=471862f40cbb30657640603a252f142122743498", "patch": "@@ -536,6 +536,13 @@ pub mod write {\n         llvm::LLVMPassManagerBuilderPopulateFunctionPassManager(builder, fpm);\n         llvm::LLVMPassManagerBuilderPopulateModulePassManager(builder, mpm);\n         llvm::LLVMPassManagerBuilderDispose(builder);\n+\n+        match opt {\n+            llvm::CodeGenLevelDefault | llvm::CodeGenLevelAggressive => {\n+                \"mergefunc\".with_c_str(|s| llvm::LLVMRustAddPass(mpm, s));\n+            }\n+            _ => {}\n+        };\n     }\n }\n "}]}