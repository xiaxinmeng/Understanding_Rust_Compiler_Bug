{"sha": "a120ae70d08d2eb991c7796e8726debb7ad46dea", "node_id": "MDY6Q29tbWl0NzI0NzEyOmExMjBhZTcwZDA4ZDJlYjk5MWM3Nzk2ZTg3MjZkZWJiN2FkNDZkZWE=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-07-06T10:30:47Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2016-07-06T10:30:47Z"}, "message": "Auto merge of #34644 - infinity0:master, r=alexcrichton\n\nAvoid redundant downloads when bootstrapping\n\nIf the local file is available, then verify it against the hash we just\ndownloaded, and if it matches then we don't need to download it again.", "tree": {"sha": "cd948e504cb1dcbbbe99f8b62209930d5a035494", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/cd948e504cb1dcbbbe99f8b62209930d5a035494"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a120ae70d08d2eb991c7796e8726debb7ad46dea", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a120ae70d08d2eb991c7796e8726debb7ad46dea", "html_url": "https://github.com/rust-lang/rust/commit/a120ae70d08d2eb991c7796e8726debb7ad46dea", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a120ae70d08d2eb991c7796e8726debb7ad46dea/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "47380768e7debc2ee6b66e491733b89534e80988", "url": "https://api.github.com/repos/rust-lang/rust/commits/47380768e7debc2ee6b66e491733b89534e80988", "html_url": "https://github.com/rust-lang/rust/commit/47380768e7debc2ee6b66e491733b89534e80988"}, {"sha": "933a1036ae12d728b2ccffa560154a8011a4c256", "url": "https://api.github.com/repos/rust-lang/rust/commits/933a1036ae12d728b2ccffa560154a8011a4c256", "html_url": "https://github.com/rust-lang/rust/commit/933a1036ae12d728b2ccffa560154a8011a4c256"}], "stats": {"total": 21, "additions": 13, "deletions": 8}, "files": [{"sha": "832911beb588c762d6ac329e04beda0eb2217d7e", "filename": "src/bootstrap/bootstrap.py", "status": "modified", "additions": 13, "deletions": 6, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/a120ae70d08d2eb991c7796e8726debb7ad46dea/src%2Fbootstrap%2Fbootstrap.py", "raw_url": "https://github.com/rust-lang/rust/raw/a120ae70d08d2eb991c7796e8726debb7ad46dea/src%2Fbootstrap%2Fbootstrap.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbootstrap.py?ref=a120ae70d08d2eb991c7796e8726debb7ad46dea", "patch": "@@ -31,8 +31,16 @@ def get(url, path, verbose=False):\n \n     try:\n         download(sha_path, sha_url, verbose)\n+        if os.path.exists(path):\n+            if verify(path, sha_path, False):\n+                print(\"using already-download file \" + path)\n+                return\n+            else:\n+                print(\"ignoring already-download file \" + path + \" due to failed verification\")\n+                os.unlink(path)\n         download(temp_path, url, verbose)\n-        verify(temp_path, sha_path, verbose)\n+        if not verify(temp_path, sha_path, True):\n+            raise RuntimeError(\"failed verification\")\n         print(\"moving {} to {}\".format(temp_path, path))\n         shutil.move(temp_path, path)\n     finally:\n@@ -64,13 +72,12 @@ def verify(path, sha_path, verbose):\n         found = hashlib.sha256(f.read()).hexdigest()\n     with open(sha_path, \"r\") as f:\n         expected, _ = f.readline().split()\n-    if found != expected:\n-        err = (\"invalid checksum:\\n\"\n+    verified = found == expected\n+    if not verified and verbose:\n+        print(\"invalid checksum:\\n\"\n                \"    found:    {}\\n\"\n                \"    expected: {}\".format(found, expected))\n-        if verbose:\n-            raise RuntimeError(err)\n-        sys.exit(err)\n+    return verified\n \n \n def unpack(tarball, dst, verbose=False, match=None):"}, {"sha": "127251cc802c9ccec20dc19c01901cbad412f43e", "filename": "src/etc/get-stage0.py", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a120ae70d08d2eb991c7796e8726debb7ad46dea/src%2Fetc%2Fget-stage0.py", "raw_url": "https://github.com/rust-lang/rust/raw/a120ae70d08d2eb991c7796e8726debb7ad46dea/src%2Fetc%2Fget-stage0.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fetc%2Fget-stage0.py?ref=a120ae70d08d2eb991c7796e8726debb7ad46dea", "patch": "@@ -31,8 +31,6 @@ def main(triple):\n     filename = 'rustc-{}-{}.tar.gz'.format(channel, triple)\n     url = 'https://static.rust-lang.org/dist/{}/{}'.format(date, filename)\n     dst = dl_dir + '/' + filename\n-    if os.path.exists(dst):\n-        os.unlink(dst)\n     bootstrap.get(url, dst)\n \n     stage0_dst = triple + '/stage0'"}]}