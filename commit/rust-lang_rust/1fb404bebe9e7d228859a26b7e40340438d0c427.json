{"sha": "1fb404bebe9e7d228859a26b7e40340438d0c427", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFmYjQwNGJlYmU5ZTdkMjI4ODU5YTI2YjdlNDAzNDA0MzhkMGM0Mjc=", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2020-10-17T21:58:46Z"}, "committer": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2020-11-05T09:22:08Z"}, "message": "Don't check for URLs inside codeblocks", "tree": {"sha": "2e28133acdab3396d3b6de78cfd455f2ab863f7a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2e28133acdab3396d3b6de78cfd455f2ab863f7a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1fb404bebe9e7d228859a26b7e40340438d0c427", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1fb404bebe9e7d228859a26b7e40340438d0c427", "html_url": "https://github.com/rust-lang/rust/commit/1fb404bebe9e7d228859a26b7e40340438d0c427", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1fb404bebe9e7d228859a26b7e40340438d0c427/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "fce2be0ea7b90fb9ba1a1704454b36307c9b8c07", "url": "https://api.github.com/repos/rust-lang/rust/commits/fce2be0ea7b90fb9ba1a1704454b36307c9b8c07", "html_url": "https://github.com/rust-lang/rust/commit/fce2be0ea7b90fb9ba1a1704454b36307c9b8c07"}], "stats": {"total": 94, "additions": 54, "deletions": 40}, "files": [{"sha": "a5d555eb19dca40c3834e0538d12051524b600b5", "filename": "src/librustdoc/passes/url_improvements.rs", "status": "modified", "additions": 30, "deletions": 20, "changes": 50, "blob_url": "https://github.com/rust-lang/rust/blob/1fb404bebe9e7d228859a26b7e40340438d0c427/src%2Flibrustdoc%2Fpasses%2Furl_improvements.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1fb404bebe9e7d228859a26b7e40340438d0c427/src%2Flibrustdoc%2Fpasses%2Furl_improvements.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Furl_improvements.rs?ref=1fb404bebe9e7d228859a26b7e40340438d0c427", "patch": "@@ -90,33 +90,43 @@ impl<'a, 'tcx> DocFolder for UrlImprovementsLinter<'a, 'tcx> {\n                 });\n             };\n \n-            let p = Parser::new_ext(&dox, opts()).into_offset_iter();\n+            let mut p = Parser::new_ext(&dox, opts()).into_offset_iter();\n \n-            let mut title = String::new();\n-            let mut in_link = false;\n-            let mut ignore = false;\n-\n-            for (event, range) in p {\n+            while let Some((event, range)) = p.next() {\n                 match event {\n                     Event::Start(Tag::Link(kind, _, _)) => {\n-                        in_link = true;\n-                        ignore = matches!(kind, LinkType::Autolink | LinkType::Email);\n-                    }\n-                    Event::End(Tag::Link(_, url, _)) => {\n-                        in_link = false;\n-                        // NOTE: links cannot be nested, so we don't need to check `kind`\n-                        if url.as_ref() == title && !ignore {\n-                            report_diag(self.cx, \"unneeded long form for URL\", &url, range);\n+                        let ignore = matches!(kind, LinkType::Autolink | LinkType::Email);\n+                        let mut title = String::new();\n+\n+                        while let Some((event, range)) = p.next() {\n+                            match event {\n+                                Event::End(Tag::Link(_, url, _)) => {\n+                                    // NOTE: links cannot be nested, so we don't need to check `kind`\n+                                    if url.as_ref() == title && !ignore {\n+                                        report_diag(\n+                                            self.cx,\n+                                            \"unneeded long form for URL\",\n+                                            &url,\n+                                            range,\n+                                        );\n+                                    }\n+                                    break;\n+                                }\n+                                Event::Text(s) if !ignore => title.push_str(&s),\n+                                _ => {}\n+                            }\n                         }\n-                        title.clear();\n-                        ignore = false;\n                     }\n-                    Event::Text(s) if in_link => {\n-                        if !ignore {\n-                            title.push_str(&s);\n+                    Event::Text(s) => self.find_raw_urls(&s, range, &report_diag),\n+                    Event::Start(Tag::CodeBlock(_)) => {\n+                        // We don't want to check the text inside the code blocks.\n+                        while let Some((event, _)) = p.next() {\n+                            match event {\n+                                Event::End(Tag::CodeBlock(_)) => break,\n+                                _ => {}\n+                            }\n                         }\n                     }\n-                    Event::Text(s) => self.find_raw_urls(&s, range, &report_diag),\n                     _ => {}\n                 }\n             }"}, {"sha": "81fd0ba7d512d28659bc1872494f0c0caa6066e9", "filename": "src/test/rustdoc-ui/url-improvements.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/1fb404bebe9e7d228859a26b7e40340438d0c427/src%2Ftest%2Frustdoc-ui%2Furl-improvements.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1fb404bebe9e7d228859a26b7e40340438d0c427/src%2Ftest%2Frustdoc-ui%2Furl-improvements.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Furl-improvements.rs?ref=1fb404bebe9e7d228859a26b7e40340438d0c427", "patch": "@@ -51,6 +51,10 @@ pub fn c() {}\n /// [b]\n ///\n /// [b]: http://b.com\n+///\n+/// ```\n+/// This link should not be linted: http://example.com\n+/// ```\n pub fn everything_is_fine_here() {}\n \n #[allow(url_improvements)]"}, {"sha": "e8ed2331dd84c3e3be202120452e4a1e7dd5e4fb", "filename": "src/test/rustdoc-ui/url-improvements.stderr", "status": "modified", "additions": 20, "deletions": 20, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/1fb404bebe9e7d228859a26b7e40340438d0c427/src%2Ftest%2Frustdoc-ui%2Furl-improvements.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/1fb404bebe9e7d228859a26b7e40340438d0c427/src%2Ftest%2Frustdoc-ui%2Furl-improvements.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Furl-improvements.stderr?ref=1fb404bebe9e7d228859a26b7e40340438d0c427", "patch": "@@ -1,119 +1,119 @@\n error: unneeded long form for URL\n-  --> $DIR/automatic-links.rs:3:5\n+  --> $DIR/url-improvements.rs:3:5\n    |\n LL | /// [http://a.com](http://a.com)\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: use an automatic link instead: `<http://a.com>`\n    |\n note: the lint level is defined here\n-  --> $DIR/automatic-links.rs:1:9\n+  --> $DIR/url-improvements.rs:1:9\n    |\n LL | #![deny(url_improvements)]\n    |         ^^^^^^^^^^^^^^^^\n \n error: unneeded long form for URL\n-  --> $DIR/automatic-links.rs:5:5\n+  --> $DIR/url-improvements.rs:5:5\n    |\n LL | /// [http://b.com]\n    |     ^^^^^^^^^^^^^^ help: use an automatic link instead: `<http://b.com>`\n \n error: this URL is not a hyperlink\n-  --> $DIR/automatic-links.rs:13:5\n+  --> $DIR/url-improvements.rs:13:5\n    |\n LL | /// https://somewhere.com\n    |     ^^^^^^^^^^^^^^^^^^^^^ help: use an automatic link instead: `<https://somewhere.com>`\n \n error: this URL is not a hyperlink\n-  --> $DIR/automatic-links.rs:15:5\n+  --> $DIR/url-improvements.rs:15:5\n    |\n LL | /// https://somewhere.com/a\n    |     ^^^^^^^^^^^^^^^^^^^^^^^ help: use an automatic link instead: `<https://somewhere.com/a>`\n \n error: this URL is not a hyperlink\n-  --> $DIR/automatic-links.rs:17:5\n+  --> $DIR/url-improvements.rs:17:5\n    |\n LL | /// https://www.somewhere.com\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^ help: use an automatic link instead: `<https://www.somewhere.com>`\n \n error: this URL is not a hyperlink\n-  --> $DIR/automatic-links.rs:19:5\n+  --> $DIR/url-improvements.rs:19:5\n    |\n LL | /// https://www.somewhere.com/a\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: use an automatic link instead: `<https://www.somewhere.com/a>`\n \n error: this URL is not a hyperlink\n-  --> $DIR/automatic-links.rs:21:5\n+  --> $DIR/url-improvements.rs:21:5\n    |\n LL | /// https://subdomain.example.com\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: use an automatic link instead: `<https://subdomain.example.com>`\n \n error: this URL is not a hyperlink\n-  --> $DIR/automatic-links.rs:23:5\n+  --> $DIR/url-improvements.rs:23:5\n    |\n LL | /// https://somewhere.com?\n    |     ^^^^^^^^^^^^^^^^^^^^^^ help: use an automatic link instead: `<https://somewhere.com?>`\n \n error: this URL is not a hyperlink\n-  --> $DIR/automatic-links.rs:25:5\n+  --> $DIR/url-improvements.rs:25:5\n    |\n LL | /// https://somewhere.com/a?\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^ help: use an automatic link instead: `<https://somewhere.com/a?>`\n \n error: this URL is not a hyperlink\n-  --> $DIR/automatic-links.rs:27:5\n+  --> $DIR/url-improvements.rs:27:5\n    |\n LL | /// https://somewhere.com?hello=12\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: use an automatic link instead: `<https://somewhere.com?hello=12>`\n \n error: this URL is not a hyperlink\n-  --> $DIR/automatic-links.rs:29:5\n+  --> $DIR/url-improvements.rs:29:5\n    |\n LL | /// https://somewhere.com/a?hello=12\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: use an automatic link instead: `<https://somewhere.com/a?hello=12>`\n \n error: this URL is not a hyperlink\n-  --> $DIR/automatic-links.rs:31:5\n+  --> $DIR/url-improvements.rs:31:5\n    |\n LL | /// https://example.com?hello=12#xyz\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: use an automatic link instead: `<https://example.com?hello=12#xyz>`\n \n error: this URL is not a hyperlink\n-  --> $DIR/automatic-links.rs:33:5\n+  --> $DIR/url-improvements.rs:33:5\n    |\n LL | /// https://example.com/a?hello=12#xyz\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: use an automatic link instead: `<https://example.com/a?hello=12#xyz>`\n \n error: this URL is not a hyperlink\n-  --> $DIR/automatic-links.rs:35:5\n+  --> $DIR/url-improvements.rs:35:5\n    |\n LL | /// https://example.com#xyz\n    |     ^^^^^^^^^^^^^^^^^^^^^^^ help: use an automatic link instead: `<https://example.com#xyz>`\n \n error: this URL is not a hyperlink\n-  --> $DIR/automatic-links.rs:37:5\n+  --> $DIR/url-improvements.rs:37:5\n    |\n LL | /// https://example.com/a#xyz\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^ help: use an automatic link instead: `<https://example.com/a#xyz>`\n \n error: this URL is not a hyperlink\n-  --> $DIR/automatic-links.rs:39:5\n+  --> $DIR/url-improvements.rs:39:5\n    |\n LL | /// https://somewhere.com?hello=12&bye=11\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: use an automatic link instead: `<https://somewhere.com?hello=12&bye=11>`\n \n error: this URL is not a hyperlink\n-  --> $DIR/automatic-links.rs:41:5\n+  --> $DIR/url-improvements.rs:41:5\n    |\n LL | /// https://somewhere.com/a?hello=12&bye=11\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: use an automatic link instead: `<https://somewhere.com/a?hello=12&bye=11>`\n \n error: this URL is not a hyperlink\n-  --> $DIR/automatic-links.rs:43:5\n+  --> $DIR/url-improvements.rs:43:5\n    |\n LL | /// https://somewhere.com?hello=12&bye=11#xyz\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: use an automatic link instead: `<https://somewhere.com?hello=12&bye=11#xyz>`\n \n error: this URL is not a hyperlink\n-  --> $DIR/automatic-links.rs:45:10\n+  --> $DIR/url-improvements.rs:45:10\n    |\n LL | /// hey! https://somewhere.com/a?hello=12&bye=11#xyz\n    |          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: use an automatic link instead: `<https://somewhere.com/a?hello=12&bye=11#xyz>`"}]}