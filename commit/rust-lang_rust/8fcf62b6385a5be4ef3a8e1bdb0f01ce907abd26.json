{"sha": "8fcf62b6385a5be4ef3a8e1bdb0f01ce907abd26", "node_id": "MDY6Q29tbWl0NzI0NzEyOjhmY2Y2MmI2Mzg1YTViZTRlZjNhOGUxYmRiMGYwMWNlOTA3YWJkMjY=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2013-10-06T04:58:55Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2013-10-09T19:38:18Z"}, "message": "Don't abort if the runtime is run twice.\n\nThis changes an `assert_once_ever!` assertion to just a plain old assertion\naround an atomic boolean to ensure that one particular runtime doesn't attempt\nto exit twice.\n\nCloses #9739", "tree": {"sha": "fd23aa0117a06bc0cf5827b374744abe32506880", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fd23aa0117a06bc0cf5827b374744abe32506880"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8fcf62b6385a5be4ef3a8e1bdb0f01ce907abd26", "comment_count": 5, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8fcf62b6385a5be4ef3a8e1bdb0f01ce907abd26", "html_url": "https://github.com/rust-lang/rust/commit/8fcf62b6385a5be4ef3a8e1bdb0f01ce907abd26", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8fcf62b6385a5be4ef3a8e1bdb0f01ce907abd26/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "acf9783879dca0db0721c10ac79c9078f2dec425", "url": "https://api.github.com/repos/rust-lang/rust/commits/acf9783879dca0db0721c10ac79c9078f2dec425", "html_url": "https://github.com/rust-lang/rust/commit/acf9783879dca0db0721c10ac79c9078f2dec425"}], "stats": {"total": 74, "additions": 34, "deletions": 40}, "files": [{"sha": "2ef25548535dc4b8444efcb3f742706aa5309b8c", "filename": "src/libstd/macros.rs", "status": "modified", "additions": 0, "deletions": 38, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/8fcf62b6385a5be4ef3a8e1bdb0f01ce907abd26/src%2Flibstd%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8fcf62b6385a5be4ef3a8e1bdb0f01ce907abd26/src%2Flibstd%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fmacros.rs?ref=8fcf62b6385a5be4ef3a8e1bdb0f01ce907abd26", "patch": "@@ -42,41 +42,3 @@ macro_rules! rtabort(\n         ::rt::util::abort(format!($($msg)*));\n     } )\n )\n-\n-macro_rules! assert_once_ever(\n-    ($($msg:tt)+) => ( {\n-        // FIXME(#8472) extra function should not be needed to hide unsafe\n-        fn assert_once_ever() {\n-            unsafe {\n-                static mut already_happened: int = 0;\n-                // Double-check lock to avoid a swap in the common case.\n-                if already_happened != 0 ||\n-                    ::unstable::intrinsics::atomic_xchg_relaxed(&mut already_happened, 1) != 0 {\n-                        fail2!(\"assert_once_ever happened twice: {}\",\n-                               format!($($msg)+));\n-                }\n-            }\n-        }\n-        assert_once_ever();\n-    } )\n-)\n-\n-#[cfg(test)]\n-mod tests {\n-    #[test]\n-    fn test_assert_once_ever_ok() {\n-        assert_once_ever!(\"help i'm stuck in an\");\n-        assert_once_ever!(\"assertion error message\");\n-    }\n-\n-    #[test] #[ignore(cfg(windows))] #[should_fail]\n-    fn test_assert_once_ever_fail() {\n-        use task;\n-\n-        fn f() { assert_once_ever!(\"if you're seeing this... good!\") }\n-\n-        // linked & watched, naturally\n-        task::spawn(f);\n-        task::spawn(f);\n-    }\n-}"}, {"sha": "fa9d767ec3fc9b5350243382dd3ad8facea738b3", "filename": "src/libstd/rt/mod.rs", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/8fcf62b6385a5be4ef3a8e1bdb0f01ce907abd26/src%2Flibstd%2Frt%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8fcf62b6385a5be4ef3a8e1bdb0f01ce907abd26/src%2Flibstd%2Frt%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Frt%2Fmod.rs?ref=8fcf62b6385a5be4ef3a8e1bdb0f01ce907abd26", "patch": "@@ -70,7 +70,7 @@ use rt::task::{Task, SchedTask, GreenTask, Sched};\n use rt::thread::Thread;\n use rt::work_queue::WorkQueue;\n use rt::uv::uvio::UvEventLoop;\n-use unstable::atomics::{AtomicInt, SeqCst};\n+use unstable::atomics::{AtomicInt, AtomicBool, SeqCst};\n use unstable::sync::UnsafeArc;\n use vec;\n use vec::{OwnedVector, MutableVector, ImmutableVector};\n@@ -298,11 +298,17 @@ fn run_(main: ~fn(), use_main_sched: bool) -> int {\n     let exit_code = UnsafeArc::new(AtomicInt::new(0));\n     let exit_code_clone = exit_code.clone();\n \n+    // Used to sanity check that the runtime only exits once\n+    let exited_already = UnsafeArc::new(AtomicBool::new(false));\n+\n     // When the main task exits, after all the tasks in the main\n     // task tree, shut down the schedulers and set the exit code.\n     let handles = Cell::new(handles);\n     let on_exit: ~fn(bool) = |exit_success| {\n-        assert_once_ever!(\"last task exiting\");\n+        unsafe {\n+            assert!(!(*exited_already.get()).swap(true, SeqCst),\n+                    \"the runtime already exited\");\n+        }\n \n         let mut handles = handles.take();\n         for handle in handles.mut_iter() {"}, {"sha": "0bb02ed5498b77e3cd8cfcc17147d9412c10e671", "filename": "src/test/run-pass/rt-run-twice.rs", "status": "added", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/8fcf62b6385a5be4ef3a8e1bdb0f01ce907abd26/src%2Ftest%2Frun-pass%2Frt-run-twice.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8fcf62b6385a5be4ef3a8e1bdb0f01ce907abd26/src%2Ftest%2Frun-pass%2Frt-run-twice.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Frt-run-twice.rs?ref=8fcf62b6385a5be4ef3a8e1bdb0f01ce907abd26", "patch": "@@ -0,0 +1,26 @@\n+// Copyright 2013 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// xfail-fast windows uses a different test runner\n+\n+use std::rt;\n+\n+#[start]\n+fn start(argc: int, argv: **u8) -> int {\n+    do rt::start(argc, argv) {\n+        println(\"First invocation\");\n+    };\n+\n+    do rt::start(argc, argv) {\n+        println(\"Second invocation\");\n+    };\n+\n+    0\n+}"}]}