{"sha": "669191bca995d01db9eb75e3d906cfc07e28d7dd", "node_id": "MDY6Q29tbWl0NzI0NzEyOjY2OTE5MWJjYTk5NWQwMWRiOWViNzVlM2Q5MDZjZmMwN2UyOGQ3ZGQ=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-04-14T09:30:22Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-04-14T09:30:22Z"}, "message": "Auto merge of #1331 - samrat:macos-mach-timebase-info, r=RalfJung\n\nImplement `mach_timebase_info` for macOS\n\nSince we return nanoseceonds instead of ticks from `mach_absolute_time`, we don't need to scale the absolute time\n\nFixes #1288", "tree": {"sha": "db613d3cb6b2f05b1a286c2a315ff163b2f00b85", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/db613d3cb6b2f05b1a286c2a315ff163b2f00b85"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/669191bca995d01db9eb75e3d906cfc07e28d7dd", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/669191bca995d01db9eb75e3d906cfc07e28d7dd", "html_url": "https://github.com/rust-lang/rust/commit/669191bca995d01db9eb75e3d906cfc07e28d7dd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/669191bca995d01db9eb75e3d906cfc07e28d7dd/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4ed3d487a6671865de902afd78a4cc5ced030aed", "url": "https://api.github.com/repos/rust-lang/rust/commits/4ed3d487a6671865de902afd78a4cc5ced030aed", "html_url": "https://github.com/rust-lang/rust/commit/4ed3d487a6671865de902afd78a4cc5ced030aed"}, {"sha": "fff45b77adc7a08b1ee2d3c277e74f2ec7027ea2", "url": "https://api.github.com/repos/rust-lang/rust/commits/fff45b77adc7a08b1ee2d3c277e74f2ec7027ea2", "html_url": "https://github.com/rust-lang/rust/commit/fff45b77adc7a08b1ee2d3c277e74f2ec7027ea2"}], "stats": {"total": 42, "additions": 32, "deletions": 10}, "files": [{"sha": "e7baacf7274d2cbb4595c6e8392e05be444e45e4", "filename": "src/shims/foreign_items/posix/macos.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/669191bca995d01db9eb75e3d906cfc07e28d7dd/src%2Fshims%2Fforeign_items%2Fposix%2Fmacos.rs", "raw_url": "https://github.com/rust-lang/rust/raw/669191bca995d01db9eb75e3d906cfc07e28d7dd/src%2Fshims%2Fforeign_items%2Fposix%2Fmacos.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fshims%2Fforeign_items%2Fposix%2Fmacos.rs?ref=669191bca995d01db9eb75e3d906cfc07e28d7dd", "patch": "@@ -60,6 +60,11 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n                 this.write_scalar(Scalar::from_u64(result), dest)?;\n             }\n \n+            \"mach_timebase_info\" => {\n+                let result = this.mach_timebase_info(args[0])?;\n+                this.write_scalar(Scalar::from_i32(result), dest)?;\n+            },\n+\n             // Access to command-line arguments\n             \"_NSGetArgc\" => {\n                 this.write_scalar(this.machine.argc.expect(\"machine must be initialized\"), dest)?;"}, {"sha": "a87db9878202491ffd1e8aad34839b48017acb69", "filename": "src/shims/time.rs", "status": "modified", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/669191bca995d01db9eb75e3d906cfc07e28d7dd/src%2Fshims%2Ftime.rs", "raw_url": "https://github.com/rust-lang/rust/raw/669191bca995d01db9eb75e3d906cfc07e28d7dd/src%2Fshims%2Ftime.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fshims%2Ftime.rs?ref=669191bca995d01db9eb75e3d906cfc07e28d7dd", "patch": "@@ -13,6 +13,7 @@ pub fn system_time_to_duration<'tcx>(time: &SystemTime) -> InterpResult<'tcx, Du\n         .map_err(|_| err_unsup_format!(\"times before the Unix epoch are not supported\").into())\n }\n \n+\n impl<'mir, 'tcx> EvalContextExt<'mir, 'tcx> for crate::MiriEvalContext<'mir, 'tcx> {}\n pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx> {\n     fn clock_gettime(\n@@ -159,4 +160,24 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n         u64::try_from(duration.as_nanos())\n             .map_err(|_| err_unsup_format!(\"programs running longer than 2^64 nanoseconds are not supported\").into())\n     }\n+\n+    fn mach_timebase_info(&mut self, info_op: OpTy<'tcx, Tag>) -> InterpResult<'tcx, i32> {\n+        let this = self.eval_context_mut();\n+\n+        this.assert_target_os(\"macos\", \"mach_timebase_info\");\n+        this.check_no_isolation(\"mach_timebase_info\")?;\n+\n+        let info = this.deref_operand(info_op)?;\n+\n+        // Since our emulated ticks in `mach_absolute_time` *are* nanoseconds,\n+        // no scaling needs to happen.\n+        let (numer, denom) = (1,1);\n+        let imms = [\n+            immty_from_int_checked(numer, this.machine.layouts.u32)?,\n+            immty_from_int_checked(denom, this.machine.layouts.u32)?\n+        ];\n+\n+        this.write_packed_immediates(info, &imms)?;\n+        Ok(0) // KERN_SUCCESS\n+    }\n }"}, {"sha": "2c9b579f7e2945f9bdc3126aa3f765c2adc284be", "filename": "tests/run-pass/time.rs", "status": "modified", "additions": 6, "deletions": 10, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/669191bca995d01db9eb75e3d906cfc07e28d7dd/tests%2Frun-pass%2Ftime.rs", "raw_url": "https://github.com/rust-lang/rust/raw/669191bca995d01db9eb75e3d906cfc07e28d7dd/tests%2Frun-pass%2Ftime.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-pass%2Ftime.rs?ref=669191bca995d01db9eb75e3d906cfc07e28d7dd", "patch": "@@ -24,14 +24,10 @@ fn main() {\n     for _ in 0..10 { drop(vec![42]); }\n     let now2 = Instant::now();\n     assert!(now2 > now1);\n-\n-    #[cfg(not(target_os = \"macos\"))] // TODO: macOS does not support Instant subtraction\n-    {\n-        let diff = now2.duration_since(now1);\n-        assert_eq!(now1 + diff, now2);\n-        assert_eq!(now2 - diff, now1);\n-        // Sanity-check the difference we got.\n-        assert!(diff.as_micros() > 1);\n-        assert!(diff.as_micros() < 1_000_000);\n-    }\n+    let diff = now2.duration_since(now1);\n+    assert_eq!(now1 + diff, now2);\n+    assert_eq!(now2 - diff, now1);\n+    // Sanity-check the difference we got.\n+    assert!(diff.as_micros() > 1);\n+    assert!(diff.as_micros() < 1_000_000);\n }"}]}