{"sha": "728b3f235656623082f558f38ede29e0f8be43d9", "node_id": "C_kwDOAAsO6NoAKDcyOGIzZjIzNTY1NjYyMzA4MmY1NThmMzhlZGUyOWUwZjhiZTQzZDk", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2021-11-18T17:22:54Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-11-18T17:22:54Z"}, "message": "Rollup merge of #90386 - pierwill:assert-incr-state-85864, r=Aaron1011\n\nAdd `-Zassert-incr-state` to assert state of incremental cache\n\nCloses #85864.", "tree": {"sha": "b25c0db717159453fbb4d70490aa538580bca180", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b25c0db717159453fbb4d70490aa538580bca180"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/728b3f235656623082f558f38ede29e0f8be43d9", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhlovvCRBK7hj4Ov3rIwAA4k8IAIbqQo+6AJx/VwZn7ZInkr5q\nhmlDBafUex/gw0AEE0luGLH1RdtLF2JCg1rB1gy5E6Umoq6GpE+kRZgGrdNoFWyg\nDbbkknt4w6dIrOASZNHi96RK9Uc+te1hp1nNJzkXG19zW4GuPSQxcroVyYK/MbIA\nSLT2caBKHpHhpFSIjX7sZxB7pE8qrP/2sY1KLHTWV6kcckfwPXGoaYkphZy8ZVLH\nH/g8N3IMziEbDBIUQPuIer/wfR5or6N39/kscoQ7topglMt7TyhBNwA9Y0decSEG\nIEprPTSn+BAF4eDe+w3HiWnoNvJHiAtlqpWrBT8VHEoQSIhjurm3bRfapQD9IDQ=\n=j095\n-----END PGP SIGNATURE-----\n", "payload": "tree b25c0db717159453fbb4d70490aa538580bca180\nparent 6414e0b5b308d3ae27da83c6a25098cc8aadc1a9\nparent 1642fdfea0ba60f4e142e5d767491ab7686cd13b\nauthor Yuki Okushi <jtitor@2k36.org> 1637256174 +0900\ncommitter GitHub <noreply@github.com> 1637256174 +0900\n\nRollup merge of #90386 - pierwill:assert-incr-state-85864, r=Aaron1011\n\nAdd `-Zassert-incr-state` to assert state of incremental cache\n\nCloses #85864.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/728b3f235656623082f558f38ede29e0f8be43d9", "html_url": "https://github.com/rust-lang/rust/commit/728b3f235656623082f558f38ede29e0f8be43d9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/728b3f235656623082f558f38ede29e0f8be43d9/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6414e0b5b308d3ae27da83c6a25098cc8aadc1a9", "url": "https://api.github.com/repos/rust-lang/rust/commits/6414e0b5b308d3ae27da83c6a25098cc8aadc1a9", "html_url": "https://github.com/rust-lang/rust/commit/6414e0b5b308d3ae27da83c6a25098cc8aadc1a9"}, {"sha": "1642fdfea0ba60f4e142e5d767491ab7686cd13b", "url": "https://api.github.com/repos/rust-lang/rust/commits/1642fdfea0ba60f4e142e5d767491ab7686cd13b", "html_url": "https://github.com/rust-lang/rust/commit/1642fdfea0ba60f4e142e5d767491ab7686cd13b"}], "stats": {"total": 67, "additions": 63, "deletions": 4}, "files": [{"sha": "9c6e2aeb50a761a4299a5222ea8050f6539cc79a", "filename": "compiler/rustc_incremental/src/persist/load.rs", "status": "modified", "additions": 23, "deletions": 1, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/728b3f235656623082f558f38ede29e0f8be43d9/compiler%2Frustc_incremental%2Fsrc%2Fpersist%2Fload.rs", "raw_url": "https://github.com/rust-lang/rust/raw/728b3f235656623082f558f38ede29e0f8be43d9/compiler%2Frustc_incremental%2Fsrc%2Fpersist%2Fload.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_incremental%2Fsrc%2Fpersist%2Fload.rs?ref=728b3f235656623082f558f38ede29e0f8be43d9", "patch": "@@ -6,6 +6,7 @@ use rustc_middle::dep_graph::{SerializedDepGraph, WorkProduct, WorkProductId};\n use rustc_middle::ty::OnDiskCache;\n use rustc_serialize::opaque::Decoder;\n use rustc_serialize::Decodable;\n+use rustc_session::config::IncrementalStateAssertion;\n use rustc_session::Session;\n use std::path::Path;\n \n@@ -16,6 +17,7 @@ use super::work_product;\n \n type WorkProductMap = FxHashMap<WorkProductId, WorkProduct>;\n \n+#[derive(Debug)]\n pub enum LoadResult<T> {\n     Ok { data: T },\n     DataOutOfDate,\n@@ -24,6 +26,26 @@ pub enum LoadResult<T> {\n \n impl<T: Default> LoadResult<T> {\n     pub fn open(self, sess: &Session) -> T {\n+        // Check for errors when using `-Zassert-incremental-state`\n+        match (sess.opts.assert_incr_state, &self) {\n+            (Some(IncrementalStateAssertion::NotLoaded), LoadResult::Ok { .. }) => {\n+                sess.fatal(\n+                    \"We asserted that the incremental cache should not be loaded, \\\n+                         but it was loaded.\",\n+                );\n+            }\n+            (\n+                Some(IncrementalStateAssertion::Loaded),\n+                LoadResult::Error { .. } | LoadResult::DataOutOfDate,\n+            ) => {\n+                sess.fatal(\n+                    \"We asserted that an existing incremental cache directory should \\\n+                         be successfully loaded, but it was not.\",\n+                );\n+            }\n+            _ => {}\n+        };\n+\n         match self {\n             LoadResult::Error { message } => {\n                 sess.warn(&message);\n@@ -33,7 +55,7 @@ impl<T: Default> LoadResult<T> {\n                 if let Err(err) = delete_all_session_dir_contents(sess) {\n                     sess.err(&format!(\n                         \"Failed to delete invalidated or incompatible \\\n-                                      incremental compilation session directory contents `{}`: {}.\",\n+                         incremental compilation session directory contents `{}`: {}.\",\n                         dep_graph_path(sess).display(),\n                         err\n                     ));"}, {"sha": "6b5c79a2d5dcd18b6fc7f82e3b903ecf37acb7d7", "filename": "compiler/rustc_interface/src/tests.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/728b3f235656623082f558f38ede29e0f8be43d9/compiler%2Frustc_interface%2Fsrc%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/728b3f235656623082f558f38ede29e0f8be43d9/compiler%2Frustc_interface%2Fsrc%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_interface%2Fsrc%2Ftests.rs?ref=728b3f235656623082f558f38ede29e0f8be43d9", "patch": "@@ -636,6 +636,7 @@ fn test_debugging_options_tracking_hash() {\n \n     // Make sure that changing an [UNTRACKED] option leaves the hash unchanged.\n     // This list is in alphabetical order.\n+    untracked!(assert_incr_state, Some(String::from(\"loaded\")));\n     untracked!(ast_json, true);\n     untracked!(ast_json_noexpand, true);\n     untracked!(borrowck, String::from(\"other\"));"}, {"sha": "3f0a6b0e2f6a0be93f2541aafd49079e775642be", "filename": "compiler/rustc_session/src/config.rs", "status": "modified", "additions": 32, "deletions": 0, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/728b3f235656623082f558f38ede29e0f8be43d9/compiler%2Frustc_session%2Fsrc%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/728b3f235656623082f558f38ede29e0f8be43d9/compiler%2Frustc_session%2Fsrc%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Fconfig.rs?ref=728b3f235656623082f558f38ede29e0f8be43d9", "patch": "@@ -165,6 +165,18 @@ pub enum LinkerPluginLto {\n     Disabled,\n }\n \n+/// Used with `-Z assert-incr-state`.\n+#[derive(Clone, Copy, PartialEq, Hash, Debug)]\n+pub enum IncrementalStateAssertion {\n+    /// Found and loaded an existing session directory.\n+    ///\n+    /// Note that this says nothing about whether any particular query\n+    /// will be found to be red or green.\n+    Loaded,\n+    /// Did not load an existing session directory.\n+    NotLoaded,\n+}\n+\n impl LinkerPluginLto {\n     pub fn enabled(&self) -> bool {\n         match *self {\n@@ -704,6 +716,7 @@ pub fn host_triple() -> &'static str {\n impl Default for Options {\n     fn default() -> Options {\n         Options {\n+            assert_incr_state: None,\n             crate_types: Vec::new(),\n             optimize: OptLevel::No,\n             debuginfo: DebugInfo::None,\n@@ -1626,6 +1639,21 @@ fn select_debuginfo(\n     }\n }\n \n+crate fn parse_assert_incr_state(\n+    opt_assertion: &Option<String>,\n+    error_format: ErrorOutputType,\n+) -> Option<IncrementalStateAssertion> {\n+    match opt_assertion {\n+        Some(s) if s.as_str() == \"loaded\" => Some(IncrementalStateAssertion::Loaded),\n+        Some(s) if s.as_str() == \"not-loaded\" => Some(IncrementalStateAssertion::NotLoaded),\n+        Some(s) => early_error(\n+            error_format,\n+            &format!(\"unexpected incremental state assertion value: {}\", s),\n+        ),\n+        None => None,\n+    }\n+}\n+\n fn parse_native_lib_kind(\n     matches: &getopts::Matches,\n     kind: &str,\n@@ -2015,6 +2043,9 @@ pub fn build_session_options(matches: &getopts::Matches) -> Options {\n \n     let incremental = cg.incremental.as_ref().map(PathBuf::from);\n \n+    let assert_incr_state =\n+        parse_assert_incr_state(&debugging_opts.assert_incr_state, error_format);\n+\n     if debugging_opts.profile && incremental.is_some() {\n         early_error(\n             error_format,\n@@ -2179,6 +2210,7 @@ pub fn build_session_options(matches: &getopts::Matches) -> Options {\n     };\n \n     Options {\n+        assert_incr_state,\n         crate_types,\n         optimize: opt_level,\n         debuginfo,"}, {"sha": "2c217e40abaa5de80a70571ad524e24cb9436863", "filename": "compiler/rustc_session/src/options.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/728b3f235656623082f558f38ede29e0f8be43d9/compiler%2Frustc_session%2Fsrc%2Foptions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/728b3f235656623082f558f38ede29e0f8be43d9/compiler%2Frustc_session%2Fsrc%2Foptions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Foptions.rs?ref=728b3f235656623082f558f38ede29e0f8be43d9", "patch": "@@ -4,7 +4,6 @@ use crate::early_error;\n use crate::lint;\n use crate::search_paths::SearchPath;\n use crate::utils::NativeLib;\n-\n use rustc_target::spec::{CodeModel, LinkerFlavor, MergeFunctions, PanicStrategy, SanitizerSet};\n use rustc_target::spec::{RelocModel, RelroLevel, SplitDebuginfo, TargetTriple, TlsModel};\n \n@@ -150,6 +149,7 @@ top_level_options!(\n         /// If `Some`, enable incremental compilation, using the given\n         /// directory to store intermediate results.\n         incremental: Option<PathBuf> [UNTRACKED],\n+        assert_incr_state: Option<IncrementalStateAssertion> [UNTRACKED],\n \n         debugging_opts: DebuggingOptions [SUBSTRUCT],\n         prints: Vec<PrintRequest> [UNTRACKED],\n@@ -1046,6 +1046,9 @@ options! {\n         \"make cfg(version) treat the current version as incomplete (default: no)\"),\n     asm_comments: bool = (false, parse_bool, [TRACKED],\n         \"generate comments into the assembly (may change behavior) (default: no)\"),\n+    assert_incr_state: Option<String> = (None, parse_opt_string, [UNTRACKED],\n+        \"assert that the incremental cache is in given state: \\\n+         either `loaded` or `not-loaded`.\"),\n     ast_json: bool = (false, parse_bool, [UNTRACKED],\n         \"print the AST as JSON and halt (default: no)\"),\n     ast_json_noexpand: bool = (false, parse_bool, [UNTRACKED],"}, {"sha": "1e7d823050c3dbb4e3f7ce313ef39c3504866a8e", "filename": "src/test/incremental/link_order/auxiliary/my_lib.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/728b3f235656623082f558f38ede29e0f8be43d9/src%2Ftest%2Fincremental%2Flink_order%2Fauxiliary%2Fmy_lib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/728b3f235656623082f558f38ede29e0f8be43d9/src%2Ftest%2Fincremental%2Flink_order%2Fauxiliary%2Fmy_lib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fincremental%2Flink_order%2Fauxiliary%2Fmy_lib.rs?ref=728b3f235656623082f558f38ede29e0f8be43d9", "patch": "@@ -1,3 +1,3 @@\n // no-prefer-dynamic\n-//[cfail1] compile-flags: -lbar -lfoo --crate-type lib\n-//[cfail2] compile-flags: -lfoo -lbar --crate-type lib\n+//[cfail1] compile-flags: -lbar -lfoo --crate-type lib -Zassert-incr-state=not-loaded\n+//[cfail2] compile-flags: -lfoo -lbar --crate-type lib -Zassert-incr-state=not-loaded"}, {"sha": "a7c79e9d751e0e8af468e20ced0b543882f3e018", "filename": "src/test/incremental/struct_change_field_name.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/728b3f235656623082f558f38ede29e0f8be43d9/src%2Ftest%2Fincremental%2Fstruct_change_field_name.rs", "raw_url": "https://github.com/rust-lang/rust/raw/728b3f235656623082f558f38ede29e0f8be43d9/src%2Ftest%2Fincremental%2Fstruct_change_field_name.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fincremental%2Fstruct_change_field_name.rs?ref=728b3f235656623082f558f38ede29e0f8be43d9", "patch": "@@ -3,6 +3,7 @@\n \n // revisions:rpass1 cfail2\n // compile-flags: -Z query-dep-graph\n+// [cfail2] compile-flags: -Z query-dep-graph -Z assert-incr-state=loaded\n \n #![feature(rustc_attrs)]\n "}]}