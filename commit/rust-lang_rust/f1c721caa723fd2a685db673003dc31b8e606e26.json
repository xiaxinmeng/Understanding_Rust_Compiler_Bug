{"sha": "f1c721caa723fd2a685db673003dc31b8e606e26", "node_id": "MDY6Q29tbWl0NzI0NzEyOmYxYzcyMWNhYTcyM2ZkMmE2ODVkYjY3MzAwM2RjMzFiOGU2MDZlMjY=", "commit": {"author": {"name": "Felix S. Klock II", "email": "pnkfelix@pnkfx.org", "date": "2017-08-31T10:04:19Z"}, "committer": {"name": "Felix S. Klock II", "email": "pnkfelix@pnkfx.org", "date": "2017-09-05T13:19:55Z"}, "message": "Skip EndRegion emission by default. Use `-Z emit-end-regions` to reenable it.\n\nThe main intent is to fix cases where EndRegion emission is believed\nto be causing excess peak memory pressure.\n\nIt may also be a welcome change to people inspecting the MIR output\nwho find the EndRegions to be a distraction.", "tree": {"sha": "9d3a88bd2f131c5e83783df8f18797990d49f7d0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9d3a88bd2f131c5e83783df8f18797990d49f7d0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f1c721caa723fd2a685db673003dc31b8e606e26", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f1c721caa723fd2a685db673003dc31b8e606e26", "html_url": "https://github.com/rust-lang/rust/commit/f1c721caa723fd2a685db673003dc31b8e606e26", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f1c721caa723fd2a685db673003dc31b8e606e26/comments", "author": {"login": "pnkfelix", "id": 173127, "node_id": "MDQ6VXNlcjE3MzEyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pnkfelix", "html_url": "https://github.com/pnkfelix", "followers_url": "https://api.github.com/users/pnkfelix/followers", "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}", "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}", "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions", "organizations_url": "https://api.github.com/users/pnkfelix/orgs", "repos_url": "https://api.github.com/users/pnkfelix/repos", "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}", "received_events_url": "https://api.github.com/users/pnkfelix/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pnkfelix", "id": 173127, "node_id": "MDQ6VXNlcjE3MzEyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pnkfelix", "html_url": "https://github.com/pnkfelix", "followers_url": "https://api.github.com/users/pnkfelix/followers", "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}", "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}", "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions", "organizations_url": "https://api.github.com/users/pnkfelix/orgs", "repos_url": "https://api.github.com/users/pnkfelix/repos", "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}", "received_events_url": "https://api.github.com/users/pnkfelix/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2f1ef9ef1181298d46e79d5dde6bafeb6483926f", "url": "https://api.github.com/repos/rust-lang/rust/commits/2f1ef9ef1181298d46e79d5dde6bafeb6483926f", "html_url": "https://github.com/rust-lang/rust/commit/2f1ef9ef1181298d46e79d5dde6bafeb6483926f"}], "stats": {"total": 41, "additions": 25, "deletions": 16}, "files": [{"sha": "577c905a1d5a689af6033ce05644fc6af7e51d9a", "filename": "src/librustc/session/config.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f1c721caa723fd2a685db673003dc31b8e606e26/src%2Flibrustc%2Fsession%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f1c721caa723fd2a685db673003dc31b8e606e26/src%2Flibrustc%2Fsession%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fsession%2Fconfig.rs?ref=f1c721caa723fd2a685db673003dc31b8e606e26", "patch": "@@ -919,6 +919,8 @@ options! {DebuggingOptions, DebuggingSetter, basic_debugging_options,\n         \"when debug-printing compiler state, do not include spans\"), // o/w tests have closure@path\n     identify_regions: bool = (false, parse_bool, [UNTRACKED],\n         \"make unnamed regions display as '# (where # is some non-ident unique id)\"),\n+    emit_end_regions: bool = (false, parse_bool, [UNTRACKED],\n+        \"emit EndRegion as part of MIR; enable transforms that solely process EndRegion\"),\n     borrowck_mir: bool = (false, parse_bool, [UNTRACKED],\n         \"implicitly treat functions as if they have `#[rustc_mir_borrowck]` attribute\"),\n     time_passes: bool = (false, parse_bool, [UNTRACKED],"}, {"sha": "859a1000ebe19bc5a4ba3bd2df658773d4e17687", "filename": "src/librustc_mir/build/cfg.rs", "status": "modified", "additions": 12, "deletions": 8, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/f1c721caa723fd2a685db673003dc31b8e606e26/src%2Flibrustc_mir%2Fbuild%2Fcfg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f1c721caa723fd2a685db673003dc31b8e606e26/src%2Flibrustc_mir%2Fbuild%2Fcfg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fbuild%2Fcfg.rs?ref=f1c721caa723fd2a685db673003dc31b8e606e26", "patch": "@@ -16,6 +16,7 @@\n use build::CFG;\n use rustc::middle::region;\n use rustc::mir::*;\n+use rustc::ty;\n \n impl<'tcx> CFG<'tcx> {\n     pub fn block_data(&self, blk: BasicBlock) -> &BasicBlockData<'tcx> {\n@@ -44,14 +45,17 @@ impl<'tcx> CFG<'tcx> {\n         self.block_data_mut(block).statements.push(statement);\n     }\n \n-    pub fn push_end_region(&mut self,\n-                           block: BasicBlock,\n-                           source_info: SourceInfo,\n-                           region_scope: region::Scope) {\n-        self.push(block, Statement {\n-            source_info,\n-            kind: StatementKind::EndRegion(region_scope),\n-        });\n+    pub fn push_end_region<'a, 'gcx:'a+'tcx>(&mut self,\n+                                             tcx: ty::TyCtxt<'a, 'gcx, 'tcx>,\n+                                             block: BasicBlock,\n+                                             source_info: SourceInfo,\n+                                             region_scope: region::Scope) {\n+        if tcx.sess.opts.debugging_opts.emit_end_regions {\n+            self.push(block, Statement {\n+                source_info,\n+                kind: StatementKind::EndRegion(region_scope),\n+            });\n+        }\n     }\n \n     pub fn push_assign(&mut self,"}, {"sha": "c08620c1e41040371f402e07287bbafb60167a15", "filename": "src/librustc_mir/build/scope.rs", "status": "modified", "additions": 8, "deletions": 7, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/f1c721caa723fd2a685db673003dc31b8e606e26/src%2Flibrustc_mir%2Fbuild%2Fscope.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f1c721caa723fd2a685db673003dc31b8e606e26/src%2Flibrustc_mir%2Fbuild%2Fscope.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fbuild%2Fscope.rs?ref=f1c721caa723fd2a685db673003dc31b8e606e26", "patch": "@@ -89,7 +89,7 @@ should go to.\n \n use build::{BlockAnd, BlockAndExtension, Builder, CFG};\n use rustc::middle::region;\n-use rustc::ty::Ty;\n+use rustc::ty::{Ty, TyCtxt};\n use rustc::mir::*;\n use rustc::mir::transform::MirSource;\n use syntax_pos::{Span};\n@@ -359,7 +359,7 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n                                           self.arg_count,\n                                           false));\n \n-        self.cfg.push_end_region(block, region_scope.1, scope.region_scope);\n+        self.cfg.push_end_region(self.hir.tcx(), block, region_scope.1, scope.region_scope);\n         block.unit()\n     }\n \n@@ -414,7 +414,7 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n                                               false));\n \n             // End all regions for scopes out of which we are breaking.\n-            self.cfg.push_end_region(block, region_scope.1, scope.region_scope);\n+            self.cfg.push_end_region(self.hir.tcx(), block, region_scope.1, scope.region_scope);\n         }\n         }\n         let scope = &self.scopes[len - scope_count];\n@@ -463,7 +463,7 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n                                               true));\n \n             // End all regions for scopes out of which we are breaking.\n-            self.cfg.push_end_region(block, src_info, scope.region_scope);\n+            self.cfg.push_end_region(self.hir.tcx(), block, src_info, scope.region_scope);\n         }\n \n         self.cfg.terminate(block, src_info, TerminatorKind::GeneratorDrop);\n@@ -694,7 +694,7 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n         };\n \n         for scope in scopes.iter_mut() {\n-            target = build_diverge_scope(cfg, scope.region_scope_span,\n+            target = build_diverge_scope(self.hir.tcx(), cfg, scope.region_scope_span,\n                                          scope, target, generator_drop);\n         }\n         Some(target)\n@@ -831,7 +831,8 @@ fn build_scope_drops<'tcx>(cfg: &mut CFG<'tcx>,\n     block.unit()\n }\n \n-fn build_diverge_scope<'a, 'gcx, 'tcx>(cfg: &mut CFG<'tcx>,\n+fn build_diverge_scope<'a, 'gcx, 'tcx>(tcx: TyCtxt<'a, 'gcx, 'tcx>,\n+                                       cfg: &mut CFG<'tcx>,\n                                        span: Span,\n                                        scope: &mut Scope<'tcx>,\n                                        mut target: BasicBlock,\n@@ -893,7 +894,7 @@ fn build_diverge_scope<'a, 'gcx, 'tcx>(cfg: &mut CFG<'tcx>,\n     // becomes trivial goto after pass that removes all EndRegions.)\n     {\n         let block = cfg.start_new_cleanup_block();\n-        cfg.push_end_region(block, source_info(span), scope.region_scope);\n+        cfg.push_end_region(tcx, block, source_info(span), scope.region_scope);\n         cfg.terminate(block, source_info(span), TerminatorKind::Goto { target: target });\n         target = block\n     }"}, {"sha": "4e4698457c3705db8e0a185a0ec6918a50bc862f", "filename": "src/librustc_mir/transform/clean_end_regions.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/f1c721caa723fd2a685db673003dc31b8e606e26/src%2Flibrustc_mir%2Ftransform%2Fclean_end_regions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f1c721caa723fd2a685db673003dc31b8e606e26/src%2Flibrustc_mir%2Ftransform%2Fclean_end_regions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fclean_end_regions.rs?ref=f1c721caa723fd2a685db673003dc31b8e606e26", "patch": "@@ -39,9 +39,11 @@ struct DeleteTrivialEndRegions<'a> {\n \n impl MirPass for CleanEndRegions {\n     fn run_pass<'a, 'tcx>(&self,\n-                          _tcx: TyCtxt<'a, 'tcx, 'tcx>,\n+                          tcx: TyCtxt<'a, 'tcx, 'tcx>,\n                           _source: MirSource,\n                           mir: &mut Mir<'tcx>) {\n+        if !tcx.sess.opts.debugging_opts.emit_end_regions { return; }\n+\n         let mut gather = GatherBorrowedRegions {\n             seen_regions: FxHashSet()\n         };"}]}