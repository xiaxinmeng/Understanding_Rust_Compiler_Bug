{"sha": "471b4d6e58baba9ee880c8c8f4183bcf363708cf", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQ3MWI0ZDZlNThiYWJhOWVlODgwYzhjOGY0MTgzYmNmMzYzNzA4Y2Y=", "commit": {"author": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2011-12-17T21:51:35Z"}, "committer": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2011-12-17T22:10:44Z"}, "message": "rt: Use a DWARF CFI scheme that works on mac in __morestack", "tree": {"sha": "b24a5ac47efe8983b848991d699869305c199a10", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b24a5ac47efe8983b848991d699869305c199a10"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/471b4d6e58baba9ee880c8c8f4183bcf363708cf", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/471b4d6e58baba9ee880c8c8f4183bcf363708cf", "html_url": "https://github.com/rust-lang/rust/commit/471b4d6e58baba9ee880c8c8f4183bcf363708cf", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/471b4d6e58baba9ee880c8c8f4183bcf363708cf/comments", "author": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "committer": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7da8ab8fab81781665fd38299645dc74a6d5ddd2", "url": "https://api.github.com/repos/rust-lang/rust/commits/7da8ab8fab81781665fd38299645dc74a6d5ddd2", "html_url": "https://github.com/rust-lang/rust/commit/7da8ab8fab81781665fd38299645dc74a6d5ddd2"}], "stats": {"total": 58, "additions": 34, "deletions": 24}, "files": [{"sha": "6e53ef850a0297ce40920312c694fe3fce67a7b2", "filename": "src/rt/arch/i386/morestack.S", "status": "modified", "additions": 3, "deletions": 13, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/471b4d6e58baba9ee880c8c8f4183bcf363708cf/src%2Frt%2Farch%2Fi386%2Fmorestack.S", "raw_url": "https://github.com/rust-lang/rust/raw/471b4d6e58baba9ee880c8c8f4183bcf363708cf/src%2Frt%2Farch%2Fi386%2Fmorestack.S", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Farch%2Fi386%2Fmorestack.S?ref=471b4d6e58baba9ee880c8c8f4183bcf363708cf", "patch": "@@ -53,8 +53,8 @@ MORESTACK:\n \n \tpushl %ebp\n #if defined(__linux__) || defined(__APPLE__)\n-\t.cfi_def_cfa_offset 8\n-\t.cfi_offset %ebp, -8\n+\t.cfi_def_cfa_offset 20\n+\t.cfi_offset %ebp, -20\n #endif\n \tmovl %esp, %ebp\n #if defined(__linux__) || defined(__APPLE__)\n@@ -79,16 +79,6 @@ MORESTACK:\n \ttestl %eax,%eax\n \tjz .L$bail\n \n-\t// During unwinding we want to skip our caller.\n-#if defined(__linux__) || defined(__APPLE__)\n-\t// Don't understand this line. I think it means that\n-\t// the next frame's pc is the return address of our caller.\n-\t.cfi_offset 8, 8\n-\t// The next frame's esp is stored at our CFA - 12\n-\t// (by the code below)\n-\t.cfi_offset %esp, -12\n-#endif\n-\n \t// Save the the correct %esp value for our grandparent frame,\n \t// for the unwinder\n \tleal 20(%ebp), %eax\n@@ -156,7 +146,7 @@ MORESTACK:\n \tpopl %ebp\n #if defined(__linux__) || defined(__APPLE__)\n \t.cfi_restore %ebp\n-\t.cfi_def_cfa %esp, 4\n+\t.cfi_def_cfa %esp, 16\n #endif\n \tretl $8\n "}, {"sha": "5378a1dcc60fcef095aceab6aa5438e6c90c1c26", "filename": "src/rt/arch/x86_64/morestack.S", "status": "modified", "additions": 3, "deletions": 11, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/471b4d6e58baba9ee880c8c8f4183bcf363708cf/src%2Frt%2Farch%2Fx86_64%2Fmorestack.S", "raw_url": "https://github.com/rust-lang/rust/raw/471b4d6e58baba9ee880c8c8f4183bcf363708cf/src%2Frt%2Farch%2Fx86_64%2Fmorestack.S", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Farch%2Fx86_64%2Fmorestack.S?ref=471b4d6e58baba9ee880c8c8f4183bcf363708cf", "patch": "@@ -54,19 +54,11 @@ MORESTACK:\n \t\n \t// Set up a normal backtrace\n \tpushq %rbp\n-\t.cfi_def_cfa_offset 16\n-\t.cfi_offset %rbp, -16\n+\t.cfi_def_cfa_offset 24\n+\t.cfi_offset %rbp, -24\n \tmovq %rsp, %rbp\n \t.cfi_def_cfa_register %rbp\n \n-\t// During unwinding we want to skip our caller since it's not\n-\t// a complete frame and will make the unwinder sad\n-\t// Don't understand this line\n-\t.cfi_offset 16, 0\n-\t// Tell the unwinding where to get the stack pointer for\n-\t// our grandparent frame\n-\t.cfi_offset %rsp, -24\n-\n \t// Save the grandparent stack pointer for the unwinder\n \tleaq 24(%rbp), %rax\n \tpushq %rax\n@@ -140,7 +132,7 @@ MORESTACK:\n \taddq $8, %rsp\n \tpopq %rbp\n \t.cfi_restore %rbp\n-\t.cfi_def_cfa %rsp, 8\n+\t.cfi_def_cfa %rsp, 16\n \tret\n \t\n \t.cfi_endproc"}, {"sha": "87c5ac570ea83a23ca246c0cc37acd739e79c61f", "filename": "src/test/run-fail/morestack4.rs", "status": "added", "additions": 28, "deletions": 0, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/471b4d6e58baba9ee880c8c8f4183bcf363708cf/src%2Ftest%2Frun-fail%2Fmorestack4.rs", "raw_url": "https://github.com/rust-lang/rust/raw/471b4d6e58baba9ee880c8c8f4183bcf363708cf/src%2Ftest%2Frun-fail%2Fmorestack4.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-fail%2Fmorestack4.rs?ref=471b4d6e58baba9ee880c8c8f4183bcf363708cf", "patch": "@@ -0,0 +1,28 @@\n+// xfail-test\n+// error-pattern:explicit failure\n+// compile-flags:--stack-growth\n+\n+// Just testing unwinding\n+\n+use std;\n+\n+native mod rustrt {\n+    fn set_min_stack(size: uint);\n+}\n+\n+fn getbig_and_fail(&&i: int) {\n+    let r = and_then_get_big_again(@0);\n+    if i != 0 {\n+        getbig_and_fail(i - 1);\n+    } else {\n+        fail;\n+    }\n+}\n+\n+resource and_then_get_big_again(_i: @int) {\n+}\n+\n+fn main() {\n+    rustrt::set_min_stack(256u);\n+    task::spawn(1, getbig_and_fail);\n+}\n\\ No newline at end of file"}]}