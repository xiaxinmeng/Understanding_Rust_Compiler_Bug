{"sha": "065d3987012b138b123f0544de193f8bb560b1b5", "node_id": "MDY6Q29tbWl0NzI0NzEyOjA2NWQzOTg3MDEyYjEzOGIxMjNmMDU0NGRlMTkzZjhiYjU2MGIxYjU=", "commit": {"author": {"name": "Florian Diebold", "email": "flodiebold@gmail.com", "date": "2019-07-06T14:41:04Z"}, "committer": {"name": "Florian Diebold", "email": "flodiebold@gmail.com", "date": "2019-07-06T15:34:05Z"}, "message": "Add trait obligations for where clauses when calling functions/methods\n\nE.g. if we call `foo<T: Into<u32>>(x)`, that adds an obligation that `x:\nInto<u32>`, etc.", "tree": {"sha": "029ff3c3a9beb816c3056cd38595e15f3c541998", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/029ff3c3a9beb816c3056cd38595e15f3c541998"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/065d3987012b138b123f0544de193f8bb560b1b5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/065d3987012b138b123f0544de193f8bb560b1b5", "html_url": "https://github.com/rust-lang/rust/commit/065d3987012b138b123f0544de193f8bb560b1b5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/065d3987012b138b123f0544de193f8bb560b1b5/comments", "author": {"login": "flodiebold", "id": 906069, "node_id": "MDQ6VXNlcjkwNjA2OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/906069?v=4", "gravatar_id": "", "url": "https://api.github.com/users/flodiebold", "html_url": "https://github.com/flodiebold", "followers_url": "https://api.github.com/users/flodiebold/followers", "following_url": "https://api.github.com/users/flodiebold/following{/other_user}", "gists_url": "https://api.github.com/users/flodiebold/gists{/gist_id}", "starred_url": "https://api.github.com/users/flodiebold/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/flodiebold/subscriptions", "organizations_url": "https://api.github.com/users/flodiebold/orgs", "repos_url": "https://api.github.com/users/flodiebold/repos", "events_url": "https://api.github.com/users/flodiebold/events{/privacy}", "received_events_url": "https://api.github.com/users/flodiebold/received_events", "type": "User", "site_admin": false}, "committer": {"login": "flodiebold", "id": 906069, "node_id": "MDQ6VXNlcjkwNjA2OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/906069?v=4", "gravatar_id": "", "url": "https://api.github.com/users/flodiebold", "html_url": "https://github.com/flodiebold", "followers_url": "https://api.github.com/users/flodiebold/followers", "following_url": "https://api.github.com/users/flodiebold/following{/other_user}", "gists_url": "https://api.github.com/users/flodiebold/gists{/gist_id}", "starred_url": "https://api.github.com/users/flodiebold/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/flodiebold/subscriptions", "organizations_url": "https://api.github.com/users/flodiebold/orgs", "repos_url": "https://api.github.com/users/flodiebold/repos", "events_url": "https://api.github.com/users/flodiebold/events{/privacy}", "received_events_url": "https://api.github.com/users/flodiebold/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "219e0e8c8d6672feaab2f19b7c3280d5967360e4", "url": "https://api.github.com/repos/rust-lang/rust/commits/219e0e8c8d6672feaab2f19b7c3280d5967360e4", "html_url": "https://github.com/rust-lang/rust/commit/219e0e8c8d6672feaab2f19b7c3280d5967360e4"}], "stats": {"total": 190, "additions": 156, "deletions": 34}, "files": [{"sha": "0e6e3fdb734bd3fbd4eafafbbcd164096f1aa65f", "filename": "crates/ra_hir/src/db.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/065d3987012b138b123f0544de193f8bb560b1b5/crates%2Fra_hir%2Fsrc%2Fdb.rs", "raw_url": "https://github.com/rust-lang/rust/raw/065d3987012b138b123f0544de193f8bb560b1b5/crates%2Fra_hir%2Fsrc%2Fdb.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fdb.rs?ref=065d3987012b138b123f0544de193f8bb560b1b5", "patch": "@@ -163,10 +163,10 @@ pub trait HirDatabase: DefDatabase + AstDatabase {\n     #[salsa::invoke(crate::ty::callable_item_sig)]\n     fn callable_item_signature(&self, def: CallableDef) -> FnSig;\n \n-    #[salsa::invoke(crate::ty::generic_predicates)]\n+    #[salsa::invoke(crate::ty::generic_predicates_query)]\n     fn generic_predicates(&self, def: GenericDef) -> Arc<[GenericPredicate]>;\n \n-    #[salsa::invoke(crate::ty::generic_defaults)]\n+    #[salsa::invoke(crate::ty::generic_defaults_query)]\n     fn generic_defaults(&self, def: GenericDef) -> Substs;\n \n     #[salsa::invoke(crate::expr::body_with_source_map_query)]"}, {"sha": "e2a7639b02da55e9b45f8ba6792a9d8e99226abb", "filename": "crates/ra_hir/src/resolve.rs", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/065d3987012b138b123f0544de193f8bb560b1b5/crates%2Fra_hir%2Fsrc%2Fresolve.rs", "raw_url": "https://github.com/rust-lang/rust/raw/065d3987012b138b123f0544de193f8bb560b1b5/crates%2Fra_hir%2Fsrc%2Fresolve.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fresolve.rs?ref=065d3987012b138b123f0544de193f8bb560b1b5", "patch": "@@ -221,6 +221,18 @@ impl Resolver {\n     pub(crate) fn krate(&self) -> Option<Crate> {\n         self.module().map(|t| t.0.krate())\n     }\n+\n+    pub(crate) fn where_predicates_in_scope<'a>(\n+        &'a self,\n+    ) -> impl Iterator<Item = &'a crate::generics::WherePredicate> + 'a {\n+        self.scopes\n+            .iter()\n+            .filter_map(|scope| match scope {\n+                Scope::GenericParams(params) => Some(params),\n+                _ => None,\n+            })\n+            .flat_map(|params| params.where_predicates.iter())\n+    }\n }\n \n impl Resolver {"}, {"sha": "d8c7945e1d46108d152b92f397089fafa0e79286", "filename": "crates/ra_hir/src/ty.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/065d3987012b138b123f0544de193f8bb560b1b5/crates%2Fra_hir%2Fsrc%2Fty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/065d3987012b138b123f0544de193f8bb560b1b5/crates%2Fra_hir%2Fsrc%2Fty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fty.rs?ref=065d3987012b138b123f0544de193f8bb560b1b5", "patch": "@@ -23,8 +23,8 @@ pub(crate) use autoderef::autoderef;\n pub(crate) use infer::{infer_query, InferTy, InferenceResult};\n pub use lower::CallableDef;\n pub(crate) use lower::{\n-    callable_item_sig, generic_defaults, generic_predicates, type_for_def, type_for_field,\n-    TypableDef,\n+    callable_item_sig, generic_defaults_query, generic_predicates_query, type_for_def,\n+    type_for_field, TypableDef,\n };\n pub(crate) use traits::ProjectionPredicate;\n "}, {"sha": "f5d8cd4b156ec8617d5581f4cc44b976cd4b68b9", "filename": "crates/ra_hir/src/ty/infer.rs", "status": "modified", "additions": 13, "deletions": 2, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/065d3987012b138b123f0544de193f8bb560b1b5/crates%2Fra_hir%2Fsrc%2Fty%2Finfer.rs", "raw_url": "https://github.com/rust-lang/rust/raw/065d3987012b138b123f0544de193f8bb560b1b5/crates%2Fra_hir%2Fsrc%2Fty%2Finfer.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fty%2Finfer.rs?ref=065d3987012b138b123f0544de193f8bb560b1b5", "patch": "@@ -849,8 +849,19 @@ impl<'a, D: HirDatabase> InferenceContext<'a, D> {\n     fn register_obligations_for_call(&mut self, callable_ty: &Ty) {\n         if let Ty::Apply(a_ty) = callable_ty {\n             if let TypeCtor::FnDef(def) = a_ty.ctor {\n+                let generic_predicates = self.db.generic_predicates(match def {\n+                    // TODO add helper function\n+                    CallableDef::Function(f) => f.into(),\n+                    CallableDef::Struct(s) => s.into(),\n+                    CallableDef::EnumVariant(_e) => unimplemented!(),\n+                });\n+                for predicate in generic_predicates.iter() {\n+                    let predicate = predicate.clone().subst(&a_ty.parameters);\n+                    if let Some(obligation) = Obligation::from_predicate(predicate) {\n+                        self.obligations.push(obligation);\n+                    }\n+                }\n                 // add obligation for trait implementation, if this is a trait method\n-                // FIXME also register obligations from where clauses from the trait or impl and method\n                 match def {\n                     CallableDef::Function(f) => {\n                         if let Some(trait_) = f.parent_trait(self.db) {\n@@ -992,7 +1003,7 @@ impl<'a, D: HirDatabase> InferenceContext<'a, D> {\n                         (Vec::new(), Ty::Unknown)\n                     }\n                 };\n-                // FIXME register obligations from where clauses from the function\n+                self.register_obligations_for_call(&callee_ty);\n                 let param_iter = param_tys.into_iter().chain(repeat(Ty::Unknown));\n                 for (arg, param) in args.iter().zip(param_iter) {\n                     self.infer_expr(*arg, &Expectation::has_type(param));"}, {"sha": "24755c6aa7e5827663b2e2156b851a212891592b", "filename": "crates/ra_hir/src/ty/lower.rs", "status": "modified", "additions": 4, "deletions": 6, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/065d3987012b138b123f0544de193f8bb560b1b5/crates%2Fra_hir%2Fsrc%2Fty%2Flower.rs", "raw_url": "https://github.com/rust-lang/rust/raw/065d3987012b138b123f0544de193f8bb560b1b5/crates%2Fra_hir%2Fsrc%2Fty%2Flower.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fty%2Flower.rs?ref=065d3987012b138b123f0544de193f8bb560b1b5", "patch": "@@ -318,15 +318,13 @@ pub(crate) fn type_for_field(db: &impl HirDatabase, field: StructField) -> Ty {\n }\n \n /// Resolve the where clause(s) of an item with generics.\n-pub(crate) fn generic_predicates(\n+pub(crate) fn generic_predicates_query(\n     db: &impl HirDatabase,\n     def: GenericDef,\n ) -> Arc<[GenericPredicate]> {\n     let resolver = def.resolver(db);\n-    let generic_params = def.generic_params(db);\n-    let predicates = generic_params\n-        .where_predicates\n-        .iter()\n+    let predicates = resolver\n+        .where_predicates_in_scope()\n         .map(|pred| {\n             TraitRef::for_where_predicate(db, &resolver, pred)\n                 .map_or(GenericPredicate::Error, GenericPredicate::Implemented)\n@@ -336,7 +334,7 @@ pub(crate) fn generic_predicates(\n }\n \n /// Resolve the default type params from generics\n-pub(crate) fn generic_defaults(db: &impl HirDatabase, def: GenericDef) -> Substs {\n+pub(crate) fn generic_defaults_query(db: &impl HirDatabase, def: GenericDef) -> Substs {\n     let resolver = def.resolver(db);\n     let generic_params = def.generic_params(db);\n "}, {"sha": "aacd94a2675080dcda0517e27afdc6358b1787cd", "filename": "crates/ra_hir/src/ty/tests.rs", "status": "modified", "additions": 113, "deletions": 21, "changes": 134, "blob_url": "https://github.com/rust-lang/rust/blob/065d3987012b138b123f0544de193f8bb560b1b5/crates%2Fra_hir%2Fsrc%2Fty%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/065d3987012b138b123f0544de193f8bb560b1b5/crates%2Fra_hir%2Fsrc%2Fty%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fty%2Ftests.rs?ref=065d3987012b138b123f0544de193f8bb560b1b5", "patch": "@@ -2232,16 +2232,18 @@ fn test() {\n }\n \"#),\n         @r###\"\n-[86; 87) 't': T\n-[92; 94) '{}': ()\n-[105; 144) '{     ...(s); }': ()\n-[115; 116) 's': S<{unknown}>\n-[119; 120) 'S': S<{unknown}>(T) -> S<T>\n-[119; 129) 'S(unknown)': S<{unknown}>\n-[121; 128) 'unknown': {unknown}\n-[135; 138) 'foo': fn foo<S<{unknown}>>(T) -> ()\n-[135; 141) 'foo(s)': ()\n-[139; 140) 's': S<{unknown}>\"###\n+   \u22ee\n+   \u22ee[86; 87) 't': T\n+   \u22ee[92; 94) '{}': ()\n+   \u22ee[105; 144) '{     ...(s); }': ()\n+   \u22ee[115; 116) 's': S<u32>\n+   \u22ee[119; 120) 'S': S<u32>(T) -> S<T>\n+   \u22ee[119; 129) 'S(unknown)': S<u32>\n+   \u22ee[121; 128) 'unknown': u32\n+   \u22ee[135; 138) 'foo': fn foo<S<u32>>(T) -> ()\n+   \u22ee[135; 141) 'foo(s)': ()\n+   \u22ee[139; 140) 's': S<u32>\n+    \"###\n     );\n }\n \n@@ -2259,17 +2261,19 @@ fn test() {\n }\n \"#),\n         @r###\"\n-[87; 88) 't': T\n-[98; 100) '{}': ()\n-[111; 163) '{     ...(s); }': ()\n-[121; 122) 's': S<{unknown}>\n-[125; 126) 'S': S<{unknown}>(T) -> S<T>\n-[125; 135) 'S(unknown)': S<{unknown}>\n-[127; 134) 'unknown': {unknown}\n-[145; 146) 'x': u32\n-[154; 157) 'foo': fn foo<u32, S<{unknown}>>(T) -> U\n-[154; 160) 'foo(s)': u32\n-[158; 159) 's': S<{unknown}>\"###\n+   \u22ee\n+   \u22ee[87; 88) 't': T\n+   \u22ee[98; 100) '{}': ()\n+   \u22ee[111; 163) '{     ...(s); }': ()\n+   \u22ee[121; 122) 's': S<u32>\n+   \u22ee[125; 126) 'S': S<u32>(T) -> S<T>\n+   \u22ee[125; 135) 'S(unknown)': S<u32>\n+   \u22ee[127; 134) 'unknown': u32\n+   \u22ee[145; 146) 'x': u32\n+   \u22ee[154; 157) 'foo': fn foo<u32, S<u32>>(T) -> U\n+   \u22ee[154; 160) 'foo(s)': u32\n+   \u22ee[158; 159) 's': S<u32>\n+    \"###\n     );\n }\n \n@@ -2822,6 +2826,94 @@ fn test(s: S) {\n     assert_eq!(t, \"{unknown}\");\n }\n \n+#[test]\n+fn obligation_from_function_clause() {\n+    let t = type_at(\n+        r#\"\n+//- /main.rs\n+struct S;\n+\n+trait Trait<T> {}\n+impl Trait<u32> for S {}\n+\n+fn foo<T: Trait<U>, U>(t: T) -> U {}\n+\n+fn test(s: S) {\n+    foo(s)<|>;\n+}\n+\"#,\n+    );\n+    assert_eq!(t, \"u32\");\n+}\n+\n+#[test]\n+fn obligation_from_method_clause() {\n+    let t = type_at(\n+        r#\"\n+//- /main.rs\n+struct S;\n+\n+trait Trait<T> {}\n+impl Trait<isize> for S {}\n+\n+struct O;\n+impl O {\n+    fn foo<T: Trait<U>, U>(&self, t: T) -> U {}\n+}\n+\n+fn test() {\n+    O.foo(S)<|>;\n+}\n+\"#,\n+    );\n+    assert_eq!(t, \"isize\");\n+}\n+\n+#[test]\n+fn obligation_from_self_method_clause() {\n+    let t = type_at(\n+        r#\"\n+//- /main.rs\n+struct S;\n+\n+trait Trait<T> {}\n+impl Trait<i64> for S {}\n+\n+impl S {\n+    fn foo<U>(&self) -> U where Self: Trait<U> {}\n+}\n+\n+fn test() {\n+    S.foo()<|>;\n+}\n+\"#,\n+    );\n+    assert_eq!(t, \"i64\");\n+}\n+\n+#[test]\n+fn obligation_from_impl_clause() {\n+    let t = type_at(\n+        r#\"\n+//- /main.rs\n+struct S;\n+\n+trait Trait<T> {}\n+impl Trait<&str> for S {}\n+\n+struct O<T>;\n+impl<U, T: Trait<U>> O<T> {\n+    fn foo(&self) -> U {}\n+}\n+\n+fn test(o: O<S>) {\n+    o.foo()<|>;\n+}\n+\"#,\n+    );\n+    assert_eq!(t, \"&str\");\n+}\n+\n fn type_at_pos(db: &MockDatabase, pos: FilePosition) -> String {\n     let file = db.parse(pos.file_id).ok().unwrap();\n     let expr = algo::find_node_at_offset::<ast::Expr>(file.syntax(), pos.offset).unwrap();"}, {"sha": "23a26a9718832bc06f17128f885d6636d343dcb2", "filename": "crates/ra_hir/src/ty/traits.rs", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/065d3987012b138b123f0544de193f8bb560b1b5/crates%2Fra_hir%2Fsrc%2Fty%2Ftraits.rs", "raw_url": "https://github.com/rust-lang/rust/raw/065d3987012b138b123f0544de193f8bb560b1b5/crates%2Fra_hir%2Fsrc%2Fty%2Ftraits.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fty%2Ftraits.rs?ref=065d3987012b138b123f0544de193f8bb560b1b5", "patch": "@@ -7,7 +7,7 @@ use parking_lot::Mutex;\n use ra_prof::profile;\n use rustc_hash::FxHashSet;\n \n-use super::{Canonical, ProjectionTy, TraitRef, Ty};\n+use super::{Canonical, GenericPredicate, ProjectionTy, TraitRef, Ty};\n use crate::{db::HirDatabase, Crate, ImplBlock, Trait};\n \n use self::chalk::{from_chalk, ToChalk};\n@@ -78,6 +78,15 @@ pub enum Obligation {\n     // Projection(ProjectionPredicate),\n }\n \n+impl Obligation {\n+    pub fn from_predicate(predicate: GenericPredicate) -> Option<Obligation> {\n+        match predicate {\n+            GenericPredicate::Implemented(trait_ref) => Some(Obligation::Trait(trait_ref)),\n+            GenericPredicate::Error => None,\n+        }\n+    }\n+}\n+\n #[derive(Clone, Debug, PartialEq, Eq, Hash)]\n pub struct ProjectionPredicate {\n     pub projection_ty: ProjectionTy,"}]}