{"sha": "12b269663485955176613a8f2e3f101793f65fda", "node_id": "MDY6Q29tbWl0NzI0NzEyOjEyYjI2OTY2MzQ4NTk1NTE3NjYxM2E4ZjJlM2YxMDE3OTNmNjVmZGE=", "commit": {"author": {"name": "Philipp Hansch", "email": "dev@phansch.net", "date": "2019-02-26T19:55:17Z"}, "committer": {"name": "Philipp Hansch", "email": "dev@phansch.net", "date": "2019-03-03T14:03:25Z"}, "message": "Add lint writing documentation\n\nThis adds a new documentation page that explains how to write Clippy\nlints. It guides the reader through creating a `foo` function lint.", "tree": {"sha": "0656795c3a014392be4f71fd266323bd69deaf15", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0656795c3a014392be4f71fd266323bd69deaf15"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/12b269663485955176613a8f2e3f101793f65fda", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEvUKv4zqIn2RHUgCKtvoGpuDiZlsFAlx73q0ACgkQtvoGpuDi\nZlulMRAAq4dUJN9LLpUlGRHBABXBTkGwebAzS1UcmlnCtlqneIYDersScCGn8laG\nuNFDSkc14ACrvU80SZk3840VKIYiZYYCy+/QDTchGGrg4vAn4KNM+F3no2VzFy/W\nRyeOolKJnz+MW8nAmFfbfRKAhaInH20u7oHOQ1gpyV/yRNX+bdqbd/J0IZ8sx0Os\n490jK5X9OsD/NLvdec5WM7dsOVGLObuOH5AFYLZdZwj4Ct9DazeuN9Uy/RRXiZ1a\nUOYrJCXimhMdxi3FELA5iwW/knknT2iIjMNE5yIIgeRFeeGoARpnrDVcOot6LQw0\nMTjNuC5ytuYAuZFKaLjoQyFlIsaSjA2pBDNR9qf6T+Eh2DHRLHaqmPV+kVlwm556\noWYJEVZoFbV4yuAEHoiQBL6Xc62M1k93XCnnh17fEHF+W4ezV4jLCcPDN57N26dM\nhaMysz9EFK6otK27Tjc93Q4Kn0q3f9ki4bfdtH5L2967rxAR6JnjkhjToRhBCNkl\nnd0nSiG/TsncaijhtE6c1KmnjzRFZbNOLhxVMK1w8pz3BcH6/w0QGyfWmVX+WCQP\nVWWhlKw71zv8r2V0qrkTotQ2YmLcM2IMO+Wvf5/Z9jIUWzncKre3hVS6BYQxYJx7\nNGSHLSbeJck/W6w1ClgVK52uAO3qeFD97fe3cAys/Eyrbn0kMNM=\n=61a4\n-----END PGP SIGNATURE-----", "payload": "tree 0656795c3a014392be4f71fd266323bd69deaf15\nparent 9d1792a4265c3645d716c5bf085c07be8749332a\nauthor Philipp Hansch <dev@phansch.net> 1551210917 +0100\ncommitter Philipp Hansch <dev@phansch.net> 1551621805 +0100\n\nAdd lint writing documentation\n\nThis adds a new documentation page that explains how to write Clippy\nlints. It guides the reader through creating a `foo` function lint.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/12b269663485955176613a8f2e3f101793f65fda", "html_url": "https://github.com/rust-lang/rust/commit/12b269663485955176613a8f2e3f101793f65fda", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/12b269663485955176613a8f2e3f101793f65fda/comments", "author": {"login": "phansch", "id": 2042399, "node_id": "MDQ6VXNlcjIwNDIzOTk=", "avatar_url": "https://avatars.githubusercontent.com/u/2042399?v=4", "gravatar_id": "", "url": "https://api.github.com/users/phansch", "html_url": "https://github.com/phansch", "followers_url": "https://api.github.com/users/phansch/followers", "following_url": "https://api.github.com/users/phansch/following{/other_user}", "gists_url": "https://api.github.com/users/phansch/gists{/gist_id}", "starred_url": "https://api.github.com/users/phansch/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/phansch/subscriptions", "organizations_url": "https://api.github.com/users/phansch/orgs", "repos_url": "https://api.github.com/users/phansch/repos", "events_url": "https://api.github.com/users/phansch/events{/privacy}", "received_events_url": "https://api.github.com/users/phansch/received_events", "type": "User", "site_admin": false}, "committer": {"login": "phansch", "id": 2042399, "node_id": "MDQ6VXNlcjIwNDIzOTk=", "avatar_url": "https://avatars.githubusercontent.com/u/2042399?v=4", "gravatar_id": "", "url": "https://api.github.com/users/phansch", "html_url": "https://github.com/phansch", "followers_url": "https://api.github.com/users/phansch/followers", "following_url": "https://api.github.com/users/phansch/following{/other_user}", "gists_url": "https://api.github.com/users/phansch/gists{/gist_id}", "starred_url": "https://api.github.com/users/phansch/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/phansch/subscriptions", "organizations_url": "https://api.github.com/users/phansch/orgs", "repos_url": "https://api.github.com/users/phansch/repos", "events_url": "https://api.github.com/users/phansch/events{/privacy}", "received_events_url": "https://api.github.com/users/phansch/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9d1792a4265c3645d716c5bf085c07be8749332a", "url": "https://api.github.com/repos/rust-lang/rust/commits/9d1792a4265c3645d716c5bf085c07be8749332a", "html_url": "https://github.com/rust-lang/rust/commit/9d1792a4265c3645d716c5bf085c07be8749332a"}], "stats": {"total": 324, "additions": 324, "deletions": 0}, "files": [{"sha": "365564ef25d62b20803af53a88dd03a5a753834b", "filename": "doc/adding_lints.md", "status": "added", "additions": 324, "deletions": 0, "changes": 324, "blob_url": "https://github.com/rust-lang/rust/blob/12b269663485955176613a8f2e3f101793f65fda/doc%2Fadding_lints.md", "raw_url": "https://github.com/rust-lang/rust/raw/12b269663485955176613a8f2e3f101793f65fda/doc%2Fadding_lints.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/doc%2Fadding_lints.md?ref=12b269663485955176613a8f2e3f101793f65fda", "patch": "@@ -0,0 +1,324 @@\n+## Adding a new lint\n+\n+You are probably here because you want to add a new lint to Clippy. If this is\n+the first time you're contributing to Clippy, this document guides you through\n+creating an example lint from scratch.\n+\n+To get started, we will create a lint that detects functions called `foo`,\n+because that's clearly a non-descriptive name.\n+\n+* [Testing](#Testing)\n+* [Lint declaration](#Lint-declaration)\n+* [Lint passes](#Lint-passes)\n+* [Emitting a lint](#Emitting-a-lint)\n+* [Adding the lint logic](#Adding-the-lint-logic)\n+* [Documentation](#Documentation)\n+* [Debugging](#Debugging)\n+* [PR Checklist](#PR-Checklist)\n+* [Cheatsheet](#Cheatsheet)\n+\n+### Testing\n+\n+Let's write some tests first that we can execute while we iterate on our lint.\n+\n+Clippy uses UI tests for testing. UI tests check that the output of Clippy is\n+exactly as expected. Each test is just a plain Rust file that contains the code\n+we want to check. The output of Clippy is compared against a `.stderr` file.\n+\n+Let's create the test file at `tests/ui/foo_functions.rs`. It doesn't really\n+matter what the file is called, but it's a good convention to name it after the\n+lint it is testing, so `foo_functions.rs` it is.\n+\n+Inside we put some examples to get started:\n+\n+```rust\n+#![warn(clippy::foo_functions)]\n+\n+// Impl methods\n+struct A;\n+impl A {\n+    pub fn fo(&self) {}\n+    pub fn foo(&self) {}\n+    pub fn food(&self) {}\n+}\n+\n+// Default trait methods\n+trait B {\n+    pub fn fo(&self) {}\n+    pub fn foo(&self) {}\n+    pub fn food(&self) {}\n+}\n+\n+// Plain functions\n+fn fo() {}\n+fn foo() {}\n+fn food() {}\n+\n+fn main() {\n+    // We also don't want to lint method calls\n+    foo();\n+    let a = A;\n+    a.foo();\n+}\n+\n+```\n+\n+Now we can run the test with `TESTNAME=ui/foo_functions cargo uitest`.\n+Currently this test will fail. If you go through the output you will see that we\n+have to add some missing imports to our lint file.\n+\n+While you are working on implementing your lint, you can keep running the UI\n+test. That allows you to check if the output is turning into what you want.\n+\n+Once you are satisfied with the output, you need to run\n+`tests/ui/update-all-references.sh` to update the `stderr` file for your lint.\n+Running `TESTNAME=ui/foo_functions cargo uitest` should pass then. When you\n+commit your lint, be sure to commit the `*.stderr` files, too.\n+\n+Let's have a look at implementing our lint now.\n+\n+### Lint declaration\n+\n+We start by creating a new file in the `clippy_lints` crate. That's the crate\n+where all the lint code is. We are going to call the file\n+`clippy_lints/src/foo_functions.rs` and import some initial things we need:\n+\n+```rust\n+use rustc::lint::{LintArray, LintPass};\n+use rustc::{declare_tool_lint, lint_array};\n+```\n+\n+The next step is to provide a lint declaration. Lints are declared using the [`declare_clippy_lint!`][declare_clippy_lint] macro:\n+\n+```rust\n+declare_clippy_lint! {\n+    pub FOO_FUNCTIONS,\n+    pedantic,\n+    \"function named `foo`, which is not a descriptive name\"\n+}\n+```\n+\n+* `FOO_FUNCTIONS` is the name of our lint. Be sure to follow the [lint naming\n+guidelines][lint_naming] here when naming your lint. In short, the name should\n+state the thing that is being checked for and read well when used with\n+`allow`/`warn`/`deny`.\n+* `pedantic` sets the lint level to `Allow`.\n+  The exact mapping can be found [here][category_level_mapping]\n+* The last part should be a text that explains what exactly is wrong with the\n+  code\n+\n+With our lint declaration done, we will now make sure that our lint declaration is assigned to a lint pass:\n+\n+```rust\n+// clippy_lints/src/foo_functions.rs\n+\n+// .. imports and lint declaration ..\n+\n+#[derive(Copy, Clone)]\n+pub struct FooFunctionsPass;\n+\n+impl LintPass for FooFunctionsPass {\n+    fn get_lints(&self) -> LintArray {\n+        lint_array!(\n+            FOO_FUNCTIONS,\n+        )\n+    }\n+\n+    fn name(&self) -> &'static str {\n+        \"FooFunctions\"\n+    }\n+}\n+```\n+\n+Don't worry about the `name` method here. As long as it includes the name of the lint pass it should be fine.\n+\n+Next you should run `util/dev update_lints` to register the lint in various\n+places, mainly in `clippy_lints/src/lib.rs`.\n+\n+While `update_lints` automates some things, it doesn't automate everything. We will have to register our lint pass manually in the `register_plugins` function in `clippy_lints/src/lib.rs`:\n+\n+```rust\n+reg.register_early_lint_pass(box foo_functions::FooFunctionsPass);\n+```\n+\n+Without that, running the UI tests would produce an error like `unknown clippy lint: clippy::foo_functions`.\n+The next decision we have to make is which lint pass our lint is going to need.\n+\n+### Lint passes\n+\n+Writing a lint that just checks for the name of a function means that we just\n+have to deal with the AST and don't have to deal with the type system at all.\n+This is good, because it makes writing this particular lint less complicated.\n+\n+We have to make this decision with every new Clippy lint. It boils down to using either `EarlyLintPass` or `LateLintPass`. This is a result of Rust's compilation process. You can read more about it [in the rustc guide][compilation_stages].\n+\n+In short, the `LateLintPass` has access to type information while the `EarlyLintPass` doesn't. If you don't need access to type information, use the `EarlyLintPass`. The `EarlyLintPass` is also faster. However linting speed hasn't really been a concern with Clippy so far.\n+\n+Since we don't need type information for checking the function name, we are going to use the `EarlyLintPass`. It has to be imported as well, changing our imports to:\n+\n+```rust\n+use rustc::lint::{LintArray, LintPass, EarlyLintPass, EarlyContext};\n+use rustc::{declare_tool_lint, lint_array};\n+```\n+\n+### Emitting a lint\n+\n+With UI tests in place, we can start working on the implementation of the lint logic. We can keep executing the tests until we make them pass.\n+\n+Let's start by emitting a lint for every function definition.\n+\n+```rust\n+impl EarlyLintPass for Pass {\n+    fn check_fn(&mut self, cx: &EarlyContext<'_>, fn_kind: FnKind<'_>, _: &FnDecl, span: Span, _: NodeId) {\n+        // TODO: Emit lint here\n+    }\n+}\n+```\n+\n+We implement the [`check_fn`][check_fn] method from the [`EarlyLintPass`][early_lint_pass] trait. This gives us access to various information about the function that is currently being checked. More on that in the next section. Let's worry about the details later and emit our lint for *every* function definition first.\n+\n+Depending on how complex we want our lint message to be, we can choose from a variety of lint emission functions.\n+They can all be found in  [`clippy_lints/src/utils/diagnostics.rs`][diagnostics].\n+\n+\n+```rust\n+impl EarlyLintPass for Pass {\n+    fn check_fn(&mut self, cx: &EarlyContext<'_>, _: FnKind<'_>, _: &FnDecl, span: Span, _: NodeId) {\n+        span_help_and_lint(\n+            cx,\n+            FOO_FUNCTIONS,\n+            span,\n+            \"function named `foo`\",\n+            \"consider using a more meaningful name\"\n+        );\n+    }\n+}\n+```\n+\n+### Adding the lint logic\n+\n+Writing the logic for your lint will most likely be different from this example,\n+so this section is kept rather short.\n+\n+Using the [`check_fn`][check_fn] method gives us access to [`FnKind`][fn_kind]\n+that has two relevant variants for us `FnKind::ItemFn` and `FnKind::Method`.\n+Both provide access to the name of the function/method via an [`Ident`][ident].\n+and delegate our check to it's own function, passing through only the data we\n+need.\n+\n+In our example, the implementation would look like:\n+\n+```rust\n+fn is_foo_fn(fn_kind: FnKind<'_>) -> bool {\n+    match fn_kind {\n+        FnKind::ItemFn(ident, ..) | FnKind::Method(ident, ..) => {\n+            return ident.name == \"foo\"\n+        },\n+        FnKind::Closure(..) => return false\n+    }\n+}\n+```\n+\n+\n+Now you'll want to also run the full test suite with `cargo test`. Apart from\n+running all other UI tests, this ensures that our lint implementation is not\n+violating any Clippy lints itself. If you are still following the example,\n+you'll see that the `FooFunctionsPass` violates a Clippy lint. So we are going\n+to rename that struct to just `Pass`:\n+\n+```rust\n+#[derive(Copy, Clone)]\n+pub struct Pass;\n+\n+impl LintPass for Pass { /* .. */ }\n+```\n+\n+\n+### Documentation\n+\n+The final thing before submitting our PR is to add some documentation to our\n+lint declaration.\n+\n+Please document your lint with a doc comment akin to the following:\n+\n+```rust\n+/// **What it does:** Checks for ... (describe what the lint matches).\n+///\n+/// **Why is this bad?** Supply the reason for linting the code.\n+///\n+/// **Known problems:** None. (Or describe where it could go wrong.)\n+///\n+/// **Example:**\n+///\n+/// ```rust,ignore\n+/// // Bad\n+/// Insert a short example of code that triggers the lint\n+///\n+/// // Good\n+/// Insert a short example of improved code that doesnt trigger the lint\n+/// ```\n+declare_clippy_lint! // ...\n+```\n+\n+Once your lint is merged, this documentation will show up in the [lint\n+list][lint_list].\n+\n+### Debugging\n+\n+If you want to debug parts of your lint implementation, you can use the `dbg!`\n+macro anywhere in your code. Running the tests should then include the debug\n+output in the `stdout` part.\n+\n+### PR Checklist\n+\n+TODO: Prose\n+\n+- [ ] Followed [lint naming conventions][lint_naming]\n+- [ ] Added passing UI tests (including committed `.stderr` file)\n+- [ ] `cargo test` passes locally\n+- [ ] Added lint documentation\n+\n+### Cheatsheet\n+\n+Here are some pointers to things you are likely going to need for every lint:\n+\n+* [The `if_chain` macro][if_chain]\n+* [`in_macro`][in_macro] and [`in_external_macro`][in_external_macro]\n+* [`Span`][span]\n+* [Clippy diagnostics][diagnostics]\n+* [`Applicability`][applicability]\n+\n+For `EarlyLintPass` lints:\n+\n+* [`EarlyLintPass`][early_lint_pass]\n+* [`syntax::ast`][ast]\n+\n+For `LateLintPass` lints:\n+\n+* [`LateLintPass`][late_lint_pass]\n+* [`Ty::TyKind`][ty]\n+\n+\n+While most of Clippy's lint utils are documented, most of rustc's internals lack\n+documentation currently. This is unfortunate, but in most cases you can probably\n+get away with copying things from existing similar lints. If you are stuck,\n+don't hesitate to ask on Discord, IRC or in the issue/PR.\n+\n+[lint_list]: https://rust-lang.github.io/rust-clippy/master/index.html\n+[lint_naming]: https://rust-lang.github.io/rfcs/0344-conventions-galore.html#lints\n+[category_level_mapping]: https://github.com/rust-lang/rust-clippy/blob/bd23cb89ec0ea63403a17d3fc5e50c88e38dd54f/clippy_lints/src/lib.rs#L43\n+[declare_clippy_lint]: https://github.com/rust-lang/rust-clippy/blob/a71acac1da7eaf667ab90a1d65d10e5cc4b80191/clippy_lints/src/lib.rs#L39\n+[compilation_stages]: https://rust-lang.github.io/rustc-guide/high-level-overview.html#the-main-stages-of-compilation\n+[check_fn]: https://doc.rust-lang.org/nightly/nightly-rustc/rustc/lint/trait.EarlyLintPass.html#method.check_fn\n+[early_lint_pass]: https://doc.rust-lang.org/nightly/nightly-rustc/rustc/lint/trait.EarlyLintPass.html\n+[late_lint_pass]: https://doc.rust-lang.org/nightly/nightly-rustc/rustc/lint/trait.LateLintPass.html\n+[fn_kind]: https://doc.rust-lang.org/nightly/nightly-rustc/syntax/visit/enum.FnKind.html\n+[diagnostics]: https://github.com/rust-lang/rust-clippy/blob/master/clippy_lints/src/utils/diagnostics.rs\n+[ident]: https://doc.rust-lang.org/nightly/nightly-rustc/syntax/source_map/symbol/struct.Ident.html\n+[span]: https://doc.rust-lang.org/nightly/nightly-rustc/syntax_pos/struct.Span.html\n+[applicability]: https://doc.rust-lang.org/nightly/nightly-rustc/rustc_errors/enum.Applicability.html\n+[if_chain]: https://docs.rs/if_chain/0.1.2/if_chain/\n+[ty]: https://doc.rust-lang.org/nightly/nightly-rustc/rustc/ty/sty/index.html\n+[ast]: https://doc.rust-lang.org/nightly/nightly-rustc/syntax/ast/index.html\n+[in_macro]: https://github.com/rust-lang/rust-clippy/blob/d0717d1f9531a03d154aaeb0cad94c243915a146/clippy_lints/src/utils/mod.rs#L94\n+[in_external_macro]: https://doc.rust-lang.org/nightly/nightly-rustc/rustc/lint/fn.in_external_macro.html"}]}