{"sha": "182ac89f16ff2594eaa1e3e899fa4d228a3539c3", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE4MmFjODlmMTZmZjI1OTRlYWExZTNlODk5ZmE0ZDIyOGEzNTM5YzM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-05-26T06:23:58Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-05-26T06:23:58Z"}, "message": "Auto merge of #5636 - ebroto:issue_5041, r=phansch\n\nmultiple_crate_versions: skip dev and build deps\n\nchangelog: multiple_crate_versions: skip dev and build deps\n\nCloses #5041", "tree": {"sha": "fcaeb6081e441c8f4e5ff9549a83a772ffd78605", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fcaeb6081e441c8f4e5ff9549a83a772ffd78605"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/182ac89f16ff2594eaa1e3e899fa4d228a3539c3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/182ac89f16ff2594eaa1e3e899fa4d228a3539c3", "html_url": "https://github.com/rust-lang/rust/commit/182ac89f16ff2594eaa1e3e899fa4d228a3539c3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/182ac89f16ff2594eaa1e3e899fa4d228a3539c3/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2a6cfa7f0537e9437de8ccd3781fb44645af6082", "url": "https://api.github.com/repos/rust-lang/rust/commits/2a6cfa7f0537e9437de8ccd3781fb44645af6082", "html_url": "https://github.com/rust-lang/rust/commit/2a6cfa7f0537e9437de8ccd3781fb44645af6082"}, {"sha": "ec0a00e53980619a6313ff4f01099a1aebcfd9e6", "url": "https://api.github.com/repos/rust-lang/rust/commits/ec0a00e53980619a6313ff4f01099a1aebcfd9e6", "html_url": "https://github.com/rust-lang/rust/commit/ec0a00e53980619a6313ff4f01099a1aebcfd9e6"}], "stats": {"total": 104, "additions": 85, "deletions": 19}, "files": [{"sha": "c0b2dac2f60ff0105364e0c371b54d6bfb244869", "filename": "clippy_dev/src/new_lint.rs", "status": "modified", "additions": 12, "deletions": 5, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/182ac89f16ff2594eaa1e3e899fa4d228a3539c3/clippy_dev%2Fsrc%2Fnew_lint.rs", "raw_url": "https://github.com/rust-lang/rust/raw/182ac89f16ff2594eaa1e3e899fa4d228a3539c3/clippy_dev%2Fsrc%2Fnew_lint.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_dev%2Fsrc%2Fnew_lint.rs?ref=182ac89f16ff2594eaa1e3e899fa4d228a3539c3", "patch": "@@ -76,7 +76,8 @@ fn create_test(lint: &LintData) -> io::Result<()> {\n \n         path.push(\"src\");\n         fs::create_dir(&path)?;\n-        write_file(path.join(\"main.rs\"), get_test_file_contents(lint_name))?;\n+        let header = format!(\"// compile-flags: --crate-name={}\", lint_name);\n+        write_file(path.join(\"main.rs\"), get_test_file_contents(lint_name, Some(&header)))?;\n \n         Ok(())\n     }\n@@ -90,7 +91,7 @@ fn create_test(lint: &LintData) -> io::Result<()> {\n         create_project_layout(lint.name, &test_dir, \"pass\", \"This file should not trigger the lint\")\n     } else {\n         let test_path = format!(\"tests/ui/{}.rs\", lint.name);\n-        let test_contents = get_test_file_contents(lint.name);\n+        let test_contents = get_test_file_contents(lint.name, None);\n         write_file(lint.project_root.join(test_path), test_contents)\n     }\n }\n@@ -119,16 +120,22 @@ fn to_camel_case(name: &str) -> String {\n         .collect()\n }\n \n-fn get_test_file_contents(lint_name: &str) -> String {\n-    format!(\n+fn get_test_file_contents(lint_name: &str, header_commands: Option<&str>) -> String {\n+    let mut contents = format!(\n         \"#![warn(clippy::{})]\n \n fn main() {{\n     // test code goes here\n }}\n \",\n         lint_name\n-    )\n+    );\n+\n+    if let Some(header) = header_commands {\n+        contents = format!(\"{}\\n{}\", header, contents);\n+    }\n+\n+    contents\n }\n \n fn get_manifest_contents(lint_name: &str, hint: &str) -> String {"}, {"sha": "b6770804e180118736898314e6f94615d67a93ec", "filename": "clippy_lints/src/multiple_crate_versions.rs", "status": "modified", "additions": 46, "deletions": 14, "changes": 60, "blob_url": "https://github.com/rust-lang/rust/blob/182ac89f16ff2594eaa1e3e899fa4d228a3539c3/clippy_lints%2Fsrc%2Fmultiple_crate_versions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/182ac89f16ff2594eaa1e3e899fa4d228a3539c3/clippy_lints%2Fsrc%2Fmultiple_crate_versions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmultiple_crate_versions.rs?ref=182ac89f16ff2594eaa1e3e899fa4d228a3539c3", "patch": "@@ -1,11 +1,14 @@\n //! lint on multiple versions of a crate being used\n \n use crate::utils::{run_lints, span_lint};\n+use rustc_hir::def_id::LOCAL_CRATE;\n use rustc_hir::{Crate, CRATE_HIR_ID};\n use rustc_lint::{LateContext, LateLintPass};\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n use rustc_span::source_map::DUMMY_SP;\n \n+use cargo_metadata::{DependencyKind, MetadataCommand, Node, Package, PackageId};\n+use if_chain::if_chain;\n use itertools::Itertools;\n \n declare_clippy_lint! {\n@@ -39,32 +42,61 @@ impl LateLintPass<'_, '_> for MultipleCrateVersions {\n             return;\n         }\n \n-        let metadata = if let Ok(metadata) = cargo_metadata::MetadataCommand::new().exec() {\n+        let metadata = if let Ok(metadata) = MetadataCommand::new().exec() {\n             metadata\n         } else {\n             span_lint(cx, MULTIPLE_CRATE_VERSIONS, DUMMY_SP, \"could not read cargo metadata\");\n-\n             return;\n         };\n \n+        let local_name = cx.tcx.crate_name(LOCAL_CRATE).as_str();\n         let mut packages = metadata.packages;\n         packages.sort_by(|a, b| a.name.cmp(&b.name));\n \n-        for (name, group) in &packages.into_iter().group_by(|p| p.name.clone()) {\n-            let group: Vec<cargo_metadata::Package> = group.collect();\n+        if_chain! {\n+            if let Some(resolve) = &metadata.resolve;\n+            if let Some(local_id) = packages\n+                .iter()\n+                .find_map(|p| if p.name == *local_name { Some(&p.id) } else { None });\n+            then {\n+                for (name, group) in &packages.iter().group_by(|p| p.name.clone()) {\n+                    let group: Vec<&Package> = group.collect();\n+\n+                    if group.len() <= 1 {\n+                        continue;\n+                    }\n \n-            if group.len() > 1 {\n-                let mut versions: Vec<_> = group.into_iter().map(|p| p.version).collect();\n-                versions.sort();\n-                let versions = versions.iter().join(\", \");\n+                    if group.iter().all(|p| is_normal_dep(&resolve.nodes, local_id, &p.id)) {\n+                        let mut versions: Vec<_> = group.into_iter().map(|p| &p.version).collect();\n+                        versions.sort();\n+                        let versions = versions.iter().join(\", \");\n \n-                span_lint(\n-                    cx,\n-                    MULTIPLE_CRATE_VERSIONS,\n-                    DUMMY_SP,\n-                    &format!(\"multiple versions for dependency `{}`: {}\", name, versions),\n-                );\n+                        span_lint(\n+                            cx,\n+                            MULTIPLE_CRATE_VERSIONS,\n+                            DUMMY_SP,\n+                            &format!(\"multiple versions for dependency `{}`: {}\", name, versions),\n+                        );\n+                    }\n+                }\n             }\n         }\n     }\n }\n+\n+fn is_normal_dep(nodes: &[Node], local_id: &PackageId, dep_id: &PackageId) -> bool {\n+    fn depends_on(node: &Node, dep_id: &PackageId) -> bool {\n+        node.deps.iter().any(|dep| {\n+            dep.pkg == *dep_id\n+                && dep\n+                    .dep_kinds\n+                    .iter()\n+                    .any(|info| matches!(info.kind, DependencyKind::Normal))\n+        })\n+    }\n+\n+    nodes\n+        .iter()\n+        .filter(|node| depends_on(node, dep_id))\n+        .any(|node| node.id == *local_id || is_normal_dep(nodes, local_id, &node.id))\n+}"}, {"sha": "27841e18aa9ef830cb1daf4080d0acd19a3b3c97", "filename": "tests/ui-cargo/cargo_common_metadata/fail/src/main.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/182ac89f16ff2594eaa1e3e899fa4d228a3539c3/tests%2Fui-cargo%2Fcargo_common_metadata%2Ffail%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/182ac89f16ff2594eaa1e3e899fa4d228a3539c3/tests%2Fui-cargo%2Fcargo_common_metadata%2Ffail%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui-cargo%2Fcargo_common_metadata%2Ffail%2Fsrc%2Fmain.rs?ref=182ac89f16ff2594eaa1e3e899fa4d228a3539c3", "patch": "@@ -1,3 +1,4 @@\n+// compile-flags: --crate-name=cargo_common_metadata\n #![warn(clippy::cargo_common_metadata)]\n \n fn main() {}"}, {"sha": "27841e18aa9ef830cb1daf4080d0acd19a3b3c97", "filename": "tests/ui-cargo/cargo_common_metadata/pass/src/main.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/182ac89f16ff2594eaa1e3e899fa4d228a3539c3/tests%2Fui-cargo%2Fcargo_common_metadata%2Fpass%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/182ac89f16ff2594eaa1e3e899fa4d228a3539c3/tests%2Fui-cargo%2Fcargo_common_metadata%2Fpass%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui-cargo%2Fcargo_common_metadata%2Fpass%2Fsrc%2Fmain.rs?ref=182ac89f16ff2594eaa1e3e899fa4d228a3539c3", "patch": "@@ -1,3 +1,4 @@\n+// compile-flags: --crate-name=cargo_common_metadata\n #![warn(clippy::cargo_common_metadata)]\n \n fn main() {}"}, {"sha": "72731fbc75d00c3e3587bc91de4ffc3d3bd31f23", "filename": "tests/ui-cargo/multiple_crate_versions/5041_allow_dev_build/Cargo.toml", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/182ac89f16ff2594eaa1e3e899fa4d228a3539c3/tests%2Fui-cargo%2Fmultiple_crate_versions%2F5041_allow_dev_build%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/182ac89f16ff2594eaa1e3e899fa4d228a3539c3/tests%2Fui-cargo%2Fmultiple_crate_versions%2F5041_allow_dev_build%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui-cargo%2Fmultiple_crate_versions%2F5041_allow_dev_build%2FCargo.toml?ref=182ac89f16ff2594eaa1e3e899fa4d228a3539c3", "patch": "@@ -0,0 +1,17 @@\n+# Should not lint for dev or build dependencies. See issue 5041.\n+\n+[package]\n+name = \"multiple_crate_versions\"\n+version = \"0.1.0\"\n+publish = false\n+\n+# One of the versions of winapi is only a dev dependency: allowed\n+[dependencies]\n+ctrlc = \"=3.1.0\"\n+[dev-dependencies]\n+ansi_term = \"=0.11.0\"\n+\n+# Both versions of winapi are a build dependency: allowed\n+[build-dependencies]\n+ctrlc = \"=3.1.0\"\n+ansi_term = \"=0.11.0\""}, {"sha": "1b2d3ec9459f9520ec0c8201dad49ac265051fd8", "filename": "tests/ui-cargo/multiple_crate_versions/5041_allow_dev_build/src/main.rs", "status": "added", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/182ac89f16ff2594eaa1e3e899fa4d228a3539c3/tests%2Fui-cargo%2Fmultiple_crate_versions%2F5041_allow_dev_build%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/182ac89f16ff2594eaa1e3e899fa4d228a3539c3/tests%2Fui-cargo%2Fmultiple_crate_versions%2F5041_allow_dev_build%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui-cargo%2Fmultiple_crate_versions%2F5041_allow_dev_build%2Fsrc%2Fmain.rs?ref=182ac89f16ff2594eaa1e3e899fa4d228a3539c3", "patch": "@@ -0,0 +1,4 @@\n+// compile-flags: --crate-name=multiple_crate_versions\n+#![warn(clippy::multiple_crate_versions)]\n+\n+fn main() {}"}, {"sha": "1b2d3ec9459f9520ec0c8201dad49ac265051fd8", "filename": "tests/ui-cargo/multiple_crate_versions/fail/src/main.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/182ac89f16ff2594eaa1e3e899fa4d228a3539c3/tests%2Fui-cargo%2Fmultiple_crate_versions%2Ffail%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/182ac89f16ff2594eaa1e3e899fa4d228a3539c3/tests%2Fui-cargo%2Fmultiple_crate_versions%2Ffail%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui-cargo%2Fmultiple_crate_versions%2Ffail%2Fsrc%2Fmain.rs?ref=182ac89f16ff2594eaa1e3e899fa4d228a3539c3", "patch": "@@ -1,3 +1,4 @@\n+// compile-flags: --crate-name=multiple_crate_versions\n #![warn(clippy::multiple_crate_versions)]\n \n fn main() {}"}, {"sha": "1b2d3ec9459f9520ec0c8201dad49ac265051fd8", "filename": "tests/ui-cargo/multiple_crate_versions/pass/src/main.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/182ac89f16ff2594eaa1e3e899fa4d228a3539c3/tests%2Fui-cargo%2Fmultiple_crate_versions%2Fpass%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/182ac89f16ff2594eaa1e3e899fa4d228a3539c3/tests%2Fui-cargo%2Fmultiple_crate_versions%2Fpass%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui-cargo%2Fmultiple_crate_versions%2Fpass%2Fsrc%2Fmain.rs?ref=182ac89f16ff2594eaa1e3e899fa4d228a3539c3", "patch": "@@ -1,3 +1,4 @@\n+// compile-flags: --crate-name=multiple_crate_versions\n #![warn(clippy::multiple_crate_versions)]\n \n fn main() {}"}, {"sha": "581babfeacbff7445a7655f5cdb5c536f6bc18b8", "filename": "tests/ui-cargo/wildcard_dependencies/fail/src/main.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/182ac89f16ff2594eaa1e3e899fa4d228a3539c3/tests%2Fui-cargo%2Fwildcard_dependencies%2Ffail%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/182ac89f16ff2594eaa1e3e899fa4d228a3539c3/tests%2Fui-cargo%2Fwildcard_dependencies%2Ffail%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui-cargo%2Fwildcard_dependencies%2Ffail%2Fsrc%2Fmain.rs?ref=182ac89f16ff2594eaa1e3e899fa4d228a3539c3", "patch": "@@ -1,3 +1,4 @@\n+// compile-flags: --crate-name=wildcard_dependencies\n #![warn(clippy::wildcard_dependencies)]\n \n fn main() {}"}, {"sha": "581babfeacbff7445a7655f5cdb5c536f6bc18b8", "filename": "tests/ui-cargo/wildcard_dependencies/pass/src/main.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/182ac89f16ff2594eaa1e3e899fa4d228a3539c3/tests%2Fui-cargo%2Fwildcard_dependencies%2Fpass%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/182ac89f16ff2594eaa1e3e899fa4d228a3539c3/tests%2Fui-cargo%2Fwildcard_dependencies%2Fpass%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui-cargo%2Fwildcard_dependencies%2Fpass%2Fsrc%2Fmain.rs?ref=182ac89f16ff2594eaa1e3e899fa4d228a3539c3", "patch": "@@ -1,3 +1,4 @@\n+// compile-flags: --crate-name=wildcard_dependencies\n #![warn(clippy::wildcard_dependencies)]\n \n fn main() {}"}]}