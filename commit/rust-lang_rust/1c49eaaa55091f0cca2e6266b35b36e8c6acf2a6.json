{"sha": "1c49eaaa55091f0cca2e6266b35b36e8c6acf2a6", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFjNDllYWFhNTUwOTFmMGNjYTJlNjI2NmIzNWIzNmU4YzZhY2YyYTY=", "commit": {"author": {"name": "Andrew Dunham", "email": "andrew@du.nham.ca", "date": "2014-08-31T03:36:16Z"}, "committer": {"name": "Andrew Dunham", "email": "andrew@du.nham.ca", "date": "2014-08-31T03:36:16Z"}, "message": "gensym each test re-export module individually\n\nFixes #16597", "tree": {"sha": "4c8ff3de0c3a7fdc13ffd04cbbd0017ddf6adbdb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4c8ff3de0c3a7fdc13ffd04cbbd0017ddf6adbdb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1c49eaaa55091f0cca2e6266b35b36e8c6acf2a6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1c49eaaa55091f0cca2e6266b35b36e8c6acf2a6", "html_url": "https://github.com/rust-lang/rust/commit/1c49eaaa55091f0cca2e6266b35b36e8c6acf2a6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1c49eaaa55091f0cca2e6266b35b36e8c6acf2a6/comments", "author": {"login": "andrew-d", "id": 1079173, "node_id": "MDQ6VXNlcjEwNzkxNzM=", "avatar_url": "https://avatars.githubusercontent.com/u/1079173?v=4", "gravatar_id": "", "url": "https://api.github.com/users/andrew-d", "html_url": "https://github.com/andrew-d", "followers_url": "https://api.github.com/users/andrew-d/followers", "following_url": "https://api.github.com/users/andrew-d/following{/other_user}", "gists_url": "https://api.github.com/users/andrew-d/gists{/gist_id}", "starred_url": "https://api.github.com/users/andrew-d/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/andrew-d/subscriptions", "organizations_url": "https://api.github.com/users/andrew-d/orgs", "repos_url": "https://api.github.com/users/andrew-d/repos", "events_url": "https://api.github.com/users/andrew-d/events{/privacy}", "received_events_url": "https://api.github.com/users/andrew-d/received_events", "type": "User", "site_admin": false}, "committer": {"login": "andrew-d", "id": 1079173, "node_id": "MDQ6VXNlcjEwNzkxNzM=", "avatar_url": "https://avatars.githubusercontent.com/u/1079173?v=4", "gravatar_id": "", "url": "https://api.github.com/users/andrew-d", "html_url": "https://github.com/andrew-d", "followers_url": "https://api.github.com/users/andrew-d/followers", "following_url": "https://api.github.com/users/andrew-d/following{/other_user}", "gists_url": "https://api.github.com/users/andrew-d/gists{/gist_id}", "starred_url": "https://api.github.com/users/andrew-d/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/andrew-d/subscriptions", "organizations_url": "https://api.github.com/users/andrew-d/orgs", "repos_url": "https://api.github.com/users/andrew-d/repos", "events_url": "https://api.github.com/users/andrew-d/events{/privacy}", "received_events_url": "https://api.github.com/users/andrew-d/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cbacdbc5f3bc4f401a96177df8efd2eb765e8799", "url": "https://api.github.com/repos/rust-lang/rust/commits/cbacdbc5f3bc4f401a96177df8efd2eb765e8799", "html_url": "https://github.com/rust-lang/rust/commit/cbacdbc5f3bc4f401a96177df8efd2eb765e8799"}], "stats": {"total": 46, "additions": 33, "deletions": 13}, "files": [{"sha": "8bcbe0113665c96794ef4614be4b86a891553984", "filename": "src/librustc/front/test.rs", "status": "modified", "additions": 33, "deletions": 13, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/1c49eaaa55091f0cca2e6266b35b36e8c6acf2a6/src%2Flibrustc%2Ffront%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1c49eaaa55091f0cca2e6266b35b36e8c6acf2a6/src%2Flibrustc%2Ffront%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Ffront%2Ftest.rs?ref=1c49eaaa55091f0cca2e6266b35b36e8c6acf2a6", "patch": "@@ -50,10 +50,12 @@ struct TestCtxt<'a> {\n     path: Vec<ast::Ident>,\n     ext_cx: ExtCtxt<'a>,\n     testfns: Vec<Test>,\n-    reexport_mod_ident: ast::Ident,\n     reexport_test_harness_main: Option<InternedString>,\n     is_test_crate: bool,\n     config: ast::CrateConfig,\n+\n+    // top-level re-export submodule, filled out after folding is finished\n+    toplevel_reexport: Option<ast::Ident>,\n }\n \n // Traverse the crate, collecting all the test functions, eliding any\n@@ -83,7 +85,9 @@ pub fn modify_for_testing(sess: &Session,\n struct TestHarnessGenerator<'a> {\n     cx: TestCtxt<'a>,\n     tests: Vec<ast::Ident>,\n-    tested_submods: Vec<ast::Ident>,\n+\n+    // submodule name, gensym'd identifier for re-exports\n+    tested_submods: Vec<(ast::Ident, ast::Ident)>,\n }\n \n impl<'a> fold::Folder for TestHarnessGenerator<'a> {\n@@ -168,10 +172,14 @@ impl<'a> fold::Folder for TestHarnessGenerator<'a> {\n             *i = nomain(*i);\n         }\n         if !tests.is_empty() || !tested_submods.is_empty() {\n-            mod_folded.items.push(mk_reexport_mod(&mut self.cx, tests,\n-                                                  tested_submods));\n+            let (it, sym) = mk_reexport_mod(&mut self.cx, tests, tested_submods);\n+            mod_folded.items.push(it);\n+\n             if !self.cx.path.is_empty() {\n-                self.tested_submods.push(self.cx.path[self.cx.path.len()-1]);\n+                self.tested_submods.push((self.cx.path[self.cx.path.len()-1], sym));\n+            } else {\n+                debug!(\"pushing nothing, sym: {}\", sym);\n+                self.cx.toplevel_reexport = Some(sym);\n             }\n         }\n \n@@ -180,16 +188,16 @@ impl<'a> fold::Folder for TestHarnessGenerator<'a> {\n }\n \n fn mk_reexport_mod(cx: &mut TestCtxt, tests: Vec<ast::Ident>,\n-                   tested_submods: Vec<ast::Ident>) -> Gc<ast::Item> {\n+                   tested_submods: Vec<(ast::Ident, ast::Ident)>) -> (Gc<ast::Item>, ast::Ident) {\n     let mut view_items = Vec::new();\n     let super_ = token::str_to_ident(\"super\");\n \n     view_items.extend(tests.move_iter().map(|r| {\n         cx.ext_cx.view_use_simple(DUMMY_SP, ast::Public,\n                                   cx.ext_cx.path(DUMMY_SP, vec![super_, r]))\n     }));\n-    view_items.extend(tested_submods.move_iter().map(|r| {\n-        let path = cx.ext_cx.path(DUMMY_SP, vec![super_, r, cx.reexport_mod_ident]);\n+    view_items.extend(tested_submods.move_iter().map(|(r, sym)| {\n+        let path = cx.ext_cx.path(DUMMY_SP, vec![super_, r, sym]);\n         cx.ext_cx.view_use_simple_(DUMMY_SP, ast::Public, r, path)\n     }));\n \n@@ -198,14 +206,18 @@ fn mk_reexport_mod(cx: &mut TestCtxt, tests: Vec<ast::Ident>,\n         view_items: view_items,\n         items: Vec::new(),\n     };\n-    box(GC) ast::Item {\n-        ident: cx.reexport_mod_ident.clone(),\n+\n+    let sym = token::gensym_ident(\"__test_reexports\");\n+    let it = box(GC) ast::Item {\n+        ident: sym.clone(),\n         attrs: Vec::new(),\n         id: ast::DUMMY_NODE_ID,\n         node: ast::ItemMod(reexport_mod),\n         vis: ast::Public,\n         span: DUMMY_SP,\n-    }\n+    };\n+\n+    (it, sym)\n }\n \n fn generate_test_harness(sess: &Session,\n@@ -220,10 +232,10 @@ fn generate_test_harness(sess: &Session,\n                              }),\n         path: Vec::new(),\n         testfns: Vec::new(),\n-        reexport_mod_ident: token::gensym_ident(\"__test_reexports\"),\n         reexport_test_harness_main: reexport_test_harness_main,\n         is_test_crate: is_test_crate(&krate),\n         config: krate.config.clone(),\n+        toplevel_reexport: None,\n     };\n \n     cx.ext_cx.bt_push(ExpnInfo {\n@@ -530,7 +542,15 @@ fn mk_test_desc_and_fn_rec(cx: &TestCtxt, test: &Test) -> Gc<ast::Expr> {\n              field(\"should_fail\", fail_expr)]);\n \n \n-    let mut visible_path = vec![cx.reexport_mod_ident.clone()];\n+    let mut visible_path = match cx.toplevel_reexport {\n+        Some(id) => vec![id],\n+        None => {\n+            cx.sess.span_bug(\n+                DUMMY_SP,\n+                \"expected to find top-level re-export name, but found None\"\n+            );\n+        }\n+    };\n     visible_path.extend(path.move_iter());\n \n     let fn_expr = ecx.expr_path(ecx.path_global(span, visible_path));"}]}