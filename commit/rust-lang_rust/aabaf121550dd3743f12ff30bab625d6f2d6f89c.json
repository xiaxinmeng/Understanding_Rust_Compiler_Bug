{"sha": "aabaf121550dd3743f12ff30bab625d6f2d6f89c", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFhYmFmMTIxNTUwZGQzNzQzZjEyZmYzMGJhYjYyNWQ2ZjJkNmY4OWM=", "commit": {"author": {"name": "Wesley Wiser", "email": "wwiser@gmail.com", "date": "2019-07-03T12:25:27Z"}, "committer": {"name": "Wesley Wiser", "email": "wwiser@gmail.com", "date": "2019-07-12T00:12:19Z"}, "message": "Fix leak when early returning out of `box` syntax\n\nFixes #62289", "tree": {"sha": "28f92d3d1040d47957823a57cbc641bc84fd58cd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/28f92d3d1040d47957823a57cbc641bc84fd58cd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/aabaf121550dd3743f12ff30bab625d6f2d6f89c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/aabaf121550dd3743f12ff30bab625d6f2d6f89c", "html_url": "https://github.com/rust-lang/rust/commit/aabaf121550dd3743f12ff30bab625d6f2d6f89c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/aabaf121550dd3743f12ff30bab625d6f2d6f89c/comments", "author": {"login": "wesleywiser", "id": 831192, "node_id": "MDQ6VXNlcjgzMTE5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/831192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wesleywiser", "html_url": "https://github.com/wesleywiser", "followers_url": "https://api.github.com/users/wesleywiser/followers", "following_url": "https://api.github.com/users/wesleywiser/following{/other_user}", "gists_url": "https://api.github.com/users/wesleywiser/gists{/gist_id}", "starred_url": "https://api.github.com/users/wesleywiser/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wesleywiser/subscriptions", "organizations_url": "https://api.github.com/users/wesleywiser/orgs", "repos_url": "https://api.github.com/users/wesleywiser/repos", "events_url": "https://api.github.com/users/wesleywiser/events{/privacy}", "received_events_url": "https://api.github.com/users/wesleywiser/received_events", "type": "User", "site_admin": false}, "committer": {"login": "wesleywiser", "id": 831192, "node_id": "MDQ6VXNlcjgzMTE5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/831192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wesleywiser", "html_url": "https://github.com/wesleywiser", "followers_url": "https://api.github.com/users/wesleywiser/followers", "following_url": "https://api.github.com/users/wesleywiser/following{/other_user}", "gists_url": "https://api.github.com/users/wesleywiser/gists{/gist_id}", "starred_url": "https://api.github.com/users/wesleywiser/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wesleywiser/subscriptions", "organizations_url": "https://api.github.com/users/wesleywiser/orgs", "repos_url": "https://api.github.com/users/wesleywiser/repos", "events_url": "https://api.github.com/users/wesleywiser/events{/privacy}", "received_events_url": "https://api.github.com/users/wesleywiser/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "78ca1bda3522b14bc0336bc01dd1d49fdba2cda7", "url": "https://api.github.com/repos/rust-lang/rust/commits/78ca1bda3522b14bc0336bc01dd1d49fdba2cda7", "html_url": "https://github.com/rust-lang/rust/commit/78ca1bda3522b14bc0336bc01dd1d49fdba2cda7"}], "stats": {"total": 93, "additions": 92, "deletions": 1}, "files": [{"sha": "56c518a6d57a8231489b817e72d2436a46299a13", "filename": "src/librustc_mir/build/expr/as_rvalue.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/aabaf121550dd3743f12ff30bab625d6f2d6f89c/src%2Flibrustc_mir%2Fbuild%2Fexpr%2Fas_rvalue.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aabaf121550dd3743f12ff30bab625d6f2d6f89c/src%2Flibrustc_mir%2Fbuild%2Fexpr%2Fas_rvalue.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fbuild%2Fexpr%2Fas_rvalue.rs?ref=aabaf121550dd3743f12ff30bab625d6f2d6f89c", "patch": "@@ -128,7 +128,7 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n                         expr_span,\n                         scope,\n                         result,\n-                        value.ty,\n+                        expr.ty,\n                     );\n                 }\n "}, {"sha": "a3b517e9bca87bfa0cf295af84a7496c3ad5fe65", "filename": "src/test/mir-opt/issue-62289.rs", "status": "added", "additions": 91, "deletions": 0, "changes": 91, "blob_url": "https://github.com/rust-lang/rust/blob/aabaf121550dd3743f12ff30bab625d6f2d6f89c/src%2Ftest%2Fmir-opt%2Fissue-62289.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aabaf121550dd3743f12ff30bab625d6f2d6f89c/src%2Ftest%2Fmir-opt%2Fissue-62289.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fissue-62289.rs?ref=aabaf121550dd3743f12ff30bab625d6f2d6f89c", "patch": "@@ -0,0 +1,91 @@\n+// check that we don't forget to drop the Box if we early return before\n+// initializing it\n+// ignore-tidy-linelength\n+// ignore-wasm32-bare compiled with panic=abort by default\n+\n+#![feature(box_syntax)]\n+\n+fn test() -> Option<Box<u32>> {\n+    Some(box (None?))\n+}\n+\n+fn main() {\n+    test();\n+}\n+\n+// END RUST SOURCE\n+// START rustc.test.ElaborateDrops.before.mir\n+// fn test() -> std::option::Option<std::boxed::Box<u32>> {\n+//     ...\n+//     bb0: {\n+//         StorageLive(_1);\n+//         StorageLive(_2);\n+//         _2 = Box(u32);\n+//         StorageLive(_3);\n+//         StorageLive(_4);\n+//         _4 = std::option::Option::<u32>::None;\n+//         _3 = const <std::option::Option<u32> as std::ops::Try>::into_result(move _4) -> [return: bb2, unwind: bb3];\n+//     }\n+//     bb1 (cleanup): {\n+//         resume;\n+//     }\n+//     bb2: {\n+//         StorageDead(_4);\n+//         _5 = discriminant(_3);\n+//         switchInt(move _5) -> [0isize: bb10, 1isize: bb5, otherwise: bb4];\n+//     }\n+//     bb3 (cleanup): {\n+//         drop(_2) -> bb1;\n+//     }\n+//     bb4: {\n+//         unreachable;\n+//     }\n+//     bb5: {\n+//         StorageLive(_6);\n+//         _6 = ((_3 as Err).0: std::option::NoneError);\n+//         StorageLive(_8);\n+//         StorageLive(_9);\n+//         _9 = _6;\n+//         _8 = const <std::option::NoneError as std::convert::From<std::option::NoneError>>::from(move _9) -> [return: bb7, unwind: bb3];\n+//     }\n+//     bb6: {\n+//         return;\n+//     }\n+//     bb7: {\n+//         StorageDead(_9);\n+//         _0 = const <std::option::Option<std::boxed::Box<u32>> as std::ops::Try>::from_error(move _8) -> [return: bb8, unwind: bb3];\n+//     }\n+//     bb8: {\n+//         StorageDead(_8);\n+//         StorageDead(_6);\n+//         drop(_2) -> bb9;\n+//     }\n+//     bb9: {\n+//         StorageDead(_2);\n+//         StorageDead(_1);\n+//         StorageDead(_3);\n+//         goto -> bb6;\n+//     }\n+//     bb10: {\n+//         StorageLive(_10);\n+//         _10 = ((_3 as Ok).0: u32);\n+//         (*_2) = _10;\n+//         StorageDead(_10);\n+//         _1 = move _2;\n+//         drop(_2) -> [return: bb12, unwind: bb11];\n+//     }\n+//     bb11 (cleanup): {\n+//         drop(_1) -> bb1;\n+//     }\n+//     bb12: {\n+//         StorageDead(_2);\n+//         _0 = std::option::Option::<std::boxed::Box<u32>>::Some(move _1,);\n+//         drop(_1) -> bb13;\n+//     }\n+//     bb13: {\n+//         StorageDead(_1);\n+//         StorageDead(_3);\n+//         goto -> bb6;\n+//     }\n+// }\n+// END rustc.test.ElaborateDrops.before.mir"}]}