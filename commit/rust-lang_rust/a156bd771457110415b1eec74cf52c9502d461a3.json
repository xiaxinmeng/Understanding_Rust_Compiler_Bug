{"sha": "a156bd771457110415b1eec74cf52c9502d461a3", "node_id": "C_kwDOAAsO6NoAKGExNTZiZDc3MTQ1NzExMDQxNWIxZWVjNzRjZjUyYzk1MDJkNDYxYTM", "commit": {"author": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2023-05-03T23:53:44Z"}, "committer": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2023-05-08T03:34:46Z"}, "message": "Make spans a bit better", "tree": {"sha": "eefcd36e3289030d0c1589b36d78a60795d3a543", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/eefcd36e3289030d0c1589b36d78a60795d3a543"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a156bd771457110415b1eec74cf52c9502d461a3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a156bd771457110415b1eec74cf52c9502d461a3", "html_url": "https://github.com/rust-lang/rust/commit/a156bd771457110415b1eec74cf52c9502d461a3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a156bd771457110415b1eec74cf52c9502d461a3/comments", "author": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2b9279f3131056a1a1dd5de7513de4eb98987770", "url": "https://api.github.com/repos/rust-lang/rust/commits/2b9279f3131056a1a1dd5de7513de4eb98987770", "html_url": "https://github.com/rust-lang/rust/commit/2b9279f3131056a1a1dd5de7513de4eb98987770"}], "stats": {"total": 94, "additions": 48, "deletions": 46}, "files": [{"sha": "cd6e36874603f8a499100c817af10ca83079af44", "filename": "compiler/rustc_macros/src/diagnostics/diagnostic_builder.rs", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/a156bd771457110415b1eec74cf52c9502d461a3/compiler%2Frustc_macros%2Fsrc%2Fdiagnostics%2Fdiagnostic_builder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a156bd771457110415b1eec74cf52c9502d461a3/compiler%2Frustc_macros%2Fsrc%2Fdiagnostics%2Fdiagnostic_builder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_macros%2Fsrc%2Fdiagnostics%2Fdiagnostic_builder.rs?ref=a156bd771457110415b1eec74cf52c9502d461a3", "patch": "@@ -9,7 +9,7 @@ use crate::diagnostics::utils::{\n     FieldInnerTy, FieldMap, HasFieldMap, SetOnce, SpannedOption, SubdiagnosticKind,\n };\n use proc_macro2::{Ident, Span, TokenStream};\n-use quote::{format_ident, quote};\n+use quote::{format_ident, quote, quote_spanned};\n use syn::Token;\n use syn::{parse_quote, spanned::Spanned, Attribute, Meta, Path, Type};\n use synstructure::{BindingInfo, Structure, VariantInfo};\n@@ -251,7 +251,8 @@ impl<'a> DiagnosticDeriveVariantBuilder<'a> {\n         let diag = &self.parent.diag;\n \n         let field = binding_info.ast();\n-        let field_binding = &binding_info.binding;\n+        let mut field_binding = binding_info.binding.clone();\n+        field_binding.set_span(field.ty.span());\n \n         let ident = field.ident.as_ref().unwrap();\n         let ident = format_ident!(\"{}\", ident); // strip `r#` prefix, if present\n@@ -284,9 +285,9 @@ impl<'a> DiagnosticDeriveVariantBuilder<'a> {\n                     name == \"primary_span\" && matches!(inner_ty, FieldInnerTy::Vec(_));\n                 let (binding, needs_destructure) = if needs_clone {\n                     // `primary_span` can accept a `Vec<Span>` so don't destructure that.\n-                    (quote! { #field_binding.clone() }, false)\n+                    (quote_spanned! {inner_ty.span()=> #field_binding.clone() }, false)\n                 } else {\n-                    (quote! { #field_binding }, true)\n+                    (quote_spanned! {inner_ty.span()=> #field_binding }, true)\n                 };\n \n                 let generated_code = self"}, {"sha": "374ba1a45c06ec89ada4f940cf52d01e357ef5f8", "filename": "compiler/rustc_macros/src/diagnostics/subdiagnostic.rs", "status": "modified", "additions": 12, "deletions": 9, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/a156bd771457110415b1eec74cf52c9502d461a3/compiler%2Frustc_macros%2Fsrc%2Fdiagnostics%2Fsubdiagnostic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a156bd771457110415b1eec74cf52c9502d461a3/compiler%2Frustc_macros%2Fsrc%2Fdiagnostics%2Fsubdiagnostic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_macros%2Fsrc%2Fdiagnostics%2Fsubdiagnostic.rs?ref=a156bd771457110415b1eec74cf52c9502d461a3", "patch": "@@ -209,18 +209,20 @@ impl<'parent, 'a> SubdiagnosticDeriveVariantBuilder<'parent, 'a> {\n     }\n \n     /// Generates the code for a field with no attributes.\n-    fn generate_field_set_arg(&mut self, binding: &BindingInfo<'_>) -> TokenStream {\n-        let ast = binding.ast();\n-\n+    fn generate_field_set_arg(&mut self, binding_info: &BindingInfo<'_>) -> TokenStream {\n         let diag = &self.parent.diag;\n-        let ident = ast.ident.as_ref().unwrap();\n-        // strip `r#` prefix, if present\n-        let ident = format_ident!(\"{}\", ident);\n+\n+        let field = binding_info.ast();\n+        let mut field_binding = binding_info.binding.clone();\n+        field_binding.set_span(field.ty.span());\n+\n+        let ident = field.ident.as_ref().unwrap();\n+        let ident = format_ident!(\"{}\", ident); // strip `r#` prefix, if present\n \n         quote! {\n             #diag.set_arg(\n                 stringify!(#ident),\n-                #binding\n+                #field_binding\n             );\n         }\n     }\n@@ -397,7 +399,8 @@ impl<'parent, 'a> SubdiagnosticDeriveVariantBuilder<'parent, 'a> {\n         clone_suggestion_code: bool,\n     ) -> Result<TokenStream, DiagnosticDeriveError> {\n         let span = attr.span().unwrap();\n-        let ident = &list.path.segments.last().unwrap().ident;\n+        let mut ident = list.path.segments.last().unwrap().ident.clone();\n+        ident.set_span(info.ty.span());\n         let name = ident.to_string();\n         let name = name.as_str();\n \n@@ -496,7 +499,7 @@ impl<'parent, 'a> SubdiagnosticDeriveVariantBuilder<'parent, 'a> {\n             .variant\n             .bindings()\n             .iter()\n-            .filter(|binding| !binding.ast().attrs.is_empty())\n+            .filter(|binding| !should_generate_set_arg(binding.ast()))\n             .map(|binding| self.generate_field_attr_code(binding, kind_stats))\n             .collect();\n "}, {"sha": "e2434981f8d1782fd3fdfb0f051bcae1a6a9f8be", "filename": "compiler/rustc_macros/src/diagnostics/utils.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/a156bd771457110415b1eec74cf52c9502d461a3/compiler%2Frustc_macros%2Fsrc%2Fdiagnostics%2Futils.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a156bd771457110415b1eec74cf52c9502d461a3/compiler%2Frustc_macros%2Fsrc%2Fdiagnostics%2Futils.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_macros%2Fsrc%2Fdiagnostics%2Futils.rs?ref=a156bd771457110415b1eec74cf52c9502d461a3", "patch": "@@ -207,6 +207,12 @@ impl<'ty> FieldInnerTy<'ty> {\n             FieldInnerTy::Plain(..) => quote! { #inner },\n         }\n     }\n+\n+    pub fn span(&self) -> proc_macro2::Span {\n+        match self {\n+            FieldInnerTy::Option(ty) | FieldInnerTy::Vec(ty) | FieldInnerTy::Plain(ty) => ty.span(),\n+        }\n+    }\n }\n \n /// Field information passed to the builder. Deliberately omits attrs to discourage the"}, {"sha": "642b58b0753fd894e2b0a2defb69bdd700175e6e", "filename": "tests/ui-fulldeps/session-diagnostic/diagnostic-derive-doc-comment-field.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/a156bd771457110415b1eec74cf52c9502d461a3/tests%2Fui-fulldeps%2Fsession-diagnostic%2Fdiagnostic-derive-doc-comment-field.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a156bd771457110415b1eec74cf52c9502d461a3/tests%2Fui-fulldeps%2Fsession-diagnostic%2Fdiagnostic-derive-doc-comment-field.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui-fulldeps%2Fsession-diagnostic%2Fdiagnostic-derive-doc-comment-field.rs?ref=a156bd771457110415b1eec74cf52c9502d461a3", "patch": "@@ -1,5 +1,7 @@\n // check-fail\n // Tests that a doc comment will not preclude a field from being considered a diagnostic argument\n+// normalize-stderr-test \"the following other types implement trait `IntoDiagnosticArg`:(?:.*\\n){0,9}\\s+and \\d+ others\" -> \"normalized in stderr\"\n+// normalize-stderr-test \"diagnostic_builder\\.rs:[0-9]+:[0-9]+\" -> \"diagnostic_builder.rs:LL:CC\"\n \n // The proc_macro2 crate handles spans differently when on beta/stable release rather than nightly,\n // changing the output of this test. Since Subdiagnostic is strictly internal to the compiler\n@@ -27,21 +29,21 @@ fluent_messages! { \"./example.ftl\" }\n struct NotIntoDiagnosticArg;\n \n #[derive(Diagnostic)]\n-//~^ ERROR the trait bound `NotIntoDiagnosticArg: IntoDiagnosticArg` is not satisfied\n #[diag(no_crate_example)]\n struct Test {\n     #[primary_span]\n     span: Span,\n     /// A doc comment\n     arg: NotIntoDiagnosticArg,\n+    //~^ ERROR the trait bound `NotIntoDiagnosticArg: IntoDiagnosticArg` is not satisfied\n }\n \n #[derive(Subdiagnostic)]\n-//~^ ERROR the trait bound `NotIntoDiagnosticArg: IntoDiagnosticArg` is not satisfied\n #[label(no_crate_example)]\n struct SubTest {\n     #[primary_span]\n     span: Span,\n     /// A doc comment\n     arg: NotIntoDiagnosticArg,\n+    //~^ ERROR the trait bound `NotIntoDiagnosticArg: IntoDiagnosticArg` is not satisfied\n }"}, {"sha": "e4b8958b4fae871d3ee0d1fa60dea6bd606e0a60", "filename": "tests/ui-fulldeps/session-diagnostic/diagnostic-derive-doc-comment-field.stderr", "status": "modified", "additions": 14, "deletions": 27, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/a156bd771457110415b1eec74cf52c9502d461a3/tests%2Fui-fulldeps%2Fsession-diagnostic%2Fdiagnostic-derive-doc-comment-field.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/a156bd771457110415b1eec74cf52c9502d461a3/tests%2Fui-fulldeps%2Fsession-diagnostic%2Fdiagnostic-derive-doc-comment-field.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui-fulldeps%2Fsession-diagnostic%2Fdiagnostic-derive-doc-comment-field.stderr?ref=a156bd771457110415b1eec74cf52c9502d461a3", "patch": "@@ -1,42 +1,29 @@\n error[E0277]: the trait bound `NotIntoDiagnosticArg: IntoDiagnosticArg` is not satisfied\n-  --> $DIR/diagnostic-derive-doc-comment-field.rs:29:10\n+  --> $DIR/diagnostic-derive-doc-comment-field.rs:37:10\n    |\n LL | #[derive(Diagnostic)]\n-   |          ^^^^^^^^^^ the trait `IntoDiagnosticArg` is not implemented for `NotIntoDiagnosticArg`\n+   |          ---------- required by a bound introduced by this call\n+...\n+LL |     arg: NotIntoDiagnosticArg,\n+   |          ^^^^^^^^^^^^^^^^^^^^ the trait `IntoDiagnosticArg` is not implemented for `NotIntoDiagnosticArg`\n    |\n-   = help: the following other types implement trait `IntoDiagnosticArg`:\n-             &'a T\n-             &'a std::path::Path\n-             &'a str\n-             &rustc_target::spec::TargetTriple\n-             Box<(dyn std::error::Error + 'static)>\n-             CString\n-             CguReuse\n-             Cow<'a, str>\n-           and 42 others\n+   = help: normalized in stderr\n note: required by a bound in `DiagnosticBuilder::<'a, G>::set_arg`\n-  --> $COMPILER_DIR/rustc_errors/src/diagnostic_builder.rs:747:5\n-   = note: this error originates in the derive macro `Diagnostic` which comes from the expansion of the macro `forward` (in Nightly builds, run with -Z macro-backtrace for more info)\n+  --> $COMPILER_DIR/rustc_errors/src/diagnostic_builder.rs:LL:CC\n+   = note: this error originates in the macro `forward` (in Nightly builds, run with -Z macro-backtrace for more info)\n \n error[E0277]: the trait bound `NotIntoDiagnosticArg: IntoDiagnosticArg` is not satisfied\n-  --> $DIR/diagnostic-derive-doc-comment-field.rs:39:10\n+  --> $DIR/diagnostic-derive-doc-comment-field.rs:47:10\n    |\n LL | #[derive(Subdiagnostic)]\n-   |          ^^^^^^^^^^^^^ the trait `IntoDiagnosticArg` is not implemented for `NotIntoDiagnosticArg`\n+   |          ------------- required by a bound introduced by this call\n+...\n+LL |     arg: NotIntoDiagnosticArg,\n+   |          ^^^^^^^^^^^^^^^^^^^^ the trait `IntoDiagnosticArg` is not implemented for `NotIntoDiagnosticArg`\n    |\n-   = help: the following other types implement trait `IntoDiagnosticArg`:\n-             &'a T\n-             &'a std::path::Path\n-             &'a str\n-             &rustc_target::spec::TargetTriple\n-             Box<(dyn std::error::Error + 'static)>\n-             CString\n-             CguReuse\n-             Cow<'a, str>\n-           and 42 others\n+   = help: normalized in stderr\n note: required by a bound in `Diagnostic::set_arg`\n   --> $COMPILER_DIR/rustc_errors/src/diagnostic.rs:964:5\n-   = note: this error originates in the derive macro `Subdiagnostic` (in Nightly builds, run with -Z macro-backtrace for more info)\n \n error: aborting due to 2 previous errors\n "}, {"sha": "39e34d73f9a431ad1d254d118958dbe4b86d7d26", "filename": "tests/ui-fulldeps/session-diagnostic/diagnostic-derive.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a156bd771457110415b1eec74cf52c9502d461a3/tests%2Fui-fulldeps%2Fsession-diagnostic%2Fdiagnostic-derive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a156bd771457110415b1eec74cf52c9502d461a3/tests%2Fui-fulldeps%2Fsession-diagnostic%2Fdiagnostic-derive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui-fulldeps%2Fsession-diagnostic%2Fdiagnostic-derive.rs?ref=a156bd771457110415b1eec74cf52c9502d461a3", "patch": "@@ -339,12 +339,12 @@ struct ErrorWithDefaultLabelAttr<'a> {\n }\n \n #[derive(Diagnostic)]\n-//~^ ERROR the trait bound `Hello: IntoDiagnosticArg` is not satisfied\n #[diag(no_crate_example, code = \"E0123\")]\n struct ArgFieldWithoutSkip {\n     #[primary_span]\n     span: Span,\n     other: Hello,\n+    //~^ ERROR the trait bound `Hello: IntoDiagnosticArg` is not satisfied\n }\n \n #[derive(Diagnostic)]"}, {"sha": "801e4b5793cc1622916608c419eaa7029d477e76", "filename": "tests/ui-fulldeps/session-diagnostic/diagnostic-derive.stderr", "status": "modified", "additions": 6, "deletions": 3, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/a156bd771457110415b1eec74cf52c9502d461a3/tests%2Fui-fulldeps%2Fsession-diagnostic%2Fdiagnostic-derive.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/a156bd771457110415b1eec74cf52c9502d461a3/tests%2Fui-fulldeps%2Fsession-diagnostic%2Fdiagnostic-derive.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui-fulldeps%2Fsession-diagnostic%2Fdiagnostic-derive.stderr?ref=a156bd771457110415b1eec74cf52c9502d461a3", "patch": "@@ -641,15 +641,18 @@ LL | #[derive(Diagnostic)]\n    = note: this error originates in the derive macro `Diagnostic` (in Nightly builds, run with -Z macro-backtrace for more info)\n \n error[E0277]: the trait bound `Hello: IntoDiagnosticArg` is not satisfied\n-  --> $DIR/diagnostic-derive.rs:341:10\n+  --> $DIR/diagnostic-derive.rs:346:12\n    |\n LL | #[derive(Diagnostic)]\n-   |          ^^^^^^^^^^ the trait `IntoDiagnosticArg` is not implemented for `Hello`\n+   |          ---------- required by a bound introduced by this call\n+...\n+LL |     other: Hello,\n+   |            ^^^^^ the trait `IntoDiagnosticArg` is not implemented for `Hello`\n    |\n    = help: normalized in stderr\n note: required by a bound in `DiagnosticBuilder::<'a, G>::set_arg`\n   --> $COMPILER_DIR/rustc_errors/src/diagnostic_builder.rs:LL:CC\n-   = note: this error originates in the derive macro `Diagnostic` which comes from the expansion of the macro `forward` (in Nightly builds, run with -Z macro-backtrace for more info)\n+   = note: this error originates in the macro `forward` (in Nightly builds, run with -Z macro-backtrace for more info)\n \n error: aborting due to 84 previous errors\n "}]}