{"sha": "6ebacf2fd77b4a7a688aeebd5f6fcc422e230635", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZlYmFjZjJmZDc3YjRhN2E2ODhhZWViZDVmNmZjYzQyMmUyMzA2MzU=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2013-12-15T07:11:13Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2013-12-16T06:36:44Z"}, "message": "Move logic for test output generation forward\n\nBy performing this logic very late in the build process, it ended up leading to\nbugs like those found in #10973 where certain stages of the build process\nexpected a particular output format which didn't end up being the case. In order\nto fix this, the build output generation is moved very early in the build\nprocess to the absolute first thing in phase 2.\n\nCloses #10973", "tree": {"sha": "396149cc4beccc5691cb5ad7e7bdf3e047e46218", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/396149cc4beccc5691cb5ad7e7bdf3e047e46218"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6ebacf2fd77b4a7a688aeebd5f6fcc422e230635", "comment_count": 5, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6ebacf2fd77b4a7a688aeebd5f6fcc422e230635", "html_url": "https://github.com/rust-lang/rust/commit/6ebacf2fd77b4a7a688aeebd5f6fcc422e230635", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6ebacf2fd77b4a7a688aeebd5f6fcc422e230635/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f73c9c9bbcaf1595f766ad8bb01e21c78fcba84b", "url": "https://api.github.com/repos/rust-lang/rust/commits/f73c9c9bbcaf1595f766ad8bb01e21c78fcba84b", "html_url": "https://github.com/rust-lang/rust/commit/f73c9c9bbcaf1595f766ad8bb01e21c78fcba84b"}], "stats": {"total": 27, "additions": 16, "deletions": 11}, "files": [{"sha": "badc0507a431712348de5757d8658ae317e70ac9", "filename": "src/librustc/back/link.rs", "status": "modified", "additions": 3, "deletions": 10, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/6ebacf2fd77b4a7a688aeebd5f6fcc422e230635/src%2Flibrustc%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6ebacf2fd77b4a7a688aeebd5f6fcc422e230635/src%2Flibrustc%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fback%2Flink.rs?ref=6ebacf2fd77b4a7a688aeebd5f6fcc422e230635", "patch": "@@ -722,17 +722,10 @@ pub fn link_binary(sess: Session,\n                    obj_filename: &Path,\n                    out_filename: &Path,\n                    lm: &LinkMeta) -> ~[Path] {\n-    // If we're generating a test executable, then ignore all other output\n-    // styles at all other locations\n-    let outputs = if sess.opts.test {\n-        ~[session::OutputExecutable]\n-    } else {\n-        (*sess.outputs).clone()\n-    };\n-\n     let mut out_filenames = ~[];\n-    for output in outputs.move_iter() {\n-        let out_file = link_binary_output(sess, trans, output, obj_filename, out_filename, lm);\n+    for &output in sess.outputs.iter() {\n+        let out_file = link_binary_output(sess, trans, output, obj_filename,\n+                                          out_filename, lm);\n         out_filenames.push(out_file);\n     }\n "}, {"sha": "78b59f493413b989c86fbf16182ebaa432e0e1b0", "filename": "src/librustc/driver/session.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/6ebacf2fd77b4a7a688aeebd5f6fcc422e230635/src%2Flibrustc%2Fdriver%2Fsession.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6ebacf2fd77b4a7a688aeebd5f6fcc422e230635/src%2Flibrustc%2Fdriver%2Fsession.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fdriver%2Fsession.rs?ref=6ebacf2fd77b4a7a688aeebd5f6fcc422e230635", "patch": "@@ -405,20 +405,25 @@ pub fn expect<T:Clone>(sess: Session, opt: Option<T>, msg: || -> ~str) -> T {\n }\n \n pub fn building_library(options: &options, crate: &ast::Crate) -> bool {\n+    if options.test { return false }\n     for output in options.outputs.iter() {\n         match *output {\n             OutputExecutable => {}\n             OutputStaticlib | OutputDylib | OutputRlib => return true\n         }\n     }\n-    if options.test { return false }\n     match syntax::attr::first_attr_value_str_by_name(crate.attrs, \"crate_type\") {\n         Some(s) => \"lib\" == s || \"rlib\" == s || \"dylib\" == s || \"staticlib\" == s,\n         _ => false\n     }\n }\n \n pub fn collect_outputs(options: &options, crate: &ast::Crate) -> ~[OutputStyle] {\n+    // If we're generating a test executable, then ignore all other output\n+    // styles at all other locations\n+    if options.test {\n+        return ~[OutputExecutable];\n+    }\n     let mut base = options.outputs.clone();\n     let mut iter = crate.attrs.iter().filter_map(|a| {\n         if \"crate_type\" == a.name() {"}, {"sha": "89186b2ad4da2e3d62fd81093f939bcac338de78", "filename": "src/test/run-make/no-intermediate-extras/Makefile", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/6ebacf2fd77b4a7a688aeebd5f6fcc422e230635/src%2Ftest%2Frun-make%2Fno-intermediate-extras%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/6ebacf2fd77b4a7a688aeebd5f6fcc422e230635/src%2Ftest%2Frun-make%2Fno-intermediate-extras%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fno-intermediate-extras%2FMakefile?ref=6ebacf2fd77b4a7a688aeebd5f6fcc422e230635", "patch": "@@ -0,0 +1,7 @@\n+# Regression test for issue #10973\n+\n+-include ../tools.mk\n+\n+all:\n+\t$(RUSTC) --rlib --test foo.rs\n+\trm $(TMPDIR)/foo.bc && exit 1 || exit 0"}, {"sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391", "filename": "src/test/run-make/no-intermediate-extras/foo.rs", "status": "added", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/6ebacf2fd77b4a7a688aeebd5f6fcc422e230635/src%2Ftest%2Frun-make%2Fno-intermediate-extras%2Ffoo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6ebacf2fd77b4a7a688aeebd5f6fcc422e230635/src%2Ftest%2Frun-make%2Fno-intermediate-extras%2Ffoo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fno-intermediate-extras%2Ffoo.rs?ref=6ebacf2fd77b4a7a688aeebd5f6fcc422e230635"}]}