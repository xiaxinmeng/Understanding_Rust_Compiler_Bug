{"sha": "462461699aa78e08388fb32cf7b4ab05336a5763", "node_id": "C_kwDOAAsO6NoAKDQ2MjQ2MTY5OWFhNzhlMDgzODhmYjMyY2Y3YjRhYjA1MzM2YTU3NjM", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2023-04-20T15:59:54Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-04-20T15:59:54Z"}, "message": "Rollup merge of #110558 - spastorino:smir-call-terminator, r=oli-obk\n\nAdd Call terminator to SMIR\n\nThis adds internal MIR `TerminatorKind::Call` to SMIR `Terminator::Call` conversion.\n\nr? `@oli-obk`", "tree": {"sha": "bb3bf43231655599e1d69f0c8acedd66ccfb57d8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bb3bf43231655599e1d69f0c8acedd66ccfb57d8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/462461699aa78e08388fb32cf7b4ab05336a5763", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkQWF6CRBK7hj4Ov3rIwAApu4IAC11bJT12fR2U+6FiFt6B8ZV\nUGXw372Ro0TIYeVjEwJn03+36MCM9X5HEUL+8JYALswFSR6MqrqcfsBz6i/7vIap\n2MaKTcefcJMCElmcbv70iYeJDCe9a2GXIymGVk2mDGvW4l6FpJkoVQ35COUqlWsd\nuMAg/3oaTgKdTWdpcqfRKWZdT6nWqULuirXtYpyqsTLcopuv5T88l+gRDtYJvryi\nU7h0Z2mUUbLFuZmnwLDxmYzt8+SthfJf1rq8/6ML5sndm5cUPOf8MvD61IVzesdp\n5qBU3FKQ1ojDV8y0KeZUy6z6sapRrAd9zp0a8Q0r92IchCTI+6H6wWpsj+fH+YU=\n=I2W2\n-----END PGP SIGNATURE-----\n", "payload": "tree bb3bf43231655599e1d69f0c8acedd66ccfb57d8\nparent 7dc211f5cede0a515d7a00bf7f3f908ce97e861c\nparent 2f503345b482e970df48cdb074becc75b7e507f2\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1682006394 +0200\ncommitter GitHub <noreply@github.com> 1682006394 +0200\n\nRollup merge of #110558 - spastorino:smir-call-terminator, r=oli-obk\n\nAdd Call terminator to SMIR\n\nThis adds internal MIR `TerminatorKind::Call` to SMIR `Terminator::Call` conversion.\n\nr? `@oli-obk`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/462461699aa78e08388fb32cf7b4ab05336a5763", "html_url": "https://github.com/rust-lang/rust/commit/462461699aa78e08388fb32cf7b4ab05336a5763", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/462461699aa78e08388fb32cf7b4ab05336a5763/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7dc211f5cede0a515d7a00bf7f3f908ce97e861c", "url": "https://api.github.com/repos/rust-lang/rust/commits/7dc211f5cede0a515d7a00bf7f3f908ce97e861c", "html_url": "https://github.com/rust-lang/rust/commit/7dc211f5cede0a515d7a00bf7f3f908ce97e861c"}, {"sha": "2f503345b482e970df48cdb074becc75b7e507f2", "url": "https://api.github.com/repos/rust-lang/rust/commits/2f503345b482e970df48cdb074becc75b7e507f2", "html_url": "https://github.com/rust-lang/rust/commit/2f503345b482e970df48cdb074becc75b7e507f2"}], "stats": {"total": 42, "additions": 39, "deletions": 3}, "files": [{"sha": "09cb6fd22d5e6250e6b0530468365d55e8467d47", "filename": "compiler/rustc_smir/src/rustc_smir/mod.rs", "status": "modified", "additions": 21, "deletions": 1, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/462461699aa78e08388fb32cf7b4ab05336a5763/compiler%2Frustc_smir%2Fsrc%2Frustc_smir%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/462461699aa78e08388fb32cf7b4ab05336a5763/compiler%2Frustc_smir%2Fsrc%2Frustc_smir%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_smir%2Fsrc%2Frustc_smir%2Fmod.rs?ref=462461699aa78e08388fb32cf7b4ab05336a5763", "patch": "@@ -128,6 +128,18 @@ fn rustc_place_to_place(place: &rustc_middle::mir::Place<'_>) -> stable_mir::mir\n     stable_mir::mir::Place { local: place.local.as_usize() }\n }\n \n+fn rustc_unwind_to_unwind(\n+    unwind: &rustc_middle::mir::UnwindAction,\n+) -> stable_mir::mir::UnwindAction {\n+    use rustc_middle::mir::UnwindAction;\n+    match unwind {\n+        UnwindAction::Continue => stable_mir::mir::UnwindAction::Continue,\n+        UnwindAction::Unreachable => stable_mir::mir::UnwindAction::Unreachable,\n+        UnwindAction::Terminate => stable_mir::mir::UnwindAction::Terminate,\n+        UnwindAction::Cleanup(bb) => stable_mir::mir::UnwindAction::Cleanup(bb.as_usize()),\n+    }\n+}\n+\n fn rustc_terminator_to_terminator(\n     terminator: &rustc_middle::mir::Terminator<'_>,\n ) -> stable_mir::mir::Terminator {\n@@ -151,7 +163,15 @@ fn rustc_terminator_to_terminator(\n         Return => Terminator::Return,\n         Unreachable => Terminator::Unreachable,\n         Drop { .. } => todo!(),\n-        Call { .. } => todo!(),\n+        Call { func, args, destination, target, unwind, from_hir_call: _, fn_span: _ } => {\n+            Terminator::Call {\n+                func: rustc_op_to_op(func),\n+                args: args.iter().map(|arg| rustc_op_to_op(arg)).collect(),\n+                destination: rustc_place_to_place(destination),\n+                target: target.map(|t| t.as_usize()),\n+                unwind: rustc_unwind_to_unwind(unwind),\n+            }\n+        }\n         Assert { .. } => todo!(),\n         Yield { .. } => todo!(),\n         GeneratorDrop => todo!(),"}, {"sha": "bd5e6b68a12fab04fb4123b46c60d3225969fa38", "filename": "compiler/rustc_smir/src/stable_mir/mir/body.rs", "status": "modified", "additions": 9, "deletions": 1, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/462461699aa78e08388fb32cf7b4ab05336a5763/compiler%2Frustc_smir%2Fsrc%2Fstable_mir%2Fmir%2Fbody.rs", "raw_url": "https://github.com/rust-lang/rust/raw/462461699aa78e08388fb32cf7b4ab05336a5763/compiler%2Frustc_smir%2Fsrc%2Fstable_mir%2Fmir%2Fbody.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_smir%2Fsrc%2Fstable_mir%2Fmir%2Fbody.rs?ref=462461699aa78e08388fb32cf7b4ab05336a5763", "patch": "@@ -33,7 +33,7 @@ pub enum Terminator {\n         args: Vec<Operand>,\n         destination: Place,\n         target: Option<usize>,\n-        cleanup: Option<usize>,\n+        unwind: UnwindAction,\n     },\n     Assert {\n         cond: Operand,\n@@ -44,6 +44,14 @@ pub enum Terminator {\n     },\n }\n \n+#[derive(Clone, Debug)]\n+pub enum UnwindAction {\n+    Continue,\n+    Unreachable,\n+    Terminate,\n+    Cleanup(usize),\n+}\n+\n #[derive(Clone, Debug)]\n pub enum Statement {\n     Assign(Place, Operand),"}, {"sha": "95f27efa7715c45cac3f8dd3110ad34eea36f07e", "filename": "tests/ui-fulldeps/stable-mir/crate-info.rs", "status": "modified", "additions": 9, "deletions": 1, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/462461699aa78e08388fb32cf7b4ab05336a5763/tests%2Fui-fulldeps%2Fstable-mir%2Fcrate-info.rs", "raw_url": "https://github.com/rust-lang/rust/raw/462461699aa78e08388fb32cf7b4ab05336a5763/tests%2Fui-fulldeps%2Fstable-mir%2Fcrate-info.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui-fulldeps%2Fstable-mir%2Fcrate-info.rs?ref=462461699aa78e08388fb32cf7b4ab05336a5763", "patch": "@@ -33,7 +33,6 @@ fn test_stable_mir(tcx: TyCtxt<'_>) {\n \n     // Find items in the local crate.\n     let items = stable_mir::all_local_items();\n-    assert!(get_item(tcx, &items, (DefKind::Fn, \"foo_bar\")).is_some());\n     assert!(get_item(tcx, &items, (DefKind::Fn, \"foo::bar\")).is_some());\n \n     // Find the `std` crate.\n@@ -52,6 +51,15 @@ fn test_stable_mir(tcx: TyCtxt<'_>) {\n         stable_mir::mir::Terminator::Return => {}\n         other => panic!(\"{other:?}\"),\n     }\n+\n+    let foo_bar = get_item(tcx, &items, (DefKind::Fn, \"foo_bar\")).unwrap();\n+    let body = foo_bar.body();\n+    assert_eq!(body.blocks.len(), 4);\n+    let block = &body.blocks[0];\n+    match &block.terminator {\n+        stable_mir::mir::Terminator::Call { .. } => {}\n+        other => panic!(\"{other:?}\"),\n+    }\n }\n \n // Use internal API to find a function in a crate."}]}