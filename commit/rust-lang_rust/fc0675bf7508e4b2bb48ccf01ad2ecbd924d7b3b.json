{"sha": "fc0675bf7508e4b2bb48ccf01ad2ecbd924d7b3b", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZjMDY3NWJmNzUwOGU0YjJiYjQ4Y2NmMDFhZDJlY2JkOTI0ZDdiM2I=", "commit": {"author": {"name": "Tymoteusz Jankowski", "email": "tymoteusz.jankowski@gmail.com", "date": "2020-05-22T09:50:22Z"}, "committer": {"name": "Tymoteusz Jankowski", "email": "tymoteusz.jankowski@gmail.com", "date": "2020-05-22T11:57:05Z"}, "message": "Allow using `Self::` in doc", "tree": {"sha": "72ce83c0aea0c17ff8b74de6e0e3b19f3d5b497e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/72ce83c0aea0c17ff8b74de6e0e3b19f3d5b497e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fc0675bf7508e4b2bb48ccf01ad2ecbd924d7b3b", "comment_count": 0, "verification": {"verified": false, "reason": "no_user", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQJSBAABCAA8FiEEz+VEfPVBkDAIKjASdufZPLFRDjEFAl7HvhIeHHR5bW90ZXVz\nei5qYW5rb3dza2lAZ21haWwuY29tAAoJEHbn2TyxUQ4xbrgP/RF5K/mZIiCCFp60\nKN8I1RzMJOXQNFBjhq7ZzdUWIh3eNgo9Dv1DHogiE5TDZUh+0Eevvi3mfTNJ+XIc\nrj6fTCODnfNcsTyde/t9XEYZ2AkNk/ORLxANBbfSJQz0+0faPewd/0v9ypVKqMI/\nLLtNlxeH8600l0gMobvbXQ7AndlkfDLyYmTOy7ph9feZU5mR2F346Vvb4M35zRcT\ntQPzV3uqU7nkGlf54C7wpck+OStXjBVWPgXtxE1jdhJR/cTPu2hjGY5NtElEnFtn\nyZgrqTU26p3yUR9K8Np0dcJu+3D2gu5v76ILAPBKuDyviua/Fqqk7UQJS/t4BTdd\n9OapIhI+WiGoUS8lYBbhdfB3XPzf17Q3DrF/KILCDI4NHhpn4oTikR8Hsu1Et8DG\nl4HJQYP50UE2Bww5N5Q6pnHTcd3SSPkYJwasL+LL/3myg6aMTUxecWZkYJa12w7L\nIFlzBxcG/vI6NlaKRrFceyFsIpFHp8EvMxUEjqDrkopejIdPvZNxLh5SAKowM8fK\nKzsW5Zfd/RLqmpAOvRI09MxWO7go85mA3j7ZwlMunCuEZ4BnqeQ1l/0gXffwWkEf\nSUrlve4YfOZZnW9BTwy6I2mkSMcsGW343uU/M7F6fm/iWgm9KL/jROD5aVTCyTA5\n8eZe8VIGhsA5P+aotboJcj9W/WBv\n=Y3Xw\n-----END PGP SIGNATURE-----", "payload": "tree 72ce83c0aea0c17ff8b74de6e0e3b19f3d5b497e\nparent 458a3e76294fd859fb037f425404180c91e14767\nauthor Tymoteusz Jankowski <tymoteusz.jankowski@gmail.com> 1590141022 +0200\ncommitter Tymoteusz Jankowski <tymoteusz.jankowski@gmail.com> 1590148625 +0200\n\nAllow using `Self::` in doc\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fc0675bf7508e4b2bb48ccf01ad2ecbd924d7b3b", "html_url": "https://github.com/rust-lang/rust/commit/fc0675bf7508e4b2bb48ccf01ad2ecbd924d7b3b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fc0675bf7508e4b2bb48ccf01ad2ecbd924d7b3b/comments", "author": null, "committer": null, "parents": [{"sha": "458a3e76294fd859fb037f425404180c91e14767", "url": "https://api.github.com/repos/rust-lang/rust/commits/458a3e76294fd859fb037f425404180c91e14767", "html_url": "https://github.com/rust-lang/rust/commit/458a3e76294fd859fb037f425404180c91e14767"}], "stats": {"total": 142, "additions": 138, "deletions": 4}, "files": [{"sha": "adb7fc3eb9cff8f827a51acfb34061fc2ee4b156", "filename": "src/librustdoc/passes/collect_intra_doc_links.rs", "status": "modified", "additions": 50, "deletions": 4, "changes": 54, "blob_url": "https://github.com/rust-lang/rust/blob/fc0675bf7508e4b2bb48ccf01ad2ecbd924d7b3b/src%2Flibrustdoc%2Fpasses%2Fcollect_intra_doc_links.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fc0675bf7508e4b2bb48ccf01ad2ecbd924d7b3b/src%2Flibrustdoc%2Fpasses%2Fcollect_intra_doc_links.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fcollect_intra_doc_links.rs?ref=fc0675bf7508e4b2bb48ccf01ad2ecbd924d7b3b", "patch": "@@ -431,6 +431,43 @@ impl<'a, 'tcx> DocFolder for LinkCollector<'a, 'tcx> {\n \n         look_for_tests(&cx, &dox, &item, true);\n \n+        // find item's parent to resolve `Self` in item's docs below\n+        let parent_name = self.cx.as_local_hir_id(item.def_id).and_then(|item_hir| {\n+            let parent_hir = self.cx.tcx.hir().get_parent_item(item_hir);\n+            let item_parent = self.cx.tcx.hir().find(parent_hir);\n+            match item_parent {\n+                Some(hir::Node::Item(hir::Item {\n+                    kind:\n+                        hir::ItemKind::Impl {\n+                            self_ty:\n+                                hir::Ty {\n+                                    kind:\n+                                        hir::TyKind::Path(hir::QPath::Resolved(\n+                                            _,\n+                                            hir::Path { segments, .. },\n+                                        )),\n+                                    ..\n+                                },\n+                            ..\n+                        },\n+                    ..\n+                })) => segments.first().and_then(|seg| Some(seg.ident.to_string())),\n+                Some(hir::Node::Item(hir::Item {\n+                    ident, kind: hir::ItemKind::Enum(..), ..\n+                }))\n+                | Some(hir::Node::Item(hir::Item {\n+                    ident, kind: hir::ItemKind::Struct(..), ..\n+                }))\n+                | Some(hir::Node::Item(hir::Item {\n+                    ident, kind: hir::ItemKind::Union(..), ..\n+                }))\n+                | Some(hir::Node::Item(hir::Item {\n+                    ident, kind: hir::ItemKind::Trait(..), ..\n+                })) => Some(ident.to_string()),\n+                _ => None,\n+            }\n+        });\n+\n         for (ori_link, link_range) in markdown_links(&dox) {\n             // Bail early for real links.\n             if ori_link.contains('/') {\n@@ -467,7 +504,7 @@ impl<'a, 'tcx> DocFolder for LinkCollector<'a, 'tcx> {\n             };\n             let (res, fragment) = {\n                 let mut kind = None;\n-                let path_str = if let Some(prefix) =\n+                let mut path_str = if let Some(prefix) =\n                     [\"struct@\", \"enum@\", \"type@\", \"trait@\", \"union@\"]\n                         .iter()\n                         .find(|p| link.starts_with(**p))\n@@ -521,6 +558,15 @@ impl<'a, 'tcx> DocFolder for LinkCollector<'a, 'tcx> {\n                 let base_node =\n                     if item.is_mod() && item.attrs.inner_docs { None } else { parent_node };\n \n+                let resolved_self;\n+                // replace `Self` with suitable item's parent name\n+                if path_str.starts_with(\"Self::\") {\n+                    if let Some(ref name) = parent_name {\n+                        resolved_self = format!(\"{}::{}\", name, &path_str[6..]);\n+                        path_str = &resolved_self;\n+                    }\n+                }\n+\n                 match kind {\n                     Some(ns @ ValueNS) => {\n                         match self.resolve(\n@@ -529,7 +575,7 @@ impl<'a, 'tcx> DocFolder for LinkCollector<'a, 'tcx> {\n                             &current_item,\n                             base_node,\n                             &extra_fragment,\n-                            None,\n+                            Some(&item),\n                         ) {\n                             Ok(res) => res,\n                             Err(ErrorKind::ResolutionFailure) => {\n@@ -552,7 +598,7 @@ impl<'a, 'tcx> DocFolder for LinkCollector<'a, 'tcx> {\n                             &current_item,\n                             base_node,\n                             &extra_fragment,\n-                            None,\n+                            Some(&item),\n                         ) {\n                             Ok(res) => res,\n                             Err(ErrorKind::ResolutionFailure) => {\n@@ -577,7 +623,7 @@ impl<'a, 'tcx> DocFolder for LinkCollector<'a, 'tcx> {\n                                 &current_item,\n                                 base_node,\n                                 &extra_fragment,\n-                                None,\n+                                Some(&item),\n                             ) {\n                                 Err(ErrorKind::AnchorFailure(msg)) => {\n                                     anchor_failure(cx, &item, &ori_link, &dox, link_range, msg);"}, {"sha": "97752d5cfcb5c96d29e81fc020c4231d70102594", "filename": "src/test/rustdoc/intra-link-self.rs", "status": "modified", "additions": 88, "deletions": 0, "changes": 88, "blob_url": "https://github.com/rust-lang/rust/blob/fc0675bf7508e4b2bb48ccf01ad2ecbd924d7b3b/src%2Ftest%2Frustdoc%2Fintra-link-self.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fc0675bf7508e4b2bb48ccf01ad2ecbd924d7b3b/src%2Ftest%2Frustdoc%2Fintra-link-self.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fintra-link-self.rs?ref=fc0675bf7508e4b2bb48ccf01ad2ecbd924d7b3b", "patch": "@@ -1,5 +1,7 @@\n #![crate_name = \"foo\"]\n \n+// ignore-tidy-linelength\n+\n // @has foo/index.html '//a/@href' '../foo/struct.Foo.html#method.new'\n // @has foo/struct.Foo.html '//a/@href' '../foo/struct.Foo.html#method.new'\n \n@@ -27,3 +29,89 @@ impl Bar {\n         unimplemented!()\n     }\n }\n+\n+pub struct MyStruct {\n+    // @has foo/struct.MyStruct.html '//a/@href' '../foo/struct.MyStruct.html#structfield.struct_field'\n+\n+    /// [`struct_field`]\n+    ///\n+    /// [`struct_field`]: Self::struct_field\n+    pub struct_field: u8,\n+}\n+\n+pub enum MyEnum {\n+    // @has foo/enum.MyEnum.html '//a/@href' '../foo/enum.MyEnum.html#EnumVariant.v'\n+\n+    /// [`EnumVariant`]\n+    ///\n+    /// [`EnumVariant`]: Self::EnumVariant\n+    EnumVariant,\n+}\n+\n+pub union MyUnion {\n+    // @has foo/union.MyUnion.html '//a/@href' '../foo/union.MyUnion.html#structfield.union_field'\n+\n+    /// [`union_field`]\n+    ///\n+    /// [`union_field`]: Self::union_field\n+    pub union_field: f32,\n+}\n+\n+pub trait MyTrait {\n+    // @has foo/trait.MyTrait.html '//a/@href' '../foo/trait.MyTrait.html#associatedtype.AssoType'\n+\n+    /// [`AssoType`]\n+    ///\n+    /// [`AssoType`]: Self::AssoType\n+    type AssoType;\n+\n+    // @has foo/trait.MyTrait.html '//a/@href' '../foo/trait.MyTrait.html#associatedconstant.ASSO_CONST'\n+\n+    /// [`ASSO_CONST`]\n+    ///\n+    /// [`ASSO_CONST`]: Self::ASSO_CONST\n+    const ASSO_CONST: i32 = 1;\n+\n+    // @has foo/trait.MyTrait.html '//a/@href' '../foo/trait.MyTrait.html#method.asso_fn'\n+\n+    /// [`asso_fn`]\n+    ///\n+    /// [`asso_fn`]: Self::asso_fn\n+    fn asso_fn() {}\n+}\n+\n+impl MyStruct {\n+    // @has foo/struct.MyStruct.html '//a/@href' '../foo/struct.MyStruct.html#method.for_impl'\n+\n+    /// [`for_impl`]\n+    ///\n+    /// [`for_impl`]: Self::for_impl\n+    pub fn for_impl() {\n+        unimplemented!()\n+    }\n+}\n+\n+impl MyTrait for MyStruct {\n+    // @has foo/struct.MyStruct.html '//a/@href' '../foo/struct.MyStruct.html#associatedtype.AssoType'\n+\n+    /// [`AssoType`]\n+    ///\n+    /// [`AssoType`]: Self::AssoType\n+    type AssoType = u32;\n+\n+    // @has foo/struct.MyStruct.html '//a/@href' '../foo/struct.MyStruct.html#associatedconstant.ASSO_CONST'\n+\n+    /// [`ASSO_CONST`]\n+    ///\n+    /// [`ASSO_CONST`]: Self::ASSO_CONST\n+    const ASSO_CONST: i32 = 10;\n+\n+    // @has foo/struct.MyStruct.html '//a/@href' '../foo/struct.MyStruct.html#method.asso_fn'\n+\n+    /// [`asso_fn`]\n+    ///\n+    /// [`asso_fn`]: Self::asso_fn\n+    fn asso_fn() {\n+        unimplemented!()\n+    }\n+}"}]}