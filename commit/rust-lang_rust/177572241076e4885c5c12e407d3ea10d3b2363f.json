{"sha": "177572241076e4885c5c12e407d3ea10d3b2363f", "node_id": "C_kwDOAAsO6NoAKDE3NzU3MjI0MTA3NmU0ODg1YzVjMTJlNDA3ZDNlYTEwZDNiMjM2M2Y", "commit": {"author": {"name": "bohan", "email": "bohan-zhang@foxmail.com", "date": "2023-03-19T12:12:57Z"}, "committer": {"name": "bohan", "email": "bohan-zhang@foxmail.com", "date": "2023-03-19T12:18:45Z"}, "message": "fix: modify the condition that `resolve_imports` stops", "tree": {"sha": "0fdba88d34411b8c4fbce558a94ade60daacf582", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0fdba88d34411b8c4fbce558a94ade60daacf582"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/177572241076e4885c5c12e407d3ea10d3b2363f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/177572241076e4885c5c12e407d3ea10d3b2363f", "html_url": "https://github.com/rust-lang/rust/commit/177572241076e4885c5c12e407d3ea10d3b2363f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/177572241076e4885c5c12e407d3ea10d3b2363f/comments", "author": {"login": "bvanjoi", "id": 30187863, "node_id": "MDQ6VXNlcjMwMTg3ODYz", "avatar_url": "https://avatars.githubusercontent.com/u/30187863?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bvanjoi", "html_url": "https://github.com/bvanjoi", "followers_url": "https://api.github.com/users/bvanjoi/followers", "following_url": "https://api.github.com/users/bvanjoi/following{/other_user}", "gists_url": "https://api.github.com/users/bvanjoi/gists{/gist_id}", "starred_url": "https://api.github.com/users/bvanjoi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bvanjoi/subscriptions", "organizations_url": "https://api.github.com/users/bvanjoi/orgs", "repos_url": "https://api.github.com/users/bvanjoi/repos", "events_url": "https://api.github.com/users/bvanjoi/events{/privacy}", "received_events_url": "https://api.github.com/users/bvanjoi/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bvanjoi", "id": 30187863, "node_id": "MDQ6VXNlcjMwMTg3ODYz", "avatar_url": "https://avatars.githubusercontent.com/u/30187863?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bvanjoi", "html_url": "https://github.com/bvanjoi", "followers_url": "https://api.github.com/users/bvanjoi/followers", "following_url": "https://api.github.com/users/bvanjoi/following{/other_user}", "gists_url": "https://api.github.com/users/bvanjoi/gists{/gist_id}", "starred_url": "https://api.github.com/users/bvanjoi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bvanjoi/subscriptions", "organizations_url": "https://api.github.com/users/bvanjoi/orgs", "repos_url": "https://api.github.com/users/bvanjoi/repos", "events_url": "https://api.github.com/users/bvanjoi/events{/privacy}", "received_events_url": "https://api.github.com/users/bvanjoi/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ab9bb3ea368b2412531a3e8c07ba73d1dd690134", "url": "https://api.github.com/repos/rust-lang/rust/commits/ab9bb3ea368b2412531a3e8c07ba73d1dd690134", "html_url": "https://github.com/rust-lang/rust/commit/ab9bb3ea368b2412531a3e8c07ba73d1dd690134"}], "stats": {"total": 121, "additions": 106, "deletions": 15}, "files": [{"sha": "4d4bc1be34973b241a0282fa75a1e184ebc798dd", "filename": "compiler/rustc_resolve/src/imports.rs", "status": "modified", "additions": 23, "deletions": 15, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/177572241076e4885c5c12e407d3ea10d3b2363f/compiler%2Frustc_resolve%2Fsrc%2Fimports.rs", "raw_url": "https://github.com/rust-lang/rust/raw/177572241076e4885c5c12e407d3ea10d3b2363f/compiler%2Frustc_resolve%2Fsrc%2Fimports.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Fimports.rs?ref=177572241076e4885c5c12e407d3ea10d3b2363f", "patch": "@@ -423,13 +423,17 @@ impl<'a, 'tcx> Resolver<'a, 'tcx> {\n     /// Resolves all imports for the crate. This method performs the fixed-\n     /// point iteration.\n     pub(crate) fn resolve_imports(&mut self) {\n-        let mut prev_num_indeterminates = self.indeterminate_imports.len() + 1;\n-        while self.indeterminate_imports.len() < prev_num_indeterminates {\n-            prev_num_indeterminates = self.indeterminate_imports.len();\n+        let mut prev_indeterminate_count = usize::MAX;\n+        let mut indeterminate_count = self.indeterminate_imports.len() * 3;\n+        while indeterminate_count < prev_indeterminate_count {\n+            prev_indeterminate_count = indeterminate_count;\n+            indeterminate_count = 0;\n             for import in mem::take(&mut self.indeterminate_imports) {\n-                match self.resolve_import(&import) {\n-                    true => self.determined_imports.push(import),\n-                    false => self.indeterminate_imports.push(import),\n+                let import_indeterminate_count = self.resolve_import(&import);\n+                indeterminate_count += import_indeterminate_count;\n+                match import_indeterminate_count {\n+                    0 => self.determined_imports.push(import),\n+                    _ => self.indeterminate_imports.push(import),\n                 }\n             }\n         }\n@@ -581,9 +585,13 @@ impl<'a, 'tcx> Resolver<'a, 'tcx> {\n         diag.emit();\n     }\n \n-    /// Attempts to resolve the given import, returning true if its resolution is determined.\n-    /// If successful, the resolved bindings are written into the module.\n-    fn resolve_import(&mut self, import: &'a Import<'a>) -> bool {\n+    /// Attempts to resolve the given import, returning:\n+    /// - `0` means its resolution is determined.\n+    /// - Other values mean that indeterminate exists under certain namespaces.\n+    ///\n+    /// Meanwhile, if resolve successful, the resolved bindings are written\n+    /// into the module.\n+    fn resolve_import(&mut self, import: &'a Import<'a>) -> usize {\n         debug!(\n             \"(resolving import for module) resolving import `{}::...` in `{}`\",\n             Segment::names_to_string(&import.module_path),\n@@ -601,8 +609,8 @@ impl<'a, 'tcx> Resolver<'a, 'tcx> {\n \n             match path_res {\n                 PathResult::Module(module) => module,\n-                PathResult::Indeterminate => return false,\n-                PathResult::NonModule(..) | PathResult::Failed { .. } => return true,\n+                PathResult::Indeterminate => return 3,\n+                PathResult::NonModule(..) | PathResult::Failed { .. } => return 0,\n             }\n         };\n \n@@ -618,12 +626,12 @@ impl<'a, 'tcx> Resolver<'a, 'tcx> {\n             } => (source, target, source_bindings, target_bindings, type_ns_only),\n             ImportKind::Glob { .. } => {\n                 self.resolve_glob_import(import);\n-                return true;\n+                return 0;\n             }\n             _ => unreachable!(),\n         };\n \n-        let mut indeterminate = false;\n+        let mut indeterminate_count = 0;\n         self.per_ns(|this, ns| {\n             if !type_ns_only || ns == TypeNS {\n                 if let Err(Undetermined) = source_bindings[ns].get() {\n@@ -646,7 +654,7 @@ impl<'a, 'tcx> Resolver<'a, 'tcx> {\n \n                 let parent = import.parent_scope.module;\n                 match source_bindings[ns].get() {\n-                    Err(Undetermined) => indeterminate = true,\n+                    Err(Undetermined) => indeterminate_count += 1,\n                     // Don't update the resolution, because it was never added.\n                     Err(Determined) if target.name == kw::Underscore => {}\n                     Ok(binding) if binding.is_importable() => {\n@@ -670,7 +678,7 @@ impl<'a, 'tcx> Resolver<'a, 'tcx> {\n             }\n         });\n \n-        !indeterminate\n+        indeterminate_count\n     }\n \n     /// Performs final import resolution, consistency checks and error reporting."}, {"sha": "21aa81e80926ead1252b83b6cf06c2295fc3c943", "filename": "tests/ui/macros/nested-use-as.rs", "status": "added", "additions": 83, "deletions": 0, "changes": 83, "blob_url": "https://github.com/rust-lang/rust/blob/177572241076e4885c5c12e407d3ea10d3b2363f/tests%2Fui%2Fmacros%2Fnested-use-as.rs", "raw_url": "https://github.com/rust-lang/rust/raw/177572241076e4885c5c12e407d3ea10d3b2363f/tests%2Fui%2Fmacros%2Fnested-use-as.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmacros%2Fnested-use-as.rs?ref=177572241076e4885c5c12e407d3ea10d3b2363f", "patch": "@@ -0,0 +1,83 @@\n+// check-pass\n+// edition:2018\n+// issue: https://github.com/rust-lang/rust/issues/97534\n+\n+macro_rules! m {\n+    () => {\n+        macro_rules! foo {\n+            () => {}\n+        }\n+        use foo as bar;\n+    }\n+}\n+\n+m!{}\n+\n+use bar as baz;\n+\n+baz!{}\n+\n+macro_rules! foo2 {\n+    () => {};\n+}\n+\n+macro_rules! m2 {\n+    () => {\n+        use foo2 as bar2;\n+    };\n+}\n+\n+m2! {}\n+\n+use bar2 as baz2;\n+\n+baz2! {}\n+\n+macro_rules! n1 {\n+    () => {\n+        macro_rules! n2 {\n+            () => {\n+                macro_rules! n3 {\n+                    () => {\n+                        macro_rules! n4 {\n+                            () => {}\n+                        }\n+                        use n4 as c4;\n+                    }\n+                }\n+                use n3 as c3;\n+            }\n+        }\n+        use n2 as c2;\n+    }\n+}\n+\n+use n1 as c1;\n+c1!{}\n+use c2 as a2;\n+a2!{}\n+use c3 as a3;\n+a3!{}\n+use c4 as a4;\n+a4!{}\n+\n+// https://github.com/rust-lang/rust/pull/108729#issuecomment-1474750675\n+// reversed\n+use d5 as d6;\n+use d4 as d5;\n+use d3 as d4;\n+use d2 as d3;\n+use d1 as d2;\n+use foo2 as d1;\n+d6! {}\n+\n+// mess\n+use f3 as f4;\n+f5! {}\n+use f1 as f2;\n+use f4 as f5;\n+use f2 as f3;\n+use foo2 as f1;\n+\n+fn main() {\n+}"}]}