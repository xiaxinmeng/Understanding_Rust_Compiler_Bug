{"sha": "7b43cfc9b25ac4a906bd56d32d3111085dd9e6a1", "node_id": "C_kwDOAAsO6NoAKDdiNDNjZmM5YjI1YWM0YTkwNmJkNTZkMzJkMzExMTA4NWRkOWU2YTE", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-02-06T21:41:00Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-02-06T21:41:00Z"}, "message": "Auto merge of #93695 - matthiaskrgr:rollup-zslgooo, r=matthiaskrgr\n\nRollup of 2 pull requests\n\nSuccessful merges:\n\n - #90998 (Require const stability attribute on all stable functions that are `const`)\n - #93489 (Mark the panic_no_unwind lang item as nounwind)\n\nFailed merges:\n\nr? `@ghost`\n`@rustbot` modify labels: rollup", "tree": {"sha": "d3b9c5eb4d6d84b7fb81d24b4c7371cf667c9f8b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d3b9c5eb4d6d84b7fb81d24b4c7371cf667c9f8b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7b43cfc9b25ac4a906bd56d32d3111085dd9e6a1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7b43cfc9b25ac4a906bd56d32d3111085dd9e6a1", "html_url": "https://github.com/rust-lang/rust/commit/7b43cfc9b25ac4a906bd56d32d3111085dd9e6a1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7b43cfc9b25ac4a906bd56d32d3111085dd9e6a1/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f624427f8771c00819684c783bb841bf72095704", "url": "https://api.github.com/repos/rust-lang/rust/commits/f624427f8771c00819684c783bb841bf72095704", "html_url": "https://github.com/rust-lang/rust/commit/f624427f8771c00819684c783bb841bf72095704"}, {"sha": "4695c2157c394ff00bf624adbc8ac566d4b7c791", "url": "https://api.github.com/repos/rust-lang/rust/commits/4695c2157c394ff00bf624adbc8ac566d4b7c791", "html_url": "https://github.com/rust-lang/rust/commit/4695c2157c394ff00bf624adbc8ac566d4b7c791"}], "stats": {"total": 88, "additions": 62, "deletions": 26}, "files": [{"sha": "136059677c5ae94a80203d3768b13ee63901dc90", "filename": "compiler/rustc_passes/src/stability.rs", "status": "modified", "additions": 18, "deletions": 18, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/7b43cfc9b25ac4a906bd56d32d3111085dd9e6a1/compiler%2Frustc_passes%2Fsrc%2Fstability.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7b43cfc9b25ac4a906bd56d32d3111085dd9e6a1/compiler%2Frustc_passes%2Fsrc%2Fstability.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fstability.rs?ref=7b43cfc9b25ac4a906bd56d32d3111085dd9e6a1", "patch": "@@ -577,17 +577,21 @@ impl<'tcx> MissingStabilityAnnotations<'tcx> {\n     }\n \n     fn check_missing_const_stability(&self, def_id: LocalDefId, span: Span) {\n-        let stab_map = self.tcx.stability();\n-        let stab = stab_map.local_stability(def_id);\n-        if stab.map_or(false, |stab| stab.level.is_stable()) {\n-            let const_stab = stab_map.local_const_stability(def_id);\n-            if const_stab.is_none() {\n-                self.tcx.sess.span_err(\n-                    span,\n-                    \"`#[stable]` const functions must also be either \\\n-                    `#[rustc_const_stable]` or `#[rustc_const_unstable]`\",\n-                );\n-            }\n+        if !self.tcx.features().staged_api {\n+            return;\n+        }\n+\n+        let is_const = self.tcx.is_const_fn(def_id.to_def_id());\n+        let is_stable = self\n+            .tcx\n+            .lookup_stability(def_id)\n+            .map_or(false, |stability| stability.level.is_stable());\n+        let missing_const_stability_attribute = self.tcx.lookup_const_stability(def_id).is_none();\n+        let is_reachable = self.access_levels.is_reachable(def_id);\n+\n+        if is_const && is_stable && missing_const_stability_attribute && is_reachable {\n+            let descr = self.tcx.def_kind(def_id).descr(def_id.to_def_id());\n+            self.tcx.sess.span_err(span, &format!(\"{descr} has missing const stability attribute\"));\n         }\n     }\n }\n@@ -612,13 +616,8 @@ impl<'tcx> Visitor<'tcx> for MissingStabilityAnnotations<'tcx> {\n             self.check_missing_stability(i.def_id, i.span);\n         }\n \n-        // Ensure `const fn` that are `stable` have one of `rustc_const_unstable` or\n-        // `rustc_const_stable`.\n-        if self.tcx.features().staged_api\n-            && matches!(&i.kind, hir::ItemKind::Fn(sig, ..) if sig.header.is_const())\n-        {\n-            self.check_missing_const_stability(i.def_id, i.span);\n-        }\n+        // Ensure stable `const fn` have a const stability attribute.\n+        self.check_missing_const_stability(i.def_id, i.span);\n \n         intravisit::walk_item(self, i)\n     }\n@@ -632,6 +631,7 @@ impl<'tcx> Visitor<'tcx> for MissingStabilityAnnotations<'tcx> {\n         let impl_def_id = self.tcx.hir().get_parent_item(ii.hir_id());\n         if self.tcx.impl_trait_ref(impl_def_id).is_none() {\n             self.check_missing_stability(ii.def_id, ii.span);\n+            self.check_missing_const_stability(ii.def_id, ii.span);\n         }\n         intravisit::walk_impl_item(self, ii);\n     }"}, {"sha": "7c8a47d5d65244fc13d53fe80382bce6b8c45b5e", "filename": "compiler/rustc_typeck/src/collect.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/7b43cfc9b25ac4a906bd56d32d3111085dd9e6a1/compiler%2Frustc_typeck%2Fsrc%2Fcollect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7b43cfc9b25ac4a906bd56d32d3111085dd9e6a1/compiler%2Frustc_typeck%2Fsrc%2Fcollect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcollect.rs?ref=7b43cfc9b25ac4a906bd56d32d3111085dd9e6a1", "patch": "@@ -2778,6 +2778,13 @@ fn codegen_fn_attrs(tcx: TyCtxt<'_>, id: DefId) -> CodegenFnAttrs {\n         }\n     }\n \n+    // The panic_no_unwind function called by TerminatorKind::Abort will never\n+    // unwind. If the panic handler that it invokes unwind then it will simply\n+    // call the panic handler again.\n+    if Some(id) == tcx.lang_items().panic_no_unwind() {\n+        codegen_fn_attrs.flags |= CodegenFnAttrFlags::NEVER_UNWIND;\n+    }\n+\n     let supported_target_features = tcx.supported_target_features(LOCAL_CRATE);\n \n     let mut inline_span = None;"}, {"sha": "ee79021ed536e69555e6a8ba2c470549143fd7e8", "filename": "library/core/src/array/mod.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7b43cfc9b25ac4a906bd56d32d3111085dd9e6a1/library%2Fcore%2Fsrc%2Farray%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7b43cfc9b25ac4a906bd56d32d3111085dd9e6a1/library%2Fcore%2Fsrc%2Farray%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Farray%2Fmod.rs?ref=7b43cfc9b25ac4a906bd56d32d3111085dd9e6a1", "patch": "@@ -512,6 +512,7 @@ impl<T, const N: usize> [T; N] {\n \n     /// Returns a slice containing the entire array. Equivalent to `&s[..]`.\n     #[stable(feature = \"array_as_slice\", since = \"1.57.0\")]\n+    #[rustc_const_stable(feature = \"array_as_slice\", since = \"1.57.0\")]\n     pub const fn as_slice(&self) -> &[T] {\n         self\n     }"}, {"sha": "feb9455565844ae5ae127568fb80eae4bc6ee170", "filename": "library/core/src/cell.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7b43cfc9b25ac4a906bd56d32d3111085dd9e6a1/library%2Fcore%2Fsrc%2Fcell.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7b43cfc9b25ac4a906bd56d32d3111085dd9e6a1/library%2Fcore%2Fsrc%2Fcell.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fcell.rs?ref=7b43cfc9b25ac4a906bd56d32d3111085dd9e6a1", "patch": "@@ -1959,6 +1959,7 @@ impl<T: ?Sized> UnsafeCell<T> {\n     /// ```\n     #[inline(always)]\n     #[stable(feature = \"unsafe_cell_raw_get\", since = \"1.56.0\")]\n+    #[rustc_const_stable(feature = \"unsafe_cell_raw_get\", since = \"1.56.0\")]\n     pub const fn raw_get(this: *const Self) -> *mut T {\n         // We can just cast the pointer from `UnsafeCell<T>` to `T` because of\n         // #[repr(transparent)]. This exploits libstd's special status, there is"}, {"sha": "c5e8408d904eec23dd486b6cd4831799f0e555b3", "filename": "library/core/src/num/int_macros.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7b43cfc9b25ac4a906bd56d32d3111085dd9e6a1/library%2Fcore%2Fsrc%2Fnum%2Fint_macros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7b43cfc9b25ac4a906bd56d32d3111085dd9e6a1/library%2Fcore%2Fsrc%2Fnum%2Fint_macros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fnum%2Fint_macros.rs?ref=7b43cfc9b25ac4a906bd56d32d3111085dd9e6a1", "patch": "@@ -1064,6 +1064,7 @@ macro_rules! int_impl {\n         ///\n         /// ```\n         #[stable(feature = \"saturating_div\", since = \"1.58.0\")]\n+        #[rustc_const_stable(feature = \"saturating_div\", since = \"1.58.0\")]\n         #[must_use = \"this returns the result of the operation, \\\n                       without modifying the original\"]\n         #[inline]"}, {"sha": "1ebd1c58f2b59dc3b8b02e743becc57cc17b6ed3", "filename": "library/core/src/num/nonzero.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7b43cfc9b25ac4a906bd56d32d3111085dd9e6a1/library%2Fcore%2Fsrc%2Fnum%2Fnonzero.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7b43cfc9b25ac4a906bd56d32d3111085dd9e6a1/library%2Fcore%2Fsrc%2Fnum%2Fnonzero.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fnum%2Fnonzero.rs?ref=7b43cfc9b25ac4a906bd56d32d3111085dd9e6a1", "patch": "@@ -972,6 +972,7 @@ macro_rules! nonzero_unsigned_is_power_of_two {\n                 /// ```\n                 #[must_use]\n                 #[stable(feature = \"nonzero_is_power_of_two\", since = \"1.59.0\")]\n+                #[rustc_const_stable(feature = \"nonzero_is_power_of_two\", since = \"1.59.0\")]\n                 #[inline]\n                 pub const fn is_power_of_two(self) -> bool {\n                     // LLVM 11 normalizes `unchecked_sub(x, 1) & x == 0` to the implementation seen here."}, {"sha": "052db4e3b3d13907b15d9011aa9483900bd20ab1", "filename": "library/core/src/num/uint_macros.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7b43cfc9b25ac4a906bd56d32d3111085dd9e6a1/library%2Fcore%2Fsrc%2Fnum%2Fuint_macros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7b43cfc9b25ac4a906bd56d32d3111085dd9e6a1/library%2Fcore%2Fsrc%2Fnum%2Fuint_macros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fnum%2Fuint_macros.rs?ref=7b43cfc9b25ac4a906bd56d32d3111085dd9e6a1", "patch": "@@ -1132,6 +1132,7 @@ macro_rules! uint_impl {\n         ///\n         /// ```\n         #[stable(feature = \"saturating_div\", since = \"1.58.0\")]\n+        #[rustc_const_stable(feature = \"saturating_div\", since = \"1.58.0\")]\n         #[must_use = \"this returns the result of the operation, \\\n                       without modifying the original\"]\n         #[inline]"}, {"sha": "be8598fae09d793a8859a0e9dac14e2cd9fa3dbe", "filename": "library/core/src/panic/panic_info.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/7b43cfc9b25ac4a906bd56d32d3111085dd9e6a1/library%2Fcore%2Fsrc%2Fpanic%2Fpanic_info.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7b43cfc9b25ac4a906bd56d32d3111085dd9e6a1/library%2Fcore%2Fsrc%2Fpanic%2Fpanic_info.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fpanic%2Fpanic_info.rs?ref=7b43cfc9b25ac4a906bd56d32d3111085dd9e6a1", "patch": "@@ -136,6 +136,10 @@ impl<'a> PanicInfo<'a> {\n     /// This is true for most kinds of panics with the exception of panics\n     /// caused by trying to unwind out of a `Drop` implementation or a function\n     /// whose ABI does not support unwinding.\n+    ///\n+    /// It is safe for a panic handler to unwind even when this function returns\n+    /// true, however this will simply cause the panic handler to be called\n+    /// again.\n     #[must_use]\n     #[unstable(feature = \"panic_can_unwind\", issue = \"92988\")]\n     pub fn can_unwind(&self) -> bool {"}, {"sha": "57e64737d0faa53ae4f203234006c37f9761ab9b", "filename": "src/test/ui/stability-attribute/missing-const-stability.rs", "status": "modified", "additions": 20, "deletions": 6, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/7b43cfc9b25ac4a906bd56d32d3111085dd9e6a1/src%2Ftest%2Fui%2Fstability-attribute%2Fmissing-const-stability.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7b43cfc9b25ac4a906bd56d32d3111085dd9e6a1/src%2Ftest%2Fui%2Fstability-attribute%2Fmissing-const-stability.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fstability-attribute%2Fmissing-const-stability.rs?ref=7b43cfc9b25ac4a906bd56d32d3111085dd9e6a1", "patch": "@@ -1,12 +1,26 @@\n #![feature(staged_api)]\n+#![feature(const_trait_impl)]\n+#![stable(feature = \"stable\", since = \"1.0.0\")]\n \n-#![stable(feature = \"rust1\", since = \"1.0.0\")]\n+#[stable(feature = \"stable\", since = \"1.0.0\")]\n+pub const fn foo() {} //~ ERROR function has missing const stability attribute\n \n-#[stable(feature = \"foo\", since = \"1.0.0\")]\n-pub const fn foo() {}\n-//~^ ERROR rustc_const_stable\n+#[unstable(feature = \"unstable\", issue = \"none\")]\n+pub const fn bar() {} // ok because function is unstable\n \n-#[unstable(feature = \"bar\", issue = \"none\")]\n-pub const fn bar() {} // ok\n+#[stable(feature = \"stable\", since = \"1.0.0\")]\n+pub struct Foo;\n+impl Foo {\n+    #[stable(feature = \"stable\", since = \"1.0.0\")]\n+    pub const fn foo() {} //~ ERROR associated function has missing const stability attribute\n+\n+    #[unstable(feature = \"unstable\", issue = \"none\")]\n+    pub const fn bar() {} // ok because function is unstable\n+}\n+\n+// FIXME Once #![feature(const_trait_impl)] is allowed to be stable, add a test\n+// for const trait impls. Right now, a \"trait methods cannot be stable const fn\"\n+// error is emitted. This occurs prior to the lint being tested here, such that\n+// the lint cannot currently be tested on this use case.\n \n fn main() {}"}, {"sha": "7eba99a477abe0ed5a14f5933d3546c591e907a5", "filename": "src/test/ui/stability-attribute/missing-const-stability.stderr", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/7b43cfc9b25ac4a906bd56d32d3111085dd9e6a1/src%2Ftest%2Fui%2Fstability-attribute%2Fmissing-const-stability.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/7b43cfc9b25ac4a906bd56d32d3111085dd9e6a1/src%2Ftest%2Fui%2Fstability-attribute%2Fmissing-const-stability.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fstability-attribute%2Fmissing-const-stability.stderr?ref=7b43cfc9b25ac4a906bd56d32d3111085dd9e6a1", "patch": "@@ -1,8 +1,14 @@\n-error: `#[stable]` const functions must also be either `#[rustc_const_stable]` or `#[rustc_const_unstable]`\n+error: function has missing const stability attribute\n   --> $DIR/missing-const-stability.rs:6:1\n    |\n LL | pub const fn foo() {}\n    | ^^^^^^^^^^^^^^^^^^^^^\n \n-error: aborting due to previous error\n+error: associated function has missing const stability attribute\n+  --> $DIR/missing-const-stability.rs:15:5\n+   |\n+LL |     pub const fn foo() {}\n+   |     ^^^^^^^^^^^^^^^^^^^^^\n+\n+error: aborting due to 2 previous errors\n "}]}