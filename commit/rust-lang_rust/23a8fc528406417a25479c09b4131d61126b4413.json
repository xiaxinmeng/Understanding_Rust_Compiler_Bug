{"sha": "23a8fc528406417a25479c09b4131d61126b4413", "node_id": "MDY6Q29tbWl0NzI0NzEyOjIzYThmYzUyODQwNjQxN2EyNTQ3OWMwOWI0MTMxZDYxMTI2YjQ0MTM=", "commit": {"author": {"name": "Lauren\u021biu Nicola", "email": "lnicola@dend.ro", "date": "2021-02-20T16:39:26Z"}, "committer": {"name": "Lauren\u021biu Nicola", "email": "lnicola@dend.ro", "date": "2021-02-20T16:44:28Z"}, "message": "Try to detect musl distros in the Code extension", "tree": {"sha": "c3658151be61adcf93c94c06516a6e0b8d36f207", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c3658151be61adcf93c94c06516a6e0b8d36f207"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/23a8fc528406417a25479c09b4131d61126b4413", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/23a8fc528406417a25479c09b4131d61126b4413", "html_url": "https://github.com/rust-lang/rust/commit/23a8fc528406417a25479c09b4131d61126b4413", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/23a8fc528406417a25479c09b4131d61126b4413/comments", "author": {"login": "lnicola", "id": 308347, "node_id": "MDQ6VXNlcjMwODM0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/308347?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lnicola", "html_url": "https://github.com/lnicola", "followers_url": "https://api.github.com/users/lnicola/followers", "following_url": "https://api.github.com/users/lnicola/following{/other_user}", "gists_url": "https://api.github.com/users/lnicola/gists{/gist_id}", "starred_url": "https://api.github.com/users/lnicola/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lnicola/subscriptions", "organizations_url": "https://api.github.com/users/lnicola/orgs", "repos_url": "https://api.github.com/users/lnicola/repos", "events_url": "https://api.github.com/users/lnicola/events{/privacy}", "received_events_url": "https://api.github.com/users/lnicola/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lnicola", "id": 308347, "node_id": "MDQ6VXNlcjMwODM0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/308347?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lnicola", "html_url": "https://github.com/lnicola", "followers_url": "https://api.github.com/users/lnicola/followers", "following_url": "https://api.github.com/users/lnicola/following{/other_user}", "gists_url": "https://api.github.com/users/lnicola/gists{/gist_id}", "starred_url": "https://api.github.com/users/lnicola/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lnicola/subscriptions", "organizations_url": "https://api.github.com/users/lnicola/orgs", "repos_url": "https://api.github.com/users/lnicola/repos", "events_url": "https://api.github.com/users/lnicola/events{/privacy}", "received_events_url": "https://api.github.com/users/lnicola/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "de67469f59d5c16e9b4ca106a0265bb8b1585c83", "url": "https://api.github.com/repos/rust-lang/rust/commits/de67469f59d5c16e9b4ca106a0265bb8b1585c83", "html_url": "https://github.com/rust-lang/rust/commit/de67469f59d5c16e9b4ca106a0265bb8b1585c83"}], "stats": {"total": 14, "additions": 12, "deletions": 2}, "files": [{"sha": "00393d6e8f2302efdbda452763dcec5d5385806f", "filename": "editors/code/src/main.ts", "status": "modified", "additions": 12, "deletions": 2, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/23a8fc528406417a25479c09b4131d61126b4413/editors%2Fcode%2Fsrc%2Fmain.ts", "raw_url": "https://github.com/rust-lang/rust/raw/23a8fc528406417a25479c09b4131d61126b4413/editors%2Fcode%2Fsrc%2Fmain.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fmain.ts?ref=23a8fc528406417a25479c09b4131d61126b4413", "patch": "@@ -12,7 +12,7 @@ import { PersistentState } from './persistent_state';\n import { fetchRelease, download } from './net';\n import { activateTaskProvider } from './tasks';\n import { setContextValue } from './util';\n-import { exec } from 'child_process';\n+import { exec, spawnSync } from 'child_process';\n \n let ctx: Ctx | undefined;\n \n@@ -297,7 +297,7 @@ async function getServer(config: Config, state: PersistentState): Promise<string\n         \"arm64 linux\": \"aarch64-unknown-linux-gnu\",\n         \"arm64 darwin\": \"aarch64-apple-darwin\",\n     };\n-    const platform = platforms[`${process.arch} ${process.platform}`];\n+    let platform = platforms[`${process.arch} ${process.platform}`];\n     if (platform === undefined) {\n         await vscode.window.showErrorMessage(\n             \"Unfortunately we don't ship binaries for your platform yet. \" +\n@@ -309,6 +309,9 @@ async function getServer(config: Config, state: PersistentState): Promise<string\n         );\n         return undefined;\n     }\n+    if (platform === \"x86_64-unknown-linux-gnu\" && isMusl()) {\n+        platform = \"x86_64-unknown-linux-musl\";\n+    }\n     const ext = platform.indexOf(\"-windows-\") !== -1 ? \".exe\" : \"\";\n     const dest = path.join(config.globalStoragePath, `rust-analyzer-${platform}${ext}`);\n     const exists = await fs.stat(dest).then(() => true, () => false);\n@@ -365,6 +368,13 @@ async function isNixOs(): Promise<boolean> {\n     }\n }\n \n+function isMusl(): boolean {\n+    // We can detect Alpine by checking `/etc/os-release` but not Void Linux musl.\n+    // Instead, we run `ldd` since it advertises the libc which it belongs to.\n+    const res = spawnSync(\"ldd\", [\"--version\"]);\n+    return res.stderr != null && res.stderr.indexOf(\"musl libc\") >= 0;\n+}\n+\n async function downloadWithRetryDialog<T>(state: PersistentState, downloadFunc: () => Promise<T>): Promise<T> {\n     while (true) {\n         try {"}]}