{"sha": "d20ff927475a072529e4f11740bbd23611ed9045", "node_id": "C_kwDOAAsO6NoAKGQyMGZmOTI3NDc1YTA3MjUyOWU0ZjExNzQwYmJkMjM2MTFlZDkwNDU", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2022-02-02T11:20:38Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-02-02T11:20:38Z"}, "message": "Merge #11395\n\n11395: fix: Fix and re-enable format string completions r=Veykril a=Veykril\n\nbors r+\n\nCo-authored-by: Lukas Wirth <lukastw97@gmail.com>", "tree": {"sha": "a5b325a88500f0612b06b2736c70de1690a3f656", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a5b325a88500f0612b06b2736c70de1690a3f656"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d20ff927475a072529e4f11740bbd23611ed9045", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJh+mkGCRBK7hj4Ov3rIwAAAQ4IAJdd2Que42MA/D49OtW1QPpS\niRZlX78PeX6gmbckzy5V1s9AO/XK8su8zRGEQyAKKkWY8+krWScKufcQLiZvKELY\nm2YSCFt8f5s+aJRutcH171ixWqbUBnvMDKJmmLRxMCf62Tg2ErM7nT1nUnIPswz/\nEJdLu8bStYc0MO7DoThFVChokEK9oa4tHbYPGYVeFhEzeZ1RkbF+aTHzV0sjowpW\nG+OyTLFQGVh/z93suuxLNPHQf7MvUWjq9DOqFAgLrCl5xBlKtM7Ggecu2qsRAA8h\nltDvCIccmDaAMEdjPS6qFnkW0xiupIdEEF0dQfhmuVi0fJ7g6Ou48h78a4kUJ3w=\n=v20j\n-----END PGP SIGNATURE-----\n", "payload": "tree a5b325a88500f0612b06b2736c70de1690a3f656\nparent 34138379b5945616e51b3822769628b252c7a4f5\nparent 6f974cf477080bbe987730189be51a1da1419e75\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1643800838 +0000\ncommitter GitHub <noreply@github.com> 1643800838 +0000\n\nMerge #11395\n\n11395: fix: Fix and re-enable format string completions r=Veykril a=Veykril\n\nbors r+\n\nCo-authored-by: Lukas Wirth <lukastw97@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d20ff927475a072529e4f11740bbd23611ed9045", "html_url": "https://github.com/rust-lang/rust/commit/d20ff927475a072529e4f11740bbd23611ed9045", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d20ff927475a072529e4f11740bbd23611ed9045/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "34138379b5945616e51b3822769628b252c7a4f5", "url": "https://api.github.com/repos/rust-lang/rust/commits/34138379b5945616e51b3822769628b252c7a4f5", "html_url": "https://github.com/rust-lang/rust/commit/34138379b5945616e51b3822769628b252c7a4f5"}, {"sha": "6f974cf477080bbe987730189be51a1da1419e75", "url": "https://api.github.com/repos/rust-lang/rust/commits/6f974cf477080bbe987730189be51a1da1419e75", "html_url": "https://github.com/rust-lang/rust/commit/6f974cf477080bbe987730189be51a1da1419e75"}], "stats": {"total": 129, "additions": 74, "deletions": 55}, "files": [{"sha": "6b6759ebfd9570992213bde2799574393c9abde8", "filename": "crates/ide_completion/src/completions/attribute.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d20ff927475a072529e4f11740bbd23611ed9045/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fattribute.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d20ff927475a072529e4f11740bbd23611ed9045/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fattribute.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fattribute.rs?ref=d20ff927475a072529e4f11740bbd23611ed9045", "patch": "@@ -62,6 +62,7 @@ pub(crate) fn complete_attribute(acc: &mut Completions, ctx: &CompletionContext)\n     Some(())\n }\n \n+// FIXME?: Move this functionality to (un)qualified_path, make this module work solely for builtin/known attributes for their inputs?\n fn complete_new_attribute(acc: &mut Completions, ctx: &CompletionContext, attribute: &ast::Attr) {\n     let is_inner = attribute.kind() == ast::AttrKind::Inner;\n     let attribute_annotated_item_kind ="}, {"sha": "87052d020a4379251c52c247793fbe404a122454", "filename": "crates/ide_completion/src/completions/format_string.rs", "status": "modified", "additions": 73, "deletions": 55, "changes": 128, "blob_url": "https://github.com/rust-lang/rust/blob/d20ff927475a072529e4f11740bbd23611ed9045/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fformat_string.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d20ff927475a072529e4f11740bbd23611ed9045/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fformat_string.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fformat_string.rs?ref=d20ff927475a072529e4f11740bbd23611ed9045", "patch": "@@ -8,15 +8,14 @@ use crate::{context::CompletionContext, CompletionItem, CompletionItemKind, Comp\n \n /// Complete identifiers in format strings.\n pub(crate) fn format_string(acc: &mut Completions, ctx: &CompletionContext) {\n-    if true {\n-        return;\n-    }\n-    let string = match ast::String::cast(ctx.token.clone()) {\n-        Some(it) if is_format_string(&it) => it,\n+    let string = match ast::String::cast(ctx.token.clone())\n+        .zip(ast::String::cast(ctx.original_token.clone()))\n+    {\n+        Some((expanded, original)) if is_format_string(&expanded) => original,\n         _ => return,\n     };\n     let cursor = ctx.position.offset;\n-    let lit_start = ctx.token.text_range().start();\n+    let lit_start = ctx.original_token.text_range().start();\n     let cursor_in_lit = cursor - lit_start;\n \n     let prefix = &string.text()[..cursor_in_lit.into()];\n@@ -39,72 +38,91 @@ pub(crate) fn format_string(acc: &mut Completions, ctx: &CompletionContext) {\n mod tests {\n     use expect_test::{expect, Expect};\n \n-    use crate::tests::completion_list_no_kw;\n+    use crate::tests::{check_edit, completion_list_no_kw};\n \n     fn check(ra_fixture: &str, expect: Expect) {\n         let actual = completion_list_no_kw(ra_fixture);\n         expect.assert_eq(&actual);\n     }\n \n+    #[test]\n+    fn works_when_wrapped() {\n+        check(\n+            r#\"\n+macro_rules! format_args {\n+    ($lit:literal $(tt:tt)*) => { 0 },\n+}\n+macro_rules! print {\n+    ($($arg:tt)*) => (std::io::_print(format_args!($($arg)*)));\n+}\n+fn main() {\n+    let foobar = 1;\n+    print!(\"f$0\");\n+}\n+\"#,\n+            expect![[]],\n+        );\n+    }\n+\n     #[test]\n     fn no_completion_without_brace() {\n         check(\n             r#\"\n macro_rules! format_args {\n-($lit:literal $(tt:tt)*) => { 0 },\n+    ($lit:literal $(tt:tt)*) => { 0 },\n }\n fn main() {\n-let foobar = 1;\n-format_args!(\"f$0\");\n+    let foobar = 1;\n+    format_args!(\"f$0\");\n }\n \"#,\n             expect![[]],\n         );\n     }\n \n-    //     #[test]\n-    //     fn completes_locals() {\n-    //         check_edit(\n-    //             \"foobar\",\n-    //             r#\"\n-    // macro_rules! format_args {\n-    //     ($lit:literal $(tt:tt)*) => { 0 },\n-    // }\n-    // fn main() {\n-    //     let foobar = 1;\n-    //     format_args!(\"{f$0\");\n-    // }\n-    // \"#,\n-    //             r#\"\n-    // macro_rules! format_args {\n-    //     ($lit:literal $(tt:tt)*) => { 0 },\n-    // }\n-    // fn main() {\n-    //     let foobar = 1;\n-    //     format_args!(\"{foobar\");\n-    // }\n-    // \"#,\n-    //         );\n-    //         check_edit(\n-    //             \"foobar\",\n-    //             r#\"\n-    // macro_rules! format_args {\n-    //     ($lit:literal $(tt:tt)*) => { 0 },\n-    // }\n-    // fn main() {\n-    //     let foobar = 1;\n-    //     format_args!(\"{$0\");\n-    // }\n-    // \"#,\n-    //             r#\"\n-    // macro_rules! format_args {\n-    //     ($lit:literal $(tt:tt)*) => { 0 },\n-    // }\n-    // fn main() {\n-    //     let foobar = 1;\n-    //     format_args!(\"{foobar\");\n-    // }\n-    // \"#,\n-    //         );\n-    //     }\n+    #[test]\n+    fn completes_locals() {\n+        check_edit(\n+            \"foobar\",\n+            r#\"\n+macro_rules! format_args {\n+    ($lit:literal $(tt:tt)*) => { 0 },\n+}\n+fn main() {\n+    let foobar = 1;\n+    format_args!(\"{f$0\");\n+}\n+\"#,\n+            r#\"\n+macro_rules! format_args {\n+    ($lit:literal $(tt:tt)*) => { 0 },\n+}\n+fn main() {\n+    let foobar = 1;\n+    format_args!(\"{foobar\");\n+}\n+\"#,\n+        );\n+        check_edit(\n+            \"foobar\",\n+            r#\"\n+macro_rules! format_args {\n+    ($lit:literal $(tt:tt)*) => { 0 },\n+}\n+fn main() {\n+    let foobar = 1;\n+    format_args!(\"{$0\");\n+}\n+\"#,\n+            r#\"\n+macro_rules! format_args {\n+    ($lit:literal $(tt:tt)*) => { 0 },\n+}\n+fn main() {\n+    let foobar = 1;\n+    format_args!(\"{foobar\");\n+}\n+\"#,\n+        );\n+    }\n }"}]}