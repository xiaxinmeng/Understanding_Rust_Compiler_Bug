{"sha": "e1541bda940ca8c06e9bc134aab64ccbf9e6c225", "node_id": "C_kwDOAAsO6NoAKGUxNTQxYmRhOTQwY2E4YzA2ZTliYzEzNGFhYjY0Y2NiZjllNmMyMjU", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2022-02-25T17:41:05Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-02-25T17:41:05Z"}, "message": "Merge #11552\n\n11552: fix: properly display `$crate` in hovers r=jonas-schievink a=jonas-schievink\n\nWe used to print it as `{extern_crate}`, this PR resolves it to the crate's name, or falls back to `$crate` if the crate has no name.\r\n\r\nbors r+\n\nCo-authored-by: Jonas Schievink <jonas.schievink@ferrous-systems.com>", "tree": {"sha": "81ec5a9d2f7bf5adf7e5731050665753a8dbea5e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/81ec5a9d2f7bf5adf7e5731050665753a8dbea5e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e1541bda940ca8c06e9bc134aab64ccbf9e6c225", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJiGRSxCRBK7hj4Ov3rIwAAfB8IAAuE2kdDPi7AYlbPCRQQhYrN\n7bLIgv5+mVRlQgI9NPCgx7X9Y0+Y/+PUCiHYTavj14uMn805+x5WRPvwJV7cQq6U\n/qHtZ1PxfCcBZ6mQCY4+WtRKcVxdeAVgocVaB81hZIIWjNVHFoH3Q9X+T6SFA+i7\nCQeriSZasb2H6bQMxAeZCzt7u46x/PX6EIprLb4MMTpza42squCXO6ms3XIFDUVJ\nW0yKkAXXp8PzI/SFO2Uyvo+ICLeRP14WYwYkINie3ZQk0wWAey7qejaFxRe6YRxs\nqO3bJxzCjtrhDs9KM1RZK+rvyJq+OFcnMQahhiiXCyPrYQ5aKrUh0U+PXu/g4gk=\n=DAYg\n-----END PGP SIGNATURE-----\n", "payload": "tree 81ec5a9d2f7bf5adf7e5731050665753a8dbea5e\nparent ab896e38e124676c4d0532b74f4d0d714b33b2f9\nparent a247fffdf618cc39ce83d181d4c58da1ec8803a2\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1645810865 +0000\ncommitter GitHub <noreply@github.com> 1645810865 +0000\n\nMerge #11552\n\n11552: fix: properly display `$crate` in hovers r=jonas-schievink a=jonas-schievink\n\nWe used to print it as `{extern_crate}`, this PR resolves it to the crate's name, or falls back to `$crate` if the crate has no name.\r\n\r\nbors r+\n\nCo-authored-by: Jonas Schievink <jonas.schievink@ferrous-systems.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e1541bda940ca8c06e9bc134aab64ccbf9e6c225", "html_url": "https://github.com/rust-lang/rust/commit/e1541bda940ca8c06e9bc134aab64ccbf9e6c225", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e1541bda940ca8c06e9bc134aab64ccbf9e6c225/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ab896e38e124676c4d0532b74f4d0d714b33b2f9", "url": "https://api.github.com/repos/rust-lang/rust/commits/ab896e38e124676c4d0532b74f4d0d714b33b2f9", "html_url": "https://github.com/rust-lang/rust/commit/ab896e38e124676c4d0532b74f4d0d714b33b2f9"}, {"sha": "a247fffdf618cc39ce83d181d4c58da1ec8803a2", "url": "https://api.github.com/repos/rust-lang/rust/commits/a247fffdf618cc39ce83d181d4c58da1ec8803a2", "html_url": "https://github.com/rust-lang/rust/commit/a247fffdf618cc39ce83d181d4c58da1ec8803a2"}], "stats": {"total": 43, "additions": 42, "deletions": 1}, "files": [{"sha": "2020834fbc49752a7bb09aa365face1040fdf06d", "filename": "crates/hir_ty/src/display.rs", "status": "modified", "additions": 12, "deletions": 1, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/e1541bda940ca8c06e9bc134aab64ccbf9e6c225/crates%2Fhir_ty%2Fsrc%2Fdisplay.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e1541bda940ca8c06e9bc134aab64ccbf9e6c225/crates%2Fhir_ty%2Fsrc%2Fdisplay.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Fdisplay.rs?ref=e1541bda940ca8c06e9bc134aab64ccbf9e6c225", "patch": "@@ -1189,7 +1189,18 @@ impl HirDisplay for Path {\n                     write!(f, \"super\")?;\n                 }\n             }\n-            (_, PathKind::DollarCrate(_)) => write!(f, \"{{extern_crate}}\")?,\n+            (_, PathKind::DollarCrate(id)) => {\n+                // Resolve `$crate` to the crate's display name.\n+                // FIXME: should use the dependency name instead if available, but that depends on\n+                // the crate invoking `HirDisplay`\n+                let crate_graph = f.db.crate_graph();\n+                let name = crate_graph[*id]\n+                    .display_name\n+                    .as_ref()\n+                    .map(|name| name.canonical_name())\n+                    .unwrap_or(\"$crate\");\n+                write!(f, \"{name}\")?\n+            }\n         }\n \n         for (seg_idx, segment) in self.segments().iter().enumerate() {"}, {"sha": "df0ca941c99d80247c657b457f4914549765f4cb", "filename": "crates/ide/src/hover/tests.rs", "status": "modified", "additions": 30, "deletions": 0, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/e1541bda940ca8c06e9bc134aab64ccbf9e6c225/crates%2Fide%2Fsrc%2Fhover%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e1541bda940ca8c06e9bc134aab64ccbf9e6c225/crates%2Fide%2Fsrc%2Fhover%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fhover%2Ftests.rs?ref=e1541bda940ca8c06e9bc134aab64ccbf9e6c225", "patch": "@@ -4583,3 +4583,33 @@ pub struct Foo;\n         \"##]],\n     );\n }\n+\n+#[test]\n+fn hover_dollar_crate() {\n+    // $crate should be resolved to the right crate name.\n+\n+    check(\n+        r#\"\n+//- /main.rs crate:main deps:dep\n+dep::m!(KONST$0);\n+//- /dep.rs crate:dep\n+#[macro_export]\n+macro_rules! m {\n+    ( $name:ident ) => { const $name: $crate::Type = $crate::Type; };\n+}\n+\n+pub struct Type;\n+\"#,\n+        expect![[r#\"\n+            *KONST*\n+\n+            ```rust\n+            main\n+            ```\n+\n+            ```rust\n+            const KONST: dep::Type = $crate::Type\n+            ```\n+        \"#]],\n+    );\n+}"}]}