{"sha": "8bb4690487a39f9faab77b308bd797a15c216703", "node_id": "C_kwDOAAsO6NoAKDhiYjQ2OTA0ODdhMzlmOWZhYWI3N2IzMDhiZDc5N2ExNWMyMTY3MDM", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-01-19T16:33:10Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-01-19T16:33:10Z"}, "message": "Auto merge of #8280 - xFrednet:8276-map-clone-msrv, r=flip1995\n\nAdd `msrv` config for `map_clone`\n\nJust a small PR to have some fun with Clippy and to clear my head a bit :sweat_smile:\n\n---\n\nchangelog: [`map_clone`]: The suggestion takes `msrv` into account\nchangelog: Track `msrv` attribute for `manual_bits` and `borrow_as_prt`\n\nfixes: #8276", "tree": {"sha": "3371c9c569c7cc6aa2844b4a53fb161dfdc451d1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3371c9c569c7cc6aa2844b4a53fb161dfdc451d1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8bb4690487a39f9faab77b308bd797a15c216703", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8bb4690487a39f9faab77b308bd797a15c216703", "html_url": "https://github.com/rust-lang/rust/commit/8bb4690487a39f9faab77b308bd797a15c216703", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8bb4690487a39f9faab77b308bd797a15c216703/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0b143e347c61ab2fc62e9b533d48009aede2f3fc", "url": "https://api.github.com/repos/rust-lang/rust/commits/0b143e347c61ab2fc62e9b533d48009aede2f3fc", "html_url": "https://github.com/rust-lang/rust/commit/0b143e347c61ab2fc62e9b533d48009aede2f3fc"}, {"sha": "1afeb7106514557e19b2eb48529a9a96879ca4d3", "url": "https://api.github.com/repos/rust-lang/rust/commits/1afeb7106514557e19b2eb48529a9a96879ca4d3", "html_url": "https://github.com/rust-lang/rust/commit/1afeb7106514557e19b2eb48529a9a96879ca4d3"}], "stats": {"total": 112, "additions": 79, "deletions": 33}, "files": [{"sha": "265cdeab094fe205bb5c1f440a44aba4c3b87593", "filename": "clippy_lints/src/borrow_as_ptr.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/8bb4690487a39f9faab77b308bd797a15c216703/clippy_lints%2Fsrc%2Fborrow_as_ptr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8bb4690487a39f9faab77b308bd797a15c216703/clippy_lints%2Fsrc%2Fborrow_as_ptr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fborrow_as_ptr.rs?ref=8bb4690487a39f9faab77b308bd797a15c216703", "patch": "@@ -5,7 +5,7 @@ use clippy_utils::{meets_msrv, msrvs};\n use if_chain::if_chain;\n use rustc_errors::Applicability;\n use rustc_hir::{BorrowKind, Expr, ExprKind, Mutability, TyKind};\n-use rustc_lint::{LateContext, LateLintPass};\n+use rustc_lint::{LateContext, LateLintPass, LintContext};\n use rustc_semver::RustcVersion;\n use rustc_session::{declare_tool_lint, impl_lint_pass};\n \n@@ -94,4 +94,6 @@ impl<'tcx> LateLintPass<'tcx> for BorrowAsPtr {\n             }\n         }\n     }\n+\n+    extract_msrv_attr!(LateContext);\n }"}, {"sha": "ed25d6fd29757f3376e211dd1756a9a5aa7ed08c", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/8bb4690487a39f9faab77b308bd797a15c216703/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8bb4690487a39f9faab77b308bd797a15c216703/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=8bb4690487a39f9faab77b308bd797a15c216703", "patch": "@@ -581,6 +581,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n     store.register_late_pass(move || Box::new(needless_question_mark::NeedlessQuestionMark));\n     store.register_late_pass(move || Box::new(casts::Casts::new(msrv)));\n     store.register_early_pass(move || Box::new(unnested_or_patterns::UnnestedOrPatterns::new(msrv)));\n+    store.register_late_pass(move || Box::new(map_clone::MapClone::new(msrv)));\n \n     store.register_late_pass(|| Box::new(size_of_in_element_count::SizeOfInElementCount));\n     store.register_late_pass(|| Box::new(same_name_method::SameNameMethod));\n@@ -591,7 +592,6 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n             msrv,\n         ))\n     });\n-    store.register_late_pass(|| Box::new(map_clone::MapClone));\n     store.register_late_pass(|| Box::new(map_err_ignore::MapErrIgnore));\n     store.register_late_pass(|| Box::new(shadow::Shadow::default()));\n     store.register_late_pass(|| Box::new(unit_types::UnitTypes));"}, {"sha": "a72ef1d2de2fe7c9b7ebd8b098cac1ba9d7be46b", "filename": "clippy_lints/src/manual_bits.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/8bb4690487a39f9faab77b308bd797a15c216703/clippy_lints%2Fsrc%2Fmanual_bits.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8bb4690487a39f9faab77b308bd797a15c216703/clippy_lints%2Fsrc%2Fmanual_bits.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmanual_bits.rs?ref=8bb4690487a39f9faab77b308bd797a15c216703", "patch": "@@ -4,7 +4,7 @@ use clippy_utils::{match_def_path, meets_msrv, msrvs, paths};\n use rustc_ast::ast::LitKind;\n use rustc_errors::Applicability;\n use rustc_hir::{BinOpKind, Expr, ExprKind, GenericArg, QPath};\n-use rustc_lint::{LateContext, LateLintPass};\n+use rustc_lint::{LateContext, LateLintPass, LintContext};\n use rustc_middle::ty::{self, Ty};\n use rustc_semver::RustcVersion;\n use rustc_session::{declare_tool_lint, impl_lint_pass};\n@@ -72,6 +72,8 @@ impl<'tcx> LateLintPass<'tcx> for ManualBits {\n             }\n         }\n     }\n+\n+    extract_msrv_attr!(LateContext);\n }\n \n fn get_one_size_of_ty<'tcx>("}, {"sha": "5b203fd3d928cc369d999c99786845f2e87a5279", "filename": "clippy_lints/src/map_clone.rs", "status": "modified", "additions": 39, "deletions": 27, "changes": 66, "blob_url": "https://github.com/rust-lang/rust/blob/8bb4690487a39f9faab77b308bd797a15c216703/clippy_lints%2Fsrc%2Fmap_clone.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8bb4690487a39f9faab77b308bd797a15c216703/clippy_lints%2Fsrc%2Fmap_clone.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmap_clone.rs?ref=8bb4690487a39f9faab77b308bd797a15c216703", "patch": "@@ -1,15 +1,16 @@\n use clippy_utils::diagnostics::span_lint_and_sugg;\n use clippy_utils::source::snippet_with_applicability;\n use clippy_utils::ty::{is_copy, is_type_diagnostic_item};\n-use clippy_utils::{is_trait_method, peel_blocks};\n+use clippy_utils::{is_trait_method, meets_msrv, msrvs, peel_blocks};\n use if_chain::if_chain;\n use rustc_errors::Applicability;\n use rustc_hir as hir;\n-use rustc_lint::{LateContext, LateLintPass};\n+use rustc_lint::{LateContext, LateLintPass, LintContext};\n use rustc_middle::mir::Mutability;\n use rustc_middle::ty;\n use rustc_middle::ty::adjustment::Adjust;\n-use rustc_session::{declare_lint_pass, declare_tool_lint};\n+use rustc_semver::RustcVersion;\n+use rustc_session::{declare_tool_lint, impl_lint_pass};\n use rustc_span::symbol::Ident;\n use rustc_span::{sym, Span};\n \n@@ -42,7 +43,17 @@ declare_clippy_lint! {\n     \"using `iterator.map(|x| x.clone())`, or dereferencing closures for `Copy` types\"\n }\n \n-declare_lint_pass!(MapClone => [MAP_CLONE]);\n+pub struct MapClone {\n+    msrv: Option<RustcVersion>,\n+}\n+\n+impl_lint_pass!(MapClone => [MAP_CLONE]);\n+\n+impl MapClone {\n+    pub fn new(msrv: Option<RustcVersion>) -> Self {\n+        Self { msrv }\n+    }\n+}\n \n impl<'tcx> LateLintPass<'tcx> for MapClone {\n     fn check_expr(&mut self, cx: &LateContext<'_>, e: &hir::Expr<'_>) {\n@@ -65,15 +76,15 @@ impl<'tcx> LateLintPass<'tcx> for MapClone {\n                         hir::BindingAnnotation::Unannotated, .., name, None\n                     ) = inner.kind {\n                         if ident_eq(name, closure_expr) {\n-                            lint(cx, e.span, args[0].span, true);\n+                            self.lint_explicit_closure(cx, e.span, args[0].span, true);\n                         }\n                     },\n                     hir::PatKind::Binding(hir::BindingAnnotation::Unannotated, .., name, None) => {\n                         match closure_expr.kind {\n                             hir::ExprKind::Unary(hir::UnOp::Deref, inner) => {\n                                 if ident_eq(name, inner) {\n                                     if let ty::Ref(.., Mutability::Not) = cx.typeck_results().expr_ty(inner).kind() {\n-                                        lint(cx, e.span, args[0].span, true);\n+                                        self.lint_explicit_closure(cx, e.span, args[0].span, true);\n                                     }\n                                 }\n                             },\n@@ -90,7 +101,7 @@ impl<'tcx> LateLintPass<'tcx> for MapClone {\n                                     if let ty::Ref(_, ty, mutability) = obj_ty.kind() {\n                                         if matches!(mutability, Mutability::Not) {\n                                             let copy = is_copy(cx, ty);\n-                                            lint(cx, e.span, args[0].span, copy);\n+                                            self.lint_explicit_closure(cx, e.span, args[0].span, copy);\n                                         }\n                                     } else {\n                                         lint_needless_cloning(cx, e.span, args[0].span);\n@@ -105,6 +116,8 @@ impl<'tcx> LateLintPass<'tcx> for MapClone {\n             }\n         }\n     }\n+\n+    extract_msrv_attr!(LateContext);\n }\n \n fn ident_eq(name: Ident, path: &hir::Expr<'_>) -> bool {\n@@ -127,31 +140,30 @@ fn lint_needless_cloning(cx: &LateContext<'_>, root: Span, receiver: Span) {\n     );\n }\n \n-fn lint(cx: &LateContext<'_>, replace: Span, root: Span, copied: bool) {\n-    let mut applicability = Applicability::MachineApplicable;\n-    if copied {\n-        span_lint_and_sugg(\n-            cx,\n-            MAP_CLONE,\n-            replace,\n-            \"you are using an explicit closure for copying elements\",\n-            \"consider calling the dedicated `copied` method\",\n-            format!(\n-                \"{}.copied()\",\n-                snippet_with_applicability(cx, root, \"..\", &mut applicability)\n-            ),\n-            applicability,\n-        );\n-    } else {\n+impl MapClone {\n+    fn lint_explicit_closure(&self, cx: &LateContext<'_>, replace: Span, root: Span, is_copy: bool) {\n+        let mut applicability = Applicability::MachineApplicable;\n+        let message = if is_copy {\n+            \"you are using an explicit closure for copying elements\"\n+        } else {\n+            \"you are using an explicit closure for cloning elements\"\n+        };\n+        let sugg_method = if is_copy && meets_msrv(self.msrv.as_ref(), &msrvs::ITERATOR_COPIED) {\n+            \"copied\"\n+        } else {\n+            \"cloned\"\n+        };\n+\n         span_lint_and_sugg(\n             cx,\n             MAP_CLONE,\n             replace,\n-            \"you are using an explicit closure for cloning elements\",\n-            \"consider calling the dedicated `cloned` method\",\n+            message,\n+            &format!(\"consider calling the dedicated `{}` method\", sugg_method),\n             format!(\n-                \"{}.cloned()\",\n-                snippet_with_applicability(cx, root, \"..\", &mut applicability)\n+                \"{}.{}()\",\n+                snippet_with_applicability(cx, root, \"..\", &mut applicability),\n+                sugg_method,\n             ),\n             applicability,\n         );"}, {"sha": "c9d99617c1e281f8315bfc2669fd71243155a3ad", "filename": "clippy_lints/src/utils/conf.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/8bb4690487a39f9faab77b308bd797a15c216703/clippy_lints%2Fsrc%2Futils%2Fconf.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8bb4690487a39f9faab77b308bd797a15c216703/clippy_lints%2Fsrc%2Futils%2Fconf.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Futils%2Fconf.rs?ref=8bb4690487a39f9faab77b308bd797a15c216703", "patch": "@@ -156,7 +156,7 @@ define_Conf! {\n     ///\n     /// Suppress lints whenever the suggested change would cause breakage for other crates.\n     (avoid_breaking_exported_api: bool = true),\n-    /// Lint: MANUAL_SPLIT_ONCE, MANUAL_STR_REPEAT, CLONED_INSTEAD_OF_COPIED, REDUNDANT_FIELD_NAMES, REDUNDANT_STATIC_LIFETIMES, FILTER_MAP_NEXT, CHECKED_CONVERSIONS, MANUAL_RANGE_CONTAINS, USE_SELF, MEM_REPLACE_WITH_DEFAULT, MANUAL_NON_EXHAUSTIVE, OPTION_AS_REF_DEREF, MAP_UNWRAP_OR, MATCH_LIKE_MATCHES_MACRO, MANUAL_STRIP, MISSING_CONST_FOR_FN, UNNESTED_OR_PATTERNS, FROM_OVER_INTO, PTR_AS_PTR, IF_THEN_SOME_ELSE_NONE, APPROX_CONSTANT, DEPRECATED_CFG_ATTR, INDEX_REFUTABLE_SLICE.\n+    /// Lint: MANUAL_SPLIT_ONCE, MANUAL_STR_REPEAT, CLONED_INSTEAD_OF_COPIED, REDUNDANT_FIELD_NAMES, REDUNDANT_STATIC_LIFETIMES, FILTER_MAP_NEXT, CHECKED_CONVERSIONS, MANUAL_RANGE_CONTAINS, USE_SELF, MEM_REPLACE_WITH_DEFAULT, MANUAL_NON_EXHAUSTIVE, OPTION_AS_REF_DEREF, MAP_UNWRAP_OR, MATCH_LIKE_MATCHES_MACRO, MANUAL_STRIP, MISSING_CONST_FOR_FN, UNNESTED_OR_PATTERNS, FROM_OVER_INTO, PTR_AS_PTR, IF_THEN_SOME_ELSE_NONE, APPROX_CONSTANT, DEPRECATED_CFG_ATTR, INDEX_REFUTABLE_SLICE, MAP_CLONE, BORROW_AS_PTR, MANUAL_BITS.\n     ///\n     /// The minimum rust version that the project supports\n     (msrv: Option<String> = None),"}, {"sha": "1e3ec123a3c8b0b430eb253f739da3fd41868b71", "filename": "tests/ui-toml/min_rust_version/min_rust_version.rs", "status": "modified", "additions": 22, "deletions": 2, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/8bb4690487a39f9faab77b308bd797a15c216703/tests%2Fui-toml%2Fmin_rust_version%2Fmin_rust_version.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8bb4690487a39f9faab77b308bd797a15c216703/tests%2Fui-toml%2Fmin_rust_version%2Fmin_rust_version.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui-toml%2Fmin_rust_version%2Fmin_rust_version.rs?ref=8bb4690487a39f9faab77b308bd797a15c216703", "patch": "@@ -1,6 +1,7 @@\n-#![allow(clippy::redundant_clone)]\n-#![warn(clippy::manual_non_exhaustive)]\n+#![allow(clippy::redundant_clone, clippy::unnecessary_operation)]\n+#![warn(clippy::manual_non_exhaustive, clippy::borrow_as_ptr, clippy::manual_bits)]\n \n+use std::mem::{size_of, size_of_val};\n use std::ops::Deref;\n \n mod enums {\n@@ -68,11 +69,30 @@ fn check_index_refutable_slice() {\n     }\n }\n \n+fn map_clone_suggest_copied() {\n+    // This should still trigger the lint but suggest `cloned()` instead of `copied()`\n+    let _: Option<u64> = Some(&16).map(|b| *b);\n+}\n+\n+fn borrow_as_ptr() {\n+    let val = 1;\n+    let _p = &val as *const i32;\n+\n+    let mut val_mut = 1;\n+    let _p_mut = &mut val_mut as *mut i32;\n+}\n+\n+fn manual_bits() {\n+    size_of::<i8>() * 8;\n+    size_of_val(&0u32) * 8;\n+}\n+\n fn main() {\n     option_as_ref_deref();\n     match_like_matches();\n     match_same_arms();\n     match_same_arms2();\n     manual_strip_msrv();\n     check_index_refutable_slice();\n+    borrow_as_ptr();\n }"}, {"sha": "a1e7361c0cb32fe4bbe9e9c5a09320691b3b123a", "filename": "tests/ui-toml/min_rust_version/min_rust_version.stderr", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/8bb4690487a39f9faab77b308bd797a15c216703/tests%2Fui-toml%2Fmin_rust_version%2Fmin_rust_version.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/8bb4690487a39f9faab77b308bd797a15c216703/tests%2Fui-toml%2Fmin_rust_version%2Fmin_rust_version.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui-toml%2Fmin_rust_version%2Fmin_rust_version.stderr?ref=8bb4690487a39f9faab77b308bd797a15c216703", "patch": "@@ -0,0 +1,10 @@\n+error: you are using an explicit closure for copying elements\n+  --> $DIR/min_rust_version.rs:74:26\n+   |\n+LL |     let _: Option<u64> = Some(&16).map(|b| *b);\n+   |                          ^^^^^^^^^^^^^^^^^^^^^ help: consider calling the dedicated `cloned` method: `Some(&16).cloned()`\n+   |\n+   = note: `-D clippy::map-clone` implied by `-D warnings`\n+\n+error: aborting due to previous error\n+"}]}