{"sha": "d6182b365c09d6729b2ebd1c08e654e064072f67", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQ2MTgyYjM2NWMwOWQ2NzI5YjJlYmQxYzA4ZTY1NGUwNjQwNzJmNjc=", "commit": {"author": {"name": "mcarton", "email": "cartonmartin+git@gmail.com", "date": "2016-07-01T15:48:57Z"}, "committer": {"name": "mcarton", "email": "cartonmartin+git@gmail.com", "date": "2016-07-01T15:48:57Z"}, "message": "Merge remote-tracking branch 'origin/rustup' into sugg", "tree": {"sha": "ba52010e5c253d69ce8cb0c7c8d14eeee1eae015", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ba52010e5c253d69ce8cb0c7c8d14eeee1eae015"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d6182b365c09d6729b2ebd1c08e654e064072f67", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\nVersion: GnuPG v2\n\niQIcBAABCAAGBQJXdpDtAAoJEF5CfHlMukXoyFYP/1750xQxjuo21PJ+t98M0hTc\nJm415NGVIzfAUijxq8neTFvFYmU0MO4ehncft3raJTWVGJkVpBD4OqS791ZtBcVo\nXL7+O2J18RoNm2ZiPWxYdW0f+PCZ4X7FXhpwVPlfWVvZx8NPXbuk5UMdmNJRrHXJ\nBy0AotJeMJOPGFUcFXCGNPPYu6vXAjgeuQnmUn9WRRgxMbSQK8JMfGjELLj2RyOC\nKcBrSLWJHQP1apG+KRTY6+PwCj4xl6fjUu3KrC05hnIhDBjOKXR6VqOPmb9vfeZC\nsXLdkC/24Md3QAXjArAXT/YWB0WZKvQDIqCA4MJhCM8jeKBmPMzdFevy9QaqpqKy\n5lo2MitW5zm7Q3RNCaKFDMfRSHbi2MHE+aH7h6Uo8f8qrRtHNrAni45Oay54stVg\nD8yQYCaXG39dJoGDAHcwSH8eoNzX/Rd6mppAvh60aC4BlhKZZx8tb2f6tCUv7zB5\nTfeV8XEm6Ug/OC/2PihDh92C6ECOTotmnnUq2c6/qv0xn5pJYog15gVQwF+K4lAv\ngppZ1EKwGwqBTqHvkrM8n03hIJFzkMVJAKSEFeIcWsuPK1HNCMs6bWYbzpc60FJm\nN6zt17wwi75HR0739LQYTuUpOxSxGev9Jt9L7c34fknjNohDBjBb7d7IFgw3caiE\nnh3+3VwI29SMpuZQ5mnt\n=xMTC\n-----END PGP SIGNATURE-----", "payload": "tree ba52010e5c253d69ce8cb0c7c8d14eeee1eae015\nparent 28bd591f05770fd35cc6f2f82f0a13e71d13dcea\nparent 55b78ae47844f65d8d2703a4edd1b9d5a2bfb93e\nauthor mcarton <cartonmartin+git@gmail.com> 1467388137 +0200\ncommitter mcarton <cartonmartin+git@gmail.com> 1467388137 +0200\n\nMerge remote-tracking branch 'origin/rustup' into sugg\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d6182b365c09d6729b2ebd1c08e654e064072f67", "html_url": "https://github.com/rust-lang/rust/commit/d6182b365c09d6729b2ebd1c08e654e064072f67", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d6182b365c09d6729b2ebd1c08e654e064072f67/comments", "author": {"login": "mcarton", "id": 3751788, "node_id": "MDQ6VXNlcjM3NTE3ODg=", "avatar_url": "https://avatars.githubusercontent.com/u/3751788?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mcarton", "html_url": "https://github.com/mcarton", "followers_url": "https://api.github.com/users/mcarton/followers", "following_url": "https://api.github.com/users/mcarton/following{/other_user}", "gists_url": "https://api.github.com/users/mcarton/gists{/gist_id}", "starred_url": "https://api.github.com/users/mcarton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mcarton/subscriptions", "organizations_url": "https://api.github.com/users/mcarton/orgs", "repos_url": "https://api.github.com/users/mcarton/repos", "events_url": "https://api.github.com/users/mcarton/events{/privacy}", "received_events_url": "https://api.github.com/users/mcarton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "mcarton", "id": 3751788, "node_id": "MDQ6VXNlcjM3NTE3ODg=", "avatar_url": "https://avatars.githubusercontent.com/u/3751788?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mcarton", "html_url": "https://github.com/mcarton", "followers_url": "https://api.github.com/users/mcarton/followers", "following_url": "https://api.github.com/users/mcarton/following{/other_user}", "gists_url": "https://api.github.com/users/mcarton/gists{/gist_id}", "starred_url": "https://api.github.com/users/mcarton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mcarton/subscriptions", "organizations_url": "https://api.github.com/users/mcarton/orgs", "repos_url": "https://api.github.com/users/mcarton/repos", "events_url": "https://api.github.com/users/mcarton/events{/privacy}", "received_events_url": "https://api.github.com/users/mcarton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "28bd591f05770fd35cc6f2f82f0a13e71d13dcea", "url": "https://api.github.com/repos/rust-lang/rust/commits/28bd591f05770fd35cc6f2f82f0a13e71d13dcea", "html_url": "https://github.com/rust-lang/rust/commit/28bd591f05770fd35cc6f2f82f0a13e71d13dcea"}, {"sha": "55b78ae47844f65d8d2703a4edd1b9d5a2bfb93e", "url": "https://api.github.com/repos/rust-lang/rust/commits/55b78ae47844f65d8d2703a4edd1b9d5a2bfb93e", "html_url": "https://github.com/rust-lang/rust/commit/55b78ae47844f65d8d2703a4edd1b9d5a2bfb93e"}], "stats": {"total": 265, "additions": 155, "deletions": 110}, "files": [{"sha": "fece611c1dac772002e5bbaf858456f26e4de84e", "filename": "CHANGELOG.md", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/d6182b365c09d6729b2ebd1c08e654e064072f67/CHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/d6182b365c09d6729b2ebd1c08e654e064072f67/CHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/CHANGELOG.md?ref=d6182b365c09d6729b2ebd1c08e654e064072f67", "patch": "@@ -2,7 +2,7 @@\n All notable changes to this project will be documented in this file.\n \n ## 0.0.78 - TBA\n-* New lints: [`wrong_transmute`]\n+* New lints: [`wrong_transmute`, `double_neg`]\n * For compatibility, `cargo clippy` does not defines the `clippy` feature\n   introduced in 0.0.76 anymore\n * [`collapsible_if`] now considers `if let`\n@@ -153,6 +153,7 @@ All notable changes to this project will be documented in this file.\n [`deprecated_semver`]: https://github.com/Manishearth/rust-clippy/wiki#deprecated_semver\n [`derive_hash_xor_eq`]: https://github.com/Manishearth/rust-clippy/wiki#derive_hash_xor_eq\n [`doc_markdown`]: https://github.com/Manishearth/rust-clippy/wiki#doc_markdown\n+[`double_neg`]: https://github.com/Manishearth/rust-clippy/wiki#double_neg\n [`drop_ref`]: https://github.com/Manishearth/rust-clippy/wiki#drop_ref\n [`duplicate_underscore_argument`]: https://github.com/Manishearth/rust-clippy/wiki#duplicate_underscore_argument\n [`empty_loop`]: https://github.com/Manishearth/rust-clippy/wiki#empty_loop"}, {"sha": "6fb3913bac129f4685909028597aa4cddbb3e2b0", "filename": "README.md", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/d6182b365c09d6729b2ebd1c08e654e064072f67/README.md", "raw_url": "https://github.com/rust-lang/rust/raw/d6182b365c09d6729b2ebd1c08e654e064072f67/README.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/README.md?ref=d6182b365c09d6729b2ebd1c08e654e064072f67", "patch": "@@ -17,7 +17,7 @@ Table of contents:\n \n ## Lints\n \n-There are 156 lints included in this crate:\n+There are 157 lints included in this crate:\n \n name                                                                                                                 | default | meaning\n ---------------------------------------------------------------------------------------------------------------------|---------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n@@ -49,6 +49,7 @@ name\n [deprecated_semver](https://github.com/Manishearth/rust-clippy/wiki#deprecated_semver)                               | warn    | `Warn` on `#[deprecated(since = \"x\")]` where x is not semver\n [derive_hash_xor_eq](https://github.com/Manishearth/rust-clippy/wiki#derive_hash_xor_eq)                             | warn    | deriving `Hash` but implementing `PartialEq` explicitly\n [doc_markdown](https://github.com/Manishearth/rust-clippy/wiki#doc_markdown)                                         | warn    | checks for the presence of `_`, `::` or camel-case outside ticks in documentation\n+[double_neg](https://github.com/Manishearth/rust-clippy/wiki#double_neg)                                             | warn    | `--x` is a double negation of `x` and not a pre-decrement as in C or C++\n [drop_ref](https://github.com/Manishearth/rust-clippy/wiki#drop_ref)                                                 | warn    | call to `std::mem::drop` with a reference instead of an owned value, which will not call the `Drop::drop` method on the underlying value\n [duplicate_underscore_argument](https://github.com/Manishearth/rust-clippy/wiki#duplicate_underscore_argument)       | warn    | Function arguments having names which only differ by an underscore\n [empty_loop](https://github.com/Manishearth/rust-clippy/wiki#empty_loop)                                             | warn    | empty `loop {}` detected"}, {"sha": "672dee77783ea0706b21184052b1b5f4d5974002", "filename": "clippy_lints/src/booleans.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/d6182b365c09d6729b2ebd1c08e654e064072f67/clippy_lints%2Fsrc%2Fbooleans.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d6182b365c09d6729b2ebd1c08e654e064072f67/clippy_lints%2Fsrc%2Fbooleans.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fbooleans.rs?ref=d6182b365c09d6729b2ebd1c08e654e064072f67", "patch": "@@ -3,6 +3,7 @@ use rustc::hir::*;\n use rustc::hir::intravisit::*;\n use syntax::ast::{LitKind, DUMMY_NODE_ID};\n use syntax::codemap::{DUMMY_SP, dummy_spanned};\n+use syntax::util::ThinVec;\n use utils::{span_lint_and_then, in_macro, snippet_opt, SpanlessEq};\n \n /// **What it does:** This lint checks for boolean expressions that can be written more concisely\n@@ -99,7 +100,7 @@ impl<'a, 'tcx, 'v> Hir2Qmm<'a, 'tcx, 'v> {\n                         Expr {\n                             id: DUMMY_NODE_ID,\n                             span: DUMMY_SP,\n-                            attrs: None,\n+                            attrs: ThinVec::new(),\n                             node: ExprBinary(dummy_spanned(op), lhs.clone(), rhs.clone()),\n                         }\n                     };"}, {"sha": "1d9e3984e743056977bd9846e3e0f78bf1e3dd19", "filename": "clippy_lints/src/collapsible_if.rs", "status": "modified", "additions": 11, "deletions": 23, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/d6182b365c09d6729b2ebd1c08e654e064072f67/clippy_lints%2Fsrc%2Fcollapsible_if.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d6182b365c09d6729b2ebd1c08e654e064072f67/clippy_lints%2Fsrc%2Fcollapsible_if.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fcollapsible_if.rs?ref=d6182b365c09d6729b2ebd1c08e654e064072f67", "patch": "@@ -71,8 +71,8 @@ fn check_if(cx: &EarlyContext, expr: &ast::Expr) {\n fn check_collapsible_maybe_if_let(cx: &EarlyContext, else_: &ast::Expr) {\n     if_let_chain! {[\n         let ast::ExprKind::Block(ref block) = else_.node,\n-        block.stmts.is_empty(),\n-        let Some(ref else_) = block.expr,\n+        let Some(ref else_) = expr_block(block),\n+        !in_macro(cx, else_.span),\n     ], {\n         match else_.node {\n             ast::ExprKind::If(..) | ast::ExprKind::IfLet(..) => {\n@@ -95,7 +95,7 @@ fn check_collapsible_no_if_let(\n     then: &ast::Block,\n ) {\n     if_let_chain! {[\n-        let Some(inner) = single_stmt_of_block(then),\n+        let Some(inner) = expr_block(then),\n         let ast::ExprKind::If(ref check_inner, ref content, None) = inner.node,\n     ], {\n         if expr.span.expn_id != inner.span.expn_id {\n@@ -113,28 +113,16 @@ fn check_collapsible_no_if_let(\n     }}\n }\n \n-fn single_stmt_of_block(block: &ast::Block) -> Option<&ast::Expr> {\n-    if block.stmts.len() == 1 && block.expr.is_none() {\n-        if let ast::StmtKind::Expr(ref expr, _) = block.stmts[0].node {\n-            single_stmt_of_expr(expr)\n-        } else {\n-            None\n-        }\n-    } else if block.stmts.is_empty() {\n-        if let Some(ref p) = block.expr {\n-            Some(p)\n-        } else {\n-            None\n+/// If the block contains only one expression, returns it.\n+fn expr_block(block: &ast::Block) -> Option<&ast::Expr> {\n+    let mut it = block.stmts.iter();\n+\n+    if let (Some(stmt), None) = (it.next(), it.next()) {\n+        match stmt.node {\n+            ast::StmtKind::Expr(ref expr) | ast::StmtKind::Semi(ref expr) => Some(expr),\n+            _ => None,\n         }\n     } else {\n         None\n     }\n }\n-\n-fn single_stmt_of_expr(expr: &ast::Expr) -> Option<&ast::Expr> {\n-    if let ast::ExprKind::Block(ref block) = expr.node {\n-        single_stmt_of_block(block)\n-    } else {\n-        Some(expr)\n-    }\n-}"}, {"sha": "0bc8c2bfd961eef1f0f5e7919c02767c55bb8e67", "filename": "clippy_lints/src/formatting.rs", "status": "modified", "additions": 2, "deletions": 10, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/d6182b365c09d6729b2ebd1c08e654e064072f67/clippy_lints%2Fsrc%2Fformatting.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d6182b365c09d6729b2ebd1c08e654e064072f67/clippy_lints%2Fsrc%2Fformatting.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fformatting.rs?ref=d6182b365c09d6729b2ebd1c08e654e064072f67", "patch": "@@ -59,21 +59,13 @@ impl EarlyLintPass for Formatting {\n     fn check_block(&mut self, cx: &EarlyContext, block: &ast::Block) {\n         for w in block.stmts.windows(2) {\n             match (&w[0].node, &w[1].node) {\n-                (&ast::StmtKind::Expr(ref first, _), &ast::StmtKind::Expr(ref second, _)) |\n-                (&ast::StmtKind::Expr(ref first, _), &ast::StmtKind::Semi(ref second, _)) => {\n+                (&ast::StmtKind::Expr(ref first), &ast::StmtKind::Expr(ref second)) |\n+                (&ast::StmtKind::Expr(ref first), &ast::StmtKind::Semi(ref second)) => {\n                     check_consecutive_ifs(cx, first, second);\n                 }\n                 _ => (),\n             }\n         }\n-\n-        if let Some(ref expr) = block.expr {\n-            if let Some(ref stmt) = block.stmts.iter().last() {\n-                if let ast::StmtKind::Expr(ref first, _) = stmt.node {\n-                    check_consecutive_ifs(cx, first, expr);\n-                }\n-            }\n-        }\n     }\n \n     fn check_expr(&mut self, cx: &EarlyContext, expr: &ast::Expr) {"}, {"sha": "0afc2e8f7cefa6cdfbb6f0be009f0d2ec0c99dba", "filename": "clippy_lints/src/items_after_statements.rs", "status": "modified", "additions": 14, "deletions": 17, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/d6182b365c09d6729b2ebd1c08e654e064072f67/clippy_lints%2Fsrc%2Fitems_after_statements.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d6182b365c09d6729b2ebd1c08e654e064072f67/clippy_lints%2Fsrc%2Fitems_after_statements.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fitems_after_statements.rs?ref=d6182b365c09d6729b2ebd1c08e654e064072f67", "patch": "@@ -2,7 +2,7 @@\n \n use rustc::lint::*;\n use syntax::ast::*;\n-use utils::in_macro;\n+use utils::{in_macro, span_lint};\n \n /// **What it does:** This lints checks for items declared after some statement in a block\n ///\n@@ -44,26 +44,23 @@ impl EarlyLintPass for ItemsAfterStatements {\n         if in_macro(cx, item.span) {\n             return;\n         }\n-        let mut stmts = item.stmts.iter().map(|stmt| &stmt.node);\n+\n         // skip initial items\n-        while let Some(&StmtKind::Decl(ref decl, _)) = stmts.next() {\n-            if let DeclKind::Local(_) = decl.node {\n-                break;\n-            }\n-        }\n+        let stmts = item.stmts.iter()\n+                              .map(|stmt| &stmt.node)\n+                              .skip_while(|s| matches!(**s, StmtKind::Item(..)));\n+\n         // lint on all further items\n         for stmt in stmts {\n-            if let StmtKind::Decl(ref decl, _) = *stmt {\n-                if let DeclKind::Item(ref it) = decl.node {\n-                    if in_macro(cx, it.span) {\n-                        return;\n-                    }\n-                    cx.struct_span_lint(ITEMS_AFTER_STATEMENTS,\n-                                        it.span,\n-                                        \"adding items after statements is confusing, since items exist from the \\\n-                                         start of the scope\")\n-                      .emit();\n+            if let StmtKind::Item(ref it) = *stmt {\n+                if in_macro(cx, it.span) {\n+                    return;\n                 }\n+                span_lint(cx,\n+                          ITEMS_AFTER_STATEMENTS,\n+                          it.span,\n+                          \"adding items after statements is confusing, since items exist from the \\\n+                           start of the scope\");\n             }\n         }\n     }"}, {"sha": "41a61feab5390446710ae4b610a2117c786520ed", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d6182b365c09d6729b2ebd1c08e654e064072f67/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d6182b365c09d6729b2ebd1c08e654e064072f67/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=d6182b365c09d6729b2ebd1c08e654e064072f67", "patch": "@@ -370,6 +370,7 @@ pub fn register_plugins(reg: &mut rustc_plugin::Registry) {\n         misc::MODULO_ONE,\n         misc::REDUNDANT_PATTERN,\n         misc::TOPLEVEL_REF_ARG,\n+        misc_early::DOUBLE_NEG,\n         misc_early::DUPLICATE_UNDERSCORE_ARGUMENT,\n         misc_early::REDUNDANT_CLOSURE_CALL,\n         misc_early::UNNEEDED_FIELD_PATTERN,"}, {"sha": "45964cf3ce705d617309063a52971dc375a88915", "filename": "clippy_lints/src/misc_early.rs", "status": "modified", "additions": 45, "deletions": 22, "changes": 67, "blob_url": "https://github.com/rust-lang/rust/blob/d6182b365c09d6729b2ebd1c08e654e064072f67/clippy_lints%2Fsrc%2Fmisc_early.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d6182b365c09d6729b2ebd1c08e654e064072f67/clippy_lints%2Fsrc%2Fmisc_early.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmisc_early.rs?ref=d6182b365c09d6729b2ebd1c08e654e064072f67", "patch": "@@ -40,12 +40,25 @@ declare_lint! {\n     \"Closures should not be called in the expression they are defined\"\n }\n \n+/// **What it does:** This lint detects expressions of the form `--x`\n+///\n+/// **Why is this bad?** It can mislead C/C++ programmers to think `x` was decremented.\n+///\n+/// **Known problems:** None.\n+///\n+/// **Example:** `--x;`\n+declare_lint! {\n+    pub DOUBLE_NEG, Warn,\n+    \"`--x` is a double negation of `x` and not a pre-decrement as in C or C++\"\n+}\n+\n+\n #[derive(Copy, Clone)]\n pub struct MiscEarly;\n \n impl LintPass for MiscEarly {\n     fn get_lints(&self) -> LintArray {\n-        lint_array!(UNNEEDED_FIELD_PATTERN, DUPLICATE_UNDERSCORE_ARGUMENT, REDUNDANT_CLOSURE_CALL)\n+        lint_array!(UNNEEDED_FIELD_PATTERN, DUPLICATE_UNDERSCORE_ARGUMENT, REDUNDANT_CLOSURE_CALL, DOUBLE_NEG)\n     }\n }\n \n@@ -126,36 +139,46 @@ impl EarlyLintPass for MiscEarly {\n     }\n \n     fn check_expr(&mut self, cx: &EarlyContext, expr: &Expr) {\n-        if let ExprKind::Call(ref paren, _) = expr.node {\n-            if let ExprKind::Paren(ref closure) = paren.node {\n-                if let ExprKind::Closure(_, ref decl, ref block, _) = closure.node {\n-                    span_lint_and_then(cx,\n-                                       REDUNDANT_CLOSURE_CALL,\n-                                       expr.span,\n-                                       \"Try not to call a closure in the expression where it is declared.\",\n-                                       |db| {\n-                                           if decl.inputs.is_empty() {\n-                                               let hint = format!(\"{}\", snippet(cx, block.span, \"..\"));\n-                                               db.span_suggestion(expr.span, \"Try doing something like: \", hint);\n-                                           }\n-                                       });\n+        match expr.node {\n+            ExprKind::Call(ref paren, _) => {\n+                if let ExprKind::Paren(ref closure) = paren.node {\n+                    if let ExprKind::Closure(_, ref decl, ref block, _) = closure.node {\n+                        span_lint_and_then(cx,\n+                                           REDUNDANT_CLOSURE_CALL,\n+                                           expr.span,\n+                                           \"Try not to call a closure in the expression where it is declared.\",\n+                                           |db| {\n+                                               if decl.inputs.is_empty() {\n+                                                   let hint = format!(\"{}\", snippet(cx, block.span, \"..\"));\n+                                                   db.span_suggestion(expr.span, \"Try doing something like: \", hint);\n+                                               }\n+                                           });\n+                    }\n                 }\n             }\n+            ExprKind::Unary(UnOp::Neg, ref inner) => {\n+                if let ExprKind::Unary(UnOp::Neg, _) = inner.node {\n+                    span_lint(cx,\n+                              DOUBLE_NEG,\n+                              expr.span,\n+                              \"`--x` could be misinterpreted as pre-decrement by C programmers, is usually a no-op\");\n+    }\n+            }\n+            _ => ()\n         }\n     }\n \n     fn check_block(&mut self, cx: &EarlyContext, block: &Block) {\n         for w in block.stmts.windows(2) {\n             if_let_chain! {[\n-                let StmtKind::Decl(ref first, _) = w[0].node,\n-                let DeclKind::Local(ref local) = first.node,\n+                let StmtKind::Local(ref local) = w[0].node,\n                 let Option::Some(ref t) = local.init,\n-                let ExprKind::Closure(_,_,_,_) = t.node,\n-                let PatKind::Ident(_,sp_ident,_) = local.pat.node,\n-                let StmtKind::Semi(ref second,_) = w[1].node,\n-                let ExprKind::Assign(_,ref call) = second.node,\n-                let ExprKind::Call(ref closure,_) = call.node,\n-                let ExprKind::Path(_,ref path) = closure.node\n+                let ExprKind::Closure(_, _, _, _) = t.node,\n+                let PatKind::Ident(_, sp_ident, _) = local.pat.node,\n+                let StmtKind::Semi(ref second) = w[1].node,\n+                let ExprKind::Assign(_, ref call) = second.node,\n+                let ExprKind::Call(ref closure, _) = call.node,\n+                let ExprKind::Path(_, ref path) = closure.node\n             ], {\n                 if sp_ident.node == (&path.segments[0]).identifier {\n                     span_lint(cx, REDUNDANT_CLOSURE_CALL, second.span, \"Closure called just once immediately after it was declared\");"}, {"sha": "17f12afcaec9c5dd8c2140d1a7b0244bfbf3dd5e", "filename": "clippy_lints/src/non_expressive_names.rs", "status": "modified", "additions": 7, "deletions": 7, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/d6182b365c09d6729b2ebd1c08e654e064072f67/clippy_lints%2Fsrc%2Fnon_expressive_names.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d6182b365c09d6729b2ebd1c08e654e064072f67/clippy_lints%2Fsrc%2Fnon_expressive_names.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fnon_expressive_names.rs?ref=d6182b365c09d6729b2ebd1c08e654e064072f67", "patch": "@@ -68,8 +68,8 @@ const WHITELIST: &'static [&'static [&'static str]] = &[\n \n struct SimilarNamesNameVisitor<'a, 'b: 'a, 'c: 'b>(&'a mut SimilarNamesLocalVisitor<'b, 'c>);\n \n-impl<'v, 'a, 'b, 'c> Visitor<'v> for SimilarNamesNameVisitor<'a, 'b, 'c> {\n-    fn visit_pat(&mut self, pat: &'v Pat) {\n+impl<'a, 'b, 'c> Visitor for SimilarNamesNameVisitor<'a, 'b, 'c> {\n+    fn visit_pat(&mut self, pat: &Pat) {\n         match pat.node {\n             PatKind::Ident(_, id, _) => self.check_name(id.span, id.node.name),\n             PatKind::Struct(_, ref fields, _) => {\n@@ -226,25 +226,25 @@ impl<'a, 'b> SimilarNamesLocalVisitor<'a, 'b> {\n     }\n }\n \n-impl<'v, 'a, 'b> Visitor<'v> for SimilarNamesLocalVisitor<'a, 'b> {\n-    fn visit_local(&mut self, local: &'v Local) {\n+impl<'a, 'b> Visitor for SimilarNamesLocalVisitor<'a, 'b> {\n+    fn visit_local(&mut self, local: &Local) {\n         if let Some(ref init) = local.init {\n             self.apply(|this| walk_expr(this, &**init));\n         }\n         // add the pattern after the expression because the bindings aren't available yet in the init expression\n         SimilarNamesNameVisitor(self).visit_pat(&*local.pat);\n     }\n-    fn visit_block(&mut self, blk: &'v Block) {\n+    fn visit_block(&mut self, blk: &Block) {\n         self.apply(|this| walk_block(this, blk));\n     }\n-    fn visit_arm(&mut self, arm: &'v Arm) {\n+    fn visit_arm(&mut self, arm: &Arm) {\n         self.apply(|this| {\n             // just go through the first pattern, as either all patterns bind the same bindings or rustc would have errored much earlier\n             SimilarNamesNameVisitor(this).visit_pat(&arm.pats[0]);\n             this.apply(|this| walk_expr(this, &arm.body));\n         });\n     }\n-    fn visit_item(&mut self, _: &'v Item) {\n+    fn visit_item(&mut self, _: &Item) {\n         // do not recurse into inner items\n     }\n }"}, {"sha": "fda151cd6d7e1f186765647b1c450282782908fe", "filename": "clippy_lints/src/returns.rs", "status": "modified", "additions": 11, "deletions": 10, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/d6182b365c09d6729b2ebd1c08e654e064072f67/clippy_lints%2Fsrc%2Freturns.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d6182b365c09d6729b2ebd1c08e654e064072f67/clippy_lints%2Fsrc%2Freturns.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Freturns.rs?ref=d6182b365c09d6729b2ebd1c08e654e064072f67", "patch": "@@ -36,13 +36,12 @@ pub struct ReturnPass;\n impl ReturnPass {\n     // Check the final stmt or expr in a block for unnecessary return.\n     fn check_block_return(&mut self, cx: &EarlyContext, block: &Block) {\n-        if let Some(ref expr) = block.expr {\n-            self.check_final_expr(cx, expr);\n-        } else if let Some(stmt) = block.stmts.last() {\n-            if let StmtKind::Semi(ref expr, _) = stmt.node {\n-                if let ExprKind::Ret(Some(ref inner)) = expr.node {\n-                    self.emit_return_lint(cx, (stmt.span, inner.span));\n+        if let Some(stmt) = block.stmts.last() {\n+            match stmt.node {\n+                StmtKind::Expr(ref expr) | StmtKind::Semi(ref expr) => {\n+                    self.check_final_expr(cx, expr);\n                 }\n+                _ => (),\n             }\n         }\n     }\n@@ -88,12 +87,14 @@ impl ReturnPass {\n \n     // Check for \"let x = EXPR; x\"\n     fn check_let_return(&mut self, cx: &EarlyContext, block: &Block) {\n+        let mut it = block.stmts.iter();\n+\n         // we need both a let-binding stmt and an expr\n         if_let_chain! {[\n-            let Some(stmt) = block.stmts.last(),\n-            let Some(ref retexpr) = block.expr,\n-            let StmtKind::Decl(ref decl, _) = stmt.node,\n-            let DeclKind::Local(ref local) = decl.node,\n+            let Some(ref retexpr) = it.next_back(),\n+            let StmtKind::Expr(ref retexpr) = retexpr.node,\n+            let Some(stmt) = it.next_back(),\n+            let StmtKind::Local(ref local) = stmt.node,\n             let Some(ref initexpr) = local.init,\n             let PatKind::Ident(_, Spanned { node: id, .. }, _) = local.pat.node,\n             let ExprKind::Path(_, ref path) = retexpr.node,"}, {"sha": "4b0c5ea5afde4db8118f39a562c36e6420c2dfb1", "filename": "mini-macro/src/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d6182b365c09d6729b2ebd1c08e654e064072f67/mini-macro%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d6182b365c09d6729b2ebd1c08e654e064072f67/mini-macro%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/mini-macro%2Fsrc%2Flib.rs?ref=d6182b365c09d6729b2ebd1c08e654e064072f67", "patch": "@@ -5,7 +5,7 @@ extern crate rustc;\n extern crate rustc_plugin;\n \n use syntax::codemap::Span;\n-use syntax::ast::TokenTree;\n+use syntax::tokenstream::TokenTree;\n use syntax::ext::base::{ExtCtxt, MacResult, MacEager};\n use syntax::ext::build::AstBuilder;  // trait for expr_usize\n use rustc_plugin::Registry;"}, {"sha": "c4ad6d66177a8c812239070240b1ca4225b84a81", "filename": "src/main.rs", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/d6182b365c09d6729b2ebd1c08e654e064072f67/src%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d6182b365c09d6729b2ebd1c08e654e064072f67/src%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fmain.rs?ref=d6182b365c09d6729b2ebd1c08e654e064072f67", "patch": "@@ -2,17 +2,17 @@\n #![feature(box_syntax)]\n #![feature(rustc_private)]\n \n-extern crate rustc_driver;\n+extern crate clippy_lints;\n extern crate getopts;\n extern crate rustc;\n-extern crate syntax;\n+extern crate rustc_driver;\n+extern crate rustc_errors;\n extern crate rustc_plugin;\n-extern crate clippy_lints;\n+extern crate syntax;\n \n use rustc_driver::{driver, CompilerCalls, RustcDefaultCalls, Compilation};\n use rustc::session::{config, Session};\n use rustc::session::config::{Input, ErrorOutputType};\n-use syntax::diagnostics;\n use std::path::PathBuf;\n use std::process::Command;\n \n@@ -36,7 +36,7 @@ impl<'a> CompilerCalls<'a> for ClippyCompilerCalls {\n     fn early_callback(&mut self,\n                       matches: &getopts::Matches,\n                       sopts: &config::Options,\n-                      descriptions: &diagnostics::registry::Registry,\n+                      descriptions: &rustc_errors::registry::Registry,\n                       output: ErrorOutputType)\n                       -> Compilation {\n         self.0.early_callback(matches, sopts, descriptions, output)\n@@ -46,7 +46,7 @@ impl<'a> CompilerCalls<'a> for ClippyCompilerCalls {\n                 sopts: &config::Options,\n                 odir: &Option<PathBuf>,\n                 ofile: &Option<PathBuf>,\n-                descriptions: &diagnostics::registry::Registry)\n+                descriptions: &rustc_errors::registry::Registry)\n                 -> Option<(Input, Option<PathBuf>)> {\n         self.0.no_input(matches, sopts, odir, ofile, descriptions)\n     }"}, {"sha": "b23d6a6e4c186c19c237d927700fdd94b27a7ba2", "filename": "tests/compile-fail/collapsible_if.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/d6182b365c09d6729b2ebd1c08e654e064072f67/tests%2Fcompile-fail%2Fcollapsible_if.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d6182b365c09d6729b2ebd1c08e654e064072f67/tests%2Fcompile-fail%2Fcollapsible_if.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Fcollapsible_if.rs?ref=d6182b365c09d6729b2ebd1c08e654e064072f67", "patch": "@@ -175,4 +175,9 @@ fn main() {\n             println!(\"world!\")\n         }\n     }\n+\n+    if true {\n+    } else {\n+        assert!(true); // assert! is just an `if`\n+    }\n }"}, {"sha": "790ca93728bac6043f026d442fc264d572407aeb", "filename": "tests/compile-fail/double_neg.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/d6182b365c09d6729b2ebd1c08e654e064072f67/tests%2Fcompile-fail%2Fdouble_neg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d6182b365c09d6729b2ebd1c08e654e064072f67/tests%2Fcompile-fail%2Fdouble_neg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Fdouble_neg.rs?ref=d6182b365c09d6729b2ebd1c08e654e064072f67", "patch": "@@ -0,0 +1,10 @@\n+#![feature(plugin)]\n+#![plugin(clippy)]\n+\n+#[deny(double_neg)]\n+fn main() {\n+    let x = 1;\n+    -x;\n+    -(-x);\n+    --x; //~ERROR: `--x` could be misinterpreted as pre-decrement by C programmers, is usually a no-op\n+}"}, {"sha": "9b8146dc2293fff49c67264e02e069d6d791c69d", "filename": "tests/compile-fail/formatting.rs", "status": "modified", "additions": 15, "deletions": 1, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/d6182b365c09d6729b2ebd1c08e654e064072f67/tests%2Fcompile-fail%2Fformatting.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d6182b365c09d6729b2ebd1c08e654e064072f67/tests%2Fcompile-fail%2Fformatting.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Fformatting.rs?ref=d6182b365c09d6729b2ebd1c08e654e064072f67", "patch": "@@ -16,7 +16,9 @@ fn main() {\n     //~| NOTE add the missing `else` or\n     }\n \n-    let _ = {\n+    let _ = { // if as the last expression\n+        let _ = 0;\n+\n         if foo() {\n         } if foo() {\n         //~^ ERROR this looks like an `else if` but the `else` is missing\n@@ -26,6 +28,18 @@ fn main() {\n         }\n     };\n \n+    let _ = { // if in the middle of a block\n+        if foo() {\n+        } if foo() {\n+        //~^ ERROR this looks like an `else if` but the `else` is missing\n+        //~| NOTE add the missing `else` or\n+        }\n+        else {\n+        }\n+\n+        let _ = 0;\n+    };\n+\n     if foo() {\n     } else\n     //~^ ERROR this is an `else if` but the formatting might hide it"}, {"sha": "4be89176fc7d1df080d45264a6981d9fc433e146", "filename": "tests/compile-fail/item_after_statement.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/d6182b365c09d6729b2ebd1c08e654e064072f67/tests%2Fcompile-fail%2Fitem_after_statement.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d6182b365c09d6729b2ebd1c08e654e064072f67/tests%2Fcompile-fail%2Fitem_after_statement.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Fitem_after_statement.rs?ref=d6182b365c09d6729b2ebd1c08e654e064072f67", "patch": "@@ -2,6 +2,16 @@\n #![plugin(clippy)]\n #![deny(items_after_statements)]\n \n+fn ok() {\n+    fn foo() { println!(\"foo\"); }\n+    foo();\n+}\n+\n+fn last() {\n+    foo();\n+    fn foo() { println!(\"foo\"); } //~ ERROR adding items after statements is confusing\n+}\n+\n fn main() {\n     foo();\n     fn foo() { println!(\"foo\"); } //~ ERROR adding items after statements is confusing"}, {"sha": "480c16f16660c6a22d5887a5261f9e37a312d115", "filename": "tests/compile-fail/needless_bool.rs", "status": "modified", "additions": 9, "deletions": 9, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/d6182b365c09d6729b2ebd1c08e654e064072f67/tests%2Fcompile-fail%2Fneedless_bool.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d6182b365c09d6729b2ebd1c08e654e064072f67/tests%2Fcompile-fail%2Fneedless_bool.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Fneedless_bool.rs?ref=d6182b365c09d6729b2ebd1c08e654e064072f67", "patch": "@@ -1,8 +1,8 @@\n #![feature(plugin)]\n #![plugin(clippy)]\n+#![deny(needless_bool)]\n \n #[allow(if_same_then_else)]\n-#[deny(needless_bool)]\n fn main() {\n     let x = true;\n     if x { true } else { true }; //~ERROR this if-then-else expression will always return true\n@@ -22,27 +22,27 @@ fn main() {\n     bool_ret4(x);\n }\n \n-#[deny(needless_bool)]\n-#[allow(if_same_then_else)]\n+#[allow(if_same_then_else, needless_return)]\n fn bool_ret(x: bool) -> bool {\n-    if x { return true } else { return true }; //~ERROR this if-then-else expression will always return true\n+    if x { return true } else { return true };\n+    //~^ ERROR this if-then-else expression will always return true\n }\n \n-#[deny(needless_bool)]\n-#[allow(if_same_then_else)]\n+#[allow(if_same_then_else, needless_return)]\n fn bool_ret2(x: bool) -> bool {\n-    if x { return false } else { return false }; //~ERROR this if-then-else expression will always return false\n+    if x { return false } else { return false };\n+    //~^ ERROR this if-then-else expression will always return false\n }\n \n-#[deny(needless_bool)]\n+#[allow(needless_return)]\n fn bool_ret3(x: bool) -> bool {\n     if x { return true } else { return false };\n     //~^ ERROR this if-then-else expression returns a bool literal\n     //~| HELP you can reduce it to\n     //~| SUGGESTION `return x`\n }\n \n-#[deny(needless_bool)]\n+#[allow(needless_return)]\n fn bool_ret4(x: bool) -> bool {\n     if x { return false } else { return true };\n     //~^ ERROR this if-then-else expression returns a bool literal"}, {"sha": "773b889ebff76b8e84177905aa0b8570d8cab74f", "filename": "tests/consts.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/d6182b365c09d6729b2ebd1c08e654e064072f67/tests%2Fconsts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d6182b365c09d6729b2ebd1c08e654e064072f67/tests%2Fconsts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fconsts.rs?ref=d6182b365c09d6729b2ebd1c08e654e064072f67", "patch": "@@ -14,6 +14,7 @@ use syntax::ast::{LitIntType, LitKind, StrStyle};\n use syntax::codemap::{Spanned, COMMAND_LINE_SP};\n use syntax::parse::token::InternedString;\n use syntax::ptr::P;\n+use syntax::util::ThinVec;\n \n fn spanned<T>(t: T) -> Spanned<T> {\n     Spanned {\n@@ -27,7 +28,7 @@ fn expr(n: Expr_) -> Expr {\n         id: 1,\n         node: n,\n         span: COMMAND_LINE_SP,\n-        attrs: None,\n+        attrs: ThinVec::new(),\n     }\n }\n "}]}