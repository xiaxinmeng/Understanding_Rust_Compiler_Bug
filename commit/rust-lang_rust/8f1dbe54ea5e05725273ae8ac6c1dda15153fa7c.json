{"sha": "8f1dbe54ea5e05725273ae8ac6c1dda15153fa7c", "node_id": "C_kwDOAAsO6NoAKDhmMWRiZTU0ZWE1ZTA1NzI1MjczYWU4YWM2YzFkZGExNTE1M2ZhN2M", "commit": {"author": {"name": "Camille GILLOT", "email": "gillot.camille@gmail.com", "date": "2023-01-18T22:59:52Z"}, "committer": {"name": "Camille GILLOT", "email": "gillot.camille@gmail.com", "date": "2023-01-27T18:22:45Z"}, "message": "Discard raw pointers from SSA locals.", "tree": {"sha": "03aa0f0dfacf13ea114617245edad1b6cc99041f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/03aa0f0dfacf13ea114617245edad1b6cc99041f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8f1dbe54ea5e05725273ae8ac6c1dda15153fa7c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8f1dbe54ea5e05725273ae8ac6c1dda15153fa7c", "html_url": "https://github.com/rust-lang/rust/commit/8f1dbe54ea5e05725273ae8ac6c1dda15153fa7c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8f1dbe54ea5e05725273ae8ac6c1dda15153fa7c/comments", "author": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "committer": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d45815eb4ae2737b5fb8f4eeeb0eb3d784efeca3", "url": "https://api.github.com/repos/rust-lang/rust/commits/d45815eb4ae2737b5fb8f4eeeb0eb3d784efeca3", "html_url": "https://github.com/rust-lang/rust/commit/d45815eb4ae2737b5fb8f4eeeb0eb3d784efeca3"}], "stats": {"total": 47, "additions": 45, "deletions": 2}, "files": [{"sha": "bce307d368ca5e24b834962c246e654cc036e575", "filename": "compiler/rustc_mir_transform/src/copy_prop.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/8f1dbe54ea5e05725273ae8ac6c1dda15153fa7c/compiler%2Frustc_mir_transform%2Fsrc%2Fcopy_prop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8f1dbe54ea5e05725273ae8ac6c1dda15153fa7c/compiler%2Frustc_mir_transform%2Fsrc%2Fcopy_prop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_transform%2Fsrc%2Fcopy_prop.rs?ref=8f1dbe54ea5e05725273ae8ac6c1dda15153fa7c", "patch": "@@ -117,8 +117,10 @@ impl<'tcx> Visitor<'tcx> for SsaLocals {\n                 self.assignments[local].insert(LocationExtended::Plain(loc));\n                 self.assignment_order.push(local);\n             }\n-            PlaceContext::MutatingUse(_) => self.assignments[local] = Set1::Many,\n-            // Immutable borrows and AddressOf are taken into account in `SsaLocals::new` by\n+            // Anything can happen with raw pointers, so remove them.\n+            PlaceContext::NonMutatingUse(NonMutatingUseContext::AddressOf)\n+            | PlaceContext::MutatingUse(_) => self.assignments[local] = Set1::Many,\n+            // Immutable borrows are taken into account in `SsaLocals::new` by\n             // removing non-freeze locals.\n             PlaceContext::NonMutatingUse(_) => {\n                 let set = &mut self.assignments[local];"}, {"sha": "61fdd6f8c05bfb72a480e4cf47d0aad63db2abbe", "filename": "tests/mir-opt/copy-prop/mutate_through_pointer.f.CopyProp.diff", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/8f1dbe54ea5e05725273ae8ac6c1dda15153fa7c/tests%2Fmir-opt%2Fcopy-prop%2Fmutate_through_pointer.f.CopyProp.diff", "raw_url": "https://github.com/rust-lang/rust/raw/8f1dbe54ea5e05725273ae8ac6c1dda15153fa7c/tests%2Fmir-opt%2Fcopy-prop%2Fmutate_through_pointer.f.CopyProp.diff", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Fcopy-prop%2Fmutate_through_pointer.f.CopyProp.diff?ref=8f1dbe54ea5e05725273ae8ac6c1dda15153fa7c", "patch": "@@ -0,0 +1,19 @@\n+- // MIR for `f` before CopyProp\n++ // MIR for `f` after CopyProp\n+  \n+  fn f(_1: bool) -> bool {\n+      let mut _0: bool;                    // return place in scope 0 at $DIR/mutate_through_pointer.rs:+0:18: +0:22\n+      let mut _2: bool;                    // in scope 0 at $SRC_DIR/core/src/intrinsics/mir.rs:LL:COL\n+      let mut _3: *const bool;             // in scope 0 at $SRC_DIR/core/src/intrinsics/mir.rs:LL:COL\n+      let mut _4: *mut bool;               // in scope 0 at $SRC_DIR/core/src/intrinsics/mir.rs:LL:COL\n+  \n+      bb0: {\n+          _2 = _1;                         // scope 0 at $SRC_DIR/core/src/intrinsics/mir.rs:LL:COL\n+          _3 = &raw const _2;              // scope 0 at $SRC_DIR/core/src/intrinsics/mir.rs:LL:COL\n+          _4 = &raw mut (*_3);             // scope 0 at $SRC_DIR/core/src/intrinsics/mir.rs:LL:COL\n+          (*_4) = const false;             // scope 0 at $DIR/mutate_through_pointer.rs:+5:9: +5:20\n+          _0 = _1;                         // scope 0 at $DIR/mutate_through_pointer.rs:+6:9: +6:16\n+          return;                          // scope 0 at $DIR/mutate_through_pointer.rs:+7:9: +7:17\n+      }\n+  }\n+  "}, {"sha": "609e49d6bc99864b1354c0199b29705d96bec679", "filename": "tests/mir-opt/copy-prop/mutate_through_pointer.rs", "status": "added", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/8f1dbe54ea5e05725273ae8ac6c1dda15153fa7c/tests%2Fmir-opt%2Fcopy-prop%2Fmutate_through_pointer.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8f1dbe54ea5e05725273ae8ac6c1dda15153fa7c/tests%2Fmir-opt%2Fcopy-prop%2Fmutate_through_pointer.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Fcopy-prop%2Fmutate_through_pointer.rs?ref=8f1dbe54ea5e05725273ae8ac6c1dda15153fa7c", "patch": "@@ -0,0 +1,22 @@\n+#![feature(custom_mir, core_intrinsics)]\n+#![allow(unused_assignments)]\n+extern crate core;\n+use core::intrinsics::mir::*;\n+\n+#[custom_mir(dialect = \"analysis\", phase = \"post-cleanup\")]\n+fn f(c: bool) -> bool {\n+    mir!({\n+        let a = c;\n+        let p = core::ptr::addr_of!(a);\n+        let p2 = core::ptr::addr_of_mut!(*p);\n+        *p2 = false;\n+        RET = c;\n+        Return()\n+    })\n+}\n+\n+fn main() {\n+    assert_eq!(true, f(true));\n+}\n+\n+// EMIT_MIR mutate_through_pointer.f.CopyProp.diff"}]}