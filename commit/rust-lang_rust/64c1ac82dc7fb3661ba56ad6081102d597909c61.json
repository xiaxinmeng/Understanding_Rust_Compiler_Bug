{"sha": "64c1ac82dc7fb3661ba56ad6081102d597909c61", "node_id": "MDY6Q29tbWl0NzI0NzEyOjY0YzFhYzgyZGM3ZmIzNjYxYmE1NmFkNjA4MTEwMmQ1OTc5MDljNjE=", "commit": {"author": {"name": "Andrew Cann", "email": "shum@canndrew.org", "date": "2017-02-06T08:30:01Z"}, "committer": {"name": "Andrew Cann", "email": "shum@canndrew.org", "date": "2017-02-06T08:30:01Z"}, "message": "Fix for bootstrapping on NixOS\n\nNixOS puts Linux's dynamic loader in wierd place. Detect when we're on NixOS\nand patch the downloaded bootstrap executables appropriately.", "tree": {"sha": "8611d2d4e17cb80274206823b631909f8d00fca7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8611d2d4e17cb80274206823b631909f8d00fca7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/64c1ac82dc7fb3661ba56ad6081102d597909c61", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/64c1ac82dc7fb3661ba56ad6081102d597909c61", "html_url": "https://github.com/rust-lang/rust/commit/64c1ac82dc7fb3661ba56ad6081102d597909c61", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/64c1ac82dc7fb3661ba56ad6081102d597909c61/comments", "author": {"login": "canndrew", "id": 5555066, "node_id": "MDQ6VXNlcjU1NTUwNjY=", "avatar_url": "https://avatars.githubusercontent.com/u/5555066?v=4", "gravatar_id": "", "url": "https://api.github.com/users/canndrew", "html_url": "https://github.com/canndrew", "followers_url": "https://api.github.com/users/canndrew/followers", "following_url": "https://api.github.com/users/canndrew/following{/other_user}", "gists_url": "https://api.github.com/users/canndrew/gists{/gist_id}", "starred_url": "https://api.github.com/users/canndrew/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/canndrew/subscriptions", "organizations_url": "https://api.github.com/users/canndrew/orgs", "repos_url": "https://api.github.com/users/canndrew/repos", "events_url": "https://api.github.com/users/canndrew/events{/privacy}", "received_events_url": "https://api.github.com/users/canndrew/received_events", "type": "User", "site_admin": false}, "committer": {"login": "canndrew", "id": 5555066, "node_id": "MDQ6VXNlcjU1NTUwNjY=", "avatar_url": "https://avatars.githubusercontent.com/u/5555066?v=4", "gravatar_id": "", "url": "https://api.github.com/users/canndrew", "html_url": "https://github.com/canndrew", "followers_url": "https://api.github.com/users/canndrew/followers", "following_url": "https://api.github.com/users/canndrew/following{/other_user}", "gists_url": "https://api.github.com/users/canndrew/gists{/gist_id}", "starred_url": "https://api.github.com/users/canndrew/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/canndrew/subscriptions", "organizations_url": "https://api.github.com/users/canndrew/orgs", "repos_url": "https://api.github.com/users/canndrew/repos", "events_url": "https://api.github.com/users/canndrew/events{/privacy}", "received_events_url": "https://api.github.com/users/canndrew/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a3da24bba940831697a024b93569891c77675778", "url": "https://api.github.com/repos/rust-lang/rust/commits/a3da24bba940831697a024b93569891c77675778", "html_url": "https://github.com/rust-lang/rust/commit/a3da24bba940831697a024b93569891c77675778"}], "stats": {"total": 57, "additions": 56, "deletions": 1}, "files": [{"sha": "c5e00a58185229570931af8dfa86c149d728da49", "filename": "src/bootstrap/bootstrap.py", "status": "modified", "additions": 56, "deletions": 1, "changes": 57, "blob_url": "https://github.com/rust-lang/rust/blob/64c1ac82dc7fb3661ba56ad6081102d597909c61/src%2Fbootstrap%2Fbootstrap.py", "raw_url": "https://github.com/rust-lang/rust/raw/64c1ac82dc7fb3661ba56ad6081102d597909c61/src%2Fbootstrap%2Fbootstrap.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbootstrap.py?ref=64c1ac82dc7fb3661ba56ad6081102d597909c61", "patch": "@@ -89,7 +89,6 @@ def verify(path, sha_path, verbose):\n                \"    expected: {}\".format(found, expected))\n     return verified\n \n-\n def unpack(tarball, dst, verbose=False, match=None):\n     print(\"extracting \" + tarball)\n     fname = os.path.basename(tarball).replace(\".tar.gz\", \"\")\n@@ -173,6 +172,8 @@ def download_stage0(self):\n             if not os.path.exists(tarball):\n                 get(\"{}/{}\".format(url, filename), tarball, verbose=self.verbose)\n             unpack(tarball, self.bin_root(), match=\"rustc\", verbose=self.verbose)\n+            self.fix_executable(self.bin_root() + \"/bin/rustc\")\n+            self.fix_executable(self.bin_root() + \"/bin/rustdoc\")\n             with open(self.rustc_stamp(), 'w') as f:\n                 f.write(self.stage0_rustc_date())\n \n@@ -185,9 +186,63 @@ def download_stage0(self):\n             if not os.path.exists(tarball):\n                 get(\"{}/{}\".format(url, filename), tarball, verbose=self.verbose)\n             unpack(tarball, self.bin_root(), match=\"cargo\", verbose=self.verbose)\n+            self.fix_executable(self.bin_root() + \"/bin/cargo\")\n             with open(self.cargo_stamp(), 'w') as f:\n                 f.write(self.stage0_cargo_rev())\n \n+    def fix_executable(self, fname):\n+        # If we're on NixOS we need to change the path to the dynamic loader\n+\n+        default_encoding = sys.getdefaultencoding()\n+        try:\n+            ostype = subprocess.check_output(['uname', '-s']).strip().decode(default_encoding)\n+        except (subprocess.CalledProcessError, WindowsError):\n+            return\n+\n+        if ostype != \"Linux\":\n+            return\n+\n+        if not os.path.exists(\"/nix/store\"):\n+            return\n+        if os.path.exists(\"/lib\"):\n+            return\n+\n+        # At this point we're pretty sure the user is running NixOS\n+        print(\"Info: you seem to be running NixOS. Attempting to patch \" + fname)\n+\n+        try:\n+            interpreter = subprocess.check_output([\"patchelf\", \"--print-interpreter\", fname])\n+            interpreter = interpreter.strip().decode(default_encoding)\n+        except subprocess.CalledProcessError as e:\n+            print(\"Warning: failed to call patchelf: %s\" % e)\n+            return\n+\n+        loader = interpreter.split(\"/\")[-1]\n+\n+        try:\n+            ldd_output = subprocess.check_output(['ldd', '/run/current-system/sw/bin/sh'])\n+            ldd_output = ldd_output.strip().decode(default_encoding)\n+        except subprocess.CalledProcessError as e:\n+            print(\"Warning: unable to call ldd: %s\" % e)\n+            return\n+\n+        for line in ldd_output.splitlines():\n+            libname = line.split()[0]\n+            if libname.endswith(loader):\n+                loader_path = libname[:len(libname) - len(loader)]\n+                break\n+        else:\n+            print(\"Warning: unable to find the path to the dynamic linker\")\n+            return\n+\n+        correct_interpreter = loader_path + loader\n+\n+        try:\n+            subprocess.check_output([\"patchelf\", \"--set-interpreter\", correct_interpreter, fname])\n+        except subprocess.CalledProcessError as e:\n+            print(\"Warning: failed to call patchelf: %s\" % e)\n+            return\n+\n     def stage0_cargo_rev(self):\n         return self._cargo_rev\n "}]}