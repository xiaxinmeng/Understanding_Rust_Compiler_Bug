{"sha": "aaa170bebe31d03e2eea14e8cb06dc2e8891216b", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFhYTE3MGJlYmUzMWQwM2UyZWVhMTRlOGNiMDZkYzJlODg5MTIxNmI=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-08-31T17:39:28Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-08-31T17:39:28Z"}, "message": "Auto merge of #51384 - QuietMisdreavus:extern-version, r=GuillaumeGomez\n\nrustdoc: add flag to control the html_root_url of dependencies\n\nThe `--extern-html-root-url` flag in this PR allows one to override links to crates whose docs are not already available locally in the doc bundle. Docs.rs currently uses a version of this to make sure links to other crates go into that crate's docs.rs page. See the included test for intended use, but the idea is as follows:\n\nCalling rustdoc with `--extern-html-root-url crate=https://some-url.com` will cause rustdoc to override links that point to that crate to instead be replaced with a link rooted at `https://some-url.com/`. (e.g. for docs.rs this would be `https://docs.rs/crate/0.1.0` or the like.) Cheekily, rustup could use these options to redirect links to std/core/etc to instead point to locally-downloaded docs, if it so desired.\n\nFixes https://github.com/rust-lang/rust/issues/19603", "tree": {"sha": "69401f21bce6a0136c59a6df85f20da6f29e700a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/69401f21bce6a0136c59a6df85f20da6f29e700a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/aaa170bebe31d03e2eea14e8cb06dc2e8891216b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/aaa170bebe31d03e2eea14e8cb06dc2e8891216b", "html_url": "https://github.com/rust-lang/rust/commit/aaa170bebe31d03e2eea14e8cb06dc2e8891216b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/aaa170bebe31d03e2eea14e8cb06dc2e8891216b/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "163adf2860d0a5d9eff0e401e314de9383ff56a1", "url": "https://api.github.com/repos/rust-lang/rust/commits/163adf2860d0a5d9eff0e401e314de9383ff56a1", "html_url": "https://github.com/rust-lang/rust/commit/163adf2860d0a5d9eff0e401e314de9383ff56a1"}, {"sha": "fcb54f674ab5f86b72ef97178a3df255f1ef4783", "url": "https://api.github.com/repos/rust-lang/rust/commits/fcb54f674ab5f86b72ef97178a3df255f1ef4783", "html_url": "https://github.com/rust-lang/rust/commit/fcb54f674ab5f86b72ef97178a3df255f1ef4783"}], "stats": {"total": 79, "additions": 76, "deletions": 3}, "files": [{"sha": "a23dbd308244fab569f1d1dd276e768d4a98c471", "filename": "src/doc/rustdoc/src/unstable-features.md", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/aaa170bebe31d03e2eea14e8cb06dc2e8891216b/src%2Fdoc%2Frustdoc%2Fsrc%2Funstable-features.md", "raw_url": "https://github.com/rust-lang/rust/raw/aaa170bebe31d03e2eea14e8cb06dc2e8891216b/src%2Fdoc%2Frustdoc%2Fsrc%2Funstable-features.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Frustdoc%2Fsrc%2Funstable-features.md?ref=aaa170bebe31d03e2eea14e8cb06dc2e8891216b", "patch": "@@ -361,6 +361,21 @@ This flag allows rustdoc to treat your rust code as the given edition. It will c\n the given edition as well. As with `rustc`, the default edition that `rustdoc` will use is `2015`\n (the first edition).\n \n+### `--extern-html-root-url`: control how rustdoc links to non-local crates\n+\n+Using this flag looks like this:\n+\n+```bash\n+$ rustdoc src/lib.rs -Z unstable-options --extern-html-root-url some-crate=https://example.com/some-crate/1.0.1\n+```\n+\n+Ordinarily, when rustdoc wants to link to a type from a different crate, it looks in two places:\n+docs that already exist in the output directory, or the `#![doc(doc_html_root)]` set in the other\n+crate. However, if you want to link to docs that exist in neither of those places, you can use these\n+flags to control that behavior. When the `--extern-html-root-url` flag is given with a name matching\n+one of your dependencies, rustdoc use that URL for those docs. Keep in mind that if those docs exist\n+in the output directory, those local docs will still override this flag.\n+\n ### `-Z force-unstable-if-unmarked`\n \n Using this flag looks like this:"}, {"sha": "be51ab5484da7df1f92a4e9b5fe139e7143f59d8", "filename": "src/librustdoc/html/render.rs", "status": "modified", "additions": 14, "deletions": 2, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/aaa170bebe31d03e2eea14e8cb06dc2e8891216b/src%2Flibrustdoc%2Fhtml%2Frender.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aaa170bebe31d03e2eea14e8cb06dc2e8891216b/src%2Flibrustdoc%2Fhtml%2Frender.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender.rs?ref=aaa170bebe31d03e2eea14e8cb06dc2e8891216b", "patch": "@@ -479,6 +479,7 @@ pub fn initial_ids() -> Vec<String> {\n \n /// Generates the documentation for `crate` into the directory `dst`\n pub fn run(mut krate: clean::Crate,\n+           extern_urls: BTreeMap<String, String>,\n            external_html: &ExternalHtml,\n            playground_url: Option<String>,\n            dst: PathBuf,\n@@ -611,8 +612,9 @@ pub fn run(mut krate: clean::Crate,\n             },\n             _ => PathBuf::new(),\n         };\n+        let extern_url = extern_urls.get(&e.name).map(|u| &**u);\n         cache.extern_locations.insert(n, (e.name.clone(), src_root,\n-                                          extern_location(e, &cx.dst)));\n+                                          extern_location(e, extern_url, &cx.dst)));\n \n         let did = DefId { krate: n, index: CRATE_DEF_INDEX };\n         cache.external_paths.insert(did, (vec![e.name.to_string()], ItemType::Module));\n@@ -1096,13 +1098,23 @@ fn clean_srcpath<F>(src_root: &Path, p: &Path, keep_filename: bool, mut f: F) wh\n \n /// Attempts to find where an external crate is located, given that we're\n /// rendering in to the specified source destination.\n-fn extern_location(e: &clean::ExternalCrate, dst: &Path) -> ExternalLocation {\n+fn extern_location(e: &clean::ExternalCrate, extern_url: Option<&str>, dst: &Path)\n+    -> ExternalLocation\n+{\n     // See if there's documentation generated into the local directory\n     let local_location = dst.join(&e.name);\n     if local_location.is_dir() {\n         return Local;\n     }\n \n+    if let Some(url) = extern_url {\n+        let mut url = url.to_string();\n+        if !url.ends_with(\"/\") {\n+            url.push('/');\n+        }\n+        return Remote(url);\n+    }\n+\n     // Failing that, see if there's an attribute specifying where to find this\n     // external crate\n     e.attrs.lists(\"doc\")"}, {"sha": "df885d8a772fbcfa040d04249fcd6a9d12d56e20", "filename": "src/librustdoc/lib.rs", "status": "modified", "additions": 29, "deletions": 1, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/aaa170bebe31d03e2eea14e8cb06dc2e8891216b/src%2Flibrustdoc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aaa170bebe31d03e2eea14e8cb06dc2e8891216b/src%2Flibrustdoc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Flib.rs?ref=aaa170bebe31d03e2eea14e8cb06dc2e8891216b", "patch": "@@ -162,6 +162,10 @@ fn opts() -> Vec<RustcOptGroup> {\n         stable(\"extern\", |o| {\n             o.optmulti(\"\", \"extern\", \"pass an --extern to rustc\", \"NAME=PATH\")\n         }),\n+        unstable(\"extern-html-root-url\", |o| {\n+            o.optmulti(\"\", \"extern-html-root-url\",\n+                       \"base URL to use for dependencies\", \"NAME=URL\")\n+        }),\n         stable(\"plugin-path\", |o| {\n             o.optmulti(\"\", \"plugin-path\", \"removed\", \"DIR\")\n         }),\n@@ -453,6 +457,13 @@ fn main_args(args: &[String]) -> isize {\n             return 1;\n         }\n     };\n+    let extern_urls = match parse_extern_html_roots(&matches) {\n+        Ok(ex) => ex,\n+        Err(err) => {\n+            diag.struct_err(err).emit();\n+            return 1;\n+        }\n+    };\n \n     let test_args = matches.opt_strs(\"test-args\");\n     let test_args: Vec<String> = test_args.iter()\n@@ -553,7 +564,7 @@ fn main_args(args: &[String]) -> isize {\n         info!(\"going to format\");\n         match output_format.as_ref().map(|s| &**s) {\n             Some(\"html\") | None => {\n-                html::render::run(krate, &external_html, playground_url,\n+                html::render::run(krate, extern_urls, &external_html, playground_url,\n                                   output.unwrap_or(PathBuf::from(\"doc\")),\n                                   resource_suffix.unwrap_or(String::new()),\n                                   passes.into_iter().collect(),\n@@ -612,6 +623,23 @@ fn parse_externs(matches: &getopts::Matches) -> Result<Externs, String> {\n     Ok(Externs::new(externs))\n }\n \n+/// Extracts `--extern-html-root-url` arguments from `matches` and returns a map of crate names to\n+/// the given URLs. If an `--extern-html-root-url` argument was ill-formed, returns an error\n+/// describing the issue.\n+fn parse_extern_html_roots(matches: &getopts::Matches)\n+    -> Result<BTreeMap<String, String>, &'static str>\n+{\n+    let mut externs = BTreeMap::new();\n+    for arg in &matches.opt_strs(\"extern-html-root-url\") {\n+        let mut parts = arg.splitn(2, '=');\n+        let name = parts.next().ok_or(\"--extern-html-root-url must not be empty\")?;\n+        let url = parts.next().ok_or(\"--extern-html-root-url must be of the form name=url\")?;\n+        externs.insert(name.to_string(), url.to_string());\n+    }\n+\n+    Ok(externs)\n+}\n+\n /// Interprets the input file as a rust source file, passing it through the\n /// compiler all the way through the analysis passes. The rustdoc output is then\n /// generated from the cleaned AST of the crate."}, {"sha": "c8a13bec9d321a19a7d56f14683671754f750a81", "filename": "src/test/rustdoc/extern-html-root-url.rs", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/aaa170bebe31d03e2eea14e8cb06dc2e8891216b/src%2Ftest%2Frustdoc%2Fextern-html-root-url.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aaa170bebe31d03e2eea14e8cb06dc2e8891216b/src%2Ftest%2Frustdoc%2Fextern-html-root-url.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fextern-html-root-url.rs?ref=aaa170bebe31d03e2eea14e8cb06dc2e8891216b", "patch": "@@ -0,0 +1,18 @@\n+// Copyright 2012-2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// ignore-tidy-linelength\n+\n+// compile-flags:-Z unstable-options --extern-html-root-url core=https://example.com/core/0.1.0\n+\n+// @has extern_html_root_url/index.html\n+// @has - '//a/@href' 'https://example.com/core/0.1.0/core/iter/index.html'\n+#[doc(no_inline)]\n+pub use std::iter;"}]}