{"sha": "17d32770649fefe8efe6510f7dbff6123f544ba6", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE3ZDMyNzcwNjQ5ZmVmZThlZmU2NTEwZjdkYmZmNjEyM2Y1NDRiYTY=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-09-13T11:08:41Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-09-13T11:08:41Z"}, "message": "Auto merge of #76598 - ad-anssi:diagnostic_errors_fix, r=estebank\n\nFixing memory exhaustion when formatting short code suggestion\n\nDetails can be found in issue #76597. This PR replaces substractions with `saturating_sub`'s to avoid usize wrapping leading to memory exhaustion when formatting short suggestion messages.", "tree": {"sha": "b135999cff4666b2b182c288f85dda8ae5f53cbc", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b135999cff4666b2b182c288f85dda8ae5f53cbc"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/17d32770649fefe8efe6510f7dbff6123f544ba6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/17d32770649fefe8efe6510f7dbff6123f544ba6", "html_url": "https://github.com/rust-lang/rust/commit/17d32770649fefe8efe6510f7dbff6123f544ba6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/17d32770649fefe8efe6510f7dbff6123f544ba6/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b6c84553c4fa47174d2510541a90243000fb44d8", "url": "https://api.github.com/repos/rust-lang/rust/commits/b6c84553c4fa47174d2510541a90243000fb44d8", "html_url": "https://github.com/rust-lang/rust/commit/b6c84553c4fa47174d2510541a90243000fb44d8"}, {"sha": "62068a59eea44ff78c4293d5fcc676279b1deab0", "url": "https://api.github.com/repos/rust-lang/rust/commits/62068a59eea44ff78c4293d5fcc676279b1deab0", "html_url": "https://github.com/rust-lang/rust/commit/62068a59eea44ff78c4293d5fcc676279b1deab0"}], "stats": {"total": 47, "additions": 43, "deletions": 4}, "files": [{"sha": "4555168af0ab526bafca9d45a7eb5415c852cf22", "filename": "compiler/rustc_errors/src/emitter.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/17d32770649fefe8efe6510f7dbff6123f544ba6/compiler%2Frustc_errors%2Fsrc%2Femitter.rs", "raw_url": "https://github.com/rust-lang/rust/raw/17d32770649fefe8efe6510f7dbff6123f544ba6/compiler%2Frustc_errors%2Fsrc%2Femitter.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_errors%2Fsrc%2Femitter.rs?ref=17d32770649fefe8efe6510f7dbff6123f544ba6", "patch": "@@ -959,15 +959,15 @@ impl EmitterWriter {\n                         '_',\n                         line_offset + pos,\n                         width_offset + depth,\n-                        code_offset + annotation.start_col - left,\n+                        (code_offset + annotation.start_col).saturating_sub(left),\n                         style,\n                     );\n                 }\n                 _ if self.teach => {\n                     buffer.set_style_range(\n                         line_offset,\n-                        code_offset + annotation.start_col - left,\n-                        code_offset + annotation.end_col - left,\n+                        (code_offset + annotation.start_col).saturating_sub(left),\n+                        (code_offset + annotation.end_col).saturating_sub(left),\n                         style,\n                         annotation.is_primary,\n                     );"}, {"sha": "7340c5744808c4325c93a3e6469a5a98f5617345", "filename": "compiler/rustc_parse/src/parser/mod.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/17d32770649fefe8efe6510f7dbff6123f544ba6/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/17d32770649fefe8efe6510f7dbff6123f544ba6/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fmod.rs?ref=17d32770649fefe8efe6510f7dbff6123f544ba6", "patch": "@@ -694,9 +694,13 @@ impl<'a> Parser<'a> {\n                                 Ok(t) => {\n                                     // Parsed successfully, therefore most probably the code only\n                                     // misses a separator.\n+                                    let mut exp_span = self.sess.source_map().next_point(sp);\n+                                    if self.sess.source_map().is_multiline(exp_span) {\n+                                        exp_span = sp;\n+                                    }\n                                     expect_err\n                                         .span_suggestion_short(\n-                                            self.sess.source_map().next_point(sp),\n+                                            exp_span,\n                                             &format!(\"missing `{}`\", token_str),\n                                             token_str,\n                                             Applicability::MaybeIncorrect,"}, {"sha": "2d7a30b8361ad7b2ccc11845bd6cd5154f526921", "filename": "src/test/ui/issue-76597.fixed", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/17d32770649fefe8efe6510f7dbff6123f544ba6/src%2Ftest%2Fui%2Fissue-76597.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/17d32770649fefe8efe6510f7dbff6123f544ba6/src%2Ftest%2Fui%2Fissue-76597.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissue-76597.fixed?ref=17d32770649fefe8efe6510f7dbff6123f544ba6", "patch": "@@ -0,0 +1,11 @@\n+// run-rustfix\n+\n+#![allow(dead_code)]\n+#![allow(unused_variables)]\n+fn f(\n+                                     x: u8,\n+                                     y: u8,\n+) {}\n+//~^^ ERROR: expected one of `!`, `(`, `)`, `+`, `,`, `::`, or `<`, found `y`\n+\n+fn main() {}"}, {"sha": "521b9c64b1c5714bcf8bdf84f629bb1163f5c3bf", "filename": "src/test/ui/issue-76597.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/17d32770649fefe8efe6510f7dbff6123f544ba6/src%2Ftest%2Fui%2Fissue-76597.rs", "raw_url": "https://github.com/rust-lang/rust/raw/17d32770649fefe8efe6510f7dbff6123f544ba6/src%2Ftest%2Fui%2Fissue-76597.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissue-76597.rs?ref=17d32770649fefe8efe6510f7dbff6123f544ba6", "patch": "@@ -0,0 +1,11 @@\n+// run-rustfix\n+\n+#![allow(dead_code)]\n+#![allow(unused_variables)]\n+fn f(\n+                                     x: u8\n+                                     y: u8,\n+) {}\n+//~^^ ERROR: expected one of `!`, `(`, `)`, `+`, `,`, `::`, or `<`, found `y`\n+\n+fn main() {}"}, {"sha": "50b23329f0cebd2f8400354675514ba9fd844d0f", "filename": "src/test/ui/issue-76597.stderr", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/17d32770649fefe8efe6510f7dbff6123f544ba6/src%2Ftest%2Fui%2Fissue-76597.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/17d32770649fefe8efe6510f7dbff6123f544ba6/src%2Ftest%2Fui%2Fissue-76597.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissue-76597.stderr?ref=17d32770649fefe8efe6510f7dbff6123f544ba6", "patch": "@@ -0,0 +1,13 @@\n+error: expected one of `!`, `(`, `)`, `+`, `,`, `::`, or `<`, found `y`\n+  --> $DIR/issue-76597.rs:7:38\n+   |\n+LL | ...                   x: u8\n+   |                            -\n+   |                            |\n+   |                            expected one of 7 possible tokens\n+   |                            help: missing `,`\n+LL | ...                   y: u8,\n+   |                       ^ unexpected token\n+\n+error: aborting due to previous error\n+"}]}