{"sha": "9bb3832ebd7aa820366598187862fd6370aefd9f", "node_id": "C_kwDOAAsO6NoAKDliYjM4MzJlYmQ3YWE4MjAzNjY1OTgxODc4NjJmZDYzNzBhZWZkOWY", "commit": {"author": {"name": "Dylan DPC", "email": "99973273+Dylan-DPC@users.noreply.github.com", "date": "2022-05-30T12:33:51Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-05-30T12:33:51Z"}, "message": "Rollup merge of #97519 - binggh:readd-help-on-error, r=jyn514\n\nRe-add help_on_error for download-ci-llvm\n\nCloses #97503\n\n- Re-added `help_on_error` for `download_component()` and the downstream functions\n- Removed dead code in `bootstrap.py`\n\nThanks `@jyn514` for the helpful tips!\n\n(first contribution here, please let me know if I missed anything out!)", "tree": {"sha": "6c80776050306e1032a3ceb450f50fa32144d9c9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6c80776050306e1032a3ceb450f50fa32144d9c9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9bb3832ebd7aa820366598187862fd6370aefd9f", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJilLmvCRBK7hj4Ov3rIwAAc4oIAAcebRlvqYHB7WWLbXMN31fZ\nUUiOCVT3Yew6o8mLnqJWuoNj73rUzJO9GKphAUO8N0WFKOc13XdHgljO3pUwKMRu\n+sRqJoZ64pMDohg+eJeWsv2DWp49KHC6otzrae5mTOfNEwdgy/QpKsQ1nmRHH+ja\neGBx0NC1KnSKVnYLdi+6CYuuZuWcU5NWC9kvVD+ZnOxjkSksyfBdBf7I8p7srt4Y\ncaAYlhZ58xCjByKFk6+f1nYWREn5x2oshFb+yjglUw/FQfB6bA8sOJIicUKSefRQ\nze3XdtcT6U32tlx5c0dvGUcKgjlvlx3WqnjldSh/1K0rWOEHlFWO2KfKAgfqRhY=\n=ap/G\n-----END PGP SIGNATURE-----\n", "payload": "tree 6c80776050306e1032a3ceb450f50fa32144d9c9\nparent 106d5fde92f210b9a1728a54b9ce76ad52641b40\nparent c0f18f9412f222e7f314a637d69968618f633b01\nauthor Dylan DPC <99973273+Dylan-DPC@users.noreply.github.com> 1653914031 +0200\ncommitter GitHub <noreply@github.com> 1653914031 +0200\n\nRollup merge of #97519 - binggh:readd-help-on-error, r=jyn514\n\nRe-add help_on_error for download-ci-llvm\n\nCloses #97503\n\n- Re-added `help_on_error` for `download_component()` and the downstream functions\n- Removed dead code in `bootstrap.py`\n\nThanks `@jyn514` for the helpful tips!\n\n(first contribution here, please let me know if I missed anything out!)\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9bb3832ebd7aa820366598187862fd6370aefd9f", "html_url": "https://github.com/rust-lang/rust/commit/9bb3832ebd7aa820366598187862fd6370aefd9f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9bb3832ebd7aa820366598187862fd6370aefd9f/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "106d5fde92f210b9a1728a54b9ce76ad52641b40", "url": "https://api.github.com/repos/rust-lang/rust/commits/106d5fde92f210b9a1728a54b9ce76ad52641b40", "html_url": "https://github.com/rust-lang/rust/commit/106d5fde92f210b9a1728a54b9ce76ad52641b40"}, {"sha": "c0f18f9412f222e7f314a637d69968618f633b01", "url": "https://api.github.com/repos/rust-lang/rust/commits/c0f18f9412f222e7f314a637d69968618f633b01", "html_url": "https://github.com/rust-lang/rust/commit/c0f18f9412f222e7f314a637d69968618f633b01"}], "stats": {"total": 45, "additions": 30, "deletions": 15}, "files": [{"sha": "a997c4f63abb8ace72ea3265a18486f8159c58bd", "filename": "src/bootstrap/bootstrap.py", "status": "modified", "additions": 8, "deletions": 10, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/9bb3832ebd7aa820366598187862fd6370aefd9f/src%2Fbootstrap%2Fbootstrap.py", "raw_url": "https://github.com/rust-lang/rust/raw/9bb3832ebd7aa820366598187862fd6370aefd9f/src%2Fbootstrap%2Fbootstrap.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbootstrap.py?ref=9bb3832ebd7aa820366598187862fd6370aefd9f", "patch": "@@ -63,7 +63,7 @@ def support_xz():\n     except tarfile.CompressionError:\n         return False\n \n-def get(base, url, path, checksums, verbose=False, do_verify=True, help_on_error=None):\n+def get(base, url, path, checksums, verbose=False, do_verify=True):\n     with tempfile.NamedTemporaryFile(delete=False) as temp_file:\n         temp_path = temp_file.name\n \n@@ -86,7 +86,7 @@ def get(base, url, path, checksums, verbose=False, do_verify=True, help_on_error\n                         print(\"ignoring already-download file\",\n                             path, \"due to failed verification\")\n                     os.unlink(path)\n-        download(temp_path, \"{}/{}\".format(base, url), True, verbose, help_on_error=help_on_error)\n+        download(temp_path, \"{}/{}\".format(base, url), True, verbose)\n         if do_verify and not verify(temp_path, sha256, verbose):\n             raise RuntimeError(\"failed verification\")\n         if verbose:\n@@ -99,17 +99,17 @@ def get(base, url, path, checksums, verbose=False, do_verify=True, help_on_error\n             os.unlink(temp_path)\n \n \n-def download(path, url, probably_big, verbose, help_on_error=None):\n+def download(path, url, probably_big, verbose):\n     for _ in range(0, 4):\n         try:\n-            _download(path, url, probably_big, verbose, True, help_on_error=help_on_error)\n+            _download(path, url, probably_big, verbose, True)\n             return\n         except RuntimeError:\n             print(\"\\nspurious failure, trying again\")\n-    _download(path, url, probably_big, verbose, False, help_on_error=help_on_error)\n+    _download(path, url, probably_big, verbose, False)\n \n \n-def _download(path, url, probably_big, verbose, exception, help_on_error=None):\n+def _download(path, url, probably_big, verbose, exception):\n     # Try to use curl (potentially available on win32\n     #    https://devblogs.microsoft.com/commandline/tar-and-curl-come-to-windows/)\n     # If an error occurs:\n@@ -134,7 +134,7 @@ def _download(path, url, probably_big, verbose, exception, help_on_error=None):\n              \"--retry\", \"3\", \"-Sf\", \"-o\", path, url],\n             verbose=verbose,\n             exception=True, # Will raise RuntimeError on failure\n-            help_on_error=help_on_error)\n+        )\n     except (subprocess.CalledProcessError, OSError, RuntimeError):\n         # see http://serverfault.com/questions/301128/how-to-download\n         if platform_is_win32:\n@@ -186,7 +186,7 @@ def unpack(tarball, tarball_suffix, dst, verbose=False, match=None):\n     shutil.rmtree(os.path.join(dst, fname))\n \n \n-def run(args, verbose=False, exception=False, is_bootstrap=False, help_on_error=None, **kwargs):\n+def run(args, verbose=False, exception=False, is_bootstrap=False, **kwargs):\n     \"\"\"Run a child program in a new process\"\"\"\n     if verbose:\n         print(\"running: \" + ' '.join(args))\n@@ -197,8 +197,6 @@ def run(args, verbose=False, exception=False, is_bootstrap=False, help_on_error=\n     code = ret.wait()\n     if code != 0:\n         err = \"failed to run: \" + ' '.join(args)\n-        if help_on_error is not None:\n-            err += \"\\n\" + help_on_error\n         if verbose or exception:\n             raise RuntimeError(err)\n         # For most failures, we definitely do want to print this error, or the user will have no"}, {"sha": "17c2d1c79ec5c4cdbb75a8383ebbf9a21a63692c", "filename": "src/bootstrap/builder.rs", "status": "modified", "additions": 12, "deletions": 3, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/9bb3832ebd7aa820366598187862fd6370aefd9f/src%2Fbootstrap%2Fbuilder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9bb3832ebd7aa820366598187862fd6370aefd9f/src%2Fbootstrap%2Fbuilder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuilder.rs?ref=9bb3832ebd7aa820366598187862fd6370aefd9f", "patch": "@@ -869,15 +869,21 @@ impl<'a> Builder<'a> {\n         self.try_run(patchelf.arg(fname));\n     }\n \n-    pub(crate) fn download_component(&self, base: &str, url: &str, dest_path: &Path) {\n+    pub(crate) fn download_component(\n+        &self,\n+        base: &str,\n+        url: &str,\n+        dest_path: &Path,\n+        help_on_error: &str,\n+    ) {\n         // Use a temporary file in case we crash while downloading, to avoid a corrupt download in cache/.\n         let tempfile = self.tempdir().join(dest_path.file_name().unwrap());\n         // FIXME: support `do_verify` (only really needed for nightly rustfmt)\n-        self.download_with_retries(&tempfile, &format!(\"{}/{}\", base, url));\n+        self.download_with_retries(&tempfile, &format!(\"{}/{}\", base, url), help_on_error);\n         t!(std::fs::rename(&tempfile, dest_path));\n     }\n \n-    fn download_with_retries(&self, tempfile: &Path, url: &str) {\n+    fn download_with_retries(&self, tempfile: &Path, url: &str, help_on_error: &str) {\n         println!(\"downloading {}\", url);\n         // Try curl. If that fails and we are on windows, fallback to PowerShell.\n         let mut curl = Command::new(\"curl\");\n@@ -914,6 +920,9 @@ impl<'a> Builder<'a> {\n                     println!(\"\\nspurious failure, trying again\");\n                 }\n             }\n+            if !help_on_error.is_empty() {\n+                eprintln!(\"{}\", help_on_error);\n+            }\n             std::process::exit(1);\n         }\n     }"}, {"sha": "8e94fc7c4bea5512395bbe24e1bbd9ef302ab29b", "filename": "src/bootstrap/config.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/9bb3832ebd7aa820366598187862fd6370aefd9f/src%2Fbootstrap%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9bb3832ebd7aa820366598187862fd6370aefd9f/src%2Fbootstrap%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fconfig.rs?ref=9bb3832ebd7aa820366598187862fd6370aefd9f", "patch": "@@ -1491,7 +1491,7 @@ fn download_component(builder: &Builder<'_>, filename: String, prefix: &str, com\n     let url = format!(\"rustc-builds/{commit}\");\n     let tarball = rustc_cache.join(&filename);\n     if !tarball.exists() {\n-        builder.download_component(base, &format!(\"{url}/{filename}\"), &tarball);\n+        builder.download_component(base, &format!(\"{url}/{filename}\"), &tarball, \"\");\n     }\n     let bin_root = builder.out.join(builder.config.build.triple).join(\"ci-rustc\");\n     builder.unpack(&tarball, &bin_root, prefix)"}, {"sha": "a41079333b1aabbe3bd39f33c466c00f89f82d3c", "filename": "src/bootstrap/native.rs", "status": "modified", "additions": 9, "deletions": 1, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/9bb3832ebd7aa820366598187862fd6370aefd9f/src%2Fbootstrap%2Fnative.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9bb3832ebd7aa820366598187862fd6370aefd9f/src%2Fbootstrap%2Fnative.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fnative.rs?ref=9bb3832ebd7aa820366598187862fd6370aefd9f", "patch": "@@ -179,7 +179,15 @@ fn download_ci_llvm(builder: &Builder<'_>, llvm_sha: &str) {\n     let filename = format!(\"rust-dev-nightly-{}.tar.xz\", builder.build.build.triple);\n     let tarball = rustc_cache.join(&filename);\n     if !tarball.exists() {\n-        builder.download_component(base, &format!(\"{}/{}\", url, filename), &tarball);\n+        let help_on_error = \"error: failed to download llvm from ci\\n\n+\\nhelp: old builds get deleted after a certain time\n+\\nhelp: if trying to compile an old commit of rustc, disable `download-ci-llvm` in config.toml:\n+\\n\n+\\n[llvm]\n+\\ndownload-ci-llvm = false\n+\\n\n+\";\n+        builder.download_component(base, &format!(\"{}/{}\", url, filename), &tarball, help_on_error);\n     }\n     let llvm_root = builder.config.ci_llvm_root();\n     builder.unpack(&tarball, &llvm_root, \"rust-dev\");"}]}