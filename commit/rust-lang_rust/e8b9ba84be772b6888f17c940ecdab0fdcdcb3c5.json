{"sha": "e8b9ba84be772b6888f17c940ecdab0fdcdcb3c5", "node_id": "C_kwDOAAsO6NoAKGU4YjliYTg0YmU3NzJiNjg4OGYxN2M5NDBlY2RhYjBmZGNkY2IzYzU", "commit": {"author": {"name": "Josh Stone", "email": "jistone@redhat.com", "date": "2022-03-08T21:36:01Z"}, "committer": {"name": "Josh Stone", "email": "jistone@redhat.com", "date": "2022-03-08T21:36:01Z"}, "message": "unix: reduce the size of DirEntry\n\nOn platforms where we call `readdir` instead of `readdir_r`, we store\nthe name as an allocated `CString` for variable length. There's no point\ncarrying around a full `dirent64` with its fixed-length `d_name` too.", "tree": {"sha": "fb0c023ee11db198cbaeba8620ab59179249bc69", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fb0c023ee11db198cbaeba8620ab59179249bc69"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e8b9ba84be772b6888f17c940ecdab0fdcdcb3c5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e8b9ba84be772b6888f17c940ecdab0fdcdcb3c5", "html_url": "https://github.com/rust-lang/rust/commit/e8b9ba84be772b6888f17c940ecdab0fdcdcb3c5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e8b9ba84be772b6888f17c940ecdab0fdcdcb3c5/comments", "author": {"login": "cuviper", "id": 36186, "node_id": "MDQ6VXNlcjM2MTg2", "avatar_url": "https://avatars.githubusercontent.com/u/36186?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cuviper", "html_url": "https://github.com/cuviper", "followers_url": "https://api.github.com/users/cuviper/followers", "following_url": "https://api.github.com/users/cuviper/following{/other_user}", "gists_url": "https://api.github.com/users/cuviper/gists{/gist_id}", "starred_url": "https://api.github.com/users/cuviper/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cuviper/subscriptions", "organizations_url": "https://api.github.com/users/cuviper/orgs", "repos_url": "https://api.github.com/users/cuviper/repos", "events_url": "https://api.github.com/users/cuviper/events{/privacy}", "received_events_url": "https://api.github.com/users/cuviper/received_events", "type": "User", "site_admin": false}, "committer": {"login": "cuviper", "id": 36186, "node_id": "MDQ6VXNlcjM2MTg2", "avatar_url": "https://avatars.githubusercontent.com/u/36186?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cuviper", "html_url": "https://github.com/cuviper", "followers_url": "https://api.github.com/users/cuviper/followers", "following_url": "https://api.github.com/users/cuviper/following{/other_user}", "gists_url": "https://api.github.com/users/cuviper/gists{/gist_id}", "starred_url": "https://api.github.com/users/cuviper/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cuviper/subscriptions", "organizations_url": "https://api.github.com/users/cuviper/orgs", "repos_url": "https://api.github.com/users/cuviper/repos", "events_url": "https://api.github.com/users/cuviper/events{/privacy}", "received_events_url": "https://api.github.com/users/cuviper/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "64187b837486be90b897c7014572aa3537dc9b27", "url": "https://api.github.com/repos/rust-lang/rust/commits/64187b837486be90b897c7014572aa3537dc9b27", "html_url": "https://github.com/rust-lang/rust/commit/64187b837486be90b897c7014572aa3537dc9b27"}], "stats": {"total": 57, "additions": 47, "deletions": 10}, "files": [{"sha": "d5ef68d7e87f33e9a8c45301213903f9b594a7b2", "filename": "library/std/src/sys/unix/fs.rs", "status": "modified", "additions": 47, "deletions": 10, "changes": 57, "blob_url": "https://github.com/rust-lang/rust/blob/e8b9ba84be772b6888f17c940ecdab0fdcdcb3c5/library%2Fstd%2Fsrc%2Fsys%2Funix%2Ffs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e8b9ba84be772b6888f17c940ecdab0fdcdcb3c5/library%2Fstd%2Fsrc%2Fsys%2Funix%2Ffs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Funix%2Ffs.rs?ref=e8b9ba84be772b6888f17c940ecdab0fdcdcb3c5", "patch": "@@ -228,23 +228,54 @@ struct Dir(*mut libc::DIR);\n unsafe impl Send for Dir {}\n unsafe impl Sync for Dir {}\n \n+#[cfg(any(\n+    target_os = \"android\",\n+    target_os = \"linux\",\n+    target_os = \"solaris\",\n+    target_os = \"illumos\",\n+    target_os = \"fuchsia\",\n+    target_os = \"redox\"\n+))]\n pub struct DirEntry {\n-    entry: dirent64,\n     dir: Arc<InnerReadDir>,\n+    entry: dirent64_min,\n     // We need to store an owned copy of the entry name on platforms that use\n     // readdir() (not readdir_r()), because a) struct dirent may use a flexible\n     // array to store the name, b) it lives only until the next readdir() call.\n-    #[cfg(any(\n-        target_os = \"android\",\n-        target_os = \"linux\",\n-        target_os = \"solaris\",\n-        target_os = \"illumos\",\n-        target_os = \"fuchsia\",\n-        target_os = \"redox\"\n-    ))]\n     name: CString,\n }\n \n+// Define a minimal subset of fields we need from `dirent64`, especially since\n+// we're not using the immediate `d_name` on these targets. Keeping this as an\n+// `entry` field in `DirEntry` helps reduce the `cfg` boilerplate elsewhere.\n+#[cfg(any(\n+    target_os = \"android\",\n+    target_os = \"linux\",\n+    target_os = \"solaris\",\n+    target_os = \"illumos\",\n+    target_os = \"fuchsia\",\n+    target_os = \"redox\"\n+))]\n+struct dirent64_min {\n+    d_ino: u64,\n+    #[cfg(not(any(target_os = \"solaris\", target_os = \"illumos\")))]\n+    d_type: u8,\n+}\n+\n+#[cfg(not(any(\n+    target_os = \"android\",\n+    target_os = \"linux\",\n+    target_os = \"solaris\",\n+    target_os = \"illumos\",\n+    target_os = \"fuchsia\",\n+    target_os = \"redox\"\n+)))]\n+pub struct DirEntry {\n+    dir: Arc<InnerReadDir>,\n+    // The full entry includes a fixed-length `d_name`.\n+    entry: dirent64,\n+}\n+\n #[derive(Clone, Debug)]\n pub struct OpenOptions {\n     // generic\n@@ -501,8 +532,14 @@ impl Iterator for ReadDir {\n                 let entry_name = entry_bytes.add(name_offset);\n                 ptr::copy_nonoverlapping(entry_bytes, copy_bytes, name_offset);\n \n+                let entry = dirent64_min {\n+                    d_ino: copy.d_ino as u64,\n+                    #[cfg(not(any(target_os = \"solaris\", target_os = \"illumos\")))]\n+                    d_type: copy.d_type as u8,\n+                };\n+\n                 let ret = DirEntry {\n-                    entry: copy,\n+                    entry,\n                     // d_name is guaranteed to be null-terminated.\n                     name: CStr::from_ptr(entry_name as *const _).to_owned(),\n                     dir: Arc::clone(&self.inner),"}]}