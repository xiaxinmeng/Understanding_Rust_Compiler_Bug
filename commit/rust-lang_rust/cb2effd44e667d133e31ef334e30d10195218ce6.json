{"sha": "cb2effd44e667d133e31ef334e30d10195218ce6", "node_id": "MDY6Q29tbWl0NzI0NzEyOmNiMmVmZmQ0NGU2NjdkMTMzZTMxZWYzMzRlMzBkMTAxOTUyMThjZTY=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-02-18T10:13:36Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-02-18T10:13:36Z"}, "message": "Auto merge of #81574 - tmiasko:p, r=oli-obk\n\nPrecompute ancestors when checking privacy\n\nPrecompute ancestors of the old error node set so that check for private\ntypes and traits in public interfaces can in constant time determine if\nthe current item has any descendants in the old error set.\n\nThis removes disparity in compilation time between public and private type\naliases reported in #50614 (from 30 s to 5 s, in an example making extensive use\nof private type aliases).\n\nNo functional changes intended.", "tree": {"sha": "8b21f5bca535a15d6d4a85c789d4a97c7212e44f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8b21f5bca535a15d6d4a85c789d4a97c7212e44f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cb2effd44e667d133e31ef334e30d10195218ce6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cb2effd44e667d133e31ef334e30d10195218ce6", "html_url": "https://github.com/rust-lang/rust/commit/cb2effd44e667d133e31ef334e30d10195218ce6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cb2effd44e667d133e31ef334e30d10195218ce6/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "25a2c13e9d19c18d5f3c2656e3d2dda086cb023b", "url": "https://api.github.com/repos/rust-lang/rust/commits/25a2c13e9d19c18d5f3c2656e3d2dda086cb023b", "html_url": "https://github.com/rust-lang/rust/commit/25a2c13e9d19c18d5f3c2656e3d2dda086cb023b"}, {"sha": "b01976aa267620719afdd0effcc0501648bbefd4", "url": "https://api.github.com/repos/rust-lang/rust/commits/b01976aa267620719afdd0effcc0501648bbefd4", "html_url": "https://github.com/rust-lang/rust/commit/b01976aa267620719afdd0effcc0501648bbefd4"}], "stats": {"total": 54, "additions": 21, "deletions": 33}, "files": [{"sha": "559ae99257fcc8f696d56ba1c4e535acba733c47", "filename": "compiler/rustc_privacy/src/lib.rs", "status": "modified", "additions": 21, "deletions": 33, "changes": 54, "blob_url": "https://github.com/rust-lang/rust/blob/cb2effd44e667d133e31ef334e30d10195218ce6/compiler%2Frustc_privacy%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cb2effd44e667d133e31ef334e30d10195218ce6/compiler%2Frustc_privacy%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_privacy%2Fsrc%2Flib.rs?ref=cb2effd44e667d133e31ef334e30d10195218ce6", "patch": "@@ -1849,49 +1849,26 @@ impl DefIdVisitor<'tcx> for SearchInterfaceForPrivateItemsVisitor<'tcx> {\n     }\n }\n \n-struct PrivateItemsInPublicInterfacesVisitor<'a, 'tcx> {\n+struct PrivateItemsInPublicInterfacesVisitor<'tcx> {\n     tcx: TyCtxt<'tcx>,\n     has_pub_restricted: bool,\n-    old_error_set: &'a HirIdSet,\n+    old_error_set_ancestry: HirIdSet,\n }\n \n-impl<'a, 'tcx> PrivateItemsInPublicInterfacesVisitor<'a, 'tcx> {\n+impl<'tcx> PrivateItemsInPublicInterfacesVisitor<'tcx> {\n     fn check(\n         &self,\n         item_id: hir::HirId,\n         required_visibility: ty::Visibility,\n     ) -> SearchInterfaceForPrivateItemsVisitor<'tcx> {\n-        let mut has_old_errors = false;\n-\n-        // Slow path taken only if there any errors in the crate.\n-        for &id in self.old_error_set {\n-            // Walk up the nodes until we find `item_id` (or we hit a root).\n-            let mut id = id;\n-            loop {\n-                if id == item_id {\n-                    has_old_errors = true;\n-                    break;\n-                }\n-                let parent = self.tcx.hir().get_parent_node(id);\n-                if parent == id {\n-                    break;\n-                }\n-                id = parent;\n-            }\n-\n-            if has_old_errors {\n-                break;\n-            }\n-        }\n-\n         SearchInterfaceForPrivateItemsVisitor {\n             tcx: self.tcx,\n             item_id,\n             item_def_id: self.tcx.hir().local_def_id(item_id).to_def_id(),\n             span: self.tcx.hir().span(item_id),\n             required_visibility,\n             has_pub_restricted: self.has_pub_restricted,\n-            has_old_errors,\n+            has_old_errors: self.old_error_set_ancestry.contains(&item_id),\n             in_assoc_ty: false,\n         }\n     }\n@@ -1917,7 +1894,7 @@ impl<'a, 'tcx> PrivateItemsInPublicInterfacesVisitor<'a, 'tcx> {\n     }\n }\n \n-impl<'a, 'tcx> Visitor<'tcx> for PrivateItemsInPublicInterfacesVisitor<'a, 'tcx> {\n+impl<'tcx> Visitor<'tcx> for PrivateItemsInPublicInterfacesVisitor<'tcx> {\n     type Map = Map<'tcx>;\n \n     fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n@@ -2137,11 +2114,22 @@ fn check_private_in_public(tcx: TyCtxt<'_>, krate: CrateNum) {\n         pub_restricted_visitor.has_pub_restricted\n     };\n \n+    let mut old_error_set_ancestry = HirIdSet::default();\n+    for mut id in visitor.old_error_set.iter().copied() {\n+        loop {\n+            if !old_error_set_ancestry.insert(id) {\n+                break;\n+            }\n+            let parent = tcx.hir().get_parent_node(id);\n+            if parent == id {\n+                break;\n+            }\n+            id = parent;\n+        }\n+    }\n+\n     // Check for private types and traits in public interfaces.\n-    let mut visitor = PrivateItemsInPublicInterfacesVisitor {\n-        tcx,\n-        has_pub_restricted,\n-        old_error_set: &visitor.old_error_set,\n-    };\n+    let mut visitor =\n+        PrivateItemsInPublicInterfacesVisitor { tcx, has_pub_restricted, old_error_set_ancestry };\n     krate.visit_all_item_likes(&mut DeepVisitor::new(&mut visitor));\n }"}]}