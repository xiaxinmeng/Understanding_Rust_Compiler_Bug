{"sha": "ae4288f9ffd2fd431dba04a5906b5304e9106755", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFlNDI4OGY5ZmZkMmZkNDMxZGJhMDRhNTkwNmI1MzA0ZTkxMDY3NTU=", "commit": {"author": {"name": "Ed Schouten", "email": "ed@nuxi.nl", "date": "2018-01-16T21:23:18Z"}, "committer": {"name": "Ed Schouten", "email": "ed@nuxi.nl", "date": "2018-01-16T21:23:18Z"}, "message": "Integrate dist-cloudabi into dist-various-2.\n\nAs discussed in #47427, let's not have a separate container for doing\nCloudABI builds. It's a lot faster if we integrate it into an existing\ncontainer, so there's less duplication of what's being built.\n\nUpgrade the existing container to Ubuntu 17.10, which is required for\nCloudABI builds. The version of Clang shipped with 16.04 is not recent\nenough to support CloudABI properly.", "tree": {"sha": "115a695ee5b4c25b426c4291f2f1c672b0386734", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/115a695ee5b4c25b426c4291f2f1c672b0386734"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ae4288f9ffd2fd431dba04a5906b5304e9106755", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ae4288f9ffd2fd431dba04a5906b5304e9106755", "html_url": "https://github.com/rust-lang/rust/commit/ae4288f9ffd2fd431dba04a5906b5304e9106755", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ae4288f9ffd2fd431dba04a5906b5304e9106755/comments", "author": {"login": "EdSchouten", "id": 736085, "node_id": "MDQ6VXNlcjczNjA4NQ==", "avatar_url": "https://avatars.githubusercontent.com/u/736085?v=4", "gravatar_id": "", "url": "https://api.github.com/users/EdSchouten", "html_url": "https://github.com/EdSchouten", "followers_url": "https://api.github.com/users/EdSchouten/followers", "following_url": "https://api.github.com/users/EdSchouten/following{/other_user}", "gists_url": "https://api.github.com/users/EdSchouten/gists{/gist_id}", "starred_url": "https://api.github.com/users/EdSchouten/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/EdSchouten/subscriptions", "organizations_url": "https://api.github.com/users/EdSchouten/orgs", "repos_url": "https://api.github.com/users/EdSchouten/repos", "events_url": "https://api.github.com/users/EdSchouten/events{/privacy}", "received_events_url": "https://api.github.com/users/EdSchouten/received_events", "type": "User", "site_admin": false}, "committer": {"login": "EdSchouten", "id": 736085, "node_id": "MDQ6VXNlcjczNjA4NQ==", "avatar_url": "https://avatars.githubusercontent.com/u/736085?v=4", "gravatar_id": "", "url": "https://api.github.com/users/EdSchouten", "html_url": "https://github.com/EdSchouten", "followers_url": "https://api.github.com/users/EdSchouten/followers", "following_url": "https://api.github.com/users/EdSchouten/following{/other_user}", "gists_url": "https://api.github.com/users/EdSchouten/gists{/gist_id}", "starred_url": "https://api.github.com/users/EdSchouten/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/EdSchouten/subscriptions", "organizations_url": "https://api.github.com/users/EdSchouten/orgs", "repos_url": "https://api.github.com/users/EdSchouten/repos", "events_url": "https://api.github.com/users/EdSchouten/events{/privacy}", "received_events_url": "https://api.github.com/users/EdSchouten/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5801f95cbc2183285bc4423b3405f2767e448ef6", "url": "https://api.github.com/repos/rust-lang/rust/commits/5801f95cbc2183285bc4423b3405f2767e448ef6", "html_url": "https://github.com/rust-lang/rust/commit/5801f95cbc2183285bc4423b3405f2767e448ef6"}], "stats": {"total": 91, "additions": 40, "deletions": 51}, "files": [{"sha": "f1f6f0ff6cac91b0a802aa864cdf50d3235e4525", "filename": "src/ci/docker/disabled/dist-cloudabi/Dockerfile", "status": "removed", "additions": 0, "deletions": 30, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/5801f95cbc2183285bc4423b3405f2767e448ef6/src%2Fci%2Fdocker%2Fdisabled%2Fdist-cloudabi%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/5801f95cbc2183285bc4423b3405f2767e448ef6/src%2Fci%2Fdocker%2Fdisabled%2Fdist-cloudabi%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fdisabled%2Fdist-cloudabi%2FDockerfile?ref=5801f95cbc2183285bc4423b3405f2767e448ef6", "patch": "@@ -1,30 +0,0 @@\n-FROM ubuntu:17.10\n-\n-ENV TARGETS=aarch64-unknown-cloudabi\n-# FIXME(EdSchouten): Enable ARMv7 support once libc \u22650.2.37 has been merged.\n-# ENV TARGETS=armv7-unknown-cloudabi-eabihf\n-ENV TARGETS=$TARGETS,i686-unknown-cloudabi\n-ENV TARGETS=$TARGETS,x86_64-unknown-cloudabi\n-\n-COPY scripts/cloudabi-toolchain.sh /tmp/\n-RUN /tmp/cloudabi-toolchain.sh\n-\n-COPY scripts/sccache.sh /scripts/\n-RUN sh /scripts/sccache.sh\n-\n-# FIXME(EdSchouten): Remove this once cc \u22651.0.4 has been merged. It can\n-# automatically pick the right compiler path.\n-ENV \\\n-    AR_aarch64_unknown_cloudabi=aarch64-unknown-cloudabi-ar \\\n-    CC_aarch64_unknown_cloudabi=aarch64-unknown-cloudabi-clang \\\n-    CXX_aarch64_unknown_cloudabi=aarch64-unknown-cloudabi-clang++ \\\n-    AR_i686_unknown_cloudabi=i686-unknown-cloudabi-ar \\\n-    CC_i686_unknown_cloudabi=i686-unknown-cloudabi-clang \\\n-    CXX_i686_unknown_cloudabi=i686-unknown-cloudabi-clang++ \\\n-    AR_x86_64_unknown_cloudabi=x86_64-unknown-cloudabi-ar \\\n-    CC_x86_64_unknown_cloudabi=x86_64-unknown-cloudabi-clang \\\n-    CXX_x86_64_unknown_cloudabi=x86_64-unknown-cloudabi-clang++\n-\n-# FIXME(EdSchouten): Work towards being able to run 'x.py test'.\n-ENV RUST_CONFIGURE_ARGS --target=${TARGETS} --disable-jemalloc\n-ENV SCRIPT python2.7 /checkout/x.py dist --target ${TARGETS}"}, {"sha": "5284a1c875ce49eee5b857bfe7492e34649a1f86", "filename": "src/ci/docker/dist-various-2/Dockerfile", "status": "modified", "additions": 26, "deletions": 3, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/ae4288f9ffd2fd431dba04a5906b5304e9106755/src%2Fci%2Fdocker%2Fdist-various-2%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/ae4288f9ffd2fd431dba04a5906b5304e9106755/src%2Fci%2Fdocker%2Fdist-various-2%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fdist-various-2%2FDockerfile?ref=ae4288f9ffd2fd431dba04a5906b5304e9106755", "patch": "@@ -1,4 +1,4 @@\n-FROM ubuntu:16.04\n+FROM ubuntu:17.10\n \n COPY scripts/cross-apt-packages.sh /scripts/\n RUN sh /scripts/cross-apt-packages.sh\n@@ -21,9 +21,14 @@ RUN apt-key adv --batch --yes --keyserver keyserver.ubuntu.com --recv-keys 74DA7\n RUN add-apt-repository -y 'deb http://apt.dilos.org/dilos dilos2-testing main'\n \n WORKDIR /tmp\n-COPY dist-various-2/shared.sh dist-various-2/build-fuchsia-toolchain.sh /tmp/\n-COPY dist-various-2/build-solaris-toolchain.sh /tmp/\n+COPY dist-various-2/shared.sh /tmp/\n+COPY dist-various-2/build-cloudabi-toolchain.sh /tmp/\n+RUN /tmp/build-cloudabi-toolchain.sh aarch64-unknown-cloudabi\n+RUN /tmp/build-cloudabi-toolchain.sh i686-unknown-cloudabi\n+RUN /tmp/build-cloudabi-toolchain.sh x86_64-unknown-cloudabi\n+COPY dist-various-2/build-fuchsia-toolchain.sh /tmp/\n RUN /tmp/build-fuchsia-toolchain.sh\n+COPY dist-various-2/build-solaris-toolchain.sh /tmp/\n RUN /tmp/build-solaris-toolchain.sh x86_64  amd64   solaris-i386\n RUN /tmp/build-solaris-toolchain.sh sparcv9 sparcv9 solaris-sparc\n \n@@ -44,12 +49,30 @@ ENV \\\n     CC_x86_64_sun_solaris=x86_64-sun-solaris2.10-gcc \\\n     CXX_x86_64_sun_solaris=x86_64-sun-solaris2.10-g++\n \n+# FIXME(EdSchouten): Remove this once cc \u22651.0.4 has been merged. It can\n+# automatically pick the right compiler path.\n+ENV \\\n+    AR_aarch64_unknown_cloudabi=aarch64-unknown-cloudabi-ar \\\n+    CC_aarch64_unknown_cloudabi=aarch64-unknown-cloudabi-clang \\\n+    CXX_aarch64_unknown_cloudabi=aarch64-unknown-cloudabi-clang++ \\\n+    AR_i686_unknown_cloudabi=i686-unknown-cloudabi-ar \\\n+    CC_i686_unknown_cloudabi=i686-unknown-cloudabi-clang \\\n+    CXX_i686_unknown_cloudabi=i686-unknown-cloudabi-clang++ \\\n+    AR_x86_64_unknown_cloudabi=x86_64-unknown-cloudabi-ar \\\n+    CC_x86_64_unknown_cloudabi=x86_64-unknown-cloudabi-clang \\\n+    CXX_x86_64_unknown_cloudabi=x86_64-unknown-cloudabi-clang++\n+\n ENV TARGETS=x86_64-unknown-fuchsia\n ENV TARGETS=$TARGETS,aarch64-unknown-fuchsia\n ENV TARGETS=$TARGETS,sparcv9-sun-solaris\n ENV TARGETS=$TARGETS,wasm32-unknown-unknown\n ENV TARGETS=$TARGETS,x86_64-sun-solaris\n ENV TARGETS=$TARGETS,x86_64-unknown-linux-gnux32\n+ENV TARGETS=$TARGETS,aarch64-unknown-cloudabi\n+# FIXME(EdSchouten): Enable ARMv7 support once libc \u22650.2.37 has been merged.\n+# ENV TARGETS=$TARGETS,armv7-unknown-cloudabi-eabihf\n+ENV TARGETS=$TARGETS,i686-unknown-cloudabi\n+ENV TARGETS=$TARGETS,x86_64-unknown-cloudabi\n \n ENV RUST_CONFIGURE_ARGS --target=$TARGETS --enable-extended\n ENV SCRIPT python2.7 ../x.py dist --target $TARGETS"}, {"sha": "d64da4366399701498446545d683c6030c32c291", "filename": "src/ci/docker/dist-various-2/build-cloudabi-toolchain.sh", "status": "renamed", "additions": 14, "deletions": 18, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/ae4288f9ffd2fd431dba04a5906b5304e9106755/src%2Fci%2Fdocker%2Fdist-various-2%2Fbuild-cloudabi-toolchain.sh", "raw_url": "https://github.com/rust-lang/rust/raw/ae4288f9ffd2fd431dba04a5906b5304e9106755/src%2Fci%2Fdocker%2Fdist-various-2%2Fbuild-cloudabi-toolchain.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fdist-various-2%2Fbuild-cloudabi-toolchain.sh?ref=ae4288f9ffd2fd431dba04a5906b5304e9106755", "patch": "@@ -31,29 +31,25 @@ apt-get install -y --no-install-recommends \\\n \n # Set up a Clang-based cross compiler toolchain.\n # Based on the steps described at https://nuxi.nl/cloudabi/debian/\n-IFS=,\n-for target in ${TARGETS}; do\n-  for tool in ar nm objdump ranlib size; do\n-    ln -s ../lib/llvm-5.0/bin/llvm-${tool} /usr/bin/${target}-${tool}\n-  done\n-  ln -s ../lib/llvm-5.0/bin/clang /usr/bin/${target}-cc\n-  ln -s ../lib/llvm-5.0/bin/clang /usr/bin/${target}-c++\n-  ln -s ../lib/llvm-5.0/bin/lld /usr/bin/${target}-ld\n-  ln -s ../../${target} /usr/lib/llvm-5.0/${target}\n-\n-  # FIXME(EdSchouten): Remove this once cc \u22651.0.4 has been merged. It\n-  # can make use of ${target}-cc and ${target}-c++, without incorrectly\n-  # assuming it's MSVC.\n-  ln -s ../lib/llvm-5.0/bin/clang /usr/bin/${target}-clang\n-  ln -s ../lib/llvm-5.0/bin/clang /usr/bin/${target}-clang++\n+target=$1\n+for tool in ar nm objdump ranlib size; do\n+  ln -s ../lib/llvm-5.0/bin/llvm-${tool} /usr/bin/${target}-${tool}\n done\n+ln -s ../lib/llvm-5.0/bin/clang /usr/bin/${target}-cc\n+ln -s ../lib/llvm-5.0/bin/clang /usr/bin/${target}-c++\n+ln -s ../lib/llvm-5.0/bin/lld /usr/bin/${target}-ld\n+ln -s ../../${target} /usr/lib/llvm-5.0/${target}\n+\n+# FIXME(EdSchouten): Remove this once cc \u22651.0.4 has been merged. It\n+# can make use of ${target}-cc and ${target}-c++, without incorrectly\n+# assuming it's MSVC.\n+ln -s ../lib/llvm-5.0/bin/clang /usr/bin/${target}-clang\n+ln -s ../lib/llvm-5.0/bin/clang /usr/bin/${target}-clang++\n \n # Install the C++ runtime libraries from CloudABI Ports.\n echo deb https://nuxi.nl/distfiles/cloudabi-ports/debian/ cloudabi cloudabi > \\\n     /etc/apt/sources.list.d/cloudabi.list\n curl 'https://pgp.mit.edu/pks/lookup?op=get&search=0x0DA51B8531344B15' | \\\n     apt-key add -\n apt-get update\n-for target in ${TARGETS}; do\n-  apt-get install -y $(echo ${target} | sed -e s/_/-/g)-cxx-runtime\n-done\n+apt-get install -y $(echo ${target} | sed -e s/_/-/g)-cxx-runtime", "previous_filename": "src/ci/docker/scripts/cloudabi-toolchain.sh"}]}