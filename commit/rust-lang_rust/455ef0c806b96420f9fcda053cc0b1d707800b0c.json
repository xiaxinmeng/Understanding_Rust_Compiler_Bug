{"sha": "455ef0c806b96420f9fcda053cc0b1d707800b0c", "node_id": "C_kwDOAAsO6NoAKDQ1NWVmMGM4MDZiOTY0MjBmOWZjZGEwNTNjYzBiMWQ3MDc4MDBiMGM", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-01-16T19:11:19Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-01-16T19:11:19Z"}, "message": "Auto merge of #13935 - ModProg:assist_desugar_doc_comment, r=Veykril\n\nAssist: desugar doc-comment\n\nMy need for this arose due to wanting to do feature dependent documentation and therefor convert parts of my doc-comments to attributes.\n\nNot sure about the pub-making of the other handlers functions, but I didn't think it made much sense to reimplement them.", "tree": {"sha": "fc532abd1fba62056ef8ab5d8354e29545d11cc7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fc532abd1fba62056ef8ab5d8354e29545d11cc7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/455ef0c806b96420f9fcda053cc0b1d707800b0c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/455ef0c806b96420f9fcda053cc0b1d707800b0c", "html_url": "https://github.com/rust-lang/rust/commit/455ef0c806b96420f9fcda053cc0b1d707800b0c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/455ef0c806b96420f9fcda053cc0b1d707800b0c/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1d02474cd2a6b72578c3a1dd98114ed43ae53505", "url": "https://api.github.com/repos/rust-lang/rust/commits/1d02474cd2a6b72578c3a1dd98114ed43ae53505", "html_url": "https://github.com/rust-lang/rust/commit/1d02474cd2a6b72578c3a1dd98114ed43ae53505"}, {"sha": "ec06313a6d318771d2bc1f3be81e9b5991cc6ea1", "url": "https://api.github.com/repos/rust-lang/rust/commits/ec06313a6d318771d2bc1f3be81e9b5991cc6ea1", "html_url": "https://github.com/rust-lang/rust/commit/ec06313a6d318771d2bc1f3be81e9b5991cc6ea1"}], "stats": {"total": 377, "additions": 353, "deletions": 24}, "files": [{"sha": "1acd5ee97283fcefa57524e347ef62b3ae7d5053", "filename": "crates/ide-assists/src/handlers/convert_comment_block.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/455ef0c806b96420f9fcda053cc0b1d707800b0c/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fconvert_comment_block.rs", "raw_url": "https://github.com/rust-lang/rust/raw/455ef0c806b96420f9fcda053cc0b1d707800b0c/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fconvert_comment_block.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fconvert_comment_block.rs?ref=455ef0c806b96420f9fcda053cc0b1d707800b0c", "patch": "@@ -107,7 +107,7 @@ fn line_to_block(acc: &mut Assists, comment: ast::Comment) -> Option<()> {\n /// The line -> block assist can  be invoked from anywhere within a sequence of line comments.\n /// relevant_line_comments crawls backwards and forwards finding the complete sequence of comments that will\n /// be joined.\n-fn relevant_line_comments(comment: &ast::Comment) -> Vec<Comment> {\n+pub(crate) fn relevant_line_comments(comment: &ast::Comment) -> Vec<Comment> {\n     // The prefix identifies the kind of comment we're dealing with\n     let prefix = comment.prefix();\n     let same_prefix = |c: &ast::Comment| c.prefix() == prefix;\n@@ -159,7 +159,7 @@ fn relevant_line_comments(comment: &ast::Comment) -> Vec<Comment> {\n //              */\n //\n // But since such comments aren't idiomatic we're okay with this.\n-fn line_comment_text(indentation: IndentLevel, comm: ast::Comment) -> String {\n+pub(crate) fn line_comment_text(indentation: IndentLevel, comm: ast::Comment) -> String {\n     let contents_without_prefix = comm.text().strip_prefix(comm.prefix()).unwrap();\n     let contents = contents_without_prefix.strip_prefix(' ').unwrap_or(contents_without_prefix);\n "}, {"sha": "226a5dd9fa8b7c09b1eddff4d500c10cb34d3e74", "filename": "crates/ide-assists/src/handlers/desugar_doc_comment.rs", "status": "added", "additions": 312, "deletions": 0, "changes": 312, "blob_url": "https://github.com/rust-lang/rust/blob/455ef0c806b96420f9fcda053cc0b1d707800b0c/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fdesugar_doc_comment.rs", "raw_url": "https://github.com/rust-lang/rust/raw/455ef0c806b96420f9fcda053cc0b1d707800b0c/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fdesugar_doc_comment.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fdesugar_doc_comment.rs?ref=455ef0c806b96420f9fcda053cc0b1d707800b0c", "patch": "@@ -0,0 +1,312 @@\n+use either::Either;\n+use itertools::Itertools;\n+use syntax::{\n+    ast::{self, edit::IndentLevel, CommentPlacement, Whitespace},\n+    AstToken, TextRange,\n+};\n+\n+use crate::{\n+    handlers::convert_comment_block::{line_comment_text, relevant_line_comments},\n+    utils::required_hashes,\n+    AssistContext, AssistId, AssistKind, Assists,\n+};\n+\n+// Assist: desugar_doc_comment\n+//\n+// Desugars doc-comments to the attribute form.\n+//\n+// ```\n+// /// Multi-line$0\n+// /// comment\n+// ```\n+// ->\n+// ```\n+// #[doc = r\"Multi-line\n+// comment\"]\n+// ```\n+pub(crate) fn desugar_doc_comment(acc: &mut Assists, ctx: &AssistContext<'_>) -> Option<()> {\n+    let comment = ctx.find_token_at_offset::<ast::Comment>()?;\n+    // Only allow doc comments\n+    let Some(placement) = comment.kind().doc else { return None; };\n+\n+    // Only allow comments which are alone on their line\n+    if let Some(prev) = comment.syntax().prev_token() {\n+        if Whitespace::cast(prev).filter(|w| w.text().contains('\\n')).is_none() {\n+            return None;\n+        }\n+    }\n+\n+    let indentation = IndentLevel::from_token(comment.syntax()).to_string();\n+\n+    let (target, comments) = match comment.kind().shape {\n+        ast::CommentShape::Block => (comment.syntax().text_range(), Either::Left(comment)),\n+        ast::CommentShape::Line => {\n+            // Find all the comments we'll be desugaring\n+            let comments = relevant_line_comments(&comment);\n+\n+            // Establish the target of our edit based on the comments we found\n+            (\n+                TextRange::new(\n+                    comments[0].syntax().text_range().start(),\n+                    comments.last().unwrap().syntax().text_range().end(),\n+                ),\n+                Either::Right(comments),\n+            )\n+        }\n+    };\n+\n+    acc.add(\n+        AssistId(\"desugar_doc_comment\", AssistKind::RefactorRewrite),\n+        \"Desugar doc-comment to attribute macro\",\n+        target,\n+        |edit| {\n+            let text = match comments {\n+                Either::Left(comment) => {\n+                    let text = comment.text();\n+                    text[comment.prefix().len()..(text.len() - \"*/\".len())]\n+                        .trim()\n+                        .lines()\n+                        .map(|l| l.strip_prefix(&indentation).unwrap_or(l))\n+                        .join(\"\\n\")\n+                }\n+                Either::Right(comments) => {\n+                    comments.into_iter().map(|c| line_comment_text(IndentLevel(0), c)).join(\"\\n\")\n+                }\n+            };\n+\n+            let hashes = \"#\".repeat(required_hashes(&text));\n+\n+            let prefix = match placement {\n+                CommentPlacement::Inner => \"#!\",\n+                CommentPlacement::Outer => \"#\",\n+            };\n+\n+            let output = format!(r#\"{prefix}[doc = r{hashes}\"{text}\"{hashes}]\"#);\n+\n+            edit.replace(target, output)\n+        },\n+    )\n+}\n+\n+#[cfg(test)]\n+mod tests {\n+    use crate::tests::{check_assist, check_assist_not_applicable};\n+\n+    use super::*;\n+\n+    #[test]\n+    fn single_line() {\n+        check_assist(\n+            desugar_doc_comment,\n+            r#\"\n+/// line$0 comment\n+fn main() {\n+    foo();\n+}\n+\"#,\n+            r#\"\n+#[doc = r\"line comment\"]\n+fn main() {\n+    foo();\n+}\n+\"#,\n+        );\n+        check_assist(\n+            desugar_doc_comment,\n+            r#\"\n+//! line$0 comment\n+fn main() {\n+    foo();\n+}\n+\"#,\n+            r#\"\n+#![doc = r\"line comment\"]\n+fn main() {\n+    foo();\n+}\n+\"#,\n+        );\n+    }\n+\n+    #[test]\n+    fn single_line_indented() {\n+        check_assist(\n+            desugar_doc_comment,\n+            r#\"\n+fn main() {\n+    /// line$0 comment\n+    struct Foo;\n+}\n+\"#,\n+            r#\"\n+fn main() {\n+    #[doc = r\"line comment\"]\n+    struct Foo;\n+}\n+\"#,\n+        );\n+    }\n+\n+    #[test]\n+    fn multiline() {\n+        check_assist(\n+            desugar_doc_comment,\n+            r#\"\n+fn main() {\n+    /// above\n+    /// line$0 comment\n+    ///\n+    /// below\n+    struct Foo;\n+}\n+\"#,\n+            r#\"\n+fn main() {\n+    #[doc = r\"above\n+line comment\n+\n+below\"]\n+    struct Foo;\n+}\n+\"#,\n+        );\n+    }\n+\n+    #[test]\n+    fn end_of_line() {\n+        check_assist_not_applicable(\n+            desugar_doc_comment,\n+            r#\"\n+fn main() { /// end-of-line$0 comment\n+    struct Foo;\n+}\n+\"#,\n+        );\n+    }\n+\n+    #[test]\n+    fn single_line_different_kinds() {\n+        check_assist(\n+            desugar_doc_comment,\n+            r#\"\n+fn main() {\n+    //! different prefix\n+    /// line$0 comment\n+    /// below\n+    struct Foo;\n+}\n+\"#,\n+            r#\"\n+fn main() {\n+    //! different prefix\n+    #[doc = r\"line comment\n+below\"]\n+    struct Foo;\n+}\n+\"#,\n+        );\n+    }\n+\n+    #[test]\n+    fn single_line_separate_chunks() {\n+        check_assist(\n+            desugar_doc_comment,\n+            r#\"\n+/// different chunk\n+\n+/// line$0 comment\n+/// below\n+\"#,\n+            r#\"\n+/// different chunk\n+\n+#[doc = r\"line comment\n+below\"]\n+\"#,\n+        );\n+    }\n+\n+    #[test]\n+    fn block_comment() {\n+        check_assist(\n+            desugar_doc_comment,\n+            r#\"\n+/**\n+ hi$0 there\n+*/\n+\"#,\n+            r#\"\n+#[doc = r\"hi there\"]\n+\"#,\n+        );\n+    }\n+\n+    #[test]\n+    fn inner_doc_block() {\n+        check_assist(\n+            desugar_doc_comment,\n+            r#\"\n+/*!\n+ hi$0 there\n+*/\n+\"#,\n+            r#\"\n+#![doc = r\"hi there\"]\n+\"#,\n+        );\n+    }\n+\n+    #[test]\n+    fn block_indent() {\n+        check_assist(\n+            desugar_doc_comment,\n+            r#\"\n+fn main() {\n+    /*!\n+    hi$0 there\n+\n+    ```\n+      code_sample\n+    ```\n+    */\n+}\n+\"#,\n+            r#\"\n+fn main() {\n+    #![doc = r\"hi there\n+\n+```\n+  code_sample\n+```\"]\n+}\n+\"#,\n+        );\n+    }\n+\n+    #[test]\n+    fn end_of_line_block() {\n+        check_assist_not_applicable(\n+            desugar_doc_comment,\n+            r#\"\n+fn main() {\n+    foo(); /** end-of-line$0 comment */\n+}\n+\"#,\n+        );\n+    }\n+\n+    #[test]\n+    fn regular_comment() {\n+        check_assist_not_applicable(desugar_doc_comment, r#\"// some$0 comment\"#);\n+        check_assist_not_applicable(desugar_doc_comment, r#\"/* some$0 comment*/\"#);\n+    }\n+\n+    #[test]\n+    fn quotes_and_escapes() {\n+        check_assist(\n+            desugar_doc_comment,\n+            r###\"/// some$0 \"\\ \"## comment\"###,\n+            r####\"#[doc = r###\"some \"\\ \"## comment\"###]\"####,\n+        );\n+    }\n+}"}, {"sha": "01420430bb41987fa33859813fbe425a45a42350", "filename": "crates/ide-assists/src/handlers/raw_string.rs", "status": "modified", "additions": 1, "deletions": 22, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/455ef0c806b96420f9fcda053cc0b1d707800b0c/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fraw_string.rs", "raw_url": "https://github.com/rust-lang/rust/raw/455ef0c806b96420f9fcda053cc0b1d707800b0c/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fraw_string.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fraw_string.rs?ref=455ef0c806b96420f9fcda053cc0b1d707800b0c", "patch": "@@ -2,7 +2,7 @@ use std::borrow::Cow;\n \n use syntax::{ast, ast::IsString, AstToken, TextRange, TextSize};\n \n-use crate::{AssistContext, AssistId, AssistKind, Assists};\n+use crate::{utils::required_hashes, AssistContext, AssistId, AssistKind, Assists};\n \n // Assist: make_raw_string\n //\n@@ -155,33 +155,12 @@ pub(crate) fn remove_hash(acc: &mut Assists, ctx: &AssistContext<'_>) -> Option<\n     })\n }\n \n-fn required_hashes(s: &str) -> usize {\n-    let mut res = 0usize;\n-    for idx in s.match_indices('\"').map(|(i, _)| i) {\n-        let (_, sub) = s.split_at(idx + 1);\n-        let n_hashes = sub.chars().take_while(|c| *c == '#').count();\n-        res = res.max(n_hashes + 1)\n-    }\n-    res\n-}\n-\n #[cfg(test)]\n mod tests {\n     use crate::tests::{check_assist, check_assist_not_applicable, check_assist_target};\n \n     use super::*;\n \n-    #[test]\n-    fn test_required_hashes() {\n-        assert_eq!(0, required_hashes(\"abc\"));\n-        assert_eq!(0, required_hashes(\"###\"));\n-        assert_eq!(1, required_hashes(\"\\\"\"));\n-        assert_eq!(2, required_hashes(\"\\\"#abc\"));\n-        assert_eq!(0, required_hashes(\"#abc\"));\n-        assert_eq!(3, required_hashes(\"#ab\\\"##c\"));\n-        assert_eq!(5, required_hashes(\"#ab\\\"##\\\"####c\"));\n-    }\n-\n     #[test]\n     fn make_raw_string_target() {\n         check_assist_target("}, {"sha": "546ef96260f2cf8da992ba6156692432a055c9f7", "filename": "crates/ide-assists/src/lib.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/455ef0c806b96420f9fcda053cc0b1d707800b0c/crates%2Fide-assists%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/455ef0c806b96420f9fcda053cc0b1d707800b0c/crates%2Fide-assists%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-assists%2Fsrc%2Flib.rs?ref=455ef0c806b96420f9fcda053cc0b1d707800b0c", "patch": "@@ -126,6 +126,7 @@ mod handlers {\n     mod convert_to_guarded_return;\n     mod convert_two_arm_bool_match_to_matches_macro;\n     mod convert_while_to_loop;\n+    mod desugar_doc_comment;\n     mod destructure_tuple_binding;\n     mod expand_glob_import;\n     mod extract_expressions_from_format_string;\n@@ -231,6 +232,7 @@ mod handlers {\n             convert_tuple_struct_to_named_struct::convert_tuple_struct_to_named_struct,\n             convert_two_arm_bool_match_to_matches_macro::convert_two_arm_bool_match_to_matches_macro,\n             convert_while_to_loop::convert_while_to_loop,\n+            desugar_doc_comment::desugar_doc_comment,\n             destructure_tuple_binding::destructure_tuple_binding,\n             expand_glob_import::expand_glob_import,\n             extract_expressions_from_format_string::extract_expressions_from_format_string,"}, {"sha": "16a06b60de901f9403fd6feabd7e59ae4f68599c", "filename": "crates/ide-assists/src/tests/generated.rs", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/455ef0c806b96420f9fcda053cc0b1d707800b0c/crates%2Fide-assists%2Fsrc%2Ftests%2Fgenerated.rs", "raw_url": "https://github.com/rust-lang/rust/raw/455ef0c806b96420f9fcda053cc0b1d707800b0c/crates%2Fide-assists%2Fsrc%2Ftests%2Fgenerated.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-assists%2Fsrc%2Ftests%2Fgenerated.rs?ref=455ef0c806b96420f9fcda053cc0b1d707800b0c", "patch": "@@ -597,6 +597,21 @@ fn main() {\n     )\n }\n \n+#[test]\n+fn doctest_desugar_doc_comment() {\n+    check_doc_test(\n+        \"desugar_doc_comment\",\n+        r#####\"\n+/// Multi-line$0\n+/// comment\n+\"#####,\n+        r#####\"\n+#[doc = r\"Multi-line\n+comment\"]\n+\"#####,\n+    )\n+}\n+\n #[test]\n fn doctest_expand_glob_import() {\n     check_doc_test("}, {"sha": "63f467bd3086059cf1e3748c174eb13fa647e6f8", "filename": "crates/ide-assists/src/utils.rs", "status": "modified", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/455ef0c806b96420f9fcda053cc0b1d707800b0c/crates%2Fide-assists%2Fsrc%2Futils.rs", "raw_url": "https://github.com/rust-lang/rust/raw/455ef0c806b96420f9fcda053cc0b1d707800b0c/crates%2Fide-assists%2Fsrc%2Futils.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-assists%2Fsrc%2Futils.rs?ref=455ef0c806b96420f9fcda053cc0b1d707800b0c", "patch": "@@ -758,3 +758,24 @@ pub(crate) fn convert_param_list_to_arg_list(list: ast::ParamList) -> ast::ArgLi\n     }\n     make::arg_list(args)\n }\n+\n+/// Calculate the number of hashes required for a raw string containing `s`\n+pub(crate) fn required_hashes(s: &str) -> usize {\n+    let mut res = 0usize;\n+    for idx in s.match_indices('\"').map(|(i, _)| i) {\n+        let (_, sub) = s.split_at(idx + 1);\n+        let n_hashes = sub.chars().take_while(|c| *c == '#').count();\n+        res = res.max(n_hashes + 1)\n+    }\n+    res\n+}\n+#[test]\n+fn test_required_hashes() {\n+    assert_eq!(0, required_hashes(\"abc\"));\n+    assert_eq!(0, required_hashes(\"###\"));\n+    assert_eq!(1, required_hashes(\"\\\"\"));\n+    assert_eq!(2, required_hashes(\"\\\"#abc\"));\n+    assert_eq!(0, required_hashes(\"#abc\"));\n+    assert_eq!(3, required_hashes(\"#ab\\\"##c\"));\n+    assert_eq!(5, required_hashes(\"#ab\\\"##\\\"####c\"));\n+}"}]}