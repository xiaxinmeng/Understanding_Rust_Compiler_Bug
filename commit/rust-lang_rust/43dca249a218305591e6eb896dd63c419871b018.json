{"sha": "43dca249a218305591e6eb896dd63c419871b018", "node_id": "C_kwDOAAsO6NoAKDQzZGNhMjQ5YTIxODMwNTU5MWU2ZWI4OTZkZDYzYzQxOTg3MWIwMTg", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-11-17T21:33:18Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-11-17T21:33:18Z"}, "message": "Rollup merge of #104366 - GuillaumeGomez:simplify-settings-theme-choice, r=notriddle\n\nSimplify settings theme choice\n\nI removed the storage changes from https://github.com/rust-lang/rust/pull/98765 and only kept the UI changes.\n\nYou can test it [here](https://rustdoc.crud.net/imperio/simplify-settings-theme-choice/foo/index.html).\n\nDiscussion about this still in progress [on zulip](https://rust-lang.zulipchat.com/#narrow/stream/266220-rustdoc/topic/Last.20part.20of.20settings.20simplification).\n\nr? ````@notriddle````", "tree": {"sha": "0c0d3845429b1e74ba846b32cfea8772761f60b2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0c0d3845429b1e74ba846b32cfea8772761f60b2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/43dca249a218305591e6eb896dd63c419871b018", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjdqieCRBK7hj4Ov3rIwAArNwIABZm3ZG1LI2/e5X1UkL9qntM\nIjeCr81fXwIJmfq+TWqKlypQ3BybB2YctlToKn7bRypkQuQwPfy8gST9OXIlaJwE\nkw+UpfEiBsFXGYNzmbs9I/O3isyqgbkauy6+L9oSKdvdVpNbnZbfFo9Ui0mHtLJk\nq7cGH9HEFq++sRPgvjkr2rROAh0Sqfdji988E2QYug+8Dg9wMujbxTm9ktIBFWbw\nv46OhX5yZo7K6+fku7tUJNBIE2l/dCIlh63s/Z6FiaApYeIh8BqGNvAf8zc87Psz\n648ZOaPXIVE9I/+vguilwilOnjiV/UIeqb7ELh1CS/Scy//S5jcuATUBDfG5uYE=\n=XC1e\n-----END PGP SIGNATURE-----\n", "payload": "tree 0c0d3845429b1e74ba846b32cfea8772761f60b2\nparent 1521795a7da083a16329bcb27d81d34434cfc6d0\nparent dacf9b89b7668ad8fedd44f2c1980aea676b7831\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1668720798 +0100\ncommitter GitHub <noreply@github.com> 1668720798 +0100\n\nRollup merge of #104366 - GuillaumeGomez:simplify-settings-theme-choice, r=notriddle\n\nSimplify settings theme choice\n\nI removed the storage changes from https://github.com/rust-lang/rust/pull/98765 and only kept the UI changes.\n\nYou can test it [here](https://rustdoc.crud.net/imperio/simplify-settings-theme-choice/foo/index.html).\n\nDiscussion about this still in progress [on zulip](https://rust-lang.zulipchat.com/#narrow/stream/266220-rustdoc/topic/Last.20part.20of.20settings.20simplification).\n\nr? ````@notriddle````\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/43dca249a218305591e6eb896dd63c419871b018", "html_url": "https://github.com/rust-lang/rust/commit/43dca249a218305591e6eb896dd63c419871b018", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/43dca249a218305591e6eb896dd63c419871b018/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1521795a7da083a16329bcb27d81d34434cfc6d0", "url": "https://api.github.com/repos/rust-lang/rust/commits/1521795a7da083a16329bcb27d81d34434cfc6d0", "html_url": "https://github.com/rust-lang/rust/commit/1521795a7da083a16329bcb27d81d34434cfc6d0"}, {"sha": "dacf9b89b7668ad8fedd44f2c1980aea676b7831", "url": "https://api.github.com/repos/rust-lang/rust/commits/dacf9b89b7668ad8fedd44f2c1980aea676b7831", "html_url": "https://github.com/rust-lang/rust/commit/dacf9b89b7668ad8fedd44f2c1980aea676b7831"}], "stats": {"total": 148, "additions": 79, "deletions": 69}, "files": [{"sha": "5256ae916a771a6121c888c527bd80db8160fe01", "filename": "src/librustdoc/html/static/js/settings.js", "status": "modified", "additions": 36, "deletions": 24, "changes": 60, "blob_url": "https://github.com/rust-lang/rust/blob/43dca249a218305591e6eb896dd63c419871b018/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsettings.js", "raw_url": "https://github.com/rust-lang/rust/raw/43dca249a218305591e6eb896dd63c419871b018/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsettings.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsettings.js?ref=43dca249a218305591e6eb896dd63c419871b018", "patch": "@@ -9,13 +9,16 @@\n     const isSettingsPage = window.location.pathname.endsWith(\"/settings.html\");\n \n     function changeSetting(settingName, value) {\n+        if (settingName === \"theme\") {\n+            const useSystem = value === \"system preference\" ? \"true\" : \"false\";\n+            updateLocalStorage(\"use-system-theme\", useSystem);\n+        }\n         updateLocalStorage(settingName, value);\n \n         switch (settingName) {\n             case \"theme\":\n             case \"preferred-dark-theme\":\n             case \"preferred-light-theme\":\n-            case \"use-system-theme\":\n                 updateSystemTheme();\n                 updateLightAndDark();\n                 break;\n@@ -45,19 +48,18 @@\n     }\n \n     function showLightAndDark() {\n-        addClass(document.getElementById(\"theme\").parentElement, \"hidden\");\n         removeClass(document.getElementById(\"preferred-light-theme\").parentElement, \"hidden\");\n         removeClass(document.getElementById(\"preferred-dark-theme\").parentElement, \"hidden\");\n     }\n \n     function hideLightAndDark() {\n         addClass(document.getElementById(\"preferred-light-theme\").parentElement, \"hidden\");\n         addClass(document.getElementById(\"preferred-dark-theme\").parentElement, \"hidden\");\n-        removeClass(document.getElementById(\"theme\").parentElement, \"hidden\");\n     }\n \n     function updateLightAndDark() {\n-        if (getSettingValue(\"use-system-theme\") !== \"false\") {\n+        const useSystem = getSettingValue(\"use-system-theme\");\n+        if (useSystem === \"true\" || (useSystem === null && getSettingValue(\"theme\") === null)) {\n             showLightAndDark();\n         } else {\n             hideLightAndDark();\n@@ -91,7 +93,18 @@\n         });\n         onEachLazy(settingsElement.querySelectorAll(\"input[type=\\\"radio\\\"]\"), elem => {\n             const settingId = elem.name;\n-            const settingValue = getSettingValue(settingId);\n+            let settingValue = getSettingValue(settingId);\n+            if (settingId === \"theme\") {\n+                const useSystem = getSettingValue(\"use-system-theme\");\n+                if (useSystem === \"true\" || settingValue === null) {\n+                    if (useSystem !== \"false\") {\n+                        settingValue = \"system preference\";\n+                    } else {\n+                        // This is the default theme.\n+                        settingValue = \"light\";\n+                    }\n+                }\n+            }\n             if (settingValue !== null && settingValue !== \"null\") {\n                 elem.checked = settingValue === elem.value;\n             }\n@@ -120,26 +133,30 @@\n \n             if (setting[\"options\"] !== undefined) {\n                 // This is a select setting.\n-                output += `<div class=\"radio-line\" id=\"${js_data_name}\">\\\n-                        <span class=\"setting-name\">${setting_name}</span>\\\n-                        <div class=\"choices\">`;\n+                output += `\\\n+<div class=\"radio-line\" id=\"${js_data_name}\">\n+    <span class=\"setting-name\">${setting_name}</span>\n+<div class=\"choices\">`;\n                 onEach(setting[\"options\"], option => {\n                     const checked = option === setting[\"default\"] ? \" checked\" : \"\";\n+                    const full = `${js_data_name}-${option.replace(/ /g,\"-\")}`;\n \n-                    output += `<label for=\"${js_data_name}-${option}\" class=\"choice\">\\\n-                           <input type=\"radio\" name=\"${js_data_name}\" \\\n-                                id=\"${js_data_name}-${option}\" value=\"${option}\"${checked}>\\\n-                           <span>${option}</span>\\\n-                         </label>`;\n+                    output += `\\\n+<label for=\"${full}\" class=\"choice\">\n+    <input type=\"radio\" name=\"${js_data_name}\"\n+        id=\"${full}\" value=\"${option}\"${checked}>\n+    <span>${option}</span>\n+</label>`;\n                 });\n                 output += \"</div></div>\";\n             } else {\n                 // This is a toggle.\n                 const checked = setting[\"default\"] === true ? \" checked\" : \"\";\n-                output += `<label class=\"toggle\">\\\n-                        <input type=\"checkbox\" id=\"${js_data_name}\"${checked}>\\\n-                        <span class=\"label\">${setting_name}</span>\\\n-                    </label>`;\n+                output += `\\\n+<label class=\"toggle\">\\\n+    <input type=\"checkbox\" id=\"${js_data_name}\"${checked}>\\\n+    <span class=\"label\">${setting_name}</span>\\\n+</label>`;\n             }\n             output += \"</div>\";\n         }\n@@ -156,16 +173,11 @@\n         theme_names.push(\"light\", \"dark\", \"ayu\");\n \n         const settings = [\n-            {\n-                \"name\": \"Use system theme\",\n-                \"js_name\": \"use-system-theme\",\n-                \"default\": true,\n-            },\n             {\n                 \"name\": \"Theme\",\n                 \"js_name\": \"theme\",\n-                \"default\": \"light\",\n-                \"options\": theme_names,\n+                \"default\": \"system preference\",\n+                \"options\": theme_names.concat(\"system preference\"),\n             },\n             {\n                 \"name\": \"Preferred light theme\","}, {"sha": "fc3beaa53fafcb396d81b49da63b59930fb61107", "filename": "src/test/rustdoc-gui/settings.goml", "status": "modified", "additions": 2, "deletions": 39, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/43dca249a218305591e6eb896dd63c419871b018/src%2Ftest%2Frustdoc-gui%2Fsettings.goml", "raw_url": "https://github.com/rust-lang/rust/raw/43dca249a218305591e6eb896dd63c419871b018/src%2Ftest%2Frustdoc-gui%2Fsettings.goml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-gui%2Fsettings.goml?ref=43dca249a218305591e6eb896dd63c419871b018", "patch": "@@ -37,8 +37,7 @@ click: \"#settings-menu\"\n wait-for: \"#settings\"\n \n // We check that the \"Use system theme\" is disabled.\n-assert-property: (\"#use-system-theme\", {\"checked\": \"false\"})\n-assert: \"//*[@class='setting-line']//span[text()='Use system theme']\"\n+assert-property: (\"#theme-system-preference\", {\"checked\": \"false\"})\n // Meaning that only the \"theme\" menu is showing up.\n assert: \".setting-line:not(.hidden) #theme\"\n assert: \".setting-line.hidden #preferred-dark-theme\"\n@@ -115,13 +114,6 @@ assert-css: (\n         \"border-color\": \"rgb(221, 221, 221)\",\n     },\n )\n-assert-css: (\n-    \"#use-system-theme\",\n-    {\n-        \"background-color\": \"rgba(0, 0, 0, 0)\",\n-        \"border-color\": \"rgb(221, 221, 221)\",\n-    }\n-)\n // Let's start with the hover for toggles.\n move-cursor-to: \"#auto-hide-large-items\"\n assert-css: (\n@@ -131,14 +123,6 @@ assert-css: (\n         \"border-color\": \"rgb(33, 150, 243)\",\n     },\n )\n-move-cursor-to: \"#use-system-theme\"\n-assert-css: (\n-    \"#use-system-theme\",\n-    {\n-        \"background-color\": \"rgba(0, 0, 0, 0)\",\n-        \"border-color\": \"rgb(33, 150, 243)\",\n-    }\n-)\n move-cursor-to: \"#settings-menu > a\"\n // Let's now check with the focus for toggles.\n focus: \"#auto-hide-large-items\"\n@@ -150,15 +134,6 @@ assert-css: (\n         \"box-shadow\": \"rgb(33, 150, 243) 0px 0px 1px 1px\",\n     },\n )\n-focus: \"#use-system-theme\"\n-assert-css: (\n-    \"#use-system-theme\",\n-    {\n-        \"background-color\": \"rgba(0, 0, 0, 0)\",\n-        \"border-color\": \"rgb(221, 221, 221)\",\n-        \"box-shadow\": \"rgb(33, 150, 243) 0px 0px 1px 1px\",\n-    },\n-)\n // Now we check we both focus and hover for toggles.\n move-cursor-to: \"#auto-hide-large-items\"\n focus: \"#auto-hide-large-items\"\n@@ -170,24 +145,12 @@ assert-css: (\n         \"box-shadow\": \"rgb(33, 150, 243) 0px 0px 1px 1px\",\n     },\n )\n-move-cursor-to: \"#use-system-theme\"\n-focus: \"#use-system-theme\"\n-assert-css: (\n-    \"#use-system-theme\",\n-    {\n-        \"background-color\": \"rgba(0, 0, 0, 0)\",\n-        \"border-color\": \"rgb(33, 150, 243)\",\n-        \"box-shadow\": \"rgb(33, 150, 243) 0px 0px 1px 1px\",\n-    },\n-)\n \n // We now switch the display.\n-click: \"#use-system-theme\"\n+click: \"#theme-system-preference\"\n // Wait for the hidden element to show up.\n wait-for: \".setting-line:not(.hidden) #preferred-dark-theme\"\n assert: \".setting-line:not(.hidden) #preferred-light-theme\"\n-// Check that the theme picking is hidden.\n-assert: \".setting-line.hidden #theme\"\n \n // We check their text as well.\n assert-text: (\"#preferred-dark-theme .setting-name\", \"Preferred dark theme\")"}, {"sha": "cc47f1f450c5a79b65b8c7527ef3ba97e769c278", "filename": "src/test/rustdoc-gui/theme-change.goml", "status": "modified", "additions": 41, "deletions": 6, "changes": 47, "blob_url": "https://github.com/rust-lang/rust/blob/43dca249a218305591e6eb896dd63c419871b018/src%2Ftest%2Frustdoc-gui%2Ftheme-change.goml", "raw_url": "https://github.com/rust-lang/rust/raw/43dca249a218305591e6eb896dd63c419871b018/src%2Ftest%2Frustdoc-gui%2Ftheme-change.goml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-gui%2Ftheme-change.goml?ref=43dca249a218305591e6eb896dd63c419871b018", "patch": "@@ -2,31 +2,66 @@\n goto: \"file://\" + |DOC_PATH| + \"/test_docs/index.html\"\n local-storage: {\"rustdoc-use-system-theme\": \"false\", \"rustdoc-theme\": \"dark\"}\n reload:\n+\n+store-value: (background_light, \"rgb(255, 255, 255)\")\n+store-value: (background_dark, \"rgb(53, 53, 53)\")\n+store-value: (background_ayu, \"rgb(15, 20, 25)\")\n+\n click: \"#settings-menu\"\n wait-for: \"#theme-ayu\"\n click: \"#theme-ayu\"\n // should be the ayu theme so let's check the color.\n-wait-for-css: (\"body\", { \"background-color\": \"rgb(15, 20, 25)\" })\n+wait-for-css: (\"body\", { \"background-color\": |background_ayu| })\n assert-local-storage: { \"rustdoc-theme\": \"ayu\" }\n click: \"#theme-light\"\n // should be the light theme so let's check the color.\n-wait-for-css: (\"body\", { \"background-color\": \"rgb(255, 255, 255)\" })\n+wait-for-css: (\"body\", { \"background-color\": |background_light| })\n assert-local-storage: { \"rustdoc-theme\": \"light\" }\n click: \"#theme-dark\"\n // Should be the dark theme so let's check the color.\n-wait-for-css: (\"body\", { \"background-color\": \"rgb(53, 53, 53)\" })\n+wait-for-css: (\"body\", { \"background-color\": |background_dark| })\n assert-local-storage: { \"rustdoc-theme\": \"dark\" }\n \n+local-storage: {\n+    \"rustdoc-preferred-light-theme\": \"light\",\n+    \"rustdoc-preferred-dark-theme\": \"light\",\n+}\n goto: \"file://\" + |DOC_PATH| + \"/settings.html\"\n+\n wait-for: \"#settings\"\n click: \"#theme-light\"\n-wait-for-css: (\"body\", { \"background-color\": \"rgb(255, 255, 255)\" })\n+wait-for-css: (\"body\", { \"background-color\": |background_light| })\n assert-local-storage: { \"rustdoc-theme\": \"light\" }\n \n click: \"#theme-dark\"\n-wait-for-css: (\"body\", { \"background-color\": \"rgb(53, 53, 53)\" })\n+wait-for-css: (\"body\", { \"background-color\": |background_dark| })\n assert-local-storage: { \"rustdoc-theme\": \"dark\" }\n \n click: \"#theme-ayu\"\n-wait-for-css: (\"body\", { \"background-color\": \"rgb(15, 20, 25)\" })\n+wait-for-css: (\"body\", { \"background-color\": |background_ayu| })\n assert-local-storage: { \"rustdoc-theme\": \"ayu\" }\n+\n+assert-local-storage-false: { \"rustdoc-use-system-theme\": \"true\" }\n+click: \"#theme-system-preference\"\n+wait-for: \".setting-line:not(.hidden) #preferred-light-theme\"\n+assert-local-storage: { \"rustdoc-use-system-theme\": \"true\" }\n+// We click on both preferred light and dark themes to be sure that there is a change.\n+click: \"#preferred-light-theme-dark\"\n+click: \"#preferred-dark-theme-dark\"\n+wait-for-css: (\"body\", { \"background-color\": |background_dark| })\n+\n+reload:\n+// Ensure that the \"preferred themes\" are still displayed.\n+wait-for: \".setting-line:not(.hidden) #preferred-light-theme\"\n+click: \"#theme-light\"\n+wait-for-css: (\"body\", { \"background-color\": |background_light| })\n+assert-local-storage: { \"rustdoc-theme\": \"light\" }\n+// Ensure it's now hidden again\n+wait-for: \".setting-line.hidden #preferred-light-theme\"\n+// And ensure the theme was rightly set.\n+wait-for-css: (\"body\", { \"background-color\": |background_light| })\n+assert-local-storage: { \"rustdoc-theme\": \"light\" }\n+\n+reload:\n+wait-for: \"#settings\"\n+assert: \".setting-line.hidden #preferred-light-theme\""}]}