{"sha": "6bd9fb85255581cab7888965b464e462582bbb5f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZiZDlmYjg1MjU1NTgxY2FiNzg4ODk2NWI0NjRlNDYyNTgyYmJiNWY=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-12-07T12:46:02Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-12-07T12:46:02Z"}, "message": "Merge pull request #2491 from matklad/skip-heavy-tests-by-default\n\nSkip slow tests by default", "tree": {"sha": "980c78e286c207bf9d056ffecbab62468f83aa2d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/980c78e286c207bf9d056ffecbab62468f83aa2d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6bd9fb85255581cab7888965b464e462582bbb5f", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJd658KCRBK7hj4Ov3rIwAAdHIIAIvPfT80O2ZnAbARVDNypOrx\nq876r74WJerVc4YjVf8RMGg7Ga2jAgetxlymrLjnukz54g0BX1L0/zeeKJBELUJp\ngqy9K9Sn7flLT1iBReAJrY7nAW3HxqPjKj+Pky0M0fh2FNaZA4hv9sgEKSVSQiBQ\ni6kJoJsOEQpgEypB4Xy9O9BYTUzGlpG+dS5ZP4hhHl3eUf0qrhg76ZjYj+R6yyGK\n+8L/dNwVfKCXE1uFNcELBzOdmbJe6706SNDIYIqYr1svm0ZTXvVkrjX8wCZMNuo+\nI30R9w67mpujywOYfNQP58lSjjktGXjavm8SZnbgR+nljMrxQPyRYahf+ZN6wm4=\n=qcY0\n-----END PGP SIGNATURE-----\n", "payload": "tree 980c78e286c207bf9d056ffecbab62468f83aa2d\nparent 7aac5f2b427247120025f63c4864a1b937ed20c7\nparent 8ec5f2fcdcdd2e2a9297093189ad8c05e1dd7a8f\nauthor Aleksey Kladov <aleksey.kladov@gmail.com> 1575722762 +0100\ncommitter GitHub <noreply@github.com> 1575722762 +0100\n\nMerge pull request #2491 from matklad/skip-heavy-tests-by-default\n\nSkip slow tests by default"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6bd9fb85255581cab7888965b464e462582bbb5f", "html_url": "https://github.com/rust-lang/rust/commit/6bd9fb85255581cab7888965b464e462582bbb5f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6bd9fb85255581cab7888965b464e462582bbb5f/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7aac5f2b427247120025f63c4864a1b937ed20c7", "url": "https://api.github.com/repos/rust-lang/rust/commits/7aac5f2b427247120025f63c4864a1b937ed20c7", "html_url": "https://github.com/rust-lang/rust/commit/7aac5f2b427247120025f63c4864a1b937ed20c7"}, {"sha": "8ec5f2fcdcdd2e2a9297093189ad8c05e1dd7a8f", "url": "https://api.github.com/repos/rust-lang/rust/commits/8ec5f2fcdcdd2e2a9297093189ad8c05e1dd7a8f", "html_url": "https://github.com/rust-lang/rust/commit/8ec5f2fcdcdd2e2a9297093189ad8c05e1dd7a8f"}], "stats": {"total": 57, "additions": 54, "deletions": 3}, "files": [{"sha": "cb397ae14ae5a5085eb000955c867477efd6a6ca", "filename": ".github/workflows/ci.yaml", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/6bd9fb85255581cab7888965b464e462582bbb5f/.github%2Fworkflows%2Fci.yaml", "raw_url": "https://github.com/rust-lang/rust/raw/6bd9fb85255581cab7888965b464e462582bbb5f/.github%2Fworkflows%2Fci.yaml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.github%2Fworkflows%2Fci.yaml?ref=6bd9fb85255581cab7888965b464e462582bbb5f", "patch": "@@ -14,6 +14,7 @@ jobs:\n     env:\n       RUSTFLAGS: -D warnings\n       CARGO_INCREMENTAL: 0\n+      RUN_SLOW_TESTS: 1\n     steps:\n \n       - name: Checkout repository\n@@ -46,9 +47,10 @@ jobs:\n \n       - name: Prepare build directory for cache\n         run: |\n-          find ./target/debug -maxdepth 1 -type f -delete && \\\n-          rm -fr ./target/debug/{deps,.fingerprint}/{*ra_*,*heavy_test*,*gen_lsp*,*thread_worker*} && \\\n-          rm -f  ./target/.rustc_info.json\n+          find ./target/debug -maxdepth 1 -type f -delete \\\n+          && rm -fr ./target/debug/{deps,.fingerprint}/{*ra_*,*heavy_test*,*gen_lsp*,*thread_worker*} \\\n+          && rm -f  ./target/.rustc_info.json \\\n+          && rm ./target/.slow_tests_cookie\n \n   type-script:\n     name: TypeScript"}, {"sha": "cfbf16ea5f064163191232d46ac0c293ae7940e5", "filename": "crates/ra_lsp_server/tests/heavy_tests/main.rs", "status": "modified", "additions": 38, "deletions": 0, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/6bd9fb85255581cab7888965b464e462582bbb5f/crates%2Fra_lsp_server%2Ftests%2Fheavy_tests%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6bd9fb85255581cab7888965b464e462582bbb5f/crates%2Fra_lsp_server%2Ftests%2Fheavy_tests%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2Ftests%2Fheavy_tests%2Fmain.rs?ref=6bd9fb85255581cab7888965b464e462582bbb5f", "patch": "@@ -12,6 +12,7 @@ use ra_lsp_server::req::{\n };\n use serde_json::json;\n use tempfile::TempDir;\n+use test_utils::skip_slow_tests;\n \n use crate::support::{project, Project};\n \n@@ -20,6 +21,10 @@ const PROFILE: &'static str = \"\";\n \n #[test]\n fn completes_items_from_standard_library() {\n+    if skip_slow_tests() {\n+        return;\n+    }\n+\n     let project_start = Instant::now();\n     let server = Project::with_fixture(\n         r#\"\n@@ -50,6 +55,10 @@ use std::collections::Spam;\n \n #[test]\n fn test_runnables_no_project() {\n+    if skip_slow_tests() {\n+        return;\n+    }\n+\n     let server = project(\n         r\"\n //- lib.rs\n@@ -99,6 +108,10 @@ fn foo() {\n \n #[test]\n fn test_runnables_project() {\n+    if skip_slow_tests() {\n+        return;\n+    }\n+\n     let code = r#\"\n //- foo/Cargo.toml\n [package]\n@@ -170,6 +183,10 @@ fn main() {}\n \n #[test]\n fn test_format_document() {\n+    if skip_slow_tests() {\n+        return;\n+    }\n+\n     let server = project(\n         r#\"\n //- Cargo.toml\n@@ -222,6 +239,10 @@ pub use std::collections::HashMap;\n \n #[test]\n fn test_format_document_2018() {\n+    if skip_slow_tests() {\n+        return;\n+    }\n+\n     let server = project(\n         r#\"\n //- Cargo.toml\n@@ -277,8 +298,13 @@ pub use std::collections::HashMap;\n         ]),\n     );\n }\n+\n #[test]\n fn test_missing_module_code_action() {\n+    if skip_slow_tests() {\n+        return;\n+    }\n+\n     let server = project(\n         r#\"\n //- Cargo.toml\n@@ -337,6 +363,10 @@ fn main() {}\n \n #[test]\n fn test_missing_module_code_action_in_json_project() {\n+    if skip_slow_tests() {\n+        return;\n+    }\n+\n     let tmp_dir = TempDir::new().unwrap();\n \n     let path = tmp_dir.path();\n@@ -412,6 +442,10 @@ fn main() {{}}\n \n #[test]\n fn diagnostics_dont_block_typing() {\n+    if skip_slow_tests() {\n+        return;\n+    }\n+\n     let librs: String = (0..10).map(|i| format!(\"mod m{};\", i)).collect();\n     let libs: String = (0..10).map(|i| format!(\"//- src/m{}.rs\\nfn foo() {{}}\\n\\n\", i)).collect();\n     let server = Project::with_fixture(&format!(\n@@ -480,6 +514,10 @@ fn main() {{}}\n \n #[test]\n fn preserves_dos_line_endings() {\n+    if skip_slow_tests() {\n+        return;\n+    }\n+\n     let server = Project::with_fixture(\n         &\"\n //- Cargo.toml"}, {"sha": "657ddf2a691b5815caa06b70e0664e8caa5b5c69", "filename": "crates/test_utils/src/lib.rs", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/6bd9fb85255581cab7888965b464e462582bbb5f/crates%2Ftest_utils%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6bd9fb85255581cab7888965b464e462582bbb5f/crates%2Ftest_utils%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Ftest_utils%2Fsrc%2Flib.rs?ref=6bd9fb85255581cab7888965b464e462582bbb5f", "patch": "@@ -356,6 +356,17 @@ pub fn read_text(path: &Path) -> String {\n         .replace(\"\\r\\n\", \"\\n\")\n }\n \n+pub fn skip_slow_tests() -> bool {\n+    let should_skip = std::env::var(\"CI\").is_err() && std::env::var(\"RUN_SLOW_TESTS\").is_err();\n+    if should_skip {\n+        eprintln!(\"ignoring slow test\")\n+    } else {\n+        let path = project_dir().join(\"./target/.slow_tests_cookie\");\n+        fs::write(&path, \".\").unwrap();\n+    }\n+    should_skip\n+}\n+\n const REWRITE: bool = false;\n \n fn assert_equal_text(expected: &str, actual: &str, path: &Path) {"}]}