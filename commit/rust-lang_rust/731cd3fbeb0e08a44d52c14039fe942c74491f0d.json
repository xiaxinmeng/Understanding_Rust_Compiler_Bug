{"sha": "731cd3fbeb0e08a44d52c14039fe942c74491f0d", "node_id": "C_kwDOAAsO6NoAKDczMWNkM2ZiZWIwZTA4YTQ0ZDUyYzE0MDM5ZmU5NDJjNzQ0OTFmMGQ", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-02-25T13:14:40Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-02-25T13:14:40Z"}, "message": "Rollup merge of #94344 - notriddle:notriddle/suggest-parens-more, r=oli-obk\n\ndiagnostic: suggest parens when users want logical ops, but get closures\n\nFixes #93536", "tree": {"sha": "603794c02d501f40e703078f1c3335bd54e5706d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/603794c02d501f40e703078f1c3335bd54e5706d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/731cd3fbeb0e08a44d52c14039fe942c74491f0d", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJiGNZACRBK7hj4Ov3rIwAAeJIIAB1jad0EFG5jJacCmX5MTVWV\nicoBxKCCDDxwLPyNUZCGpvocCiygZHqNzPJ6UD4FdH4YJX/22GBB3mb0Y4q63USR\nqD/n/RT/zDKnV5mKHaoRcsQbQEf78AiQmC9DZPowPBw3kh5l+XV6r56hBW7YPPpT\nvD4qWchjLH7bI+fcYOLQZtdmsYy44hp5rlRJKet0jsXMmRBp9lDGrsnGYjZl35po\nIWTxqka8JnpT8Jfi36rx2yFntTzmROsTWAw7wPu+DeAzKlYb3NStGmI6jPsOZhTa\nYPxfSxmFJKjf0n0pb1ne8dtTMOfZO9Yq3cnmXdeTCTf1hVuFtQs1EltEo28UeVQ=\n=vpCg\n-----END PGP SIGNATURE-----\n", "payload": "tree 603794c02d501f40e703078f1c3335bd54e5706d\nparent cf3bb098881da40eed6ce7ad913a7e5d904663e2\nparent fd35770e8d092b79eef16a7061e202307f730c90\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1645794880 +0100\ncommitter GitHub <noreply@github.com> 1645794880 +0100\n\nRollup merge of #94344 - notriddle:notriddle/suggest-parens-more, r=oli-obk\n\ndiagnostic: suggest parens when users want logical ops, but get closures\n\nFixes #93536\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/731cd3fbeb0e08a44d52c14039fe942c74491f0d", "html_url": "https://github.com/rust-lang/rust/commit/731cd3fbeb0e08a44d52c14039fe942c74491f0d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/731cd3fbeb0e08a44d52c14039fe942c74491f0d/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cf3bb098881da40eed6ce7ad913a7e5d904663e2", "url": "https://api.github.com/repos/rust-lang/rust/commits/cf3bb098881da40eed6ce7ad913a7e5d904663e2", "html_url": "https://github.com/rust-lang/rust/commit/cf3bb098881da40eed6ce7ad913a7e5d904663e2"}, {"sha": "fd35770e8d092b79eef16a7061e202307f730c90", "url": "https://api.github.com/repos/rust-lang/rust/commits/fd35770e8d092b79eef16a7061e202307f730c90", "html_url": "https://github.com/rust-lang/rust/commit/fd35770e8d092b79eef16a7061e202307f730c90"}], "stats": {"total": 154, "additions": 151, "deletions": 3}, "files": [{"sha": "a11cb3f5677c6fb8aeab0df15e86158406aee326", "filename": "compiler/rustc_parse/src/parser/expr.rs", "status": "modified", "additions": 16, "deletions": 2, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/731cd3fbeb0e08a44d52c14039fe942c74491f0d/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/731cd3fbeb0e08a44d52c14039fe942c74491f0d/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fexpr.rs?ref=731cd3fbeb0e08a44d52c14039fe942c74491f0d", "patch": "@@ -372,10 +372,17 @@ impl<'a> Parser<'a> {\n                 self.sess.ambiguous_block_expr_parse.borrow_mut().insert(sp, lhs.span);\n                 false\n             }\n-            (true, Some(AssocOp::LAnd)) => {\n+            (true, Some(AssocOp::LAnd)) |\n+            (true, Some(AssocOp::LOr)) |\n+            (true, Some(AssocOp::BitOr)) => {\n                 // `{ 42 } &&x` (#61475) or `{ 42 } && if x { 1 } else { 0 }`. Separated from the\n                 // above due to #74233.\n                 // These cases are ambiguous and can't be identified in the parser alone.\n+                //\n+                // Bitwise AND is left out because guessing intent is hard. We can make\n+                // suggestions based on the assumption that double-refs are rarely intentional,\n+                // and closures are distinct enough that they don't get mixed up with their\n+                // return value.\n                 let sp = self.sess.source_map().start_point(self.token.span);\n                 self.sess.ambiguous_block_expr_parse.borrow_mut().insert(sp, lhs.span);\n                 false\n@@ -1247,7 +1254,14 @@ impl<'a> Parser<'a> {\n         } else if self.check(&token::OpenDelim(token::Brace)) {\n             self.parse_block_expr(None, lo, BlockCheckMode::Default, attrs)\n         } else if self.check(&token::BinOp(token::Or)) || self.check(&token::OrOr) {\n-            self.parse_closure_expr(attrs)\n+            self.parse_closure_expr(attrs).map_err(|mut err| {\n+                // If the input is something like `if a { 1 } else { 2 } | if a { 3 } else { 4 }`\n+                // then suggest parens around the lhs.\n+                if let Some(sp) = self.sess.ambiguous_block_expr_parse.borrow().get(&lo) {\n+                    self.sess.expr_parentheses_needed(&mut err, *sp);\n+                }\n+                err\n+            })\n         } else if self.check(&token::OpenDelim(token::Bracket)) {\n             self.parse_array_or_repeat_expr(attrs, token::Bracket)\n         } else if self.check_path() {"}, {"sha": "36709eea17c2144795de5995d944bf091a490b9f", "filename": "src/test/ui/parser/expr-as-stmt.fixed", "status": "modified", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/731cd3fbeb0e08a44d52c14039fe942c74491f0d/src%2Ftest%2Fui%2Fparser%2Fexpr-as-stmt.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/731cd3fbeb0e08a44d52c14039fe942c74491f0d/src%2Ftest%2Fui%2Fparser%2Fexpr-as-stmt.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fexpr-as-stmt.fixed?ref=731cd3fbeb0e08a44d52c14039fe942c74491f0d", "patch": "@@ -37,4 +37,31 @@ fn qux() -> u32 {\n     //~^ ERROR mismatched types\n }\n \n+fn space_cadet() -> bool {\n+    ({ true }) | { true } //~ ERROR E0308\n+    //~^ ERROR expected parameter name\n+}\n+\n+fn revenge_from_mars() -> bool {\n+    ({ true }) && { true } //~ ERROR E0308\n+    //~^ ERROR mismatched types\n+}\n+\n+fn attack_from_mars() -> bool {\n+    ({ true }) || { true } //~ ERROR E0308\n+    //~^ ERROR mismatched types\n+}\n+\n+// This gets corrected by adding a semicolon, instead of parens.\n+// It's placed here to help keep track of the way this diagnostic\n+// needs to interact with type checking to avoid MachineApplicable\n+// suggestions that actually break stuff.\n+//\n+// If you're wondering what happens if that `foo()` is a `true` like\n+// all the ones above use? Nothing. It makes neither suggestion in\n+// that case.\n+fn asteroids() -> impl FnOnce() -> bool {\n+    { foo(); } || { true } //~ ERROR E0308\n+}\n+\n fn main() {}"}, {"sha": "92bb972b24020e3cc29ce21ef0d4e79d98bafffd", "filename": "src/test/ui/parser/expr-as-stmt.rs", "status": "modified", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/731cd3fbeb0e08a44d52c14039fe942c74491f0d/src%2Ftest%2Fui%2Fparser%2Fexpr-as-stmt.rs", "raw_url": "https://github.com/rust-lang/rust/raw/731cd3fbeb0e08a44d52c14039fe942c74491f0d/src%2Ftest%2Fui%2Fparser%2Fexpr-as-stmt.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fexpr-as-stmt.rs?ref=731cd3fbeb0e08a44d52c14039fe942c74491f0d", "patch": "@@ -37,4 +37,31 @@ fn qux() -> u32 {\n     //~^ ERROR mismatched types\n }\n \n+fn space_cadet() -> bool {\n+    { true } | { true } //~ ERROR E0308\n+    //~^ ERROR expected parameter name\n+}\n+\n+fn revenge_from_mars() -> bool {\n+    { true } && { true } //~ ERROR E0308\n+    //~^ ERROR mismatched types\n+}\n+\n+fn attack_from_mars() -> bool {\n+    { true } || { true } //~ ERROR E0308\n+    //~^ ERROR mismatched types\n+}\n+\n+// This gets corrected by adding a semicolon, instead of parens.\n+// It's placed here to help keep track of the way this diagnostic\n+// needs to interact with type checking to avoid MachineApplicable\n+// suggestions that actually break stuff.\n+//\n+// If you're wondering what happens if that `foo()` is a `true` like\n+// all the ones above use? Nothing. It makes neither suggestion in\n+// that case.\n+fn asteroids() -> impl FnOnce() -> bool {\n+    { foo() } || { true } //~ ERROR E0308\n+}\n+\n fn main() {}"}, {"sha": "df0e4dcb16e2cbc57abb68659db7b9e804e1a6ac", "filename": "src/test/ui/parser/expr-as-stmt.stderr", "status": "modified", "additions": 81, "deletions": 1, "changes": 82, "blob_url": "https://github.com/rust-lang/rust/blob/731cd3fbeb0e08a44d52c14039fe942c74491f0d/src%2Ftest%2Fui%2Fparser%2Fexpr-as-stmt.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/731cd3fbeb0e08a44d52c14039fe942c74491f0d/src%2Ftest%2Fui%2Fparser%2Fexpr-as-stmt.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fexpr-as-stmt.stderr?ref=731cd3fbeb0e08a44d52c14039fe942c74491f0d", "patch": "@@ -44,6 +44,25 @@ LL |         _ => 1,\n LL ~     }) > 0\n    |\n \n+error: expected parameter name, found `{`\n+  --> $DIR/expr-as-stmt.rs:41:16\n+   |\n+LL |     { true } | { true }\n+   |                ^ expected parameter name\n+   |\n+help: parentheses are required to parse this as an expression\n+   |\n+LL |     ({ true }) | { true }\n+   |     +        +\n+\n+error[E0308]: mismatched types\n+  --> $DIR/expr-as-stmt.rs:64:7\n+   |\n+LL |     { foo() } || { true }\n+   |       ^^^^^- help: consider using a semicolon here: `;`\n+   |       |\n+   |       expected `()`, found `i32`\n+\n error[E0308]: mismatched types\n   --> $DIR/expr-as-stmt.rs:8:6\n    |\n@@ -121,7 +140,68 @@ help: parentheses are required to parse this as an expression\n LL |     ({2}) - 2\n    |     +   +\n \n-error: aborting due to 11 previous errors\n+error[E0308]: mismatched types\n+  --> $DIR/expr-as-stmt.rs:41:7\n+   |\n+LL |     { true } | { true }\n+   |       ^^^^ expected `()`, found `bool`\n+   |\n+help: you might have meant to return this value\n+   |\n+LL |     { return true; } | { true }\n+   |       ++++++     +\n+\n+error[E0308]: mismatched types\n+  --> $DIR/expr-as-stmt.rs:46:7\n+   |\n+LL |     { true } && { true }\n+   |       ^^^^ expected `()`, found `bool`\n+   |\n+help: you might have meant to return this value\n+   |\n+LL |     { return true; } && { true }\n+   |       ++++++     +\n+\n+error[E0308]: mismatched types\n+  --> $DIR/expr-as-stmt.rs:46:14\n+   |\n+LL | fn revenge_from_mars() -> bool {\n+   |                           ---- expected `bool` because of return type\n+LL |     { true } && { true }\n+   |              ^^^^^^^^^^^ expected `bool`, found `&&bool`\n+   |\n+help: parentheses are required to parse this as an expression\n+   |\n+LL |     ({ true }) && { true }\n+   |     +        +\n+\n+error[E0308]: mismatched types\n+  --> $DIR/expr-as-stmt.rs:51:7\n+   |\n+LL |     { true } || { true }\n+   |       ^^^^ expected `()`, found `bool`\n+   |\n+help: you might have meant to return this value\n+   |\n+LL |     { return true; } || { true }\n+   |       ++++++     +\n+\n+error[E0308]: mismatched types\n+  --> $DIR/expr-as-stmt.rs:51:14\n+   |\n+LL | fn attack_from_mars() -> bool {\n+   |                          ---- expected `bool` because of return type\n+LL |     { true } || { true }\n+   |              ^^^^^^^^^^^ expected `bool`, found closure\n+   |\n+   = note: expected type `bool`\n+           found closure `[closure@$DIR/expr-as-stmt.rs:51:14: 51:25]`\n+help: parentheses are required to parse this as an expression\n+   |\n+LL |     ({ true }) || { true }\n+   |     +        +\n+\n+error: aborting due to 18 previous errors\n \n Some errors have detailed explanations: E0308, E0600, E0614.\n For more information about an error, try `rustc --explain E0308`."}]}