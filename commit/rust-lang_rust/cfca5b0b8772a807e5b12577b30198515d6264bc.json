{"sha": "cfca5b0b8772a807e5b12577b30198515d6264bc", "node_id": "C_kwDOAAsO6NoAKGNmY2E1YjBiODc3MmE4MDdlNWIxMjU3N2IzMDE5ODUxNWQ2MjY0YmM", "commit": {"author": {"name": "Michael Woerister", "email": "michaelwoerister@posteo", "date": "2023-05-17T08:45:57Z"}, "committer": {"name": "Michael Woerister", "email": "michaelwoerister@posteo", "date": "2023-05-17T09:39:11Z"}, "message": "Add/improve tests for debugger_visualizer change detection.", "tree": {"sha": "eb6e4a6f51dac3365cc1330211f7dbb9b42871df", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/eb6e4a6f51dac3365cc1330211f7dbb9b42871df"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cfca5b0b8772a807e5b12577b30198515d6264bc", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cfca5b0b8772a807e5b12577b30198515d6264bc", "html_url": "https://github.com/rust-lang/rust/commit/cfca5b0b8772a807e5b12577b30198515d6264bc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cfca5b0b8772a807e5b12577b30198515d6264bc/comments", "author": {"login": "michaelwoerister", "id": 1825894, "node_id": "MDQ6VXNlcjE4MjU4OTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1825894?v=4", "gravatar_id": "", "url": "https://api.github.com/users/michaelwoerister", "html_url": "https://github.com/michaelwoerister", "followers_url": "https://api.github.com/users/michaelwoerister/followers", "following_url": "https://api.github.com/users/michaelwoerister/following{/other_user}", "gists_url": "https://api.github.com/users/michaelwoerister/gists{/gist_id}", "starred_url": "https://api.github.com/users/michaelwoerister/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/michaelwoerister/subscriptions", "organizations_url": "https://api.github.com/users/michaelwoerister/orgs", "repos_url": "https://api.github.com/users/michaelwoerister/repos", "events_url": "https://api.github.com/users/michaelwoerister/events{/privacy}", "received_events_url": "https://api.github.com/users/michaelwoerister/received_events", "type": "User", "site_admin": false}, "committer": {"login": "michaelwoerister", "id": 1825894, "node_id": "MDQ6VXNlcjE4MjU4OTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1825894?v=4", "gravatar_id": "", "url": "https://api.github.com/users/michaelwoerister", "html_url": "https://github.com/michaelwoerister", "followers_url": "https://api.github.com/users/michaelwoerister/followers", "following_url": "https://api.github.com/users/michaelwoerister/following{/other_user}", "gists_url": "https://api.github.com/users/michaelwoerister/gists{/gist_id}", "starred_url": "https://api.github.com/users/michaelwoerister/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/michaelwoerister/subscriptions", "organizations_url": "https://api.github.com/users/michaelwoerister/orgs", "repos_url": "https://api.github.com/users/michaelwoerister/repos", "events_url": "https://api.github.com/users/michaelwoerister/events{/privacy}", "received_events_url": "https://api.github.com/users/michaelwoerister/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d6236685516420bbc70399fcfc74f3b7e46e8349", "url": "https://api.github.com/repos/rust-lang/rust/commits/d6236685516420bbc70399fcfc74f3b7e46e8349", "html_url": "https://github.com/rust-lang/rust/commit/d6236685516420bbc70399fcfc74f3b7e46e8349"}], "stats": {"total": 68, "additions": 63, "deletions": 5}, "files": [{"sha": "0877998a74fe7864b1ade280bbc74f530f969397", "filename": "tests/run-make/debugger-visualizer-dep-info/Makefile", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/cfca5b0b8772a807e5b12577b30198515d6264bc/tests%2Frun-make%2Fdebugger-visualizer-dep-info%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/cfca5b0b8772a807e5b12577b30198515d6264bc/tests%2Frun-make%2Fdebugger-visualizer-dep-info%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-make%2Fdebugger-visualizer-dep-info%2FMakefile?ref=cfca5b0b8772a807e5b12577b30198515d6264bc", "patch": "@@ -1,8 +1,9 @@\n-# ignore-windows-gnu\n-\n include ../tools.mk\n \n+# This test makes sure that files referenced via #[debugger_visualizer] are\n+# included in `--emit dep-info` output.\n+\n all:\n \t$(RUSTC) --emit dep-info main.rs\n \t$(CGREP) \"foo.py\" < $(TMPDIR)/main.d\n-\t$(CGREP) \"my_visualizers/bar.py\" < $(TMPDIR)/main.d\n+\t$(CGREP) \"my_visualizers/bar.natvis\" < $(TMPDIR)/main.d"}, {"sha": "3aede2215eac23485aa8c3db7c7710f7dfdcb0c7", "filename": "tests/run-make/debugger-visualizer-dep-info/main.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/cfca5b0b8772a807e5b12577b30198515d6264bc/tests%2Frun-make%2Fdebugger-visualizer-dep-info%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cfca5b0b8772a807e5b12577b30198515d6264bc/tests%2Frun-make%2Fdebugger-visualizer-dep-info%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-make%2Fdebugger-visualizer-dep-info%2Fmain.rs?ref=cfca5b0b8772a807e5b12577b30198515d6264bc", "patch": "@@ -3,7 +3,7 @@\n fn main() {\n     const _UNUSED: u32 = {\n         mod inner {\n-            #![debugger_visualizer(gdb_script_file = \"my_visualizers/bar.py\")]\n+            #![debugger_visualizer(natvis_file = \"my_visualizers/bar.natvis\")]\n             pub const XYZ: u32 = 123;\n         }\n "}, {"sha": "c341a403902b9c6eb2ccdd2cb62b9ba88ddaf37a", "filename": "tests/run-make/debugger-visualizer-dep-info/my_visualizers/bar.natvis", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/cfca5b0b8772a807e5b12577b30198515d6264bc/tests%2Frun-make%2Fdebugger-visualizer-dep-info%2Fmy_visualizers%2Fbar.natvis", "raw_url": "https://github.com/rust-lang/rust/raw/cfca5b0b8772a807e5b12577b30198515d6264bc/tests%2Frun-make%2Fdebugger-visualizer-dep-info%2Fmy_visualizers%2Fbar.natvis", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-make%2Fdebugger-visualizer-dep-info%2Fmy_visualizers%2Fbar.natvis?ref=cfca5b0b8772a807e5b12577b30198515d6264bc", "patch": "@@ -0,0 +1 @@\n+<!-- empty -->"}, {"sha": "1bb8bf6d7fd4c8d09aea89b47de20fb8bbb61626", "filename": "tests/run-make/debugger-visualizer-dep-info/my_visualizers/bar.py", "status": "removed", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d6236685516420bbc70399fcfc74f3b7e46e8349/tests%2Frun-make%2Fdebugger-visualizer-dep-info%2Fmy_visualizers%2Fbar.py", "raw_url": "https://github.com/rust-lang/rust/raw/d6236685516420bbc70399fcfc74f3b7e46e8349/tests%2Frun-make%2Fdebugger-visualizer-dep-info%2Fmy_visualizers%2Fbar.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-make%2Fdebugger-visualizer-dep-info%2Fmy_visualizers%2Fbar.py?ref=d6236685516420bbc70399fcfc74f3b7e46e8349", "patch": "@@ -1 +0,0 @@\n-# empty"}, {"sha": "3084dde7e99d80d2a588067e40fc69b2a54f71d6", "filename": "tests/run-make/incremental-debugger-visualizer/Makefile", "status": "added", "additions": 51, "deletions": 0, "changes": 51, "blob_url": "https://github.com/rust-lang/rust/blob/cfca5b0b8772a807e5b12577b30198515d6264bc/tests%2Frun-make%2Fincremental-debugger-visualizer%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/cfca5b0b8772a807e5b12577b30198515d6264bc/tests%2Frun-make%2Fincremental-debugger-visualizer%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-make%2Fincremental-debugger-visualizer%2FMakefile?ref=cfca5b0b8772a807e5b12577b30198515d6264bc", "patch": "@@ -0,0 +1,51 @@\n+include ../tools.mk\n+\n+# This test makes sure that changes to files referenced via #[debugger_visualizer]\n+# are picked up when compiling incrementally.\n+\n+# We have to copy the source to $(TMPDIR) because Github CI mounts the source\n+# directory as readonly. We need to apply modifications to some of the source\n+# file.\n+SRC_DIR := $(TMPDIR)/src\n+\n+INCR_CACHE_DIR := $(TMPDIR)/incremental\n+\n+\n+all:\n+\trm -rf $(TMPDIR)/*\n+\tmkdir $(SRC_DIR)\n+\tcp -t $(SRC_DIR) ./foo.rs\n+\techo \"GDB script v1\" > $(SRC_DIR)/foo.py\n+\techo \"Natvis v1\" > $(SRC_DIR)/foo.natvis\n+\t$(RUSTC) $(SRC_DIR)/foo.rs \\\n+\t  --crate-type=rlib \\\n+\t  --emit metadata \\\n+\t  -C incremental=$(INCR_CACHE_DIR) \\\n+\t  -Z incremental-verify-ich\n+\t$(CGREP) \"GDB script v1\" < $(TMPDIR)/libfoo.rmeta\n+\t$(CGREP) \"Natvis v1\" < $(TMPDIR)/libfoo.rmeta\n+\n+\t# Change only the GDB script and check that the change has been picked up\n+\techo \"GDB script v2\" > $(SRC_DIR)/foo.py\n+\t$(RUSTC) $(SRC_DIR)/foo.rs \\\n+\t  --crate-type=rlib \\\n+\t  --emit metadata \\\n+\t  -C incremental=$(INCR_CACHE_DIR) \\\n+\t  -Z incremental-verify-ich\n+\n+\t$(CGREP) \"GDB script v2\" < $(TMPDIR)/libfoo.rmeta\n+\t$(CGREP) -v \"GDB script v1\" < $(TMPDIR)/libfoo.rmeta\n+\t$(CGREP) \"Natvis v1\" < $(TMPDIR)/libfoo.rmeta\n+\n+\t# Now change the Natvis version and check that the change has been picked up\n+\techo \"Natvis v2\" > $(SRC_DIR)/foo.natvis\n+\t$(RUSTC) $(SRC_DIR)/foo.rs \\\n+\t  --crate-type=rlib \\\n+\t  --emit metadata \\\n+\t  -C incremental=$(INCR_CACHE_DIR) \\\n+\t  -Z incremental-verify-ich\n+\n+\t$(CGREP) \"GDB script v2\" < $(TMPDIR)/libfoo.rmeta\n+\t$(CGREP) -v \"GDB script v1\" < $(TMPDIR)/libfoo.rmeta\n+\t$(CGREP) \"Natvis v2\" < $(TMPDIR)/libfoo.rmeta\n+\t$(CGREP) -v \"Natvis v1\" < $(TMPDIR)/libfoo.rmeta"}, {"sha": "8daa36a12d3810245379f2d3d5f7dd6c961f18a4", "filename": "tests/run-make/incremental-debugger-visualizer/foo.rs", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/cfca5b0b8772a807e5b12577b30198515d6264bc/tests%2Frun-make%2Fincremental-debugger-visualizer%2Ffoo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cfca5b0b8772a807e5b12577b30198515d6264bc/tests%2Frun-make%2Fincremental-debugger-visualizer%2Ffoo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-make%2Fincremental-debugger-visualizer%2Ffoo.rs?ref=cfca5b0b8772a807e5b12577b30198515d6264bc", "patch": "@@ -0,0 +1,6 @@\n+#![debugger_visualizer(natvis_file = \"./foo.natvis\")]\n+#![debugger_visualizer(gdb_script_file = \"./foo.py\")]\n+\n+pub struct Foo {\n+    pub x: u32,\n+}"}]}