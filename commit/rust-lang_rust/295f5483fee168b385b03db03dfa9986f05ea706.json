{"sha": "295f5483fee168b385b03db03dfa9986f05ea706", "node_id": "C_kwDOAAsO6NoAKDI5NWY1NDgzZmVlMTY4YjM4NWIwM2RiMDNkZmE5OTg2ZjA1ZWE3MDY", "commit": {"author": {"name": "clubby789", "email": "jamie@hill-daniel.co.uk", "date": "2023-01-15T05:06:33Z"}, "committer": {"name": "clubby789", "email": "jamie@hill-daniel.co.uk", "date": "2023-01-15T05:08:30Z"}, "message": "Fix regression in `unused_braces` with macros", "tree": {"sha": "5dd0a8dfcb2c063bee28077f7ec6d03e10dfc8d6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5dd0a8dfcb2c063bee28077f7ec6d03e10dfc8d6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/295f5483fee168b385b03db03dfa9986f05ea706", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/295f5483fee168b385b03db03dfa9986f05ea706", "html_url": "https://github.com/rust-lang/rust/commit/295f5483fee168b385b03db03dfa9986f05ea706", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/295f5483fee168b385b03db03dfa9986f05ea706/comments", "author": {"login": "clubby789", "id": 13556931, "node_id": "MDQ6VXNlcjEzNTU2OTMx", "avatar_url": "https://avatars.githubusercontent.com/u/13556931?v=4", "gravatar_id": "", "url": "https://api.github.com/users/clubby789", "html_url": "https://github.com/clubby789", "followers_url": "https://api.github.com/users/clubby789/followers", "following_url": "https://api.github.com/users/clubby789/following{/other_user}", "gists_url": "https://api.github.com/users/clubby789/gists{/gist_id}", "starred_url": "https://api.github.com/users/clubby789/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/clubby789/subscriptions", "organizations_url": "https://api.github.com/users/clubby789/orgs", "repos_url": "https://api.github.com/users/clubby789/repos", "events_url": "https://api.github.com/users/clubby789/events{/privacy}", "received_events_url": "https://api.github.com/users/clubby789/received_events", "type": "User", "site_admin": false}, "committer": {"login": "clubby789", "id": 13556931, "node_id": "MDQ6VXNlcjEzNTU2OTMx", "avatar_url": "https://avatars.githubusercontent.com/u/13556931?v=4", "gravatar_id": "", "url": "https://api.github.com/users/clubby789", "html_url": "https://github.com/clubby789", "followers_url": "https://api.github.com/users/clubby789/followers", "following_url": "https://api.github.com/users/clubby789/following{/other_user}", "gists_url": "https://api.github.com/users/clubby789/gists{/gist_id}", "starred_url": "https://api.github.com/users/clubby789/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/clubby789/subscriptions", "organizations_url": "https://api.github.com/users/clubby789/orgs", "repos_url": "https://api.github.com/users/clubby789/repos", "events_url": "https://api.github.com/users/clubby789/events{/privacy}", "received_events_url": "https://api.github.com/users/clubby789/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "754f6d4a8cf1963a3446b20b20fd10f42df1ee41", "url": "https://api.github.com/repos/rust-lang/rust/commits/754f6d4a8cf1963a3446b20b20fd10f42df1ee41", "html_url": "https://github.com/rust-lang/rust/commit/754f6d4a8cf1963a3446b20b20fd10f42df1ee41"}], "stats": {"total": 34, "additions": 29, "deletions": 5}, "files": [{"sha": "36791915964df75565cc6d3a1670fdc01b1e7f95", "filename": "compiler/rustc_lint/src/unused.rs", "status": "modified", "additions": 8, "deletions": 4, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/295f5483fee168b385b03db03dfa9986f05ea706/compiler%2Frustc_lint%2Fsrc%2Funused.rs", "raw_url": "https://github.com/rust-lang/rust/raw/295f5483fee168b385b03db03dfa9986f05ea706/compiler%2Frustc_lint%2Fsrc%2Funused.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_lint%2Fsrc%2Funused.rs?ref=295f5483fee168b385b03db03dfa9986f05ea706", "patch": "@@ -1095,17 +1095,21 @@ impl UnusedDelimLint for UnusedBraces {\n                 //      ```\n                 // - the block has no attribute and was not created inside a macro\n                 // - if the block is an `anon_const`, the inner expr must be a literal\n-                //      (do not lint `struct A<const N: usize>; let _: A<{ 2 + 3 }>;`)\n-                //\n+                //   not created by a macro, i.e. do not lint on:\n+                //      ```\n+                //      struct A<const N: usize>;\n+                //      let _: A<{ 2 + 3 }>;\n+                //      let _: A<{produces_literal!()}>;\n+                //      ```\n                 // FIXME(const_generics): handle paths when #67075 is fixed.\n                 if let [stmt] = inner.stmts.as_slice() {\n                     if let ast::StmtKind::Expr(ref expr) = stmt.kind {\n                         if !Self::is_expr_delims_necessary(expr, followed_by_block, false)\n                             && (ctx != UnusedDelimsCtx::AnonConst\n-                                || matches!(expr.kind, ast::ExprKind::Lit(_)))\n+                                || (matches!(expr.kind, ast::ExprKind::Lit(_))\n+                                    && !expr.span.from_expansion()))\n                             && !cx.sess().source_map().is_multiline(value.span)\n                             && value.attrs.is_empty()\n-                            && !expr.span.from_expansion()\n                             && !value.span.from_expansion()\n                             && !inner.span.from_expansion()\n                         {"}, {"sha": "e691fb37e6c43e51341367474a4fe12ac274edd0", "filename": "tests/ui/lint/unused_braces.fixed", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/295f5483fee168b385b03db03dfa9986f05ea706/tests%2Fui%2Flint%2Funused_braces.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/295f5483fee168b385b03db03dfa9986f05ea706/tests%2Fui%2Flint%2Funused_braces.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Flint%2Funused_braces.fixed?ref=295f5483fee168b385b03db03dfa9986f05ea706", "patch": "@@ -50,4 +50,8 @@ fn main() {\n     if { return } {\n \n     }\n+\n+    // regression test for https://github.com/rust-lang/rust/issues/106899\n+    return println!(\"!\");\n+    //~^ WARN unnecessary braces\n }"}, {"sha": "0d260d2cbc93f5d82dcc96f0c1fee67871bbf273", "filename": "tests/ui/lint/unused_braces.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/295f5483fee168b385b03db03dfa9986f05ea706/tests%2Fui%2Flint%2Funused_braces.rs", "raw_url": "https://github.com/rust-lang/rust/raw/295f5483fee168b385b03db03dfa9986f05ea706/tests%2Fui%2Flint%2Funused_braces.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Flint%2Funused_braces.rs?ref=295f5483fee168b385b03db03dfa9986f05ea706", "patch": "@@ -50,4 +50,8 @@ fn main() {\n     if { return } {\n \n     }\n+\n+    // regression test for https://github.com/rust-lang/rust/issues/106899\n+    return { println!(\"!\") };\n+    //~^ WARN unnecessary braces\n }"}, {"sha": "0b4a1c321805ddea51a8b4261d5794fd89b38efc", "filename": "tests/ui/lint/unused_braces.stderr", "status": "modified", "additions": 13, "deletions": 1, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/295f5483fee168b385b03db03dfa9986f05ea706/tests%2Fui%2Flint%2Funused_braces.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/295f5483fee168b385b03db03dfa9986f05ea706/tests%2Fui%2Flint%2Funused_braces.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Flint%2Funused_braces.stderr?ref=295f5483fee168b385b03db03dfa9986f05ea706", "patch": "@@ -68,5 +68,17 @@ LL -     consume({ 7 });\n LL +     consume(7);\n    |\n \n-warning: 5 warnings emitted\n+warning: unnecessary braces around `return` value\n+  --> $DIR/unused_braces.rs:55:12\n+   |\n+LL |     return { println!(\"!\") };\n+   |            ^^             ^^\n+   |\n+help: remove these braces\n+   |\n+LL -     return { println!(\"!\") };\n+LL +     return println!(\"!\");\n+   |\n+\n+warning: 6 warnings emitted\n "}]}