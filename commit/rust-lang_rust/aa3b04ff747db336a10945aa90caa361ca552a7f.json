{"sha": "aa3b04ff747db336a10945aa90caa361ca552a7f", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFhM2IwNGZmNzQ3ZGIzMzZhMTA5NDVhYTkwY2FhMzYxY2E1NTJhN2Y=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-08-21T23:43:20Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-08-21T23:43:20Z"}, "message": "Auto merge of #5933 - mikerite:fix-5927, r=matthiaskrgr\n\nFix false negative in `option_as_ref_deref`\n\nCloses #5927\n\nchangelog: Fix false negative in `option_as_ref_deref`", "tree": {"sha": "c5d2a316e2823fef295d69f058b12cfa4f5e0837", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c5d2a316e2823fef295d69f058b12cfa4f5e0837"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/aa3b04ff747db336a10945aa90caa361ca552a7f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/aa3b04ff747db336a10945aa90caa361ca552a7f", "html_url": "https://github.com/rust-lang/rust/commit/aa3b04ff747db336a10945aa90caa361ca552a7f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/aa3b04ff747db336a10945aa90caa361ca552a7f/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1a26dbff22adaa80f967db15960766794cafff0e", "url": "https://api.github.com/repos/rust-lang/rust/commits/1a26dbff22adaa80f967db15960766794cafff0e", "html_url": "https://github.com/rust-lang/rust/commit/1a26dbff22adaa80f967db15960766794cafff0e"}, {"sha": "11efd75aeb8637bd5444104a57f1051b86c0d62b", "url": "https://api.github.com/repos/rust-lang/rust/commits/11efd75aeb8637bd5444104a57f1051b86c0d62b", "html_url": "https://github.com/rust-lang/rust/commit/11efd75aeb8637bd5444104a57f1051b86c0d62b"}], "stats": {"total": 21, "additions": 19, "deletions": 2}, "files": [{"sha": "22942d9fb0c97bac1bdf5cdd13b6a8653d1628a2", "filename": "clippy_lints/src/methods/mod.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/aa3b04ff747db336a10945aa90caa361ca552a7f/clippy_lints%2Fsrc%2Fmethods%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa3b04ff747db336a10945aa90caa361ca552a7f/clippy_lints%2Fsrc%2Fmethods%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmethods%2Fmod.rs?ref=aa3b04ff747db336a10945aa90caa361ca552a7f", "patch": "@@ -3421,7 +3421,12 @@ fn lint_option_as_ref_deref<'tcx>(\n     ];\n \n     let is_deref = match map_args[1].kind {\n-        hir::ExprKind::Path(ref expr_qpath) => deref_aliases.iter().any(|path| match_qpath(expr_qpath, path)),\n+        hir::ExprKind::Path(ref expr_qpath) => cx\n+            .qpath_res(expr_qpath, map_args[1].hir_id)\n+            .opt_def_id()\n+            .map_or(false, |fun_def_id| {\n+                deref_aliases.iter().any(|path| match_def_path(cx, fun_def_id, path))\n+            }),\n         hir::ExprKind::Closure(_, _, body_id, _, _) => {\n             let closure_body = cx.tcx.hir().body(body_id);\n             let closure_expr = remove_blocks(&closure_body.value);"}, {"sha": "07d7f0b45b0c2f2171cd29c29a4360deb7cff1ed", "filename": "tests/ui/option_as_ref_deref.fixed", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/aa3b04ff747db336a10945aa90caa361ca552a7f/tests%2Fui%2Foption_as_ref_deref.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/aa3b04ff747db336a10945aa90caa361ca552a7f/tests%2Fui%2Foption_as_ref_deref.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Foption_as_ref_deref.fixed?ref=aa3b04ff747db336a10945aa90caa361ca552a7f", "patch": "@@ -38,4 +38,7 @@ fn main() {\n \n     let _ = opt.as_deref();\n     let _ = opt.as_deref_mut();\n+\n+    // Issue #5927\n+    let _ = opt.as_deref();\n }"}, {"sha": "6ae059c9425d35480c7afcc00ab7e6b63b0db3cf", "filename": "tests/ui/option_as_ref_deref.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/aa3b04ff747db336a10945aa90caa361ca552a7f/tests%2Fui%2Foption_as_ref_deref.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa3b04ff747db336a10945aa90caa361ca552a7f/tests%2Fui%2Foption_as_ref_deref.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Foption_as_ref_deref.rs?ref=aa3b04ff747db336a10945aa90caa361ca552a7f", "patch": "@@ -41,4 +41,7 @@ fn main() {\n \n     let _ = opt.as_ref().map(|x| &**x);\n     let _ = opt.as_mut().map(|x| &mut **x);\n+\n+    // Issue #5927\n+    let _ = opt.as_ref().map(std::ops::Deref::deref);\n }"}, {"sha": "62f28232475282a1a51ade866365560ec6031386", "filename": "tests/ui/option_as_ref_deref.stderr", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/aa3b04ff747db336a10945aa90caa361ca552a7f/tests%2Fui%2Foption_as_ref_deref.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/aa3b04ff747db336a10945aa90caa361ca552a7f/tests%2Fui%2Foption_as_ref_deref.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Foption_as_ref_deref.stderr?ref=aa3b04ff747db336a10945aa90caa361ca552a7f", "patch": "@@ -100,5 +100,11 @@ error: called `.as_mut().map(|x| &mut **x)` on an Option value. This can be done\n LL |     let _ = opt.as_mut().map(|x| &mut **x);\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: try using as_deref_mut instead: `opt.as_deref_mut()`\n \n-error: aborting due to 16 previous errors\n+error: called `.as_ref().map(std::ops::Deref::deref)` on an Option value. This can be done more directly by calling `opt.as_deref()` instead\n+  --> $DIR/option_as_ref_deref.rs:46:13\n+   |\n+LL |     let _ = opt.as_ref().map(std::ops::Deref::deref);\n+   |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: try using as_deref instead: `opt.as_deref()`\n+\n+error: aborting due to 17 previous errors\n "}]}