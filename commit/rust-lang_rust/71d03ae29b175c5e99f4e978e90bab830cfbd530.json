{"sha": "71d03ae29b175c5e99f4e978e90bab830cfbd530", "node_id": "MDY6Q29tbWl0NzI0NzEyOjcxZDAzYWUyOWIxNzVjNWU5OWY0ZTk3OGU5MGJhYjgzMGNmYmQ1MzA=", "commit": {"author": {"name": "Jeremy Fitzhardinge", "email": "jsgf@fb.com", "date": "2019-01-15T19:39:23Z"}, "committer": {"name": "Jeremy Fitzhardinge", "email": "jeremy@goop.org", "date": "2019-02-02T19:43:21Z"}, "message": "clippy-driver: if --sysroot is specified on the command line, use that\n\nIf the user explicitly sets sysroot on the command line, then use that\nvalue.\n\nIssue #3663", "tree": {"sha": "5d993485309664ff1e5be03a05ea725ca7d22c83", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5d993485309664ff1e5be03a05ea725ca7d22c83"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/71d03ae29b175c5e99f4e978e90bab830cfbd530", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/71d03ae29b175c5e99f4e978e90bab830cfbd530", "html_url": "https://github.com/rust-lang/rust/commit/71d03ae29b175c5e99f4e978e90bab830cfbd530", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/71d03ae29b175c5e99f4e978e90bab830cfbd530/comments", "author": {"login": "jsgf", "id": 147966, "node_id": "MDQ6VXNlcjE0Nzk2Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/147966?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jsgf", "html_url": "https://github.com/jsgf", "followers_url": "https://api.github.com/users/jsgf/followers", "following_url": "https://api.github.com/users/jsgf/following{/other_user}", "gists_url": "https://api.github.com/users/jsgf/gists{/gist_id}", "starred_url": "https://api.github.com/users/jsgf/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jsgf/subscriptions", "organizations_url": "https://api.github.com/users/jsgf/orgs", "repos_url": "https://api.github.com/users/jsgf/repos", "events_url": "https://api.github.com/users/jsgf/events{/privacy}", "received_events_url": "https://api.github.com/users/jsgf/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jsgf", "id": 147966, "node_id": "MDQ6VXNlcjE0Nzk2Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/147966?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jsgf", "html_url": "https://github.com/jsgf", "followers_url": "https://api.github.com/users/jsgf/followers", "following_url": "https://api.github.com/users/jsgf/following{/other_user}", "gists_url": "https://api.github.com/users/jsgf/gists{/gist_id}", "starred_url": "https://api.github.com/users/jsgf/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jsgf/subscriptions", "organizations_url": "https://api.github.com/users/jsgf/orgs", "repos_url": "https://api.github.com/users/jsgf/repos", "events_url": "https://api.github.com/users/jsgf/events{/privacy}", "received_events_url": "https://api.github.com/users/jsgf/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b5fd0108b3a6b8a9626645ac174cf653de576135", "url": "https://api.github.com/repos/rust-lang/rust/commits/b5fd0108b3a6b8a9626645ac174cf653de576135", "html_url": "https://github.com/rust-lang/rust/commit/b5fd0108b3a6b8a9626645ac174cf653de576135"}], "stats": {"total": 19, "additions": 15, "deletions": 4}, "files": [{"sha": "fbff693f8870964b226cf1f80852bf3c69c40acf", "filename": "src/driver.rs", "status": "modified", "additions": 15, "deletions": 4, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/71d03ae29b175c5e99f4e978e90bab830cfbd530/src%2Fdriver.rs", "raw_url": "https://github.com/rust-lang/rust/raw/71d03ae29b175c5e99f4e978e90bab830cfbd530/src%2Fdriver.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdriver.rs?ref=71d03ae29b175c5e99f4e978e90bab830cfbd530", "patch": "@@ -72,8 +72,19 @@ pub fn main() {\n                 exit(0);\n             }\n \n-            let sys_root = option_env!(\"SYSROOT\")\n-                .map(String::from)\n+            let mut orig_args: Vec<String> = env::args().collect();\n+\n+            // Get the sysroot, looking from most specific to this invocation to the least:\n+            // - command line\n+            // - runtime environment\n+            //    - SYSROOT\n+            //    - RUSTUP_HOME, MULTIRUST_HOME, RUSTUP_TOOLCHAIN, MULTIRUST_TOOLCHAIN\n+            // - sysroot from rustc in the path\n+            // - compile-time environment\n+            let sys_root_arg = arg_value(&orig_args, \"--sysroot\", |_| true);\n+            let have_sys_root_arg = sys_root_arg.is_some();\n+            let sys_root = sys_root_arg\n+                .map(|s| s.to_string())\n                 .or_else(|| std::env::var(\"SYSROOT\").ok())\n                 .or_else(|| {\n                     let home = option_env!(\"RUSTUP_HOME\").or(option_env!(\"MULTIRUST_HOME\"));\n@@ -89,11 +100,11 @@ pub fn main() {\n                         .and_then(|out| String::from_utf8(out.stdout).ok())\n                         .map(|s| s.trim().to_owned())\n                 })\n+                .or_else(|| option_env!(\"SYSROOT\").map(String::from))\n                 .expect(\"need to specify SYSROOT env var during clippy compilation, or use rustup or multirust\");\n \n             // Setting RUSTC_WRAPPER causes Cargo to pass 'rustc' as the first argument.\n             // We're invoking the compiler programmatically, so we ignore this/\n-            let mut orig_args: Vec<String> = env::args().collect();\n             if orig_args.len() <= 1 {\n                 std::process::exit(1);\n             }\n@@ -104,7 +115,7 @@ pub fn main() {\n             // this conditional check for the --sysroot flag is there so users can call\n             // `clippy_driver` directly\n             // without having to pass --sysroot or anything\n-            let mut args: Vec<String> = if orig_args.iter().any(|s| s == \"--sysroot\") {\n+            let mut args: Vec<String> = if have_sys_root_arg {\n                 orig_args.clone()\n             } else {\n                 orig_args"}]}