{"sha": "6824f119fcaef80e6ac377e887cbe6789e587f77", "node_id": "MDY6Q29tbWl0NzI0NzEyOjY4MjRmMTE5ZmNhZWY4MGU2YWMzNzdlODg3Y2JlNjc4OWU1ODdmNzc=", "commit": {"author": {"name": "Brian Anderson", "email": "andersrb@gmail.com", "date": "2011-05-13T18:42:23Z"}, "committer": {"name": "Brian Anderson", "email": "andersrb@gmail.com", "date": "2011-05-21T17:22:01Z"}, "message": "rustc: Allow alt expressions to fail", "tree": {"sha": "ba5fbb5d7a5a659acb98a95c6d2c7ff4324cc753", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ba5fbb5d7a5a659acb98a95c6d2c7ff4324cc753"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6824f119fcaef80e6ac377e887cbe6789e587f77", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6824f119fcaef80e6ac377e887cbe6789e587f77", "html_url": "https://github.com/rust-lang/rust/commit/6824f119fcaef80e6ac377e887cbe6789e587f77", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6824f119fcaef80e6ac377e887cbe6789e587f77/comments", "author": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "committer": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "418b4c456703501b18f6774e7708186ae9c1e2c2", "url": "https://api.github.com/repos/rust-lang/rust/commits/418b4c456703501b18f6774e7708186ae9c1e2c2", "html_url": "https://github.com/rust-lang/rust/commit/418b4c456703501b18f6774e7708186ae9c1e2c2"}], "stats": {"total": 55, "additions": 52, "deletions": 3}, "files": [{"sha": "aedbb89f2a8a6608bbac964d0a60a76ef2a3a8d7", "filename": "src/comp/middle/typeck.rs", "status": "modified", "additions": 9, "deletions": 3, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/6824f119fcaef80e6ac377e887cbe6789e587f77/src%2Fcomp%2Fmiddle%2Ftypeck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6824f119fcaef80e6ac377e887cbe6789e587f77/src%2Fcomp%2Fmiddle%2Ftypeck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcomp%2Fmiddle%2Ftypeck.rs?ref=6824f119fcaef80e6ac377e887cbe6789e587f77", "patch": "@@ -1457,7 +1457,10 @@ mod Pushdown {\n                 for (ast::arm arm_0 in arms_0) {\n                     pushdown_block(scx, expected, arm_0.block);\n                     auto bty = block_ty(scx.fcx.ccx.tcx, arm_0.block);\n-                    t = Demand::simple(scx, e.span, t, bty);\n+                    // Failing alt arms don't need to have a matching type\n+                    if (!ty::type_is_bot(scx.fcx.ccx.tcx, bty)) {\n+                        t = Demand::simple(scx, e.span, t, bty);\n+                    }\n                 }\n                 write::ty_only_fixup(scx, ann.id, t);\n             }\n@@ -2209,8 +2212,11 @@ fn check_expr(&@stmt_ctxt scx, &@ast::expr expr) {\n                 check_block(scx, arm.block);\n \n                 auto bty = block_ty(scx.fcx.ccx.tcx, arm.block);\n-                result_ty = Demand::simple(scx, arm.block.span, result_ty,\n-                                           bty);\n+                // Failing alt arms don't need to have a matching type\n+                if (!ty::type_is_bot(scx.fcx.ccx.tcx, bty)) {\n+                    result_ty = Demand::simple(scx, arm.block.span,\n+                                               result_ty, bty);\n+                }\n             }\n \n             auto i = 0u;"}, {"sha": "33d09cce8c0f2dbf551bbb4a5cba3369b95b1b5d", "filename": "src/test/run-fail/expr-alt-fail.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/6824f119fcaef80e6ac377e887cbe6789e587f77/src%2Ftest%2Frun-fail%2Fexpr-alt-fail.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6824f119fcaef80e6ac377e887cbe6789e587f77/src%2Ftest%2Frun-fail%2Fexpr-alt-fail.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-fail%2Fexpr-alt-fail.rs?ref=6824f119fcaef80e6ac377e887cbe6789e587f77", "patch": "@@ -0,0 +1,13 @@\n+// xfail-stage0\n+// error-pattern:explicit failure\n+\n+fn main() {\n+  auto x = alt(true) {\n+    case (false) {\n+      0\n+    }\n+    case (true) {\n+      fail\n+    }\n+  };\n+}"}, {"sha": "373e0f02b3699c344e33118134963ebd81baffa3", "filename": "src/test/run-pass/expr-alt-fail.rs", "status": "added", "additions": 30, "deletions": 0, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/6824f119fcaef80e6ac377e887cbe6789e587f77/src%2Ftest%2Frun-pass%2Fexpr-alt-fail.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6824f119fcaef80e6ac377e887cbe6789e587f77/src%2Ftest%2Frun-pass%2Fexpr-alt-fail.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fexpr-alt-fail.rs?ref=6824f119fcaef80e6ac377e887cbe6789e587f77", "patch": "@@ -0,0 +1,30 @@\n+// xfail-stage0\n+\n+fn test_simple() {\n+  auto r = alt (true) {\n+    case (true) {\n+      true\n+    }\n+    case (false) {\n+      fail\n+    }\n+  };\n+  assert (r == true);\n+}\n+\n+fn test_box() {\n+  auto r = alt (true) {\n+    case (true) {\n+      [10]\n+    }\n+    case (false) {\n+      fail\n+    }\n+  };\n+  assert (r.(0) == 10);\n+}\n+\n+fn main() {\n+  test_simple();\n+  test_box();\n+}"}]}