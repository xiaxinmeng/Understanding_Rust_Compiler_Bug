{"sha": "631b4ee7a26e4e68469a607376005eb4064b3e6f", "node_id": "C_kwDOAAsO6NoAKDYzMWI0ZWU3YTI2ZTRlNjg0NjlhNjA3Mzc2MDA1ZWI0MDY0YjNlNmY", "commit": {"author": {"name": "Evan Typanski", "email": "evantypanski@gmail.com", "date": "2022-05-10T18:21:51Z"}, "committer": {"name": "Evan Typanski", "email": "evantypanski@gmail.com", "date": "2022-05-10T18:21:51Z"}, "message": "Fix redundant_allocation warning for Rc<Box<str>>", "tree": {"sha": "3da99b08532a5e1ef3a67f096057a36f7b0629ef", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3da99b08532a5e1ef3a67f096057a36f7b0629ef"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/631b4ee7a26e4e68469a607376005eb4064b3e6f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/631b4ee7a26e4e68469a607376005eb4064b3e6f", "html_url": "https://github.com/rust-lang/rust/commit/631b4ee7a26e4e68469a607376005eb4064b3e6f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/631b4ee7a26e4e68469a607376005eb4064b3e6f/comments", "author": {"login": "evantypanski", "id": 22875724, "node_id": "MDQ6VXNlcjIyODc1NzI0", "avatar_url": "https://avatars.githubusercontent.com/u/22875724?v=4", "gravatar_id": "", "url": "https://api.github.com/users/evantypanski", "html_url": "https://github.com/evantypanski", "followers_url": "https://api.github.com/users/evantypanski/followers", "following_url": "https://api.github.com/users/evantypanski/following{/other_user}", "gists_url": "https://api.github.com/users/evantypanski/gists{/gist_id}", "starred_url": "https://api.github.com/users/evantypanski/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/evantypanski/subscriptions", "organizations_url": "https://api.github.com/users/evantypanski/orgs", "repos_url": "https://api.github.com/users/evantypanski/repos", "events_url": "https://api.github.com/users/evantypanski/events{/privacy}", "received_events_url": "https://api.github.com/users/evantypanski/received_events", "type": "User", "site_admin": false}, "committer": {"login": "evantypanski", "id": 22875724, "node_id": "MDQ6VXNlcjIyODc1NzI0", "avatar_url": "https://avatars.githubusercontent.com/u/22875724?v=4", "gravatar_id": "", "url": "https://api.github.com/users/evantypanski", "html_url": "https://github.com/evantypanski", "followers_url": "https://api.github.com/users/evantypanski/followers", "following_url": "https://api.github.com/users/evantypanski/following{/other_user}", "gists_url": "https://api.github.com/users/evantypanski/gists{/gist_id}", "starred_url": "https://api.github.com/users/evantypanski/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/evantypanski/subscriptions", "organizations_url": "https://api.github.com/users/evantypanski/orgs", "repos_url": "https://api.github.com/users/evantypanski/repos", "events_url": "https://api.github.com/users/evantypanski/events{/privacy}", "received_events_url": "https://api.github.com/users/evantypanski/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d422baa30c415e6aed786f1953b0ac1b7d840dc1", "url": "https://api.github.com/repos/rust-lang/rust/commits/d422baa30c415e6aed786f1953b0ac1b7d840dc1", "html_url": "https://github.com/rust-lang/rust/commit/d422baa30c415e6aed786f1953b0ac1b7d840dc1"}], "stats": {"total": 51, "additions": 47, "deletions": 4}, "files": [{"sha": "5fdf17314953d279e39aab855bac73f2610a99a5", "filename": "clippy_lints/src/types/redundant_allocation.rs", "status": "modified", "additions": 19, "deletions": 3, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/631b4ee7a26e4e68469a607376005eb4064b3e6f/clippy_lints%2Fsrc%2Ftypes%2Fredundant_allocation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/631b4ee7a26e4e68469a607376005eb4064b3e6f/clippy_lints%2Fsrc%2Ftypes%2Fredundant_allocation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Ftypes%2Fredundant_allocation.rs?ref=631b4ee7a26e4e68469a607376005eb4064b3e6f", "patch": "@@ -2,7 +2,7 @@ use clippy_utils::diagnostics::span_lint_and_then;\n use clippy_utils::source::{snippet, snippet_with_applicability};\n use clippy_utils::{path_def_id, qpath_generic_tys};\n use rustc_errors::Applicability;\n-use rustc_hir::{self as hir, def_id::DefId, QPath, TyKind};\n+use rustc_hir::{self as hir, def, def_id::DefId, PrimTy, QPath, TyKind};\n use rustc_lint::LateContext;\n use rustc_span::symbol::sym;\n \n@@ -54,8 +54,7 @@ pub(super) fn check(cx: &LateContext<'_>, hir_ty: &hir::Ty<'_>, qpath: &QPath<'_\n     };\n     let inner_span = match qpath_generic_tys(inner_qpath).next() {\n         Some(ty) => {\n-            // Box<Box<dyn T>> is smaller than Box<dyn T> because of wide pointers\n-            if matches!(ty.kind, TyKind::TraitObject(..)) {\n+            if alloc_makes_pointer_thin(cx, ty) {\n                 return false;\n             }\n             ty.span\n@@ -110,3 +109,20 @@ pub(super) fn check(cx: &LateContext<'_>, hir_ty: &hir::Ty<'_>, qpath: &QPath<'_\n     }\n     true\n }\n+\n+/// Returns `true` if the allocation would make `hir_ty` go from fat to thin.\n+fn alloc_makes_pointer_thin(cx: &LateContext<'_>, hir_ty: &hir::Ty<'_>) -> bool {\n+    match &hir_ty.kind {\n+        TyKind::TraitObject(..) => true,\n+        TyKind::Path(ty_qpath) => {\n+            let ty_res = cx.qpath_res(ty_qpath, hir_ty.hir_id);\n+            if let def::Res::PrimTy(prim_ty) = ty_res {\n+                if matches!(prim_ty, PrimTy::Str) {\n+                    return true;\n+                }\n+            }\n+            false\n+        },\n+        _ => false,\n+    }\n+}"}, {"sha": "b830a3771d5c14843053c4825f183370a341abd8", "filename": "tests/ui/redundant_allocation.rs", "status": "modified", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/631b4ee7a26e4e68469a607376005eb4064b3e6f/tests%2Fui%2Fredundant_allocation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/631b4ee7a26e4e68469a607376005eb4064b3e6f/tests%2Fui%2Fredundant_allocation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fredundant_allocation.rs?ref=631b4ee7a26e4e68469a607376005eb4064b3e6f", "patch": "@@ -97,4 +97,22 @@ mod box_dyn {\n     pub fn test_rc_box(_: Rc<Box<Box<dyn T>>>) {}\n }\n \n+// https://github.com/rust-lang/rust-clippy/issues/8604\n+mod box_str {\n+    use std::boxed::Box;\n+    use std::rc::Rc;\n+    use std::sync::Arc;\n+\n+    struct S {\n+        a: Box<Box<str>>,\n+        b: Rc<Box<str>>,\n+        c: Arc<Box<str>>,\n+    }\n+\n+    pub fn test_box(_: Box<Box<str>>) {}\n+    pub fn test_rc(_: Rc<Box<str>>) {}\n+    pub fn test_arc(_: Arc<Box<str>>) {}\n+    pub fn test_rc_box(_: Rc<Box<Box<str>>>) {}\n+}\n+\n fn main() {}"}, {"sha": "ae213cb8975ae7496965d0a00f21da4566db48dd", "filename": "tests/ui/redundant_allocation.stderr", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/631b4ee7a26e4e68469a607376005eb4064b3e6f/tests%2Fui%2Fredundant_allocation.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/631b4ee7a26e4e68469a607376005eb4064b3e6f/tests%2Fui%2Fredundant_allocation.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fredundant_allocation.stderr?ref=631b4ee7a26e4e68469a607376005eb4064b3e6f", "patch": "@@ -143,5 +143,14 @@ LL |     pub fn test_rc_box(_: Rc<Box<Box<dyn T>>>) {}\n    = note: `Box<Box<dyn T>>` is already on the heap, `Rc<Box<Box<dyn T>>>` makes an extra allocation\n    = help: consider using just `Rc<Box<dyn T>>` or `Box<Box<dyn T>>`\n \n-error: aborting due to 16 previous errors\n+error: usage of `Rc<Box<Box<str>>>`\n+  --> $DIR/redundant_allocation.rs:115:27\n+   |\n+LL |     pub fn test_rc_box(_: Rc<Box<Box<str>>>) {}\n+   |                           ^^^^^^^^^^^^^^^^^\n+   |\n+   = note: `Box<Box<str>>` is already on the heap, `Rc<Box<Box<str>>>` makes an extra allocation\n+   = help: consider using just `Rc<Box<str>>` or `Box<Box<str>>`\n+\n+error: aborting due to 17 previous errors\n "}]}