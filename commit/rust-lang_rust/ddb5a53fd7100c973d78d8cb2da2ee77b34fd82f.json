{"sha": "ddb5a53fd7100c973d78d8cb2da2ee77b34fd82f", "node_id": "C_kwDOAAsO6NoAKGRkYjVhNTNmZDcxMDBjOTczZDc4ZDhjYjJkYTJlZTc3YjM0ZmQ4MmY", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2022-02-26T12:54:57Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-02-26T12:54:57Z"}, "message": "Merge #11562\n\n11562: fix: Don't emit unresolvedReference highlight tags in unlinked files r=Veykril a=Veykril\n\nEmitting these overwrites any syntax based highlighting that is being done in the file, causing a lot of noise if the user gave them a specific color.\r\nbors r+\n\nCo-authored-by: Lukas Wirth <lukastw97@gmail.com>", "tree": {"sha": "06c646174acfcad3fbae88c3482749d93c201a4a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/06c646174acfcad3fbae88c3482749d93c201a4a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ddb5a53fd7100c973d78d8cb2da2ee77b34fd82f", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJiGiMhCRBK7hj4Ov3rIwAAKmoIAF76rPMdzkTsnIb0QrygtfXV\n66SL4iKqrGMxks7b9bkE/FcVHxKWYneeufCuKF5Ft/+bfI4Nioxs5J39/D/g1US9\nh6rfIv0tcV5Qb37IIJI0TzQ+gs8T8afTk3m0LQLF6sLFZpEAxhwECSUN0rlgeSKF\nhV53Qc4ip1jDSzH0CU+pfQRXYIzfVuG/9QFrkMuMIxElAG007fXIiQuNAh/hD2hA\nJKMlC5iSNTnhNG/G70T5As+3VeXfdF1DUSBPv0hVAIxaoaLvMOYna/Pg4nGAciFs\n1xTqe5d4PzDkx4+LaglTIA0s4effRLaWXkSKLC+rLxulV5d0s3vVBDPkTOZJUmI=\n=s7UF\n-----END PGP SIGNATURE-----\n", "payload": "tree 06c646174acfcad3fbae88c3482749d93c201a4a\nparent a2cc1d6b7b499d6b03436db7fc8053aea72f75ac\nparent 03d33556c9f248ea6a1d8473b98cfa4c1e96343b\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1645880097 +0000\ncommitter GitHub <noreply@github.com> 1645880097 +0000\n\nMerge #11562\n\n11562: fix: Don't emit unresolvedReference highlight tags in unlinked files r=Veykril a=Veykril\n\nEmitting these overwrites any syntax based highlighting that is being done in the file, causing a lot of noise if the user gave them a specific color.\r\nbors r+\n\nCo-authored-by: Lukas Wirth <lukastw97@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ddb5a53fd7100c973d78d8cb2da2ee77b34fd82f", "html_url": "https://github.com/rust-lang/rust/commit/ddb5a53fd7100c973d78d8cb2da2ee77b34fd82f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ddb5a53fd7100c973d78d8cb2da2ee77b34fd82f/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a2cc1d6b7b499d6b03436db7fc8053aea72f75ac", "url": "https://api.github.com/repos/rust-lang/rust/commits/a2cc1d6b7b499d6b03436db7fc8053aea72f75ac", "html_url": "https://github.com/rust-lang/rust/commit/a2cc1d6b7b499d6b03436db7fc8053aea72f75ac"}, {"sha": "03d33556c9f248ea6a1d8473b98cfa4c1e96343b", "url": "https://api.github.com/repos/rust-lang/rust/commits/03d33556c9f248ea6a1d8473b98cfa4c1e96343b", "html_url": "https://github.com/rust-lang/rust/commit/03d33556c9f248ea6a1d8473b98cfa4c1e96343b"}], "stats": {"total": 16, "additions": 12, "deletions": 4}, "files": [{"sha": "1b2fc9c635d30ef2e3dc74d35bb2831aff74809b", "filename": "crates/ide/src/syntax_highlighting.rs", "status": "modified", "additions": 12, "deletions": 4, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/ddb5a53fd7100c973d78d8cb2da2ee77b34fd82f/crates%2Fide%2Fsrc%2Fsyntax_highlighting.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ddb5a53fd7100c973d78d8cb2da2ee77b34fd82f/crates%2Fide%2Fsrc%2Fsyntax_highlighting.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fsyntax_highlighting.rs?ref=ddb5a53fd7100c973d78d8cb2da2ee77b34fd82f", "patch": "@@ -183,7 +183,8 @@ pub(crate) fn highlight(\n     traverse(\n         &mut hl,\n         &sema,\n-        InFile::new(file_id.into(), &root),\n+        file_id,\n+        &root,\n         sema.scope(&root).krate(),\n         range_to_highlight,\n         syntactic_name_ref_highlighting,\n@@ -194,11 +195,13 @@ pub(crate) fn highlight(\n fn traverse(\n     hl: &mut Highlights,\n     sema: &Semantics<RootDatabase>,\n-    root: InFile<&SyntaxNode>,\n+    file_id: FileId,\n+    root: &SyntaxNode,\n     krate: Option<hir::Crate>,\n     range_to_highlight: TextRange,\n     syntactic_name_ref_highlighting: bool,\n ) {\n+    let is_unlinked = sema.to_module_def(file_id).is_none();\n     let mut bindings_shadow_count: FxHashMap<Name, u32> = FxHashMap::default();\n \n     let mut current_macro_call: Option<ast::MacroCall> = None;\n@@ -209,7 +212,7 @@ fn traverse(\n \n     // Walk all nodes, keeping track of whether we are inside a macro or not.\n     // If in macro, expand it first and highlight the expanded code.\n-    for event in root.value.preorder_with_tokens() {\n+    for event in root.preorder_with_tokens() {\n         let range = match &event {\n             WalkEvent::Enter(it) | WalkEvent::Leave(it) => it.text_range(),\n         };\n@@ -283,7 +286,7 @@ fn traverse(\n             WalkEvent::Enter(it) => it,\n             WalkEvent::Leave(NodeOrToken::Token(_)) => continue,\n             WalkEvent::Leave(NodeOrToken::Node(node)) => {\n-                inject::doc_comment(hl, sema, root.with_value(&node));\n+                inject::doc_comment(hl, sema, InFile::new(file_id.into(), &node));\n                 continue;\n             }\n         };\n@@ -378,6 +381,11 @@ fn traverse(\n             NodeOrToken::Token(token) => highlight::token(sema, token).zip(Some(None)),\n         };\n         if let Some((mut highlight, binding_hash)) = element {\n+            if is_unlinked && highlight.tag == HlTag::UnresolvedReference {\n+                // do not emit unresolved references if the file is unlinked\n+                // let the editor do its highlighting for these tokens instead\n+                continue;\n+            }\n             if inside_attribute {\n                 highlight |= HlMod::Attribute\n             }"}]}