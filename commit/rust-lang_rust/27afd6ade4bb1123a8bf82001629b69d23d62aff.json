{"sha": "27afd6ade4bb1123a8bf82001629b69d23d62aff", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI3YWZkNmFkZTRiYjExMjNhOGJmODIwMDE2MjliNjlkMjNkNjJhZmY=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-09-08T13:30:11Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-09-08T13:30:11Z"}, "message": "Auto merge of #7631 - camsteffen:depinfo, r=flip1995\n\nUse binary-dep-depinfo to resolve UI test dependencies\n\nCloses #7343\nCloses #6809\nCloses #3643\n\nchangelog: none\n\nr? `@flip1995`\ncc `@Jarcho`", "tree": {"sha": "bdc55a6118485eb026aa107a565cb6747d2a1150", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bdc55a6118485eb026aa107a565cb6747d2a1150"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/27afd6ade4bb1123a8bf82001629b69d23d62aff", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/27afd6ade4bb1123a8bf82001629b69d23d62aff", "html_url": "https://github.com/rust-lang/rust/commit/27afd6ade4bb1123a8bf82001629b69d23d62aff", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/27afd6ade4bb1123a8bf82001629b69d23d62aff/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5458358461ffd70c069fe1fee514c7e2abcbde4f", "url": "https://api.github.com/repos/rust-lang/rust/commits/5458358461ffd70c069fe1fee514c7e2abcbde4f", "html_url": "https://github.com/rust-lang/rust/commit/5458358461ffd70c069fe1fee514c7e2abcbde4f"}, {"sha": "5d3fc6fc08d604889e5c52ad8b38ea474fab9a6f", "url": "https://api.github.com/repos/rust-lang/rust/commits/5d3fc6fc08d604889e5c52ad8b38ea474fab9a6f", "html_url": "https://github.com/rust-lang/rust/commit/5d3fc6fc08d604889e5c52ad8b38ea474fab9a6f"}], "stats": {"total": 195, "additions": 111, "deletions": 84}, "files": [{"sha": "84ae36a46d71de51a394f27bc3fe2533c2ccec60", "filename": ".cargo/config", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/27afd6ade4bb1123a8bf82001629b69d23d62aff/.cargo%2Fconfig", "raw_url": "https://github.com/rust-lang/rust/raw/27afd6ade4bb1123a8bf82001629b69d23d62aff/.cargo%2Fconfig", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.cargo%2Fconfig?ref=27afd6ade4bb1123a8bf82001629b69d23d62aff", "patch": "@@ -5,4 +5,5 @@ lintcheck = \"run --target-dir lintcheck/target --package lintcheck --bin lintche\n collect-metadata = \"test --test dogfood --features metadata-collector-lint -- run_metadata_collection_lint --ignored\"\n \n [build]\n-rustflags = [\"-Zunstable-options\"]\n+# -Zbinary-dep-depinfo allows us to track which rlib files to use for compiling UI tests\n+rustflags = [\"-Zunstable-options\", \"-Zbinary-dep-depinfo\"]"}, {"sha": "2310370fb9fbe7eaed80f888f40633a2f8151fd3", "filename": "Cargo.toml", "status": "modified", "additions": 9, "deletions": 4, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/27afd6ade4bb1123a8bf82001629b69d23d62aff/Cargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/27afd6ade4bb1123a8bf82001629b69d23d62aff/Cargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.toml?ref=27afd6ade4bb1123a8bf82001629b69d23d62aff", "patch": "@@ -32,11 +32,7 @@ tempfile = { version = \"3.1.0\", optional = true }\n cargo_metadata = \"0.12\"\n compiletest_rs = { version = \"0.6.0\", features = [\"tmp\"] }\n tester = \"0.9\"\n-serde = { version = \"1.0\", features = [\"derive\"] }\n-derive-new = \"0.5\"\n regex = \"1.4\"\n-quote = \"1\"\n-syn = { version = \"1\", features = [\"full\"] }\n # This is used by the `collect-metadata` alias.\n filetime = \"0.2\"\n \n@@ -45,6 +41,15 @@ filetime = \"0.2\"\n # for more information.\n rustc-workspace-hack = \"1.0.0\"\n \n+# UI test dependencies\n+clippy_utils = { path = \"clippy_utils\" }\n+derive-new = \"0.5\"\n+if_chain = \"1.0\"\n+itertools = \"0.10.1\"\n+quote = \"1\"\n+serde = { version = \"1.0\", features = [\"derive\"] }\n+syn = { version = \"1\", features = [\"full\"] }\n+\n [build-dependencies]\n rustc_tools_util = { version = \"0.2.0\", path = \"rustc_tools_util\" }\n "}, {"sha": "4c038a997952aba3ff2fd6a14384e17d077badba", "filename": "clippy_utils/Cargo.toml", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/27afd6ade4bb1123a8bf82001629b69d23d62aff/clippy_utils%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/27afd6ade4bb1123a8bf82001629b69d23d62aff/clippy_utils%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_utils%2FCargo.toml?ref=27afd6ade4bb1123a8bf82001629b69d23d62aff", "patch": "@@ -6,10 +6,6 @@ publish = false\n \n [dependencies]\n if_chain = \"1.0.0\"\n-itertools = \"0.9\"\n-regex-syntax = \"0.6\"\n-serde = { version = \"1.0\", features = [\"derive\"] }\n-unicode-normalization = \"0.1\"\n rustc-semver=\"1.1.0\"\n \n [features]"}, {"sha": "c63c47690d52ad9e9027ecfa6058217e09eae70f", "filename": "tests/compile-test.rs", "status": "modified", "additions": 85, "deletions": 75, "changes": 160, "blob_url": "https://github.com/rust-lang/rust/blob/27afd6ade4bb1123a8bf82001629b69d23d62aff/tests%2Fcompile-test.rs", "raw_url": "https://github.com/rust-lang/rust/raw/27afd6ade4bb1123a8bf82001629b69d23d62aff/tests%2Fcompile-test.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-test.rs?ref=27afd6ade4bb1123a8bf82001629b69d23d62aff", "patch": "@@ -1,10 +1,12 @@\n #![feature(test)] // compiletest_rs requires this attribute\n #![feature(once_cell)]\n-#![feature(try_blocks)]\n+#![cfg_attr(feature = \"deny-warnings\", deny(warnings))]\n+#![warn(rust_2018_idioms, unused_lifetimes)]\n \n use compiletest_rs as compiletest;\n use compiletest_rs::common::Mode as TestMode;\n \n+use std::collections::HashMap;\n use std::env::{self, remove_var, set_var, var_os};\n use std::ffi::{OsStr, OsString};\n use std::fs;\n@@ -16,6 +18,34 @@ mod cargo;\n // whether to run internal tests or not\n const RUN_INTERNAL_TESTS: bool = cfg!(feature = \"internal-lints\");\n \n+/// All crates used in UI tests are listed here\n+static TEST_DEPENDENCIES: &[&str] = &[\n+    \"clippy_utils\",\n+    \"derive_new\",\n+    \"if_chain\",\n+    \"itertools\",\n+    \"quote\",\n+    \"regex\",\n+    \"serde\",\n+    \"serde_derive\",\n+    \"syn\",\n+];\n+\n+// Test dependencies may need an `extern crate` here to ensure that they show up\n+// in the depinfo file (otherwise cargo thinks they are unused)\n+#[allow(unused_extern_crates)]\n+extern crate clippy_utils;\n+#[allow(unused_extern_crates)]\n+extern crate derive_new;\n+#[allow(unused_extern_crates)]\n+extern crate if_chain;\n+#[allow(unused_extern_crates)]\n+extern crate itertools;\n+#[allow(unused_extern_crates)]\n+extern crate quote;\n+#[allow(unused_extern_crates)]\n+extern crate syn;\n+\n fn host_lib() -> PathBuf {\n     option_env!(\"HOST_LIBS\").map_or(cargo::CARGO_TARGET_DIR.join(env!(\"PROFILE\")), PathBuf::from)\n }\n@@ -24,72 +54,58 @@ fn clippy_driver_path() -> PathBuf {\n     option_env!(\"CLIPPY_DRIVER_PATH\").map_or(cargo::TARGET_LIB.join(\"clippy-driver\"), PathBuf::from)\n }\n \n-// When we'll want to use `extern crate ..` for a dependency that is used\n-// both by the crate and the compiler itself, we can't simply pass -L flags\n-// as we'll get a duplicate matching versions. Instead, disambiguate with\n-// `--extern dep=path`.\n-// See https://github.com/rust-lang/rust-clippy/issues/4015.\n-//\n-// FIXME: We cannot use `cargo build --message-format=json` to resolve to dependency files.\n-//        Because it would force-rebuild if the options passed to `build` command is not the same\n-//        as what we manually pass to `cargo` invocation\n-fn third_party_crates() -> String {\n-    use std::collections::HashMap;\n-    static CRATES: &[&str] = &[\n-        \"clippy_lints\",\n-        \"clippy_utils\",\n-        \"if_chain\",\n-        \"itertools\",\n-        \"quote\",\n-        \"regex\",\n-        \"serde\",\n-        \"serde_derive\",\n-        \"syn\",\n-    ];\n-    let dep_dir = cargo::TARGET_LIB.join(\"deps\");\n-    let mut crates: HashMap<&str, Vec<PathBuf>> = HashMap::with_capacity(CRATES.len());\n-    let mut flags = String::new();\n-    for entry in fs::read_dir(dep_dir).unwrap().flatten() {\n-        let path = entry.path();\n-        if let Some(name) = try {\n-            let name = path.file_name()?.to_str()?;\n-            let (name, _) = name.strip_suffix(\".rlib\")?.strip_prefix(\"lib\")?.split_once('-')?;\n-            CRATES.iter().copied().find(|&c| c == name)?\n-        } {\n-            flags += &format!(\" --extern {}={}\", name, path.display());\n-            crates.entry(name).or_default().push(path.clone());\n+/// Produces a string with an `--extern` flag for all UI test crate\n+/// dependencies.\n+///\n+/// The dependency files are located by parsing the depinfo file for this test\n+/// module. This assumes the `-Z binary-dep-depinfo` flag is enabled. All test\n+/// dependencies must be added to Cargo.toml at the project root. Test\n+/// dependencies that are not *directly* used by this test module require an\n+/// `extern crate` declaration.\n+fn extern_flags() -> String {\n+    let current_exe_depinfo = {\n+        let mut path = env::current_exe().unwrap();\n+        path.set_extension(\"d\");\n+        std::fs::read_to_string(path).unwrap()\n+    };\n+    let mut crates: HashMap<&str, &str> = HashMap::with_capacity(TEST_DEPENDENCIES.len());\n+    for line in current_exe_depinfo.lines() {\n+        // each dependency is expected to have a Makefile rule like `/path/to/crate-hash.rlib:`\n+        let parse_name_path = || {\n+            if line.starts_with(char::is_whitespace) {\n+                return None;\n+            }\n+            let path_str = line.strip_suffix(':')?;\n+            let path = Path::new(path_str);\n+            if !matches!(path.extension()?.to_str()?, \"rlib\" | \"so\" | \"dylib\" | \"dll\") {\n+                return None;\n+            }\n+            let (name, _hash) = path.file_stem()?.to_str()?.rsplit_once('-')?;\n+            // the \"lib\" prefix is not present for dll files\n+            let name = name.strip_prefix(\"lib\").unwrap_or(name);\n+            Some((name, path_str))\n+        };\n+        if let Some((name, path)) = parse_name_path() {\n+            if TEST_DEPENDENCIES.contains(&name) {\n+                // A dependency may be listed twice if it is available in sysroot,\n+                // and the sysroot dependencies are listed first. As of the writing,\n+                // this only seems to apply to if_chain.\n+                crates.insert(name, path);\n+            }\n         }\n     }\n-    crates.retain(|_, paths| paths.len() > 1);\n-    if !crates.is_empty() {\n-        let crate_names = crates.keys().map(|s| format!(\"`{}`\", s)).collect::<Vec<_>>().join(\", \");\n-        // add backslashes for an easy copy-paste `rm` command\n-        let paths = crates\n-            .into_values()\n-            .flatten()\n-            .map(|p| strip_current_dir(&p).display().to_string())\n-            .collect::<Vec<_>>()\n-            .join(\" \\\\\\n\");\n-        // Check which action should be done in order to remove compiled deps.\n-        // If pre-installed version of compiler is used, `cargo clean` will do.\n-        // Otherwise (for bootstrapped compiler), the dependencies directory\n-        // must be removed manually.\n-        let suggested_action = if std::env::var_os(\"RUSTC_BOOTSTRAP\").is_some() {\n-            \"removing the stageN-tools directory\"\n-        } else {\n-            \"running `cargo clean`\"\n-        };\n-\n-        panic!(\n-            \"\\n----------------------------------------------------------------------\\n\\\n-            ERROR: Found multiple rlibs for crates: {}\\n\\\n-            Try {} or remove the following files:\\n\\n{}\\n\\n\\\n-            For details on this error see https://github.com/rust-lang/rust-clippy/issues/7343\\n\\\n-            ----------------------------------------------------------------------\\n\",\n-            crate_names, suggested_action, paths\n-        );\n+    let not_found: Vec<&str> = TEST_DEPENDENCIES\n+        .iter()\n+        .copied()\n+        .filter(|n| !crates.contains_key(n))\n+        .collect();\n+    if !not_found.is_empty() {\n+        panic!(\"dependencies not found in depinfo: {:?}\", not_found);\n     }\n-    flags\n+    crates\n+        .into_iter()\n+        .map(|(name, path)| format!(\"--extern {}={} \", name, path))\n+        .collect()\n }\n \n fn default_config() -> compiletest::Config {\n@@ -105,11 +121,14 @@ fn default_config() -> compiletest::Config {\n         config.compile_lib_path = path;\n     }\n \n+    // Using `-L dependency={}` enforces that external dependencies are added with `--extern`.\n+    // This is valuable because a) it allows us to monitor what external dependencies are used\n+    // and b) it ensures that conflicting rlibs are resolved properly.\n     config.target_rustcflags = Some(format!(\n-        \"--emit=metadata -L {0} -L {1} -Dwarnings -Zui-testing {2}\",\n+        \"--emit=metadata -L dependency={} -L dependency={} -Dwarnings -Zui-testing {}\",\n         host_lib().join(\"deps\").display(),\n         cargo::TARGET_LIB.join(\"deps\").display(),\n-        third_party_crates(),\n+        extern_flags(),\n     ));\n \n     config.build_base = host_lib().join(\"test_build_base\");\n@@ -316,12 +335,3 @@ impl Drop for VarGuard {\n         }\n     }\n }\n-\n-fn strip_current_dir(path: &Path) -> &Path {\n-    if let Ok(curr) = env::current_dir() {\n-        if let Ok(stripped) = path.strip_prefix(curr) {\n-            return stripped;\n-        }\n-    }\n-    path\n-}"}, {"sha": "54f452172deb4a3f727e3a586fbd8f3266c45efe", "filename": "tests/dogfood.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/27afd6ade4bb1123a8bf82001629b69d23d62aff/tests%2Fdogfood.rs", "raw_url": "https://github.com/rust-lang/rust/raw/27afd6ade4bb1123a8bf82001629b69d23d62aff/tests%2Fdogfood.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fdogfood.rs?ref=27afd6ade4bb1123a8bf82001629b69d23d62aff", "patch": "@@ -6,6 +6,8 @@\n // Dogfood cannot run on Windows\n #![cfg(not(windows))]\n #![feature(once_cell)]\n+#![cfg_attr(feature = \"deny-warnings\", deny(warnings))]\n+#![warn(rust_2018_idioms, unused_lifetimes)]\n \n use std::lazy::SyncLazy;\n use std::path::PathBuf;"}, {"sha": "be42f1fbb2023b4bb5bd8d4e2937be64cafa6f80", "filename": "tests/fmt.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/27afd6ade4bb1123a8bf82001629b69d23d62aff/tests%2Ffmt.rs", "raw_url": "https://github.com/rust-lang/rust/raw/27afd6ade4bb1123a8bf82001629b69d23d62aff/tests%2Ffmt.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ffmt.rs?ref=27afd6ade4bb1123a8bf82001629b69d23d62aff", "patch": "@@ -1,3 +1,6 @@\n+#![cfg_attr(feature = \"deny-warnings\", deny(warnings))]\n+#![warn(rust_2018_idioms, unused_lifetimes)]\n+\n use std::path::PathBuf;\n use std::process::Command;\n "}, {"sha": "7e3eff3c7324fc3b4f31b1d4443b576e3cd41883", "filename": "tests/integration.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/27afd6ade4bb1123a8bf82001629b69d23d62aff/tests%2Fintegration.rs", "raw_url": "https://github.com/rust-lang/rust/raw/27afd6ade4bb1123a8bf82001629b69d23d62aff/tests%2Fintegration.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fintegration.rs?ref=27afd6ade4bb1123a8bf82001629b69d23d62aff", "patch": "@@ -1,4 +1,6 @@\n #![cfg(feature = \"integration\")]\n+#![cfg_attr(feature = \"deny-warnings\", deny(warnings))]\n+#![warn(rust_2018_idioms, unused_lifetimes)]\n \n use std::env;\n use std::ffi::OsStr;"}, {"sha": "b4d94dc983fec11fecc2efc20e8dbf006193ae07", "filename": "tests/lint_message_convention.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/27afd6ade4bb1123a8bf82001629b69d23d62aff/tests%2Flint_message_convention.rs", "raw_url": "https://github.com/rust-lang/rust/raw/27afd6ade4bb1123a8bf82001629b69d23d62aff/tests%2Flint_message_convention.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Flint_message_convention.rs?ref=27afd6ade4bb1123a8bf82001629b69d23d62aff", "patch": "@@ -1,3 +1,6 @@\n+#![cfg_attr(feature = \"deny-warnings\", deny(warnings))]\n+#![warn(rust_2018_idioms, unused_lifetimes)]\n+\n use std::ffi::OsStr;\n use std::path::PathBuf;\n "}, {"sha": "bd342e390f52f3d065bdef329f2c082ed3f322c7", "filename": "tests/missing-test-files.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/27afd6ade4bb1123a8bf82001629b69d23d62aff/tests%2Fmissing-test-files.rs", "raw_url": "https://github.com/rust-lang/rust/raw/27afd6ade4bb1123a8bf82001629b69d23d62aff/tests%2Fmissing-test-files.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmissing-test-files.rs?ref=27afd6ade4bb1123a8bf82001629b69d23d62aff", "patch": "@@ -1,3 +1,5 @@\n+#![cfg_attr(feature = \"deny-warnings\", deny(warnings))]\n+#![warn(rust_2018_idioms, unused_lifetimes)]\n #![allow(clippy::assertions_on_constants)]\n \n use std::fs::{self, DirEntry};"}, {"sha": "77102b8cac0c977e9621dc9bcc1bf1c6bcb5c11d", "filename": "tests/versioncheck.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/27afd6ade4bb1123a8bf82001629b69d23d62aff/tests%2Fversioncheck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/27afd6ade4bb1123a8bf82001629b69d23d62aff/tests%2Fversioncheck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fversioncheck.rs?ref=27afd6ade4bb1123a8bf82001629b69d23d62aff", "patch": "@@ -1,4 +1,7 @@\n+#![cfg_attr(feature = \"deny-warnings\", deny(warnings))]\n+#![warn(rust_2018_idioms, unused_lifetimes)]\n #![allow(clippy::single_match_else)]\n+\n use rustc_tools_util::VersionInfo;\n \n #[test]"}]}