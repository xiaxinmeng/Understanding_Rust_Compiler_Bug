{"sha": "b886a4de157873c6a3e536a517fd6b097a4ab11b", "node_id": "C_kwDOAAsO6NoAKGI4ODZhNGRlMTU3ODczYzZhM2U1MzZhNTE3ZmQ2YjA5N2E0YWIxMWI", "commit": {"author": {"name": "Deadbeef", "email": "ent3rm4n@gmail.com", "date": "2023-02-01T05:56:04Z"}, "committer": {"name": "Deadbeef", "email": "ent3rm4n@gmail.com", "date": "2023-02-03T14:43:13Z"}, "message": "Replace `ConstFnMutClosure` with const closures", "tree": {"sha": "8e344baede9d0de48cd0d12d2f99e543b0f8f0c3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8e344baede9d0de48cd0d12d2f99e543b0f8f0c3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b886a4de157873c6a3e536a517fd6b097a4ab11b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b886a4de157873c6a3e536a517fd6b097a4ab11b", "html_url": "https://github.com/rust-lang/rust/commit/b886a4de157873c6a3e536a517fd6b097a4ab11b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b886a4de157873c6a3e536a517fd6b097a4ab11b/comments", "author": {"login": "fee1-dead", "id": 43851243, "node_id": "MDQ6VXNlcjQzODUxMjQz", "avatar_url": "https://avatars.githubusercontent.com/u/43851243?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fee1-dead", "html_url": "https://github.com/fee1-dead", "followers_url": "https://api.github.com/users/fee1-dead/followers", "following_url": "https://api.github.com/users/fee1-dead/following{/other_user}", "gists_url": "https://api.github.com/users/fee1-dead/gists{/gist_id}", "starred_url": "https://api.github.com/users/fee1-dead/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fee1-dead/subscriptions", "organizations_url": "https://api.github.com/users/fee1-dead/orgs", "repos_url": "https://api.github.com/users/fee1-dead/repos", "events_url": "https://api.github.com/users/fee1-dead/events{/privacy}", "received_events_url": "https://api.github.com/users/fee1-dead/received_events", "type": "User", "site_admin": false}, "committer": {"login": "fee1-dead", "id": 43851243, "node_id": "MDQ6VXNlcjQzODUxMjQz", "avatar_url": "https://avatars.githubusercontent.com/u/43851243?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fee1-dead", "html_url": "https://github.com/fee1-dead", "followers_url": "https://api.github.com/users/fee1-dead/followers", "following_url": "https://api.github.com/users/fee1-dead/following{/other_user}", "gists_url": "https://api.github.com/users/fee1-dead/gists{/gist_id}", "starred_url": "https://api.github.com/users/fee1-dead/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fee1-dead/subscriptions", "organizations_url": "https://api.github.com/users/fee1-dead/orgs", "repos_url": "https://api.github.com/users/fee1-dead/repos", "events_url": "https://api.github.com/users/fee1-dead/events{/privacy}", "received_events_url": "https://api.github.com/users/fee1-dead/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "679dde7338281f958094b409202cc23ce1ba640c", "url": "https://api.github.com/repos/rust-lang/rust/commits/679dde7338281f958094b409202cc23ce1ba640c", "html_url": "https://github.com/rust-lang/rust/commit/679dde7338281f958094b409202cc23ce1ba640c"}], "stats": {"total": 141, "additions": 21, "deletions": 120}, "files": [{"sha": "f290e5baf9dd3c21ccdd9c4f979daea388d8e459", "filename": "library/core/src/cmp.rs", "status": "modified", "additions": 1, "deletions": 12, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/b886a4de157873c6a3e536a517fd6b097a4ab11b/library%2Fcore%2Fsrc%2Fcmp.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b886a4de157873c6a3e536a517fd6b097a4ab11b/library%2Fcore%2Fsrc%2Fcmp.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fcmp.rs?ref=b886a4de157873c6a3e536a517fd6b097a4ab11b", "patch": "@@ -22,7 +22,6 @@\n \n #![stable(feature = \"rust1\", since = \"1.0.0\")]\n \n-use crate::const_closure::ConstFnMutClosure;\n use crate::marker::Destruct;\n \n use self::Ordering::*;\n@@ -1291,17 +1290,7 @@ where\n     F: ~const Destruct,\n     K: ~const Destruct,\n {\n-    const fn imp<T, F: ~const FnMut(&T) -> K, K: ~const Ord>(\n-        f: &mut F,\n-        (v1, v2): (&T, &T),\n-    ) -> Ordering\n-    where\n-        T: ~const Destruct,\n-        K: ~const Destruct,\n-    {\n-        f(v1).cmp(&f(v2))\n-    }\n-    max_by(v1, v2, ConstFnMutClosure::new(&mut f, imp))\n+    max_by(v1, v2, const |v1, v2| f(v1).cmp(&f(v2)))\n }\n \n // Implementation of PartialEq, Eq, PartialOrd and Ord for primitive types"}, {"sha": "97900a4862f5653fc49c537fdc95c3690d71d9a0", "filename": "library/core/src/const_closure.rs", "status": "removed", "additions": 0, "deletions": 78, "changes": 78, "blob_url": "https://github.com/rust-lang/rust/blob/679dde7338281f958094b409202cc23ce1ba640c/library%2Fcore%2Fsrc%2Fconst_closure.rs", "raw_url": "https://github.com/rust-lang/rust/raw/679dde7338281f958094b409202cc23ce1ba640c/library%2Fcore%2Fsrc%2Fconst_closure.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fconst_closure.rs?ref=679dde7338281f958094b409202cc23ce1ba640c", "patch": "@@ -1,78 +0,0 @@\n-use crate::marker::Destruct;\n-use crate::marker::Tuple;\n-\n-/// Struct representing a closure with mutably borrowed data.\n-///\n-/// Example:\n-/// ```no_build\n-/// #![feature(const_mut_refs)]\n-/// use crate::const_closure::ConstFnMutClosure;\n-/// const fn imp(state: &mut i32, (arg,): (i32,)) -> i32 {\n-///   *state += arg;\n-///   *state\n-/// }\n-/// let mut i = 5;\n-/// let mut cl = ConstFnMutClosure::new(&mut i, imp);\n-///\n-/// assert!(7 == cl(2));\n-/// assert!(8 == cl(1));\n-/// ```\n-pub(crate) struct ConstFnMutClosure<CapturedData, Function> {\n-    /// The Data captured by the Closure.\n-    /// Must be either a (mutable) reference or a tuple of (mutable) references.\n-    pub data: CapturedData,\n-    /// The Function of the Closure, must be: Fn(CapturedData, ClosureArgs) -> ClosureReturn\n-    pub func: Function,\n-}\n-impl<'a, CapturedData: ?Sized, Function> ConstFnMutClosure<&'a mut CapturedData, Function> {\n-    /// Function for creating a new closure.\n-    ///\n-    /// `data` is the a mutable borrow of data that is captured from the environment.\n-    /// If you want Data to be a tuple of mutable Borrows, the struct must be constructed manually.\n-    ///\n-    /// `func` is the function of the closure, it gets the data and a tuple of the arguments closure\n-    ///   and return the return value of the closure.\n-    pub(crate) const fn new<ClosureArguments, ClosureReturnValue>(\n-        data: &'a mut CapturedData,\n-        func: Function,\n-    ) -> Self\n-    where\n-        Function: ~const Fn(&mut CapturedData, ClosureArguments) -> ClosureReturnValue,\n-    {\n-        Self { data, func }\n-    }\n-}\n-\n-macro_rules! impl_fn_mut_tuple {\n-    ($($var:ident)*) => {\n-        #[allow(unused_parens)]\n-        impl<'a, $($var,)* ClosureArguments: Tuple, Function, ClosureReturnValue> const\n-            FnOnce<ClosureArguments> for ConstFnMutClosure<($(&'a mut $var),*), Function>\n-        where\n-            Function: ~const Fn(($(&mut $var),*), ClosureArguments) -> ClosureReturnValue+ ~const Destruct,\n-        {\n-            type Output = ClosureReturnValue;\n-\n-            extern \"rust-call\" fn call_once(mut self, args: ClosureArguments) -> Self::Output {\n-            self.call_mut(args)\n-            }\n-        }\n-        #[allow(unused_parens)]\n-        impl<'a, $($var,)* ClosureArguments: Tuple, Function, ClosureReturnValue> const\n-            FnMut<ClosureArguments> for ConstFnMutClosure<($(&'a mut $var),*), Function>\n-        where\n-            Function: ~const Fn(($(&mut $var),*), ClosureArguments)-> ClosureReturnValue,\n-        {\n-            extern \"rust-call\" fn call_mut(&mut self, args: ClosureArguments) -> Self::Output {\n-                #[allow(non_snake_case)]\n-                let ($($var),*) = &mut self.data;\n-                (self.func)(($($var),*), args)\n-            }\n-        }\n-    };\n-}\n-impl_fn_mut_tuple!(A);\n-impl_fn_mut_tuple!(A B);\n-impl_fn_mut_tuple!(A B C);\n-impl_fn_mut_tuple!(A B C D);\n-impl_fn_mut_tuple!(A B C D E);"}, {"sha": "af786609757b1325d85c166a3a382929bba74634", "filename": "library/core/src/iter/adapters/array_chunks.rs", "status": "modified", "additions": 2, "deletions": 4, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/b886a4de157873c6a3e536a517fd6b097a4ab11b/library%2Fcore%2Fsrc%2Fiter%2Fadapters%2Farray_chunks.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b886a4de157873c6a3e536a517fd6b097a4ab11b/library%2Fcore%2Fsrc%2Fiter%2Fadapters%2Farray_chunks.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fiter%2Fadapters%2Farray_chunks.rs?ref=b886a4de157873c6a3e536a517fd6b097a4ab11b", "patch": "@@ -1,5 +1,4 @@\n use crate::array;\n-use crate::const_closure::ConstFnMutClosure;\n use crate::iter::{ByRefSized, FusedIterator, Iterator, TrustedRandomAccessNoCoerce};\n use crate::mem::{self, MaybeUninit};\n use crate::ops::{ControlFlow, NeverShortCircuit, Try};\n@@ -189,13 +188,12 @@ where\n     I: Iterator,\n {\n     #[inline]\n-    default fn fold<B, F>(mut self, init: B, mut f: F) -> B\n+    default fn fold<B, F>(mut self, init: B, f: F) -> B\n     where\n         Self: Sized,\n         F: FnMut(B, Self::Item) -> B,\n     {\n-        let fold = ConstFnMutClosure::new(&mut f, NeverShortCircuit::wrap_mut_2_imp);\n-        self.try_fold(init, fold).0\n+        self.try_fold(init, NeverShortCircuit::wrap_mut_2(f)).0\n     }\n }\n "}, {"sha": "477e7117c3ea125973252685d8bded87ab93686f", "filename": "library/core/src/iter/adapters/by_ref_sized.rs", "status": "modified", "additions": 5, "deletions": 14, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/b886a4de157873c6a3e536a517fd6b097a4ab11b/library%2Fcore%2Fsrc%2Fiter%2Fadapters%2Fby_ref_sized.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b886a4de157873c6a3e536a517fd6b097a4ab11b/library%2Fcore%2Fsrc%2Fiter%2Fadapters%2Fby_ref_sized.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fiter%2Fadapters%2Fby_ref_sized.rs?ref=b886a4de157873c6a3e536a517fd6b097a4ab11b", "patch": "@@ -1,7 +1,4 @@\n-use crate::{\n-    const_closure::ConstFnMutClosure,\n-    ops::{NeverShortCircuit, Try},\n-};\n+use crate::ops::{NeverShortCircuit, Try};\n \n /// Like `Iterator::by_ref`, but requiring `Sized` so it can forward generics.\n ///\n@@ -39,13 +36,12 @@ impl<I: Iterator> Iterator for ByRefSized<'_, I> {\n     }\n \n     #[inline]\n-    fn fold<B, F>(self, init: B, mut f: F) -> B\n+    fn fold<B, F>(self, init: B, f: F) -> B\n     where\n         F: FnMut(B, Self::Item) -> B,\n     {\n         // `fold` needs ownership, so this can't forward directly.\n-        I::try_fold(self.0, init, ConstFnMutClosure::new(&mut f, NeverShortCircuit::wrap_mut_2_imp))\n-            .0\n+        I::try_fold(self.0, init, NeverShortCircuit::wrap_mut_2(f)).0\n     }\n \n     #[inline]\n@@ -76,17 +72,12 @@ impl<I: DoubleEndedIterator> DoubleEndedIterator for ByRefSized<'_, I> {\n     }\n \n     #[inline]\n-    fn rfold<B, F>(self, init: B, mut f: F) -> B\n+    fn rfold<B, F>(self, init: B, f: F) -> B\n     where\n         F: FnMut(B, Self::Item) -> B,\n     {\n         // `rfold` needs ownership, so this can't forward directly.\n-        I::try_rfold(\n-            self.0,\n-            init,\n-            ConstFnMutClosure::new(&mut f, NeverShortCircuit::wrap_mut_2_imp),\n-        )\n-        .0\n+        I::try_rfold(self.0, init, NeverShortCircuit::wrap_mut_2(f)).0\n     }\n \n     #[inline]"}, {"sha": "00f57fbcc6162abd5e591edc85766a7711153225", "filename": "library/core/src/iter/mod.rs", "status": "modified", "additions": 2, "deletions": 4, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/b886a4de157873c6a3e536a517fd6b097a4ab11b/library%2Fcore%2Fsrc%2Fiter%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b886a4de157873c6a3e536a517fd6b097a4ab11b/library%2Fcore%2Fsrc%2Fiter%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fiter%2Fmod.rs?ref=b886a4de157873c6a3e536a517fd6b097a4ab11b", "patch": "@@ -362,15 +362,13 @@ macro_rules! impl_fold_via_try_fold {\n     };\n     (@internal $fold:ident -> $try_fold:ident) => {\n         #[inline]\n-        fn $fold<AAA, FFF>(mut self, init: AAA, mut fold: FFF) -> AAA\n+        fn $fold<AAA, FFF>(mut self, init: AAA, fold: FFF) -> AAA\n         where\n             FFF: FnMut(AAA, Self::Item) -> AAA,\n         {\n-            use crate::const_closure::ConstFnMutClosure;\n             use crate::ops::NeverShortCircuit;\n \n-            let fold = ConstFnMutClosure::new(&mut fold, NeverShortCircuit::wrap_mut_2_imp);\n-            self.$try_fold(init, fold).0\n+            self.$try_fold(init, NeverShortCircuit::wrap_mut_2(fold)).0\n         }\n     };\n }"}, {"sha": "dc0702c467a4ea1d3c69d2ce21504c114a91fc13", "filename": "library/core/src/lib.rs", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b886a4de157873c6a3e536a517fd6b097a4ab11b/library%2Fcore%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b886a4de157873c6a3e536a517fd6b097a4ab11b/library%2Fcore%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Flib.rs?ref=b886a4de157873c6a3e536a517fd6b097a4ab11b", "patch": "@@ -376,8 +376,6 @@ mod bool;\n mod tuple;\n mod unit;\n \n-mod const_closure;\n-\n #[stable(feature = \"core_primitive\", since = \"1.43.0\")]\n pub mod primitive;\n "}, {"sha": "9108fc63045250d5369d2d63d4fc6581cc18ad9e", "filename": "library/core/src/ops/try_trait.rs", "status": "modified", "additions": 11, "deletions": 6, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/b886a4de157873c6a3e536a517fd6b097a4ab11b/library%2Fcore%2Fsrc%2Fops%2Ftry_trait.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b886a4de157873c6a3e536a517fd6b097a4ab11b/library%2Fcore%2Fsrc%2Fops%2Ftry_trait.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fops%2Ftry_trait.rs?ref=b886a4de157873c6a3e536a517fd6b097a4ab11b", "patch": "@@ -379,13 +379,18 @@ pub(crate) type ChangeOutputType<T, V> = <<T as Try>::Residual as Residual<V>>::\n pub(crate) struct NeverShortCircuit<T>(pub T);\n \n impl<T> NeverShortCircuit<T> {\n-    /// Implementation for building `ConstFnMutClosure` for wrapping the output of a ~const FnMut in a `NeverShortCircuit`.\n     #[inline]\n-    pub const fn wrap_mut_2_imp<A, B, F: ~const FnMut(A, B) -> T>(\n-        f: &mut F,\n-        (a, b): (A, B),\n-    ) -> NeverShortCircuit<T> {\n-        NeverShortCircuit(f(a, b))\n+    pub fn wrap_mut_2<A, B>(\n+        mut f: impl ~const FnMut(A, B) -> T,\n+    ) -> impl ~const FnMut(A, B) -> Self {\n+        cfg_if! {\n+            if #[cfg(bootstrap)] {\n+                #[allow(unused_parens)]\n+                (const move |a, b| NeverShortCircuit(f(a, b)))\n+            } else {\n+                const move |a, b| NeverShortCircuit(f(a, b))\n+            }\n+        }\n     }\n }\n "}]}