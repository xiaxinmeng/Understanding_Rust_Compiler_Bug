{"sha": "e38844a9d837ebe6f8f6e79445e9dead579c387e", "node_id": "C_kwDOAAsO6NoAKGUzODg0NGE5ZDgzN2ViZTZmOGY2ZTc5NDQ1ZTlkZWFkNTc5YzM4N2U", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2021-11-02T22:48:50Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-11-02T22:48:50Z"}, "message": "Rollup merge of #90502 - GuillaumeGomez:split-doc-cfg-feature, r=jyn514\n\nSplit doc_cfg and doc_auto_cfg features\n\nPart of #90497.\n\nWith this feature, `doc_cfg` won't pick up items automatically anymore.\n\ncc `@Mark-Simulacrum`\nr? `@jyn514`", "tree": {"sha": "3a944e98a5d153d11e483fa484932b4ad53b30e5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3a944e98a5d153d11e483fa484932b4ad53b30e5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e38844a9d837ebe6f8f6e79445e9dead579c387e", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhgcBSCRBK7hj4Ov3rIwAAUy8IAFTCFSwYg+Sj73fYO2/p9BYY\nhRe5HdAXv1S3zDXQbnhMktLklRNO/yp9J8UZ1UhGOrF1EWa3tAcHaldTpdIj0EWb\neAKjgDTGxJzFCrbtHWrBIYOrvyU6I/ELNjLdbjKpxagxDBqBxEc+TLgXCBAxDius\nYgsiL51ZMm7/+8Hap7CbOJBbk/d2f73pXU6xXkUv9lDEIVAu2tMFQuKIs/dS3lc5\n8zujcqk9cgDwCMj3EvsY9ip6we3lUZBCDOSkukqu0rF36gXIh8BjNVUDRZXRpZxD\nvPJWsA3/ieks9gYadmpSX3PhrINA8H7c7ac2gKfN3IZT6UXvqjme7MEj+tMp4Z8=\n=yABS\n-----END PGP SIGNATURE-----\n", "payload": "tree 3a944e98a5d153d11e483fa484932b4ad53b30e5\nparent 673aafe70e70df837da98ae28644da713ba58ced\nparent d7afbf61d87bf345597624cccdfb1036439697b9\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1635893330 +0100\ncommitter GitHub <noreply@github.com> 1635893330 +0100\n\nRollup merge of #90502 - GuillaumeGomez:split-doc-cfg-feature, r=jyn514\n\nSplit doc_cfg and doc_auto_cfg features\n\nPart of #90497.\n\nWith this feature, `doc_cfg` won't pick up items automatically anymore.\n\ncc `@Mark-Simulacrum`\nr? `@jyn514`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e38844a9d837ebe6f8f6e79445e9dead579c387e", "html_url": "https://github.com/rust-lang/rust/commit/e38844a9d837ebe6f8f6e79445e9dead579c387e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e38844a9d837ebe6f8f6e79445e9dead579c387e/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "673aafe70e70df837da98ae28644da713ba58ced", "url": "https://api.github.com/repos/rust-lang/rust/commits/673aafe70e70df837da98ae28644da713ba58ced", "html_url": "https://github.com/rust-lang/rust/commit/673aafe70e70df837da98ae28644da713ba58ced"}, {"sha": "d7afbf61d87bf345597624cccdfb1036439697b9", "url": "https://api.github.com/repos/rust-lang/rust/commits/d7afbf61d87bf345597624cccdfb1036439697b9", "html_url": "https://github.com/rust-lang/rust/commit/d7afbf61d87bf345597624cccdfb1036439697b9"}], "stats": {"total": 34, "additions": 29, "deletions": 5}, "files": [{"sha": "1c6f1344e8a1ecca19866b582b413ef804533d6e", "filename": "compiler/rustc_feature/src/active.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/e38844a9d837ebe6f8f6e79445e9dead579c387e/compiler%2Frustc_feature%2Fsrc%2Factive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e38844a9d837ebe6f8f6e79445e9dead579c387e/compiler%2Frustc_feature%2Fsrc%2Factive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_feature%2Fsrc%2Factive.rs?ref=e38844a9d837ebe6f8f6e79445e9dead579c387e", "patch": "@@ -689,6 +689,9 @@ declare_features! (\n     /// not changed from prior instances of the same struct (RFC #2528)\n     (incomplete, type_changing_struct_update, \"1.58.0\", Some(86555), None),\n \n+    /// Tells rustdoc to automatically generate `#[doc(cfg(...))]`.\n+    (active, doc_auto_cfg, \"1.58.0\", Some(43781), None),\n+\n     // -------------------------------------------------------------------------\n     // feature-group-end: actual feature gates\n     // -------------------------------------------------------------------------"}, {"sha": "5f71e955e2ad7aad58673357dfad0028f1150137", "filename": "compiler/rustc_span/src/symbol.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/e38844a9d837ebe6f8f6e79445e9dead579c387e/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e38844a9d837ebe6f8f6e79445e9dead579c387e/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs?ref=e38844a9d837ebe6f8f6e79445e9dead579c387e", "patch": "@@ -549,6 +549,7 @@ symbols! {\n         div_assign,\n         doc,\n         doc_alias,\n+        doc_auto_cfg,\n         doc_cfg,\n         doc_cfg_hide,\n         doc_keyword,"}, {"sha": "56ae43855de924718c08a49e5c85de296bfb4210", "filename": "src/librustdoc/clean/types.rs", "status": "modified", "additions": 6, "deletions": 3, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/e38844a9d837ebe6f8f6e79445e9dead579c387e/src%2Flibrustdoc%2Fclean%2Ftypes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e38844a9d837ebe6f8f6e79445e9dead579c387e/src%2Flibrustdoc%2Fclean%2Ftypes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Ftypes.rs?ref=e38844a9d837ebe6f8f6e79445e9dead579c387e", "patch": "@@ -789,6 +789,7 @@ impl AttributesExt for [ast::Attribute] {\n     fn cfg(&self, tcx: TyCtxt<'_>, hidden_cfg: &FxHashSet<Cfg>) -> Option<Arc<Cfg>> {\n         let sess = tcx.sess;\n         let doc_cfg_active = tcx.features().doc_cfg;\n+        let doc_auto_cfg_active = tcx.features().doc_auto_cfg;\n \n         fn single<T: IntoIterator>(it: T) -> Option<T::Item> {\n             let mut iter = it.into_iter();\n@@ -799,24 +800,26 @@ impl AttributesExt for [ast::Attribute] {\n             Some(item)\n         }\n \n-        let mut cfg = if doc_cfg_active {\n+        let mut cfg = if doc_cfg_active || doc_auto_cfg_active {\n             let mut doc_cfg = self\n                 .iter()\n                 .filter(|attr| attr.has_name(sym::doc))\n                 .flat_map(|attr| attr.meta_item_list().unwrap_or_else(Vec::new))\n                 .filter(|attr| attr.has_name(sym::cfg))\n                 .peekable();\n-            if doc_cfg.peek().is_some() {\n+            if doc_cfg.peek().is_some() && doc_cfg_active {\n                 doc_cfg\n                     .filter_map(|attr| Cfg::parse(attr.meta_item()?).ok())\n                     .fold(Cfg::True, |cfg, new_cfg| cfg & new_cfg)\n-            } else {\n+            } else if doc_auto_cfg_active {\n                 self.iter()\n                     .filter(|attr| attr.has_name(sym::cfg))\n                     .filter_map(|attr| single(attr.meta_item_list()?))\n                     .filter_map(|attr| Cfg::parse(attr.meta_item()?).ok())\n                     .filter(|cfg| !hidden_cfg.contains(cfg))\n                     .fold(Cfg::True, |cfg, new_cfg| cfg & new_cfg)\n+            } else {\n+                Cfg::True\n             }\n         } else {\n             Cfg::True"}, {"sha": "fcdd83545696b46fa4d6e0546c8a87e19ea94bcf", "filename": "src/test/rustdoc/doc-auto-cfg.rs", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/e38844a9d837ebe6f8f6e79445e9dead579c387e/src%2Ftest%2Frustdoc%2Fdoc-auto-cfg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e38844a9d837ebe6f8f6e79445e9dead579c387e/src%2Ftest%2Frustdoc%2Fdoc-auto-cfg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fdoc-auto-cfg.rs?ref=e38844a9d837ebe6f8f6e79445e9dead579c387e", "patch": "@@ -0,0 +1,8 @@\n+#![feature(doc_auto_cfg)]\n+\n+#![crate_name = \"foo\"]\n+\n+// @has foo/fn.foo.html\n+// @has - '//*[@class=\"item-info\"]/*[@class=\"stab portability\"]' 'non-test'\n+#[cfg(not(test))]\n+pub fn foo() {}"}, {"sha": "424fa6d6a911fac841884f3d302fcb7a0805ed6c", "filename": "src/test/rustdoc/doc-cfg-hide.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e38844a9d837ebe6f8f6e79445e9dead579c387e/src%2Ftest%2Frustdoc%2Fdoc-cfg-hide.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e38844a9d837ebe6f8f6e79445e9dead579c387e/src%2Ftest%2Frustdoc%2Fdoc-cfg-hide.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fdoc-cfg-hide.rs?ref=e38844a9d837ebe6f8f6e79445e9dead579c387e", "patch": "@@ -1,5 +1,5 @@\n #![crate_name = \"oud\"]\n-#![feature(doc_cfg, doc_cfg_hide)]\n+#![feature(doc_auto_cfg, doc_cfg, doc_cfg_hide)]\n \n #![doc(cfg_hide(feature = \"solecism\"))]\n "}, {"sha": "5d17a4ede6adcb16da2a182c0abe50e36b64132f", "filename": "src/test/rustdoc/doc-cfg-implicit.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e38844a9d837ebe6f8f6e79445e9dead579c387e/src%2Ftest%2Frustdoc%2Fdoc-cfg-implicit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e38844a9d837ebe6f8f6e79445e9dead579c387e/src%2Ftest%2Frustdoc%2Fdoc-cfg-implicit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fdoc-cfg-implicit.rs?ref=e38844a9d837ebe6f8f6e79445e9dead579c387e", "patch": "@@ -1,5 +1,5 @@\n #![crate_name = \"funambulism\"]\n-#![feature(doc_cfg)]\n+#![feature(doc_auto_cfg, doc_cfg)]\n \n // @has 'funambulism/struct.Disorbed.html'\n // @count   - '//*[@class=\"stab portability\"]' 1"}, {"sha": "da76381e4800064b7b3327bf62693605b44e4e65", "filename": "src/test/rustdoc/feature-gate-doc_auto_cfg.rs", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/e38844a9d837ebe6f8f6e79445e9dead579c387e/src%2Ftest%2Frustdoc%2Ffeature-gate-doc_auto_cfg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e38844a9d837ebe6f8f6e79445e9dead579c387e/src%2Ftest%2Frustdoc%2Ffeature-gate-doc_auto_cfg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Ffeature-gate-doc_auto_cfg.rs?ref=e38844a9d837ebe6f8f6e79445e9dead579c387e", "patch": "@@ -0,0 +1,8 @@\n+#![feature(doc_cfg)]\n+\n+#![crate_name = \"foo\"]\n+\n+// @has foo/fn.foo.html\n+// @count - '//*[@class=\"item-info\"]/*[@class=\"stab portability\"]' 0\n+#[cfg(not(test))]\n+pub fn foo() {}"}, {"sha": "129237775fe3f803c561c47886048987a92a4170", "filename": "src/tools/tidy/src/features.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/e38844a9d837ebe6f8f6e79445e9dead579c387e/src%2Ftools%2Ftidy%2Fsrc%2Ffeatures.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e38844a9d837ebe6f8f6e79445e9dead579c387e/src%2Ftools%2Ftidy%2Fsrc%2Ffeatures.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Ffeatures.rs?ref=e38844a9d837ebe6f8f6e79445e9dead579c387e", "patch": "@@ -97,6 +97,7 @@ pub fn check(\n             &src_path.join(\"test/ui\"),\n             &src_path.join(\"test/ui-fulldeps\"),\n             &src_path.join(\"test/rustdoc-ui\"),\n+            &src_path.join(\"test/rustdoc\"),\n         ],\n         &mut |path| super::filter_dirs(path),\n         &mut |entry, contents| {"}]}