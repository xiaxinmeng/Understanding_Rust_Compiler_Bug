{"sha": "a0ab61fb6c1b0fa2bdcd10cdba17b444941c073e", "node_id": "C_kwDOAAsO6NoAKGEwYWI2MWZiNmMxYjBmYTJiZGNkMTBjZGJhMTdiNDQ0OTQxYzA3M2U", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-10-11T18:45:31Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-10-11T18:45:31Z"}, "message": "Auto merge of #13358 - btwotwo:feature/env-vars-autocompletion, r=Veykril\n\nfeat: Autocomplete Cargo-defined env vars in `env!` and `option_env!` (#12448)\n\nCloses #12448\n\nImportant to know:\n\n- Variables are taken from https://doc.rust-lang.org/cargo/reference/environment-variables.html and hardcoded as a const array.\n- For the sake of simplicity I didn't include the autocompletion of `CARGO_BIN_EXE_<name>` and `OUT_DIR` since it would require information about build.rs and binary name. If somebody knows an easy way of obtaining them I can add those vars as well :)", "tree": {"sha": "1978f072f2aa48e289ac8b5d522dcdc6552850a9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1978f072f2aa48e289ac8b5d522dcdc6552850a9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a0ab61fb6c1b0fa2bdcd10cdba17b444941c073e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a0ab61fb6c1b0fa2bdcd10cdba17b444941c073e", "html_url": "https://github.com/rust-lang/rust/commit/a0ab61fb6c1b0fa2bdcd10cdba17b444941c073e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a0ab61fb6c1b0fa2bdcd10cdba17b444941c073e/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d08f1c3dff1827d401bafb82ab509a9d1e954008", "url": "https://api.github.com/repos/rust-lang/rust/commits/d08f1c3dff1827d401bafb82ab509a9d1e954008", "html_url": "https://github.com/rust-lang/rust/commit/d08f1c3dff1827d401bafb82ab509a9d1e954008"}, {"sha": "2b2b9f8c7332314b151fd8287a8b02c34a20a5a7", "url": "https://api.github.com/repos/rust-lang/rust/commits/2b2b9f8c7332314b151fd8287a8b02c34a20a5a7", "html_url": "https://github.com/rust-lang/rust/commit/2b2b9f8c7332314b151fd8287a8b02c34a20a5a7"}], "stats": {"total": 167, "additions": 162, "deletions": 5}, "files": [{"sha": "296dfc14250f75013e748352511adcf8b26ff066", "filename": "crates/ide-completion/src/completions.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/a0ab61fb6c1b0fa2bdcd10cdba17b444941c073e/crates%2Fide-completion%2Fsrc%2Fcompletions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a0ab61fb6c1b0fa2bdcd10cdba17b444941c073e/crates%2Fide-completion%2Fsrc%2Fcompletions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-completion%2Fsrc%2Fcompletions.rs?ref=a0ab61fb6c1b0fa2bdcd10cdba17b444941c073e", "patch": "@@ -19,6 +19,7 @@ pub(crate) mod snippet;\n pub(crate) mod r#type;\n pub(crate) mod use_;\n pub(crate) mod vis;\n+pub(crate) mod env_vars;\n \n use std::iter;\n "}, {"sha": "09e95e53de63ce42f31791d8c092a2772b4e9501", "filename": "crates/ide-completion/src/completions/env_vars.rs", "status": "added", "additions": 150, "deletions": 0, "changes": 150, "blob_url": "https://github.com/rust-lang/rust/blob/a0ab61fb6c1b0fa2bdcd10cdba17b444941c073e/crates%2Fide-completion%2Fsrc%2Fcompletions%2Fenv_vars.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a0ab61fb6c1b0fa2bdcd10cdba17b444941c073e/crates%2Fide-completion%2Fsrc%2Fcompletions%2Fenv_vars.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-completion%2Fsrc%2Fcompletions%2Fenv_vars.rs?ref=a0ab61fb6c1b0fa2bdcd10cdba17b444941c073e", "patch": "@@ -0,0 +1,150 @@\n+//! Completes environment variables defined by Cargo (https://doc.rust-lang.org/cargo/reference/environment-variables.html)\n+use hir::Semantics;\n+use ide_db::{syntax_helpers::node_ext::macro_call_for_string_token, RootDatabase};\n+use syntax::ast::{self, IsString};\n+\n+use crate::{\n+    completions::Completions, context::CompletionContext, CompletionItem, CompletionItemKind,\n+};\n+\n+const CARGO_DEFINED_VARS: &[(&str, &str)] = &[\n+    (\"CARGO\",\"Path to the cargo binary performing the build\"),\n+    (\"CARGO_MANIFEST_DIR\",\"The directory containing the manifest of your package\"),\n+    (\"CARGO_PKG_VERSION\",\"The full version of your package\"),\n+    (\"CARGO_PKG_VERSION_MAJOR\",\"The major version of your package\"),\n+    (\"CARGO_PKG_VERSION_MINOR\",\"The minor version of your package\"),\n+    (\"CARGO_PKG_VERSION_PATCH\",\"The patch version of your package\"),\n+    (\"CARGO_PKG_VERSION_PRE\",\"The pre-release version of your package\"),\n+    (\"CARGO_PKG_AUTHORS\",\"Colon separated list of authors from the manifest of your package\"),\n+    (\"CARGO_PKG_NAME\",\"The name of your package\"),\n+    (\"CARGO_PKG_DESCRIPTION\",\"The description from the manifest of your package\"),\n+    (\"CARGO_PKG_HOMEPAGE\",\"The home page from the manifest of your package\"),\n+    (\"CARGO_PKG_REPOSITORY\",\"The repository from the manifest of your package\"),\n+    (\"CARGO_PKG_LICENSE\",\"The license from the manifest of your package\"),\n+    (\"CARGO_PKG_LICENSE_FILE\",\"The license file from the manifest of your package\"),\n+    (\"CARGO_PKG_RUST_VERSION\",\"The Rust version from the manifest of your package. Note that this is the minimum Rust version supported by the package, not the current Rust version\"),\n+    (\"CARGO_CRATE_NAME\",\"The name of the crate that is currently being compiled\"),\n+    (\"CARGO_BIN_NAME\",\"The name of the binary that is currently being compiled (if it is a binary). This name does not include any file extension, such as .exe\"),\n+    (\"CARGO_PRIMARY_PACKAGE\",\"This environment variable will be set if the package being built is primary. Primary packages are the ones the user selected on the command-line, either with -p flags or the defaults based on the current directory and the default workspace members. This environment variable will not be set when building dependencies. This is only set when compiling the package (not when running binaries or tests)\"),\n+    (\"CARGO_TARGET_TMPDIR\",\"Only set when building integration test or benchmark code. This is a path to a directory inside the target directory where integration tests or benchmarks are free to put any data needed by the tests/benches. Cargo initially creates this directory but doesn't manage its content in any way, this is the responsibility of the test code\")\n+];\n+\n+pub(crate) fn complete_cargo_env_vars(\n+    acc: &mut Completions,\n+    ctx: &CompletionContext<'_>,\n+    expanded: &ast::String,\n+) -> Option<()> {\n+    guard_env_macro(expanded, &ctx.sema)?;\n+    let range = expanded.text_range_between_quotes()?;\n+\n+    CARGO_DEFINED_VARS.iter().for_each(|(var, detail)| {\n+        let mut item = CompletionItem::new(CompletionItemKind::Keyword, range, var);\n+        item.detail(*detail);\n+        item.add_to(acc);\n+    });\n+\n+    Some(())\n+}\n+\n+fn guard_env_macro(string: &ast::String, semantics: &Semantics<'_, RootDatabase>) -> Option<()> {\n+    let call = macro_call_for_string_token(string)?;\n+    let name = call.path()?.segment()?.name_ref()?;\n+    let makro = semantics.resolve_macro_call(&call)?;\n+    let db = semantics.db;\n+\n+    match name.text().as_str() {\n+        \"env\" | \"option_env\" if makro.kind(db) == hir::MacroKind::BuiltIn => Some(()),\n+        _ => None,\n+    }\n+}\n+\n+#[cfg(test)]\n+mod tests {\n+    use crate::tests::{check_edit, completion_list};\n+\n+    fn check(macro_name: &str) {\n+        check_edit(\n+            \"CARGO_BIN_NAME\",\n+            &format!(\n+                r#\"\n+            #[rustc_builtin_macro]\n+            macro_rules! {} {{\n+                ($var:literal) => {{ 0 }}\n+            }}\n+\n+            fn main() {{\n+                let foo = {}!(\"CAR$0\");\n+            }}\n+        \"#,\n+                macro_name, macro_name\n+            ),\n+            &format!(\n+                r#\"\n+            #[rustc_builtin_macro]\n+            macro_rules! {} {{\n+                ($var:literal) => {{ 0 }}\n+            }}\n+\n+            fn main() {{\n+                let foo = {}!(\"CARGO_BIN_NAME\");\n+            }}\n+        \"#,\n+                macro_name, macro_name\n+            ),\n+        );\n+    }\n+    #[test]\n+    fn completes_env_variable_in_env() {\n+        check(\"env\")\n+    }\n+\n+    #[test]\n+    fn completes_env_variable_in_option_env() {\n+        check(\"option_env\");\n+    }\n+\n+    #[test]\n+    fn doesnt_complete_in_random_strings() {\n+        let fixture = r#\"\n+            fn main() {\n+                let foo = \"CA$0\";\n+            }\n+        \"#;\n+\n+        let completions = completion_list(fixture);\n+        assert!(completions.is_empty(), \"Completions weren't empty: {}\", completions);\n+    }\n+\n+    #[test]\n+    fn doesnt_complete_in_random_macro() {\n+        let fixture = r#\"\n+            macro_rules! bar {\n+                ($($arg:tt)*) => { 0 }\n+            }\n+\n+            fn main() {\n+                let foo = bar!(\"CA$0\");\n+\n+            }\n+        \"#;\n+\n+        let completions = completion_list(fixture);\n+        assert!(completions.is_empty(), \"Completions weren't empty: {}\", completions);\n+    }\n+\n+    #[test]\n+    fn doesnt_complete_for_shadowed_macro() {\n+        let fixture = r#\"\n+            macro_rules! env {\n+                ($var:literal) => { 0 }\n+            }\n+\n+            fn main() {\n+                let foo = env!(\"CA$0\");\n+            }\n+        \"#;\n+\n+        let completions = completion_list(fixture);\n+        assert!(completions.is_empty(), \"Completions weren't empty: {}\", completions)\n+    }\n+}"}, {"sha": "9d0044e55f598870413f74f7ce879d267342482c", "filename": "crates/ide-completion/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/a0ab61fb6c1b0fa2bdcd10cdba17b444941c073e/crates%2Fide-completion%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a0ab61fb6c1b0fa2bdcd10cdba17b444941c073e/crates%2Fide-completion%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-completion%2Fsrc%2Flib.rs?ref=a0ab61fb6c1b0fa2bdcd10cdba17b444941c073e", "patch": "@@ -183,6 +183,7 @@ pub fn completions(\n             CompletionAnalysis::String { original, expanded: Some(expanded) } => {\n                 completions::extern_abi::complete_extern_abi(acc, ctx, expanded);\n                 completions::format_string::format_string(acc, ctx, original, expanded);\n+                completions::env_vars::complete_cargo_env_vars(acc, ctx, expanded);\n             }\n             CompletionAnalysis::UnexpandedAttrTT {\n                 colon_prefix,"}, {"sha": "2d6927cee9953c2fdd9a1a1e7cdc93d6ba2cbdfa", "filename": "crates/ide-db/src/syntax_helpers/format_string.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/a0ab61fb6c1b0fa2bdcd10cdba17b444941c073e/crates%2Fide-db%2Fsrc%2Fsyntax_helpers%2Fformat_string.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a0ab61fb6c1b0fa2bdcd10cdba17b444941c073e/crates%2Fide-db%2Fsrc%2Fsyntax_helpers%2Fformat_string.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-db%2Fsrc%2Fsyntax_helpers%2Fformat_string.rs?ref=a0ab61fb6c1b0fa2bdcd10cdba17b444941c073e", "patch": "@@ -1,7 +1,8 @@\n //! Tools to work with format string literals for the `format_args!` family of macros.\n+use crate::syntax_helpers::node_ext::macro_call_for_string_token;\n use syntax::{\n     ast::{self, IsString},\n-    AstNode, AstToken, TextRange, TextSize,\n+    TextRange, TextSize,\n };\n \n pub fn is_format_string(string: &ast::String) -> bool {\n@@ -14,8 +15,7 @@ pub fn is_format_string(string: &ast::String) -> bool {\n     // This setup lets us correctly highlight the components of `concat!(\"{}\", \"bla\")` format\n     // strings. It still fails for `concat!(\"{\", \"}\")`, but that is rare.\n     (|| {\n-        let macro_call = string.syntax().parent_ancestors().find_map(ast::MacroCall::cast)?;\n-        let name = macro_call.path()?.segment()?.name_ref()?;\n+        let name = macro_call_for_string_token(string)?.path()?.segment()?.name_ref()?;\n \n         if !matches!(\n             name.text().as_str(),"}, {"sha": "39710b8f13eb5f7024b8fe2a385ead1badda3a21", "filename": "crates/ide-db/src/syntax_helpers/node_ext.rs", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/a0ab61fb6c1b0fa2bdcd10cdba17b444941c073e/crates%2Fide-db%2Fsrc%2Fsyntax_helpers%2Fnode_ext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a0ab61fb6c1b0fa2bdcd10cdba17b444941c073e/crates%2Fide-db%2Fsrc%2Fsyntax_helpers%2Fnode_ext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-db%2Fsrc%2Fsyntax_helpers%2Fnode_ext.rs?ref=a0ab61fb6c1b0fa2bdcd10cdba17b444941c073e", "patch": "@@ -2,8 +2,8 @@\n use itertools::Itertools;\n use parser::T;\n use syntax::{\n-    ast::{self, HasLoopBody, PathSegmentKind, VisibilityKind},\n-    AstNode, Preorder, RustLanguage, WalkEvent,\n+    ast::{self, HasLoopBody, MacroCall, PathSegmentKind, VisibilityKind},\n+    AstNode, AstToken, Preorder, RustLanguage, WalkEvent,\n };\n \n pub fn expr_as_name_ref(expr: &ast::Expr) -> Option<ast::NameRef> {\n@@ -457,3 +457,8 @@ pub fn parse_tt_as_comma_sep_paths(input: ast::TokenTree) -> Option<Vec<ast::Pat\n         .collect();\n     Some(paths)\n }\n+\n+pub fn macro_call_for_string_token(string: &ast::String) -> Option<MacroCall> {\n+    let macro_call = string.syntax().parent_ancestors().find_map(ast::MacroCall::cast)?;\n+    Some(macro_call)\n+}"}]}