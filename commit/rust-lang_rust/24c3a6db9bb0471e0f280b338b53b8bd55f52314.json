{"sha": "24c3a6db9bb0471e0f280b338b53b8bd55f52314", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI0YzNhNmRiOWJiMDQ3MWUwZjI4MGIzMzhiNTNiOGJkNTVmNTIzMTQ=", "commit": {"author": {"name": "Ed Schouten", "email": "ed@nuxi.nl", "date": "2018-01-14T17:37:52Z"}, "committer": {"name": "Ed Schouten", "email": "ed@nuxi.nl", "date": "2018-01-16T19:31:09Z"}, "message": "Add a Docker container for doing automated builds for CloudABI.\n\nSetting up a cross compilation toolchain for CloudABI is relatively\neasy. It's just a matter of installing a somewhat recent version of\nClang (5.0 preferred) and installing the corresponding\n${target}-cxx-runtime package, containing a set of core C/C++ libraries\n(libc, libc++, libunwind, etc).\n\nEventually it would be nice if we could also run 'x.py test'. That,\nhowever still requires some more work. Both libtest and compiletest\nwould need to be adjusted to deal with CloudABI's requirement of having\nall of an application's dependencies injected. Let's settle for just\ndoing 'x.py dist' for now.", "tree": {"sha": "f4020e07e19721055e3a3031903d515e974d4061", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f4020e07e19721055e3a3031903d515e974d4061"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/24c3a6db9bb0471e0f280b338b53b8bd55f52314", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/24c3a6db9bb0471e0f280b338b53b8bd55f52314", "html_url": "https://github.com/rust-lang/rust/commit/24c3a6db9bb0471e0f280b338b53b8bd55f52314", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/24c3a6db9bb0471e0f280b338b53b8bd55f52314/comments", "author": {"login": "EdSchouten", "id": 736085, "node_id": "MDQ6VXNlcjczNjA4NQ==", "avatar_url": "https://avatars.githubusercontent.com/u/736085?v=4", "gravatar_id": "", "url": "https://api.github.com/users/EdSchouten", "html_url": "https://github.com/EdSchouten", "followers_url": "https://api.github.com/users/EdSchouten/followers", "following_url": "https://api.github.com/users/EdSchouten/following{/other_user}", "gists_url": "https://api.github.com/users/EdSchouten/gists{/gist_id}", "starred_url": "https://api.github.com/users/EdSchouten/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/EdSchouten/subscriptions", "organizations_url": "https://api.github.com/users/EdSchouten/orgs", "repos_url": "https://api.github.com/users/EdSchouten/repos", "events_url": "https://api.github.com/users/EdSchouten/events{/privacy}", "received_events_url": "https://api.github.com/users/EdSchouten/received_events", "type": "User", "site_admin": false}, "committer": {"login": "EdSchouten", "id": 736085, "node_id": "MDQ6VXNlcjczNjA4NQ==", "avatar_url": "https://avatars.githubusercontent.com/u/736085?v=4", "gravatar_id": "", "url": "https://api.github.com/users/EdSchouten", "html_url": "https://github.com/EdSchouten", "followers_url": "https://api.github.com/users/EdSchouten/followers", "following_url": "https://api.github.com/users/EdSchouten/following{/other_user}", "gists_url": "https://api.github.com/users/EdSchouten/gists{/gist_id}", "starred_url": "https://api.github.com/users/EdSchouten/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/EdSchouten/subscriptions", "organizations_url": "https://api.github.com/users/EdSchouten/orgs", "repos_url": "https://api.github.com/users/EdSchouten/repos", "events_url": "https://api.github.com/users/EdSchouten/events{/privacy}", "received_events_url": "https://api.github.com/users/EdSchouten/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "da569fa9ddf8369a9809184d43c600dc06bd4b4d", "url": "https://api.github.com/repos/rust-lang/rust/commits/da569fa9ddf8369a9809184d43c600dc06bd4b4d", "html_url": "https://github.com/rust-lang/rust/commit/da569fa9ddf8369a9809184d43c600dc06bd4b4d"}], "stats": {"total": 91, "additions": 91, "deletions": 0}, "files": [{"sha": "1642a39955293a57f6f26abbbb2bef2e531f3fb6", "filename": ".travis.yml", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/24c3a6db9bb0471e0f280b338b53b8bd55f52314/.travis.yml", "raw_url": "https://github.com/rust-lang/rust/raw/24c3a6db9bb0471e0f280b338b53b8bd55f52314/.travis.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.travis.yml?ref=24c3a6db9bb0471e0f280b338b53b8bd55f52314", "patch": "@@ -126,6 +126,8 @@ matrix:\n       if: branch = auto\n     - env: IMAGE=dist-armv7-linux DEPLOY=1\n       if: branch = auto\n+    - env: IMAGE=dist-cloudabi DEPLOY=1\n+      if: branch = auto\n     - env: IMAGE=dist-i586-gnu-i586-i686-musl DEPLOY=1\n       if: branch = auto\n     - env: IMAGE=dist-i686-freebsd DEPLOY=1"}, {"sha": "f1f6f0ff6cac91b0a802aa864cdf50d3235e4525", "filename": "src/ci/docker/dist-cloudabi/Dockerfile", "status": "added", "additions": 30, "deletions": 0, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/24c3a6db9bb0471e0f280b338b53b8bd55f52314/src%2Fci%2Fdocker%2Fdist-cloudabi%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/24c3a6db9bb0471e0f280b338b53b8bd55f52314/src%2Fci%2Fdocker%2Fdist-cloudabi%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fdist-cloudabi%2FDockerfile?ref=24c3a6db9bb0471e0f280b338b53b8bd55f52314", "patch": "@@ -0,0 +1,30 @@\n+FROM ubuntu:17.10\n+\n+ENV TARGETS=aarch64-unknown-cloudabi\n+# FIXME(EdSchouten): Enable ARMv7 support once libc \u22650.2.37 has been merged.\n+# ENV TARGETS=armv7-unknown-cloudabi-eabihf\n+ENV TARGETS=$TARGETS,i686-unknown-cloudabi\n+ENV TARGETS=$TARGETS,x86_64-unknown-cloudabi\n+\n+COPY scripts/cloudabi-toolchain.sh /tmp/\n+RUN /tmp/cloudabi-toolchain.sh\n+\n+COPY scripts/sccache.sh /scripts/\n+RUN sh /scripts/sccache.sh\n+\n+# FIXME(EdSchouten): Remove this once cc \u22651.0.4 has been merged. It can\n+# automatically pick the right compiler path.\n+ENV \\\n+    AR_aarch64_unknown_cloudabi=aarch64-unknown-cloudabi-ar \\\n+    CC_aarch64_unknown_cloudabi=aarch64-unknown-cloudabi-clang \\\n+    CXX_aarch64_unknown_cloudabi=aarch64-unknown-cloudabi-clang++ \\\n+    AR_i686_unknown_cloudabi=i686-unknown-cloudabi-ar \\\n+    CC_i686_unknown_cloudabi=i686-unknown-cloudabi-clang \\\n+    CXX_i686_unknown_cloudabi=i686-unknown-cloudabi-clang++ \\\n+    AR_x86_64_unknown_cloudabi=x86_64-unknown-cloudabi-ar \\\n+    CC_x86_64_unknown_cloudabi=x86_64-unknown-cloudabi-clang \\\n+    CXX_x86_64_unknown_cloudabi=x86_64-unknown-cloudabi-clang++\n+\n+# FIXME(EdSchouten): Work towards being able to run 'x.py test'.\n+ENV RUST_CONFIGURE_ARGS --target=${TARGETS} --disable-jemalloc\n+ENV SCRIPT python2.7 /checkout/x.py dist --target ${TARGETS}"}, {"sha": "5d6ecb48d3cae44252bbd07f4fc074d6c4dcb625", "filename": "src/ci/docker/scripts/cloudabi-toolchain.sh", "status": "added", "additions": 59, "deletions": 0, "changes": 59, "blob_url": "https://github.com/rust-lang/rust/blob/24c3a6db9bb0471e0f280b338b53b8bd55f52314/src%2Fci%2Fdocker%2Fscripts%2Fcloudabi-toolchain.sh", "raw_url": "https://github.com/rust-lang/rust/raw/24c3a6db9bb0471e0f280b338b53b8bd55f52314/src%2Fci%2Fdocker%2Fscripts%2Fcloudabi-toolchain.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fscripts%2Fcloudabi-toolchain.sh?ref=24c3a6db9bb0471e0f280b338b53b8bd55f52314", "patch": "@@ -0,0 +1,59 @@\n+#!/bin/bash\n+# Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n+# file at the top-level directory of this distribution and at\n+# http://rust-lang.org/COPYRIGHT.\n+#\n+# Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+# http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+# <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+# option. This file may not be copied, modified, or distributed\n+# except according to those terms.\n+\n+set -eux\n+\n+# Install prerequisites.\n+apt-get update\n+apt-get install -y --no-install-recommends \\\n+  apt-transport-https \\\n+  ca-certificates \\\n+  clang-5.0 \\\n+  cmake \\\n+  curl \\\n+  file \\\n+  g++ \\\n+  gdb \\\n+  git \\\n+  lld-5.0 \\\n+  make \\\n+  python \\\n+  sudo \\\n+  xz-utils\n+\n+# Set up a Clang-based cross compiler toolchain.\n+# Based on the steps described at https://nuxi.nl/cloudabi/debian/\n+IFS=,\n+for target in ${TARGETS}; do\n+  for tool in ar nm objdump ranlib size; do\n+    ln -s ../lib/llvm-5.0/bin/llvm-${tool} /usr/bin/${target}-${tool}\n+  done\n+  ln -s ../lib/llvm-5.0/bin/clang /usr/bin/${target}-cc\n+  ln -s ../lib/llvm-5.0/bin/clang /usr/bin/${target}-c++\n+  ln -s ../lib/llvm-5.0/bin/lld /usr/bin/${target}-ld\n+  ln -s ../../${target} /usr/lib/llvm-5.0/${target}\n+\n+  # FIXME(EdSchouten): Remove this once cc \u22651.0.4 has been merged. It\n+  # can make use of ${target}-cc and ${target}-c++, without incorrectly\n+  # assuming it's MSVC.\n+  ln -s ../lib/llvm-5.0/bin/clang /usr/bin/${target}-clang\n+  ln -s ../lib/llvm-5.0/bin/clang /usr/bin/${target}-clang++\n+done\n+\n+# Install the C++ runtime libraries from CloudABI Ports.\n+echo deb https://nuxi.nl/distfiles/cloudabi-ports/debian/ cloudabi cloudabi > \\\n+    /etc/apt/sources.list.d/cloudabi.list\n+curl 'https://pgp.mit.edu/pks/lookup?op=get&search=0x0DA51B8531344B15' | \\\n+    apt-key add -\n+apt-get update\n+for target in ${TARGETS}; do\n+  apt-get install -y $(echo ${target} | sed -e s/_/-/g)-cxx-runtime\n+done"}]}