{"sha": "25ebcca224dc220c0439d9c82c6ef5ffa131c409", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI1ZWJjY2EyMjRkYzIyMGMwNDM5ZDljODJjNmVmNWZmYTEzMWM0MDk=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-11-29T19:35:12Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-11-29T19:35:12Z"}, "message": "Merge #6599\n\n6599: Add attribute highlight modifier to all tokens inside attributes r=matklad a=Veykril\n\nThis has the side effect that we also emit `attribute.attribute` highlights now, as in, the tokens that get the attribute semantic type also get the attribute modifier. I personally don't think it's really a problem but maybe it is to some? It's just that it was really simple to implement it this way, which is why I just went this route for now.\r\n\r\nFixes #6536\n\nCo-authored-by: Lukas Wirth <lukastw97@gmail.com>", "tree": {"sha": "6f506eb1050b5a57a28a95d6de483ea0e2445a57", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6f506eb1050b5a57a28a95d6de483ea0e2445a57"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/25ebcca224dc220c0439d9c82c6ef5ffa131c409", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfw/fwCRBK7hj4Ov3rIwAAdHIIAJp4wxlLb8g2Wnis6IpgI/as\nYMJfNsL8FD/DzKHst3gu1sgFuI/rRjyQw4dRIa/Np2DMbYNKrY5GjBZfwdSRHPUy\n1kXTbUX4xvNaEMkOCITR1ki2pSaKD57EaTHRI+aqKMm5xGE/ZMDaT7BjuoqAG2c2\nfsvyv5lePIKcn1kgWoknHY5NJa2wIWlC1+rZsRZClqX2t5eIsnBm7PbYjv/BYEcS\nd8Evkusht27WuiTbN50+k6oNmA20jdi+IuMo1XEeKSuJzuoxezAGh8RR15GSv4D6\nNlccgFu7ZgTTxZvBoTNTOj44AEWAl+wGZdPuOuNXTAG5QL3n45bmAAwIbhaTmtw=\n=Jj+Z\n-----END PGP SIGNATURE-----\n", "payload": "tree 6f506eb1050b5a57a28a95d6de483ea0e2445a57\nparent f8726d781a971752a6918a20eea10cddca2114ed\nparent 1f87a4198956fd3a8b57d01c2bce19481fe2c610\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1606678512 +0000\ncommitter GitHub <noreply@github.com> 1606678512 +0000\n\nMerge #6599\n\n6599: Add attribute highlight modifier to all tokens inside attributes r=matklad a=Veykril\n\nThis has the side effect that we also emit `attribute.attribute` highlights now, as in, the tokens that get the attribute semantic type also get the attribute modifier. I personally don't think it's really a problem but maybe it is to some? It's just that it was really simple to implement it this way, which is why I just went this route for now.\r\n\r\nFixes #6536\n\nCo-authored-by: Lukas Wirth <lukastw97@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/25ebcca224dc220c0439d9c82c6ef5ffa131c409", "html_url": "https://github.com/rust-lang/rust/commit/25ebcca224dc220c0439d9c82c6ef5ffa131c409", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/25ebcca224dc220c0439d9c82c6ef5ffa131c409/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f8726d781a971752a6918a20eea10cddca2114ed", "url": "https://api.github.com/repos/rust-lang/rust/commits/f8726d781a971752a6918a20eea10cddca2114ed", "html_url": "https://github.com/rust-lang/rust/commit/f8726d781a971752a6918a20eea10cddca2114ed"}, {"sha": "1f87a4198956fd3a8b57d01c2bce19481fe2c610", "url": "https://api.github.com/repos/rust-lang/rust/commits/1f87a4198956fd3a8b57d01c2bce19481fe2c610", "html_url": "https://github.com/rust-lang/rust/commit/1f87a4198956fd3a8b57d01c2bce19481fe2c610"}], "stats": {"total": 33, "additions": 23, "deletions": 10}, "files": [{"sha": "5150a970c1a31502681a175491ebd66d7e7855ed", "filename": "crates/ide/src/syntax_highlighting.rs", "status": "modified", "additions": 16, "deletions": 3, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/25ebcca224dc220c0439d9c82c6ef5ffa131c409/crates%2Fide%2Fsrc%2Fsyntax_highlighting.rs", "raw_url": "https://github.com/rust-lang/rust/raw/25ebcca224dc220c0439d9c82c6ef5ffa131c409/crates%2Fide%2Fsrc%2Fsyntax_highlighting.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fsyntax_highlighting.rs?ref=25ebcca224dc220c0439d9c82c6ef5ffa131c409", "patch": "@@ -76,6 +76,7 @@ pub(crate) fn highlight(\n     let mut current_macro_call: Option<ast::MacroCall> = None;\n     let mut format_string_highlighter = FormatStringHighlighter::default();\n     let mut macro_rules_highlighter = MacroRulesHighlighter::default();\n+    let mut inside_attribute = false;\n \n     // Walk all nodes, keeping track of whether we are inside a macro or not.\n     // If in macro, expand it first and highlight the expanded code.\n@@ -132,9 +133,12 @@ pub(crate) fn highlight(\n             _ => (),\n         }\n \n-        // Check for Rust code in documentation\n         match &event {\n+            // Check for Rust code in documentation\n             WalkEvent::Leave(NodeOrToken::Node(node)) => {\n+                if ast::Attr::can_cast(node.kind()) {\n+                    inside_attribute = false\n+                }\n                 if let Some((doctest, range_mapping, new_comments)) =\n                     injection::extract_doc_comments(node)\n                 {\n@@ -146,6 +150,9 @@ pub(crate) fn highlight(\n                     );\n                 }\n             }\n+            WalkEvent::Enter(NodeOrToken::Node(node)) if ast::Attr::can_cast(node.kind()) => {\n+                inside_attribute = true\n+            }\n             _ => (),\n         }\n \n@@ -188,12 +195,16 @@ pub(crate) fn highlight(\n             }\n         }\n \n-        if let Some((highlight, binding_hash)) = highlight_element(\n+        if let Some((mut highlight, binding_hash)) = highlight_element(\n             &sema,\n             &mut bindings_shadow_count,\n             syntactic_name_ref_highlighting,\n             element_to_highlight.clone(),\n         ) {\n+            if inside_attribute {\n+                highlight = highlight | HighlightModifier::Attribute;\n+            }\n+\n             if macro_rules_highlighter.highlight(element_to_highlight.clone()).is_none() {\n                 stack.add(HighlightedRange { range, highlight, binding_hash });\n             }\n@@ -474,7 +485,9 @@ fn highlight_element(\n \n         // Highlight references like the definitions they resolve to\n         NAME_REF if element.ancestors().any(|it| it.kind() == ATTR) => {\n-            Highlight::from(HighlightTag::Function) | HighlightModifier::Attribute\n+            // even though we track whether we are in an attribute or not we still need this special case\n+            // as otherwise we would emit unresolved references for name refs inside attributes\n+            Highlight::from(HighlightTag::Function)\n         }\n         NAME_REF => {\n             let name_ref = element.into_node().and_then(ast::NameRef::cast).unwrap();"}, {"sha": "d79fa6dca86fd4ccbe6c99cc96c5e9b3529a7997", "filename": "crates/ide/src/syntax_highlighting/test_data/highlight_doctest.html", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/25ebcca224dc220c0439d9c82c6ef5ffa131c409/crates%2Fide%2Fsrc%2Fsyntax_highlighting%2Ftest_data%2Fhighlight_doctest.html", "raw_url": "https://github.com/rust-lang/rust/raw/25ebcca224dc220c0439d9c82c6ef5ffa131c409/crates%2Fide%2Fsrc%2Fsyntax_highlighting%2Ftest_data%2Fhighlight_doctest.html", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fsyntax_highlighting%2Ftest_data%2Fhighlight_doctest.html?ref=25ebcca224dc220c0439d9c82c6ef5ffa131c409", "patch": "@@ -50,7 +50,7 @@\n     <span class=\"comment documentation\">/// # Examples</span>\n     <span class=\"comment documentation\">///</span>\n     <span class=\"comment documentation\">/// ```</span>\n-    <span class=\"comment documentation\">/// #</span><span class=\"generic injected\"> </span><span class=\"attribute injected\">#</span><span class=\"attribute injected\">!</span><span class=\"attribute injected\">[</span><span class=\"function attribute injected\">allow</span><span class=\"punctuation injected\">(</span><span class=\"attribute injected\">unused_mut</span><span class=\"punctuation injected\">)</span><span class=\"attribute injected\">]</span>\n+    <span class=\"comment documentation\">/// #</span><span class=\"generic injected\"> </span><span class=\"attribute attribute injected\">#</span><span class=\"attribute attribute injected\">!</span><span class=\"attribute attribute injected\">[</span><span class=\"function attribute injected\">allow</span><span class=\"punctuation attribute injected\">(</span><span class=\"attribute attribute injected\">unused_mut</span><span class=\"punctuation attribute injected\">)</span><span class=\"attribute attribute injected\">]</span>\n     <span class=\"comment documentation\">/// </span><span class=\"keyword injected\">let</span><span class=\"generic injected\"> </span><span class=\"keyword injected\">mut</span><span class=\"generic injected\"> </span><span class=\"variable declaration injected mutable\">foo</span><span class=\"punctuation injected\">:</span><span class=\"generic injected\"> </span><span class=\"struct injected\">Foo</span><span class=\"generic injected\"> </span><span class=\"operator injected\">=</span><span class=\"generic injected\"> </span><span class=\"struct injected\">Foo</span><span class=\"operator injected\">::</span><span class=\"function injected\">new</span><span class=\"punctuation injected\">(</span><span class=\"punctuation injected\">)</span><span class=\"punctuation injected\">;</span><span class=\"punctuation injected\">\n </span>    <span class=\"comment documentation\">/// ```</span>\n     <span class=\"keyword\">pub</span> <span class=\"keyword\">const</span> <span class=\"keyword\">fn</span> <span class=\"function declaration static\">new</span><span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">-&gt;</span> <span class=\"struct\">Foo</span> <span class=\"punctuation\">{</span>"}, {"sha": "1d05b771310b0fa006c0f19564d85ea25b05cb4d", "filename": "crates/ide/src/syntax_highlighting/test_data/highlight_unsafe.html", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/25ebcca224dc220c0439d9c82c6ef5ffa131c409/crates%2Fide%2Fsrc%2Fsyntax_highlighting%2Ftest_data%2Fhighlight_unsafe.html", "raw_url": "https://github.com/rust-lang/rust/raw/25ebcca224dc220c0439d9c82c6ef5ffa131c409/crates%2Fide%2Fsrc%2Fsyntax_highlighting%2Ftest_data%2Fhighlight_unsafe.html", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fsyntax_highlighting%2Ftest_data%2Fhighlight_unsafe.html?ref=25ebcca224dc220c0439d9c82c6ef5ffa131c409", "patch": "@@ -54,7 +54,7 @@\n \n <span class=\"keyword\">static</span> <span class=\"keyword\">mut</span> <span class=\"static declaration mutable unsafe\">global_mut</span><span class=\"punctuation\">:</span> <span class=\"struct\">TypeForStaticMut</span> <span class=\"operator\">=</span> <span class=\"struct\">TypeForStaticMut</span> <span class=\"punctuation\">{</span> <span class=\"field\">a</span><span class=\"punctuation\">:</span> <span class=\"numeric_literal\">0</span> <span class=\"punctuation\">}</span><span class=\"punctuation\">;</span>\n \n-<span class=\"attribute\">#</span><span class=\"attribute\">[</span><span class=\"function attribute\">repr</span><span class=\"punctuation\">(</span><span class=\"attribute\">packed</span><span class=\"punctuation\">)</span><span class=\"attribute\">]</span>\n+<span class=\"attribute attribute\">#</span><span class=\"attribute attribute\">[</span><span class=\"function attribute\">repr</span><span class=\"punctuation attribute\">(</span><span class=\"attribute attribute\">packed</span><span class=\"punctuation attribute\">)</span><span class=\"attribute attribute\">]</span>\n <span class=\"keyword\">struct</span> <span class=\"struct declaration\">Packed</span> <span class=\"punctuation\">{</span>\n     <span class=\"field declaration\">a</span><span class=\"punctuation\">:</span> <span class=\"builtin_type\">u16</span><span class=\"punctuation\">,</span>\n <span class=\"punctuation\">}</span>"}, {"sha": "15fbf2ce3914f57f4dd8b1856e94b010d1361f50", "filename": "crates/ide/src/syntax_highlighting/test_data/highlighting.html", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/25ebcca224dc220c0439d9c82c6ef5ffa131c409/crates%2Fide%2Fsrc%2Fsyntax_highlighting%2Ftest_data%2Fhighlighting.html", "raw_url": "https://github.com/rust-lang/rust/raw/25ebcca224dc220c0439d9c82c6ef5ffa131c409/crates%2Fide%2Fsrc%2Fsyntax_highlighting%2Ftest_data%2Fhighlighting.html", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fsyntax_highlighting%2Ftest_data%2Fhighlighting.html?ref=25ebcca224dc220c0439d9c82c6ef5ffa131c409", "patch": "@@ -40,18 +40,18 @@\n \n <span class=\"comment\">// Needed for function consuming vs normal</span>\n <span class=\"keyword\">pub</span> <span class=\"keyword\">mod</span> <span class=\"module declaration\">marker</span> <span class=\"punctuation\">{</span>\n-    <span class=\"attribute\">#</span><span class=\"attribute\">[</span><span class=\"function attribute\">lang</span><span class=\"attribute\"> </span><span class=\"operator\">=</span><span class=\"attribute\"> </span><span class=\"string_literal\">\"copy\"</span><span class=\"attribute\">]</span>\n+    <span class=\"attribute attribute\">#</span><span class=\"attribute attribute\">[</span><span class=\"function attribute\">lang</span><span class=\"attribute attribute\"> </span><span class=\"operator attribute\">=</span><span class=\"attribute attribute\"> </span><span class=\"string_literal attribute\">\"copy\"</span><span class=\"attribute attribute\">]</span>\n     <span class=\"keyword\">pub</span> <span class=\"keyword\">trait</span> <span class=\"trait declaration\">Copy</span> <span class=\"punctuation\">{</span><span class=\"punctuation\">}</span>\n <span class=\"punctuation\">}</span>\n \n <span class=\"keyword\">pub</span> <span class=\"keyword\">mod</span> <span class=\"module declaration\">ops</span> <span class=\"punctuation\">{</span>\n-    <span class=\"attribute\">#</span><span class=\"attribute\">[</span><span class=\"function attribute\">lang</span><span class=\"attribute\"> </span><span class=\"operator\">=</span><span class=\"attribute\"> </span><span class=\"string_literal\">\"fn_once\"</span><span class=\"attribute\">]</span>\n+    <span class=\"attribute attribute\">#</span><span class=\"attribute attribute\">[</span><span class=\"function attribute\">lang</span><span class=\"attribute attribute\"> </span><span class=\"operator attribute\">=</span><span class=\"attribute attribute\"> </span><span class=\"string_literal attribute\">\"fn_once\"</span><span class=\"attribute attribute\">]</span>\n     <span class=\"keyword\">pub</span> <span class=\"keyword\">trait</span> <span class=\"trait declaration\">FnOnce</span><span class=\"punctuation\">&lt;</span><span class=\"type_param declaration\">Args</span><span class=\"punctuation\">&gt;</span> <span class=\"punctuation\">{</span><span class=\"punctuation\">}</span>\n \n-    <span class=\"attribute\">#</span><span class=\"attribute\">[</span><span class=\"function attribute\">lang</span><span class=\"attribute\"> </span><span class=\"operator\">=</span><span class=\"attribute\"> </span><span class=\"string_literal\">\"fn_mut\"</span><span class=\"attribute\">]</span>\n+    <span class=\"attribute attribute\">#</span><span class=\"attribute attribute\">[</span><span class=\"function attribute\">lang</span><span class=\"attribute attribute\"> </span><span class=\"operator attribute\">=</span><span class=\"attribute attribute\"> </span><span class=\"string_literal attribute\">\"fn_mut\"</span><span class=\"attribute attribute\">]</span>\n     <span class=\"keyword\">pub</span> <span class=\"keyword\">trait</span> <span class=\"trait declaration\">FnMut</span><span class=\"punctuation\">&lt;</span><span class=\"type_param declaration\">Args</span><span class=\"punctuation\">&gt;</span><span class=\"punctuation\">:</span> <span class=\"trait\">FnOnce</span><span class=\"punctuation\">&lt;</span><span class=\"type_param\">Args</span><span class=\"punctuation\">&gt;</span> <span class=\"punctuation\">{</span><span class=\"punctuation\">}</span>\n \n-    <span class=\"attribute\">#</span><span class=\"attribute\">[</span><span class=\"function attribute\">lang</span><span class=\"attribute\"> </span><span class=\"operator\">=</span><span class=\"attribute\"> </span><span class=\"string_literal\">\"fn\"</span><span class=\"attribute\">]</span>\n+    <span class=\"attribute attribute\">#</span><span class=\"attribute attribute\">[</span><span class=\"function attribute\">lang</span><span class=\"attribute attribute\"> </span><span class=\"operator attribute\">=</span><span class=\"attribute attribute\"> </span><span class=\"string_literal attribute\">\"fn\"</span><span class=\"attribute attribute\">]</span>\n     <span class=\"keyword\">pub</span> <span class=\"keyword\">trait</span> <span class=\"trait declaration\">Fn</span><span class=\"punctuation\">&lt;</span><span class=\"type_param declaration\">Args</span><span class=\"punctuation\">&gt;</span><span class=\"punctuation\">:</span> <span class=\"trait\">FnMut</span><span class=\"punctuation\">&lt;</span><span class=\"type_param\">Args</span><span class=\"punctuation\">&gt;</span> <span class=\"punctuation\">{</span><span class=\"punctuation\">}</span>\n <span class=\"punctuation\">}</span>\n \n@@ -85,7 +85,7 @@\n     <span class=\"punctuation\">}</span>\n <span class=\"punctuation\">}</span>\n \n-<span class=\"attribute\">#</span><span class=\"attribute\">[</span><span class=\"function attribute\">derive</span><span class=\"punctuation\">(</span><span class=\"attribute\">Copy</span><span class=\"punctuation\">)</span><span class=\"attribute\">]</span>\n+<span class=\"attribute attribute\">#</span><span class=\"attribute attribute\">[</span><span class=\"function attribute\">derive</span><span class=\"punctuation attribute\">(</span><span class=\"attribute attribute\">Copy</span><span class=\"punctuation attribute\">)</span><span class=\"attribute attribute\">]</span>\n <span class=\"keyword\">struct</span> <span class=\"struct declaration\">FooCopy</span> <span class=\"punctuation\">{</span>\n     <span class=\"field declaration\">x</span><span class=\"punctuation\">:</span> <span class=\"builtin_type\">u32</span><span class=\"punctuation\">,</span>\n <span class=\"punctuation\">}</span>"}]}