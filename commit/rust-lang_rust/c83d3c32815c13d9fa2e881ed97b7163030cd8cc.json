{"sha": "c83d3c32815c13d9fa2e881ed97b7163030cd8cc", "node_id": "MDY6Q29tbWl0NzI0NzEyOmM4M2QzYzMyODE1YzEzZDlmYTJlODgxZWQ5N2I3MTYzMDMwY2Q4Y2M=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2019-08-16T16:22:24Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-08-16T16:22:24Z"}, "message": "Rollup merge of #63525 - matklad:centraliza-file-loading, r=petrochenkov\n\nMake sure that all file loading happens via SourceMap\n\nThat way, callers don't need to repeat \"let's add this to sm manually\nfor tracking dependencies\" trick.\n\nIt should make it easier to switch to using `FileLoader` for binary\nfiles in the future as well\n\ncc #62948\n\nr? @petrochenkov", "tree": {"sha": "b427373656728960e894f6ea9fca4d67a88785fb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b427373656728960e894f6ea9fca4d67a88785fb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c83d3c32815c13d9fa2e881ed97b7163030cd8cc", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJdVthBCRBK7hj4Ov3rIwAAdHIIACnJR5OdRMIbf+yCENPCndm0\nMlii52hg5a/YxHLfWsewajIbXZAoSk5VA6Tpd360C5vOBsJFNzW7fEdUJfqCszmO\ns7c6QMxXtQPT/vtN1yZmish2s2ecHPQnqavbXWQA1b0KSM/ucqRJL41oC8aWYIyA\npkAoXAfFHj2npNgl+9GYa8eQBUg9UJF7UUbkj3wmKpciZ6MUDDWKFxEySf0id/o3\nIejL/NYa++vIrhlB00sB9G69WanCxWLXuiPu0XgKVYpuZ8Xzt3qS1Yp3buz93lGl\nccx25k5bSVEj7d0wMAWmGxJIZ5s9eWi7Uywbq861XdIbwriBzeRzS0swN+g2K0Q=\n=NmWg\n-----END PGP SIGNATURE-----\n", "payload": "tree b427373656728960e894f6ea9fca4d67a88785fb\nparent db3bae01708b41f7fd9bb75830cd9163b8b10e48\nparent 14bc998df9f15042342ac8e649a4adadf17a65f8\nauthor Mazdak Farrokhzad <twingoow@gmail.com> 1565972544 +0200\ncommitter GitHub <noreply@github.com> 1565972544 +0200\n\nRollup merge of #63525 - matklad:centraliza-file-loading, r=petrochenkov\n\nMake sure that all file loading happens via SourceMap\n\nThat way, callers don't need to repeat \"let's add this to sm manually\nfor tracking dependencies\" trick.\n\nIt should make it easier to switch to using `FileLoader` for binary\nfiles in the future as well\n\ncc #62948\n\nr? @petrochenkov\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c83d3c32815c13d9fa2e881ed97b7163030cd8cc", "html_url": "https://github.com/rust-lang/rust/commit/c83d3c32815c13d9fa2e881ed97b7163030cd8cc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c83d3c32815c13d9fa2e881ed97b7163030cd8cc/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "db3bae01708b41f7fd9bb75830cd9163b8b10e48", "url": "https://api.github.com/repos/rust-lang/rust/commits/db3bae01708b41f7fd9bb75830cd9163b8b10e48", "html_url": "https://github.com/rust-lang/rust/commit/db3bae01708b41f7fd9bb75830cd9163b8b10e48"}, {"sha": "14bc998df9f15042342ac8e649a4adadf17a65f8", "url": "https://api.github.com/repos/rust-lang/rust/commits/14bc998df9f15042342ac8e649a4adadf17a65f8", "html_url": "https://github.com/rust-lang/rust/commit/14bc998df9f15042342ac8e649a4adadf17a65f8"}], "stats": {"total": 85, "additions": 51, "deletions": 34}, "files": [{"sha": "dac402921b95c2b0ac379d8796e2cc77e96abe24", "filename": "src/libsyntax/ext/expand.rs", "status": "modified", "additions": 5, "deletions": 8, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/c83d3c32815c13d9fa2e881ed97b7163030cd8cc/src%2Flibsyntax%2Fext%2Fexpand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c83d3c32815c13d9fa2e881ed97b7163030cd8cc/src%2Flibsyntax%2Fext%2Fexpand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fexpand.rs?ref=c83d3c32815c13d9fa2e881ed97b7163030cd8cc", "patch": "@@ -25,7 +25,6 @@ use syntax_pos::{Span, DUMMY_SP, FileName};\n \n use rustc_data_structures::fx::FxHashMap;\n use rustc_data_structures::sync::Lrc;\n-use std::fs;\n use std::io::ErrorKind;\n use std::{iter, mem};\n use std::ops::DerefMut;\n@@ -1241,13 +1240,11 @@ impl<'a, 'b> MutVisitor for InvocationCollector<'a, 'b> {\n                     }\n \n                     let filename = self.cx.resolve_path(&*file.as_str(), it.span());\n-                    match fs::read_to_string(&filename) {\n-                        Ok(src) => {\n-                            let src_interned = Symbol::intern(&src);\n-\n-                            // Add this input file to the code map to make it available as\n-                            // dependency information\n-                            self.cx.source_map().new_source_file(filename.into(), src);\n+                    match self.cx.source_map().load_file(&filename) {\n+                        Ok(source_file) => {\n+                            let src = source_file.src.as_ref()\n+                                .expect(\"freshly loaded file should have a source\");\n+                            let src_interned = Symbol::intern(src.as_str());\n \n                             let include_info = vec![\n                                 ast::NestedMetaItem::MetaItem("}, {"sha": "7190cfd72a959af92d34022f04d7cea89c0817e4", "filename": "src/libsyntax/source_map.rs", "status": "modified", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/c83d3c32815c13d9fa2e881ed97b7163030cd8cc/src%2Flibsyntax%2Fsource_map.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c83d3c32815c13d9fa2e881ed97b7163030cd8cc/src%2Flibsyntax%2Fsource_map.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fsource_map.rs?ref=c83d3c32815c13d9fa2e881ed97b7163030cd8cc", "patch": "@@ -171,6 +171,26 @@ impl SourceMap {\n         Ok(self.new_source_file(filename, src))\n     }\n \n+    /// Loads source file as a binary blob.\n+    ///\n+    /// Unlike `load_file`, guarantees that no normalization like BOM-removal\n+    /// takes place.\n+    pub fn load_binary_file(&self, path: &Path) -> io::Result<Vec<u8>> {\n+        // Ideally, this should use `self.file_loader`, but it can't\n+        // deal with binary files yet.\n+        let bytes = fs::read(path)?;\n+\n+        // We need to add file to the `SourceMap`, so that it is present\n+        // in dep-info. There's also an edge case that file might be both\n+        // loaded as a binary via `include_bytes!` and as proper `SourceFile`\n+        // via `mod`, so we try to use real file contents and not just an\n+        // empty string.\n+        let text = std::str::from_utf8(&bytes).unwrap_or(\"\")\n+            .to_string();\n+        self.new_source_file(path.to_owned().into(), text);\n+        Ok(bytes)\n+    }\n+\n     pub fn files(&self) -> MappedLockGuard<'_, Vec<Lrc<SourceFile>>> {\n         LockGuard::map(self.files.borrow(), |files| &mut files.source_files)\n     }"}, {"sha": "e008ed710e4d07e1ea270bb1aa67d4fe26170705", "filename": "src/libsyntax_ext/source_util.rs", "status": "modified", "additions": 11, "deletions": 26, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/c83d3c32815c13d9fa2e881ed97b7163030cd8cc/src%2Flibsyntax_ext%2Fsource_util.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c83d3c32815c13d9fa2e881ed97b7163030cd8cc/src%2Flibsyntax_ext%2Fsource_util.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax_ext%2Fsource_util.rs?ref=c83d3c32815c13d9fa2e881ed97b7163030cd8cc", "patch": "@@ -9,8 +9,6 @@ use syntax::tokenstream;\n use smallvec::SmallVec;\n use syntax_pos::{self, Pos, Span};\n \n-use std::fs;\n-use std::io::ErrorKind;\n use rustc_data_structures::sync::Lrc;\n \n // These macros all relate to the file system; they either return\n@@ -114,20 +112,17 @@ pub fn expand_include_str(cx: &mut ExtCtxt<'_>, sp: Span, tts: &[tokenstream::To\n         None => return DummyResult::any(sp)\n     };\n     let file = cx.resolve_path(file, sp);\n-    match fs::read_to_string(&file) {\n-        Ok(src) => {\n-            let interned_src = Symbol::intern(&src);\n-\n-            // Add this input file to the code map to make it available as\n-            // dependency information\n-            cx.source_map().new_source_file(file.into(), src);\n-\n-            base::MacEager::expr(cx.expr_str(sp, interned_src))\n+    match cx.source_map().load_binary_file(&file) {\n+        Ok(bytes) => match std::str::from_utf8(&bytes) {\n+            Ok(src) => {\n+                let interned_src = Symbol::intern(&src);\n+                base::MacEager::expr(cx.expr_str(sp, interned_src))\n+            }\n+            Err(_) => {\n+                cx.span_err(sp, &format!(\"{} wasn't a utf-8 file\", file.display()));\n+                DummyResult::any(sp)\n+            }\n         },\n-        Err(ref e) if e.kind() == ErrorKind::InvalidData => {\n-            cx.span_err(sp, &format!(\"{} wasn't a utf-8 file\", file.display()));\n-            DummyResult::any(sp)\n-        }\n         Err(e) => {\n             cx.span_err(sp, &format!(\"couldn't read {}: {}\", file.display(), e));\n             DummyResult::any(sp)\n@@ -142,18 +137,8 @@ pub fn expand_include_bytes(cx: &mut ExtCtxt<'_>, sp: Span, tts: &[tokenstream::\n         None => return DummyResult::any(sp)\n     };\n     let file = cx.resolve_path(file, sp);\n-    match fs::read(&file) {\n+    match cx.source_map().load_binary_file(&file) {\n         Ok(bytes) => {\n-            // Add the contents to the source map if it contains UTF-8.\n-            let (contents, bytes) = match String::from_utf8(bytes) {\n-                Ok(s) => {\n-                    let bytes = s.as_bytes().to_owned();\n-                    (s, bytes)\n-                },\n-                Err(e) => (String::new(), e.into_bytes()),\n-            };\n-            cx.source_map().new_source_file(file.into(), contents);\n-\n             base::MacEager::expr(cx.expr_lit(sp, ast::LitKind::ByteStr(Lrc::new(bytes))))\n         },\n         Err(e) => {"}, {"sha": "489dc8ad1118cda0191fe8529129674a4583179c", "filename": "src/test/ui/.gitattributes", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/c83d3c32815c13d9fa2e881ed97b7163030cd8cc/src%2Ftest%2Fui%2F.gitattributes", "raw_url": "https://github.com/rust-lang/rust/raw/c83d3c32815c13d9fa2e881ed97b7163030cd8cc/src%2Ftest%2Fui%2F.gitattributes", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2F.gitattributes?ref=c83d3c32815c13d9fa2e881ed97b7163030cd8cc", "patch": "@@ -1,2 +1,3 @@\n lexer-crlf-line-endings-string-literal-doc-comment.rs -text\n trailing-carriage-return-in-string.rs -text\n+*.bin -text"}, {"sha": "ce4e0b8311a31a78c537a7282133ab4f9306cdad", "filename": "src/test/ui/include-macros/data.bin", "status": "added", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/c83d3c32815c13d9fa2e881ed97b7163030cd8cc/src%2Ftest%2Fui%2Finclude-macros%2Fdata.bin", "raw_url": "https://github.com/rust-lang/rust/raw/c83d3c32815c13d9fa2e881ed97b7163030cd8cc/src%2Ftest%2Fui%2Finclude-macros%2Fdata.bin", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Finclude-macros%2Fdata.bin?ref=c83d3c32815c13d9fa2e881ed97b7163030cd8cc", "patch": "@@ -0,0 +1,2 @@\n+\ufeffThis file starts with BOM.\r\n+Lines are separated by \\r\\n.\r"}, {"sha": "889f08e606ec9a7b610d409e316b6fc8c1bb30a0", "filename": "src/test/ui/include-macros/normalization.rs", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/c83d3c32815c13d9fa2e881ed97b7163030cd8cc/src%2Ftest%2Fui%2Finclude-macros%2Fnormalization.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c83d3c32815c13d9fa2e881ed97b7163030cd8cc/src%2Ftest%2Fui%2Finclude-macros%2Fnormalization.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Finclude-macros%2Fnormalization.rs?ref=c83d3c32815c13d9fa2e881ed97b7163030cd8cc", "patch": "@@ -0,0 +1,12 @@\n+// run-pass\n+\n+fn main() {\n+    assert_eq!(\n+        &include_bytes!(\"data.bin\")[..],\n+        &b\"\\xEF\\xBB\\xBFThis file starts with BOM.\\r\\nLines are separated by \\\\r\\\\n.\\r\\n\"[..],\n+    );\n+    assert_eq!(\n+        include_str!(\"data.bin\"),\n+        \"\\u{FEFF}This file starts with BOM.\\r\\nLines are separated by \\\\r\\\\n.\\r\\n\",\n+    );\n+}"}]}