{"sha": "9acb351f5756b58b053ca9b834664da971ac52f2", "node_id": "MDY6Q29tbWl0NzI0NzEyOjlhY2IzNTFmNTc1NmI1OGIwNTNjYTliODM0NjY0ZGE5NzFhYzUyZjI=", "commit": {"author": {"name": "Niko Matsakis", "email": "niko@alum.mit.edu", "date": "2018-05-30T14:27:53Z"}, "committer": {"name": "Niko Matsakis", "email": "niko@alum.mit.edu", "date": "2018-05-30T18:54:51Z"}, "message": "reset the \"anonymous lifetime mode\" for parenthesized where clauses\n\nBackground:\n\nThe anonymous lifetime mode is used to prohibit elided lifetimes where\nthey didn't used to be permitted, and instead require that `'_` be\nused. For example:\n\n```rust\nimpl Trait for Ref<T> { .. }\n//             ^^^^^^ ERROR: should be `Ref<'_, T>`\n```\n\nWhen we are parsing the parts of the impl header, we enter into an\nalternate mode called `CreateParameter`. In this mode, we give an\nerror for things like `Ref<T>`, but for elided lifetimes in a\nreference type like `&T` we make the elided lifetime into an in-band\nlifetime:\n\nhttps://github.com/rust-lang/rust/blob/4f99f37b7e213d69a489884f651adfc6d217cef5/src/librustc/hir/lowering.rs#L4017-L4035\n\nThis was not intended to change behavior because we only enter into\nthat mode in contexts where elision was not historically\npermitted. However, the problem is that we fail to reset the mode when\nwe enter into bounds like `Fn(&u32)`, where elision *was* allowed --\nthe same occurs for fn types like `fn(&u32`). This PR restores the\noriginal mode in those contexts.", "tree": {"sha": "43f3f7ea9b956836032559407a7d98f487c9c06d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/43f3f7ea9b956836032559407a7d98f487c9c06d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9acb351f5756b58b053ca9b834664da971ac52f2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9acb351f5756b58b053ca9b834664da971ac52f2", "html_url": "https://github.com/rust-lang/rust/commit/9acb351f5756b58b053ca9b834664da971ac52f2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9acb351f5756b58b053ca9b834664da971ac52f2/comments", "author": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "74d09399c1289a20b1c258153f005f2604f9ec46", "url": "https://api.github.com/repos/rust-lang/rust/commits/74d09399c1289a20b1c258153f005f2604f9ec46", "html_url": "https://github.com/rust-lang/rust/commit/74d09399c1289a20b1c258153f005f2604f9ec46"}], "stats": {"total": 128, "additions": 91, "deletions": 37}, "files": [{"sha": "7d88468c3dd7896bdd0d0b0f7ebc4e177f9fd293", "filename": "src/librustc/hir/lowering.rs", "status": "modified", "additions": 59, "deletions": 37, "changes": 96, "blob_url": "https://github.com/rust-lang/rust/blob/9acb351f5756b58b053ca9b834664da971ac52f2/src%2Flibrustc%2Fhir%2Flowering.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9acb351f5756b58b053ca9b834664da971ac52f2/src%2Flibrustc%2Fhir%2Flowering.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fhir%2Flowering.rs?ref=9acb351f5756b58b053ca9b834664da971ac52f2", "patch": "@@ -594,6 +594,18 @@ impl<'a> LoweringContext<'a> {\n         span.with_ctxt(SyntaxContext::empty().apply_mark(mark))\n     }\n \n+    fn with_anonymous_lifetime_mode<R>(\n+        &mut self,\n+        anonymous_lifetime_mode: AnonymousLifetimeMode,\n+        op: impl FnOnce(&mut Self) -> R,\n+    ) -> R {\n+        let old_anonymous_lifetime_mode = self.anonymous_lifetime_mode;\n+        self.anonymous_lifetime_mode = anonymous_lifetime_mode;\n+        let result = op(self);\n+        self.anonymous_lifetime_mode = old_anonymous_lifetime_mode;\n+        result\n+    }\n+\n     /// Creates a new hir::GenericParam for every new lifetime and\n     /// type parameter encountered while evaluating `f`. Definitions\n     /// are created with the parent provided. If no `parent_id` is\n@@ -1620,44 +1632,54 @@ impl<'a> LoweringContext<'a> {\n         &mut self,\n         data: &ParenthesizedParameterData,\n     ) -> (hir::PathParameters, bool) {\n-        const DISALLOWED: ImplTraitContext = ImplTraitContext::Disallowed;\n-        let &ParenthesizedParameterData {\n-            ref inputs,\n-            ref output,\n-            span,\n-        } = data;\n-        let inputs = inputs\n-            .iter()\n-            .map(|ty| self.lower_ty(ty, DISALLOWED))\n-            .collect();\n-        let mk_tup = |this: &mut Self, tys, span| {\n-            let LoweredNodeId { node_id, hir_id } = this.next_id();\n-            P(hir::Ty {\n-                node: hir::TyTup(tys),\n-                id: node_id,\n-                hir_id,\n-                span,\n-            })\n-        };\n+        // Switch to `PassThrough` mode for anonymous lifetimes: this\n+        // means that we permit things like `&Ref<T>`, where `Ref` has\n+        // a hidden lifetime parameter. This is needed for backwards\n+        // compatibility, even in contexts like an impl header where\n+        // we generally don't permit such things (see #51008).\n+        self.with_anonymous_lifetime_mode(\n+            AnonymousLifetimeMode::PassThrough,\n+            |this| {\n+                const DISALLOWED: ImplTraitContext = ImplTraitContext::Disallowed;\n+                let &ParenthesizedParameterData {\n+                    ref inputs,\n+                    ref output,\n+                    span,\n+                } = data;\n+                let inputs = inputs\n+                    .iter()\n+                    .map(|ty| this.lower_ty(ty, DISALLOWED))\n+                    .collect();\n+                let mk_tup = |this: &mut Self, tys, span| {\n+                    let LoweredNodeId { node_id, hir_id } = this.next_id();\n+                    P(hir::Ty {\n+                        node: hir::TyTup(tys),\n+                        id: node_id,\n+                        hir_id,\n+                        span,\n+                    })\n+                };\n \n-        (\n-            hir::PathParameters {\n-                lifetimes: hir::HirVec::new(),\n-                types: hir_vec![mk_tup(self, inputs, span)],\n-                bindings: hir_vec![\n-                    hir::TypeBinding {\n-                        id: self.next_id().node_id,\n-                        name: Symbol::intern(FN_OUTPUT_NAME),\n-                        ty: output\n-                            .as_ref()\n-                            .map(|ty| self.lower_ty(&ty, DISALLOWED))\n-                            .unwrap_or_else(|| mk_tup(self, hir::HirVec::new(), span)),\n-                        span: output.as_ref().map_or(span, |ty| ty.span),\n-                    }\n-                ],\n-                parenthesized: true,\n-            },\n-            false,\n+                (\n+                    hir::PathParameters {\n+                        lifetimes: hir::HirVec::new(),\n+                        types: hir_vec![mk_tup(this, inputs, span)],\n+                        bindings: hir_vec![\n+                            hir::TypeBinding {\n+                                id: this.next_id().node_id,\n+                                name: Symbol::intern(FN_OUTPUT_NAME),\n+                                ty: output\n+                                    .as_ref()\n+                                    .map(|ty| this.lower_ty(&ty, DISALLOWED))\n+                                    .unwrap_or_else(|| mk_tup(this, hir::HirVec::new(), span)),\n+                                span: output.as_ref().map_or(span, |ty| ty.span),\n+                            }\n+                        ],\n+                        parenthesized: true,\n+                    },\n+                    false,\n+                )\n+            }\n         )\n     }\n "}, {"sha": "2da99b35929a1de908f934ee0d6de4d6b89c202f", "filename": "src/librustc/middle/resolve_lifetime.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/9acb351f5756b58b053ca9b834664da971ac52f2/src%2Flibrustc%2Fmiddle%2Fresolve_lifetime.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9acb351f5756b58b053ca9b834664da971ac52f2/src%2Flibrustc%2Fmiddle%2Fresolve_lifetime.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fresolve_lifetime.rs?ref=9acb351f5756b58b053ca9b834664da971ac52f2", "patch": "@@ -101,6 +101,13 @@ impl Region {\n         let depth = ty::DebruijnIndex::INNERMOST;\n         let def_id = hir_map.local_def_id(def.lifetime.id);\n         let origin = LifetimeDefOrigin::from_is_in_band(def.in_band);\n+        debug!(\n+            \"Region::late: def={:?} depth={:?} def_id={:?} origin={:?}\",\n+            def,\n+            depth,\n+            def_id,\n+            origin,\n+        );\n         (def.lifetime.name, Region::LateBound(depth, def_id, origin))\n     }\n "}, {"sha": "eb2673857e2f42dc33dfda9c58bf657f622ff623", "filename": "src/test/ui/rust-2018/issue-51008.rs", "status": "added", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/9acb351f5756b58b053ca9b834664da971ac52f2/src%2Ftest%2Fui%2Frust-2018%2Fissue-51008.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9acb351f5756b58b053ca9b834664da971ac52f2/src%2Ftest%2Fui%2Frust-2018%2Fissue-51008.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frust-2018%2Fissue-51008.rs?ref=9acb351f5756b58b053ca9b834664da971ac52f2", "patch": "@@ -0,0 +1,25 @@\n+// Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// Regression test for #51008 -- the anonymous lifetime in `&i32` was\n+// being incorrectly considered part of the \"elided lifetimes\" from\n+// the impl.\n+//\n+// run-pass\n+\n+#![feature(rust_2018_preview)]\n+\n+trait A {\n+\n+}\n+\n+impl<F> A for F where F: FnOnce(&i32) {}\n+\n+fn main() {}"}]}