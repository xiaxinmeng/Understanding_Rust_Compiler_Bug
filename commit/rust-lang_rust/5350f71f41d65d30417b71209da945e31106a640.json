{"sha": "5350f71f41d65d30417b71209da945e31106a640", "node_id": "MDY6Q29tbWl0NzI0NzEyOjUzNTBmNzFmNDFkNjVkMzA0MTdiNzEyMDlkYTk0NWUzMTEwNmE2NDA=", "commit": {"author": {"name": "Nick Cameron", "email": "nrc@ncameron.org", "date": "2017-07-10T05:52:23Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2017-07-10T05:52:23Z"}, "message": "Merge pull request #1776 from topecongiro/poor-formatting/index-budget\n\nUse correct one line budget when rewriting index", "tree": {"sha": "c23676674eed53e8778bc9937ff0778d6c82f8e6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c23676674eed53e8778bc9937ff0778d6c82f8e6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5350f71f41d65d30417b71209da945e31106a640", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5350f71f41d65d30417b71209da945e31106a640", "html_url": "https://github.com/rust-lang/rust/commit/5350f71f41d65d30417b71209da945e31106a640", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5350f71f41d65d30417b71209da945e31106a640/comments", "author": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "588d11955557e29eca5c5e48b160acb8de038cd7", "url": "https://api.github.com/repos/rust-lang/rust/commits/588d11955557e29eca5c5e48b160acb8de038cd7", "html_url": "https://github.com/rust-lang/rust/commit/588d11955557e29eca5c5e48b160acb8de038cd7"}, {"sha": "7ab4bdfd85fe868e7aaabe1fe3192815787e5b29", "url": "https://api.github.com/repos/rust-lang/rust/commits/7ab4bdfd85fe868e7aaabe1fe3192815787e5b29", "html_url": "https://github.com/rust-lang/rust/commit/7ab4bdfd85fe868e7aaabe1fe3192815787e5b29"}], "stats": {"total": 29, "additions": 22, "deletions": 7}, "files": [{"sha": "d9524c46fa52abb04ad4fae0f1d3437762afb2ce", "filename": "src/expr.rs", "status": "modified", "additions": 11, "deletions": 7, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/5350f71f41d65d30417b71209da945e31106a640/src%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5350f71f41d65d30417b71209da945e31106a640/src%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fexpr.rs?ref=5350f71f41d65d30417b71209da945e31106a640", "patch": "@@ -2494,13 +2494,18 @@ fn rewrite_index(\n         (\"[\", \"]\")\n     };\n \n-    let offset = expr_str.len() + lbr.len();\n-    let orig_index_rw = shape\n-        .visual_indent(offset)\n-        .sub_width(offset + rbr.len())\n-        .and_then(|index_shape| index.rewrite(context, index_shape));\n+    let offset = last_line_width(&expr_str) + lbr.len();\n+    let rhs_overhead = shape.rhs_overhead(context.config);\n+    let index_shape = if expr_str.contains('\\n') {\n+        Shape::legacy(context.config.max_width(), shape.indent)\n+            .offset_left(offset)\n+            .and_then(|shape| shape.sub_width(rbr.len() + rhs_overhead))\n+    } else {\n+        shape.visual_indent(offset).sub_width(offset + rbr.len())\n+    };\n+    let orig_index_rw = index_shape.and_then(|s| index.rewrite(context, s));\n \n-    // Return if everything fits in a single line.\n+    // Return if index fits in a single line.\n     match orig_index_rw {\n         Some(ref index_str) if !index_str.contains('\\n') => {\n             return Some(format!(\"{}{}{}{}\", expr_str, lbr, index_str, rbr));\n@@ -2510,7 +2515,6 @@ fn rewrite_index(\n \n     // Try putting index on the next line and see if it fits in a single line.\n     let indent = shape.indent.block_indent(context.config);\n-    let rhs_overhead = shape.rhs_overhead(context.config);\n     let index_shape = try_opt!(Shape::indented(indent, context.config).offset_left(lbr.len()));\n     let index_shape = try_opt!(index_shape.sub_width(rbr.len() + rhs_overhead));\n     let new_index_rw = index.rewrite(context, index_shape);"}, {"sha": "fb0bd905d0aae5c26d931465153ea876ae251044", "filename": "tests/source/expr.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/5350f71f41d65d30417b71209da945e31106a640/tests%2Fsource%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5350f71f41d65d30417b71209da945e31106a640/tests%2Fsource%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fexpr.rs?ref=5350f71f41d65d30417b71209da945e31106a640", "patch": "@@ -222,6 +222,8 @@ fn casts() {\n fn indices() {\n     let x = (aaaaaaaaaaaaaaaaaaaaaaaaaaaa+bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb+cccccccccccccccc) [ x + y + z ];\n     let y = (aaaaaaaaaaaaaaaaaaaaaaaaaaaa + bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb + cccccccccccccccc)[ xxxxx + yyyyy + zzzzz ];\n+    let z = xxxxxxxxxx.x().y().zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz()[aaaaa];\n+    let z = xxxxxxxxxx.x().y().zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz()[aaaaa];\n }\n \n fn repeats() {"}, {"sha": "26963540fcca036a69897b455f30a8371a2ad759", "filename": "tests/target/expr.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/5350f71f41d65d30417b71209da945e31106a640/tests%2Ftarget%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5350f71f41d65d30417b71209da945e31106a640/tests%2Ftarget%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fexpr.rs?ref=5350f71f41d65d30417b71209da945e31106a640", "patch": "@@ -283,6 +283,15 @@ fn indices() {\n         [x + y + z];\n     let y = (aaaaaaaaaaaaaaaaaaaaaaaaaaaa + bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb + cccccccccccccccc)\n         [xxxxx + yyyyy + zzzzz];\n+    let z = xxxxxxxxxx\n+        .x()\n+        .y()\n+        .zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz()[aaaaa];\n+    let z = xxxxxxxxxx\n+        .x()\n+        .y()\n+        .zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz()\n+        [aaaaa];\n }\n \n fn repeats() {"}]}