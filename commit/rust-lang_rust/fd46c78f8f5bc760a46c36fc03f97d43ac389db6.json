{"sha": "fd46c78f8f5bc760a46c36fc03f97d43ac389db6", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZkNDZjNzhmOGY1YmM3NjBhNDZjMzZmYzAzZjk3ZDQzYWMzODlkYjY=", "commit": {"author": {"name": "Nick Cameron", "email": "ncameron@mozilla.com", "date": "2015-12-31T03:50:06Z"}, "committer": {"name": "Nick Cameron", "email": "ncameron@mozilla.com", "date": "2016-01-14T21:24:12Z"}, "message": "Add an --output option for specifying an error emitter", "tree": {"sha": "f119237ab574a412a5324902ecded9d8199d8f54", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f119237ab574a412a5324902ecded9d8199d8f54"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fd46c78f8f5bc760a46c36fc03f97d43ac389db6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fd46c78f8f5bc760a46c36fc03f97d43ac389db6", "html_url": "https://github.com/rust-lang/rust/commit/fd46c78f8f5bc760a46c36fc03f97d43ac389db6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fd46c78f8f5bc760a46c36fc03f97d43ac389db6/comments", "author": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "acfccc515bfbed098f46c6530d57aaef846b99ca", "url": "https://api.github.com/repos/rust-lang/rust/commits/acfccc515bfbed098f46c6530d57aaef846b99ca", "html_url": "https://github.com/rust-lang/rust/commit/acfccc515bfbed098f46c6530d57aaef846b99ca"}], "stats": {"total": 216, "additions": 135, "deletions": 81}, "files": [{"sha": "d7eacbfff90db6032a350216a64ac37c2f6b84fa", "filename": "src/librustc/lint/context.rs", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/fd46c78f8f5bc760a46c36fc03f97d43ac389db6/src%2Flibrustc%2Flint%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd46c78f8f5bc760a46c36fc03f97d43ac389db6/src%2Flibrustc%2Flint%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Flint%2Fcontext.rs?ref=fd46c78f8f5bc760a46c36fc03f97d43ac389db6", "patch": "@@ -28,7 +28,7 @@ use self::TargetLint::*;\n use dep_graph::DepNode;\n use middle::privacy::AccessLevels;\n use middle::ty;\n-use session::{early_error, Session};\n+use session::{config, early_error, Session};\n use lint::{Level, LevelSource, Lint, LintId, LintArray, LintPass};\n use lint::{EarlyLintPass, EarlyLintPassObject, LateLintPass, LateLintPassObject};\n use lint::{Default, CommandLine, Node, Allow, Warn, Deny, Forbid};\n@@ -37,11 +37,12 @@ use util::nodemap::FnvHashMap;\n \n use std::cell::RefCell;\n use std::cmp;\n+use std::default::Default as StdDefault;\n use std::mem;\n use syntax::ast_util::{self, IdVisitingOperation};\n use syntax::attr::{self, AttrMetaMethods};\n use syntax::codemap::Span;\n-use syntax::errors::{self, DiagnosticBuilder};\n+use syntax::errors::DiagnosticBuilder;\n use syntax::parse::token::InternedString;\n use syntax::ast;\n use syntax::attr::ThinAttributesExt;\n@@ -168,7 +169,7 @@ impl LintStore {\n                 match (sess, from_plugin) {\n                     // We load builtin lints first, so a duplicate is a compiler bug.\n                     // Use early_error when handling -W help with no crate.\n-                    (None, _) => early_error(errors::ColorConfig::Auto, &msg[..]),\n+                    (None, _) => early_error(config::ErrorOutputType::default(), &msg[..]),\n                     (Some(sess), false) => sess.bug(&msg[..]),\n \n                     // A duplicate name from a plugin is a user error.\n@@ -192,7 +193,7 @@ impl LintStore {\n             match (sess, from_plugin) {\n                 // We load builtin lints first, so a duplicate is a compiler bug.\n                 // Use early_error when handling -W help with no crate.\n-                (None, _) => early_error(errors::ColorConfig::Auto, &msg[..]),\n+                (None, _) => early_error(config::ErrorOutputType::default(), &msg[..]),\n                 (Some(sess), false) => sess.bug(&msg[..]),\n \n                 // A duplicate name from a plugin is a user error."}, {"sha": "6a7b411823ce9ed77a8b69b55fd6a7f9f2eaac90", "filename": "src/librustc/session/config.rs", "status": "modified", "additions": 74, "deletions": 36, "changes": 110, "blob_url": "https://github.com/rust-lang/rust/blob/fd46c78f8f5bc760a46c36fc03f97d43ac389db6/src%2Flibrustc%2Fsession%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd46c78f8f5bc760a46c36fc03f97d43ac389db6/src%2Flibrustc%2Fsession%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fsession%2Fconfig.rs?ref=fd46c78f8f5bc760a46c36fc03f97d43ac389db6", "patch": "@@ -14,7 +14,6 @@\n pub use self::EntryFnType::*;\n pub use self::CrateType::*;\n pub use self::Passes::*;\n-pub use self::OptLevel::*;\n pub use self::DebugInfoLevel::*;\n \n use session::{early_error, early_warn, Session};\n@@ -71,6 +70,18 @@ pub enum OutputType {\n     DepInfo,\n }\n \n+#[derive(Clone, Copy, Debug, PartialEq, Eq)]\n+pub enum ErrorOutputType {\n+    Tty(ColorConfig),\n+    Json,\n+}\n+\n+impl Default for ErrorOutputType {\n+    fn default() -> ErrorOutputType {\n+        ErrorOutputType::Tty(ColorConfig::Auto)\n+    }\n+}\n+\n impl OutputType {\n     fn is_compatible_with_codegen_units_and_single_output_file(&self) -> bool {\n         match *self {\n@@ -124,14 +135,14 @@ pub struct Options {\n     pub test: bool,\n     pub parse_only: bool,\n     pub no_trans: bool,\n+    pub output: ErrorOutputType,\n     pub treat_err_as_bug: bool,\n     pub incremental_compilation: bool,\n     pub dump_dep_graph: bool,\n     pub no_analysis: bool,\n     pub debugging_opts: DebuggingOptions,\n     pub prints: Vec<PrintRequest>,\n     pub cg: CodegenOptions,\n-    pub color: ColorConfig,\n     pub externs: HashMap<String, Vec<String>>,\n     pub crate_name: Option<String>,\n     /// An optional name to use as the crate for std during std injection,\n@@ -221,7 +232,7 @@ pub fn basic_options() -> Options {\n     Options {\n         crate_types: Vec::new(),\n         gc: false,\n-        optimize: No,\n+        optimize: OptLevel::No,\n         debuginfo: NoDebugInfo,\n         lint_opts: Vec::new(),\n         lint_cap: None,\n@@ -241,7 +252,12 @@ pub fn basic_options() -> Options {\n         debugging_opts: basic_debugging_options(),\n         prints: Vec::new(),\n         cg: basic_codegen_options(),\n+<<<<<<< HEAD\n         color: ColorConfig::Auto,\n+=======\n+        output: ErrorOutputType::default(),\n+        show_span: None,\n+>>>>>>> Add an --output option for specifying an error emitter\n         externs: HashMap::new(),\n         crate_name: None,\n         alt_std_name: None,\n@@ -308,7 +324,7 @@ macro_rules! options {\n         $struct_name { $($opt: $init),* }\n     }\n \n-    pub fn $buildfn(matches: &getopts::Matches, color: ColorConfig) -> $struct_name\n+    pub fn $buildfn(matches: &getopts::Matches, output: ErrorOutputType) -> $struct_name\n     {\n         let mut op = $defaultfn();\n         for option in matches.opt_strs($prefix) {\n@@ -322,17 +338,17 @@ macro_rules! options {\n                 if !setter(&mut op, value) {\n                     match (value, opt_type_desc) {\n                         (Some(..), None) => {\n-                            early_error(color, &format!(\"{} option `{}` takes no \\\n+                            early_error(output, &format!(\"{} option `{}` takes no \\\n                                                          value\", $outputname, key))\n                         }\n                         (None, Some(type_desc)) => {\n-                            early_error(color, &format!(\"{0} option `{1}` requires \\\n+                            early_error(output, &format!(\"{0} option `{1}` requires \\\n                                                          {2} ({3} {1}=<value>)\",\n                                                         $outputname, key,\n                                                         type_desc, $prefix))\n                         }\n                         (Some(value), Some(type_desc)) => {\n-                            early_error(color, &format!(\"incorrect value `{}` for {} \\\n+                            early_error(output, &format!(\"incorrect value `{}` for {} \\\n                                                          option `{}` - {} was expected\",\n                                                         value, $outputname,\n                                                         key, type_desc))\n@@ -344,7 +360,7 @@ macro_rules! options {\n                 break;\n             }\n             if !found {\n-                early_error(color, &format!(\"unknown {} option: `{}`\",\n+                early_error(output, &format!(\"unknown {} option: `{}`\",\n                                             $outputname, key));\n             }\n         }\n@@ -863,6 +879,7 @@ pub fn rustc_optgroups() -> Vec<RustcOptGroup> {\n                  \"NAME=PATH\"),\n         opt::opt(\"\", \"sysroot\", \"Override the system root\", \"PATH\"),\n         opt::multi(\"Z\", \"\", \"Set internal debugging options\", \"FLAG\"),\n+        opt::opt_u(\"\", \"output\", \"How errors and other mesasges are produced\", \"tty|json\"),\n         opt::opt(\"\", \"color\", \"Configure coloring of output:\n             auto   = colorize, if output goes to a tty (default);\n             always = always colorize output;\n@@ -905,15 +922,36 @@ pub fn build_session_options(matches: &getopts::Matches) -> Options {\n         None => ColorConfig::Auto,\n \n         Some(arg) => {\n-            early_error(ColorConfig::Auto, &format!(\"argument for --color must be auto, always \\\n-                                                     or never (instead was `{}`)\",\n-                                                    arg))\n+            early_error(ErrorOutputType::default(), &format!(\"argument for --color must be auto, \\\n+                                                              always or never (instead was `{}`)\",\n+                                                            arg))\n         }\n     };\n \n+    // We need the opts_present check because the driver will send us Matches\n+    // with only stable options if no unstable options are used. Since output is\n+    // unstable, it will not be present. We have to use opts_present not\n+    // opt_present because the latter will panic.\n+    let output = if matches.opts_present(&[\"output\".to_owned()]) {\n+        match matches.opt_str(\"output\").as_ref().map(|s| &s[..]) {\n+            Some(\"tty\")   => ErrorOutputType::Tty(color),\n+            Some(\"json\") => ErrorOutputType::Json,\n+\n+            None => ErrorOutputType::default(),\n+\n+            Some(arg) => {\n+                early_error(ErrorOutputType::default(), &format!(\"argument for --output must be tty or \\\n+                                                                  json (instead was `{}`)\",\n+                                                                 arg))\n+            }\n+        }\n+    } else {\n+        ErrorOutputType::default()\n+    };\n+\n     let unparsed_crate_types = matches.opt_strs(\"crate-type\");\n     let crate_types = parse_crate_types_from_list(unparsed_crate_types)\n-        .unwrap_or_else(|e| early_error(color, &e[..]));\n+        .unwrap_or_else(|e| early_error(output, &e[..]));\n \n     let mut lint_opts = vec!();\n     let mut describe_lints = false;\n@@ -930,11 +968,11 @@ pub fn build_session_options(matches: &getopts::Matches) -> Options {\n \n     let lint_cap = matches.opt_str(\"cap-lints\").map(|cap| {\n         lint::Level::from_str(&cap).unwrap_or_else(|| {\n-            early_error(color, &format!(\"unknown lint level: `{}`\", cap))\n+            early_error(output, &format!(\"unknown lint level: `{}`\", cap))\n         })\n     });\n \n-    let debugging_opts = build_debugging_options(matches, color);\n+    let debugging_opts = build_debugging_options(matches, output);\n \n     let parse_only = debugging_opts.parse_only;\n     let no_trans = debugging_opts.no_trans;\n@@ -960,7 +998,7 @@ pub fn build_session_options(matches: &getopts::Matches) -> Options {\n                     \"link\" => OutputType::Exe,\n                     \"dep-info\" => OutputType::DepInfo,\n                     part => {\n-                        early_error(color, &format!(\"unknown emission type: `{}`\",\n+                        early_error(output, &format!(\"unknown emission type: `{}`\",\n                                                     part))\n                     }\n                 };\n@@ -973,7 +1011,7 @@ pub fn build_session_options(matches: &getopts::Matches) -> Options {\n         output_types.insert(OutputType::Exe, None);\n     }\n \n-    let mut cg = build_codegen_options(matches, color);\n+    let mut cg = build_codegen_options(matches, output);\n \n     // Issue #30063: if user requests llvm-related output to one\n     // particular path, disable codegen-units.\n@@ -985,11 +1023,11 @@ pub fn build_session_options(matches: &getopts::Matches) -> Options {\n             }).collect();\n         if !incompatible.is_empty() {\n             for ot in &incompatible {\n-                early_warn(color, &format!(\"--emit={} with -o incompatible with \\\n+                early_warn(output, &format!(\"--emit={} with -o incompatible with \\\n                                             -C codegen-units=N for N > 1\",\n                                            ot.shorthand()));\n             }\n-            early_warn(color, \"resetting to default -C codegen-units=1\");\n+            early_warn(output, \"resetting to default -C codegen-units=1\");\n             cg.codegen_units = 1;\n         }\n     }\n@@ -1002,29 +1040,29 @@ pub fn build_session_options(matches: &getopts::Matches) -> Options {\n     let opt_level = {\n         if matches.opt_present(\"O\") {\n             if cg.opt_level.is_some() {\n-                early_error(color, \"-O and -C opt-level both provided\");\n+                early_error(output, \"-O and -C opt-level both provided\");\n             }\n-            Default\n+            OptLevel::Default\n         } else {\n             match cg.opt_level {\n-                None => No,\n-                Some(0) => No,\n-                Some(1) => Less,\n-                Some(2) => Default,\n-                Some(3) => Aggressive,\n+                None => OptLevel::No,\n+                Some(0) => OptLevel::No,\n+                Some(1) => OptLevel::Less,\n+                Some(2) => OptLevel::Default,\n+                Some(3) => OptLevel::Aggressive,\n                 Some(arg) => {\n-                    early_error(color, &format!(\"optimization level needs to be \\\n+                    early_error(output, &format!(\"optimization level needs to be \\\n                                                  between 0-3 (instead was `{}`)\",\n                                                 arg));\n                 }\n             }\n         }\n     };\n-    let debug_assertions = cg.debug_assertions.unwrap_or(opt_level == No);\n+    let debug_assertions = cg.debug_assertions.unwrap_or(opt_level == OptLevel::No);\n     let gc = debugging_opts.gc;\n     let debuginfo = if matches.opt_present(\"g\") {\n         if cg.debuginfo.is_some() {\n-            early_error(color, \"-g and -C debuginfo both provided\");\n+            early_error(output, \"-g and -C debuginfo both provided\");\n         }\n         FullDebugInfo\n     } else {\n@@ -1033,7 +1071,7 @@ pub fn build_session_options(matches: &getopts::Matches) -> Options {\n             Some(1) => LimitedDebugInfo,\n             Some(2) => FullDebugInfo,\n             Some(arg) => {\n-                early_error(color, &format!(\"debug info level needs to be between \\\n+                early_error(output, &format!(\"debug info level needs to be between \\\n                                              0-2 (instead was `{}`)\",\n                                             arg));\n             }\n@@ -1042,7 +1080,7 @@ pub fn build_session_options(matches: &getopts::Matches) -> Options {\n \n     let mut search_paths = SearchPaths::new();\n     for s in &matches.opt_strs(\"L\") {\n-        search_paths.add_path(&s[..], color);\n+        search_paths.add_path(&s[..], output);\n     }\n \n     let libs = matches.opt_strs(\"l\").into_iter().map(|s| {\n@@ -1054,7 +1092,7 @@ pub fn build_session_options(matches: &getopts::Matches) -> Options {\n             (Some(name), \"framework\") => (name, cstore::NativeFramework),\n             (Some(name), \"static\") => (name, cstore::NativeStatic),\n             (_, s) => {\n-                early_error(color, &format!(\"unknown library kind `{}`, expected \\\n+                early_error(output, &format!(\"unknown library kind `{}`, expected \\\n                                              one of dylib, framework, or static\",\n                                             s));\n             }\n@@ -1071,13 +1109,13 @@ pub fn build_session_options(matches: &getopts::Matches) -> Options {\n             \"file-names\" => PrintRequest::FileNames,\n             \"sysroot\" => PrintRequest::Sysroot,\n             req => {\n-                early_error(color, &format!(\"unknown print request `{}`\", req))\n+                early_error(output, &format!(\"unknown print request `{}`\", req))\n             }\n         }\n     }).collect::<Vec<_>>();\n \n     if !cg.remark.is_empty() && debuginfo == NoDebugInfo {\n-        early_warn(color, \"-C remark will not show source locations without \\\n+        early_warn(output, \"-C remark will not show source locations without \\\n                            --debuginfo\");\n     }\n \n@@ -1086,11 +1124,11 @@ pub fn build_session_options(matches: &getopts::Matches) -> Options {\n         let mut parts = arg.splitn(2, '=');\n         let name = match parts.next() {\n             Some(s) => s,\n-            None => early_error(color, \"--extern value must not be empty\"),\n+            None => early_error(output, \"--extern value must not be empty\"),\n         };\n         let location = match parts.next() {\n             Some(s) => s,\n-            None => early_error(color, \"--extern value must be of the format `foo=bar`\"),\n+            None => early_error(output, \"--extern value must be of the format `foo=bar`\"),\n         };\n \n         externs.entry(name.to_string()).or_insert(vec![]).push(location.to_string());\n@@ -1121,7 +1159,7 @@ pub fn build_session_options(matches: &getopts::Matches) -> Options {\n         debugging_opts: debugging_opts,\n         prints: prints,\n         cg: cg,\n-        color: color,\n+        output: output,\n         externs: externs,\n         crate_name: crate_name,\n         alt_std_name: None,"}, {"sha": "0abf8f28a80078ea8f1634df44d0dcb214f3b57d", "filename": "src/librustc/session/mod.rs", "status": "modified", "additions": 24, "deletions": 10, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/fd46c78f8f5bc760a46c36fc03f97d43ac389db6/src%2Flibrustc%2Fsession%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd46c78f8f5bc760a46c36fc03f97d43ac389db6/src%2Flibrustc%2Fsession%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fsession%2Fmod.rs?ref=fd46c78f8f5bc760a46c36fc03f97d43ac389db6", "patch": "@@ -17,7 +17,8 @@ use util::nodemap::{NodeMap, FnvHashMap};\n use syntax::ast::{NodeId, NodeIdAssigner, Name};\n use syntax::codemap::Span;\n use syntax::errors::{self, DiagnosticBuilder};\n-use syntax::errors::emitter::{Emitter, BasicEmitter};\n+use syntax::errors::emitter::{Emitter, BasicEmitter, EmitterWriter};\n+use syntax::errors::json::JsonEmitter;\n use syntax::diagnostics;\n use syntax::feature_gate;\n use syntax::parse;\n@@ -405,12 +406,19 @@ pub fn build_session(sopts: config::Options,\n     let treat_err_as_bug = sopts.treat_err_as_bug;\n \n     let codemap = Rc::new(codemap::CodeMap::new());\n+    let emitter: Box<Emitter> = match sopts.output {\n+        config::ErrorOutputType::Tty(color_config) => {\n+            Box::new(EmitterWriter::stderr(color_config, Some(registry), codemap.clone()))\n+        }\n+        config::ErrorOutputType::Json => {\n+            Box::new(JsonEmitter::stderr(Some(registry), codemap.clone()))\n+        }\n+    };\n+\n     let diagnostic_handler =\n-        errors::Handler::new(sopts.color,\n-                             Some(registry),\n-                             can_print_warnings,\n-                             treat_err_as_bug,\n-                             codemap.clone());\n+        errors::Handler::with_emitter(can_print_warnings,\n+                                      treat_err_as_bug,\n+                                      emitter);\n \n     build_session_(sopts, local_crate_source_file, diagnostic_handler, codemap, cstore)\n }\n@@ -473,13 +481,19 @@ pub fn build_session_(sopts: config::Options,\n     sess\n }\n \n-pub fn early_error(color: errors::ColorConfig, msg: &str) -> ! {\n-    let mut emitter = BasicEmitter::stderr(color);\n+pub fn early_error(output: config::ErrorOutputType, msg: &str) -> ! {\n+    let mut emitter: Box<Emitter> = match output {\n+        config::ErrorOutputType::Tty(color_config) => Box::new(BasicEmitter::stderr(color_config)),\n+        config::ErrorOutputType::Json => Box::new(JsonEmitter::basic()),\n+    };\n     emitter.emit(None, msg, None, errors::Level::Fatal);\n     panic!(errors::FatalError);\n }\n \n-pub fn early_warn(color: errors::ColorConfig, msg: &str) {\n-    let mut emitter = BasicEmitter::stderr(color);\n+pub fn early_warn(output: config::ErrorOutputType, msg: &str) {\n+    let mut emitter: Box<Emitter> = match output {\n+        config::ErrorOutputType::Tty(color_config) => Box::new(BasicEmitter::stderr(color_config)),\n+        config::ErrorOutputType::Json => Box::new(JsonEmitter::basic()),\n+    };\n     emitter.emit(None, msg, None, errors::Level::Warning);\n }"}, {"sha": "3c6cd26bef6ce87bfc853f040abae95d848a14a2", "filename": "src/librustc/session/search_paths.rs", "status": "modified", "additions": 3, "deletions": 4, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/fd46c78f8f5bc760a46c36fc03f97d43ac389db6/src%2Flibrustc%2Fsession%2Fsearch_paths.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd46c78f8f5bc760a46c36fc03f97d43ac389db6/src%2Flibrustc%2Fsession%2Fsearch_paths.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fsession%2Fsearch_paths.rs?ref=fd46c78f8f5bc760a46c36fc03f97d43ac389db6", "patch": "@@ -10,8 +10,7 @@\n \n use std::slice;\n use std::path::{Path, PathBuf};\n-use session::early_error;\n-use syntax::errors;\n+use session::{early_error, config};\n \n #[derive(Clone, Debug)]\n pub struct SearchPaths {\n@@ -38,7 +37,7 @@ impl SearchPaths {\n         SearchPaths { paths: Vec::new() }\n     }\n \n-    pub fn add_path(&mut self, path: &str, color: errors::ColorConfig) {\n+    pub fn add_path(&mut self, path: &str, output: config::ErrorOutputType) {\n         let (kind, path) = if path.starts_with(\"native=\") {\n             (PathKind::Native, &path[\"native=\".len()..])\n         } else if path.starts_with(\"crate=\") {\n@@ -53,7 +52,7 @@ impl SearchPaths {\n             (PathKind::All, path)\n         };\n         if path.is_empty() {\n-            early_error(color, \"empty search path given via `-L`\");\n+            early_error(output, \"empty search path given via `-L`\");\n         }\n         self.paths.push((kind, PathBuf::from(path)));\n     }"}, {"sha": "f3fe7b116e6bfebb2b119d92822950f5a92b8230", "filename": "src/librustc_driver/lib.rs", "status": "modified", "additions": 12, "deletions": 11, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/fd46c78f8f5bc760a46c36fc03f97d43ac389db6/src%2Flibrustc_driver%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd46c78f8f5bc760a46c36fc03f97d43ac389db6/src%2Flibrustc_driver%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_driver%2Flib.rs?ref=fd46c78f8f5bc760a46c36fc03f97d43ac389db6", "patch": "@@ -62,7 +62,7 @@ use rustc_resolve as resolve;\n use rustc_trans::back::link;\n use rustc_trans::save;\n use rustc::session::{config, Session, build_session};\n-use rustc::session::config::{Input, PrintRequest, OutputType};\n+use rustc::session::config::{Input, PrintRequest, OutputType, ErrorOutputType};\n use rustc::middle::cstore::CrateStore;\n use rustc::lint::Lint;\n use rustc::lint;\n@@ -72,6 +72,7 @@ use rustc::util::common::time;\n \n use std::cmp::max;\n use std::cmp::Ordering::Equal;\n+use std::default::Default;\n use std::env;\n use std::io::{self, Read, Write};\n use std::iter::repeat;\n@@ -126,7 +127,7 @@ pub fn run_compiler<'a>(args: &[String], callbacks: &mut CompilerCalls<'a>) {\n \n     let descriptions = diagnostics_registry();\n \n-    do_or_return!(callbacks.early_callback(&matches, &descriptions, sopts.color));\n+    do_or_return!(callbacks.early_callback(&matches, &descriptions, sopts.output));\n \n     let (odir, ofile) = make_output(&matches);\n     let (input, input_file_path) = match make_input(&matches.free) {\n@@ -214,7 +215,7 @@ pub trait CompilerCalls<'a> {\n     fn early_callback(&mut self,\n                       _: &getopts::Matches,\n                       _: &diagnostics::registry::Registry,\n-                      _: errors::ColorConfig)\n+                      _: ErrorOutputType)\n                       -> Compilation {\n         Compilation::Continue\n     }\n@@ -290,7 +291,7 @@ impl<'a> CompilerCalls<'a> for RustcDefaultCalls {\n     fn early_callback(&mut self,\n                       matches: &getopts::Matches,\n                       descriptions: &diagnostics::registry::Registry,\n-                      color: errors::ColorConfig)\n+                      output: ErrorOutputType)\n                       -> Compilation {\n         match matches.opt_str(\"explain\") {\n             Some(ref code) => {\n@@ -305,7 +306,7 @@ impl<'a> CompilerCalls<'a> for RustcDefaultCalls {\n                         print!(\"{}\", &description[1..]);\n                     }\n                     None => {\n-                        early_error(color, &format!(\"no extended information for {}\", code));\n+                        early_error(output, &format!(\"no extended information for {}\", code));\n                     }\n                 }\n                 return Compilation::Stop;\n@@ -339,10 +340,10 @@ impl<'a> CompilerCalls<'a> for RustcDefaultCalls {\n                 if should_stop == Compilation::Stop {\n                     return None;\n                 }\n-                early_error(sopts.color, \"no input filename given\");\n+                early_error(sopts.output, \"no input filename given\");\n             }\n             1 => panic!(\"make_input should have provided valid inputs\"),\n-            _ => early_error(sopts.color, \"multiple input filenames provided\"),\n+            _ => early_error(sopts.output, \"multiple input filenames provided\"),\n         }\n \n         None\n@@ -432,7 +433,7 @@ impl RustcDefaultCalls {\n                     println!(\"{}\", String::from_utf8(v).unwrap());\n                 }\n                 &Input::Str(_) => {\n-                    early_error(sess.opts.color, \"cannot list metadata for stdin\");\n+                    early_error(ErrorOutputType::default(), \"cannot list metadata for stdin\");\n                 }\n             }\n             return Compilation::Stop;\n@@ -459,7 +460,7 @@ impl RustcDefaultCalls {\n                 PrintRequest::CrateName => {\n                     let input = match input {\n                         Some(input) => input,\n-                        None => early_error(sess.opts.color, \"no input file provided\"),\n+                        None => early_error(ErrorOutputType::default(), \"no input file provided\"),\n                     };\n                     let attrs = attrs.as_ref().unwrap();\n                     let t_outputs = driver::build_output_filenames(input, odir, ofile, attrs, sess);\n@@ -752,7 +753,7 @@ pub fn handle_options(mut args: Vec<String>) -> Option<getopts::Matches> {\n                             &opt.opt_group.short_name\n                         };\n                         if m.opt_present(opt_name) {\n-                            early_error(errors::ColorConfig::Auto,\n+                            early_error(ErrorOutputType::default(),\n                                         &format!(\"use of unstable option '{}' requires -Z \\\n                                                   unstable-options\",\n                                                  opt_name));\n@@ -761,7 +762,7 @@ pub fn handle_options(mut args: Vec<String>) -> Option<getopts::Matches> {\n                 }\n                 m\n             }\n-            Err(f) => early_error(errors::ColorConfig::Auto, &f.to_string()),\n+            Err(f) => early_error(ErrorOutputType::default(), &f.to_string()),\n         }\n     }\n "}, {"sha": "2450414d8b67e6407abbafb6415236da19480c07", "filename": "src/librustc_trans/back/linker.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/fd46c78f8f5bc760a46c36fc03f97d43ac389db6/src%2Flibrustc_trans%2Fback%2Flinker.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd46c78f8f5bc760a46c36fc03f97d43ac389db6/src%2Flibrustc_trans%2Fback%2Flinker.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Fback%2Flinker.rs?ref=fd46c78f8f5bc760a46c36fc03f97d43ac389db6", "patch": "@@ -149,8 +149,8 @@ impl<'a> Linker for GnuLinker<'a> {\n \n         // GNU-style linkers support optimization with -O. GNU ld doesn't\n         // need a numeric argument, but other linkers do.\n-        if self.sess.opts.optimize == config::Default ||\n-           self.sess.opts.optimize == config::Aggressive {\n+        if self.sess.opts.optimize == config::OptLevel::Default ||\n+           self.sess.opts.optimize == config::OptLevel::Aggressive {\n             self.cmd.arg(\"-Wl,-O1\");\n         }\n     }"}, {"sha": "544df1798eaf93e48dc1a288c75ce74b087661a4", "filename": "src/librustc_trans/back/write.rs", "status": "modified", "additions": 9, "deletions": 9, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/fd46c78f8f5bc760a46c36fc03f97d43ac389db6/src%2Flibrustc_trans%2Fback%2Fwrite.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd46c78f8f5bc760a46c36fc03f97d43ac389db6/src%2Flibrustc_trans%2Fback%2Fwrite.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Fback%2Fwrite.rs?ref=fd46c78f8f5bc760a46c36fc03f97d43ac389db6", "patch": "@@ -144,10 +144,10 @@ fn target_feature(sess: &Session) -> String {\n \n fn get_llvm_opt_level(optimize: config::OptLevel) -> llvm::CodeGenOptLevel {\n     match optimize {\n-      config::No => llvm::CodeGenLevelNone,\n-      config::Less => llvm::CodeGenLevelLess,\n-      config::Default => llvm::CodeGenLevelDefault,\n-      config::Aggressive => llvm::CodeGenLevelAggressive,\n+      config::OptLevel::No => llvm::CodeGenLevelNone,\n+      config::OptLevel::Less => llvm::CodeGenLevelLess,\n+      config::OptLevel::Default => llvm::CodeGenLevelDefault,\n+      config::OptLevel::Aggressive => llvm::CodeGenLevelAggressive,\n     }\n }\n \n@@ -303,13 +303,13 @@ impl ModuleConfig {\n         // slp vectorization at O3. Otherwise configure other optimization aspects\n         // of this pass manager builder.\n         self.vectorize_loop = !sess.opts.cg.no_vectorize_loops &&\n-                             (sess.opts.optimize == config::Default ||\n-                              sess.opts.optimize == config::Aggressive);\n+                             (sess.opts.optimize == config::OptLevel::Default ||\n+                              sess.opts.optimize == config::OptLevel::Aggressive);\n         self.vectorize_slp = !sess.opts.cg.no_vectorize_slp &&\n-                            sess.opts.optimize == config::Aggressive;\n+                            sess.opts.optimize == config::OptLevel::Aggressive;\n \n-        self.merge_functions = sess.opts.optimize == config::Default ||\n-                               sess.opts.optimize == config::Aggressive;\n+        self.merge_functions = sess.opts.optimize == config::OptLevel::Default ||\n+                               sess.opts.optimize == config::OptLevel::Aggressive;\n     }\n }\n "}, {"sha": "ea4259f8262a7b484c38314b0b12e0b5aa2a9934", "filename": "src/librustc_trans/trans/base.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/fd46c78f8f5bc760a46c36fc03f97d43ac389db6/src%2Flibrustc_trans%2Ftrans%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd46c78f8f5bc760a46c36fc03f97d43ac389db6/src%2Flibrustc_trans%2Ftrans%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Ftrans%2Fbase.rs?ref=fd46c78f8f5bc760a46c36fc03f97d43ac389db6", "patch": "@@ -1163,7 +1163,7 @@ fn core_lifetime_emit<'blk, 'tcx, F>(ccx: &'blk CrateContext<'blk, 'tcx>,\n                                      emit: F)\n     where F: FnOnce(&'blk CrateContext<'blk, 'tcx>, machine::llsize, ValueRef)\n {\n-    if ccx.sess().opts.optimize == config::No {\n+    if ccx.sess().opts.optimize == config::OptLevel::No {\n         return;\n     }\n "}, {"sha": "d90acd78147c974d7428e721449be9881a582a29", "filename": "src/librustc_trans/trans/debuginfo/metadata.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/fd46c78f8f5bc760a46c36fc03f97d43ac389db6/src%2Flibrustc_trans%2Ftrans%2Fdebuginfo%2Fmetadata.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd46c78f8f5bc760a46c36fc03f97d43ac389db6/src%2Flibrustc_trans%2Ftrans%2Fdebuginfo%2Fmetadata.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Ftrans%2Fdebuginfo%2Fmetadata.rs?ref=fd46c78f8f5bc760a46c36fc03f97d43ac389db6", "patch": "@@ -1020,7 +1020,7 @@ pub fn compile_unit_metadata(cx: &CrateContext) -> DIDescriptor {\n             compile_unit_name,\n             work_dir.as_ptr(),\n             producer.as_ptr(),\n-            cx.sess().opts.optimize != config::No,\n+            cx.sess().opts.optimize != config::OptLevel::No,\n             flags.as_ptr() as *const _,\n             0,\n             split_name.as_ptr() as *const _)"}, {"sha": "5e11a50be22735f00e2195c43a4df658e10493e5", "filename": "src/librustc_trans/trans/debuginfo/mod.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/fd46c78f8f5bc760a46c36fc03f97d43ac389db6/src%2Flibrustc_trans%2Ftrans%2Fdebuginfo%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd46c78f8f5bc760a46c36fc03f97d43ac389db6/src%2Flibrustc_trans%2Ftrans%2Fdebuginfo%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Ftrans%2Fdebuginfo%2Fmod.rs?ref=fd46c78f8f5bc760a46c36fc03f97d43ac389db6", "patch": "@@ -383,7 +383,7 @@ pub fn create_function_debug_context<'a, 'tcx>(cx: &CrateContext<'a, 'tcx>,\n             true,\n             scope_line as c_uint,\n             FlagPrototyped as c_uint,\n-            cx.sess().opts.optimize != config::No,\n+            cx.sess().opts.optimize != config::OptLevel::No,\n             llfn,\n             template_parameters,\n             ptr::null_mut())\n@@ -596,7 +596,7 @@ fn declare_local<'blk, 'tcx>(bcx: Block<'blk, 'tcx>,\n                     file_metadata,\n                     loc.line as c_uint,\n                     type_metadata,\n-                    cx.sess().opts.optimize != config::No,\n+                    cx.sess().opts.optimize != config::OptLevel::No,\n                     0,\n                     address_operations.as_ptr(),\n                     address_operations.len() as c_uint,"}, {"sha": "c21bf1e6a1fa04abaf1033296f2209de5de9138f", "filename": "src/libsyntax/errors/emitter.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/fd46c78f8f5bc760a46c36fc03f97d43ac389db6/src%2Flibsyntax%2Ferrors%2Femitter.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd46c78f8f5bc760a46c36fc03f97d43ac389db6/src%2Flibsyntax%2Ferrors%2Femitter.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Ferrors%2Femitter.rs?ref=fd46c78f8f5bc760a46c36fc03f97d43ac389db6", "patch": "@@ -43,7 +43,7 @@ pub trait Emitter {\n /// maximum number of lines we will print for each error; arbitrary.\n const MAX_LINES: usize = 6;\n \n-#[derive(Clone, Copy)]\n+#[derive(Clone, Copy, Debug, PartialEq, Eq)]\n pub enum ColorConfig {\n     Auto,\n     Always,"}, {"sha": "68f8caf755aa6c0563230bfe996f12280e9d4809", "filename": "src/libsyntax/errors/mod.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/fd46c78f8f5bc760a46c36fc03f97d43ac389db6/src%2Flibsyntax%2Ferrors%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd46c78f8f5bc760a46c36fc03f97d43ac389db6/src%2Flibsyntax%2Ferrors%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Ferrors%2Fmod.rs?ref=fd46c78f8f5bc760a46c36fc03f97d43ac389db6", "patch": "@@ -276,6 +276,7 @@ pub struct Handler {\n }\n \n impl Handler {\n+    // TODO remove\n     pub fn new(color_config: ColorConfig,\n                registry: Option<diagnostics::registry::Registry>,\n                can_emit_warnings: bool,"}]}