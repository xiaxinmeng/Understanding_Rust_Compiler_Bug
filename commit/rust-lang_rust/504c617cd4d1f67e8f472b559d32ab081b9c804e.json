{"sha": "504c617cd4d1f67e8f472b559d32ab081b9c804e", "node_id": "MDY6Q29tbWl0NzI0NzEyOjUwNGM2MTdjZDRkMWY2N2U4ZjQ3MmI1NTlkMzJhYjA4MWI5YzgwNGU=", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2020-09-09T07:18:10Z"}, "committer": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2020-09-17T15:33:47Z"}, "message": "test reading from stdin", "tree": {"sha": "2164e665b6a5af2485cfa81833d1fd9e20a14748", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2164e665b6a5af2485cfa81833d1fd9e20a14748"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/504c617cd4d1f67e8f472b559d32ab081b9c804e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/504c617cd4d1f67e8f472b559d32ab081b9c804e", "html_url": "https://github.com/rust-lang/rust/commit/504c617cd4d1f67e8f472b559d32ab081b9c804e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/504c617cd4d1f67e8f472b559d32ab081b9c804e/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "74fdb5cf2cbd069ad2890ee642d66fc59b3ddc0e", "url": "https://api.github.com/repos/rust-lang/rust/commits/74fdb5cf2cbd069ad2890ee642d66fc59b3ddc0e", "html_url": "https://github.com/rust-lang/rust/commit/74fdb5cf2cbd069ad2890ee642d66fc59b3ddc0e"}], "stats": {"total": 40, "additions": 30, "deletions": 10}, "files": [{"sha": "877a2a5706196e3d9864c6600aa21b4c0f8c0dba", "filename": "test-cargo-miri/run-test.py", "status": "modified", "additions": 9, "deletions": 10, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/504c617cd4d1f67e8f472b559d32ab081b9c804e/test-cargo-miri%2Frun-test.py", "raw_url": "https://github.com/rust-lang/rust/raw/504c617cd4d1f67e8f472b559d32ab081b9c804e/test-cargo-miri%2Frun-test.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/test-cargo-miri%2Frun-test.py?ref=504c617cd4d1f67e8f472b559d32ab081b9c804e", "patch": "@@ -21,18 +21,19 @@ def cargo_miri(cmd):\n         args += [\"--target\", os.environ['MIRI_TEST_TARGET']]\n     return args\n \n-def test(name, cmd, stdout_ref, stderr_ref, env={}):\n+def test(name, cmd, stdout_ref, stderr_ref, stdin=b'', env={}):\n     print(\"==> Testing `{}` <==\".format(name))\n     ## Call `cargo miri`, capture all output\n     p_env = os.environ.copy()\n     p_env.update(env)\n     p = subprocess.Popen(\n         cmd,\n+        stdin=subprocess.PIPE,\n         stdout=subprocess.PIPE,\n         stderr=subprocess.PIPE,\n         env=p_env,\n     )\n-    (stdout, stderr) = p.communicate()\n+    (stdout, stderr) = p.communicate(input=stdin)\n     stdout = stdout.decode(\"UTF-8\")\n     stderr = stderr.decode(\"UTF-8\")\n     # Show output\n@@ -51,15 +52,13 @@ def test(name, cmd, stdout_ref, stderr_ref, env={}):\n def test_cargo_miri_run():\n     test(\"cargo miri run\",\n         cargo_miri(\"run\"),\n-        \"stdout.ref\", \"stderr.ref\"\n-    )\n-    test(\"cargo miri run (with target)\",\n-        cargo_miri(\"run\") + [\"--bin\", \"cargo-miri-test\"],\n-        \"stdout.ref\", \"stderr.ref\"\n+        \"stdout.ref\", \"stderr.ref\",\n+        stdin=b'12\\n21\\n',\n+        env={'MIRIFLAGS': \"-Zmiri-disable-isolation\"},\n     )\n-    test(\"cargo miri run (with arguments)\",\n-        cargo_miri(\"run\") + [\"--\", \"hello world\", '\"hello world\"'],\n-        \"stdout.ref\", \"stderr.ref2\"\n+    test(\"cargo miri run (with arguments and target)\",\n+        cargo_miri(\"run\") + [\"--bin\", \"cargo-miri-test\", \"--\", \"hello world\", '\"hello world\"'],\n+        \"stdout.ref2\", \"stderr.ref2\"\n     )\n \n def test_cargo_miri_test():"}, {"sha": "0079328ff6059712f5e658dc14d3bb1d3eb0a48d", "filename": "test-cargo-miri/src/main.rs", "status": "modified", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/504c617cd4d1f67e8f472b559d32ab081b9c804e/test-cargo-miri%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/504c617cd4d1f67e8f472b559d32ab081b9c804e/test-cargo-miri%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/test-cargo-miri%2Fsrc%2Fmain.rs?ref=504c617cd4d1f67e8f472b559d32ab081b9c804e", "patch": "@@ -1,4 +1,6 @@\n use byteorder::{BigEndian, ByteOrder};\n+#[cfg(unix)]\n+use std::io::{self, BufRead};\n \n fn main() {\n     // Exercise external crate, printing to stdout.\n@@ -11,6 +13,22 @@ fn main() {\n     for arg in std::env::args() {\n         eprintln!(\"{}\", arg);\n     }\n+\n+    // If there were no arguments, access stdin.\n+    if std::env::args().len() <= 1 {\n+        #[cfg(unix)]\n+        for line in io::stdin().lock().lines() {\n+            let num: i32 = line.unwrap().parse().unwrap();\n+            println!(\"{}\", 2*num);\n+        }\n+        // On non-Unix, reading from stdin is not support. So we hard-code the right answer.\n+        #[cfg(not(unix))]\n+        {\n+            println!(\"24\");\n+            println!(\"42\");\n+        }\n+    }\n+\n }\n \n #[cfg(test)]"}, {"sha": "2eab8df967d5fc613a3085920c1a0cc81971da78", "filename": "test-cargo-miri/stdout.ref", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/504c617cd4d1f67e8f472b559d32ab081b9c804e/test-cargo-miri%2Fstdout.ref", "raw_url": "https://github.com/rust-lang/rust/raw/504c617cd4d1f67e8f472b559d32ab081b9c804e/test-cargo-miri%2Fstdout.ref", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/test-cargo-miri%2Fstdout.ref?ref=504c617cd4d1f67e8f472b559d32ab081b9c804e", "patch": "@@ -1 +1,3 @@\n 0x01020304\n+24\n+42"}, {"sha": "6710f307cb26daf260543237456b7d44fa2998ab", "filename": "test-cargo-miri/stdout.ref2", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/504c617cd4d1f67e8f472b559d32ab081b9c804e/test-cargo-miri%2Fstdout.ref2", "raw_url": "https://github.com/rust-lang/rust/raw/504c617cd4d1f67e8f472b559d32ab081b9c804e/test-cargo-miri%2Fstdout.ref2", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/test-cargo-miri%2Fstdout.ref2?ref=504c617cd4d1f67e8f472b559d32ab081b9c804e", "patch": "@@ -0,0 +1 @@\n+0x01020304"}]}