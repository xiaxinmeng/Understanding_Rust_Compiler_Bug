{"sha": "63ed2f9eb4a787abdd8c50773f3ef9cc8a5cb724", "node_id": "MDY6Q29tbWl0NzI0NzEyOjYzZWQyZjllYjRhNzg3YWJkZDhjNTA3NzNmM2VmOWNjOGE1Y2I3MjQ=", "commit": {"author": {"name": "F3real", "email": "stefan92ff@yandex.com", "date": "2021-09-17T22:56:14Z"}, "committer": {"name": "F3real", "email": "stefan92ff@yandex.com", "date": "2021-09-20T08:23:55Z"}, "message": "Expand BOX_VEC to BOX_COLLECTION", "tree": {"sha": "3eb56209d35edda6a40b9ef4f49b94adafc0f254", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3eb56209d35edda6a40b9ef4f49b94adafc0f254"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/63ed2f9eb4a787abdd8c50773f3ef9cc8a5cb724", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/63ed2f9eb4a787abdd8c50773f3ef9cc8a5cb724", "html_url": "https://github.com/rust-lang/rust/commit/63ed2f9eb4a787abdd8c50773f3ef9cc8a5cb724", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/63ed2f9eb4a787abdd8c50773f3ef9cc8a5cb724/comments", "author": {"login": "F3real", "id": 7493206, "node_id": "MDQ6VXNlcjc0OTMyMDY=", "avatar_url": "https://avatars.githubusercontent.com/u/7493206?v=4", "gravatar_id": "", "url": "https://api.github.com/users/F3real", "html_url": "https://github.com/F3real", "followers_url": "https://api.github.com/users/F3real/followers", "following_url": "https://api.github.com/users/F3real/following{/other_user}", "gists_url": "https://api.github.com/users/F3real/gists{/gist_id}", "starred_url": "https://api.github.com/users/F3real/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/F3real/subscriptions", "organizations_url": "https://api.github.com/users/F3real/orgs", "repos_url": "https://api.github.com/users/F3real/repos", "events_url": "https://api.github.com/users/F3real/events{/privacy}", "received_events_url": "https://api.github.com/users/F3real/received_events", "type": "User", "site_admin": false}, "committer": {"login": "F3real", "id": 7493206, "node_id": "MDQ6VXNlcjc0OTMyMDY=", "avatar_url": "https://avatars.githubusercontent.com/u/7493206?v=4", "gravatar_id": "", "url": "https://api.github.com/users/F3real", "html_url": "https://github.com/F3real", "followers_url": "https://api.github.com/users/F3real/followers", "following_url": "https://api.github.com/users/F3real/following{/other_user}", "gists_url": "https://api.github.com/users/F3real/gists{/gist_id}", "starred_url": "https://api.github.com/users/F3real/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/F3real/subscriptions", "organizations_url": "https://api.github.com/users/F3real/orgs", "repos_url": "https://api.github.com/users/F3real/repos", "events_url": "https://api.github.com/users/F3real/events{/privacy}", "received_events_url": "https://api.github.com/users/F3real/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "871ad80bb02af6d8fbf3f5c7291916b817c75168", "url": "https://api.github.com/repos/rust-lang/rust/commits/871ad80bb02af6d8fbf3f5c7291916b817c75168", "html_url": "https://github.com/rust-lang/rust/commit/871ad80bb02af6d8fbf3f5c7291916b817c75168"}], "stats": {"total": 145, "additions": 97, "deletions": 48}, "files": [{"sha": "eff73d1fae8a5a044fc6feb24dedb889bf313171", "filename": "CHANGELOG.md", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/63ed2f9eb4a787abdd8c50773f3ef9cc8a5cb724/CHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/63ed2f9eb4a787abdd8c50773f3ef9cc8a5cb724/CHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/CHANGELOG.md?ref=63ed2f9eb4a787abdd8c50773f3ef9cc8a5cb724", "patch": "@@ -2570,7 +2570,7 @@ Released 2018-09-13\n [`bool_comparison`]: https://rust-lang.github.io/rust-clippy/master/index.html#bool_comparison\n [`borrow_interior_mutable_const`]: https://rust-lang.github.io/rust-clippy/master/index.html#borrow_interior_mutable_const\n [`borrowed_box`]: https://rust-lang.github.io/rust-clippy/master/index.html#borrowed_box\n-[`box_vec`]: https://rust-lang.github.io/rust-clippy/master/index.html#box_vec\n+[`box_collection`]: https://rust-lang.github.io/rust-clippy/master/index.html#box_collection\n [`boxed_local`]: https://rust-lang.github.io/rust-clippy/master/index.html#boxed_local\n [`branches_sharing_code`]: https://rust-lang.github.io/rust-clippy/master/index.html#branches_sharing_code\n [`builtin_type_shadow`]: https://rust-lang.github.io/rust-clippy/master/index.html#builtin_type_shadow"}, {"sha": "fdbaccef53bda19bad58996a4093876cce8e4854", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/63ed2f9eb4a787abdd8c50773f3ef9cc8a5cb724/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/63ed2f9eb4a787abdd8c50773f3ef9cc8a5cb724/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=63ed2f9eb4a787abdd8c50773f3ef9cc8a5cb724", "patch": "@@ -956,7 +956,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n         transmuting_null::TRANSMUTING_NULL,\n         try_err::TRY_ERR,\n         types::BORROWED_BOX,\n-        types::BOX_VEC,\n+        types::BOX_COLLECTION,\n         types::LINKEDLIST,\n         types::OPTION_OPTION,\n         types::RC_BUFFER,\n@@ -1454,7 +1454,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n         LintId::of(transmuting_null::TRANSMUTING_NULL),\n         LintId::of(try_err::TRY_ERR),\n         LintId::of(types::BORROWED_BOX),\n-        LintId::of(types::BOX_VEC),\n+        LintId::of(types::BOX_COLLECTION),\n         LintId::of(types::REDUNDANT_ALLOCATION),\n         LintId::of(types::TYPE_COMPLEXITY),\n         LintId::of(types::VEC_BOX),\n@@ -1792,7 +1792,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n         LintId::of(redundant_clone::REDUNDANT_CLONE),\n         LintId::of(slow_vector_initialization::SLOW_VECTOR_INITIALIZATION),\n         LintId::of(stable_sort_primitive::STABLE_SORT_PRIMITIVE),\n-        LintId::of(types::BOX_VEC),\n+        LintId::of(types::BOX_COLLECTION),\n         LintId::of(types::REDUNDANT_ALLOCATION),\n         LintId::of(vec::USELESS_VEC),\n         LintId::of(vec_init_then_push::VEC_INIT_THEN_PUSH),"}, {"sha": "718aea471d9ce1a00969b527327791fbb4bec7b6", "filename": "clippy_lints/src/types/box_collection.rs", "status": "added", "additions": 50, "deletions": 0, "changes": 50, "blob_url": "https://github.com/rust-lang/rust/blob/63ed2f9eb4a787abdd8c50773f3ef9cc8a5cb724/clippy_lints%2Fsrc%2Ftypes%2Fbox_collection.rs", "raw_url": "https://github.com/rust-lang/rust/raw/63ed2f9eb4a787abdd8c50773f3ef9cc8a5cb724/clippy_lints%2Fsrc%2Ftypes%2Fbox_collection.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Ftypes%2Fbox_collection.rs?ref=63ed2f9eb4a787abdd8c50773f3ef9cc8a5cb724", "patch": "@@ -0,0 +1,50 @@\n+use clippy_utils::diagnostics::span_lint_and_help;\n+use clippy_utils::is_ty_param_diagnostic_item;\n+use rustc_hir::{self as hir, def_id::DefId, QPath};\n+use rustc_lint::LateContext;\n+use rustc_span::symbol::sym;\n+\n+use super::BOX_COLLECTION;\n+\n+pub(super) fn check(cx: &LateContext<'_>, hir_ty: &hir::Ty<'_>, qpath: &QPath<'_>, def_id: DefId) -> bool {\n+    if_chain! {\n+        if Some(def_id) == cx.tcx.lang_items().owned_box();\n+        if let Some(item_type) = get_std_collection(cx, qpath);\n+        then {\n+            let generic = if item_type == \"String\" {\n+                \"\"\n+            } else {\n+                \"<..>\"\n+            };\n+            span_lint_and_help(\n+                cx,\n+                BOX_COLLECTION,\n+                hir_ty.span,\n+                &format!(\n+                    \"you seem to be trying to use `Box<{outer}{generic}>`. Consider using just `{outer}{generic}`\",\n+                    outer=item_type,\n+                    generic = generic),\n+                None,\n+                &format!(\n+                    \"`{outer}{generic}` is already on the heap, `Box<{outer}{generic}>` makes an extra allocation\",\n+                    outer=item_type,\n+                    generic = generic)\n+            );\n+            true\n+        } else {\n+            false\n+        }\n+    }\n+}\n+\n+fn get_std_collection(cx: &LateContext<'_>, qpath: &QPath<'_>) -> Option<String> {\n+    if is_ty_param_diagnostic_item(cx, qpath, sym::vec_type).is_some() {\n+        Some(String::from(\"Vec\"))\n+    } else if is_ty_param_diagnostic_item(cx, qpath, sym::string_type).is_some() {\n+        Some(String::from(\"String\"))\n+    } else if is_ty_param_diagnostic_item(cx, qpath, sym::hashmap_type).is_some() {\n+        Some(String::from(\"HashMap\"))\n+    } else {\n+        None\n+    }\n+}"}, {"sha": "d8b1953457ccc961f4803370e7195540ee168ca3", "filename": "clippy_lints/src/types/box_vec.rs", "status": "removed", "additions": 0, "deletions": 25, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/871ad80bb02af6d8fbf3f5c7291916b817c75168/clippy_lints%2Fsrc%2Ftypes%2Fbox_vec.rs", "raw_url": "https://github.com/rust-lang/rust/raw/871ad80bb02af6d8fbf3f5c7291916b817c75168/clippy_lints%2Fsrc%2Ftypes%2Fbox_vec.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Ftypes%2Fbox_vec.rs?ref=871ad80bb02af6d8fbf3f5c7291916b817c75168", "patch": "@@ -1,25 +0,0 @@\n-use clippy_utils::diagnostics::span_lint_and_help;\n-use clippy_utils::is_ty_param_diagnostic_item;\n-use rustc_hir::{self as hir, def_id::DefId, QPath};\n-use rustc_lint::LateContext;\n-use rustc_span::symbol::sym;\n-\n-use super::BOX_VEC;\n-\n-pub(super) fn check(cx: &LateContext<'_>, hir_ty: &hir::Ty<'_>, qpath: &QPath<'_>, def_id: DefId) -> bool {\n-    if Some(def_id) == cx.tcx.lang_items().owned_box()\n-        && is_ty_param_diagnostic_item(cx, qpath, sym::vec_type).is_some()\n-    {\n-        span_lint_and_help(\n-            cx,\n-            BOX_VEC,\n-            hir_ty.span,\n-            \"you seem to be trying to use `Box<Vec<T>>`. Consider using just `Vec<T>`\",\n-            None,\n-            \"`Vec<T>` is already on the heap, `Box<Vec<T>>` makes an extra allocation\",\n-        );\n-        true\n-    } else {\n-        false\n-    }\n-}"}, {"sha": "bbe07db5358cdc805be57a209fc87c22871b24ee", "filename": "clippy_lints/src/types/mod.rs", "status": "modified", "additions": 7, "deletions": 7, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/63ed2f9eb4a787abdd8c50773f3ef9cc8a5cb724/clippy_lints%2Fsrc%2Ftypes%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/63ed2f9eb4a787abdd8c50773f3ef9cc8a5cb724/clippy_lints%2Fsrc%2Ftypes%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Ftypes%2Fmod.rs?ref=63ed2f9eb4a787abdd8c50773f3ef9cc8a5cb724", "patch": "@@ -1,5 +1,5 @@\n mod borrowed_box;\n-mod box_vec;\n+mod box_collection;\n mod linked_list;\n mod option_option;\n mod rc_buffer;\n@@ -21,12 +21,12 @@ use rustc_span::source_map::Span;\n \n declare_clippy_lint! {\n     /// ### What it does\n-    /// Checks for use of `Box<Vec<_>>` anywhere in the code.\n+    /// Checks for use of `Box<T>` where T is a collection such as Vec anywhere in the code.\n     /// Check the [Box documentation](https://doc.rust-lang.org/std/boxed/index.html) for more information.\n     ///\n     /// ### Why is this bad?\n-    /// `Vec` already keeps its contents in a separate area on\n-    /// the heap. So if you `Box` it, you just add another level of indirection\n+    /// Collections already keeps their contents in a separate area on\n+    /// the heap. So if you `Box` them, you just add another level of indirection\n     /// without any benefit whatsoever.\n     ///\n     /// ### Example\n@@ -43,7 +43,7 @@ declare_clippy_lint! {\n     ///     values: Vec<Foo>,\n     /// }\n     /// ```\n-    pub BOX_VEC,\n+    pub BOX_COLLECTION,\n     perf,\n     \"usage of `Box<Vec<T>>`, vector elements are already on the heap\"\n }\n@@ -298,7 +298,7 @@ pub struct Types {\n     avoid_breaking_exported_api: bool,\n }\n \n-impl_lint_pass!(Types => [BOX_VEC, VEC_BOX, OPTION_OPTION, LINKEDLIST, BORROWED_BOX, REDUNDANT_ALLOCATION, RC_BUFFER, RC_MUTEX, TYPE_COMPLEXITY]);\n+impl_lint_pass!(Types => [BOX_COLLECTION, VEC_BOX, OPTION_OPTION, LINKEDLIST, BORROWED_BOX, REDUNDANT_ALLOCATION, RC_BUFFER, RC_MUTEX, TYPE_COMPLEXITY]);\n \n impl<'tcx> LateLintPass<'tcx> for Types {\n     fn check_fn(&mut self, cx: &LateContext<'_>, _: FnKind<'_>, decl: &FnDecl<'_>, _: &Body<'_>, _: Span, id: HirId) {\n@@ -447,7 +447,7 @@ impl Types {\n                         // in `clippy_lints::utils::conf.rs`\n \n                         let mut triggered = false;\n-                        triggered |= box_vec::check(cx, hir_ty, qpath, def_id);\n+                        triggered |= box_collection::check(cx, hir_ty, qpath, def_id);\n                         triggered |= redundant_allocation::check(cx, hir_ty, qpath, def_id);\n                         triggered |= rc_buffer::check(cx, hir_ty, qpath, def_id);\n                         triggered |= vec_box::check(cx, hir_ty, qpath, def_id, self.vec_box_size_threshold);"}, {"sha": "1e0447239be99813cb7777c9e929fa600e86c71c", "filename": "clippy_lints/src/utils/conf.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/63ed2f9eb4a787abdd8c50773f3ef9cc8a5cb724/clippy_lints%2Fsrc%2Futils%2Fconf.rs", "raw_url": "https://github.com/rust-lang/rust/raw/63ed2f9eb4a787abdd8c50773f3ef9cc8a5cb724/clippy_lints%2Fsrc%2Futils%2Fconf.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Futils%2Fconf.rs?ref=63ed2f9eb4a787abdd8c50773f3ef9cc8a5cb724", "patch": "@@ -136,7 +136,7 @@ macro_rules! define_Conf {\n }\n \n define_Conf! {\n-    /// Lint: ENUM_VARIANT_NAMES, LARGE_TYPES_PASSED_BY_VALUE, TRIVIALLY_COPY_PASS_BY_REF, UNNECESSARY_WRAPS, UPPER_CASE_ACRONYMS, WRONG_SELF_CONVENTION, BOX_VEC, REDUNDANT_ALLOCATION, RC_BUFFER, VEC_BOX, OPTION_OPTION, LINKEDLIST, RC_MUTEX.\n+    /// Lint: ENUM_VARIANT_NAMES, LARGE_TYPES_PASSED_BY_VALUE, TRIVIALLY_COPY_PASS_BY_REF, UNNECESSARY_WRAPS, UPPER_CASE_ACRONYMS, WRONG_SELF_CONVENTION, BOX_COLLECTION, REDUNDANT_ALLOCATION, RC_BUFFER, VEC_BOX, OPTION_OPTION, LINKEDLIST, RC_MUTEX.\n     ///\n     /// Suppress lints whenever the suggested change would cause breakage for other crates.\n     (avoid_breaking_exported_api: bool = true),"}, {"sha": "e00f061f28a94b67a91f87d105b43a4131d68bc0", "filename": "tests/ui/box_collection.rs", "status": "renamed", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/63ed2f9eb4a787abdd8c50773f3ef9cc8a5cb724/tests%2Fui%2Fbox_collection.rs", "raw_url": "https://github.com/rust-lang/rust/raw/63ed2f9eb4a787abdd8c50773f3ef9cc8a5cb724/tests%2Fui%2Fbox_collection.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fbox_collection.rs?ref=63ed2f9eb4a787abdd8c50773f3ef9cc8a5cb724", "patch": "@@ -6,6 +6,8 @@\n     unused\n )]\n \n+use std::collections::HashMap;\n+\n macro_rules! boxit {\n     ($init:expr, $x:ty) => {\n         let _: Box<$x> = Box::new($init);\n@@ -15,20 +17,26 @@ macro_rules! boxit {\n fn test_macro() {\n     boxit!(Vec::new(), Vec<u8>);\n }\n+\n fn test(foo: Box<Vec<bool>>) {}\n \n fn test2(foo: Box<dyn Fn(Vec<u32>)>) {\n     // pass if #31 is fixed\n     foo(vec![1, 2, 3])\n }\n \n+fn test3(foo: Box<String>) {}\n+\n+fn test4(foo: Box<HashMap<String, String>>) {}\n+\n fn test_local_not_linted() {\n     let _: Box<Vec<bool>>;\n }\n \n // All of these test should be allowed because they are part of the\n // public api and `avoid_breaking_exported_api` is `false` by default.\n pub fn pub_test(foo: Box<Vec<bool>>) {}\n+\n pub fn pub_test_ret() -> Box<Vec<bool>> {\n     Box::new(Vec::new())\n }", "previous_filename": "tests/ui/box_vec.rs"}, {"sha": "6de85d05a99f32b59eac0905a7f19967d8419f6e", "filename": "tests/ui/box_collection.stderr", "status": "added", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/63ed2f9eb4a787abdd8c50773f3ef9cc8a5cb724/tests%2Fui%2Fbox_collection.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/63ed2f9eb4a787abdd8c50773f3ef9cc8a5cb724/tests%2Fui%2Fbox_collection.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fbox_collection.stderr?ref=63ed2f9eb4a787abdd8c50773f3ef9cc8a5cb724", "patch": "@@ -0,0 +1,27 @@\n+error: you seem to be trying to use `Box<Vec<..>>`. Consider using just `Vec<..>`\n+  --> $DIR/box_collection.rs:21:14\n+   |\n+LL | fn test(foo: Box<Vec<bool>>) {}\n+   |              ^^^^^^^^^^^^^^\n+   |\n+   = note: `-D clippy::box-collection` implied by `-D warnings`\n+   = help: `Vec<..>` is already on the heap, `Box<Vec<..>>` makes an extra allocation\n+\n+error: you seem to be trying to use `Box<String>`. Consider using just `String`\n+  --> $DIR/box_collection.rs:28:15\n+   |\n+LL | fn test3(foo: Box<String>) {}\n+   |               ^^^^^^^^^^^\n+   |\n+   = help: `String` is already on the heap, `Box<String>` makes an extra allocation\n+\n+error: you seem to be trying to use `Box<HashMap<..>>`. Consider using just `HashMap<..>`\n+  --> $DIR/box_collection.rs:30:15\n+   |\n+LL | fn test4(foo: Box<HashMap<String, String>>) {}\n+   |               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+   = help: `HashMap<..>` is already on the heap, `Box<HashMap<..>>` makes an extra allocation\n+\n+error: aborting due to 3 previous errors\n+"}, {"sha": "58c1f13fb877b1ba77deda63048b0ed41bf36314", "filename": "tests/ui/box_vec.stderr", "status": "removed", "additions": 0, "deletions": 11, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/871ad80bb02af6d8fbf3f5c7291916b817c75168/tests%2Fui%2Fbox_vec.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/871ad80bb02af6d8fbf3f5c7291916b817c75168/tests%2Fui%2Fbox_vec.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fbox_vec.stderr?ref=871ad80bb02af6d8fbf3f5c7291916b817c75168", "patch": "@@ -1,11 +0,0 @@\n-error: you seem to be trying to use `Box<Vec<T>>`. Consider using just `Vec<T>`\n-  --> $DIR/box_vec.rs:18:14\n-   |\n-LL | fn test(foo: Box<Vec<bool>>) {}\n-   |              ^^^^^^^^^^^^^^\n-   |\n-   = note: `-D clippy::box-vec` implied by `-D warnings`\n-   = help: `Vec<T>` is already on the heap, `Box<Vec<T>>` makes an extra allocation\n-\n-error: aborting due to previous error\n-"}]}