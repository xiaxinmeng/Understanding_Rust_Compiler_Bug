{"sha": "e2326a1eecfe5562712649e8696c579bc919a9af", "node_id": "MDY6Q29tbWl0NzI0NzEyOmUyMzI2YTFlZWNmZTU1NjI3MTI2NDllODY5NmM1NzliYzkxOWE5YWY=", "commit": {"author": {"name": "Dylan MacKenzie", "email": "ecstaticmorse@gmail.com", "date": "2020-08-22T18:13:32Z"}, "committer": {"name": "Dylan MacKenzie", "email": "ecstaticmorse@gmail.com", "date": "2020-08-22T18:14:07Z"}, "message": "Treat a NULL return from `dlsym` as an error on illumos\n\nThis works around behavior observed on illumos in #74469, in which\nforeign code (libc according to the OP) was racing with rustc to check\n`dlerror`.", "tree": {"sha": "a108feebdc36773996450a07e1a6096b0049ccda", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a108feebdc36773996450a07e1a6096b0049ccda"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e2326a1eecfe5562712649e8696c579bc919a9af", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e2326a1eecfe5562712649e8696c579bc919a9af", "html_url": "https://github.com/rust-lang/rust/commit/e2326a1eecfe5562712649e8696c579bc919a9af", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e2326a1eecfe5562712649e8696c579bc919a9af/comments", "author": {"login": "ecstatic-morse", "id": 29463364, "node_id": "MDQ6VXNlcjI5NDYzMzY0", "avatar_url": "https://avatars.githubusercontent.com/u/29463364?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ecstatic-morse", "html_url": "https://github.com/ecstatic-morse", "followers_url": "https://api.github.com/users/ecstatic-morse/followers", "following_url": "https://api.github.com/users/ecstatic-morse/following{/other_user}", "gists_url": "https://api.github.com/users/ecstatic-morse/gists{/gist_id}", "starred_url": "https://api.github.com/users/ecstatic-morse/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ecstatic-morse/subscriptions", "organizations_url": "https://api.github.com/users/ecstatic-morse/orgs", "repos_url": "https://api.github.com/users/ecstatic-morse/repos", "events_url": "https://api.github.com/users/ecstatic-morse/events{/privacy}", "received_events_url": "https://api.github.com/users/ecstatic-morse/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ecstatic-morse", "id": 29463364, "node_id": "MDQ6VXNlcjI5NDYzMzY0", "avatar_url": "https://avatars.githubusercontent.com/u/29463364?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ecstatic-morse", "html_url": "https://github.com/ecstatic-morse", "followers_url": "https://api.github.com/users/ecstatic-morse/followers", "following_url": "https://api.github.com/users/ecstatic-morse/following{/other_user}", "gists_url": "https://api.github.com/users/ecstatic-morse/gists{/gist_id}", "starred_url": "https://api.github.com/users/ecstatic-morse/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ecstatic-morse/subscriptions", "organizations_url": "https://api.github.com/users/ecstatic-morse/orgs", "repos_url": "https://api.github.com/users/ecstatic-morse/repos", "events_url": "https://api.github.com/users/ecstatic-morse/events{/privacy}", "received_events_url": "https://api.github.com/users/ecstatic-morse/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "766fcb0b01986396b2b87ba194dcd4392b57b613", "url": "https://api.github.com/repos/rust-lang/rust/commits/766fcb0b01986396b2b87ba194dcd4392b57b613", "html_url": "https://github.com/rust-lang/rust/commit/766fcb0b01986396b2b87ba194dcd4392b57b613"}], "stats": {"total": 28, "additions": 24, "deletions": 4}, "files": [{"sha": "b49a1456046529696ff6f31d2e28304aac90e9f1", "filename": "src/librustc_metadata/dynamic_lib.rs", "status": "modified", "additions": 24, "deletions": 4, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/e2326a1eecfe5562712649e8696c579bc919a9af/src%2Flibrustc_metadata%2Fdynamic_lib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e2326a1eecfe5562712649e8696c579bc919a9af/src%2Flibrustc_metadata%2Fdynamic_lib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Fdynamic_lib.rs?ref=e2326a1eecfe5562712649e8696c579bc919a9af", "patch": "@@ -107,11 +107,26 @@ mod dl {\n         handle: *mut u8,\n         symbol: *const libc::c_char,\n     ) -> Result<*mut u8, String> {\n+        // HACK(#74469): On some platforms, users observed foreign code\n+        // (specifically libc) invoking `dlopen`/`dlsym` in parallel with the\n+        // functions in this module. This is problematic because, according to\n+        // the POSIX API documentation, `dlerror` must be called to determine\n+        // whether `dlsym` succeeded. Unlike `dlopen`, a NULL return value may\n+        // indicate a successfully resolved symbol with an address of zero.\n+        //\n+        // Because symbols with address zero shouldn't occur in practice, we\n+        // treat them as errors on platforms with misbehaving libc\n+        // implementations.\n+        const DLSYM_NULL_IS_ERROR: bool = cfg!(target_os = \"illumos\");\n+\n         let mut dlerror = error::lock();\n \n-        // Flush `dlerror` since we need to use it to determine whether the subsequent call to\n-        // `dlsym` is successful.\n-        dlerror.clear();\n+        // No need to flush `dlerror` if we aren't using it to determine whether\n+        // the subsequent call to `dlsym` succeeded. If an error occurs, any\n+        // stale value will be overwritten.\n+        if !DLSYM_NULL_IS_ERROR {\n+            dlerror.clear();\n+        }\n \n         let ret = libc::dlsym(handle as *mut libc::c_void, symbol) as *mut u8;\n \n@@ -121,7 +136,12 @@ mod dl {\n             return Ok(ret);\n         }\n \n-        dlerror.get().map(|()| ret)\n+        match dlerror.get() {\n+            Ok(()) if DLSYM_NULL_IS_ERROR => Err(\"Unknown error\".to_string()),\n+            Ok(()) => Ok(ret),\n+\n+            Err(msg) => Err(msg),\n+        }\n     }\n \n     pub(super) unsafe fn close(handle: *mut u8) {"}]}