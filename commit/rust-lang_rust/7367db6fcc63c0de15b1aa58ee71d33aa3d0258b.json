{"sha": "7367db6fcc63c0de15b1aa58ee71d33aa3d0258b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjczNjdkYjZmY2M2M2MwZGUxNWIxYWE1OGVlNzFkMzNhYTNkMDI1OGI=", "commit": {"author": {"name": "Tamir Duberstein", "email": "tamird@gmail.com", "date": "2016-10-15T20:17:23Z"}, "committer": {"name": "Tamir Duberstein", "email": "tamird@gmail.com", "date": "2016-10-28T01:35:57Z"}, "message": "tidy/bins: fix false positive on non checked-in binary\n\n`git ls-files` now exits zero when called with a missing file; check\nthat the file is included in the output before reporting a checked-in\nbinary. Observed with git 2.10.1 and tripped by a symlink created by\ntests:\n\nsrc/test/run-make/issue-26006/out/time/deps/liblibc.rlib -> out/libc/liblibc.rlib", "tree": {"sha": "23832201e1f0fbed9d41258e8376af9f8762a65e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/23832201e1f0fbed9d41258e8376af9f8762a65e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7367db6fcc63c0de15b1aa58ee71d33aa3d0258b", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\nVersion: GnuPG v2\n\niQIcBAABCAAGBQJYEqt9AAoJEBwemMyOF7uJRcYP/3YTvuXny0n5dF8w1Fg26jLf\n5mVEzwoz2hPhl32/WUnoaMIp2+RTiVzaxRHcprONLjn0zDdKU7oVlB6XpWifC1bX\nWLPb9/nyCeejE1IWPyaNJsg2JojDOcITMcuQG8KYJActhEkDwiZitiS0ZoWo8NZI\nDVp64qnXWJH2N5KD7aL1Q09hFMwYXyHlE4K3BDZmcrCADN6yAcREFtLphX5z6zhx\nO5THfDKZkISZ3jnXbc+fMaWU0xxa6GDmDafLKNrbTH0gXx5+OWBtH24fO7Rx1czR\nhhqEXsGD/6NN8ERor2MmsxTwuMxvknBp6Utxups2gLoEsPnlzNNoGq2Oi4nJrTJz\nIw6BqvbSyZB1Wk0zEwDVoJPPYS/vkK3arwJWm1ac475hQtDAgBHzPE3TbvjVs5S1\nStbdbNkOT9dyLvDC6B/q1Ou0Ay4719COulxbKZFgrNHnMJSNJRWnfmJ8K/553OnD\niFsdE6gFagR/iy5xUMSXyOw/Sh0ZE0tz9XkQc9s2V8EWZh4UQWIGnhZu6dqJA9Hy\n0uAiqto5g1UMjIJntFjNv3jnJINBG0Iut0AsR0hHBFE/IYzQEO/497oF9C3enYBx\nDdfyJk8JZ6w7eSi4BF43gBv3ygSWgoRq/frVKq+LPZK7aZeiixXpQzENGxMlMCIw\nQ1h3PScPOq1PcW4zp5rV\n=90mU\n-----END PGP SIGNATURE-----", "payload": "tree 23832201e1f0fbed9d41258e8376af9f8762a65e\nparent 3f4408347d2109803edbf53c89c8bce575de4b67\nauthor Tamir Duberstein <tamird@gmail.com> 1476562643 -0400\ncommitter Tamir Duberstein <tamird@gmail.com> 1477618557 -0400\n\ntidy/bins: fix false positive on non checked-in binary\n\n`git ls-files` now exits zero when called with a missing file; check\nthat the file is included in the output before reporting a checked-in\nbinary. Observed with git 2.10.1 and tripped by a symlink created by\ntests:\n\nsrc/test/run-make/issue-26006/out/time/deps/liblibc.rlib -> out/libc/liblibc.rlib\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7367db6fcc63c0de15b1aa58ee71d33aa3d0258b", "html_url": "https://github.com/rust-lang/rust/commit/7367db6fcc63c0de15b1aa58ee71d33aa3d0258b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7367db6fcc63c0de15b1aa58ee71d33aa3d0258b/comments", "author": {"login": "tamird", "id": 1535036, "node_id": "MDQ6VXNlcjE1MzUwMzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1535036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tamird", "html_url": "https://github.com/tamird", "followers_url": "https://api.github.com/users/tamird/followers", "following_url": "https://api.github.com/users/tamird/following{/other_user}", "gists_url": "https://api.github.com/users/tamird/gists{/gist_id}", "starred_url": "https://api.github.com/users/tamird/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tamird/subscriptions", "organizations_url": "https://api.github.com/users/tamird/orgs", "repos_url": "https://api.github.com/users/tamird/repos", "events_url": "https://api.github.com/users/tamird/events{/privacy}", "received_events_url": "https://api.github.com/users/tamird/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tamird", "id": 1535036, "node_id": "MDQ6VXNlcjE1MzUwMzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1535036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tamird", "html_url": "https://github.com/tamird", "followers_url": "https://api.github.com/users/tamird/followers", "following_url": "https://api.github.com/users/tamird/following{/other_user}", "gists_url": "https://api.github.com/users/tamird/gists{/gist_id}", "starred_url": "https://api.github.com/users/tamird/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tamird/subscriptions", "organizations_url": "https://api.github.com/users/tamird/orgs", "repos_url": "https://api.github.com/users/tamird/repos", "events_url": "https://api.github.com/users/tamird/events{/privacy}", "received_events_url": "https://api.github.com/users/tamird/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3f4408347d2109803edbf53c89c8bce575de4b67", "url": "https://api.github.com/repos/rust-lang/rust/commits/3f4408347d2109803edbf53c89c8bce575de4b67", "html_url": "https://github.com/rust-lang/rust/commit/3f4408347d2109803edbf53c89c8bce575de4b67"}], "stats": {"total": 25, "additions": 12, "deletions": 13}, "files": [{"sha": "ef93b0858b02f646068332f6c47fb521bb9e9a20", "filename": "src/tools/tidy/src/bins.rs", "status": "modified", "additions": 12, "deletions": 13, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/7367db6fcc63c0de15b1aa58ee71d33aa3d0258b/src%2Ftools%2Ftidy%2Fsrc%2Fbins.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7367db6fcc63c0de15b1aa58ee71d33aa3d0258b/src%2Ftools%2Ftidy%2Fsrc%2Fbins.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Fbins.rs?ref=7367db6fcc63c0de15b1aa58ee71d33aa3d0258b", "patch": "@@ -44,28 +44,27 @@ pub fn check(path: &Path, bad: &mut bool) {\n         let filename = file.file_name().unwrap().to_string_lossy();\n         let extensions = [\".py\", \".sh\"];\n         if extensions.iter().any(|e| filename.ends_with(e)) {\n-            return\n+            return;\n         }\n \n         let metadata = t!(fs::symlink_metadata(&file), &file);\n         if metadata.mode() & 0o111 != 0 {\n             let rel_path = file.strip_prefix(path).unwrap();\n             let git_friendly_path = rel_path.to_str().unwrap().replace(\"\\\\\", \"/\");\n-            let ret_code = Command::new(\"git\")\n-                                        .arg(\"ls-files\")\n-                                        .arg(&git_friendly_path)\n-                                        .current_dir(path)\n-                                        .stdout(Stdio::null())\n-                                        .stderr(Stdio::null())\n-                                        .status()\n-                                        .unwrap_or_else(|e| {\n-                                            panic!(\"could not run git ls-files: {}\", e);\n-                                        });\n-            if ret_code.success() {\n+            let output = Command::new(\"git\")\n+                .arg(\"ls-files\")\n+                .arg(&git_friendly_path)\n+                .current_dir(path)\n+                .stderr(Stdio::null())\n+                .output()\n+                .unwrap_or_else(|e| {\n+                    panic!(\"could not run git ls-files: {}\", e);\n+                });\n+            let path_bytes = rel_path.as_os_str().as_bytes();\n+            if output.status.success() && output.stdout.starts_with(path_bytes) {\n                 println!(\"binary checked into source: {}\", file.display());\n                 *bad = true;\n             }\n         }\n     })\n }\n-"}]}