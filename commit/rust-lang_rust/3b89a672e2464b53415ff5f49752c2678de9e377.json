{"sha": "3b89a672e2464b53415ff5f49752c2678de9e377", "node_id": "MDY6Q29tbWl0NzI0NzEyOjNiODlhNjcyZTI0NjRiNTM0MTVmZjVmNDk3NTJjMjY3OGRlOWUzNzc=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-12-12T21:09:20Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-12-12T21:09:20Z"}, "message": "Auto merge of #6382 - giraffate:fix_fp_in_manual_range_contains_when_const_fn, r=llogiq\n\nFix FP of `manual_range_contains` in `const fn`\n\nFix #6373.\n\nchangelog: Fix FP of `manual_range_contains` in `const fn`", "tree": {"sha": "cf2f92f73619da720fa1df7fd1fed73f007d2e99", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/cf2f92f73619da720fa1df7fd1fed73f007d2e99"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3b89a672e2464b53415ff5f49752c2678de9e377", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3b89a672e2464b53415ff5f49752c2678de9e377", "html_url": "https://github.com/rust-lang/rust/commit/3b89a672e2464b53415ff5f49752c2678de9e377", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3b89a672e2464b53415ff5f49752c2678de9e377/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "18c5ea490584fe166b7640fa19f850405f9b9e56", "url": "https://api.github.com/repos/rust-lang/rust/commits/18c5ea490584fe166b7640fa19f850405f9b9e56", "html_url": "https://github.com/rust-lang/rust/commit/18c5ea490584fe166b7640fa19f850405f9b9e56"}, {"sha": "26c61c7e49b173c8ae7c54c3a4c90b60cd9f71b8", "url": "https://api.github.com/repos/rust-lang/rust/commits/26c61c7e49b173c8ae7c54c3a4c90b60cd9f71b8", "html_url": "https://github.com/rust-lang/rust/commit/26c61c7e49b173c8ae7c54c3a4c90b60cd9f71b8"}], "stats": {"total": 21, "additions": 18, "deletions": 3}, "files": [{"sha": "3e454eecd970e37b85dfb0d150f13e3715b5d136", "filename": "clippy_lints/src/ranges.rs", "status": "modified", "additions": 8, "deletions": 3, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/3b89a672e2464b53415ff5f49752c2678de9e377/clippy_lints%2Fsrc%2Franges.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3b89a672e2464b53415ff5f49752c2678de9e377/clippy_lints%2Fsrc%2Franges.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Franges.rs?ref=3b89a672e2464b53415ff5f49752c2678de9e377", "patch": "@@ -14,7 +14,7 @@ use std::cmp::Ordering;\n \n use crate::utils::sugg::Sugg;\n use crate::utils::{\n-    get_parent_expr, is_integer_const, meets_msrv, single_segment_path, snippet, snippet_opt,\n+    get_parent_expr, in_constant, is_integer_const, meets_msrv, single_segment_path, snippet, snippet_opt,\n     snippet_with_applicability, span_lint, span_lint_and_sugg, span_lint_and_then,\n };\n use crate::utils::{higher, SpanlessEq};\n@@ -190,7 +190,7 @@ impl<'tcx> LateLintPass<'tcx> for Ranges {\n             },\n             ExprKind::Binary(ref op, ref l, ref r) => {\n                 if meets_msrv(self.msrv.as_ref(), &MANUAL_RANGE_CONTAINS_MSRV) {\n-                    check_possible_range_contains(cx, op.node, l, r, expr.span);\n+                    check_possible_range_contains(cx, op.node, l, r, expr);\n                 }\n             },\n             _ => {},\n@@ -203,7 +203,12 @@ impl<'tcx> LateLintPass<'tcx> for Ranges {\n     extract_msrv_attr!(LateContext);\n }\n \n-fn check_possible_range_contains(cx: &LateContext<'_>, op: BinOpKind, l: &Expr<'_>, r: &Expr<'_>, span: Span) {\n+fn check_possible_range_contains(cx: &LateContext<'_>, op: BinOpKind, l: &Expr<'_>, r: &Expr<'_>, expr: &Expr<'_>) {\n+    if in_constant(cx, expr.hir_id) {\n+        return;\n+    }\n+\n+    let span = expr.span;\n     let combine_and = match op {\n         BinOpKind::And | BinOpKind::BitAnd => true,\n         BinOpKind::Or | BinOpKind::BitOr => false,"}, {"sha": "47c974e614b91e80bda1fd3b46dfe11a92b240f9", "filename": "tests/ui/range_contains.fixed", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/3b89a672e2464b53415ff5f49752c2678de9e377/tests%2Fui%2Frange_contains.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/3b89a672e2464b53415ff5f49752c2678de9e377/tests%2Fui%2Frange_contains.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Frange_contains.fixed?ref=3b89a672e2464b53415ff5f49752c2678de9e377", "patch": "@@ -44,3 +44,8 @@ fn main() {\n     (0. ..1.).contains(&y);\n     !(0. ..=1.).contains(&y);\n }\n+\n+// Fix #6373\n+pub const fn in_range(a: i32) -> bool {\n+    3 <= a && a <= 20\n+}"}, {"sha": "835deced5e4cba34a443debfc104ce0ac21b8635", "filename": "tests/ui/range_contains.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/3b89a672e2464b53415ff5f49752c2678de9e377/tests%2Fui%2Frange_contains.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3b89a672e2464b53415ff5f49752c2678de9e377/tests%2Fui%2Frange_contains.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Frange_contains.rs?ref=3b89a672e2464b53415ff5f49752c2678de9e377", "patch": "@@ -44,3 +44,8 @@ fn main() {\n     y >= 0. && y < 1.;\n     y < 0. || y > 1.;\n }\n+\n+// Fix #6373\n+pub const fn in_range(a: i32) -> bool {\n+    3 <= a && a <= 20\n+}"}]}