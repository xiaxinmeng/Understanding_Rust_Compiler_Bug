{"sha": "d3ce333ec858e33e7c881386784d7871c58db2d8", "node_id": "C_kwDOAAsO6NoAKGQzY2UzMzNlYzg1OGUzM2U3Yzg4MTM4Njc4NGQ3ODcxYzU4ZGIyZDg", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-05-08T09:52:29Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-05-08T09:52:29Z"}, "message": "Auto merge of #14742 - Veykril:closure-capture-inlays, r=Veykril\n\nfeat: Closure capture inlay hints\n\nI opted for a fictional `move(foo, &bar, &mut qux)` syntax here, disabled by default as these are not correct rust syntax and hence could cause confusion.\n![image](https://user-images.githubusercontent.com/3757771/236447484-649a4ea6-ad61-496e-bad8-765a5236150e.png)", "tree": {"sha": "d4b93f00579543d24a3c31939ad09217da003fb3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d4b93f00579543d24a3c31939ad09217da003fb3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d3ce333ec858e33e7c881386784d7871c58db2d8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d3ce333ec858e33e7c881386784d7871c58db2d8", "html_url": "https://github.com/rust-lang/rust/commit/d3ce333ec858e33e7c881386784d7871c58db2d8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d3ce333ec858e33e7c881386784d7871c58db2d8/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ff8b9699518d4fe92f08629d91b3983e00f75282", "url": "https://api.github.com/repos/rust-lang/rust/commits/ff8b9699518d4fe92f08629d91b3983e00f75282", "html_url": "https://github.com/rust-lang/rust/commit/ff8b9699518d4fe92f08629d91b3983e00f75282"}, {"sha": "4c5fd19ee5734992344827b11c0d0e864b020b25", "url": "https://api.github.com/repos/rust-lang/rust/commits/4c5fd19ee5734992344827b11c0d0e864b020b25", "html_url": "https://github.com/rust-lang/rust/commit/4c5fd19ee5734992344827b11c0d0e864b020b25"}], "stats": {"total": 315, "additions": 278, "deletions": 37}, "files": [{"sha": "6d03c76eb6abc3787110023c951d5dc22e2b65bc", "filename": "crates/hir-ty/src/infer/closure.rs", "status": "modified", "additions": 4, "deletions": 16, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/d3ce333ec858e33e7c881386784d7871c58db2d8/crates%2Fhir-ty%2Fsrc%2Finfer%2Fclosure.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d3ce333ec858e33e7c881386784d7871c58db2d8/crates%2Fhir-ty%2Fsrc%2Finfer%2Fclosure.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-ty%2Fsrc%2Finfer%2Fclosure.rs?ref=d3ce333ec858e33e7c881386784d7871c58db2d8", "patch": "@@ -148,7 +148,7 @@ impl HirPlace {\n }\n \n #[derive(Debug, Clone, Copy, PartialEq, Eq, PartialOrd, Ord)]\n-pub(crate) enum CaptureKind {\n+pub enum CaptureKind {\n     ByRef(BorrowKind),\n     ByValue,\n }\n@@ -166,23 +166,11 @@ impl CapturedItem {\n         self.place.local\n     }\n \n-    pub fn display_kind(&self) -> &'static str {\n-        match self.kind {\n-            CaptureKind::ByRef(k) => match k {\n-                BorrowKind::Shared => \"immutable borrow\",\n-                BorrowKind::Shallow => {\n-                    never!(\"shallow borrow should not happen in closure captures\");\n-                    \"shallow borrow\"\n-                },\n-                BorrowKind::Unique => \"unique immutable borrow ([read more](https://doc.rust-lang.org/stable/reference/types/closure.html#unique-immutable-borrows-in-captures))\",\n-                BorrowKind::Mut { .. } => \"mutable borrow\",\n-            },\n-            CaptureKind::ByValue => \"move\",\n-        }\n+    pub fn kind(&self) -> CaptureKind {\n+        self.kind\n     }\n \n-    pub fn display_place(&self, owner: ClosureId, db: &dyn HirDatabase) -> String {\n-        let owner = db.lookup_intern_closure(owner.into()).0;\n+    pub fn display_place(&self, owner: DefWithBodyId, db: &dyn HirDatabase) -> String {\n         let body = db.body(owner);\n         let mut result = body[self.place.local].name.to_string();\n         let mut field_need_paren = false;"}, {"sha": "28a2bf2838db3f2d397437ef3f590153d9707158", "filename": "crates/hir-ty/src/lib.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/d3ce333ec858e33e7c881386784d7871c58db2d8/crates%2Fhir-ty%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d3ce333ec858e33e7c881386784d7871c58db2d8/crates%2Fhir-ty%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-ty%2Fsrc%2Flib.rs?ref=d3ce333ec858e33e7c881386784d7871c58db2d8", "patch": "@@ -61,8 +61,9 @@ pub use autoderef::autoderef;\n pub use builder::{ParamKind, TyBuilder};\n pub use chalk_ext::*;\n pub use infer::{\n-    closure::CapturedItem, could_coerce, could_unify, Adjust, Adjustment, AutoBorrow, BindingMode,\n-    InferenceDiagnostic, InferenceResult, OverloadedDeref, PointerCast,\n+    closure::{CaptureKind, CapturedItem},\n+    could_coerce, could_unify, Adjust, Adjustment, AutoBorrow, BindingMode, InferenceDiagnostic,\n+    InferenceResult, OverloadedDeref, PointerCast,\n };\n pub use interner::Interner;\n pub use lower::{"}, {"sha": "1fac95ae5e37c0a5b4003bb765749ed890dd83c6", "filename": "crates/hir/src/lib.rs", "status": "modified", "additions": 32, "deletions": 5, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/d3ce333ec858e33e7c881386784d7871c58db2d8/crates%2Fhir%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d3ce333ec858e33e7c881386784d7871c58db2d8/crates%2Fhir%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir%2Fsrc%2Flib.rs?ref=d3ce333ec858e33e7c881386784d7871c58db2d8", "patch": "@@ -2611,6 +2611,10 @@ impl LocalSource {\n         self.source.file_id.original_file(db.upcast())\n     }\n \n+    pub fn file(&self) -> HirFileId {\n+        self.source.file_id\n+    }\n+\n     pub fn name(&self) -> Option<ast::Name> {\n         self.source.value.name()\n     }\n@@ -3210,7 +3214,11 @@ impl Closure {\n         let owner = db.lookup_intern_closure((self.id).into()).0;\n         let infer = &db.infer(owner);\n         let info = infer.closure_info(&self.id);\n-        info.0.iter().cloned().map(|capture| ClosureCapture { owner, capture }).collect()\n+        info.0\n+            .iter()\n+            .cloned()\n+            .map(|capture| ClosureCapture { owner, closure: self.id, capture })\n+            .collect()\n     }\n \n     pub fn fn_trait(&self, db: &dyn HirDatabase) -> FnTrait {\n@@ -3224,6 +3232,7 @@ impl Closure {\n #[derive(Clone, Debug, PartialEq, Eq)]\n pub struct ClosureCapture {\n     owner: DefWithBodyId,\n+    closure: ClosureId,\n     capture: hir_ty::CapturedItem,\n }\n \n@@ -3232,15 +3241,33 @@ impl ClosureCapture {\n         Local { parent: self.owner, binding_id: self.capture.local() }\n     }\n \n-    pub fn display_kind(&self) -> &'static str {\n-        self.capture.display_kind()\n+    pub fn kind(&self) -> CaptureKind {\n+        match self.capture.kind() {\n+            hir_ty::CaptureKind::ByRef(\n+                hir_ty::mir::BorrowKind::Shallow | hir_ty::mir::BorrowKind::Shared,\n+            ) => CaptureKind::SharedRef,\n+            hir_ty::CaptureKind::ByRef(hir_ty::mir::BorrowKind::Unique) => {\n+                CaptureKind::UniqueSharedRef\n+            }\n+            hir_ty::CaptureKind::ByRef(hir_ty::mir::BorrowKind::Mut { .. }) => {\n+                CaptureKind::MutableRef\n+            }\n+            hir_ty::CaptureKind::ByValue => CaptureKind::Move,\n+        }\n     }\n \n-    pub fn display_place(&self, owner: ClosureId, db: &dyn HirDatabase) -> String {\n-        self.capture.display_place(owner, db)\n+    pub fn display_place(&self, db: &dyn HirDatabase) -> String {\n+        self.capture.display_place(self.owner, db)\n     }\n }\n \n+pub enum CaptureKind {\n+    SharedRef,\n+    UniqueSharedRef,\n+    MutableRef,\n+    Move,\n+}\n+\n #[derive(Clone, PartialEq, Eq, Debug)]\n pub struct Type {\n     env: Arc<TraitEnvironment>,"}, {"sha": "53226db7ccd6ef6169a0b40d0fec2e7c06c8e789", "filename": "crates/ide/src/hover/render.rs", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/d3ce333ec858e33e7c881386784d7871c58db2d8/crates%2Fide%2Fsrc%2Fhover%2Frender.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d3ce333ec858e33e7c881386784d7871c58db2d8/crates%2Fide%2Fsrc%2Fhover%2Frender.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fhover%2Frender.rs?ref=d3ce333ec858e33e7c881386784d7871c58db2d8", "patch": "@@ -3,7 +3,8 @@ use std::fmt::Display;\n \n use either::Either;\n use hir::{\n-    Adt, AsAssocItem, AttributeTemplate, HasAttrs, HasSource, HirDisplay, Semantics, TypeInfo,\n+    Adt, AsAssocItem, AttributeTemplate, CaptureKind, HasAttrs, HasSource, HirDisplay, Semantics,\n+    TypeInfo,\n };\n use ide_db::{\n     base_db::SourceDatabase,\n@@ -58,8 +59,14 @@ pub(super) fn closure_expr(\n     let mut captures = c\n         .captured_items(sema.db)\n         .into_iter()\n-        .map(|x| {\n-            format!(\"* `{}` by {}\", x.display_place(c.clone().into(), sema.db), x.display_kind())\n+        .map(|it| {\n+            let borrow_kind=   match it.kind() {\n+                CaptureKind::SharedRef => \"immutable borrow\",\n+                CaptureKind::UniqueSharedRef => \"unique immutable borrow ([read more](https://doc.rust-lang.org/stable/reference/types/closure.html#unique-immutable-borrows-in-captures))\",\n+                CaptureKind::MutableRef => \"mutable borrow\",\n+                CaptureKind::Move => \"move\",\n+            };\n+            format!(\"* `{}` by {}\", it.display_place(sema.db), borrow_kind)\n         })\n         .join(\"\\n\");\n     if captures.trim().is_empty() {"}, {"sha": "c326688ae6a9ed3d371ac204523728967fe170ad", "filename": "crates/ide/src/inlay_hints.rs", "status": "modified", "additions": 17, "deletions": 11, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/d3ce333ec858e33e7c881386784d7871c58db2d8/crates%2Fide%2Fsrc%2Finlay_hints.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d3ce333ec858e33e7c881386784d7871c58db2d8/crates%2Fide%2Fsrc%2Finlay_hints.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Finlay_hints.rs?ref=d3ce333ec858e33e7c881386784d7871c58db2d8", "patch": "@@ -20,16 +20,17 @@ use text_edit::TextEdit;\n \n use crate::{navigation_target::TryToNav, FileId};\n \n-mod closing_brace;\n-mod implicit_static;\n-mod fn_lifetime_fn;\n-mod closure_ret;\n mod adjustment;\n-mod chaining;\n-mod param_name;\n-mod binding_mode;\n mod bind_pat;\n+mod binding_mode;\n+mod chaining;\n+mod closing_brace;\n+mod closure_ret;\n+mod closure_captures;\n mod discriminant;\n+mod fn_lifetime_fn;\n+mod implicit_static;\n+mod param_name;\n \n #[derive(Clone, Debug, PartialEq, Eq)]\n pub struct InlayHintsConfig {\n@@ -42,6 +43,7 @@ pub struct InlayHintsConfig {\n     pub adjustment_hints_mode: AdjustmentHintsMode,\n     pub adjustment_hints_hide_outside_unsafe: bool,\n     pub closure_return_type_hints: ClosureReturnTypeHints,\n+    pub closure_capture_hints: bool,\n     pub binding_mode_hints: bool,\n     pub lifetime_elision_hints: LifetimeElisionHints,\n     pub param_names_for_lifetime_elision_hints: bool,\n@@ -88,6 +90,8 @@ pub enum AdjustmentHintsMode {\n     PreferPostfix,\n }\n \n+// FIXME: Clean up this mess, the kinds are mainly used for setting different rendering properties in the lsp layer\n+// We should probably turns this into such a property holding struct. Or clean this up in some other form.\n #[derive(Copy, Clone, Debug, PartialEq, Eq)]\n pub enum InlayKind {\n     BindingMode,\n@@ -98,6 +102,7 @@ pub enum InlayKind {\n     Adjustment,\n     AdjustmentPostfix,\n     Lifetime,\n+    ClosureCapture,\n     Parameter,\n     Type,\n     Discriminant,\n@@ -444,10 +449,10 @@ fn hints(\n                     ast::Expr::MethodCallExpr(it) => {\n                         param_name::hints(hints, sema, config, ast::Expr::from(it))\n                     }\n-                    ast::Expr::ClosureExpr(it) => closure_ret::hints(hints, famous_defs, config, file_id, it),\n-                    // We could show reborrows for all expressions, but usually that is just noise to the user\n-                    // and the main point here is to show why \"moving\" a mutable reference doesn't necessarily move it\n-                    // ast::Expr::PathExpr(_) => reborrow_hints(hints, sema, config, &expr),\n+                    ast::Expr::ClosureExpr(it) => {\n+                        closure_captures::hints(hints, famous_defs, config, file_id, it.clone());\n+                        closure_ret::hints(hints, famous_defs, config, file_id, it)\n+                    },\n                     _ => None,\n                 }\n             },\n@@ -535,6 +540,7 @@ mod tests {\n         chaining_hints: false,\n         lifetime_elision_hints: LifetimeElisionHints::Never,\n         closure_return_type_hints: ClosureReturnTypeHints::Never,\n+        closure_capture_hints: false,\n         adjustment_hints: AdjustmentHints::Never,\n         adjustment_hints_mode: AdjustmentHintsMode::Prefix,\n         adjustment_hints_hide_outside_unsafe: false,"}, {"sha": "60c4fe411f4fac17888675df7d8c809a1db257d6", "filename": "crates/ide/src/inlay_hints/closure_captures.rs", "status": "added", "additions": 192, "deletions": 0, "changes": 192, "blob_url": "https://github.com/rust-lang/rust/blob/d3ce333ec858e33e7c881386784d7871c58db2d8/crates%2Fide%2Fsrc%2Finlay_hints%2Fclosure_captures.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d3ce333ec858e33e7c881386784d7871c58db2d8/crates%2Fide%2Fsrc%2Finlay_hints%2Fclosure_captures.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Finlay_hints%2Fclosure_captures.rs?ref=d3ce333ec858e33e7c881386784d7871c58db2d8", "patch": "@@ -0,0 +1,192 @@\n+//! Implementation of \"closure return type\" inlay hints.\n+//!\n+//! Tests live in [`bind_pat`][super::bind_pat] module.\n+use ide_db::{base_db::FileId, famous_defs::FamousDefs};\n+use syntax::ast::{self, AstNode};\n+use text_edit::{TextRange, TextSize};\n+\n+use crate::{InlayHint, InlayHintLabel, InlayHintsConfig, InlayKind};\n+\n+pub(super) fn hints(\n+    acc: &mut Vec<InlayHint>,\n+    FamousDefs(sema, _): &FamousDefs<'_, '_>,\n+    config: &InlayHintsConfig,\n+    _file_id: FileId,\n+    closure: ast::ClosureExpr,\n+) -> Option<()> {\n+    if !config.closure_capture_hints {\n+        return None;\n+    }\n+    let ty = &sema.type_of_expr(&closure.clone().into())?.original;\n+    let c = ty.as_closure()?;\n+    let captures = c.captured_items(sema.db);\n+\n+    if captures.is_empty() {\n+        return None;\n+    }\n+\n+    let move_kw_range = match closure.move_token() {\n+        Some(t) => t.text_range(),\n+        None => {\n+            let range = closure.syntax().first_token()?.prev_token()?.text_range();\n+            let range = TextRange::new(range.end() - TextSize::from(1), range.end());\n+            acc.push(InlayHint {\n+                range,\n+                kind: InlayKind::ClosureCapture,\n+                label: InlayHintLabel::simple(\"move\", None, None),\n+                text_edit: None,\n+            });\n+            range\n+        }\n+    };\n+    acc.push(InlayHint {\n+        range: move_kw_range,\n+        kind: InlayKind::ClosureCapture,\n+        label: InlayHintLabel::from(\"(\"),\n+        text_edit: None,\n+    });\n+    let last = captures.len() - 1;\n+    for (idx, capture) in captures.into_iter().enumerate() {\n+        let local = capture.local();\n+        let source = local.primary_source(sema.db);\n+\n+        // force cache the source file, otherwise sema lookup will potentially panic\n+        _ = sema.parse_or_expand(source.file());\n+\n+        acc.push(InlayHint {\n+            range: move_kw_range,\n+            kind: InlayKind::ClosureCapture,\n+            label: InlayHintLabel::simple(\n+                format!(\n+                    \"{}{}\",\n+                    match capture.kind() {\n+                        hir::CaptureKind::SharedRef => \"&\",\n+                        hir::CaptureKind::UniqueSharedRef => \"&unique \",\n+                        hir::CaptureKind::MutableRef => \"&mut \",\n+                        hir::CaptureKind::Move => \"\",\n+                    },\n+                    capture.display_place(sema.db)\n+                ),\n+                None,\n+                source.name().and_then(|name| sema.original_range_opt(name.syntax())),\n+            ),\n+            text_edit: None,\n+        });\n+\n+        if idx != last {\n+            acc.push(InlayHint {\n+                range: move_kw_range,\n+                kind: InlayKind::ClosureCapture,\n+                label: InlayHintLabel::simple(\", \", None, None),\n+                text_edit: None,\n+            });\n+        }\n+    }\n+    acc.push(InlayHint {\n+        range: move_kw_range,\n+        kind: InlayKind::ClosureCapture,\n+        label: InlayHintLabel::from(\")\"),\n+        text_edit: None,\n+    });\n+\n+    Some(())\n+}\n+\n+#[cfg(test)]\n+mod tests {\n+    use crate::{\n+        inlay_hints::tests::{check_with_config, DISABLED_CONFIG},\n+        InlayHintsConfig,\n+    };\n+\n+    #[test]\n+    fn all_capture_kinds() {\n+        check_with_config(\n+            InlayHintsConfig { closure_capture_hints: true, ..DISABLED_CONFIG },\n+            r#\"\n+//- minicore: copy, derive\n+\n+\n+#[derive(Copy, Clone)]\n+struct Copy;\n+\n+struct NonCopy;\n+\n+fn main() {\n+    let foo = Copy;\n+    let bar = NonCopy;\n+    let mut baz = NonCopy;\n+    let qux = &mut NonCopy;\n+    || {\n+// ^ move\n+// ^ (\n+// ^ &foo\n+// ^ , $\n+// ^ bar\n+// ^ , $\n+// ^ baz\n+// ^ , $\n+// ^ qux\n+// ^ )\n+        foo;\n+        bar;\n+        baz;\n+        qux;\n+    };\n+    || {\n+// ^ move\n+// ^ (\n+// ^ &foo\n+// ^ , $\n+// ^ &bar\n+// ^ , $\n+// ^ &baz\n+// ^ , $\n+// ^ &qux\n+// ^ )\n+        &foo;\n+        &bar;\n+        &baz;\n+        &qux;\n+    };\n+    || {\n+// ^ move\n+// ^ (\n+// ^ &mut baz\n+// ^ )\n+        &mut baz;\n+    };\n+    || {\n+// ^ move\n+// ^ (\n+// ^ &mut baz\n+// ^ , $\n+// ^ &mut *qux\n+// ^ )\n+        baz = NonCopy;\n+        *qux = NonCopy;\n+    };\n+}\n+\"#,\n+        );\n+    }\n+\n+    #[test]\n+    fn move_token() {\n+        check_with_config(\n+            InlayHintsConfig { closure_capture_hints: true, ..DISABLED_CONFIG },\n+            r#\"\n+//- minicore: copy, derive\n+fn main() {\n+    let foo = u32;\n+    move || {\n+//  ^^^^ (\n+//  ^^^^ foo\n+//  ^^^^ )\n+        foo;\n+    };\n+}\n+\"#,\n+        );\n+    }\n+}"}, {"sha": "e7b223caab43de45d9909f97071bad6bd1c16e13", "filename": "crates/ide/src/static_index.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d3ce333ec858e33e7c881386784d7871c58db2d8/crates%2Fide%2Fsrc%2Fstatic_index.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d3ce333ec858e33e7c881386784d7871c58db2d8/crates%2Fide%2Fsrc%2Fstatic_index.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fstatic_index.rs?ref=d3ce333ec858e33e7c881386784d7871c58db2d8", "patch": "@@ -122,6 +122,7 @@ impl StaticIndex<'_> {\n                     param_names_for_lifetime_elision_hints: false,\n                     binding_mode_hints: false,\n                     max_length: Some(25),\n+                    closure_capture_hints: false,\n                     closing_brace_hints_min_lines: Some(25),\n                 },\n                 file_id,"}, {"sha": "9d5aa0c8d2aa4f619d66389ad474e761cbdb1984", "filename": "crates/rust-analyzer/src/config.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/d3ce333ec858e33e7c881386784d7871c58db2d8/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d3ce333ec858e33e7c881386784d7871c58db2d8/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs?ref=d3ce333ec858e33e7c881386784d7871c58db2d8", "patch": "@@ -340,6 +340,8 @@ config_data! {\n         /// Minimum number of lines required before the `}` until the hint is shown (set to 0 or 1\n         /// to always show them).\n         inlayHints_closingBraceHints_minLines: usize               = \"25\",\n+        /// Whether to show inlay hints for closure captures.\n+        inlayHints_closureCaptureHints_enable: bool                          = \"false\",\n         /// Whether to show inlay type hints for return types of closures.\n         inlayHints_closureReturnTypeHints_enable: ClosureReturnTypeHintsDef  = \"\\\"never\\\"\",\n         /// Closure notation in type and chaining inlay hints.\n@@ -1314,6 +1316,7 @@ impl Config {\n                 ClosureStyle::WithId => hir::ClosureStyle::ClosureWithId,\n                 ClosureStyle::Hide => hir::ClosureStyle::Hide,\n             },\n+            closure_capture_hints: self.data.inlayHints_closureCaptureHints_enable,\n             adjustment_hints: match self.data.inlayHints_expressionAdjustmentHints_enable {\n                 AdjustmentHintsDef::Always => ide::AdjustmentHints::Always,\n                 AdjustmentHintsDef::Never => match self.data.inlayHints_reborrowHints_enable {"}, {"sha": "06f8ba3fb8cf328bb3e16bf51a9eb795eb388d83", "filename": "crates/rust-analyzer/src/to_proto.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/d3ce333ec858e33e7c881386784d7871c58db2d8/crates%2Frust-analyzer%2Fsrc%2Fto_proto.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d3ce333ec858e33e7c881386784d7871c58db2d8/crates%2Frust-analyzer%2Fsrc%2Fto_proto.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fto_proto.rs?ref=d3ce333ec858e33e7c881386784d7871c58db2d8", "patch": "@@ -456,6 +456,7 @@ pub(crate) fn inlay_hint(\n             | InlayKind::BindingMode => position(line_index, inlay_hint.range.start()),\n             // after annotated thing\n             InlayKind::ClosureReturnType\n+            | InlayKind::ClosureCapture\n             | InlayKind::Type\n             | InlayKind::Discriminant\n             | InlayKind::Chaining\n@@ -469,6 +470,7 @@ pub(crate) fn inlay_hint(\n             InlayKind::Type => !render_colons,\n             InlayKind::Chaining | InlayKind::ClosingBrace => true,\n             InlayKind::ClosingParenthesis\n+            | InlayKind::ClosureCapture\n             | InlayKind::Discriminant\n             | InlayKind::OpeningParenthesis\n             | InlayKind::BindingMode\n@@ -490,6 +492,9 @@ pub(crate) fn inlay_hint(\n             | InlayKind::Type\n             | InlayKind::Discriminant\n             | InlayKind::ClosingBrace => false,\n+            InlayKind::ClosureCapture => {\n+                matches!(&label, lsp_types::InlayHintLabel::String(s) if s == \")\")\n+            }\n             InlayKind::BindingMode => {\n                 matches!(&label, lsp_types::InlayHintLabel::String(s) if s != \"&\")\n             }\n@@ -501,6 +506,7 @@ pub(crate) fn inlay_hint(\n                 Some(lsp_types::InlayHintKind::TYPE)\n             }\n             InlayKind::ClosingParenthesis\n+            | InlayKind::ClosureCapture\n             | InlayKind::Discriminant\n             | InlayKind::OpeningParenthesis\n             | InlayKind::BindingMode"}, {"sha": "6a2da3d90e34d5bd0fedd222b45a6ec8ac090851", "filename": "docs/user/generated_config.adoc", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/d3ce333ec858e33e7c881386784d7871c58db2d8/docs%2Fuser%2Fgenerated_config.adoc", "raw_url": "https://github.com/rust-lang/rust/raw/d3ce333ec858e33e7c881386784d7871c58db2d8/docs%2Fuser%2Fgenerated_config.adoc", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/docs%2Fuser%2Fgenerated_config.adoc?ref=d3ce333ec858e33e7c881386784d7871c58db2d8", "patch": "@@ -479,6 +479,11 @@ Whether to show inlay hints after a closing `}` to indicate what item it belongs\n Minimum number of lines required before the `}` until the hint is shown (set to 0 or 1\n to always show them).\n --\n+[[rust-analyzer.inlayHints.closureCaptureHints.enable]]rust-analyzer.inlayHints.closureCaptureHints.enable (default: `false`)::\n++\n+--\n+Whether to show inlay hints for closure captures.\n+--\n [[rust-analyzer.inlayHints.closureReturnTypeHints.enable]]rust-analyzer.inlayHints.closureReturnTypeHints.enable (default: `\"never\"`)::\n +\n --"}, {"sha": "fdcd707a07cca0fa113df855ef022bd1bb5384fd", "filename": "editors/code/package.json", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/d3ce333ec858e33e7c881386784d7871c58db2d8/editors%2Fcode%2Fpackage.json", "raw_url": "https://github.com/rust-lang/rust/raw/d3ce333ec858e33e7c881386784d7871c58db2d8/editors%2Fcode%2Fpackage.json", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fpackage.json?ref=d3ce333ec858e33e7c881386784d7871c58db2d8", "patch": "@@ -1037,6 +1037,11 @@\n                     \"type\": \"integer\",\n                     \"minimum\": 0\n                 },\n+                \"rust-analyzer.inlayHints.closureCaptureHints.enable\": {\n+                    \"markdownDescription\": \"Whether to show inlay hints for closure captures.\",\n+                    \"default\": false,\n+                    \"type\": \"boolean\"\n+                },\n                 \"rust-analyzer.inlayHints.closureReturnTypeHints.enable\": {\n                     \"markdownDescription\": \"Whether to show inlay type hints for return types of closures.\",\n                     \"default\": \"never\","}]}