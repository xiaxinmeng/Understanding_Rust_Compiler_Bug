{"sha": "39bafb09fd616ae6aceec4abf05c270435e8cc42", "node_id": "MDY6Q29tbWl0NzI0NzEyOjM5YmFmYjA5ZmQ2MTZhZTZhY2VlYzRhYmYwNWMyNzA0MzVlOGNjNDI=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-08-09T01:21:23Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-08-09T01:21:23Z"}, "message": "auto merge of #16314 : Ryman/rust/ringbuf_non_pow2, r=huonw\n\nSee test for details.", "tree": {"sha": "f8d8c2e22ccf3fddb7c2f290646be16367259469", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f8d8c2e22ccf3fddb7c2f290646be16367259469"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/39bafb09fd616ae6aceec4abf05c270435e8cc42", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/39bafb09fd616ae6aceec4abf05c270435e8cc42", "html_url": "https://github.com/rust-lang/rust/commit/39bafb09fd616ae6aceec4abf05c270435e8cc42", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/39bafb09fd616ae6aceec4abf05c270435e8cc42/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a1429bca5a5462bd9c489f79f511a7e5ad939046", "url": "https://api.github.com/repos/rust-lang/rust/commits/a1429bca5a5462bd9c489f79f511a7e5ad939046", "html_url": "https://github.com/rust-lang/rust/commit/a1429bca5a5462bd9c489f79f511a7e5ad939046"}, {"sha": "64896d6103f619e5f20719496cb7520491adcead", "url": "https://api.github.com/repos/rust-lang/rust/commits/64896d6103f619e5f20719496cb7520491adcead", "html_url": "https://github.com/rust-lang/rust/commit/64896d6103f619e5f20719496cb7520491adcead"}], "stats": {"total": 47, "additions": 44, "deletions": 3}, "files": [{"sha": "84b5c5bb9985bf94fcb37f82403bf2d8c21e071a", "filename": "src/libcollections/ringbuf.rs", "status": "modified", "additions": 44, "deletions": 3, "changes": 47, "blob_url": "https://github.com/rust-lang/rust/blob/39bafb09fd616ae6aceec4abf05c270435e8cc42/src%2Flibcollections%2Fringbuf.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39bafb09fd616ae6aceec4abf05c270435e8cc42/src%2Flibcollections%2Fringbuf.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcollections%2Fringbuf.rs?ref=39bafb09fd616ae6aceec4abf05c270435e8cc42", "patch": "@@ -403,11 +403,11 @@ impl<'a, T> ExactSize<&'a mut T> for MutItems<'a, T> {}\n fn grow<T>(nelts: uint, loptr: &mut uint, elts: &mut Vec<Option<T>>) {\n     assert_eq!(nelts, elts.len());\n     let lo = *loptr;\n-    let newlen = nelts * 2;\n-    elts.reserve(newlen);\n+    elts.reserve(nelts * 2);\n+    let newlen = elts.capacity();\n \n     /* fill with None */\n-    for _ in range(elts.len(), elts.capacity()) {\n+    for _ in range(elts.len(), newlen) {\n         elts.push(None);\n     }\n \n@@ -750,6 +750,47 @@ mod tests {\n         assert_eq!(d.len(), 1);\n     }\n \n+    #[test]\n+    fn test_with_capacity_non_power_two() {\n+        let mut d3 = RingBuf::with_capacity(3);\n+        d3.push(1i);\n+\n+        // X = None, | = lo\n+        // [|1, X, X]\n+        assert_eq!(d3.pop_front(), Some(1));\n+        // [X, |X, X]\n+        assert_eq!(d3.front(), None);\n+\n+        // [X, |3, X]\n+        d3.push(3);\n+        // [X, |3, 6]\n+        d3.push(6);\n+        // [X, X, |6]\n+        assert_eq!(d3.pop_front(), Some(3));\n+\n+        // Pushing the lo past half way point to trigger\n+        // the 'B' scenario for growth\n+        // [9, X, |6]\n+        d3.push(9);\n+        // [9, 12, |6]\n+        d3.push(12);\n+\n+        d3.push(15);\n+        // There used to be a bug here about how the\n+        // RingBuf made growth assumptions about the\n+        // underlying Vec which didn't hold and lead\n+        // to corruption.\n+        // (Vec grows to next power of two)\n+        //good- [9, 12, 15, X, X, X, X, |6]\n+        //bug-  [15, 12, X, X, X, |6, X, X]\n+        assert_eq!(d3.pop_front(), Some(6));\n+\n+        // Which leads us to the following state which\n+        // would be a failure case.\n+        //bug-  [15, 12, X, X, X, X, |X, X]\n+        assert_eq!(d3.front(), Some(&9));\n+    }\n+\n     #[test]\n     fn test_reserve_exact() {\n         let mut d = RingBuf::new();"}]}