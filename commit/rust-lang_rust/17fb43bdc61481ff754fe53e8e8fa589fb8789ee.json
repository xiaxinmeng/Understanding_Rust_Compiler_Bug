{"sha": "17fb43bdc61481ff754fe53e8e8fa589fb8789ee", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE3ZmI0M2JkYzYxNDgxZmY3NTRmZTUzZThlOGZhNTg5ZmI4Nzg5ZWU=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2017-12-07T01:59:33Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2017-12-07T14:53:49Z"}, "message": "rustc: Further tweak linkage in ThinLTO\n\nIn #46382 the logic around linkage preservation with ThinLTO ws tweaked but the\nloop that registered all otherwise exported GUID values as \"don't internalize\nme please\" was erroneously too conservative and only asking \"external\" linkage\nitems to not be internalized. Instead we actually want the inversion of that\ncondition, everything *without* \"local\" linkage to be internalized.\n\nThis commit updates the condition there, adds a test, and...\n\nCloses #46543", "tree": {"sha": "ba77e556c989eb628fc216facfe0d27840706499", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ba77e556c989eb628fc216facfe0d27840706499"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/17fb43bdc61481ff754fe53e8e8fa589fb8789ee", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/17fb43bdc61481ff754fe53e8e8fa589fb8789ee", "html_url": "https://github.com/rust-lang/rust/commit/17fb43bdc61481ff754fe53e8e8fa589fb8789ee", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/17fb43bdc61481ff754fe53e8e8fa589fb8789ee/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "833785b090c30d4a359d901fb41bfafbe1607ce9", "url": "https://api.github.com/repos/rust-lang/rust/commits/833785b090c30d4a359d901fb41bfafbe1607ce9", "html_url": "https://github.com/rust-lang/rust/commit/833785b090c30d4a359d901fb41bfafbe1607ce9"}], "stats": {"total": 39, "additions": 38, "deletions": 1}, "files": [{"sha": "072a9144f17a18ab3bca4e777128ef1dc60abbb8", "filename": "src/rustllvm/PassWrapper.cpp", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/17fb43bdc61481ff754fe53e8e8fa589fb8789ee/src%2Frustllvm%2FPassWrapper.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/17fb43bdc61481ff754fe53e8e8fa589fb8789ee/src%2Frustllvm%2FPassWrapper.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustllvm%2FPassWrapper.cpp?ref=17fb43bdc61481ff754fe53e8e8fa589fb8789ee", "patch": "@@ -970,7 +970,7 @@ LLVMRustCreateThinLTOData(LLVMRustThinLTOModule *modules,\n   std::set<GlobalValue::GUID> ExportedGUIDs;\n   for (auto &List : Ret->Index) {\n     for (auto &GVS: List.second) {\n-      if (!GlobalValue::isExternalLinkage(GVS->linkage()))\n+      if (GlobalValue::isLocalLinkage(GVS->linkage()))\n         continue;\n       auto GUID = GVS->getOriginalName();\n       if (!DeadSymbols.count(GUID))"}, {"sha": "b9719e04f34470b6e67804bf5e95a58be11a7a2f", "filename": "src/test/run-pass/thinlto/weak-works.rs", "status": "added", "additions": 37, "deletions": 0, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/17fb43bdc61481ff754fe53e8e8fa589fb8789ee/src%2Ftest%2Frun-pass%2Fthinlto%2Fweak-works.rs", "raw_url": "https://github.com/rust-lang/rust/raw/17fb43bdc61481ff754fe53e8e8fa589fb8789ee/src%2Ftest%2Frun-pass%2Fthinlto%2Fweak-works.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fthinlto%2Fweak-works.rs?ref=17fb43bdc61481ff754fe53e8e8fa589fb8789ee", "patch": "@@ -0,0 +1,37 @@\n+// Copyright 2017 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// compile-flags: -C codegen-units=8 -Z thinlto\n+// ignore-windows\n+// min-llvm-version 4.0\n+\n+#![feature(linkage)]\n+\n+pub mod foo {\n+    #[linkage = \"weak\"]\n+    #[no_mangle]\n+    pub extern \"C\" fn FOO() -> i32 {\n+        0\n+    }\n+}\n+\n+mod bar {\n+    extern \"C\" {\n+        fn FOO() -> i32;\n+    }\n+\n+    pub fn bar() -> i32 {\n+        unsafe { FOO() }\n+    }\n+}\n+\n+fn main() {\n+    bar::bar();\n+}"}]}