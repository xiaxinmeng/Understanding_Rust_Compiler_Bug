{"sha": "63396b30cf6e4f9148c7af8a21727b4d2109b632", "node_id": "C_kwDOAAsO6NoAKDYzMzk2YjMwY2Y2ZTRmOTE0OGM3YWY4YTIxNzI3YjRkMjEwOWI2MzI", "commit": {"author": {"name": "Thom Chiovoloni", "email": "thom@shift.click", "date": "2023-03-06T02:16:58Z"}, "committer": {"name": "Thom Chiovoloni", "email": "thom@shift.click", "date": "2023-03-06T02:16:58Z"}, "message": "Allow binary files to go through the `FileLoader`", "tree": {"sha": "f84515183871f57d8bdfe1bd5e9ae8c31981309e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f84515183871f57d8bdfe1bd5e9ae8c31981309e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/63396b30cf6e4f9148c7af8a21727b4d2109b632", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN SSH SIGNATURE-----\nU1NIU0lHAAAAAQAAADMAAAALc3NoLWVkMjU1MTkAAAAgMrDyZKNSLq6TEmWvPtNWv4vJNv\nay7sfrM7c6iOWHdh8AAAADZ2l0AAAAAAAAAAZzaGE1MTIAAABTAAAAC3NzaC1lZDI1NTE5\nAAAAQMvMz/vjDrhddOZhEQzGUWj2b/of9Hxx6LL73ZTbOUKzDlLtxh+FSJ72thI045BZaS\n9Hq9nSsed1qwY6ZZUohQ0=\n-----END SSH SIGNATURE-----", "payload": "tree f84515183871f57d8bdfe1bd5e9ae8c31981309e\nparent 816f958ac3db8931855c42649809aead01d20d9b\nauthor Thom Chiovoloni <thom@shift.click> 1678069018 -0800\ncommitter Thom Chiovoloni <thom@shift.click> 1678069018 -0800\n\nAllow binary files to go through the `FileLoader`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/63396b30cf6e4f9148c7af8a21727b4d2109b632", "html_url": "https://github.com/rust-lang/rust/commit/63396b30cf6e4f9148c7af8a21727b4d2109b632", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/63396b30cf6e4f9148c7af8a21727b4d2109b632/comments", "author": {"login": "thomcc", "id": 860665, "node_id": "MDQ6VXNlcjg2MDY2NQ==", "avatar_url": "https://avatars.githubusercontent.com/u/860665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/thomcc", "html_url": "https://github.com/thomcc", "followers_url": "https://api.github.com/users/thomcc/followers", "following_url": "https://api.github.com/users/thomcc/following{/other_user}", "gists_url": "https://api.github.com/users/thomcc/gists{/gist_id}", "starred_url": "https://api.github.com/users/thomcc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/thomcc/subscriptions", "organizations_url": "https://api.github.com/users/thomcc/orgs", "repos_url": "https://api.github.com/users/thomcc/repos", "events_url": "https://api.github.com/users/thomcc/events{/privacy}", "received_events_url": "https://api.github.com/users/thomcc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "thomcc", "id": 860665, "node_id": "MDQ6VXNlcjg2MDY2NQ==", "avatar_url": "https://avatars.githubusercontent.com/u/860665?v=4", "gravatar_id": "", "url": "https://api.github.com/users/thomcc", "html_url": "https://github.com/thomcc", "followers_url": "https://api.github.com/users/thomcc/followers", "following_url": "https://api.github.com/users/thomcc/following{/other_user}", "gists_url": "https://api.github.com/users/thomcc/gists{/gist_id}", "starred_url": "https://api.github.com/users/thomcc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/thomcc/subscriptions", "organizations_url": "https://api.github.com/users/thomcc/orgs", "repos_url": "https://api.github.com/users/thomcc/repos", "events_url": "https://api.github.com/users/thomcc/events{/privacy}", "received_events_url": "https://api.github.com/users/thomcc/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "816f958ac3db8931855c42649809aead01d20d9b", "url": "https://api.github.com/repos/rust-lang/rust/commits/816f958ac3db8931855c42649809aead01d20d9b", "html_url": "https://github.com/rust-lang/rust/commit/816f958ac3db8931855c42649809aead01d20d9b"}], "stats": {"total": 11, "additions": 8, "deletions": 3}, "files": [{"sha": "a1cb810a4293bbc7e0e6d2fd9701d0ebe6f00688", "filename": "compiler/rustc_span/src/source_map.rs", "status": "modified", "additions": 8, "deletions": 3, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/63396b30cf6e4f9148c7af8a21727b4d2109b632/compiler%2Frustc_span%2Fsrc%2Fsource_map.rs", "raw_url": "https://github.com/rust-lang/rust/raw/63396b30cf6e4f9148c7af8a21727b4d2109b632/compiler%2Frustc_span%2Fsrc%2Fsource_map.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_span%2Fsrc%2Fsource_map.rs?ref=63396b30cf6e4f9148c7af8a21727b4d2109b632", "patch": "@@ -100,6 +100,9 @@ pub trait FileLoader {\n \n     /// Read the contents of a UTF-8 file into memory.\n     fn read_file(&self, path: &Path) -> io::Result<String>;\n+\n+    /// Read the contents of a potentially non-UTF-8 file into memory.\n+    fn read_binary_file(&self, path: &Path) -> io::Result<Vec<u8>>;\n }\n \n /// A FileLoader that uses std::fs to load real files.\n@@ -113,6 +116,10 @@ impl FileLoader for RealFileLoader {\n     fn read_file(&self, path: &Path) -> io::Result<String> {\n         fs::read_to_string(path)\n     }\n+\n+    fn read_binary_file(&self, path: &Path) -> io::Result<Vec<u8>> {\n+        fs::read(path)\n+    }\n }\n \n /// This is a [SourceFile] identifier that is used to correlate source files between\n@@ -220,9 +227,7 @@ impl SourceMap {\n     /// Unlike `load_file`, guarantees that no normalization like BOM-removal\n     /// takes place.\n     pub fn load_binary_file(&self, path: &Path) -> io::Result<Vec<u8>> {\n-        // Ideally, this should use `self.file_loader`, but it can't\n-        // deal with binary files yet.\n-        let bytes = fs::read(path)?;\n+        let bytes = self.file_loader.read_binary_file(path)?;\n \n         // We need to add file to the `SourceMap`, so that it is present\n         // in dep-info. There's also an edge case that file might be both"}]}