{"sha": "39761b0cf9c603beb7862e6c7cbb796defb2be90", "node_id": "C_kwDOAAsO6NoAKDM5NzYxYjBjZjljNjAzYmViNzg2MmU2YzdjYmI3OTZkZWZiMmJlOTA", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2023-05-11T05:05:27Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-05-11T05:05:27Z"}, "message": "Rollup merge of #111382 - Zalathar:ffi, r=cuviper\n\nIsolate coverage FFI type layouts from their underlying LLVM C++ types\n\nI noticed that several of the types used to send coverage information through FFI are not properly isolated from the layout of their corresponding C++ types in the LLVM API.\n\nThis PR adds more explicitly-defined FFI struct/enum types in `CoverageMappingWrapper.cpp`, so that Rust source files in `rustc_codegen_ssa` and `rustc_codegen_llvm` aren't directly exposed to LLVM C++ types.", "tree": {"sha": "233f44f06ecfd34b1414b1cb5ca380f364e35a5b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/233f44f06ecfd34b1414b1cb5ca380f364e35a5b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/39761b0cf9c603beb7862e6c7cbb796defb2be90", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkXHeXCRBK7hj4Ov3rIwAAnzYIADYolknk3fstd0uhV4+Wagh2\nKyXZM7UKUvFLwUm4OX/5gg2M4o5uHxNZchAs4sVPESElMula3gqbx6y3B+4nIFPK\n+6slwfJuWfpWfXCYBWLX+SksJlBBbr7Op7FJPBLpxrCv1E4N0sWMmvWCq7KzAjXI\ny+3KmkUM3Tw8FHHxtjzv1LUQX3XEDKivpEUS1e99NIG+D5pLQ7ZuydcxKJL0gsTI\nMThlOdE1qi0fZc1r/iCsmPX7AbvnxZwKBBsgKMyEGhpUtYOOF1d22zQeMpRD/F+8\n0sxnj3oS87bU8PrynM6K61oFsfZamK9QyZaz+8g3emY5Kf8XWsvfPdlVNgJ0Sds=\n=jHkg\n-----END PGP SIGNATURE-----\n", "payload": "tree 233f44f06ecfd34b1414b1cb5ca380f364e35a5b\nparent aa9adf457b85a4c75f3b0f791338395b1bd367e5\nparent 9addf0651c2fc9174824ea7e28c2651c780ae968\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1683781527 +0200\ncommitter GitHub <noreply@github.com> 1683781527 +0200\n\nRollup merge of #111382 - Zalathar:ffi, r=cuviper\n\nIsolate coverage FFI type layouts from their underlying LLVM C++ types\n\nI noticed that several of the types used to send coverage information through FFI are not properly isolated from the layout of their corresponding C++ types in the LLVM API.\n\nThis PR adds more explicitly-defined FFI struct/enum types in `CoverageMappingWrapper.cpp`, so that Rust source files in `rustc_codegen_ssa` and `rustc_codegen_llvm` aren't directly exposed to LLVM C++ types.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/39761b0cf9c603beb7862e6c7cbb796defb2be90", "html_url": "https://github.com/rust-lang/rust/commit/39761b0cf9c603beb7862e6c7cbb796defb2be90", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/39761b0cf9c603beb7862e6c7cbb796defb2be90/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "aa9adf457b85a4c75f3b0f791338395b1bd367e5", "url": "https://api.github.com/repos/rust-lang/rust/commits/aa9adf457b85a4c75f3b0f791338395b1bd367e5", "html_url": "https://github.com/rust-lang/rust/commit/aa9adf457b85a4c75f3b0f791338395b1bd367e5"}, {"sha": "9addf0651c2fc9174824ea7e28c2651c780ae968", "url": "https://api.github.com/repos/rust-lang/rust/commits/9addf0651c2fc9174824ea7e28c2651c780ae968", "html_url": "https://github.com/rust-lang/rust/commit/9addf0651c2fc9174824ea7e28c2651c780ae968"}], "stats": {"total": 135, "additions": 118, "deletions": 17}, "files": [{"sha": "aefd5b2a13c92ad1cfe5034d1c7b7e6ff2d10ada", "filename": "compiler/rustc_codegen_llvm/src/llvm/ffi.rs", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/39761b0cf9c603beb7862e6c7cbb796defb2be90/compiler%2Frustc_codegen_llvm%2Fsrc%2Fllvm%2Fffi.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39761b0cf9c603beb7862e6c7cbb796defb2be90/compiler%2Frustc_codegen_llvm%2Fsrc%2Fllvm%2Fffi.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fllvm%2Fffi.rs?ref=39761b0cf9c603beb7862e6c7cbb796defb2be90", "patch": "@@ -680,7 +680,9 @@ pub type InlineAsmDiagHandlerTy = unsafe extern \"C\" fn(&SMDiagnostic, *const c_v\n pub mod coverageinfo {\n     use super::coverage_map;\n \n-    /// Aligns with [llvm::coverage::CounterMappingRegion::RegionKind](https://github.com/rust-lang/llvm-project/blob/rustc/13.0-2021-09-30/llvm/include/llvm/ProfileData/Coverage/CoverageMapping.h#L209-L230)\n+    /// Corresponds to enum `llvm::coverage::CounterMappingRegion::RegionKind`.\n+    ///\n+    /// Must match the layout of `LLVMRustCounterMappingRegionKind`.\n     #[derive(Copy, Clone, Debug)]\n     #[repr(C)]\n     pub enum RegionKind {\n@@ -714,7 +716,9 @@ pub mod coverageinfo {\n     /// array\", encoded separately), and source location (start and end positions of the represented\n     /// code region).\n     ///\n-    /// Matches LLVMRustCounterMappingRegion.\n+    /// Corresponds to struct `llvm::coverage::CounterMappingRegion`.\n+    ///\n+    /// Must match the layout of `LLVMRustCounterMappingRegion`.\n     #[derive(Copy, Clone, Debug)]\n     #[repr(C)]\n     pub struct CounterMappingRegion {"}, {"sha": "1791ce4b31559bcba88bba2c4cae5fa8c3f290f1", "filename": "compiler/rustc_codegen_ssa/src/coverageinfo/ffi.rs", "status": "modified", "additions": 11, "deletions": 7, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/39761b0cf9c603beb7862e6c7cbb796defb2be90/compiler%2Frustc_codegen_ssa%2Fsrc%2Fcoverageinfo%2Fffi.rs", "raw_url": "https://github.com/rust-lang/rust/raw/39761b0cf9c603beb7862e6c7cbb796defb2be90/compiler%2Frustc_codegen_ssa%2Fsrc%2Fcoverageinfo%2Fffi.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fcoverageinfo%2Fffi.rs?ref=39761b0cf9c603beb7862e6c7cbb796defb2be90", "patch": "@@ -1,6 +1,6 @@\n use rustc_middle::mir::coverage::{CounterValueReference, MappedExpressionIndex};\n \n-/// Aligns with [llvm::coverage::Counter::CounterKind](https://github.com/rust-lang/llvm-project/blob/rustc/13.0-2021-09-30/llvm/include/llvm/ProfileData/Coverage/CoverageMapping.h#L95)\n+/// Must match the layout of `LLVMRustCounterKind`.\n #[derive(Copy, Clone, Debug)]\n #[repr(C)]\n pub enum CounterKind {\n@@ -17,8 +17,10 @@ pub enum CounterKind {\n ///     `instrprof.increment()`)\n ///   * For `CounterKind::Expression`, `id` is the index into the coverage map's array of\n ///     counter expressions.\n-/// Aligns with [llvm::coverage::Counter](https://github.com/rust-lang/llvm-project/blob/rustc/13.0-2021-09-30/llvm/include/llvm/ProfileData/Coverage/CoverageMapping.h#L102-L103)\n-/// Important: The Rust struct layout (order and types of fields) must match its C++ counterpart.\n+///\n+/// Corresponds to struct `llvm::coverage::Counter`.\n+///\n+/// Must match the layout of `LLVMRustCounter`.\n #[derive(Copy, Clone, Debug)]\n #[repr(C)]\n pub struct Counter {\n@@ -59,17 +61,19 @@ impl Counter {\n     }\n }\n \n-/// Aligns with [llvm::coverage::CounterExpression::ExprKind](https://github.com/rust-lang/llvm-project/blob/rustc/13.0-2021-09-30/llvm/include/llvm/ProfileData/Coverage/CoverageMapping.h#L150)\n+/// Corresponds to enum `llvm::coverage::CounterExpression::ExprKind`.\n+///\n+/// Must match the layout of `LLVMRustCounterExprKind`.\n #[derive(Copy, Clone, Debug)]\n #[repr(C)]\n pub enum ExprKind {\n     Subtract = 0,\n     Add = 1,\n }\n \n-/// Aligns with [llvm::coverage::CounterExpression](https://github.com/rust-lang/llvm-project/blob/rustc/13.0-2021-09-30/llvm/include/llvm/ProfileData/Coverage/CoverageMapping.h#L151-L152)\n-/// Important: The Rust struct layout (order and types of fields) must match its C++\n-/// counterpart.\n+/// Corresponds to struct `llvm::coverage::CounterExpression`.\n+///\n+/// Must match the layout of `LLVMRustCounterExpression`.\n #[derive(Copy, Clone, Debug)]\n #[repr(C)]\n pub struct CounterExpression {"}, {"sha": "87906dee4d3481d4f59d3966d9e0a7e7ab0561c4", "filename": "compiler/rustc_llvm/llvm-wrapper/CoverageMappingWrapper.cpp", "status": "modified", "additions": 101, "deletions": 8, "changes": 109, "blob_url": "https://github.com/rust-lang/rust/blob/39761b0cf9c603beb7862e6c7cbb796defb2be90/compiler%2Frustc_llvm%2Fllvm-wrapper%2FCoverageMappingWrapper.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/39761b0cf9c603beb7862e6c7cbb796defb2be90/compiler%2Frustc_llvm%2Fllvm-wrapper%2FCoverageMappingWrapper.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_llvm%2Fllvm-wrapper%2FCoverageMappingWrapper.cpp?ref=39761b0cf9c603beb7862e6c7cbb796defb2be90", "patch": "@@ -8,18 +8,100 @@\n \n using namespace llvm;\n \n+// FFI equivalent of enum `llvm::coverage::Counter::CounterKind`\n+// https://github.com/rust-lang/llvm-project/blob/ea6fa9c2/llvm/include/llvm/ProfileData/Coverage/CoverageMapping.h#L97-L99\n+enum class LLVMRustCounterKind {\n+  Zero = 0,\n+  CounterValueReference = 1,\n+  Expression = 2,\n+};\n+\n+// FFI equivalent of struct `llvm::coverage::Counter`\n+// https://github.com/rust-lang/llvm-project/blob/ea6fa9c2/llvm/include/llvm/ProfileData/Coverage/CoverageMapping.h#L94-L149\n+struct LLVMRustCounter {\n+  LLVMRustCounterKind CounterKind;\n+  uint32_t ID;\n+};\n+\n+static coverage::Counter fromRust(LLVMRustCounter Counter) {\n+  switch (Counter.CounterKind) {\n+  case LLVMRustCounterKind::Zero:\n+    return coverage::Counter::getZero();\n+  case LLVMRustCounterKind::CounterValueReference:\n+    return coverage::Counter::getCounter(Counter.ID);\n+  case LLVMRustCounterKind::Expression:\n+    return coverage::Counter::getExpression(Counter.ID);\n+  }\n+  report_fatal_error(\"Bad LLVMRustCounterKind!\");\n+}\n+\n+// FFI equivalent of enum `llvm::coverage::CounterMappingRegion::RegionKind`\n+// https://github.com/rust-lang/llvm-project/blob/ea6fa9c2/llvm/include/llvm/ProfileData/Coverage/CoverageMapping.h#L213-L234\n+enum class LLVMRustCounterMappingRegionKind {\n+  CodeRegion = 0,\n+  ExpansionRegion = 1,\n+  SkippedRegion = 2,\n+  GapRegion = 3,\n+  BranchRegion = 4,\n+};\n+\n+static coverage::CounterMappingRegion::RegionKind\n+fromRust(LLVMRustCounterMappingRegionKind Kind) {\n+  switch (Kind) {\n+  case LLVMRustCounterMappingRegionKind::CodeRegion:\n+    return coverage::CounterMappingRegion::CodeRegion;\n+  case LLVMRustCounterMappingRegionKind::ExpansionRegion:\n+    return coverage::CounterMappingRegion::ExpansionRegion;\n+  case LLVMRustCounterMappingRegionKind::SkippedRegion:\n+    return coverage::CounterMappingRegion::SkippedRegion;\n+  case LLVMRustCounterMappingRegionKind::GapRegion:\n+    return coverage::CounterMappingRegion::GapRegion;\n+  case LLVMRustCounterMappingRegionKind::BranchRegion:\n+    return coverage::CounterMappingRegion::BranchRegion;\n+  }\n+  report_fatal_error(\"Bad LLVMRustCounterMappingRegionKind!\");\n+}\n+\n+// FFI equivalent of struct `llvm::coverage::CounterMappingRegion`\n+// https://github.com/rust-lang/llvm-project/blob/ea6fa9c2/llvm/include/llvm/ProfileData/Coverage/CoverageMapping.h#L211-L304\n struct LLVMRustCounterMappingRegion {\n-  coverage::Counter Count;\n-  coverage::Counter FalseCount;\n+  LLVMRustCounter Count;\n+  LLVMRustCounter FalseCount;\n   uint32_t FileID;\n   uint32_t ExpandedFileID;\n   uint32_t LineStart;\n   uint32_t ColumnStart;\n   uint32_t LineEnd;\n   uint32_t ColumnEnd;\n-  coverage::CounterMappingRegion::RegionKind Kind;\n+  LLVMRustCounterMappingRegionKind Kind;\n+};\n+\n+// FFI equivalent of enum `llvm::coverage::CounterExpression::ExprKind`\n+// https://github.com/rust-lang/llvm-project/blob/ea6fa9c2/llvm/include/llvm/ProfileData/Coverage/CoverageMapping.h#L154\n+enum class LLVMRustCounterExprKind {\n+  Subtract = 0,\n+  Add = 1,\n };\n \n+// FFI equivalent of struct `llvm::coverage::CounterExpression`\n+// https://github.com/rust-lang/llvm-project/blob/ea6fa9c2/llvm/include/llvm/ProfileData/Coverage/CoverageMapping.h#L151-L160\n+struct LLVMRustCounterExpression {\n+  LLVMRustCounterExprKind Kind;\n+  LLVMRustCounter LHS;\n+  LLVMRustCounter RHS;\n+};\n+\n+static coverage::CounterExpression::ExprKind\n+fromRust(LLVMRustCounterExprKind Kind) {\n+  switch (Kind) {\n+  case LLVMRustCounterExprKind::Subtract:\n+    return coverage::CounterExpression::Subtract;\n+  case LLVMRustCounterExprKind::Add:\n+    return coverage::CounterExpression::Add;\n+  }\n+  report_fatal_error(\"Bad LLVMRustCounterExprKind!\");\n+}\n+\n extern \"C\" void LLVMRustCoverageWriteFilenamesSectionToBuffer(\n     const char* const Filenames[],\n     size_t FilenamesLen,\n@@ -37,9 +119,9 @@ extern \"C\" void LLVMRustCoverageWriteFilenamesSectionToBuffer(\n extern \"C\" void LLVMRustCoverageWriteMappingToBuffer(\n     const unsigned *VirtualFileMappingIDs,\n     unsigned NumVirtualFileMappingIDs,\n-    const coverage::CounterExpression *Expressions,\n+    const LLVMRustCounterExpression *RustExpressions,\n     unsigned NumExpressions,\n-    LLVMRustCounterMappingRegion *RustMappingRegions,\n+    const LLVMRustCounterMappingRegion *RustMappingRegions,\n     unsigned NumMappingRegions,\n     RustStringRef BufferOut) {\n   // Convert from FFI representation to LLVM representation.\n@@ -48,13 +130,24 @@ extern \"C\" void LLVMRustCoverageWriteMappingToBuffer(\n   for (const auto &Region : ArrayRef<LLVMRustCounterMappingRegion>(\n            RustMappingRegions, NumMappingRegions)) {\n     MappingRegions.emplace_back(\n-        Region.Count, Region.FalseCount, Region.FileID, Region.ExpandedFileID,\n+        fromRust(Region.Count), fromRust(Region.FalseCount),\n+        Region.FileID, Region.ExpandedFileID,\n         Region.LineStart, Region.ColumnStart, Region.LineEnd, Region.ColumnEnd,\n-        Region.Kind);\n+        fromRust(Region.Kind));\n   }\n+\n+  std::vector<coverage::CounterExpression> Expressions;\n+  Expressions.reserve(NumExpressions);\n+  for (const auto &Expression :\n+       ArrayRef<LLVMRustCounterExpression>(RustExpressions, NumExpressions)) {\n+    Expressions.emplace_back(fromRust(Expression.Kind),\n+                             fromRust(Expression.LHS),\n+                             fromRust(Expression.RHS));\n+  }\n+\n   auto CoverageMappingWriter = coverage::CoverageMappingWriter(\n       ArrayRef<unsigned>(VirtualFileMappingIDs, NumVirtualFileMappingIDs),\n-      ArrayRef<coverage::CounterExpression>(Expressions, NumExpressions),\n+      Expressions,\n       MappingRegions);\n   RawRustStringOstream OS(BufferOut);\n   CoverageMappingWriter.write(OS);"}]}