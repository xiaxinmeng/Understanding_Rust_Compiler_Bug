{"sha": "31c7aae1136b4d80f0256e269ca8086fd3fbdddd", "node_id": "MDY6Q29tbWl0NzI0NzEyOjMxYzdhYWUxMTM2YjRkODBmMDI1NmUyNjljYTgwODZmZDNmYmRkZGQ=", "commit": {"author": {"name": "Andrew Paverd", "email": "andrew.paverd@microsoft.com", "date": "2020-07-14T14:27:42Z"}, "committer": {"name": "Andrew Paverd", "email": "andrew.paverd@microsoft.com", "date": "2020-07-14T14:27:42Z"}, "message": "Stabilize control-flow-guard codegen option", "tree": {"sha": "1cad41bdc1b23ac926a9ee9621e562dac3ea39f8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1cad41bdc1b23ac926a9ee9621e562dac3ea39f8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/31c7aae1136b4d80f0256e269ca8086fd3fbdddd", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/31c7aae1136b4d80f0256e269ca8086fd3fbdddd", "html_url": "https://github.com/rust-lang/rust/commit/31c7aae1136b4d80f0256e269ca8086fd3fbdddd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/31c7aae1136b4d80f0256e269ca8086fd3fbdddd/comments", "author": {"login": "ajpaverd", "id": 207321, "node_id": "MDQ6VXNlcjIwNzMyMQ==", "avatar_url": "https://avatars.githubusercontent.com/u/207321?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ajpaverd", "html_url": "https://github.com/ajpaverd", "followers_url": "https://api.github.com/users/ajpaverd/followers", "following_url": "https://api.github.com/users/ajpaverd/following{/other_user}", "gists_url": "https://api.github.com/users/ajpaverd/gists{/gist_id}", "starred_url": "https://api.github.com/users/ajpaverd/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ajpaverd/subscriptions", "organizations_url": "https://api.github.com/users/ajpaverd/orgs", "repos_url": "https://api.github.com/users/ajpaverd/repos", "events_url": "https://api.github.com/users/ajpaverd/events{/privacy}", "received_events_url": "https://api.github.com/users/ajpaverd/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ajpaverd", "id": 207321, "node_id": "MDQ6VXNlcjIwNzMyMQ==", "avatar_url": "https://avatars.githubusercontent.com/u/207321?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ajpaverd", "html_url": "https://github.com/ajpaverd", "followers_url": "https://api.github.com/users/ajpaverd/followers", "following_url": "https://api.github.com/users/ajpaverd/following{/other_user}", "gists_url": "https://api.github.com/users/ajpaverd/gists{/gist_id}", "starred_url": "https://api.github.com/users/ajpaverd/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ajpaverd/subscriptions", "organizations_url": "https://api.github.com/users/ajpaverd/orgs", "repos_url": "https://api.github.com/users/ajpaverd/repos", "events_url": "https://api.github.com/users/ajpaverd/events{/privacy}", "received_events_url": "https://api.github.com/users/ajpaverd/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c724b67e1b474262917a5154d74e7072267593fe", "url": "https://api.github.com/repos/rust-lang/rust/commits/c724b67e1b474262917a5154d74e7072267593fe", "html_url": "https://github.com/rust-lang/rust/commit/c724b67e1b474262917a5154d74e7072267593fe"}], "stats": {"total": 36, "additions": 24, "deletions": 12}, "files": [{"sha": "276e7ac558e31e6ab0eec9a1f33ade9e08fcc37c", "filename": "src/bootstrap/builder.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/31c7aae1136b4d80f0256e269ca8086fd3fbdddd/src%2Fbootstrap%2Fbuilder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/31c7aae1136b4d80f0256e269ca8086fd3fbdddd/src%2Fbootstrap%2Fbuilder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuilder.rs?ref=31c7aae1136b4d80f0256e269ca8086fd3fbdddd", "patch": "@@ -1231,7 +1231,7 @@ impl<'a> Builder<'a> {\n             && self.config.control_flow_guard\n             && compiler.stage >= 1\n         {\n-            rustflags.arg(\"-Zcontrol-flow-guard\");\n+            rustflags.arg(\"-Ccontrol-flow-guard\");\n         }\n \n         // For `cargo doc` invocations, make rustdoc print the Rust version into the docs"}, {"sha": "35904e15d3feeaa596f58772a70bcd92fb1cd848", "filename": "src/doc/rustc/src/codegen-options/index.md", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/31c7aae1136b4d80f0256e269ca8086fd3fbdddd/src%2Fdoc%2Frustc%2Fsrc%2Fcodegen-options%2Findex.md", "raw_url": "https://github.com/rust-lang/rust/raw/31c7aae1136b4d80f0256e269ca8086fd3fbdddd/src%2Fdoc%2Frustc%2Fsrc%2Fcodegen-options%2Findex.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Frustc%2Fsrc%2Fcodegen-options%2Findex.md?ref=31c7aae1136b4d80f0256e269ca8086fd3fbdddd", "patch": "@@ -42,6 +42,18 @@ generated code, but may be slower to compile.\n The default value, if not specified, is 16 for non-incremental builds. For\n incremental builds the default is 256 which allows caching to be more granular.\n \n+## control-flow-guard\n+\n+This flag controls whether LLVM enables the Windows [Control Flow \n+Guard](https://docs.microsoft.com/en-us/windows/win32/secbp/control-flow-guard) \n+platform security feature. This flag is currently ignored for non-Windows targets. \n+It takes one of the following values:\n+\n+* `y`, `yes`, `on`, `checks`, or no value: enable Control Flow Guard.\n+* `nochecks`: emit Control Flow Guard metadata without runtime enforcement checks (this \n+should only be used for testing purposes as it does not provide security enforcement).\n+* `n`, `no`, `off`: do not enable Control Flow Guard (the default).\n+\n ## debug-assertions\n \n This flag lets you turn `cfg(debug_assertions)` [conditional"}, {"sha": "a07f6c64edcb188e2853b56220ea291df892368a", "filename": "src/librustc_codegen_llvm/context.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/31c7aae1136b4d80f0256e269ca8086fd3fbdddd/src%2Flibrustc_codegen_llvm%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/31c7aae1136b4d80f0256e269ca8086fd3fbdddd/src%2Flibrustc_codegen_llvm%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fcontext.rs?ref=31c7aae1136b4d80f0256e269ca8086fd3fbdddd", "patch": "@@ -190,7 +190,7 @@ pub unsafe fn create_module(\n \n     // Control Flow Guard is currently only supported by the MSVC linker on Windows.\n     if sess.target.target.options.is_like_msvc {\n-        match sess.opts.debugging_opts.control_flow_guard {\n+        match sess.opts.cg.control_flow_guard {\n             CFGuard::Disabled => {}\n             CFGuard::NoChecks => {\n                 // Set `cfguard=1` module flag to emit metadata only."}, {"sha": "7f3aa4be9fdb6dd08e65511f35d4b7e956eb62b9", "filename": "src/librustc_codegen_ssa/back/link.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/31c7aae1136b4d80f0256e269ca8086fd3fbdddd/src%2Flibrustc_codegen_ssa%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/31c7aae1136b4d80f0256e269ca8086fd3fbdddd/src%2Flibrustc_codegen_ssa%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_ssa%2Fback%2Flink.rs?ref=31c7aae1136b4d80f0256e269ca8086fd3fbdddd", "patch": "@@ -1700,7 +1700,7 @@ fn linker_with_args<'a, B: ArchiveBuilder<'a>>(\n     }\n \n     // OBJECT-FILES-NO, AUDIT-ORDER\n-    if sess.opts.debugging_opts.control_flow_guard != CFGuard::Disabled {\n+    if sess.opts.cg.control_flow_guard != CFGuard::Disabled {\n         cmd.control_flow_guard();\n     }\n "}, {"sha": "dd09ce9e3dddf3627b7b0c0d9cb58c0166146ae0", "filename": "src/librustc_interface/tests.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/31c7aae1136b4d80f0256e269ca8086fd3fbdddd/src%2Flibrustc_interface%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/31c7aae1136b4d80f0256e269ca8086fd3fbdddd/src%2Flibrustc_interface%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_interface%2Ftests.rs?ref=31c7aae1136b4d80f0256e269ca8086fd3fbdddd", "patch": "@@ -420,6 +420,7 @@ fn test_codegen_options_tracking_hash() {\n     // Make sure that changing a [TRACKED] option changes the hash.\n     // This list is in alphabetical order.\n     tracked!(code_model, Some(CodeModel::Large));\n+    tracked!(control_flow_guard, CFGuard::Checks);\n     tracked!(debug_assertions, Some(true));\n     tracked!(debuginfo, 0xdeadbeef);\n     tracked!(embed_bitcode, false);\n@@ -537,7 +538,6 @@ fn test_debugging_options_tracking_hash() {\n     tracked!(binary_dep_depinfo, true);\n     tracked!(chalk, true);\n     tracked!(codegen_backend, Some(\"abc\".to_string()));\n-    tracked!(control_flow_guard, CFGuard::Checks);\n     tracked!(crate_attr, vec![\"abc\".to_string()]);\n     tracked!(debug_macros, true);\n     tracked!(dep_info_omit_d_target, true);"}, {"sha": "dbf5b7ece08fee5cf44105af2ab7b38727c73370", "filename": "src/librustc_session/config.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/31c7aae1136b4d80f0256e269ca8086fd3fbdddd/src%2Flibrustc_session%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/31c7aae1136b4d80f0256e269ca8086fd3fbdddd/src%2Flibrustc_session%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_session%2Fconfig.rs?ref=31c7aae1136b4d80f0256e269ca8086fd3fbdddd", "patch": "@@ -103,7 +103,7 @@ pub enum Strip {\n     Symbols,\n }\n \n-/// The different settings that the `-Z control-flow-guard` flag can have.\n+/// The different settings that the `-C control-flow-guard` flag can have.\n #[derive(Clone, Copy, PartialEq, Hash, Debug)]\n pub enum CFGuard {\n     /// Do not emit Control Flow Guard metadata or checks."}, {"sha": "62f6fca97466d0bb96d729667ec9d9ec0b59d0e8", "filename": "src/librustc_session/options.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/31c7aae1136b4d80f0256e269ca8086fd3fbdddd/src%2Flibrustc_session%2Foptions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/31c7aae1136b4d80f0256e269ca8086fd3fbdddd/src%2Flibrustc_session%2Foptions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_session%2Foptions.rs?ref=31c7aae1136b4d80f0256e269ca8086fd3fbdddd", "patch": "@@ -692,6 +692,8 @@ options! {CodegenOptions, CodegenSetter, basic_codegen_options,\n         \"choose the code model to use (`rustc --print code-models` for details)\"),\n     codegen_units: Option<usize> = (None, parse_opt_uint, [UNTRACKED],\n         \"divide crate into N units to optimize in parallel\"),\n+    control_flow_guard: CFGuard = (CFGuard::Disabled, parse_cfguard, [TRACKED],\n+        \"use Windows Control Flow Guard (default: no)\"),\n     debug_assertions: Option<bool> = (None, parse_opt_bool, [TRACKED],\n         \"explicitly enable the `cfg(debug_assertions)` directive\"),\n     debuginfo: usize = (0, parse_uint, [TRACKED],\n@@ -809,8 +811,6 @@ options! {DebuggingOptions, DebuggingSetter, basic_debugging_options,\n         \"enable the experimental Chalk-based trait solving engine\"),\n     codegen_backend: Option<String> = (None, parse_opt_string, [TRACKED],\n         \"the backend to use\"),\n-    control_flow_guard: CFGuard = (CFGuard::Disabled, parse_cfguard, [TRACKED],\n-        \"use Windows Control Flow Guard (default: no)\"),\n     crate_attr: Vec<String> = (Vec::new(), parse_string_push, [TRACKED],\n         \"inject the given attribute in the crate\"),\n     debug_macros: bool = (false, parse_bool, [TRACKED],"}, {"sha": "571a2654bcbfd2f6d7f6543479d009f6abe3cad7", "filename": "src/test/codegen/cfguard-checks.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/31c7aae1136b4d80f0256e269ca8086fd3fbdddd/src%2Ftest%2Fcodegen%2Fcfguard-checks.rs", "raw_url": "https://github.com/rust-lang/rust/raw/31c7aae1136b4d80f0256e269ca8086fd3fbdddd/src%2Ftest%2Fcodegen%2Fcfguard-checks.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fcfguard-checks.rs?ref=31c7aae1136b4d80f0256e269ca8086fd3fbdddd", "patch": "@@ -1,4 +1,4 @@\n-// compile-flags: -Z control-flow-guard=checks\n+// compile-flags: -C control-flow-guard=checks\n // only-msvc\n \n #![crate_type = \"lib\"]"}, {"sha": "c3f8f4116819ce2bf420dce85a50b7c7926dc24c", "filename": "src/test/codegen/cfguard-disabled.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/31c7aae1136b4d80f0256e269ca8086fd3fbdddd/src%2Ftest%2Fcodegen%2Fcfguard-disabled.rs", "raw_url": "https://github.com/rust-lang/rust/raw/31c7aae1136b4d80f0256e269ca8086fd3fbdddd/src%2Ftest%2Fcodegen%2Fcfguard-disabled.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fcfguard-disabled.rs?ref=31c7aae1136b4d80f0256e269ca8086fd3fbdddd", "patch": "@@ -1,4 +1,4 @@\n-// compile-flags: -Z control-flow-guard=no\n+// compile-flags: -C control-flow-guard=no\n // only-msvc\n \n #![crate_type = \"lib\"]"}, {"sha": "3847c3e81ed7a6d78f2e3e6b50741fb549c68431", "filename": "src/test/codegen/cfguard-nochecks.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/31c7aae1136b4d80f0256e269ca8086fd3fbdddd/src%2Ftest%2Fcodegen%2Fcfguard-nochecks.rs", "raw_url": "https://github.com/rust-lang/rust/raw/31c7aae1136b4d80f0256e269ca8086fd3fbdddd/src%2Ftest%2Fcodegen%2Fcfguard-nochecks.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fcfguard-nochecks.rs?ref=31c7aae1136b4d80f0256e269ca8086fd3fbdddd", "patch": "@@ -1,4 +1,4 @@\n-// compile-flags: -Z control-flow-guard=nochecks\n+// compile-flags: -C control-flow-guard=nochecks\n // only-msvc\n \n #![crate_type = \"lib\"]"}, {"sha": "6278a951e35f1565151946520f4919088e9b20eb", "filename": "src/test/codegen/cfguard-non-msvc.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/31c7aae1136b4d80f0256e269ca8086fd3fbdddd/src%2Ftest%2Fcodegen%2Fcfguard-non-msvc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/31c7aae1136b4d80f0256e269ca8086fd3fbdddd/src%2Ftest%2Fcodegen%2Fcfguard-non-msvc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fcfguard-non-msvc.rs?ref=31c7aae1136b4d80f0256e269ca8086fd3fbdddd", "patch": "@@ -1,4 +1,4 @@\n-// compile-flags: -Z control-flow-guard\n+// compile-flags: -C control-flow-guard\n // ignore-msvc\n \n #![crate_type = \"lib\"]"}, {"sha": "3c4f9a1f5ee2c3c0a433022517176f4abc0b7c56", "filename": "src/test/ui/cfguard-run.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/31c7aae1136b4d80f0256e269ca8086fd3fbdddd/src%2Ftest%2Fui%2Fcfguard-run.rs", "raw_url": "https://github.com/rust-lang/rust/raw/31c7aae1136b4d80f0256e269ca8086fd3fbdddd/src%2Ftest%2Fui%2Fcfguard-run.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcfguard-run.rs?ref=31c7aae1136b4d80f0256e269ca8086fd3fbdddd", "patch": "@@ -1,5 +1,5 @@\n // run-pass\n-// compile-flags: -Z control-flow-guard\n+// compile-flags: -C control-flow-guard\n \n pub fn main() {\n     println!(\"hello, world\");"}]}