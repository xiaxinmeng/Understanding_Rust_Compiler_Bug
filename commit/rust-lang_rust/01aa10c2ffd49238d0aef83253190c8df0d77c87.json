{"sha": "01aa10c2ffd49238d0aef83253190c8df0d77c87", "node_id": "C_kwDOAAsO6NoAKDAxYWExMGMyZmZkNDkyMzhkMGFlZjgzMjUzMTkwYzhkZjBkNzdjODc", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2022-07-01T21:39:07Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-07-01T21:39:07Z"}, "message": "Rollup merge of #98418 - topjohnwu:macos-dylib, r=jyn514\n\nAllow macOS to build LLVM as shared library\n\nInspired by how [homebrew](https://github.com/Homebrew/homebrew-core/blob/HEAD/Formula/llvm.rb) builds and distributes llvm, here we manually create a symlink with a versioned dylib path to make `llvm-config` work properly. Note, the resulting `rustc` executable and `librustc_driver-<hash>.dylib` still links to the un-versioned `libLLVM.dylib` as expected when distributed in the final output. I have confirmed this by checking `otool -L` on both binaries.\n\nAfter the change, enabling `llvm.link-shared` and `llvm.thin-lto` will be possible on macOS.", "tree": {"sha": "a6b1e1e54a7f726afb79df01a37b89a51c7c9fb2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a6b1e1e54a7f726afb79df01a37b89a51c7c9fb2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/01aa10c2ffd49238d0aef83253190c8df0d77c87", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJiv2l8CRBK7hj4Ov3rIwAAcrAIAABLQtD8fn5P0Gywi+kd1zpM\nLY+cC9KtguCAkDQoFHWY8RHbyKfo98f7LptMLtblbRRPpg5qa8cH4CFfOwFfKOja\nq8RdCtXuIkbvJPxi0z3iu/EtC0ZgldLYoHWKpkTOAdNPo3EE6T+V6nPNI9vyEGF8\n1/z8afBlKqNTEZkco8G/Jijrf9OgA2jqdtemvyBjhNXukNFhHhIBxiYmSW5hKDwU\nYg5ABmdSxjymQwG9+yRXPIs4W+ngS3kWeuJuRay70om/r2/gWxM9JY9Ibplmk6HL\nCGNy5zIs3QpgP/jGba/rRvObHSyAXsrHIkuyLSTS5Gggjq05g//iPw7bnN4DqjY=\n=PXPv\n-----END PGP SIGNATURE-----\n", "payload": "tree a6b1e1e54a7f726afb79df01a37b89a51c7c9fb2\nparent 194764fdc070d95ce2200548a2e6267d701068bd\nparent b6e28b59679e3e4ee47b20090035ef33889b3f3b\nauthor Guillaume Gomez <guillaume1.gomez@gmail.com> 1656711547 +0200\ncommitter GitHub <noreply@github.com> 1656711547 +0200\n\nRollup merge of #98418 - topjohnwu:macos-dylib, r=jyn514\n\nAllow macOS to build LLVM as shared library\n\nInspired by how [homebrew](https://github.com/Homebrew/homebrew-core/blob/HEAD/Formula/llvm.rb) builds and distributes llvm, here we manually create a symlink with a versioned dylib path to make `llvm-config` work properly. Note, the resulting `rustc` executable and `librustc_driver-<hash>.dylib` still links to the un-versioned `libLLVM.dylib` as expected when distributed in the final output. I have confirmed this by checking `otool -L` on both binaries.\n\nAfter the change, enabling `llvm.link-shared` and `llvm.thin-lto` will be possible on macOS.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/01aa10c2ffd49238d0aef83253190c8df0d77c87", "html_url": "https://github.com/rust-lang/rust/commit/01aa10c2ffd49238d0aef83253190c8df0d77c87", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/01aa10c2ffd49238d0aef83253190c8df0d77c87/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "194764fdc070d95ce2200548a2e6267d701068bd", "url": "https://api.github.com/repos/rust-lang/rust/commits/194764fdc070d95ce2200548a2e6267d701068bd", "html_url": "https://github.com/rust-lang/rust/commit/194764fdc070d95ce2200548a2e6267d701068bd"}, {"sha": "b6e28b59679e3e4ee47b20090035ef33889b3f3b", "url": "https://api.github.com/repos/rust-lang/rust/commits/b6e28b59679e3e4ee47b20090035ef33889b3f3b", "html_url": "https://github.com/rust-lang/rust/commit/b6e28b59679e3e4ee47b20090035ef33889b3f3b"}], "stats": {"total": 57, "additions": 41, "deletions": 16}, "files": [{"sha": "40ff0381c8bc16e5f563cc5d7c6c2af3e8247fbc", "filename": "src/bootstrap/lib.rs", "status": "modified", "additions": 10, "deletions": 6, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/01aa10c2ffd49238d0aef83253190c8df0d77c87/src%2Fbootstrap%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/01aa10c2ffd49238d0aef83253190c8df0d77c87/src%2Fbootstrap%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Flib.rs?ref=01aa10c2ffd49238d0aef83253190c8df0d77c87", "patch": "@@ -107,15 +107,11 @@ use std::cell::{Cell, RefCell};\n use std::collections::{HashMap, HashSet};\n use std::env;\n use std::fs::{self, File};\n+use std::io;\n use std::path::{Path, PathBuf};\n use std::process::{self, Command};\n use std::str;\n \n-#[cfg(unix)]\n-use std::os::unix::fs::symlink as symlink_file;\n-#[cfg(windows)]\n-use std::os::windows::fs::symlink_file;\n-\n use filetime::FileTime;\n use once_cell::sync::OnceCell;\n \n@@ -1460,7 +1456,7 @@ impl Build {\n                 src = t!(fs::canonicalize(src));\n             } else {\n                 let link = t!(fs::read_link(src));\n-                t!(symlink_file(link, dst));\n+                t!(self.symlink_file(link, dst));\n                 return;\n             }\n         }\n@@ -1585,6 +1581,14 @@ impl Build {\n         iter.map(|e| t!(e)).collect::<Vec<_>>().into_iter()\n     }\n \n+    fn symlink_file<P: AsRef<Path>, Q: AsRef<Path>>(&self, src: P, link: Q) -> io::Result<()> {\n+        #[cfg(unix)]\n+        use std::os::unix::fs::symlink as symlink_file;\n+        #[cfg(windows)]\n+        use std::os::windows::fs::symlink_file;\n+        if !self.config.dry_run { symlink_file(src.as_ref(), link.as_ref()) } else { Ok(()) }\n+    }\n+\n     fn remove(&self, f: &Path) {\n         if self.config.dry_run {\n             return;"}, {"sha": "8395be40f9b525e5ea2fd6c414602b0c1dbcef9a", "filename": "src/bootstrap/native.rs", "status": "modified", "additions": 31, "deletions": 10, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/01aa10c2ffd49238d0aef83253190c8df0d77c87/src%2Fbootstrap%2Fnative.rs", "raw_url": "https://github.com/rust-lang/rust/raw/01aa10c2ffd49238d0aef83253190c8df0d77c87/src%2Fbootstrap%2Fnative.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fnative.rs?ref=01aa10c2ffd49238d0aef83253190c8df0d77c87", "patch": "@@ -251,9 +251,7 @@ impl Step for Llvm {\n             };\n \n         builder.update_submodule(&Path::new(\"src\").join(\"llvm-project\"));\n-        if builder.llvm_link_shared()\n-            && (target.contains(\"windows\") || target.contains(\"apple-darwin\"))\n-        {\n+        if builder.llvm_link_shared() && target.contains(\"windows\") {\n             panic!(\"shared linking to LLVM is not currently supported on {}\", target.triple);\n         }\n \n@@ -359,7 +357,9 @@ impl Step for Llvm {\n         //\n         // If we're not linking rustc to a dynamic LLVM, though, then don't link\n         // tools to it.\n-        if builder.llvm_link_tools_dynamically(target) && builder.llvm_link_shared() {\n+        let llvm_link_shared =\n+            builder.llvm_link_tools_dynamically(target) && builder.llvm_link_shared();\n+        if llvm_link_shared {\n             cfg.define(\"LLVM_LINK_LLVM_DYLIB\", \"ON\");\n         }\n \n@@ -438,18 +438,18 @@ impl Step for Llvm {\n             );\n         }\n \n-        if let Some(ref suffix) = builder.config.llvm_version_suffix {\n+        let llvm_version_suffix = if let Some(ref suffix) = builder.config.llvm_version_suffix {\n             // Allow version-suffix=\"\" to not define a version suffix at all.\n-            if !suffix.is_empty() {\n-                cfg.define(\"LLVM_VERSION_SUFFIX\", suffix);\n-            }\n+            if !suffix.is_empty() { Some(suffix.to_string()) } else { None }\n         } else if builder.config.channel == \"dev\" {\n             // Changes to a version suffix require a complete rebuild of the LLVM.\n             // To avoid rebuilds during a time of version bump, don't include rustc\n             // release number on the dev channel.\n-            cfg.define(\"LLVM_VERSION_SUFFIX\", \"-rust-dev\");\n+            Some(\"-rust-dev\".to_string())\n         } else {\n-            let suffix = format!(\"-rust-{}-{}\", builder.version, builder.config.channel);\n+            Some(format!(\"-rust-{}-{}\", builder.version, builder.config.channel))\n+        };\n+        if let Some(ref suffix) = llvm_version_suffix {\n             cfg.define(\"LLVM_VERSION_SUFFIX\", suffix);\n         }\n \n@@ -478,6 +478,27 @@ impl Step for Llvm {\n \n         cfg.build();\n \n+        // When building LLVM with LLVM_LINK_LLVM_DYLIB for macOS, an unversioned\n+        // libLLVM.dylib will be built. However, llvm-config will still look\n+        // for a versioned path like libLLVM-14.dylib. Manually create a symbolic\n+        // link to make llvm-config happy.\n+        if llvm_link_shared && target.contains(\"apple-darwin\") {\n+            let mut cmd = Command::new(&build_llvm_config);\n+            let version = output(cmd.arg(\"--version\"));\n+            let major = version.split('.').next().unwrap();\n+            let lib_name = match llvm_version_suffix {\n+                Some(s) => format!(\"lib/libLLVM-{}{}.dylib\", major, s),\n+                None => format!(\"lib/libLLVM-{}.dylib\", major),\n+            };\n+\n+            // The reason why we build the library path from llvm-config is because\n+            // the output of llvm-config depends on its location in the file system.\n+            // Make sure we create the symlink exactly where it's needed.\n+            let llvm_base = build_llvm_config.parent().unwrap().parent().unwrap();\n+            let lib_llvm = llvm_base.join(lib_name);\n+            t!(builder.symlink_file(\"libLLVM.dylib\", &lib_llvm));\n+        }\n+\n         t!(stamp.write());\n \n         build_llvm_config"}]}