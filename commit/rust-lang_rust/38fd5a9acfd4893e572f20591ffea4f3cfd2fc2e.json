{"sha": "38fd5a9acfd4893e572f20591ffea4f3cfd2fc2e", "node_id": "C_kwDOAAsO6NoAKDM4ZmQ1YTlhY2ZkNDg5M2U1NzJmMjA1OTFmZmVhNGYzY2ZkMmZjMmU", "commit": {"author": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2022-12-29T02:26:59Z"}, "committer": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2022-12-29T02:30:18Z"}, "message": "Account for ADT bodies and struct expressions", "tree": {"sha": "915f00bd64d1abb9f1765917ab0fef03bb53eb42", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/915f00bd64d1abb9f1765917ab0fef03bb53eb42"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/38fd5a9acfd4893e572f20591ffea4f3cfd2fc2e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/38fd5a9acfd4893e572f20591ffea4f3cfd2fc2e", "html_url": "https://github.com/rust-lang/rust/commit/38fd5a9acfd4893e572f20591ffea4f3cfd2fc2e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/38fd5a9acfd4893e572f20591ffea4f3cfd2fc2e/comments", "author": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "committer": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "375f02580522ddacb4777d194d48d82454bb6aa9", "url": "https://api.github.com/repos/rust-lang/rust/commits/375f02580522ddacb4777d194d48d82454bb6aa9", "html_url": "https://github.com/rust-lang/rust/commit/375f02580522ddacb4777d194d48d82454bb6aa9"}], "stats": {"total": 144, "additions": 142, "deletions": 2}, "files": [{"sha": "1fc1ffd6cb6ed39e70463a7743fc48d8c9fabecd", "filename": "compiler/rustc_parse/src/parser/expr.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/38fd5a9acfd4893e572f20591ffea4f3cfd2fc2e/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/38fd5a9acfd4893e572f20591ffea4f3cfd2fc2e/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fexpr.rs?ref=38fd5a9acfd4893e572f20591ffea4f3cfd2fc2e", "patch": "@@ -3039,6 +3039,7 @@ impl<'a> Parser<'a> {\n     /// Parses `ident (COLON expr)?`.\n     fn parse_expr_field(&mut self) -> PResult<'a, ExprField> {\n         let attrs = self.parse_outer_attributes()?;\n+        self.recover_diff_marker();\n         self.collect_tokens_trailing_token(attrs, ForceCollect::No, |this, attrs| {\n             let lo = this.token.span;\n "}, {"sha": "b996ce0a15571737fdb3a757698650d1a6e15743", "filename": "compiler/rustc_parse/src/parser/item.rs", "status": "modified", "additions": 29, "deletions": 2, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/38fd5a9acfd4893e572f20591ffea4f3cfd2fc2e/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fitem.rs", "raw_url": "https://github.com/rust-lang/rust/raw/38fd5a9acfd4893e572f20591ffea4f3cfd2fc2e/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fitem.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fitem.rs?ref=38fd5a9acfd4893e572f20591ffea4f3cfd2fc2e", "patch": "@@ -1385,7 +1385,9 @@ impl<'a> Parser<'a> {\n     }\n \n     fn parse_enum_variant(&mut self) -> PResult<'a, Option<Variant>> {\n+        self.recover_diff_marker();\n         let variant_attrs = self.parse_outer_attributes()?;\n+        self.recover_diff_marker();\n         self.collect_tokens_trailing_token(\n             variant_attrs,\n             ForceCollect::No,\n@@ -1579,9 +1581,32 @@ impl<'a> Parser<'a> {\n         self.parse_paren_comma_seq(|p| {\n             let attrs = p.parse_outer_attributes()?;\n             p.collect_tokens_trailing_token(attrs, ForceCollect::No, |p, attrs| {\n+                let mut snapshot = None;\n+                if p.is_diff_marker(&TokenKind::BinOp(token::Shl), &TokenKind::Lt) {\n+                    // Account for `<<<<<<<` diff markers. We can't proactivelly error here because\n+                    // that can be a valid type start, so we snapshot and reparse only we've\n+                    // encountered another parse error.\n+                    snapshot = Some(p.create_snapshot_for_diagnostic());\n+                }\n                 let lo = p.token.span;\n-                let vis = p.parse_visibility(FollowedByType::Yes)?;\n-                let ty = p.parse_ty()?;\n+                let vis = match p.parse_visibility(FollowedByType::Yes) {\n+                    Ok(vis) => vis,\n+                    Err(err) => {\n+                        if let Some(ref mut snapshot) = snapshot {\n+                            snapshot.recover_diff_marker();\n+                        }\n+                        return Err(err);\n+                    }\n+                };\n+                let ty = match p.parse_ty() {\n+                    Ok(ty) => ty,\n+                    Err(err) => {\n+                        if let Some(ref mut snapshot) = snapshot {\n+                            snapshot.recover_diff_marker();\n+                        }\n+                        return Err(err);\n+                    }\n+                };\n \n                 Ok((\n                     FieldDef {\n@@ -1602,7 +1627,9 @@ impl<'a> Parser<'a> {\n \n     /// Parses an element of a struct declaration.\n     fn parse_field_def(&mut self, adt_ty: &str) -> PResult<'a, FieldDef> {\n+        self.recover_diff_marker();\n         let attrs = self.parse_outer_attributes()?;\n+        self.recover_diff_marker();\n         self.collect_tokens_trailing_token(attrs, ForceCollect::No, |this, attrs| {\n             let lo = this.token.span;\n             let vis = this.parse_visibility(FollowedByType::No)?;"}, {"sha": "d8c527281de1838b04eeb77f3e0ed9d633bf8239", "filename": "src/test/ui/parser/diff-markers/enum-2.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/38fd5a9acfd4893e572f20591ffea4f3cfd2fc2e/src%2Ftest%2Fui%2Fparser%2Fdiff-markers%2Fenum-2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/38fd5a9acfd4893e572f20591ffea4f3cfd2fc2e/src%2Ftest%2Fui%2Fparser%2Fdiff-markers%2Fenum-2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fdiff-markers%2Fenum-2.rs?ref=38fd5a9acfd4893e572f20591ffea4f3cfd2fc2e", "patch": "@@ -0,0 +1,9 @@\n+enum E {\n+    Foo {\n+<<<<<<< HEAD //~ ERROR encountered diff marker\n+        x: u8,\n+=======\n+        x: i8,\n+>>>>>>> branch\n+    }\n+}"}, {"sha": "5264a5964884c89eded817db3319e6eb64cda60e", "filename": "src/test/ui/parser/diff-markers/enum-2.stderr", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/38fd5a9acfd4893e572f20591ffea4f3cfd2fc2e/src%2Ftest%2Fui%2Fparser%2Fdiff-markers%2Fenum-2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/38fd5a9acfd4893e572f20591ffea4f3cfd2fc2e/src%2Ftest%2Fui%2Fparser%2Fdiff-markers%2Fenum-2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fdiff-markers%2Fenum-2.stderr?ref=38fd5a9acfd4893e572f20591ffea4f3cfd2fc2e", "patch": "@@ -0,0 +1,14 @@\n+error: encountered diff marker\n+  --> $DIR/enum-2.rs:3:1\n+   |\n+LL | <<<<<<< HEAD\n+   | ^^^^^^^ start\n+LL |         x: u8,\n+LL | =======\n+   | ^^^^^^^ middle\n+LL |         x: i8,\n+LL | >>>>>>> branch\n+   | ^^^^^^^ end\n+\n+error: aborting due to previous error\n+"}, {"sha": "45df6e3251d763d0dfb0ba5a24ca3cd2b0fbfc75", "filename": "src/test/ui/parser/diff-markers/enum.rs", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/38fd5a9acfd4893e572f20591ffea4f3cfd2fc2e/src%2Ftest%2Fui%2Fparser%2Fdiff-markers%2Fenum.rs", "raw_url": "https://github.com/rust-lang/rust/raw/38fd5a9acfd4893e572f20591ffea4f3cfd2fc2e/src%2Ftest%2Fui%2Fparser%2Fdiff-markers%2Fenum.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fdiff-markers%2Fenum.rs?ref=38fd5a9acfd4893e572f20591ffea4f3cfd2fc2e", "patch": "@@ -0,0 +1,7 @@\n+enum E {\n+<<<<<<< HEAD //~ ERROR encountered diff marker\n+    Foo(u8),\n+=======\n+    Bar(i8),\n+>>>>>>> branch\n+}"}, {"sha": "6bdc20d3cd3248967e905754c4792deece0ddba1", "filename": "src/test/ui/parser/diff-markers/enum.stderr", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/38fd5a9acfd4893e572f20591ffea4f3cfd2fc2e/src%2Ftest%2Fui%2Fparser%2Fdiff-markers%2Fenum.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/38fd5a9acfd4893e572f20591ffea4f3cfd2fc2e/src%2Ftest%2Fui%2Fparser%2Fdiff-markers%2Fenum.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fdiff-markers%2Fenum.stderr?ref=38fd5a9acfd4893e572f20591ffea4f3cfd2fc2e", "patch": "@@ -0,0 +1,14 @@\n+error: encountered diff marker\n+  --> $DIR/enum.rs:2:1\n+   |\n+LL | <<<<<<< HEAD\n+   | ^^^^^^^ start\n+LL |     Foo(u8),\n+LL | =======\n+   | ^^^^^^^ middle\n+LL |     Bar(i8),\n+LL | >>>>>>> branch\n+   | ^^^^^^^ end\n+\n+error: aborting due to previous error\n+"}, {"sha": "99d2fd662c69ca70084ba1b6e1cf00adeec49f11", "filename": "src/test/ui/parser/diff-markers/struct-expr.rs", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/38fd5a9acfd4893e572f20591ffea4f3cfd2fc2e/src%2Ftest%2Fui%2Fparser%2Fdiff-markers%2Fstruct-expr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/38fd5a9acfd4893e572f20591ffea4f3cfd2fc2e/src%2Ftest%2Fui%2Fparser%2Fdiff-markers%2Fstruct-expr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fdiff-markers%2Fstruct-expr.rs?ref=38fd5a9acfd4893e572f20591ffea4f3cfd2fc2e", "patch": "@@ -0,0 +1,12 @@\n+struct S {\n+    x: u8,\n+}\n+fn main() {\n+    let _ = S {\n+<<<<<<< HEAD //~ ERROR encountered diff marker\n+        x: 42,\n+=======\n+        x: 0,\n+>>>>>>> branch\n+    }\n+}"}, {"sha": "0ddb1a301e3424fe8ef0dc1a1130e4bd816110bf", "filename": "src/test/ui/parser/diff-markers/struct-expr.stderr", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/38fd5a9acfd4893e572f20591ffea4f3cfd2fc2e/src%2Ftest%2Fui%2Fparser%2Fdiff-markers%2Fstruct-expr.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/38fd5a9acfd4893e572f20591ffea4f3cfd2fc2e/src%2Ftest%2Fui%2Fparser%2Fdiff-markers%2Fstruct-expr.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fdiff-markers%2Fstruct-expr.stderr?ref=38fd5a9acfd4893e572f20591ffea4f3cfd2fc2e", "patch": "@@ -0,0 +1,14 @@\n+error: encountered diff marker\n+  --> $DIR/struct-expr.rs:6:1\n+   |\n+LL | <<<<<<< HEAD\n+   | ^^^^^^^ start\n+LL |         x: 42,\n+LL | =======\n+   | ^^^^^^^ middle\n+LL |         x: 0,\n+LL | >>>>>>> branch\n+   | ^^^^^^^ end\n+\n+error: aborting due to previous error\n+"}, {"sha": "d26464d47bcef1b0801891c03d0f7586f8f47f18", "filename": "src/test/ui/parser/diff-markers/struct.rs", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/38fd5a9acfd4893e572f20591ffea4f3cfd2fc2e/src%2Ftest%2Fui%2Fparser%2Fdiff-markers%2Fstruct.rs", "raw_url": "https://github.com/rust-lang/rust/raw/38fd5a9acfd4893e572f20591ffea4f3cfd2fc2e/src%2Ftest%2Fui%2Fparser%2Fdiff-markers%2Fstruct.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fdiff-markers%2Fstruct.rs?ref=38fd5a9acfd4893e572f20591ffea4f3cfd2fc2e", "patch": "@@ -0,0 +1,7 @@\n+struct S {\n+<<<<<<< HEAD //~ ERROR encountered diff marker\n+    x: u8,\n+=======\n+    x: i8,\n+>>>>>>> branch\n+}"}, {"sha": "e47bcfdaedcd30b79fd1078ae59df76e3efd41a9", "filename": "src/test/ui/parser/diff-markers/struct.stderr", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/38fd5a9acfd4893e572f20591ffea4f3cfd2fc2e/src%2Ftest%2Fui%2Fparser%2Fdiff-markers%2Fstruct.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/38fd5a9acfd4893e572f20591ffea4f3cfd2fc2e/src%2Ftest%2Fui%2Fparser%2Fdiff-markers%2Fstruct.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fdiff-markers%2Fstruct.stderr?ref=38fd5a9acfd4893e572f20591ffea4f3cfd2fc2e", "patch": "@@ -0,0 +1,14 @@\n+error: encountered diff marker\n+  --> $DIR/struct.rs:2:1\n+   |\n+LL | <<<<<<< HEAD\n+   | ^^^^^^^ start\n+LL |     x: u8,\n+LL | =======\n+   | ^^^^^^^ middle\n+LL |     x: i8,\n+LL | >>>>>>> branch\n+   | ^^^^^^^ end\n+\n+error: aborting due to previous error\n+"}, {"sha": "7eec35c968da30e7d286e77f1151413621f7e3bb", "filename": "src/test/ui/parser/diff-markers/tuple-struct.rs", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/38fd5a9acfd4893e572f20591ffea4f3cfd2fc2e/src%2Ftest%2Fui%2Fparser%2Fdiff-markers%2Ftuple-struct.rs", "raw_url": "https://github.com/rust-lang/rust/raw/38fd5a9acfd4893e572f20591ffea4f3cfd2fc2e/src%2Ftest%2Fui%2Fparser%2Fdiff-markers%2Ftuple-struct.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fdiff-markers%2Ftuple-struct.rs?ref=38fd5a9acfd4893e572f20591ffea4f3cfd2fc2e", "patch": "@@ -0,0 +1,7 @@\n+struct S(\n+<<<<<<< HEAD //~ ERROR encountered diff marker\n+    u8,\n+=======\n+    i8,\n+>>>>>>> branch\n+);"}, {"sha": "7f30cbcc1f74af0ce5d87cbb2e0f9285a1b7ccb3", "filename": "src/test/ui/parser/diff-markers/tuple-struct.stderr", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/38fd5a9acfd4893e572f20591ffea4f3cfd2fc2e/src%2Ftest%2Fui%2Fparser%2Fdiff-markers%2Ftuple-struct.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/38fd5a9acfd4893e572f20591ffea4f3cfd2fc2e/src%2Ftest%2Fui%2Fparser%2Fdiff-markers%2Ftuple-struct.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fdiff-markers%2Ftuple-struct.stderr?ref=38fd5a9acfd4893e572f20591ffea4f3cfd2fc2e", "patch": "@@ -0,0 +1,14 @@\n+error: encountered diff marker\n+  --> $DIR/tuple-struct.rs:2:1\n+   |\n+LL | <<<<<<< HEAD\n+   | ^^^^^^^ start\n+LL |     u8,\n+LL | =======\n+   | ^^^^^^^ middle\n+LL |     i8,\n+LL | >>>>>>> branch\n+   | ^^^^^^^ end\n+\n+error: aborting due to previous error\n+"}]}