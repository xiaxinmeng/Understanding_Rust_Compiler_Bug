{"sha": "b52522ade1f6979a35b24087dadcf5ba5c981cbe", "node_id": "MDY6Q29tbWl0NzI0NzEyOmI1MjUyMmFkZTFmNjk3OWEzNWIyNDA4N2RhZGNmNWJhNWM5ODFjYmU=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-07-21T03:09:04Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-07-21T03:09:04Z"}, "message": "Auto merge of #69749 - davidtwco:issue-46477-polymorphization, r=eddyb\n\nPolymorphization\n\nThis PR implements an analysis to detect when functions could remain polymorphic during code generation.\n\nFixes #46477\n\nr? @eddyb\ncc @rust-lang/wg-mir-opt @nikomatsakis @pnkfelix", "tree": {"sha": "67c849a1e6ac611aa3a4eb502b92c9e88c0e225c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/67c849a1e6ac611aa3a4eb502b92c9e88c0e225c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b52522ade1f6979a35b24087dadcf5ba5c981cbe", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b52522ade1f6979a35b24087dadcf5ba5c981cbe", "html_url": "https://github.com/rust-lang/rust/commit/b52522ade1f6979a35b24087dadcf5ba5c981cbe", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b52522ade1f6979a35b24087dadcf5ba5c981cbe/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "734233d29771869f824d8ddbaddabb90b3b68e03", "url": "https://api.github.com/repos/rust-lang/rust/commits/734233d29771869f824d8ddbaddabb90b3b68e03", "html_url": "https://github.com/rust-lang/rust/commit/734233d29771869f824d8ddbaddabb90b3b68e03"}, {"sha": "4b99699c8407f38df1e0ec1c22488c558d414582", "url": "https://api.github.com/repos/rust-lang/rust/commits/4b99699c8407f38df1e0ec1c22488c558d414582", "html_url": "https://github.com/rust-lang/rust/commit/4b99699c8407f38df1e0ec1c22488c558d414582"}], "stats": {"total": 2225, "additions": 2034, "deletions": 191}, "files": [{"sha": "75b4f2e3ca5a55aa0e4bb6dd79d3ccc6f76f4495", "filename": "src/librustc_codegen_llvm/callee.rs", "status": "modified", "additions": 7, "deletions": 3, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_codegen_llvm%2Fcallee.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_codegen_llvm%2Fcallee.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fcallee.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -13,7 +13,7 @@ use log::debug;\n use rustc_codegen_ssa::traits::*;\n \n use rustc_middle::ty::layout::{FnAbiExt, HasTyCtxt};\n-use rustc_middle::ty::{Instance, TypeFoldable};\n+use rustc_middle::ty::{self, Instance, TypeFoldable};\n \n /// Codegens a reference to a fn/method item, monomorphizing and\n /// inlining as it goes.\n@@ -29,14 +29,18 @@ pub fn get_fn(cx: &CodegenCx<'ll, 'tcx>, instance: Instance<'tcx>) -> &'ll Value\n \n     assert!(!instance.substs.needs_infer());\n     assert!(!instance.substs.has_escaping_bound_vars());\n-    assert!(!instance.substs.has_param_types_or_consts());\n \n     if let Some(&llfn) = cx.instances.borrow().get(&instance) {\n         return llfn;\n     }\n \n     let sym = tcx.symbol_name(instance).name;\n-    debug!(\"get_fn({:?}: {:?}) => {}\", instance, instance.monomorphic_ty(cx.tcx()), sym);\n+    debug!(\n+        \"get_fn({:?}: {:?}) => {}\",\n+        instance,\n+        instance.ty(cx.tcx(), ty::ParamEnv::reveal_all()),\n+        sym\n+    );\n \n     let fn_abi = FnAbi::of_instance(cx, instance, &[]);\n "}, {"sha": "e8d475405096af3d2e64a6b33831987fe484edee", "filename": "src/librustc_codegen_llvm/consts.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_codegen_llvm%2Fconsts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_codegen_llvm%2Fconsts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fconsts.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -203,7 +203,7 @@ impl CodegenCx<'ll, 'tcx> {\n             def_id\n         );\n \n-        let ty = instance.monomorphic_ty(self.tcx);\n+        let ty = instance.ty(self.tcx, ty::ParamEnv::reveal_all());\n         let sym = self.tcx.symbol_name(instance).name;\n \n         debug!(\"get_static: sym={} instance={:?}\", sym, instance);\n@@ -361,7 +361,7 @@ impl StaticMethods for CodegenCx<'ll, 'tcx> {\n             };\n \n             let instance = Instance::mono(self.tcx, def_id);\n-            let ty = instance.monomorphic_ty(self.tcx);\n+            let ty = instance.ty(self.tcx, ty::ParamEnv::reveal_all());\n             let llty = self.layout_of(ty).llvm_type(self);\n             let g = if val_llty == llty {\n                 g"}, {"sha": "6ae7c7efaee62b4933c33d8d578493e348a9fa55", "filename": "src/librustc_codegen_llvm/debuginfo/metadata.rs", "status": "modified", "additions": 17, "deletions": 1, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_codegen_llvm%2Fdebuginfo%2Fmetadata.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_codegen_llvm%2Fdebuginfo%2Fmetadata.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fdebuginfo%2Fmetadata.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -700,6 +700,8 @@ pub fn type_metadata(cx: &CodegenCx<'ll, 'tcx>, t: Ty<'tcx>, usage_site_span: Sp\n             prepare_tuple_metadata(cx, t, &tys, unique_type_id, usage_site_span, NO_SCOPE_METADATA)\n                 .finalize(cx)\n         }\n+        // Type parameters from polymorphized functions.\n+        ty::Param(_) => MetadataCreationResult::new(param_type_metadata(cx, t), false),\n         _ => bug!(\"debuginfo: unexpected type in type_metadata: {:?}\", t),\n     };\n \n@@ -955,6 +957,20 @@ fn pointer_type_metadata(\n     }\n }\n \n+fn param_type_metadata(cx: &CodegenCx<'ll, 'tcx>, t: Ty<'tcx>) -> &'ll DIType {\n+    debug!(\"param_type_metadata: {:?}\", t);\n+    let name = format!(\"{:?}\", t);\n+    return unsafe {\n+        llvm::LLVMRustDIBuilderCreateBasicType(\n+            DIB(cx),\n+            name.as_ptr().cast(),\n+            name.len(),\n+            Size::ZERO.bits(),\n+            DW_ATE_unsigned,\n+        )\n+    };\n+}\n+\n pub fn compile_unit_metadata(\n     tcx: TyCtxt<'_>,\n     codegen_unit_name: &str,\n@@ -2465,7 +2481,7 @@ pub fn create_global_var_metadata(cx: &CodegenCx<'ll, '_>, def_id: DefId, global\n     };\n \n     let is_local_to_unit = is_node_local_to_unit(cx, def_id);\n-    let variable_type = Instance::mono(cx.tcx, def_id).monomorphic_ty(cx.tcx);\n+    let variable_type = Instance::mono(cx.tcx, def_id).ty(cx.tcx, ty::ParamEnv::reveal_all());\n     let type_metadata = type_metadata(cx, variable_type, span);\n     let var_name = tcx.item_name(def_id).as_str();\n     let linkage_name = mangled_name_of_instance(cx, Instance::mono(tcx, def_id)).name;"}, {"sha": "a01b8553721290697e789f760c95cc084718a72a", "filename": "src/librustc_codegen_llvm/debuginfo/mod.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_codegen_llvm%2Fdebuginfo%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_codegen_llvm%2Fdebuginfo%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fdebuginfo%2Fmod.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -26,7 +26,7 @@ use rustc_index::vec::IndexVec;\n use rustc_middle::mir;\n use rustc_middle::ty::layout::HasTyCtxt;\n use rustc_middle::ty::subst::{GenericArgKind, SubstsRef};\n-use rustc_middle::ty::{self, Instance, ParamEnv, Ty};\n+use rustc_middle::ty::{self, Instance, ParamEnv, Ty, TypeFoldable};\n use rustc_session::config::{self, DebugInfo};\n use rustc_span::symbol::Symbol;\n use rustc_span::{self, BytePos, Span};\n@@ -470,7 +470,9 @@ impl DebugInfoMethods<'tcx> for CodegenCx<'ll, 'tcx> {\n                     match impl_self_ty.kind {\n                         ty::Adt(def, ..) if !def.is_box() => {\n                             // Again, only create type information if full debuginfo is enabled\n-                            if cx.sess().opts.debuginfo == DebugInfo::Full {\n+                            if cx.sess().opts.debuginfo == DebugInfo::Full\n+                                && !impl_self_ty.needs_subst()\n+                            {\n                                 Some(type_metadata(cx, impl_self_ty, rustc_span::DUMMY_SP))\n                             } else {\n                                 Some(namespace::item_namespace(cx, def.did))"}, {"sha": "2e5929a433de040cb8b49e0f1e78355a096bf170", "filename": "src/librustc_codegen_llvm/intrinsic.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_codegen_llvm%2Fintrinsic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_codegen_llvm%2Fintrinsic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fintrinsic.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -160,7 +160,7 @@ impl IntrinsicCallMethods<'tcx> for Builder<'a, 'll, 'tcx> {\n         caller_instance: ty::Instance<'tcx>,\n     ) {\n         let tcx = self.tcx;\n-        let callee_ty = instance.monomorphic_ty(tcx);\n+        let callee_ty = instance.ty(tcx, ty::ParamEnv::reveal_all());\n \n         let (def_id, substs) = match callee_ty.kind {\n             ty::FnDef(def_id, substs) => (def_id, substs),"}, {"sha": "0936deb7bb5a9c26d916e2a088d4e2cf5b98bd82", "filename": "src/librustc_codegen_llvm/mono_item.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_codegen_llvm%2Fmono_item.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_codegen_llvm%2Fmono_item.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fmono_item.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -10,7 +10,7 @@ use rustc_hir::def_id::{DefId, LOCAL_CRATE};\n pub use rustc_middle::mir::mono::MonoItem;\n use rustc_middle::mir::mono::{Linkage, Visibility};\n use rustc_middle::ty::layout::FnAbiExt;\n-use rustc_middle::ty::{Instance, TypeFoldable};\n+use rustc_middle::ty::{self, Instance, TypeFoldable};\n use rustc_target::abi::LayoutOf;\n \n impl PreDefineMethods<'tcx> for CodegenCx<'ll, 'tcx> {\n@@ -22,7 +22,7 @@ impl PreDefineMethods<'tcx> for CodegenCx<'ll, 'tcx> {\n         symbol_name: &str,\n     ) {\n         let instance = Instance::mono(self.tcx, def_id);\n-        let ty = instance.monomorphic_ty(self.tcx);\n+        let ty = instance.ty(self.tcx, ty::ParamEnv::reveal_all());\n         let llty = self.layout_of(ty).llvm_type(self);\n \n         let g = self.define_global(symbol_name, llty).unwrap_or_else(|| {\n@@ -47,7 +47,7 @@ impl PreDefineMethods<'tcx> for CodegenCx<'ll, 'tcx> {\n         visibility: Visibility,\n         symbol_name: &str,\n     ) {\n-        assert!(!instance.substs.needs_infer() && !instance.substs.has_param_types_or_consts());\n+        assert!(!instance.substs.needs_infer());\n \n         let fn_abi = FnAbi::of_instance(self, instance, &[]);\n         let lldecl = self.declare_fn(symbol_name, &fn_abi);"}, {"sha": "fb8f5a6298911f23584790e9cf62b39db5ec189d", "filename": "src/librustc_codegen_ssa/debuginfo/type_names.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_codegen_ssa%2Fdebuginfo%2Ftype_names.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_codegen_ssa%2Fdebuginfo%2Ftype_names.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_ssa%2Fdebuginfo%2Ftype_names.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -205,14 +205,17 @@ pub fn push_debuginfo_type_name<'tcx>(\n                 tcx.def_key(def_id).disambiguated_data.disambiguator\n             ));\n         }\n+        // Type parameters from polymorphized functions.\n+        ty::Param(_) => {\n+            output.push_str(&format!(\"{:?}\", t));\n+        }\n         ty::Error(_)\n         | ty::Infer(_)\n         | ty::Placeholder(..)\n         | ty::Projection(..)\n         | ty::Bound(..)\n         | ty::Opaque(..)\n-        | ty::GeneratorWitness(..)\n-        | ty::Param(_) => {\n+        | ty::GeneratorWitness(..) => {\n             bug!(\n                 \"debuginfo: Trying to create type name for \\\n                   unexpected type: {:?}\","}, {"sha": "cfa01280e5a97f3812e582b5b74c266cee7f74e9", "filename": "src/librustc_codegen_ssa/meth.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_codegen_ssa%2Fmeth.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_codegen_ssa%2Fmeth.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_ssa%2Fmeth.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -94,7 +94,8 @@ pub fn get_vtable<'tcx, Cx: CodegenMethods<'tcx>>(\n                     def_id,\n                     substs,\n                 )\n-                .unwrap(),\n+                .unwrap()\n+                .polymorphize(cx.tcx()),\n             )\n         })\n     });"}, {"sha": "2e386c1e5946bf141e409900e7eaba4a88338c19", "filename": "src/librustc_codegen_ssa/mir/analyze.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_codegen_ssa%2Fmir%2Fanalyze.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_codegen_ssa%2Fmir%2Fanalyze.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_ssa%2Fmir%2Fanalyze.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -124,8 +124,7 @@ impl<Bx: BuilderMethods<'a, 'tcx>> LocalAnalyzer<'mir, 'a, 'tcx, Bx> {\n                 let base_ty = self.fx.monomorphize(&base_ty);\n \n                 // ZSTs don't require any actual memory access.\n-                let elem_ty = base_ty.projection_ty(cx.tcx(), elem).ty;\n-                let elem_ty = self.fx.monomorphize(&elem_ty);\n+                let elem_ty = base_ty.projection_ty(cx.tcx(), self.fx.monomorphize(&elem)).ty;\n                 let span = self.fx.mir.local_decls[place_ref.local].source_info.span;\n                 if cx.spanned_layout_of(elem_ty, span).is_zst() {\n                     return;"}, {"sha": "e1de9677f807a4fb312c2c245854583bee726ce4", "filename": "src/librustc_codegen_ssa/mir/block.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_codegen_ssa%2Fmir%2Fblock.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_codegen_ssa%2Fmir%2Fblock.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_ssa%2Fmir%2Fblock.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -543,7 +543,8 @@ impl<'a, 'tcx, Bx: BuilderMethods<'a, 'tcx>> FunctionCx<'a, 'tcx, Bx> {\n                 Some(\n                     ty::Instance::resolve(bx.tcx(), ty::ParamEnv::reveal_all(), def_id, substs)\n                         .unwrap()\n-                        .unwrap(),\n+                        .unwrap()\n+                        .polymorphize(bx.tcx()),\n                 ),\n                 None,\n             ),"}, {"sha": "9c108998bc9078928827a8114789a56b0f474e97", "filename": "src/librustc_codegen_ssa/mir/rvalue.rs", "status": "modified", "additions": 10, "deletions": 11, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_codegen_ssa%2Fmir%2Frvalue.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_codegen_ssa%2Fmir%2Frvalue.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_ssa%2Fmir%2Frvalue.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -190,17 +190,15 @@ impl<'a, 'tcx, Bx: BuilderMethods<'a, 'tcx>> FunctionCx<'a, 'tcx, Bx> {\n                                 if bx.cx().tcx().has_attr(def_id, sym::rustc_args_required_const) {\n                                     bug!(\"reifying a fn ptr that requires const arguments\");\n                                 }\n-                                OperandValue::Immediate(\n-                                    bx.get_fn_addr(\n-                                        ty::Instance::resolve_for_fn_ptr(\n-                                            bx.tcx(),\n-                                            ty::ParamEnv::reveal_all(),\n-                                            def_id,\n-                                            substs,\n-                                        )\n-                                        .unwrap(),\n-                                    ),\n+                                let instance = ty::Instance::resolve_for_fn_ptr(\n+                                    bx.tcx(),\n+                                    ty::ParamEnv::reveal_all(),\n+                                    def_id,\n+                                    substs,\n                                 )\n+                                .unwrap()\n+                                .polymorphize(bx.cx().tcx());\n+                                OperandValue::Immediate(bx.get_fn_addr(instance))\n                             }\n                             _ => bug!(\"{} cannot be reified to a fn ptr\", operand.layout.ty),\n                         }\n@@ -213,7 +211,8 @@ impl<'a, 'tcx, Bx: BuilderMethods<'a, 'tcx>> FunctionCx<'a, 'tcx, Bx> {\n                                     def_id,\n                                     substs,\n                                     ty::ClosureKind::FnOnce,\n-                                );\n+                                )\n+                                .polymorphize(bx.cx().tcx());\n                                 OperandValue::Immediate(bx.cx().get_fn_addr(instance))\n                             }\n                             _ => bug!(\"{} cannot be cast to a fn ptr\", operand.layout.ty),"}, {"sha": "c1c79b174f415e93d4637ca0f684f54856a6871f", "filename": "src/librustc_data_structures/stable_hasher.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_data_structures%2Fstable_hasher.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_data_structures%2Fstable_hasher.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_data_structures%2Fstable_hasher.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -469,6 +469,15 @@ impl<R: vec::Idx, C: vec::Idx, CTX> HashStable<CTX> for bit_set::BitMatrix<R, C>\n     }\n }\n \n+impl<T, CTX> HashStable<CTX> for bit_set::FiniteBitSet<T>\n+where\n+    T: HashStable<CTX> + bit_set::FiniteBitSetTy,\n+{\n+    fn hash_stable(&self, hcx: &mut CTX, hasher: &mut StableHasher) {\n+        self.0.hash_stable(hcx, hasher);\n+    }\n+}\n+\n impl_stable_hash_via_hash!(::std::path::Path);\n impl_stable_hash_via_hash!(::std::path::PathBuf);\n "}, {"sha": "879f06f89a70a8a92bc55be479634edb854578b3", "filename": "src/librustc_feature/builtin_attrs.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_feature%2Fbuiltin_attrs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_feature%2Fbuiltin_attrs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_feature%2Fbuiltin_attrs.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -568,6 +568,7 @@ pub const BUILTIN_ATTRIBUTES: &[BuiltinAttribute] = &[\n     ),\n     rustc_attr!(TEST, rustc_synthetic, AssumedUsed, template!(Word)),\n     rustc_attr!(TEST, rustc_symbol_name, AssumedUsed, template!(Word)),\n+    rustc_attr!(TEST, rustc_polymorphize_error, AssumedUsed, template!(Word)),\n     rustc_attr!(TEST, rustc_def_path, AssumedUsed, template!(Word)),\n     rustc_attr!(TEST, rustc_mir, AssumedUsed, template!(List: \"arg1, arg2, ...\")),\n     rustc_attr!(TEST, rustc_dump_program_clauses, AssumedUsed, template!(Word)),"}, {"sha": "b369be252185b378319eca659abce5966c96b855", "filename": "src/librustc_index/bit_set.rs", "status": "modified", "additions": 135, "deletions": 0, "changes": 135, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_index%2Fbit_set.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_index%2Fbit_set.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_index%2Fbit_set.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -4,6 +4,7 @@ use std::fmt;\n use std::iter;\n use std::marker::PhantomData;\n use std::mem;\n+use std::ops::{BitAnd, BitAndAssign, BitOrAssign, Not, Range, Shl};\n use std::slice;\n \n #[cfg(test)]\n@@ -1001,3 +1002,137 @@ fn word_index_and_mask<T: Idx>(elem: T) -> (usize, Word) {\n     let mask = 1 << (elem % WORD_BITS);\n     (word_index, mask)\n }\n+\n+/// Integral type used to represent the bit set.\n+pub trait FiniteBitSetTy:\n+    BitAnd<Output = Self>\n+    + BitAndAssign\n+    + BitOrAssign\n+    + Clone\n+    + Copy\n+    + Shl\n+    + Not<Output = Self>\n+    + PartialEq\n+    + Sized\n+{\n+    /// Size of the domain representable by this type, e.g. 64 for `u64`.\n+    const DOMAIN_SIZE: u32;\n+\n+    /// Value which represents the `FiniteBitSet` having every bit set.\n+    const FILLED: Self;\n+    /// Value which represents the `FiniteBitSet` having no bits set.\n+    const EMPTY: Self;\n+\n+    /// Value for one as the integral type.\n+    const ONE: Self;\n+    /// Value for zero as the integral type.\n+    const ZERO: Self;\n+\n+    /// Perform a checked left shift on the integral type.\n+    fn checked_shl(self, rhs: u32) -> Option<Self>;\n+    /// Perform a checked right shift on the integral type.\n+    fn checked_shr(self, rhs: u32) -> Option<Self>;\n+}\n+\n+impl FiniteBitSetTy for u64 {\n+    const DOMAIN_SIZE: u32 = 64;\n+\n+    const FILLED: Self = Self::MAX;\n+    const EMPTY: Self = Self::MIN;\n+\n+    const ONE: Self = 1u64;\n+    const ZERO: Self = 0u64;\n+\n+    fn checked_shl(self, rhs: u32) -> Option<Self> {\n+        self.checked_shl(rhs)\n+    }\n+\n+    fn checked_shr(self, rhs: u32) -> Option<Self> {\n+        self.checked_shr(rhs)\n+    }\n+}\n+\n+impl std::fmt::Debug for FiniteBitSet<u64> {\n+    fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {\n+        write!(f, \"{:064b}\", self.0)\n+    }\n+}\n+\n+impl FiniteBitSetTy for u128 {\n+    const DOMAIN_SIZE: u32 = 128;\n+\n+    const FILLED: Self = Self::MAX;\n+    const EMPTY: Self = Self::MIN;\n+\n+    const ONE: Self = 1u128;\n+    const ZERO: Self = 0u128;\n+\n+    fn checked_shl(self, rhs: u32) -> Option<Self> {\n+        self.checked_shl(rhs)\n+    }\n+\n+    fn checked_shr(self, rhs: u32) -> Option<Self> {\n+        self.checked_shr(rhs)\n+    }\n+}\n+\n+impl std::fmt::Debug for FiniteBitSet<u128> {\n+    fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {\n+        write!(f, \"{:0128b}\", self.0)\n+    }\n+}\n+\n+/// A fixed-sized bitset type represented by an integer type. Indices outwith than the range\n+/// representable by `T` are considered set.\n+#[derive(Copy, Clone, Eq, PartialEq, RustcDecodable, RustcEncodable)]\n+pub struct FiniteBitSet<T: FiniteBitSetTy>(pub T);\n+\n+impl<T: FiniteBitSetTy> FiniteBitSet<T> {\n+    /// Creates a new, empty bitset.\n+    pub fn new_empty() -> Self {\n+        Self(T::EMPTY)\n+    }\n+\n+    /// Sets the `index`th bit.\n+    pub fn set(&mut self, index: u32) {\n+        self.0 |= T::ONE.checked_shl(index).unwrap_or(T::ZERO);\n+    }\n+\n+    /// Unsets the `index`th bit.\n+    pub fn clear(&mut self, index: u32) {\n+        self.0 &= !T::ONE.checked_shl(index).unwrap_or(T::ZERO);\n+    }\n+\n+    /// Sets the `i`th to `j`th bits.\n+    pub fn set_range(&mut self, range: Range<u32>) {\n+        let bits = T::FILLED\n+            .checked_shl(range.end - range.start)\n+            .unwrap_or(T::ZERO)\n+            .not()\n+            .checked_shl(range.start)\n+            .unwrap_or(T::ZERO);\n+        self.0 |= bits;\n+    }\n+\n+    /// Is the set empty?\n+    pub fn is_empty(&self) -> bool {\n+        self.0 == T::EMPTY\n+    }\n+\n+    /// Returns the domain size of the bitset.\n+    pub fn within_domain(&self, index: u32) -> bool {\n+        index < T::DOMAIN_SIZE\n+    }\n+\n+    /// Returns if the `index`th bit is set.\n+    pub fn contains(&self, index: u32) -> Option<bool> {\n+        self.within_domain(index)\n+            .then(|| ((self.0.checked_shr(index).unwrap_or(T::ONE)) & T::ONE) == T::ONE)\n+    }\n+}\n+\n+impl<T: FiniteBitSetTy> Default for FiniteBitSet<T> {\n+    fn default() -> Self {\n+        Self::new_empty()\n+    }\n+}"}, {"sha": "7ee881b0639daf53f363e82d6878fc12e0a1735c", "filename": "src/librustc_index/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_index%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_index%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_index%2Flib.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -1,4 +1,5 @@\n #![feature(allow_internal_unstable)]\n+#![feature(bool_to_option)]\n #![feature(const_fn)]\n #![feature(const_panic)]\n #![feature(extend_one)]"}, {"sha": "a6d708ebe9048d0b24779ab8b90d676e0e9c6a00", "filename": "src/librustc_metadata/rmeta/decoder.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_metadata%2Frmeta%2Fdecoder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_metadata%2Frmeta%2Fdecoder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Frmeta%2Fdecoder.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -1132,6 +1132,16 @@ impl<'a, 'tcx> CrateMetadataRef<'a> {\n             .decode((self, tcx))\n     }\n \n+    fn get_unused_generic_params(&self, id: DefIndex) -> FiniteBitSet<u64> {\n+        self.root\n+            .tables\n+            .unused_generic_params\n+            .get(self, id)\n+            .filter(|_| !self.is_proc_macro(id))\n+            .map(|params| params.decode(self))\n+            .unwrap_or_default()\n+    }\n+\n     fn get_promoted_mir(&self, tcx: TyCtxt<'tcx>, id: DefIndex) -> IndexVec<Promoted, Body<'tcx>> {\n         self.root\n             .tables"}, {"sha": "9160327c1d1b5e3b00b9c737a84736588f41a5db", "filename": "src/librustc_metadata/rmeta/decoder/cstore_impl.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_metadata%2Frmeta%2Fdecoder%2Fcstore_impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_metadata%2Frmeta%2Fdecoder%2Fcstore_impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Frmeta%2Fdecoder%2Fcstore_impl.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -113,6 +113,7 @@ provide! { <'tcx> tcx, def_id, other, cdata,\n     }\n     optimized_mir => { tcx.arena.alloc(cdata.get_optimized_mir(tcx, def_id.index)) }\n     promoted_mir => { tcx.arena.alloc(cdata.get_promoted_mir(tcx, def_id.index)) }\n+    unused_generic_params => { cdata.get_unused_generic_params(def_id.index) }\n     mir_const_qualif => { cdata.mir_const_qualif(def_id.index) }\n     fn_sig => { cdata.fn_sig(def_id.index, tcx) }\n     inherent_impls => { cdata.get_inherent_implementations_for_type(tcx, def_id.index) }"}, {"sha": "186828b6a19f6234fa0a96da047e31108170a5d8", "filename": "src/librustc_metadata/rmeta/encoder.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_metadata%2Frmeta%2Fencoder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_metadata%2Frmeta%2Fencoder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Frmeta%2Fencoder.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -1065,6 +1065,8 @@ impl EncodeContext<'tcx> {\n         debug!(\"EntryBuilder::encode_mir({:?})\", def_id);\n         if self.tcx.mir_keys(LOCAL_CRATE).contains(&def_id) {\n             record!(self.tables.mir[def_id.to_def_id()] <- self.tcx.optimized_mir(def_id));\n+            record!(self.tables.unused_generic_params[def_id.to_def_id()] <-\n+                    self.tcx.unused_generic_params(def_id));\n         }\n     }\n "}, {"sha": "e616e8cf00a2f5d1127b043fc1f224d5f2cc996b", "filename": "src/librustc_metadata/rmeta/mod.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_metadata%2Frmeta%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_metadata%2Frmeta%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Frmeta%2Fmod.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -9,7 +9,7 @@ use rustc_hir as hir;\n use rustc_hir::def::CtorKind;\n use rustc_hir::def_id::{DefId, DefIndex};\n use rustc_hir::lang_items;\n-use rustc_index::vec::IndexVec;\n+use rustc_index::{bit_set::FiniteBitSet, vec::IndexVec};\n use rustc_middle::hir::exports::Export;\n use rustc_middle::middle::cstore::{DepKind, ForeignModule, LinkagePreference, NativeLib};\n use rustc_middle::middle::exported_symbols::{ExportedSymbol, SymbolExportLevel};\n@@ -277,6 +277,7 @@ define_tables! {\n     super_predicates: Table<DefIndex, Lazy!(ty::GenericPredicates<'tcx>)>,\n     mir: Table<DefIndex, Lazy!(mir::Body<'tcx>)>,\n     promoted_mir: Table<DefIndex, Lazy!(IndexVec<mir::Promoted, mir::Body<'tcx>>)>,\n+    unused_generic_params: Table<DefIndex, Lazy<FiniteBitSet<u64>>>,\n }\n \n #[derive(Copy, Clone, RustcEncodable, RustcDecodable)]"}, {"sha": "bb204223b60607ee9079ac6ec8da1e3e02b9d5a1", "filename": "src/librustc_middle/mir/mono.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_middle%2Fmir%2Fmono.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_middle%2Fmir%2Fmono.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_middle%2Fmir%2Fmono.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -168,7 +168,7 @@ impl<'tcx> MonoItem<'tcx> {\n             MonoItem::GlobalAsm(..) => return true,\n         };\n \n-        tcx.substitute_normalize_and_test_predicates((def_id, &substs))\n+        !tcx.subst_and_check_impossible_predicates((def_id, &substs))\n     }\n \n     pub fn to_string(&self, tcx: TyCtxt<'tcx>, debug: bool) -> String {"}, {"sha": "f857af28622d1047cd6dcbd02b60556e568d4c28", "filename": "src/librustc_middle/query/mod.rs", "status": "modified", "additions": 9, "deletions": 2, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_middle%2Fquery%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_middle%2Fquery%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_middle%2Fquery%2Fmod.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -1313,6 +1313,13 @@ rustc_queries! {\n         query codegen_unit(_: Symbol) -> &'tcx CodegenUnit<'tcx> {\n             desc { \"codegen_unit\" }\n         }\n+        query unused_generic_params(key: DefId) -> FiniteBitSet<u64> {\n+            cache_on_disk_if { key.is_local() }\n+            desc {\n+                |tcx| \"determining which generic parameters are unused by `{}`\",\n+                    tcx.def_path_str(key)\n+            }\n+        }\n         query backend_optimization_level(_: CrateNum) -> OptLevel {\n             desc { \"optimization level used by backend\" }\n         }\n@@ -1465,9 +1472,9 @@ rustc_queries! {\n             desc { \"normalizing `{:?}`\", goal }\n         }\n \n-        query substitute_normalize_and_test_predicates(key: (DefId, SubstsRef<'tcx>)) -> bool {\n+        query subst_and_check_impossible_predicates(key: (DefId, SubstsRef<'tcx>)) -> bool {\n             desc { |tcx|\n-                \"testing substituted normalized predicates:`{}`\",\n+                \"impossible substituted predicates:`{}`\",\n                 tcx.def_path_str(key.0)\n             }\n         }"}, {"sha": "11a8bedb6605bf6caa3de7fd23e818806f244f72", "filename": "src/librustc_middle/ty/flags.rs", "status": "modified", "additions": 24, "deletions": 2, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_middle%2Fty%2Fflags.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_middle%2Fty%2Fflags.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_middle%2Fty%2Fflags.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -85,7 +85,19 @@ impl FlagComputation {\n             }\n \n             &ty::Generator(_, ref substs, _) => {\n-                self.add_substs(substs);\n+                let substs = substs.as_generator();\n+                let should_remove_further_specializable =\n+                    !self.flags.contains(TypeFlags::STILL_FURTHER_SPECIALIZABLE);\n+                self.add_substs(substs.parent_substs());\n+                if should_remove_further_specializable {\n+                    self.flags -= TypeFlags::STILL_FURTHER_SPECIALIZABLE;\n+                }\n+\n+                self.add_ty(substs.resume_ty());\n+                self.add_ty(substs.return_ty());\n+                self.add_ty(substs.witness());\n+                self.add_ty(substs.yield_ty());\n+                self.add_ty(substs.tupled_upvars_ty());\n             }\n \n             &ty::GeneratorWitness(ts) => {\n@@ -95,7 +107,17 @@ impl FlagComputation {\n             }\n \n             &ty::Closure(_, substs) => {\n-                self.add_substs(substs);\n+                let substs = substs.as_closure();\n+                let should_remove_further_specializable =\n+                    !self.flags.contains(TypeFlags::STILL_FURTHER_SPECIALIZABLE);\n+                self.add_substs(substs.parent_substs());\n+                if should_remove_further_specializable {\n+                    self.flags -= TypeFlags::STILL_FURTHER_SPECIALIZABLE;\n+                }\n+\n+                self.add_ty(substs.sig_as_fn_ptr_ty());\n+                self.add_ty(substs.kind_ty());\n+                self.add_ty(substs.tupled_upvars_ty());\n             }\n \n             &ty::Bound(debruijn, _) => {"}, {"sha": "cdb883da32bb0314eb85fc314e47e3dbb2d24399", "filename": "src/librustc_middle/ty/instance.rs", "status": "modified", "additions": 40, "deletions": 26, "changes": 66, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_middle%2Fty%2Finstance.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_middle%2Fty%2Finstance.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_middle%2Fty%2Finstance.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -1,5 +1,6 @@\n use crate::middle::codegen_fn_attrs::CodegenFnAttrFlags;\n use crate::ty::print::{FmtPrinter, Printer};\n+use crate::ty::subst::InternalSubsts;\n use crate::ty::{self, SubstsRef, Ty, TyCtxt, TypeFoldable};\n use rustc_errors::ErrorReported;\n use rustc_hir::def::Namespace;\n@@ -106,32 +107,9 @@ pub enum InstanceDef<'tcx> {\n }\n \n impl<'tcx> Instance<'tcx> {\n-    /// Returns the `Ty` corresponding to this `Instance`,\n-    /// with generic substitutions applied and lifetimes erased.\n-    ///\n-    /// This method can only be called when the 'substs' for this Instance\n-    /// are fully monomorphic (no `ty::Param`'s are present).\n-    /// This is usually the case (e.g. during codegen).\n-    /// However, during constant evaluation, we may want\n-    /// to try to resolve a `Instance` using generic parameters\n-    /// (e.g. when we are attempting to to do const-propagation).\n-    /// In this case, `Instance.ty_env` should be used to provide\n-    /// the `ParamEnv` for our generic context.\n-    pub fn monomorphic_ty(&self, tcx: TyCtxt<'tcx>) -> Ty<'tcx> {\n-        let ty = tcx.type_of(self.def.def_id());\n-        // There shouldn't be any params - if there are, then\n-        // Instance.ty_env should have been used to provide the proper\n-        // ParamEnv\n-        if self.substs.has_param_types_or_consts() {\n-            bug!(\"Instance.ty called for type {:?} with params in substs: {:?}\", ty, self.substs);\n-        }\n-        tcx.subst_and_normalize_erasing_regions(self.substs, ty::ParamEnv::reveal_all(), &ty)\n-    }\n-\n-    /// Like `Instance.ty`, but allows a `ParamEnv` to be specified for use during\n-    /// normalization. This method is only really useful during constant evaluation,\n-    /// where we are dealing with potentially generic types.\n-    pub fn ty_env(&self, tcx: TyCtxt<'tcx>, param_env: ty::ParamEnv<'tcx>) -> Ty<'tcx> {\n+    /// Returns the `Ty` corresponding to this `Instance`, with generic substitutions applied and\n+    /// lifetimes erased, allowing a `ParamEnv` to be specified for use during normalization.\n+    pub fn ty(&self, tcx: TyCtxt<'tcx>, param_env: ty::ParamEnv<'tcx>) -> Ty<'tcx> {\n         let ty = tcx.type_of(self.def.def_id());\n         tcx.subst_and_normalize_erasing_regions(self.substs, param_env, &ty)\n     }\n@@ -486,6 +464,42 @@ impl<'tcx> Instance<'tcx> {\n             | InstanceDef::VtableShim(..) => Some(self.substs),\n         }\n     }\n+\n+    /// Returns a new `Instance` where generic parameters in `instance.substs` are replaced by\n+    /// identify parameters if they are determined to be unused in `instance.def`.\n+    pub fn polymorphize(self, tcx: TyCtxt<'tcx>) -> Self {\n+        debug!(\"polymorphize: running polymorphization analysis\");\n+        if !tcx.sess.opts.debugging_opts.polymorphize {\n+            return self;\n+        }\n+\n+        if let InstanceDef::Item(def) = self.def {\n+            let unused = tcx.unused_generic_params(def.did);\n+\n+            if unused.is_empty() {\n+                // Exit early if every parameter was used.\n+                return self;\n+            }\n+\n+            debug!(\"polymorphize: unused={:?}\", unused);\n+            let polymorphized_substs =\n+                InternalSubsts::for_item(tcx, def.did, |param, _| match param.kind {\n+                // If parameter is a const or type parameter..\n+                ty::GenericParamDefKind::Const | ty::GenericParamDefKind::Type { .. } if\n+                    // ..and is within range and unused..\n+                    unused.contains(param.index).unwrap_or(false) =>\n+                        // ..then use the identity for this parameter.\n+                        tcx.mk_param_from_def(param),\n+                // Otherwise, use the parameter as before.\n+                _ => self.substs[param.index as usize],\n+            });\n+\n+            debug!(\"polymorphize: self={:?} polymorphized_substs={:?}\", self, polymorphized_substs);\n+            Self { def: self.def, substs: polymorphized_substs }\n+        } else {\n+            self\n+        }\n+    }\n }\n \n fn needs_fn_once_adapter_shim("}, {"sha": "cb937bf0112aee952aef0d9afb57a233d1f529f7", "filename": "src/librustc_middle/ty/layout.rs", "status": "modified", "additions": 28, "deletions": 18, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_middle%2Fty%2Flayout.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_middle%2Fty%2Flayout.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_middle%2Fty%2Flayout.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -2299,12 +2299,22 @@ impl<'tcx> ty::Instance<'tcx> {\n     // or should go through `FnAbi` instead, to avoid losing any\n     // adjustments `FnAbi::of_instance` might be performing.\n     fn fn_sig_for_fn_abi(&self, tcx: TyCtxt<'tcx>) -> ty::PolyFnSig<'tcx> {\n-        let ty = self.monomorphic_ty(tcx);\n+        // FIXME(davidtwco,eddyb): A `ParamEnv` should be passed through to this function.\n+        let ty = self.ty(tcx, ty::ParamEnv::reveal_all());\n         match ty.kind {\n-            ty::FnDef(..) |\n-            // Shims currently have type FnPtr. Not sure this should remain.\n-            ty::FnPtr(_) => {\n-                let mut sig = ty.fn_sig(tcx);\n+            ty::FnDef(..) => {\n+                // HACK(davidtwco,eddyb): This is a workaround for polymorphization considering\n+                // parameters unused if they show up in the signature, but not in the `mir::Body`\n+                // (i.e. due to being inside a projection that got normalized, see\n+                // `src/test/ui/polymorphization/normalized_sig_types.rs`), and codegen not keeping\n+                // track of a polymorphization `ParamEnv` to allow normalizing later.\n+                let mut sig = match ty.kind {\n+                    ty::FnDef(def_id, substs) => tcx\n+                        .normalize_erasing_regions(tcx.param_env(def_id), tcx.fn_sig(def_id))\n+                        .subst(tcx, substs),\n+                    _ => unreachable!(),\n+                };\n+\n                 if let ty::InstanceDef::VtableShim(..) = self.def {\n                     // Modify `fn(self, ...)` to `fn(self: *mut Self, ...)`.\n                     sig = sig.map_bound(|mut sig| {\n@@ -2320,13 +2330,15 @@ impl<'tcx> ty::Instance<'tcx> {\n                 let sig = substs.as_closure().sig();\n \n                 let env_ty = tcx.closure_env_ty(def_id, substs).unwrap();\n-                sig.map_bound(|sig| tcx.mk_fn_sig(\n-                    iter::once(env_ty.skip_binder()).chain(sig.inputs().iter().cloned()),\n-                    sig.output(),\n-                    sig.c_variadic,\n-                    sig.unsafety,\n-                    sig.abi\n-                ))\n+                sig.map_bound(|sig| {\n+                    tcx.mk_fn_sig(\n+                        iter::once(env_ty.skip_binder()).chain(sig.inputs().iter().cloned()),\n+                        sig.output(),\n+                        sig.c_variadic,\n+                        sig.unsafety,\n+                        sig.abi,\n+                    )\n+                })\n             }\n             ty::Generator(_, substs, _) => {\n                 let sig = substs.as_generator().poly_sig();\n@@ -2342,22 +2354,20 @@ impl<'tcx> ty::Instance<'tcx> {\n                 sig.map_bound(|sig| {\n                     let state_did = tcx.require_lang_item(GeneratorStateLangItem, None);\n                     let state_adt_ref = tcx.adt_def(state_did);\n-                    let state_substs = tcx.intern_substs(&[\n-                        sig.yield_ty.into(),\n-                        sig.return_ty.into(),\n-                    ]);\n+                    let state_substs =\n+                        tcx.intern_substs(&[sig.yield_ty.into(), sig.return_ty.into()]);\n                     let ret_ty = tcx.mk_adt(state_adt_ref, state_substs);\n \n                     tcx.mk_fn_sig(\n                         [env_ty, sig.resume_ty].iter(),\n                         &ret_ty,\n                         false,\n                         hir::Unsafety::Normal,\n-                        rustc_target::spec::abi::Abi::Rust\n+                        rustc_target::spec::abi::Abi::Rust,\n                     )\n                 })\n             }\n-            _ => bug!(\"unexpected type {:?} in Instance::fn_sig\", ty)\n+            _ => bug!(\"unexpected type {:?} in Instance::fn_sig\", ty),\n         }\n     }\n }"}, {"sha": "51a353c0132412cb0cdf5429bf4d0fdb7c71f144", "filename": "src/librustc_middle/ty/mod.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_middle%2Fty%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_middle%2Fty%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_middle%2Fty%2Fmod.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -890,6 +890,7 @@ impl<'tcx> Generics {\n         false\n     }\n \n+    /// Returns the `GenericParamDef` with the given index.\n     pub fn param_at(&'tcx self, param_index: usize, tcx: TyCtxt<'tcx>) -> &'tcx GenericParamDef {\n         if let Some(index) = param_index.checked_sub(self.parent_count) {\n             &self.params[index]\n@@ -899,6 +900,7 @@ impl<'tcx> Generics {\n         }\n     }\n \n+    /// Returns the `GenericParamDef` associated with this `EarlyBoundRegion`.\n     pub fn region_param(\n         &'tcx self,\n         param: &EarlyBoundRegion,\n@@ -920,7 +922,7 @@ impl<'tcx> Generics {\n         }\n     }\n \n-    /// Returns the `ConstParameterDef` associated with this `ParamConst`.\n+    /// Returns the `GenericParamDef` associated with this `ParamConst`.\n     pub fn const_param(&'tcx self, param: &ParamConst, tcx: TyCtxt<'tcx>) -> &GenericParamDef {\n         let param = self.param_at(param.index as usize, tcx);\n         match param.kind {"}, {"sha": "48a62b64604672f59770171ef7b0db34ae17aef5", "filename": "src/librustc_middle/ty/normalize_erasing_regions.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_middle%2Fty%2Fnormalize_erasing_regions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_middle%2Fty%2Fnormalize_erasing_regions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_middle%2Fty%2Fnormalize_erasing_regions.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -54,7 +54,6 @@ impl<'tcx> TyCtxt<'tcx> {\n     where\n         T: TypeFoldable<'tcx>,\n     {\n-        assert!(!value.needs_subst());\n         let value = self.erase_late_bound_regions(value);\n         self.normalize_erasing_regions(param_env, value)\n     }"}, {"sha": "2ea7cd2a6dc7acb118d8d104ed771bd83515132a", "filename": "src/librustc_middle/ty/print/obsolete.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_middle%2Fty%2Fprint%2Fobsolete.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_middle%2Fty%2Fprint%2Fobsolete.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_middle%2Fty%2Fprint%2Fobsolete.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -144,12 +144,14 @@ impl DefPathBasedNames<'tcx> {\n                 let substs = substs.truncate_to(self.tcx, generics);\n                 self.push_generic_params(substs, iter::empty(), output, debug);\n             }\n+            ty::Param(_) => {\n+                output.push_str(&t.to_string());\n+            }\n             ty::Error(_)\n             | ty::Bound(..)\n             | ty::Infer(_)\n             | ty::Placeholder(..)\n             | ty::Projection(..)\n-            | ty::Param(_)\n             | ty::GeneratorWitness(_)\n             | ty::Opaque(..) => {\n                 if debug {"}, {"sha": "2f7a9aee536d84593461e77df6956f118f276b1a", "filename": "src/librustc_middle/ty/query/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_middle%2Fty%2Fquery%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_middle%2Fty%2Fquery%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_middle%2Fty%2Fquery%2Fmod.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -44,7 +44,7 @@ use rustc_hir::def::DefKind;\n use rustc_hir::def_id::{CrateNum, DefId, DefIdMap, DefIdSet, LocalDefId};\n use rustc_hir::lang_items::{LangItem, LanguageItems};\n use rustc_hir::{Crate, HirIdSet, ItemLocalId, TraitCandidate};\n-use rustc_index::vec::IndexVec;\n+use rustc_index::{bit_set::FiniteBitSet, vec::IndexVec};\n use rustc_session::config::{EntryFnType, OptLevel, OutputFilenames, SymbolManglingVersion};\n use rustc_session::utils::NativeLibKind;\n use rustc_session::CrateDisambiguator;"}, {"sha": "03bf51c95c5a3d7d2a0ecb3beec2f190de0ebab0", "filename": "src/librustc_middle/ty/sty.rs", "status": "modified", "additions": 42, "deletions": 6, "changes": 48, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_middle%2Fty%2Fsty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_middle%2Fty%2Fsty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_middle%2Fty%2Fsty.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -318,6 +318,7 @@ pub struct ClosureSubsts<'tcx> {\n /// Struct returned by `split()`. Note that these are subslices of the\n /// parent slice and not canonical substs themselves.\n struct SplitClosureSubsts<'tcx> {\n+    parent: &'tcx [GenericArg<'tcx>],\n     closure_kind_ty: GenericArg<'tcx>,\n     closure_sig_as_fn_ptr_ty: GenericArg<'tcx>,\n     tupled_upvars_ty: GenericArg<'tcx>,\n@@ -329,8 +330,13 @@ impl<'tcx> ClosureSubsts<'tcx> {\n     /// ordering.\n     fn split(self) -> SplitClosureSubsts<'tcx> {\n         match self.substs[..] {\n-            [.., closure_kind_ty, closure_sig_as_fn_ptr_ty, tupled_upvars_ty] => {\n-                SplitClosureSubsts { closure_kind_ty, closure_sig_as_fn_ptr_ty, tupled_upvars_ty }\n+            [ref parent @ .., closure_kind_ty, closure_sig_as_fn_ptr_ty, tupled_upvars_ty] => {\n+                SplitClosureSubsts {\n+                    parent,\n+                    closure_kind_ty,\n+                    closure_sig_as_fn_ptr_ty,\n+                    tupled_upvars_ty,\n+                }\n             }\n             _ => bug!(\"closure substs missing synthetics\"),\n         }\n@@ -345,9 +351,20 @@ impl<'tcx> ClosureSubsts<'tcx> {\n         self.substs.len() >= 3 && matches!(self.split().tupled_upvars_ty.expect_ty().kind, Tuple(_))\n     }\n \n+    /// Returns the substitutions of the closure's parent.\n+    pub fn parent_substs(self) -> &'tcx [GenericArg<'tcx>] {\n+        self.split().parent\n+    }\n+\n     #[inline]\n     pub fn upvar_tys(self) -> impl Iterator<Item = Ty<'tcx>> + 'tcx {\n-        self.split().tupled_upvars_ty.expect_ty().tuple_fields()\n+        self.tupled_upvars_ty().tuple_fields()\n+    }\n+\n+    /// Returns the tuple type representing the upvars for this closure.\n+    #[inline]\n+    pub fn tupled_upvars_ty(self) -> Ty<'tcx> {\n+        self.split().tupled_upvars_ty.expect_ty()\n     }\n \n     /// Returns the closure kind for this closure; may return a type\n@@ -392,6 +409,7 @@ pub struct GeneratorSubsts<'tcx> {\n }\n \n struct SplitGeneratorSubsts<'tcx> {\n+    parent: &'tcx [GenericArg<'tcx>],\n     resume_ty: GenericArg<'tcx>,\n     yield_ty: GenericArg<'tcx>,\n     return_ty: GenericArg<'tcx>,\n@@ -402,8 +420,15 @@ struct SplitGeneratorSubsts<'tcx> {\n impl<'tcx> GeneratorSubsts<'tcx> {\n     fn split(self) -> SplitGeneratorSubsts<'tcx> {\n         match self.substs[..] {\n-            [.., resume_ty, yield_ty, return_ty, witness, tupled_upvars_ty] => {\n-                SplitGeneratorSubsts { resume_ty, yield_ty, return_ty, witness, tupled_upvars_ty }\n+            [ref parent @ .., resume_ty, yield_ty, return_ty, witness, tupled_upvars_ty] => {\n+                SplitGeneratorSubsts {\n+                    parent,\n+                    resume_ty,\n+                    yield_ty,\n+                    return_ty,\n+                    witness,\n+                    tupled_upvars_ty,\n+                }\n             }\n             _ => bug!(\"generator substs missing synthetics\"),\n         }\n@@ -418,6 +443,11 @@ impl<'tcx> GeneratorSubsts<'tcx> {\n         self.substs.len() >= 5 && matches!(self.split().tupled_upvars_ty.expect_ty().kind, Tuple(_))\n     }\n \n+    /// Returns the substitutions of the generator's parent.\n+    pub fn parent_substs(self) -> &'tcx [GenericArg<'tcx>] {\n+        self.split().parent\n+    }\n+\n     /// This describes the types that can be contained in a generator.\n     /// It will be a type variable initially and unified in the last stages of typeck of a body.\n     /// It contains a tuple of all the types that could end up on a generator frame.\n@@ -429,7 +459,13 @@ impl<'tcx> GeneratorSubsts<'tcx> {\n \n     #[inline]\n     pub fn upvar_tys(self) -> impl Iterator<Item = Ty<'tcx>> + 'tcx {\n-        self.split().tupled_upvars_ty.expect_ty().tuple_fields()\n+        self.tupled_upvars_ty().tuple_fields()\n+    }\n+\n+    /// Returns the tuple type representing the upvars for this generator.\n+    #[inline]\n+    pub fn tupled_upvars_ty(self) -> Ty<'tcx> {\n+        self.split().tupled_upvars_ty.expect_ty()\n     }\n \n     /// Returns the type representing the resume type of the generator."}, {"sha": "705a1b2ae79e52cda180e97db0cd547a5f245729", "filename": "src/librustc_mir/const_eval/eval_queries.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_mir%2Fconst_eval%2Feval_queries.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_mir%2Fconst_eval%2Feval_queries.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fconst_eval%2Feval_queries.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -240,7 +240,7 @@ pub fn const_eval_validated_provider<'tcx>(\n     // We call `const_eval` for zero arg intrinsics, too, in order to cache their value.\n     // Catch such calls and evaluate them instead of trying to load a constant's MIR.\n     if let ty::InstanceDef::Intrinsic(def_id) = key.value.instance.def {\n-        let ty = key.value.instance.ty_env(tcx, key.param_env);\n+        let ty = key.value.instance.ty(tcx, key.param_env);\n         let substs = match ty.kind {\n             ty::FnDef(_, substs) => substs,\n             _ => bug!(\"intrinsic with type {:?}\", ty),"}, {"sha": "663f61b11554c4c384bff82cdb64275c59ec55db", "filename": "src/librustc_mir/interpret/terminator.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_mir%2Finterpret%2Fterminator.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_mir%2Finterpret%2Fterminator.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Finterpret%2Fterminator.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -221,7 +221,7 @@ impl<'mir, 'tcx: 'mir, M: Machine<'mir, 'tcx>> InterpCx<'mir, 'tcx, M> {\n         // ABI check\n         {\n             let callee_abi = {\n-                let instance_ty = instance.ty_env(*self.tcx, self.param_env);\n+                let instance_ty = instance.ty(*self.tcx, self.param_env);\n                 match instance_ty.kind {\n                     ty::FnDef(..) => instance_ty.fn_sig(*self.tcx).abi(),\n                     ty::Closure(..) => Abi::RustCall,"}, {"sha": "49a80ca13457ddb24c042744ca6702bfa50f73ce", "filename": "src/librustc_mir/interpret/traits.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_mir%2Finterpret%2Ftraits.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_mir%2Finterpret%2Ftraits.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Finterpret%2Ftraits.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -142,7 +142,7 @@ impl<'mir, 'tcx: 'mir, M: Machine<'mir, 'tcx>> InterpCx<'mir, 'tcx, M> {\n         // to determine the type.\n         let drop_instance = self.memory.get_fn(drop_fn)?.as_instance()?;\n         trace!(\"Found drop fn: {:?}\", drop_instance);\n-        let fn_sig = drop_instance.ty_env(*self.tcx, self.param_env).fn_sig(*self.tcx);\n+        let fn_sig = drop_instance.ty(*self.tcx, self.param_env).fn_sig(*self.tcx);\n         let fn_sig = self.tcx.normalize_erasing_late_bound_regions(self.param_env, &fn_sig);\n         // The drop function takes `*mut T` where `T` is the type being dropped, so get that.\n         let args = fn_sig.inputs();"}, {"sha": "4e7142a93aedc7c20afbe97eca387192d3764f88", "filename": "src/librustc_mir/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_mir%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_mir%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Flib.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -51,6 +51,7 @@ pub fn provide(providers: &mut Providers) {\n     shim::provide(providers);\n     transform::provide(providers);\n     monomorphize::partitioning::provide(providers);\n+    monomorphize::polymorphize::provide(providers);\n     providers.const_eval_validated = const_eval::const_eval_validated_provider;\n     providers.const_eval_raw = const_eval::const_eval_raw_provider;\n     providers.const_caller_location = const_eval::const_caller_location;"}, {"sha": "0b5f27fc17a72fd12562c1e304874e7edcc437e1", "filename": "src/librustc_mir/monomorphize/collector.rs", "status": "modified", "additions": 36, "deletions": 39, "changes": 75, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_mir%2Fmonomorphize%2Fcollector.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_mir%2Fmonomorphize%2Fcollector.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fmonomorphize%2Fcollector.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -358,9 +358,9 @@ fn collect_items_rec<'tcx>(\n             let instance = Instance::mono(tcx, def_id);\n \n             // Sanity check whether this ended up being collected accidentally\n-            debug_assert!(should_monomorphize_locally(tcx, &instance));\n+            debug_assert!(should_codegen_locally(tcx, &instance));\n \n-            let ty = instance.monomorphic_ty(tcx);\n+            let ty = instance.ty(tcx, ty::ParamEnv::reveal_all());\n             visit_drop_use(tcx, ty, true, starting_point.span, &mut neighbors);\n \n             recursion_depth_reset = None;\n@@ -371,7 +371,7 @@ fn collect_items_rec<'tcx>(\n         }\n         MonoItem::Fn(instance) => {\n             // Sanity check whether this ended up being collected accidentally\n-            debug_assert!(should_monomorphize_locally(tcx, &instance));\n+            debug_assert!(should_codegen_locally(tcx, &instance));\n \n             // Keep track of the monomorphization recursion depth\n             recursion_depth_reset =\n@@ -584,8 +584,8 @@ impl<'a, 'tcx> MirVisitor<'tcx> for MirNeighborCollector<'a, 'tcx> {\n                             substs,\n                             ty::ClosureKind::FnOnce,\n                         );\n-                        if should_monomorphize_locally(self.tcx, &instance) {\n-                            self.output.push(create_fn_mono_item(instance, span));\n+                        if should_codegen_locally(self.tcx, &instance) {\n+                            self.output.push(create_fn_mono_item(self.tcx, instance, span));\n                         }\n                     }\n                     _ => bug!(),\n@@ -596,14 +596,14 @@ impl<'a, 'tcx> MirVisitor<'tcx> for MirNeighborCollector<'a, 'tcx> {\n                 let exchange_malloc_fn_def_id =\n                     tcx.require_lang_item(ExchangeMallocFnLangItem, None);\n                 let instance = Instance::mono(tcx, exchange_malloc_fn_def_id);\n-                if should_monomorphize_locally(tcx, &instance) {\n-                    self.output.push(create_fn_mono_item(instance, span));\n+                if should_codegen_locally(tcx, &instance) {\n+                    self.output.push(create_fn_mono_item(self.tcx, instance, span));\n                 }\n             }\n             mir::Rvalue::ThreadLocalRef(def_id) => {\n                 assert!(self.tcx.is_thread_local_static(def_id));\n                 let instance = Instance::mono(self.tcx, def_id);\n-                if should_monomorphize_locally(self.tcx, &instance) {\n+                if should_codegen_locally(self.tcx, &instance) {\n                     trace!(\"collecting thread-local static {:?}\", def_id);\n                     self.output.push(respan(span, MonoItem::Static(def_id)));\n                 }\n@@ -664,7 +664,7 @@ impl<'a, 'tcx> MirVisitor<'tcx> for MirNeighborCollector<'a, 'tcx> {\n                         }\n                         mir::InlineAsmOperand::SymStatic { def_id } => {\n                             let instance = Instance::mono(self.tcx, def_id);\n-                            if should_monomorphize_locally(self.tcx, &instance) {\n+                            if should_codegen_locally(self.tcx, &instance) {\n                                 trace!(\"collecting asm sym static {:?}\", def_id);\n                                 self.output.push(respan(source, MonoItem::Static(def_id)));\n                             }\n@@ -735,7 +735,7 @@ fn visit_instance_use<'tcx>(\n     output: &mut Vec<Spanned<MonoItem<'tcx>>>,\n ) {\n     debug!(\"visit_item_use({:?}, is_direct_call={:?})\", instance, is_direct_call);\n-    if !should_monomorphize_locally(tcx, &instance) {\n+    if !should_codegen_locally(tcx, &instance) {\n         return;\n     }\n \n@@ -748,7 +748,7 @@ fn visit_instance_use<'tcx>(\n         ty::InstanceDef::DropGlue(_, None) => {\n             // Don't need to emit noop drop glue if we are calling directly.\n             if !is_direct_call {\n-                output.push(create_fn_mono_item(instance, source));\n+                output.push(create_fn_mono_item(tcx, instance, source));\n             }\n         }\n         ty::InstanceDef::DropGlue(_, Some(_))\n@@ -758,15 +758,15 @@ fn visit_instance_use<'tcx>(\n         | ty::InstanceDef::Item(..)\n         | ty::InstanceDef::FnPtrShim(..)\n         | ty::InstanceDef::CloneShim(..) => {\n-            output.push(create_fn_mono_item(instance, source));\n+            output.push(create_fn_mono_item(tcx, instance, source));\n         }\n     }\n }\n \n // Returns `true` if we should codegen an instance in the local crate.\n // Returns `false` if we can just link to the upstream crate and therefore don't\n // need a mono item.\n-fn should_monomorphize_locally<'tcx>(tcx: TyCtxt<'tcx>, instance: &Instance<'tcx>) -> bool {\n+fn should_codegen_locally<'tcx>(tcx: TyCtxt<'tcx>, instance: &Instance<'tcx>) -> bool {\n     let def_id = match instance.def {\n         ty::InstanceDef::Item(def) => def.did,\n         ty::InstanceDef::DropGlue(def_id, Some(_)) => def_id,\n@@ -781,20 +781,19 @@ fn should_monomorphize_locally<'tcx>(tcx: TyCtxt<'tcx>, instance: &Instance<'tcx\n     };\n \n     if tcx.is_foreign_item(def_id) {\n-        // Foreign items are always linked against, there's no way of\n-        // instantiating them.\n+        // Foreign items are always linked against, there's no way of instantiating them.\n         return false;\n     }\n \n     if def_id.is_local() {\n-        // Local items cannot be referred to locally without\n-        // monomorphizing them locally.\n+        // Local items cannot be referred to locally without monomorphizing them locally.\n         return true;\n     }\n \n-    if tcx.is_reachable_non_generic(def_id) || instance.upstream_monomorphization(tcx).is_some() {\n-        // We can link to the item in question, no instance needed\n-        // in this crate.\n+    if tcx.is_reachable_non_generic(def_id)\n+        || instance.polymorphize(tcx).upstream_monomorphization(tcx).is_some()\n+    {\n+        // We can link to the item in question, no instance needed in this crate.\n         return false;\n     }\n \n@@ -903,9 +902,13 @@ fn find_vtable_types_for_unsizing<'tcx>(\n     }\n }\n \n-fn create_fn_mono_item(instance: Instance<'_>, source: Span) -> Spanned<MonoItem<'_>> {\n+fn create_fn_mono_item<'tcx>(\n+    tcx: TyCtxt<'tcx>,\n+    instance: Instance<'tcx>,\n+    source: Span,\n+) -> Spanned<MonoItem<'tcx>> {\n     debug!(\"create_fn_mono_item(instance={})\", instance);\n-    respan(source, MonoItem::Fn(instance))\n+    respan(source, MonoItem::Fn(instance.polymorphize(tcx)))\n }\n \n /// Creates a `MonoItem` for each method that is referenced by the vtable for\n@@ -917,12 +920,7 @@ fn create_mono_items_for_vtable_methods<'tcx>(\n     source: Span,\n     output: &mut Vec<Spanned<MonoItem<'tcx>>>,\n ) {\n-    assert!(\n-        !trait_ty.needs_subst()\n-            && !trait_ty.has_escaping_bound_vars()\n-            && !impl_ty.needs_subst()\n-            && !impl_ty.has_escaping_bound_vars()\n-    );\n+    assert!(!trait_ty.has_escaping_bound_vars() && !impl_ty.has_escaping_bound_vars());\n \n     if let ty::Dynamic(ref trait_ty, ..) = trait_ty.kind {\n         if let Some(principal) = trait_ty.principal() {\n@@ -944,8 +942,8 @@ fn create_mono_items_for_vtable_methods<'tcx>(\n                     )\n                     .unwrap()\n                 })\n-                .filter(|&instance| should_monomorphize_locally(tcx, &instance))\n-                .map(|item| create_fn_mono_item(item, source));\n+                .filter(|&instance| should_codegen_locally(tcx, &instance))\n+                .map(|item| create_fn_mono_item(tcx, item, source));\n             output.extend(methods);\n         }\n \n@@ -997,7 +995,7 @@ impl ItemLikeVisitor<'v> for RootCollector<'_, 'v> {\n                         );\n \n                         let ty = Instance::new(def_id.to_def_id(), InternalSubsts::empty())\n-                            .monomorphic_ty(self.tcx);\n+                            .ty(self.tcx, ty::ParamEnv::reveal_all());\n                         visit_drop_use(self.tcx, ty, true, DUMMY_SP, self.output);\n                     }\n                 }\n@@ -1069,7 +1067,7 @@ impl RootCollector<'_, 'v> {\n             debug!(\"RootCollector::push_if_root: found root def_id={:?}\", def_id);\n \n             let instance = Instance::mono(self.tcx, def_id.to_def_id());\n-            self.output.push(create_fn_mono_item(instance, DUMMY_SP));\n+            self.output.push(create_fn_mono_item(self.tcx, instance, DUMMY_SP));\n         }\n     }\n \n@@ -1106,7 +1104,7 @@ impl RootCollector<'_, 'v> {\n         .unwrap()\n         .unwrap();\n \n-        self.output.push(create_fn_mono_item(start_instance, DUMMY_SP));\n+        self.output.push(create_fn_mono_item(self.tcx, start_instance, DUMMY_SP));\n     }\n }\n \n@@ -1163,9 +1161,8 @@ fn create_mono_items_for_default_impls<'tcx>(\n                         .unwrap()\n                         .unwrap();\n \n-                    let mono_item = create_fn_mono_item(instance, DUMMY_SP);\n-                    if mono_item.node.is_instantiable(tcx)\n-                        && should_monomorphize_locally(tcx, &instance)\n+                    let mono_item = create_fn_mono_item(tcx, instance, DUMMY_SP);\n+                    if mono_item.node.is_instantiable(tcx) && should_codegen_locally(tcx, &instance)\n                     {\n                         output.push(mono_item);\n                     }\n@@ -1186,7 +1183,7 @@ fn collect_miri<'tcx>(\n         GlobalAlloc::Static(def_id) => {\n             assert!(!tcx.is_thread_local_static(def_id));\n             let instance = Instance::mono(tcx, def_id);\n-            if should_monomorphize_locally(tcx, &instance) {\n+            if should_codegen_locally(tcx, &instance) {\n                 trace!(\"collecting static {:?}\", def_id);\n                 output.push(dummy_spanned(MonoItem::Static(def_id)));\n             }\n@@ -1200,9 +1197,9 @@ fn collect_miri<'tcx>(\n             }\n         }\n         GlobalAlloc::Function(fn_instance) => {\n-            if should_monomorphize_locally(tcx, &fn_instance) {\n+            if should_codegen_locally(tcx, &fn_instance) {\n                 trace!(\"collecting {:?} with {:#?}\", alloc_id, fn_instance);\n-                output.push(create_fn_mono_item(fn_instance, DUMMY_SP));\n+                output.push(create_fn_mono_item(tcx, fn_instance, DUMMY_SP));\n             }\n         }\n     }"}, {"sha": "15d7b11124071a59b9e0f01eb2abf1791f8ba50f", "filename": "src/librustc_mir/monomorphize/mod.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_mir%2Fmonomorphize%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_mir%2Fmonomorphize%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fmonomorphize%2Fmod.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -6,6 +6,7 @@ use rustc_hir::lang_items::CoerceUnsizedTraitLangItem;\n \n pub mod collector;\n pub mod partitioning;\n+pub mod polymorphize;\n \n pub fn custom_coerce_unsize_info<'tcx>(\n     tcx: TyCtxt<'tcx>,"}, {"sha": "071b9bb97113907b916f0d6cf0a21be6b3f9404c", "filename": "src/librustc_mir/monomorphize/polymorphize.rs", "status": "added", "additions": 285, "deletions": 0, "changes": 285, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_mir%2Fmonomorphize%2Fpolymorphize.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_mir%2Fmonomorphize%2Fpolymorphize.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fmonomorphize%2Fpolymorphize.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -0,0 +1,285 @@\n+//! Polymorphization Analysis\n+//! =========================\n+//!\n+//! This module implements an analysis of functions, methods and closures to determine which\n+//! generic parameters are unused (and eventually, in what ways generic parameters are used - only\n+//! for their size, offset of a field, etc.).\n+\n+use rustc_hir::{def::DefKind, def_id::DefId};\n+use rustc_index::bit_set::FiniteBitSet;\n+use rustc_middle::mir::{\n+    visit::{TyContext, Visitor},\n+    Local, LocalDecl, Location,\n+};\n+use rustc_middle::ty::{\n+    self,\n+    fold::{TypeFoldable, TypeVisitor},\n+    query::Providers,\n+    Const, Ty, TyCtxt,\n+};\n+use rustc_span::symbol::sym;\n+use std::convert::TryInto;\n+\n+/// Provide implementations of queries relating to polymorphization analysis.\n+pub fn provide(providers: &mut Providers) {\n+    providers.unused_generic_params = unused_generic_params;\n+}\n+\n+/// Determine which generic parameters are used by the function/method/closure represented by\n+/// `def_id`. Returns a bitset where bits representing unused parameters are set (`is_empty`\n+/// indicates all parameters are used).\n+fn unused_generic_params(tcx: TyCtxt<'_>, def_id: DefId) -> FiniteBitSet<u64> {\n+    debug!(\"unused_generic_params({:?})\", def_id);\n+\n+    if !tcx.sess.opts.debugging_opts.polymorphize {\n+        // If polymorphization disabled, then all parameters are used.\n+        return FiniteBitSet::new_empty();\n+    }\n+\n+    let generics = tcx.generics_of(def_id);\n+    debug!(\"unused_generic_params: generics={:?}\", generics);\n+\n+    // Exit early when there are no parameters to be unused.\n+    if generics.count() == 0 {\n+        return FiniteBitSet::new_empty();\n+    }\n+\n+    // Exit early when there is no MIR available.\n+    if !tcx.is_mir_available(def_id) {\n+        debug!(\"unused_generic_params: (no mir available) def_id={:?}\", def_id);\n+        return FiniteBitSet::new_empty();\n+    }\n+\n+    // Create a bitset with N rightmost ones for each parameter.\n+    let generics_count: u32 =\n+        generics.count().try_into().expect(\"more generic parameters than can fit into a `u32`\");\n+    let mut unused_parameters = FiniteBitSet::<u64>::new_empty();\n+    unused_parameters.set_range(0..generics_count);\n+    debug!(\"unused_generic_params: (start) unused_parameters={:?}\", unused_parameters);\n+    mark_used_by_default_parameters(tcx, def_id, generics, &mut unused_parameters);\n+    debug!(\"unused_generic_params: (after default) unused_parameters={:?}\", unused_parameters);\n+\n+    // Visit MIR and accumululate used generic parameters.\n+    let body = tcx.optimized_mir(def_id);\n+    let mut vis =\n+        UsedGenericParametersVisitor { tcx, def_id, unused_parameters: &mut unused_parameters };\n+    vis.visit_body(body);\n+    debug!(\"unused_generic_params: (after visitor) unused_parameters={:?}\", unused_parameters);\n+\n+    mark_used_by_predicates(tcx, def_id, &mut unused_parameters);\n+    debug!(\"unused_generic_params: (end) unused_parameters={:?}\", unused_parameters);\n+\n+    // Emit errors for debugging and testing if enabled.\n+    if !unused_parameters.is_empty() {\n+        emit_unused_generic_params_error(tcx, def_id, generics, &unused_parameters);\n+    }\n+\n+    unused_parameters\n+}\n+\n+/// Some parameters are considered used-by-default, such as non-generic parameters and the dummy\n+/// generic parameters from closures, this function marks them as used. `leaf_is_closure` should\n+/// be `true` if the item that `unused_generic_params` was invoked on is a closure.\n+fn mark_used_by_default_parameters<'tcx>(\n+    tcx: TyCtxt<'tcx>,\n+    def_id: DefId,\n+    generics: &'tcx ty::Generics,\n+    unused_parameters: &mut FiniteBitSet<u64>,\n+) {\n+    if !tcx.is_trait(def_id) && (tcx.is_closure(def_id) || tcx.type_of(def_id).is_generator()) {\n+        for param in &generics.params {\n+            debug!(\"mark_used_by_default_parameters: (closure/gen) param={:?}\", param);\n+            unused_parameters.clear(param.index);\n+        }\n+    } else {\n+        for param in &generics.params {\n+            debug!(\"mark_used_by_default_parameters: (other) param={:?}\", param);\n+            if let ty::GenericParamDefKind::Lifetime = param.kind {\n+                unused_parameters.clear(param.index);\n+            }\n+        }\n+    }\n+\n+    if let Some(parent) = generics.parent {\n+        mark_used_by_default_parameters(tcx, parent, tcx.generics_of(parent), unused_parameters);\n+    }\n+}\n+\n+/// Search the predicates on used generic parameters for any unused generic parameters, and mark\n+/// those as used.\n+fn mark_used_by_predicates<'tcx>(\n+    tcx: TyCtxt<'tcx>,\n+    def_id: DefId,\n+    unused_parameters: &mut FiniteBitSet<u64>,\n+) {\n+    let def_id = tcx.closure_base_def_id(def_id);\n+\n+    let is_self_ty_used = |unused_parameters: &mut FiniteBitSet<u64>, self_ty: Ty<'tcx>| {\n+        debug!(\"unused_generic_params: self_ty={:?}\", self_ty);\n+        if let ty::Param(param) = self_ty.kind {\n+            !unused_parameters.contains(param.index).unwrap_or(false)\n+        } else {\n+            false\n+        }\n+    };\n+\n+    let mark_ty = |unused_parameters: &mut FiniteBitSet<u64>, ty: Ty<'tcx>| {\n+        let mut vis = UsedGenericParametersVisitor { tcx, def_id, unused_parameters };\n+        ty.visit_with(&mut vis);\n+    };\n+\n+    let predicates = tcx.explicit_predicates_of(def_id);\n+    debug!(\"mark_parameters_used_in_predicates: predicates_of={:?}\", predicates);\n+    for (predicate, _) in predicates.predicates {\n+        match predicate.kind() {\n+            ty::PredicateKind::Trait(predicate, ..) => {\n+                let trait_ref = predicate.skip_binder().trait_ref;\n+                if is_self_ty_used(unused_parameters, trait_ref.self_ty()) {\n+                    for ty in trait_ref.substs.types() {\n+                        debug!(\"unused_generic_params: (trait) ty={:?}\", ty);\n+                        mark_ty(unused_parameters, ty);\n+                    }\n+                }\n+            }\n+            ty::PredicateKind::Projection(predicate, ..) => {\n+                let self_ty = predicate.skip_binder().projection_ty.self_ty();\n+                if is_self_ty_used(unused_parameters, self_ty) {\n+                    let ty = predicate.ty();\n+                    debug!(\"unused_generic_params: (projection) ty={:?}\", ty);\n+                    mark_ty(unused_parameters, ty.skip_binder());\n+                }\n+            }\n+            _ => (),\n+        }\n+    }\n+}\n+\n+/// Emit errors for the function annotated by `#[rustc_polymorphize_error]`, labelling each generic\n+/// parameter which was unused.\n+fn emit_unused_generic_params_error<'tcx>(\n+    tcx: TyCtxt<'tcx>,\n+    def_id: DefId,\n+    generics: &'tcx ty::Generics,\n+    unused_parameters: &FiniteBitSet<u64>,\n+) {\n+    debug!(\"emit_unused_generic_params_error: def_id={:?}\", def_id);\n+    let base_def_id = tcx.closure_base_def_id(def_id);\n+    if !tcx.get_attrs(base_def_id).iter().any(|a| a.check_name(sym::rustc_polymorphize_error)) {\n+        return;\n+    }\n+\n+    debug!(\"emit_unused_generic_params_error: unused_parameters={:?}\", unused_parameters);\n+    let fn_span = match tcx.opt_item_name(def_id) {\n+        Some(ident) => ident.span,\n+        _ => tcx.def_span(def_id),\n+    };\n+\n+    let mut err = tcx.sess.struct_span_err(fn_span, \"item has unused generic parameters\");\n+\n+    let mut next_generics = Some(generics);\n+    while let Some(generics) = next_generics {\n+        for param in &generics.params {\n+            if unused_parameters.contains(param.index).unwrap_or(false) {\n+                debug!(\"emit_unused_generic_params_error: param={:?}\", param);\n+                let def_span = tcx.def_span(param.def_id);\n+                err.span_label(def_span, &format!(\"generic parameter `{}` is unused\", param.name));\n+            }\n+        }\n+\n+        next_generics = generics.parent.map(|did| tcx.generics_of(did));\n+    }\n+\n+    err.emit();\n+}\n+\n+/// Visitor used to aggregate generic parameter uses.\n+struct UsedGenericParametersVisitor<'a, 'tcx> {\n+    tcx: TyCtxt<'tcx>,\n+    def_id: DefId,\n+    unused_parameters: &'a mut FiniteBitSet<u64>,\n+}\n+\n+impl<'a, 'tcx> Visitor<'tcx> for UsedGenericParametersVisitor<'a, 'tcx> {\n+    fn visit_local_decl(&mut self, local: Local, local_decl: &LocalDecl<'tcx>) {\n+        debug!(\"visit_local_decl: local_decl={:?}\", local_decl);\n+        if local == Local::from_usize(1) {\n+            let def_kind = self.tcx.def_kind(self.def_id);\n+            if matches!(def_kind, DefKind::Closure | DefKind::Generator) {\n+                // Skip visiting the closure/generator that is currently being processed. This only\n+                // happens because the first argument to the closure is a reference to itself and\n+                // that will call `visit_substs`, resulting in each generic parameter captured being\n+                // considered used by default.\n+                debug!(\"visit_local_decl: skipping closure substs\");\n+                return;\n+            }\n+        }\n+\n+        self.super_local_decl(local, local_decl);\n+    }\n+\n+    fn visit_const(&mut self, c: &&'tcx Const<'tcx>, _: Location) {\n+        c.visit_with(self);\n+    }\n+\n+    fn visit_ty(&mut self, ty: Ty<'tcx>, _: TyContext) {\n+        ty.visit_with(self);\n+    }\n+}\n+\n+impl<'a, 'tcx> TypeVisitor<'tcx> for UsedGenericParametersVisitor<'a, 'tcx> {\n+    fn visit_const(&mut self, c: &'tcx Const<'tcx>) -> bool {\n+        debug!(\"visit_const: c={:?}\", c);\n+        if !c.has_param_types_or_consts() {\n+            return false;\n+        }\n+\n+        match c.val {\n+            ty::ConstKind::Param(param) => {\n+                debug!(\"visit_const: param={:?}\", param);\n+                self.unused_parameters.clear(param.index);\n+                false\n+            }\n+            _ => c.super_visit_with(self),\n+        }\n+    }\n+\n+    fn visit_ty(&mut self, ty: Ty<'tcx>) -> bool {\n+        debug!(\"visit_ty: ty={:?}\", ty);\n+        if !ty.has_param_types_or_consts() {\n+            return false;\n+        }\n+\n+        match ty.kind {\n+            ty::Closure(def_id, substs) | ty::Generator(def_id, substs, ..) => {\n+                debug!(\"visit_ty: def_id={:?}\", def_id);\n+                // Avoid cycle errors with generators.\n+                if def_id == self.def_id {\n+                    return false;\n+                }\n+\n+                // Consider any generic parameters used by any closures/generators as used in the\n+                // parent.\n+                let unused = self.tcx.unused_generic_params(def_id);\n+                debug!(\n+                    \"visit_ty: unused_parameters={:?} unused={:?}\",\n+                    self.unused_parameters, unused\n+                );\n+                for (i, arg) in substs.iter().enumerate() {\n+                    let i = i.try_into().unwrap();\n+                    if !unused.contains(i).unwrap_or(false) {\n+                        arg.visit_with(self);\n+                    }\n+                }\n+                debug!(\"visit_ty: unused_parameters={:?}\", self.unused_parameters);\n+\n+                false\n+            }\n+            ty::Param(param) => {\n+                debug!(\"visit_ty: param={:?}\", param);\n+                self.unused_parameters.clear(param.index);\n+                false\n+            }\n+            _ => ty.super_visit_with(self),\n+        }\n+    }\n+}"}, {"sha": "bfa9bb9e0f0e1a6657ac8dce2b864fa3342838dc", "filename": "src/librustc_mir/shim.rs", "status": "modified", "additions": 3, "deletions": 22, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_mir%2Fshim.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_mir%2Fshim.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fshim.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -4,7 +4,7 @@ use rustc_hir::lang_items::FnMutTraitLangItem;\n use rustc_middle::mir::*;\n use rustc_middle::ty::query::Providers;\n use rustc_middle::ty::subst::{InternalSubsts, Subst};\n-use rustc_middle::ty::{self, Ty, TyCtxt, TypeFoldable};\n+use rustc_middle::ty::{self, Ty, TyCtxt};\n use rustc_target::abi::VariantIdx;\n \n use rustc_index::vec::{Idx, IndexVec};\n@@ -36,11 +36,6 @@ fn make_shim<'tcx>(tcx: TyCtxt<'tcx>, instance: ty::InstanceDef<'tcx>) -> Body<'\n             build_call_shim(tcx, instance, Some(Adjustment::Deref), CallKind::Direct(def_id), None)\n         }\n         ty::InstanceDef::FnPtrShim(def_id, ty) => {\n-            // FIXME(eddyb) support generating shims for a \"shallow type\",\n-            // e.g. `Foo<_>` or `[_]` instead of requiring a fully monomorphic\n-            // `Foo<Bar>` or `[String]` etc.\n-            assert!(!ty.needs_subst());\n-\n             let trait_ = tcx.trait_of_item(def_id).unwrap();\n             let adjustment = match tcx.fn_trait_kind_from_lang_item(trait_) {\n                 Some(ty::ClosureKind::FnOnce) => Adjustment::Identity,\n@@ -83,22 +78,8 @@ fn make_shim<'tcx>(tcx: TyCtxt<'tcx>, instance: ty::InstanceDef<'tcx>) -> Body<'\n                 None,\n             )\n         }\n-        ty::InstanceDef::DropGlue(def_id, ty) => {\n-            // FIXME(eddyb) support generating shims for a \"shallow type\",\n-            // e.g. `Foo<_>` or `[_]` instead of requiring a fully monomorphic\n-            // `Foo<Bar>` or `[String]` etc.\n-            assert!(!ty.needs_subst());\n-\n-            build_drop_shim(tcx, def_id, ty)\n-        }\n-        ty::InstanceDef::CloneShim(def_id, ty) => {\n-            // FIXME(eddyb) support generating shims for a \"shallow type\",\n-            // e.g. `Foo<_>` or `[_]` instead of requiring a fully monomorphic\n-            // `Foo<Bar>` or `[String]` etc.\n-            assert!(!ty.needs_subst());\n-\n-            build_clone_shim(tcx, def_id, ty)\n-        }\n+        ty::InstanceDef::DropGlue(def_id, ty) => build_drop_shim(tcx, def_id, ty),\n+        ty::InstanceDef::CloneShim(def_id, ty) => build_clone_shim(tcx, def_id, ty),\n         ty::InstanceDef::Virtual(..) => {\n             bug!(\"InstanceDef::Virtual ({:?}) is for direct calls only\", instance)\n         }"}, {"sha": "3073bf53afd7869486a54daa9f7d13a8f1a86e4c", "filename": "src/librustc_mir/transform/const_prop.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_mir%2Ftransform%2Fconst_prop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_mir%2Ftransform%2Fconst_prop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fconst_prop.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -116,7 +116,7 @@ impl<'tcx> MirPass<'tcx> for ConstProp {\n             .predicates\n             .iter()\n             .filter_map(|(p, _)| if p.is_global() { Some(*p) } else { None });\n-        if !traits::normalize_and_test_predicates(\n+        if traits::impossible_predicates(\n             tcx,\n             traits::elaborate_predicates(tcx, predicates).map(|o| o.predicate).collect(),\n         ) {"}, {"sha": "6b2097240e215f5d4d75af507f42a3478e1dea19", "filename": "src/librustc_session/options.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_session%2Foptions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_session%2Foptions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_session%2Foptions.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -949,6 +949,8 @@ options! {DebuggingOptions, DebuggingSetter, basic_debugging_options,\n         (default: PLT is disabled if full relro is enabled)\"),\n     polonius: bool = (false, parse_bool, [UNTRACKED],\n         \"enable polonius-based borrow-checker (default: no)\"),\n+    polymorphize: bool = (true, parse_bool, [TRACKED],\n+          \"perform polymorphization analysis\"),\n     pre_link_arg: (/* redirected to pre_link_args */) = ((), parse_string_push, [UNTRACKED],\n         \"a single extra argument to prepend the linker invocation (can be used several times)\"),\n     pre_link_args: Vec<String> = (Vec::new(), parse_list, [UNTRACKED],"}, {"sha": "22a5115c7f556f12c508a678c299cd59048ec6b4", "filename": "src/librustc_span/symbol.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_span%2Fsymbol.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_span%2Fsymbol.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_span%2Fsymbol.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -921,6 +921,7 @@ symbols! {\n         rustc_peek_liveness,\n         rustc_peek_maybe_init,\n         rustc_peek_maybe_uninit,\n+        rustc_polymorphize_error,\n         rustc_private,\n         rustc_proc_macro_decls,\n         rustc_promotable,"}, {"sha": "90c89ea6b0a86243b8be7e564c50abb1a5c139a8", "filename": "src/librustc_symbol_mangling/legacy.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_symbol_mangling%2Flegacy.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_symbol_mangling%2Flegacy.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_symbol_mangling%2Flegacy.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -116,7 +116,6 @@ fn get_symbol_hash<'tcx>(\n \n         // also include any type parameters (for generic items)\n         assert!(!substs.has_erasable_regions());\n-        assert!(!substs.needs_subst());\n         substs.hash_stable(&mut hcx, &mut hasher);\n \n         if let Some(instantiating_crate) = instantiating_crate {"}, {"sha": "1c3755222495e28585dbb4d83efb2d57de7b8ee9", "filename": "src/librustc_trait_selection/traits/mod.rs", "status": "modified", "additions": 15, "deletions": 15, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_trait_selection%2Ftraits%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_trait_selection%2Ftraits%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trait_selection%2Ftraits%2Fmod.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -418,15 +418,14 @@ where\n     Ok(resolved_value)\n }\n \n-/// Normalizes the predicates and checks whether they hold in an empty\n-/// environment. If this returns false, then either normalize\n-/// encountered an error or one of the predicates did not hold. Used\n-/// when creating vtables to check for unsatisfiable methods.\n-pub fn normalize_and_test_predicates<'tcx>(\n+/// Normalizes the predicates and checks whether they hold in an empty environment. If this\n+/// returns true, then either normalize encountered an error or one of the predicates did not\n+/// hold. Used when creating vtables to check for unsatisfiable methods.\n+pub fn impossible_predicates<'tcx>(\n     tcx: TyCtxt<'tcx>,\n     predicates: Vec<ty::Predicate<'tcx>>,\n ) -> bool {\n-    debug!(\"normalize_and_test_predicates(predicates={:?})\", predicates);\n+    debug!(\"impossible_predicates(predicates={:?})\", predicates);\n \n     let result = tcx.infer_ctxt().enter(|infcx| {\n         let param_env = ty::ParamEnv::reveal_all();\n@@ -443,22 +442,23 @@ pub fn normalize_and_test_predicates<'tcx>(\n             fulfill_cx.register_predicate_obligation(&infcx, obligation);\n         }\n \n-        fulfill_cx.select_all_or_error(&infcx).is_ok()\n+        fulfill_cx.select_all_or_error(&infcx).is_err()\n     });\n-    debug!(\"normalize_and_test_predicates(predicates={:?}) = {:?}\", predicates, result);\n+    debug!(\"impossible_predicates(predicates={:?}) = {:?}\", predicates, result);\n     result\n }\n \n-fn substitute_normalize_and_test_predicates<'tcx>(\n+fn subst_and_check_impossible_predicates<'tcx>(\n     tcx: TyCtxt<'tcx>,\n     key: (DefId, SubstsRef<'tcx>),\n ) -> bool {\n-    debug!(\"substitute_normalize_and_test_predicates(key={:?})\", key);\n+    debug!(\"subst_and_check_impossible_predicates(key={:?})\", key);\n \n-    let predicates = tcx.predicates_of(key.0).instantiate(tcx, key.1).predicates;\n-    let result = normalize_and_test_predicates(tcx, predicates);\n+    let mut predicates = tcx.predicates_of(key.0).instantiate(tcx, key.1).predicates;\n+    predicates.retain(|predicate| !predicate.needs_subst());\n+    let result = impossible_predicates(tcx, predicates);\n \n-    debug!(\"substitute_normalize_and_test_predicates(key={:?}) = {:?}\", key, result);\n+    debug!(\"subst_and_check_impossible_predicates(key={:?}) = {:?}\", key, result);\n     result\n }\n \n@@ -510,7 +510,7 @@ fn vtable_methods<'tcx>(\n             // Note that this method could then never be called, so we\n             // do not want to try and codegen it, in that case (see #23435).\n             let predicates = tcx.predicates_of(def_id).instantiate_own(tcx, substs);\n-            if !normalize_and_test_predicates(tcx, predicates.predicates) {\n+            if impossible_predicates(tcx, predicates.predicates) {\n                 debug!(\"vtable_methods: predicates do not hold\");\n                 return None;\n             }\n@@ -558,8 +558,8 @@ pub fn provide(providers: &mut ty::query::Providers) {\n         specializes: specialize::specializes,\n         codegen_fulfill_obligation: codegen::codegen_fulfill_obligation,\n         vtable_methods,\n-        substitute_normalize_and_test_predicates,\n         type_implements_trait,\n+        subst_and_check_impossible_predicates,\n         ..*providers\n     };\n }"}, {"sha": "324ae4ec29e9b9cd7eb75a243e0069b15495bb16", "filename": "src/librustc_ty/instance.rs", "status": "modified", "additions": 23, "deletions": 18, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_ty%2Finstance.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Flibrustc_ty%2Finstance.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_ty%2Finstance.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -3,7 +3,7 @@ use rustc_hir::def_id::{DefId, LocalDefId};\n use rustc_infer::infer::TyCtxtInferExt;\n use rustc_middle::ty::subst::SubstsRef;\n use rustc_middle::ty::{self, Instance, TyCtxt, TypeFoldable};\n-use rustc_span::sym;\n+use rustc_span::{sym, DUMMY_SP};\n use rustc_target::spec::abi::Abi;\n use rustc_trait_selection::traits;\n use traits::{translate_substs, Reveal};\n@@ -67,12 +67,19 @@ fn inner_resolve_instance<'tcx>(\n                 let ty = substs.type_at(0);\n \n                 if ty.needs_drop(tcx, param_env) {\n-                    // `DropGlue` requires a monomorphic aka concrete type.\n-                    if ty.needs_subst() {\n-                        return Ok(None);\n+                    debug!(\" => nontrivial drop glue\");\n+                    match ty.kind {\n+                        ty::Closure(..)\n+                        | ty::Generator(..)\n+                        | ty::Tuple(..)\n+                        | ty::Adt(..)\n+                        | ty::Dynamic(..)\n+                        | ty::Array(..)\n+                        | ty::Slice(..) => {}\n+                        // Drop shims can only be built from ADTs.\n+                        _ => return Ok(None),\n                     }\n \n-                    debug!(\" => nontrivial drop glue\");\n                     ty::InstanceDef::DropGlue(def_id, Some(ty))\n                 } else {\n                     debug!(\" => trivial drop glue\");\n@@ -224,17 +231,13 @@ fn resolve_associated_item<'tcx>(\n                 trait_closure_kind,\n             ))\n         }\n-        traits::ImplSourceFnPointer(ref data) => {\n-            // `FnPtrShim` requires a monomorphic aka concrete type.\n-            if data.fn_ty.needs_subst() {\n-                return Ok(None);\n-            }\n-\n-            Some(Instance {\n+        traits::ImplSourceFnPointer(ref data) => match data.fn_ty.kind {\n+            ty::FnDef(..) | ty::FnPtr(..) => Some(Instance {\n                 def: ty::InstanceDef::FnPtrShim(trait_item.def_id, data.fn_ty),\n                 substs: rcvr_substs,\n-            })\n-        }\n+            }),\n+            _ => None,\n+        },\n         traits::ImplSourceObject(ref data) => {\n             let index = traits::get_vtable_index_of_object_method(tcx, data, def_id);\n             Some(Instance { def: ty::InstanceDef::Virtual(def_id, index), substs: rcvr_substs })\n@@ -246,10 +249,12 @@ fn resolve_associated_item<'tcx>(\n                 if name == sym::clone {\n                     let self_ty = trait_ref.self_ty();\n \n-                    // `CloneShim` requires a monomorphic aka concrete type.\n-                    if self_ty.needs_subst() {\n-                        return Ok(None);\n-                    }\n+                    let is_copy = self_ty.is_copy_modulo_regions(tcx.at(DUMMY_SP), param_env);\n+                    match self_ty.kind {\n+                        _ if is_copy => (),\n+                        ty::Array(..) | ty::Closure(..) | ty::Tuple(..) => {}\n+                        _ => return Ok(None),\n+                    };\n \n                     Some(Instance {\n                         def: ty::InstanceDef::CloneShim(def_id, self_ty),"}, {"sha": "aebccff01fc69bf62017966a2b6248176ca18113", "filename": "src/test/codegen-units/item-collection/static-init.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fcodegen-units%2Fitem-collection%2Fstatic-init.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fcodegen-units%2Fitem-collection%2Fstatic-init.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen-units%2Fitem-collection%2Fstatic-init.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -6,7 +6,7 @@ pub static FN : fn() = foo::<i32>;\n \n pub fn foo<T>() { }\n \n-//~ MONO_ITEM fn static_init::foo[0]<i32>\n+//~ MONO_ITEM fn static_init::foo[0]<T>\n //~ MONO_ITEM static static_init::FN[0]\n \n //~ MONO_ITEM fn static_init::start[0]"}, {"sha": "abe2d108eae7d77b21cebde17abf24a03a824eb2", "filename": "src/test/codegen-units/item-collection/trait-method-default-impl.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fcodegen-units%2Fitem-collection%2Ftrait-method-default-impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fcodegen-units%2Fitem-collection%2Ftrait-method-default-impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen-units%2Fitem-collection%2Ftrait-method-default-impl.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -27,7 +27,7 @@ impl SomeGenericTrait<u64> for i32 {\n \n     // For the non-generic foo(), we should generate a codegen-item even if it\n     // is not called anywhere\n-    //~ MONO_ITEM fn trait_method_default_impl::SomeGenericTrait[0]::foo[0]<i32, u64>\n+    //~ MONO_ITEM fn trait_method_default_impl::SomeGenericTrait[0]::foo[0]<i32, T1>\n }\n \n // Non-generic impl of generic trait"}, {"sha": "dc2ad0559b34f9c21cdba0be260f057271173d42", "filename": "src/test/codegen-units/polymorphization/unused_type_parameters.rs", "status": "added", "additions": 323, "deletions": 0, "changes": 323, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fcodegen-units%2Fpolymorphization%2Funused_type_parameters.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fcodegen-units%2Fpolymorphization%2Funused_type_parameters.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen-units%2Fpolymorphization%2Funused_type_parameters.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -0,0 +1,323 @@\n+// compile-flags:-Zprint-mono-items=lazy -Copt-level=1\n+// ignore-tidy-linelength\n+\n+#![crate_type = \"rlib\"]\n+\n+// This test checks that the polymorphization analysis correctly reduces the\n+// generated mono items.\n+\n+mod functions {\n+    // Function doesn't have any type parameters to be unused.\n+    pub fn no_parameters() {}\n+\n+//~ MONO_ITEM fn unused_type_parameters::functions[0]::no_parameters[0]\n+\n+    // Function has an unused type parameter.\n+    pub fn unused<T>() {\n+    }\n+\n+//~ MONO_ITEM fn unused_type_parameters::functions[0]::unused[0]<T>\n+\n+    // Function uses type parameter in value of a binding.\n+    pub fn used_binding_value<T: Default>() {\n+        let _: T = Default::default();\n+    }\n+\n+//~ MONO_ITEM fn unused_type_parameters::functions[0]::used_binding_value[0]<u32>\n+//~ MONO_ITEM fn unused_type_parameters::functions[0]::used_binding_value[0]<u64>\n+\n+    // Function uses type parameter in type of a binding.\n+    pub fn used_binding_type<T>() {\n+        let _: Option<T> = None;\n+    }\n+\n+//~ MONO_ITEM fn unused_type_parameters::functions[0]::used_binding_type[0]<u32>\n+//~ MONO_ITEM fn unused_type_parameters::functions[0]::used_binding_type[0]<u64>\n+\n+    // Function uses type parameter in argument.\n+    pub fn used_argument<T>(_: T) {\n+    }\n+\n+//~ MONO_ITEM fn unused_type_parameters::functions[0]::used_argument[0]<u32>\n+//~ MONO_ITEM fn unused_type_parameters::functions[0]::used_argument[0]<u64>\n+//\n+    // Function uses type parameter in substitutions to another function.\n+    pub fn used_substs<T>() {\n+        unused::<T>()\n+    }\n+\n+//~ MONO_ITEM fn unused_type_parameters::functions[0]::used_substs[0]<u32>\n+//~ MONO_ITEM fn unused_type_parameters::functions[0]::used_substs[0]<u64>\n+}\n+\n+\n+mod closures {\n+    // Function doesn't have any type parameters to be unused.\n+    pub fn no_parameters() {\n+        let _ = || {};\n+    }\n+\n+//~ MONO_ITEM fn unused_type_parameters::closures[0]::no_parameters[0]\n+\n+    // Function has an unused type parameter in parent and closure.\n+    pub fn unused<T>() -> u32 {\n+        let add_one = |x: u32| x + 1;\n+        add_one(3)\n+    }\n+\n+//~ MONO_ITEM fn unused_type_parameters::closures[0]::unused[0]::{{closure}}[0]<T, i8, extern \"rust-call\" fn((u32)) -> u32, ()>\n+//~ MONO_ITEM fn unused_type_parameters::closures[0]::unused[0]<T>\n+\n+    // Function has an unused type parameter in closure, but not in parent.\n+    pub fn used_parent<T: Default>() -> u32 {\n+        let _: T = Default::default();\n+        let add_one = |x: u32| x + 1;\n+        add_one(3)\n+    }\n+\n+//~ MONO_ITEM fn unused_type_parameters::closures[0]::used_parent[0]::{{closure}}[0]<T, i8, extern \"rust-call\" fn((u32)) -> u32, ()>\n+//~ MONO_ITEM fn unused_type_parameters::closures[0]::used_parent[0]<u32>\n+//~ MONO_ITEM fn unused_type_parameters::closures[0]::used_parent[0]<u64>\n+\n+    // Function uses type parameter in value of a binding in closure.\n+    pub fn used_binding_value<T: Default>() -> T {\n+        let x = || {\n+            let y: T = Default::default();\n+            y\n+        };\n+\n+        x()\n+    }\n+\n+//~ MONO_ITEM fn unused_type_parameters::closures[0]::used_binding_value[0]::{{closure}}[0]<u32, i8, extern \"rust-call\" fn(()) -> u32, ()>\n+//~ MONO_ITEM fn unused_type_parameters::closures[0]::used_binding_value[0]::{{closure}}[0]<u64, i8, extern \"rust-call\" fn(()) -> u64, ()>\n+//~ MONO_ITEM fn unused_type_parameters::closures[0]::used_binding_value[0]<u32>\n+//~ MONO_ITEM fn unused_type_parameters::closures[0]::used_binding_value[0]<u64>\n+\n+    // Function uses type parameter in type of a binding in closure.\n+    pub fn used_binding_type<T>() -> Option<T> {\n+        let x = || {\n+            let y: Option<T> = None;\n+            y\n+        };\n+\n+        x()\n+    }\n+\n+//~ MONO_ITEM fn unused_type_parameters::closures[0]::used_binding_type[0]::{{closure}}[0]<u32, i8, extern \"rust-call\" fn(()) -> core::option[0]::Option[0]<u32>, ()>\n+//~ MONO_ITEM fn unused_type_parameters::closures[0]::used_binding_type[0]::{{closure}}[0]<u64, i8, extern \"rust-call\" fn(()) -> core::option[0]::Option[0]<u64>, ()>\n+//~ MONO_ITEM fn unused_type_parameters::closures[0]::used_binding_type[0]<u32>\n+//~ MONO_ITEM fn unused_type_parameters::closures[0]::used_binding_type[0]<u64>\n+\n+    // Function and closure uses type parameter in argument.\n+    pub fn used_argument<T>(t: T) -> u32 {\n+        let x = |_: T| 3;\n+        x(t)\n+    }\n+\n+//~ MONO_ITEM fn unused_type_parameters::closures[0]::used_argument[0]::{{closure}}[0]<u32, i8, extern \"rust-call\" fn((u32)) -> u32, ()>\n+//~ MONO_ITEM fn unused_type_parameters::closures[0]::used_argument[0]::{{closure}}[0]<u64, i8, extern \"rust-call\" fn((u64)) -> u32, ()>\n+//~ MONO_ITEM fn unused_type_parameters::closures[0]::used_argument[0]<u32>\n+//~ MONO_ITEM fn unused_type_parameters::closures[0]::used_argument[0]<u64>\n+\n+    // Closure uses type parameter in argument.\n+    pub fn used_argument_closure<T: Default>() -> u32 {\n+        let t: T = Default::default();\n+        let x = |_: T| 3;\n+        x(t)\n+    }\n+\n+//~ MONO_ITEM fn unused_type_parameters::closures[0]::used_argument_closure[0]::{{closure}}[0]<u32, i8, extern \"rust-call\" fn((u32)) -> u32, ()>\n+//~ MONO_ITEM fn unused_type_parameters::closures[0]::used_argument_closure[0]::{{closure}}[0]<u64, i8, extern \"rust-call\" fn((u64)) -> u32, ()>\n+//~ MONO_ITEM fn unused_type_parameters::closures[0]::used_argument_closure[0]<u32>\n+//~ MONO_ITEM fn unused_type_parameters::closures[0]::used_argument_closure[0]<u64>\n+\n+    // Closure uses type parameter as upvar.\n+    pub fn used_upvar<T: Default>() -> T {\n+        let x: T = Default::default();\n+        let y = || x;\n+        y()\n+    }\n+\n+//~ MONO_ITEM fn unused_type_parameters::closures[0]::used_upvar[0]::{{closure}}[0]<u32, i32, extern \"rust-call\" fn(()) -> u32, (u32)>\n+//~ MONO_ITEM fn unused_type_parameters::closures[0]::used_upvar[0]::{{closure}}[0]<u64, i32, extern \"rust-call\" fn(()) -> u64, (u64)>\n+//~ MONO_ITEM fn unused_type_parameters::closures[0]::used_upvar[0]<u32>\n+//~ MONO_ITEM fn unused_type_parameters::closures[0]::used_upvar[0]<u64>\n+\n+    // Closure uses type parameter in substitutions to another function.\n+    pub fn used_substs<T>() {\n+        let x = || super::functions::unused::<T>();\n+        x()\n+    }\n+\n+//~ MONO_ITEM fn unused_type_parameters::closures[0]::used_substs[0]::{{closure}}[0]<u32, i8, extern \"rust-call\" fn(()), ()>\n+//~ MONO_ITEM fn unused_type_parameters::closures[0]::used_substs[0]::{{closure}}[0]<u64, i8, extern \"rust-call\" fn(()), ()>\n+//~ MONO_ITEM fn unused_type_parameters::closures[0]::used_substs[0]<u32>\n+//~ MONO_ITEM fn unused_type_parameters::closures[0]::used_substs[0]<u64>\n+}\n+\n+mod methods {\n+    pub struct Foo<F>(F);\n+\n+    impl<F: Default> Foo<F> {\n+        // Function has an unused type parameter from impl.\n+        pub fn unused_impl() {\n+        }\n+\n+//~ MONO_ITEM fn unused_type_parameters::methods[0]::{{impl}}[0]::unused_impl[0]<F>\n+\n+        // Function has an unused type parameter from impl and fn.\n+        pub fn unused_both<G: Default>() {\n+        }\n+\n+//~ MONO_ITEM fn unused_type_parameters::methods[0]::{{impl}}[0]::unused_both[0]<F, G>\n+\n+        // Function uses type parameter from impl.\n+        pub fn used_impl() {\n+            let _: F = Default::default();\n+        }\n+\n+//~ MONO_ITEM fn unused_type_parameters::methods[0]::{{impl}}[0]::used_impl[0]<u32>\n+//~ MONO_ITEM fn unused_type_parameters::methods[0]::{{impl}}[0]::used_impl[0]<u64>\n+\n+        // Function uses type parameter from impl.\n+        pub fn used_fn<G: Default>() {\n+            let _: G = Default::default();\n+        }\n+\n+//~ MONO_ITEM fn unused_type_parameters::methods[0]::{{impl}}[0]::used_fn[0]<F, u32>\n+//~ MONO_ITEM fn unused_type_parameters::methods[0]::{{impl}}[0]::used_fn[0]<F, u64>\n+\n+        // Function uses type parameter from impl.\n+        pub fn used_both<G: Default>() {\n+            let _: F = Default::default();\n+            let _: G = Default::default();\n+        }\n+\n+//~ MONO_ITEM fn unused_type_parameters::methods[0]::{{impl}}[0]::used_both[0]<u32, u32>\n+//~ MONO_ITEM fn unused_type_parameters::methods[0]::{{impl}}[0]::used_both[0]<u64, u64>\n+\n+        // Function uses type parameter in substitutions to another function.\n+        pub fn used_substs() {\n+            super::functions::unused::<F>()\n+        }\n+\n+//~ MONO_ITEM fn unused_type_parameters::methods[0]::{{impl}}[0]::used_substs[0]<u32>\n+//~ MONO_ITEM fn unused_type_parameters::methods[0]::{{impl}}[0]::used_substs[0]<u64>\n+\n+        // Function has an unused type parameter from impl and fn.\n+        pub fn closure_unused_all<G: Default>() -> u32 {\n+            let add_one = |x: u32| x + 1;\n+            add_one(3)\n+        }\n+\n+//~ MONO_ITEM fn unused_type_parameters::methods[0]::{{impl}}[0]::closure_unused_all[0]::{{closure}}[0]<F, G, i8, extern \"rust-call\" fn((u32)) -> u32, ()>\n+//~ MONO_ITEM fn unused_type_parameters::methods[0]::{{impl}}[0]::closure_unused_all[0]<F, G>\n+\n+        // Function uses type parameter from impl and fn in closure.\n+        pub fn closure_used_both<G: Default>() -> u32 {\n+            let add_one = |x: u32| {\n+                let _: F = Default::default();\n+                let _: G = Default::default();\n+                x + 1\n+            };\n+\n+            add_one(3)\n+        }\n+\n+//~ MONO_ITEM fn unused_type_parameters::methods[0]::{{impl}}[0]::closure_used_both[0]::{{closure}}[0]<u32, u32, i8, extern \"rust-call\" fn((u32)) -> u32, ()>\n+//~ MONO_ITEM fn unused_type_parameters::methods[0]::{{impl}}[0]::closure_used_both[0]::{{closure}}[0]<u64, u64, i8, extern \"rust-call\" fn((u32)) -> u32, ()>\n+//~ MONO_ITEM fn unused_type_parameters::methods[0]::{{impl}}[0]::closure_used_both[0]<u32, u32>\n+//~ MONO_ITEM fn unused_type_parameters::methods[0]::{{impl}}[0]::closure_used_both[0]<u64, u64>\n+\n+        // Function uses type parameter from fn in closure.\n+        pub fn closure_used_fn<G: Default>() -> u32 {\n+            let add_one = |x: u32| {\n+                let _: G = Default::default();\n+                x + 1\n+            };\n+\n+            add_one(3)\n+        }\n+\n+//~ MONO_ITEM fn unused_type_parameters::methods[0]::{{impl}}[0]::closure_used_fn[0]::{{closure}}[0]<F, u32, i8, extern \"rust-call\" fn((u32)) -> u32, ()>\n+//~ MONO_ITEM fn unused_type_parameters::methods[0]::{{impl}}[0]::closure_used_fn[0]::{{closure}}[0]<F, u64, i8, extern \"rust-call\" fn((u32)) -> u32, ()>\n+//~ MONO_ITEM fn unused_type_parameters::methods[0]::{{impl}}[0]::closure_used_fn[0]<F, u32>\n+//~ MONO_ITEM fn unused_type_parameters::methods[0]::{{impl}}[0]::closure_used_fn[0]<F, u64>\n+\n+        // Function uses type parameter from impl in closure.\n+        pub fn closure_used_impl<G: Default>() -> u32 {\n+            let add_one = |x: u32| {\n+                let _: F = Default::default();\n+                x + 1\n+            };\n+\n+            add_one(3)\n+        }\n+\n+//~ MONO_ITEM fn unused_type_parameters::methods[0]::{{impl}}[0]::closure_used_impl[0]::{{closure}}[0]<u32, G, i8, extern \"rust-call\" fn((u32)) -> u32, ()>\n+//~ MONO_ITEM fn unused_type_parameters::methods[0]::{{impl}}[0]::closure_used_impl[0]::{{closure}}[0]<u64, G, i8, extern \"rust-call\" fn((u32)) -> u32, ()>\n+//~ MONO_ITEM fn unused_type_parameters::methods[0]::{{impl}}[0]::closure_used_impl[0]<u32, G>\n+//~ MONO_ITEM fn unused_type_parameters::methods[0]::{{impl}}[0]::closure_used_impl[0]<u64, G>\n+\n+        // Closure uses type parameter in substitutions to another function.\n+        pub fn closure_used_substs() {\n+            let x = || super::functions::unused::<F>();\n+            x()\n+        }\n+\n+//~ MONO_ITEM fn unused_type_parameters::methods[0]::{{impl}}[0]::closure_used_substs[0]::{{closure}}[0]<u32, i8, extern \"rust-call\" fn(()), ()>\n+//~ MONO_ITEM fn unused_type_parameters::methods[0]::{{impl}}[0]::closure_used_substs[0]::{{closure}}[0]<u64, i8, extern \"rust-call\" fn(()), ()>\n+//~ MONO_ITEM fn unused_type_parameters::methods[0]::{{impl}}[0]::closure_used_substs[0]<u32>\n+//~ MONO_ITEM fn unused_type_parameters::methods[0]::{{impl}}[0]::closure_used_substs[0]<u64>\n+    }\n+}\n+\n+\n+\n+fn dispatch<T: Default>() {\n+    functions::no_parameters();\n+    functions::unused::<T>();\n+    functions::used_binding_value::<T>();\n+    functions::used_binding_type::<T>();\n+    functions::used_argument::<T>(Default::default());\n+    functions::used_substs::<T>();\n+\n+    closures::no_parameters();\n+    let _ = closures::unused::<T>();\n+    let _ = closures::used_parent::<T>();\n+    let _ = closures::used_binding_value::<T>();\n+    let _ = closures::used_binding_type::<T>();\n+    let _ = closures::used_argument::<T>(Default::default());\n+    let _ = closures::used_argument_closure::<T>();\n+    let _ = closures::used_upvar::<T>();\n+    let _ = closures::used_substs::<T>();\n+\n+    methods::Foo::<T>::unused_impl();\n+    methods::Foo::<T>::unused_both::<T>();\n+    methods::Foo::<T>::used_impl();\n+    methods::Foo::<T>::used_fn::<T>();\n+    methods::Foo::<T>::used_both::<T>();\n+    methods::Foo::<T>::used_substs();\n+    let _ = methods::Foo::<T>::closure_unused_all::<T>();\n+    let _ = methods::Foo::<T>::closure_used_both::<T>();\n+    let _ = methods::Foo::<T>::closure_used_impl::<T>();\n+    let _ = methods::Foo::<T>::closure_used_fn::<T>();\n+    let _ = methods::Foo::<T>::closure_used_substs();\n+}\n+\n+//~ MONO_ITEM fn unused_type_parameters::dispatch[0]<u32>\n+//~ MONO_ITEM fn unused_type_parameters::dispatch[0]<u64>\n+\n+pub fn foo() {\n+    // Generate two copies of each function to check that where the type parameter is unused,\n+    // there is only a single copy.\n+    dispatch::<u32>();\n+    dispatch::<u64>();\n+}\n+\n+//~ MONO_ITEM fn unused_type_parameters::foo[0] @@ unused_type_parameters-cgu.0[External]\n+\n+// These are all the items that aren't relevant to the test.\n+//~ MONO_ITEM fn core::default[0]::{{impl}}[6]::default[0]\n+//~ MONO_ITEM fn core::default[0]::{{impl}}[7]::default[0]"}, {"sha": "7bbcaebea0125ceb6bb6d1bd626e67d1a44b4ef8", "filename": "src/test/ui/polymorphization/const_parameters/closures.rs", "status": "added", "additions": 66, "deletions": 0, "changes": 66, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fui%2Fpolymorphization%2Fconst_parameters%2Fclosures.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fui%2Fpolymorphization%2Fconst_parameters%2Fclosures.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fpolymorphization%2Fconst_parameters%2Fclosures.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -0,0 +1,66 @@\n+// build-fail\n+#![feature(const_generics, rustc_attrs)]\n+//~^ WARN the feature `const_generics` is incomplete\n+\n+// This test checks that the polymorphization analysis correctly detects unused const\n+// parameters in closures.\n+\n+// Function doesn't have any generic parameters to be unused.\n+#[rustc_polymorphize_error]\n+pub fn no_parameters() {\n+    let _ = || {};\n+}\n+\n+// Function has an unused generic parameter in parent and closure.\n+#[rustc_polymorphize_error]\n+pub fn unused<const T: usize>() -> usize {\n+    //~^ ERROR item has unused generic parameters\n+    let add_one = |x: usize| x + 1;\n+    //~^ ERROR item has unused generic parameters\n+    add_one(3)\n+}\n+\n+// Function has an unused generic parameter in closure, but not in parent.\n+#[rustc_polymorphize_error]\n+pub fn used_parent<const T: usize>() -> usize {\n+    let x: usize = T;\n+    let add_one = |x: usize| x + 1;\n+    //~^ ERROR item has unused generic parameters\n+    x + add_one(3)\n+}\n+\n+// Function uses generic parameter in value of a binding in closure.\n+#[rustc_polymorphize_error]\n+pub fn used_binding<const T: usize>() -> usize {\n+    let x = || {\n+        let y: usize = T;\n+        y\n+    };\n+\n+    x()\n+}\n+\n+// Closure uses a value as an upvar, which used the generic parameter.\n+#[rustc_polymorphize_error]\n+pub fn unused_upvar<const T: usize>() -> usize {\n+    let x: usize = T;\n+    let y = || x;\n+    //~^ ERROR item has unused generic parameters\n+    y()\n+}\n+\n+// Closure uses generic parameter in substitutions to another function.\n+#[rustc_polymorphize_error]\n+pub fn used_substs<const T: usize>() -> usize {\n+    let x = || unused::<T>();\n+    x()\n+}\n+\n+fn main() {\n+    no_parameters();\n+    let _ = unused::<1>();\n+    let _ = used_parent::<1>();\n+    let _ = used_binding::<1>();\n+    let _ = unused_upvar::<1>();\n+    let _ = used_substs::<1>();\n+}"}, {"sha": "eb872eac74c9177c9c4d7a3c7b50373fde983475", "filename": "src/test/ui/polymorphization/const_parameters/closures.stderr", "status": "added", "additions": 44, "deletions": 0, "changes": 44, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fui%2Fpolymorphization%2Fconst_parameters%2Fclosures.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fui%2Fpolymorphization%2Fconst_parameters%2Fclosures.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fpolymorphization%2Fconst_parameters%2Fclosures.stderr?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -0,0 +1,44 @@\n+warning: the feature `const_generics` is incomplete and may not be safe to use and/or cause compiler crashes\n+  --> $DIR/closures.rs:2:12\n+   |\n+LL | #![feature(const_generics, rustc_attrs)]\n+   |            ^^^^^^^^^^^^^^\n+   |\n+   = note: `#[warn(incomplete_features)]` on by default\n+   = note: see issue #44580 <https://github.com/rust-lang/rust/issues/44580> for more information\n+\n+error: item has unused generic parameters\n+  --> $DIR/closures.rs:18:19\n+   |\n+LL | pub fn unused<const T: usize>() -> usize {\n+   |                     - generic parameter `T` is unused\n+LL |\n+LL |     let add_one = |x: usize| x + 1;\n+   |                   ^^^^^^^^^^^^^^^^\n+\n+error: item has unused generic parameters\n+  --> $DIR/closures.rs:16:8\n+   |\n+LL | pub fn unused<const T: usize>() -> usize {\n+   |        ^^^^^^       - generic parameter `T` is unused\n+\n+error: item has unused generic parameters\n+  --> $DIR/closures.rs:27:19\n+   |\n+LL | pub fn used_parent<const T: usize>() -> usize {\n+   |                          - generic parameter `T` is unused\n+LL |     let x: usize = T;\n+LL |     let add_one = |x: usize| x + 1;\n+   |                   ^^^^^^^^^^^^^^^^\n+\n+error: item has unused generic parameters\n+  --> $DIR/closures.rs:47:13\n+   |\n+LL | pub fn unused_upvar<const T: usize>() -> usize {\n+   |                           - generic parameter `T` is unused\n+LL |     let x: usize = T;\n+LL |     let y = || x;\n+   |             ^^^^\n+\n+error: aborting due to 4 previous errors; 1 warning emitted\n+"}, {"sha": "77539b94e489a0a712d17520a007b02142b057e5", "filename": "src/test/ui/polymorphization/const_parameters/functions.rs", "status": "added", "additions": 36, "deletions": 0, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fui%2Fpolymorphization%2Fconst_parameters%2Ffunctions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fui%2Fpolymorphization%2Fconst_parameters%2Ffunctions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fpolymorphization%2Fconst_parameters%2Ffunctions.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -0,0 +1,36 @@\n+// build-fail\n+#![feature(const_generics, rustc_attrs)]\n+//~^ WARN the feature `const_generics` is incomplete\n+\n+// This test checks that the polymorphization analysis correctly detects unused const\n+// parameters in functions.\n+\n+// Function doesn't have any generic parameters to be unused.\n+#[rustc_polymorphize_error]\n+pub fn no_parameters() {}\n+\n+// Function has an unused generic parameter.\n+#[rustc_polymorphize_error]\n+pub fn unused<const T: usize>() {\n+    //~^ ERROR item has unused generic parameters\n+}\n+\n+// Function uses generic parameter in value of a binding.\n+#[rustc_polymorphize_error]\n+pub fn used_binding<const T: usize>() -> usize {\n+    let x: usize = T;\n+    x\n+}\n+\n+// Function uses generic parameter in substitutions to another function.\n+#[rustc_polymorphize_error]\n+pub fn used_substs<const T: usize>() {\n+    unused::<T>()\n+}\n+\n+fn main() {\n+    no_parameters();\n+    unused::<1>();\n+    used_binding::<1>();\n+    used_substs::<1>();\n+}"}, {"sha": "c99a9b788ebc5e012430a69ef8093870f9530e65", "filename": "src/test/ui/polymorphization/const_parameters/functions.stderr", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fui%2Fpolymorphization%2Fconst_parameters%2Ffunctions.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fui%2Fpolymorphization%2Fconst_parameters%2Ffunctions.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fpolymorphization%2Fconst_parameters%2Ffunctions.stderr?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -0,0 +1,17 @@\n+warning: the feature `const_generics` is incomplete and may not be safe to use and/or cause compiler crashes\n+  --> $DIR/functions.rs:2:12\n+   |\n+LL | #![feature(const_generics, rustc_attrs)]\n+   |            ^^^^^^^^^^^^^^\n+   |\n+   = note: `#[warn(incomplete_features)]` on by default\n+   = note: see issue #44580 <https://github.com/rust-lang/rust/issues/44580> for more information\n+\n+error: item has unused generic parameters\n+  --> $DIR/functions.rs:14:8\n+   |\n+LL | pub fn unused<const T: usize>() {\n+   |        ^^^^^^       - generic parameter `T` is unused\n+\n+error: aborting due to previous error; 1 warning emitted\n+"}, {"sha": "ce56b7a358861c30d404cd9aa11a6eecd7e454cf", "filename": "src/test/ui/polymorphization/drop_shims/simple.rs", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fui%2Fpolymorphization%2Fdrop_shims%2Fsimple.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fui%2Fpolymorphization%2Fdrop_shims%2Fsimple.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fpolymorphization%2Fdrop_shims%2Fsimple.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -0,0 +1,21 @@\n+// check-pass\n+\n+pub struct OnDrop<F: Fn()>(pub F);\n+\n+impl<F: Fn()> Drop for OnDrop<F> {\n+    fn drop(&mut self) { }\n+}\n+\n+fn foo<R, S: FnOnce()>(\n+    _: R,\n+    _: S,\n+) {\n+    let bar = || {\n+        let _ = OnDrop(|| ());\n+    };\n+    let _ = bar();\n+}\n+\n+fn main() {\n+    foo(3u32, || {});\n+}"}, {"sha": "b7ea07b6bc653595cff967c32e345810cbf85f0b", "filename": "src/test/ui/polymorphization/drop_shims/transitive.rs", "status": "added", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fui%2Fpolymorphization%2Fdrop_shims%2Ftransitive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fui%2Fpolymorphization%2Fdrop_shims%2Ftransitive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fpolymorphization%2Fdrop_shims%2Ftransitive.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -0,0 +1,26 @@\n+// check-pass\n+\n+pub struct OnDrop<F: Fn()>(pub F);\n+\n+impl<F: Fn()> Drop for OnDrop<F> {\n+    fn drop(&mut self) { }\n+}\n+\n+fn bar<F: FnOnce()>(f: F) {\n+    let _ = OnDrop(|| ());\n+    f()\n+}\n+\n+fn foo<R, S: FnOnce()>(\n+    _: R,\n+    _: S,\n+) {\n+    let bar = || {\n+        bar(|| {})\n+    };\n+    let _ = bar();\n+}\n+\n+fn main() {\n+    foo(3u32, || {});\n+}"}, {"sha": "1acba7c8bf14cff441da22bb9328b1a87cdecbed", "filename": "src/test/ui/polymorphization/generators.rs", "status": "added", "additions": 93, "deletions": 0, "changes": 93, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fui%2Fpolymorphization%2Fgenerators.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fui%2Fpolymorphization%2Fgenerators.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fpolymorphization%2Fgenerators.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -0,0 +1,93 @@\n+// build-fail\n+#![feature(const_generics, generators, generator_trait, rustc_attrs)]\n+//~^ WARN the feature `const_generics` is incomplete\n+\n+use std::marker::Unpin;\n+use std::ops::{Generator, GeneratorState};\n+use std::pin::Pin;\n+\n+enum YieldOrReturn<Y, R> {\n+    Yield(Y),\n+    Return(R),\n+}\n+\n+fn finish<T, Y, R>(mut t: T) -> Vec<YieldOrReturn<Y, R>>\n+where\n+    T: Generator<(), Yield = Y, Return = R> + Unpin,\n+{\n+    let mut results = Vec::new();\n+    loop {\n+        match Pin::new(&mut t).resume(()) {\n+            GeneratorState::Yielded(yielded) => results.push(YieldOrReturn::Yield(yielded)),\n+            GeneratorState::Complete(returned) => {\n+                results.push(YieldOrReturn::Return(returned));\n+                return results;\n+            }\n+        }\n+    }\n+}\n+\n+// This test checks that the polymorphization analysis functions on generators.\n+\n+#[rustc_polymorphize_error]\n+pub fn unused_type<T>() -> impl Generator<(), Yield = u32, Return = u32> + Unpin {\n+    //~^ ERROR item has unused generic parameters\n+    || {\n+        //~^ ERROR item has unused generic parameters\n+        yield 1;\n+        2\n+    }\n+}\n+\n+#[rustc_polymorphize_error]\n+pub fn used_type_in_yield<Y: Default>() -> impl Generator<(), Yield = Y, Return = u32> + Unpin {\n+    || {\n+        yield Y::default();\n+        2\n+    }\n+}\n+\n+#[rustc_polymorphize_error]\n+pub fn used_type_in_return<R: Default>() -> impl Generator<(), Yield = u32, Return = R> + Unpin {\n+    || {\n+        yield 3;\n+        R::default()\n+    }\n+}\n+\n+#[rustc_polymorphize_error]\n+pub fn unused_const<const T: u32>() -> impl Generator<(), Yield = u32, Return = u32> + Unpin {\n+    //~^ ERROR item has unused generic parameters\n+    || {\n+        //~^ ERROR item has unused generic parameters\n+        yield 1;\n+        2\n+    }\n+}\n+\n+#[rustc_polymorphize_error]\n+pub fn used_const_in_yield<const Y: u32>() -> impl Generator<(), Yield = u32, Return = u32> + Unpin\n+{\n+    || {\n+        yield Y;\n+        2\n+    }\n+}\n+\n+#[rustc_polymorphize_error]\n+pub fn used_const_in_return<const R: u32>() -> impl Generator<(), Yield = u32, Return = u32> + Unpin\n+{\n+    || {\n+        yield 4;\n+        R\n+    }\n+}\n+\n+fn main() {\n+    finish(unused_type::<u32>());\n+    finish(used_type_in_yield::<u32>());\n+    finish(used_type_in_return::<u32>());\n+    finish(unused_const::<1u32>());\n+    finish(used_const_in_yield::<1u32>());\n+    finish(used_const_in_return::<1u32>());\n+}"}, {"sha": "b3e5a2de0270a6049e27335c1addcb5dd9c7a916", "filename": "src/test/ui/polymorphization/generators.stderr", "status": "added", "additions": 49, "deletions": 0, "changes": 49, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fui%2Fpolymorphization%2Fgenerators.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fui%2Fpolymorphization%2Fgenerators.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fpolymorphization%2Fgenerators.stderr?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -0,0 +1,49 @@\n+warning: the feature `const_generics` is incomplete and may not be safe to use and/or cause compiler crashes\n+  --> $DIR/generators.rs:2:12\n+   |\n+LL | #![feature(const_generics, generators, generator_trait, rustc_attrs)]\n+   |            ^^^^^^^^^^^^^^\n+   |\n+   = note: `#[warn(incomplete_features)]` on by default\n+   = note: see issue #44580 <https://github.com/rust-lang/rust/issues/44580> for more information\n+\n+error: item has unused generic parameters\n+  --> $DIR/generators.rs:35:5\n+   |\n+LL |   pub fn unused_type<T>() -> impl Generator<(), Yield = u32, Return = u32> + Unpin {\n+   |                      - generic parameter `T` is unused\n+LL |\n+LL | /     || {\n+LL | |\n+LL | |         yield 1;\n+LL | |         2\n+LL | |     }\n+   | |_____^\n+\n+error: item has unused generic parameters\n+  --> $DIR/generators.rs:33:8\n+   |\n+LL | pub fn unused_type<T>() -> impl Generator<(), Yield = u32, Return = u32> + Unpin {\n+   |        ^^^^^^^^^^^ - generic parameter `T` is unused\n+\n+error: item has unused generic parameters\n+  --> $DIR/generators.rs:61:5\n+   |\n+LL |   pub fn unused_const<const T: u32>() -> impl Generator<(), Yield = u32, Return = u32> + Unpin {\n+   |                             - generic parameter `T` is unused\n+LL |\n+LL | /     || {\n+LL | |\n+LL | |         yield 1;\n+LL | |         2\n+LL | |     }\n+   | |_____^\n+\n+error: item has unused generic parameters\n+  --> $DIR/generators.rs:59:8\n+   |\n+LL | pub fn unused_const<const T: u32>() -> impl Generator<(), Yield = u32, Return = u32> + Unpin {\n+   |        ^^^^^^^^^^^^       - generic parameter `T` is unused\n+\n+error: aborting due to 4 previous errors; 1 warning emitted\n+"}, {"sha": "4bde349a336ea3b2dd85d8264fe53a340b3665a9", "filename": "src/test/ui/polymorphization/lifetimes.rs", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fui%2Fpolymorphization%2Flifetimes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fui%2Fpolymorphization%2Flifetimes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fpolymorphization%2Flifetimes.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -0,0 +1,24 @@\n+// build-fail\n+#![feature(rustc_attrs)]\n+\n+// This test checks that the polymorphization analysis doesn't break when the\n+// function/closure doesn't just have generic parameters.\n+\n+// Function has an unused generic parameter.\n+#[rustc_polymorphize_error]\n+pub fn unused<'a, T>(_: &'a u32) {\n+    //~^ ERROR item has unused generic parameters\n+}\n+\n+#[rustc_polymorphize_error]\n+pub fn used<'a, T: Default>(_: &'a u32) -> u32 {\n+    let _: T = Default::default();\n+    let add_one = |x: u32| x + 1;\n+    //~^ ERROR item has unused generic parameters\n+    add_one(3)\n+}\n+\n+fn main() {\n+    unused::<u32>(&3);\n+    used::<u32>(&3);\n+}"}, {"sha": "6c85e4f291611f855d91d4c74d70377b2376072b", "filename": "src/test/ui/polymorphization/lifetimes.stderr", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fui%2Fpolymorphization%2Flifetimes.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fui%2Fpolymorphization%2Flifetimes.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fpolymorphization%2Flifetimes.stderr?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -0,0 +1,17 @@\n+error: item has unused generic parameters\n+  --> $DIR/lifetimes.rs:9:8\n+   |\n+LL | pub fn unused<'a, T>(_: &'a u32) {\n+   |        ^^^^^^     - generic parameter `T` is unused\n+\n+error: item has unused generic parameters\n+  --> $DIR/lifetimes.rs:16:19\n+   |\n+LL | pub fn used<'a, T: Default>(_: &'a u32) -> u32 {\n+   |                 - generic parameter `T` is unused\n+LL |     let _: T = Default::default();\n+LL |     let add_one = |x: u32| x + 1;\n+   |                   ^^^^^^^^^^^^^^\n+\n+error: aborting due to 2 previous errors\n+"}, {"sha": "fa76b7201e8c3cabfa6e2d47eb0b5e25d843ecfb", "filename": "src/test/ui/polymorphization/normalized_sig_types.rs", "status": "added", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fui%2Fpolymorphization%2Fnormalized_sig_types.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fui%2Fpolymorphization%2Fnormalized_sig_types.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fpolymorphization%2Fnormalized_sig_types.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -0,0 +1,25 @@\n+// build-pass\n+\n+pub trait ParallelIterator: Sized {\n+    fn drive<C: Consumer<()>>(_: C) {\n+        C::into_folder();\n+    }\n+}\n+\n+pub trait Consumer<T>: Sized {\n+    type Result;\n+    fn into_folder() -> Self::Result;\n+}\n+\n+impl ParallelIterator for () {}\n+\n+impl<F: Fn(), T> Consumer<T> for F {\n+    type Result = ();\n+    fn into_folder() -> Self::Result {\n+        unimplemented!()\n+    }\n+}\n+\n+fn main() {\n+    <()>::drive(|| ());\n+}"}, {"sha": "390ac983aa00779060eccd348aa1750bab5035c7", "filename": "src/test/ui/polymorphization/predicates.rs", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fui%2Fpolymorphization%2Fpredicates.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fui%2Fpolymorphization%2Fpredicates.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fpolymorphization%2Fpredicates.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -0,0 +1,23 @@\n+// build-fail\n+#![feature(rustc_attrs)]\n+\n+// This test checks that `T` is considered used in `foo`, because it is used in a predicate for\n+// `I`, which is used.\n+\n+#[rustc_polymorphize_error]\n+fn bar<I>() {\n+    //~^ ERROR item has unused generic parameters\n+}\n+\n+#[rustc_polymorphize_error]\n+fn foo<I, T>(_: I)\n+where\n+    I: Iterator<Item = T>,\n+{\n+    bar::<I>()\n+}\n+\n+fn main() {\n+    let x = &[2u32];\n+    foo(x.iter());\n+}"}, {"sha": "1b266083463a2518a4816a3fd1151e077a6b6137", "filename": "src/test/ui/polymorphization/predicates.stderr", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fui%2Fpolymorphization%2Fpredicates.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fui%2Fpolymorphization%2Fpredicates.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fpolymorphization%2Fpredicates.stderr?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -0,0 +1,8 @@\n+error: item has unused generic parameters\n+  --> $DIR/predicates.rs:8:4\n+   |\n+LL | fn bar<I>() {\n+   |    ^^^ - generic parameter `I` is unused\n+\n+error: aborting due to previous error\n+"}, {"sha": "ec6244630fd1fc5616fa49d8a0439ce23c12574b", "filename": "src/test/ui/polymorphization/too-many-generic-params.rs", "status": "added", "additions": 85, "deletions": 0, "changes": 85, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fui%2Fpolymorphization%2Ftoo-many-generic-params.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fui%2Fpolymorphization%2Ftoo-many-generic-params.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fpolymorphization%2Ftoo-many-generic-params.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -0,0 +1,85 @@\n+// build-pass\n+#![feature(rustc_attrs)]\n+\n+// This test checks that the analysis doesn't panic when there are >64 generic parameters, but\n+// instead considers those parameters used.\n+\n+#[rustc_polymorphize_error]\n+fn bar<A, B, C, D, E, F, G, H, I, J, K, L, M, N, O, P, Q, R, S, T, U, V, W, X, Y, Z, AA,\n+       AB, AC, AD, AE, AF, AG, AH, AI, AJ, AK, AL, AM, AN, AO, AP, AQ, AR, AS, AT, AU, AV, AW,\n+       AX, AY, AZ, BA, BB, BC, BD, BE, BF, BG, BH, BI, BJ, BK, BL, BM>()\n+{\n+    let _: Option<A> = None;\n+    let _: Option<B> = None;\n+    let _: Option<C> = None;\n+    let _: Option<D> = None;\n+    let _: Option<E> = None;\n+    let _: Option<F> = None;\n+    let _: Option<G> = None;\n+    let _: Option<H> = None;\n+    let _: Option<I> = None;\n+    let _: Option<J> = None;\n+    let _: Option<K> = None;\n+    let _: Option<L> = None;\n+    let _: Option<M> = None;\n+    let _: Option<N> = None;\n+    let _: Option<O> = None;\n+    let _: Option<P> = None;\n+    let _: Option<Q> = None;\n+    let _: Option<R> = None;\n+    let _: Option<S> = None;\n+    let _: Option<T> = None;\n+    let _: Option<U> = None;\n+    let _: Option<V> = None;\n+    let _: Option<W> = None;\n+    let _: Option<X> = None;\n+    let _: Option<Y> = None;\n+    let _: Option<Z> = None;\n+    let _: Option<AA> = None;\n+    let _: Option<AB> = None;\n+    let _: Option<AC> = None;\n+    let _: Option<AD> = None;\n+    let _: Option<AE> = None;\n+    let _: Option<AF> = None;\n+    let _: Option<AG> = None;\n+    let _: Option<AH> = None;\n+    let _: Option<AI> = None;\n+    let _: Option<AJ> = None;\n+    let _: Option<AK> = None;\n+    let _: Option<AL> = None;\n+    let _: Option<AM> = None;\n+    let _: Option<AN> = None;\n+    let _: Option<AO> = None;\n+    let _: Option<AP> = None;\n+    let _: Option<AQ> = None;\n+    let _: Option<AR> = None;\n+    let _: Option<AS> = None;\n+    let _: Option<AT> = None;\n+    let _: Option<AU> = None;\n+    let _: Option<AV> = None;\n+    let _: Option<AW> = None;\n+    let _: Option<AX> = None;\n+    let _: Option<AY> = None;\n+    let _: Option<AZ> = None;\n+    let _: Option<BA> = None;\n+    let _: Option<BB> = None;\n+    let _: Option<BC> = None;\n+    let _: Option<BD> = None;\n+    let _: Option<BE> = None;\n+    let _: Option<BF> = None;\n+    let _: Option<BG> = None;\n+    let _: Option<BH> = None;\n+    let _: Option<BI> = None;\n+    let _: Option<BJ> = None;\n+    let _: Option<BK> = None;\n+    let _: Option<BL> = None;\n+    let _: Option<BM> = None;\n+}\n+\n+fn main() {\n+    bar::<u32, u32, u32, u32, u32, u32, u32, u32, u32, u32, u32, u32, u32, u32, u32, u32,\n+          u32, u32, u32, u32, u32, u32, u32, u32, u32, u32, u32, u32, u32, u32, u32, u32,\n+          u32, u32, u32, u32, u32, u32, u32, u32, u32, u32, u32, u32, u32, u32, u32, u32,\n+          u32, u32, u32, u32, u32, u32, u32, u32, u32, u32, u32, u32, u32, u32, u32, u32,\n+          u32>();\n+}"}, {"sha": "1fbe13380b5b99ab9cb172dbeff9b680320dee97", "filename": "src/test/ui/polymorphization/type_parameters/closures.rs", "status": "added", "additions": 160, "deletions": 0, "changes": 160, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fui%2Fpolymorphization%2Ftype_parameters%2Fclosures.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fui%2Fpolymorphization%2Ftype_parameters%2Fclosures.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fpolymorphization%2Ftype_parameters%2Fclosures.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -0,0 +1,160 @@\n+// build-fail\n+#![feature(stmt_expr_attributes, rustc_attrs)]\n+\n+// This test checks that the polymorphization analysis correctly detects unused type\n+// parameters in closures.\n+\n+// Function doesn't have any generic parameters to be unused.\n+#[rustc_polymorphize_error]\n+pub fn no_parameters() {\n+    let _ = || {};\n+}\n+\n+// Function has an unused generic parameter in parent and closure.\n+#[rustc_polymorphize_error]\n+pub fn unused<T>() -> u32 {\n+    //~^ ERROR item has unused generic parameters\n+\n+    let add_one = |x: u32| x + 1;\n+    //~^ ERROR item has unused generic parameters\n+    add_one(3)\n+}\n+\n+// Function has an unused generic parameter in closure, but not in parent.\n+#[rustc_polymorphize_error]\n+pub fn used_parent<T: Default>() -> u32 {\n+    let _: T = Default::default();\n+    let add_one = |x: u32| x + 1;\n+    //~^ ERROR item has unused generic parameters\n+    add_one(3)\n+}\n+\n+// Function uses generic parameter in value of a binding in closure.\n+#[rustc_polymorphize_error]\n+pub fn used_binding_value<T: Default>() -> T {\n+    let x = || {\n+        let y: T = Default::default();\n+        y\n+    };\n+\n+    x()\n+}\n+\n+// Function uses generic parameter in generic of a binding in closure.\n+#[rustc_polymorphize_error]\n+pub fn used_binding_generic<T>() -> Option<T> {\n+    let x = || {\n+        let y: Option<T> = None;\n+        y\n+    };\n+\n+    x()\n+}\n+\n+// Function and closure uses generic parameter in argument.\n+#[rustc_polymorphize_error]\n+pub fn used_argument<T>(t: T) -> u32 {\n+    let x = |_: T| 3;\n+    x(t)\n+}\n+\n+// Closure uses generic parameter in argument.\n+#[rustc_polymorphize_error]\n+pub fn used_argument_closure<T: Default>() -> u32 {\n+    let t: T = Default::default();\n+\n+    let x = |_: T| 3;\n+    x(t)\n+}\n+\n+// Closure uses generic parameter as upvar.\n+#[rustc_polymorphize_error]\n+pub fn used_upvar<T: Default>() -> T {\n+    let x: T = Default::default();\n+\n+    let y = || x;\n+    y()\n+}\n+\n+// Closure uses generic parameter in substitutions to another function.\n+#[rustc_polymorphize_error]\n+pub fn used_substs<T>() -> u32 {\n+    let x = || unused::<T>();\n+    x()\n+}\n+\n+struct Foo<F>(F);\n+\n+impl<F: Default> Foo<F> {\n+    // Function has an unused generic parameter from impl and fn.\n+    #[rustc_polymorphize_error]\n+    pub fn unused_all<G: Default>() -> u32 {\n+        //~^ ERROR item has unused generic parameters\n+        let add_one = |x: u32| x + 1;\n+        //~^ ERROR item has unused generic parameters\n+        add_one(3)\n+    }\n+\n+    // Function uses generic parameter from impl and fn in closure.\n+    #[rustc_polymorphize_error]\n+    pub fn used_both<G: Default>() -> u32 {\n+        let add_one = |x: u32| {\n+            let _: F = Default::default();\n+            let _: G = Default::default();\n+            x + 1\n+        };\n+\n+        add_one(3)\n+    }\n+\n+    // Function uses generic parameter from fn in closure.\n+    #[rustc_polymorphize_error]\n+    pub fn used_fn<G: Default>() -> u32 {\n+        //~^ ERROR item has unused generic parameters\n+        let add_one = |x: u32| {\n+            //~^ ERROR item has unused generic parameters\n+            let _: G = Default::default();\n+            x + 1\n+        };\n+\n+        add_one(3)\n+    }\n+\n+    // Function uses generic parameter from impl in closure.\n+    #[rustc_polymorphize_error]\n+    pub fn used_impl<G: Default>() -> u32 {\n+        //~^ ERROR item has unused generic parameters\n+        let add_one = |x: u32| {\n+            //~^ ERROR item has unused generic parameters\n+            let _: F = Default::default();\n+            x + 1\n+        };\n+\n+        add_one(3)\n+    }\n+\n+    // Closure uses generic parameter in substitutions to another function.\n+    #[rustc_polymorphize_error]\n+    pub fn used_substs() -> u32 {\n+        let x = || unused::<F>();\n+        x()\n+    }\n+}\n+\n+fn main() {\n+    no_parameters();\n+    let _ = unused::<u32>();\n+    let _ = used_parent::<u32>();\n+    let _ = used_binding_value::<u32>();\n+    let _ = used_binding_generic::<u32>();\n+    let _ = used_argument(3u32);\n+    let _ = used_argument_closure::<u32>();\n+    let _ = used_upvar::<u32>();\n+    let _ = used_substs::<u32>();\n+\n+    let _ = Foo::<u32>::unused_all::<u32>();\n+    let _ = Foo::<u32>::used_both::<u32>();\n+    let _ = Foo::<u32>::used_impl::<u32>();\n+    let _ = Foo::<u32>::used_fn::<u32>();\n+    let _ = Foo::<u32>::used_substs();\n+}"}, {"sha": "d68e6e25a1eb969ae48bb03f0e3c455dbf7b7311", "filename": "src/test/ui/polymorphization/type_parameters/closures.stderr", "status": "added", "additions": 90, "deletions": 0, "changes": 90, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fui%2Fpolymorphization%2Ftype_parameters%2Fclosures.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fui%2Fpolymorphization%2Ftype_parameters%2Fclosures.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fpolymorphization%2Ftype_parameters%2Fclosures.stderr?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -0,0 +1,90 @@\n+error: item has unused generic parameters\n+  --> $DIR/closures.rs:18:19\n+   |\n+LL | pub fn unused<T>() -> u32 {\n+   |               - generic parameter `T` is unused\n+...\n+LL |     let add_one = |x: u32| x + 1;\n+   |                   ^^^^^^^^^^^^^^\n+\n+error: item has unused generic parameters\n+  --> $DIR/closures.rs:15:8\n+   |\n+LL | pub fn unused<T>() -> u32 {\n+   |        ^^^^^^ - generic parameter `T` is unused\n+\n+error: item has unused generic parameters\n+  --> $DIR/closures.rs:27:19\n+   |\n+LL | pub fn used_parent<T: Default>() -> u32 {\n+   |                    - generic parameter `T` is unused\n+LL |     let _: T = Default::default();\n+LL |     let add_one = |x: u32| x + 1;\n+   |                   ^^^^^^^^^^^^^^\n+\n+error: item has unused generic parameters\n+  --> $DIR/closures.rs:93:23\n+   |\n+LL | impl<F: Default> Foo<F> {\n+   |      - generic parameter `F` is unused\n+...\n+LL |     pub fn unused_all<G: Default>() -> u32 {\n+   |                       - generic parameter `G` is unused\n+LL |\n+LL |         let add_one = |x: u32| x + 1;\n+   |                       ^^^^^^^^^^^^^^\n+\n+error: item has unused generic parameters\n+  --> $DIR/closures.rs:91:12\n+   |\n+LL | impl<F: Default> Foo<F> {\n+   |      - generic parameter `F` is unused\n+...\n+LL |     pub fn unused_all<G: Default>() -> u32 {\n+   |            ^^^^^^^^^^ - generic parameter `G` is unused\n+\n+error: item has unused generic parameters\n+  --> $DIR/closures.rs:127:23\n+   |\n+LL |       pub fn used_impl<G: Default>() -> u32 {\n+   |                        - generic parameter `G` is unused\n+LL |\n+LL |           let add_one = |x: u32| {\n+   |  _______________________^\n+LL | |\n+LL | |             let _: F = Default::default();\n+LL | |             x + 1\n+LL | |         };\n+   | |_________^\n+\n+error: item has unused generic parameters\n+  --> $DIR/closures.rs:125:12\n+   |\n+LL |     pub fn used_impl<G: Default>() -> u32 {\n+   |            ^^^^^^^^^ - generic parameter `G` is unused\n+\n+error: item has unused generic parameters\n+  --> $DIR/closures.rs:114:23\n+   |\n+LL |   impl<F: Default> Foo<F> {\n+   |        - generic parameter `F` is unused\n+...\n+LL |           let add_one = |x: u32| {\n+   |  _______________________^\n+LL | |\n+LL | |             let _: G = Default::default();\n+LL | |             x + 1\n+LL | |         };\n+   | |_________^\n+\n+error: item has unused generic parameters\n+  --> $DIR/closures.rs:112:12\n+   |\n+LL | impl<F: Default> Foo<F> {\n+   |      - generic parameter `F` is unused\n+...\n+LL |     pub fn used_fn<G: Default>() -> u32 {\n+   |            ^^^^^^^\n+\n+error: aborting due to 9 previous errors\n+"}, {"sha": "38f10148c2c526ef442ce16222ed8fa59eb9a2c0", "filename": "src/test/ui/polymorphization/type_parameters/functions.rs", "status": "added", "additions": 95, "deletions": 0, "changes": 95, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fui%2Fpolymorphization%2Ftype_parameters%2Ffunctions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fui%2Fpolymorphization%2Ftype_parameters%2Ffunctions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fpolymorphization%2Ftype_parameters%2Ffunctions.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -0,0 +1,95 @@\n+// build-fail\n+#![feature(rustc_attrs)]\n+\n+// This test checks that the polymorphization analysis correctly detects unused type\n+// parameters in functions.\n+\n+// Function doesn't have any generic parameters to be unused.\n+#[rustc_polymorphize_error]\n+pub fn no_parameters() {}\n+\n+// Function has an unused generic parameter.\n+#[rustc_polymorphize_error]\n+pub fn unused<T>() {\n+    //~^ ERROR item has unused generic parameters\n+}\n+\n+// Function uses generic parameter in value of a binding.\n+#[rustc_polymorphize_error]\n+pub fn used_binding_value<T: Default>() {\n+    let _: T = Default::default();\n+}\n+\n+// Function uses generic parameter in generic of a binding.\n+#[rustc_polymorphize_error]\n+pub fn used_binding_generic<T>() {\n+    let _: Option<T> = None;\n+}\n+\n+// Function uses generic parameter in argument.\n+#[rustc_polymorphize_error]\n+pub fn used_argument<T>(_: T) {}\n+\n+// Function uses generic parameter in substitutions to another function.\n+#[rustc_polymorphize_error]\n+pub fn used_substs<T>() {\n+    unused::<T>()\n+}\n+\n+struct Foo<F>(F);\n+\n+impl<F: Default> Foo<F> {\n+    // Function has an unused generic parameter from impl.\n+    #[rustc_polymorphize_error]\n+    pub fn unused_impl() {\n+        //~^ ERROR item has unused generic parameters\n+    }\n+\n+    // Function has an unused generic parameter from impl and fn.\n+    #[rustc_polymorphize_error]\n+    pub fn unused_both<G: Default>() {\n+        //~^ ERROR item has unused generic parameters\n+    }\n+\n+    // Function uses generic parameter from impl.\n+    #[rustc_polymorphize_error]\n+    pub fn used_impl() {\n+        let _: F = Default::default();\n+    }\n+\n+    // Function uses generic parameter from impl.\n+    #[rustc_polymorphize_error]\n+    pub fn used_fn<G: Default>() {\n+        //~^ ERROR item has unused generic parameters\n+        let _: G = Default::default();\n+    }\n+\n+    // Function uses generic parameter from impl.\n+    #[rustc_polymorphize_error]\n+    pub fn used_both<G: Default>() {\n+        let _: F = Default::default();\n+        let _: G = Default::default();\n+    }\n+\n+    // Function uses generic parameter in substitutions to another function.\n+    #[rustc_polymorphize_error]\n+    pub fn used_substs() {\n+        unused::<F>()\n+    }\n+}\n+\n+fn main() {\n+    no_parameters();\n+    unused::<u32>();\n+    used_binding_value::<u32>();\n+    used_binding_generic::<u32>();\n+    used_argument(3u32);\n+    used_substs::<u32>();\n+\n+    Foo::<u32>::unused_impl();\n+    Foo::<u32>::unused_both::<u32>();\n+    Foo::<u32>::used_impl();\n+    Foo::<u32>::used_fn::<u32>();\n+    Foo::<u32>::used_both::<u32>();\n+    Foo::<u32>::used_substs();\n+}"}, {"sha": "be4c6576e964557b5ca0586ea138ada357eff54e", "filename": "src/test/ui/polymorphization/type_parameters/functions.stderr", "status": "added", "additions": 35, "deletions": 0, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fui%2Fpolymorphization%2Ftype_parameters%2Ffunctions.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fui%2Fpolymorphization%2Ftype_parameters%2Ffunctions.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fpolymorphization%2Ftype_parameters%2Ffunctions.stderr?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -0,0 +1,35 @@\n+error: item has unused generic parameters\n+  --> $DIR/functions.rs:13:8\n+   |\n+LL | pub fn unused<T>() {\n+   |        ^^^^^^ - generic parameter `T` is unused\n+\n+error: item has unused generic parameters\n+  --> $DIR/functions.rs:44:12\n+   |\n+LL | impl<F: Default> Foo<F> {\n+   |      - generic parameter `F` is unused\n+...\n+LL |     pub fn unused_impl() {\n+   |            ^^^^^^^^^^^\n+\n+error: item has unused generic parameters\n+  --> $DIR/functions.rs:50:12\n+   |\n+LL | impl<F: Default> Foo<F> {\n+   |      - generic parameter `F` is unused\n+...\n+LL |     pub fn unused_both<G: Default>() {\n+   |            ^^^^^^^^^^^ - generic parameter `G` is unused\n+\n+error: item has unused generic parameters\n+  --> $DIR/functions.rs:62:12\n+   |\n+LL | impl<F: Default> Foo<F> {\n+   |      - generic parameter `F` is unused\n+...\n+LL |     pub fn used_fn<G: Default>() {\n+   |            ^^^^^^^\n+\n+error: aborting due to 4 previous errors\n+"}, {"sha": "d2f3d4f13cdcc0c996147652347dfca45a6eac51", "filename": "src/test/ui/polymorphization/unsized_cast.rs", "status": "added", "additions": 28, "deletions": 0, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fui%2Fpolymorphization%2Funsized_cast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fui%2Fpolymorphization%2Funsized_cast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fpolymorphization%2Funsized_cast.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -0,0 +1,28 @@\n+// build-fail\n+#![feature(fn_traits, rustc_attrs, unboxed_closures)]\n+\n+// This test checks that the polymorphization analysis considers a closure\n+// as using all generic parameters if it does an unsizing cast.\n+\n+#[rustc_polymorphize_error]\n+fn foo<T: Default>() {\n+    let _: T = Default::default();\n+    (|| Box::new(|| {}) as Box<dyn Fn()>)();\n+    //~^ ERROR item has unused generic parameters\n+    //~^^ ERROR item has unused generic parameters\n+}\n+\n+#[rustc_polymorphize_error]\n+fn foo2<T: Default>() {\n+    let _: T = Default::default();\n+    (|| {\n+        let call: extern \"rust-call\" fn(_, _) = Fn::call;\n+        call(&|| {}, ());\n+        //~^ ERROR item has unused generic parameters\n+    })();\n+}\n+\n+fn main() {\n+    foo::<u32>();\n+    foo2::<u32>();\n+}"}, {"sha": "b8b96bbdf15a6e4009950b24f7cbc8057a8add1d", "filename": "src/test/ui/polymorphization/unsized_cast.stderr", "status": "added", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fui%2Fpolymorphization%2Funsized_cast.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftest%2Fui%2Fpolymorphization%2Funsized_cast.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fpolymorphization%2Funsized_cast.stderr?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -0,0 +1,29 @@\n+error: item has unused generic parameters\n+  --> $DIR/unsized_cast.rs:10:18\n+   |\n+LL | fn foo<T: Default>() {\n+   |        - generic parameter `T` is unused\n+LL |     let _: T = Default::default();\n+LL |     (|| Box::new(|| {}) as Box<dyn Fn()>)();\n+   |                  ^^^^^\n+\n+error: item has unused generic parameters\n+  --> $DIR/unsized_cast.rs:10:5\n+   |\n+LL | fn foo<T: Default>() {\n+   |        - generic parameter `T` is unused\n+LL |     let _: T = Default::default();\n+LL |     (|| Box::new(|| {}) as Box<dyn Fn()>)();\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: item has unused generic parameters\n+  --> $DIR/unsized_cast.rs:20:15\n+   |\n+LL | fn foo2<T: Default>() {\n+   |         - generic parameter `T` is unused\n+...\n+LL |         call(&|| {}, ());\n+   |               ^^^^^\n+\n+error: aborting due to 3 previous errors\n+"}, {"sha": "a4bee1c278059a97329ef6a28e6426288ac426ef", "filename": "src/tools/clippy/clippy_lints/src/utils/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Futils%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52522ade1f6979a35b24087dadcf5ba5c981cbe/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Futils%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Futils%2Fmod.rs?ref=b52522ade1f6979a35b24087dadcf5ba5c981cbe", "patch": "@@ -1346,7 +1346,7 @@ pub fn fn_has_unsatisfiable_preds(cx: &LateContext<'_>, did: DefId) -> bool {\n             .predicates\n             .iter()\n             .filter_map(|(p, _)| if p.is_global() { Some(*p) } else { None });\n-    !traits::normalize_and_test_predicates(\n+    traits::impossible_predicates(\n         cx.tcx,\n         traits::elaborate_predicates(cx.tcx, predicates)\n             .map(|o| o.predicate)"}]}