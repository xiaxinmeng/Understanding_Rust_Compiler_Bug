{"sha": "2d8b10f63c394c99f2268de3132086bc72ee5a2b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjJkOGIxMGY2M2MzOTRjOTlmMjI2OGRlMzEzMjA4NmJjNzJlZTVhMmI=", "commit": {"author": {"name": "Niko Matsakis", "email": "niko@alum.mit.edu", "date": "2019-09-17T08:47:54Z"}, "committer": {"name": "Niko Matsakis", "email": "niko@alum.mit.edu", "date": "2019-09-17T09:10:22Z"}, "message": "adjust larger comment to include the body", "tree": {"sha": "f64d374826427d582a0fb25ab3ebca46a5e04d3b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f64d374826427d582a0fb25ab3ebca46a5e04d3b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2d8b10f63c394c99f2268de3132086bc72ee5a2b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2d8b10f63c394c99f2268de3132086bc72ee5a2b", "html_url": "https://github.com/rust-lang/rust/commit/2d8b10f63c394c99f2268de3132086bc72ee5a2b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2d8b10f63c394c99f2268de3132086bc72ee5a2b/comments", "author": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "716b2bcfb36111ea8afb49d289ddfba2b62a7b8e", "url": "https://api.github.com/repos/rust-lang/rust/commits/716b2bcfb36111ea8afb49d289ddfba2b62a7b8e", "html_url": "https://github.com/rust-lang/rust/commit/716b2bcfb36111ea8afb49d289ddfba2b62a7b8e"}], "stats": {"total": 20, "additions": 10, "deletions": 10}, "files": [{"sha": "61be40a6b907f63e6ea69cd712bcc7bdeb7c9ae2", "filename": "src/librustc/hir/lowering/item.rs", "status": "modified", "additions": 10, "deletions": 10, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/2d8b10f63c394c99f2268de3132086bc72ee5a2b/src%2Flibrustc%2Fhir%2Flowering%2Fitem.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2d8b10f63c394c99f2268de3132086bc72ee5a2b/src%2Flibrustc%2Fhir%2Flowering%2Fitem.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fhir%2Flowering%2Fitem.rs?ref=2d8b10f63c394c99f2268de3132086bc72ee5a2b", "patch": "@@ -1099,8 +1099,7 @@ impl LoweringContext<'_> {\n             // from:\n             //\n             //     async fn foo(<pattern>: <ty>, <pattern>: <ty>, <pattern>: <ty>) {\n-            //       async move {\n-            //       }\n+            //         <body>\n             //     }\n             //\n             // into:\n@@ -1113,11 +1112,19 @@ impl LoweringContext<'_> {\n             //         let <pattern> = __arg1;\n             //         let __arg0 = __arg0;\n             //         let <pattern> = __arg0;\n+            //         drop-temps { <body> } // see comments later in fn for details\n             //       }\n             //     }\n             //\n             // If `<pattern>` is a simple ident, then it is lowered to a single\n             // `let <pattern> = <pattern>;` statement as an optimization.\n+            //\n+            // Note that the body is embedded in `drop-temps`; an\n+            // equivalent desugaring would be `return { <body>\n+            // };`. The key point is that we wish to drop all the\n+            // let-bound variables and temporaries created in the body\n+            // (and its tail expression!) before we drop the\n+            // parameters (c.f. rust-lang/rust#64512).\n             for (index, parameter) in decl.inputs.iter().enumerate() {\n                 let parameter = this.lower_param(parameter);\n                 let span = parameter.pat.span;\n@@ -1231,7 +1238,7 @@ impl LoweringContext<'_> {\n                         ThinVec::new(),\n                     );\n \n-                    // Create a block like\n+                    // As noted above, create the final block like\n                     //\n                     // ```\n                     // {\n@@ -1240,13 +1247,6 @@ impl LoweringContext<'_> {\n                     //   drop-temps { <user-body> }\n                     // }\n                     // ```\n-                    //\n-                    // This construction is carefully calibrated to\n-                    // get the drop-order correct.  In particular, the\n-                    // drop-temps ensures that any temporaries in the\n-                    // tail expression of `<user-body>` are dropped\n-                    // *before* the parameters are dropped (see\n-                    // rust-lang/rust#64512).\n                     let body = this.block_all(\n                         desugared_span,\n                         statements.into(),"}]}