{"sha": "3d8ce0aa55c182e569ad7015a0af752ef92e2572", "node_id": "MDY6Q29tbWl0NzI0NzEyOjNkOGNlMGFhNTVjMTgyZTU2OWFkNzAxNWEwYWY3NTJlZjkyZTI1NzI=", "commit": {"author": {"name": "Camelid", "email": "camelidcamel@gmail.com", "date": "2021-03-10T06:11:53Z"}, "committer": {"name": "Camelid", "email": "camelidcamel@gmail.com", "date": "2021-03-24T02:29:49Z"}, "message": "rustdoc: Use diagnostics for error when including sources\n\nThis error probably almost never happens, but we should still use the\ndiagnostic infrastructure. My guess is that the error was added back\nbefore rustdoc used the rustc diagnostic infrastructure (it was all\n`println!` and `eprintln!` back then!) and since it likely rarely occurs\nand this code doesn't change that much, no one thought to transition it\nto using diagnostics.\n\nNote that the old error was actually a warning (it didn't stop the rest\nof doc building). It seems very unlikely that this would fail without\nthe rest of the doc build failing, so it makes more sense for it to be a\nhard error.\n\nThe error looks like this:\n\n    error: failed to render source code for `src/test/rustdoc/smart-punct.rs`: \"bar\": foo\n      --> src/test/rustdoc/smart-punct.rs:3:1\n       |\n    3  | / #![crate_name = \"foo\"]\n    4  | |\n    5  | | //! This is the \"start\" of the 'document'! How'd you know that \"it's\" ...\n    6  | | //!\n    ...  |\n    22 | | //! I say \"don't smart-punct me -- please!\"\n    23 | | //! ```\n       | |_______^\n\nI wasn't sure how to trigger the error, so to create that message I\ntemporarily made rustdoc always emit it. That's also why it says \"bar\"\nand \"foo\" instead of a real error message.\n\nNote that the span of the diagnostic starts at line 3 because line 1 of\nthat file is a (non-doc) comment and line 2 is a blank line.", "tree": {"sha": "277f8bdcbea784c197dc2e635f2855938df0927d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/277f8bdcbea784c197dc2e635f2855938df0927d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3d8ce0aa55c182e569ad7015a0af752ef92e2572", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3d8ce0aa55c182e569ad7015a0af752ef92e2572", "html_url": "https://github.com/rust-lang/rust/commit/3d8ce0aa55c182e569ad7015a0af752ef92e2572", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3d8ce0aa55c182e569ad7015a0af752ef92e2572/comments", "author": {"login": "camelid", "id": 37223377, "node_id": "MDQ6VXNlcjM3MjIzMzc3", "avatar_url": "https://avatars.githubusercontent.com/u/37223377?v=4", "gravatar_id": "", "url": "https://api.github.com/users/camelid", "html_url": "https://github.com/camelid", "followers_url": "https://api.github.com/users/camelid/followers", "following_url": "https://api.github.com/users/camelid/following{/other_user}", "gists_url": "https://api.github.com/users/camelid/gists{/gist_id}", "starred_url": "https://api.github.com/users/camelid/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/camelid/subscriptions", "organizations_url": "https://api.github.com/users/camelid/orgs", "repos_url": "https://api.github.com/users/camelid/repos", "events_url": "https://api.github.com/users/camelid/events{/privacy}", "received_events_url": "https://api.github.com/users/camelid/received_events", "type": "User", "site_admin": false}, "committer": {"login": "camelid", "id": 37223377, "node_id": "MDQ6VXNlcjM3MjIzMzc3", "avatar_url": "https://avatars.githubusercontent.com/u/37223377?v=4", "gravatar_id": "", "url": "https://api.github.com/users/camelid", "html_url": "https://github.com/camelid", "followers_url": "https://api.github.com/users/camelid/followers", "following_url": "https://api.github.com/users/camelid/following{/other_user}", "gists_url": "https://api.github.com/users/camelid/gists{/gist_id}", "starred_url": "https://api.github.com/users/camelid/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/camelid/subscriptions", "organizations_url": "https://api.github.com/users/camelid/orgs", "repos_url": "https://api.github.com/users/camelid/repos", "events_url": "https://api.github.com/users/camelid/events{/privacy}", "received_events_url": "https://api.github.com/users/camelid/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "673d0db5e393e9c64897005b470bfeb6d5aec61b", "url": "https://api.github.com/repos/rust-lang/rust/commits/673d0db5e393e9c64897005b470bfeb6d5aec61b", "html_url": "https://github.com/rust-lang/rust/commit/673d0db5e393e9c64897005b470bfeb6d5aec61b"}], "stats": {"total": 8, "additions": 3, "deletions": 5}, "files": [{"sha": "001c8b090448bed2bb20ce825f4295a5a5c9155c", "filename": "src/librustdoc/html/sources.rs", "status": "modified", "additions": 3, "deletions": 5, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/3d8ce0aa55c182e569ad7015a0af752ef92e2572/src%2Flibrustdoc%2Fhtml%2Fsources.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3d8ce0aa55c182e569ad7015a0af752ef92e2572/src%2Flibrustdoc%2Fhtml%2Fsources.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fsources.rs?ref=3d8ce0aa55c182e569ad7015a0af752ef92e2572", "patch": "@@ -54,12 +54,10 @@ impl DocFolder for SourceCollector<'_, '_> {\n             self.scx.include_sources = match self.emit_source(&filename) {\n                 Ok(()) => true,\n                 Err(e) => {\n-                    println!(\n-                        \"warning: source code was requested to be rendered, \\\n-                         but processing `{}` had an error: {}\",\n-                        filename, e\n+                    self.scx.tcx.sess.span_err(\n+                        item.span.inner(),\n+                        &format!(\"failed to render source code for `{}`: {}\", filename, e),\n                     );\n-                    println!(\"         skipping rendering of source code\");\n                     false\n                 }\n             };"}]}