{"sha": "8b77e2692cd97552b1b8d66eb51cec69695b3a5b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjhiNzdlMjY5MmNkOTc1NTJiMWI4ZDY2ZWI1MWNlYzY5Njk1YjNhNWI=", "commit": {"author": {"name": "Jade", "email": "software@lfcode.ca", "date": "2021-06-14T04:41:46Z"}, "committer": {"name": "Jade", "email": "software@lfcode.ca", "date": "2021-06-19T08:09:19Z"}, "message": "Implement a config override for the default #[cfg(test)] in cargo crates\n\nFixes crates which vanish when the 'test' cfg atom is set.\n\nFix #7243.\nFix #9203.\nFix #7225.", "tree": {"sha": "82187a911cd5e5acd8ce84f1f375d53185a05c7f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/82187a911cd5e5acd8ce84f1f375d53185a05c7f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8b77e2692cd97552b1b8d66eb51cec69695b3a5b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8b77e2692cd97552b1b8d66eb51cec69695b3a5b", "html_url": "https://github.com/rust-lang/rust/commit/8b77e2692cd97552b1b8d66eb51cec69695b3a5b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8b77e2692cd97552b1b8d66eb51cec69695b3a5b/comments", "author": {"login": "lf-", "id": 6652840, "node_id": "MDQ6VXNlcjY2NTI4NDA=", "avatar_url": "https://avatars.githubusercontent.com/u/6652840?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lf-", "html_url": "https://github.com/lf-", "followers_url": "https://api.github.com/users/lf-/followers", "following_url": "https://api.github.com/users/lf-/following{/other_user}", "gists_url": "https://api.github.com/users/lf-/gists{/gist_id}", "starred_url": "https://api.github.com/users/lf-/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lf-/subscriptions", "organizations_url": "https://api.github.com/users/lf-/orgs", "repos_url": "https://api.github.com/users/lf-/repos", "events_url": "https://api.github.com/users/lf-/events{/privacy}", "received_events_url": "https://api.github.com/users/lf-/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lf-", "id": 6652840, "node_id": "MDQ6VXNlcjY2NTI4NDA=", "avatar_url": "https://avatars.githubusercontent.com/u/6652840?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lf-", "html_url": "https://github.com/lf-", "followers_url": "https://api.github.com/users/lf-/followers", "following_url": "https://api.github.com/users/lf-/following{/other_user}", "gists_url": "https://api.github.com/users/lf-/gists{/gist_id}", "starred_url": "https://api.github.com/users/lf-/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lf-/subscriptions", "organizations_url": "https://api.github.com/users/lf-/orgs", "repos_url": "https://api.github.com/users/lf-/repos", "events_url": "https://api.github.com/users/lf-/events{/privacy}", "received_events_url": "https://api.github.com/users/lf-/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1f6abb7fbae35dbd036032a6ea2a9e04307f1f55", "url": "https://api.github.com/repos/rust-lang/rust/commits/1f6abb7fbae35dbd036032a6ea2a9e04307f1f55", "html_url": "https://github.com/rust-lang/rust/commit/1f6abb7fbae35dbd036032a6ea2a9e04307f1f55"}], "stats": {"total": 163, "additions": 108, "deletions": 55}, "files": [{"sha": "916d39a0b4a2bf3b41c78139de8215df821142bf", "filename": "crates/cfg/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/8b77e2692cd97552b1b8d66eb51cec69695b3a5b/crates%2Fcfg%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8b77e2692cd97552b1b8d66eb51cec69695b3a5b/crates%2Fcfg%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fcfg%2Fsrc%2Flib.rs?ref=8b77e2692cd97552b1b8d66eb51cec69695b3a5b", "patch": "@@ -52,6 +52,7 @@ impl CfgOptions {\n     }\n }\n \n+#[derive(Clone, Debug, PartialEq, Eq)]\n pub struct CfgDiff {\n     // Invariants: No duplicates, no atom that's both in `enable` and `disable`.\n     enable: Vec<CfgAtom>,"}, {"sha": "0935ea96762367923a53bbf55d9bd78127b9747a", "filename": "crates/project_model/src/cargo_workspace.rs", "status": "modified", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/8b77e2692cd97552b1b8d66eb51cec69695b3a5b/crates%2Fproject_model%2Fsrc%2Fcargo_workspace.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8b77e2692cd97552b1b8d66eb51cec69695b3a5b/crates%2Fproject_model%2Fsrc%2Fcargo_workspace.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproject_model%2Fsrc%2Fcargo_workspace.rs?ref=8b77e2692cd97552b1b8d66eb51cec69695b3a5b", "patch": "@@ -1,5 +1,6 @@\n //! See [`CargoWorkspace`].\n \n+use std::iter;\n use std::path::PathBuf;\n use std::{convert::TryInto, ops, process::Command, sync::Arc};\n \n@@ -12,6 +13,7 @@ use rustc_hash::FxHashMap;\n use serde::Deserialize;\n use serde_json::from_value;\n \n+use crate::CfgOverrides;\n use crate::{build_data::BuildDataConfig, utf8_stdout};\n \n /// [`CargoWorkspace`] represents the logical structure of, well, a Cargo\n@@ -76,6 +78,21 @@ pub struct CargoConfig {\n \n     /// rustc private crate source\n     pub rustc_source: Option<RustcSource>,\n+\n+    /// crates to disable `#[cfg(test)]` on\n+    pub unset_test_crates: Vec<String>,\n+}\n+\n+impl CargoConfig {\n+    pub fn cfg_overrides(&self) -> CfgOverrides {\n+        self.unset_test_crates\n+            .iter()\n+            .cloned()\n+            .zip(iter::repeat_with(|| {\n+                cfg::CfgDiff::new(Vec::new(), vec![cfg::CfgAtom::Flag(\"test\".into())]).unwrap()\n+            }))\n+            .collect()\n+    }\n }\n \n pub type Package = Idx<PackageData>;"}, {"sha": "1d408dff2eafeb2f48de0fd3a87478c2c6385ff2", "filename": "crates/project_model/src/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/8b77e2692cd97552b1b8d66eb51cec69695b3a5b/crates%2Fproject_model%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8b77e2692cd97552b1b8d66eb51cec69695b3a5b/crates%2Fproject_model%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproject_model%2Fsrc%2Flib.rs?ref=8b77e2692cd97552b1b8d66eb51cec69695b3a5b", "patch": "@@ -41,7 +41,7 @@ pub use crate::{\n     },\n     project_json::{ProjectJson, ProjectJsonData},\n     sysroot::Sysroot,\n-    workspace::{PackageRoot, ProjectWorkspace},\n+    workspace::{CfgOverrides, PackageRoot, ProjectWorkspace},\n };\n \n pub use proc_macro_api::ProcMacroClient;"}, {"sha": "d8217f714ebb935aa6e8f8c4e20bc87cd0683031", "filename": "crates/project_model/src/workspace.rs", "status": "modified", "additions": 70, "deletions": 54, "changes": 124, "blob_url": "https://github.com/rust-lang/rust/blob/8b77e2692cd97552b1b8d66eb51cec69695b3a5b/crates%2Fproject_model%2Fsrc%2Fworkspace.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8b77e2692cd97552b1b8d66eb51cec69695b3a5b/crates%2Fproject_model%2Fsrc%2Fworkspace.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproject_model%2Fsrc%2Fworkspace.rs?ref=8b77e2692cd97552b1b8d66eb51cec69695b3a5b", "patch": "@@ -7,7 +7,7 @@ use std::{collections::VecDeque, fmt, fs, path::Path, process::Command};\n use anyhow::{format_err, Context, Result};\n use base_db::{CrateDisplayName, CrateGraph, CrateId, CrateName, Edition, Env, FileId, ProcMacro};\n use cargo_workspace::DepKind;\n-use cfg::{CfgAtom, CfgDiff, CfgOptions};\n+use cfg::{CfgDiff, CfgOptions};\n use paths::{AbsPath, AbsPathBuf};\n use proc_macro_api::ProcMacroClient;\n use rustc_hash::{FxHashMap, FxHashSet};\n@@ -22,6 +22,8 @@ use crate::{\n     Sysroot, TargetKind,\n };\n \n+pub type CfgOverrides = FxHashMap<String, CfgDiff>;\n+\n /// `PackageRoot` describes a package root folder.\n /// Which may be an external dependency, or a member of\n /// the current workspace.\n@@ -46,6 +48,7 @@ pub enum ProjectWorkspace {\n         /// FIXME: make this a per-crate map, as, eg, build.rs might have a\n         /// different target.\n         rustc_cfg: Vec<CfgFlag>,\n+        cfg_overrides: CfgOverrides,\n     },\n     /// Project workspace was manually specified using a `rust-project.json` file.\n     Json { project: ProjectJson, sysroot: Option<Sysroot>, rustc_cfg: Vec<CfgFlag> },\n@@ -67,7 +70,7 @@ impl fmt::Debug for ProjectWorkspace {\n     fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {\n         // Make sure this isn't too verbose.\n         match self {\n-            ProjectWorkspace::Cargo { cargo, sysroot, rustc, rustc_cfg } => f\n+            ProjectWorkspace::Cargo { cargo, sysroot, rustc, rustc_cfg, cfg_overrides } => f\n                 .debug_struct(\"Cargo\")\n                 .field(\"root\", &cargo.workspace_root().file_name())\n                 .field(\"n_packages\", &cargo.packages().len())\n@@ -77,6 +80,7 @@ impl fmt::Debug for ProjectWorkspace {\n                     &rustc.as_ref().map_or(0, |rc| rc.packages().len()),\n                 )\n                 .field(\"n_rustc_cfg\", &rustc_cfg.len())\n+                .field(\"n_cfg_overrides\", &cfg_overrides.len())\n                 .finish(),\n             ProjectWorkspace::Json { project, sysroot, rustc_cfg } => {\n                 let mut debug_struct = f.debug_struct(\"Json\");\n@@ -164,7 +168,9 @@ impl ProjectWorkspace {\n                 };\n \n                 let rustc_cfg = rustc_cfg::get(Some(&cargo_toml), config.target.as_deref());\n-                ProjectWorkspace::Cargo { cargo, sysroot, rustc, rustc_cfg }\n+\n+                let cfg_overrides = config.cfg_overrides();\n+                ProjectWorkspace::Cargo { cargo, sysroot, rustc, rustc_cfg, cfg_overrides }\n             }\n         };\n \n@@ -213,43 +219,45 @@ impl ProjectWorkspace {\n                     })\n                 }))\n                 .collect::<Vec<_>>(),\n-            ProjectWorkspace::Cargo { cargo, sysroot, rustc, rustc_cfg: _ } => cargo\n-                .packages()\n-                .map(|pkg| {\n-                    let is_member = cargo[pkg].is_member;\n-                    let pkg_root = cargo[pkg].root().to_path_buf();\n-\n-                    let mut include = vec![pkg_root.clone()];\n-                    include.extend(\n-                        build_data\n-                            .and_then(|it| it.get(cargo.workspace_root()))\n-                            .and_then(|map| map.get(&cargo[pkg].id))\n-                            .and_then(|it| it.out_dir.clone()),\n-                    );\n+            ProjectWorkspace::Cargo { cargo, sysroot, rustc, rustc_cfg: _, cfg_overrides: _ } => {\n+                cargo\n+                    .packages()\n+                    .map(|pkg| {\n+                        let is_member = cargo[pkg].is_member;\n+                        let pkg_root = cargo[pkg].root().to_path_buf();\n+\n+                        let mut include = vec![pkg_root.clone()];\n+                        include.extend(\n+                            build_data\n+                                .and_then(|it| it.get(cargo.workspace_root()))\n+                                .and_then(|map| map.get(&cargo[pkg].id))\n+                                .and_then(|it| it.out_dir.clone()),\n+                        );\n \n-                    let mut exclude = vec![pkg_root.join(\".git\")];\n-                    if is_member {\n-                        exclude.push(pkg_root.join(\"target\"));\n-                    } else {\n-                        exclude.push(pkg_root.join(\"tests\"));\n-                        exclude.push(pkg_root.join(\"examples\"));\n-                        exclude.push(pkg_root.join(\"benches\"));\n-                    }\n-                    PackageRoot { is_member, include, exclude }\n-                })\n-                .chain(sysroot.crates().map(|krate| PackageRoot {\n-                    is_member: false,\n-                    include: vec![sysroot[krate].root_dir().to_path_buf()],\n-                    exclude: Vec::new(),\n-                }))\n-                .chain(rustc.into_iter().flat_map(|rustc| {\n-                    rustc.packages().map(move |krate| PackageRoot {\n+                        let mut exclude = vec![pkg_root.join(\".git\")];\n+                        if is_member {\n+                            exclude.push(pkg_root.join(\"target\"));\n+                        } else {\n+                            exclude.push(pkg_root.join(\"tests\"));\n+                            exclude.push(pkg_root.join(\"examples\"));\n+                            exclude.push(pkg_root.join(\"benches\"));\n+                        }\n+                        PackageRoot { is_member, include, exclude }\n+                    })\n+                    .chain(sysroot.crates().map(|krate| PackageRoot {\n                         is_member: false,\n-                        include: vec![rustc[krate].root().to_path_buf()],\n+                        include: vec![sysroot[krate].root_dir().to_path_buf()],\n                         exclude: Vec::new(),\n-                    })\n-                }))\n-                .collect(),\n+                    }))\n+                    .chain(rustc.into_iter().flat_map(|rustc| {\n+                        rustc.packages().map(move |krate| PackageRoot {\n+                            is_member: false,\n+                            include: vec![rustc[krate].root().to_path_buf()],\n+                            exclude: Vec::new(),\n+                        })\n+                    }))\n+                    .collect()\n+            }\n             ProjectWorkspace::DetachedFiles { files, sysroot, .. } => files\n                 .into_iter()\n                 .map(|detached_file| PackageRoot {\n@@ -299,16 +307,22 @@ impl ProjectWorkspace {\n                 project,\n                 sysroot,\n             ),\n-            ProjectWorkspace::Cargo { cargo, sysroot, rustc, rustc_cfg } => cargo_to_crate_graph(\n-                rustc_cfg.clone(),\n-                &proc_macro_loader,\n-                load,\n-                cargo,\n-                build_data.and_then(|it| it.get(cargo.workspace_root())),\n-                sysroot,\n-                rustc,\n-                rustc.as_ref().zip(build_data).and_then(|(it, map)| map.get(it.workspace_root())),\n-            ),\n+            ProjectWorkspace::Cargo { cargo, sysroot, rustc, rustc_cfg, cfg_overrides } => {\n+                cargo_to_crate_graph(\n+                    rustc_cfg.clone(),\n+                    cfg_overrides,\n+                    &proc_macro_loader,\n+                    load,\n+                    cargo,\n+                    build_data.and_then(|it| it.get(cargo.workspace_root())),\n+                    sysroot,\n+                    rustc,\n+                    rustc\n+                        .as_ref()\n+                        .zip(build_data)\n+                        .and_then(|(it, map)| map.get(it.workspace_root())),\n+                )\n+            }\n             ProjectWorkspace::DetachedFiles { files, sysroot, rustc_cfg } => {\n                 detached_files_to_crate_graph(rustc_cfg.clone(), load, files, sysroot)\n             }\n@@ -398,6 +412,7 @@ fn project_json_to_crate_graph(\n \n fn cargo_to_crate_graph(\n     rustc_cfg: Vec<CfgFlag>,\n+    override_cfg: &CfgOverrides,\n     proc_macro_loader: &dyn Fn(&Path) -> Vec<ProcMacro>,\n     load: &mut dyn FnMut(&AbsPath) -> Option<FileId>,\n     cargo: &CargoWorkspace,\n@@ -427,15 +442,16 @@ fn cargo_to_crate_graph(\n     for pkg in cargo.packages() {\n         let mut cfg_options = &cfg_options;\n         let mut replaced_cfg_options;\n-        if cargo[pkg].name == \"core\" {\n-            // FIXME: in the specific case of libcore in rust-lang/rust (i.e. it is not coming from\n-            // a sysroot), there's a `#![cfg(not(test))]` at the top of it that makes its contents\n-            // get ignored by r-a. We should implement a more general solution for this\n+        if let Some(overrides) = override_cfg.get(&cargo[pkg].name) {\n+            // FIXME: this is sort of a hack to deal with #![cfg(not(test))] vanishing such as seen\n+            // in ed25519_dalek (#7243), and libcore (#9203) (although you only hit that one while\n+            // working on rust-lang/rust as that's the only time it appears outside sysroot).\n+            //\n+            // A more ideal solution might be to reanalyze crates based on where the cursor is and\n+            // figure out the set of cfgs that would have to apply to make it active.\n \n             replaced_cfg_options = cfg_options.clone();\n-            replaced_cfg_options.apply_diff(\n-                CfgDiff::new(Default::default(), vec![CfgAtom::Flag(\"test\".into())]).unwrap(),\n-            );\n+            replaced_cfg_options.apply_diff(overrides.clone());\n             cfg_options = &replaced_cfg_options;\n         };\n "}, {"sha": "7e0276c10e627f63b27d96845da24801d4045455", "filename": "crates/rust-analyzer/src/config.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/8b77e2692cd97552b1b8d66eb51cec69695b3a5b/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8b77e2692cd97552b1b8d66eb51cec69695b3a5b/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs?ref=8b77e2692cd97552b1b8d66eb51cec69695b3a5b", "patch": "@@ -55,6 +55,8 @@ config_data! {\n         cargo_autoreload: bool           = \"true\",\n         /// Activate all available features (`--all-features`).\n         cargo_allFeatures: bool          = \"false\",\n+        /// Unsets `#[cfg(test)]` for the specified crates.\n+        cargo_unsetTest: Vec<String>   = \"[\\\"core\\\"]\",\n         /// List of features to activate.\n         cargo_features: Vec<String>      = \"[]\",\n         /// Run build scripts (`build.rs`) for more precise code analysis.\n@@ -595,8 +597,10 @@ impl Config {\n             target: self.data.cargo_target.clone(),\n             rustc_source,\n             no_sysroot: self.data.cargo_noSysroot,\n+            unset_test_crates: self.data.cargo_unsetTest.clone(),\n         }\n     }\n+\n     pub fn rustfmt(&self) -> RustfmtConfig {\n         match &self.data.rustfmt_overrideCommand {\n             Some(args) if !args.is_empty() => {"}, {"sha": "58cb469740fe4415ea954fd52b1eaadc05464fe7", "filename": "docs/user/generated_config.adoc", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/8b77e2692cd97552b1b8d66eb51cec69695b3a5b/docs%2Fuser%2Fgenerated_config.adoc", "raw_url": "https://github.com/rust-lang/rust/raw/8b77e2692cd97552b1b8d66eb51cec69695b3a5b/docs%2Fuser%2Fgenerated_config.adoc", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/docs%2Fuser%2Fgenerated_config.adoc?ref=8b77e2692cd97552b1b8d66eb51cec69695b3a5b", "patch": "@@ -39,6 +39,11 @@ Automatically refresh project info via `cargo metadata` on\n --\n Activate all available features (`--all-features`).\n --\n+[[rust-analyzer.cargo.unsetTest]]rust-analyzer.cargo.unsetTest (default: `[\"core\"]`)::\n++\n+--\n+Unsets `#[cfg(test)]` for the specified crates.\n+--\n [[rust-analyzer.cargo.features]]rust-analyzer.cargo.features (default: `[]`)::\n +\n --"}, {"sha": "b20a39a956fe1563dab79e1cafbefc2a7851f9f3", "filename": "editors/code/package.json", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/8b77e2692cd97552b1b8d66eb51cec69695b3a5b/editors%2Fcode%2Fpackage.json", "raw_url": "https://github.com/rust-lang/rust/raw/8b77e2692cd97552b1b8d66eb51cec69695b3a5b/editors%2Fcode%2Fpackage.json", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fpackage.json?ref=8b77e2692cd97552b1b8d66eb51cec69695b3a5b", "patch": "@@ -452,6 +452,16 @@\n                     \"default\": false,\n                     \"type\": \"boolean\"\n                 },\n+                \"rust-analyzer.cargo.unsetTest\": {\n+                    \"markdownDescription\": \"Unsets `#[cfg(test)]` for the specified crates.\",\n+                    \"default\": [\n+                        \"core\"\n+                    ],\n+                    \"type\": \"array\",\n+                    \"items\": {\n+                        \"type\": \"string\"\n+                    }\n+                },\n                 \"rust-analyzer.cargo.features\": {\n                     \"markdownDescription\": \"List of features to activate.\",\n                     \"default\": [],"}]}