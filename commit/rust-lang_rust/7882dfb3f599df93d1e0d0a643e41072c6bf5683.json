{"sha": "7882dfb3f599df93d1e0d0a643e41072c6bf5683", "node_id": "MDY6Q29tbWl0NzI0NzEyOjc4ODJkZmIzZjU5OWRmOTNkMWUwZDBhNjQzZTQxMDcyYzZiZjU2ODM=", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2020-03-05T22:25:55Z"}, "committer": {"name": "Christian Poveda", "email": "git@christianpoveda.xyz", "date": "2020-03-06T13:21:53Z"}, "message": "fix env update, and expand test", "tree": {"sha": "f5ed8db0bab7ececb5161f72ed03f531a57acd8a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f5ed8db0bab7ececb5161f72ed03f531a57acd8a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7882dfb3f599df93d1e0d0a643e41072c6bf5683", "comment_count": 0, "verification": {"verified": false, "reason": "bad_email", "signature": "-----BEGIN PGP SIGNATURE-----\n\niHUEABYIAB0WIQRsB8A/3NrzTlMMjT0nUl7150IKUAUCXmJOcQAKCRAnUl7150IK\nUI6YAP0XKH1wwcgSC+zGkr/bUDzrIC9C6pCGNY+F5nmtXkiybwD/Yp+YSBRLj9pO\nD+nd0u7gYp0+VXcrLEF4GmJLe+TLdgA=\n=zzog\n-----END PGP SIGNATURE-----", "payload": "tree f5ed8db0bab7ececb5161f72ed03f531a57acd8a\nparent a28330febb07e46b5f5bc73356eb4b36b549c51e\nauthor Ralf Jung <post@ralfj.de> 1583447155 +0100\ncommitter Christian Poveda <git@christianpoveda.xyz> 1583500913 -0500\n\nfix env update, and expand test\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7882dfb3f599df93d1e0d0a643e41072c6bf5683", "html_url": "https://github.com/rust-lang/rust/commit/7882dfb3f599df93d1e0d0a643e41072c6bf5683", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7882dfb3f599df93d1e0d0a643e41072c6bf5683/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pvdrz", "id": 31802960, "node_id": "MDQ6VXNlcjMxODAyOTYw", "avatar_url": "https://avatars.githubusercontent.com/u/31802960?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pvdrz", "html_url": "https://github.com/pvdrz", "followers_url": "https://api.github.com/users/pvdrz/followers", "following_url": "https://api.github.com/users/pvdrz/following{/other_user}", "gists_url": "https://api.github.com/users/pvdrz/gists{/gist_id}", "starred_url": "https://api.github.com/users/pvdrz/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pvdrz/subscriptions", "organizations_url": "https://api.github.com/users/pvdrz/orgs", "repos_url": "https://api.github.com/users/pvdrz/repos", "events_url": "https://api.github.com/users/pvdrz/events{/privacy}", "received_events_url": "https://api.github.com/users/pvdrz/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a28330febb07e46b5f5bc73356eb4b36b549c51e", "url": "https://api.github.com/repos/rust-lang/rust/commits/a28330febb07e46b5f5bc73356eb4b36b549c51e", "html_url": "https://github.com/rust-lang/rust/commit/a28330febb07e46b5f5bc73356eb4b36b549c51e"}], "stats": {"total": 41, "additions": 35, "deletions": 6}, "files": [{"sha": "3469beb971d68f31dffd8d80a5bc3241b1cea4a1", "filename": "src/shims/env.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/7882dfb3f599df93d1e0d0a643e41072c6bf5683/src%2Fshims%2Fenv.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7882dfb3f599df93d1e0d0a643e41072c6bf5683/src%2Fshims%2Fenv.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fshims%2Fenv.rs?ref=7882dfb3f599df93d1e0d0a643e41072c6bf5683", "patch": "@@ -81,10 +81,10 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n         if let Some((name, value)) = new {\n             let var_ptr = alloc_env_var_as_c_str(&name, &value, &mut this);\n             if let Some(var) = this.machine.env_vars.map.insert(name.to_owned(), var_ptr) {\n-                this.update_environ()?;\n                 this.memory\n                     .deallocate(var, None, MiriMemoryKind::Machine.into())?;\n             }\n+            this.update_environ()?;\n             Ok(0)\n         } else {\n             Ok(-1)\n@@ -100,14 +100,14 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n             let name = this.read_os_str_from_c_str(name_ptr)?.to_owned();\n             if !name.is_empty() && !name.to_string_lossy().contains('=') {\n                 success = Some(this.machine.env_vars.map.remove(&name));\n-                this.update_environ()?;\n             }\n         }\n         if let Some(old) = success {\n             if let Some(var) = old {\n                 this.memory\n                     .deallocate(var, None, MiriMemoryKind::Machine.into())?;\n             }\n+            this.update_environ()?;\n             Ok(0)\n         } else {\n             Ok(-1)"}, {"sha": "c7506b23c1da06f51e159967d2f0dea78c48dc22", "filename": "tests/run-pass/env.rs", "status": "modified", "additions": 19, "deletions": 4, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/7882dfb3f599df93d1e0d0a643e41072c6bf5683/tests%2Frun-pass%2Fenv.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7882dfb3f599df93d1e0d0a643e41072c6bf5683/tests%2Frun-pass%2Fenv.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-pass%2Fenv.rs?ref=7882dfb3f599df93d1e0d0a643e41072c6bf5683", "patch": "@@ -3,11 +3,26 @@\n use std::env;\n \n fn main() {\n+    // Test that miri environment is isolated when communication is disabled.\n+    // (`MIRI_ENV_VAR_TEST` is set by the test harness.)\n+    assert_eq!(env::var(\"MIRI_ENV_VAR_TEST\"), Err(env::VarError::NotPresent));\n+\n+    // Test base state.\n+    println!(\"{:#?}\", env::vars().collect::<Vec<_>>());\n     assert_eq!(env::var(\"MIRI_TEST\"), Err(env::VarError::NotPresent));\n+\n+    // Set the variable.\n     env::set_var(\"MIRI_TEST\", \"the answer\");\n     assert_eq!(env::var(\"MIRI_TEST\"), Ok(\"the answer\".to_owned()));\n-    // Test that miri environment is isolated when communication is disabled.\n-    assert!(env::var(\"MIRI_ENV_VAR_TEST\").is_err());\n-    // Test that the new variable is in the `std::env::Vars` iterator\n-    assert!(env::vars().any(|(name, value)| name == \"MIRI_TEST\"))\n+    println!(\"{:#?}\", env::vars().collect::<Vec<_>>());\n+\n+    // Change the variable.\n+    env::set_var(\"MIRI_TEST\", \"42\");\n+    assert_eq!(env::var(\"MIRI_TEST\"), Ok(\"42\".to_owned()));\n+    println!(\"{:#?}\", env::vars().collect::<Vec<_>>());\n+\n+    // Remove the variable.\n+    env::remove_var(\"MIRI_TEST\");\n+    assert_eq!(env::var(\"MIRI_TEST\"), Err(env::VarError::NotPresent));\n+    println!(\"{:#?}\", env::vars().collect::<Vec<_>>());\n }"}, {"sha": "9a8f979598ebc0f3a3bee7fcb097b02a72acdcf9", "filename": "tests/run-pass/env.stdout", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/7882dfb3f599df93d1e0d0a643e41072c6bf5683/tests%2Frun-pass%2Fenv.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/7882dfb3f599df93d1e0d0a643e41072c6bf5683/tests%2Frun-pass%2Fenv.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-pass%2Fenv.stdout?ref=7882dfb3f599df93d1e0d0a643e41072c6bf5683", "patch": "@@ -0,0 +1,14 @@\n+[]\n+[\n+    (\n+        \"MIRI_TEST\",\n+        \"the answer\",\n+    ),\n+]\n+[\n+    (\n+        \"MIRI_TEST\",\n+        \"42\",\n+    ),\n+]\n+[]"}]}