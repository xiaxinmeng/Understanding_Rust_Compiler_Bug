{"sha": "2b8674b37ed533fba65b82da35a33c77775df278", "node_id": "MDY6Q29tbWl0NzI0NzEyOjJiODY3NGIzN2VkNTMzZmJhNjViODJkYTM1YTMzYzc3Nzc1ZGYyNzg=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-03-10T18:43:03Z"}, "committer": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-03-10T18:43:03Z"}, "message": "Implement builtin `cfg!` macro", "tree": {"sha": "8293508a0beaea93703d2a8f25ba7476ab3f9bb7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8293508a0beaea93703d2a8f25ba7476ab3f9bb7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2b8674b37ed533fba65b82da35a33c77775df278", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2b8674b37ed533fba65b82da35a33c77775df278", "html_url": "https://github.com/rust-lang/rust/commit/2b8674b37ed533fba65b82da35a33c77775df278", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2b8674b37ed533fba65b82da35a33c77775df278/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f0e78f2ed6bda5d48caabe35efbb09cb2f3ff5a4", "url": "https://api.github.com/repos/rust-lang/rust/commits/f0e78f2ed6bda5d48caabe35efbb09cb2f3ff5a4", "html_url": "https://github.com/rust-lang/rust/commit/f0e78f2ed6bda5d48caabe35efbb09cb2f3ff5a4"}], "stats": {"total": 22, "additions": 20, "deletions": 2}, "files": [{"sha": "8059a8809da37ee76e226ccc59236f8d92fcd681", "filename": "Cargo.lock", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/2b8674b37ed533fba65b82da35a33c77775df278/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/2b8674b37ed533fba65b82da35a33c77775df278/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=2b8674b37ed533fba65b82da35a33c77775df278", "patch": "@@ -524,6 +524,7 @@ name = \"hir_expand\"\n version = \"0.0.0\"\n dependencies = [\n  \"base_db\",\n+ \"cfg\",\n  \"either\",\n  \"la-arena\",\n  \"log\","}, {"sha": "7bb40ba9b665e6b4a31490502271f23be309105d", "filename": "crates/hir_expand/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/2b8674b37ed533fba65b82da35a33c77775df278/crates%2Fhir_expand%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/2b8674b37ed533fba65b82da35a33c77775df278/crates%2Fhir_expand%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_expand%2FCargo.toml?ref=2b8674b37ed533fba65b82da35a33c77775df278", "patch": "@@ -16,6 +16,7 @@ rustc-hash = \"1.0.0\"\n la-arena = { version = \"0.2.0\", path = \"../../lib/arena\" }\n \n base_db = { path = \"../base_db\", version = \"0.0.0\" }\n+cfg = { path = \"../cfg\", version = \"0.0.0\" }\n syntax = { path = \"../syntax\", version = \"0.0.0\" }\n parser = { path = \"../parser\", version = \"0.0.0\" }\n profile = { path = \"../profile\", version = \"0.0.0\" }"}, {"sha": "b34f1a4f2228f276ca5901d969d676e64b8a2ba7", "filename": "crates/hir_expand/src/builtin_macro.rs", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/2b8674b37ed533fba65b82da35a33c77775df278/crates%2Fhir_expand%2Fsrc%2Fbuiltin_macro.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2b8674b37ed533fba65b82da35a33c77775df278/crates%2Fhir_expand%2Fsrc%2Fbuiltin_macro.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_expand%2Fsrc%2Fbuiltin_macro.rs?ref=2b8674b37ed533fba65b82da35a33c77775df278", "patch": "@@ -5,6 +5,7 @@ use crate::{\n };\n \n use base_db::{AnchoredPath, FileId};\n+use cfg::CfgExpr;\n use either::Either;\n use mbe::{parse_exprs_with_sep, parse_to_token_tree, ExpandResult};\n use parser::FragmentKind;\n@@ -97,6 +98,7 @@ register_builtin! {\n     (format_args_nl, FormatArgsNl) => format_args_expand,\n     (llvm_asm, LlvmAsm) => asm_expand,\n     (asm, Asm) => asm_expand,\n+    (cfg, Cfg) => cfg_expand,\n \n     EAGER:\n     (compile_error, CompileError) => compile_error_expand,\n@@ -258,6 +260,18 @@ fn asm_expand(\n     ExpandResult::ok(expanded)\n }\n \n+fn cfg_expand(\n+    db: &dyn AstDatabase,\n+    id: LazyMacroId,\n+    tt: &tt::Subtree,\n+) -> ExpandResult<tt::Subtree> {\n+    let loc = db.lookup_intern_macro(id);\n+    let expr = CfgExpr::parse(tt);\n+    let enabled = db.crate_graph()[loc.krate].cfg_options.check(&expr) != Some(false);\n+    let expanded = if enabled { quote!(true) } else { quote!(false) };\n+    ExpandResult::ok(expanded)\n+}\n+\n fn unquote_str(lit: &tt::Literal) -> Option<String> {\n     let lit = ast::make::tokens::literal(&lit.to_string());\n     let token = ast::String::cast(lit)?;"}, {"sha": "e833e032c08582288d48e0194d17438becca16b0", "filename": "crates/hir_expand/src/name.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/2b8674b37ed533fba65b82da35a33c77775df278/crates%2Fhir_expand%2Fsrc%2Fname.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2b8674b37ed533fba65b82da35a33c77775df278/crates%2Fhir_expand%2Fsrc%2Fname.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_expand%2Fsrc%2Fname.rs?ref=2b8674b37ed533fba65b82da35a33c77775df278", "patch": "@@ -154,6 +154,7 @@ pub mod known {\n         macro_rules,\n         derive,\n         doc,\n+        cfg,\n         cfg_attr,\n         // Components of known path (value or mod name)\n         std,"}, {"sha": "08bc5aa49f2a902fc9fd966834663d9af7e0c519", "filename": "crates/hir_expand/src/quote.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/2b8674b37ed533fba65b82da35a33c77775df278/crates%2Fhir_expand%2Fsrc%2Fquote.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2b8674b37ed533fba65b82da35a33c77775df278/crates%2Fhir_expand%2Fsrc%2Fquote.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_expand%2Fsrc%2Fquote.rs?ref=2b8674b37ed533fba65b82da35a33c77775df278", "patch": "@@ -188,8 +188,9 @@ macro_rules! impl_to_to_tokentrees {\n \n impl_to_to_tokentrees! {\n     u32 => self { tt::Literal{text: self.to_string().into(), id: tt::TokenId::unspecified()} };\n-    usize => self { tt::Literal{text: self.to_string().into(), id: tt::TokenId::unspecified()}};\n-    i32 => self { tt::Literal{text: self.to_string().into(), id: tt::TokenId::unspecified()}};\n+    usize => self { tt::Literal{text: self.to_string().into(), id: tt::TokenId::unspecified()} };\n+    i32 => self { tt::Literal{text: self.to_string().into(), id: tt::TokenId::unspecified()} };\n+    bool => self { tt::Ident{text: self.to_string().into(), id: tt::TokenId::unspecified()} };\n     tt::Leaf => self { self };\n     tt::Literal => self { self };\n     tt::Ident => self { self };"}]}