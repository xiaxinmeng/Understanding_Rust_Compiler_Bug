{"sha": "ad734680af76d92f8e490141d72bf2a629e2d5f8", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFkNzM0NjgwYWY3NmQ5MmY4ZTQ5MDE0MWQ3MmJmMmE2MjllMmQ1Zjg=", "commit": {"author": {"name": "Paul Daniel Faria", "email": "Nashenas88@users.noreply.github.com", "date": "2019-10-04T04:55:28Z"}, "committer": {"name": "Paul Daniel Faria", "email": "Nashenas88@users.noreply.github.com", "date": "2019-12-02T13:30:30Z"}, "message": "Move predecessors cache invalidation back to basic_blocks_mut, add a couple more ensure_predecessors to prevent panics", "tree": {"sha": "bb191576da0a3f87defdcbf9c0754bcd6cb4ac31", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bb191576da0a3f87defdcbf9c0754bcd6cb4ac31"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ad734680af76d92f8e490141d72bf2a629e2d5f8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ad734680af76d92f8e490141d72bf2a629e2d5f8", "html_url": "https://github.com/rust-lang/rust/commit/ad734680af76d92f8e490141d72bf2a629e2d5f8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ad734680af76d92f8e490141d72bf2a629e2d5f8/comments", "author": {"login": "Nashenas88", "id": 1673130, "node_id": "MDQ6VXNlcjE2NzMxMzA=", "avatar_url": "https://avatars.githubusercontent.com/u/1673130?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Nashenas88", "html_url": "https://github.com/Nashenas88", "followers_url": "https://api.github.com/users/Nashenas88/followers", "following_url": "https://api.github.com/users/Nashenas88/following{/other_user}", "gists_url": "https://api.github.com/users/Nashenas88/gists{/gist_id}", "starred_url": "https://api.github.com/users/Nashenas88/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Nashenas88/subscriptions", "organizations_url": "https://api.github.com/users/Nashenas88/orgs", "repos_url": "https://api.github.com/users/Nashenas88/repos", "events_url": "https://api.github.com/users/Nashenas88/events{/privacy}", "received_events_url": "https://api.github.com/users/Nashenas88/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Nashenas88", "id": 1673130, "node_id": "MDQ6VXNlcjE2NzMxMzA=", "avatar_url": "https://avatars.githubusercontent.com/u/1673130?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Nashenas88", "html_url": "https://github.com/Nashenas88", "followers_url": "https://api.github.com/users/Nashenas88/followers", "following_url": "https://api.github.com/users/Nashenas88/following{/other_user}", "gists_url": "https://api.github.com/users/Nashenas88/gists{/gist_id}", "starred_url": "https://api.github.com/users/Nashenas88/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Nashenas88/subscriptions", "organizations_url": "https://api.github.com/users/Nashenas88/orgs", "repos_url": "https://api.github.com/users/Nashenas88/repos", "events_url": "https://api.github.com/users/Nashenas88/events{/privacy}", "received_events_url": "https://api.github.com/users/Nashenas88/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8e8c97e5fde0321da6e706d2f193cb3f395de1b6", "url": "https://api.github.com/repos/rust-lang/rust/commits/8e8c97e5fde0321da6e706d2f193cb3f395de1b6", "html_url": "https://github.com/rust-lang/rust/commit/8e8c97e5fde0321da6e706d2f193cb3f395de1b6"}], "stats": {"total": 227, "additions": 102, "deletions": 125}, "files": [{"sha": "a91017e880a3ba4701c2129e5f00694ff7ecfa98", "filename": "src/librustc/mir/mod.rs", "status": "modified", "additions": 3, "deletions": 28, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/ad734680af76d92f8e490141d72bf2a629e2d5f8/src%2Flibrustc%2Fmir%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad734680af76d92f8e490141d72bf2a629e2d5f8/src%2Flibrustc%2Fmir%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmir%2Fmod.rs?ref=ad734680af76d92f8e490141d72bf2a629e2d5f8", "patch": "@@ -203,23 +203,9 @@ impl<'tcx> Body<'tcx> {\n \n     #[inline]\n     pub fn basic_blocks_mut(&mut self) -> &mut IndexVec<BasicBlock, BasicBlockData<'tcx>> {\n-        &mut self.basic_blocks\n-    }\n-\n-    pub fn basic_block_terminator_opt_mut(\n-        &mut self, bb: BasicBlock\n-    ) -> &mut Option<Terminator<'tcx>> {\n-        // FIXME we should look into improving the cache invalidation\n-        debug!(\"Invalidating predecessors cache through opt terminator for block at : {:?}\", self.span.data());\n-        self.predecessors_cache = None;\n-        &mut self.basic_blocks[bb].terminator\n-    }\n-\n-    pub fn basic_block_terminator_mut(&mut self, bb: BasicBlock) -> &mut Terminator<'tcx> {\n-        // FIXME we should look into improving the cache invalidation\n-        debug!(\"Invalidating predecessors cache through terminator for block at : {:?}\", self.span.data());\n+        debug!(\"Clearing predecessors cache at: {:?}\", self.span.data());\n         self.predecessors_cache = None;\n-        self.basic_blocks[bb].terminator_mut()\n+        &mut self.basic_blocks\n     }\n \n     #[inline]\n@@ -1370,10 +1356,6 @@ impl<'tcx> BasicBlockData<'tcx> {\n         BasicBlockData { statements: vec![], terminator, is_cleanup: false }\n     }\n \n-    pub fn terminator_opt(&self) -> &Option<Terminator<'tcx>> {\n-        &self.terminator\n-    }\n-\n     /// Accessor for terminator.\n     ///\n     /// Terminator may not be None after construction of the basic block is complete. This accessor\n@@ -1382,17 +1364,10 @@ impl<'tcx> BasicBlockData<'tcx> {\n         self.terminator.as_ref().expect(\"invalid terminator state\")\n     }\n \n-    // This cannot be public since changing the terminator will break the predecessors cache in Body\n-    // To do so outside of this module, use Body::basic_block_terminator_mut(BasicBlock)\n-    fn terminator_mut(&mut self) -> &mut Terminator<'tcx> {\n+    pub fn terminator_mut(&mut self) -> &mut Terminator<'tcx> {\n         self.terminator.as_mut().expect(\"invalid terminator state\")\n     }\n \n-    // This can be public since changing the kind will not break the predecessors cache in Body\n-    pub fn terminator_kind_mut(&mut self) -> &mut TerminatorKind<'tcx> {\n-        &mut self.terminator_mut().kind\n-    }\n-\n     pub fn retain_statements<F>(&mut self, mut f: F)\n     where\n         F: FnMut(&mut Statement<'_>) -> bool,"}, {"sha": "f129dd3abeff7b1d6431fb82818b1a3aca0408ed", "filename": "src/librustc/mir/traversal.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/ad734680af76d92f8e490141d72bf2a629e2d5f8/src%2Flibrustc%2Fmir%2Ftraversal.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad734680af76d92f8e490141d72bf2a629e2d5f8/src%2Flibrustc%2Fmir%2Ftraversal.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmir%2Ftraversal.rs?ref=ad734680af76d92f8e490141d72bf2a629e2d5f8", "patch": "@@ -55,7 +55,7 @@ impl<'a, 'tcx> Iterator for Preorder<'a, 'tcx> {\n \n             let data = &self.body[idx];\n \n-            if let Some(ref term) = data.terminator_opt() {\n+            if let Some(ref term) = data.terminator {\n                 self.worklist.extend(term.successors());\n             }\n \n@@ -117,7 +117,7 @@ impl<'a, 'tcx> Postorder<'a, 'tcx> {\n \n         let data = &po.body[root];\n \n-        if let Some(ref term) = data.terminator_opt() {\n+        if let Some(ref term) = data.terminator {\n             po.visited.insert(root);\n             po.visit_stack.push((root, term.successors()));\n             po.traverse_successor();\n@@ -186,7 +186,7 @@ impl<'a, 'tcx> Postorder<'a, 'tcx> {\n             };\n \n             if self.visited.insert(bb) {\n-                if let Some(term) = &self.body[bb].terminator_opt() {\n+                if let Some(term) = &self.body[bb].terminator {\n                     self.visit_stack.push((bb, term.successors()));\n                 }\n             }"}, {"sha": "145593f1c4d4adc839b6cb96aac54b6420a25e57", "filename": "src/librustc/mir/visit.rs", "status": "modified", "additions": 11, "deletions": 24, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/ad734680af76d92f8e490141d72bf2a629e2d5f8/src%2Flibrustc%2Fmir%2Fvisit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad734680af76d92f8e490141d72bf2a629e2d5f8/src%2Flibrustc%2Fmir%2Fvisit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmir%2Fvisit.rs?ref=ad734680af76d92f8e490141d72bf2a629e2d5f8", "patch": "@@ -789,31 +789,18 @@ macro_rules! make_mir_visitor {\n             }\n \n             // Convenience methods\n-            make_mir_visitor!{@make_visit_location, $($mutability)?}\n-        }\n-    };\n-    (@make_visit_location, mut) => {\n-       fn visit_location(&mut self, body: &mut Body<'tcx>, location: Location) {\n-          if body[location.block].statements.len() == location.statement_index {\n-            if let Some(ref mut terminator) = body.basic_block_terminator_opt_mut(location.block) {\n-                self.visit_terminator(terminator, location)\n-            }\n-          } else {\n-            let statement = &mut body[location.block].statements[location.statement_index];\n-            self.visit_statement(statement, location)\n-          }\n-       }\n-    };\n-    (@make_visit_location, ) => {\n-        fn visit_location(&mut self, body: &Body<'tcx>, location: Location) {\n-            let basic_block = &body[location.block];\n-            if basic_block.statements.len() == location.statement_index {\n-                if let Some(ref terminator) = basic_block.terminator_opt() {\n-                    self.visit_terminator(terminator, location)\n+\n+            fn visit_location(&mut self, body: & $($mutability)? Body<'tcx>, location: Location) {\n+                let basic_block = & $($mutability)? body[location.block];\n+                if basic_block.statements.len() == location.statement_index {\n+                    if let Some(ref $($mutability)? terminator) = basic_block.terminator {\n+                        self.visit_terminator(terminator, location)\n+                    }\n+                } else {\n+                    let statement = & $($mutability)?\n+                        basic_block.statements[location.statement_index];\n+                    self.visit_statement(statement, location)\n                 }\n-            } else {\n-                let statement = &basic_block.statements[location.statement_index];\n-                self.visit_statement(statement, location)\n             }\n         }\n     }"}, {"sha": "6041232489d0d30dcf319a018ac13149741f0346", "filename": "src/librustc_codegen_ssa/mir/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ad734680af76d92f8e490141d72bf2a629e2d5f8/src%2Flibrustc_codegen_ssa%2Fmir%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad734680af76d92f8e490141d72bf2a629e2d5f8/src%2Flibrustc_codegen_ssa%2Fmir%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_ssa%2Fmir%2Fmod.rs?ref=ad734680af76d92f8e490141d72bf2a629e2d5f8", "patch": "@@ -265,7 +265,7 @@ fn create_funclets<'a, 'tcx, Bx: BuilderMethods<'a, 'tcx>>(\n \n         let funclet;\n         let ret_llbb;\n-        match mir[bb].terminator_opt().as_ref().map(|t| &t.kind) {\n+        match mir[bb].terminator.as_ref().map(|t| &t.kind) {\n             // This is a basic block that we're aborting the program for,\n             // notably in an `extern` function. These basic blocks are inserted\n             // so that we assert that `extern` functions do indeed not panic,"}, {"sha": "a555e0b74c2b780c440720980ef2bdb3afb83769", "filename": "src/librustc_mir/borrow_check/error_reporting.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ad734680af76d92f8e490141d72bf2a629e2d5f8/src%2Flibrustc_mir%2Fborrow_check%2Ferror_reporting.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad734680af76d92f8e490141d72bf2a629e2d5f8/src%2Flibrustc_mir%2Fborrow_check%2Ferror_reporting.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fborrow_check%2Ferror_reporting.rs?ref=ad734680af76d92f8e490141d72bf2a629e2d5f8", "patch": "@@ -497,7 +497,7 @@ impl<'cx, 'tcx> MirBorrowckCtxt<'cx, 'tcx> {\n                             ..\n                         },\n                         ..\n-                    }) = bbd.terminator_opt() {\n+                    }) = bbd.terminator {\n                         if let Some(source)\n                             = BorrowedContentSource::from_call(func.ty(self.body, tcx), tcx)\n                         {"}, {"sha": "63a8de5eebacd6b04fc225d9cb3ffbf23e8a6db1", "filename": "src/librustc_mir/borrow_check/mod.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/ad734680af76d92f8e490141d72bf2a629e2d5f8/src%2Flibrustc_mir%2Fborrow_check%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad734680af76d92f8e490141d72bf2a629e2d5f8/src%2Flibrustc_mir%2Fborrow_check%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fborrow_check%2Fmod.rs?ref=ad734680af76d92f8e490141d72bf2a629e2d5f8", "patch": "@@ -166,6 +166,11 @@ fn do_mir_borrowck<'a, 'tcx>(\n     let mut promoted: IndexVec<Promoted, Body<'tcx>> = input_promoted.clone();\n     let free_regions =\n         nll::replace_regions_in_mir(infcx, def_id, param_env, &mut body, &mut promoted);\n+\n+    // Region replacement above very likely invalidated the predecessors cache. It's used later on\n+    // when retrieving the dominators from the body, so we need to ensure it exists before locking\n+    // the body for changes.\n+    body.ensure_predecessors();\n     let body = &body; // no further changes\n     let location_table = &LocationTable::new(body);\n "}, {"sha": "3ed6b4ff346784c66e27a4fc17a664ece3acae91", "filename": "src/librustc_mir/build/cfg.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ad734680af76d92f8e490141d72bf2a629e2d5f8/src%2Flibrustc_mir%2Fbuild%2Fcfg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad734680af76d92f8e490141d72bf2a629e2d5f8/src%2Flibrustc_mir%2Fbuild%2Fcfg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fbuild%2Fcfg.rs?ref=ad734680af76d92f8e490141d72bf2a629e2d5f8", "patch": "@@ -64,7 +64,7 @@ impl<'tcx> CFG<'tcx> {\n                      source_info: SourceInfo,\n                      kind: TerminatorKind<'tcx>) {\n         debug!(\"terminating block {:?} <- {:?}\", block, kind);\n-        debug_assert!(self.block_data(block).terminator_opt().is_none(),\n+        debug_assert!(self.block_data(block).terminator.is_none(),\n                       \"terminate: block {:?}={:?} already has a terminator set\",\n                       block,\n                       self.block_data(block));"}, {"sha": "eb9b401f27208abc5352e5e7c1e749a01e5f2da2", "filename": "src/librustc_mir/build/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ad734680af76d92f8e490141d72bf2a629e2d5f8/src%2Flibrustc_mir%2Fbuild%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad734680af76d92f8e490141d72bf2a629e2d5f8/src%2Flibrustc_mir%2Fbuild%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fbuild%2Fmod.rs?ref=ad734680af76d92f8e490141d72bf2a629e2d5f8", "patch": "@@ -731,7 +731,7 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n \n     fn finish(self) -> Body<'tcx> {\n         for (index, block) in self.cfg.basic_blocks.iter().enumerate() {\n-            if block.terminator_opt().is_none() {\n+            if block.terminator.is_none() {\n                 span_bug!(self.fn_span, \"no terminator on block {:?}\", index);\n             }\n         }"}, {"sha": "158b730b9bd43735e0ce5f1ae22981e75d6bb7d8", "filename": "src/librustc_mir/lints.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ad734680af76d92f8e490141d72bf2a629e2d5f8/src%2Flibrustc_mir%2Flints.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad734680af76d92f8e490141d72bf2a629e2d5f8/src%2Flibrustc_mir%2Flints.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Flints.rs?ref=ad734680af76d92f8e490141d72bf2a629e2d5f8", "patch": "@@ -79,7 +79,7 @@ fn check_fn_for_unconditional_recursion(\n \n         let block = &basic_blocks[bb];\n \n-        if let Some(ref terminator) = block.terminator_opt() {\n+        if let Some(ref terminator) = block.terminator {\n             match terminator.kind {\n                 TerminatorKind::Call { ref func, .. } => {\n                     let func_ty = func.ty(body, tcx);"}, {"sha": "938d3f8ce97610356979c71e8f2df3557c500053", "filename": "src/librustc_mir/shim.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/ad734680af76d92f8e490141d72bf2a629e2d5f8/src%2Flibrustc_mir%2Fshim.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad734680af76d92f8e490141d72bf2a629e2d5f8/src%2Flibrustc_mir%2Fshim.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fshim.rs?ref=ad734680af76d92f8e490141d72bf2a629e2d5f8", "patch": "@@ -123,6 +123,15 @@ fn make_shim<'tcx>(tcx: TyCtxt<'tcx>, instance: ty::InstanceDef<'tcx>) -> &'tcx\n         &add_call_guards::CriticalCallEdges,\n     ]);\n \n+    // The `ensure_predecessors_cache::EnsurePredecessorsCache` MirPass wasn't used in the\n+    // `run_passes` above because the above pass is not always guaranteed to run. There can be\n+    // instances where, e.g. a `MirPhase::Validated` pass has already been run on a `Body` by the\n+    // time it arrived at this line, and so the above `run_passes` call will NOT run any of the\n+    // passes (They do not run if a same or later pass has already been executed on a `Body`).\n+    // Adding the ensure pass during the `run_passes` for `MirPhase::Validated` would not\n+    // help because the predecessors cache would be invalidated between that pass and this call.\n+    // Having the single ensure outside of the `run_passes` list here guarantees that anyone\n+    // using this `Body` could call `Body::unwrap_predecessors()` without worrying about a panic.\n     result.ensure_predecessors();\n \n     debug!(\"make_shim({:?}) = {:?}\", instance, result);"}, {"sha": "bf3df1ae2fd8484ab6fa6919427a61488b20f029", "filename": "src/librustc_mir/transform/add_call_guards.rs", "status": "modified", "additions": 4, "deletions": 5, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/ad734680af76d92f8e490141d72bf2a629e2d5f8/src%2Flibrustc_mir%2Ftransform%2Fadd_call_guards.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad734680af76d92f8e490141d72bf2a629e2d5f8/src%2Flibrustc_mir%2Ftransform%2Fadd_call_guards.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fadd_call_guards.rs?ref=ad734680af76d92f8e490141d72bf2a629e2d5f8", "patch": "@@ -46,9 +46,8 @@ impl AddCallGuards {\n \n         let cur_len = body.basic_blocks().len();\n \n-        for bb in body.basic_blocks().indices() {\n-            let is_cleanup = body.basic_blocks()[bb].is_cleanup;\n-            match body.basic_block_terminator_opt_mut(bb) {\n+        for block in body.basic_blocks_mut() {\n+            match block.terminator {\n                 Some(Terminator {\n                     kind: TerminatorKind::Call {\n                         destination: Some((_, ref mut destination)),\n@@ -61,9 +60,9 @@ impl AddCallGuards {\n                     // It's a critical edge, break it\n                     let call_guard = BasicBlockData {\n                         statements: vec![],\n-                        is_cleanup: is_cleanup,\n+                        is_cleanup: block.is_cleanup,\n                         terminator: Some(Terminator {\n-                            source_info: *source_info,\n+                            source_info,\n                             kind: TerminatorKind::Goto { target: *destination }\n                         })\n                     };"}, {"sha": "8c11d66fb48c7202b2be1f21947dc483ee1d4a5f", "filename": "src/librustc_mir/transform/generator.rs", "status": "modified", "additions": 10, "deletions": 6, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/ad734680af76d92f8e490141d72bf2a629e2d5f8/src%2Flibrustc_mir%2Ftransform%2Fgenerator.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad734680af76d92f8e490141d72bf2a629e2d5f8/src%2Flibrustc_mir%2Ftransform%2Fgenerator.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fgenerator.rs?ref=ad734680af76d92f8e490141d72bf2a629e2d5f8", "patch": "@@ -368,7 +368,7 @@ impl MutVisitor<'tcx> for TransformVisitor<'tcx> {\n                 VariantIdx::new(RETURNED) // state for returned\n             };\n             data.statements.push(self.set_discr(state, source_info));\n-            *data.terminator_kind_mut() = TerminatorKind::Return;\n+            data.terminator_mut().kind = TerminatorKind::Return;\n         }\n \n         self.super_basic_block_data(block, data);\n@@ -852,10 +852,10 @@ fn insert_switch<'tcx>(\n         is_cleanup: false,\n     });\n \n-    for bb in body.basic_blocks_mut().indices() {\n-        for target in body.basic_block_terminator_mut(bb).successors_mut() {\n-            *target = BasicBlock::new(target.index() + 1);\n-        }\n+    let blocks = body.basic_blocks_mut().iter_mut();\n+\n+    for target in blocks.flat_map(|b| b.terminator_mut().successors_mut()) {\n+        *target = BasicBlock::new(target.index() + 1);\n     }\n }\n \n@@ -941,7 +941,7 @@ fn create_generator_drop_shim<'tcx>(\n     insert_switch(&mut body, cases, &transform, TerminatorKind::Return);\n \n     for block in body.basic_blocks_mut() {\n-        let kind = block.terminator_kind_mut();\n+        let kind = &mut block.terminator_mut().kind;\n         if let TerminatorKind::GeneratorDrop = *kind {\n             *kind = TerminatorKind::Return;\n         }\n@@ -1203,6 +1203,10 @@ impl<'tcx> MirPass<'tcx> for StateTransform {\n         // RETURN_PLACE then is a fresh unused local with type ret_ty.\n         let new_ret_local = replace_result_variable(ret_ty, body, tcx);\n \n+        // Replacing result variables very likely clears the predecessors cache (needed inside of\n+        // compute layout), so we need to ensure the cache exists.\n+        body.ensure_predecessors();\n+\n         // Extract locals which are live across suspension point into `layout`\n         // `remap` gives a mapping from local indices onto generator struct indices\n         // `storage_liveness` tells us which locals have live storage at suspension points"}, {"sha": "1d45c1fe186969c4c32d6db0223a79abdf7da41a", "filename": "src/librustc_mir/transform/inline.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/ad734680af76d92f8e490141d72bf2a629e2d5f8/src%2Flibrustc_mir%2Ftransform%2Finline.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad734680af76d92f8e490141d72bf2a629e2d5f8/src%2Flibrustc_mir%2Ftransform%2Finline.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Finline.rs?ref=ad734680af76d92f8e490141d72bf2a629e2d5f8", "patch": "@@ -379,7 +379,7 @@ impl Inliner<'tcx> {\n                    callsite: CallSite<'tcx>,\n                    caller_body: &mut Body<'tcx>,\n                    mut callee_body: Body<'tcx>) -> bool {\n-        let terminator = caller_body.basic_block_terminator_opt_mut(callsite.bb).take().unwrap();\n+        let terminator = caller_body[callsite.bb].terminator.take().unwrap();\n         match terminator.kind {\n             // FIXME: Handle inlining of diverging calls\n             TerminatorKind::Call { args, destination: Some(destination), cleanup, .. } => {\n@@ -496,12 +496,12 @@ impl Inliner<'tcx> {\n                     kind: TerminatorKind::Goto { target: BasicBlock::new(bb_len) }\n                 };\n \n-                *caller_body.basic_block_terminator_opt_mut(callsite.bb) = Some(terminator);\n+                caller_body[callsite.bb].terminator= Some(terminator);\n \n                 true\n             }\n             kind => {\n-                *caller_body.basic_block_terminator_opt_mut(callsite.bb) = Some(Terminator {\n+                caller_body[callsite.bb].terminator = Some(Terminator {\n                     source_info: terminator.source_info,\n                     kind,\n                 });"}, {"sha": "591f3ca44009d4aa4bf004f3c1ba5d4f73b7f0d7", "filename": "src/librustc_mir/transform/promote_consts.rs", "status": "modified", "additions": 8, "deletions": 9, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/ad734680af76d92f8e490141d72bf2a629e2d5f8/src%2Flibrustc_mir%2Ftransform%2Fpromote_consts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad734680af76d92f8e490141d72bf2a629e2d5f8/src%2Flibrustc_mir%2Ftransform%2Fpromote_consts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fpromote_consts.rs?ref=ad734680af76d92f8e490141d72bf2a629e2d5f8", "patch": "@@ -866,7 +866,7 @@ impl<'a, 'tcx> Promoter<'a, 'tcx> {\n             let terminator = if self.keep_original {\n                 self.source[loc.block].terminator().clone()\n             } else {\n-                let terminator = self.source.basic_block_terminator_mut(loc.block);\n+                let terminator = self.source[loc.block].terminator_mut();\n                 let target = match terminator.kind {\n                     TerminatorKind::Call { destination: Some((_, target)), .. } => target,\n                     ref kind => {\n@@ -891,7 +891,7 @@ impl<'a, 'tcx> Promoter<'a, 'tcx> {\n                     let last = self.promoted.basic_blocks().last().unwrap();\n                     let new_target = self.new_block();\n \n-                    *self.promoted.basic_block_terminator_mut(last) = Terminator {\n+                    *self.promoted[last].terminator_mut() = Terminator {\n                         kind: TerminatorKind::Call {\n                             func,\n                             args,\n@@ -976,12 +976,11 @@ impl<'a, 'tcx> Promoter<'a, 'tcx> {\n                     }\n                 },\n                 Candidate::Argument { bb, index } => {\n-                    let data = &mut blocks[bb];\n-                    let terminator_span = data.terminator().source_info.span;\n-                    match data.terminator_kind_mut() {\n+                    let terminator = blocks[bb].terminator_mut();\n+                    match terminator.kind {\n                         TerminatorKind::Call { ref mut args, .. } => {\n                             let ty = args[index].ty(local_decls, self.tcx);\n-                            let span = terminator_span;\n+                            let span = terminator.source_info.span;\n                             let operand = Operand::Copy(promoted_place(ty, span));\n                             mem::replace(&mut args[index], operand)\n                         }\n@@ -1104,8 +1103,8 @@ pub fn promote_candidates<'tcx>(\n \n     // Eliminate assignments to, and drops of promoted temps.\n     let promoted = |index: Local| temps[index] == TempState::PromotedOut;\n-    for bb in body.basic_blocks().indices() {\n-        body.basic_blocks_mut()[bb].statements.retain(|statement| {\n+    for block in body.basic_blocks_mut() {\n+        block.statements.retain(|statement| {\n             match &statement.kind {\n                 StatementKind::Assign(box(place, _)) => {\n                     if let Some(index) = place.as_local() {\n@@ -1121,7 +1120,7 @@ pub fn promote_candidates<'tcx>(\n                 _ => true\n             }\n         });\n-        let terminator = body.basic_block_terminator_mut(bb);\n+        let terminator = block.terminator_mut();\n         match &terminator.kind {\n             TerminatorKind::Drop { location: place, target, .. } => {\n                 if let Some(index) = place.as_local() {"}, {"sha": "130393e2c4c865f359586ca96cf75f88374ce139", "filename": "src/librustc_mir/transform/remove_noop_landing_pads.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/ad734680af76d92f8e490141d72bf2a629e2d5f8/src%2Flibrustc_mir%2Ftransform%2Fremove_noop_landing_pads.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad734680af76d92f8e490141d72bf2a629e2d5f8/src%2Flibrustc_mir%2Ftransform%2Fremove_noop_landing_pads.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fremove_noop_landing_pads.rs?ref=ad734680af76d92f8e490141d72bf2a629e2d5f8", "patch": "@@ -103,15 +103,15 @@ impl RemoveNoopLandingPads {\n         let postorder: Vec<_> = traversal::postorder(body).map(|(bb, _)| bb).collect();\n         for bb in postorder {\n             debug!(\"  processing {:?}\", bb);\n-            for target in body.basic_block_terminator_mut(bb).successors_mut() {\n+            for target in body[bb].terminator_mut().successors_mut() {\n                 if *target != resume_block && nop_landing_pads.contains(*target) {\n                     debug!(\"    folding noop jump to {:?} to resume block\", target);\n                     *target = resume_block;\n                     jumps_folded += 1;\n                 }\n             }\n \n-            match body.basic_block_terminator_mut(bb).unwind_mut() {\n+            match body[bb].terminator_mut().unwind_mut() {\n                 Some(unwind) => {\n                     if *unwind == Some(resume_block) {\n                         debug!(\"    removing noop landing pad\");"}, {"sha": "2cd13daf31b4dda5cbb2b95cef411ab1cf55e3e6", "filename": "src/librustc_mir/transform/simplify.rs", "status": "modified", "additions": 36, "deletions": 37, "changes": 73, "blob_url": "https://github.com/rust-lang/rust/blob/ad734680af76d92f8e490141d72bf2a629e2d5f8/src%2Flibrustc_mir%2Ftransform%2Fsimplify.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad734680af76d92f8e490141d72bf2a629e2d5f8/src%2Flibrustc_mir%2Ftransform%2Fsimplify.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fsimplify.rs?ref=ad734680af76d92f8e490141d72bf2a629e2d5f8", "patch": "@@ -63,7 +63,7 @@ impl<'tcx> MirPass<'tcx> for SimplifyCfg {\n }\n \n pub struct CfgSimplifier<'a, 'tcx> {\n-    body: &'a mut Body<'tcx>,\n+    basic_blocks: &'a mut IndexVec<BasicBlock, BasicBlockData<'tcx>>,\n     pred_count: IndexVec<BasicBlock, u32>\n }\n \n@@ -76,23 +76,21 @@ impl<'a, 'tcx> CfgSimplifier<'a, 'tcx> {\n         pred_count[START_BLOCK] = 1;\n \n         for (_, data) in traversal::preorder(body) {\n-            if let Some(ref term) = data.terminator_opt() {\n+            if let Some(ref term) = data.terminator {\n                 for &tgt in term.successors() {\n                     pred_count[tgt] += 1;\n                 }\n             }\n         }\n \n+        let basic_blocks = body.basic_blocks_mut();\n+\n         CfgSimplifier {\n-            body,\n+            basic_blocks,\n             pred_count,\n         }\n     }\n \n-    fn basic_blocks(&mut self) -> &mut IndexVec<BasicBlock, BasicBlockData<'tcx>> {\n-        self.body.basic_blocks_mut()\n-    }\n-\n     pub fn simplify(mut self) {\n         self.strip_nops();\n \n@@ -103,14 +101,14 @@ impl<'a, 'tcx> CfgSimplifier<'a, 'tcx> {\n \n             self.collapse_goto_chain(&mut start, &mut changed);\n \n-            for bb in self.body.basic_blocks().indices() {\n+            for bb in self.basic_blocks.indices() {\n                 if self.pred_count[bb] == 0 {\n                     continue\n                 }\n \n                 debug!(\"simplifying {:?}\", bb);\n \n-                let mut terminator = self.body.basic_block_terminator_opt_mut(bb).take()\n+                let mut terminator = self.basic_blocks[bb].terminator.take()\n                     .expect(\"invalid terminator state\");\n \n                 for successor in terminator.successors_mut() {\n@@ -125,8 +123,12 @@ impl<'a, 'tcx> CfgSimplifier<'a, 'tcx> {\n                     inner_changed |= self.merge_successor(&mut new_stmts, &mut terminator);\n                     changed |= inner_changed;\n                 }\n-                self.basic_blocks()[bb].statements.extend(new_stmts);\n-                *self.body.basic_block_terminator_opt_mut(bb) = Some(terminator);\n+\n+                {\n+                    let data = &mut self.basic_blocks[bb];\n+                    data.statements.extend(new_stmts);\n+                    data.terminator = Some(terminator);\n+                }\n \n                 changed |= inner_changed;\n             }\n@@ -136,17 +138,17 @@ impl<'a, 'tcx> CfgSimplifier<'a, 'tcx> {\n \n         if start != START_BLOCK {\n             debug_assert!(self.pred_count[START_BLOCK] == 0);\n-            self.basic_blocks().swap(START_BLOCK, start);\n+            self.basic_blocks.swap(START_BLOCK, start);\n             self.pred_count.swap(START_BLOCK, start);\n \n             // pred_count == 1 if the start block has no predecessor _blocks_.\n             if self.pred_count[START_BLOCK] > 1 {\n-                for bb in self.basic_blocks().indices() {\n+                for (bb, data) in self.basic_blocks.iter_enumerated_mut() {\n                     if self.pred_count[bb] == 0 {\n                         continue;\n                     }\n \n-                    for target in self.body.basic_block_terminator_mut(bb).successors_mut() {\n+                    for target in data.terminator_mut().successors_mut() {\n                         if *target == start {\n                             *target = START_BLOCK;\n                         }\n@@ -158,7 +160,7 @@ impl<'a, 'tcx> CfgSimplifier<'a, 'tcx> {\n \n     // Collapse a goto chain starting from `start`\n     fn collapse_goto_chain(&mut self, start: &mut BasicBlock, changed: &mut bool) {\n-        let mut terminator = match self.basic_blocks()[*start] {\n+        let mut terminator = match self.basic_blocks[*start] {\n             BasicBlockData {\n                 ref statements,\n                 terminator: ref mut terminator @ Some(Terminator {\n@@ -177,7 +179,7 @@ impl<'a, 'tcx> CfgSimplifier<'a, 'tcx> {\n             }\n             _ => unreachable!()\n         };\n-        self.basic_blocks()[*start].terminator = terminator;\n+        self.basic_blocks[*start].terminator = terminator;\n \n         debug!(\"collapsing goto chain from {:?} to {:?}\", *start, target);\n \n@@ -209,15 +211,15 @@ impl<'a, 'tcx> CfgSimplifier<'a, 'tcx> {\n         };\n \n         debug!(\"merging block {:?} into {:?}\", target, terminator);\n-        *terminator = match self.body.basic_block_terminator_opt_mut(target).take() {\n+        *terminator = match self.basic_blocks[target].terminator.take() {\n             Some(terminator) => terminator,\n             None => {\n                 // unreachable loop - this should not be possible, as we\n                 // don't strand blocks, but handle it correctly.\n                 return false\n             }\n         };\n-        new_stmts.extend(self.basic_blocks()[target].statements.drain(..));\n+        new_stmts.extend(self.basic_blocks[target].statements.drain(..));\n         self.pred_count[target] = 0;\n \n         true\n@@ -250,7 +252,7 @@ impl<'a, 'tcx> CfgSimplifier<'a, 'tcx> {\n     }\n \n     fn strip_nops(&mut self) {\n-        for blk in self.basic_blocks().iter_mut() {\n+        for blk in self.basic_blocks.iter_mut() {\n             blk.statements.retain(|stmt| if let StatementKind::Nop = stmt.kind {\n                 false\n             } else {\n@@ -266,27 +268,24 @@ pub fn remove_dead_blocks(body: &mut Body<'_>) {\n         seen.insert(bb.index());\n     }\n \n-    let mut replacements: Vec<BasicBlock>;\n-    {\n-        let basic_blocks = body.basic_blocks_mut();\n-\n-        let num_blocks = basic_blocks.len();\n-        replacements = (0..num_blocks).map(BasicBlock::new).collect();\n-        let mut used_blocks = 0;\n-        for alive_index in seen.iter() {\n-            replacements[alive_index] = BasicBlock::new(used_blocks);\n-            if alive_index != used_blocks {\n-                // Swap the next alive block data with the current available slot. Since\n-                // alive_index is non-decreasing this is a valid operation.\n-                basic_blocks.raw.swap(alive_index, used_blocks);\n-            }\n-            used_blocks += 1;\n+    let basic_blocks = body.basic_blocks_mut();\n+\n+    let num_blocks = basic_blocks.len();\n+    let mut replacements : Vec<_> = (0..num_blocks).map(BasicBlock::new).collect();\n+    let mut used_blocks = 0;\n+    for alive_index in seen.iter() {\n+        replacements[alive_index] = BasicBlock::new(used_blocks);\n+        if alive_index != used_blocks {\n+            // Swap the next alive block data with the current available slot. Since\n+            // alive_index is non-decreasing this is a valid operation.\n+            basic_blocks.raw.swap(alive_index, used_blocks);\n         }\n-        basic_blocks.raw.truncate(used_blocks);\n+        used_blocks += 1;\n     }\n+    basic_blocks.raw.truncate(used_blocks);\n \n-    for bb in body.basic_blocks().indices() {\n-        for target in body.basic_block_terminator_mut(bb).successors_mut() {\n+    for block in basic_blocks {\n+        for target in block.terminator_mut().successors_mut() {\n             *target = replacements[target.index()];\n         }\n     }"}, {"sha": "0a509666d34aedb76ffd0711af52c4562db8fc8f", "filename": "src/librustc_mir/transform/simplify_branches.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/ad734680af76d92f8e490141d72bf2a629e2d5f8/src%2Flibrustc_mir%2Ftransform%2Fsimplify_branches.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad734680af76d92f8e490141d72bf2a629e2d5f8/src%2Flibrustc_mir%2Ftransform%2Fsimplify_branches.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fsimplify_branches.rs?ref=ad734680af76d92f8e490141d72bf2a629e2d5f8", "patch": "@@ -21,8 +21,8 @@ impl<'tcx> MirPass<'tcx> for SimplifyBranches {\n \n     fn run_pass(&self, tcx: TyCtxt<'tcx>, src: MirSource<'tcx>, body: &mut Body<'tcx>) {\n         let param_env = tcx.param_env(src.def_id());\n-        for bb in body.basic_blocks().indices() {\n-            let terminator = body.basic_block_terminator_mut(bb);\n+        for block in body.basic_blocks_mut() {\n+            let terminator = block.terminator_mut();\n             terminator.kind = match terminator.kind {\n                 TerminatorKind::SwitchInt {\n                     discr: Operand::Constant(ref c), switch_ty, ref values, ref targets, .."}, {"sha": "a5f7e5401573bd606ac6374e06397e21166954d0", "filename": "src/librustc_mir/util/patch.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ad734680af76d92f8e490141d72bf2a629e2d5f8/src%2Flibrustc_mir%2Futil%2Fpatch.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad734680af76d92f8e490141d72bf2a629e2d5f8/src%2Flibrustc_mir%2Futil%2Fpatch.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Futil%2Fpatch.rs?ref=ad734680af76d92f8e490141d72bf2a629e2d5f8", "patch": "@@ -141,7 +141,7 @@ impl<'tcx> MirPatch<'tcx> {\n         for (src, patch) in self.patch_map.into_iter_enumerated() {\n             if let Some(patch) = patch {\n                 debug!(\"MirPatch: patching block {:?}\", src);\n-                body.basic_block_terminator_mut(src).kind = patch;\n+                body[src].terminator_mut().kind = patch;\n             }\n         }\n "}]}