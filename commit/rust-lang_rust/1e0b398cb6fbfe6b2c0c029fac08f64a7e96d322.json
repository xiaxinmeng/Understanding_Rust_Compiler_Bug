{"sha": "1e0b398cb6fbfe6b2c0c029fac08f64a7e96d322", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFlMGIzOThjYjZmYmZlNmIyYzBjMDI5ZmFjMDhmNjRhN2U5NmQzMjI=", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2019-11-02T10:48:28Z"}, "committer": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2019-11-02T10:48:28Z"}, "message": "Windows cmdline: avoid accessing allocations directly", "tree": {"sha": "5e1292e4dfe4a65f4a356685724022ac06679f7a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5e1292e4dfe4a65f4a356685724022ac06679f7a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1e0b398cb6fbfe6b2c0c029fac08f64a7e96d322", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1e0b398cb6fbfe6b2c0c029fac08f64a7e96d322", "html_url": "https://github.com/rust-lang/rust/commit/1e0b398cb6fbfe6b2c0c029fac08f64a7e96d322", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1e0b398cb6fbfe6b2c0c029fac08f64a7e96d322/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d4e4fe71e6a9568f5d081d99f1c621c5a4ddd7db", "url": "https://api.github.com/repos/rust-lang/rust/commits/d4e4fe71e6a9568f5d081d99f1c621c5a4ddd7db", "html_url": "https://github.com/rust-lang/rust/commit/d4e4fe71e6a9568f5d081d99f1c621c5a4ddd7db"}], "stats": {"total": 36, "additions": 12, "deletions": 24}, "files": [{"sha": "2f998408b8ccb31461971e4e94e18b16cd2af4b1", "filename": "src/eval.rs", "status": "modified", "additions": 12, "deletions": 24, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/1e0b398cb6fbfe6b2c0c029fac08f64a7e96d322/src%2Feval.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1e0b398cb6fbfe6b2c0c029fac08f64a7e96d322/src%2Feval.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Feval.rs?ref=1e0b398cb6fbfe6b2c0c029fac08f64a7e96d322", "patch": "@@ -4,7 +4,7 @@ use rand::rngs::StdRng;\n use rand::SeedableRng;\n \n use rustc::hir::def_id::DefId;\n-use rustc::ty::layout::{Align, LayoutOf, Size};\n+use rustc::ty::layout::{LayoutOf, Size};\n use rustc::ty::{self, TyCtxt};\n use syntax::source_map::DUMMY_SP;\n \n@@ -48,7 +48,7 @@ pub fn create_ecx<'mir, 'tcx: 'mir>(\n     EnvVars::init(&mut ecx, config.excluded_env_vars);\n \n     // Setup first stack-frame\n-    let main_instance = ty::Instance::mono(ecx.tcx.tcx, main_id);\n+    let main_instance = ty::Instance::mono(tcx, main_id);\n     let main_mir = ecx.load_mir(main_instance.def, None)?;\n \n     if !main_mir.return_ty().is_unit() || main_mir.arg_count != 0 {\n@@ -59,11 +59,10 @@ pub fn create_ecx<'mir, 'tcx: 'mir>(\n     let main_ret_ty = tcx.fn_sig(main_id).output();\n     let main_ret_ty = main_ret_ty.no_bound_vars().unwrap();\n     let start_instance = ty::Instance::resolve(\n-        ecx.tcx.tcx,\n+        tcx,\n         ty::ParamEnv::reveal_all(),\n         start_id,\n-        ecx.tcx\n-            .mk_substs(::std::iter::once(ty::subst::GenericArg::from(main_ret_ty))),\n+        tcx.mk_substs(::std::iter::once(ty::subst::GenericArg::from(main_ret_ty))),\n     )\n     .unwrap();\n     let start_mir = ecx.load_mir(start_instance.def, None)?;\n@@ -134,8 +133,7 @@ pub fn create_ecx<'mir, 'tcx: 'mir>(\n     }\n     // Make an array with all these pointers, in the Miri memory.\n     let argvs_layout = ecx.layout_of(\n-        ecx.tcx\n-            .mk_array(ecx.tcx.mk_imm_ptr(ecx.tcx.types.u8), argvs.len() as u64),\n+        tcx.mk_array(tcx.mk_imm_ptr(tcx.types.u8), argvs.len() as u64),\n     )?;\n     let argvs_place = ecx.allocate(argvs_layout, MiriMemoryKind::Env.into());\n     for (idx, arg) in argvs.into_iter().enumerate() {\n@@ -156,31 +154,21 @@ pub fn create_ecx<'mir, 'tcx: 'mir>(\n     // Store command line as UTF-16 for Windows `GetCommandLineW`.\n     {\n         let cmd_utf16: Vec<u16> = cmd.encode_utf16().collect();\n-        let cmd_ptr = ecx.memory.allocate(\n-            Size::from_bytes(cmd_utf16.len() as u64 * 2),\n-            Align::from_bytes(2).unwrap(),\n-            MiriMemoryKind::Env.into(),\n-        );\n-        ecx.machine.cmd_line = Some(cmd_ptr);\n+        let cmd_type = tcx.mk_array(tcx.types.u16, cmd_utf16.len() as u64);\n+        let cmd_place = ecx.allocate(ecx.layout_of(cmd_type)?, MiriMemoryKind::Env.into());\n+        ecx.machine.cmd_line = Some(cmd_place.ptr.to_ptr()?);\n         // Store the UTF-16 string. We just allocated so we know the bounds are fine.\n         let char_size = Size::from_bytes(2);\n-        let cmd_alloc = ecx.memory.get_mut(cmd_ptr.alloc_id)?;\n-        let mut cur_ptr = cmd_ptr;\n-        for &c in cmd_utf16.iter() {\n-            cmd_alloc.write_scalar(\n-                &*ecx.tcx,\n-                cur_ptr,\n-                Scalar::from_uint(c, char_size).into(),\n-                char_size,\n-            )?;\n-            cur_ptr = cur_ptr.offset(char_size, &*ecx.tcx)?;\n+        for (idx, &c) in cmd_utf16.iter().enumerate() {\n+            let place = ecx.mplace_field(cmd_place, idx as u64)?;\n+            ecx.write_scalar(Scalar::from_uint(c, char_size), place.into())?;\n         }\n     }\n \n     args.next().expect_none(\"start lang item has more arguments than expected\");\n \n     // Set the last_error to 0\n-    let errno_layout = ecx.layout_of(ecx.tcx.types.u32)?;\n+    let errno_layout = ecx.layout_of(tcx.types.u32)?;\n     let errno_place = ecx.allocate(errno_layout, MiriMemoryKind::Static.into());\n     ecx.write_scalar(Scalar::from_u32(0), errno_place.into())?;\n     ecx.machine.last_error = Some(errno_place);"}]}