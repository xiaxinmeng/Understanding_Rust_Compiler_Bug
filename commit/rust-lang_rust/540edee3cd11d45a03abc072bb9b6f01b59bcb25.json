{"sha": "540edee3cd11d45a03abc072bb9b6f01b59bcb25", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU0MGVkZWUzY2QxMWQ0NWEwM2FiYzA3MmJiOWI2ZjAxYjU5YmNiMjU=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-01-14T15:27:20Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-01-14T15:27:20Z"}, "message": "Merge #7270\n\n7270: Introduce more appropriate assertion mechanism r=matklad a=matklad\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>", "tree": {"sha": "7d86fca4364984808724ccc5694aef20a43d686c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7d86fca4364984808724ccc5694aef20a43d686c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/540edee3cd11d45a03abc072bb9b6f01b59bcb25", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgAGLYCRBK7hj4Ov3rIwAAdHIIAAcfcTw5Xhjy243HYMv+v+j1\n3V37gHzZOkIkFS09VpfmpZSV7xwnnX5WNGJL+UachNvkahh9LoJoZWNCKc1UbsLq\nLsQVto4JE4IFSXmWQKm8bR/kUZnEIlQa+kspW1139bAQQ2LmQdiCtPnhcr3t2Rbp\nUB8H/IBZZWUYYc1qX6H3FzaQDE8ad6weHfBm1IJIe38mjCtKSfEhNMtV0WKqzUs2\nhMIVeB9ixCSWKOi4uxgUm6oSSwN2Hjwf1deiO25IBWkFk2KS/qrOJHqKaTNjsgVf\n8iY436OzDEBcEK89W9eFObjTKzGRcrrCU45UmS8obLp560ZMLpEhpIvoVeO0mLI=\n=xnMu\n-----END PGP SIGNATURE-----\n", "payload": "tree 7d86fca4364984808724ccc5694aef20a43d686c\nparent aeacaeed4e49dd71ba0de30a21d9f3d1cc153cec\nparent 8dc68ecdfcc764c7c0dcf5fcedcb51b092d99620\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1610638040 +0000\ncommitter GitHub <noreply@github.com> 1610638040 +0000\n\nMerge #7270\n\n7270: Introduce more appropriate assertion mechanism r=matklad a=matklad\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/540edee3cd11d45a03abc072bb9b6f01b59bcb25", "html_url": "https://github.com/rust-lang/rust/commit/540edee3cd11d45a03abc072bb9b6f01b59bcb25", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/540edee3cd11d45a03abc072bb9b6f01b59bcb25/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "aeacaeed4e49dd71ba0de30a21d9f3d1cc153cec", "url": "https://api.github.com/repos/rust-lang/rust/commits/aeacaeed4e49dd71ba0de30a21d9f3d1cc153cec", "html_url": "https://github.com/rust-lang/rust/commit/aeacaeed4e49dd71ba0de30a21d9f3d1cc153cec"}, {"sha": "8dc68ecdfcc764c7c0dcf5fcedcb51b092d99620", "url": "https://api.github.com/repos/rust-lang/rust/commits/8dc68ecdfcc764c7c0dcf5fcedcb51b092d99620", "html_url": "https://github.com/rust-lang/rust/commit/8dc68ecdfcc764c7c0dcf5fcedcb51b092d99620"}], "stats": {"total": 79, "additions": 72, "deletions": 7}, "files": [{"sha": "33df26761562d381c5dd2e7e01fd4bb6d9ee2716", "filename": "crates/completion/src/completions/qualified_path.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/540edee3cd11d45a03abc072bb9b6f01b59bcb25/crates%2Fcompletion%2Fsrc%2Fcompletions%2Fqualified_path.rs", "raw_url": "https://github.com/rust-lang/rust/raw/540edee3cd11d45a03abc072bb9b6f01b59bcb25/crates%2Fcompletion%2Fsrc%2Fcompletions%2Fqualified_path.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fcompletion%2Fsrc%2Fcompletions%2Fqualified_path.rs?ref=540edee3cd11d45a03abc072bb9b6f01b59bcb25", "patch": "@@ -590,8 +590,7 @@ fn main() { let _ = crate::$0 }\n         \"#,\n             expect![[r##\"\n                 fn main()  fn main()\n-                ma foo!(\u2026) #[macro_export]\n-                macro_rules! foo\n+                ma foo!(\u2026) #[macro_export] macro_rules! foo\n             \"##]],\n         );\n     }"}, {"sha": "53e1391f34e572a61be6852c68969ead635534f5", "filename": "crates/completion/src/completions/unqualified_path.rs", "status": "modified", "additions": 2, "deletions": 4, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/540edee3cd11d45a03abc072bb9b6f01b59bcb25/crates%2Fcompletion%2Fsrc%2Fcompletions%2Funqualified_path.rs", "raw_url": "https://github.com/rust-lang/rust/raw/540edee3cd11d45a03abc072bb9b6f01b59bcb25/crates%2Fcompletion%2Fsrc%2Fcompletions%2Funqualified_path.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fcompletion%2Fsrc%2Fcompletions%2Funqualified_path.rs?ref=540edee3cd11d45a03abc072bb9b6f01b59bcb25", "patch": "@@ -540,8 +540,7 @@ mod macros {\n \"#,\n             expect![[r##\"\n                 fn f()        fn f()\n-                ma concat!(\u2026) #[macro_export]\n-                macro_rules! concat\n+                ma concat!(\u2026) #[macro_export] macro_rules! concat\n                 md std\n             \"##]],\n         );\n@@ -597,8 +596,7 @@ fn main() { let v = $0 }\n \"#,\n             expect![[r##\"\n                 md m1\n-                ma baz!(\u2026) #[macro_export]\n-                macro_rules! baz\n+                ma baz!(\u2026) #[macro_export] macro_rules! baz\n                 fn main()  fn main()\n                 md m2\n                 ma bar!(\u2026) macro_rules! bar"}, {"sha": "0134ff219b6003a4e1fe1e535f6fd3626ce27f5f", "filename": "crates/completion/src/item.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/540edee3cd11d45a03abc072bb9b6f01b59bcb25/crates%2Fcompletion%2Fsrc%2Fitem.rs", "raw_url": "https://github.com/rust-lang/rust/raw/540edee3cd11d45a03abc072bb9b6f01b59bcb25/crates%2Fcompletion%2Fsrc%2Fitem.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fcompletion%2Fsrc%2Fitem.rs?ref=540edee3cd11d45a03abc072bb9b6f01b59bcb25", "patch": "@@ -7,6 +7,7 @@ use ide_db::helpers::{\n     insert_use::{self, ImportScope, MergeBehavior},\n     mod_path_to_ast, SnippetCap,\n };\n+use stdx::assert_never;\n use syntax::{algo, TextRange};\n use text_edit::TextEdit;\n \n@@ -396,6 +397,9 @@ impl Builder {\n     }\n     pub(crate) fn set_detail(mut self, detail: Option<impl Into<String>>) -> Builder {\n         self.detail = detail.map(Into::into);\n+        if let Some(detail) = &self.detail {\n+            assert_never!(detail.contains('\\n'), \"multiline detail: {}\", detail);\n+        }\n         self\n     }\n     #[allow(unused)]"}, {"sha": "bf42654a88cc1190452553b74d8df16dababd822", "filename": "crates/rust-analyzer/src/bin/main.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/540edee3cd11d45a03abc072bb9b6f01b59bcb25/crates%2Frust-analyzer%2Fsrc%2Fbin%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/540edee3cd11d45a03abc072bb9b6f01b59bcb25/crates%2Frust-analyzer%2Fsrc%2Fbin%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fbin%2Fmain.rs?ref=540edee3cd11d45a03abc072bb9b6f01b59bcb25", "patch": "@@ -70,6 +70,11 @@ fn setup_logging(log_file: Option<PathBuf>) -> Result<()> {\n     tracing_setup::setup_tracing()?;\n \n     profile::init();\n+\n+    if !cfg!(debug_assertions) {\n+        stdx::set_assert_hook(|loc, args| log::error!(\"assertion failed at {}: {}\", loc, args));\n+    }\n+\n     Ok(())\n }\n "}, {"sha": "1ff2559bbdaa20c50a4c50bd0c7ecffe10b869b6", "filename": "crates/stdx/src/lib.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/540edee3cd11d45a03abc072bb9b6f01b59bcb25/crates%2Fstdx%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/540edee3cd11d45a03abc072bb9b6f01b59bcb25/crates%2Fstdx%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fstdx%2Fsrc%2Flib.rs?ref=540edee3cd11d45a03abc072bb9b6f01b59bcb25", "patch": "@@ -4,6 +4,8 @@ use std::{cmp::Ordering, ops, process, time::Instant};\n mod macros;\n pub mod panic_context;\n \n+pub use crate::macros::{on_assert_failure, set_assert_hook};\n+\n #[inline(always)]\n pub fn is_ci() -> bool {\n     option_env!(\"CI\").is_some()"}, {"sha": "263b938e3f20ad56ab9c9a3a874dbd5a5467d609", "filename": "crates/stdx/src/macros.rs", "status": "modified", "additions": 52, "deletions": 0, "changes": 52, "blob_url": "https://github.com/rust-lang/rust/blob/540edee3cd11d45a03abc072bb9b6f01b59bcb25/crates%2Fstdx%2Fsrc%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/540edee3cd11d45a03abc072bb9b6f01b59bcb25/crates%2Fstdx%2Fsrc%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fstdx%2Fsrc%2Fmacros.rs?ref=540edee3cd11d45a03abc072bb9b6f01b59bcb25", "patch": "@@ -1,4 +1,9 @@\n //! Convenience macros.\n+\n+use std::{\n+    fmt, mem, panic,\n+    sync::atomic::{AtomicUsize, Ordering::SeqCst},\n+};\n #[macro_export]\n macro_rules! eprintln {\n     ($($tt:tt)*) => {{\n@@ -44,3 +49,50 @@ macro_rules! impl_from {\n         )*\n     }\n }\n+\n+/// A version of `assert!` macro which allows to handle an assertion failure.\n+///\n+/// In release mode, it returns the condition and logs an error.\n+///\n+/// ```\n+/// if assert_never!(impossible) {\n+///     // Heh, this shouldn't have happened, but lets try to soldier on...\n+///     return None;\n+/// }\n+/// ```\n+///\n+/// Rust analyzer is a long-running process, and crashing really isn't an option.\n+///\n+/// Shamelessly stolen from: https://www.sqlite.org/assert.html\n+#[macro_export]\n+macro_rules! assert_never {\n+    ($cond:expr) => { $crate::assert_always!($cond, \"\") };\n+    ($cond:expr, $($fmt:tt)*) => {{\n+        let value = $cond;\n+        if value {\n+            $crate::on_assert_failure(\n+                format_args!($($fmt)*)\n+            );\n+        }\n+        value\n+    }};\n+}\n+\n+type AssertHook = fn(&panic::Location<'_>, fmt::Arguments<'_>);\n+static HOOK: AtomicUsize = AtomicUsize::new(0);\n+\n+pub fn set_assert_hook(hook: AssertHook) {\n+    HOOK.store(hook as usize, SeqCst);\n+}\n+\n+#[cold]\n+#[track_caller]\n+pub fn on_assert_failure(args: fmt::Arguments) {\n+    let hook: usize = HOOK.load(SeqCst);\n+    if hook == 0 {\n+        panic!(\"\\n  assertion failed: {}\\n\", args);\n+    }\n+\n+    let hook: AssertHook = unsafe { mem::transmute::<usize, AssertHook>(hook) };\n+    hook(panic::Location::caller(), args)\n+}"}, {"sha": "cd956d950deb734a6541b2f46f77a059be41c29d", "filename": "crates/syntax/src/display.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/540edee3cd11d45a03abc072bb9b6f01b59bcb25/crates%2Fsyntax%2Fsrc%2Fdisplay.rs", "raw_url": "https://github.com/rust-lang/rust/raw/540edee3cd11d45a03abc072bb9b6f01b59bcb25/crates%2Fsyntax%2Fsrc%2Fdisplay.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fsyntax%2Fsrc%2Fdisplay.rs?ref=540edee3cd11d45a03abc072bb9b6f01b59bcb25", "patch": "@@ -80,7 +80,7 @@ pub fn macro_label(node: &ast::Macro) -> String {\n     let name = node.name().map(|name| name.syntax().text().to_string()).unwrap_or_default();\n     match node {\n         ast::Macro::MacroRules(node) => {\n-            let vis = if node.has_atom_attr(\"macro_export\") { \"#[macro_export]\\n\" } else { \"\" };\n+            let vis = if node.has_atom_attr(\"macro_export\") { \"#[macro_export] \" } else { \"\" };\n             format!(\"{}macro_rules! {}\", vis, name)\n         }\n         ast::Macro::MacroDef(node) => {"}, {"sha": "21330948ba5a38ca17834d7cbc994de18d73dee7", "filename": "docs/dev/style.md", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/540edee3cd11d45a03abc072bb9b6f01b59bcb25/docs%2Fdev%2Fstyle.md", "raw_url": "https://github.com/rust-lang/rust/raw/540edee3cd11d45a03abc072bb9b6f01b59bcb25/docs%2Fdev%2Fstyle.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/docs%2Fdev%2Fstyle.md?ref=540edee3cd11d45a03abc072bb9b6f01b59bcb25", "patch": "@@ -215,6 +215,11 @@ if idx >= len {\n \n **Rationale:** its useful to see the invariant relied upon by the rest of the function clearly spelled out.\n \n+## Assertions\n+\n+Assert liberally.\n+Prefer `stdx::assert_never!` to standard `assert!`.\n+\n ## Getters & Setters\n \n If a field can have any value without breaking invariants, make the field public."}]}