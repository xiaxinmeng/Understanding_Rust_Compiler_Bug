{"sha": "d2482fd36ac144b5dac106026b90d112d4707d79", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQyNDgyZmQzNmFjMTQ0YjVkYWMxMDYwMjZiOTBkMTEyZDQ3MDdkNzk=", "commit": {"author": {"name": "Felix S. Klock II", "email": "pnkfelix@pnkfx.org", "date": "2019-03-06T12:49:48Z"}, "committer": {"name": "Felix S. Klock II", "email": "pnkfelix@pnkfx.org", "date": "2019-03-06T12:49:48Z"}, "message": "Avoid ICE during `repr(packed)` well-formedness check via delay_span_bug.\n\n(It is possible that there is a more fundamental invariant being\nviolated, in terms of the `check_type_defn` code assuming that lifting\nto tcx will always succeed. But I am unaware of any test input that\nhits this that isn't already type-incorrect in some fashion.)", "tree": {"sha": "07c6b1c1629ee724760ff77938082d3cc07a7590", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/07c6b1c1629ee724760ff77938082d3cc07a7590"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d2482fd36ac144b5dac106026b90d112d4707d79", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d2482fd36ac144b5dac106026b90d112d4707d79", "html_url": "https://github.com/rust-lang/rust/commit/d2482fd36ac144b5dac106026b90d112d4707d79", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d2482fd36ac144b5dac106026b90d112d4707d79/comments", "author": {"login": "pnkfelix", "id": 173127, "node_id": "MDQ6VXNlcjE3MzEyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pnkfelix", "html_url": "https://github.com/pnkfelix", "followers_url": "https://api.github.com/users/pnkfelix/followers", "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}", "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}", "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions", "organizations_url": "https://api.github.com/users/pnkfelix/orgs", "repos_url": "https://api.github.com/users/pnkfelix/repos", "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}", "received_events_url": "https://api.github.com/users/pnkfelix/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pnkfelix", "id": 173127, "node_id": "MDQ6VXNlcjE3MzEyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pnkfelix", "html_url": "https://github.com/pnkfelix", "followers_url": "https://api.github.com/users/pnkfelix/followers", "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}", "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}", "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions", "organizations_url": "https://api.github.com/users/pnkfelix/orgs", "repos_url": "https://api.github.com/users/pnkfelix/repos", "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}", "received_events_url": "https://api.github.com/users/pnkfelix/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a9da8fc9c267c08cfdb8cf5b39da14f154d12939", "url": "https://api.github.com/repos/rust-lang/rust/commits/a9da8fc9c267c08cfdb8cf5b39da14f154d12939", "html_url": "https://github.com/rust-lang/rust/commit/a9da8fc9c267c08cfdb8cf5b39da14f154d12939"}], "stats": {"total": 11, "additions": 7, "deletions": 4}, "files": [{"sha": "e9ff8aa02967510cdcd3e2f5d2ecf6371a0f0b4a", "filename": "src/librustc_typeck/check/wfcheck.rs", "status": "modified", "additions": 7, "deletions": 4, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/d2482fd36ac144b5dac106026b90d112d4707d79/src%2Flibrustc_typeck%2Fcheck%2Fwfcheck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d2482fd36ac144b5dac106026b90d112d4707d79/src%2Flibrustc_typeck%2Fcheck%2Fwfcheck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fwfcheck.rs?ref=d2482fd36ac144b5dac106026b90d112d4707d79", "patch": "@@ -250,11 +250,14 @@ fn check_type_defn<'a, 'tcx, F>(tcx: TyCtxt<'a, 'tcx, 'tcx>,\n             let needs_drop_copy = || {\n                 packed && {\n                     let ty = variant.fields.last().unwrap().ty;\n-                    let ty = fcx.tcx.erase_regions(&ty).lift_to_tcx(fcx_tcx)\n+                    fcx.tcx.erase_regions(&ty).lift_to_tcx(fcx_tcx)\n+                        .map(|ty| ty.needs_drop(fcx_tcx, fcx_tcx.param_env(def_id)))\n                         .unwrap_or_else(|| {\n-                            span_bug!(item.span, \"inference variables in {:?}\", ty)\n-                        });\n-                    ty.needs_drop(fcx_tcx, fcx_tcx.param_env(def_id))\n+                            fcx_tcx.sess.delay_span_bug(\n+                                item.span, &format!(\"inference variables in {:?}\", ty));\n+                            // Just treat unresolved type expression as if it needs drop.\n+                            true\n+                        })\n                 }\n             };\n             let all_sized ="}]}