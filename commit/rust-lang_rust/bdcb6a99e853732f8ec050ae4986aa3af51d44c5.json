{"sha": "bdcb6a99e853732f8ec050ae4986aa3af51d44c5", "node_id": "C_kwDOAAsO6NoAKGJkY2I2YTk5ZTg1MzczMmY4ZWMwNTBhZTQ5ODZhYTNhZjUxZDQ0YzU", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-05-05T00:24:48Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-05-05T00:24:48Z"}, "message": "Auto merge of #96593 - jackh726:issue-93262, r=compiler-errors\n\nRevert \"Prefer projection candidates instead of param_env candidates for Sized predicates\"\n\nFixes #93262\nReopens #89352\n\nThis was a hack that seemed to have no negative side-effects at the time. Given that the latter has a workaround and likely less common than the former, it makes sense to revert this change.\n\nr? `@compiler-errors`", "tree": {"sha": "98442fbffdeb4ce5fe2b88dba21709d1565c733f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/98442fbffdeb4ce5fe2b88dba21709d1565c733f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bdcb6a99e853732f8ec050ae4986aa3af51d44c5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bdcb6a99e853732f8ec050ae4986aa3af51d44c5", "html_url": "https://github.com/rust-lang/rust/commit/bdcb6a99e853732f8ec050ae4986aa3af51d44c5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bdcb6a99e853732f8ec050ae4986aa3af51d44c5/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4c60a0ea5b2385d7400df9db1ad04e96f2a4c154", "url": "https://api.github.com/repos/rust-lang/rust/commits/4c60a0ea5b2385d7400df9db1ad04e96f2a4c154", "html_url": "https://github.com/rust-lang/rust/commit/4c60a0ea5b2385d7400df9db1ad04e96f2a4c154"}, {"sha": "8e31cdefc42682e495a22c6a08b95526aea8a94e", "url": "https://api.github.com/repos/rust-lang/rust/commits/8e31cdefc42682e495a22c6a08b95526aea8a94e", "html_url": "https://github.com/rust-lang/rust/commit/8e31cdefc42682e495a22c6a08b95526aea8a94e"}], "stats": {"total": 81, "additions": 64, "deletions": 17}, "files": [{"sha": "07720ba71ca95138c95eb9d32fcc7df4a63b05cf", "filename": "compiler/rustc_trait_selection/src/traits/select/candidate_assembly.rs", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/bdcb6a99e853732f8ec050ae4986aa3af51d44c5/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fcandidate_assembly.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bdcb6a99e853732f8ec050ae4986aa3af51d44c5/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fcandidate_assembly.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fcandidate_assembly.rs?ref=bdcb6a99e853732f8ec050ae4986aa3af51d44c5", "patch": "@@ -175,9 +175,6 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n \n         let needs_infer = stack.obligation.predicate.has_infer_types_or_consts();\n \n-        let sized_predicate = self.tcx().lang_items().sized_trait()\n-            == Some(stack.obligation.predicate.skip_binder().def_id());\n-\n         // If there are STILL multiple candidates, we can further\n         // reduce the list by dropping duplicates -- including\n         // resolving specializations.\n@@ -186,7 +183,6 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n             while i < candidates.len() {\n                 let is_dup = (0..candidates.len()).filter(|&j| i != j).any(|j| {\n                     self.candidate_should_be_dropped_in_favor_of(\n-                        sized_predicate,\n                         &candidates[i],\n                         &candidates[j],\n                         needs_infer,"}, {"sha": "9e2d0657029fd0d83c6c399b7cf3978ed5425bb3", "filename": "compiler/rustc_trait_selection/src/traits/select/mod.rs", "status": "modified", "additions": 8, "deletions": 12, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/bdcb6a99e853732f8ec050ae4986aa3af51d44c5/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bdcb6a99e853732f8ec050ae4986aa3af51d44c5/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fmod.rs?ref=bdcb6a99e853732f8ec050ae4986aa3af51d44c5", "patch": "@@ -1553,7 +1553,6 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n     /// See the comment for \"SelectionCandidate\" for more details.\n     fn candidate_should_be_dropped_in_favor_of(\n         &mut self,\n-        sized_predicate: bool,\n         victim: &EvaluatedCandidate<'tcx>,\n         other: &EvaluatedCandidate<'tcx>,\n         needs_infer: bool,\n@@ -1625,16 +1624,6 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n             // Drop otherwise equivalent non-const fn pointer candidates\n             (FnPointerCandidate { .. }, FnPointerCandidate { is_const: false }) => true,\n \n-            // If obligation is a sized predicate or the where-clause bound is\n-            // global, prefer the projection or object candidate. See issue\n-            // #50825 and #89352.\n-            (ObjectCandidate(_) | ProjectionCandidate(_), ParamCandidate(ref cand)) => {\n-                sized_predicate || is_global(cand)\n-            }\n-            (ParamCandidate(ref cand), ObjectCandidate(_) | ProjectionCandidate(_)) => {\n-                !(sized_predicate || is_global(cand))\n-            }\n-\n             // Global bounds from the where clause should be ignored\n             // here (see issue #50825). Otherwise, we have a where\n             // clause so don't go around looking for impls.\n@@ -1650,8 +1639,15 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n                 | BuiltinUnsizeCandidate\n                 | TraitUpcastingUnsizeCandidate(_)\n                 | BuiltinCandidate { .. }\n-                | TraitAliasCandidate(..),\n+                | TraitAliasCandidate(..)\n+                | ObjectCandidate(_)\n+                | ProjectionCandidate(_),\n             ) => !is_global(cand),\n+            (ObjectCandidate(_) | ProjectionCandidate(_), ParamCandidate(ref cand)) => {\n+                // Prefer these to a global where-clause bound\n+                // (see issue #50825).\n+                is_global(cand)\n+            }\n             (\n                 ImplCandidate(_)\n                 | ClosureCandidate"}, {"sha": "81125a7d6f320c117740bf621c83a091095e13c9", "filename": "src/test/ui/generic-associated-types/bugs/issue-89352.base.stderr", "status": "added", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/bdcb6a99e853732f8ec050ae4986aa3af51d44c5/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fbugs%2Fissue-89352.base.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/bdcb6a99e853732f8ec050ae4986aa3af51d44c5/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fbugs%2Fissue-89352.base.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fbugs%2Fissue-89352.base.stderr?ref=bdcb6a99e853732f8ec050ae4986aa3af51d44c5", "patch": "@@ -0,0 +1,22 @@\n+error[E0308]: mismatched types\n+  --> $DIR/issue-89352.rs:36:13\n+   |\n+LL |         let a = A::reborrow::<'ai, 's>(self.a.clone());\n+   |             ^ lifetime mismatch\n+   |\n+   = note: expected type `<<A as GenAssoc<T>>::Iter<'s> as Sized>`\n+              found type `<<A as GenAssoc<T>>::Iter<'ai> as Sized>`\n+note: the lifetime `'s` as defined here...\n+  --> $DIR/issue-89352.rs:35:13\n+   |\n+LL |     fn iter<'s>(&'s self) -> Self::Iter<'s> {\n+   |             ^^\n+note: ...does not necessarily outlive the lifetime `'ai` as defined here\n+  --> $DIR/issue-89352.rs:30:6\n+   |\n+LL | impl<'ai, T: 'ai, A: GenAssoc<T>> GenAssoc<T> for Wrapper<'ai, T, A>\n+   |      ^^^\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0308`."}, {"sha": "a9f0dd0a0b4ad5f2caac7996f4ad3bc6194442c1", "filename": "src/test/ui/generic-associated-types/bugs/issue-89352.rs", "status": "renamed", "additions": 13, "deletions": 1, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/bdcb6a99e853732f8ec050ae4986aa3af51d44c5/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fbugs%2Fissue-89352.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bdcb6a99e853732f8ec050ae4986aa3af51d44c5/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fbugs%2Fissue-89352.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fbugs%2Fissue-89352.rs?ref=bdcb6a99e853732f8ec050ae4986aa3af51d44c5", "patch": "@@ -1,4 +1,16 @@\n-// check-pass\n+// revisions: base nll\n+// ignore-compare-mode-nll\n+//[nll] compile-flags: -Z borrowck=mir\n+\n+//[base] check-fail\n+//[nll] check-pass\n+// known-bug\n+\n+// This should pass, but we end up with `A::Iter<'ai>: Sized` for some specific\n+// `'ai`. We also know that `for<'at> A::Iter<'at>: Sized` from the definition,\n+// but we prefer param env candidates. We changed this to preference in #92191,\n+// but this led to unintended consequences (#93262). Suprisingly, this passes\n+// under NLL. So only a bug in migrate mode.\n \n #![feature(generic_associated_types)]\n ", "previous_filename": "src/test/ui/generic-associated-types/issue-89352.rs"}, {"sha": "adc6aa8fa1afa2d6bb199fa3c52566d72446c281", "filename": "src/test/ui/generic-associated-types/issue-93262.rs", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/bdcb6a99e853732f8ec050ae4986aa3af51d44c5/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fissue-93262.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bdcb6a99e853732f8ec050ae4986aa3af51d44c5/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fissue-93262.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fgeneric-associated-types%2Fissue-93262.rs?ref=bdcb6a99e853732f8ec050ae4986aa3af51d44c5", "patch": "@@ -0,0 +1,21 @@\n+// check-pass\n+\n+#![feature(generic_associated_types)]\n+\n+pub trait Trait {\n+    type Assoc<'a> where Self: 'a;\n+}\n+\n+pub trait Foo<T: Trait>\n+where\n+    for<'a> T::Assoc<'a>: Clone\n+{}\n+\n+pub struct Type;\n+\n+impl<T: Trait> Foo<T> for Type\n+where\n+    for<'a> T::Assoc<'a>: Clone\n+{}\n+\n+fn main() {}"}]}