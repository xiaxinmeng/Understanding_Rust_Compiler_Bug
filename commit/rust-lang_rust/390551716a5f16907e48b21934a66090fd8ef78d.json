{"sha": "390551716a5f16907e48b21934a66090fd8ef78d", "node_id": "C_kwDOAAsO6NoAKDM5MDU1MTcxNmE1ZjE2OTA3ZTQ4YjIxOTM0YTY2MDkwZmQ4ZWY3OGQ", "commit": {"author": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2023-02-25T19:53:09Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-02-25T19:53:09Z"}, "message": "Rollup merge of #107848 - clubby789:x-setup-options, r=Mark-Simulacrum\n\nSplit `x setup` sub-actions to CLI arguments\n\nCloses #107846\n\nThis adds a new `none` profile option which simply skips the `config.toml` step. It also adds `hook` and `vscode` subcommands, for installing the pre-push hook and getting `settings.json` respectively.", "tree": {"sha": "ba9444079de3b3583a76259ea0dec535fba85a1b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ba9444079de3b3583a76259ea0dec535fba85a1b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/390551716a5f16907e48b21934a66090fd8ef78d", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJj+mclCRBK7hj4Ov3rIwAAsr8IAI3kKko4G3hEaqREFav/cySb\nmyTVX6sHxNa012RMsfXJD3f8WDvO75DJnzTNiABdyDhse9WcVnhwUwM93ecMyMcY\n42wG4R+ZFwRrHPTmaEmWmIn2pIzu5cr9OB7AqhRyDdyKF7E3FYPeYaKo6I/p2xBO\n2wMXHA7lfAeHv1Q8CEeN9GHrtjxSunaI9HDPGKH5Dwmh0EssHcAP4ap0eIuDYFaR\nhU2fXCgPeQI+U4kOXO3Opxn3Uh73I94sYqPCLtT0R+CtVS6lyoQq/rZnAnxiMCRU\nxR0Z2Rlxrb9f+H6lyLZVw7kVOWLlvTJ0NUTwRMA/uYrOccl/rn1JkFlCbugbYTE=\n=NhZ2\n-----END PGP SIGNATURE-----\n", "payload": "tree ba9444079de3b3583a76259ea0dec535fba85a1b\nparent 1a599d7d97c7ab4b03a75f1405bb19293ea2ca6a\nparent ee5404c69ecd5ea1500bd14b854a2b08d1196d21\nauthor Michael Goulet <michael@errs.io> 1677354789 -0800\ncommitter GitHub <noreply@github.com> 1677354789 -0800\n\nRollup merge of #107848 - clubby789:x-setup-options, r=Mark-Simulacrum\n\nSplit `x setup` sub-actions to CLI arguments\n\nCloses #107846\n\nThis adds a new `none` profile option which simply skips the `config.toml` step. It also adds `hook` and `vscode` subcommands, for installing the pre-push hook and getting `settings.json` respectively.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/390551716a5f16907e48b21934a66090fd8ef78d", "html_url": "https://github.com/rust-lang/rust/commit/390551716a5f16907e48b21934a66090fd8ef78d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/390551716a5f16907e48b21934a66090fd8ef78d/comments", "author": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1a599d7d97c7ab4b03a75f1405bb19293ea2ca6a", "url": "https://api.github.com/repos/rust-lang/rust/commits/1a599d7d97c7ab4b03a75f1405bb19293ea2ca6a", "html_url": "https://github.com/rust-lang/rust/commit/1a599d7d97c7ab4b03a75f1405bb19293ea2ca6a"}, {"sha": "ee5404c69ecd5ea1500bd14b854a2b08d1196d21", "url": "https://api.github.com/repos/rust-lang/rust/commits/ee5404c69ecd5ea1500bd14b854a2b08d1196d21", "html_url": "https://github.com/rust-lang/rust/commit/ee5404c69ecd5ea1500bd14b854a2b08d1196d21"}], "stats": {"total": 135, "additions": 114, "deletions": 21}, "files": [{"sha": "b33fc02f49c247068b87f30ad95461e5661eacf9", "filename": "src/bootstrap/builder.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/390551716a5f16907e48b21934a66090fd8ef78d/src%2Fbootstrap%2Fbuilder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/390551716a5f16907e48b21934a66090fd8ef78d/src%2Fbootstrap%2Fbuilder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuilder.rs?ref=390551716a5f16907e48b21934a66090fd8ef78d", "patch": "@@ -792,7 +792,7 @@ impl<'a> Builder<'a> {\n                 run::CollectLicenseMetadata,\n                 run::GenerateCopyright,\n             ),\n-            Kind::Setup => describe!(setup::Profile),\n+            Kind::Setup => describe!(setup::Profile, setup::Hook, setup::Link, setup::Vscode),\n             Kind::Clean => describe!(clean::CleanAll, clean::Rustc, clean::Std),\n             // special-cased in Build::build()\n             Kind::Format => vec![],"}, {"sha": "9d1504c34e81799a8aced1e1d8aaf89820eef906", "filename": "src/bootstrap/flags.rs", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/390551716a5f16907e48b21934a66090fd8ef78d/src%2Fbootstrap%2Fflags.rs", "raw_url": "https://github.com/rust-lang/rust/raw/390551716a5f16907e48b21934a66090fd8ef78d/src%2Fbootstrap%2Fflags.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fflags.rs?ref=390551716a5f16907e48b21934a66090fd8ef78d", "patch": "@@ -554,7 +554,8 @@ Arguments:\n             Kind::Setup => {\n                 subcommand_help.push_str(&format!(\n                     \"\\n\n-x.py setup creates a `config.toml` which changes the defaults for x.py itself.\n+x.py setup creates a `config.toml` which changes the defaults for x.py itself,\n+as well as setting up a git pre-push hook, VS code config and toolchain link.\n \n Arguments:\n     This subcommand accepts a 'profile' to use for builds. For example:\n@@ -564,7 +565,13 @@ Arguments:\n     The profile is optional and you will be prompted interactively if it is not given.\n     The following profiles are available:\n \n-{}\",\n+{}\n+\n+    To only set up the git hook, VS code or toolchain link, you may use\n+        ./x.py setup hook\n+        ./x.py setup vscode\n+        ./x.py setup link\n+\",\n                     Profile::all_for_help(\"        \").trim_end()\n                 ));\n             }\n@@ -638,7 +645,7 @@ Arguments:\n             }\n             Kind::Setup => {\n                 let profile = if paths.len() > 1 {\n-                    eprintln!(\"\\nerror: At most one profile can be passed to setup\\n\");\n+                    eprintln!(\"\\nerror: At most one option can be passed to setup\\n\");\n                     usage(1, &opts, verbose, &subcommand_help)\n                 } else if let Some(path) = paths.pop() {\n                     let profile_string = t!(path.into_os_string().into_string().map_err("}, {"sha": "4480bce99d799075b3de7fd176fa0be1c282365e", "filename": "src/bootstrap/setup.rs", "status": "modified", "additions": 103, "deletions": 17, "changes": 120, "blob_url": "https://github.com/rust-lang/rust/blob/390551716a5f16907e48b21934a66090fd8ef78d/src%2Fbootstrap%2Fsetup.rs", "raw_url": "https://github.com/rust-lang/rust/raw/390551716a5f16907e48b21934a66090fd8ef78d/src%2Fbootstrap%2Fsetup.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fsetup.rs?ref=390551716a5f16907e48b21934a66090fd8ef78d", "patch": "@@ -21,6 +21,7 @@ pub enum Profile {\n     Library,\n     Tools,\n     User,\n+    None,\n }\n \n /// A list of historical hashes of `src/etc/vscode_settings.json`.\n@@ -41,7 +42,7 @@ impl Profile {\n     pub fn all() -> impl Iterator<Item = Self> {\n         use Profile::*;\n         // N.B. these are ordered by how they are displayed, not alphabetically\n-        [Library, Compiler, Codegen, Tools, User].iter().copied()\n+        [Library, Compiler, Codegen, Tools, User, None].iter().copied()\n     }\n \n     pub fn purpose(&self) -> String {\n@@ -52,6 +53,7 @@ impl Profile {\n             Codegen => \"Contribute to the compiler, and also modify LLVM or codegen\",\n             Tools => \"Contribute to tools which depend on the compiler, but do not modify it directly (e.g. rustdoc, clippy, miri)\",\n             User => \"Install Rust from source\",\n+            None => \"Do not modify `config.toml`\"\n         }\n         .to_string()\n     }\n@@ -71,6 +73,7 @@ impl Profile {\n             Profile::Library => \"library\",\n             Profile::Tools => \"tools\",\n             Profile::User => \"user\",\n+            Profile::None => \"none\",\n         }\n     }\n }\n@@ -87,6 +90,7 @@ impl FromStr for Profile {\n             \"tools\" | \"tool\" | \"rustdoc\" | \"clippy\" | \"miri\" | \"rustfmt\" | \"rls\" => {\n                 Ok(Profile::Tools)\n             }\n+            \"none\" => Ok(Profile::None),\n             _ => Err(format!(\"unknown profile: '{}'\", s)),\n         }\n     }\n@@ -144,17 +148,8 @@ impl Step for Profile {\n }\n \n pub fn setup(config: &Config, profile: Profile) {\n-    let stage_path =\n-        [\"build\", config.build.rustc_target_arg(), \"stage1\"].join(&MAIN_SEPARATOR.to_string());\n-\n-    if !rustup_installed() && profile != Profile::User {\n-        eprintln!(\"`rustup` is not installed; cannot link `stage1` toolchain\");\n-    } else if stage_dir_exists(&stage_path[..]) && !config.dry_run() {\n-        attempt_toolchain_link(&stage_path[..]);\n-    }\n-\n-    let suggestions = match profile {\n-        Profile::Codegen | Profile::Compiler => &[\"check\", \"build\", \"test\"][..],\n+    let suggestions: &[&str] = match profile {\n+        Profile::Codegen | Profile::Compiler | Profile::None => &[\"check\", \"build\", \"test\"],\n         Profile::Tools => &[\n             \"check\",\n             \"build\",\n@@ -167,11 +162,6 @@ pub fn setup(config: &Config, profile: Profile) {\n         Profile::User => &[\"dist\", \"build\"],\n     };\n \n-    if !config.dry_run() {\n-        t!(install_git_hook_maybe(&config));\n-        t!(create_vscode_settings_maybe(&config));\n-    }\n-\n     println!();\n \n     println!(\"To get started, try one of the following commands:\");\n@@ -190,6 +180,9 @@ pub fn setup(config: &Config, profile: Profile) {\n }\n \n fn setup_config_toml(path: &PathBuf, profile: Profile, config: &Config) {\n+    if profile == Profile::None {\n+        return;\n+    }\n     if path.exists() {\n         eprintln!();\n         eprintln!(\n@@ -217,6 +210,41 @@ fn setup_config_toml(path: &PathBuf, profile: Profile, config: &Config) {\n     println!(\"`x.py` will now use the configuration at {}\", include_path.display());\n }\n \n+/// Creates a toolchain link for stage1 using `rustup`\n+#[derive(Clone, Copy, Debug, Eq, PartialEq, Hash)]\n+pub struct Link;\n+impl Step for Link {\n+    type Output = ();\n+    const DEFAULT: bool = true;\n+    fn should_run(run: ShouldRun<'_>) -> ShouldRun<'_> {\n+        run.alias(\"link\")\n+    }\n+    fn make_run(run: RunConfig<'_>) {\n+        if run.builder.config.dry_run() {\n+            return;\n+        }\n+        if let [cmd] = &run.paths[..] {\n+            if cmd.assert_single_path().path.as_path().as_os_str() == \"link\" {\n+                run.builder.ensure(Link);\n+            }\n+        }\n+    }\n+    fn run(self, builder: &Builder<'_>) -> Self::Output {\n+        let config = &builder.config;\n+        if config.dry_run() {\n+            return;\n+        }\n+        let stage_path =\n+            [\"build\", config.build.rustc_target_arg(), \"stage1\"].join(&MAIN_SEPARATOR.to_string());\n+\n+        if !rustup_installed() {\n+            eprintln!(\"`rustup` is not installed; cannot link `stage1` toolchain\");\n+        } else if stage_dir_exists(&stage_path[..]) && !config.dry_run() {\n+            attempt_toolchain_link(&stage_path[..]);\n+        }\n+    }\n+}\n+\n fn rustup_installed() -> bool {\n     Command::new(\"rustup\")\n         .arg(\"--version\")\n@@ -394,6 +422,35 @@ fn prompt_user(prompt: &str) -> io::Result<Option<PromptResult>> {\n     }\n }\n \n+/// Installs `src/etc/pre-push.sh` as a Git hook\n+#[derive(Clone, Copy, Debug, Eq, PartialEq, Hash)]\n+pub struct Hook;\n+\n+impl Step for Hook {\n+    type Output = ();\n+    const DEFAULT: bool = true;\n+    fn should_run(run: ShouldRun<'_>) -> ShouldRun<'_> {\n+        run.alias(\"hook\")\n+    }\n+    fn make_run(run: RunConfig<'_>) {\n+        if run.builder.config.dry_run() {\n+            return;\n+        }\n+        if let [cmd] = &run.paths[..] {\n+            if cmd.assert_single_path().path.as_path().as_os_str() == \"hook\" {\n+                run.builder.ensure(Hook);\n+            }\n+        }\n+    }\n+    fn run(self, builder: &Builder<'_>) -> Self::Output {\n+        let config = &builder.config;\n+        if config.dry_run() {\n+            return;\n+        }\n+        t!(install_git_hook_maybe(&config));\n+    }\n+}\n+\n // install a git hook to automatically run tidy, if they want\n fn install_git_hook_maybe(config: &Config) -> io::Result<()> {\n     let git = t!(config.git().args(&[\"rev-parse\", \"--git-common-dir\"]).output().map(|output| {\n@@ -432,6 +489,35 @@ undesirable, simply delete the `pre-push` file from .git/hooks.\"\n     Ok(())\n }\n \n+/// Sets up or displays `src/etc/vscode_settings.json`\n+#[derive(Clone, Copy, Debug, Eq, PartialEq, Hash)]\n+pub struct Vscode;\n+\n+impl Step for Vscode {\n+    type Output = ();\n+    const DEFAULT: bool = true;\n+    fn should_run(run: ShouldRun<'_>) -> ShouldRun<'_> {\n+        run.alias(\"vscode\")\n+    }\n+    fn make_run(run: RunConfig<'_>) {\n+        if run.builder.config.dry_run() {\n+            return;\n+        }\n+        if let [cmd] = &run.paths[..] {\n+            if cmd.assert_single_path().path.as_path().as_os_str() == \"vscode\" {\n+                run.builder.ensure(Vscode);\n+            }\n+        }\n+    }\n+    fn run(self, builder: &Builder<'_>) -> Self::Output {\n+        let config = &builder.config;\n+        if config.dry_run() {\n+            return;\n+        }\n+        t!(create_vscode_settings_maybe(&config));\n+    }\n+}\n+\n /// Create a `.vscode/settings.json` file for rustc development, or just print it\n fn create_vscode_settings_maybe(config: &Config) -> io::Result<()> {\n     let (current_hash, historical_hashes) = SETTINGS_HASHES.split_last().unwrap();"}]}