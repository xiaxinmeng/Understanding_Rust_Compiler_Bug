{"sha": "b13cad3a9cef1d1fbc97434d9f3081788548e811", "node_id": "MDY6Q29tbWl0NzI0NzEyOmIxM2NhZDNhOWNlZjFkMWZiYzk3NDM0ZDlmMzA4MTc4ODU0OGU4MTE=", "commit": {"author": {"name": "Bj\u00f6rn Steinbrink", "email": "bsteinbr@gmail.com", "date": "2014-07-25T12:31:05Z"}, "committer": {"name": "Bj\u00f6rn Steinbrink", "email": "bsteinbr@gmail.com", "date": "2014-07-25T12:31:05Z"}, "message": "Emit lifetime end markers in unwinding codepaths\n\nCurrently we don't emit lifetime end markers when translating the\nunwinding code. I omitted that when I added the support for lifetime\nintrinsics, because I initially made the mistake of just returning true\nin clean_on_unwind(). That caused almost all calls to be translated as\ninvokes, leading to quite awful results.\n\nTo correctly emit the lifetime end markers, we must differentiate\nbetween cleanup that requires unwinding and such cleanup that just wants\nto emit code during unwinding.", "tree": {"sha": "c97fcaceb7ef6696b3804c787f5d3a79cd76739d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c97fcaceb7ef6696b3804c787f5d3a79cd76739d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b13cad3a9cef1d1fbc97434d9f3081788548e811", "comment_count": 5, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b13cad3a9cef1d1fbc97434d9f3081788548e811", "html_url": "https://github.com/rust-lang/rust/commit/b13cad3a9cef1d1fbc97434d9f3081788548e811", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b13cad3a9cef1d1fbc97434d9f3081788548e811/comments", "author": {"login": "dotdash", "id": 230962, "node_id": "MDQ6VXNlcjIzMDk2Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/230962?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dotdash", "html_url": "https://github.com/dotdash", "followers_url": "https://api.github.com/users/dotdash/followers", "following_url": "https://api.github.com/users/dotdash/following{/other_user}", "gists_url": "https://api.github.com/users/dotdash/gists{/gist_id}", "starred_url": "https://api.github.com/users/dotdash/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dotdash/subscriptions", "organizations_url": "https://api.github.com/users/dotdash/orgs", "repos_url": "https://api.github.com/users/dotdash/repos", "events_url": "https://api.github.com/users/dotdash/events{/privacy}", "received_events_url": "https://api.github.com/users/dotdash/received_events", "type": "User", "site_admin": false}, "committer": {"login": "dotdash", "id": 230962, "node_id": "MDQ6VXNlcjIzMDk2Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/230962?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dotdash", "html_url": "https://github.com/dotdash", "followers_url": "https://api.github.com/users/dotdash/followers", "following_url": "https://api.github.com/users/dotdash/following{/other_user}", "gists_url": "https://api.github.com/users/dotdash/gists{/gist_id}", "starred_url": "https://api.github.com/users/dotdash/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dotdash/subscriptions", "organizations_url": "https://api.github.com/users/dotdash/orgs", "repos_url": "https://api.github.com/users/dotdash/repos", "events_url": "https://api.github.com/users/dotdash/events{/privacy}", "received_events_url": "https://api.github.com/users/dotdash/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e5984640e63d2e9f613d857ad2d48ff57b310655", "url": "https://api.github.com/repos/rust-lang/rust/commits/e5984640e63d2e9f613d857ad2d48ff57b310655", "html_url": "https://github.com/rust-lang/rust/commit/e5984640e63d2e9f613d857ad2d48ff57b310655"}], "stats": {"total": 29, "additions": 21, "deletions": 8}, "files": [{"sha": "cf2410f6571554d1589849e2bf7d59875617bfaa", "filename": "src/librustc/middle/trans/cleanup.rs", "status": "modified", "additions": 21, "deletions": 8, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/b13cad3a9cef1d1fbc97434d9f3081788548e811/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcleanup.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b13cad3a9cef1d1fbc97434d9f3081788548e811/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcleanup.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcleanup.rs?ref=b13cad3a9cef1d1fbc97434d9f3081788548e811", "patch": "@@ -68,6 +68,7 @@ pub struct CachedEarlyExit {\n }\n \n pub trait Cleanup {\n+    fn must_unwind(&self) -> bool;\n     fn clean_on_unwind(&self) -> bool;\n     fn trans<'a>(&self, bcx: &'a Block<'a>) -> &'a Block<'a>;\n }\n@@ -252,7 +253,7 @@ impl<'a> CleanupMethods<'a> for FunctionContext<'a> {\n         if !ty::type_needs_drop(self.ccx.tcx(), ty) { return; }\n         let drop = box DropValue {\n             is_immediate: false,\n-            on_unwind: ty::type_needs_unwind_cleanup(self.ccx.tcx(), ty),\n+            must_unwind: ty::type_needs_unwind_cleanup(self.ccx.tcx(), ty),\n             val: val,\n             ty: ty,\n             zero: false\n@@ -278,7 +279,7 @@ impl<'a> CleanupMethods<'a> for FunctionContext<'a> {\n         if !ty::type_needs_drop(self.ccx.tcx(), ty) { return; }\n         let drop = box DropValue {\n             is_immediate: false,\n-            on_unwind: ty::type_needs_unwind_cleanup(self.ccx.tcx(), ty),\n+            must_unwind: ty::type_needs_unwind_cleanup(self.ccx.tcx(), ty),\n             val: val,\n             ty: ty,\n             zero: true\n@@ -304,7 +305,7 @@ impl<'a> CleanupMethods<'a> for FunctionContext<'a> {\n         if !ty::type_needs_drop(self.ccx.tcx(), ty) { return; }\n         let drop = box DropValue {\n             is_immediate: true,\n-            on_unwind: ty::type_needs_unwind_cleanup(self.ccx.tcx(), ty),\n+            must_unwind: ty::type_needs_unwind_cleanup(self.ccx.tcx(), ty),\n             val: val,\n             ty: ty,\n             zero: false\n@@ -793,10 +794,10 @@ impl<'a> CleanupScope<'a> {\n     }\n \n     fn needs_invoke(&self) -> bool {\n-        /*! True if this scope has cleanups for use during unwinding */\n+        /*! True if this scope has cleanups that need unwinding */\n \n         self.cached_landing_pad.is_some() ||\n-            self.cleanups.iter().any(|c| c.clean_on_unwind())\n+            self.cleanups.iter().any(|c| c.must_unwind())\n     }\n \n     fn block_name(&self, prefix: &str) -> String {\n@@ -864,15 +865,19 @@ impl EarlyExitLabel {\n \n pub struct DropValue {\n     is_immediate: bool,\n-    on_unwind: bool,\n+    must_unwind: bool,\n     val: ValueRef,\n     ty: ty::t,\n     zero: bool\n }\n \n impl Cleanup for DropValue {\n+    fn must_unwind(&self) -> bool {\n+        self.must_unwind\n+    }\n+\n     fn clean_on_unwind(&self) -> bool {\n-        self.on_unwind\n+        self.must_unwind\n     }\n \n     fn trans<'a>(&self, bcx: &'a Block<'a>) -> &'a Block<'a> {\n@@ -900,6 +905,10 @@ pub struct FreeValue {\n }\n \n impl Cleanup for FreeValue {\n+    fn must_unwind(&self) -> bool {\n+        true\n+    }\n+\n     fn clean_on_unwind(&self) -> bool {\n         true\n     }\n@@ -921,10 +930,14 @@ pub struct LifetimeEnd {\n }\n \n impl Cleanup for LifetimeEnd {\n-    fn clean_on_unwind(&self) -> bool {\n+    fn must_unwind(&self) -> bool {\n         false\n     }\n \n+    fn clean_on_unwind(&self) -> bool {\n+        true\n+    }\n+\n     fn trans<'a>(&self, bcx: &'a Block<'a>) -> &'a Block<'a> {\n         base::call_lifetime_end(bcx, self.ptr);\n         bcx"}]}