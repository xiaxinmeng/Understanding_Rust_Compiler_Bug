{"sha": "b37a05bd01a4f1fdcdfda77df4a9008d04236528", "node_id": "C_kwDOAAsO6NoAKGIzN2EwNWJkMDFhNGYxZmRjZGZkYTc3ZGY0YTkwMDhkMDQyMzY1Mjg", "commit": {"author": {"name": "Jacob Hoffman-Andrews", "email": "github@hoffman-andrews.com", "date": "2022-06-20T19:41:11Z"}, "committer": {"name": "Jacob Hoffman-Andrews", "email": "github@hoffman-andrews.com", "date": "2022-06-20T22:08:02Z"}, "message": "rustdoc: optimize loading of source sidebar\n\nThe source sidebar has a setting to remember whether it should be open or\nclosed. Previously, this setting was handled in source-script.js, which\nis loaded with `defer`, meaning it is often run after the document is rendered.\nSince CSS renders the source sidebar as closed by default, changing this\nafter the initial render results in a relayout.\n\nInstead, handle the setting in storage.js, which is the first script to load\nand is the only script that blocks render. This avoids a relayout and means\nnavigating between files with the sidebar open is faster.", "tree": {"sha": "c721c0c224e78af8a1526ff9d26c10878781888c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c721c0c224e78af8a1526ff9d26c10878781888c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b37a05bd01a4f1fdcdfda77df4a9008d04236528", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b37a05bd01a4f1fdcdfda77df4a9008d04236528", "html_url": "https://github.com/rust-lang/rust/commit/b37a05bd01a4f1fdcdfda77df4a9008d04236528", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b37a05bd01a4f1fdcdfda77df4a9008d04236528/comments", "author": {"login": "jsha", "id": 220205, "node_id": "MDQ6VXNlcjIyMDIwNQ==", "avatar_url": "https://avatars.githubusercontent.com/u/220205?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jsha", "html_url": "https://github.com/jsha", "followers_url": "https://api.github.com/users/jsha/followers", "following_url": "https://api.github.com/users/jsha/following{/other_user}", "gists_url": "https://api.github.com/users/jsha/gists{/gist_id}", "starred_url": "https://api.github.com/users/jsha/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jsha/subscriptions", "organizations_url": "https://api.github.com/users/jsha/orgs", "repos_url": "https://api.github.com/users/jsha/repos", "events_url": "https://api.github.com/users/jsha/events{/privacy}", "received_events_url": "https://api.github.com/users/jsha/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jsha", "id": 220205, "node_id": "MDQ6VXNlcjIyMDIwNQ==", "avatar_url": "https://avatars.githubusercontent.com/u/220205?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jsha", "html_url": "https://github.com/jsha", "followers_url": "https://api.github.com/users/jsha/followers", "following_url": "https://api.github.com/users/jsha/following{/other_user}", "gists_url": "https://api.github.com/users/jsha/gists{/gist_id}", "starred_url": "https://api.github.com/users/jsha/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jsha/subscriptions", "organizations_url": "https://api.github.com/users/jsha/orgs", "repos_url": "https://api.github.com/users/jsha/repos", "events_url": "https://api.github.com/users/jsha/events{/privacy}", "received_events_url": "https://api.github.com/users/jsha/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "bb8c2f41174caceec00c28bc6c5c20ae9f9a175c", "url": "https://api.github.com/repos/rust-lang/rust/commits/bb8c2f41174caceec00c28bc6c5c20ae9f9a175c", "html_url": "https://github.com/rust-lang/rust/commit/bb8c2f41174caceec00c28bc6c5c20ae9f9a175c"}], "stats": {"total": 68, "additions": 42, "deletions": 26}, "files": [{"sha": "b4b7790eebba1fa87431a8ec2f1fdd1451494998", "filename": "src/librustdoc/html/static/css/rustdoc.css", "status": "modified", "additions": 23, "deletions": 12, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/b37a05bd01a4f1fdcdfda77df4a9008d04236528/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Frustdoc.css", "raw_url": "https://github.com/rust-lang/rust/raw/b37a05bd01a4f1fdcdfda77df4a9008d04236528/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Frustdoc.css", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Frustdoc.css?ref=b37a05bd01a4f1fdcdfda77df4a9008d04236528", "patch": "@@ -387,16 +387,20 @@ nav.sub {\n \toverflow-y: hidden;\n }\n \n+.rustdoc.source .sidebar .sidebar-logo {\n+\tdisplay: none;\n+}\n+\n .source .sidebar > *:not(#sidebar-toggle) {\n \topacity: 0;\n \tvisibility: hidden;\n }\n \n-.source .sidebar.expanded {\n+.source-sidebar-expanded .source .sidebar {\n \toverflow-y: auto;\n }\n \n-.source .sidebar.expanded > *:not(#sidebar-toggle) {\n+.source-sidebar-expanded .source .sidebar > *:not(#sidebar-toggle) {\n \topacity: 1;\n \tvisibility: visible;\n }\n@@ -1682,11 +1686,11 @@ details.rustdoc-toggle[open] > summary.hideme::after {\n \n \t/* When we expand the sidebar on the source code page, we hide the logo on the left of the\n \tsearch bar to have more space. */\n-\t.sidebar.expanded + main .width-limiter .sub-logo-container.rust-logo {\n+\t.source-sidebar-expanded .source .sidebar + main .width-limiter .sub-logo-container.rust-logo {\n \t\tdisplay: none;\n \t}\n \n-\t.source .sidebar.expanded {\n+\t.source-sidebar-expanded .source .sidebar {\n \t\twidth: 300px;\n \t}\n }\n@@ -1766,7 +1770,7 @@ details.rustdoc-toggle[open] > summary.hideme::after {\n \t}\n \n \t.sidebar.shown,\n-\t.sidebar.expanded,\n+\t.source-sidebar-expanded .source .sidebar,\n \t.sidebar:focus-within {\n \t\tleft: 0;\n \t}\n@@ -1889,11 +1893,7 @@ details.rustdoc-toggle[open] > summary.hideme::after {\n \t\tleft: -11px;\n \t}\n \n-\t.sidebar.expanded #sidebar-toggle {\n-\t\tfont-size: 1.5rem;\n-\t}\n-\n-\t.sidebar:not(.expanded) #sidebar-toggle {\n+\t#sidebar-toggle {\n \t\tposition: fixed;\n \t\tleft: 1px;\n \t\ttop: 100px;\n@@ -1910,6 +1910,14 @@ details.rustdoc-toggle[open] > summary.hideme::after {\n \t\tborder-left: 0;\n \t}\n \n+\t.source-sidebar-expanded #sidebar-toggle {\n+\t\tleft: unset;\n+\t\ttop: unset;\n+\t\twidth: unset;\n+\t\tborder-top-right-radius: unset;\n+\t\tborder-bottom-right-radius: unset;\n+\t}\n+\n \t#source-sidebar {\n \t\tz-index: 11;\n \t}\n@@ -1952,7 +1960,7 @@ details.rustdoc-toggle[open] > summary.hideme::after {\n \t\tpadding-left: 2em;\n \t}\n \n-\t.source .sidebar.expanded {\n+\t.source-sidebar-expanded .source .sidebar {\n \t\tmax-width: 100vw;\n \t\twidth: 100vw;\n \t}\n@@ -2010,9 +2018,12 @@ details.rustdoc-toggle[open] > summary.hideme::after {\n \t\twidth: 35px;\n \t}\n \n-\t.sidebar:not(.expanded) #sidebar-toggle {\n+\t#sidebar-toggle {\n \t\ttop: 10px;\n \t}\n+\t.source-sidebar-expanded #sidebar-toggle {\n+\t\ttop: unset;\n+\t}\n }\n \n .method-toggle summary,"}, {"sha": "45955c6dd052c9596c45ddd4a23377b956cbbea7", "filename": "src/librustdoc/html/static/js/source-script.js", "status": "modified", "additions": 2, "deletions": 8, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/b37a05bd01a4f1fdcdfda77df4a9008d04236528/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsource-script.js", "raw_url": "https://github.com/rust-lang/rust/raw/b37a05bd01a4f1fdcdfda77df4a9008d04236528/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsource-script.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsource-script.js?ref=b37a05bd01a4f1fdcdfda77df4a9008d04236528", "patch": "@@ -76,14 +76,13 @@ function createDirEntry(elem, parent, fullPath, currentFile, hasFoundFile) {\n }\n \n function toggleSidebar() {\n-    const sidebar = document.querySelector(\"nav.sidebar\");\n     const child = this.children[0];\n     if (child.innerText === \">\") {\n-        sidebar.classList.add(\"expanded\");\n+        addClass(document.documentElement, \"source-sidebar-expanded\");\n         child.innerText = \"<\";\n         updateLocalStorage(\"source-sidebar-show\", \"true\");\n     } else {\n-        sidebar.classList.remove(\"expanded\");\n+        removeClass(document.documentElement, \"source-sidebar-expanded\");\n         child.innerText = \">\";\n         updateLocalStorage(\"source-sidebar-show\", \"false\");\n     }\n@@ -119,11 +118,6 @@ function createSourceSidebar() {\n \n     const sidebar = document.createElement(\"div\");\n     sidebar.id = \"source-sidebar\";\n-    if (getCurrentValue(\"source-sidebar-show\") !== \"true\") {\n-        container.classList.remove(\"expanded\");\n-    } else {\n-        container.classList.add(\"expanded\");\n-    }\n \n     const currentFile = getCurrentFilePath();\n     let hasFoundFile = false;"}, {"sha": "1c4c88344888cf28dd6c6aca00d3fcae540790d2", "filename": "src/librustdoc/html/static/js/storage.js", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/b37a05bd01a4f1fdcdfda77df4a9008d04236528/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fstorage.js", "raw_url": "https://github.com/rust-lang/rust/raw/b37a05bd01a4f1fdcdfda77df4a9008d04236528/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fstorage.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fstorage.js?ref=b37a05bd01a4f1fdcdfda77df4a9008d04236528", "patch": "@@ -1,3 +1,8 @@\n+// storage.js is loaded in the `<head>` of all rustdoc pages and doesn't\n+// use `async` or `defer`. That means it blocks further parsing and rendering\n+// of the page: https://developer.mozilla.org/en-US/docs/Web/HTML/Element/script.\n+// This makes it the correct place to act on settings that affect the display of\n+// the page, so we don't see major layout changes during the load of the page.\n \"use strict\";\n \n const darkThemes = [\"dark\", \"ayu\"];\n@@ -236,6 +241,12 @@ if (getSettingValue(\"use-system-theme\") !== \"false\" && window.matchMedia) {\n     switchToSavedTheme();\n }\n \n+if (getSettingValue(\"source-sidebar-show\") === \"true\") {\n+    // At this point in page load, `document.body` is not available yet.\n+    // Set a class on the `<html>` element instead.\n+    addClass(document.documentElement, \"source-sidebar-expanded\");\n+}\n+\n // If we navigate away (for example to a settings page), and then use the back or\n // forward button to get back to a page, the theme may have changed in the meantime.\n // But scripts may not be re-loaded in such a case due to the bfcache"}, {"sha": "724520bc399d0da0743f9eafaee98195034a0f61", "filename": "src/test/rustdoc-gui/sidebar-source-code.goml", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/b37a05bd01a4f1fdcdfda77df4a9008d04236528/src%2Ftest%2Frustdoc-gui%2Fsidebar-source-code.goml", "raw_url": "https://github.com/rust-lang/rust/raw/b37a05bd01a4f1fdcdfda77df4a9008d04236528/src%2Ftest%2Frustdoc-gui%2Fsidebar-source-code.goml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-gui%2Fsidebar-source-code.goml?ref=b37a05bd01a4f1fdcdfda77df4a9008d04236528", "patch": "@@ -8,12 +8,12 @@ assert-css: (\"nav.sidebar\", {\"width\": \"50px\"})\n // We now click on the button to expand the sidebar.\n click: (10, 10)\n // We wait for the sidebar to be expanded.\n-wait-for-css: (\"nav.sidebar.expanded\", {\"width\": \"300px\"})\n-assert-css: (\"nav.sidebar.expanded a\", {\"font-size\": \"14px\"})\n+wait-for-css: (\".source-sidebar-expanded nav.sidebar\", {\"width\": \"300px\"})\n+assert-css: (\".source-sidebar-expanded nav.sidebar a\", {\"font-size\": \"14px\"})\n // We collapse the sidebar.\n click: (10, 10)\n // We ensure that the class has been removed.\n-wait-for: \"nav.sidebar:not(.expanded)\"\n+wait-for: \"html:not(.expanded)\"\n assert: \"nav.sidebar\"\n \n // We now switch to mobile mode.\n@@ -22,11 +22,11 @@ size: (600, 600)\n assert-css: (\"nav.sidebar\", {\"width\": \"1px\"})\n // We expand the sidebar.\n click: \"#sidebar-toggle\"\n-assert-css: (\"nav.sidebar.expanded\", {\"width\": \"600px\"})\n+assert-css: (\".source-sidebar-expanded nav.sidebar\", {\"width\": \"600px\"})\n // We collapse the sidebar.\n click: (10, 10)\n // We ensure that the class has been removed.\n-assert-false: \"nav.sidebar.expanded\"\n+assert-false: \".source-sidebar-expanded\"\n assert: \"nav.sidebar\"\n \n // Check that the topbar is not visible"}, {"sha": "b45512601f2087703010813314d5ccc9322c34a0", "filename": "src/test/rustdoc-gui/source-code-page.goml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b37a05bd01a4f1fdcdfda77df4a9008d04236528/src%2Ftest%2Frustdoc-gui%2Fsource-code-page.goml", "raw_url": "https://github.com/rust-lang/rust/raw/b37a05bd01a4f1fdcdfda77df4a9008d04236528/src%2Ftest%2Frustdoc-gui%2Fsource-code-page.goml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-gui%2Fsource-code-page.goml?ref=b37a05bd01a4f1fdcdfda77df4a9008d04236528", "patch": "@@ -32,7 +32,7 @@ assert-document-property: ({\"URL\": \"/lib.rs.html\"}, ENDS_WITH)\n \n // First we \"open\" it.\n click: \"#sidebar-toggle\"\n-assert: \".sidebar.expanded\"\n+assert: \".source-sidebar-expanded\"\n \n // We check that the first entry of the sidebar is collapsed (which, for whatever reason,\n // is number 2 and not 1...)."}]}