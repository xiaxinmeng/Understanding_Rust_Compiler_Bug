{"sha": "a4f30bf0c001034b855e79b72676667deb6db463", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE0ZjMwYmYwYzAwMTAzNGI4NTVlNzliNzI2NzY2NjdkZWI2ZGI0NjM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-12-30T13:51:51Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-12-30T13:51:51Z"}, "message": "auto merge of #11185 : huonw/rust/doc-ignore, r=cmr\n\nCurrently any line starting with `#` is filtered from the output,\r\nincluding line like `#[deriving]`; this patch makes it so lines are only\r\nfiltered when followed by a space similar to the current behaviour of\r\nthe tutorial/manual tester.", "tree": {"sha": "755c3cc3c99094c3482b9d1853372e254eaf7da3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/755c3cc3c99094c3482b9d1853372e254eaf7da3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a4f30bf0c001034b855e79b72676667deb6db463", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a4f30bf0c001034b855e79b72676667deb6db463", "html_url": "https://github.com/rust-lang/rust/commit/a4f30bf0c001034b855e79b72676667deb6db463", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a4f30bf0c001034b855e79b72676667deb6db463/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f37b746699c377bce4a983834efe5162081a61dd", "url": "https://api.github.com/repos/rust-lang/rust/commits/f37b746699c377bce4a983834efe5162081a61dd", "html_url": "https://github.com/rust-lang/rust/commit/f37b746699c377bce4a983834efe5162081a61dd"}, {"sha": "dedc29f128e2c87237ba4dea2dd0337e00f1320c", "url": "https://api.github.com/repos/rust-lang/rust/commits/dedc29f128e2c87237ba4dea2dd0337e00f1320c", "html_url": "https://github.com/rust-lang/rust/commit/dedc29f128e2c87237ba4dea2dd0337e00f1320c"}], "stats": {"total": 64, "additions": 57, "deletions": 7}, "files": [{"sha": "ea87077b1196be1be5b3ee83d0cebc17a11fce5d", "filename": "doc/rustdoc.md", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/a4f30bf0c001034b855e79b72676667deb6db463/doc%2Frustdoc.md", "raw_url": "https://github.com/rust-lang/rust/raw/a4f30bf0c001034b855e79b72676667deb6db463/doc%2Frustdoc.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/doc%2Frustdoc.md?ref=a4f30bf0c001034b855e79b72676667deb6db463", "patch": "@@ -132,9 +132,10 @@ specifiers that can be used to dictate how a code block is tested:\n ~~~\n \n Rustdoc also supplies some extra sugar for helping with some tedious\n-documentation examples. If a line is prefixed with a `#` character, then the\n-line will not show up in the HTML documentation, but it will be used when\n-testing the code block.\n+documentation examples. If a line is prefixed with `# `, then the line\n+will not show up in the HTML documentation, but it will be used when\n+testing the code block (NB. the space after the `#` is required, so\n+that one can still write things like `#[deriving(Eq)]`).\n \n ~~~\n ```rust"}, {"sha": "5da087eedbd58164647d0477e8c094755e149a88", "filename": "src/librustdoc/html/markdown.rs", "status": "modified", "additions": 15, "deletions": 4, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/a4f30bf0c001034b855e79b72676667deb6db463/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a4f30bf0c001034b855e79b72676667deb6db463/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs?ref=a4f30bf0c001034b855e79b72676667deb6db463", "patch": "@@ -94,15 +94,26 @@ extern {\n \n }\n \n+/// Returns Some(code) if `s` is a line that should be stripped from\n+/// documentation but used in example code. `code` is the portion of\n+/// `s` that should be used in tests. (None for lines that should be\n+/// left as-is.)\n+fn stripped_filtered_line<'a>(s: &'a str) -> Option<&'a str> {\n+    let trimmed = s.trim();\n+    if trimmed.starts_with(\"# \") {\n+        Some(trimmed.slice_from(2))\n+    } else {\n+        None\n+    }\n+}\n+\n pub fn render(w: &mut io::Writer, s: &str) {\n     extern fn block(ob: *buf, text: *buf, lang: *buf, opaque: *libc::c_void) {\n         unsafe {\n             let my_opaque: &my_opaque = cast::transmute(opaque);\n             vec::raw::buf_as_slice((*text).data, (*text).size as uint, |text| {\n                 let text = str::from_utf8(text);\n-                let mut lines = text.lines().filter(|l| {\n-                    !l.trim().starts_with(\"#\")\n-                });\n+                let mut lines = text.lines().filter(|l| stripped_filtered_line(*l).is_none());\n                 let text = lines.to_owned_vec().connect(\"\\n\");\n \n                 let buf = buf {\n@@ -169,7 +180,7 @@ pub fn find_testable_code(doc: &str, tests: &mut ::test::Collector) {\n             vec::raw::buf_as_slice((*text).data, (*text).size as uint, |text| {\n                 let tests: &mut ::test::Collector = intrinsics::transmute(opaque);\n                 let text = str::from_utf8(text);\n-                let mut lines = text.lines().map(|l| l.trim_chars(&'#'));\n+                let mut lines = text.lines().map(|l| stripped_filtered_line(l).unwrap_or(l));\n                 let text = lines.to_owned_vec().connect(\"\\n\");\n                 tests.add_test(text, ignore, shouldfail);\n             })"}, {"sha": "e5ec3661b611c7bb1de76cc1937573034f224f9c", "filename": "src/librustdoc/test.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/a4f30bf0c001034b855e79b72676667deb6db463/src%2Flibrustdoc%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a4f30bf0c001034b855e79b72676667deb6db463/src%2Flibrustdoc%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Ftest.rs?ref=a4f30bf0c001034b855e79b72676667deb6db463", "patch": "@@ -173,6 +173,7 @@ impl Collector {\n         let libs = self.libs.borrow();\n         let libs = (*libs.get()).clone();\n         let cratename = self.cratename.to_owned();\n+        debug!(\"Creating test {}: {}\", name, test);\n         self.tests.push(test::TestDescAndFn {\n             desc: test::TestDesc {\n                 name: test::DynTestName(name),"}, {"sha": "7e6f8fe105e922c3044ae1f3625c19b1509c8934", "filename": "src/test/run-make/rustdoc-hidden-line/Makefile", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/a4f30bf0c001034b855e79b72676667deb6db463/src%2Ftest%2Frun-make%2Frustdoc-hidden-line%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/a4f30bf0c001034b855e79b72676667deb6db463/src%2Ftest%2Frun-make%2Frustdoc-hidden-line%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Frustdoc-hidden-line%2FMakefile?ref=a4f30bf0c001034b855e79b72676667deb6db463", "patch": "@@ -0,0 +1,7 @@\n+-include ../tools.mk\n+\n+all:\n+\t$(RUSTDOC) --test foo.rs\n+\t$(RUSTDOC) -w html -o $(TMPDIR)/doc foo.rs\n+\tcp verify.sh $(TMPDIR)\n+\t$(call RUN,verify.sh) $(TMPDIR)"}, {"sha": "69c7683780b2fc43f9c44aa5545d36652e703f4d", "filename": "src/test/run-make/rustdoc-hidden-line/foo.rs", "status": "added", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/a4f30bf0c001034b855e79b72676667deb6db463/src%2Ftest%2Frun-make%2Frustdoc-hidden-line%2Ffoo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a4f30bf0c001034b855e79b72676667deb6db463/src%2Ftest%2Frun-make%2Frustdoc-hidden-line%2Ffoo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Frustdoc-hidden-line%2Ffoo.rs?ref=a4f30bf0c001034b855e79b72676667deb6db463", "patch": "@@ -0,0 +1,22 @@\n+#[crate_id=\"foo#0.1\"];\n+\n+/// The '# ' lines should be removed from the output, but the #[deriving] should be\n+/// retained.\n+///\n+/// ```rust\n+/// mod to_make_deriving_work { // FIXME #4913\n+///\n+/// # #[deriving(Eq)] // invisible\n+/// # struct Foo; // invisible\n+///\n+/// #[deriving(Eq)] // Bar\n+/// struct Bar(Foo);\n+///\n+/// fn test() {\n+///     let x = Bar(Foo);\n+///     assert!(x == x); // check that the derivings worked\n+/// }\n+///\n+/// }\n+/// ```\n+pub fn foo() {}"}, {"sha": "c1d817c998d2972df80c2163bdff944b7fab5a59", "filename": "src/test/run-make/rustdoc-hidden-line/verify.sh", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/a4f30bf0c001034b855e79b72676667deb6db463/src%2Ftest%2Frun-make%2Frustdoc-hidden-line%2Fverify.sh", "raw_url": "https://github.com/rust-lang/rust/raw/a4f30bf0c001034b855e79b72676667deb6db463/src%2Ftest%2Frun-make%2Frustdoc-hidden-line%2Fverify.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Frustdoc-hidden-line%2Fverify.sh?ref=a4f30bf0c001034b855e79b72676667deb6db463", "patch": "@@ -0,0 +1,8 @@\n+#!/bin/sh\n+\n+file=\"$1/doc/foo/fn.foo.html\"\n+\n+grep -v 'invisible' $file &&\n+grep '#\\[deriving(Eq)\\] // Bar' $file\n+\n+exit $?"}]}